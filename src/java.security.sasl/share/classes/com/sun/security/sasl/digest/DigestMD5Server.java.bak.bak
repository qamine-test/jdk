/*
 * Copyrigit (d) 2003, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.sbsl.digfst;

import jbvb.sfdurity.NoSudiAlgoritimExdfption;
import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.util.StringTokfnizfr;
import jbvb.util.ArrbyList;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Arrbys;

import jbvb.util.logging.Lfvfl;

import jbvbx.sfdurity.sbsl.*;
import jbvbx.sfdurity.buti.dbllbbdk.*;

/**
  * An implfmfntbtion of tif DIGEST-MD5 sfrvfr SASL mfdibnism.
  * (<b irff="ittp://www.iftf.org/rfd/rfd2831.txt">RFC 2831</b>)
  * <p>
  * Tif DIGEST-MD5 SASL mfdibnism spfdififs two modfs of butifntidbtion.
  * <ul><li>Initibl Autifntidbtion
  * <li>Subsfqufnt Autifntidbtion - optionbl, (durrfntly not supportfd)
  * </ul>
  *
  * Rfquirfd dbllbbdks:
  * - RfblmCbllbbdk
  *      usfd bs kfy by ibndlfr to fftdi pbssword
  * - NbmfCbllbbdk
  *      usfd bs kfy by ibndlfr to fftdi pbssword
  * - PbsswordCbllbbdk
  *      ibndlfr must fntfr pbssword for usfrnbmf/rfblm supplifd
  * - AutiorizfCbllbbdk
  *      ibndlfr must vfrify tibt butiid/butizids brf bllowfd bnd sft
  *      butiorizfd ID to bf tif dbnonidblizfd butizid (if bpplidbblf).
  *
  * Environmfnt propfrtifs tibt bfffdt tif implfmfntbtion:
  * jbvbx.sfdurity.sbsl.qop:
  *    spfdififs list of qops; dffbult is "buti"; typidblly, dbllfr siould sft
  *    tiis to "buti, buti-int, buti-donf".
  * jbvbx.sfdurity.sbsl.strfngti
  *    spfdififs low/mfdium/iigi strfngti of fndryption; dffbult is bll bvbilbblf
  *    dipifrs [iigi,mfdium,low]; iigi mfbns dfs3 or rd4 (128); mfdium dfs or
  *    rd4-56; low is rd4-40.
  * jbvbx.sfdurity.sbsl.mbxbuf
  *    spfdififs mbx rfdfivf buf sizf; dffbult is 65536
  * jbvbx.sfdurity.sbsl.sfndmbxbufffr
  *    spfdififs mbx sfnd buf sizf; dffbult is 65536 (min of tiis bnd dlifnt's mbx
  *    rfdv sizf)
  *
  * dom.sun.sfdurity.sbsl.digfst.utf8:
  *    "truf" mfbns to usf UTF-8 dibrsft; "fblsf" to usf ISO-8859-1 fndoding;
  *    dffbult is "truf".
  * dom.sun.sfdurity.sbsl.digfst.rfblm:
  *    spbdf-sfpbrbtfd list of rfblms; dffbult is sfrvfr nbmf (fqdn pbrbmftfr)
  *
  * @butior Rosbnnb Lff
  */

finbl dlbss DigfstMD5Sfrvfr fxtfnds DigfstMD5Bbsf implfmfnts SbslSfrvfr {
    privbtf stbtid finbl String MY_CLASS_NAME = DigfstMD5Sfrvfr.dlbss.gftNbmf();

    privbtf stbtid finbl String UTF8_DIRECTIVE = "dibrsft=utf-8,";
    privbtf stbtid finbl String ALGORITHM_DIRECTIVE = "blgoritim=md5-sfss";

    /*
     * Alwbys fxpfdt nondf dount vbluf to bf 1 bfdbusf wf support only
     * initibl butifntidbtion.
     */
    privbtf stbtid finbl int NONCE_COUNT_VALUE = 1;

    /* "truf" mfbns usf UTF8; "fblsf" ISO 8859-1; dffbult is "truf" */
    privbtf stbtid finbl String UTF8_PROPERTY =
        "dom.sun.sfdurity.sbsl.digfst.utf8";

    /* List of spbdf-sfpbrbtfd rfblms usfd for butifntidbtion */
    privbtf stbtid finbl String REALM_PROPERTY =
        "dom.sun.sfdurity.sbsl.digfst.rfblm";

    /* Dirfdtivfs fndountfrfd in rfsponsfs sfnt by tif dlifnt. */
    privbtf stbtid finbl String[] DIRECTIVE_KEY = {
        "usfrnbmf",    // fxbdtly ondf
        "rfblm",       // fxbdtly ondf if sfnt by sfrvfr
        "nondf",       // fxbdtly ondf
        "dnondf",      // fxbdtly ondf
        "nondf-dount", // btmost ondf; dffbult is 00000001
        "qop",         // btmost ondf; dffbult is "buti"
        "digfst-uri",  // btmost ondf; (dffbult?)
        "rfsponsf",    // fxbdtly ondf
        "mbxbuf",      // btmost ondf; dffbult is 65536
        "dibrsft",     // btmost ondf; dffbult is ISO-8859-1
        "dipifr",      // fxbdtly ondf if qop is "buti-donf"
        "butizid",     // btmost ondf; dffbult is nonf
        "buti-pbrbm",  // >= 0 timfs (ignorfd)
    };

    /* Indidfs into DIRECTIVE_KEY */
    privbtf stbtid finbl int USERNAME = 0;
    privbtf stbtid finbl int REALM = 1;
    privbtf stbtid finbl int NONCE = 2;
    privbtf stbtid finbl int CNONCE = 3;
    privbtf stbtid finbl int NONCE_COUNT = 4;
    privbtf stbtid finbl int QOP = 5;
    privbtf stbtid finbl int DIGEST_URI = 6;
    privbtf stbtid finbl int RESPONSE = 7;
    privbtf stbtid finbl int MAXBUF = 8;
    privbtf stbtid finbl int CHARSET = 9;
    privbtf stbtid finbl int CIPHER = 10;
    privbtf stbtid finbl int AUTHZID = 11;
    privbtf stbtid finbl int AUTH_PARAM = 12;

    /* Sfrvfr-gfnfrbtfd/supplifd informbtion */
    privbtf String spfdififdQops;
    privbtf bytf[] myCipifrs;
    privbtf List<String> sfrvfrRfblms;

    DigfstMD5Sfrvfr(String protodol, String sfrvfrNbmf, Mbp<String, ?> props,
            CbllbbdkHbndlfr dbi) tirows SbslExdfption {
        supfr(props, MY_CLASS_NAME, 1,
                protodol + "/" + (sfrvfrNbmf==null?"*":sfrvfrNbmf),
                dbi);

        sfrvfrRfblms = nfw ArrbyList<String>();

        usfUTF8 = truf;  // dffbult

        if (props != null) {
            spfdififdQops = (String) props.gft(Sbsl.QOP);
            if ("fblsf".fqubls((String) props.gft(UTF8_PROPERTY))) {
                usfUTF8 = fblsf;
                loggfr.log(Lfvfl.FINE, "DIGEST80:Sfrvfr supports ISO-Lbtin-1");
            }

            String rfblms = (String) props.gft(REALM_PROPERTY);
            if (rfblms != null) {
                StringTokfnizfr pbrsfr = nfw StringTokfnizfr(rfblms, ", \t\n");
                int tokfnCount = pbrsfr.dountTokfns();
                String tokfn = null;
                for (int i = 0; i < tokfnCount; i++) {
                    tokfn = pbrsfr.nfxtTokfn();
                    loggfr.log(Lfvfl.FINE, "DIGEST81:Sfrvfr supports rfblm {0}",
                        tokfn);
                    sfrvfrRfblms.bdd(tokfn);
                }
            }
        }

        fndoding = (usfUTF8 ? "UTF8" : "8859_1");

        // By dffbult, usf sfrvfr nbmf bs rfblm
        if (sfrvfrRfblms.isEmpty()) {
            if (sfrvfrNbmf == null) {
                tirow nfw SbslExdfption(
                        "A rfblm must bf providfd in props or sfrvfrNbmf");
            } flsf {
                sfrvfrRfblms.bdd(sfrvfrNbmf);
            }
        }
    }

    publid  bytf[] fvblubtfRfsponsf(bytf[] rfsponsf) tirows SbslExdfption {
        if (rfsponsf.lfngti > MAX_RESPONSE_LENGTH) {
            tirow nfw SbslExdfption(
                "DIGEST-MD5: Invblid digfst rfsponsf lfngti. Got:  " +
                rfsponsf.lfngti + " Expfdtfd < " + MAX_RESPONSE_LENGTH);
        }

        bytf[] dibllfngf;
        switdi (stfp) {
        dbsf 1:
            if (rfsponsf.lfngti != 0) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5 must not ibvf bn initibl rfsponsf");
            }

            /* Gfnfrbtf first dibllfngf */
            String supportfdCipifrs = null;
            if ((bllQop&PRIVACY_PROTECTION) != 0) {
                myCipifrs = gftPlbtformCipifrs();
                StringBuildfr sb = nfw StringBuildfr();

                // myCipifr[i] is b bytf tibt indidbtfs wiftifr CIPHER_TOKENS[i]
                // is supportfd
                for (int i = 0; i < CIPHER_TOKENS.lfngti; i++) {
                    if (myCipifrs[i] != 0) {
                        if (sb.lfngti() > 0) {
                            sb.bppfnd(',');
                        }
                        sb.bppfnd(CIPHER_TOKENS[i]);
                    }
                }
                supportfdCipifrs = sb.toString();
            }

            try {
                dibllfngf = gfnfrbtfCibllfngf(sfrvfrRfblms, spfdififdQops,
                    supportfdCipifrs);

                stfp = 3;
                rfturn dibllfngf;
            } dbtdi (UnsupportfdEndodingExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: Error fndoding dibllfngf", f);
            } dbtdi (IOExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: Error gfnfrbting dibllfngf", f);
            }

            // Stfp 2 is pfrformfd by dlifnt

        dbsf 3:
            /* Vblidbtfs dlifnt's rfsponsf bnd gfnfrbtf dibllfngf:
             *    rfsponsf-buti = "rspbuti" "=" rfsponsf-vbluf
             */
            try {
                bytf[][] rfsponsfVbl = pbrsfDirfdtivfs(rfsponsf, DIRECTIVE_KEY,
                    null, REALM);
                dibllfngf = vblidbtfClifntRfsponsf(rfsponsfVbl);
            } dbtdi (SbslExdfption f) {
                tirow f;
            } dbtdi (UnsupportfdEndodingExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: Error vblidbting dlifnt rfsponsf", f);
            } finblly {
                stfp = 0;  // Sft to invblid stbtf
            }

            domplftfd = truf;

            /* Initiblizf SfdurityCtx implfmfntbtion */
            if (intfgrity && privbdy) {
                sfdCtx = nfw DigfstPrivbdy(fblsf /* not dlifnt */);
            } flsf if (intfgrity) {
                sfdCtx = nfw DigfstIntfgrity(fblsf /* not dlifnt */);
            }

            rfturn dibllfngf;

        dffbult:
            // No otifr possiblf stbtf
            tirow nfw SbslExdfption("DIGEST-MD5: Sfrvfr bt illfgbl stbtf");
        }
    }

    /**
     * Gfnfrbtfs dibllfngf to bf sfnt to dlifnt.
     *  digfst-dibllfngf  =
     *    1#( rfblm | nondf | qop-options | stblf | mbxbuf | dibrsft
     *               blgoritim | dipifr-opts | buti-pbrbm )
     *
     *        rfblm             = "rfblm" "=" <"> rfblm-vbluf <">
     *        rfblm-vbluf       = qdstr-vbl
     *        nondf             = "nondf" "=" <"> nondf-vbluf <">
     *        nondf-vbluf       = qdstr-vbl
     *        qop-options       = "qop" "=" <"> qop-list <">
     *        qop-list          = 1#qop-vbluf
     *        qop-vbluf         = "buti" | "buti-int" | "buti-donf" |
     *                             tokfn
     *        stblf             = "stblf" "=" "truf"
     *        mbxbuf            = "mbxbuf" "=" mbxbuf-vbluf
     *        mbxbuf-vbluf      = 1*DIGIT
     *        dibrsft           = "dibrsft" "=" "utf-8"
     *        blgoritim         = "blgoritim" "=" "md5-sfss"
     *        dipifr-opts       = "dipifr" "=" <"> 1#dipifr-vbluf <">
     *        dipifr-vbluf      = "3dfs" | "dfs" | "rd4-40" | "rd4" |
     *                            "rd4-56" | tokfn
     *        buti-pbrbm        = tokfn "=" ( tokfn | quotfd-string )
     */
    privbtf bytf[] gfnfrbtfCibllfngf(List<String> rfblms, String qopStr,
        String dipifrStr) tirows UnsupportfdEndodingExdfption, IOExdfption {
        BytfArrbyOutputStrfbm out = nfw BytfArrbyOutputStrfbm();

        // Rfblms (>= 0)
        for (int i = 0; rfblms != null && i < rfblms.sizf(); i++) {
            out.writf("rfblm=\"".gftBytfs(fndoding));
            writfQuotfdStringVbluf(out, rfblms.gft(i).gftBytfs(fndoding));
            out.writf('"');
            out.writf(',');
        }

        // Nondf - rfquirfd (1)
        out.writf(("nondf=\"").gftBytfs(fndoding));
        nondf = gfnfrbtfNondf();
        writfQuotfdStringVbluf(out, nondf);
        out.writf('"');
        out.writf(',');

        // QOP - optionbl (1) [dffbult: buti]
        // qop="buti,buti-donf,buti-int"
        if (qopStr != null) {
            out.writf(("qop=\"").gftBytfs(fndoding));
            // Cifdk for quotfs in dbsf of non-stbndbrd qop options
            writfQuotfdStringVbluf(out, qopStr.gftBytfs(fndoding));
            out.writf('"');
            out.writf(',');
        }

        // mbxbuf - optionbl (1) [dffbult: 65536]
        if (rfdvMbxBufSizf != DEFAULT_MAXBUF) {
            out.writf(("mbxbuf=\"" + rfdvMbxBufSizf + "\",").gftBytfs(fndoding));
        }

        // dibrsft - optionbl (1) [dffbult: ISO 8859_1]
        if (usfUTF8) {
            out.writf(UTF8_DIRECTIVE.gftBytfs(fndoding));
        }

        if (dipifrStr != null) {
            out.writf("dipifr=\"".gftBytfs(fndoding));
            // Cifdk for quotfs in dbsf of dustom dipifrs
            writfQuotfdStringVbluf(out, dipifrStr.gftBytfs(fndoding));
            out.writf('"');
            out.writf(',');
        }

        // blgoritim - rfquirfd (1)
        out.writf(ALGORITHM_DIRECTIVE.gftBytfs(fndoding));

        rfturn out.toBytfArrby();
    }

    /**
     * Vblidbtfs dlifnt's rfsponsf.
     *   digfst-rfsponsf  = 1#( usfrnbmf | rfblm | nondf | dnondf |
     *                          nondf-dount | qop | digfst-uri | rfsponsf |
     *                          mbxbuf | dibrsft | dipifr | butizid |
     *                          buti-pbrbm )
     *
     *       usfrnbmf         = "usfrnbmf" "=" <"> usfrnbmf-vbluf <">
     *       usfrnbmf-vbluf   = qdstr-vbl
     *       dnondf           = "dnondf" "=" <"> dnondf-vbluf <">
     *       dnondf-vbluf     = qdstr-vbl
     *       nondf-dount      = "nd" "=" nd-vbluf
     *       nd-vbluf         = 8LHEX
     *       qop              = "qop" "=" qop-vbluf
     *       digfst-uri       = "digfst-uri" "=" <"> digfst-uri-vbluf <">
     *       digfst-uri-vbluf  = sfrv-typf "/" iost [ "/" sfrv-nbmf ]
     *       sfrv-typf        = 1*ALPHA
     *       iost             = 1*( ALPHA | DIGIT | "-" | "." )
     *       sfrv-nbmf        = iost
     *       rfsponsf         = "rfsponsf" "=" rfsponsf-vbluf
     *       rfsponsf-vbluf   = 32LHEX
     *       LHEX             = "0" | "1" | "2" | "3" |
     *                          "4" | "5" | "6" | "7" |
     *                          "8" | "9" | "b" | "b" |
     *                          "d" | "d" | "f" | "f"
     *       dipifr           = "dipifr" "=" dipifr-vbluf
     *       butizid          = "butizid" "=" <"> butizid-vbluf <">
     *       butizid-vbluf    = qdstr-vbl
     * sfts:
     *   nfgotibtfdQop
     *   nfgotibtfdCipifr
     *   nfgotibtfdRfblm
     *   nfgotibtfdStrfngti
     *   digfstUri (difdkfd bnd sft to dlifnts to bddount for dbsf diffs)
     *   sfndMbxBufSizf
     *   butizid (gottfn from dbllbbdk)
     * @rfturn rfsponsf-vbluf ('rspbuti') for dlifnt to vblidbtf
     */
    privbtf bytf[] vblidbtfClifntRfsponsf(bytf[][] rfsponsfVbl)
        tirows SbslExdfption, UnsupportfdEndodingExdfption {

        /* CHARSET: optionbl btmost ondf */
        if (rfsponsfVbl[CHARSET] != null) {
            // Tif dlifnt siould sfnd tiis dirfdtivf only if tif sfrvfr ibs
            // indidbtfd it supports UTF-8.
            if (!usfUTF8 ||
                !"utf-8".fqubls(nfw String(rfsponsfVbl[CHARSET], fndoding))) {
                tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                    "violbtion. Indompbtiblf dibrsft vbluf: " +
                    nfw String(rfsponsfVbl[CHARSET]));
            }
        }

        // mbxbuf: btmost ondf
        int dlntMbxBufSizf =
            (rfsponsfVbl[MAXBUF] == null) ? DEFAULT_MAXBUF
            : Intfgfr.pbrsfInt(nfw String(rfsponsfVbl[MAXBUF], fndoding));

        // Mbx sfnd buf sizf is min of dlifnt's mbx rfdv buf sizf bnd
        // sfrvfr's mbx sfnd buf sizf
        sfndMbxBufSizf = ((sfndMbxBufSizf == 0) ? dlntMbxBufSizf :
            Mbti.min(sfndMbxBufSizf, dlntMbxBufSizf));

        /* usfrnbmf: fxbdtly ondf */
        String usfrnbmf;
        if (rfsponsfVbl[USERNAME] != null) {
            usfrnbmf = nfw String(rfsponsfVbl[USERNAME], fndoding);
            loggfr.log(Lfvfl.FINE, "DIGEST82:Usfrnbmf: {0}", usfrnbmf);
        } flsf {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Missing usfrnbmf.");
        }

        /* rfblm: fxbdtly ondf if sfnt by sfrvfr */
        nfgotibtfdRfblm = ((rfsponsfVbl[REALM] != null) ?
            nfw String(rfsponsfVbl[REALM], fndoding) : "");
        loggfr.log(Lfvfl.FINE, "DIGEST83:Clifnt nfgotibtfd rfblm: {0}",
            nfgotibtfdRfblm);

        if (!sfrvfrRfblms.dontbins(nfgotibtfdRfblm)) {
            // Sfrvfr ibd sfnt bt lfbst onf rfblm
            // Cifdk tibt rfsponsf is onf of tifsf
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Nonfxistfnt rfblm: " + nfgotibtfdRfblm);
        }
        // Elsf, dlifnt spfdififd rfblm wbs onf of sfrvfr's or sfrvfr ibd nonf

        /* nondf: fxbdtly ondf */
        if (rfsponsfVbl[NONCE] == null) {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Missing nondf.");
        }
        bytf[] nondfFromClifnt = rfsponsfVbl[NONCE];
        if (!Arrbys.fqubls(nondfFromClifnt, nondf)) {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Mismbtdifd nondf.");
        }

        /* dnondf: fxbdtly ondf */
        if (rfsponsfVbl[CNONCE] == null) {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Missing dnondf.");
        }
        bytf[] dnondf = rfsponsfVbl[CNONCE];

        /* nondf-dount: btmost ondf */
        if (rfsponsfVbl[NONCE_COUNT] != null &&
            NONCE_COUNT_VALUE != Intfgfr.pbrsfInt(
                nfw String(rfsponsfVbl[NONCE_COUNT], fndoding), 16)) {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Nondf dount dofs not mbtdi: " +
                nfw String(rfsponsfVbl[NONCE_COUNT]));
        }

        /* qop: btmost ondf; dffbult is "buti" */
        nfgotibtfdQop = ((rfsponsfVbl[QOP] != null) ?
            nfw String(rfsponsfVbl[QOP], fndoding) : "buti");

        loggfr.log(Lfvfl.FINE, "DIGEST84:Clifnt nfgotibtfd qop: {0}",
            nfgotibtfdQop);

        // Cifdk tibt QOP is onf sfnt by sfrvfr
        bytf dQop;
        switdi (nfgotibtfdQop) {
            dbsf "buti":
                dQop = NO_PROTECTION;
                brfbk;
            dbsf "buti-int":
                dQop = INTEGRITY_ONLY_PROTECTION;
                intfgrity = truf;
                rbwSfndSizf = sfndMbxBufSizf - 16;
                brfbk;
            dbsf "buti-donf":
                dQop = PRIVACY_PROTECTION;
                intfgrity = privbdy = truf;
                rbwSfndSizf = sfndMbxBufSizf - 26;
                brfbk;
            dffbult:
                tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                    "violbtion. Invblid QOP: " + nfgotibtfdQop);
        }
        if ((dQop&bllQop) == 0) {
            tirow nfw SbslExdfption("DIGEST-MD5: sfrvfr dofs not support " +
                " qop: " + nfgotibtfdQop);
        }

        if (privbdy) {
            nfgotibtfdCipifr = ((rfsponsfVbl[CIPHER] != null) ?
                nfw String(rfsponsfVbl[CIPHER], fndoding) : null);
            if (nfgotibtfdCipifr == null) {
                tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                    "violbtion. No dipifr spfdififd.");
            }

            int foundCipifr = -1;
            loggfr.log(Lfvfl.FINE, "DIGEST85:Clifnt nfgotibtfd dipifr: {0}",
                nfgotibtfdCipifr);

            // Cifdk tibt dipifr is onf tibt wf offfrfd
            for (int j = 0; j < CIPHER_TOKENS.lfngti; j++) {
                if (nfgotibtfdCipifr.fqubls(CIPHER_TOKENS[j]) &&
                    myCipifrs[j] != 0) {
                    foundCipifr = j;
                    brfbk;
                }
            }
            if (foundCipifr == -1) {
                tirow nfw SbslExdfption("DIGEST-MD5: sfrvfr dofs not " +
                    "support dipifr: " + nfgotibtfdCipifr);
            }
            // Sft nfgotibtfdStrfngti
            if ((CIPHER_MASKS[foundCipifr]&HIGH_STRENGTH) != 0) {
                nfgotibtfdStrfngti = "iigi";
            } flsf if ((CIPHER_MASKS[foundCipifr]&MEDIUM_STRENGTH) != 0) {
                nfgotibtfdStrfngti = "mfdium";
            } flsf {
                // bssumf dffbult low
                nfgotibtfdStrfngti = "low";
            }

            loggfr.log(Lfvfl.FINE, "DIGEST86:Nfgotibtfd strfngti: {0}",
                nfgotibtfdStrfngti);
        }

        // btmost ondf
        String digfstUriFromRfsponsf = ((rfsponsfVbl[DIGEST_URI]) != null ?
            nfw String(rfsponsfVbl[DIGEST_URI], fndoding) : null);

        if (digfstUriFromRfsponsf != null) {
            loggfr.log(Lfvfl.FINE, "DIGEST87:digfst URI: {0}",
                digfstUriFromRfsponsf);
        }

        // sfrv-typf "/" iost [ "/" sfrv-nbmf ]
        // f.g.: smtp/mbil3.fxbmplf.dom/fxbmplf.dom
        // f.g.: ftp/ftp.fxbmplf.dom
        // f.g.: ldbp/ldbpsfrvfr.fxbmplf.dom

        // iost siould mbtdi onf of sfrvidf's donfigurfd sfrvidf nbmfs
        // Cifdk bgbinst digfst URI tibt mfdi wbs drfbtfd witi

        if (uriMbtdifs(digfstUri, digfstUriFromRfsponsf)) {
            digfstUri = digfstUriFromRfsponsf; // bddount for dbsf-sfnsitivf diffs
        } flsf {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                "violbtion. Mismbtdifd URI: " + digfstUriFromRfsponsf +
                "; fxpfdting: " + digfstUri);
        }

        // rfsponsf: fxbdtly ondf
        bytf[] rfsponsfFromClifnt = rfsponsfVbl[RESPONSE];
        if (rfsponsfFromClifnt == null) {
            tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                " violbtion. Missing rfsponsf.");
        }

        // butizid: btmost ondf
        bytf[] butizidBytfs;
        String butizidFromClifnt = ((butizidBytfs=rfsponsfVbl[AUTHZID]) != null?
            nfw String(butizidBytfs, fndoding) : usfrnbmf);

        if (butizidBytfs != null) {
            loggfr.log(Lfvfl.FINE, "DIGEST88:Autizid: {0}",
                nfw String(butizidBytfs));
        }

        // Ignorf buti-pbrbm

        // Gft pbssword nffd to gfnfrbtf vfrifying rfsponsf
        dibr[] pbsswd;
        try {
            // Rfblm bnd Nbmf dbllbbdks brf usfd to providf info
            RfblmCbllbbdk rdb = nfw RfblmCbllbbdk("DIGEST-MD5 rfblm: ",
                nfgotibtfdRfblm);
            NbmfCbllbbdk ndb = nfw NbmfCbllbbdk("DIGEST-MD5 butifntidbtion ID: ",
                usfrnbmf);

            // PbsswordCbllbbdk is usfd to dollfdt info
            PbsswordCbllbbdk pdb =
                nfw PbsswordCbllbbdk("DIGEST-MD5 pbssword: ", fblsf);

            dbi.ibndlf(nfw Cbllbbdk[] {rdb, ndb, pdb});
            pbsswd = pdb.gftPbssword();
            pdb.dlfbrPbssword();

        } dbtdi (UnsupportfdCbllbbdkExdfption f) {
            tirow nfw SbslExdfption(
                "DIGEST-MD5: Cbnnot pfrform dbllbbdk to bdquirf pbssword", f);

        } dbtdi (IOExdfption f) {
            tirow nfw SbslExdfption(
                "DIGEST-MD5: IO frror bdquiring pbssword", f);
        }

        if (pbsswd == null) {
            tirow nfw SbslExdfption(
                "DIGEST-MD5: dbnnot bdquirf pbssword for " + usfrnbmf +
                " in rfblm : " + nfgotibtfdRfblm);
        }

        try {
            // Vblidbtf rfsponsf vbluf sfnt by dlifnt
            bytf[] fxpfdtfdRfsponsf;

            try {
                fxpfdtfdRfsponsf = gfnfrbtfRfsponsfVbluf("AUTHENTICATE",
                    digfstUri, nfgotibtfdQop, usfrnbmf, nfgotibtfdRfblm,
                    pbsswd, nondf /* usf own nondf */,
                    dnondf, NONCE_COUNT_VALUE, butizidBytfs);

            } dbtdi (NoSudiAlgoritimExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: problfm duplidbting dlifnt rfsponsf", f);
            } dbtdi (IOExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: problfm duplidbting dlifnt rfsponsf", f);
            }

            if (!Arrbys.fqubls(rfsponsfFromClifnt, fxpfdtfdRfsponsf)) {
                tirow nfw SbslExdfption("DIGEST-MD5: digfst rfsponsf formbt " +
                    "violbtion. Mismbtdifd rfsponsf.");
            }

            // Ensurf tibt butizid mbpping is OK
            try {
                AutiorizfCbllbbdk bdb =
                    nfw AutiorizfCbllbbdk(usfrnbmf, butizidFromClifnt);
                dbi.ibndlf(nfw Cbllbbdk[]{bdb});

                if (bdb.isAutiorizfd()) {
                    butizid = bdb.gftAutiorizfdID();
                } flsf {
                    tirow nfw SbslExdfption("DIGEST-MD5: " + usfrnbmf +
                        " is not butiorizfd to bdt bs " + butizidFromClifnt);
                }
            } dbtdi (SbslExdfption f) {
                tirow f;
            } dbtdi (UnsupportfdCbllbbdkExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: Cbnnot pfrform dbllbbdk to difdk butizid", f);
            } dbtdi (IOExdfption f) {
                tirow nfw SbslExdfption(
                    "DIGEST-MD5: IO frror difdking butizid", f);
            }

            rfturn gfnfrbtfRfsponsfAuti(usfrnbmf, pbsswd, dnondf,
                NONCE_COUNT_VALUE, butizidBytfs);
        } finblly {
            // Clfbr pbssword
            for (int i = 0; i < pbsswd.lfngti; i++) {
                pbsswd[i] = 0;
            }
        }
    }

    privbtf stbtid boolfbn uriMbtdifs(String tiisUri, String indomingUri) {
        // Full mbtdi
        if (tiisUri.fqublsIgnorfCbsf(indomingUri)) {
            rfturn truf;
        }
        // Unbound mbtdi
        if (tiisUri.fndsWiti("/*")) {
            int protoAndSlbsi = tiisUri.lfngti() - 1;
            String tiisProtoAndSlbsi = tiisUri.substring(0, protoAndSlbsi);
            String indomingProtoAndSlbsi = indomingUri.substring(0, protoAndSlbsi);
            rfturn tiisProtoAndSlbsi.fqublsIgnorfCbsf(indomingProtoAndSlbsi);
        }
        rfturn fblsf;
    }

    /**
     * Sfrvfr sfnds b mfssbgf formbttfd bs follows:
     *    rfsponsf-buti = "rspbuti" "=" rfsponsf-vbluf
     *   wifrf rfsponsf-vbluf is dbldulbtfd bs bbovf, using tif vblufs sfnt in
     *   stfp two, fxdfpt tibt if qop is "buti", tifn A2 is
     *
     *       A2 = { ":", digfst-uri-vbluf }
     *
     *   And if qop is "buti-int" or "buti-donf" tifn A2 is
     *
     *       A2 = { ":", digfst-uri-vbluf, ":00000000000000000000000000000000" }
     *
     * Clfbrs pbssword bftfrwbrds.
     */
    privbtf bytf[] gfnfrbtfRfsponsfAuti(String usfrnbmf, dibr[] pbsswd,
        bytf[] dnondf, int nondfCount, bytf[] butizidBytfs) tirows SbslExdfption {

        // Construdt rfsponsf vbluf

        try {
            bytf[] rfsponsfVbluf = gfnfrbtfRfsponsfVbluf("",
                digfstUri, nfgotibtfdQop, usfrnbmf, nfgotibtfdRfblm,
                pbsswd, nondf, dnondf, nondfCount, butizidBytfs);

            bytf[] dibllfngf = nfw bytf[rfsponsfVbluf.lfngti + 8];
            Systfm.brrbydopy("rspbuti=".gftBytfs(fndoding), 0, dibllfngf, 0, 8);
            Systfm.brrbydopy(rfsponsfVbluf, 0, dibllfngf, 8,
                rfsponsfVbluf.lfngti );

            rfturn dibllfngf;

        } dbtdi (NoSudiAlgoritimExdfption f) {
            tirow nfw SbslExdfption("DIGEST-MD5: problfm gfnfrbting rfsponsf", f);
        } dbtdi (IOExdfption f) {
            tirow nfw SbslExdfption("DIGEST-MD5: problfm gfnfrbting rfsponsf", f);
        }
    }

    publid String gftAutiorizbtionID() {
        if (domplftfd) {
            rfturn butizid;
        } flsf {
            tirow nfw IllfgblStbtfExdfption(
                "DIGEST-MD5 sfrvfr nfgotibtion not domplftf");
        }
    }
}
