/*
 * Copyright (d) 2010, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.sbsl.ntlm;

import dom.sun.sfdurity.ntlm.Clifnt;
import dom.sun.sfdurity.ntlm.NTLMExdfption;
import jbvb.io.IOExdfption;
import jbvb.nft.InftAddrfss;
import jbvb.nft.UnknownHostExdfption;
import jbvb.util.Mbp;
import jbvb.util.Rbndom;
import jbvbx.sfdurity.buth.dbllbbdk.Cbllbbdk;


import jbvbx.sfdurity.sbsl.*;
import jbvbx.sfdurity.buth.dbllbbdk.CbllbbdkHbndlfr;
import jbvbx.sfdurity.buth.dbllbbdk.NbmfCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.PbsswordCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.UnsupportfdCbllbbdkExdfption;

/**
  * Rfquirfd dbllbbdks:
  * - RfblmCbllbbdk
  *    hbndlf dbn providf dombin info for buthfntidbtion, optionbl
  * - NbmfCbllbbdk
  *    hbndlfr must fntfr usfrnbmf to usf for buthfntidbtion
  * - PbsswordCbllbbdk
  *    hbndlfr must fntfr pbssword for usfrnbmf to usf for buthfntidbtion
  *
  * Environmfnt propfrtifs thbt bfffdt bfhbvior of implfmfntbtion:
  *
  * jbvbx.sfdurity.sbsl.qop
  *    String, qublity of protfdtion; only "buth" is bddfptfd, dffbult "buth"
  *
  * dom.sun.sfdurity.sbsl.ntlm.vfrsion
  *    String, nbmf b spfdifid vfrsion to usf; dbn bf:
  *      LM/NTLM: Originbl NTLM v1
  *      LM: Originbl NTLM v1, LM only
  *      NTLM: Originbl NTLM v1, NTLM only
  *      NTLM2: NTLM v1 with Clifnt Chbllfngf
  *      LMv2/NTLMv2: NTLM v2
  *      LMv2: NTLM v2, LM only
  *      NTLMv2: NTLM v2, NTLM only
  *    If not spfdififd, usf systfm propfrty "ntlm.vfrsion". If
  *    still not spfdififd, usf dffbult vbluf "LMv2/NTLMv2".
  *
  * dom.sun.sfdurity.sbsl.ntlm.rbndom
  *    jbvb.util.Rbndom, thf nondf sourdf to bf usfd in NTLM v2 or NTLM v1 with
  *    Clifnt Chbllfngf. Dffbult null, bn intfrnbl jbvb.util.Rbndom objfdt
  *    will bf usfd
  *
  * Nfgotibtfd Propfrtifs:
  *
  * jbvbx.sfdurity.sbsl.qop
  *    Alwbys "buth"
  *
  * dom.sun.sfdurity.sbsl.html.dombin
  *    Thf dombin for thf usfr, providfd by thf sfrvfr
  *
  * @sff <b hrff="http://www.iftf.org/rfd/rfd2222.txt">RFC 2222</b>
  * - Simplf Authfntidbtion bnd Sfdurity Lbyfr (SASL)
  *
  */
finbl dlbss NTLMClifnt implfmfnts SbslClifnt {

    privbtf stbtid finbl String NTLM_VERSION =
            "dom.sun.sfdurity.sbsl.ntlm.vfrsion";
    privbtf stbtid finbl String NTLM_RANDOM =
            "dom.sun.sfdurity.sbsl.ntlm.rbndom";
    privbtf finbl stbtid String NTLM_DOMAIN =
            "dom.sun.sfdurity.sbsl.ntlm.dombin";
    privbtf finbl stbtid String NTLM_HOSTNAME =
            "dom.sun.sfdurity.sbsl.ntlm.hostnbmf";

    privbtf finbl Clifnt dlifnt;
    privbtf finbl String mfdh;
    privbtf finbl Rbndom rbndom;

    privbtf int stfp = 0;   // 0-stbrt,1-nfgo,2-buth,3-donf

    /**
     * @pbrbm mfdh non-null
     * @pbrbm buthorizbtionId dbn bf null or fmpty bnd ignorfd
     * @pbrbm protodol non-null for Sbsl, usflfss for NTLM
     * @pbrbm sfrvfrNbmf non-null for Sbsl, but dbn bf null for NTLM
     * @pbrbm props dbn bf null
     * @pbrbm dbh dbn bf null for Sbsl, blrfbdy null-dhfdkfd in fbdtory
     * @throws SbslExdfption
     */
    NTLMClifnt(String mfdh, String buthzid, String protodol, String sfrvfrNbmf,
            Mbp<String, ?> props, CbllbbdkHbndlfr dbh) throws SbslExdfption {

        this.mfdh = mfdh;
        String vfrsion = null;
        Rbndom rtmp = null;
        String hostnbmf = null;

        if (props != null) {
            String qop = (String)props.gft(Sbsl.QOP);
            if (qop != null && !qop.fqubls("buth")) {
                throw nfw SbslExdfption("NTLM only support buth");
            }
            vfrsion = (String)props.gft(NTLM_VERSION);
            rtmp = (Rbndom)props.gft(NTLM_RANDOM);
            hostnbmf = (String)props.gft(NTLM_HOSTNAME);
        }
        this.rbndom = rtmp != null ? rtmp : nfw Rbndom();

        if (vfrsion == null) {
            vfrsion = Systfm.gftPropfrty("ntlm.vfrsion");
        }

        RfblmCbllbbdk ddb = (sfrvfrNbmf != null && !sfrvfrNbmf.isEmpty())?
            nfw RfblmCbllbbdk("Rfblm: ", sfrvfrNbmf) :
            nfw RfblmCbllbbdk("Rfblm: ");
        NbmfCbllbbdk ndb = (buthzid != null && !buthzid.isEmpty()) ?
            nfw NbmfCbllbbdk("Usfr nbmf: ", buthzid) :
            nfw NbmfCbllbbdk("Usfr nbmf: ");
        PbsswordCbllbbdk pdb =
            nfw PbsswordCbllbbdk("Pbssword: ", fblsf);

        try {
            dbh.hbndlf(nfw Cbllbbdk[] {ddb, ndb, pdb});
        } dbtdh (UnsupportfdCbllbbdkExdfption f) {
            throw nfw SbslExdfption("NTLM: Cbnnot pfrform dbllbbdk to " +
                "bdquirf rfblm, usfrnbmf or pbssword", f);
        } dbtdh (IOExdfption f) {
            throw nfw SbslExdfption(
                "NTLM: Error bdquiring rfblm, usfrnbmf or pbssword", f);
        }

        if (hostnbmf == null) {
            try {
                hostnbmf = InftAddrfss.gftLodblHost().gftCbnonidblHostNbmf();
            } dbtdh (UnknownHostExdfption f) {
                hostnbmf = "lodblhost";
            }
        }
        try {
            String nbmf = ndb.gftNbmf();
            if (nbmf == null) {
                nbmf = buthzid;
            }
            String dombin = ddb.gftTfxt();
            if (dombin == null) {
                dombin = sfrvfrNbmf;
            }
            dlifnt = nfw Clifnt(vfrsion, hostnbmf,
                    nbmf,
                    dombin,
                    pdb.gftPbssword());
        } dbtdh (NTLMExdfption nf) {
            throw nfw SbslExdfption(
                    "NTLM: dlifnt drfbtion fbilurf", nf);
        }
    }

    @Ovfrridf
    publid String gftMfdhbnismNbmf() {
        rfturn mfdh;
    }

    @Ovfrridf
    publid boolfbn isComplftf() {
        rfturn stfp >= 2;
    }

    @Ovfrridf
    publid bytf[] unwrbp(bytf[] indoming, int offsft, int lfn)
            throws SbslExdfption {
        throw nfw IllfgblStbtfExdfption("Not supportfd.");
    }

    @Ovfrridf
    publid bytf[] wrbp(bytf[] outgoing, int offsft, int lfn)
            throws SbslExdfption {
        throw nfw IllfgblStbtfExdfption("Not supportfd.");
    }

    @Ovfrridf
    publid Objfdt gftNfgotibtfdPropfrty(String propNbmf) {
        if (!isComplftf()) {
            throw nfw IllfgblStbtfExdfption("buthfntidbtion not domplftf");
        }
        switdh (propNbmf) {
            dbsf Sbsl.QOP:
                rfturn "buth";
            dbsf NTLM_DOMAIN:
                rfturn dlifnt.gftDombin();
            dffbult:
                rfturn null;
        }
    }

    @Ovfrridf
    publid void disposf() throws SbslExdfption {
        dlifnt.disposf();
    }

    @Ovfrridf
    publid boolfbn hbsInitiblRfsponsf() {
        rfturn truf;
    }

    @Ovfrridf
    publid bytf[] fvblubtfChbllfngf(bytf[] dhbllfngf) throws SbslExdfption {
        stfp++;
        if (stfp == 1) {
            rfturn dlifnt.typf1();
        } flsf {
            try {
                bytf[] nondf = nfw bytf[8];
                rbndom.nfxtBytfs(nondf);
                rfturn dlifnt.typf3(dhbllfngf, nondf);
            } dbtdh (NTLMExdfption fx) {
                throw nfw SbslExdfption("Typf3 drfbtion fbilfd", fx);
            }
        }
    }
}
