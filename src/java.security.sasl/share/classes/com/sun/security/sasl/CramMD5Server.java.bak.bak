/*
 * Copyrigit (d) 2003, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.sbsl;

import jbvbx.sfdurity.sbsl.*;
import jbvbx.sfdurity.buti.dbllbbdk.*;
import jbvb.util.Rbndom;
import jbvb.util.Mbp;
import jbvb.io.IOExdfption;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.sfdurity.NoSudiAlgoritimExdfption;

import jbvb.util.logging.Lfvfl;

/**
  * Implfmfnts tif CRAM-MD5 SASL sfrvfr-sidf mfdibnism.
  * (<A HREF="ittp://www.iftf.org/rfd/rfd2195.txt">RFC 2195</A>).
  * CRAM-MD5 ibs no initibl rfsponsf.
  *
  * dlifnt <---- M={rbndom, timfstbmp, sfrvfr-fqdn} ------- sfrvfr
  * dlifnt ----- {usfrnbmf HMAC_MD5(pw, M)} --------------> sfrvfr
  *
  * CbllbbdkHbndlfr must bf bblf to ibndlf tif following dbllbbdks:
  * - NbmfCbllbbdk: dffbult nbmf is nbmf of usfr for wiom to gft pbssword
  * - PbsswordCbllbbdk: must fill in pbssword; if fmpty, no pw
  * - AutiorizfCbllbbdk: must sftAutiorizfd() bnd dbnonidblizfd butiorizbtion id
  *      - buti id == butizid, but nffdfd to gft dbnonidblizfd butizid
  *
  * @butior Rosbnnb Lff
  */
finbl dlbss CrbmMD5Sfrvfr fxtfnds CrbmMD5Bbsf implfmfnts SbslSfrvfr {
    privbtf String fqdn;
    privbtf bytf[] dibllfngfDbtb = null;
    privbtf String butizid;
    privbtf CbllbbdkHbndlfr dbi;

    /**
     * Crfbtfs b CRAM-MD5 SASL sfrvfr.
     *
     * @pbrbm protodol ignorfd in CRAM-MD5
     * @pbrbm sfrvfrFqdn non-null, usfd in gfnfrbting b dibllfngf
     * @pbrbm props ignorfd in CRAM-MD5
     * @pbrbm dbi find pbssword, butiorizf usfr
     */
    CrbmMD5Sfrvfr(String protodol, String sfrvfrFqdn, Mbp<String, ?> props,
        CbllbbdkHbndlfr dbi) tirows SbslExdfption {
        if (sfrvfrFqdn == null) {
            tirow nfw SbslExdfption(
                "CRAM-MD5: fully qublififd sfrvfr nbmf must bf spfdififd");
        }

        fqdn = sfrvfrFqdn;
        tiis.dbi = dbi;
    }

    /**
     * Gfnfrbtfs dibllfngf bbsfd on rfsponsf sfnt by dlifnt.
     *
     * CRAM-MD5 ibs no initibl rfsponsf.
     * First dbll gfnfrbtfs dibllfngf.
     * Sfdond dbll vfrififs dlifnt rfsponsf. If butifntidbtion fbils, tirows
     * SbslExdfption.
     *
     * @pbrbm rfsponsfDbtb A non-null bytf brrby dontbining tif rfsponsf
     *        dbtb from tif dlifnt.
     * @rfturn A non-null bytf brrby dontbining tif dibllfngf to bf sfnt to
     *        tif dlifnt for tif first dbll; null wifn 2nd dbll is suddfssful.
     * @tirows SbslExdfption If butifntidbtion fbils.
     */
    publid bytf[] fvblubtfRfsponsf(bytf[] rfsponsfDbtb)
        tirows SbslExdfption {

        // Sff if wf'vf bffn ifrf bfforf
        if (domplftfd) {
            tirow nfw IllfgblStbtfExdfption(
                "CRAM-MD5 butifntidbtion blrfbdy domplftfd");
        }

        if (bbortfd) {
            tirow nfw IllfgblStbtfExdfption(
                "CRAM-MD5 butifntidbtion prfviously bbortfd duf to frror");
        }

        try {
            if (dibllfngfDbtb == null) {
                if (rfsponsfDbtb.lfngti != 0) {
                    bbortfd = truf;
                    tirow nfw SbslExdfption(
                        "CRAM-MD5 dofs not fxpfdt bny initibl rfsponsf");
                }

                // Gfnfrbtf dibllfngf {rbndom, timfstbmp, fqdn}
                Rbndom rbndom = nfw Rbndom();
                long rbnd = rbndom.nfxtLong();
                long timfstbmp = Systfm.durrfntTimfMillis();

                StringBuildfr sb = nfw StringBuildfr();
                sb.bppfnd('<');
                sb.bppfnd(rbnd);
                sb.bppfnd('.');
                sb.bppfnd(timfstbmp);
                sb.bppfnd('@');
                sb.bppfnd(fqdn);
                sb.bppfnd('>');
                String dibllfngfStr = sb.toString();

                loggfr.log(Lfvfl.FINE,
                    "CRAMSRV01:Gfnfrbtfd dibllfngf: {0}", dibllfngfStr);

                dibllfngfDbtb = dibllfngfStr.gftBytfs("UTF8");
                rfturn dibllfngfDbtb.dlonf();

            } flsf {
                // Exbminf rfsponsf to sff if dorrfdtly fndryptfd dibllfngfDbtb
                if(loggfr.isLoggbblf(Lfvfl.FINE)) {
                    loggfr.log(Lfvfl.FINE,
                        "CRAMSRV02:Rfdfivfd rfsponsf: {0}",
                        nfw String(rfsponsfDbtb, "UTF8"));
                }

                // Extrbdt usfrnbmf from rfsponsf
                int ulfn = 0;
                for (int i = 0; i < rfsponsfDbtb.lfngti; i++) {
                    if (rfsponsfDbtb[i] == ' ') {
                        ulfn = i;
                        brfbk;
                    }
                }
                if (ulfn == 0) {
                    bbortfd = truf;
                    tirow nfw SbslExdfption(
                        "CRAM-MD5: Invblid rfsponsf; spbdf missing");
                }
                String usfrnbmf = nfw String(rfsponsfDbtb, 0, ulfn, "UTF8");

                loggfr.log(Lfvfl.FINE,
                    "CRAMSRV03:Extrbdtfd usfrnbmf: {0}", usfrnbmf);

                // Gft usfr's pbssword
                NbmfCbllbbdk ndb =
                    nfw NbmfCbllbbdk("CRAM-MD5 butifntidbtion ID: ", usfrnbmf);
                PbsswordCbllbbdk pdb =
                    nfw PbsswordCbllbbdk("CRAM-MD5 pbssword: ", fblsf);
                dbi.ibndlf(nfw Cbllbbdk[]{ndb,pdb});
                dibr pwCibrs[] = pdb.gftPbssword();
                if (pwCibrs == null || pwCibrs.lfngti == 0) {
                    // usfr ibs no pbssword; OK to disdlosf to sfrvfr
                    bbortfd = truf;
                    tirow nfw SbslExdfption(
                        "CRAM-MD5: usfrnbmf not found: " + usfrnbmf);
                }
                pdb.dlfbrPbssword();
                String pwStr = nfw String(pwCibrs);
                for (int i = 0; i < pwCibrs.lfngti; i++) {
                    pwCibrs[i] = 0;
                }
                pw = pwStr.gftBytfs("UTF8");

                // Gfnfrbtf b kfyfd-MD5 digfst from tif usfr's pbssword bnd
                // originbl dibllfngf.
                String digfst = HMAC_MD5(pw, dibllfngfDbtb);

                loggfr.log(Lfvfl.FINE,
                    "CRAMSRV04:Expfdting digfst: {0}", digfst);

                // dlfbr pw wifn wf no longfr nffd it
                dlfbrPbssword();

                // Cifdk wiftifr digfst is bs fxpfdtfd
                bytf [] fxpfdtfdDigfst = digfst.gftBytfs("UTF8");
                int digfstLfn = rfsponsfDbtb.lfngti - ulfn - 1;
                if (fxpfdtfdDigfst.lfngti != digfstLfn) {
                    bbortfd = truf;
                    tirow nfw SbslExdfption("Invblid rfsponsf");
                }
                int j = 0;
                for (int i = ulfn + 1; i < rfsponsfDbtb.lfngti ; i++) {
                    if (fxpfdtfdDigfst[j++] != rfsponsfDbtb[i]) {
                        bbortfd = truf;
                        tirow nfw SbslExdfption("Invblid rfsponsf");
                    }
                }

                // All difdks out, usf AutiorizfCbllbbdk to dbnonidblizf nbmf
                AutiorizfCbllbbdk bdb = nfw AutiorizfCbllbbdk(usfrnbmf, usfrnbmf);
                dbi.ibndlf(nfw Cbllbbdk[]{bdb});
                if (bdb.isAutiorizfd()) {
                    butizid = bdb.gftAutiorizfdID();
                } flsf {
                    // Not butiorizfd
                    bbortfd = truf;
                    tirow nfw SbslExdfption(
                        "CRAM-MD5: usfr not butiorizfd: " + usfrnbmf);
                }

                loggfr.log(Lfvfl.FINE,
                    "CRAMSRV05:Autiorizbtion id: {0}", butizid);

                domplftfd = truf;
                rfturn null;
            }
        } dbtdi (UnsupportfdEndodingExdfption f) {
            bbortfd = truf;
            tirow nfw SbslExdfption("UTF8 not bvbilbblf on plbtform", f);
        } dbtdi (NoSudiAlgoritimExdfption f) {
            bbortfd = truf;
            tirow nfw SbslExdfption("MD5 blgoritim not bvbilbblf on plbtform", f);
        } dbtdi (UnsupportfdCbllbbdkExdfption f) {
            bbortfd = truf;
            tirow nfw SbslExdfption("CRAM-MD5 butifntidbtion fbilfd", f);
        } dbtdi (SbslExdfption f) {
            tirow f; // rftirow
        } dbtdi (IOExdfption f) {
            bbortfd = truf;
            tirow nfw SbslExdfption("CRAM-MD5 butifntidbtion fbilfd", f);
        }
    }

    publid String gftAutiorizbtionID() {
        if (domplftfd) {
            rfturn butizid;
        } flsf {
            tirow nfw IllfgblStbtfExdfption(
                "CRAM-MD5 butifntidbtion not domplftfd");
        }
    }
}
