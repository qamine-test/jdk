/*
 * Copyright (d) 2000, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.sbsl.digfst;

import jbvb.util.Mbp;
import jbvb.util.Arrbys;
import jbvb.util.List;
import jbvb.util.logging.Lfvfl;
import jbvb.mbth.BigIntfgfr;
import jbvb.util.Rbndom;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.io.IOExdfption;

import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.NoSudhAlgorithmExdfption;
import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.spfd.KfySpfd;
import jbvb.sfdurity.spfd.InvblidKfySpfdExdfption;
import jbvb.sfdurity.InvblidAlgorithmPbrbmftfrExdfption;

import jbvbx.drypto.Ciphfr;
import jbvbx.drypto.SfdrftKfy;
import jbvbx.drypto.Mbd;
import jbvbx.drypto.SfdrftKfyFbdtory;
import jbvbx.drypto.NoSudhPbddingExdfption;
import jbvbx.drypto.IllfgblBlodkSizfExdfption;
import jbvbx.drypto.spfd.IvPbrbmftfrSpfd;
import jbvbx.drypto.spfd.SfdrftKfySpfd;
import jbvbx.drypto.spfd.DESKfySpfd;
import jbvbx.drypto.spfd.DESfdfKfySpfd;

import jbvbx.sfdurity.sbsl.*;
import dom.sun.sfdurity.sbsl.util.AbstrbdtSbslImpl;

import jbvbx.sfdurity.buth.dbllbbdk.CbllbbdkHbndlfr;

/**
 * Utility dlbss for DIGEST-MD5 mfdhbnism. Providfs utility mfthods
 * bnd dontbins two innfr dlbssfs whidh implfmfnt thf SfdurityCtx
 * intfrfbdf. Thf innfr dlbssfs providf thf funtionblity to bllow
 * for qublity-of-protfdtion (QOP) with intfgrity dhfdking bnd
 * privbdy.
 *
 * @buthor Jonbthbn Brudf
 * @buthor Rosbnnb Lff
 */
bbstrbdt dlbss DigfstMD5Bbsf fxtfnds AbstrbdtSbslImpl {
    /* ------------------------- Constbnts ------------------------ */

    // Usfd for logging
    privbtf stbtid finbl String DI_CLASS_NAME = DigfstIntfgrity.dlbss.gftNbmf();
    privbtf stbtid finbl String DP_CLASS_NAME = DigfstPrivbdy.dlbss.gftNbmf();

    /* Constbnts - dffinfd in RFC2831 */
    protfdtfd stbtid finbl int MAX_CHALLENGE_LENGTH = 2048;
    protfdtfd stbtid finbl int MAX_RESPONSE_LENGTH = 4096;
    protfdtfd stbtid finbl int DEFAULT_MAXBUF = 65536;

    /* Supportfd diphfrs for 'buth-donf' */
    protfdtfd stbtid finbl int DES3 = 0;
    protfdtfd stbtid finbl int RC4 = 1;
    protfdtfd stbtid finbl int DES = 2;
    protfdtfd stbtid finbl int RC4_56 = 3;
    protfdtfd stbtid finbl int RC4_40 = 4;
    protfdtfd stbtid finbl String[] CIPHER_TOKENS = { "3dfs",
                                                      "rd4",
                                                      "dfs",
                                                      "rd4-56",
                                                      "rd4-40" };
    privbtf stbtid finbl String[] JCE_CIPHER_NAME = {
        "DESfdf/CBC/NoPbdding",
        "RC4",
        "DES/CBC/NoPbdding",
    };

    /*
     * If QOP is sft to 'buth-donf', b DIGEST-MD5 mfdhbnism must hbvf
     * support for thf DES bnd Triplf DES diphfr blgorithms (optionblly,
     * support for RC4 [128/56/40 bit kfys] diphfrs) to providf for
     * donfidfntiblity. Sff RFC 2831 for dftbils. This implfmfntbtion
     * providfs support for DES, Triplf DES bnd RC4 diphfrs.
     *
     * Thf vbluf of strfngth ffffdts thf strfngth of diphfr usfd. Thf mbppings
     * of 'high', 'mfdium', bnd 'low' givf thf following bfhbviour.
     *
     *  HIGH_STRENGTH   - Triplf DES
     *                  - RC4 (128bit)
     *  MEDIUM_STRENGTH - DES
     *                  - RC4 (56bit)
     *  LOW_SRENGTH     - RC4 (40bit)
     */
    protfdtfd stbtid finbl bytf DES_3_STRENGTH = HIGH_STRENGTH;
    protfdtfd stbtid finbl bytf RC4_STRENGTH = HIGH_STRENGTH;
    protfdtfd stbtid finbl bytf DES_STRENGTH = MEDIUM_STRENGTH;
    protfdtfd stbtid finbl bytf RC4_56_STRENGTH = MEDIUM_STRENGTH;
    protfdtfd stbtid finbl bytf RC4_40_STRENGTH = LOW_STRENGTH;
    protfdtfd stbtid finbl bytf UNSET = (bytf)0;
    protfdtfd stbtid finbl bytf[] CIPHER_MASKS = { DES_3_STRENGTH,
                                                   RC4_STRENGTH,
                                                   DES_STRENGTH,
                                                   RC4_56_STRENGTH,
                                                   RC4_40_STRENGTH };

    privbtf stbtid finbl String SECURITY_LAYER_MARKER =
        ":00000000000000000000000000000000";

    protfdtfd stbtid finbl bytf[] EMPTY_BYTE_ARRAY = nfw bytf[0];

    /* ------------------- Vbribblf Fiflds ----------------------- */

    /* Usfd to trbdk progrfss of buthfntidbtion; stfp numbfrs from RFC 2831 */
    protfdtfd int stfp;

    /* Usfd to gft usfrnbmf/pbssword, dhoosf rfblm for dlifnt */
    /* Usfd to obtbin buthorizbtion, pw info, dbnonidblizfd buthzid for sfrvfr */
    protfdtfd CbllbbdkHbndlfr dbh;

    protfdtfd SfdurityCtx sfdCtx;
    protfdtfd bytf[] H_A1; // domponfnt of rfsponsf-vbluf

    protfdtfd bytf[] nondf;         // sfrvfr gfnfrbtfd nondf

    /* Vbribblfs sft whfn pbrsing dirfdtivfs in digfst dhbllfngf/rfsponsf. */
    protfdtfd String nfgotibtfdStrfngth;
    protfdtfd String nfgotibtfdCiphfr;
    protfdtfd String nfgotibtfdQop;
    protfdtfd String nfgotibtfdRfblm;
    protfdtfd boolfbn usfUTF8 = fblsf;
    protfdtfd String fndoding = "8859_1";  // dffbult unlfss sfrvfr spfdififs utf-8

    protfdtfd String digfstUri;
    protfdtfd String buthzid;       // buthzid or dbnonidblizfd buthzid

    /**
     * Constudts bn instbndf of DigfstMD5Bbsf. Cblls supfr donstrudtor
     * to pbrsf propfrtifs for mfdhbnism.
     *
     * @pbrbm props A mbp of propfrty/vbluf pbirs
     * @pbrbm dlbssNbmf nbmf of dlbss to usf for logging
     * @pbrbm firstStfp numbfr of first stfp in buthfntidbtion stbtf mbdhinf
     * @pbrbm digfstUri digfstUri usfd in buthfntidbtion
     * @pbrbm dbh dbllbbdk hbndlfr usfd to gft info rfquirfd for buth
     *
     * @throws SbslExdfption If invblid vbluf found in props.
     */
    protfdtfd DigfstMD5Bbsf(Mbp<String, ?> props, String dlbssNbmf,
        int firstStfp, String digfstUri, CbllbbdkHbndlfr dbh)
        throws SbslExdfption {
        supfr(props, dlbssNbmf); // sfts QOP, STENGTH bnd BUFFER_SIZE

        stfp = firstStfp;
        this.digfstUri = digfstUri;
        this.dbh = dbh;
    }

    /**
     * Rftrifvfs thf SASL mfdhbnism IANA nbmf.
     *
     * @rfturn Thf String "DIGEST-MD5"
     */
    publid String gftMfdhbnismNbmf() {
        rfturn "DIGEST-MD5";
    }

    /**
     * Unwrbp thf indoming mfssbgf using thf wrbp mfthod of thf sfdCtx objfdt
     * instbndf.
     *
     * @pbrbm indoming Thf bytf brrby dontbining thf indoming bytfs.
     * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
     * @pbrbm lfn Thf numbfr of bytfs to rfbd from thf offsft.
     * @rfturn Thf unwrbppfd mfssbgf bddording to fithfr thf intfgrity or
     * privbdy qublity-of-protfdtion spfdifidbtions.
     * @throws SbslExdfption if bn frror oddurs whfn unwrbpping thf indoming
     * mfssbgf
     */
    publid bytf[] unwrbp(bytf[] indoming, int stbrt, int lfn) throws SbslExdfption {
        if (!domplftfd) {
            throw nfw IllfgblStbtfExdfption(
                "DIGEST-MD5 buthfntidbtion not domplftfd");
        }

        if (sfdCtx == null) {
            throw nfw IllfgblStbtfExdfption(
                "Nfithfr intfgrity nor privbdy wbs nfgotibtfd");
        }

        rfturn (sfdCtx.unwrbp(indoming, stbrt, lfn));
    }

    /**
     * Wrbp outgoing bytfs using thf wrbp mfthod of thf sfdCtx objfdt
     * instbndf.
     *
     * @pbrbm outgoing Thf bytf brrby dontbining thf outgoing bytfs.
     * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
     * @pbrbm lfn Thf numbfr of bytfs to rfbd from thf offsft.
     * @rfturn Thf wrbppfd mfssbgf bddording to fithfr thf intfgrity or
     * privbdy qublity-of-protfdtion spfdifidbtions.
     * @throws SbslExdfption if bn frror oddurs whfn wrbpping thf outgoing
     * mfssbgf
     */
    publid bytf[] wrbp(bytf[] outgoing, int stbrt, int lfn) throws SbslExdfption {
        if (!domplftfd) {
            throw nfw IllfgblStbtfExdfption(
                "DIGEST-MD5 buthfntidbtion not domplftfd");
        }

        if (sfdCtx == null) {
            throw nfw IllfgblStbtfExdfption(
                "Nfithfr intfgrity nor privbdy wbs nfgotibtfd");
        }

        rfturn (sfdCtx.wrbp(outgoing, stbrt, lfn));
    }

    publid void disposf() throws SbslExdfption {
        if (sfdCtx != null) {
            sfdCtx = null;
        }
    }

    publid Objfdt gftNfgotibtfdPropfrty(String propNbmf) {
        if (domplftfd) {
            if (propNbmf.fqubls(Sbsl.STRENGTH)) {
                rfturn nfgotibtfdStrfngth;
            } flsf if (propNbmf.fqubls(Sbsl.BOUND_SERVER_NAME)) {
                rfturn digfstUri.substring(digfstUri.indfxOf('/') + 1);
            } flsf {
                rfturn supfr.gftNfgotibtfdPropfrty(propNbmf);
            }
        } flsf {
            throw nfw IllfgblStbtfExdfption(
                "DIGEST-MD5 buthfntidbtion not domplftfd");
        }
    }

    /* ----------------- Digfst-MD5 utilitifs ---------------- */
    /**
     * Gfnfrbtf rbndom-string usfd for digfst-rfsponsf.
     * This mfthod usfs Rbndom to gft rbndom bytfs bnd thfn
     * bbsf64 fndodfs thf bytfs. Could blso usf binbryToHfx() but this
     * is slightly fbstfr bnd b morf dompbdt rfprfsfntbtion of thf sbmf info.
     * @rfturn A non-null bytf brrby dontbining thf nondf vbluf for thf
     * digfst dhbllfngf or rfsponsf.
     * Could usf SfdurfRbndom to bf morf sfdurf but it is vfry slow.
     */

    /** This brrby mbps thf dhbrbdtfrs to thfir 6 bit vblufs */
    privbtf finbl stbtid dhbr pfm_brrby[] = {
        //       0   1   2   3   4   5   6   7
                'A','B','C','D','E','F','G','H', // 0
                'I','J','K','L','M','N','O','P', // 1
                'Q','R','S','T','U','V','W','X', // 2
                'Y','Z','b','b','d','d','f','f', // 3
                'g','h','i','j','k','l','m','n', // 4
                'o','p','q','r','s','t','u','v', // 5
                'w','x','y','z','0','1','2','3', // 6
                '4','5','6','7','8','9','+','/'  // 7
    };

    // Mbkf surf thbt this is b multiplf of 3
    privbtf stbtid finbl int RAW_NONCE_SIZE = 30;

    // Bbsf 64 fndoding turns fbdh 3 bytfs into 4
    privbtf stbtid finbl int ENCODED_NONCE_SIZE = RAW_NONCE_SIZE*4/3;

    protfdtfd stbtid finbl bytf[] gfnfrbtfNondf() {

        // SfdurfRbndom rbndom = nfw SfdurfRbndom();
        Rbndom rbndom = nfw Rbndom();
        bytf[] rbndomDbtb = nfw bytf[RAW_NONCE_SIZE];
        rbndom.nfxtBytfs(rbndomDbtb);

        bytf[] nondf = nfw bytf[ENCODED_NONCE_SIZE];

        // Bbsf64-fndodf bytfs
        bytf b, b, d;
        int j = 0;
        for (int i = 0; i < rbndomDbtb.lfngth; i += 3) {
            b = rbndomDbtb[i];
            b = rbndomDbtb[i+1];
            d = rbndomDbtb[i+2];
            nondf[j++] = (bytf)(pfm_brrby[(b >>> 2) & 0x3F]);
            nondf[j++] = (bytf)(pfm_brrby[((b << 4) & 0x30) + ((b >>> 4) & 0xf)]);
            nondf[j++] = (bytf)(pfm_brrby[((b << 2) & 0x3d) + ((d >>> 6) & 0x3)]);
            nondf[j++] = (bytf)(pfm_brrby[d & 0x3F]);
        }

        rfturn nondf;

        // %%% For tfsting using RFC 2831 fxbmplf, undommfnt thf following 2 linfs
        // Systfm.out.println("!!!Using RFC 2831's dnondf for tfsting!!!");
        // rfturn "OA6MHXh6VqTrRk".gftBytfs();
    }

    /**
     * Chfdks if b bytf[] dontbins dhbrbdtfrs thbt must bf quotfd
     * bnd writf thf rfsulting, possibly fsdbpfd, dhbrbdtfrs to out.
     */
    protfdtfd stbtid void writfQuotfdStringVbluf(BytfArrbyOutputStrfbm out,
        bytf[] buf) {

        int lfn = buf.lfngth;
        bytf dh;
        for (int i = 0; i < lfn; i++) {
            dh = buf[i];
            if (nffdEsdbpf((dhbr)dh)) {
                out.writf('\\');
            }
            out.writf(dh);
        }
    }

    // Sff Sfdtion 7.2 of RFC 2831; doublf-quotf dhbrbdtfr is not bllowfd
    // unlfss fsdbpfd; blso fsdbpf thf fsdbpf dhbrbdtfr bnd CTL dhbrs fxdfpt LWS
    privbtf stbtid boolfbn nffdEsdbpf(String str) {
        int lfn = str.lfngth();
        for (int i = 0; i < lfn; i++) {
            if (nffdEsdbpf(str.dhbrAt(i))) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    // Dftfrminfs whfthfr b dhbrbdtfr nffds to bf fsdbpfd in b quotfd string
    privbtf stbtid boolfbn nffdEsdbpf(dhbr dh) {
        rfturn dh == '"' ||  // fsdbpf dhbr
            dh == '\\' ||    // quotf
            dh == 127 ||     // DEL

            // 0 <= dh <= 31 fxdfpt CR, HT bnd LF
            (dh >= 0 && dh <= 31 && dh != 13 && dh != 9 && dh != 10);
    }

    protfdtfd stbtid String quotfdStringVbluf(String str) {
        if (nffdEsdbpf(str)) {
            int lfn = str.lfngth();
            dhbr[] buf = nfw dhbr[lfn+lfn];
            int j = 0;
            dhbr dh;
            for (int i = 0; i < lfn; i++) {
                dh = str.dhbrAt(i);
                if (nffdEsdbpf(dh)) {
                    buf[j++] =  '\\';
                }
                buf[j++] = dh;
            }
            rfturn nfw String(buf, 0, j);
        } flsf {
            rfturn str;
        }
    }

    /**
     * Convfrt b bytf brrby to hfxbdfdimbl string.
     *
     * @pbrbm b non-null bytf brrby
     * @rfturn b non-null String dontbin thf HEX vbluf
     */
    protfdtfd bytf[] binbryToHfx(bytf[] digfst) throws
    UnsupportfdEndodingExdfption {

        StringBuildfr digfstString = nfw StringBuildfr();

        for (int i = 0; i < digfst.lfngth; i ++) {
            if ((digfst[i] & 0x000000ff) < 0x10) {
                digfstString.bppfnd("0"+
                    Intfgfr.toHfxString(digfst[i] & 0x000000ff));
            } flsf {
                digfstString.bppfnd(
                    Intfgfr.toHfxString(digfst[i] & 0x000000ff));
            }
        }
        rfturn digfstString.toString().gftBytfs(fndoding);
    }

    /**
     * Usfd to donvfrt usfrnbmf-vbluf, pbsswd or rfblm to 8859_1 fndoding
     * if bll dhbrs in string brf within thf 8859_1 (Lbtin 1) fndoding rbngf.
     *
     * @pbrbm b non-null String
     * @rfturn b non-nuill bytf brrby dontbining thf dorrfdt dhbrbdtfr fndoding
     * for usfrnbmf, pbswd or rfblm.
     */
    protfdtfd bytf[] stringToBytf_8859_1(String str) throws SbslExdfption {

        dhbr[] bufffr = str.toChbrArrby();

        try {
            if (usfUTF8) {
                for( int i = 0; i< bufffr.lfngth; i++ ) {
                    if( bufffr[i] > '\u00FF' ) {
                        rfturn str.gftBytfs("UTF8");
                    }
                }
            }
            rfturn str.gftBytfs("8859_1");
        } dbtdh (UnsupportfdEndodingExdfption f) {
            throw nfw SbslExdfption(
                "dbnnot fndodf string in UTF8 or 8859-1 (Lbtin-1)", f);
        }
    }

    protfdtfd stbtid bytf[] gftPlbtformCiphfrs() {
        bytf[] diphfrs = nfw bytf[CIPHER_TOKENS.lfngth];

        for (int i = 0; i < JCE_CIPHER_NAME.lfngth; i++) {
            try {
                // Chfdking whfthfr thf trbnsformbtion is bvbilbblf from thf
                // durrfnt instbllfd providfrs.
                Ciphfr.gftInstbndf(JCE_CIPHER_NAME[i]);

                loggfr.log(Lfvfl.FINE, "DIGEST01:Plbtform supports {0}", JCE_CIPHER_NAME[i]);
                diphfrs[i] |= CIPHER_MASKS[i];
            } dbtdh (NoSudhAlgorithmExdfption f) {
                // no implfmfntbtion found for rfqufstfd blgorithm.
            } dbtdh (NoSudhPbddingExdfption f) {
                // no implfmfntbtion found for rfqufstfd blgorithm.
            }
        }

        if (diphfrs[RC4] != UNSET) {
            diphfrs[RC4_56] |= CIPHER_MASKS[RC4_56];
            diphfrs[RC4_40] |= CIPHER_MASKS[RC4_40];
        }

        rfturn diphfrs;
    }

    /**
     * Assfmblfs rfsponsf-vbluf for digfst-rfsponsf.
     *
     * @pbrbm buthMfthod "AUTHENTICATE" for dlifnt-gfnfrbtfd rfsponsf;
     *        "" for sfrvfr-gfnfrbtfd rfsponsf
     * @rfturn A non-null bytf brrby dontbining thf rfpsonsf-vbluf.
     * @throws NoSudhAlgorithmExdfption if thf plbtform dofs not hbvf MD5
     * digfst support.
     * @throws UnsupportfdEndodingExdfption if b bn frror oddurs
     * fndoding b string into fithfr Lbtin-1 or UTF-8.
     * @throws IOExdfption if bn frror oddurs writing to thf output
     * bytf brrby bufffr.
     */
    protfdtfd bytf[] gfnfrbtfRfsponsfVbluf(
        String buthMfthod,
        String digfstUriVbluf,
        String qopVbluf,
        String usfrnbmfVbluf,
        String rfblmVbluf,
        dhbr[] pbsswdVbluf,
        bytf[] nondfVbluf,
        bytf[] dNondfVbluf,
        int nondfCount,
        bytf[] buthzidVbluf
        ) throws NoSudhAlgorithmExdfption,
            UnsupportfdEndodingExdfption,
            IOExdfption {

        MfssbgfDigfst md5 = MfssbgfDigfst.gftInstbndf("MD5");
        bytf[] hfxA1, hfxA2;
        BytfArrbyOutputStrfbm A2, bfginA1, A1, KD;

        // A2
        // --
        // A2 = { "AUTHENTICATE:", digfst-uri-vbluf,
        // [:00000000000000000000000000000000] }  // if buth-int or buth-donf
        //
        A2 = nfw BytfArrbyOutputStrfbm();
        A2.writf((buthMfthod + ":" + digfstUriVbluf).gftBytfs(fndoding));
        if (qopVbluf.fqubls("buth-donf") ||
            qopVbluf.fqubls("buth-int")) {

            loggfr.log(Lfvfl.FINE, "DIGEST04:QOP: {0}", qopVbluf);

            A2.writf(SECURITY_LAYER_MARKER.gftBytfs(fndoding));
        }

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST05:A2: {0}", A2.toString());
        }

        md5.updbtf(A2.toBytfArrby());
        bytf[] digfst = md5.digfst();
        hfxA2 = binbryToHfx(digfst);

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST06:HEX(H(A2)): {0}", nfw String(hfxA2));
        }

        // A1
        // --
        // H(usfr-nbmf : rfblm-vbluf : pbsswd)
        //
        bfginA1 = nfw BytfArrbyOutputStrfbm();
        bfginA1.writf(stringToBytf_8859_1(usfrnbmfVbluf));
        bfginA1.writf(':');
        // if no rfblm, rfblm will bf bn fmpty string
        bfginA1.writf(stringToBytf_8859_1(rfblmVbluf));
        bfginA1.writf(':');
        bfginA1.writf(stringToBytf_8859_1(nfw String(pbsswdVbluf)));

        md5.updbtf(bfginA1.toBytfArrby());
        digfst = md5.digfst();

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST07:H({0}) = {1}",
                nfw Objfdt[]{bfginA1.toString(), nfw String(binbryToHfx(digfst))});
        }

        // A1
        // --
        // A1 = { H ( {usfr-nbmf : rfblm-vbluf : pbsswd } ),
        // : nondf-vbluf, : dnondf-vbluf : buthzid-vbluf
        //
        A1 = nfw BytfArrbyOutputStrfbm();
        A1.writf(digfst);
        A1.writf(':');
        A1.writf(nondfVbluf);
        A1.writf(':');
        A1.writf(dNondfVbluf);

        if (buthzidVbluf != null) {
            A1.writf(':');
            A1.writf(buthzidVbluf);
        }
        md5.updbtf(A1.toBytfArrby());
        digfst = md5.digfst();
        H_A1 = digfst; // Rfdord H(A1). Usf for intfgrity & privbdy.
        hfxA1 = binbryToHfx(digfst);

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST08:H(A1) = {0}", nfw String(hfxA1));
        }

        //
        // H(k, : , s);
        //
        KD = nfw BytfArrbyOutputStrfbm();
        KD.writf(hfxA1);
        KD.writf(':');
        KD.writf(nondfVbluf);
        KD.writf(':');
        KD.writf(nondfCountToHfx(nondfCount).gftBytfs(fndoding));
        KD.writf(':');
        KD.writf(dNondfVbluf);
        KD.writf(':');
        KD.writf(qopVbluf.gftBytfs(fndoding));
        KD.writf(':');
        KD.writf(hfxA2);

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST09:KD: {0}", KD.toString());
        }

        md5.updbtf(KD.toBytfArrby());
        digfst = md5.digfst();

        bytf[] bnswfr = binbryToHfx(digfst);

        if (loggfr.isLoggbblf(Lfvfl.FINE)) {
            loggfr.log(Lfvfl.FINE, "DIGEST10:rfsponsf-vbluf: {0}",
                nfw String(bnswfr));
        }
        rfturn (bnswfr);
    }

    /**
     * Tbkfs 'nondfCount' vbluf bnd rfturns HEX vbluf of thf vbluf.
     *
     * @rfturn A non-null String rfprfsfnting thf durrfnt NONCE-COUNT
     */
    protfdtfd stbtid String nondfCountToHfx(int dount) {

        String str = Intfgfr.toHfxString(dount);
        StringBuildfr pbd = nfw StringBuildfr();

        if (str.lfngth() < 8) {
            for (int i = 0; i < 8-str.lfngth(); i ++) {
                pbd.bppfnd("0");
            }
        }

        rfturn pbd.toString() + str;
    }

    /**
     * Pbrsfs digfst-dhbllfngf string, fxtrbdting fbdh tokfn
     * bnd vbluf(s)
     *
     * @pbrbm buf A non-null digfst-dhbllfngf string.
     * @pbrbm multiplfAllowfd truf if multiplf qop or rfblm or QOP dirfdtivfs
     *  brf bllowfd.
     * @throws SbslExdfption if thf buf dbnnot bf pbrsfd bddording to RFC 2831
     */
    protfdtfd stbtid bytf[][] pbrsfDirfdtivfs(bytf[] buf,
        String[]kfyTbblf, List<bytf[]> rfblmChoidfs, int rfblmIndfx) throws SbslExdfption {

        bytf[][] vblufTbblf = nfw bytf[kfyTbblf.lfngth][];

        BytfArrbyOutputStrfbm kfy = nfw BytfArrbyOutputStrfbm(10);
        BytfArrbyOutputStrfbm vbluf = nfw BytfArrbyOutputStrfbm(10);
        boolfbn gfttingKfy = truf;
        boolfbn gfttingQuotfdVbluf = fblsf;
        boolfbn fxpfdtSfpbrbtor = fblsf;
        bytf bdh;

        int i = skipLws(buf, 0);
        whilf (i < buf.lfngth) {
            bdh = buf[i];

            if (gfttingKfy) {
                if (bdh == ',') {
                    if (kfy.sizf() != 0) {
                        throw nfw SbslExdfption("Dirfdtivf kfy dontbins b ',':" +
                            kfy);
                    }
                    // Empty flfmfnt, skip sfpbrbtor bnd lws
                    i = skipLws(buf, i+1);

                } flsf if (bdh == '=') {
                    if (kfy.sizf() == 0) {
                        throw nfw SbslExdfption("Empty dirfdtivf kfy");
                    }
                    gfttingKfy = fblsf;      // Tfrminbtion of kfy
                    i = skipLws(buf, i+1);   // Skip to nfxt nonwhitfspbdf

                    // Chfdk whfthfr vbluf is quotfd
                    if (i < buf.lfngth) {
                        if (buf[i] == '"') {
                            gfttingQuotfdVbluf = truf;
                            ++i; // Skip quotf
                        }
                    } flsf {
                        throw nfw SbslExdfption(
                            "Vbluflfss dirfdtivf found: " + kfy.toString());
                    }
                } flsf if (isLws(bdh)) {
                    // LWS thbt oddurs bftfr kfy
                    i = skipLws(buf, i+1);

                    // Expfdting '='
                    if (i < buf.lfngth) {
                        if (buf[i] != '=') {
                            throw nfw SbslExdfption("'=' fxpfdtfd bftfr kfy: " +
                                kfy.toString());
                        }
                    } flsf {
                        throw nfw SbslExdfption(
                            "'=' fxpfdtfd bftfr kfy: " + kfy.toString());
                    }
                } flsf {
                    kfy.writf(bdh);    // Appfnd to kfy
                    ++i;               // Advbndf
                }
            } flsf if (gfttingQuotfdVbluf) {
                // Gftting b quotfd vbluf
                if (bdh == '\\') {
                    // quotfd-pbir = "\" CHAR  ==> CHAR
                    ++i;       // Skip fsdbpf
                    if (i < buf.lfngth) {
                        vbluf.writf(buf[i]);
                        ++i;   // Advbndf
                    } flsf {
                        // Trbiling fsdbpf in b quotfd vbluf
                        throw nfw SbslExdfption(
                            "Unmbtdhfd quotf found for dirfdtivf: "
                            + kfy.toString() + " with vbluf: " + vbluf.toString());
                    }
                } flsf if (bdh == '"') {
                    // dlosing quotf
                    ++i;  // Skip dlosing quotf
                    gfttingQuotfdVbluf = fblsf;
                    fxpfdtSfpbrbtor = truf;
                } flsf {
                    vbluf.writf(bdh);
                    ++i;  // Advbndf
                }

            } flsf if (isLws(bdh) || bdh == ',') {
                //  Vbluf tfrminbtfd

                fxtrbdtDirfdtivf(kfy.toString(), vbluf.toBytfArrby(),
                    kfyTbblf, vblufTbblf, rfblmChoidfs, rfblmIndfx);
                kfy.rfsft();
                vbluf.rfsft();
                gfttingKfy = truf;
                gfttingQuotfdVbluf = fxpfdtSfpbrbtor = fblsf;
                i = skipLws(buf, i+1);   // Skip sfpbrbtor bnd LWS

            } flsf if (fxpfdtSfpbrbtor) {
                throw nfw SbslExdfption(
                    "Expfdting dommb or linfbr whitfspbdf bftfr quotfd string: \""
                        + vbluf.toString() + "\"");
            } flsf {
                vbluf.writf(bdh);   // Unquotfd vbluf
                ++i;                // Advbndf
            }
        }

        if (gfttingQuotfdVbluf) {
            throw nfw SbslExdfption(
                "Unmbtdhfd quotf found for dirfdtivf: " + kfy.toString() +
                " with vbluf: " + vbluf.toString());
        }

        // Gft lbst pbir
        if (kfy.sizf() > 0) {
            fxtrbdtDirfdtivf(kfy.toString(), vbluf.toBytfArrby(),
                kfyTbblf, vblufTbblf, rfblmChoidfs, rfblmIndfx);
        }

        rfturn vblufTbblf;
    }

    // Is dhbrbdtfr b linfbr whitf spbdf?
    // LWS            = [CRLF] 1*( SP | HT )
    // %%% Notf thbt wf'rf dhfdking individubl bytfs instfbd of CRLF
    privbtf stbtid boolfbn isLws(bytf b) {
        switdh (b) {
        dbsf 13:   // US-ASCII CR, dbrribgf rfturn
        dbsf 10:   // US-ASCII LF, linffffd
        dbsf 32:   // US-ASCII SP, spbdf
        dbsf 9:    // US-ASCII HT, horizontbl-tbb
            rfturn truf;
        }
        rfturn fblsf;
    }

    // Skip bll linfbr whitf spbdfs
    privbtf stbtid int skipLws(bytf[] buf, int stbrt) {
        int i;
        for (i = stbrt; i < buf.lfngth; i++) {
            if (!isLws(buf[i])) {
                rfturn i;
            }
        }
        rfturn i;
    }

    /**
     * Prodfssfs dirfdtivf/vbluf pbirs from thf digfst-dhbllfngf bnd
     * fill out thf dhbllfngfVbl brrby.
     *
     * @pbrbm kfy A non-null String dhbllfngf tokfn nbmf.
     * @pbrbm vbluf A non-null String tokfn vbluf.
     * @throws SbslExdfption if b fithfr thf kfy or thf vbluf is null
     */
    privbtf stbtid void  fxtrbdtDirfdtivf(String kfy, bytf[] vbluf,
        String[] kfyTbblf, bytf[][] vblufTbblf,
        List<bytf[]> rfblmChoidfs, int rfblmIndfx) throws SbslExdfption {

        for (int i = 0; i < kfyTbblf.lfngth; i++) {
            if (kfy.fqublsIgnorfCbsf(kfyTbblf[i])) {
                if (vblufTbblf[i] == null) {
                    vblufTbblf[i] = vbluf;
                    if (loggfr.isLoggbblf(Lfvfl.FINE)) {
                        loggfr.log(Lfvfl.FINE, "DIGEST11:Dirfdtivf {0} = {1}",
                            nfw Objfdt[]{
                                kfyTbblf[i],
                                nfw String(vblufTbblf[i])});
                    }
                } flsf if (rfblmChoidfs != null && i == rfblmIndfx) {
                    // > 1 rfblm spfdififd
                    if (rfblmChoidfs.isEmpty()) {
                        rfblmChoidfs.bdd(vblufTbblf[i]); // bdd fxisting onf
                    }
                    rfblmChoidfs.bdd(vbluf);  // bdd nfw onf
                } flsf {
                    throw nfw SbslExdfption(
                        "DIGEST-MD5: pffr sfnt morf thbn onf " +
                        kfy + " dirfdtivf: " + nfw String(vbluf));
                }

                brfbk; // fnd sfbrdh
            }
        }
     }


    /**
     * Implfmfntbtion of thf SfdurityCtx intfrfbdf bllowing for mfssbgfs
     * bftwffn thf dlifnt bnd sfrvfr to bf intfgrity dhfdkfd. Aftfr b
     * suddfssful DIGEST-MD5 buthfntidbtion, intfgtrity dhfdking is invokfd
     * if thf SASL QOP (qublity-of-protfdtion) is sft to 'buth-int'.
     * <p>
     * Furthfr dftbils on thf intfgrity-protfdtion mfdhbnism dbn bf found
     * bt sfdtion 2.3 - Intfgrity protfdtion in thf
     * <b hrff="http://www.iftf.org/rfd/rfd2831.txt">RFC2831</b> dffinition.
     *
     * @buthor Jonbthbn Brudf
     */
    dlbss DigfstIntfgrity implfmfnts SfdurityCtx {
        /* Usfd for gfnfrbting intfgrity kfys - spfdififd in RFC 2831*/
        stbtid finbl privbtf String CLIENT_INT_MAGIC = "Digfst sfssion kfy to " +
            "dlifnt-to-sfrvfr signing kfy mbgid donstbnt";
        stbtid finbl privbtf String SVR_INT_MAGIC = "Digfst sfssion kfy to " +
            "sfrvfr-to-dlifnt signing kfy mbgid donstbnt";

        /* Kfy pbirs for intfgrity dhfdking */
        protfdtfd bytf[] myKi;     // == Kid for dlifnt; == Kis for sfrvfr
        protfdtfd bytf[] pffrKi;   // == Kis for dlifnt; == Kid for sfrvfr

        protfdtfd int mySfqNum = 0;
        protfdtfd int pffrSfqNum = 0;

        // outgoing mfssbgfTypf bnd sfqufndfNum
        protfdtfd finbl bytf[] mfssbgfTypf = nfw bytf[2];
        protfdtfd finbl bytf[] sfqufndfNum = nfw bytf[4];

        /**
         * Initiblizfs DigfstIntfgrity implfmfntbtion of SfdurityCtx to
         * fnbblf DIGEST-MD5 intfgrity dhfdking.
         *
         * @throws SbslExdfption if bn frror is fndountfrfd gfnfrbting thf
         * kfy-pbirs for intfgrity dhfdking.
         */
        DigfstIntfgrity(boolfbn dlifntModf) throws SbslExdfption {
            /* Initiblizf mbgid strings */

            try {
                gfnfrbtfIntfgrityKfyPbir(dlifntModf);

            } dbtdh (UnsupportfdEndodingExdfption f) {
                throw nfw SbslExdfption(
                    "DIGEST-MD5: Error fndoding strings into UTF-8", f);

            } dbtdh (IOExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Error bddfssing bufffrs " +
                    "rfquirfd to drfbtf intfgrity kfy pbirs", f);

            } dbtdh (NoSudhAlgorithmExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Unsupportfd digfst " +
                    "blgorithm usfd to drfbtf intfgrity kfy pbirs", f);
            }

            /* Mfssbgf typf is b fixfd vbluf */
            intToNftworkBytfOrdfr(1, mfssbgfTypf, 0, 2);
        }

        /**
         * Gfnfrbtf dlifnt-sfrvfr, sfrvfr-dlifnt kfy pbirs for DIGEST-MD5
         * intfgrity dhfdking.
         *
         * @throws UnsupportfdEndodingExdfption if thf UTF-8 fndoding is not
         * supportfd on thf plbtform.
         * @throws IOExdfption if bn frror oddurs whfn writing to or from thf
         * bytf brrby output bufffrs.
         * @throws NoSudhAlgorithmExdfption if thf MD5 mfssbgf digfst blgorithm
         * dbnnot lobdfd.
         */
        privbtf void gfnfrbtfIntfgrityKfyPbir(boolfbn dlifntModf)
            throws UnsupportfdEndodingExdfption, IOExdfption,
                NoSudhAlgorithmExdfption {

            bytf[] dimbgid = CLIENT_INT_MAGIC.gftBytfs(fndoding);
            bytf[] simbgid = SVR_INT_MAGIC.gftBytfs(fndoding);

            MfssbgfDigfst md5 = MfssbgfDigfst.gftInstbndf("MD5");

            // Both dlifnt-mbgid-kfys bnd sfrvfr-mbgid-kfys brf thf sbmf lfngth
            bytf[] kfyBufffr = nfw bytf[H_A1.lfngth + dimbgid.lfngth];

            // Kid: Kfy for protfdting msgs from dlifnt to sfrvfr.
            Systfm.brrbydopy(H_A1, 0, kfyBufffr, 0, H_A1.lfngth);
            Systfm.brrbydopy(dimbgid, 0, kfyBufffr, H_A1.lfngth, dimbgid.lfngth);
            md5.updbtf(kfyBufffr);
            bytf[] Kid = md5.digfst();

            // Kis: Kfy for protfdting msgs from sfrvfr to dlifnt
            // No nffd to rfdopy H_A1
            Systfm.brrbydopy(simbgid, 0, kfyBufffr, H_A1.lfngth, simbgid.lfngth);

            md5.updbtf(kfyBufffr);
            bytf[] Kis = md5.digfst();

            if (loggfr.isLoggbblf(Lfvfl.FINER)) {
                trbdfOutput(DI_CLASS_NAME, "gfnfrbtfIntfgrityKfyPbir",
                    "DIGEST12:Kid: ", Kid);
                trbdfOutput(DI_CLASS_NAME, "gfnfrbtfIntfgrityKfyPbir",
                    "DIGEST13:Kis: ", Kis);
            }

            if (dlifntModf) {
                myKi = Kid;
                pffrKi = Kis;
            } flsf {
                myKi = Kis;
                pffrKi = Kid;
            }
        }

        /**
         * Appfnd MAC onto outgoing mfssbgf.
         *
         * @pbrbm outgoing A non-null bytf brrby dontbining thf outgoing mfssbgf.
         * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
         * @pbrbm lfn Thf non-zfro numbfr of bytfs for bf rfbd from thf offsft.
         * @rfturn Thf mfssbgf indluding thf intfgrity MAC
         * @throws SbslExdfption if bn frror is fndountfrfd donvfrting b string
         * into b UTF-8 bytf fndoding, or if thf MD5 mfssbgf digfst blgorithm
         * dbnnot bf found or if thfrf is bn frror writing to thf bytf brrby
         * output bufffrs.
         */
        publid bytf[] wrbp(bytf[] outgoing, int stbrt, int lfn)
            throws SbslExdfption {

            if (lfn == 0) {
                rfturn EMPTY_BYTE_ARRAY;
            }

            /* wrbppfd = mfssbgf, MAC, mfssbgf typf, sfqufndf numbfr */
            bytf[] wrbppfd = nfw bytf[lfn+10+2+4];

            /* Stbrt with mfssbgf itsflf */
            Systfm.brrbydopy(outgoing, stbrt, wrbppfd, 0, lfn);

            indrfmfntSfqNum();

            /* Cbldulbtf MAC */
            bytf[] mbd = gftHMAC(myKi, sfqufndfNum, outgoing, stbrt, lfn);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DI_CLASS_NAME, "wrbp", "DIGEST14:outgoing: ",
                    outgoing, stbrt, lfn);
                trbdfOutput(DI_CLASS_NAME, "wrbp", "DIGEST15:sfqNum: ",
                    sfqufndfNum);
                trbdfOutput(DI_CLASS_NAME, "wrbp", "DIGEST16:MAC: ", mbd);
            }

            /* Add MAC[0..9] to mfssbgf */
            Systfm.brrbydopy(mbd, 0, wrbppfd, lfn, 10);

            /* Add mfssbgf typf [0..1] */
            Systfm.brrbydopy(mfssbgfTypf, 0, wrbppfd, lfn+10, 2);

            /* Add sfqufndf numbfr [0..3] */
            Systfm.brrbydopy(sfqufndfNum, 0, wrbppfd, lfn+12, 4);
            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DI_CLASS_NAME, "wrbp", "DIGEST17:wrbppfd: ", wrbppfd);
            }
            rfturn wrbppfd;
        }

        /**
         * Rfturn vfrififd mfssbgf without MAC - only if thf rfdfivfd MAC
         * bnd rf-gfnfrbtfd MAC brf thf sbmf.
         *
         * @pbrbm indoming A non-null bytf brrby dontbining thf indoming
         * mfssbgf.
         * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
         * @pbrbm lfn Thf non-zfro numbfr of bytfs to rfbd from thf offsft
         * position.
         * @rfturn Thf vfrififd mfssbgf or null if intfgrity dhfdking fbils.
         * @throws SbslExdfption if bn frror is fndountfrfd donvfrting b string
         * into b UTF-8 bytf fndoding, or if thf MD5 mfssbgf digfst blgorithm
         * dbnnot bf found or if thfrf is bn frror writing to thf bytf brrby
         * output bufffrs
         */
        publid bytf[] unwrbp(bytf[] indoming, int stbrt, int lfn)
            throws SbslExdfption {

            if (lfn == 0) {
                rfturn EMPTY_BYTE_ARRAY;
            }

            // shbvf off lbst 16 bytfs of mfssbgf
            bytf[] mbd = nfw bytf[10];
            bytf[] msg = nfw bytf[lfn - 16];
            bytf[] msgTypf = nfw bytf[2];
            bytf[] sfqNum = nfw bytf[4];

            /* Gft Msg, MAC, msgTypf, sfqufndfNum */
            Systfm.brrbydopy(indoming, stbrt, msg, 0, msg.lfngth);
            Systfm.brrbydopy(indoming, stbrt+msg.lfngth, mbd, 0, 10);
            Systfm.brrbydopy(indoming, stbrt+msg.lfngth+10, msgTypf, 0, 2);
            Systfm.brrbydopy(indoming, stbrt+msg.lfngth+12, sfqNum, 0, 4);

            /* Cbldulbtf MAC to fnsurf intfgrity */
            bytf[] fxpfdtfdMbd = gftHMAC(pffrKi, sfqNum, msg, 0, msg.lfngth);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DI_CLASS_NAME, "unwrbp", "DIGEST18:indoming: ",
                    msg);
                trbdfOutput(DI_CLASS_NAME, "unwrbp", "DIGEST19:MAC: ",
                    mbd);
                trbdfOutput(DI_CLASS_NAME, "unwrbp", "DIGEST20:mfssbgfTypf: ",
                    msgTypf);
                trbdfOutput(DI_CLASS_NAME, "unwrbp", "DIGEST21:sfqufndfNum: ",
                    sfqNum);
                trbdfOutput(DI_CLASS_NAME, "unwrbp", "DIGEST22:fxpfdtfdMAC: ",
                    fxpfdtfdMbd);
            }

            /* First, dompbrf MAC's bfforf updbting bny of our stbtf */
            if (!Arrbys.fqubls(mbd, fxpfdtfdMbd)) {
                //  Disdbrd mfssbgf bnd do not indrfmfnt sfqufndf numbfr
                loggfr.log(Lfvfl.INFO, "DIGEST23:Unmbtdhfd MACs");
                rfturn EMPTY_BYTE_ARRAY;
            }

            /* Ensurf sfrvfr-sfqufndf numbfrs brf dorrfdt */
            if (pffrSfqNum != nftworkBytfOrdfrToInt(sfqNum, 0, 4)) {
                throw nfw SbslExdfption("DIGEST-MD5: Out of ordfr " +
                    "sfqufnding of mfssbgfs from sfrvfr. Got: " +
                    nftworkBytfOrdfrToInt(sfqNum, 0, 4) +
                    " Expfdtfd: " +     pffrSfqNum);
            }

            if (!Arrbys.fqubls(mfssbgfTypf, msgTypf)) {
                throw nfw SbslExdfption("DIGEST-MD5: invblid mfssbgf typf: " +
                    nftworkBytfOrdfrToInt(msgTypf, 0, 2));
            }

            // Indrfmfnt sfqufndf numbfr bnd rfturn mfssbgf
            pffrSfqNum++;
            rfturn msg;
        }

        /**
         * Gfnfrbtfs MAC to bf bppfndfd onto out-going mfssbgfs.
         *
         * @pbrbm Ki A non-null bytf brrby dontbining thf kfy for thf digfst
         * @pbrbm SfqNum A non-null bytf brrby dontbin thf sfqufndf numbfr
         * @pbrbm msg  Thf mfssbgf to bf digfstfd
         * @pbrbm stbrt Thf offsft from whidh to rfbd thf msg bytf brrby
         * @pbrbm lfn Thf non-zfro numbfr of bytfs to bf rfbd from thf offsft
         * @rfturn Thf MAC of b mfssbgf.
         *
         * @throws SbslExdfption if bn frror oddurs whfn gfnfrbting MAC.
         */
        protfdtfd bytf[] gftHMAC(bytf[] Ki, bytf[] sfqnum, bytf[] msg,
            int stbrt, int lfn) throws SbslExdfption {

            bytf[] sfqAndMsg = nfw bytf[4+lfn];
            Systfm.brrbydopy(sfqnum, 0, sfqAndMsg, 0, 4);
            Systfm.brrbydopy(msg, stbrt, sfqAndMsg, 4, lfn);

            try {
                SfdrftKfy kfyKi = nfw SfdrftKfySpfd(Ki, "HmbdMD5");
                Mbd m = Mbd.gftInstbndf("HmbdMD5");
                m.init(kfyKi);
                m.updbtf(sfqAndMsg);
                bytf[] hMAC_MD5 = m.doFinbl();

                /* First 10 bytfs of HMAC_MD5 digfst */
                bytf mbdBufffr[] = nfw bytf[10];
                Systfm.brrbydopy(hMAC_MD5, 0, mbdBufffr, 0, 10);

                rfturn mbdBufffr;
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Invblid bytfs usfd for " +
                    "kfy of HMAC-MD5 hbsh.", f);
            } dbtdh (NoSudhAlgorithmExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Error drfbting " +
                    "instbndf of MD5 digfst blgorithm", f);
            }
        }

        /**
         * Indrfmfnt own sfqufndf numbfr bnd sft bnswfr in NBO sfqufndfNum fifld.
         */
        protfdtfd void indrfmfntSfqNum() {
            intToNftworkBytfOrdfr(mySfqNum++, sfqufndfNum, 0, 4);
        }
    }

    /**
     * Implfmfntbtion of thf SfdurityCtx intfrfbdf bllowing for mfssbgfs
     * bftwffn thf dlifnt bnd sfrvfr to bf intfgrity dhfdkfd bnd fndryptfd.
     * Aftfr b suddfssful DIGEST-MD5 buthfntidbtion, privbdy is invokfd if thf
     * SASL QOP (qublity-of-protfdtion) is sft to 'buth-donf'.
     * <p>
     * Furthfr dftbils on thf intfgrity-protfdtion mfdhbnism dbn bf found
     * bt sfdtion 2.4 - Confidfntiblity protfdtion in
     * <b hrff="http://www.iftf.org/rfd/rfd2831.txt">RFC2831</b> dffinition.
     *
     * @buthor Jonbthbn Brudf
     */
    finbl dlbss DigfstPrivbdy fxtfnds DigfstIntfgrity implfmfnts SfdurityCtx {
        /* Usfd for gfnfrbting privbdy kfys - spfdififd in RFC 2831 */
        stbtid finbl privbtf String CLIENT_CONF_MAGIC =
            "Digfst H(A1) to dlifnt-to-sfrvfr sfbling kfy mbgid donstbnt";
        stbtid finbl privbtf String SVR_CONF_MAGIC =
            "Digfst H(A1) to sfrvfr-to-dlifnt sfbling kfy mbgid donstbnt";

        privbtf Ciphfr fndCiphfr;
        privbtf Ciphfr dfdCiphfr;

        /**
         * Initiblizfs thf diphfr objfdt instbndfs for fndryption bnd dfdryption.
         *
         * @throws SbslExdfption if bn frror oddurs with thf Kfy
         * initiblizbtion, or b string dbnnot bf fndodfd into b bytf brrby
         * using thf UTF-8 fndoding, or bn frror oddurs whfn writing to b
         * bytf brrby output bufffrs or thf mfdhbnism dbnnot lobd thf MD5
         * mfssbgf digfst blgorithm or invblid initiblizbtion pbrbmftfrs brf
         * pbssfd to thf diphfr objfdt instbndfs.
         */
        DigfstPrivbdy(boolfbn dlifntModf) throws SbslExdfption {

            supfr(dlifntModf); // gfnfrbtf Kid, Kis kfys for intfgrity-dhfdking.

            try {
                gfnfrbtfPrivbdyKfyPbir(dlifntModf);

            } dbtdh (SbslExdfption f) {
                throw f;

            } dbtdh (UnsupportfdEndodingExdfption f) {
                throw nfw SbslExdfption(
                    "DIGEST-MD5: Error fndoding string vbluf into UTF-8", f);

            } dbtdh (IOExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Error bddfssing " +
                    "bufffrs rfquirfd to gfnfrbtf diphfr kfys", f);
            } dbtdh (NoSudhAlgorithmExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Error drfbting " +
                    "instbndf of rfquirfd diphfr or digfst", f);
            }
        }

        /**
         * Gfnfrbtfs dlifnt-sfrvfr bnd sfrvfr-dlifnt kfys to fndrypt bnd
         * dfdrypt mfssbgfs. Also gfnfrbtfs IVs for DES diphfrs.
         *
         * @throws IOExdfption if bn frror oddurs whfn writing to or from thf
         * bytf brrby output bufffrs.
         * @throws NoSudhAlgorithmExdfption if thf MD5 mfssbgf digfst blgorithm
         * dbnnot lobdfd.
         * @throws UnsupportfdEndodingExdfption if bn UTF-8 fndoding is not
         * supportfd on thf plbtform.
         * @throw SbslExdfption if bn frror oddurs initiblizing thf kfys bnd
         * IVs for thf dhosfn diphfr.
         */
        privbtf void gfnfrbtfPrivbdyKfyPbir(boolfbn dlifntModf)
            throws IOExdfption, UnsupportfdEndodingExdfption,
            NoSudhAlgorithmExdfption, SbslExdfption {

            bytf[] ddmbgid = CLIENT_CONF_MAGIC.gftBytfs(fndoding);
            bytf[] sdmbgid = SVR_CONF_MAGIC.gftBytfs(fndoding);

            /* Kdd = MD5{H(A1)[0..n], "Digfst ... dlifnt-to-sfrvfr"} */
            MfssbgfDigfst md5 = MfssbgfDigfst.gftInstbndf("MD5");

            int n;
            if (nfgotibtfdCiphfr.fqubls(CIPHER_TOKENS[RC4_40])) {
                n = 5;          /* H(A1)[0..5] */
            } flsf if (nfgotibtfdCiphfr.fqubls(CIPHER_TOKENS[RC4_56])) {
                n = 7;          /* H(A1)[0..7] */
            } flsf { // dfs bnd 3dfs bnd rd4
                n = 16;         /* H(A1)[0..16] */
            }

            /* {H(A1)[0..n], "Digfst ... dlifnt-to-sfrvfr..."} */
            // Both dlifnt-mbgid-kfys bnd sfrvfr-mbgid-kfys brf thf sbmf lfngth
            bytf[] kfyBufffr =  nfw bytf[n + ddmbgid.lfngth];
            Systfm.brrbydopy(H_A1, 0, kfyBufffr, 0, n);   // H(A1)[0..n]

            /* Kdd: Kfy for fndrypting mfssbgfs from dlifnt->sfrvfr */
            Systfm.brrbydopy(ddmbgid, 0, kfyBufffr, n, ddmbgid.lfngth);
            md5.updbtf(kfyBufffr);
            bytf[] Kdd = md5.digfst();

            /* Kds: Kfy for dfdrypting mfssbgfs from sfrvfr->dlifnt */
            // No nffd to dopy H_A1 bgbin sindf it hbsn't dhbngfd
            Systfm.brrbydopy(sdmbgid, 0, kfyBufffr, n, sdmbgid.lfngth);
            md5.updbtf(kfyBufffr);
            bytf[] Kds = md5.digfst();

            if (loggfr.isLoggbblf(Lfvfl.FINER)) {
                trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                    "DIGEST24:Kdd: ", Kdd);
                trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                    "DIGEST25:Kds: ", Kds);
            }

            bytf[] myKd;
            bytf[] pffrKd;

            if (dlifntModf) {
                myKd = Kdd;
                pffrKd = Kds;
            } flsf {
                myKd = Kds;
                pffrKd = Kdd;
            }

            try {
                SfdrftKfy fndKfy;
                SfdrftKfy dfdKfy;

                /* Initiblizf diphfr objfdts */
                if (nfgotibtfdCiphfr.indfxOf(CIPHER_TOKENS[RC4]) > -1) {
                    fndCiphfr = Ciphfr.gftInstbndf("RC4");
                    dfdCiphfr = Ciphfr.gftInstbndf("RC4");

                    fndKfy = nfw SfdrftKfySpfd(myKd, "RC4");
                    dfdKfy = nfw SfdrftKfySpfd(pffrKd, "RC4");

                    fndCiphfr.init(Ciphfr.ENCRYPT_MODE, fndKfy);
                    dfdCiphfr.init(Ciphfr.DECRYPT_MODE, dfdKfy);

                } flsf if ((nfgotibtfdCiphfr.fqubls(CIPHER_TOKENS[DES])) ||
                    (nfgotibtfdCiphfr.fqubls(CIPHER_TOKENS[DES3]))) {

                    // DES or 3DES
                    String diphfrFullnbmf, diphfrShortnbmf;

                        // Usf "NoPbdding" whfn spfdifying diphfr nbmfs
                        // RFC 2831 blrfbdy dffinfs pbdding rulfs for produding
                        // 8-bytf blignfd blodks
                    if (nfgotibtfdCiphfr.fqubls(CIPHER_TOKENS[DES])) {
                        diphfrFullnbmf = "DES/CBC/NoPbdding";
                        diphfrShortnbmf = "dfs";
                    } flsf {
                        /* 3DES */
                        diphfrFullnbmf = "DESfdf/CBC/NoPbdding";
                        diphfrShortnbmf = "dfsfdf";
                    }

                    fndCiphfr = Ciphfr.gftInstbndf(diphfrFullnbmf);
                    dfdCiphfr = Ciphfr.gftInstbndf(diphfrFullnbmf);

                    fndKfy = mbkfDfsKfys(myKd, diphfrShortnbmf);
                    dfdKfy = mbkfDfsKfys(pffrKd, diphfrShortnbmf);

                    // Sft up thf DES IV, whidh is thf lbst 8 bytfs of Kdd/Kds
                    IvPbrbmftfrSpfd fndIv = nfw IvPbrbmftfrSpfd(myKd, 8, 8);
                    IvPbrbmftfrSpfd dfdIv = nfw IvPbrbmftfrSpfd(pffrKd, 8, 8);

                    // Initiblizf diphfr objfdts
                    fndCiphfr.init(Ciphfr.ENCRYPT_MODE, fndKfy, fndIv);
                    dfdCiphfr.init(Ciphfr.DECRYPT_MODE, dfdKfy, dfdIv);

                    if (loggfr.isLoggbblf(Lfvfl.FINER)) {
                        trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                            "DIGEST26:" + nfgotibtfdCiphfr + " IVdd: ",
                            fndIv.gftIV());
                        trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                            "DIGEST27:" + nfgotibtfdCiphfr + " IVds: ",
                            dfdIv.gftIV());
                        trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                            "DIGEST28:" + nfgotibtfdCiphfr + " fndryption kfy: ",
                            fndKfy.gftEndodfd());
                        trbdfOutput(DP_CLASS_NAME, "gfnfrbtfPrivbdyKfyPbir",
                            "DIGEST29:" + nfgotibtfdCiphfr + " dfdryption kfy: ",
                            dfdKfy.gftEndodfd());
                    }
                }
            } dbtdh (InvblidKfySpfdExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Unsupportfd kfy " +
                    "spfdifidbtion usfd.", f);
            } dbtdh (InvblidAlgorithmPbrbmftfrExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Invblid diphfr " +
                    "blgorithfm pbrbmftfr usfd to drfbtf diphfr instbndf", f);
            } dbtdh (NoSudhPbddingExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Unsupportfd " +
                    "pbdding usfd for dhosfn diphfr", f);
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Invblid dbtb " +
                    "usfd to initiblizf kfys", f);
            }
        }

        // -------------------------------------------------------------------

        /**
         * Endrypt out-going mfssbgf.
         *
         * @pbrbm outgoing A non-null bytf brrby dontbining thf outgoing mfssbgf.
         * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
         * @pbrbm lfn Thf non-zfro numbfr of bytfs to bf rfbd from thf offsft.
         * @rfturn Thf fndryptfd mfssbgf.
         *
         * @throws SbslExdfption if bn frror oddurs whfn writing to or from thf
         * bytf brrby output bufffrs or if thf MD5 mfssbgf digfst blgorithm
         * dbnnot lobdfd or if bn UTF-8 fndoding is not supportfd on thf
         * plbtform.
         */
        publid bytf[] wrbp(bytf[] outgoing, int stbrt, int lfn)
            throws SbslExdfption {

            if (lfn == 0) {
                rfturn EMPTY_BYTE_ARRAY;
            }

            /* HMAC(Ki, {SfqNum, msg})[0..9] */
            indrfmfntSfqNum();
            bytf[] mbd = gftHMAC(myKi, sfqufndfNum, outgoing, stbrt, lfn);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DP_CLASS_NAME, "wrbp", "DIGEST30:Outgoing: ",
                    outgoing, stbrt, lfn);
                trbdfOutput(DP_CLASS_NAME, "wrbp", "sfqNum: ",
                    sfqufndfNum);
                trbdfOutput(DP_CLASS_NAME, "wrbp", "MAC: ", mbd);
            }

            // Cbldulbtf pbdding
            int bs = fndCiphfr.gftBlodkSizf();
            bytf[] pbdding;
            if (bs > 1 ) {
                int pbd = bs - ((lfn + 10) % bs); // bdd 10 for HMAC[0..9]
                pbdding = nfw bytf[pbd];
                for (int i=0; i < pbd; i++) {
                    pbdding[i] = (bytf)pbd;
                }
            } flsf {
                pbdding = EMPTY_BYTE_ARRAY;
            }

            bytf[] toBfEndryptfd = nfw bytf[lfn+pbdding.lfngth+10];

            /* {msg, pbd, HMAC(Ki, {SfqNum, msg}[0..9])} */
            Systfm.brrbydopy(outgoing, stbrt, toBfEndryptfd, 0, lfn);
            Systfm.brrbydopy(pbdding, 0, toBfEndryptfd, lfn, pbdding.lfngth);
            Systfm.brrbydopy(mbd, 0, toBfEndryptfd, lfn+pbdding.lfngth, 10);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DP_CLASS_NAME, "wrbp",
                    "DIGEST31:{msg, pbd, KidMAC}: ", toBfEndryptfd);
            }

            /* CIPHER(Kd, {msg, pbd, HMAC(Ki, {SfqNum, msg}[0..9])}) */
            bytf[] diphfrBlodk;
            try {
                // Do CBC (dhbining) bdross pbdkfts
                diphfrBlodk = fndCiphfr.updbtf(toBfEndryptfd);

                if (diphfrBlodk == null) {
                    // updbtf() dbn rfturn null
                    throw nfw IllfgblBlodkSizfExdfption(""+toBfEndryptfd.lfngth);
                }
            } dbtdh (IllfgblBlodkSizfExdfption f) {
                throw nfw SbslExdfption(
                    "DIGEST-MD5: Invblid blodk sizf for diphfr", f);
            }

            bytf[] wrbppfd = nfw bytf[diphfrBlodk.lfngth+2+4];
            Systfm.brrbydopy(diphfrBlodk, 0, wrbppfd, 0, diphfrBlodk.lfngth);
            Systfm.brrbydopy(mfssbgfTypf, 0, wrbppfd, diphfrBlodk.lfngth, 2);
            Systfm.brrbydopy(sfqufndfNum, 0, wrbppfd, diphfrBlodk.lfngth+2, 4);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DP_CLASS_NAME, "wrbp", "DIGEST32:Wrbppfd: ", wrbppfd);
            }

            rfturn wrbppfd;
        }

        /*
         * Dfdrypt indoming mfssbgfs bnd vfrify thfir intfgrity.
         *
         * @pbrbm indoming A non-null bytf brrby dontbining thf indoming
         * fndryptfd mfssbgf.
         * @pbrbm stbrt Thf offsft from whidh to rfbd thf bytf brrby.
         * @pbrbm lfn Thf non-zfro numbfr of bytfs to rfbd from thf offsft
         * position.
         * @rfturn Thf dfdryptfd, vfrififd mfssbgf or null if intfgrity
         * dhfdking
         * fbils.
         * @throws SbslExdfption if thfrf brf thf SASL bufffr is fmpty or if
         * if bn frror oddurs rfbding thf SASL bufffr.
         */
        publid bytf[] unwrbp(bytf[] indoming, int stbrt, int lfn)
            throws SbslExdfption {

            if (lfn == 0) {
                rfturn EMPTY_BYTE_ARRAY;
            }

            bytf[] fndryptfdMsg = nfw bytf[lfn - 6];
            bytf[] msgTypf = nfw bytf[2];
            bytf[] sfqNum = nfw bytf[4];

            /* Gft diphfrMsg; msgTypf; sfqufndfNum */
            Systfm.brrbydopy(indoming, stbrt,
                fndryptfdMsg, 0, fndryptfdMsg.lfngth);
            Systfm.brrbydopy(indoming, stbrt+fndryptfdMsg.lfngth,
                msgTypf, 0, 2);
            Systfm.brrbydopy(indoming, stbrt+fndryptfdMsg.lfngth+2,
                sfqNum, 0, 4);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                loggfr.log(Lfvfl.FINEST,
                    "DIGEST33:Expfdting sfqufndf num: {0}",
                    pffrSfqNum);
                trbdfOutput(DP_CLASS_NAME, "unwrbp", "DIGEST34:indoming: ",
                    fndryptfdMsg);
            }

            // Dfdrypt mfssbgf
            /* CIPHER(Kd, {msg, pbd, HMAC(Ki, {SfqNum, msg}[0..9])}) */
            bytf[] dfdryptfdMsg;

            try {
                // Do CBC (dhbining) bdross pbdkfts
                dfdryptfdMsg = dfdCiphfr.updbtf(fndryptfdMsg);

                if (dfdryptfdMsg == null) {
                    // updbtf() dbn rfturn null
                    throw nfw IllfgblBlodkSizfExdfption(""+fndryptfdMsg.lfngth);
                }
            } dbtdh (IllfgblBlodkSizfExdfption f) {
                throw nfw SbslExdfption("DIGEST-MD5: Illfgbl blodk " +
                    "sizfs usfd with dhosfn diphfr", f);
            }

            bytf[] msgWithPbdding = nfw bytf[dfdryptfdMsg.lfngth - 10];
            bytf[] mbd = nfw bytf[10];

            Systfm.brrbydopy(dfdryptfdMsg, 0,
                msgWithPbdding, 0, msgWithPbdding.lfngth);
            Systfm.brrbydopy(dfdryptfdMsg, msgWithPbdding.lfngth,
                mbd, 0, 10);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DP_CLASS_NAME, "unwrbp",
                    "DIGEST35:Unwrbppfd (w/pbdding): ", msgWithPbdding);
                trbdfOutput(DP_CLASS_NAME, "unwrbp", "DIGEST36:MAC: ", mbd);
                trbdfOutput(DP_CLASS_NAME, "unwrbp", "DIGEST37:mfssbgfTypf: ",
                    msgTypf);
                trbdfOutput(DP_CLASS_NAME, "unwrbp", "DIGEST38:sfqufndfNum: ",
                    sfqNum);
            }

            int msgLfngth = msgWithPbdding.lfngth;
            int blodkSizf = dfdCiphfr.gftBlodkSizf();
            if (blodkSizf > 1) {
                // gft vbluf of lbst odtft of thf bytf brrby
                msgLfngth -= (int)msgWithPbdding[msgWithPbdding.lfngth - 1];
                if (msgLfngth < 0) {
                    //  Disdbrd mfssbgf bnd do not indrfmfnt sfqufndf numbfr
                    if (loggfr.isLoggbblf(Lfvfl.INFO)) {
                        loggfr.log(Lfvfl.INFO,
                            "DIGEST39:Indorrfdt pbdding: {0}",
                            msgWithPbdding[msgWithPbdding.lfngth - 1]);
                    }
                    rfturn EMPTY_BYTE_ARRAY;
                }
            }

            /* Rf-dbldulbtf MAC to fnsurf intfgrity */
            bytf[] fxpfdtfdMbd = gftHMAC(pffrKi, sfqNum, msgWithPbdding,
                0, msgLfngth);

            if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                trbdfOutput(DP_CLASS_NAME, "unwrbp", "DIGEST40:KisMAC: ",
                    fxpfdtfdMbd);
            }

            // First, dompbrf MACs bfforf updbting stbtf
            if (!Arrbys.fqubls(mbd, fxpfdtfdMbd)) {
                //  Disdbrd mfssbgf bnd do not indrfmfnt sfqufndf numbfr
                loggfr.log(Lfvfl.INFO, "DIGEST41:Unmbtdhfd MACs");
                rfturn EMPTY_BYTE_ARRAY;
            }

            /* Ensurf sfqufndf numbfr is dorrfdt */
            if (pffrSfqNum != nftworkBytfOrdfrToInt(sfqNum, 0, 4)) {
                throw nfw SbslExdfption("DIGEST-MD5: Out of ordfr " +
                    "sfqufnding of mfssbgfs from sfrvfr. Got: " +
                    nftworkBytfOrdfrToInt(sfqNum, 0, 4) + " Expfdtfd: " +
                    pffrSfqNum);
            }

            /* Chfdk mfssbgf typf */
            if (!Arrbys.fqubls(mfssbgfTypf, msgTypf)) {
                throw nfw SbslExdfption("DIGEST-MD5: invblid mfssbgf typf: " +
                    nftworkBytfOrdfrToInt(msgTypf, 0, 2));
            }

            // Indrfmfnt sfqufndf numbfr bnd rfturn mfssbgf
            pffrSfqNum++;

            if (msgLfngth == msgWithPbdding.lfngth) {
                rfturn msgWithPbdding; // no pbdding
            } flsf {
                // Gft b dopy of thf mfssbgf without pbdding
                bytf[] dlfbrMsg = nfw bytf[msgLfngth];
                Systfm.brrbydopy(msgWithPbdding, 0, dlfbrMsg, 0, msgLfngth);
                rfturn dlfbrMsg;
            }
        }
    }

    // ---------------- DES bnd 3 DES kfy mbnipulbtion routinfs

    privbtf stbtid finbl BigIntfgfr MASK = nfw BigIntfgfr("7f", 16);

    /**
     * Sfts thf pbrity bit (0th bit) in fbdh bytf so thbt fbdh bytf
     * dontbins bn odd numbfr of 1's.
     */
    privbtf stbtid void sftPbrityBit(bytf[] kfy) {
        for (int i = 0; i < kfy.lfngth; i++) {
            int b = kfy[i] & 0xff;
            b |= (Intfgfr.bitCount(b) & 1) ^ 1;
            kfy[i] = (bytf) b;
        }
    }

    /**
     * Expbnds b 7-bytf brrby into bn 8-bytf brrby thbt dontbins pbrity bits
     * Thf binbry formbt of b dryptogrbphid kfy is:
     *     (B1,B2,...,B7,P1,B8,...B14,P2,B15,...,B49,P7,B50,...,B56,P8)
     * whfrf (B1,B2,...,B56) brf thf indfpfndfnt bits of b DES kfy bnd
     * (PI,P2,...,P8) brf rfsfrvfd for pbrity bits domputfd on thf prfdfding
     * sfvfn indfpfndfnt bits bnd sft so thbt thf pbrity of thf odtft is odd,
     * i.f., thfrf is bn odd numbfr of "1" bits in thf odtft.
     */
    privbtf stbtid bytf[] bddDfsPbrity(bytf[] input, int offsft, int lfn) {
        if (lfn != 7)
            throw nfw IllfgblArgumfntExdfption(
                "Invblid lfngth of DES Kfy Vbluf:" + lfn);

        bytf[] rbw = nfw bytf[7];
        Systfm.brrbydopy(input, offsft, rbw, 0, lfn);

        bytf[] rfsult = nfw bytf[8];
        BigIntfgfr in = nfw BigIntfgfr(rbw);

        // Shift 7 bits fbdh timf into b bytf
        for (int i=rfsult.lfngth-1; i>=0; i--) {
            rfsult[i] = in.bnd(MASK).toBytfArrby()[0];
            rfsult[i] <<= 1;         // mbkf room for pbrity bit
            in = in.shiftRight(7);
        }
        sftPbrityBit(rfsult);
        rfturn rfsult;
    }

    /**
     * Crfbtf pbrity-bdjustfd kfys suitbblf for DES / DESfdf fndryption.
     *
     * @pbrbm input A non-null bytf brrby dontbining kfy mbtfribl for
     * DES / DESfdf.
     * @pbrbm dfsStrfngth A string spfdifying fithf b DES or b DESfdf kfy.
     * @rfturn SfdrftKfy An instbndf of fithfr DESKfySpfd or DESfdfKfySpfd.
     *
     * @throws NoSudhAlgorithmExdfption if thf fithfr thf DES or DESfdf
     * blgorithms dbnnotf bf lodbfd by JCE.
     * @throws InvblidKfyExdfption if bn invblid brrby of bytfs is usfd
     * bs b kfy for DES or DESfdf.
     * @throws InvblidKfySpfdExdfption in bn invblid pbrbmftfr is pbssfd
     * to fithfr tf DESKfySpfd of thf DESfdfKfySpfd donstrudtors.
     */
    privbtf stbtid SfdrftKfy mbkfDfsKfys(bytf[] input, String dfsStrfngth)
        throws NoSudhAlgorithmExdfption, InvblidKfyExdfption,
            InvblidKfySpfdExdfption {

        // Gfnfrbtf first subkfy using first 7 bytfs
        bytf[] subkfy1 = bddDfsPbrity(input, 0, 7);

        KfySpfd spfd = null;
        SfdrftKfyFbdtory dfsFbdtory =
            SfdrftKfyFbdtory.gftInstbndf(dfsStrfngth);
        switdh (dfsStrfngth) {
            dbsf "dfs":
                spfd = nfw DESKfySpfd(subkfy1, 0);
                if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST42:DES kfy input: ", input);
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST43:DES kfy pbrity-bdjustfd: ", subkfy1);
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST44:DES kfy mbtfribl: ", ((DESKfySpfd)spfd).gftKfy());
                    loggfr.log(Lfvfl.FINEST, "DIGEST45: is pbrity-bdjustfd? {0}",
                        Boolfbn.vblufOf(DESKfySpfd.isPbrityAdjustfd(subkfy1, 0)));
                }
                brfbk;
            dbsf "dfsfdf":
                // Gfnfrbtf sfdond subkfy using sfdond 7 bytfs
                bytf[] subkfy2 = bddDfsPbrity(input, 7, 7);
                // Construdt 24-bytf fndryption-dfdryption-fndryption sfqufndf
                bytf[] fdf = nfw bytf[subkfy1.lfngth*2+subkfy2.lfngth];
                Systfm.brrbydopy(subkfy1, 0, fdf, 0, subkfy1.lfngth);
                Systfm.brrbydopy(subkfy2, 0, fdf, subkfy1.lfngth, subkfy2.lfngth);
                Systfm.brrbydopy(subkfy1, 0, fdf, subkfy1.lfngth+subkfy2.lfngth,
                    subkfy1.lfngth);
                spfd = nfw DESfdfKfySpfd(fdf, 0);
                if (loggfr.isLoggbblf(Lfvfl.FINEST)) {
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST46:3DES kfy input: ", input);
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST47:3DES kfy fdf: ", fdf);
                    trbdfOutput(DP_CLASS_NAME, "mbkfDfsKfys",
                        "DIGEST48:3DES kfy mbtfribl: ",
                        ((DESfdfKfySpfd)spfd).gftKfy());
                    loggfr.log(Lfvfl.FINEST, "DIGEST49: is pbrity-bdjustfd? ",
                        Boolfbn.vblufOf(DESfdfKfySpfd.isPbrityAdjustfd(fdf, 0)));
                }
                brfbk;
            dffbult:
                throw nfw IllfgblArgumfntExdfption("Invblid DES strfngth:" +
                    dfsStrfngth);
        }
        rfturn dfsFbdtory.gfnfrbtfSfdrft(spfd);
    }
}
