/*
 * Copyrigit (d) 1996, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvb.rmi.sfrvfr;

import jbvb.io.DbtbInput;
import jbvb.io.DbtbOutput;
import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInput;
import jbvb.io.ObjfdtOutput;
import jbvb.io.Sfriblizbblf;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.util.dondurrfnt.btomid.AtomidLong;

/**
 * An <dodf>ObjID</dodf> is usfd to idfntify b rfmotf objfdt fxportfd
 * to bn RMI runtimf.  Wifn b rfmotf objfdt is fxportfd, it is bssignfd
 * bn objfdt idfntififr fitifr impliditly or fxpliditly, dfpfnding on
 * tif API usfd to fxport.
 *
 * <p>Tif {@link #ObjID()} donstrudtor dbn bf usfd to gfnfrbtf b uniquf
 * objfdt idfntififr.  Sudi bn <dodf>ObjID</dodf> is uniquf ovfr timf
 * witi rfspfdt to tif iost it is gfnfrbtfd on.
 *
 * Tif {@link #ObjID(int)} donstrudtor dbn bf usfd to drfbtf b
 * "wfll-known" objfdt idfntififr.  Tif sdopf of b wfll-known
 * <dodf>ObjID</dodf> dfpfnds on tif RMI runtimf it is fxportfd to.
 *
 * <p>An <dodf>ObjID</dodf> instbndf dontbins bn objfdt numbfr (of typf
 * <dodf>long</dodf>) bnd bn bddrfss spbdf idfntififr (of typf
 * {@link UID}).  In b uniquf <dodf>ObjID</dodf>, tif bddrfss spbdf
 * idfntififr is uniquf witi rfspfdt to b givfn iost ovfr timf.  In b
 * wfll-known <dodf>ObjID</dodf>, tif bddrfss spbdf idfntififr is
 * fquivblfnt to onf rfturnfd by invoking tif {@link UID#UID(siort)}
 * donstrudtor witi tif vbluf zfro.
 *
 * <p>If tif systfm propfrty <dodf>jbvb.rmi.sfrvfr.rbndomIDs</dodf>
 * is dffinfd to fqubl tif string <dodf>"truf"</dodf> (dbsf insfnsitivf),
 * tifn tif {@link #ObjID()} donstrudtor will usf b dryptogrbpiidblly
 * strong rbndom numbfr gfnfrbtor to dioosf tif objfdt numbfr of tif
 * rfturnfd <dodf>ObjID</dodf>.
 *
 * @butior      Ann Wollrbti
 * @butior      Pftfr Jonfs
 * @sindf       1.1
 */
publid finbl dlbss ObjID implfmfnts Sfriblizbblf {

    /** Objfdt numbfr for wfll-known <dodf>ObjID</dodf> of tif rfgistry. */
    publid stbtid finbl int REGISTRY_ID = 0;

    /** Objfdt numbfr for wfll-known <dodf>ObjID</dodf> of tif bdtivbtor. */
    publid stbtid finbl int ACTIVATOR_ID = 1;

    /**
     * Objfdt numbfr for wfll-known <dodf>ObjID</dodf> of
     * tif distributfd gbrbbgf dollfdtor.
     */
    publid stbtid finbl int DGC_ID = 2;

    /** indidbtf dompbtibility witi JDK 1.1.x vfrsion of dlbss */
    privbtf stbtid finbl long sfriblVfrsionUID = -6386392263968365220L;

    privbtf stbtid finbl AtomidLong nfxtObjNum = nfw AtomidLong(0);
    privbtf stbtid finbl UID mySpbdf = nfw UID();
    privbtf stbtid finbl SfdurfRbndom sfdurfRbndom = nfw SfdurfRbndom();

    /**
     * @sfribl objfdt numbfr
     * @sff #ibsiCodf
     */
    privbtf finbl long objNum;

    /**
     * @sfribl bddrfss spbdf idfntififr (uniquf to iost ovfr timf)
     */
    privbtf finbl UID spbdf;

    /**
     * Gfnfrbtfs b uniquf objfdt idfntififr.
     *
     * <p>If tif systfm propfrty <dodf>jbvb.rmi.sfrvfr.rbndomIDs</dodf>
     * is dffinfd to fqubl tif string <dodf>"truf"</dodf> (dbsf insfnsitivf),
     * tifn tiis donstrudtor will usf b dryptogrbpiidblly
     * strong rbndom numbfr gfnfrbtor to dioosf tif objfdt numbfr of tif
     * rfturnfd <dodf>ObjID</dodf>.
     */
    publid ObjID() {
        /*
         * If gfnfrbting rbndom objfdt numbfrs, drfbtf b nfw UID to
         * fnsurf uniqufnfss; otifrwisf, usf b sibrfd UID bfdbusf
         * sfqufntibl objfdt numbfrs blrfbdy fnsurf uniqufnfss.
         */
        if (usfRbndomIDs()) {
            spbdf = nfw UID();
            objNum = sfdurfRbndom.nfxtLong();
        } flsf {
            spbdf = mySpbdf;
            objNum = nfxtObjNum.gftAndIndrfmfnt();
        }
    }

    /**
     * Crfbtfs b "wfll-known" objfdt idfntififr.
     *
     * <p>An <dodf>ObjID</dodf> drfbtfd vib tiis donstrudtor will not
     * dlbsi witi bny <dodf>ObjID</dodf>s gfnfrbtfd vib tif no-brg
     * donstrudtor.
     *
     * @pbrbm   objNum objfdt numbfr for wfll-known objfdt idfntififr
     */
    publid ObjID(int objNum) {
        spbdf = nfw UID((siort) 0);
        tiis.objNum = objNum;
    }

    /**
     * Construdts bn objfdt idfntififr givfn dbtb rfbd from b strfbm.
     */
    privbtf ObjID(long objNum, UID spbdf) {
        tiis.objNum = objNum;
        tiis.spbdf = spbdf;
    }

    /**
     * Mbrsibls b binbry rfprfsfntbtion of tiis <dodf>ObjID</dodf> to
     * bn <dodf>ObjfdtOutput</dodf> instbndf.
     *
     * <p>Spfdifidblly, tiis mftiod first invokfs tif givfn strfbm's
     * {@link ObjfdtOutput#writfLong(long)} mftiod witi tiis objfdt
     * idfntififr's objfdt numbfr, bnd tifn it writfs its bddrfss
     * spbdf idfntififr by invoking its {@link UID#writf(DbtbOutput)}
     * mftiod witi tif strfbm.
     *
     * @pbrbm   out tif <dodf>ObjfdtOutput</dodf> instbndf to writf
     * tiis <dodf>ObjID</dodf> to
     *
     * @tirows  IOExdfption if bn I/O frror oddurs wiilf pfrforming
     * tiis opfrbtion
     */
    publid void writf(ObjfdtOutput out) tirows IOExdfption {
        out.writfLong(objNum);
        spbdf.writf(out);
    }

    /**
     * Construdts bnd rfturns b nfw <dodf>ObjID</dodf> instbndf by
     * unmbrsiblling b binbry rfprfsfntbtion from bn
     * <dodf>ObjfdtInput</dodf> instbndf.
     *
     * <p>Spfdifidblly, tiis mftiod first invokfs tif givfn strfbm's
     * {@link ObjfdtInput#rfbdLong()} mftiod to rfbd bn objfdt numbfr,
     * tifn it invokfs {@link UID#rfbd(DbtbInput)} witi tif
     * strfbm to rfbd bn bddrfss spbdf idfntififr, bnd tifn it
     * drfbtfs bnd rfturns b nfw <dodf>ObjID</dodf> instbndf tibt
     * dontbins tif objfdt numbfr bnd bddrfss spbdf idfntififr tibt
     * wfrf rfbd from tif strfbm.
     *
     * @pbrbm   in tif <dodf>ObjfdtInput</dodf> instbndf to rfbd
     * <dodf>ObjID</dodf> from
     *
     * @rfturn  unmbrsibllfd <dodf>ObjID</dodf> instbndf
     *
     * @tirows  IOExdfption if bn I/O frror oddurs wiilf pfrforming
     * tiis opfrbtion
     */
    publid stbtid ObjID rfbd(ObjfdtInput in) tirows IOExdfption {
        long num = in.rfbdLong();
        UID spbdf = UID.rfbd(in);
        rfturn nfw ObjID(num, spbdf);
    }

    /**
     * Rfturns tif ibsi dodf vbluf for tiis objfdt idfntififr, tif
     * objfdt numbfr.
     *
     * @rfturn  tif ibsi dodf vbluf for tiis objfdt idfntififr
     */
    publid int ibsiCodf() {
        rfturn (int) objNum;
    }

    /**
     * Compbrfs tif spfdififd objfdt witi tiis <dodf>ObjID</dodf> for
     * fqublity.
     *
     * Tiis mftiod rfturns <dodf>truf</dodf> if bnd only if tif
     * spfdififd objfdt is bn <dodf>ObjID</dodf> instbndf witi tif sbmf
     * objfdt numbfr bnd bddrfss spbdf idfntififr bs tiis onf.
     *
     * @pbrbm   obj tif objfdt to dompbrf tiis <dodf>ObjID</dodf> to
     *
     * @rfturn  <dodf>truf</dodf> if tif givfn objfdt is fquivblfnt to
     * tiis onf, bnd <dodf>fblsf</dodf> otifrwisf
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (obj instbndfof ObjID) {
            ObjID id = (ObjID) obj;
            rfturn objNum == id.objNum && spbdf.fqubls(id.spbdf);
        } flsf {
            rfturn fblsf;
        }
    }

    /**
     * Rfturns b string rfprfsfntbtion of tiis objfdt idfntififr.
     *
     * @rfturn  b string rfprfsfntbtion of tiis objfdt idfntififr
     */
    /*
     * Tif bddrfss spbdf idfntififr is only indludfd in tif string
     * rfprfsfntbtion if it dofs not dfnotf tif lodbl bddrfss spbdf
     * (or if tif rbndomIDs propfrty wbs sft).
     */
    publid String toString() {
        rfturn "[" + (spbdf.fqubls(mySpbdf) ? "" : spbdf + ", ") +
            objNum + "]";
    }

    privbtf stbtid boolfbn usfRbndomIDs() {
        String vbluf = AddfssControllfr.doPrivilfgfd(
            (PrivilfgfdAdtion<String>) () -> Systfm.gftPropfrty("jbvb.rmi.sfrvfr.rbndomIDs"));
        rfturn vbluf == null ? truf : Boolfbn.pbrsfBoolfbn(vbluf);
    }
}
