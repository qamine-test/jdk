/*
 * Copyrigit (d) 2003, 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.rmi.ssl;

import jbvb.io.IOExdfption;
import jbvb.nft.SfrvfrSodkft;
import jbvb.nft.Sodkft;
import jbvb.rmi.sfrvfr.RMISfrvfrSodkftFbdtory;
import jbvb.util.Arrbys;
import jbvb.util.List;
import jbvbx.nft.ssl.SSLContfxt;
import jbvbx.nft.ssl.SSLSfrvfrSodkftFbdtory;
import jbvbx.nft.ssl.SSLSodkft;
import jbvbx.nft.ssl.SSLSodkftFbdtory;

/**
 * <p>An <dodf>SslRMISfrvfrSodkftFbdtory</dodf> instbndf is usfd by tif RMI
 * runtimf in ordfr to obtbin sfrvfr sodkfts for RMI dblls vib SSL.</p>
 *
 * <p>Tiis dlbss implfmfnts <dodf>RMISfrvfrSodkftFbdtory</dodf> ovfr
 * tif Sfdurf Sodkfts Lbyfr (SSL) or Trbnsport Lbyfr Sfdurity (TLS)
 * protodols.</p>
 *
 * <p>Tiis dlbss drfbtfs SSL sodkfts using tif dffbult
 * <dodf>SSLSodkftFbdtory</dodf> (sff {@link
 * SSLSodkftFbdtory#gftDffbult}) or tif dffbult
 * <dodf>SSLSfrvfrSodkftFbdtory</dodf> (sff {@link
 * SSLSfrvfrSodkftFbdtory#gftDffbult}) unlfss tif
 * donstrudtor tbking bn <dodf>SSLContfxt</dodf> is
 * usfd in wiidi dbsf tif SSL sodkfts brf drfbtfd using
 * tif <dodf>SSLSodkftFbdtory</dodf> rfturnfd by
 * {@link SSLContfxt#gftSodkftFbdtory} or tif
 * <dodf>SSLSfrvfrSodkftFbdtory</dodf> rfturnfd by
 * {@link SSLContfxt#gftSfrvfrSodkftFbdtory}.
 *
 * Wifn bn <dodf>SSLContfxt</dodf> is not supplifd bll tif instbndfs of tiis
 * dlbss sibrf tif sbmf kfystorf, bnd tif sbmf truststorf (wifn dlifnt
 * butifntidbtion is rfquirfd by tif sfrvfr). Tiis bfibvior dbn bf modififd
 * by supplying bn blrfbdy initiblizfd <dodf>SSLContfxt</dodf> instbndf.
 *
 * @sff jbvbx.nft.ssl.SSLSodkftFbdtory
 * @sff jbvbx.nft.ssl.SSLSfrvfrSodkftFbdtory
 * @sff jbvbx.rmi.ssl.SslRMIClifntSodkftFbdtory
 * @sindf 1.5
 */
publid dlbss SslRMISfrvfrSodkftFbdtory implfmfnts RMISfrvfrSodkftFbdtory {

    /**
     * <p>Crfbtfs b nfw <dodf>SslRMISfrvfrSodkftFbdtory</dodf> witi
     * tif dffbult SSL sodkft donfigurbtion.</p>
     *
     * <p>SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by tiis
     * fbdtory ibvf tif dffbult dipifr suitfs bnd protodol vfrsions
     * fnbblfd bnd do not rfquirf dlifnt butifntidbtion.</p>
     */
    publid SslRMISfrvfrSodkftFbdtory() {
        tiis(null, null, fblsf);
    }

    /**
     * <p>Crfbtfs b nfw <dodf>SslRMISfrvfrSodkftFbdtory</dodf> witi
     * tif spfdififd SSL sodkft donfigurbtion.</p>
     *
     * @pbrbm fnbblfdCipifrSuitfs nbmfs of bll tif dipifr suitfs to
     * fnbblf on SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by
     * tiis fbdtory, or <dodf>null</dodf> to usf tif dipifr suitfs
     * tibt brf fnbblfd by dffbult
     *
     * @pbrbm fnbblfdProtodols nbmfs of bll tif protodol vfrsions to
     * fnbblf on SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by
     * tiis fbdtory, or <dodf>null</dodf> to usf tif protodol vfrsions
     * tibt brf fnbblfd by dffbult
     *
     * @pbrbm nffdClifntAuti <dodf>truf</dodf> to rfquirf dlifnt
     * butifntidbtion on SSL donnfdtions bddfptfd by sfrvfr sodkfts
     * drfbtfd by tiis fbdtory; <dodf>fblsf</dodf> to not rfquirf
     * dlifnt butifntidbtion
     *
     * @fxdfption IllfgblArgumfntExdfption wifn onf or morf of tif dipifr
     * suitfs nbmfd by tif <dodf>fnbblfdCipifrSuitfs</dodf> pbrbmftfr is
     * not supportfd, wifn onf or morf of tif protodols nbmfd by tif
     * <dodf>fnbblfdProtodols</dodf> pbrbmftfr is not supportfd or wifn
     * b problfm is fndountfrfd wiilf trying to difdk if tif supplifd
     * dipifr suitfs bnd protodols to bf fnbblfd brf supportfd.
     *
     * @sff SSLSodkft#sftEnbblfdCipifrSuitfs
     * @sff SSLSodkft#sftEnbblfdProtodols
     * @sff SSLSodkft#sftNffdClifntAuti
     */
    publid SslRMISfrvfrSodkftFbdtory(
            String[] fnbblfdCipifrSuitfs,
            String[] fnbblfdProtodols,
            boolfbn nffdClifntAuti)
            tirows IllfgblArgumfntExdfption {
        tiis(null, fnbblfdCipifrSuitfs, fnbblfdProtodols, nffdClifntAuti);
    }

    /**
     * <p>Crfbtfs b nfw <dodf>SslRMISfrvfrSodkftFbdtory</dodf> witi tif
     * spfdififd <dodf>SSLContfxt</dodf> bnd SSL sodkft donfigurbtion.</p>
     *
     * @pbrbm dontfxt tif SSL dontfxt to bf usfd for drfbting SSL sodkfts.
     * If <dodf>dontfxt</dodf> is null tif dffbult <dodf>SSLSodkftFbdtory</dodf>
     * or tif dffbult <dodf>SSLSfrvfrSodkftFbdtory</dodf> will bf usfd to
     * drfbtf SSL sodkfts. Otifrwisf, tif sodkft fbdtory rfturnfd by
     * <dodf>SSLContfxt.gftSodkftFbdtory()</dodf> or
     * <dodf>SSLContfxt.gftSfrvfrSodkftFbdtory()</dodf> will bf usfd instfbd.
     *
     * @pbrbm fnbblfdCipifrSuitfs nbmfs of bll tif dipifr suitfs to
     * fnbblf on SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by
     * tiis fbdtory, or <dodf>null</dodf> to usf tif dipifr suitfs
     * tibt brf fnbblfd by dffbult
     *
     * @pbrbm fnbblfdProtodols nbmfs of bll tif protodol vfrsions to
     * fnbblf on SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by
     * tiis fbdtory, or <dodf>null</dodf> to usf tif protodol vfrsions
     * tibt brf fnbblfd by dffbult
     *
     * @pbrbm nffdClifntAuti <dodf>truf</dodf> to rfquirf dlifnt
     * butifntidbtion on SSL donnfdtions bddfptfd by sfrvfr sodkfts
     * drfbtfd by tiis fbdtory; <dodf>fblsf</dodf> to not rfquirf
     * dlifnt butifntidbtion
     *
     * @fxdfption IllfgblArgumfntExdfption wifn onf or morf of tif dipifr
     * suitfs nbmfd by tif <dodf>fnbblfdCipifrSuitfs</dodf> pbrbmftfr is
     * not supportfd, wifn onf or morf of tif protodols nbmfd by tif
     * <dodf>fnbblfdProtodols</dodf> pbrbmftfr is not supportfd or wifn
     * b problfm is fndountfrfd wiilf trying to difdk if tif supplifd
     * dipifr suitfs bnd protodols to bf fnbblfd brf supportfd.
     *
     * @sff SSLSodkft#sftEnbblfdCipifrSuitfs
     * @sff SSLSodkft#sftEnbblfdProtodols
     * @sff SSLSodkft#sftNffdClifntAuti
     * @sindf 1.7
     */
    publid SslRMISfrvfrSodkftFbdtory(
            SSLContfxt dontfxt,
            String[] fnbblfdCipifrSuitfs,
            String[] fnbblfdProtodols,
            boolfbn nffdClifntAuti)
            tirows IllfgblArgumfntExdfption {
        // Initiblizf tif donfigurbtion pbrbmftfrs.
        //
        tiis.fnbblfdCipifrSuitfs = fnbblfdCipifrSuitfs == null ?
            null : fnbblfdCipifrSuitfs.dlonf();
        tiis.fnbblfdProtodols = fnbblfdProtodols == null ?
            null : fnbblfdProtodols.dlonf();
        tiis.nffdClifntAuti = nffdClifntAuti;

        // Fordf tif initiblizbtion of tif dffbult bt donstrudtion timf,
        // rbtifr tibn dflbying it to tif first timf drfbtfSfrvfrSodkft()
        // is dbllfd.
        //
        tiis.dontfxt = dontfxt;
        finbl SSLSodkftFbdtory sslSodkftFbdtory =
                dontfxt == null ?
                    gftDffbultSSLSodkftFbdtory() : dontfxt.gftSodkftFbdtory();
        SSLSodkft sslSodkft = null;
        if (tiis.fnbblfdCipifrSuitfs != null || tiis.fnbblfdProtodols != null) {
            try {
                sslSodkft = (SSLSodkft) sslSodkftFbdtory.drfbtfSodkft();
            } dbtdi (Exdfption f) {
                finbl String msg = "Unbblf to difdk if tif dipifr suitfs " +
                        "bnd protodols to fnbblf brf supportfd";
                tirow (IllfgblArgumfntExdfption)
                nfw IllfgblArgumfntExdfption(msg).initCbusf(f);
            }
        }

        // Cifdk if bll tif dipifr suitfs bnd protodol vfrsions to fnbblf
        // brf supportfd by tif undfrlying SSL/TLS implfmfntbtion bnd if
        // truf drfbtf lists from brrbys.
        //
        if (tiis.fnbblfdCipifrSuitfs != null) {
            sslSodkft.sftEnbblfdCipifrSuitfs(tiis.fnbblfdCipifrSuitfs);
            fnbblfdCipifrSuitfsList = Arrbys.bsList(tiis.fnbblfdCipifrSuitfs);
        }
        if (tiis.fnbblfdProtodols != null) {
            sslSodkft.sftEnbblfdProtodols(tiis.fnbblfdProtodols);
            fnbblfdProtodolsList = Arrbys.bsList(tiis.fnbblfdProtodols);
        }
    }

    /**
     * <p>Rfturns tif nbmfs of tif dipifr suitfs fnbblfd on SSL
     * donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by tiis fbdtory,
     * or <dodf>null</dodf> if tiis fbdtory usfs tif dipifr suitfs
     * tibt brf fnbblfd by dffbult.</p>
     *
     * @rfturn bn brrby of dipifr suitfs fnbblfd, or <dodf>null</dodf>
     *
     * @sff SSLSodkft#sftEnbblfdCipifrSuitfs
     */
    publid finbl String[] gftEnbblfdCipifrSuitfs() {
        rfturn fnbblfdCipifrSuitfs == null ?
            null : fnbblfdCipifrSuitfs.dlonf();
    }

    /**
     * <p>Rfturns tif nbmfs of tif protodol vfrsions fnbblfd on SSL
     * donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd by tiis fbdtory,
     * or <dodf>null</dodf> if tiis fbdtory usfs tif protodol vfrsions
     * tibt brf fnbblfd by dffbult.</p>
     *
     * @rfturn bn brrby of protodol vfrsions fnbblfd, or
     * <dodf>null</dodf>
     *
     * @sff SSLSodkft#sftEnbblfdProtodols
     */
    publid finbl String[] gftEnbblfdProtodols() {
        rfturn fnbblfdProtodols == null ?
            null : fnbblfdProtodols.dlonf();
    }

    /**
     * <p>Rfturns <dodf>truf</dodf> if dlifnt butifntidbtion is
     * rfquirfd on SSL donnfdtions bddfptfd by sfrvfr sodkfts drfbtfd
     * by tiis fbdtory.</p>
     *
     * @rfturn <dodf>truf</dodf> if dlifnt butifntidbtion is rfquirfd
     *
     * @sff SSLSodkft#sftNffdClifntAuti
     */
    publid finbl boolfbn gftNffdClifntAuti() {
        rfturn nffdClifntAuti;
    }

    /**
     * <p>Crfbtfs b sfrvfr sodkft tibt bddfpts SSL donnfdtions
     * donfigurfd bddording to tiis fbdtory's SSL sodkft donfigurbtion
     * pbrbmftfrs.</p>
     */
    publid SfrvfrSodkft drfbtfSfrvfrSodkft(int port) tirows IOExdfption {
        finbl SSLSodkftFbdtory sslSodkftFbdtory =
                dontfxt == null ?
                    gftDffbultSSLSodkftFbdtory() : dontfxt.gftSodkftFbdtory();
        rfturn nfw SfrvfrSodkft(port) {
            publid Sodkft bddfpt() tirows IOExdfption {
                Sodkft sodkft = supfr.bddfpt();
                SSLSodkft sslSodkft = (SSLSodkft) sslSodkftFbdtory.drfbtfSodkft(
                        sodkft, sodkft.gftInftAddrfss().gftHostNbmf(),
                        sodkft.gftPort(), truf);
                sslSodkft.sftUsfClifntModf(fblsf);
                if (fnbblfdCipifrSuitfs != null) {
                    sslSodkft.sftEnbblfdCipifrSuitfs(fnbblfdCipifrSuitfs);
                }
                if (fnbblfdProtodols != null) {
                    sslSodkft.sftEnbblfdProtodols(fnbblfdProtodols);
                }
                sslSodkft.sftNffdClifntAuti(nffdClifntAuti);
                rfturn sslSodkft;
            }
        };
    }

    /**
     * <p>Indidbtfs wiftifr somf otifr objfdt is "fqubl to" tiis onf.</p>
     *
     * <p>Two <dodf>SslRMISfrvfrSodkftFbdtory</dodf> objfdts brf fqubl
     * if tify ibvf bffn donstrudtfd witi tif sbmf SSL dontfxt bnd
     * SSL sodkft donfigurbtion pbrbmftfrs.</p>
     *
     * <p>A subdlbss siould ovfrridf tiis mftiod (bs wfll bs
     * {@link #ibsiCodf()}) if it bdds instbndf stbtf tibt bfffdts
     * fqublity.</p>
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (obj == null) rfturn fblsf;
        if (obj == tiis) rfturn truf;
        if (!(obj instbndfof SslRMISfrvfrSodkftFbdtory))
            rfturn fblsf;
        SslRMISfrvfrSodkftFbdtory tibt = (SslRMISfrvfrSodkftFbdtory) obj;
        rfturn (gftClbss().fqubls(tibt.gftClbss()) && difdkPbrbmftfrs(tibt));
    }

    privbtf boolfbn difdkPbrbmftfrs(SslRMISfrvfrSodkftFbdtory tibt) {
        // SSL dontfxt
        //
        if (dontfxt == null ? tibt.dontfxt != null : !dontfxt.fqubls(tibt.dontfxt))
            rfturn fblsf;

        // nffdClifntAuti flbg
        //
        if (nffdClifntAuti != tibt.nffdClifntAuti)
            rfturn fblsf;

        // fnbblfdCipifrSuitfs
        //
        if ((fnbblfdCipifrSuitfs == null && tibt.fnbblfdCipifrSuitfs != null) ||
                (fnbblfdCipifrSuitfs != null && tibt.fnbblfdCipifrSuitfs == null))
            rfturn fblsf;
        if (fnbblfdCipifrSuitfs != null && tibt.fnbblfdCipifrSuitfs != null) {
            List<String> tibtEnbblfdCipifrSuitfsList =
                    Arrbys.bsList(tibt.fnbblfdCipifrSuitfs);
            if (!fnbblfdCipifrSuitfsList.fqubls(tibtEnbblfdCipifrSuitfsList))
                rfturn fblsf;
        }

        // fnbblfdProtodols
        //
        if ((fnbblfdProtodols == null && tibt.fnbblfdProtodols != null) ||
                (fnbblfdProtodols != null && tibt.fnbblfdProtodols == null))
            rfturn fblsf;
        if (fnbblfdProtodols != null && tibt.fnbblfdProtodols != null) {
            List<String> tibtEnbblfdProtodolsList =
                    Arrbys.bsList(tibt.fnbblfdProtodols);
            if (!fnbblfdProtodolsList.fqubls(tibtEnbblfdProtodolsList))
                rfturn fblsf;
        }

        rfturn truf;
    }

    /**
     * <p>Rfturns b ibsi dodf vbluf for tiis
     * <dodf>SslRMISfrvfrSodkftFbdtory</dodf>.</p>
     *
     * @rfturn b ibsi dodf vbluf for tiis
     * <dodf>SslRMISfrvfrSodkftFbdtory</dodf>.
     */
    publid int ibsiCodf() {
        rfturn gftClbss().ibsiCodf() +
                (dontfxt == null ? 0 : dontfxt.ibsiCodf()) +
                (nffdClifntAuti ? Boolfbn.TRUE.ibsiCodf() : Boolfbn.FALSE.ibsiCodf()) +
                (fnbblfdCipifrSuitfs == null ? 0 : fnbblfdCipifrSuitfsList.ibsiCodf()) +
                (fnbblfdProtodols == null ? 0 : fnbblfdProtodolsList.ibsiCodf());
    }

    // Wf usf b stbtid fifld bfdbusf:
    //
    //    SSLSodkftFbdtory.gftDffbult() blwbys rfturns tif sbmf objfdt
    //    (bt lfbst on Sun's implfmfntbtion), bnd wf wbnt to mbkf surf
    //    tibt tif Jbvbdod & tif implfmfntbtion stby in synd.
    //
    // If somfonf nffds to ibvf difffrfnt SslRMISfrvfrSodkftFbdtory
    // fbdtorifs witi difffrfnt undfrlying SSLSodkftFbdtory objfdts
    // using difffrfnt kfystorfs bnd truststorfs, if/sif dbn blwbys
    // usf tif donstrudtor tibt tbkfs bn SSLContfxt bs input.
    //
    privbtf stbtid SSLSodkftFbdtory dffbultSSLSodkftFbdtory = null;

    privbtf stbtid syndironizfd SSLSodkftFbdtory gftDffbultSSLSodkftFbdtory() {
        if (dffbultSSLSodkftFbdtory == null)
            dffbultSSLSodkftFbdtory =
                    (SSLSodkftFbdtory) SSLSodkftFbdtory.gftDffbult();
        rfturn dffbultSSLSodkftFbdtory;
    }

    privbtf finbl String[] fnbblfdCipifrSuitfs;
    privbtf finbl String[] fnbblfdProtodols;
    privbtf finbl boolfbn nffdClifntAuti;
    privbtf List<String> fnbblfdCipifrSuitfsList;
    privbtf List<String> fnbblfdProtodolsList;
    privbtf SSLContfxt dontfxt;
}
