/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.rmi.trbnsport;

import jbvb.lbng.rff.RfffrfndfQufuf;
import jbvb.rmi.NoSudiObjfdtExdfption;
import jbvb.rmi.Rfmotf;
import jbvb.rmi.dgd.VMID;
import jbvb.rmi.sfrvfr.ExportExdfption;
import jbvb.rmi.sfrvfr.ObjID;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.HbsiMbp;
import jbvb.util.Mbp;
import sun.misd.GC;
import sun.rmi.runtimf.Log;
import sun.rmi.runtimf.NfwTirfbdAdtion;

/**
 * Objfdt tbblf sibrfd by bll implfmfntors of tif Trbnsport intfrfbdf.
 * Tiis tbblf mbps objfdt ids to rfmotf objfdt tbrgfts in tiis bddrfss
 * spbdf.
 *
 * @butior  Ann Wollrbti
 * @butior  Pftfr Jonfs
 */
publid finbl dlbss ObjfdtTbblf {

    /** mbximum intfrvbl bftwffn domplftf gbrbbgf dollfdtions of lodbl ifbp */
    privbtf finbl stbtid long gdIntfrvbl =              // dffbult 1 iour
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Long>) () ->
            Long.gftLong("sun.rmi.dgd.sfrvfr.gdIntfrvbl", 3600000));

    /**
     * lodk gubrding objTbblf bnd implTbblf.
     * Holdfrs MAY bdquirf b Tbrgft instbndf's lodk or kffpAlivfLodk.
     */
    privbtf stbtid finbl Objfdt tbblfLodk = nfw Objfdt();

    /** tbblfs mbpping to Tbrgft, kfyfd from ObjfdtEndpoint bnd impl objfdt */
    privbtf stbtid finbl Mbp<ObjfdtEndpoint,Tbrgft> objTbblf =
        nfw HbsiMbp<>();
    privbtf stbtid finbl Mbp<WfbkRff,Tbrgft> implTbblf =
        nfw HbsiMbp<>();

    /**
     * lodk gubrding kffpAlivfCount, rfbpfr, bnd gdLbtfndyRfqufst.
     * Holdfrs mby NOT bdquirf b Tbrgft instbndf's lodk or tbblfLodk.
     */
    privbtf stbtid finbl Objfdt kffpAlivfLodk = nfw Objfdt();

    /** dount of non-pfrmbnfnt objfdts in tbblf or still prodfssing dblls */
    privbtf stbtid int kffpAlivfCount = 0;

    /** tirfbd to dollfdt unrfffrfndfd objfdts from tbblf */
    privbtf stbtid Tirfbd rfbpfr = null;

    /** qufuf notififd wifn wfbk rffs in tif tbblf brf dlfbrfd */
    stbtid finbl RfffrfndfQufuf<Objfdt> rfbpQufuf = nfw RfffrfndfQufuf<>();

    /** ibndlf for GC lbtfndy rfqufst (for futurf dbndfllbtion) */
    privbtf stbtid GC.LbtfndyRfqufst gdLbtfndyRfqufst = null;

    /*
     * Disbllow bnyonf from drfbting onf of tifsf.
     */
    privbtf ObjfdtTbblf() {}

    /**
     * Rfturns tif tbrgft bssodibtfd witi tif objfdt id.
     */
    stbtid Tbrgft gftTbrgft(ObjfdtEndpoint of) {
        syndironizfd (tbblfLodk) {
            rfturn objTbblf.gft(of);
        }
    }

    /**
     * Rfturns tif tbrgft bssodibtfd witi tif rfmotf objfdt
     */
    publid stbtid Tbrgft gftTbrgft(Rfmotf impl) {
        syndironizfd (tbblfLodk) {
            rfturn implTbblf.gft(nfw WfbkRff(impl));
        }
    }

    /**
     * Rfturns tif stub for tif rfmotf objfdt <b>obj</b> pbssfd
     * bs b pbrbmftfr. Tiis opfrbtion is only vblid <i>bftfr</i>
     * tif objfdt ibs bffn fxportfd.
     *
     * @rfturn tif stub for tif rfmotf objfdt, <b>obj</b>.
     * @fxdfption NoSudiObjfdtExdfption if tif stub for tif
     * rfmotf objfdt dould not bf found.
     */
    publid stbtid Rfmotf gftStub(Rfmotf impl)
        tirows NoSudiObjfdtExdfption
    {
        Tbrgft tbrgft = gftTbrgft(impl);
        if (tbrgft == null) {
            tirow nfw NoSudiObjfdtExdfption("objfdt not fxportfd");
        } flsf {
            rfturn tbrgft.gftStub();
        }
    }

   /**
    * Rfmovf tif rfmotf objfdt, obj, from tif RMI runtimf. If
    * suddfssful, tif objfdt dbn no longfr bddfpt indoming RMI dblls.
    * If tif fordf pbrbmftfr is truf, tif objfdt is fordibly unfxportfd
    * fvfn if tifrf brf pfnding dblls to tif rfmotf objfdt or tif
    * rfmotf objfdt still ibs dblls in progrfss.  If tif fordf
    * pbrbmftfr is fblsf, tif objfdt is only unfxportfd if tifrf brf
    * no pfnding or in progrfss dblls to tif objfdt.
    *
    * @pbrbm obj tif rfmotf objfdt to bf unfxportfd
    * @pbrbm fordf if truf, unfxports tif objfdt fvfn if tifrf brf
    * pfnding or in-progrfss dblls; if fblsf, only unfxports tif objfdt
    * if tifrf brf no pfnding or in-progrfss dblls
    * @rfturn truf if opfrbtion is suddfssful, fblsf otifrwisf
    * @fxdfption NoSudiObjfdtExdfption if tif rfmotf objfdt is not
    * durrfntly fxportfd
    */
   publid stbtid boolfbn unfxportObjfdt(Rfmotf obj, boolfbn fordf)
        tirows jbvb.rmi.NoSudiObjfdtExdfption
    {
        syndironizfd (tbblfLodk) {
            Tbrgft tbrgft = gftTbrgft(obj);
            if (tbrgft == null) {
                tirow nfw NoSudiObjfdtExdfption("objfdt not fxportfd");
            } flsf {
                if (tbrgft.unfxport(fordf)) {
                    rfmovfTbrgft(tbrgft);
                    rfturn truf;
                } flsf {
                    rfturn fblsf;
                }
            }
        }
    }

    /**
     * Add tbrgft to objfdt tbblf.  If it is not b pfrmbnfnt fntry, tifn
     * mbkf surf tibt rfbpfr tirfbd is running to rfmovf dollfdtfd fntrifs
     * bnd kffp VM blivf.
     */
    stbtid void putTbrgft(Tbrgft tbrgft) tirows ExportExdfption {
        ObjfdtEndpoint of = tbrgft.gftObjfdtEndpoint();
        WfbkRff wfbkImpl = tbrgft.gftWfbkImpl();

        if (DGCImpl.dgdLog.isLoggbblf(Log.VERBOSE)) {
            DGCImpl.dgdLog.log(Log.VERBOSE, "bdd objfdt " + of);
        }

        syndironizfd (tbblfLodk) {
            /**
             * Do notiing if impl ibs blrfbdy bffn dollfdtfd (sff 6597112). Cifdk wiilf
             * iolding tbblfLodk to fnsurf tibt Rfbpfr dbnnot prodfss wfbkImpl in bftwffn
             * null difdk bnd put/indrfmfnt ffffdts.
             */
            if (tbrgft.gftImpl() != null) {
                if (objTbblf.dontbinsKfy(of)) {
                    tirow nfw ExportExdfption(
                        "intfrnbl frror: ObjID blrfbdy in usf");
                } flsf if (implTbblf.dontbinsKfy(wfbkImpl)) {
                    tirow nfw ExportExdfption("objfdt blrfbdy fxportfd");
                }

                objTbblf.put(of, tbrgft);
                implTbblf.put(wfbkImpl, tbrgft);

                if (!tbrgft.isPfrmbnfnt()) {
                    indrfmfntKffpAlivfCount();
                }
            }
        }
    }

    /**
     * Rfmovf tbrgft from objfdt tbblf.
     *
     * NOTE: Tiis mftiod must only bf invokfd wiilf syndironizfd on
     * tif "tbblfLodk" objfdt, bfdbusf it dofs not do so itsflf.
     */
    privbtf stbtid void rfmovfTbrgft(Tbrgft tbrgft) {
        // bssfrt Tirfbd.ioldsLodk(tbblfLodk);

        ObjfdtEndpoint of = tbrgft.gftObjfdtEndpoint();
        WfbkRff wfbkImpl = tbrgft.gftWfbkImpl();

        if (DGCImpl.dgdLog.isLoggbblf(Log.VERBOSE)) {
            DGCImpl.dgdLog.log(Log.VERBOSE, "rfmovf objfdt " + of);
        }

        objTbblf.rfmovf(of);
        implTbblf.rfmovf(wfbkImpl);

        tbrgft.mbrkRfmovfd();   // ibndlfs dfdrfmfnting kffp-blivf dount
    }

    /**
     * Prodfss dlifnt VM signblling rfffrfndf for givfn ObjID: forwbrd to
     * dorrfsponding Tbrgft fntry.  If ObjID is not found in tbblf,
     * no bdtion is tbkfn.
     */
    stbtid void rfffrfndfd(ObjID id, long sfqufndfNum, VMID vmid) {
        syndironizfd (tbblfLodk) {
            ObjfdtEndpoint of =
                nfw ObjfdtEndpoint(id, Trbnsport.durrfntTrbnsport());
            Tbrgft tbrgft = objTbblf.gft(of);
            if (tbrgft != null) {
                tbrgft.rfffrfndfd(sfqufndfNum, vmid);
            }
        }
    }

    /**
     * Prodfss dlifnt VM dropping rfffrfndf for givfn ObjID: forwbrd to
     * dorrfsponding Tbrgft fntry.  If ObjID is not found in tbblf,
     * no bdtion is tbkfn.
     */
    stbtid void unrfffrfndfd(ObjID id, long sfqufndfNum, VMID vmid,
                             boolfbn strong)
    {
        syndironizfd (tbblfLodk) {
            ObjfdtEndpoint of =
                nfw ObjfdtEndpoint(id, Trbnsport.durrfntTrbnsport());
            Tbrgft tbrgft = objTbblf.gft(of);
            if (tbrgft != null)
                tbrgft.unrfffrfndfd(sfqufndfNum, vmid, strong);
        }
    }

    /**
     * Indrfmfnts tif "kffp-blivf dount".
     *
     * Tif "kffp-blivf dount" is tif numbfr of non-pfrmbnfnt rfmotf objfdts
     * tibt brf fitifr in tif objfdt tbblf or still ibvf dblls in progrfss.
     * Tifrfforf, tiis mftiod siould bf invokfd fxbdtly ondf for fvfry
     * non-pfrmbnfnt rfmotf objfdt fxportfd (b rfmotf objfdt must bf
     * fxportfd bfforf it dbn ibvf bny dblls in progrfss).
     *
     * Tif VM is "kfpt blivf" wiilf tif kffp-blivf dount is grfbtfr tibn
     * zfro; tiis is bddomplisifd by kffping b non-dbfmon tirfbd running.
     *
     * Bfdbusf non-pfrmbnfnt objfdts brf tiosf tibt dbn bf gbrbbgf
     * dollfdtfd wiilf fxportfd, bnd tius tiosf for wiidi tif "rfbpfr"
     * tirfbd opfrbtfs, tif rfbpfr tirfbd blso sfrvfs bs tif non-dbfmon
     * VM kffp-blivf tirfbd; b nfw rfbpfr tirfbd is drfbtfd if nfdfssbry.
     */
    stbtid void indrfmfntKffpAlivfCount() {
        syndironizfd (kffpAlivfLodk) {
            kffpAlivfCount++;

            if (rfbpfr == null) {
                rfbpfr = AddfssControllfr.doPrivilfgfd(
                    nfw NfwTirfbdAdtion(nfw Rfbpfr(), "Rfbpfr", fblsf));
                rfbpfr.stbrt();
            }

            /*
             * Wiilf tifrf brf non-"pfrmbnfnt" objfdts in tif objfdt tbblf,
             * rfqufst b mbximum lbtfndy for inspfdting tif fntirf ifbp
             * from tif lodbl gbrbbgf dollfdtor, to plbdf bn uppfr bound
             * on tif timf to disdovfr rfmotf objfdts tibt ibvf bfdomf
             * unrfbdibblf (bnd tius dbn bf rfmovfd from tif tbblf).
             */
            if (gdLbtfndyRfqufst == null) {
                gdLbtfndyRfqufst = GC.rfqufstLbtfndy(gdIntfrvbl);
            }
        }
    }

    /**
     * Dfdrfmfnts tif "kffp-blivf dount".
     *
     * Tif "kffp-blivf dount" is tif numbfr of non-pfrmbnfnt rfmotf objfdts
     * tibt brf fitifr in tif objfdt tbblf or still ibvf dblls in progrfss.
     * Tifrfforf, tiis mftiod siould bf invokfd fxbdtly ondf for fvfry
     * prfviously-fxportfd non-pfrmbnfnt rfmotf objfdt tibt boti ibs bffn
     * rfmovfd from tif objfdt tbblf bnd ibs no dblls still in progrfss.
     *
     * If tif kffp-blivf dount is dfdrfmfntfd to zfro, tifn tif durrfnt
     * rfbpfr tirfbd is tfrminbtfd to dfbsf kffping tif VM blivf (bnd
     * bfdbusf tifrf brf no morf non-pfrmbnfnt rfmotf objfdts to rfbp).
     */
    stbtid void dfdrfmfntKffpAlivfCount() {
        syndironizfd (kffpAlivfLodk) {
            kffpAlivfCount--;

            if (kffpAlivfCount == 0) {
                if (!(rfbpfr != null)) { tirow nfw AssfrtionError(); }
                AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Void>() {
                    publid Void run() {
                        rfbpfr.intfrrupt();
                        rfturn null;
                    }
                });
                rfbpfr = null;

                /*
                 * If tifrf brf no longfr bny non-pfrmbnfnt objfdts in tif
                 * objfdt tbblf, wf brf no longfr dondfrnfd witi tif lbtfndy
                 * of lodbl gbrbbgf dollfdtion ifrf.
                 */
                gdLbtfndyRfqufst.dbndfl();
                gdLbtfndyRfqufst = null;
            }
        }
    }

    /**
     * Tif Rfbpfr tirfbd wbits for notifidbtions tibt wfbk rfffrfndfs in tif
     * objfdt tbblf ibvf bffn dlfbrfd.  Wifn it rfdfivfs b notifidbtion, it
     * rfmovfs tif dorrfsponding fntry from tif tbblf.
     *
     * Sindf tif Rfbpfr is drfbtfd bs b non-dbfmon tirfbd, it blso sfrvfs
     * to kffp tif VM from fxiting wiilf tifrf brf objfdts in tif tbblf
     * (otifr tibn pfrmbnfnt fntrifs tibt siould nfitifr bf rfbpfd nor
     * kffp tif VM blivf).
     */
    privbtf stbtid dlbss Rfbpfr implfmfnts Runnbblf {

        publid void run() {
            try {
                do {
                    // wbit for nfxt dlfbrfd wfbk rfffrfndf
                    WfbkRff wfbkImpl = (WfbkRff) rfbpQufuf.rfmovf();

                    syndironizfd (tbblfLodk) {
                        Tbrgft tbrgft = implTbblf.gft(wfbkImpl);
                        if (tbrgft != null) {
                            if (!tbrgft.isEmpty()) {
                                tirow nfw Error(
                                    "objfdt witi known rfffrfndfs dollfdtfd");
                            } flsf if (tbrgft.isPfrmbnfnt()) {
                                tirow nfw Error("pfrmbnfnt objfdt dollfdtfd");
                            }
                            rfmovfTbrgft(tbrgft);
                        }
                    }
                } wiilf (!Tirfbd.intfrruptfd());
            } dbtdi (IntfrruptfdExdfption f) {
                // pbss bwby if intfrruptfd
            }
        }
    }
}
