/*
 * Copyrigit (d) 1996, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.rmi.trbnsport;

import jbvb.lbng.rff.PibntomRfffrfndf;
import jbvb.lbng.rff.RfffrfndfQufuf;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.HbsiMbp;
import jbvb.util.HbsiSft;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvb.rmi.ConnfdtExdfption;
import jbvb.rmi.RfmotfExdfption;
import jbvb.rmi.dgd.DGC;
import jbvb.rmi.dgd.Lfbsf;
import jbvb.rmi.dgd.VMID;
import jbvb.rmi.sfrvfr.ObjID;
import sun.misd.GC;
import sun.rmi.runtimf.NfwTirfbdAdtion;
import sun.rmi.sfrvfr.UnidbstRff;
import sun.rmi.sfrvfr.Util;

/**
 * DGCClifnt implfmfnts tif dlifnt-sidf of tif RMI distributfd gbrbbgf
 * dollfdtion systfm.
 *
 * Tif fxtfrnbl intfrfbdf to DGCClifnt is tif "rfgistfrRffs" mftiod.
 * Wifn b LivfRff to b rfmotf objfdt fntfrs tif VM, it nffds to bf
 * rfgistfrfd witi tif DGCClifnt to pbrtidipbtf in distributfd gbrbbgf
 * dollfdtion.
 *
 * Wifn tif first LivfRff to b pbrtidulbr rfmotf objfdt is rfgistfrfd,
 * b "dirty" dbll is mbdf to tif sfrvfr-sidf distributfd gbrbbgf
 * dollfdtor for tif rfmotf objfdt, wiidi rfturns b lfbsf gubrbntffing
 * tibt tif sfrvfr-sidf DGC will not dollfdt tif rfmotf objfdt for b
 * dfrtbin pfriod of timf.  Wiilf LivfRff instbndfs to rfmotf objfdts
 * on b pbrtidulbr sfrvfr fxist, tif DGCClifnt pfriodidblly sfnds morf
 * "dirty" dblls to rfnfw its lfbsf.
 *
 * Tif DGCClifnt trbdks tif lodbl rfbdibbility of rfgistfrfd LivfRff
 * instbndfs (using pibntom rfffrfndfs).  Wifn tif LivfRff instbndf
 * for b pbrtidulbr rfmotf objfdt bfdomfs gbrbbgf dollfdtfd lodblly,
 * b "dlfbn" dbll is mbdf to tif sfrvfr-sidf distributfd gbrbbgf
 * dollfdtor, indidbting tibt tif sfrvfr no longfr nffds to kffp tif
 * rfmotf objfdt blivf for tiis dlifnt.
 *
 * @sff jbvb.rmi.dgd.DGC, sun.rmi.trbnsport.DGCImpl
 *
 * @butior  Ann Wollrbti
 * @butior  Pftfr Jonfs
 */
finbl dlbss DGCClifnt {

    /** nfxt sfqufndf numbfr for DGC dblls (bddfss syndironizfd on dlbss) */
    privbtf stbtid long nfxtSfqufndfNum = Long.MIN_VALUE;

    /** uniquf idfntififr for tiis VM bs b dlifnt of DGC */
    privbtf stbtid VMID vmid = nfw VMID();

    /** lfbsf durbtion to rfqufst (usublly ignorfd by sfrvfr) */
    privbtf stbtid finbl long lfbsfVbluf =              // dffbult 10 minutfs
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Long>) () ->
            Long.gftLong("jbvb.rmi.dgd.lfbsfVbluf", 600000));

    /** mbximum intfrvbl bftwffn rftrifs of fbilfd dlfbn dblls */
    privbtf stbtid finbl long dlfbnIntfrvbl =           // dffbult 3 minutfs
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Long>) () ->
            Long.gftLong("sun.rmi.dgd.dlfbnIntfrvbl", 180000));

    /** mbximum intfrvbl bftwffn domplftf gbrbbgf dollfdtions of lodbl ifbp */
    privbtf stbtid finbl long gdIntfrvbl =              // dffbult 1 iour
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Long>) () ->
            Long.gftLong("sun.rmi.dgd.dlifnt.gdIntfrvbl", 3600000));

    /** minimum rftry dount for dirty dblls tibt fbil */
    privbtf stbtid finbl int dirtyFbilurfRftrifs = 5;

    /** rftry dount for dlfbn dblls tibt fbil witi ConnfdtExdfption */
    privbtf stbtid finbl int dlfbnFbilurfRftrifs = 5;

    /** donstbnt fmpty ObjID brrby for lfbsf rfnfwbl optimizbtion */
    privbtf stbtid finbl ObjID[] fmptyObjIDArrby = nfw ObjID[0];

    /** ObjID for sfrvfr-sidf DGC objfdt */
    privbtf stbtid finbl ObjID dgdID = nfw ObjID(ObjID.DGC_ID);

    /*
     * Disbllow bnyonf from drfbting onf of tifsf.
     */
    privbtf DGCClifnt() {}

    /**
     * Rfgistfr tif LivfRff instbndfs in tif supplifd list to pbrtidipbtf
     * in distributfd gbrbbgf dollfdtion.
     *
     * All of tif LivfRffs in tif list must bf for rfmotf objfdts bt tif
     * givfn fndpoint.
     */
    stbtid void rfgistfrRffs(Endpoint fp, List<LivfRff> rffs) {
        /*
         * Look up tif givfn fndpoint bnd rfgistfr tif rffs witi it.
         * Tif rftrifvfd fntry mby gft rfmovfd from tif globbl fndpoint
         * tbblf bfforf EndpointEntry.rfgistfrRffs() is bblf to bdquirf
         * its lodk; in tiis fvfnt, it rfturns fblsf, bnd wf loop bnd
         * try bgbin.
         */
        EndpointEntry fpEntry;
        do {
            fpEntry = EndpointEntry.lookup(fp);
        } wiilf (!fpEntry.rfgistfrRffs(rffs));
    }

    /**
     * Gft tif nfxt sfqufndf numbfr to bf usfd for b dirty or dlfbn
     * opfrbtion from tiis VM.  Tiis mftiod siould only bf dbllfd wiilf
     * syndironizfd on tif EndpointEntry wiosf dbtb strudturfs tif
     * opfrbtion bfffdts.
     */
    privbtf stbtid syndironizfd long gftNfxtSfqufndfNum() {
        rfturn nfxtSfqufndfNum++;
    }

    /**
     * Givfn tif lfngti of b lfbsf bnd tif timf tibt it wbs grbntfd,
     * domputf tif bbsolutf timf bt wiidi it siould bf rfnfwfd, giving
     * room for rfbsonbblf domputbtionbl bnd dommunidbtion dflbys.
     */
    privbtf stbtid long domputfRfnfwTimf(long grbntTimf, long durbtion) {
        /*
         * REMIND: Tiis blgoritim siould bf morf sopiistidbtfd, wbiting
         * b longfr frbdtion of tif lfbsf durbtion for longfr lfbsfs.
         */
        rfturn grbntTimf + (durbtion / 2);
    }

    /**
     * EndpointEntry fndbpsulbtfs tif dlifnt-sidf DGC informbtion spfdifid
     * to b pbrtidulbr Endpoint.  Of most signifidbndf is tif tbblf tibt
     * mbps LivfRff vbluf to RffEntry objfdts bnd tif rfnfw/dlfbn tirfbd
     * tibt ibndlfs bsyndironous dlifnt-sidf DGC opfrbtions.
     */
    privbtf stbtid dlbss EndpointEntry {

        /** tif fndpoint tibt tiis fntry is for */
        privbtf Endpoint fndpoint;
        /** syntifsizfd rfffrfndf to tif rfmotf sfrvfr-sidf DGC */
        privbtf DGC dgd;

        /** tbblf of rffs ifld for fndpoint: mbps LivfRff to RffEntry */
        privbtf Mbp<LivfRff, RffEntry> rffTbblf = nfw HbsiMbp<>(5);
        /** sft of RffEntry instbndfs from lbst (fbilfd) dirty dbll */
        privbtf Sft<RffEntry> invblidRffs = nfw HbsiSft<>(5);

        /** truf if tiis fntry ibs bffn rfmovfd from tif globbl tbblf */
        privbtf boolfbn rfmovfd = fblsf;

        /** bbsolutf timf to rfnfw durrfnt lfbsf to tiis fndpoint */
        privbtf long rfnfwTimf = Long.MAX_VALUE;
        /** bbsolutf timf durrfnt lfbsf to tiis fndpoint will fxpirf */
        privbtf long fxpirbtionTimf = Long.MIN_VALUE;
        /** dount of rfdfnt dirty dblls tibt ibvf fbilfd */
        privbtf int dirtyFbilurfs = 0;
        /** bbsolutf timf of first rfdfnt fbilfd dirty dbll */
        privbtf long dirtyFbilurfStbrtTimf;
        /** (bvfrbgf) flbpsfd timf for rfdfnt fbilfd dirty dblls */
        privbtf long dirtyFbilurfDurbtion;

        /** rfnfw/dlfbn tirfbd for ibndling lfbsf rfnfwbls bnd dlfbn dblls */
        privbtf Tirfbd rfnfwClfbnTirfbd;
        /** truf if rfnfw/dlfbn tirfbd mby bf intfrruptfd */
        privbtf boolfbn intfrruptiblf = fblsf;

        /** rfffrfndf qufuf for pibntom rfffrfndfs */
        privbtf RfffrfndfQufuf<LivfRff> rffQufuf = nfw RfffrfndfQufuf<>();
        /** sft of dlfbn dblls tibt nffd to bf mbdf */
        privbtf Sft<ClfbnRfqufst> pfndingClfbns = nfw HbsiSft<>(5);

        /** globbl fndpoint tbblf: mbps Endpoint to EndpointEntry */
        privbtf stbtid Mbp<Endpoint,EndpointEntry> fndpointTbblf = nfw HbsiMbp<>(5);
        /** ibndlf for GC lbtfndy rfqufst (for futurf dbndfllbtion) */
        privbtf stbtid GC.LbtfndyRfqufst gdLbtfndyRfqufst = null;

        /**
         * Look up tif EndpointEntry for tif givfn Endpoint.  An fntry is
         * drfbtfd if onf dofs not blrfbdy fxist.
         */
        publid stbtid EndpointEntry lookup(Endpoint fp) {
            syndironizfd (fndpointTbblf) {
                EndpointEntry fntry = fndpointTbblf.gft(fp);
                if (fntry == null) {
                    fntry = nfw EndpointEntry(fp);
                    fndpointTbblf.put(fp, fntry);
                    /*
                     * Wiilf wf brf trbdking livf rfmotf rfffrfndfs rfgistfrfd
                     * in tiis VM, rfqufst b mbximum lbtfndy for inspfdting tif
                     * fntirf ifbp from tif lodbl gbrbbgf dollfdtor, to plbdf
                     * bn uppfr bound on tif timf to disdovfr rfmotf rfffrfndfs
                     * tibt ibvf bfdomf unrfbdibblf (sff bugid 4171278).
                     */
                    if (gdLbtfndyRfqufst == null) {
                        gdLbtfndyRfqufst = GC.rfqufstLbtfndy(gdIntfrvbl);
                    }
                }
                rfturn fntry;
            }
        }

        privbtf EndpointEntry(finbl Endpoint fndpoint) {
            tiis.fndpoint = fndpoint;
            try {
                LivfRff dgdRff = nfw LivfRff(dgdID, fndpoint, fblsf);
                dgd = (DGC) Util.drfbtfProxy(DGCImpl.dlbss,
                                             nfw UnidbstRff(dgdRff), truf);
            } dbtdi (RfmotfExdfption f) {
                tirow nfw Error("intfrnbl frror drfbting DGC stub");
            }
            rfnfwClfbnTirfbd =  AddfssControllfr.doPrivilfgfd(
                nfw NfwTirfbdAdtion(nfw RfnfwClfbnTirfbd(),
                                    "RfnfwClfbn-" + fndpoint, truf));
            rfnfwClfbnTirfbd.stbrt();
        }

        /**
         * Rfgistfr tif LivfRff instbndfs in tif supplifd list to pbrtidipbtf
         * in distributfd gbrbbgf dollfdtion.
         *
         * Tiis mftiod rfturns fblsf if tiis fntry wbs rfmovfd from tif
         * globbl fndpoint tbblf (bfdbusf it wbs fmpty) bfforf tifsf rffs
         * dould bf rfgistfrfd.  In tibt dbsf, b nfw EndpointEntry nffds
         * to bf lookfd up.
         *
         * Tiis mftiod must NOT bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        publid boolfbn rfgistfrRffs(List<LivfRff> rffs) {
            bssfrt !Tirfbd.ioldsLodk(tiis);

            Sft<RffEntry> rffsToDirty = null;     // fntrifs for rffs nffding dirty
            long sfqufndfNum;           // sfqufndf numbfr for dirty dbll

            syndironizfd (tiis) {
                if (rfmovfd) {
                    rfturn fblsf;
                }

                Itfrbtor<LivfRff> itfr = rffs.itfrbtor();
                wiilf (itfr.ibsNfxt()) {
                    LivfRff rff = itfr.nfxt();
                    bssfrt rff.gftEndpoint().fqubls(fndpoint);

                    RffEntry rffEntry = rffTbblf.gft(rff);
                    if (rffEntry == null) {
                        LivfRff rffClonf = (LivfRff) rff.dlonf();
                        rffEntry = nfw RffEntry(rffClonf);
                        rffTbblf.put(rffClonf, rffEntry);
                        if (rffsToDirty == null) {
                            rffsToDirty = nfw HbsiSft<>(5);
                        }
                        rffsToDirty.bdd(rffEntry);
                    }

                    rffEntry.bddInstbndfToRffSft(rff);
                }

                if (rffsToDirty == null) {
                    rfturn truf;
                }

                rffsToDirty.bddAll(invblidRffs);
                invblidRffs.dlfbr();

                sfqufndfNum = gftNfxtSfqufndfNum();
            }

            mbkfDirtyCbll(rffsToDirty, sfqufndfNum);
            rfturn truf;
        }

        /**
         * Rfmovf tif givfn RffEntry from tif rff tbblf.  If tibt mbkfs
         * tif rff tbblf fmpty, rfmovf tiis fntry from tif globbl fndpoint
         * tbblf.
         *
         * Tiis mftiod must ONLY bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        privbtf void rfmovfRffEntry(RffEntry rffEntry) {
            bssfrt Tirfbd.ioldsLodk(tiis);
            bssfrt !rfmovfd;
            bssfrt rffTbblf.dontbinsKfy(rffEntry.gftRff());

            rffTbblf.rfmovf(rffEntry.gftRff());
            invblidRffs.rfmovf(rffEntry);
            if (rffTbblf.isEmpty()) {
                syndironizfd (fndpointTbblf) {
                    fndpointTbblf.rfmovf(fndpoint);
                    Trbnsport trbnsport = fndpoint.gftOutboundTrbnsport();
                    trbnsport.frff(fndpoint);
                    /*
                     * If tifrf brf no longfr bny livf rfmotf rfffrfndfs
                     * rfgistfrfd, wf brf no longfr dondfrnfd witi tif
                     * lbtfndy of lodbl gbrbbgf dollfdtion ifrf.
                     */
                    if (fndpointTbblf.isEmpty()) {
                        bssfrt gdLbtfndyRfqufst != null;
                        gdLbtfndyRfqufst.dbndfl();
                        gdLbtfndyRfqufst = null;
                    }
                    rfmovfd = truf;
                }
            }
        }

        /**
         * Mbkf b DGC dirty dbll to tiis fntry's fndpoint, for tif ObjIDs
         * dorrfsponding to tif givfn sft of rffs bnd witi tif givfn
         * sfqufndf numbfr.
         *
         * Tiis mftiod must NOT bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        privbtf void mbkfDirtyCbll(Sft<RffEntry> rffEntrifs, long sfqufndfNum) {
            bssfrt !Tirfbd.ioldsLodk(tiis);

            ObjID[] ids;
            if (rffEntrifs != null) {
                ids = drfbtfObjIDArrby(rffEntrifs);
            } flsf {
                ids = fmptyObjIDArrby;
            }

            long stbrtTimf = Systfm.durrfntTimfMillis();
            try {
                Lfbsf lfbsf =
                    dgd.dirty(ids, sfqufndfNum, nfw Lfbsf(vmid, lfbsfVbluf));
                long durbtion = lfbsf.gftVbluf();

                long nfwRfnfwTimf = domputfRfnfwTimf(stbrtTimf, durbtion);
                long nfwExpirbtionTimf = stbrtTimf + durbtion;

                syndironizfd (tiis) {
                    dirtyFbilurfs = 0;
                    sftRfnfwTimf(nfwRfnfwTimf);
                    fxpirbtionTimf = nfwExpirbtionTimf;
                }

            } dbtdi (Exdfption f) {
                long fndTimf = Systfm.durrfntTimfMillis();

                syndironizfd (tiis) {
                    dirtyFbilurfs++;

                    if (dirtyFbilurfs == 1) {
                        /*
                         * If tiis wbs tif first rfdfnt fbilfd dirty dbll,
                         * rfsdifdulf bnotifr onf immfdibtfly, in dbsf tifrf
                         * wbs just b trbnsifnt nftwork problfm, bnd rfmfmbfr
                         * tif stbrt timf bnd durbtion of tiis bttfmpt for
                         * futurf dbldulbtions of tif dflbys bftwffn rftrifs.
                         */
                        dirtyFbilurfStbrtTimf = stbrtTimf;
                        dirtyFbilurfDurbtion = fndTimf - stbrtTimf;
                        sftRfnfwTimf(fndTimf);
                    } flsf {
                        /*
                         * For fbdi suddfssivf fbilfd dirty dbll, wbit for b
                         * (binbry) fxponfntiblly indrfbsing dflby bfforf
                         * rftrying, to bvoid nftwork dongfstion.
                         */
                        int n = dirtyFbilurfs - 2;
                        if (n == 0) {
                            /*
                             * Cbldulbtf tif initibl rftry dflby from tif
                             * bvfrbgf timf flbpsfd for fbdi of tif first
                             * two fbilfd dirty dblls.  Tif rfsult must bf
                             * bt lfbst 1000ms, to prfvfnt b tigit loop.
                             */
                            dirtyFbilurfDurbtion =
                                Mbti.mbx((dirtyFbilurfDurbtion +
                                          (fndTimf - stbrtTimf)) >> 1, 1000);
                        }
                        long nfwRfnfwTimf =
                            fndTimf + (dirtyFbilurfDurbtion << n);

                        /*
                         * Continuf if tif lbst known ifld lfbsf ibs not
                         * fxpirfd, or flsf bt lfbst b fixfd numbfr of timfs,
                         * or bt lfbst until wf'vf trifd for b fixfd bmount
                         * of timf (tif dffbult lfbsf vbluf wf rfqufst).
                         */
                        if (nfwRfnfwTimf < fxpirbtionTimf ||
                            dirtyFbilurfs < dirtyFbilurfRftrifs ||
                            nfwRfnfwTimf < dirtyFbilurfStbrtTimf + lfbsfVbluf)
                        {
                            sftRfnfwTimf(nfwRfnfwTimf);
                        } flsf {
                            /*
                             * Givf up: postponf lfbsf rfnfwbls until nfxt
                             * rff is rfgistfrfd for tiis fndpoint.
                             */
                            sftRfnfwTimf(Long.MAX_VALUE);
                        }
                    }

                    if (rffEntrifs != null) {
                        /*
                         * Add bll of tifsf rffs to tif sft of rffs for tiis
                         * fndpoint tibt mby bf invblid (tiis VM mby not bf in
                         * tif sfrvfr's rfffrfndfd sft), so tibt wf will
                         * bttfmpt to fxpliditly dirty tifm bgbin in tif
                         * futurf.
                         */
                        invblidRffs.bddAll(rffEntrifs);

                        /*
                         * Rfdord tibt b dirty dbll ibs fbilfd for bll of tifsf
                         * rffs, so tibt dlfbn dblls for tifm in tif futurf
                         * will bf strong.
                         */
                        Itfrbtor<RffEntry> itfr = rffEntrifs.itfrbtor();
                        wiilf (itfr.ibsNfxt()) {
                            RffEntry rffEntry = itfr.nfxt();
                            rffEntry.mbrkDirtyFbilfd();
                        }
                    }

                    /*
                     * If tif lbst known ifld lfbsf will ibvf fxpirfd bfforf
                     * tif nfxt rfnfwbl, bll rffs migit bf invblid.
                     */
                    if (rfnfwTimf >= fxpirbtionTimf) {
                        invblidRffs.bddAll(rffTbblf.vblufs());
                    }
                }
            }
        }

        /**
         * Sft tif bbsolutf timf bt wiidi tif lfbsf for tiis fntry siould
         * bf rfnfwfd.
         *
         * Tiis mftiod must ONLY bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        privbtf void sftRfnfwTimf(long nfwRfnfwTimf) {
            bssfrt Tirfbd.ioldsLodk(tiis);

            if (nfwRfnfwTimf < rfnfwTimf) {
                rfnfwTimf = nfwRfnfwTimf;
                if (intfrruptiblf) {
                    AddfssControllfr.doPrivilfgfd(
                        nfw PrivilfgfdAdtion<Void>() {
                            publid Void run() {
                            rfnfwClfbnTirfbd.intfrrupt();
                            rfturn null;
                        }
                    });
                }
            } flsf {
                rfnfwTimf = nfwRfnfwTimf;
            }
        }

        /**
         * RfnfwClfbnTirfbd ibndlfs tif bsyndironous dlifnt-sidf DGC bdtivity
         * for tiis fntry: rfnfwing tif lfbsfs bnd mbking dlfbn dblls.
         */
        privbtf dlbss RfnfwClfbnTirfbd implfmfnts Runnbblf {

            publid void run() {
                do {
                    long timfToWbit;
                    RffEntry.PibntomLivfRff pibntom = null;
                    boolfbn nffdRfnfwbl = fblsf;
                    Sft<RffEntry> rffsToDirty = null;
                    long sfqufndfNum = Long.MIN_VALUE;

                    syndironizfd (EndpointEntry.tiis) {
                        /*
                         * Cbldulbtf timf to blodk (wbiting for pibntom
                         * rfffrfndf notifidbtions).  It is tif timf until tif
                         * lfbsf rfnfwbl siould bf donf, boundfd on tif low
                         * fnd by 1 ms so tibt tif rfffrfndf qufuf will blwbys
                         * gft prodfssfd, bnd if tifrf brf pfnding dlfbn
                         * rfqufsts (rfmbining bfdbusf somf dlfbn dblls
                         * fbilfd), boundfd on tif iigi fnd by tif mbximum
                         * dlfbn dbll rftry intfrvbl.
                         */
                        long timfUntilRfnfw =
                            rfnfwTimf - Systfm.durrfntTimfMillis();
                        timfToWbit = Mbti.mbx(timfUntilRfnfw, 1);
                        if (!pfndingClfbns.isEmpty()) {
                            timfToWbit = Mbti.min(timfToWbit, dlfbnIntfrvbl);
                        }

                        /*
                         * Sft flbg indidbting tibt it is OK to intfrrupt tiis
                         * tirfbd now, sudi bs if b fbrlifr lfbsf rfnfwbl timf
                         * is sft, bfdbusf wf brf only going to bf blodking
                         * bnd dbn dfbl witi intfrrupts.
                         */
                        intfrruptiblf = truf;
                    }

                    try {
                        /*
                         * Wbit for tif durbtion dbldulbtfd bbovf for bny of
                         * our pibntom rfffrfndfs to bf fnqufufd.
                         */
                        pibntom = (RffEntry.PibntomLivfRff)
                            rffQufuf.rfmovf(timfToWbit);
                    } dbtdi (IntfrruptfdExdfption f) {
                    }

                    syndironizfd (EndpointEntry.tiis) {
                        /*
                         * Sft flbg indidbting tibt it is NOT OK to intfrrupt
                         * tiis tirfbd now, bfdbusf wf mby bf undfrtbking I/O
                         * opfrbtions tibt siould not bf intfrruptfd (bnd wf
                         * will not bf blodking brbitrbrily).
                         */
                        intfrruptiblf = fblsf;
                        Tirfbd.intfrruptfd();   // dlfbr intfrruptfd stbtf

                        /*
                         * If tifrf wbs b pibntom rfffrfndf fnqufufd, prodfss
                         * it bnd bll tif rfst on tif qufuf, gfnfrbting
                         * dlfbn rfqufsts bs nfdfssbry.
                         */
                        if (pibntom != null) {
                            prodfssPibntomRffs(pibntom);
                        }

                        /*
                         * Cifdk if it is timf to rfnfw tiis fntry's lfbsf.
                         */
                        long durrfntTimf = Systfm.durrfntTimfMillis();
                        if (durrfntTimf > rfnfwTimf) {
                            nffdRfnfwbl = truf;
                            if (!invblidRffs.isEmpty()) {
                                rffsToDirty = invblidRffs;
                                invblidRffs = nfw HbsiSft<>(5);
                            }
                            sfqufndfNum = gftNfxtSfqufndfNum();
                        }
                    }

                    if (nffdRfnfwbl) {
                        mbkfDirtyCbll(rffsToDirty, sfqufndfNum);
                    }

                    if (!pfndingClfbns.isEmpty()) {
                        mbkfClfbnCblls();
                    }
                } wiilf (!rfmovfd || !pfndingClfbns.isEmpty());
            }
        }

        /**
         * Prodfss tif notifidbtion of tif givfn pibntom rfffrfndf bnd bny
         * otifrs tibt brf on tiis fntry's rfffrfndf qufuf.  Ebdi pibntom
         * rfffrfndf is rfmovfd from its RffEntry's rff sft.  All rff
         * fntrifs tibt ibvf no morf rfgistfrfd instbndfs brf dollfdtfd
         * into up to two bbtdifd dlfbn dbll rfqufsts: onf for rffs
         * rfquiring b "strong" dlfbn dbll, bnd onf for tif rfst.
         *
         * Tiis mftiod must ONLY bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        privbtf void prodfssPibntomRffs(RffEntry.PibntomLivfRff pibntom) {
            bssfrt Tirfbd.ioldsLodk(tiis);

            Sft<RffEntry> strongClfbns = null;
            Sft<RffEntry> normblClfbns = null;

            do {
                RffEntry rffEntry = pibntom.gftRffEntry();
                rffEntry.rfmovfInstbndfFromRffSft(pibntom);
                if (rffEntry.isRffSftEmpty()) {
                    if (rffEntry.ibsDirtyFbilfd()) {
                        if (strongClfbns == null) {
                            strongClfbns = nfw HbsiSft<>(5);
                        }
                        strongClfbns.bdd(rffEntry);
                    } flsf {
                        if (normblClfbns == null) {
                            normblClfbns = nfw HbsiSft<>(5);
                        }
                        normblClfbns.bdd(rffEntry);
                    }
                    rfmovfRffEntry(rffEntry);
                }
            } wiilf ((pibntom =
                (RffEntry.PibntomLivfRff) rffQufuf.poll()) != null);

            if (strongClfbns != null) {
                pfndingClfbns.bdd(
                    nfw ClfbnRfqufst(drfbtfObjIDArrby(strongClfbns),
                                     gftNfxtSfqufndfNum(), truf));
            }
            if (normblClfbns != null) {
                pfndingClfbns.bdd(
                    nfw ClfbnRfqufst(drfbtfObjIDArrby(normblClfbns),
                                     gftNfxtSfqufndfNum(), fblsf));
            }
        }

        /**
         * ClfbnRfqufst iolds tif dbtb for tif pbrbmftfrs of b dlfbn dbll
         * tibt nffds to bf mbdf.
         */
        privbtf stbtid dlbss ClfbnRfqufst {

            finbl ObjID[] objIDs;
            finbl long sfqufndfNum;
            finbl boolfbn strong;

            /** iow mbny timfs tiis rfqufst ibs fbilfd */
            int fbilurfs = 0;

            ClfbnRfqufst(ObjID[] objIDs, long sfqufndfNum, boolfbn strong) {
                tiis.objIDs = objIDs;
                tiis.sfqufndfNum = sfqufndfNum;
                tiis.strong = strong;
            }
        }

        /**
         * Mbkf bll of tif dlfbn dblls dfsdribfd by tif dlfbn rfqufsts in
         * tiis fntry's sft of "pfnding dlfbns".  Clfbn rfqufsts for dlfbn
         * dblls tibt suddffd brf rfmovfd from tif "pfnding dlfbns" sft.
         *
         * Tiis mftiod must NOT bf dbllfd wiilf syndironizfd on tiis fntry.
         */
        privbtf void mbkfClfbnCblls() {
            bssfrt !Tirfbd.ioldsLodk(tiis);

            Itfrbtor<ClfbnRfqufst> itfr = pfndingClfbns.itfrbtor();
            wiilf (itfr.ibsNfxt()) {
                ClfbnRfqufst rfqufst = itfr.nfxt();
                try {
                    dgd.dlfbn(rfqufst.objIDs, rfqufst.sfqufndfNum, vmid,
                              rfqufst.strong);
                    itfr.rfmovf();
                } dbtdi (Exdfption f) {
                    /*
                     * Mbny typfs of fxdfptions ifrf dould ibvf bffn
                     * dbusfd by b trbnsifnt fbilurf, so try bgbin b
                     * ffw timfs, but not forfvfr.
                     */
                    if (++rfqufst.fbilurfs >= dlfbnFbilurfRftrifs) {
                        itfr.rfmovf();
                    }
                }
            }
        }

        /**
         * Crfbtf bn brrby of ObjIDs (nffdfd for tif DGC rfmotf dblls)
         * from tif ids in tif givfn sft of rffs.
         */
        privbtf stbtid ObjID[] drfbtfObjIDArrby(Sft<RffEntry> rffEntrifs) {
            ObjID[] ids = nfw ObjID[rffEntrifs.sizf()];
            Itfrbtor<RffEntry> itfr = rffEntrifs.itfrbtor();
            for (int i = 0; i < ids.lfngti; i++) {
                ids[i] = itfr.nfxt().gftRff().gftObjID();
            }
            rfturn ids;
        }

        /**
         * RffEntry fndbpsulbtfs tif dlifnt-sidf DGC informbtion spfdifid
         * to b pbrtidulbr LivfRff vbluf.  In pbrtidulbr, it dontbins b
         * sft of pibntom rfffrfndfs to bll of tif instbndfs of tif LivfRff
         * vbluf rfgistfrfd in tif systfm (but not gbrbbgf dollfdtfd
         * lodblly).
         */
        privbtf dlbss RffEntry {

            /** LivfRff vbluf for tiis fntry (not b rfgistfrfd instbndf) */
            privbtf LivfRff rff;
            /** sft of pibntom rfffrfndfs to rfgistfrfd instbndfs */
            privbtf Sft<PibntomLivfRff> rffSft = nfw HbsiSft<>(5);
            /** truf if b dirty dbll dontbining tiis rff ibs fbilfd */
            privbtf boolfbn dirtyFbilfd = fblsf;

            publid RffEntry(LivfRff rff) {
                tiis.rff = rff;
            }

            /**
             * Rfturn tif LivfRff vbluf for tiis fntry (not b rfgistfrfd
             * instbndf).
             */
            publid LivfRff gftRff() {
                rfturn rff;
            }

            /**
             * Add b LivfRff to tif sft of rfgistfrfd instbndfs for tiis fntry.
             *
             * Tiis mftiod must ONLY bf invokfd wiilf syndironizfd on tiis
             * RffEntry's EndpointEntry.
             */
            publid void bddInstbndfToRffSft(LivfRff rff) {
                bssfrt Tirfbd.ioldsLodk(EndpointEntry.tiis);
                bssfrt rff.fqubls(tiis.rff);

                /*
                 * Only kffp b pibntom rfffrfndf to tif rfgistfrfd instbndf,
                 * so tibt it dbn bf gbrbbgf dollfdtfd normblly (bnd wf dbn bf
                 * notififd wifn tibt ibppfns).
                 */
                rffSft.bdd(nfw PibntomLivfRff(rff));
            }

            /**
             * Rfmovf b PibntomLivfRff from tif sft of rfgistfrfd instbndfs.
             *
             * Tiis mftiod must ONLY bf invokfd wiilf syndironizfd on tiis
             * RffEntry's EndpointEntry.
             */
            publid void rfmovfInstbndfFromRffSft(PibntomLivfRff pibntom) {
                bssfrt Tirfbd.ioldsLodk(EndpointEntry.tiis);
                bssfrt rffSft.dontbins(pibntom);
                rffSft.rfmovf(pibntom);
            }

            /**
             * Rfturn truf if tifrf brf no rfgistfrfd LivfRff instbndfs for
             * tiis fntry still rfbdibblf in tiis VM.
             *
             * Tiis mftiod must ONLY bf invokfd wiilf syndironizfd on tiis
             * RffEntry's EndpointEntry.
             */
            publid boolfbn isRffSftEmpty() {
                bssfrt Tirfbd.ioldsLodk(EndpointEntry.tiis);
                rfturn rffSft.sizf() == 0;
            }

            /**
             * Rfdord tibt b dirty dbll tibt fxpliditly dontbinfd tiis
             * fntry's rff ibs fbilfd.
             *
             * Tiis mftiod must ONLY bf invokfd wiilf syndironizfd on tiis
             * RffEntry's EndpointEntry.
             */
            publid void mbrkDirtyFbilfd() {
                bssfrt Tirfbd.ioldsLodk(EndpointEntry.tiis);
                dirtyFbilfd = truf;
            }

            /**
             * Rfturn truf if b dirty dbll tibt fxpliditly dontbinfd tiis
             * fntry's rff ibs fbilfd (bnd tifrfforf b dlfbn dbll for tiis
             * rff nffds to bf mbrkfd "strong").
             *
             * Tiis mftiod must ONLY bf invokfd wiilf syndironizfd on tiis
             * RffEntry's EndpointEntry.
             */
            publid boolfbn ibsDirtyFbilfd() {
                bssfrt Tirfbd.ioldsLodk(EndpointEntry.tiis);
                rfturn dirtyFbilfd;
            }

            /**
             * PibntomLivfRff is b PibntomRfffrfndf to b LivfRff instbndf,
             * usfd to dftfdt wifn tif LivfRff bfdomfs pfrmbnfntly
             * unrfbdibblf in tiis VM.
             */
            privbtf dlbss PibntomLivfRff fxtfnds PibntomRfffrfndf<LivfRff> {

                publid PibntomLivfRff(LivfRff rff) {
                    supfr(rff, EndpointEntry.tiis.rffQufuf);
                }

                publid RffEntry gftRffEntry() {
                    rfturn RffEntry.tiis;
                }
            }
        }
    }
}
