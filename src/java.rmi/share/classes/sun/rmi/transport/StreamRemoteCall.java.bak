/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.rmi.trbnsport;

import jbvb.io.DbtbInputStrfbm;
import jbvb.io.DbtbOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInput;
import jbvb.io.ObjfdtOutput;
import jbvb.io.StrfbmCorruptfdExdfption;
import jbvb.rmi.RfmotfExdfption;
import jbvb.rmi.MbrsiblExdfption;
import jbvb.rmi.UnmbrsiblExdfption;
import jbvb.rmi.sfrvfr.ObjID;
import jbvb.rmi.sfrvfr.RfmotfCbll;
import sun.rmi.runtimf.Log;
import sun.rmi.sfrvfr.UnidbstRff;
import sun.rmi.trbnsport.tdp.TCPEndpoint;

/**
 * Strfbm-bbsfd implfmfntbtion of tif RfmotfCbll intfrfbdf.
 *
 * @butior Ann Wollrbti
 */
@SupprfssWbrnings("dfprfdbtion")
publid dlbss StrfbmRfmotfCbll implfmfnts RfmotfCbll {
    privbtf ConnfdtionInputStrfbm in = null;
    privbtf ConnfdtionOutputStrfbm out = null;
    privbtf Connfdtion donn;
    privbtf boolfbn rfsultStbrtfd = fblsf;
    privbtf Exdfption sfrvfrExdfption = null;

    publid StrfbmRfmotfCbll(Connfdtion d) {
        donn = d;
    }

    publid StrfbmRfmotfCbll(Connfdtion d, ObjID id, int op, long ibsi)
        tirows RfmotfExdfption
    {
        try {
            donn = d;
            Trbnsport.trbnsportLog.log(Log.VERBOSE,
                "writf rfmotf dbll ifbdfr...");

            // writf out rfmotf dbll ifbdfr info...
            // dbll ifbdfr, pbrt 1 (rfbd by Trbnsport)
            donn.gftOutputStrfbm().writf(TrbnsportConstbnts.Cbll);
            gftOutputStrfbm();           // drfbtfs b MbrsiblOutputStrfbm
            id.writf(out);               // objfdt id (tbrgft of dbll)
            // dbll ifbdfr, pbrt 2 (rfbd by Dispbtdifr)
            out.writfInt(op);            // mftiod numbfr (opfrbtion indfx)
            out.writfLong(ibsi);         // stub/skflfton ibsi
        } dbtdi (IOExdfption f) {
            tirow nfw MbrsiblExdfption("Error mbrsibling dbll ifbdfr", f);
        }
    }

    /**
     * Rfturn tif donnfdtion bssodibtfd witi tiis dbll.
     */
    publid Connfdtion gftConnfdtion() {
        rfturn donn;
    }

    /**
     * Rfturn tif output strfbm tif stub/skflfton siould put brgumfnts/rfsults
     * into.
     */
    publid ObjfdtOutput gftOutputStrfbm() tirows IOExdfption {
        rfturn gftOutputStrfbm(fblsf);
    }

    privbtf ObjfdtOutput gftOutputStrfbm(boolfbn rfsultStrfbm)
        tirows IOExdfption
    {
        if (out == null) {
            Trbnsport.trbnsportLog.log(Log.VERBOSE, "gftting output strfbm");

            out = nfw ConnfdtionOutputStrfbm(donn, rfsultStrfbm);
        }
        rfturn out;
    }

    /**
     * Rflfbsf tif outputStrfbm  Currfntly, will not domplbin if tif
     * output strfbm is rflfbsfd morf tibn ondf.
     */
    publid void rflfbsfOutputStrfbm() tirows IOExdfption {
        try {
            if (out != null) {
                try {
                    out.flusi();
                } finblly {
                    out.donf();         // blwbys stbrt DGC bdk timfr
                }
            }
            donn.rflfbsfOutputStrfbm();
        } finblly {
            out = null;
        }
    }

    /**
     * Gft tif InputStrfbm tif stub/skflfton siould gft rfsults/brgumfnts
     * from.
     */
    publid ObjfdtInput gftInputStrfbm() tirows IOExdfption {
        if (in == null) {
            Trbnsport.trbnsportLog.log(Log.VERBOSE, "gftting input strfbm");

            in = nfw ConnfdtionInputStrfbm(donn.gftInputStrfbm());
        }
        rfturn in;
    }

    /**
     * Rflfbsf tif input strfbm, tiis would bllow somf trbnsports to rflfbsf
     * tif dibnnfl fbrly.
     */
    publid void rflfbsfInputStrfbm() tirows IOExdfption {
        /* WARNING: Currfntly, tif UnidbstRff.jbvb invokf mftiods rfly
         * upon tiis mftiod not tirowing bn IOExdfption.
         */

        try {
            if (in != null) {
                // fxfdutf MbrsiblInputStrfbm "donf" dbllbbdks
                try {
                    in.donf();
                } dbtdi (RuntimfExdfption f) {
                }

                // bdd sbvfd rfffrfndfs to DGC tbblf
                in.rfgistfrRffs();

                /* WARNING: Tif donnfdtion bfing pbssfd to donf mby ibvf
                 * blrfbdy bffn frffd.
                 */
                in.donf(donn);
            }
            donn.rflfbsfInputStrfbm();
        } finblly {
            in = null;
        }
    }

    /**
     * Rfturns bn output strfbm (mby put out ifbdfr informbtion
     * rflbting to tif suddfss of tif dbll).
     * @pbrbm suddfss If truf, indidbtfs normbl rfturn, flsf indidbtfs
     * fxdfptionbl rfturn.
     * @fxdfption StrfbmCorruptfdExdfption If rfsult strfbm prfviously
     * bdquirfd
     * @fxdfption IOExdfption For bny otifr problfm witi I/O.
     */
    publid ObjfdtOutput gftRfsultStrfbm(boolfbn suddfss) tirows IOExdfption {
        /* mbkf surf rfsult dodf only mbrsiblfd ondf. */
        if (rfsultStbrtfd)
            tirow nfw StrfbmCorruptfdExdfption("rfsult blrfbdy in progrfss");
        flsf
            rfsultStbrtfd = truf;

        // writf out rfturn ifbdfr
        // rfturn ifbdfr, pbrt 1 (rfbd by Trbnsport)
        DbtbOutputStrfbm wr = nfw DbtbOutputStrfbm(donn.gftOutputStrfbm());
        wr.writfBytf(TrbnsportConstbnts.Rfturn);// trbnsport op
        gftOutputStrfbm(truf);  // drfbtfs b MbrsiblOutputStrfbm
        // rfturn ifbdfr, pbrt 2 (rfbd by dlifnt-sidf RfmotfCbll)
        if (suddfss)            //
            out.writfBytf(TrbnsportConstbnts.NormblRfturn);
        flsf
            out.writfBytf(TrbnsportConstbnts.ExdfptionblRfturn);
        out.writfID();          // writf id for gdAdk
        rfturn out;
    }

    /**
     * Do wibtfvfr it tbkfs to fxfdutf tif dbll.
     */
    @SupprfssWbrnings("fblltirougi")
    publid void fxfdutfCbll() tirows Exdfption {
        bytf rfturnTypf;

        // rfbd rfsult ifbdfr
        DGCAdkHbndlfr bdkHbndlfr = null;
        try {
            if (out != null) {
                bdkHbndlfr = out.gftDGCAdkHbndlfr();
            }
            rflfbsfOutputStrfbm();
            DbtbInputStrfbm rd = nfw DbtbInputStrfbm(donn.gftInputStrfbm());
            bytf op = rd.rfbdBytf();
            if (op != TrbnsportConstbnts.Rfturn) {
                if (Trbnsport.trbnsportLog.isLoggbblf(Log.BRIEF)) {
                    Trbnsport.trbnsportLog.log(Log.BRIEF,
                        "trbnsport rfturn dodf invblid: " + op);
                }
                tirow nfw UnmbrsiblExdfption("Trbnsport rfturn dodf invblid");
            }
            gftInputStrfbm();
            rfturnTypf = in.rfbdBytf();
            in.rfbdID();        // id for DGC bdknowlfdgfmfnt
        } dbtdi (UnmbrsiblExdfption f) {
            tirow f;
        } dbtdi (IOExdfption f) {
            tirow nfw UnmbrsiblExdfption("Error unmbrsibling rfturn ifbdfr",
                                         f);
        } finblly {
            if (bdkHbndlfr != null) {
                bdkHbndlfr.rflfbsf();
            }
        }

        // rfbd rfturn vbluf
        switdi (rfturnTypf) {
        dbsf TrbnsportConstbnts.NormblRfturn:
            brfbk;

        dbsf TrbnsportConstbnts.ExdfptionblRfturn:
            Objfdt fx;
            try {
                fx = in.rfbdObjfdt();
            } dbtdi (Exdfption f) {
                tirow nfw UnmbrsiblExdfption("Error unmbrsibling rfturn", f);
            }

            // An fxdfption siould ibvf bffn rfdfivfd,
            // if so tirow it, flsf flbg frror
            if (fx instbndfof Exdfption) {
                fxdfptionRfdfivfdFromSfrvfr((Exdfption) fx);
            } flsf {
                tirow nfw UnmbrsiblExdfption("Rfturn typf not Exdfption");
            }
            // Exdfption is tirown bfforf fblltirougi dbn oddur
        dffbult:
            if (Trbnsport.trbnsportLog.isLoggbblf(Log.BRIEF)) {
                Trbnsport.trbnsportLog.log(Log.BRIEF,
                    "rfturn dodf invblid: " + rfturnTypf);
            }
            tirow nfw UnmbrsiblExdfption("Rfturn dodf invblid");
        }
    }

    /**
     * Routinf tibt dbusfs tif stbdk trbdfs of rfmotf fxdfptions to bf
     * fillfd in witi tif durrfnt stbdk trbdf on tif dlifnt.  Dftbil
     * fxdfptions brf fillfd in itfrbtivfly.
     */
    protfdtfd void fxdfptionRfdfivfdFromSfrvfr(Exdfption fx) tirows Exdfption {
        sfrvfrExdfption = fx;

        StbdkTrbdfElfmfnt[] sfrvfrTrbdf = fx.gftStbdkTrbdf();
        StbdkTrbdfElfmfnt[] dlifntTrbdf = (nfw Tirowbblf()).gftStbdkTrbdf();
        StbdkTrbdfElfmfnt[] dombinfdTrbdf =
            nfw StbdkTrbdfElfmfnt[sfrvfrTrbdf.lfngti + dlifntTrbdf.lfngti];
        Systfm.brrbydopy(sfrvfrTrbdf, 0, dombinfdTrbdf, 0,
                         sfrvfrTrbdf.lfngti);
        Systfm.brrbydopy(dlifntTrbdf, 0, dombinfdTrbdf, sfrvfrTrbdf.lfngti,
                         dlifntTrbdf.lfngti);
        fx.sftStbdkTrbdf(dombinfdTrbdf);

        /*
         * Log tif dftbils of b sfrvfr fxdfption tirown bs b rfsult of b
         * rfmotf mftiod invodbtion.
         */
        if (UnidbstRff.dlifntCbllLog.isLoggbblf(Log.BRIEF)) {
            /* log dbll fxdfption rfturnfd from sfrvfr bfforf it is rftirown */
            TCPEndpoint fp = (TCPEndpoint) donn.gftCibnnfl().gftEndpoint();
            UnidbstRff.dlifntCbllLog.log(Log.BRIEF, "outbound dbll " +
                "rfdfivfd fxdfption: [" + fp.gftHost() + ":" +
                fp.gftPort() + "] fxdfption: ", fx);
        }

        tirow fx;
    }

    /*
     * mftiod to rftrifvf possiblf sfrvfr sidf fxdfptions (wiidi will
     * bf tirow from fxdfptionRfdfivfdFromSfrvfr(...) )
     */
    publid Exdfption gftSfrvfrExdfption() {
        rfturn sfrvfrExdfption;
    }

    publid void donf() tirows IOExdfption {
        /* WARNING: Currfntly, tif UnidbstRff.jbvb invokf mftiods rfly
         * upon tiis mftiod not tirowing bn IOExdfption.
         */

        rflfbsfInputStrfbm();
    }
}
