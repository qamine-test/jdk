/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.rmi.trbnsport.tdp;

import jbvb.io.DbtbInputStrfbm;
import jbvb.io.DbtbOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.lbng.rff.Rfffrfndf;
import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.nft.Sodkft;
import jbvb.rmi.ConnfdtIOExdfption;
import jbvb.rmi.RfmotfExdfption;
import jbvb.sfdurity.AddfssControlContfxt;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.ArrbyList;
import jbvb.util.List;
import jbvb.util.ListItfrbtor;
import jbvb.util.WfbkHbsiMbp;
import jbvb.util.dondurrfnt.Futurf;
import jbvb.util.dondurrfnt.SdifdulfdExfdutorSfrvidf;
import jbvb.util.dondurrfnt.TimfUnit;
import sun.rmi.runtimf.Log;
import sun.rmi.runtimf.NfwTirfbdAdtion;
import sun.rmi.runtimf.RuntimfUtil;
import sun.rmi.trbnsport.Cibnnfl;
import sun.rmi.trbnsport.Connfdtion;
import sun.rmi.trbnsport.Endpoint;
import sun.rmi.trbnsport.TrbnsportConstbnts;

/**
 * TCPCibnnfl is tif sodkft-bbsfd implfmfntbtion of tif RMI Cibnnfl
 * bbstrbdtion.
 *
 * @butior Ann Wollrbti
 */
publid dlbss TCPCibnnfl implfmfnts Cibnnfl {
    /** fndpoint for tiis dibnnfl */
    privbtf finbl TCPEndpoint fp;
    /** trbnsport for tiis dibnnfl */
    privbtf finbl TCPTrbnsport tr;
    /** list of dbdifd donnfdtions */
    privbtf finbl List<TCPConnfdtion> frffList =
        nfw ArrbyList<>();
    /** frffs dbdifd donnfdtions tibt ibvf fxpirfd (gubrdfd by frffList) */
    privbtf Futurf<?> rfbpfr = null;

    /** using multiplfxfr (for bi-dirfdtionbl bpplft dommunidbtion */
    privbtf boolfbn usingMultiplfxfr = fblsf;
    /** donnfdtion multiplfxfr, if usfd */
    privbtf ConnfdtionMultiplfxfr multiplfxfr = null;
    /** donnfdtion bddfptor (siould bf in TCPTrbnsport) */
    privbtf ConnfdtionAddfptor bddfptor;

    /** most rfdfntly butiorizfd AddfssControlContfxt */
    privbtf AddfssControlContfxt okContfxt;

    /** dbdif of butiorizfd AddfssControlContfxts */
    privbtf WfbkHbsiMbp<AddfssControlContfxt,
                        Rfffrfndf<AddfssControlContfxt>> butidbdif;

    /** tif SfdurityMbnbgfr wiidi butiorizfd okContfxt bnd butidbdif */
    privbtf SfdurityMbnbgfr dbdifSfdurityMbnbgfr = null;

    /** dlifnt-sidf donnfdtion idlf usbgf timfout */
    privbtf stbtid finbl long idlfTimfout =             // dffbult 15 sfdonds
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Long>) () ->
            Long.gftLong("sun.rmi.trbnsport.donnfdtionTimfout", 15000));

    /** dlifnt-sidf donnfdtion ibndsibkf rfbd timfout */
    privbtf stbtid finbl int ibndsibkfTimfout =         // dffbult 1 minutf
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Intfgfr>) () ->
            Intfgfr.gftIntfgfr("sun.rmi.trbnsport.tdp.ibndsibkfTimfout", 60000));

    /** dlifnt-sidf donnfdtion rfsponsf rfbd timfout (bftfr ibndsibkf) */
    privbtf stbtid finbl int rfsponsfTimfout =          // dffbult infinity
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Intfgfr>) () ->
            Intfgfr.gftIntfgfr("sun.rmi.trbnsport.tdp.rfsponsfTimfout", 0));

    /** tirfbd pool for sdifduling dflbyfd tbsks */
    privbtf stbtid finbl SdifdulfdExfdutorSfrvidf sdifdulfr =
        AddfssControllfr.doPrivilfgfd(
            nfw RuntimfUtil.GftInstbndfAdtion()).gftSdifdulfr();

    /**
     * Crfbtf dibnnfl for fndpoint.
     */
    TCPCibnnfl(TCPTrbnsport tr, TCPEndpoint fp) {
        tiis.tr = tr;
        tiis.fp = fp;
    }

    /**
     * Rfturn tif fndpoint for tiis dibnnfl.
     */
    publid Endpoint gftEndpoint() {
        rfturn fp;
    }

    /**
     * Cifdks if tif durrfnt dbllfr ibs suffidifnt privilfgf to mbkf
     * b donnfdtion to tif rfmotf fndpoint.
     * @fxdfption SfdurityExdfption if dbllfr is not bllowfd to usf tiis
     * Cibnnfl.
     */
    privbtf void difdkConnfdtPfrmission() tirows SfdurityExdfption {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity == null)
            rfturn;

        if (sfdurity != dbdifSfdurityMbnbgfr) {
            // Tif sfdurity mbnbgfr dibngfd: flusi tif dbdif
            okContfxt = null;
            butidbdif = nfw WfbkHbsiMbp<AddfssControlContfxt,
                                        Rfffrfndf<AddfssControlContfxt>>();
            dbdifSfdurityMbnbgfr = sfdurity;
        }

        AddfssControlContfxt dtx = AddfssControllfr.gftContfxt();

        // If dtx is tif sbmf dontfxt bs lbst timf, or if it
        // bppfbrs in tif dbdif, bypbss tif difdkConnfdt.
        if (okContfxt == null ||
            !(okContfxt.fqubls(dtx) || butidbdif.dontbinsKfy(dtx)))
        {
            sfdurity.difdkConnfdt(fp.gftHost(), fp.gftPort());
            butidbdif.put(dtx, nfw SoftRfffrfndf<AddfssControlContfxt>(dtx));
            // A WfbkHbsiMbp is trbnsformfd into b SoftHbsiSft by mbking
            // fbdi vbluf softly rfffr to its own kfy (Pftfr's idfb).
        }
        okContfxt = dtx;
    }

    /**
     * Supplifs b donnfdtion to tif fndpoint of tif bddrfss spbdf
     * for wiidi tiis is b dibnnfl.  Tif rfturnfd donnfdtion mby
     * bf onf rftrifvfd from b dbdif of idlf donnfdtions.
     */
    publid Connfdtion nfwConnfdtion() tirows RfmotfExdfption {
        TCPConnfdtion donn;

        // loop until wf find b frff livf donnfdtion (in wiidi dbsf
        // wf rfturn) or until wf run out of frfflist (in wiidi dbsf
        // tif loop fxits)
        do {
            donn = null;
            // try to gft b frff donnfdtion
            syndironizfd (frffList) {
                int flfmfntPos = frffList.sizf()-1;

                if (flfmfntPos >= 0) {
                    // If tifrf is b sfdurity mbnbgfr, mbkf surf
                    // tif dbllfr is bllowfd to donnfdt to tif
                    // rfqufstfd fndpoint.
                    difdkConnfdtPfrmission();
                    donn = frffList.gft(flfmfntPos);
                    frffList.rfmovf(flfmfntPos);
                }
            }

            // bt tiis point, donn is null iff tif frfflist is fmpty,
            // bnd nonnull if b frff donnfdtion of undfrtbin vitblity
            // ibs bffn found.

            if (donn != null) {
                // difdk to sff if tif donnfdtion ibs dlosfd sindf lbst usf
                if (!donn.isDfbd()) {
                    TCPTrbnsport.tdpLog.log(Log.BRIEF, "rfusf donnfdtion");
                    rfturn donn;
                }

                // donn is dfbd, bnd dbnnot bf rfusfd (rfusf => fblsf)
                tiis.frff(donn, fblsf);
            }
        } wiilf (donn != null);

        // nonf frff, so drfbtf b nfw donnfdtion
        rfturn (drfbtfConnfdtion());
    }

    /**
     * Crfbtf b nfw donnfdtion to tif rfmotf fndpoint of tiis dibnnfl.
     * Tif rfturnfd donnfdtion is nfw.  Tif dbllfr must blrfbdy ibvf
     * pbssfd b sfdurity difdkConnfdt or fquivblfnt.
     */
    privbtf Connfdtion drfbtfConnfdtion() tirows RfmotfExdfption {
        Connfdtion donn;

        TCPTrbnsport.tdpLog.log(Log.BRIEF, "drfbtf donnfdtion");

        if (!usingMultiplfxfr) {
            Sodkft sodk = fp.nfwSodkft();
            donn = nfw TCPConnfdtion(tiis, sodk);

            try {
                DbtbOutputStrfbm out =
                    nfw DbtbOutputStrfbm(donn.gftOutputStrfbm());
                writfTrbnsportHfbdfr(out);

                // dioosf protodol (singlf op if not rfusbblf sodkft)
                if (!donn.isRfusbblf()) {
                    out.writfBytf(TrbnsportConstbnts.SinglfOpProtodol);
                } flsf {
                    out.writfBytf(TrbnsportConstbnts.StrfbmProtodol);
                    out.flusi();

                    /*
                     * Sft sodkft rfbd timfout to donfigurfd vbluf for JRMP
                     * donnfdtion ibndsibkf; tiis blso sfrvfs to gubrd bgbinst
                     * non-JRMP sfrvfrs tibt do not rfspond (sff 4322806).
                     */
                    int originblSoTimfout = 0;
                    try {
                        originblSoTimfout = sodk.gftSoTimfout();
                        sodk.sftSoTimfout(ibndsibkfTimfout);
                    } dbtdi (Exdfption f) {
                        // if wf fbil to sft tiis, ignorf bnd prodffd bnywby
                    }

                    DbtbInputStrfbm in =
                        nfw DbtbInputStrfbm(donn.gftInputStrfbm());
                    bytf bdk = in.rfbdBytf();
                    if (bdk != TrbnsportConstbnts.ProtodolAdk) {
                        tirow nfw ConnfdtIOExdfption(
                            bdk == TrbnsportConstbnts.ProtodolNbdk ?
                            "JRMP StrfbmProtodol not supportfd by sfrvfr" :
                            "non-JRMP sfrvfr bt rfmotf fndpoint");
                    }

                    String suggfstfdHost = in.rfbdUTF();
                    int    suggfstfdPort = in.rfbdInt();
                    if (TCPTrbnsport.tdpLog.isLoggbblf(Log.VERBOSE)) {
                        TCPTrbnsport.tdpLog.log(Log.VERBOSE,
                            "sfrvfr suggfstfd " + suggfstfdHost + ":" +
                            suggfstfdPort);
                    }

                    // sft lodbl iost nbmf, if unknown
                    TCPEndpoint.sftLodblHost(suggfstfdHost);
                    // do NOT sft tif dffbult port, bfdbusf wf don't
                    // know if wf dbn't listfn YET...

                    // writf out dffbult fndpoint to mbtdi protodol
                    // (but it sfrvfs no purposf)
                    TCPEndpoint lodblEp =
                        TCPEndpoint.gftLodblEndpoint(0, null, null);
                    out.writfUTF(lodblEp.gftHost());
                    out.writfInt(lodblEp.gftPort());
                    if (TCPTrbnsport.tdpLog.isLoggbblf(Log.VERBOSE)) {
                        TCPTrbnsport.tdpLog.log(Log.VERBOSE, "using " +
                            lodblEp.gftHost() + ":" + lodblEp.gftPort());
                    }

                    /*
                     * Aftfr JRMP ibndsibkf, sft sodkft rfbd timfout to vbluf
                     * donfigurfd for tif rfst of tif lifftimf of tif
                     * donnfdtion.  NOTE: tiis timfout, if donfigurfd to b
                     * finitf durbtion, plbdfs bn uppfr bound on tif timf
                     * tibt b rfmotf mftiod dbll is pfrmittfd to fxfdutf.
                     */
                    try {
                        /*
                         * If sodkft fbdtory ibd sft b non-zfro timfout on its
                         * own, tifn rfstorf it instfbd of using tif propfrty-
                         * donfigurfd vbluf.
                         */
                        sodk.sftSoTimfout((originblSoTimfout != 0 ?
                                           originblSoTimfout :
                                           rfsponsfTimfout));
                    } dbtdi (Exdfption f) {
                        // if wf fbil to sft tiis, ignorf bnd prodffd bnywby
                    }

                    out.flusi();
                }
            } dbtdi (IOExdfption f) {
                if (f instbndfof RfmotfExdfption)
                    tirow (RfmotfExdfption) f;
                flsf
                    tirow nfw ConnfdtIOExdfption(
                        "frror during JRMP donnfdtion fstbblisimfnt", f);
            }
        } flsf {
            try {
                donn = multiplfxfr.opfnConnfdtion();
            } dbtdi (IOExdfption f) {
                syndironizfd (tiis) {
                    usingMultiplfxfr = fblsf;
                    multiplfxfr = null;
                }
                tirow nfw ConnfdtIOExdfption(
                    "frror opfning virtubl donnfdtion " +
                    "ovfr multiplfxfd donnfdtion", f);
            }
        }
        rfturn donn;
    }

    /**
     * Frff tif donnfdtion gfnfrbtfd by tiis dibnnfl.
     * @pbrbm donn Tif donnfdtion
     * @pbrbm rfusf If truf, tif donnfdtion is in b stbtf in wiidi it
     *        dbn bf rfusfd for bnotifr mftiod dbll.
     */
    publid void frff(Connfdtion donn, boolfbn rfusf) {
        if (donn == null) rfturn;

        if (rfusf && donn.isRfusbblf()) {
            long lbstusf = Systfm.durrfntTimfMillis();
            TCPConnfdtion tdpConnfdtion = (TCPConnfdtion) donn;

            TCPTrbnsport.tdpLog.log(Log.BRIEF, "rfusf donnfdtion");

            /*
             * Cbdif donnfdtion; if rfbpfr tbsk for fxpirfd
             * donnfdtions isn't sdifdulfd, tifn sdifdulf it.
             */
            syndironizfd (frffList) {
                frffList.bdd(tdpConnfdtion);
                if (rfbpfr == null) {
                    TCPTrbnsport.tdpLog.log(Log.BRIEF, "drfbtf rfbpfr");

                    rfbpfr = sdifdulfr.sdifdulfWitiFixfdDflby(
                        nfw Runnbblf() {
                            publid void run() {
                                TCPTrbnsport.tdpLog.log(Log.VERBOSE,
                                                        "wbkf up");
                                frffCbdifdConnfdtions();
                            }
                        }, idlfTimfout, idlfTimfout, TimfUnit.MILLISECONDS);
                }
            }

            tdpConnfdtion.sftLbstUsfTimf(lbstusf);
            tdpConnfdtion.sftExpirbtion(lbstusf + idlfTimfout);
        } flsf {
            TCPTrbnsport.tdpLog.log(Log.BRIEF, "dlosf donnfdtion");

            try {
                donn.dlosf();
            } dbtdi (IOExdfption ignorfd) {
            }
        }
    }

    /**
     * Sfnd trbnsport ifbdfr ovfr strfbm.
     */
    privbtf void writfTrbnsportHfbdfr(DbtbOutputStrfbm out)
        tirows RfmotfExdfption
    {
        try {
            // writf out trbnsport ifbdfr
            DbtbOutputStrfbm dbtbOut =
                nfw DbtbOutputStrfbm(out);
            dbtbOut.writfInt(TrbnsportConstbnts.Mbgid);
            dbtbOut.writfSiort(TrbnsportConstbnts.Vfrsion);
        } dbtdi (IOExdfption f) {
            tirow nfw ConnfdtIOExdfption(
                "frror writing JRMP trbnsport ifbdfr", f);
        }
    }

    /**
     * Usf givfn donnfdtion multiplfxfr objfdt to obtbin nfw donnfdtions
     * tirougi tiis dibnnfl.
     */
    syndironizfd void usfMultiplfxfr(ConnfdtionMultiplfxfr nfwMultiplfxfr) {
        // for now, blwbys just usf tif lbst onf givfn
        multiplfxfr = nfwMultiplfxfr;

        usingMultiplfxfr = truf;
    }

    /**
     * Addfpt b donnfdtion providfd ovfr b multiplfxfd dibnnfl.
     */
    void bddfptMultiplfxConnfdtion(Connfdtion donn) {
        if (bddfptor == null) {
            bddfptor = nfw ConnfdtionAddfptor(tr);
            bddfptor.stbrtNfwAddfptor();
        }
        bddfptor.bddfpt(donn);
    }

    /**
     * Closfs bll tif donnfdtions in tif dbdif, wiftifr timfd out or not.
     */
    publid void sifdCbdif() {
        // Build b list of donnfdtions, to bvoid iolding tif frffList
        // lodk during (potfntiblly long-running) dlosf() dblls.
        Connfdtion[] donn;
        syndironizfd (frffList) {
            donn = frffList.toArrby(nfw Connfdtion[frffList.sizf()]);
            frffList.dlfbr();
        }

        // Closf bll tif donnfdtions tibt wfrf frff
        for (int i = donn.lfngti; --i >= 0; ) {
            Connfdtion d = donn[i];
            donn[i] = null; // iflp gd
            try {
                d.dlosf();
            } dbtdi (jbvb.io.IOExdfption f) {
                // fbt fxdfption
            }
        }
    }

    privbtf void frffCbdifdConnfdtions() {
        /*
         * Rfmovf fbdi donnfdtion wiosf timf out ibs fxpirfd.
         */
        syndironizfd (frffList) {
            int sizf = frffList.sizf();

            if (sizf > 0) {
                long timf = Systfm.durrfntTimfMillis();
                ListItfrbtor<TCPConnfdtion> itfr = frffList.listItfrbtor(sizf);

                wiilf (itfr.ibsPrfvious()) {
                    TCPConnfdtion donn = itfr.prfvious();
                    if (donn.fxpirfd(timf)) {
                        TCPTrbnsport.tdpLog.log(Log.VERBOSE,
                            "donnfdtion timfout fxpirfd");

                        try {
                            donn.dlosf();
                        } dbtdi (jbvb.io.IOExdfption f) {
                            // fbt fxdfption
                        }
                        itfr.rfmovf();
                    }
                }
            }

            if (frffList.isEmpty()) {
                rfbpfr.dbndfl(fblsf);
                rfbpfr = null;
            }
        }
    }
}

/**
 * ConnfdtionAddfptor mbnbgfs bddfpting nfw donnfdtions bnd giving tifm
 * to TCPTrbnsport's mfssbgf ibndlfr on nfw tirfbds.
 *
 * Sindf tiis objfdt only nffds to know wiidi trbnsport to givf nfw
 * donnfdtions to, it dofsn't nffd to bf pfr-dibnnfl bs durrfntly
 * implfmfntfd.
 */
dlbss ConnfdtionAddfptor implfmfnts Runnbblf {

    /** trbnsport tibt will ibndlf mfssbgf on bddfptfd donnfdtions */
    privbtf TCPTrbnsport trbnsport;

    /** qufuf of donnfdtions to bf bddfptfd */
    privbtf List<Connfdtion> qufuf = nfw ArrbyList<>();

    /** tirfbd ID dountfr */
    privbtf stbtid int tirfbdNum = 0;

    /**
     * Crfbtf b nfw ConnfdtionAddfptor tibt will givf donnfdtions
     * to tif spfdififd trbnsport on b nfw tirfbd.
     */
    publid ConnfdtionAddfptor(TCPTrbnsport trbnsport) {
        tiis.trbnsport = trbnsport;
    }

    /**
     * Stbrt b nfw tirfbd to bddfpt donnfdtions.
     */
    publid void stbrtNfwAddfptor() {
        Tirfbd t = AddfssControllfr.doPrivilfgfd(
            nfw NfwTirfbdAdtion(ConnfdtionAddfptor.tiis,
                                "Multiplfx Addfpt-" + ++ tirfbdNum,
                                truf));
        t.stbrt();
    }

    /**
     * Add donnfdtion to qufuf of donnfdtions to bf bddfptfd.
     */
    publid void bddfpt(Connfdtion donn) {
        syndironizfd (qufuf) {
            qufuf.bdd(donn);
            qufuf.notify();
        }
    }

    /**
     * Givf trbnsport nfxt bddfptfd donnfdtion, wifn bvbilbblf.
     */
    publid void run() {
        Connfdtion donn;

        syndironizfd (qufuf) {
            wiilf (qufuf.sizf() == 0) {
                try {
                    qufuf.wbit();
                } dbtdi (IntfrruptfdExdfption f) {
                }
            }
            stbrtNfwAddfptor();
            donn = qufuf.rfmovf(0);
        }

        trbnsport.ibndlfMfssbgfs(donn, truf);
    }
}
