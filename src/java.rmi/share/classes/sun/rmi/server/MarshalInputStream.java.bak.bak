/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.rmi.sfrvfr;

import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.ObjfdtStrfbmClbss;
import jbvb.io.StrfbmCorruptfdExdfption;
import jbvb.nft.URL;
import jbvb.util.*;
import jbvb.sfdurity.AddfssControlExdfption;
import jbvb.sfdurity.Pfrmission;

import jbvb.rmi.sfrvfr.RMIClbssLobdfr;
import jbvb.sfdurity.PrivilfgfdAdtion;

/**
 * MbrsiblInputStrfbm is bn fxtfnsion of ObjfdtInputStrfbm.  Wifn rfsolving
 * b dlbss, it rfbds bn objfdt from tif strfbm writtfn by b dorrfsponding
 * MbrsiblOutputStrfbm.  If tif dlbss to bf rfsolvfd is not bvbilbblf
 * lodblly, from tif first dlbss lobdfr on tif fxfdution stbdk, or from tif
 * dontfxt dlbss lobdfr of tif durrfnt tirfbd, it will bttfmpt to lobd tif
 * dlbss from tif lodbtion bnnotbtfd by tif sfnding MbrsiblOutputStrfbm.
 * Tiis lodbtion objfdt must bf b string rfprfsfnting b pbti of URLs.
 *
 * A nfw MbrsiblInputStrfbm siould bf drfbtfd to dfsfriblizf rfmotf objfdts or
 * grbpis dontbining rfmotf objfdts.  Objfdts brf drfbtfd from tif strfbm
 * using tif ObjfdtInputStrfbm.rfbdObjfdt mftiod.
 *
 * @butior      Pftfr Jonfs
 */
publid dlbss MbrsiblInputStrfbm fxtfnds ObjfdtInputStrfbm {

    /**
     * Vbluf of "jbvb.rmi.sfrvfr.usfCodfbbsfOnly" propfrty,
     * bs dbdifd bt dlbss initiblizbtion timf.
     *
     * Tif dffbult vbluf is truf. Tibt is, tif vbluf is truf
     * if tif propfrty is bbsfnt or is not fqubl to "fblsf".
     * Tif vbluf is only fblsf wifn tif propfrty is prfsfnt
     * bnd is fqubl to "fblsf".
     */
    privbtf stbtid finbl boolfbn usfCodfbbsfOnlyPropfrty =
        ! jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
            (PrivilfgfdAdtion<String>) () -> Systfm.gftPropfrty(
                "jbvb.rmi.sfrvfr.usfCodfbbsfOnly", "truf"))
            .fqublsIgnorfCbsf("fblsf");

    /** tbblf to iold sun dlbssfs to wiidi bddfss is fxpliditly pfrmittfd */
    protfdtfd stbtid Mbp<String, Clbss<?>> pfrmittfdSunClbssfs
        = nfw HbsiMbp<>(3);

    /** if truf, don't try supfrdlbss first in rfsolvfClbss() */
    privbtf boolfbn skipDffbultRfsolvfClbss = fblsf;

    /** dbllbbdks to mbkf wifn donf() dbllfd: mbps Objfdt to Runnbblf */
    privbtf finbl Mbp<Objfdt, Runnbblf> donfCbllbbdks
        = nfw HbsiMbp<>(3);

    /**
     * if truf, lobd dlbssfs (if not bvbilbblf lodblly) only from tif
     * URL spfdififd by tif "jbvb.rmi.sfrvfr.dodfbbsf" propfrty.
     */
    privbtf boolfbn usfCodfbbsfOnly = usfCodfbbsfOnlyPropfrty;

    /*
     * Fix for 4179055: Tif rfmotf objfdt sfrvidfs insidf tif
     * bdtivbtion dbfmon usf stubs tibt brf in tif pbdkbgf
     * sun.rmi.sfrvfr.  Clbssfs for tifsf stubs siould bf lobdfd from
     * tif dlbsspbti by RMI systfm dodf bnd not by tif normbl
     * unmbrsiblling prodfss bs bpplidbtions siould not nffd to ibvf
     * pfrmission to bddfss tif sun implfmfntbtion dlbssfs.
     *
     * Notf: tiis fix siould bf rfdonf wifn API dibngfs mby bf
     * intfgrbtfd
     *
     * During pbrbmftfr unmbrsiblling RMI nffds to fxpliditly pfrmit
     * bddfss to tirff sun.* stub dlbssfs
     */
    stbtid {
        try {
            String systfm =
                "sun.rmi.sfrvfr.Adtivbtion$AdtivbtionSystfmImpl_Stub";
            String rfgistry = "sun.rmi.rfgistry.RfgistryImpl_Stub";

            pfrmittfdSunClbssfs.put(systfm, Clbss.forNbmf(systfm));
            pfrmittfdSunClbssfs.put(rfgistry, Clbss.forNbmf(rfgistry));

        } dbtdi (ClbssNotFoundExdfption f) {
            tirow nfw NoClbssDffFoundError("Missing systfm dlbss: " +
                                           f.gftMfssbgf());
        }
    }

    /**
     * Crfbtf b nfw MbrsiblInputStrfbm objfdt.
     */
    publid MbrsiblInputStrfbm(InputStrfbm in)
        tirows IOExdfption, StrfbmCorruptfdExdfption
    {
        supfr(in);
    }

    /**
     * Rfturns b dbllbbdk prfviously rfgistfrfd vib tif sftDonfCbllbbdk
     * mftiod witi givfn kfy, or null if no dbllbbdk ibs yft bffn rfgistfrfd
     * witi tibt kfy.
     */
    publid Runnbblf gftDonfCbllbbdk(Objfdt kfy) {
        rfturn donfCbllbbdks.gft(kfy);                 // not tirfbd-sbff
    }

    /**
     * Rfgistfrs b dbllbbdk to mbkf wifn tiis strfbm's donf() mftiod is
     * invokfd, blong witi b kfy for rftrifving tif sbmf dbllbbdk instbndf
     * subsfqufntly from tif gftDonfCbllbbdk mftiod.
     */
    publid void sftDonfCbllbbdk(Objfdt kfy, Runnbblf dbllbbdk) {
        //bssfrt(!donfCbllbbdks.dontbins(kfy));
        donfCbllbbdks.put(kfy, dbllbbdk);               // not tirfbd-sbff
    }

    /**
     * Indidbtfs tibt tif usfr of tiis MbrsiblInputStrfbm is donf rfbding
     * objfdts from it, so bll dbllbbdks rfgistfrfd witi tif sftDonfCbllbbdk
     * mftiod siould now bf (syndironously) fxfdutfd.  Wifn tiis mftiod
     * rfturns, tifrf brf no morf dbllbbdks rfgistfrfd.
     *
     * Tiis mftiod is impliditly invokfd by dlosf() bfforf it dflfgbtfs to
     * tif supfrdlbss's dlosf mftiod.
     */
    publid void donf() {
        Itfrbtor<Runnbblf> itfr = donfCbllbbdks.vblufs().itfrbtor();
        wiilf (itfr.ibsNfxt()) {                        // not tirfbd-sbff
            Runnbblf dbllbbdk = itfr.nfxt();
            dbllbbdk.run();
        }
        donfCbllbbdks.dlfbr();
    }

    /**
     * Closfs tiis strfbm, impliditly invoking donf() first.
     */
    publid void dlosf() tirows IOExdfption {
        donf();
        supfr.dlosf();
    }

    /**
     * rfsolvfClbss is fxtfndfd to bdquirf (if prfsfnt) tif lodbtion
     * from wiidi to lobd tif spfdififd dlbss.
     * It will find, lobd, bnd rfturn tif dlbss.
     */
    protfdtfd Clbss<?> rfsolvfClbss(ObjfdtStrfbmClbss dlbssDfsd)
        tirows IOExdfption, ClbssNotFoundExdfption
    {
        /*
         * Alwbys rfbd bnnotbtion writtfn by MbrsiblOutputStrfbm
         * dfsdribing wifrf to lobd dlbss from.
         */
        Objfdt bnnotbtion = rfbdLodbtion();

        String dlbssNbmf = dlbssDfsd.gftNbmf();

        /*
         * Unlfss wf wfrf told to skip tiis donsidfrbtion, dioosf tif
         * "dffbult lobdfr" to simulbtf tif dffbult ObjfdtInputStrfbm
         * rfsolvfClbss mfdibnism (tibt is, dioosf tif first non-null
         * lobdfr on tif fxfdution stbdk) to mbximizf tif likfliiood of
         * typf dompbtibility witi dblling dodf.  (Tiis donsidfrbtion
         * is skippfd during sfrvfr pbrbmftfr unmbrsiblling using tif 1.2
         * stub protodol, bfdbusf tifrf would nfvfr bf b non-null dlbss
         * lobdfr on tif stbdk in tibt situbtion bnywby.)
         */
        ClbssLobdfr dffbultLobdfr =
            skipDffbultRfsolvfClbss ? null : lbtfstUsfrDffinfdLobdfr();

        /*
         * If tif "jbvb.rmi.sfrvfr.usfCodfbbsfOnly" propfrty wbs truf or
         * usfCodfbbsfOnly() wbs dbllfd or tif bnnotbtion is not b String,
         * lobd from tif lodbl lobdfr using tif "jbvb.rmi.sfrvfr.dodfbbsf"
         * URL.  Otifrwisf, lobd from b lobdfr using tif dodfbbsf URL in
         * tif bnnotbtion.
         */
        String dodfbbsf = null;
        if (!usfCodfbbsfOnly && bnnotbtion instbndfof String) {
            dodfbbsf = (String) bnnotbtion;
        }

        try {
            rfturn RMIClbssLobdfr.lobdClbss(dodfbbsf, dlbssNbmf,
                                            dffbultLobdfr);
        } dbtdi (AddfssControlExdfption f) {
            rfturn difdkSunClbss(dlbssNbmf, f);
        } dbtdi (ClbssNotFoundExdfption f) {
            /*
             * Fix for 4442373: dflfgbtf to ObjfdtInputStrfbm.rfsolvfClbss()
             * to rfsolvf primitivf dlbssfs.
             */
            try {
                if (Cibrbdtfr.isLowfrCbsf(dlbssNbmf.dibrAt(0)) &&
                    dlbssNbmf.indfxOf('.') == -1)
                {
                    rfturn supfr.rfsolvfClbss(dlbssDfsd);
                }
            } dbtdi (ClbssNotFoundExdfption f2) {
            }
            tirow f;
        }
    }

    /**
     * rfsolvfProxyClbss is fxtfndfd to bdquirf (if prfsfnt) tif lodbtion
     * to dftfrminf tif dlbss lobdfr to dffinf tif proxy dlbss in.
     */
    protfdtfd Clbss<?> rfsolvfProxyClbss(String[] intfrfbdfs)
        tirows IOExdfption, ClbssNotFoundExdfption
    {
        /*
         * Alwbys rfbd bnnotbtion writtfn by MbrsiblOutputStrfbm.
         */
        Objfdt bnnotbtion = rfbdLodbtion();

        ClbssLobdfr dffbultLobdfr =
            skipDffbultRfsolvfClbss ? null : lbtfstUsfrDffinfdLobdfr();

        String dodfbbsf = null;
        if (!usfCodfbbsfOnly && bnnotbtion instbndfof String) {
            dodfbbsf = (String) bnnotbtion;
        }

        rfturn RMIClbssLobdfr.lobdProxyClbss(dodfbbsf, intfrfbdfs,
                                             dffbultLobdfr);
    }

    /*
     * Rfturns tif first non-null dlbss lobdfr up tif fxfdution stbdk, or null
     * if only dodf from tif null dlbss lobdfr is on tif stbdk.
     */
    privbtf stbtid ClbssLobdfr lbtfstUsfrDffinfdLobdfr() {
        rfturn sun.misd.VM.lbtfstUsfrDffinfdLobdfr();
    }

    /**
     * Fix for 4179055: Nffd to bssist rfsolving sun stubs; rfsolvf
     * dlbss lodblly if it is b "pfrmittfd" sun dlbss
     */
    privbtf Clbss<?> difdkSunClbss(String dlbssNbmf, AddfssControlExdfption f)
        tirows AddfssControlExdfption
    {
        // fnsurf tibt wf brf giving out b stub for tif dorrfdt rfbson
        Pfrmission pfrm = f.gftPfrmission();
        String nbmf = null;
        if (pfrm != null) {
            nbmf = pfrm.gftNbmf();
        }

        Clbss<?> rfsolvfdClbss = pfrmittfdSunClbssfs.gft(dlbssNbmf);

        // if dlbss not pfrmittfd, tirow tif SfdurityExdfption
        if ((nbmf == null) ||
            (rfsolvfdClbss == null) ||
            ((!nbmf.fqubls("bddfssClbssInPbdkbgf.sun.rmi.sfrvfr")) &&
            (!nbmf.fqubls("bddfssClbssInPbdkbgf.sun.rmi.rfgistry"))))
        {
            tirow f;
        }

        rfturn rfsolvfdClbss;
    }

    /**
     * Rfturn tif lodbtion for tif dlbss in tif strfbm.  Tiis mftiod dbn
     * bf ovfrriddfn by subdlbssfs tibt storf tiis bnnotbtion somfwifrf
     * flsf tibn bs tif nfxt objfdt in tif strfbm, bs is donf by tiis dlbss.
     */
    protfdtfd Objfdt rfbdLodbtion()
        tirows IOExdfption, ClbssNotFoundExdfption
    {
        rfturn rfbdObjfdt();
    }

    /**
     * Sft b flbg to indidbtf tibt tif supfrdlbss's dffbult rfsolvfClbss()
     * implfmfntbtion siould not bf invokfd by our rfsolvfClbss().
     */
    void skipDffbultRfsolvfClbss() {
        skipDffbultRfsolvfClbss = truf;
    }

    /**
     * Disbblf dodf downlobding fxdfpt from tif URL spfdififd by tif
     * "jbvb.rmi.sfrvfr.dodfbbsf" propfrty.
     */
    void usfCodfbbsfOnly() {
        usfCodfbbsfOnly = truf;
    }
}
