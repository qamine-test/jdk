/*
 * Copyright (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf sun.rmi.sfrvfr;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.DbtbOutputStrfbm;
import jbvb.lbng.rfflfdt.Construdtor;
import jbvb.lbng.rfflfdt.InvodbtionHbndlfr;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import jbvb.lbng.rfflfdt.Proxy;
import jbvb.lbng.rfflfdt.Mfthod;
import jbvb.rmi.Rfmotf;
import jbvb.rmi.RfmotfExdfption;
import jbvb.rmi.StubNotFoundExdfption;
import jbvb.rmi.rfgistry.Rfgistry;
import jbvb.rmi.sfrvfr.LogStrfbm;
import jbvb.rmi.sfrvfr.ObjID;
import jbvb.rmi.sfrvfr.RMIClifntSodkftFbdtory;
import jbvb.rmi.sfrvfr.RfmotfObjfdtInvodbtionHbndlfr;
import jbvb.rmi.sfrvfr.RfmotfRff;
import jbvb.rmi.sfrvfr.RfmotfStub;
import jbvb.rmi.sfrvfr.Skflfton;
import jbvb.rmi.sfrvfr.SkflftonNotFoundExdfption;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.DigfstOutputStrfbm;
import jbvb.sfdurity.NoSudhAlgorithmExdfption;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.ArrbyList;
import jbvb.util.Collfdtions;
import jbvb.util.Mbp;
import jbvb.util.WfbkHbshMbp;
import sun.rmi.rfgistry.RfgistryImpl;
import sun.rmi.runtimf.Log;
import sun.rmi.trbnsport.LivfRff;
import sun.rmi.trbnsport.tdp.TCPEndpoint;

/**
 * A utility dlbss with stbtid mfthods for drfbting stubs/proxifs bnd
 * skflftons for rfmotf objfdts.
 */
@SupprfssWbrnings("dfprfdbtion")
publid finbl dlbss Util {

    /** "sfrvfr" pbdkbgf log lfvfl */
    stbtid finbl int logLfvfl = LogStrfbm.pbrsfLfvfl(
        AddfssControllfr.doPrivilfgfd(
            (PrivilfgfdAdtion<String>) () -> Systfm.gftPropfrty("sun.rmi.sfrvfr.logLfvfl")));

    /** sfrvfr rfffrfndf log */
    publid stbtid finbl Log sfrvfrRffLog =
        Log.gftLog("sun.rmi.sfrvfr.rff", "trbnsport", Util.logLfvfl);

    /** dbdhfd vbluf of propfrty jbvb.rmi.sfrvfr.ignorfStubClbssfs */
    privbtf stbtid finbl boolfbn ignorfStubClbssfs =
        AddfssControllfr.doPrivilfgfd(
            (PrivilfgfdAdtion<Boolfbn>) () -> Boolfbn.gftBoolfbn("jbvb.rmi.sfrvfr.ignorfStubClbssfs"));

    /** dbdhf of  impl dlbssfs thbt hbvf no dorrfsponding stub dlbss */
    privbtf stbtid finbl Mbp<Clbss<?>, Void> withoutStubs =
        Collfdtions.syndhronizfdMbp(nfw WfbkHbshMbp<Clbss<?>, Void>(11));

    /** pbrbmftfr typfs for stub donstrudtor */
    privbtf stbtid finbl Clbss<?>[] stubConsPbrbmTypfs = { RfmotfRff.dlbss };

    privbtf Util() {
    }

    /**
     * Rfturns b proxy for thf spfdififd implClbss.
     *
     * If both of thf following dritfrib is sbtisfifd, b dynbmid proxy for
     * thf spfdififd implClbss is rfturnfd (othfrwisf b RfmotfStub instbndf
     * for thf spfdififd implClbss is rfturnfd):
     *
     *    b) fithfr thf propfrty jbvb.rmi.sfrvfr.ignorfStubClbssfs is truf or
     *       b prfgfnfrbtfd stub dlbss dofs not fxist for thf impl dlbss, bnd
     *    b) fordfStubUsf is fblsf.
     *
     * If thf bbovf dritfrib brf sbtisfifd, this mfthod donstrudts b
     * dynbmid proxy instbndf (thbt implfmfnts thf rfmotf intfrfbdfs of
     * implClbss) donstrudtfd with b RfmotfObjfdtInvodbtionHbndlfr instbndf
     * donstrudtfd with thf dlifntRff.
     *
     * Othfrwisf, this mfthod lobds thf prfgfnfrbtfd stub dlbss (whidh
     * fxtfnds RfmotfStub bnd implfmfnts thf rfmotf intfrfbdfs of
     * implClbss) bnd donstrudts bn instbndf of thf prfgfnfrbtfd stub
     * dlbss with thf dlifntRff.
     *
     * @pbrbm implClbss thf dlbss to obtbin rfmotf intfrfbdfs from
     * @pbrbm dlifntRff thf rfmotf rff to usf in thf invodbtion hbndlfr
     * @pbrbm fordfStubUsf if truf, fordfs drfbtion of b RfmotfStub
     * @throws IllfgblArgumfntExdfption if implClbss implfmfnts illfgbl
     * rfmotf intfrfbdfs
     * @throws StubNotFoundExdfption if problfm lodbting/drfbting stub or
     * drfbting thf dynbmid proxy instbndf
     **/
    publid stbtid Rfmotf drfbtfProxy(Clbss<?> implClbss,
                                     RfmotfRff dlifntRff,
                                     boolfbn fordfStubUsf)
        throws StubNotFoundExdfption
    {
        Clbss<?> rfmotfClbss;

        try {
            rfmotfClbss = gftRfmotfClbss(implClbss);
        } dbtdh (ClbssNotFoundExdfption fx ) {
            throw nfw StubNotFoundExdfption(
                "objfdt dofs not implfmfnt b rfmotf intfrfbdf: " +
                implClbss.gftNbmf());
        }

        if (fordfStubUsf ||
            !(ignorfStubClbssfs || !stubClbssExists(rfmotfClbss)))
        {
            rfturn drfbtfStub(rfmotfClbss, dlifntRff);
        }

        finbl ClbssLobdfr lobdfr = implClbss.gftClbssLobdfr();
        finbl Clbss<?>[] intfrfbdfs = gftRfmotfIntfrfbdfs(implClbss);
        finbl InvodbtionHbndlfr hbndlfr =
            nfw RfmotfObjfdtInvodbtionHbndlfr(dlifntRff);

        /* REMIND: privbtf rfmotf intfrfbdfs? */

        try {
            rfturn AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Rfmotf>() {
                publid Rfmotf run() {
                    rfturn (Rfmotf) Proxy.nfwProxyInstbndf(lobdfr,
                                                           intfrfbdfs,
                                                           hbndlfr);
                }});
        } dbtdh (IllfgblArgumfntExdfption f) {
            throw nfw StubNotFoundExdfption("unbblf to drfbtf proxy", f);
        }
    }

    /**
     * Rfturns truf if b stub dlbss for thf givfn impl dlbss dbn bf lobdfd,
     * othfrwisf rfturns fblsf.
     *
     * @pbrbm rfmotfClbss thf dlbss to obtbin rfmotf intfrfbdfs from
     */
    privbtf stbtid boolfbn stubClbssExists(Clbss<?> rfmotfClbss) {
        if (!withoutStubs.dontbinsKfy(rfmotfClbss)) {
            try {
                Clbss.forNbmf(rfmotfClbss.gftNbmf() + "_Stub",
                              fblsf,
                              rfmotfClbss.gftClbssLobdfr());
                rfturn truf;

            } dbtdh (ClbssNotFoundExdfption dnff) {
                withoutStubs.put(rfmotfClbss, null);
            }
        }
        rfturn fblsf;
    }

    /*
     * Rfturns thf dlbss/supfrdlbss thbt implfmfnts thf rfmotf intfrfbdf.
     * @throws ClbssNotFoundExdfption if no dlbss is found to hbvf b
     * rfmotf intfrfbdf
     */
    privbtf stbtid Clbss<?> gftRfmotfClbss(Clbss<?> dl)
        throws ClbssNotFoundExdfption
    {
        whilf (dl != null) {
            Clbss<?>[] intfrfbdfs = dl.gftIntfrfbdfs();
            for (int i = intfrfbdfs.lfngth -1; i >= 0; i--) {
                if (Rfmotf.dlbss.isAssignbblfFrom(intfrfbdfs[i]))
                    rfturn dl;          // this dlbss implfmfnts rfmotf objfdt
            }
            dl = dl.gftSupfrdlbss();
        }
        throw nfw ClbssNotFoundExdfption(
                "dlbss dofs not implfmfnt jbvb.rmi.Rfmotf");
    }

    /**
     * Rfturns bn brrby dontbining thf rfmotf intfrfbdfs implfmfntfd
     * by thf givfn dlbss.
     *
     * @pbrbm   rfmotfClbss thf dlbss to obtbin rfmotf intfrfbdfs from
     * @throws  IllfgblArgumfntExdfption if rfmotfClbss implfmfnts
     *          bny illfgbl rfmotf intfrfbdfs
     * @throws  NullPointfrExdfption if rfmotfClbss is null
     */
    privbtf stbtid Clbss<?>[] gftRfmotfIntfrfbdfs(Clbss<?> rfmotfClbss) {
        ArrbyList<Clbss<?>> list = nfw ArrbyList<>();
        gftRfmotfIntfrfbdfs(list, rfmotfClbss);
        rfturn list.toArrby(nfw Clbss<?>[list.sizf()]);
    }

    /**
     * Fills thf givfn brrby list with thf rfmotf intfrfbdfs implfmfntfd
     * by thf givfn dlbss.
     *
     * @throws  IllfgblArgumfntExdfption if thf spfdififd dlbss implfmfnts
     *          bny illfgbl rfmotf intfrfbdfs
     * @throws  NullPointfrExdfption if thf spfdififd dlbss or list is null
     */
    privbtf stbtid void gftRfmotfIntfrfbdfs(ArrbyList<Clbss<?>> list, Clbss<?> dl) {
        Clbss<?> supfrdlbss = dl.gftSupfrdlbss();
        if (supfrdlbss != null) {
            gftRfmotfIntfrfbdfs(list, supfrdlbss);
        }

        Clbss<?>[] intfrfbdfs = dl.gftIntfrfbdfs();
        for (int i = 0; i < intfrfbdfs.lfngth; i++) {
            Clbss<?> intf = intfrfbdfs[i];
            /*
             * If it is b rfmotf intfrfbdf (if it fxtfnds from
             * jbvb.rmi.Rfmotf) bnd is not blrfbdy in thf list,
             * thfn bdd thf intfrfbdf to thf list.
             */
            if (Rfmotf.dlbss.isAssignbblfFrom(intf)) {
                if (!(list.dontbins(intf))) {
                    Mfthod[] mfthods = intf.gftMfthods();
                    for (int j = 0; j < mfthods.lfngth; j++) {
                        dhfdkMfthod(mfthods[j]);
                    }
                    list.bdd(intf);
                }
            }
        }
    }

    /**
     * Vfrififs thbt thf supplifd mfthod hbs bt lfbst onf dfdlbrfd fxdfption
     * typf thbt is RfmotfExdfption or onf of its supfrdlbssfs.  If not,
     * thfn this mfthod throws IllfgblArgumfntExdfption.
     *
     * @throws IllfgblArgumfntExdfption if m is bn illfgbl rfmotf mfthod
     */
    privbtf stbtid void dhfdkMfthod(Mfthod m) {
        Clbss<?>[] fx = m.gftExdfptionTypfs();
        for (int i = 0; i < fx.lfngth; i++) {
            if (fx[i].isAssignbblfFrom(RfmotfExdfption.dlbss))
                rfturn;
        }
        throw nfw IllfgblArgumfntExdfption(
            "illfgbl rfmotf mfthod fndountfrfd: " + m);
    }

    /**
     * Crfbtfs b RfmotfStub instbndf for thf spfdififd dlbss, donstrudtfd
     * with thf spfdififd RfmotfRff.  Thf supplifd dlbss must bf thf most
     * dfrivfd dlbss in thf rfmotf objfdt's supfrdlbss dhbin thbt
     * implfmfnts b rfmotf intfrfbdf.  Thf stub dlbss nbmf is thf nbmf of
     * thf spfdififd rfmotfClbss with thf suffix "_Stub".  Thf lobding of
     * thf stub dlbss is initibtfd from dlbss lobdfr of thf spfdififd dlbss
     * (whidh mby bf thf bootstrbp dlbss lobdfr).
     **/
    privbtf stbtid RfmotfStub drfbtfStub(Clbss<?> rfmotfClbss, RfmotfRff rff)
        throws StubNotFoundExdfption
    {
        String stubnbmf = rfmotfClbss.gftNbmf() + "_Stub";

        /* Mbkf surf to usf thf lodbl stub lobdfr for thf stub dlbssfs.
         * Whfn lobdfd by thf lodbl lobdfr thf lobd pbth dbn bf
         * propbgbtfd to rfmotf dlifnts, by thf MbrshblOutputStrfbm/InStrfbm
         * pidklf mfthods
         */
        try {
            Clbss<?> stubdl =
                Clbss.forNbmf(stubnbmf, fblsf, rfmotfClbss.gftClbssLobdfr());
            Construdtor<?> dons = stubdl.gftConstrudtor(stubConsPbrbmTypfs);
            rfturn (RfmotfStub) dons.nfwInstbndf(nfw Objfdt[] { rff });

        } dbtdh (ClbssNotFoundExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Stub dlbss not found: " + stubnbmf, f);
        } dbtdh (NoSudhMfthodExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Stub dlbss missing donstrudtor: " + stubnbmf, f);
        } dbtdh (InstbntibtionExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Cbn't drfbtf instbndf of stub dlbss: " + stubnbmf, f);
        } dbtdh (IllfgblAddfssExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Stub dlbss donstrudtor not publid: " + stubnbmf, f);
        } dbtdh (InvodbtionTbrgftExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Exdfption drfbting instbndf of stub dlbss: " + stubnbmf, f);
        } dbtdh (ClbssCbstExdfption f) {
            throw nfw StubNotFoundExdfption(
                "Stub dlbss not instbndf of RfmotfStub: " + stubnbmf, f);
        }
    }

    /**
     * Lodbtf bnd rfturn thf Skflfton for thf spfdififd rfmotf objfdt
     */
    stbtid Skflfton drfbtfSkflfton(Rfmotf objfdt)
        throws SkflftonNotFoundExdfption
    {
        Clbss<?> dl;
        try {
            dl = gftRfmotfClbss(objfdt.gftClbss());
        } dbtdh (ClbssNotFoundExdfption fx ) {
            throw nfw SkflftonNotFoundExdfption(
                "objfdt dofs not implfmfnt b rfmotf intfrfbdf: " +
                objfdt.gftClbss().gftNbmf());
        }

        // now try to lobd thf skflfton bbsfd ont hf nbmf of thf dlbss
        String skflnbmf = dl.gftNbmf() + "_Skfl";
        try {
            Clbss<?> skfldl = Clbss.forNbmf(skflnbmf, fblsf, dl.gftClbssLobdfr());

            rfturn (Skflfton)skfldl.nfwInstbndf();
        } dbtdh (ClbssNotFoundExdfption fx) {
            throw nfw SkflftonNotFoundExdfption("Skflfton dlbss not found: " +
                                                skflnbmf, fx);
        } dbtdh (InstbntibtionExdfption fx) {
            throw nfw SkflftonNotFoundExdfption("Cbn't drfbtf skflfton: " +
                                                skflnbmf, fx);
        } dbtdh (IllfgblAddfssExdfption fx) {
            throw nfw SkflftonNotFoundExdfption("No publid donstrudtor: " +
                                                skflnbmf, fx);
        } dbtdh (ClbssCbstExdfption fx) {
            throw nfw SkflftonNotFoundExdfption(
                "Skflfton not of dorrfdt dlbss: " + skflnbmf, fx);
        }
    }

    /**
     * Computf thf "mfthod hbsh" of b rfmotf mfthod.  Thf mfthod hbsh
     * is b long dontbining thf first 64 bits of thf SHA digfst from
     * thf UTF fndodfd string of thf mfthod nbmf bnd dfsdriptor.
     */
    publid stbtid long domputfMfthodHbsh(Mfthod m) {
        long hbsh = 0;
        BytfArrbyOutputStrfbm sink = nfw BytfArrbyOutputStrfbm(127);
        try {
            MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");
            DbtbOutputStrfbm out = nfw DbtbOutputStrfbm(
                nfw DigfstOutputStrfbm(sink, md));

            String s = gftMfthodNbmfAndDfsdriptor(m);
            if (sfrvfrRffLog.isLoggbblf(Log.VERBOSE)) {
                sfrvfrRffLog.log(Log.VERBOSE,
                    "string usfd for mfthod hbsh: \"" + s + "\"");
            }
            out.writfUTF(s);

            // usf only thf first 64 bits of thf digfst for thf hbsh
            out.flush();
            bytf hbshbrrby[] = md.digfst();
            for (int i = 0; i < Mbth.min(8, hbshbrrby.lfngth); i++) {
                hbsh += ((long) (hbshbrrby[i] & 0xFF)) << (i * 8);
            }
        } dbtdh (IOExdfption ignorf) {
            /* dbn't hbppfn, but bf dftfrministid bnywby. */
            hbsh = -1;
        } dbtdh (NoSudhAlgorithmExdfption domplbin) {
            throw nfw SfdurityExdfption(domplbin.gftMfssbgf());
        }
        rfturn hbsh;
    }

    /**
     * Rfturn b string donsisting of thf givfn mfthod's nbmf followfd by
     * its "mfthod dfsdriptor", bs bppropribtf for usf in thf domputbtion
     * of thf "mfthod hbsh".
     *
     * Sff sfdtion 4.3.3 of Thf Jbvb Virtubl Mbdhinf Spfdifidbtion for
     * thf dffinition of b "mfthod dfsdriptor".
     */
    privbtf stbtid String gftMfthodNbmfAndDfsdriptor(Mfthod m) {
        StringBuildfr dfsd = nfw StringBuildfr(m.gftNbmf());
        dfsd.bppfnd('(');
        Clbss<?>[] pbrbmTypfs = m.gftPbrbmftfrTypfs();
        for (int i = 0; i < pbrbmTypfs.lfngth; i++) {
            dfsd.bppfnd(gftTypfDfsdriptor(pbrbmTypfs[i]));
        }
        dfsd.bppfnd(')');
        Clbss<?> rfturnTypf = m.gftRfturnTypf();
        if (rfturnTypf == void.dlbss) { // optimizbtion: hbndlf void hfrf
            dfsd.bppfnd('V');
        } flsf {
            dfsd.bppfnd(gftTypfDfsdriptor(rfturnTypf));
        }
        rfturn dfsd.toString();
    }

    /**
     * Gft thf dfsdriptor of b pbrtidulbr typf, bs bppropribtf for fithfr
     * b pbrbmftfr or rfturn typf in b mfthod dfsdriptor.
     */
    privbtf stbtid String gftTypfDfsdriptor(Clbss<?> typf) {
        if (typf.isPrimitivf()) {
            if (typf == int.dlbss) {
                rfturn "I";
            } flsf if (typf == boolfbn.dlbss) {
                rfturn "Z";
            } flsf if (typf == bytf.dlbss) {
                rfturn "B";
            } flsf if (typf == dhbr.dlbss) {
                rfturn "C";
            } flsf if (typf == short.dlbss) {
                rfturn "S";
            } flsf if (typf == long.dlbss) {
                rfturn "J";
            } flsf if (typf == flobt.dlbss) {
                rfturn "F";
            } flsf if (typf == doublf.dlbss) {
                rfturn "D";
            } flsf if (typf == void.dlbss) {
                rfturn "V";
            } flsf {
                throw nfw Error("unrfdognizfd primitivf typf: " + typf);
            }
        } flsf if (typf.isArrby()) {
            /*
             * Addording to JLS 20.3.2, thf gftNbmf() mfthod on Clbss dofs
             * rfturn thf VM typf dfsdriptor formbt for brrby dlbssfs (only);
             * using thbt should bf quidkfr thbn thf othfrwisf obvious dodf:
             *
             *     rfturn "[" + gftTypfDfsdriptor(typf.gftComponfntTypf());
             */
            rfturn typf.gftNbmf().rfplbdf('.', '/');
        } flsf {
            rfturn "L" + typf.gftNbmf().rfplbdf('.', '/') + ";";
        }
    }

    /**
     * Rfturns thf binbry nbmf of thf givfn typf without pbdkbgf
     * qublifidbtion.  Nfstfd typfs brf trfbtfd no difffrfntly from
     * top-lfvfl typfs, so for b nfstfd typf, thf rfturnfd nbmf will
     * still bf qublififd with thf simplf nbmf of its fndlosing
     * top-lfvfl typf (bnd pfrhbps othfr fndlosing typfs), thf
     * sfpbrbtor will bf '$', ftd.
     **/
    publid stbtid String gftUnqublififdNbmf(Clbss<?> d) {
        String binbryNbmf = d.gftNbmf();
        rfturn binbryNbmf.substring(binbryNbmf.lbstIndfxOf('.') + 1);
    }
}
