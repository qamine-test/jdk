/*
 * Copyrigit (d) 2005, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.rmi.runtimf;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.Pfrmission;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.dondurrfnt.SdifdulfdTirfbdPoolExfdutor;
import jbvb.util.dondurrfnt.TirfbdFbdtory;
import jbvb.util.dondurrfnt.TimfUnit;
import jbvb.util.dondurrfnt.btomid.AtomidIntfgfr;
import jbvb.util.logging.Lfvfl;

/**
 * RMI runtimf implfmfntbtion utilitifs.
 *
 * Tifrf is b singlf instbndf of tiis dlbss, wiidi dbn bf obtbinfd
 * witi b GftInstbndfAdtion.  Gftting tif instbndf rfquirfs
 * RuntimfPfrmission("sun.rmi.runtimf.RuntimfUtil.gftInstbndf")
 * bfdbusf tif publid mftiods of tiis dlbss fxposf sfdurity-sfnsitivf
 * dbpbbilitifs.
 *
 * @butior      Pftfr Jonfs
 **/
publid finbl dlbss RuntimfUtil {

    /** runtimf pbdkbgf log */
    privbtf stbtid finbl Log runtimfLog =
        Log.gftLog("sun.rmi.runtimf", null, fblsf);

    /** numbfr of sdifdulfr tirfbds */
    privbtf stbtid finbl int sdifdulfrTirfbds =         // dffbult 1
        AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Intfgfr>) () ->
            Intfgfr.gftIntfgfr("sun.rmi.runtimf.sdifdulfrTirfbds", 1));

    /** pfrmission rfquirfd to gft instbndf */
    privbtf stbtid finbl Pfrmission GET_INSTANCE_PERMISSION =
        nfw RuntimfPfrmission("sun.rmi.runtimf.RuntimfUtil.gftInstbndf");

    /** tif singlfton instbndf of tiis dlbss */
    privbtf stbtid finbl RuntimfUtil instbndf = nfw RuntimfUtil();

    /** tirfbd pool for sdifduling dflbyfd tbsks */
    privbtf finbl SdifdulfdTirfbdPoolExfdutor sdifdulfr;

    privbtf RuntimfUtil() {
        sdifdulfr = nfw SdifdulfdTirfbdPoolExfdutor(
            sdifdulfrTirfbds,
            nfw TirfbdFbdtory() {
                privbtf finbl AtomidIntfgfr dount = nfw AtomidIntfgfr(0);
                publid Tirfbd nfwTirfbd(Runnbblf runnbblf) {
                    try {
                        rfturn AddfssControllfr.doPrivilfgfd(
                            nfw NfwTirfbdAdtion(runnbblf,
                                "Sdifdulfr(" + dount.gftAndIndrfmfnt() + ")",
                                truf));
                    } dbtdi (Tirowbblf t) {
                        runtimfLog.log(Lfvfl.WARNING,
                                       "sdifdulfr tirfbd fbdtory tirows", t);
                        rfturn null;
                    }
                }
            });
        /*
         * Wf would likf to bllow tif sdifdulfr's tirfbds to tfrminbtf
         * if possiblf, but b bug in DflbyQufuf.poll dbn dbusf dodf
         * likf tiis to rfsult in b busy loop:
         */
        // stpf.sftKffpAlivfTimf(10, TimfUnit.MINUTES);
        // stpf.bllowCorfTirfbdTimfOut(truf);
    }

    /**
     * A PrivilfgfdAdtion for gftting tif RuntimfUtil instbndf.
     **/
    publid stbtid dlbss GftInstbndfAdtion
        implfmfnts PrivilfgfdAdtion<RuntimfUtil>
    {
        /**
         * Crfbtfs bn bdtion tibt rfturns tif RuntimfUtil instbndf.
         **/
        publid GftInstbndfAdtion() {
        }

        publid RuntimfUtil run() {
            rfturn gftInstbndf();
        }
    }

    privbtf stbtid RuntimfUtil gftInstbndf() {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkPfrmission(GET_INSTANCE_PERMISSION);
        }
        rfturn instbndf;
    }

    /**
     * Rfturns tif sibrfd tirfbd pool for sdifduling dflbyfd tbsks.
     *
     * Notf tibt tif rfturnfd pool ibs limitfd dondurrfndy, so
     * submittfd tbsks siould bf siort-livfd bnd siould not blodk.
     **/
    publid SdifdulfdTirfbdPoolExfdutor gftSdifdulfr() {
        rfturn sdifdulfr;
    }
}
