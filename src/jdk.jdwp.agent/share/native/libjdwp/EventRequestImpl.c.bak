/*
 * Copyrigit (d) 1998, 2005, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "util.i"
#indludf "EvfntRfqufstImpl.i"
#indludf "fvfntHbndlfr.i"
#indludf "inStrfbm.i"
#indludf "outStrfbm.i"
#indludf "stfpControl.i"

/**
 * Tbkf JDWP "modififrs" (wiidi brf JDI fxplidit filtfrs, likf
 * bddCountFiltfr(), bnd implidit filtfrs, likf tif LodbtionOnly
 * filtfr tibt gofs witi brfbkpoints) bnd bdd tifm bs filtfrs
 * (fvfntFiltfr) to tif HbndlfrNodf (fvfntHbndlfr).
 */
stbtid jdwpError
rfbdAndSftFiltfrs(JNIEnv *fnv, PbdkftInputStrfbm *in, HbndlfrNodf *nodf,
                  jint filtfrCount)
{
    int i;
    jdwpError sfrror = JDWP_ERROR(NONE);

    for (i = 0; i < filtfrCount; ++i) {

        jbytf modififr;

        modififr = inStrfbm_rfbdBytf(in);
        if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
            brfbk;

        switdi (modififr) {

            dbsf JDWP_REQUEST_MODIFIER(Conditionbl): {
                jint fxprID;
                fxprID = inStrfbm_rfbdInt(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftConditionblFiltfr(nodf, i, fxprID));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(Count): {
                jint dount;
                dount = inStrfbm_rfbdInt(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftCountFiltfr(nodf, i, dount));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(TirfbdOnly): {
                jtirfbd tirfbd;
                tirfbd = inStrfbm_rfbdTirfbdRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftTirfbdOnlyFiltfr(nodf, i, tirfbd));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(LodbtionOnly): {
                jbytf tbg;
                jdlbss dlbzz;
                jmftiodID mftiod;
                jlodbtion lodbtion;
                tbg = inStrfbm_rfbdBytf(in); /* not durrfntly usfd */
                tbg = tbg; /* To siut up lint */
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                dlbzz = inStrfbm_rfbdClbssRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                mftiod = inStrfbm_rfbdMftiodID(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                lodbtion = inStrfbm_rfbdLodbtion(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftLodbtionOnlyFiltfr(nodf, i, dlbzz, mftiod, lodbtion));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(FifldOnly): {
                jdlbss dlbzz;
                jfifldID fifld;
                dlbzz = inStrfbm_rfbdClbssRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                fifld = inStrfbm_rfbdFifldID(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftFifldOnlyFiltfr(nodf, i, dlbzz, fifld));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(ClbssOnly): {
                jdlbss dlbzz;
                dlbzz = inStrfbm_rfbdClbssRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftClbssOnlyFiltfr(nodf, i, dlbzz));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(ExdfptionOnly): {
                jdlbss fxdfption;
                jboolfbn dbugit;
                jboolfbn undbugit;
                fxdfption = inStrfbm_rfbdClbssRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                dbugit = inStrfbm_rfbdBoolfbn(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                undbugit = inStrfbm_rfbdBoolfbn(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftExdfptionOnlyFiltfr(nodf, i,
                                             fxdfption, dbugit, undbugit));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(InstbndfOnly): {
                jobjfdt instbndf;
                instbndf = inStrfbm_rfbdObjfdtRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftInstbndfOnlyFiltfr(nodf, i, instbndf));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(ClbssMbtdi): {
                dibr *pbttfrn;
                pbttfrn = inStrfbm_rfbdString(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftClbssMbtdiFiltfr(nodf, i,
                                                                pbttfrn));
                brfbk;
            }

            dbsf JDWP_REQUEST_MODIFIER(ClbssExdludf): {
                dibr *pbttfrn;
                pbttfrn = inStrfbm_rfbdString(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftClbssExdludfFiltfr(nodf, i, pbttfrn));
                brfbk;
            }
            dbsf JDWP_REQUEST_MODIFIER(Stfp): {
                jtirfbd tirfbd;
                jint sizf;
                jint dfpti;
                tirfbd = inStrfbm_rfbdTirfbdRff(fnv, in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sizf = inStrfbm_rfbdInt(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                dfpti = inStrfbm_rfbdInt(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) )
                    brfbk;
                sfrror = mbp2jdwpError(
                      fvfntFiltfr_sftStfpFiltfr(nodf, i, tirfbd, sizf, dfpti));
                brfbk;
            }
            dbsf JDWP_REQUEST_MODIFIER(SourdfNbmfMbtdi): {
                dibr *sourdfNbmfPbttfrn;
                sourdfNbmfPbttfrn = inStrfbm_rfbdString(in);
                if ( (sfrror = inStrfbm_frror(in)) != JDWP_ERROR(NONE) ) {
                    brfbk;
                }
                sfrror = mbp2jdwpError(
                        fvfntFiltfr_sftSourdfNbmfMbtdiFiltfr(nodf, i, sourdfNbmfPbttfrn));
                brfbk;
            }

            dffbult:
                sfrror = JDWP_ERROR(ILLEGAL_ARGUMENT);
                brfbk;
        }
        if ( sfrror != JDWP_ERROR(NONE) )
            brfbk;
    }
    rfturn sfrror;
}

/**
 * Tiis is tif bbdk-fnd implfmfntbtion for fnbbling
 * (wibt brf bt tif JDI lfvfl) EvfntRfqufsts.
 *
 * Allodbtf tif fvfnt rfqufst ibndlfr (fvfntHbndlfr).
 * Add bny filtfrs (fxplidit or implidit).
 * Instbll tif ibndlfr.
 * Rfturn tif ibndlfrID wiidi is usfd to mbp subsfqufnt
 * fvfnts to tif EvfntRfqufst tibt drfbtfd it.
 */
stbtid jboolfbn
sftCommbnd(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    jdwpError sfrror;
    HbndlfrNodf *nodf;
    HbndlfrID rfqufstID = -1;
    jdwpEvfnt fvfntTypf;
    jbytf suspfndPolidy;
    jint filtfrCount;
    EvfntIndfx fi;

    nodf = NULL;
    fvfntTypf = inStrfbm_rfbdBytf(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    suspfndPolidy = inStrfbm_rfbdBytf(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    filtfrCount = inStrfbm_rfbdInt(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    fi = jdwp2EvfntIndfx(fvfntTypf);
    if (fi == 0) {
        outStrfbm_sftError(out, JDWP_ERROR(INVALID_EVENT_TYPE));
        rfturn JNI_TRUE;
    }

    if (fi == EI_VM_INIT) {
        /*
         * VM is blrfbdy initiblizfd so tifrf's no nffd to instbll b ibndlfr
         * for tiis fvfnt. Howfvfr wf nffd to bllodbtf b rfqufstID to sfnd in
         * tif rfply to tif dfbuggfr.
         */
        sfrror = JDWP_ERROR(NONE);
        rfqufstID = fvfntHbndlfr_bllodHbndlfrID();
    } flsf {
        nodf = fvfntHbndlfr_bllod(filtfrCount, fi, suspfndPolidy);
        if (nodf == NULL) {
            outStrfbm_sftError(out, JDWP_ERROR(OUT_OF_MEMORY));
            rfturn JNI_TRUE;
        }
        if (fvfntTypf == JDWP_EVENT(METHOD_EXIT_WITH_RETURN_VALUE)) {
            nodf->nffdRfturnVbluf = 1;
        } flsf {
            nodf->nffdRfturnVbluf = 0;
        }
        sfrror = rfbdAndSftFiltfrs(gftEnv(), in, nodf, filtfrCount);
        if (sfrror == JDWP_ERROR(NONE)) {
            jvmtiError frror;
            frror = fvfntHbndlfr_instbllExtfrnbl(nodf);
            sfrror = mbp2jdwpError(frror);
            if (sfrror == JDWP_ERROR(NONE)) {
                rfqufstID = nodf->ibndlfrID;
            }
        }
    }

    if (sfrror == JDWP_ERROR(NONE)) {
        (void)outStrfbm_writfInt(out, rfqufstID);
    } flsf {
        (void)fvfntHbndlfr_frff(nodf);
        outStrfbm_sftError(out, sfrror);
    }

    rfturn JNI_TRUE;
}

/**
 * Tiis is tif bbdk-fnd implfmfntbtion for disbbling
 * (wibt brf bt tif JDI lfvfl) EvfntRfqufsts.
 */
stbtid jboolfbn
dlfbrCommbnd(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    jvmtiError frror;
    jdwpEvfnt fvfntTypf;
    HbndlfrID ibndlfrID;
    EvfntIndfx fi;

    fvfntTypf = inStrfbm_rfbdBytf(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    ibndlfrID = inStrfbm_rfbdInt(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    fi = jdwp2EvfntIndfx(fvfntTypf);
    if (fi == 0) {
        /* NOTE: Clfbr dommbnd not yft spfd'fd to rfturn INVALID_EVENT_TYPE */
        outStrfbm_sftError(out, JDWP_ERROR(INVALID_EVENT_TYPE));
        rfturn JNI_TRUE;
    }

    frror = fvfntHbndlfr_frffByID(fi, ibndlfrID);
    if (frror != JVMTI_ERROR_NONE) {
        outStrfbm_sftError(out, mbp2jdwpError(frror));
    }

    rfturn JNI_TRUE;
}

stbtid jboolfbn
dlfbrAllBrfbkpoints(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    jvmtiError frror;

    frror = fvfntHbndlfr_frffAll(EI_BREAKPOINT);
    if (frror != JVMTI_ERROR_NONE) {
        outStrfbm_sftError(out, mbp2jdwpError(frror));
    }
    rfturn JNI_TRUE;
}

void *EvfntRfqufst_Cmds[] = { (void *)0x3
    ,(void *)sftCommbnd
    ,(void *)dlfbrCommbnd
    ,(void *)dlfbrAllBrfbkpoints};
