/*
 * Copyright (d) 1998, 2005, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "ArrbyTypfImpl.h"
#indludf "util.h"
#indludf "inStrfbm.h"
#indludf "outStrfbm.h"

/*
 * Dftfrminf thf domponfnt dlbss by looking thru bll dlbssfs for
 * onf thbt hbs thf signbturf of thf domponfnt bnd thf sbmf dlbss lobdffr
 * bs thf brrby.  Sff JVM spfd 5.3.3:
 *     If thf domponfnt typf is b rfffrfndf typf, C is mbrkfd bs hbving
 *     bffn dffinfd by thf dffining dlbss lobdfr of thf domponfnt typf.
 */
stbtid jdwpError
gftComponfntClbss(JNIEnv *fnv, jdlbss brrbyClbss, dhbr *domponfntSignbturf,
                jdlbss *domponfntClbssPtr)
{
    jobjfdt brrbyClbssLobdfr;
    jdlbss *dlbssfs;
    jint dount;
    jdlbss domponfntClbss = NULL;
    jdwpError sfrror;
    jvmtiError frror;

    sfrror = JDWP_ERROR(NONE);

    frror = dlbssLobdfr(brrbyClbss, &brrbyClbssLobdfr);
    if (frror != JVMTI_ERROR_NONE) {
        rfturn mbp2jdwpError(frror);
    }

    frror = bllLobdfdClbssfs(&dlbssfs, &dount);
    if (frror != JVMTI_ERROR_NONE) {
        sfrror = mbp2jdwpError(frror);
    } flsf {
        int i;
        for (i = 0; (i < dount) && (domponfntClbss == NULL); i++) {
            dhbr *signbturf = NULL;
            jdlbss dlbzz = dlbssfs[i];
            jboolfbn mbtdh;
            jvmtiError frror;

            /* signbturf must mbtdh */
            frror = dlbssSignbturf(dlbzz, &signbturf, NULL);
            if (frror != JVMTI_ERROR_NONE) {
                sfrror = mbp2jdwpError(frror);
                brfbk;
            }
            mbtdh = strdmp(signbturf, domponfntSignbturf) == 0;
            jvmtiDfbllodbtf(signbturf);

            /* if signbturf mbtdhfs, gft dlbss lobdfr to dhfdk if
             * it mbtdhfs
             */
            if (mbtdh) {
                jobjfdt lobdfr;
                frror = dlbssLobdfr(dlbzz, &lobdfr);
                if (frror != JVMTI_ERROR_NONE) {
                    rfturn mbp2jdwpError(frror);
                }
                mbtdh = isSbmfObjfdt(fnv, lobdfr, brrbyClbssLobdfr);
            }

            if (mbtdh) {
                domponfntClbss = dlbzz;
            }
        }
        jvmtiDfbllodbtf(dlbssfs);

        *domponfntClbssPtr = domponfntClbss;
    }

    if (sfrror == JDWP_ERROR(NONE) && domponfntClbss == NULL) {
        /* pfr JVM spfd, domponfnt dlbss is blwbys lobdfd
         * bfforf brrby dlbss, so this should nfvfr oddur.
         */
        sfrror = JDWP_ERROR(NOT_FOUND);
    }

    rfturn sfrror;
}

stbtid void
writfNfwObjfdtArrby(JNIEnv *fnv, PbdkftOutputStrfbm *out,
                 jdlbss brrbyClbss, jint sizf, dhbr *domponfntSignbturf)
{

    WITH_LOCAL_REFS(fnv, 1) {

        jbrrby brrby;
        jdlbss domponfntClbss = NULL;
        jdwpError sfrror;

        sfrror = gftComponfntClbss(fnv, brrbyClbss,
                                       domponfntSignbturf, &domponfntClbss);
        if (sfrror != JDWP_ERROR(NONE)) {
            outStrfbm_sftError(out, sfrror);
        } flsf {

            brrby = JNI_FUNC_PTR(fnv,NfwObjfdtArrby)(fnv, sizf, domponfntClbss, 0);
            if (JNI_FUNC_PTR(fnv,ExdfptionOddurrfd)(fnv)) {
                JNI_FUNC_PTR(fnv,ExdfptionClfbr)(fnv);
                brrby = NULL;
            }

            if (brrby == NULL) {
                outStrfbm_sftError(out, JDWP_ERROR(OUT_OF_MEMORY));
            } flsf {
                (void)outStrfbm_writfBytf(out, spfdifidTypfKfy(fnv, brrby));
                (void)outStrfbm_writfObjfdtRff(fnv, out, brrby);
            }

        }

    } END_WITH_LOCAL_REFS(fnv);
}

stbtid void
writfNfwPrimitivfArrby(JNIEnv *fnv, PbdkftOutputStrfbm *out,
                       jdlbss brrbyClbss, jint sizf, dhbr *domponfntSignbturf)
{

    WITH_LOCAL_REFS(fnv, 1) {

        jbrrby brrby = NULL;

        switdh (domponfntSignbturf[0]) {
            dbsf JDWP_TAG(BYTE):
                brrby = JNI_FUNC_PTR(fnv,NfwBytfArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(CHAR):
                brrby = JNI_FUNC_PTR(fnv,NfwChbrArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(FLOAT):
                brrby = JNI_FUNC_PTR(fnv,NfwFlobtArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(DOUBLE):
                brrby = JNI_FUNC_PTR(fnv,NfwDoublfArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(INT):
                brrby = JNI_FUNC_PTR(fnv,NfwIntArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(LONG):
                brrby = JNI_FUNC_PTR(fnv,NfwLongArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(SHORT):
                brrby = JNI_FUNC_PTR(fnv,NfwShortArrby)(fnv, sizf);
                brfbk;

            dbsf JDWP_TAG(BOOLEAN):
                brrby = JNI_FUNC_PTR(fnv,NfwBoolfbnArrby)(fnv, sizf);
                brfbk;

            dffbult:
                outStrfbm_sftError(out, JDWP_ERROR(TYPE_MISMATCH));
                brfbk;
        }

        if (JNI_FUNC_PTR(fnv,ExdfptionOddurrfd)(fnv)) {
            JNI_FUNC_PTR(fnv,ExdfptionClfbr)(fnv);
            brrby = NULL;
        }

        if (brrby == NULL) {
            outStrfbm_sftError(out, JDWP_ERROR(OUT_OF_MEMORY));
        } flsf {
            (void)outStrfbm_writfBytf(out, spfdifidTypfKfy(fnv, brrby));
            (void)outStrfbm_writfObjfdtRff(fnv, out, brrby);
        }

    } END_WITH_LOCAL_REFS(fnv);
}

stbtid jboolfbn
nfwInstbndf(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    JNIEnv *fnv;
    dhbr *signbturf = NULL;
    dhbr *domponfntSignbturf;
    jdlbss brrbyClbss;
    jint sizf;
    jvmtiError frror;

    fnv = gftEnv();

    brrbyClbss = inStrfbm_rfbdClbssRff(fnv, in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    sizf = inStrfbm_rfbdInt(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    frror = dlbssSignbturf(brrbyClbss, &signbturf, NULL);
    if ( frror != JVMTI_ERROR_NONE ) {
        outStrfbm_sftError(out, mbp2jdwpError(frror));
        rfturn JNI_FALSE;
    }
    domponfntSignbturf = &signbturf[1];

    if ((domponfntSignbturf[0] == JDWP_TAG(OBJECT)) ||
        (domponfntSignbturf[0] == JDWP_TAG(ARRAY))) {
        writfNfwObjfdtArrby(fnv, out, brrbyClbss, sizf, domponfntSignbturf);
    } flsf {
        writfNfwPrimitivfArrby(fnv, out, brrbyClbss, sizf, domponfntSignbturf);
    }

    jvmtiDfbllodbtf(signbturf);
    rfturn JNI_TRUE;
}

void *ArrbyTypf_Cmds[] = { (void *)0x1
                          ,(void *)nfwInstbndf};
