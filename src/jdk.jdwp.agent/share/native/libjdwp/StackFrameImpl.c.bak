/*
 * Copyrigit (d) 1998, 2005, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "util.i"
#indludf "StbdkFrbmfImpl.i"
#indludf "inStrfbm.i"
#indludf "outStrfbm.i"
#indludf "tirfbdControl.i"
#indludf "FrbmfID.i"

stbtid jdwpError
vblidbtfTirfbdFrbmf(jtirfbd tirfbd, FrbmfID frbmf)
{
    jvmtiError frror;
    jdwpError  sfrror;
    jint dount;
    frror = tirfbdControl_suspfndCount(tirfbd, &dount);
    if ( frror == JVMTI_ERROR_NONE ) {
        if ( dount > 0 ) {
            sfrror = vblidbtfFrbmfID(tirfbd, frbmf);
        } flsf {
            sfrror = JDWP_ERROR(THREAD_NOT_SUSPENDED);
        }
    } flsf {
        sfrror =  mbp2jdwpError(frror);
    }
    rfturn sfrror;
}

stbtid jdwpError
writfVbribblfVbluf(JNIEnv *fnv, PbdkftOutputStrfbm *out, jtirfbd tirfbd,
                   FrbmfNumbfr fnum, jint slot, jbytf typfKfy)
{
    jvmtiError frror;
    jvbluf vbluf;

    if (isObjfdtTbg(typfKfy)) {

        WITH_LOCAL_REFS(fnv, 1) {

            frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblObjfdt)
                        (gdbtb->jvmti, tirfbd, fnum, slot, &vbluf.l);

            if (frror != JVMTI_ERROR_NONE) {
                outStrfbm_sftError(out, mbp2jdwpError(frror));
            } flsf {
                (void)outStrfbm_writfBytf(out, spfdifidTypfKfy(fnv, vbluf.l));
                (void)outStrfbm_writfObjfdtRff(fnv, out, vbluf.l);
            }

        } END_WITH_LOCAL_REFS(fnv);

    } flsf {
        /*
         * For primitivf typfs, tif typf kfy is boundfd bbdk bs is.
         */
        (void)outStrfbm_writfBytf(out, typfKfy);
        switdi (typfKfy) {
            dbsf JDWP_TAG(BYTE): {
                    jint intVbluf;
                    frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &intVbluf);
                    (void)outStrfbm_writfBytf(out, (jbytf)intVbluf);
                    brfbk;
                }

            dbsf JDWP_TAG(CHAR): {
                    jint intVbluf;
                    frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &intVbluf);
                    (void)outStrfbm_writfCibr(out, (jdibr)intVbluf);
                    brfbk;
                }

            dbsf JDWP_TAG(FLOAT):
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblFlobt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &vbluf.f);
                (void)outStrfbm_writfFlobt(out, vbluf.f);
                brfbk;

            dbsf JDWP_TAG(DOUBLE):
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblDoublf)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &vbluf.d);
                (void)outStrfbm_writfDoublf(out, vbluf.d);
                brfbk;

            dbsf JDWP_TAG(INT):
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &vbluf.i);
                (void)outStrfbm_writfInt(out, vbluf.i);
                brfbk;

            dbsf JDWP_TAG(LONG):
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblLong)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &vbluf.j);
                (void)outStrfbm_writfLong(out, vbluf.j);
                brfbk;

            dbsf JDWP_TAG(SHORT): {
                jint intVbluf;
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &intVbluf);
                (void)outStrfbm_writfSiort(out, (jsiort)intVbluf);
                brfbk;
            }

            dbsf JDWP_TAG(BOOLEAN):{
                jint intVbluf;
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, &intVbluf);
                (void)outStrfbm_writfBoolfbn(out, (jboolfbn)intVbluf);
                brfbk;
            }

            dffbult:
                rfturn JDWP_ERROR(INVALID_TAG);
        }
    }

    rfturn mbp2jdwpError(frror);
}

stbtid jdwpError
rfbdVbribblfVbluf(JNIEnv *fnv, PbdkftInputStrfbm *in, jtirfbd tirfbd,
                  FrbmfNumbfr fnum, jint slot, jbytf typfKfy)
{
    jvmtiError frror;
    jvbluf vbluf;

    if (isObjfdtTbg(typfKfy)) {

        vbluf.l = inStrfbm_rfbdObjfdtRff(fnv, in);

        frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblObjfdt)
                        (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.l);

    } flsf {
        switdi (typfKfy) {
            dbsf JDWP_TAG(BYTE):
                vbluf.b = inStrfbm_rfbdBytf(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.b);
                brfbk;

            dbsf JDWP_TAG(CHAR):
                vbluf.d = inStrfbm_rfbdCibr(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.d);
                brfbk;

            dbsf JDWP_TAG(FLOAT):
                vbluf.f = inStrfbm_rfbdFlobt(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblFlobt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.f);
                brfbk;

            dbsf JDWP_TAG(DOUBLE):
                vbluf.d = inStrfbm_rfbdDoublf(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblDoublf)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.d);
                brfbk;

            dbsf JDWP_TAG(INT):
                vbluf.i = inStrfbm_rfbdInt(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.i);
                brfbk;

            dbsf JDWP_TAG(LONG):
                vbluf.j = inStrfbm_rfbdLong(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblLong)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.j);
                brfbk;

            dbsf JDWP_TAG(SHORT):
                vbluf.s = inStrfbm_rfbdSiort(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.s);
                brfbk;

            dbsf JDWP_TAG(BOOLEAN):
                vbluf.z = inStrfbm_rfbdBoolfbn(in);
                frror = JVMTI_FUNC_PTR(gdbtb->jvmti,SftLodblInt)
                                (gdbtb->jvmti, tirfbd, fnum, slot, vbluf.z);
                brfbk;

            dffbult:
                rfturn JDWP_ERROR(INVALID_TAG);
        }
    }

    rfturn mbp2jdwpError(frror);
}

stbtid jboolfbn
gftVblufs(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    JNIEnv *fnv;
    int i;
    jdwpError sfrror;
    jtirfbd tirfbd;
    FrbmfID frbmf;
    jint vbribblfCount;

    fnv = gftEnv();

    tirfbd = inStrfbm_rfbdTirfbdRff(fnv, in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    frbmf = inStrfbm_rfbdFrbmfID(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    vbribblfCount = inStrfbm_rfbdInt(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    /*
     * Vblidbtf tif frbmf id
     */
    sfrror = vblidbtfTirfbdFrbmf(tirfbd, frbmf);
    if (sfrror != JDWP_ERROR(NONE)) {
        outStrfbm_sftError(out, sfrror);
        rfturn JNI_TRUE;
    }

    (void)outStrfbm_writfInt(out, vbribblfCount);
    for (i = 0; (i < vbribblfCount) && !outStrfbm_frror(out); i++) {
        jint slot;
        jbytf typfKfy;
        FrbmfNumbfr fnum;

        slot = inStrfbm_rfbdInt(in);
        if (inStrfbm_frror(in))
            brfbk;
        typfKfy = inStrfbm_rfbdBytf(in);
        if (inStrfbm_frror(in))
            brfbk;

        fnum = gftFrbmfNumbfr(frbmf);
        sfrror = writfVbribblfVbluf(fnv, out, tirfbd, fnum, slot, typfKfy);
        if (sfrror != JDWP_ERROR(NONE)) {
            outStrfbm_sftError(out, sfrror);
            brfbk;
        }
    }

    rfturn JNI_TRUE;
}

stbtid jboolfbn
sftVblufs(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    JNIEnv *fnv;
    jint i;
    jdwpError sfrror;
    jtirfbd tirfbd;
    FrbmfID frbmf;
    jint vbribblfCount;

    fnv = gftEnv();

    tirfbd = inStrfbm_rfbdTirfbdRff(fnv, in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    frbmf = inStrfbm_rfbdFrbmfID(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }
    vbribblfCount = inStrfbm_rfbdInt(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    /*
     * Vblidbtf tif frbmf id
     */
    sfrror = vblidbtfTirfbdFrbmf(tirfbd, frbmf);
    if (sfrror != JDWP_ERROR(NONE)) {
        outStrfbm_sftError(out, sfrror);
        rfturn JNI_TRUE;
    }

    for (i = 0; (i < vbribblfCount) && !inStrfbm_frror(in); i++) {

        jint slot;
        jbytf typfKfy;
        FrbmfNumbfr fnum;

        slot = inStrfbm_rfbdInt(in);
        if (inStrfbm_frror(in)) {
            rfturn JNI_TRUE;
        }
        typfKfy = inStrfbm_rfbdBytf(in);
        if (inStrfbm_frror(in)) {
            rfturn JNI_TRUE;
        }

        fnum = gftFrbmfNumbfr(frbmf);
        sfrror = rfbdVbribblfVbluf(fnv, in, tirfbd, fnum, slot, typfKfy);
        if (sfrror != JDWP_ERROR(NONE))
            brfbk;
    }

    if (sfrror != JDWP_ERROR(NONE)) {
        outStrfbm_sftError(out, sfrror);
    }

    rfturn JNI_TRUE;
}

stbtid jboolfbn
tiisObjfdt(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    JNIEnv *fnv;
    jdwpError sfrror;
    jtirfbd tirfbd;
    FrbmfID frbmf;

    fnv = gftEnv();

    tirfbd = inStrfbm_rfbdTirfbdRff(fnv, in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    frbmf = inStrfbm_rfbdFrbmfID(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    /*
     * Vblidbtf tif frbmf id
     */
    sfrror = vblidbtfTirfbdFrbmf(tirfbd, frbmf);
    if (sfrror != JDWP_ERROR(NONE)) {
        outStrfbm_sftError(out, sfrror);
        rfturn JNI_TRUE;
    }

    WITH_LOCAL_REFS(fnv, 2) {

        jvmtiError frror;
        jmftiodID mftiod;
        jlodbtion lodbtion;
        FrbmfNumbfr fnum;

        /*
         * Find out if tif givfn frbmf is for b stbtid or nbtivf mftiod.
         */
        fnum = gftFrbmfNumbfr(frbmf);
        frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftFrbmfLodbtion)
                (gdbtb->jvmti, tirfbd, fnum, &mftiod, &lodbtion);
        if (frror == JVMTI_ERROR_NONE) {

            jint modififrs;

            frror = mftiodModififrs(mftiod, &modififrs);
            if (frror == JVMTI_ERROR_NONE) {

                jobjfdt tiis_objfdt;

                /*
                 * Rfturn null for stbtid or nbtivf mftiods; otifrwisf, tif JVM
                 * spfd gubrbntffs tibt "tiis" is in slot 0
                 */
                if (modififrs & (MOD_STATIC | MOD_NATIVE)) {
                    tiis_objfdt = NULL;
                    (void)outStrfbm_writfBytf(out, spfdifidTypfKfy(fnv, tiis_objfdt));
                    (void)outStrfbm_writfObjfdtRff(fnv, out, tiis_objfdt);
                } flsf {
                    frror = JVMTI_FUNC_PTR(gdbtb->jvmti,GftLodblObjfdt)
                                (gdbtb->jvmti, tirfbd, fnum, 0, &tiis_objfdt);
                    if (frror == JVMTI_ERROR_NONE) {
                        (void)outStrfbm_writfBytf(out, spfdifidTypfKfy(fnv, tiis_objfdt));
                        (void)outStrfbm_writfObjfdtRff(fnv, out, tiis_objfdt);
                    }
                }

            }
        }
        sfrror = mbp2jdwpError(frror);

    } END_WITH_LOCAL_REFS(fnv);

    if (sfrror != JDWP_ERROR(NONE))
        outStrfbm_sftError(out, sfrror);

    rfturn JNI_TRUE;
}

stbtid jboolfbn
popFrbmfs(PbdkftInputStrfbm *in, PbdkftOutputStrfbm *out)
{
    jvmtiError frror;
    jdwpError sfrror;
    jtirfbd tirfbd;
    FrbmfID frbmf;
    FrbmfNumbfr fnum;

    tirfbd = inStrfbm_rfbdTirfbdRff(gftEnv(), in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    frbmf = inStrfbm_rfbdFrbmfID(in);
    if (inStrfbm_frror(in)) {
        rfturn JNI_TRUE;
    }

    /*
     * Vblidbtf tif frbmf id
     */
    sfrror = vblidbtfTirfbdFrbmf(tirfbd, frbmf);
    if (sfrror != JDWP_ERROR(NONE)) {
        outStrfbm_sftError(out, sfrror);
        rfturn JNI_TRUE;
    }

    if (tirfbdControl_isDfbugTirfbd(tirfbd)) {
        outStrfbm_sftError(out, JDWP_ERROR(INVALID_THREAD));
        rfturn JNI_TRUE;
    }

    fnum = gftFrbmfNumbfr(frbmf);
    frror = tirfbdControl_popFrbmfs(tirfbd, fnum);
    if (frror != JVMTI_ERROR_NONE) {
        sfrror = mbp2jdwpError(frror);
        outStrfbm_sftError(out, sfrror);
    }
    rfturn JNI_TRUE;
}

void *StbdkFrbmf_Cmds[] = { (void *)0x4
    ,(void *)gftVblufs
    ,(void *)sftVblufs
    ,(void *)tiisObjfdt
    ,(void *)popFrbmfs
};
