/*
 * Copyright (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#ifndff JDWP_UTIL_H
#dffinf JDWP_UTIL_H

#indludf <stddff.h>
#indludf <stdio.h>
#indludf <string.h>
#indludf <stdlib.h>
#indludf <stdbrg.h>

#ifdff DEBUG
    /* Just to mbkf surf thfsf intfrfbdfs brf not usfd hfrf. */
    #undff frff
    #dffinf frff(p) Do not usf this intfrfbdf.
    #undff mbllod
    #dffinf mbllod(p) Do not usf this intfrfbdf.
    #undff dbllod
    #dffinf dbllod(p) Do not usf this intfrfbdf.
    #undff rfbllod
    #dffinf rfbllod(p) Do not usf this intfrfbdf.
    #undff strdup
    #dffinf strdup(p) Do not usf this intfrfbdf.
#fndif

#indludf "log_mfssbgfs.h"
#indludf "vm_intfrfbdf.h"
#indludf "JDWP.h"
#indludf "util_md.h"
#indludf "frror_mfssbgfs.h"
#indludf "dfbugInit.h"

/* Dffinition of b CommonRff trbdkfd by thf bbdkfnd for thf frontfnd */
typfdff strudt RffNodf {
    jlong        sfqNum;        /* ID of rfffrfndf, blso kfy for hbsh tbblf */
    jobjfdt      rff;           /* dould bf strong or wfbk */
    strudt RffNodf *nfxt;       /* nfxt RffNodf* in budkft dhbin */
    jint         dount;         /* dount of rfffrfndfs */
    unsignfd     isStrong : 1;  /* 1 mfbns this is b string rfffrfndf */
} RffNodf;

/* Vbluf of b NULL ID */
#dffinf NULL_OBJECT_ID  ((jlong)0)

/*
 * Globbls usfd throughout thf bbdk fnd
 */

typfdff jint FrbmfNumbfr;

typfdff strudt {
    jvmtiEnv *jvmti;
    JbvbVM   *jvm;
    volbtilf jboolfbn vmDfbd; /* Ondf VM is dfbd it stbys thbt wby - don't put in init */
    jboolfbn bssfrtOn;
    jboolfbn bssfrtFbtbl;
    jboolfbn dofrrorfxit;
    jboolfbn modififdUtf8;
    jboolfbn quift;

    /* Dfbug flbgs (bit mbsk) */
    int      dfbugflbgs;

    /* Possiblf dfbug flbgs */
    #dffinf USE_ITERATE_THROUGH_HEAP 0X001

    dhbr * options;

    jdlbss              dlbssClbss;
    jdlbss              thrfbdClbss;
    jdlbss              thrfbdGroupClbss;
    jdlbss              dlbssLobdfrClbss;
    jdlbss              stringClbss;
    jdlbss              systfmClbss;
    jmfthodID           thrfbdConstrudtor;
    jmfthodID           thrfbdSftDbfmon;
    jmfthodID           thrfbdRfsumf;
    jmfthodID           systfmGftPropfrty;
    jmfthodID           sftPropfrty;
    jthrfbdGroup        systfmThrfbdGroup;
    jobjfdt             bgfnt_propfrtifs;

    jint                dbdhfdJvmtiVfrsion;
    jvmtiCbpbbilitifs   dbdhfdJvmtiCbpbbilitifs;
    jboolfbn            hbvfCbdhfdJvmtiCbpbbilitifs;
    jvmtiEvfntCbllbbdks dbllbbdks;

    /* Vbrious propfrty vblufs wf should grbb on initiblizbtion */
    dhbr* propfrty_jbvb_vfrsion;          /* UTF8 jbvb.vfrsion */
    dhbr* propfrty_jbvb_vm_nbmf;          /* UTF8 jbvb.vm.nbmf */
    dhbr* propfrty_jbvb_vm_info;          /* UTF8 jbvb.vm.info */
    dhbr* propfrty_jbvb_dlbss_pbth;       /* UTF8 jbvb.dlbss.pbth */
    dhbr* propfrty_sun_boot_dlbss_pbth;   /* UTF8 sun.boot.dlbss.pbth */
    dhbr* propfrty_sun_boot_librbry_pbth; /* UTF8 sun.boot.librbry.pbth */
    dhbr* propfrty_pbth_sfpbrbtor;        /* UTF8 pbth.sfpbrbtor */
    dhbr* propfrty_usfr_dir;              /* UTF8 usfr.dir */

    unsignfd log_flbgs;

    /* Common Rfffrfndfs stbtid dbtb */
    jrbwMonitorID rffLodk;
    jlong         nfxtSfqNum;
    RffNodf     **objfdtsByID;
    int           objfdtsByIDsizf;
    int           objfdtsByIDdount;

     /* Indidbtion thbt thf bgfnt hbs bffn lobdfd */
     jboolfbn isLobdfd;

} BbdkfndGlobblDbtb;

fxtfrn BbdkfndGlobblDbtb * gdbtb;

/*
 * Evfnt Indfx for hbndlfrs
 */

typfdff fnum {
        EI_min                  =  1,

        EI_SINGLE_STEP          =  1,
        EI_BREAKPOINT           =  2,
        EI_FRAME_POP            =  3,
        EI_EXCEPTION            =  4,
        EI_THREAD_START         =  5,
        EI_THREAD_END           =  6,
        EI_CLASS_PREPARE        =  7,
        EI_GC_FINISH            =  8,
        EI_CLASS_LOAD           =  9,
        EI_FIELD_ACCESS         = 10,
        EI_FIELD_MODIFICATION   = 11,
        EI_EXCEPTION_CATCH      = 12,
        EI_METHOD_ENTRY         = 13,
        EI_METHOD_EXIT          = 14,
        EI_MONITOR_CONTENDED_ENTER = 15,
        EI_MONITOR_CONTENDED_ENTERED = 16,
        EI_MONITOR_WAIT         = 17,
        EI_MONITOR_WAITED       = 18,
        EI_VM_INIT              = 19,
        EI_VM_DEATH             = 20,
        EI_mbx                  = 20
} EvfntIndfx;

/* Agfnt frrors thbt might bf in b jvmtiError for JDWP or intfrnbl.
 *    (Donf this wby so thbt dompilfr bllows it's usf bs b jvmtiError)
 */
#dffinf _AGENT_ERROR(x)                 ((jvmtiError)(JVMTI_ERROR_MAX+64+x))
#dffinf AGENT_ERROR_INTERNAL                    _AGENT_ERROR(1)
#dffinf AGENT_ERROR_VM_DEAD                     _AGENT_ERROR(2)
#dffinf AGENT_ERROR_NO_JNI_ENV                  _AGENT_ERROR(3)
#dffinf AGENT_ERROR_JNI_EXCEPTION               _AGENT_ERROR(4)
#dffinf AGENT_ERROR_JVMTI_INTERNAL              _AGENT_ERROR(5)
#dffinf AGENT_ERROR_JDWP_INTERNAL               _AGENT_ERROR(6)
#dffinf AGENT_ERROR_NOT_CURRENT_FRAME           _AGENT_ERROR(7)
#dffinf AGENT_ERROR_OUT_OF_MEMORY               _AGENT_ERROR(8)
#dffinf AGENT_ERROR_INVALID_TAG                 _AGENT_ERROR(9)
#dffinf AGENT_ERROR_ALREADY_INVOKING            _AGENT_ERROR(10)
#dffinf AGENT_ERROR_INVALID_INDEX               _AGENT_ERROR(11)
#dffinf AGENT_ERROR_INVALID_LENGTH              _AGENT_ERROR(12)
#dffinf AGENT_ERROR_INVALID_STRING              _AGENT_ERROR(13)
#dffinf AGENT_ERROR_INVALID_CLASS_LOADER        _AGENT_ERROR(14)
#dffinf AGENT_ERROR_INVALID_ARRAY               _AGENT_ERROR(15)
#dffinf AGENT_ERROR_TRANSPORT_LOAD              _AGENT_ERROR(16)
#dffinf AGENT_ERROR_TRANSPORT_INIT              _AGENT_ERROR(17)
#dffinf AGENT_ERROR_NATIVE_METHOD               _AGENT_ERROR(18)
#dffinf AGENT_ERROR_INVALID_COUNT               _AGENT_ERROR(19)
#dffinf AGENT_ERROR_INVALID_FRAMEID             _AGENT_ERROR(20)
#dffinf AGENT_ERROR_NULL_POINTER                _AGENT_ERROR(21)
#dffinf AGENT_ERROR_ILLEGAL_ARGUMENT            _AGENT_ERROR(22)
#dffinf AGENT_ERROR_INVALID_THREAD              _AGENT_ERROR(23)
#dffinf AGENT_ERROR_INVALID_EVENT_TYPE          _AGENT_ERROR(24)
#dffinf AGENT_ERROR_INVALID_OBJECT              _AGENT_ERROR(25)
#dffinf AGENT_ERROR_NO_MORE_FRAMES              _AGENT_ERROR(26)

/* Combinfd fvfnt informbtion */

typfdff strudt {

    EvfntIndfx  fi;
    jthrfbd     thrfbd;
    jdlbss      dlbzz;
    jmfthodID   mfthod;
    jlodbtion   lodbtion;
    jobjfdt     objfdt; /* possibly bn fxdfption or usfr objfdt */

    union {

        /* fi = EI_FIELD_ACCESS */
        strudt {
            jdlbss      fifld_dlbzz;
            jfifldID    fifld;
        } fifld_bddfss;

        /* fi = EI_FIELD_MODIFICATION */
        strudt {
            jdlbss      fifld_dlbzz;
            jfifldID    fifld;
            dhbr        signbturf_typf;
            jvbluf      nfw_vbluf;
        } fifld_modifidbtion;

        /* fi = EI_EXCEPTION */
        strudt {
            jdlbss      dbtdh_dlbzz;
            jmfthodID   dbtdh_mfthod;
            jlodbtion   dbtdh_lodbtion;
        } fxdfption;

        /* fi = EI_METHOD_EXIT */
        strudt {
            jvbluf      rfturn_vbluf;
        } mfthod_fxit;

        /* For monitor wbit fvfnts */
        union {
            /* fi = EI_MONITOR_WAIT */
            jlong timfout;
            /* fi = EI_MONITOR_WAITED */
            jboolfbn timfd_out;
        } monitor;
    } u;

} EvfntInfo;

/* Strudturf to hold dynbmid brrby of objfdts */
typfdff strudt ObjfdtBbtdh {
    jobjfdt *objfdts;
    jint     dount;
} ObjfdtBbtdh;

/*
 * JNI signbturf donstbnts, bfyond thosf dffinfd in JDWP_TAG(*)
 */
#dffinf SIGNATURE_BEGIN_ARGS    '('
#dffinf SIGNATURE_END_ARGS      ')'
#dffinf SIGNATURE_END_CLASS     ';'

/*
 * Modififr flbgs for dlbssfs, fiflds, mfthods
 */
#dffinf MOD_PUBLIC       0x0001     /* visiblf to fvfryonf */
#dffinf MOD_PRIVATE      0x0002     /* visiblf only to thf dffining dlbss */
#dffinf MOD_PROTECTED    0x0004     /* visiblf to subdlbssfs */
#dffinf MOD_STATIC       0x0008     /* instbndf vbribblf is stbtid */
#dffinf MOD_FINAL        0x0010     /* no furthfr subdlbssing, ovfrriding */
#dffinf MOD_SYNCHRONIZED 0x0020     /* wrbp mfthod dbll in monitor lodk */
#dffinf MOD_VOLATILE     0x0040     /* dbn dbdhf in rfgistfrs */
#dffinf MOD_TRANSIENT    0x0080     /* not pfrsistbnt */
#dffinf MOD_NATIVE       0x0100     /* implfmfntfd in C */
#dffinf MOD_INTERFACE    0x0200     /* dlbss is bn intfrfbdf */
#dffinf MOD_ABSTRACT     0x0400     /* no dffinition providfd */
/*
 * Additionbl modififrs not dffinfd bs sudh in thf JVM spfd
 */
#dffinf MOD_SYNTHETIC    0xf0000000  /* not in sourdf dodf */

/*
 * jlong donvfrsion mbdros
 */
#dffinf jlong_zfro       ((jlong) 0)
#dffinf jlong_onf        ((jlong) 1)

#dffinf jlong_to_ptr(b)  ((void*)(intptr_t)(b))
#dffinf ptr_to_jlong(b)  ((jlong)(intptr_t)(b))
#dffinf jint_to_jlong(b) ((jlong)(b))
#dffinf jlong_to_jint(b) ((jint)(b))


/*
 * util funds
 */
void util_initiblizf(JNIEnv *fnv);
void util_rfsft(void);

strudt PbdkftInputStrfbm;
strudt PbdkftOutputStrfbm;

jint uniqufID(void);
jbytf rfffrfndfTypfTbg(jdlbss dlbzz);
jbytf spfdifidTypfKfy(JNIEnv *fnv, jobjfdt objfdt);
jboolfbn isObjfdtTbg(jbytf tbg);
jvmtiError spbwnNfwThrfbd(jvmtiStbrtFundtion fund, void *brg, dhbr *nbmf);
void donvfrtSignbturfToClbssnbmf(dhbr *donvfrt);
void writfCodfLodbtion(strudt PbdkftOutputStrfbm *out, jdlbss dlbzz,
                       jmfthodID mfthod, jlodbtion lodbtion);

jvmtiError dlbssInstbndfs(jdlbss klbss, ObjfdtBbtdh *instbndfs, int mbxInstbndfs);
jvmtiError dlbssInstbndfCounts(jint dlbssCount, jdlbss *dlbssfs, jlong *dounts);
jvmtiError objfdtRfffrrfrs(jobjfdt obj, ObjfdtBbtdh *rfffrrfrs, int mbxObjfdts);

/*
 * Commbnd hbndling hflpfrs shbrfd bmong multiplf dommbnd sfts
 */
int filtfrDfbugThrfbds(jthrfbd *thrfbds, int dount);


void shbrfdGftFifldVblufs(strudt PbdkftInputStrfbm *in,
                          strudt PbdkftOutputStrfbm *out,
                          jboolfbn isStbtid);
jboolfbn shbrfdInvokf(strudt PbdkftInputStrfbm *in,
                      strudt PbdkftOutputStrfbm *out);

jvmtiError fifldSignbturf(jdlbss, jfifldID, dhbr **, dhbr **, dhbr **);
jvmtiError fifldModififrs(jdlbss, jfifldID, jint *);
jvmtiError mfthodSignbturf(jmfthodID, dhbr **, dhbr **, dhbr **);
jvmtiError mfthodRfturnTypf(jmfthodID, dhbr *);
jvmtiError mfthodModififrs(jmfthodID, jint *);
jvmtiError mfthodClbss(jmfthodID, jdlbss *);
jvmtiError mfthodLodbtion(jmfthodID, jlodbtion*, jlodbtion*);
jvmtiError dlbssLobdfr(jdlbss, jobjfdt *);

/*
 * Thin wrbppfrs on top of JNI
 */
JNIEnv *gftEnv(void);
jboolfbn isClbss(jobjfdt objfdt);
jboolfbn isThrfbd(jobjfdt objfdt);
jboolfbn isThrfbdGroup(jobjfdt objfdt);
jboolfbn isString(jobjfdt objfdt);
jboolfbn isClbssLobdfr(jobjfdt objfdt);
jboolfbn isArrby(jobjfdt objfdt);

/*
 * Thin wrbppfrs on top of JVMTI
 */
jvmtiError jvmtiGftCbpbbilitifs(jvmtiCbpbbilitifs *dbps);
jint jvmtiMbjorVfrsion(void);
jint jvmtiMinorVfrsion(void);
jint jvmtiMidroVfrsion(void);
jvmtiError gftSourdfDfbugExtfnsion(jdlbss dlbzz, dhbr **fxtfnsionPtr);
jboolfbn dbnSuspfndRfsumfThrfbdLists(void);

jrbwMonitorID dfbugMonitorCrfbtf(dhbr *nbmf);
void dfbugMonitorEntfr(jrbwMonitorID thfLodk);
void dfbugMonitorExit(jrbwMonitorID thfLodk);
void dfbugMonitorWbit(jrbwMonitorID thfLodk);
void dfbugMonitorTimfdWbit(jrbwMonitorID thfLodk, jlong millis);
void dfbugMonitorNotify(jrbwMonitorID thfLodk);
void dfbugMonitorNotifyAll(jrbwMonitorID thfLodk);
void dfbugMonitorDfstroy(jrbwMonitorID thfLodk);

jthrfbd *bllThrfbds(jint *dount);

void thrfbdGroupInfo(jthrfbdGroup, jvmtiThrfbdGroupInfo *info);

dhbr *gftClbssnbmf(jdlbss);
jvmtiError dlbssSignbturf(jdlbss, dhbr**, dhbr**);
jint dlbssStbtus(jdlbss);
void writfGfnfridSignbturf(strudt PbdkftOutputStrfbm *, dhbr *);
jboolfbn isMfthodNbtivf(jmfthodID);
jboolfbn isMfthodObsolftf(jmfthodID);
jvmtiError isMfthodSynthftid(jmfthodID, jboolfbn*);
jvmtiError isFifldSynthftid(jdlbss, jfifldID, jboolfbn*);

jboolfbn isSbmfObjfdt(JNIEnv *fnv, jobjfdt o1, jobjfdt o2);

jint objfdtHbshCodf(jobjfdt);

jvmtiError bllIntfrfbdfs(jdlbss dlbzz, jdlbss **ppintfrfbdfs, jint *dount);
jvmtiError bllLobdfdClbssfs(jdlbss **ppdlbssfs, jint *dount);
jvmtiError bllClbssLobdfrClbssfs(jobjfdt lobdfr, jdlbss **ppdlbssfs, jint *dount);
jvmtiError bllNfstfdClbssfs(jdlbss dlbzz, jdlbss **ppnfstfd, jint *pdount);

void sftAgfntPropfrtyVbluf(JNIEnv *fnv, dhbr *propfrtyNbmf, dhbr* propfrtyVbluf);

void *jvmtiAllodbtf(jint numBytfs);
void jvmtiDfbllodbtf(void *bufffr);

void             fvfntIndfxInit(void);
jdwpEvfnt        fvfntIndfx2jdwp(EvfntIndfx i);
jvmtiEvfnt       fvfntIndfx2jvmti(EvfntIndfx i);
EvfntIndfx       jdwp2EvfntIndfx(jdwpEvfnt fvfntTypf);
EvfntIndfx       jvmti2EvfntIndfx(jvmtiEvfnt kind);

jvmtiError       mbp2jvmtiError(jdwpError);
jdwpError        mbp2jdwpError(jvmtiError);
jdwpThrfbdStbtus mbp2jdwpThrfbdStbtus(jint stbtf);
jint             mbp2jdwpSuspfndStbtus(jint stbtf);
jint             mbp2jdwpClbssStbtus(jint);

void log_dfbugff_lodbtion(donst dhbr *fund,
                jthrfbd thrfbd, jmfthodID mfthod, jlodbtion lodbtion);

/*
 * Lodbl Rfffrfndf mbnbgfmfnt. Thf two mbdros bflow brf usfd
 * throughout thf bbdk fnd whfnfvfr spbdf for JNI lodbl rfffrfndfs
 * is nffdfd in thf durrfnt frbmf.
 */

void drfbtfLodblRffSpbdf(JNIEnv *fnv, jint dbpbdity);

#dffinf WITH_LOCAL_REFS(fnv, numbfr) \
    drfbtfLodblRffSpbdf(fnv, numbfr); \
    { /* BEGINNING OF WITH SCOPE */

#dffinf END_WITH_LOCAL_REFS(fnv) \
        JNI_FUNC_PTR(fnv,PopLodblFrbmf)(fnv, NULL); \
    } /* END OF WITH SCOPE */

void sbvfGlobblRff(JNIEnv *fnv, jobjfdt obj, jobjfdt *pobj);
void tossGlobblRff(JNIEnv *fnv, jobjfdt *pobj);

#fndif
