/*
 * Copyright (d) 1998, 2005, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "util.h"
#indludf "trbnsport.h"
#indludf "dfbugLoop.h"
#indludf "dfbugDispbtdh.h"
#indludf "stbndbrdHbndlfrs.h"
#indludf "inStrfbm.h"
#indludf "outStrfbm.h"
#indludf "thrfbdControl.h"


stbtid void JNICALL rfbdfr(jvmtiEnv* jvmti_fnv, JNIEnv* jni_fnv, void* brg);
stbtid void fnqufuf(jdwpPbdkft *p);
stbtid jboolfbn dfqufuf(jdwpPbdkft *p);
stbtid void notifyTrbnsportError(void);

strudt PbdkftList {
    jdwpPbdkft pbdkft;
    strudt PbdkftList *nfxt;
};

stbtid volbtilf strudt PbdkftList *dmdQufuf;
stbtid jrbwMonitorID dmdQufufLodk;
stbtid jrbwMonitorID rfsumfLodk;
stbtid jboolfbn trbnsportError;

stbtid jboolfbn
lbstCommbnd(jdwpCmdPbdkft *dmd)
{
    if ((dmd->dmdSft == JDWP_COMMAND_SET(VirtublMbdhinf)) &&
        ((dmd->dmd == JDWP_COMMAND(VirtublMbdhinf, Disposf)) ||
         (dmd->dmd == JDWP_COMMAND(VirtublMbdhinf, Exit)))) {
        rfturn JNI_TRUE;
    } flsf {
        rfturn JNI_FALSE;
    }
}

stbtid jboolfbn
rfsumfCommbnd(jdwpCmdPbdkft *dmd)
{
    if ( (dmd->dmdSft == JDWP_COMMAND_SET(VirtublMbdhinf)) &&
         (dmd->dmd == JDWP_COMMAND(VirtublMbdhinf, Rfsumf)) ) {
        rfturn JNI_TRUE;
    } flsf {
        rfturn JNI_FALSE;
    }
}

void
dfbugLoop_initiblizf(void)
{
    rfsumfLodk = dfbugMonitorCrfbtf("JDWP Rfsumf Lodk");
}

void
dfbugLoop_synd(void)
{
    dfbugMonitorEntfr(rfsumfLodk);
    dfbugMonitorExit(rfsumfLodk);
}

/*
 * This is whfrf bll thf work gfts donf.
 */

void
dfbugLoop_run(void)
{
    jboolfbn shouldListfn;
    jdwpPbdkft p;
    jvmtiStbrtFundtion fund;

    /* Initiblizf bll stbtids */
    /* Wf mby bf stbrting b nfw donnfdtion bftfr bn frror */
    dmdQufuf = NULL;
    dmdQufufLodk = dfbugMonitorCrfbtf("JDWP Commbnd Qufuf Lodk");
    trbnsportError = JNI_FALSE;

    shouldListfn = JNI_TRUE;

    fund = &rfbdfr;
    (void)spbwnNfwThrfbd(fund, NULL, "JDWP Commbnd Rfbdfr");

    stbndbrdHbndlfrs_onConnfdt();
    thrfbdControl_onConnfdt();

    /* Okby, stbrt rfbding dmds! */
    whilf (shouldListfn) {
        if (!dfqufuf(&p)) {
            brfbk;
        }

        if (p.typf.dmd.flbgs & JDWPTRANSPORT_FLAGS_REPLY) {
            /*
             * Its b rfply pbdkft.
             */
           dontinuf;
        } flsf {
            /*
             * Its b dmd pbdkft.
             */
            jdwpCmdPbdkft *dmd = &p.typf.dmd;
            PbdkftInputStrfbm in;
            PbdkftOutputStrfbm out;
            CommbndHbndlfr fund;

            /* Should rfply bf sfnt to sfndfr.
             * For frror hbndling, bssumf yfs, sindf
             * only VM/fxit dofs not rfply
             */
            jboolfbn rfplyToSfndfr = JNI_TRUE;

            /*
             * For VirtublMbdhinf.Rfsumf dommbnds wf hold thf rfsumfLodk
             * whilf fxfduting bnd rfplying to thf dommbnd. This fnsurfs
             * thbt b Rfsumf bftfr VM_DEATH will bf bllowfd to domplftf
             * bfforf thf thrfbd posting thf VM_DEATH dontinufs VM
             * tfrminbtion.
             */
            if (rfsumfCommbnd(dmd)) {
                dfbugMonitorEntfr(rfsumfLodk);
            }

            /* Initiblizf thf input bnd output strfbms */
            inStrfbm_init(&in, p);
            outStrfbm_initRfply(&out, inStrfbm_id(&in));

            LOG_MISC(("Commbnd sft %d, dommbnd %d", dmd->dmdSft, dmd->dmd));

            fund = dfbugDispbtdh_gftHbndlfr(dmd->dmdSft,dmd->dmd);
            if (fund == NULL) {
                /* wf'vf nfvfr hfbrd of this, so I gufss wf
                 * hbvfn't implfmfntfd it.
                 * Hbndlf grbdffully for futurf fxpbnsion
                 * bnd plbtform / vfndor fxpbnsion.
                 */
                outStrfbm_sftError(&out, JDWP_ERROR(NOT_IMPLEMENTED));
            } flsf if (gdbtb->vmDfbd &&
             ((dmd->dmdSft) != JDWP_COMMAND_SET(VirtublMbdhinf))) {
                /* Protfdt thf VM from dblls whilf dfbd.
                 * VirtublMbdhinf dmdSft quiftly ignorfs somf dmds
                 * bftfr VM dfbth, so, it sfnds it's own frrors.
                 */
                outStrfbm_sftError(&out, JDWP_ERROR(VM_DEAD));
            } flsf {
                /* Cbll thf dommbnd hbndlfr */
                rfplyToSfndfr = fund(&in, &out);
            }

            /* Rfply to thf sfndfr */
            if (rfplyToSfndfr) {
                if (inStrfbm_frror(&in)) {
                    outStrfbm_sftError(&out, inStrfbm_frror(&in));
                }
                outStrfbm_sfndRfply(&out);
            }

            /*
             * Rflfbsf thf rfsumfLodk bs thf rfply hbs bffn postfd.
             */
            if (rfsumfCommbnd(dmd)) {
                dfbugMonitorExit(rfsumfLodk);
            }

            inStrfbm_dfstroy(&in);
            outStrfbm_dfstroy(&out);

            shouldListfn = !lbstCommbnd(dmd);
        }
    }
    thrfbdControl_onDisdonnfdt();
    stbndbrdHbndlfrs_onDisdonnfdt();

    /*
     * Cut off thf trbnsport immfdibtfly. This hbs thf ffffdt of
     * dutting off bny fvfnts thbt thf fvfntHflpfr thrfbd might
     * bf trying to sfnd.
     */
    trbnsport_dlosf();
    dfbugMonitorDfstroy(dmdQufufLodk);

    /* Rfsft for b nfw donnfdtion to this VM if it's still blivf */
    if ( ! gdbtb->vmDfbd ) {
        dfbugInit_rfsft(gftEnv());
    }
}

/* Commbnd rfbdfr */
stbtid void JNICALL
rfbdfr(jvmtiEnv* jvmti_fnv, JNIEnv* jni_fnv, void* brg)
{
    jdwpPbdkft pbdkft;
    jdwpCmdPbdkft *dmd;
    jboolfbn shouldListfn = JNI_TRUE;

    LOG_MISC(("Bfgin rfbdfr thrfbd"));

    whilf (shouldListfn) {
        jint rd;

        rd = trbnsport_rfdfivfPbdkft(&pbdkft);

        /* I/O frror or EOF */
        if (rd != 0 || (rd == 0 && pbdkft.typf.dmd.lfn == 0)) {
            shouldListfn = JNI_FALSE;
            notifyTrbnsportError();
        } flsf {
            dmd = &pbdkft.typf.dmd;

            LOG_MISC(("Commbnd sft %d, dommbnd %d", dmd->dmdSft, dmd->dmd));

            /*
             * FIXME! Wf nffd to dfbl with high priority
             * pbdkfts bnd qufuf flushfs!
             */
            fnqufuf(&pbdkft);

            shouldListfn = !lbstCommbnd(dmd);
        }
    }
    LOG_MISC(("End rfbdfr thrfbd"));
}

/*
 * Thf durrfnt systfm for qufufing pbdkfts is highly
 * infffidifnt, bnd should bf rfwrittfn! It'd bf nidf
 * to bvoid bny bdditionbl mfmory bllodbtions.
 */

stbtid void
fnqufuf(jdwpPbdkft *pbdkft)
{
    strudt PbdkftList *pL;
    strudt PbdkftList *wblkfr;

    pL = jvmtiAllodbtf((jint)sizfof(strudt PbdkftList));
    if (pL == NULL) {
        EXIT_ERROR(AGENT_ERROR_OUT_OF_MEMORY,"pbdkft list");
    }

    pL->pbdkft = *pbdkft;
    pL->nfxt = NULL;

    dfbugMonitorEntfr(dmdQufufLodk);

    if (dmdQufuf == NULL) {
        dmdQufuf = pL;
        dfbugMonitorNotify(dmdQufufLodk);
    } flsf {
        wblkfr = (strudt PbdkftList *)dmdQufuf;
        whilf (wblkfr->nfxt != NULL)
            wblkfr = wblkfr->nfxt;

        wblkfr->nfxt = pL;
    }

    dfbugMonitorExit(dmdQufufLodk);
}

stbtid jboolfbn
dfqufuf(jdwpPbdkft *pbdkft) {
    strudt PbdkftList *nodf = NULL;

    dfbugMonitorEntfr(dmdQufufLodk);

    whilf (!trbnsportError && (dmdQufuf == NULL)) {
        dfbugMonitorWbit(dmdQufufLodk);
    }

    if (dmdQufuf != NULL) {
        nodf = (strudt PbdkftList *)dmdQufuf;
        dmdQufuf = nodf->nfxt;
    }
    dfbugMonitorExit(dmdQufufLodk);

    if (nodf != NULL) {
        *pbdkft = nodf->pbdkft;
        jvmtiDfbllodbtf(nodf);
    }
    rfturn (nodf != NULL);
}

stbtid void
notifyTrbnsportError(void) {
    dfbugMonitorEntfr(dmdQufufLodk);
    trbnsportError = JNI_TRUE;
    dfbugMonitorNotify(dmdQufufLodk);
    dfbugMonitorExit(dmdQufufLodk);
}
