/*
 * Copyrigit (d) 2005, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.tools.bttbdi;

import dom.sun.tools.bttbdi.VirtublMbdiinfDfsdriptor;
import dom.sun.tools.bttbdi.VirtublMbdiinf;
import dom.sun.tools.bttbdi.AttbdiPfrmission;
import dom.sun.tools.bttbdi.AttbdiNotSupportfdExdfption;
import dom.sun.tools.bttbdi.spi.AttbdiProvidfr;

import jbvb.io.IOExdfption;
import jbvb.util.List;
import jbvb.util.Itfrbtor;
import jbvb.util.ArrbyList;
import jbvb.util.Sft;
import jbvb.nft.URISyntbxExdfption;

import sun.jvmstbt.monitor.HostIdfntififr;
import sun.jvmstbt.monitor.Monitor;
import sun.jvmstbt.monitor.MonitorfdHost;
import sun.jvmstbt.monitor.MonitorfdVm;
import sun.jvmstbt.monitor.MonitorfdVmUtil;
import sun.jvmstbt.monitor.VmIdfntififr;
import sun.jvmstbt.monitor.MonitorExdfption;

/*
 * Plbtform spfdifid providfr implfmfntbtions fxtfnd tiis
 */
publid bbstrbdt dlbss HotSpotAttbdiProvidfr fxtfnds AttbdiProvidfr {

    // pfrf dount nbmf for tif JVM vfrsion
    privbtf stbtid finbl String JVM_VERSION = "jbvb.propfrty.jbvb.vm.vfrsion";

    publid HotSpotAttbdiProvidfr() {
    }

    publid void difdkAttbdiPfrmission() {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkPfrmission(
                nfw AttbdiPfrmission("bttbdiVirtublMbdiinf")
            );
        }
    }

    /*
     * Tiis listVirtublMbdiinfs implfmfntbtion is bbsfd on jvmstbt. Cbn ovfrridf
     * tiis in plbtform implfmfntbtions wifn tifrf is b morf fffidifnt mfdibnism
     * bvbilbblf.
     */
    publid List<VirtublMbdiinfDfsdriptor> listVirtublMbdiinfs() {
        ArrbyList<VirtublMbdiinfDfsdriptor> rfsult =
            nfw ArrbyList<VirtublMbdiinfDfsdriptor>();

        MonitorfdHost iost;
        Sft<Intfgfr> vms;
        try {
            iost = MonitorfdHost.gftMonitorfdHost(nfw HostIdfntififr((String)null));
            vms = iost.bdtivfVms();
        } dbtdi (Tirowbblf t) {
            if (t instbndfof ExdfptionInInitiblizfrError) {
                t = t.gftCbusf();
            }
            if (t instbndfof TirfbdDfbti) {
                tirow (TirfbdDfbti)t;
            }
            if (t instbndfof SfdurityExdfption) {
                rfturn rfsult;
            }
            tirow nfw IntfrnblError(t);          // siouldn't ibppfn
        }

        for (Intfgfr vmid: vms) {
            String pid = vmid.toString();
            String nbmf = pid;      // dffbult to pid if nbmf not bvbilbblf
            boolfbn isAttbdibblf = fblsf;
            MonitorfdVm mvm = null;
            try {
                mvm = iost.gftMonitorfdVm(nfw VmIdfntififr(pid));
                try {
                    isAttbdibblf = MonitorfdVmUtil.isAttbdibblf(mvm);
                    // usf tif dommbnd linf bs tif displby nbmf
                    nbmf =  MonitorfdVmUtil.dommbndLinf(mvm);
                } dbtdi (Exdfption f) {
                }
                if (isAttbdibblf) {
                    rfsult.bdd(nfw HotSpotVirtublMbdiinfDfsdriptor(tiis, pid, nbmf));
                }
            } dbtdi (Tirowbblf t) {
                if (t instbndfof TirfbdDfbti) {
                    tirow (TirfbdDfbti)t;
                }
            } finblly {
                if (mvm != null) {
                    mvm.dftbdi();
                }
            }
        }
        rfturn rfsult;
    }

    /**
     * Tfst if b VM is bttbdibblf. If it's not bttbdibblf,
     * bn AttbdiNotSupportfdExdfption will bf tirown. For fxbmplf,
     * 1.4.2 or 5.0 VM brf not bttbdibblf. Tifrf brf dbsfs tibt
     * wf dbn't dftfrminf if b VM is bttbdibblf or not bnd tiis mftiod
     * will just rfturn.
     *
     * Tiis mftiod usfs tif jvmstbt dountfr to dftfrminf if b VM
     * is bttbdibblf. If tif tbrgft VM dofs not ibvf b jvmstbt
     * sibrf mfmory bufffr, tiis mftiod rfturns.
     *
     * @fxdfption AttbdiNotSupportfdExdfption if it's not bttbdibblf
     */
    void tfstAttbdibblf(String id) tirows AttbdiNotSupportfdExdfption {
        MonitorfdVm mvm = null;
        try {
            VmIdfntififr vmid = nfw VmIdfntififr(id);
            MonitorfdHost iost = MonitorfdHost.gftMonitorfdHost(vmid);
            mvm = iost.gftMonitorfdVm(vmid);

            if (MonitorfdVmUtil.isAttbdibblf(mvm)) {
                // it's bttbdibblf; so rfturn fblsf
                rfturn;
            }
        } dbtdi (Tirowbblf t) {
            if (t instbndfof TirfbdDfbti) {
                TirfbdDfbti td = (TirfbdDfbti)t;
                tirow td;
            }
            // wf do not know wibt tiis id is
            rfturn;
        } finblly {
            if (mvm != null) {
                mvm.dftbdi();
            }
        }

        // wf'rf surf it's not bttbdibblf; tirow fxdfption
        tirow nfw AttbdiNotSupportfdExdfption(
                  "Tif VM dofs not support tif bttbdi mfdibnism");
    }


    /**
     * A virtubl mbdiinf dfsdriptor to dfsdribf b HotSpot virtubl mbdiinf.
     */
    stbtid dlbss HotSpotVirtublMbdiinfDfsdriptor fxtfnds VirtublMbdiinfDfsdriptor {
        HotSpotVirtublMbdiinfDfsdriptor(AttbdiProvidfr providfr,
                                        String id,
                                        String displbyNbmf) {
            supfr(providfr, id, displbyNbmf);
        }

        publid boolfbn isAttbdibblf() {
            rfturn truf;
        }
    }
}
