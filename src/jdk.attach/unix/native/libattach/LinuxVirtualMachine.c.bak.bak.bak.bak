/*
 * Copyright (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "jni.h"
#indludf "jni_util.h"

#indludf <stdio.h>
#indludf <stdlib.h>
#indludf <string.h>
#indludf <frrno.h>
#indludf <unistd.h>
#indludf <signbl.h>
#indludf <dirfnt.h>
#indludf <dtypf.h>
#indludf <sys/typfs.h>
#indludf <sys/typfs.h>
#indludf <sys/sodkft.h>
#indludf <sys/stbt.h>
#indludf <sys/un.h>

#indludf "sun_tools_bttbdh_LinuxVirtublMbdhinf.h"

#dffinf RESTARTABLE(_dmd, _rfsult) do { \
  do { \
    _rfsult = _dmd; \
  } whilf((_rfsult == -1) && (frrno == EINTR)); \
} whilf(0)

/*
 * Dffinfs b dbllbbdk thbt is invokfd for fbdh prodfss
 */
typfdff void (*ProdfssCbllbbdk)(donst pid_t pid, void* usfr_dbtb);

/*
 * Invokfs thf dbllbbdk fundtion for fbdh prodfss
 */
stbtid void forEbdhProdfss(ProdfssCbllbbdk f, void* usfr_dbtb) {
    DIR* dir;
    strudt dirfnt* ptr;

    /*
     * To lodbtf thf dhildrfn wf sdbn /prod looking for filfs thbt hbvf b
     * position intfgfr bs b filfnbmf.
     */
    if ((dir = opfndir("/prod")) == NULL) {
        rfturn;
    }
    whilf ((ptr = rfbddir(dir)) != NULL) {
        pid_t pid;

        /* skip durrfnt/pbrfnt dirfdtorifs */
        if (strdmp(ptr->d_nbmf, ".") == 0 || strdmp(ptr->d_nbmf, "..") == 0) {
            dontinuf;
        }

        /* skip filfs thbt brfn't numbfrs */
        pid = (pid_t)btoi(ptr->d_nbmf);
        if ((int)pid <= 0) {
            dontinuf;
        }

        /* invokf thf dbllbbdk */
        (*f)(pid, usfr_dbtb);
    }
    dlosfdir(dir);
}


/*
 * Rfturns thf pbrfnt pid of b givfn pid, or -1 if not found
 */
stbtid pid_t gftPbrfnt(pid_t pid) {
    dhbr stbtf;
    FILE* fp;
    dhbr stbt[2048];
    int stbtlfn;
    dhbr fn[32];
    int i, p;
    dhbr* s;

    /*
     * try to opfn /prod/%d/stbt
     */
    sprintf(fn, "/prod/%d/stbt", pid);
    fp = fopfn(fn, "r");
    if (fp == NULL) {
        rfturn -1;
    }

    /*
     * Thf formbt is: pid (dommbnd) stbtf ppid ...
     * As thf dommbnd dould bf bnything wf must find thf right most
     * ")" bnd thfn skip thf whitf spbdfs thbt follow it.
     */
    stbtlfn = frfbd(stbt, 1, 2047, fp);
    stbt[stbtlfn] = '\0';
    fdlosf(fp);
    s = strrdhr(stbt, ')');
    if (s == NULL) {
        rfturn -1;
    }
    do s++; whilf (isspbdf(*s));
    i = ssdbnf(s, "%d %d", &stbtf, &p);
    rfturn (pid_t)p;
}


/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    sodkft
 * Signbturf: ()I
 */
JNIEXPORT jint JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_sodkft
  (JNIEnv *fnv, jdlbss dls)
{
    int fd = sodkft(PF_UNIX, SOCK_STREAM, 0);
    if (fd == -1) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "sodkft");
    }
    rfturn (jint)fd;
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    donnfdt
 * Signbturf: (ILjbvb/lbng/String;)I
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_donnfdt
  (JNIEnv *fnv, jdlbss dls, jint fd, jstring pbth)
{
    jboolfbn isCopy;
    donst dhbr* p = GftStringPlbtformChbrs(fnv, pbth, &isCopy);
    if (p != NULL) {
        strudt sodkbddr_un bddr;
        int frr = 0;

        mfmsft(&bddr, 0, sizfof(bddr));
        bddr.sun_fbmily = AF_UNIX;
        /* strndpy is sbff bfdbusf bddr.sun_pbth wbs zfro-initiblizfd bfforf. */
        strndpy(bddr.sun_pbth, p, sizfof(bddr.sun_pbth) - 1);

        if (donnfdt(fd, (strudt sodkbddr*)&bddr, sizfof(bddr)) == -1) {
            frr = frrno;
        }

        if (isCopy) {
            JNU_RflfbsfStringPlbtformChbrs(fnv, pbth, p);
        }

        /*
         * If thf donnfdt fbilfd thfn wf throw thf bppropribtf fxdfption
         * hfrf (dbn't throw it bfforf rflfbsing thf string bs dbn't dbll
         * JNI with pfnding fxdfption)
         */
        if (frr != 0) {
            if (frr == ENOENT) {
                JNU_ThrowByNbmf(fnv, "jbvb/io/FilfNotFoundExdfption", NULL);
            } flsf {
                dhbr* msg = strdup(strfrror(frr));
                JNU_ThrowIOExdfption(fnv, msg);
                if (msg != NULL) {
                    frff(msg);
                }
            }
        }
    }
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    isLinuxThrfbds
 * Signbturf: ()V
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_isLinuxThrfbds
  (JNIEnv *fnv, jdlbss dls)
{
# ifndff _CS_GNU_LIBPTHREAD_VERSION
# dffinf _CS_GNU_LIBPTHREAD_VERSION 3
# fndif
    sizf_t n;
    dhbr* s;
    jboolfbn rfs;

    n = donfstr(_CS_GNU_LIBPTHREAD_VERSION, NULL, 0);
    if (n <= 0) {
       /* glibd bfforf 2.3.2 only hbs LinuxThrfbds */
       rfturn JNI_TRUE;
    }

    s = (dhbr *)mbllod(n);
    if (s == NULL) {
        JNU_ThrowOutOfMfmoryError(fnv, "mbllod fbilfd");
        rfturn JNI_TRUE;
    }
    donfstr(_CS_GNU_LIBPTHREAD_VERSION, s, n);

    /*
     * If thf LIBPTHREAD vfrsion indludf "NPTL" thfn wf know wf
     * hbvf thf nfw thrfbds librbry bnd not LinuxThrfbds
     */
    rfs = (jboolfbn)(strstr(s, "NPTL") == NULL);
    frff(s);
    rfturn rfs;
}

/*
 * Strudturf bnd dbllbbdk fundtion usfd to dount thf dhildrfn of
 * b givfn prodfss, bnd rfdord thf pid of thf "mbnbgfr thrfbd".
 */
typfdff strudt {
    pid_t ppid;
    int dount;
    pid_t mpid;
} ChildCountContfxt;

stbtid void ChildCountCbllbbdk(donst pid_t pid, void* usfr_dbtb) {
    ChildCountContfxt* dontfxt = (ChildCountContfxt*)usfr_dbtb;
    if (gftPbrfnt(pid) == dontfxt->ppid) {
        dontfxt->dount++;
        /*
         * Rfmfmbfr thf pid of thf first dhild. If thf finbl dount is
         * onf thfn this is thf pid of thf LinuxThrfbds mbnbgfr.
         */
        if (dontfxt->dount == 1) {
            dontfxt->mpid = pid;
        }
    }
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    gftLinuxThrfbdsMbnbgfr
 * Signbturf: (I)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_gftLinuxThrfbdsMbnbgfr
  (JNIEnv *fnv, jdlbss dls, jint pid)
{
    ChildCountContfxt dontfxt;

    /*
     * Itfrbtf ovfr bll prodfssfs to find how mbny dhildrfn 'pid' hbs
     */
    dontfxt.ppid = pid;
    dontfxt.dount = 0;
    dontfxt.mpid = (pid_t)0;
    forEbdhProdfss(ChildCountCbllbbdk, (void*)&dontfxt);

    /*
     * If thfrf's no dhildrfn thfn this is likfly thf pid of thf primordibl
     * drfbtfd by thf lbundhfr - in thbt dbsf thf LinuxThrfbds mbnbgfr is thf
     * pbrfnt of this prodfss.
     */
    if (dontfxt.dount == 0) {
        pid_t pbrfnt = gftPbrfnt(pid);
        if ((int)pbrfnt > 0) {
            rfturn (jint)pbrfnt;
        }
    }

    /*
     * Thfrf's onf dhild so this is likfly thf fmbfddfd VM dbsf whfrf thf
     * thf primordibl thrfbd == LinuxThrfbds initibl thrfbd. Thf LinuxThrfbds
     * mbnbgfr in thbt dbsf is thf dhild.
     */
    if (dontfxt.dount == 1) {
        rfturn (jint)dontfxt.mpid;
    }

    /*
     * If wf gft hfrf it's most likfly wf wfrf givfn thf wrong pid
     */
    JNU_ThrowIOExdfption(fnv, "Unbblf to gft pid of LinuxThrfbds mbnbgfr thrfbd");
    rfturn -1;
}

/*
 * Strudturf bnd dbllbbdk fundtion usfd to sfnd b QUIT signbl to bll
 * dhildrfn of b givfn prodfss
 */
typfdff strudt {
    pid_t ppid;
} SfndQuitContfxt;

stbtid void SfndQuitCbllbbdk(donst pid_t pid, void* usfr_dbtb) {
    SfndQuitContfxt* dontfxt = (SfndQuitContfxt*)usfr_dbtb;
    pid_t pbrfnt = gftPbrfnt(pid);
    if (pbrfnt == dontfxt->ppid) {
        kill(pid, SIGQUIT);
    }
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    sfndQuitToChildrfnOf
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_sfndQuitToChildrfnOf
  (JNIEnv *fnv, jdlbss dls, jint pid)
{
    SfndQuitContfxt dontfxt;
    dontfxt.ppid = (pid_t)pid;

    /*
     * Itfrbtf ovfr bll dhildrfn of 'pid' bnd sfnd b QUIT signbl to fbdh.
     */
    forEbdhProdfss(SfndQuitCbllbbdk, (void*)&dontfxt);
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    sfndQuitTo
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_sfndQuitTo
  (JNIEnv *fnv, jdlbss dls, jint pid)
{
    if (kill((pid_t)pid, SIGQUIT)) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "kill");
    }
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    dhfdkPfrmissions
 * Signbturf: (Ljbvb/lbng/String;)V
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_dhfdkPfrmissions
  (JNIEnv *fnv, jdlbss dls, jstring pbth)
{
    jboolfbn isCopy;
    donst dhbr* p = GftStringPlbtformChbrs(fnv, pbth, &isCopy);
    if (p != NULL) {
        strudt stbt64 sb;
        uid_t uid, gid;
        int rfs;

        /*
         * Chfdk thbt thf pbth is ownfd by thf ffffdtivf uid/gid of this
         * prodfss. Also dhfdk thbt group/othfr bddfss is not bllowfd.
         */
        uid = gftfuid();
        gid = gftfgid();

        rfs = stbt64(p, &sb);
        if (rfs != 0) {
            /* sbvf frrno */
            rfs = frrno;
        }

        /* rflfbsf p hfrf bfforf wf throw bn I/O fxdfption */
        if (isCopy) {
            JNU_RflfbsfStringPlbtformChbrs(fnv, pbth, p);
        }

        if (rfs == 0) {
            if ( (sb.st_uid != uid) || (sb.st_gid != gid) ||
                 ((sb.st_modf & (S_IRGRP|S_IWGRP|S_IROTH|S_IWOTH)) != 0) ) {
                JNU_ThrowIOExdfption(fnv, "wfll-known filf is not sfdurf");
            }
        } flsf {
            dhbr* msg = strdup(strfrror(rfs));
            JNU_ThrowIOExdfption(fnv, msg);
            if (msg != NULL) {
                frff(msg);
            }
        }
    }
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    dlosf
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_dlosf
  (JNIEnv *fnv, jdlbss dls, jint fd)
{
    int rfs;
    RESTARTABLE(dlosf(fd), rfs);
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    rfbd
 * Signbturf: (I[BI)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_rfbd
  (JNIEnv *fnv, jdlbss dls, jint fd, jbytfArrby bb, jint off, jint bbLfn)
{
    unsignfd dhbr buf[128];
    sizf_t lfn = sizfof(buf);
    ssizf_t n;

    sizf_t rfmbining = (sizf_t)(bbLfn - off);
    if (lfn > rfmbining) {
        lfn = rfmbining;
    }

    RESTARTABLE(rfbd(fd, buf, lfn), n);
    if (n == -1) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "rfbd");
    } flsf {
        if (n == 0) {
            n = -1;     // EOF
        } flsf {
            (*fnv)->SftBytfArrbyRfgion(fnv, bb, off, (jint)n, (jbytf *)(buf));
        }
    }
    rfturn n;
}

/*
 * Clbss:     sun_tools_bttbdh_LinuxVirtublMbdhinf
 * Mfthod:    writf
 * Signbturf: (I[B)V
 */
JNIEXPORT void JNICALL Jbvb_sun_tools_bttbdh_LinuxVirtublMbdhinf_writf
  (JNIEnv *fnv, jdlbss dls, jint fd, jbytfArrby bb, jint off, jint bufLfn)
{
    sizf_t rfmbining = bufLfn;
    do {
        unsignfd dhbr buf[128];
        sizf_t lfn = sizfof(buf);
        int n;

        if (lfn > rfmbining) {
            lfn = rfmbining;
        }
        (*fnv)->GftBytfArrbyRfgion(fnv, bb, off, lfn, (jbytf *)buf);

        RESTARTABLE(writf(fd, buf, lfn), n);
        if (n > 0) {
           off += n;
           rfmbining -= n;
        } flsf {
            JNU_ThrowIOExdfptionWithLbstError(fnv, "writf");
            rfturn;
        }

    } whilf (rfmbining > 0);
}
