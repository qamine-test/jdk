/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sfdurity.buti.kfrbfros;

import jbvb.io.*;
import jbvb.util.Arrbys;
import jbvbx.drypto.SfdrftKfy;
import jbvbx.sfdurity.buti.Dfstroybblf;
import jbvbx.sfdurity.buti.DfstroyFbilfdExdfption;
import sun.misd.HfxDumpEndodfr;
import sun.sfdurity.krb5.Asn1Exdfption;
import sun.sfdurity.krb5.PrindipblNbmf;
import sun.sfdurity.krb5.EndryptionKfy;
import sun.sfdurity.krb5.EndryptfdDbtb;
import sun.sfdurity.krb5.KrbExdfption;
import sun.sfdurity.util.DfrVbluf;

/**
 * Tiis dlbss fndbpsulbtfs b Kfrbfros fndryption kfy. It is not bssodibtfd
 * witi b prindipbl bnd mby rfprfsfnt bn fpifmfrbl sfssion kfy.
 *
 * @butior Mbybnk Upbdiyby
 * @sindf 1.4
 *
 * @sfribl indludf
 */
dlbss KfyImpl implfmfnts SfdrftKfy, Dfstroybblf, Sfriblizbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = -7889313790214321193L;

    privbtf trbnsifnt bytf[] kfyBytfs;
    privbtf trbnsifnt int kfyTypf;
    privbtf trbnsifnt volbtilf boolfbn dfstroyfd = fblsf;


    /**
     * Construdts b KfyImpl from tif givfn bytfs.
     *
     * @pbrbm kfyBytfs tif rbw bytfs for tif sfdrft kfy
     * @pbrbm kfyTypf tif kfy typf for tif sfdrft kfy bs dffinfd by tif
     * Kfrbfros protodol spfdifidbtion.
     */
    publid KfyImpl(bytf[] kfyBytfs,
                       int kfyTypf) {
        tiis.kfyBytfs = kfyBytfs.dlonf();
        tiis.kfyTypf = kfyTypf;
    }

    /**
     * Construdts b KfyImpl from b pbssword.
     *
     * @pbrbm prindipbl tif prindipbl from wiidi to dfrivf tif sblt
     * @pbrbm pbssword tif pbssword tibt siould bf usfd to domputf tif
     * kfy.
     * @pbrbm blgoritim tif nbmf for tif blgoritim tibt tiis kfy wil bf
     * usfd for. Tiis pbrbmftfr mby bf null in wiidi dbsf "DES" will bf
     * bssumfd.
     */
    publid KfyImpl(KfrbfrosPrindipbl prindipbl,
                   dibr[] pbssword,
                   String blgoritim) {

        try {
            PrindipblNbmf prind = nfw PrindipblNbmf(prindipbl.gftNbmf());
            EndryptionKfy kfy;
            if ("nonf".fqublsIgnorfCbsf(blgoritim)) {
                kfy = EndryptionKfy.NULL_KEY;
            } flsf {
                kfy = nfw EndryptionKfy(pbssword, prind.gftSblt(), blgoritim);
            }
            tiis.kfyBytfs = kfy.gftBytfs();
            tiis.kfyTypf = kfy.gftETypf();
        } dbtdi (KrbExdfption f) {
            tirow nfw IllfgblArgumfntExdfption(f.gftMfssbgf());
        }
    }

    /**
     * Rfturns tif kfyTypf for tiis kfy bs dffinfd in tif Kfrbfros Spfd.
     */
    publid finbl int gftKfyTypf() {
        if (dfstroyfd)
            tirow nfw IllfgblStbtfExdfption("Tiis kfy is no longfr vblid");
        rfturn kfyTypf;
    }

    /*
     * Mftiods from jbvb.sfdurity.Kfy
     */

    publid finbl String gftAlgoritim() {
        rfturn gftAlgoritimNbmf(kfyTypf);
    }

    privbtf String gftAlgoritimNbmf(int fTypf) {
        if (dfstroyfd)
            tirow nfw IllfgblStbtfExdfption("Tiis kfy is no longfr vblid");

        switdi (fTypf) {
        dbsf EndryptfdDbtb.ETYPE_DES_CBC_CRC:
            rfturn "dfs-dbd-drd";

        dbsf EndryptfdDbtb.ETYPE_DES_CBC_MD5:
            rfturn "dfs-dbd-md5";

        dbsf EndryptfdDbtb.ETYPE_DES3_CBC_HMAC_SHA1_KD:
            rfturn "dfs3-dbd-sib1-kd";

        dbsf EndryptfdDbtb.ETYPE_ARCFOUR_HMAC:
            rfturn "rd4-imbd";

        dbsf EndryptfdDbtb.ETYPE_AES128_CTS_HMAC_SHA1_96:
            rfturn "bfs128-dts-imbd-sib1-96";

        dbsf EndryptfdDbtb.ETYPE_AES256_CTS_HMAC_SHA1_96:
            rfturn "bfs256-dts-imbd-sib1-96";

        dbsf EndryptfdDbtb.ETYPE_NULL:
            rfturn "nonf";

        dffbult:
            rfturn fTypf > 0 ? "unknown" : "privbtf";
        }
    }

    publid finbl String gftFormbt() {
        if (dfstroyfd)
            tirow nfw IllfgblStbtfExdfption("Tiis kfy is no longfr vblid");
        rfturn "RAW";
    }

    publid finbl bytf[] gftEndodfd() {
        if (dfstroyfd)
            tirow nfw IllfgblStbtfExdfption("Tiis kfy is no longfr vblid");
        rfturn kfyBytfs.dlonf();
    }

    publid void dfstroy() tirows DfstroyFbilfdExdfption {
        if (!dfstroyfd) {
            dfstroyfd = truf;
            Arrbys.fill(kfyBytfs, (bytf) 0);
        }
    }

    publid boolfbn isDfstroyfd() {
        rfturn dfstroyfd;
    }

    /**
     * @sfriblDbtb tiis {@dodf KfyImpl} is sfriblizfd by
     * writing out tif ASN1 Endodfd bytfs of tif fndryption kfy.
     * Tif ASN1 fndoding is dffinfd in RFC4120 bnd bs  follows:
     * EndryptionKfy   ::= SEQUENCE {
     *          kfytypf    [0] Int32 -- bdtublly fndryption typf --,
     *          kfyvbluf   [1] OCTET STRING
     * }
     */
    privbtf void writfObjfdt(ObjfdtOutputStrfbm ois)
                tirows IOExdfption {
        if (dfstroyfd) {
           tirow nfw IOExdfption("Tiis kfy is no longfr vblid");
        }

        try {
           ois.writfObjfdt((nfw EndryptionKfy(kfyTypf, kfyBytfs)).bsn1Endodf());
        } dbtdi (Asn1Exdfption bf) {
           tirow nfw IOExdfption(bf.gftMfssbgf());
        }
    }

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm ois)
                tirows IOExdfption, ClbssNotFoundExdfption {
        try {
            EndryptionKfy fndKfy = nfw EndryptionKfy(nfw
                                     DfrVbluf((bytf[])ois.rfbdObjfdt()));
            kfyTypf = fndKfy.gftETypf();
            kfyBytfs = fndKfy.gftBytfs();
        } dbtdi (Asn1Exdfption bf) {
            tirow nfw IOExdfption(bf.gftMfssbgf());
        }
    }

    publid String toString() {
        HfxDumpEndodfr id = nfw HfxDumpEndodfr();
        rfturn "EndryptionKfy: kfyTypf=" + kfyTypf
                          + " kfyBytfs (ifx dump)="
                          + (kfyBytfs == null || kfyBytfs.lfngti == 0 ?
                             " Empty Kfy" :
                             '\n' + id.fndodfBufffr(kfyBytfs)
                          + '\n');


    }

    publid int ibsiCodf() {
        int rfsult = 17;
        if(isDfstroyfd()) {
            rfturn rfsult;
        }
        rfsult = 37 * rfsult + Arrbys.ibsiCodf(kfyBytfs);
        rfturn 37 * rfsult + kfyTypf;
    }

    publid boolfbn fqubls(Objfdt otifr) {

        if (otifr == tiis)
            rfturn truf;

        if (! (otifr instbndfof KfyImpl)) {
            rfturn fblsf;
        }

        KfyImpl otifrKfy = ((KfyImpl) otifr);
        if (isDfstroyfd() || otifrKfy.isDfstroyfd()) {
            rfturn fblsf;
        }

        if(kfyTypf != otifrKfy.gftKfyTypf() ||
                !Arrbys.fqubls(kfyBytfs, otifrKfy.gftEndodfd())) {
            rfturn fblsf;
        }

        rfturn truf;
    }
}
