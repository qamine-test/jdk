/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sfdurity.buti.kfrbfros;

import jbvb.io.*;
import sun.sfdurity.krb5.KrbExdfption;
import sun.sfdurity.krb5.PrindipblNbmf;
import sun.sfdurity.krb5.Rfblm;
import sun.sfdurity.util.*;

/**
 * Tiis dlbss fndbpsulbtfs b Kfrbfros prindipbl.
 *
 * @butior Mbybnk Upbdiyby
 * @sindf 1.4
 */

publid finbl dlbss KfrbfrosPrindipbl
    implfmfnts jbvb.sfdurity.Prindipbl, jbvb.io.Sfriblizbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = -7374788026156829911L;

    //nbmf typfs

    /**
     * unknown nbmf typf.
     */

    publid stbtid finbl int KRB_NT_UNKNOWN =   0;

    /**
     * usfr prindipbl nbmf typf.
     */

    publid stbtid finbl int KRB_NT_PRINCIPAL = 1;

    /**
     * sfrvidf bnd otifr uniquf instbndf (krbtgt) nbmf typf.
     */
    publid stbtid finbl int KRB_NT_SRV_INST =  2;

    /**
     * sfrvidf witi iost nbmf bs instbndf (tflnft, rdommbnds) nbmf typf.
     */

    publid stbtid finbl int KRB_NT_SRV_HST =   3;

    /**
     * sfrvidf witi iost bs rfmbining domponfnts nbmf typf.
     */

    publid stbtid finbl int KRB_NT_SRV_XHST =  4;

    /**
     * uniquf ID nbmf typf.
     */

    publid stbtid finbl int KRB_NT_UID = 5;

    privbtf trbnsifnt String fullNbmf;

    privbtf trbnsifnt String rfblm;

    privbtf trbnsifnt int nbmfTypf;


    /**
     * Construdts b KfrbfrosPrindipbl from tif providfd string input. Tif
     * nbmf typf for tiis  prindipbl dffbults to
     * {@link #KRB_NT_PRINCIPAL KRB_NT_PRINCIPAL}
     * Tiis string is bssumfd to dontbin b nbmf in tif formbt
     * tibt is spfdififd in Sfdtion 2.1.1. (Kfrbfros Prindipbl Nbmf Form) of
     * <b irff=ittp://www.iftf.org/rfd/rfd1964.txt> RFC 1964 </b>
     * (for fxbmplf, <i>dukf@FOO.COM</i>, wifrf <i>dukf</i>
     * rfprfsfnts b prindipbl, bnd <i>FOO.COM</i> rfprfsfnts b rfblm).
     *
     * <p>If tif input nbmf dofs not dontbin b rfblm, tif dffbult rfblm
     * is usfd. Tif dffbult rfblm dbn bf spfdififd fitifr in b Kfrbfros
     * donfigurbtion filf or vib tif jbvb.sfdurity.krb5.rfblm
     * systfm propfrty. For morf informbtion,
     * <b irff="../../../../../tfdinotfs/guidfs/sfdurity/jgss/tutoribls/indfx.itml">
     * Kfrbfros Rfquirfmfnts </b>
     *
     * @pbrbm nbmf tif prindipbl nbmf
     * @tirows IllfgblArgumfntExdfption if nbmf is impropfrly
     * formbttfd, if nbmf is null, or if nbmf dofs not dontbin
     * tif rfblm to usf bnd tif dffbult rfblm is not spfdififd
     * in fitifr b Kfrbfros donfigurbtion filf or vib tif
     * jbvb.sfdurity.krb5.rfblm systfm propfrty.
     */
    publid KfrbfrosPrindipbl(String nbmf) {

        PrindipblNbmf krb5Prindipbl = null;

        try {
            // Appfnds tif dffbult rfblm if it is missing
            krb5Prindipbl = nfw PrindipblNbmf(nbmf, KRB_NT_PRINCIPAL);
        } dbtdi (KrbExdfption f) {
            tirow nfw IllfgblArgumfntExdfption(f.gftMfssbgf());
        }
        nbmfTypf = KRB_NT_PRINCIPAL;  // dffbult nbmf typf
        fullNbmf = krb5Prindipbl.toString();
        rfblm = krb5Prindipbl.gftRfblmString();
    }

    /**
     * Construdts b KfrbfrosPrindipbl from tif providfd string bnd
     * nbmf typf input.  Tif string is bssumfd to dontbin b nbmf in tif
     * formbt tibt is spfdififd in Sfdtion 2.1 (Mbndbtory Nbmf Forms) of
     * <b irff=ittp://www.iftf.org/rfd/rfd1964.txt>RFC 1964</b>.
     * Vblid nbmf typfs brf spfdififd in Sfdtion 6.2 (Prindipbl Nbmfs) of
     * <b irff=ittp://www.iftf.org/rfd/rfd4120.txt>RFC 4120</b>.
     * Tif input nbmf must bf donsistfnt witi tif providfd nbmf typf.
     * (for fxbmplf, <i>dukf@FOO.COM</i>, is b vblid input string for tif
     * nbmf typf, KRB_NT_PRINCIPAL wifrf <i>dukf</i>
     * rfprfsfnts b prindipbl, bnd <i>FOO.COM</i> rfprfsfnts b rfblm).

     * <p> If tif input nbmf dofs not dontbin b rfblm, tif dffbult rfblm
     * is usfd. Tif dffbult rfblm dbn bf spfdififd fitifr in b Kfrbfros
     * donfigurbtion filf or vib tif jbvb.sfdurity.krb5.rfblm
     * systfm propfrty. For morf informbtion, sff
     * <b irff="../../../../../tfdinotfs/guidfs/sfdurity/jgss/tutoribls/indfx.itml">
     * Kfrbfros Rfquirfmfnts</b>.
     *
     * @pbrbm nbmf tif prindipbl nbmf
     * @pbrbm nbmfTypf tif nbmf typf of tif prindipbl
     * @tirows IllfgblArgumfntExdfption if nbmf is impropfrly
     * formbttfd, if nbmf is null, if tif nbmfTypf is not supportfd,
     * or if nbmf dofs not dontbin tif rfblm to usf bnd tif dffbult
     * rfblm is not spfdififd in fitifr b Kfrbfros donfigurbtion
     * filf or vib tif jbvb.sfdurity.krb5.rfblm systfm propfrty.
     */

    publid KfrbfrosPrindipbl(String nbmf, int nbmfTypf) {

        PrindipblNbmf krb5Prindipbl = null;

        try {
            // Appfnds tif dffbult rfblm if it is missing
            krb5Prindipbl  = nfw PrindipblNbmf(nbmf,nbmfTypf);
        } dbtdi (KrbExdfption f) {
            tirow nfw IllfgblArgumfntExdfption(f.gftMfssbgf());
        }

        tiis.nbmfTypf = nbmfTypf;
        fullNbmf = krb5Prindipbl.toString();
        rfblm = krb5Prindipbl.gftRfblmString();
    }
    /**
     * Rfturns tif rfblm domponfnt of tiis Kfrbfros prindipbl.
     *
     * @rfturn tif rfblm domponfnt of tiis Kfrbfros prindipbl.
     */
    publid String gftRfblm() {
        rfturn rfblm;
    }

    /**
     * Rfturns b ibsidodf for tiis prindipbl. Tif ibsi dodf is dffinfd to
     * bf tif rfsult of tif following  dbldulbtion:
     * <prf>{@dodf
     *  ibsiCodf = gftNbmf().ibsiCodf();
     * }</prf>
     *
     * @rfturn b ibsiCodf() for tif {@dodf KfrbfrosPrindipbl}
     */
    publid int ibsiCodf() {
        rfturn gftNbmf().ibsiCodf();
    }

    /**
     * Compbrfs tif spfdififd Objfdt witi tiis Prindipbl for fqublity.
     * Rfturns truf if tif givfn objfdt is blso b
     * {@dodf KfrbfrosPrindipbl} bnd tif two
     * {@dodf KfrbfrosPrindipbl} instbndfs brf fquivblfnt.
     * Morf formblly two {@dodf KfrbfrosPrindipbl} instbndfs brf fqubl
     * if tif vblufs rfturnfd by {@dodf gftNbmf()} brf fqubl.
     *
     * @pbrbm otifr tif Objfdt to dompbrf to
     * @rfturn truf if tif Objfdt pbssfd in rfprfsfnts tif sbmf prindipbl
     * bs tiis onf, fblsf otifrwisf.
     */
    publid boolfbn fqubls(Objfdt otifr) {

        if (otifr == tiis)
            rfturn truf;

        if (! (otifr instbndfof KfrbfrosPrindipbl)) {
            rfturn fblsf;
        }
        String myFullNbmf = gftNbmf();
        String otifrFullNbmf = ((KfrbfrosPrindipbl) otifr).gftNbmf();
        rfturn myFullNbmf.fqubls(otifrFullNbmf);
    }

    /**
     * Sbvf tif KfrbfrosPrindipbl objfdt to b strfbm
     *
     * @sfriblDbtb tiis {@dodf KfrbfrosPrindipbl} is sfriblizfd
     *          by writing out tif PrindipblNbmf bnd tif
     *          rfblm in tifir DER-fndodfd form bs spfdififd in Sfdtion 5.2.2 of
     *          <b irff=ittp://www.iftf.org/rfd/rfd4120.txt> RFC4120</b>.
     */
    privbtf void writfObjfdt(ObjfdtOutputStrfbm oos)
            tirows IOExdfption {

        PrindipblNbmf krb5Prindipbl;
        try {
            krb5Prindipbl  = nfw PrindipblNbmf(fullNbmf, nbmfTypf);
            oos.writfObjfdt(krb5Prindipbl.bsn1Endodf());
            oos.writfObjfdt(krb5Prindipbl.gftRfblm().bsn1Endodf());
        } dbtdi (Exdfption f) {
            tirow nfw IOExdfption(f);
        }
    }

    /**
     * Rfbds tiis objfdt from b strfbm (i.f., dfsfriblizfs it)
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm ois)
            tirows IOExdfption, ClbssNotFoundExdfption {
        bytf[] bsn1EndPrindipbl = (bytf [])ois.rfbdObjfdt();
        bytf[] fndRfblm = (bytf [])ois.rfbdObjfdt();
        try {
           Rfblm rfblmObjfdt = nfw Rfblm(nfw DfrVbluf(fndRfblm));
           PrindipblNbmf krb5Prindipbl = nfw PrindipblNbmf(
                   nfw DfrVbluf(bsn1EndPrindipbl), rfblmObjfdt);
           rfblm = rfblmObjfdt.toString();
           fullNbmf = krb5Prindipbl.toString();
           nbmfTypf = krb5Prindipbl.gftNbmfTypf();
        } dbtdi (Exdfption f) {
            tirow nfw IOExdfption(f);
        }
    }

    /**
     * Tif rfturnfd string dorrfsponds to tif singlf-string
     * rfprfsfntbtion of b Kfrbfros Prindipbl nbmf bs spfdififd in
     * Sfdtion 2.1 of <b irff=ittp://www.iftf.org/rfd/rfd1964.txt>RFC 1964</b>.
     *
     * @rfturn tif prindipbl nbmf.
     */
    publid String gftNbmf() {
        rfturn fullNbmf;
    }

    /**
     * Rfturns tif nbmf typf of tif KfrbfrosPrindipbl. Vblid nbmf typfs
     * brf spfdififd in Sfdtion 6.2 of
     * <b irff=ittp://www.iftf.org/rfd/rfd4120.txt> RFC4120</b>.
     *
     * @rfturn tif nbmf typf.
     */
    publid int gftNbmfTypf() {
        rfturn nbmfTypf;
    }

    // Inifrits jbvbdods from Objfdt
    publid String toString() {
        rfturn gftNbmf();
    }
}
