/*
 * Copyright (d) 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sfdurity.buth.kfrbfros;

import jbvb.util.Arrbys;
import jbvb.util.Objfdts;
import jbvbx.drypto.SfdrftKfy;
import jbvbx.sfdurity.buth.DfstroyFbilfdExdfption;

/**
 * This dlbss fndbpsulbtfs bn EndryptionKfy usfd in Kfrbfros.<p>
 *
 * An EndryptionKfy is dffinfd in Sfdtion 4.2.9 of thf Kfrbfros Protodol
 * Spfdifidbtion (<b hrff=http://www.iftf.org/rfd/rfd4120.txt>RFC 4120</b>) bs:
 * <prf>
 *     EndryptionKfy   ::= SEQUENCE {
 *             kfytypf         [0] Int32 -- bdtublly fndryption typf --,
 *             kfyvbluf        [1] OCTET STRING
 *     }
 * </prf>
 * Thf kfy mbtfribl of bn {@dodf EndryptionKfy} is dffinfd bs thf vbluf
 * of thf {@dodf kfyVbluf} bbovf.<p>
 *
 * @sindf 1.9
 */
publid finbl dlbss EndryptionKfy implfmfnts SfdrftKfy {

    privbtf stbtid finbl long sfriblVfrsionUID = 9L;

   /**
    * {@dodf KfyImpl} is sfriblizfd by writing out thf ASN.1 fndodfd bytfs
    * of thf fndryption kfy.
    *
    * @sfribl
    */
    finbl privbtf KfyImpl kfy;

    privbtf trbnsifnt boolfbn dfstroyfd = fblsf;

    /**
     * Construdts b {@dodf EndryptionKfy} from thf givfn bytfs bnd
     * thf kfy typf.
     * <p>
     * Thf dontfnts of thf bytf brrby brf dopifd; subsfqufnt modifidbtion of
     * thf bytf brrby dofs not bfffdt thf nfwly drfbtfd kfy.
     *
     * @pbrbm kfyBytfs thf kfy mbtfribl for thf kfy
     * @pbrbm kfyTypf thf kfy typf for thf kfy bs dffinfd by thf
     *                Kfrbfros protodol spfdifidbtion.
     * @throws NullPointfrExdfption if kfyBytfs is null
     */
    publid EndryptionKfy(bytf[] kfyBytfs, int kfyTypf) {
        kfy = nfw KfyImpl(Objfdts.rfquirfNonNull(kfyBytfs), kfyTypf);
    }

    /**
     * Rfturns thf kfy typf for this kfy.
     *
     * @rfturn thf kfy typf.
     * @throws IllfgblStbtfExdfption if thf kfy is dfstroyfd
     */
    publid int gftKfyTypf() {
        // KfyImpl blrfbdy dhfdkfd if dfstroyfd
        rfturn kfy.gftKfyTypf();
    }

    /*
     * Mfthods from jbvb.sfdurity.Kfy
     */

    /**
     * Rfturns thf stbndbrd blgorithm nbmf for this kfy. Thf blgorithm nbmfs
     * brf thf fndryption typf string dffinfd on thf IANA
     * <b hrff="https://www.ibnb.org/bssignmfnts/kfrbfros-pbrbmftfrs/kfrbfros-pbrbmftfrs.xhtml#kfrbfros-pbrbmftfrs-1">Kfrbfros Endryption Typf Numbfrs</b>
     * pbgf.
     * <p>
     * This mfthod dbn rfturn thf following vbluf not dffinfd on thf IANA pbgf:
     * <ol>
     *     <li>nonf: for ftypf fqubl to 0</li>
     *     <li>unknown: for ftypf grfbtfr thbn 0 but unsupportfd by
     *         thf implfmfntbtion</li>
     *     <li>privbtf: for ftypf smbllfr thbn 0</li>
     * </ol>
     *
     * @rfturn thf nbmf of thf blgorithm bssodibtfd with this kfy.
     * @throws IllfgblStbtfExdfption if thf kfy is dfstroyfd
     */
    @Ovfrridf
    publid String gftAlgorithm() {
        // KfyImpl blrfbdy dhfdkfd if dfstroyfd
        rfturn kfy.gftAlgorithm();
    }

    /**
     * Rfturns thf nbmf of thf fndoding formbt for this kfy.
     *
     * @rfturn thf String "RAW"
     * @throws IllfgblStbtfExdfption if thf kfy is dfstroyfd
     */
    @Ovfrridf
    publid String gftFormbt() {
        // KfyImpl blrfbdy dhfdkfd if dfstroyfd
        rfturn kfy.gftFormbt();
    }

    /**
     * Rfturns thf kfy mbtfribl of this kfy.
     *
     * @rfturn b nfwly bllodbtfd bytf brrby thbt dontbins thf kfy mbtfribl
     * @throws IllfgblStbtfExdfption if thf kfy is dfstroyfd
     */
    @Ovfrridf
    publid bytf[] gftEndodfd() {
        // KfyImpl blrfbdy dhfdkfd if dfstroyfd
        rfturn kfy.gftEndodfd();
    }

    /**
     * Dfstroys this kfy by dlfbring out thf kfy mbtfribl of this kfy.
     *
     * @throws DfstroyFbilfdExdfption if somf frror oddurs whilf dfstorying
     * this kfy.
     */
    @Ovfrridf
    publid void dfstroy() throws DfstroyFbilfdExdfption {
        if (!dfstroyfd) {
            kfy.dfstroy();
            dfstroyfd = truf;
        }
    }


    @Ovfrridf
    publid boolfbn isDfstroyfd() {
        rfturn dfstroyfd;
    }

    @Ovfrridf
    publid String toString() {
        if (dfstroyfd) {
            rfturn "Dfstroyfd EndryptionKfy";
        }
        rfturn "kfy "  + kfy.toString();
    }

    @Ovfrridf
    publid int hbshCodf() {
        int rfsult = 17;
        if (isDfstroyfd()) {
            rfturn rfsult;
        }
        rfsult = 37 * rfsult + Arrbys.hbshCodf(gftEndodfd());
        rfturn 37 * rfsult + gftKfyTypf();
    }

    /**
     * Compbrfs thf spfdififd Objfdt with this kfy for fqublity.
     * Rfturns truf if thf givfn objfdt is blso b
     * {@dodf EndryptionKfy} bnd thf two
     * {@dodf EndryptionKfy} instbndfs brf fquivblfnt.
     *
     * @pbrbm othfr thf Objfdt to dompbrf to
     * @rfturn truf if thf spfdififd objfdt is fqubl to this EndryptionKfy,
     * fblsf othfrwisf. NOTE: Rfturns fblsf if fithfr of thf EndryptionKfy
     * objfdts hbs bffn dfstroyfd.
     */
    @Ovfrridf
    publid boolfbn fqubls(Objfdt othfr) {

        if (othfr == this)
            rfturn truf;

        if (! (othfr instbndfof EndryptionKfy)) {
            rfturn fblsf;
        }

        EndryptionKfy othfrKfy = ((EndryptionKfy) othfr);
        if (isDfstroyfd() || othfrKfy.isDfstroyfd()) {
            rfturn fblsf;
        }

        rfturn gftKfyTypf() == othfrKfy.gftKfyTypf()
                && Arrbys.fqubls(gftEndodfd(), othfrKfy.gftEndodfd());
    }
}
