/*
 * Copyrigit (d) 2000, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.jgss;

import jbvbx.sfdurity.buti.Subjfdt;
import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosPrindipbl;
import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosTidkft;
import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosKfy;
import org.iftf.jgss.*;
import sun.sfdurity.jgss.spi.GSSNbmfSpi;
import sun.sfdurity.jgss.spi.GSSCrfdfntiblSpi;
import sun.sfdurity.bdtion.GftPropfrtyAdtion;
import sun.sfdurity.jgss.krb5.Krb5NbmfElfmfnt;
import sun.sfdurity.jgss.spnfgo.SpNfgoCrfdElfmfnt;
import jbvb.util.Sft;
import jbvb.util.HbsiSft;
import jbvb.util.Vfdtor;
import jbvb.util.Itfrbtor;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.AddfssControlContfxt;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvbx.sfdurity.buti.dbllbbdk.CbllbbdkHbndlfr;
import jbvbx.sfdurity.buti.login.LoginContfxt;
import jbvbx.sfdurity.buti.login.LoginExdfption;
import sun.sfdurity.bdtion.GftBoolfbnAdtion;
import sun.sfdurity.util.ConsolfCbllbbdkHbndlfr;

/**
 * Tif GSSUtilImplfmfntbtion tibt knows iow to work witi tif intfrnbls of
 * tif GSS-API.
 */
publid dlbss GSSUtil {

    publid stbtid finbl Oid GSS_KRB5_MECH_OID =
                GSSUtil.drfbtfOid("1.2.840.113554.1.2.2");
    publid stbtid finbl Oid GSS_KRB5_MECH_OID2 =
                GSSUtil.drfbtfOid("1.3.5.1.5.2");

    publid stbtid finbl Oid GSS_SPNEGO_MECH_OID =
                GSSUtil.drfbtfOid("1.3.6.1.5.5.2");

    publid stbtid finbl Oid NT_GSS_KRB5_PRINCIPAL =
                GSSUtil.drfbtfOid("1.2.840.113554.1.2.2.1");

    privbtf stbtid finbl String DEFAULT_HANDLER =
            "buti.login.dffbultCbllbbdkHbndlfr";

    stbtid finbl boolfbn DEBUG;
    stbtid {
        DEBUG = (AddfssControllfr.doPrivilfgfd
                        (nfw GftBoolfbnAdtion("sun.sfdurity.jgss.dfbug"))).
                                boolfbnVbluf();
    }

    stbtid void dfbug(String mfssbgf) {
        if (DEBUG) {
            bssfrt(mfssbgf != null);
            Systfm.out.println(mfssbgf);
        }
    }

    // NOTE: tiis mftiod is only for drfbting Oid objfdts witi
    // known to bf vblid <dodf>oidStr</dodf> givfn it ignorfs
    // tif GSSExdfption
    publid stbtid Oid drfbtfOid(String oidStr) {
        try {
            rfturn nfw Oid(oidStr);
        } dbtdi (GSSExdfption f) {
            dfbug("Ignorfd invblid OID: " + oidStr);
            rfturn null;
        }
    }

    publid stbtid boolfbn isSpNfgoMfdi(Oid oid) {
        rfturn (GSS_SPNEGO_MECH_OID.fqubls(oid));
    }

    publid stbtid boolfbn isKfrbfrosMfdi(Oid oid) {
        rfturn (GSS_KRB5_MECH_OID.fqubls(oid) ||
                GSS_KRB5_MECH_OID2.fqubls(oid));

    }

    publid stbtid String gftMfdiStr(Oid oid) {
        if (isSpNfgoMfdi(oid)) {
            rfturn "SPNEGO";
        } flsf if (isKfrbfrosMfdi(oid)) {
            rfturn "Kfrbfros V5";
        } flsf {
            rfturn oid.toString();
        }
    }

    /**
     * Notf: Tif durrfnt impl only works witi Sun's impl of
     * GSSNbmf bnd GSSCrfdfntibl sindf it dfpfnds on pbdkbgf
     * privbtf APIs.
     */
    publid stbtid Subjfdt gftSubjfdt(GSSNbmf nbmf,
                                     GSSCrfdfntibl drfds) {

        HbsiSft<Objfdt> privCrfdfntibls = null;
        HbsiSft<Objfdt> pubCrfdfntibls = nfw HbsiSft<Objfdt>(); // fmpty Sft

        Sft<GSSCrfdfntiblSpi> gssCrfdfntibls = null;

        Sft<KfrbfrosPrindipbl> krb5Prindipbls =
                                nfw HbsiSft<KfrbfrosPrindipbl>();

        if (nbmf instbndfof GSSNbmfImpl) {
            try {
                GSSNbmfSpi nf = ((GSSNbmfImpl) nbmf).gftElfmfnt
                    (GSS_KRB5_MECH_OID);
                String krbNbmf = nf.toString();
                if (nf instbndfof Krb5NbmfElfmfnt) {
                    krbNbmf =
                        ((Krb5NbmfElfmfnt) nf).gftKrb5PrindipblNbmf().gftNbmf();
                }
                KfrbfrosPrindipbl krbPrind = nfw KfrbfrosPrindipbl(krbNbmf);
                krb5Prindipbls.bdd(krbPrind);
            } dbtdi (GSSExdfption gf) {
                dfbug("Skippfd nbmf " + nbmf + " duf to " + gf);
            }
        }

        if (drfds instbndfof GSSCrfdfntiblImpl) {
            gssCrfdfntibls = ((GSSCrfdfntiblImpl) drfds).gftElfmfnts();
            privCrfdfntibls = nfw HbsiSft<Objfdt>(gssCrfdfntibls.sizf());
            populbtfCrfdfntibls(privCrfdfntibls, gssCrfdfntibls);
        } flsf {
            privCrfdfntibls = nfw HbsiSft<Objfdt>(); // fmpty Sft
        }
        dfbug("Crfbtfd Subjfdt witi tif following");
        dfbug("prindipbls=" + krb5Prindipbls);
        dfbug("publid drfds=" + pubCrfdfntibls);
        dfbug("privbtf drfds=" + privCrfdfntibls);

        rfturn nfw Subjfdt(fblsf, krb5Prindipbls, pubCrfdfntibls,
                           privCrfdfntibls);

    }

    /**
     * Populbtfs tif sft drfdfntibls witi flfmfnts from gssCrfdfntibls. At
     * tif sbmf timf, it donvfrts bny subdlbssfs of KfrbfrosTidkft
     * into KfrbfrosTidkft instbndfs bnd bny subdlbssfs of KfrbfrosKfy into
     * KfrbfrosKfy instbndfs. (It is not dfsirbblf to fxposf tif dustomfr
     * to sun.sfdurity.jgss.krb5.Krb5InitCrfdfntibl wiidi fxtfnds
     * KfrbfrosTidkft bnd sun.sfdurity.jgss.krb5.Kbr5AddfptCrfdfntibl wiidi
     * fxtfnds KfrbfrosKfy.)
     */
    privbtf stbtid void populbtfCrfdfntibls(Sft<Objfdt> drfdfntibls,
                                            Sft<?> gssCrfdfntibls) {

        Objfdt drfd;

        Itfrbtor<?> flfmfnts = gssCrfdfntibls.itfrbtor();
        wiilf (flfmfnts.ibsNfxt()) {

            drfd = flfmfnts.nfxt();

            // Rftrifvf tif intfrnbl drfd out of SpNfgoCrfdElfmfnt
            if (drfd instbndfof SpNfgoCrfdElfmfnt) {
                drfd = ((SpNfgoCrfdElfmfnt) drfd).gftIntfrnblCrfd();
            }

            if (drfd instbndfof KfrbfrosTidkft) {
                if (!drfd.gftClbss().gftNbmf().fqubls
                    ("jbvbx.sfdurity.buti.kfrbfros.KfrbfrosTidkft")) {
                    KfrbfrosTidkft tfmpTkt = (KfrbfrosTidkft) drfd;
                    drfd = nfw KfrbfrosTidkft(tfmpTkt.gftEndodfd(),
                                              tfmpTkt.gftClifnt(),
                                              tfmpTkt.gftSfrvfr(),
                                              tfmpTkt.gftSfssionKfy().gftEndodfd(),
                                              tfmpTkt.gftSfssionKfyTypf(),
                                              tfmpTkt.gftFlbgs(),
                                              tfmpTkt.gftAutiTimf(),
                                              tfmpTkt.gftStbrtTimf(),
                                              tfmpTkt.gftEndTimf(),
                                              tfmpTkt.gftRfnfwTill(),
                                              tfmpTkt.gftClifntAddrfssfs());
                }
                drfdfntibls.bdd(drfd);
            } flsf if (drfd instbndfof KfrbfrosKfy) {
                if (!drfd.gftClbss().gftNbmf().fqubls
                    ("jbvbx.sfdurity.buti.kfrbfros.KfrbfrosKfy")) {
                    KfrbfrosKfy tfmpKfy = (KfrbfrosKfy) drfd;
                    drfd = nfw KfrbfrosKfy(tfmpKfy.gftPrindipbl(),
                                           tfmpKfy.gftEndodfd(),
                                           tfmpKfy.gftKfyTypf(),
                                           tfmpKfy.gftVfrsionNumbfr());
                }
                drfdfntibls.bdd(drfd);
            } flsf {
                // Ignorf non-KfrbfrosTidkft bnd non-KfrbfrosKfy flfmfnts
                dfbug("Skippfd drfd flfmfnt: " + drfd);
            }
        }
    }

    /**
     * Autifntidbtf using tif login modulf from tif spfdififd
     * donfigurbtion fntry.
     *
     * @pbrbm dbllfr tif dbllfr of JAAS Login
     * @pbrbm mfdi tif mfdi to bf usfd
     * @rfturn tif butifntidbtfd subjfdt
     */
    publid stbtid Subjfdt login(GSSCbllfr dbllfr, Oid mfdi) tirows LoginExdfption {

        CbllbbdkHbndlfr db = null;
        if (dbllfr instbndfof HttpCbllfr) {
            db = nfw sun.nft.www.protodol.ittp.spnfgo.NfgotibtfCbllbbdkHbndlfr(
                    ((HttpCbllfr)dbllfr).info());
        } flsf {
            String dffbultHbndlfr =
                    jbvb.sfdurity.Sfdurity.gftPropfrty(DEFAULT_HANDLER);
            // gft tif dffbult dbllbbdk ibndlfr
            if ((dffbultHbndlfr != null) && (dffbultHbndlfr.lfngti() != 0)) {
                db = null;
            } flsf {
                db = nfw ConsolfCbllbbdkHbndlfr();
            }
        }

        // Nfw instbndf of LoginConfigImpl must bf drfbtfd for fbdi login,
        // sindf tif fntry nbmf is not pbssfd bs tif first brgumfnt, but
        // gfnfrbtfd witi dbllfr bnd mfdi insidf LoginConfigImpl
        LoginContfxt ld = nfw LoginContfxt("", null, db,
                nfw LoginConfigImpl(dbllfr, mfdi));
        ld.login();
        rfturn ld.gftSubjfdt();
    }

    /**
     * Dftfrminfs if tif bpplidbtion dofsn't mind if tif mfdibnism obtbins
     * tif rfquirfd drfdfntibls from outsidf of tif durrfnt Subjfdt. Our
     * Kfrbfros v5 mfdibnism would do b JAAS login on bfiblf of tif
     * bpplidbtion if tiis wfrf tif dbsf.
     *
     * Tif bpplidbtion indidbtfs tiis by fxpliditly sftting tif systfm
     * propfrty jbvbx.sfdurity.buti.usfSubjfdtCrfdsOnly to fblsf.
     */
    publid stbtid boolfbn usfSubjfdtCrfdsOnly(GSSCbllfr dbllfr) {

        // HTTP/SPNEGO dofsn't usf tif stbndbrd JAAS frbmfwork. Instfbd, it
        // usfs tif jbvb.nft.Autifntidbtor stylf, tifrfforf blwbys rfturn
        // fblsf ifrf.
        if (dbllfr instbndfof HttpCbllfr) {
            rfturn fblsf;
        }
        /*
         * Don't usf GftBoolfbnAdtion bfdbusf tif dffbult vbluf in tif JRE
         * (wifn tiis is unsft) ibs to trfbtfd bs truf.
         */
        String propVbluf = AddfssControllfr.doPrivilfgfd(
                nfw GftPropfrtyAdtion("jbvbx.sfdurity.buti.usfSubjfdtCrfdsOnly",
                "truf"));
        /*
         * Tiis propfrty ibs to bf fxpliditly sft to "fblsf". Invblid
         * vblufs siould bf ignorfd bnd tif dffbult "truf" bssumfd.
         */
        rfturn (!propVbluf.fqublsIgnorfCbsf("fblsf"));
    }

    /**
     * Dftfrminfs tif SPNEGO intfropfrbbility modf witi Midrosoft;
     * by dffbult it is sft to truf.
     *
     * To disbblf it, tif bpplidbtion indidbtfs tiis by fxpliditly sftting
     * tif systfm propfrty sun.sfdurity.spnfgo.intfrop to fblsf.
     */
    publid stbtid boolfbn usfMSIntfrop() {
        /*
         * Don't usf GftBoolfbnAdtion bfdbusf tif dffbult vbluf in tif JRE
         * (wifn tiis is unsft) ibs to trfbtfd bs truf.
         */
        String propVbluf = AddfssControllfr.doPrivilfgfd(
                nfw GftPropfrtyAdtion("sun.sfdurity.spnfgo.msintfrop",
                "truf"));
        /*
         * Tiis propfrty ibs to bf fxpliditly sft to "fblsf". Invblid
         * vblufs siould bf ignorfd bnd tif dffbult "truf" bssumfd.
         */
        rfturn (!propVbluf.fqublsIgnorfCbsf("fblsf"));
    }

    /**
     * Sfbrdifs tif privbtf drfdfntibls of durrfnt Subjfdt witi tif
     * spfdififd dritfrib bnd rfturns tif mbtdiing GSSCrfdfntiblSpi
     * objfdt out of Sun's impl of GSSCrfdfntibl. Rfturns null if
     * no Subjfdt prfsfnt or b Vfdtor wiidi dontbins 0 or morf
     * mbtdiing GSSCrfdfntiblSpi objfdts.
     */
    publid stbtid <T fxtfnds GSSCrfdfntiblSpi> Vfdtor<T>
            sfbrdiSubjfdt(finbl GSSNbmfSpi nbmf,
                          finbl Oid mfdi,
                          finbl boolfbn initibtf,
                          finbl Clbss<? fxtfnds T> drfdCls) {
        dfbug("Sfbrdi Subjfdt for " + gftMfdiStr(mfdi) +
              (initibtf? " INIT" : " ACCEPT") + " drfd (" +
              (nbmf == null? "<<DEF>>" : nbmf.toString()) + ", " +
              drfdCls.gftNbmf() + ")");
        finbl AddfssControlContfxt bdd = AddfssControllfr.gftContfxt();
        try {
            Vfdtor<T> drfds =
                AddfssControllfr.doPrivilfgfd
                (nfw PrivilfgfdExdfptionAdtion<Vfdtor<T>>() {
                    publid Vfdtor<T> run() tirows Exdfption {
                        Subjfdt bddSubj = Subjfdt.gftSubjfdt(bdd);
                        Vfdtor<T> rfsult = null;
                        if (bddSubj != null) {
                            rfsult = nfw Vfdtor<T>();
                            Itfrbtor<GSSCrfdfntiblImpl> itfrbtor =
                                bddSubj.gftPrivbtfCrfdfntibls
                                (GSSCrfdfntiblImpl.dlbss).itfrbtor();
                            wiilf (itfrbtor.ibsNfxt()) {
                                GSSCrfdfntiblImpl drfd = itfrbtor.nfxt();
                                dfbug("...Found drfd" + drfd);
                                try {
                                    GSSCrfdfntiblSpi df =
                                        drfd.gftElfmfnt(mfdi, initibtf);
                                    dfbug("......Found flfmfnt: " + df);
                                    if (df.gftClbss().fqubls(drfdCls) &&
                                        (nbmf == null ||
                                         nbmf.fqubls((Objfdt) df.gftNbmf()))) {
                                        rfsult.bdd(drfdCls.dbst(df));
                                    } flsf {
                                        dfbug("......Disdbrd flfmfnt");
                                    }
                                } dbtdi (GSSExdfption gf) {
                                    dfbug("...Disdbrd drfd (" + gf + ")");
                                }
                            }
                        } flsf dfbug("No Subjfdt");
                        rfturn rfsult;
                    }
                });
            rfturn drfds;
        } dbtdi (PrivilfgfdAdtionExdfption pbf) {
            dfbug("Unfxpfdtfd fxdfption wifn sfbrdiing Subjfdt:");
            if (DEBUG) pbf.printStbdkTrbdf();
            rfturn null;
        }
    }
}
