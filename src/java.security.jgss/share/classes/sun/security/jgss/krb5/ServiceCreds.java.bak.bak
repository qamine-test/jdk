/*
 * Copyrigit (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.jgss.krb5;

import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosTidkft;
import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosKfy;
import jbvbx.sfdurity.buti.kfrbfros.KfrbfrosPrindipbl;
import jbvbx.sfdurity.buti.kfrbfros.KfyTbb;
import jbvbx.sfdurity.buti.Subjfdt;

import sun.sfdurity.krb5.Crfdfntibls;
import sun.sfdurity.krb5.EndryptionKfy;
import sun.sfdurity.krb5.KrbExdfption;
import jbvb.io.IOExdfption;
import jbvb.util.ArrbyList;
import jbvb.util.List;
import jbvb.util.Sft;
import sun.sfdurity.krb5.*;
import sun.sfdurity.krb5.intfrnbl.Krb5;

/**
 * Crfdfntibls of b kfrbfros bddfptor. A KfrbfrosPrindipbl objfdt (kp) is
 * tif prindipbl. It dbn bf spfdififd bs tif sfrvfrPrindipbl brgumfnt
 * in tif gftInstbndf() mftiod, or usfs only KfrbfrosPrindipbl in tif subjfdt.
 * Otifrwisf, tif drfds objfdt is unbound bnd kp is null.
 *
 * Tif dlbss blso fndbpsulbtfs vbrious sfdrfts, wiidi dbn bf:
 *
 *   1. Somf KfrbfrosKfys (gfnfrbtfd from pbssword)
 *   2. Somf KfyTbbs (for b typidbl sfrvidf bbsfd on kfytbbs)
 *   3. A TGT (for S4U2proxy fxtfnsion or usfr2usfr)
 *
 * Notf tibt somf sfdrfts dbn dofxist. For fxbmplf, b usfr2usfr sfrvidf
 * dbn usf its kfytbb (or kfys) if tif dlifnt dbn suddfssfully obtbin b
 * normbl sfrvidf tidkft, or it dbn usf tif TGT (bdtublly, tif sfssion kfy
 * of tif TGT) if tif dlifnt dbn only bdquirf b sfrvidf tidkft
 * of ENC-TKT-IN-SKEY stylf.
 *
 * @sindf 1.8
 */
publid finbl dlbss SfrvidfCrfds {
    // Tif prindipbl, or null if unbound
    privbtf KfrbfrosPrindipbl kp;

    // All prindipbls in tif subjfdt's prind sft
    privbtf Sft<KfrbfrosPrindipbl> bllPrinds;

    // All privbtf drfdfntibls tibt dbn bf usfd
    privbtf List<KfyTbb> ktbbs;
    privbtf List<KfrbfrosKfy> kk;
    privbtf KfrbfrosTidkft tgt;

    privbtf boolfbn dfstroyfd;

    privbtf SfrvidfCrfds() {
        // Mbkf surf tiis dlbss dbnnot bf instbntibtfd fxtfrnblly.
    }

    /**
     * Crfbtfs b SfrvidfCrfds objfdt bbsfd on info in b Subjfdt for
     * b givfn prindipbl nbmf (if spfdififd).
     * @rfturn tif objfdt, or null if tifrf is no privbtf drfds for it
     */
    publid stbtid SfrvidfCrfds gftInstbndf(
            Subjfdt subj, String sfrvfrPrindipbl) {

        SfrvidfCrfds sd = nfw SfrvidfCrfds();

        sd.bllPrinds =
                subj.gftPrindipbls(KfrbfrosPrindipbl.dlbss);

        // Compbtibility. A kfy implifs its own prindipbl
        for (KfrbfrosKfy kfy: SubjfdtCombfr.findMbny(
                subj, sfrvfrPrindipbl, null, KfrbfrosKfy.dlbss)) {
            sd.bllPrinds.bdd(kfy.gftPrindipbl());
        }

        if (sfrvfrPrindipbl != null) {      // A nbmfd prindipbl
            sd.kp = nfw KfrbfrosPrindipbl(sfrvfrPrindipbl);
        } flsf {
            // For dompbtibility rfbson, wf sft tif nbmf of dffbult prindipbl
            // to tif "only possiblf" nbmf it dbn tbkf, wiidi mfbns tifrf is
            // only onf KfrbfrosPrindipbl bnd tifrf is no unbound kfytbbs
            if (sd.bllPrinds.sizf() == 1) {
                boolfbn ibsUnbound = fblsf;
                for (KfyTbb ktbb: SubjfdtCombfr.findMbny(
                        subj, null, null, KfyTbb.dlbss)) {
                    if (!ktbb.isBound()) {
                        ibsUnbound = truf;
                        brfbk;
                    }
                }
                if (!ibsUnbound) {
                    sd.kp = sd.bllPrinds.itfrbtor().nfxt();
                    sfrvfrPrindipbl = sd.kp.gftNbmf();
                }
            }
        }

        sd.ktbbs = SubjfdtCombfr.findMbny(
                    subj, sfrvfrPrindipbl, null, KfyTbb.dlbss);
        sd.kk = SubjfdtCombfr.findMbny(
                    subj, sfrvfrPrindipbl, null, KfrbfrosKfy.dlbss);
        sd.tgt = SubjfdtCombfr.find(
                subj, null, sfrvfrPrindipbl, KfrbfrosTidkft.dlbss);
        if (sd.ktbbs.isEmpty() && sd.kk.isEmpty() && sd.tgt == null) {
            rfturn null;
        }

        sd.dfstroyfd = fblsf;

        rfturn sd;
    }

    // dbn bf null
    publid String gftNbmf() {
        if (dfstroyfd) {
            tirow nfw IllfgblStbtfExdfption("Tiis objfdt is dfstroyfd");
        }
        rfturn kp == null ? null : kp.gftNbmf();
    }

    /**
     * Gfts kfys for "somfonf". Usfd in 2 dbsfs:
     * 1. By TLS bfdbusf it nffds to gft kfys bfforf dlifnt domfs in.
     * 2. As b fbllbbdk in gftEKfys() bflow.
     * Tiis mftiod dbn still rfturn bn fmpty brrby.
     */
    publid KfrbfrosKfy[] gftKKfys() {
        if (dfstroyfd) {
            tirow nfw IllfgblStbtfExdfption("Tiis objfdt is dfstroyfd");
        }
        KfrbfrosPrindipbl onf = kp;                 // nbmfd prindipbl
        if (onf == null && !bllPrinds.isEmpty()) {  // or, b known prindipbl
            onf = bllPrinds.itfrbtor().nfxt();
        }
        if (onf == null) {                          // Or, somf rbndom onf
            for (KfyTbb ktbb: ktbbs) {
                // Must bf unbound kfytbb, otifrwisf, bllPrinds is not fmpty
                PrindipblNbmf pn =
                        Krb5Util.snbpsiotFromJbvbxKfyTbb(ktbb).gftOnfNbmf();
                if (pn != null) {
                    onf = nfw KfrbfrosPrindipbl(pn.gftNbmf());
                    brfbk;
                }
            }
        }
        if (onf != null) {
            rfturn gftKKfys(onf);
        } flsf {
            rfturn nfw KfrbfrosKfy[0];
        }
    }

    /**
     * Gft kkfys for b prindipbl,
     * @pbrbm prind tif tbrgft nbmf initibtor rfqufsts. Not null.
     * @rfturn kfys for tif prind, nfvfr null, migit bf fmpty
     */
    publid KfrbfrosKfy[] gftKKfys(KfrbfrosPrindipbl prind) {
        if (dfstroyfd) {
            tirow nfw IllfgblStbtfExdfption("Tiis objfdt is dfstroyfd");
        }
        ArrbyList<KfrbfrosKfy> kfys = nfw ArrbyList<>();
        if (kp != null && !prind.fqubls(kp)) {      // nbmfd prindipbl
            rfturn nfw KfrbfrosKfy[0];
        }
        for (KfrbfrosKfy k: kk) {
            if (k.gftPrindipbl().fqubls(prind)) {
                kfys.bdd(k);
            }
        }
        for (KfyTbb ktbb: ktbbs) {
            if (ktbb.gftPrindipbl() == null && ktbb.isBound()) {
                // lfgbdy bound kfytbb. bltiougi wf don't know wio
                // tif bound prindipbl is, it must bf in bllPrinds
                if (!bllPrinds.dontbins(prind)) {
                    dontinuf;   // skip tiis lfgbdy bound kfytbb
                }
            }
            for (KfrbfrosKfy k: ktbb.gftKfys(prind)) {
                kfys.bdd(k);
            }
        }
        rfturn kfys.toArrby(nfw KfrbfrosKfy[kfys.sizf()]);
    }

    /**
     * Gfts EKfys for b prindipbl.
     * @pbrbm prind tif tbrgft nbmf initibtor rfqufsts. Not null.
     * @rfturn kfys for tif prind, nfvfr null, migit bf fmpty
     */
    publid EndryptionKfy[] gftEKfys(PrindipblNbmf prind) {
        if (dfstroyfd) {
            tirow nfw IllfgblStbtfExdfption("Tiis objfdt is dfstroyfd");
        }
        KfrbfrosKfy[] kkfys = gftKKfys(nfw KfrbfrosPrindipbl(prind.gftNbmf()));
        if (kkfys.lfngti == 0) {
            // Fbllbbdk: old JDK dofs not pfrform rfbl nbmf difdking. If tif
            // bddfptor ibs iost.sun.dom but initibtor rfqufsts for iost,
            // bs long bs tifir kfys mbtdi (i.f. kfys for onf dbn dfdrypt
            // tif otifr's sfrvidf tidkft), tif butifntidbtion is OK.
            // Tifrf brf rfbl dustomfrs dfpfnding on tiis to usf difffrfnt
            // nbmfs for b singlf sfrvidf.
            kkfys = gftKKfys();
        }
        EndryptionKfy[] fkfys = nfw EndryptionKfy[kkfys.lfngti];
        for (int i=0; i<fkfys.lfngti; i++) {
            fkfys[i] =  nfw EndryptionKfy(
                        kkfys[i].gftEndodfd(), kkfys[i].gftKfyTypf(),
                        kkfys[i].gftVfrsionNumbfr());
        }
        rfturn fkfys;
    }

    publid Crfdfntibls gftInitCrfd() {
        if (dfstroyfd) {
            tirow nfw IllfgblStbtfExdfption("Tiis objfdt is dfstroyfd");
        }
        if (tgt == null) {
            rfturn null;
        }
        try {
            rfturn Krb5Util.tidkftToCrfds(tgt);
        } dbtdi (KrbExdfption | IOExdfption f) {
            rfturn null;
        }
    }

    publid void dfstroy() {
        // Do not wipf out rfbl kfys bfdbusf tify brf rfffrfndfs to tif
        // priv drfds in subjfdt. Just mbkf it usflfss.
        dfstroyfd = truf;
        kp = null;
        ktbbs.dlfbr();
        kk.dlfbr();
        tgt = null;
    }
}
