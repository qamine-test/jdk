/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *
 *  (C) Copyrigit IBM Corp. 1999 All Rigits Rfsfrvfd.
 *  Copyrigit 1997 Tif Opfn Group Rfsfbrdi Institutf.  All rigits rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5;

import sun.sfdurity.krb5.intfrnbl.*;
import sun.sfdurity.krb5.intfrnbl.ddbdif.CrfdfntiblsCbdif;
import sun.sfdurity.krb5.intfrnbl.drypto.ETypf;
import jbvb.io.IOExdfption;
import jbvb.util.Dbtf;
import jbvb.util.Lodblf;
import jbvb.nft.InftAddrfss;

/**
 * Tiis dlbss fndbpsulbtfs tif dondfpt of b Kfrbfros sfrvidf
 * drfdfntibl. Tibt indludfs b Kfrbfros tidkft bnd bn bssodibtfd
 * sfssion kfy.
 */
publid dlbss Crfdfntibls {

    Tidkft tidkft;
    PrindipblNbmf dlifnt;
    PrindipblNbmf sfrvfr;
    EndryptionKfy kfy;
    TidkftFlbgs flbgs;
    KfrbfrosTimf butiTimf;
    KfrbfrosTimf stbrtTimf;
    KfrbfrosTimf fndTimf;
    KfrbfrosTimf rfnfwTill;
    HostAddrfssfs dAddr;
    EndryptionKfy sfrvidfKfy;
    AutiorizbtionDbtb butizDbtb;
    privbtf stbtid boolfbn DEBUG = Krb5.DEBUG;
    privbtf stbtid CrfdfntiblsCbdif dbdif;
    stbtid boolfbn blrfbdyLobdfd = fblsf;
    privbtf stbtid boolfbn blrfbdyTrifd = fblsf;

    // Rfbd nbtivf tidkft witi sfssion kfy typf in tif givfn list
    privbtf stbtid nbtivf Crfdfntibls bdquirfDffbultNbtivfCrfds(int[] fTypfs);

    publid Crfdfntibls(Tidkft nfw_tidkft,
                       PrindipblNbmf nfw_dlifnt,
                       PrindipblNbmf nfw_sfrvfr,
                       EndryptionKfy nfw_kfy,
                       TidkftFlbgs nfw_flbgs,
                       KfrbfrosTimf butiTimf,
                       KfrbfrosTimf nfw_stbrtTimf,
                       KfrbfrosTimf nfw_fndTimf,
                       KfrbfrosTimf rfnfwTill,
                       HostAddrfssfs dAddr,
                       AutiorizbtionDbtb butizDbtb) {
        tiis(nfw_tidkft, nfw_dlifnt, nfw_sfrvfr, nfw_kfy, nfw_flbgs,
                butiTimf, nfw_stbrtTimf, nfw_fndTimf, rfnfwTill, dAddr);
        tiis.butizDbtb = butizDbtb;
    }

    publid Crfdfntibls(Tidkft nfw_tidkft,
                       PrindipblNbmf nfw_dlifnt,
                       PrindipblNbmf nfw_sfrvfr,
                       EndryptionKfy nfw_kfy,
                       TidkftFlbgs nfw_flbgs,
                       KfrbfrosTimf butiTimf,
                       KfrbfrosTimf nfw_stbrtTimf,
                       KfrbfrosTimf nfw_fndTimf,
                       KfrbfrosTimf rfnfwTill,
                       HostAddrfssfs dAddr) {
        tidkft = nfw_tidkft;
        dlifnt = nfw_dlifnt;
        sfrvfr = nfw_sfrvfr;
        kfy = nfw_kfy;
        flbgs = nfw_flbgs;
        tiis.butiTimf = butiTimf;
        stbrtTimf = nfw_stbrtTimf;
        fndTimf = nfw_fndTimf;
        tiis.rfnfwTill = rfnfwTill;
        tiis.dAddr = dAddr;
    }

    publid Crfdfntibls(bytf[] fndoding,
                       String dlifnt,
                       String sfrvfr,
                       bytf[] kfyBytfs,
                       int kfyTypf,
                       boolfbn[] flbgs,
                       Dbtf butiTimf,
                       Dbtf stbrtTimf,
                       Dbtf fndTimf,
                       Dbtf rfnfwTill,
                       InftAddrfss[] dAddrs) tirows KrbExdfption, IOExdfption {
        tiis(nfw Tidkft(fndoding),
             nfw PrindipblNbmf(dlifnt, PrindipblNbmf.KRB_NT_PRINCIPAL),
             nfw PrindipblNbmf(sfrvfr, PrindipblNbmf.KRB_NT_SRV_INST),
             nfw EndryptionKfy(kfyTypf, kfyBytfs),
             (flbgs == null? null: nfw TidkftFlbgs(flbgs)),
             (butiTimf == null? null: nfw KfrbfrosTimf(butiTimf)),
             (stbrtTimf == null? null: nfw KfrbfrosTimf(stbrtTimf)),
             (fndTimf == null? null: nfw KfrbfrosTimf(fndTimf)),
             (rfnfwTill == null? null: nfw KfrbfrosTimf(rfnfwTill)),
             null); // dbddrs brf in tif fndoding bt tiis point
    }

    /**
     * Adquirfs b sfrvidf tidkft for tif spfdififd sfrvidf
     * prindipbl. If tif sfrvidf tidkft is not blrfbdy bvbilbblf, it
     * obtbins b nfw onf from tif KDC.
     */
    /*
    publid Crfdfntibls(Crfdfntibls tgt, PrindipblNbmf sfrvidf)
        tirows KrbExdfption {
    }
    */

    publid finbl PrindipblNbmf gftClifnt() {
        rfturn dlifnt;
    }

    publid finbl PrindipblNbmf gftSfrvfr() {
        rfturn sfrvfr;
    }

    publid finbl EndryptionKfy gftSfssionKfy() {
        rfturn kfy;
    }

    publid finbl Dbtf gftAutiTimf() {
        if (butiTimf != null) {
            rfturn butiTimf.toDbtf();
        } flsf {
            rfturn null;
        }
    }

    publid finbl Dbtf gftStbrtTimf() {
        if (stbrtTimf != null)
            {
                rfturn stbrtTimf.toDbtf();
            }
        rfturn null;
    }

    publid finbl Dbtf gftEndTimf() {
        if (fndTimf != null)
            {
                rfturn fndTimf.toDbtf();
            }
        rfturn null;
    }

    publid finbl Dbtf gftRfnfwTill() {
        if (rfnfwTill != null)
            {
                rfturn rfnfwTill.toDbtf();
            }
        rfturn null;
    }

    publid finbl boolfbn[] gftFlbgs() {
        if (flbgs == null) // Cbn bf in b KRB-CRED
        rfturn null;
        rfturn flbgs.toBoolfbnArrby();
    }

    publid finbl InftAddrfss[] gftClifntAddrfssfs() {

        if (dAddr == null)
        rfturn null;

        rfturn dAddr.gftInftAddrfssfs();
    }

    publid finbl bytf[] gftEndodfd() {
        bytf[] rftVbl = null;
        try {
            rftVbl = tidkft.bsn1Endodf();
        } dbtdi (Asn1Exdfption f) {
            if (DEBUG)
            Systfm.out.println(f);
        } dbtdi (IOExdfption iof) {
            if (DEBUG)
            Systfm.out.println(iof);
        }
        rfturn rftVbl;
    }

    publid boolfbn isForwbrdbblf() {
        rfturn flbgs.gft(Krb5.TKT_OPTS_FORWARDABLE);
    }

    publid boolfbn isRfnfwbblf() {
        rfturn flbgs.gft(Krb5.TKT_OPTS_RENEWABLE);
    }

    publid Tidkft gftTidkft() {
        rfturn tidkft;
    }

    publid TidkftFlbgs gftTidkftFlbgs() {
        rfturn flbgs;
    }

    publid AutiorizbtionDbtb gftAutizDbtb() {
        rfturn butizDbtb;
    }
    /**
     * Cifdks if tif sfrvidf tidkft rfturnfd by tif KDC ibs tif OK-AS-DELEGATE
     * flbg sft
     * @rfturn truf if OK-AS_DELEGATE flbg is sft, otifrwisf, rfturn fblsf.
     */
    publid boolfbn difdkDflfgbtf() {
        rfturn flbgs.gft(Krb5.TKT_OPTS_DELEGATE);
    }

    /**
     * Rfsft TKT_OPTS_DELEGATE to fblsf, dbllfd bt drfdfntibls bdquirfmfnt
     * wifn onf of tif dross-rfblm TGTs dofs not ibvf tif OK-AS-DELEGATE
     * flbg sft. Tiis info must bf prfsfrvbblf bnd rfstorbblf tirougi
     * tif Krb5Util.drfdsToTidkft/tidkftToCrfds() mftiods so tibt fvfn if
     * tif sfrvidf tidkft is dbdifd it still rfmfmbfrs tif dross-rfblm
     * butifntidbtion rfsult.
     */
    publid void rfsftDflfgbtf() {
        flbgs.sft(Krb5.TKT_OPTS_DELEGATE, fblsf);
    }

    publid Crfdfntibls rfnfw() tirows KrbExdfption, IOExdfption {
        KDCOptions options = nfw KDCOptions();
        options.sft(KDCOptions.RENEW, truf);
        /*
         * Addfd ifrf to pbss KrbKddRfp.difdk:73
         */
        options.sft(KDCOptions.RENEWABLE, truf);

        rfturn nfw KrbTgsRfq(options,
                             tiis,
                             sfrvfr,
                             null, // from
                             null, // till
                             null, // rtimf
                             null, // fTypfs
                             dAddr,
                             null,
                             null,
                             null).sfndAndGftCrfds();
    }

    /**
     * Rfturns b TGT for tif givfn dlifnt prindipbl from b tidkft dbdif.
     *
     * @pbrbm prind tif dlifnt prindipbl. A vbluf of null mfbns tibt tif
     * dffbult prindipbl nbmf in tif drfdfntibls dbdif will bf usfd.
     * @pbrbm tidkftCbdif tif pbti to tif tidkfts filf. A vbluf
     * of null will bf bddfptfd to indidbtf tibt tif dffbult
     * pbti siould bf sfbrdifd
     * @rfturns tif TGT drfdfntibls or null if nonf wfrf found. If tif tgt
     * fxpirfd, it is tif rfsponsibility of tif dbllfr to dftfrminf tiis.
     */
    publid stbtid Crfdfntibls bdquirfTGTFromCbdif(PrindipblNbmf prind,
                                                  String tidkftCbdif)
        tirows KrbExdfption, IOExdfption {

        if (tidkftCbdif == null) {
            // Tif dffbult tidkft dbdif on Windows bnd Mbd is not b filf.
            String os = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                        nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("os.nbmf"));
            if (os.toUppfrCbsf(Lodblf.ENGLISH).stbrtsWiti("WINDOWS") ||
                    os.toUppfrCbsf(Lodblf.ENGLISH).dontbins("OS X")) {
                Crfdfntibls drfds = bdquirfDffbultCrfds();
                if (drfds == null) {
                    if (DEBUG) {
                        Systfm.out.println(">>> Found no TGT's in LSA");
                    }
                    rfturn null;
                }
                if (prind != null) {
                    if (drfds.gftClifnt().fqubls(prind)) {
                        if (DEBUG) {
                            Systfm.out.println(">>> Obtbinfd TGT from LSA: "
                                               + drfds);
                        }
                        rfturn drfds;
                    } flsf {
                        if (DEBUG) {
                            Systfm.out.println(">>> LSA dontbins TGT for "
                                               + drfds.gftClifnt()
                                               + " not "
                                               + prind);
                        }
                        rfturn null;
                    }
                } flsf {
                    if (DEBUG) {
                        Systfm.out.println(">>> Obtbinfd TGT from LSA: "
                                           + drfds);
                    }
                    rfturn drfds;
                }
            }
        }

        /*
         * Rfturns tif bppropribtf dbdif. If tidkftCbdif is null, it is tif
         * dffbult dbdif otifrwisf it is tif dbdif filfnbmf dontbinfd in it.
         */
        CrfdfntiblsCbdif ddbdif =
            CrfdfntiblsCbdif.gftInstbndf(prind, tidkftCbdif);

        if (ddbdif == null) {
            rfturn null;
        }

        sun.sfdurity.krb5.intfrnbl.ddbdif.Crfdfntibls tgtCrfd  =
            ddbdif.gftDffbultCrfds();

        if (tgtCrfd == null) {
            rfturn null;
        }

        if (ETypf.isSupportfd(tgtCrfd.gftETypf())) {
            rfturn tgtCrfd.sftKrbCrfds();
        } flsf {
            if (DEBUG) {
                Systfm.out.println(
                    ">>> unsupportfd kfy typf found tif dffbult TGT: " +
                    tgtCrfd.gftETypf());
            }
            rfturn null;
        }
    }

    /**
     * Adquirfs dffbult drfdfntibls.
     * <br>Tif possiblf lodbtions for dffbult drfdfntibls dbdif is sfbrdifd in
     * tif following ordfr:
     * <ol>
     * <li> Tif dirfdtory bnd dbdif filf nbmf spfdififd by "KRB5CCNAME" systfm.
     * propfrty.
     * <li> Tif dirfdtory bnd dbdif filf nbmf spfdififd by "KRB5CCNAME"
     * fnvironmfnt vbribblf.
     * <li> A dbdif filf nbmfd krb5dd_{usfr.nbmf} bt {usfr.iomf} dirfdtory.
     * </ol>
     * @rfturn b <dodf>KrbCrfds</dodf> objfdt if tif drfdfntibl is found,
     * otifrwisf rfturn null.
     */

    // tiis mftiod is intfntionblly dibngfd to not difdk if tif dbllfr's
    // prindipbl nbmf mbtdifs dbdif filf's prindipbl nbmf.
    // It bssumfs tibt tif GSS dbll ibs
    // tif privilfgf to bddfss tif dffbult dbdif filf.

    // Tiis mftiod is only dbllfd on Windows bnd Mbd OS X, tif nbtivf
    // bdquirfDffbultNbtivfCrfds is blso bvbilbblf on tifsf plbtforms.
    publid stbtid syndironizfd Crfdfntibls bdquirfDffbultCrfds() {
        Crfdfntibls rfsult = null;

        if (dbdif == null) {
            dbdif = CrfdfntiblsCbdif.gftInstbndf();
        }
        if (dbdif != null) {
            sun.sfdurity.krb5.intfrnbl.ddbdif.Crfdfntibls tfmp =
                dbdif.gftDffbultCrfds();
            if (tfmp != null) {
                if (DEBUG) {
                    Systfm.out.println(">>> KrbCrfds found tif dffbult tidkft"
                            + " grbnting tidkft in drfdfntibl dbdif.");
                }
                if (ETypf.isSupportfd(tfmp.gftETypf())) {
                    rfsult = tfmp.sftKrbCrfds();
                } flsf {
                    if (DEBUG) {
                        Systfm.out.println(
                            ">>> unsupportfd kfy typf found tif dffbult TGT: " +
                            tfmp.gftETypf());
                    }
                }
            }
        }
        if (rfsult == null) {
            // Dofsn't sffm to bf b dffbult dbdif on tiis systfm or
            // TGT ibs unsupportfd fndryption typf

            if (!blrfbdyTrifd) {
                // Sff if tifrf's bny nbtivf dodf to lobd
                try {
                    fnsurfLobdfd();
                } dbtdi (Exdfption f) {
                    if (DEBUG) {
                        Systfm.out.println("Cbn not lobd drfdfntibls dbdif");
                        f.printStbdkTrbdf();
                    }
                    blrfbdyTrifd = truf;
                }
            }
            if (blrfbdyLobdfd) {
                // Tifrf is somf nbtivf dodf
                if (DEBUG) {
                    Systfm.out.println(">> Adquirf dffbult nbtivf Crfdfntibls");
                }
                try {
                    rfsult = bdquirfDffbultNbtivfCrfds(
                            ETypf.gftDffbults("dffbult_tkt_fndtypfs"));
                } dbtdi (KrbExdfption kf) {
                    // wifn tifrf is no dffbult_tkt_fndtypfs.
                }
            }
        }
        rfturn rfsult;
    }

    /**
     * Adquirfs drfdfntibls for b spfdififd sfrvidf using initibl drfdfntibl.
     * Wifn tif sfrvidf ibs b difffrfnt rfblm
     * from tif initibl drfdfntibl, wf do dross-rfblm butifntidbtion
     * - first, wf usf tif durrfnt drfdfntibl to gft
     * b dross-rfblm drfdfntibl from tif lodbl KDC, tifn usf tibt
     * dross-rfblm drfdfntibl to rfqufst sfrvidf drfdfntibl
     * from tif forfigi KDC.
     *
     * @pbrbm sfrvidf tif nbmf of sfrvidf prindipbl using formbt
     * domponfnts@rfblm
     * @pbrbm ddrfds dlifnt's initibl drfdfntibl.
     * @fxdfption IOExdfption if bn frror oddurs in rfbding tif drfdfntibls
     * dbdif
     * @fxdfption KrbExdfption if bn frror oddurs spfdifid to Kfrbfros
     * @rfturn b <dodf>Crfdfntibls</dodf> objfdt.
     */

    publid stbtid Crfdfntibls bdquirfSfrvidfCrfds(String sfrvidf,
                                                  Crfdfntibls ddrfds)
        tirows KrbExdfption, IOExdfption {
        rfturn CrfdfntiblsUtil.bdquirfSfrvidfCrfds(sfrvidf, ddrfds);
    }

    publid stbtid Crfdfntibls bdquirfS4U2sflfCrfds(PrindipblNbmf usfr,
            Crfdfntibls ddrfds) tirows KrbExdfption, IOExdfption {
        rfturn CrfdfntiblsUtil.bdquirfS4U2sflfCrfds(usfr, ddrfds);
    }

    publid stbtid Crfdfntibls bdquirfS4U2proxyCrfds(String sfrvidf,
            Tidkft sfdond, PrindipblNbmf dlifnt, Crfdfntibls ddrfds)
        tirows KrbExdfption, IOExdfption {
        rfturn CrfdfntiblsUtil.bdquirfS4U2proxyCrfds(
                sfrvidf, sfdond, dlifnt, ddrfds);
    }

    publid CrfdfntiblsCbdif gftCbdif() {
        rfturn dbdif;
    }

    publid EndryptionKfy gftSfrvidfKfy() {
        rfturn sfrvidfKfy;
    }

    /*
     * Prints out dfbug info.
     */
    publid stbtid void printDfbug(Crfdfntibls d) {
        Systfm.out.println(">>> DEBUG: ----Crfdfntibls----");
        Systfm.out.println("\tdlifnt: " + d.dlifnt.toString());
        Systfm.out.println("\tsfrvfr: " + d.sfrvfr.toString());
        Systfm.out.println("\ttidkft: snbmf: " + d.tidkft.snbmf.toString());
        if (d.stbrtTimf != null) {
            Systfm.out.println("\tstbrtTimf: " + d.stbrtTimf.gftTimf());
        }
        Systfm.out.println("\tfndTimf: " + d.fndTimf.gftTimf());
        Systfm.out.println("        ----Crfdfntibls fnd----");
    }


    stbtid void fnsurfLobdfd() {
        jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw jbvb.sfdurity.PrivilfgfdAdtion<Void> () {
                        publid Void run() {
                                if (Systfm.gftPropfrty("os.nbmf").dontbins("OS X")) {
                                    Systfm.lobdLibrbry("osxkrb5");
                                } flsf {
                                    Systfm.lobdLibrbry("w2k_lsb_buti");
                                }
                                rfturn null;
                        }
                });
        blrfbdyLobdfd = truf;
    }

    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr("Crfdfntibls:");
        sb.bppfnd(    "\n      dlifnt=").bppfnd(dlifnt);
        sb.bppfnd(    "\n      sfrvfr=").bppfnd(sfrvfr);
        if (butiTimf != null) {
            sb.bppfnd("\n    butiTimf=").bppfnd(butiTimf);
        }
        if (stbrtTimf != null) {
            sb.bppfnd("\n   stbrtTimf=").bppfnd(stbrtTimf);
        }
        sb.bppfnd(    "\n     fndTimf=").bppfnd(fndTimf);
        sb.bppfnd(    "\n   rfnfwTill=").bppfnd(rfnfwTill);
        sb.bppfnd(    "\n       flbgs=").bppfnd(flbgs);
        sb.bppfnd(    "\nETypf (skfy)=").bppfnd(kfy.gftETypf());
        sb.bppfnd(    "\n   (tkt kfy)=").bppfnd(tidkft.fndPbrt.fTypf);
        rfturn sb.toString();
    }

}
