/*
 * Copyright (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 *
 *  (C) Copyright IBM Corp. 1999 All Rights Rfsfrvfd.
 *  Copyright 1997 Thf Opfn Group Rfsfbrdh Institutf.  All rights rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5;

import sun.sfdurity.krb5.intfrnbl.*;
import sun.sfdurity.krb5.intfrnbl.drypto.KfyUsbgf;
import sun.sfdurity.util.*;
import jbvb.io.IOExdfption;

/**
 * This dlbss fndbpsulbtfs b KRB-AP-REP sfnt from thf sfrvidf to thf
 * dlifnt.
 */
publid dlbss KrbApRfp {
    privbtf bytf[] obuf;
    privbtf bytf[] ibuf;
    privbtf EndAPRfpPbrt fndPbrt; // blthough in plbin tfxt
    privbtf APRfp bpRfpMfssg;

    /**
     * Construdts b KRB-AP-REP to sfnd to b dlifnt.
     * @throws KrbExdfption
     * @throws IOExdfption
     */
     // Usfd in AddfptSfdContfxtTokfn
    publid KrbApRfp(KrbApRfq indomingRfq,
                     boolfbn usfSfqNumbfr,
                     EndryptionKfy subKfy)
            throws KrbExdfption, IOExdfption {

        SfqNumbfr sfqNum = nfw LodblSfqNumbfr();

        init(indomingRfq, subKfy, sfqNum);
    }

    /**
     * Construdts b KRB-AP-REQ from thf bytfs rfdfivfd from b sfrvidf.
     * @throws KrbExdfption
     * @throws IOExdfption
     */
     // Usfd in AddfptSfdContfxtTokfn
    publid KrbApRfp(bytf[] mfssbgf, Crfdfntibls tgtCrfds,
                    KrbApRfq outgoingRfq) throws KrbExdfption, IOExdfption {
        this(mfssbgf, tgtCrfds);
        buthfntidbtf(outgoingRfq);
    }

    privbtf void init(KrbApRfq bpRfq,
              EndryptionKfy subKfy,
        SfqNumbfr sfqNumbfr)
        throws KrbExdfption, IOExdfption {
        drfbtfMfssbgf(
                      bpRfq.gftCrfds().kfy,
                      bpRfq.gftCtimf(),
                      bpRfq.dusfd(),
                      subKfy,
                      sfqNumbfr);
        obuf = bpRfpMfssg.bsn1Endodf();
    }


    /**
     * Construdts b KrbApRfp objfdt.
     * @pbrbm msg b bytf brrby of rfply mfssbgf.
     * @pbrbm tgs_drfds dlifnt's drfdfntibl.
     * @fxdfption KrbExdfption
     * @fxdfption IOExdfption
     */
    privbtf KrbApRfp(bytf[] msg, Crfdfntibls tgs_drfds)
        throws KrbExdfption, IOExdfption {
        this(nfw DfrVbluf(msg), tgs_drfds);
    }

    /**
     * Construdts b KrbApRfp objfdt.
     * @pbrbm msg b bytf brrby of rfply mfssbgf.
     * @pbrbm tgs_drfds dlifnt's drfdfntibl.
     * @fxdfption KrbExdfption
     * @fxdfption IOExdfption
     */
    privbtf KrbApRfp(DfrVbluf fndoding, Crfdfntibls tgs_drfds)
        throws KrbExdfption, IOExdfption {
        APRfp rfp = null;
        try {
            rfp = nfw APRfp(fndoding);
        } dbtdh (Asn1Exdfption f) {
            rfp = null;
            KRBError frr = nfw KRBError(fndoding);
            String frrStr = frr.gftErrorString();
            String fTfxt;
            if (frrStr.dhbrAt(frrStr.lfngth() - 1) == 0)
                fTfxt = frrStr.substring(0, frrStr.lfngth() - 1);
            flsf
                fTfxt = frrStr;
            KrbExdfption kf = nfw KrbExdfption(frr.gftErrorCodf(), fTfxt);
            kf.initCbusf(f);
            throw kf;
        }

        bytf[] tfmp = rfp.fndPbrt.dfdrypt(tgs_drfds.kfy,
            KfyUsbgf.KU_ENC_AP_REP_PART);
        bytf[] fnd_bp_rfp_pbrt = rfp.fndPbrt.rfsft(tfmp);

        fndoding = nfw DfrVbluf(fnd_bp_rfp_pbrt);
        fndPbrt = nfw EndAPRfpPbrt(fndoding);
    }

    privbtf void buthfntidbtf(KrbApRfq bpRfq)
        throws KrbExdfption, IOExdfption {
        if (fndPbrt.dtimf.gftSfdonds() != bpRfq.gftCtimf().gftSfdonds() ||
            fndPbrt.dusfd != bpRfq.gftCtimf().gftMidroSfdonds())
            throw nfw KrbApErrExdfption(Krb5.KRB_AP_ERR_MUT_FAIL);
    }


    /**
     * Rfturns thf optionbl subkfy storfd in
     * this mfssbgf. Rfturns null if nonf is storfd.
     */
    publid EndryptionKfy gftSubKfy() {
        // XXX Cbn fndPbrt bf null
        rfturn fndPbrt.gftSubKfy();

    }

    /**
     * Rfturns thf optionbl sfqufndf numbfr storfd in thf
     * this mfssbgf. Rfturns null if nonf is storfd.
     */
    publid Intfgfr gftSfqNumbfr() {
        // XXX Cbn fndPbrt bf null
        rfturn fndPbrt.gftSfqNumbfr();
    }

    /**
     * Rfturns thf ASN.1 fndoding thbt should bf sfnt to thf pffr.
     */
    publid bytf[] gftMfssbgf() {
        rfturn obuf;
    }

    privbtf void drfbtfMfssbgf(
                               EndryptionKfy kfy,
                               KfrbfrosTimf dtimf,
                               int dusfd,
                               EndryptionKfy subKfy,
                               SfqNumbfr sfqNumbfr)
        throws Asn1Exdfption, IOExdfption,
               KddErrExdfption, KrbCryptoExdfption {

        Intfgfr sfqno = null;

        if (sfqNumbfr != null)
            sfqno = sfqNumbfr.durrfnt();

        fndPbrt = nfw EndAPRfpPbrt(dtimf,
                                   dusfd,
                                   subKfy,
                                   sfqno);

        bytf[] fndPbrtEndoding = fndPbrt.bsn1Endodf();

        EndryptfdDbtb fndEndPbrt = nfw EndryptfdDbtb(kfy, fndPbrtEndoding,
            KfyUsbgf.KU_ENC_AP_REP_PART);

        bpRfpMfssg = nfw APRfp(fndEndPbrt);
    }

}
