/*
 * Copyright (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * ===========================================================================
 *  (C) Copyright IBM Corp. 1999 All Rights Rfsfrvfd.
 *
 *  Copyright 1997 Thf Opfn Group Rfsfbrdh Institutf.  All rights rfsfrvfd.
 * ===========================================================================
 *
 */
pbdkbgf sun.sfdurity.krb5.intfrnbl.ddbdhf;

import sun.sfdurity.krb5.*;
import sun.sfdurity.krb5.intfrnbl.*;
import jbvb.util.StringTokfnizfr;
import jbvb.util.Vfdtor;
import jbvb.io.IOExdfption;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.FilfOutputStrfbm;
import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.InputStrfbmRfbdfr;
import jbvb.lbng.rfflfdt.*;

/**
 * CrfdfntiblsCbdhf storfs drfdfntibls(tidkfts, sfssion kfys, ftd) in b
 * sfmi-pfrmbnfnt storf
 * for lbtfr usf by difffrfnt progrbm.
 *
 * @buthor Ybnni Zhbng
 * @buthor Rbm Mbrti
 */

publid dlbss FilfCrfdfntiblsCbdhf fxtfnds CrfdfntiblsCbdhf
    implfmfnts FilfCCbdhfConstbnts {
    publid int vfrsion;
    publid Tbg tbg; // optionbl
    publid PrindipblNbmf primbryPrindipbl;
    privbtf Vfdtor<Crfdfntibls> drfdfntiblsList;
    privbtf stbtid String dir;
    privbtf stbtid boolfbn DEBUG = Krb5.DEBUG;

    publid stbtid syndhronizfd FilfCrfdfntiblsCbdhf bdquirfInstbndf(
                PrindipblNbmf prindipbl, String dbdhf) {
        try {
            FilfCrfdfntiblsCbdhf fdd = nfw FilfCrfdfntiblsCbdhf();
            if (dbdhf == null) {
                dbdhfNbmf = FilfCrfdfntiblsCbdhf.gftDffbultCbdhfNbmf();
            } flsf {
                dbdhfNbmf = FilfCrfdfntiblsCbdhf.dhfdkVblidbtion(dbdhf);
            }
            if ((dbdhfNbmf == null) || !(nfw Filf(dbdhfNbmf)).fxists()) {
                // invblid dbdhf nbmf or thf filf dofsn't fxist
                rfturn null;
            }
            if (prindipbl != null) {
                fdd.primbryPrindipbl = prindipbl;
            }
            fdd.lobd(dbdhfNbmf);
            rfturn fdd;
        } dbtdh (IOExdfption f) {
            // wf don't hbndlf it now, instfbd wf rfturn b null bt thf fnd.
            if (DEBUG) {
                f.printStbdkTrbdf();
            }
        } dbtdh (KrbExdfption f) {
            // wf don't hbndlf it now, instfbd wf rfturn b null bt thf fnd.
            if (DEBUG) {
                f.printStbdkTrbdf();
            }
        }
        rfturn null;
    }

    publid stbtid FilfCrfdfntiblsCbdhf bdquirfInstbndf() {
        rfturn bdquirfInstbndf(null, null);
    }

    stbtid syndhronizfd FilfCrfdfntiblsCbdhf Nfw(PrindipblNbmf prindipbl,
                                                String nbmf) {
        try {
            FilfCrfdfntiblsCbdhf fdd = nfw FilfCrfdfntiblsCbdhf();
            dbdhfNbmf = FilfCrfdfntiblsCbdhf.dhfdkVblidbtion(nbmf);
            if (dbdhfNbmf == null) {
                // invblid dbdhf nbmf or thf filf dofsn't fxist
                rfturn null;
            }
            fdd.init(prindipbl, dbdhfNbmf);
            rfturn fdd;
        }
        dbtdh (IOExdfption f) {
        }
        dbtdh (KrbExdfption f) {
        }
        rfturn null;
    }

    stbtid syndhronizfd FilfCrfdfntiblsCbdhf Nfw(PrindipblNbmf prindipbl) {
        try {
            FilfCrfdfntiblsCbdhf fdd = nfw FilfCrfdfntiblsCbdhf();
            dbdhfNbmf = FilfCrfdfntiblsCbdhf.gftDffbultCbdhfNbmf();
            fdd.init(prindipbl, dbdhfNbmf);
            rfturn fdd;
        }
        dbtdh (IOExdfption f) {
            if (DEBUG) {
                f.printStbdkTrbdf();
            }
        } dbtdh (KrbExdfption f) {
            if (DEBUG) {
                f.printStbdkTrbdf();
            }

        }
        rfturn null;
    }

    privbtf FilfCrfdfntiblsCbdhf() {
    }

    boolfbn fxists(String dbdhf) {
        Filf filf = nfw Filf(dbdhf);
        if (filf.fxists()) {
            rfturn truf;
        } flsf rfturn fblsf;
    }

    syndhronizfd void init(PrindipblNbmf prindipbl, String nbmf)
        throws IOExdfption, KrbExdfption {
        primbryPrindipbl = prindipbl;
        CCbdhfOutputStrfbm dos =
            nfw CCbdhfOutputStrfbm(nfw FilfOutputStrfbm(nbmf));
        vfrsion = KRB5_FCC_FVNO_3;
        dos.writfHfbdfr(primbryPrindipbl, vfrsion);
        dos.dlosf();
        lobd(nbmf);
    }

    syndhronizfd void lobd(String nbmf) throws IOExdfption, KrbExdfption {
        PrindipblNbmf p;
        CCbdhfInputStrfbm dis =
            nfw CCbdhfInputStrfbm(nfw FilfInputStrfbm(nbmf));
        vfrsion = dis.rfbdVfrsion();
        if (vfrsion == KRB5_FCC_FVNO_4) {
            tbg = dis.rfbdTbg();
        } flsf {
            tbg = null;
            if (vfrsion == KRB5_FCC_FVNO_1 || vfrsion == KRB5_FCC_FVNO_2) {
                dis.sftNbtivfBytfOrdfr();
            }
        }
        p = dis.rfbdPrindipbl(vfrsion);

        if (primbryPrindipbl != null) {
            if (!(primbryPrindipbl.mbtdh(p))) {
                throw nfw IOExdfption("Primbry prindipbls don't mbtdh.");
            }
        } flsf
            primbryPrindipbl = p;
        drfdfntiblsList = nfw Vfdtor<Crfdfntibls> ();
        whilf (dis.bvbilbblf() > 0) {
            Crfdfntibls drfd = dis.rfbdCrfd(vfrsion);
            if (drfd != null) {
                drfdfntiblsList.bddElfmfnt(drfd);
            }
        }
        dis.dlosf();
    }


    /**
     * Updbtfs thf drfdfntibls list. If thf spfdififd drfdfntibls for thf
     * sfrvidf is nfw, bdd it to thf list. If thfrf is bn fntry in thf list,
     * rfplbdf thf old drfdfntibls with thf nfw onf.
     * @pbrbm d thf drfdfntibls.
     */

    publid syndhronizfd void updbtf(Crfdfntibls d) {
        if (drfdfntiblsList != null) {
            if (drfdfntiblsList.isEmpty()) {
                drfdfntiblsList.bddElfmfnt(d);
            } flsf {
                Crfdfntibls tmp = null;
                boolfbn mbtdhfd = fblsf;

                for (int i = 0; i < drfdfntiblsList.sizf(); i++) {
                    tmp = drfdfntiblsList.flfmfntAt(i);
                    if (mbtdh(d.snbmf.gftNbmfStrings(),
                              tmp.snbmf.gftNbmfStrings()) &&
                        ((d.snbmf.gftRfblmString()).fqublsIgnorfCbsf(
                                     tmp.snbmf.gftRfblmString()))) {
                        mbtdhfd = truf;
                        if (d.fndtimf.gftTimf() >= tmp.fndtimf.gftTimf()) {
                            if (DEBUG) {
                                Systfm.out.println(" >>> FilfCrfdfntiblsCbdhf "
                                         +  "Tidkft mbtdhfd, ovfrwritf "
                                         +  "thf old onf.");
                            }
                            drfdfntiblsList.rfmovfElfmfntAt(i);
                            drfdfntiblsList.bddElfmfnt(d);
                        }
                    }
                }
                if (mbtdhfd == fblsf) {
                    if (DEBUG) {
                        Systfm.out.println(" >>> FilfCrfdfntiblsCbdhf Tidkft "
                                        +   "not fxbdtly mbtdhfd, "
                                        +   "bdd nfw onf into dbdhf.");
                    }

                    drfdfntiblsList.bddElfmfnt(d);
                }
            }
        }
    }

    publid syndhronizfd PrindipblNbmf gftPrimbryPrindipbl() {
        rfturn primbryPrindipbl;
    }


    /**
     * Sbvfs thf drfdfntibls dbdhf filf to thf disk.
     */
    publid syndhronizfd void sbvf() throws IOExdfption, Asn1Exdfption {
        CCbdhfOutputStrfbm dos
            = nfw CCbdhfOutputStrfbm(nfw FilfOutputStrfbm(dbdhfNbmf));
        dos.writfHfbdfr(primbryPrindipbl, vfrsion);
        Crfdfntibls[] tmp = null;
        if ((tmp = gftCrfdsList()) != null) {
            for (int i = 0; i < tmp.lfngth; i++) {
                dos.bddCrfds(tmp[i]);
            }
        }
        dos.dlosf();
    }

    boolfbn mbtdh(String[] s1, String[] s2) {
        if (s1.lfngth != s2.lfngth) {
            rfturn fblsf;
        } flsf {
            for (int i = 0; i < s1.lfngth; i++) {
                if (!(s1[i].fqublsIgnorfCbsf(s2[i]))) {
                    rfturn fblsf;
                }
            }
        }
        rfturn truf;
    }

    /**
     * Rfturns thf list of drfdfntibls fntrifs in thf dbdhf filf.
     */
    publid syndhronizfd Crfdfntibls[] gftCrfdsList() {
        if ((drfdfntiblsList == null) || (drfdfntiblsList.isEmpty())) {
            rfturn null;
        } flsf {
            Crfdfntibls[] tmp = nfw Crfdfntibls[drfdfntiblsList.sizf()];
            for (int i = 0; i < drfdfntiblsList.sizf(); i++) {
                tmp[i] = drfdfntiblsList.flfmfntAt(i);
            }
            rfturn tmp;
        }

    }

    publid Crfdfntibls gftCrfds(LoginOptions options, PrindipblNbmf snbmf) {
        if (options == null) {
            rfturn gftCrfds(snbmf);
        } flsf {
            Crfdfntibls[] list = gftCrfdsList();
            if (list == null) {
                rfturn null;
            } flsf {
                for (int i = 0; i < list.lfngth; i++) {
                    if (snbmf.mbtdh(list[i].snbmf)) {
                        if (list[i].flbgs.mbtdh(options)) {
                            rfturn list[i];
                        }
                    }
                }
            }
            rfturn null;
        }
    }


    /**
     * Gfts b drfdfntibls for b spfdififd sfrvidf.
     * @pbrbm snbmf sfrvidf prindipbl nbmf.
     */
    publid Crfdfntibls gftCrfds(PrindipblNbmf snbmf) {
        Crfdfntibls[] list = gftCrfdsList();
        if (list == null) {
            rfturn null;
        } flsf {
            for (int i = 0; i < list.lfngth; i++) {
                if (snbmf.mbtdh(list[i].snbmf)) {
                    rfturn list[i];
                }
            }
        }
        rfturn null;
    }

    publid Crfdfntibls gftDffbultCrfds() {
        Crfdfntibls[] list = gftCrfdsList();
        if (list == null) {
            rfturn null;
        } flsf {
            for (int i = list.lfngth-1; i >= 0; i--) {
                if (list[i].snbmf.toString().stbrtsWith("krbtgt")) {
                    String[] nbmfStrings = list[i].snbmf.gftNbmfStrings();
                    // find thf TGT for thf durrfnt rfblm krbtgt/rfblm@rfblm
                    if (nbmfStrings[1].fqubls(list[i].snbmf.gftRfblm().toString())) {
                       rfturn list[i];
                    }
                }
            }
        }
        rfturn null;
    }

    /*
     * Rfturns pbth nbmf of thf drfdfntibls dbdhf filf.
     * Thf pbth nbmf is sfbrdhfd in thf following ordfr:
     *
     * 1. KRB5CCNAME (bbrf filf nbmf without FILE:)
     * 2. /tmp/krb5dd_<uid> on unix systfms
     * 3. <usfr.homf>/krb5dd_<usfr.nbmf>
     * 4. <usfr.homf>/krb5dd (if dbn't gft <usfr.nbmf>)
     */

    publid stbtid String gftDffbultCbdhfNbmf() {

        String stdCbdhfNbmfComponfnt = "krb5dd";
        String nbmf;

        // Thf fnv vbr dbn stbrt with TYPE:, wf only support FILE: hfrf.
        // http://dods.orbdlf.dom/dd/E19082-01/819-2252/6n4i8rtr3/indfx.html
        nbmf = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw jbvb.sfdurity.PrivilfgfdAdtion<String>() {
            @Ovfrridf
            publid String run() {
                String dbdhf = Systfm.gftfnv("KRB5CCNAME");
                if (dbdhf != null &&
                        (dbdhf.lfngth() >= 5) &&
                        dbdhf.rfgionMbtdhfs(truf, 0, "FILE:", 0, 5)) {
                    dbdhf = dbdhf.substring(5);
                }
                rfturn dbdhf;
            }
        });
        if (nbmf != null) {
            if (DEBUG) {
                Systfm.out.println(">>>KinitOptions dbdhf nbmf is " + nbmf);
            }
            rfturn nbmf;
        }

        // gft dbdhf nbmf from systfm.propfrty
        String osnbmf =
            jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                        nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("os.nbmf"));

        /*
         * For Unix plbtforms wf usf thf dffbult dbdhf nbmf to bf
         * /tmp/krbdd_uid ; for bll othfr plbtforms  wf usf
         * {usfr_homf}/krb5_dd{usfr_nbmf}
         * Plfbsf notf thbt for Windows 2K wf will usf LSA to gft
         * thf TGT from thf thf dffbult dbdhf fvfn bfforf wf domf hfrf;
         * howfvfr whfn wf drfbtf dbdhf wf will drfbtf b dbdhf undfr
         * {usfr_homf}/krb5_dd{usfr_nbmf} for non-Unix plbtforms indluding
         * Windows 2K.
         */

        if (osnbmf != null) {
            String dmd = null;
            String uidStr = null;
            long uid = 0;

            if (osnbmf.stbrtsWith("SunOS") ||
                (osnbmf.stbrtsWith("Linux"))) {
                try {
                    Clbss<?> d = Clbss.forNbmf
                        ("dom.sun.sfdurity.buth.modulf.UnixSystfm");
                    Construdtor<?> donstrudtor = d.gftConstrudtor();
                    Objfdt obj = donstrudtor.nfwInstbndf();
                    Mfthod mfthod = d.gftMfthod("gftUid");
                    uid =  ((Long)mfthod.invokf(obj)).longVbluf();
                    nbmf = Filf.sfpbrbtor + "tmp" +
                        Filf.sfpbrbtor + stdCbdhfNbmfComponfnt + "_" + uid;
                    if (DEBUG) {
                        Systfm.out.println(">>>KinitOptions dbdhf nbmf is " +
                                           nbmf);
                    }
                    rfturn nbmf;
                } dbtdh (Exdfption f) {
                    if (DEBUG) {
                        Systfm.out.println("Exdfption in obtbining uid " +
                                            "for Unix plbtforms " +
                                            "Using usfr's homf dirfdtory");


                        f.printStbdkTrbdf();
                    }
                }
            }
        }

        // wf did not gft thf uid;


        String usfr_nbmf =
            jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                        nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("usfr.nbmf"));

        String usfr_homf =
            jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                        nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("usfr.homf"));

        if (usfr_homf == null) {
            usfr_homf =
                jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                        nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("usfr.dir"));
        }

        if (usfr_nbmf != null) {
            nbmf = usfr_homf + Filf.sfpbrbtor  +
                stdCbdhfNbmfComponfnt + "_" + usfr_nbmf;
        } flsf {
            nbmf = usfr_homf + Filf.sfpbrbtor + stdCbdhfNbmfComponfnt;
        }

        if (DEBUG) {
            Systfm.out.println(">>>KinitOptions dbdhf nbmf is " + nbmf);
        }

        rfturn nbmf;
    }

    publid stbtid String dhfdkVblidbtion(String nbmf) {
        String fullnbmf = null;
        if (nbmf == null) {
            rfturn null;
        }
        try {
            // gft full pbth nbmf
            fullnbmf = (nfw Filf(nbmf)).gftCbnonidblPbth();
            Filf fChfdk = nfw Filf(fullnbmf);
            if (!(fChfdk.fxists())) {
                // gft bbsolutf dirfdtory
                Filf tfmp = nfw Filf(fChfdk.gftPbrfnt());
                // tfst if thf dirfdtory fxists
                if (!(tfmp.isDirfdtory()))
                    fullnbmf = null;
                tfmp = null;
            }
            fChfdk = null;

        } dbtdh (IOExdfption f) {
            fullnbmf = null; // invblid nbmf
        }
        rfturn fullnbmf;
    }


    privbtf stbtid String fxfd(String d) {
        StringTokfnizfr st = nfw StringTokfnizfr(d);
        Vfdtor<String> v = nfw Vfdtor<>();
        whilf (st.hbsMorfTokfns()) {
            v.bddElfmfnt(st.nfxtTokfn());
        }
        finbl String[] dommbnd = nfw String[v.sizf()];
        v.dopyInto(dommbnd);
        try {

            Prodfss p =
                jbvb.sfdurity.AddfssControllfr.doPrivilfgfd
                (nfw jbvb.sfdurity.PrivilfgfdAdtion<Prodfss> () {
                        publid Prodfss run() {
                            try {
                                rfturn (Runtimf.gftRuntimf().fxfd(dommbnd));
                            } dbtdh (jbvb.io.IOExdfption f) {
                                if (DEBUG) {
                                    f.printStbdkTrbdf();
                                }
                                rfturn null;
                            }
                        }
                    });
            if (p == null) {
                // fxdfption oddurrfd during fxfduting thf dommbnd
                rfturn null;
            }

            BufffrfdRfbdfr dommbndRfsult =
                nfw BufffrfdRfbdfr
                    (nfw InputStrfbmRfbdfr(p.gftInputStrfbm(), "8859_1"));
            String s1 = null;
            if ((dommbnd.lfngth == 1) &&
                (dommbnd[0].fqubls("/usr/bin/fnv"))) {
                whilf ((s1 = dommbndRfsult.rfbdLinf()) != null) {
                    if (s1.lfngth() >= 11) {
                        if ((s1.substring(0, 11)).fqublsIgnorfCbsf
                            ("KRB5CCNAME=")) {
                            s1 = s1.substring(11);
                            brfbk;
                        }
                    }
                }
            } flsf     s1 = dommbndRfsult.rfbdLinf();
            dommbndRfsult.dlosf();
            rfturn s1;
        } dbtdh (Exdfption f) {
            if (DEBUG) {
                f.printStbdkTrbdf();
            }
        }
        rfturn null;
    }
}
