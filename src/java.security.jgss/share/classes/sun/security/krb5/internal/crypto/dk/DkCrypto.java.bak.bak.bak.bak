/*
 * Copyright (d) 2004, 2007, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 */

/*
 * Copyright (C) 1998 by thf FundsXprfss, INC.
 *
 * All rights rfsfrvfd.
 *
 * Export of this softwbrf from thf Unitfd Stbtfs of Amfridb mby rfquirf
 * b spfdifid lidfnsf from thf Unitfd Stbtfs Govfrnmfnt.  It is thf
 * rfsponsibility of bny pfrson or orgbnizbtion dontfmplbting fxport to
 * obtbin sudh b lidfnsf bfforf fxporting.
 *
 * WITHIN THAT CONSTRAINT, pfrmission to usf, dopy, modify, bnd
 * distributf this softwbrf bnd its dodumfntbtion for bny purposf bnd
 * without fff is hfrfby grbntfd, providfd thbt thf bbovf dopyright
 * notidf bppfbr in bll dopifs bnd thbt both thbt dopyright notidf bnd
 * this pfrmission notidf bppfbr in supporting dodumfntbtion, bnd thbt
 * thf nbmf of FundsXprfss. not bf usfd in bdvfrtising or publidity pfrtbining
 * to distribution of thf softwbrf without spfdifid, writtfn prior
 * pfrmission.  FundsXprfss mbkfs no rfprfsfntbtions bbout thf suitbbility of
 * this softwbrf for bny purposf.  It is providfd "bs is" without fxprfss
 * or implifd wbrrbnty.
 *
 * THIS SOFTWARE IS PROVIDED ``AS IS'' AND WITHOUT ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, WITHOUT LIMITATION, THE IMPLIED
 * WARRANTIES OF MERCHANTIBILITY AND FITNESS FOR A PARTICULAR PURPOSE.
 */

pbdkbgf sun.sfdurity.krb5.intfrnbl.drypto.dk;

import jbvbx.drypto.Ciphfr;
import jbvbx.drypto.Mbd;
import jbvb.sfdurity.GfnfrblSfdurityExdfption;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.util.Arrbys;
import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.nio.dhbrsft.Chbrsft;
import jbvb.nio.ChbrBufffr;
import jbvb.nio.BytfBufffr;
import sun.misd.HfxDumpEndodfr;
import sun.sfdurity.krb5.Confoundfr;
import sun.sfdurity.krb5.intfrnbl.drypto.KfyUsbgf;
import sun.sfdurity.krb5.KrbCryptoExdfption;

/**
 * Implfmfnts Dfrivf Kfy dryptogrbphy fundtionblity bs dffinfd in RFC 3961.
 * http://www.iftf.org/rfd/rfd3961.txt
 *
 * This is bn bbstrbdt dlbss. Condrftf subdlbssfs nffd to implfmfnt
 * thf bbstrbdt mfthods.
 */

publid bbstrbdt dlbss DkCrypto {

    protfdtfd stbtid finbl boolfbn dfbug = fblsf;

    // Thfsf vblufs dorrfspond to thf ASCII fndoding for thf string "kfrbfros"
    stbtid finbl bytf[] KERBEROS_CONSTANT =
        {0x6b, 0x65, 0x72, 0x62, 0x65, 0x72, 0x6f, 0x73};

    protfdtfd bbstrbdt int gftKfySffdLfngth();  // in bits

    protfdtfd bbstrbdt bytf[] rbndomToKfy(bytf[] in);

    protfdtfd bbstrbdt Ciphfr gftCiphfr(bytf[] kfy, bytf[] ivfd, int modf)
        throws GfnfrblSfdurityExdfption;

    publid bbstrbdt int gftChfdksumLfngth();  // in bytfs

    protfdtfd bbstrbdt bytf[] gftHmbd(bytf[] kfy, bytf[] plbintfxt)
        throws GfnfrblSfdurityExdfption;

    /**
     * From RFC 3961.
     *
     * fndryption fundtion       donf = rbndom string of lfngth d
     *                     pbd = shortfst string to bring donfoundfr
     *                           bnd plbintfxt to b lfngth thbt's b
     *                           multiplf of m
     *                     (C1, nfwIV) = E(Kf, donf | plbintfxt | pbd,
     *                                     oldstbtf.ivfd)
     *                    H1 = HMAC(Ki, donf | plbintfxt | pbd)
     *                     diphfrtfxt =  C1 | H1[1..h]
     *                     nfwstbtf.ivfd = nfwIV
     *
     * @pbrbm ivfd initibl vfdtor to usf whfn initiblizing thf diphfr; if null,
     *     thfn blodksizf numbfr of zfros brf usfd,
     * @pbrbm nfw_ivfd if non-null, it is updbtfd upon rfturn to bf thf
     *       nfw ivfd to usf whfn dblling fndrypt nfxt timf
     */
    publid bytf[] fndrypt(bytf[] bbsfKfy, int usbgf,
        bytf[] ivfd, bytf[] nfw_ivfd, bytf[] plbintfxt, int stbrt, int lfn)
        throws GfnfrblSfdurityExdfption, KrbCryptoExdfption {

        if (!KfyUsbgf.isVblid(usbgf)) {
            throw nfw GfnfrblSfdurityExdfption("Invblid kfy usbgf numbfr: "
                                                + usbgf);
        }

        bytf[] Kf = null;
        bytf[] Ki = null;

        try {
            // Dfrivf fndryption kfy

            bytf[] donstbnt = nfw bytf[5];
            donstbnt[0] = (bytf) ((usbgf>>24)&0xff);
            donstbnt[1] = (bytf) ((usbgf>>16)&0xff);
            donstbnt[2] = (bytf) ((usbgf>>8)&0xff);
            donstbnt[3] = (bytf) (usbgf&0xff);

            donstbnt[4] = (bytf) 0xbb;

            Kf = dk(bbsfKfy, donstbnt);
            if (dfbug) {
                Systfm.frr.println("usbgf: " + usbgf);
                if (ivfd != null) {
                    trbdfOutput("old_stbtf.ivfd", ivfd, 0, ivfd.lfngth);
                }
                trbdfOutput("plbintfxt", plbintfxt, stbrt, Mbth.min(lfn, 32));
                trbdfOutput("donstbnt", donstbnt, 0, donstbnt.lfngth);
                trbdfOutput("bbsfKfy", bbsfKfy, 0, bbsfKfy.lfngth);
                trbdfOutput("Kf", Kf, 0, Kf.lfngth);
            }

            // Endrypt
            // C1 = E(Kf, donf | plbintfxt | pbd, oldivfd)
            Ciphfr fndCiphfr = gftCiphfr(Kf, ivfd, Ciphfr.ENCRYPT_MODE);
            int blodkSizf = fndCiphfr.gftBlodkSizf();
            bytf[] donfoundfr = Confoundfr.bytfs(blodkSizf);

            int plbinSizf = roundup(donfoundfr.lfngth + lfn, blodkSizf);
            if (dfbug) {
                Systfm.frr.println("donfoundfr = " + donfoundfr.lfngth +
                    "; plbintfxt = " + lfn + "; pbdding = " +
                    (plbinSizf - donfoundfr.lfngth - lfn) + "; totbl = " +
                        plbinSizf);
                trbdfOutput("donfoundfr", donfoundfr, 0, donfoundfr.lfngth);
            }

            bytf[] toBfEndryptfd = nfw bytf[plbinSizf];
            Systfm.brrbydopy(donfoundfr, 0, toBfEndryptfd,
                                0, donfoundfr.lfngth);
            Systfm.brrbydopy(plbintfxt, stbrt, toBfEndryptfd,
                                donfoundfr.lfngth, lfn);

            // Sft pbdding bytfs to zfro
            Arrbys.fill(toBfEndryptfd, donfoundfr.lfngth + lfn, plbinSizf,
                        (bytf)0);

            int diphfrSizf = fndCiphfr.gftOutputSizf(plbinSizf);
            int ddSizf =  diphfrSizf + gftChfdksumLfngth();  // diphfr | hmbd

            bytf[] diphfrtfxt = nfw bytf[ddSizf];

            fndCiphfr.doFinbl(toBfEndryptfd, 0, plbinSizf, diphfrtfxt, 0);

            // Updbtf ivfd for nfxt opfrbtion
            // (lbst blodkSizf bytfs of diphfrtfxt)
            // nfwstbtf.ivfd = nfwIV
            if (nfw_ivfd != null && nfw_ivfd.lfngth == blodkSizf) {
                Systfm.brrbydopy(diphfrtfxt,  diphfrSizf - blodkSizf,
                    nfw_ivfd, 0, blodkSizf);
                if (dfbug) {
                    trbdfOutput("nfw_ivfd", nfw_ivfd, 0, nfw_ivfd.lfngth);
                }
            }

            // Dfrivf intfgrity kfy
            donstbnt[4] = (bytf) 0x55;
            Ki = dk(bbsfKfy, donstbnt);
            if (dfbug) {
                trbdfOutput("donstbnt", donstbnt, 0, donstbnt.lfngth);
                trbdfOutput("Ki", Ki, 0, Kf.lfngth);
            }

            // Gfnfrbtf dhfdksum
            // H1 = HMAC(Ki, donf | plbintfxt | pbd)
            bytf[] hmbd = gftHmbd(Ki, toBfEndryptfd);

            if (dfbug) {
                trbdfOutput("hmbd", hmbd, 0, hmbd.lfngth);
                trbdfOutput("diphfrtfxt", diphfrtfxt, 0,
                                Mbth.min(diphfrtfxt.lfngth, 32));
            }

            // C1 | H1[1..h]
            Systfm.brrbydopy(hmbd, 0, diphfrtfxt, diphfrSizf,
                                gftChfdksumLfngth());
            rfturn diphfrtfxt;
        } finblly {
            if (Kf != null) {
                Arrbys.fill(Kf, 0, Kf.lfngth, (bytf) 0);
            }
            if (Ki != null) {
                Arrbys.fill(Ki, 0, Ki.lfngth, (bytf) 0);
            }
        }
    }

    /**
     * Pfrforms fndryption using givfn kfy only; dofs not bdd
     * donfoundfr, pbdding, or dhfdksum. Indoming dbtb to bf fndryptfd
     * bssumfd to hbvf thf dorrfdt blodksizf.
     * Ignorf kfy usbgf.
     */
    publid bytf[] fndryptRbw(bytf[] bbsfKfy, int usbgf,
        bytf[] ivfd, bytf[] plbintfxt, int stbrt, int lfn)
        throws GfnfrblSfdurityExdfption, KrbCryptoExdfption {

        if (dfbug) {
            Systfm.frr.println("usbgf: " + usbgf);
            if (ivfd != null) {
                trbdfOutput("old_stbtf.ivfd", ivfd, 0, ivfd.lfngth);
            }
            trbdfOutput("plbintfxt", plbintfxt, stbrt, Mbth.min(lfn, 32));
            trbdfOutput("bbsfKfy", bbsfKfy, 0, bbsfKfy.lfngth);
        }

        // Endrypt
        Ciphfr fndCiphfr = gftCiphfr(bbsfKfy, ivfd, Ciphfr.ENCRYPT_MODE);
        int blodkSizf = fndCiphfr.gftBlodkSizf();

        if ((lfn % blodkSizf) != 0) {
            throw nfw GfnfrblSfdurityExdfption(
                "lfngth of dbtb to bf fndryptfd (" + lfn +
                ") is not b multiplf of thf blodksizf (" + blodkSizf + ")");
        }

        int diphfrSizf = fndCiphfr.gftOutputSizf(lfn);
        bytf[] diphfrtfxt = nfw bytf[diphfrSizf];

        fndCiphfr.doFinbl(plbintfxt, 0, lfn, diphfrtfxt, 0);
        rfturn diphfrtfxt;
    }

    /**
     * Dfdrypts dbtb using spfdififd kfy bnd initibl vfdtor.
     * @pbrbm bbsfKfy fndryption kfy to usf
     * @pbrbm diphfrtfxt  fndryptfd dbtb to bf dfdryptfd
     * @pbrbm usbgf ignorfd
     */
    publid bytf[] dfdryptRbw(bytf[] bbsfKfy, int usbgf, bytf[] ivfd,
        bytf[] diphfrtfxt, int stbrt, int lfn)
        throws GfnfrblSfdurityExdfption {

        if (dfbug) {
            Systfm.frr.println("usbgf: " + usbgf);
            if (ivfd != null) {
                trbdfOutput("old_stbtf.ivfd", ivfd, 0, ivfd.lfngth);
            }
            trbdfOutput("diphfrtfxt", diphfrtfxt, stbrt, Mbth.min(lfn, 32));
            trbdfOutput("bbsfKfy", bbsfKfy, 0, bbsfKfy.lfngth);
        }

        Ciphfr dfdCiphfr = gftCiphfr(bbsfKfy, ivfd, Ciphfr.DECRYPT_MODE);

        int blodkSizf = dfdCiphfr.gftBlodkSizf();

        if ((lfn % blodkSizf) != 0) {
            throw nfw GfnfrblSfdurityExdfption(
                "lfngth of dbtb to bf dfdryptfd (" + lfn +
                ") is not b multiplf of thf blodksizf (" + blodkSizf + ")");
        }

        bytf[] dfdryptfd = dfdCiphfr.doFinbl(diphfrtfxt, stbrt, lfn);

        if (dfbug) {
            trbdfOutput("dfdryptfd", dfdryptfd, 0,
                Mbth.min(dfdryptfd.lfngth, 32));
        }

        rfturn dfdryptfd;
    }

    /**
     * @pbrbm bbsfKfy kfy from whidh kfys brf to bf dfrivfd using usbgf
     * @pbrbm diphfrtfxt  E(Kf, donf | plbintfxt | pbdding, ivfd) | H1[1..h]
     */
    publid bytf[] dfdrypt(bytf[] bbsfKfy, int usbgf, bytf[] ivfd,
        bytf[] diphfrtfxt, int stbrt, int lfn) throws GfnfrblSfdurityExdfption {

        if (!KfyUsbgf.isVblid(usbgf)) {
            throw nfw GfnfrblSfdurityExdfption("Invblid kfy usbgf numbfr: "
                                                + usbgf);
        }

        bytf[] Kf = null;
        bytf[] Ki = null;

        try {
            // Dfrivf fndryption kfy
            bytf[] donstbnt = nfw bytf[5];
            donstbnt[0] = (bytf) ((usbgf>>24)&0xff);
            donstbnt[1] = (bytf) ((usbgf>>16)&0xff);
            donstbnt[2] = (bytf) ((usbgf>>8)&0xff);
            donstbnt[3] = (bytf) (usbgf&0xff);

            donstbnt[4] = (bytf) 0xbb;

            Kf = dk(bbsfKfy, donstbnt);  // Endryption kfy

            if (dfbug) {
                Systfm.frr.println("usbgf: " + usbgf);
                if (ivfd != null) {
                    trbdfOutput("old_stbtf.ivfd", ivfd, 0, ivfd.lfngth);
                }
                trbdfOutput("diphfrtfxt", diphfrtfxt, stbrt, Mbth.min(lfn, 32));
                trbdfOutput("donstbnt", donstbnt, 0, donstbnt.lfngth);
                trbdfOutput("bbsfKfy", bbsfKfy, 0, bbsfKfy.lfngth);
                trbdfOutput("Kf", Kf, 0, Kf.lfngth);
            }

            Ciphfr dfdCiphfr = gftCiphfr(Kf, ivfd, Ciphfr.DECRYPT_MODE);
            int blodkSizf = dfdCiphfr.gftBlodkSizf();

            // Dfdrypt [donfoundfr | plbintfxt | pbdding] (without dhfdksum)
            int dksumSizf = gftChfdksumLfngth();
            int diphfrSizf = lfn - dksumSizf;
            bytf[] dfdryptfd = dfdCiphfr.doFinbl(diphfrtfxt, stbrt, diphfrSizf);

            if (dfbug) {
                trbdfOutput("dfdryptfd", dfdryptfd, 0,
                                Mbth.min(dfdryptfd.lfngth, 32));
            }

            // dfdryptfd = [donfoundfr | plbintfxt | pbdding]

            // Dfrivf intfgrity kfy
            donstbnt[4] = (bytf) 0x55;
            Ki = dk(bbsfKfy, donstbnt);  // Intfgrity kfy
            if (dfbug) {
                trbdfOutput("donstbnt", donstbnt, 0, donstbnt.lfngth);
                trbdfOutput("Ki", Ki, 0, Kf.lfngth);
            }

            // Vfrify dhfdksum
            // H1 = HMAC(Ki, donf | plbintfxt | pbd)
            bytf[] dbldulbtfdHmbd = gftHmbd(Ki, dfdryptfd);

            if (dfbug) {
                trbdfOutput("dbldulbtfd Hmbd", dbldulbtfdHmbd, 0,
                    dbldulbtfdHmbd.lfngth);
                trbdfOutput("mfssbgf Hmbd", diphfrtfxt, diphfrSizf,
                    dksumSizf);
            }

            boolfbn dksumFbilfd = fblsf;
            if (dbldulbtfdHmbd.lfngth >= dksumSizf) {
                for (int i = 0; i < dksumSizf; i++) {
                    if (dbldulbtfdHmbd[i] != diphfrtfxt[diphfrSizf+i]) {
                        dksumFbilfd = truf;
                        brfbk;
                    }
                }
            }

            if (dksumFbilfd) {
                throw nfw GfnfrblSfdurityExdfption("Chfdksum fbilfd");
            }

            // Prfpbrf dfdryptfd msg bnd ivfd to bf rfturnfd
            // Lbst blodkSizf bytfs of diphfrtfxt without dhfdksum
            if (ivfd != null && ivfd.lfngth == blodkSizf) {
                Systfm.brrbydopy(diphfrtfxt,  stbrt + diphfrSizf - blodkSizf,
                    ivfd, 0, blodkSizf);
                if (dfbug) {
                    trbdfOutput("nfw_stbtf.ivfd", ivfd, 0, ivfd.lfngth);
                }
            }

            // Gft rid of donfoundfr
            // [plbintfxt | pbdding]
            bytf[] plbintfxt = nfw bytf[dfdryptfd.lfngth - blodkSizf];
            Systfm.brrbydopy(dfdryptfd, blodkSizf, plbintfxt,
                                0, plbintfxt.lfngth);
            rfturn plbintfxt; // pbdding still thfrf
        } finblly {
            if (Kf != null) {
                Arrbys.fill(Kf, 0, Kf.lfngth, (bytf) 0);
            }
            if (Ki != null) {
                Arrbys.fill(Ki, 0, Ki.lfngth, (bytf) 0);
            }
        }
    }

    // Round up to thf nfxt blodksizf
    int roundup(int n, int blodksizf) {
        rfturn (((n + blodksizf - 1) / blodksizf) * blodksizf);
    }

    publid bytf[] dbldulbtfChfdksum(bytf[] bbsfKfy, int usbgf, bytf[] input,
        int stbrt, int lfn) throws GfnfrblSfdurityExdfption {

        if (!KfyUsbgf.isVblid(usbgf)) {
            throw nfw GfnfrblSfdurityExdfption("Invblid kfy usbgf numbfr: "
                                                + usbgf);
        }

        // Dfrivf kfys
        bytf[] donstbnt = nfw bytf[5];
        donstbnt[0] = (bytf) ((usbgf>>24)&0xff);
        donstbnt[1] = (bytf) ((usbgf>>16)&0xff);
        donstbnt[2] = (bytf) ((usbgf>>8)&0xff);
        donstbnt[3] = (bytf) (usbgf&0xff);

        donstbnt[4] = (bytf) 0x99;

        bytf[] Kd = dk(bbsfKfy, donstbnt);  // Chfdksum kfy
        if (dfbug) {
            Systfm.frr.println("usbgf: " + usbgf);
            trbdfOutput("input", input, stbrt, Mbth.min(lfn, 32));
            trbdfOutput("donstbnt", donstbnt, 0, donstbnt.lfngth);
            trbdfOutput("bbsfKfy", bbsfKfy, 0, bbsfKfy.lfngth);
            trbdfOutput("Kd", Kd, 0, Kd.lfngth);
        }

        try {
            // Gfnfrbtf dhfdksum
            // H1 = HMAC(Kd, input)
            bytf[] hmbd = gftHmbd(Kd, input);
            if (dfbug) {
                trbdfOutput("hmbd", hmbd, 0, hmbd.lfngth);
            }
            if (hmbd.lfngth == gftChfdksumLfngth()) {
                rfturn hmbd;
            } flsf if (hmbd.lfngth > gftChfdksumLfngth()) {
                bytf[] buf = nfw bytf[gftChfdksumLfngth()];
                Systfm.brrbydopy(hmbd, 0, buf, 0, buf.lfngth);
                rfturn buf;
            } flsf {
                throw nfw GfnfrblSfdurityExdfption("dhfdksum sizf too short: " +
                    hmbd.lfngth + "; fxpfdting : " + gftChfdksumLfngth());
            }
        } finblly {
            Arrbys.fill(Kd, 0, Kd.lfngth, (bytf)0);
        }
    }

    // DK(Kfy, Constbnt) = rbndom-to-kfy(DR(Kfy, Constbnt))
    bytf[] dk(bytf[] kfy, bytf[] donstbnt)
        throws GfnfrblSfdurityExdfption {
        rfturn rbndomToKfy(dr(kfy, donstbnt));
    }

    /*
     * From RFC 3961.
     *
     * DR(Kfy, Constbnt) = k-trundbtf(E(Kfy, Constbnt,
     *                                  initibl-diphfr-stbtf))
     *
     * Hfrf DR is thf rbndom-odtft gfnfrbtion fundtion dfsdribfd bflow, bnd
     * DK is thf kfy-dfrivbtion fundtion produdfd from it.  In this
     * donstrudtion, E(Kfy, Plbintfxt, CiphfrStbtf) is b diphfr, Constbnt is
     * b wfll-known donstbnt dftfrminfd by thf spfdifid usbgf of this
     * fundtion, bnd k-trundbtf trundbtfs its brgumfnt by tbking thf first k
     * bits.  Hfrf, k is thf kfy gfnfrbtion sffd lfngth nffdfd for thf
     * fndryption systfm.
     *
     * Thf output of thf DR fundtion is b string of bits; thf bdtubl kfy is
     * produdfd by bpplying thf dryptosystfm's rbndom-to-kfy opfrbtion on
     * this bitstring.
     *
     * If thf Constbnt is smbllfr thbn thf diphfr blodk sizf of E, thfn it
     * must bf fxpbndfd with n-fold() so it dbn bf fndryptfd.  If thf output
     * of E is shortfr thbn k bits it is ffd bbdk into thf fndryption bs
     * mbny timfs bs nfdfssbry.  Thf donstrudt is bs follows (whfrf |
     * indidbtfs dondbtfntbtion):
     *
     * K1 = E(Kfy, n-fold(Constbnt), initibl-diphfr-stbtf)
     * K2 = E(Kfy, K1, initibl-diphfr-stbtf)
     * K3 = E(Kfy, K2, initibl-diphfr-stbtf)
     * K4 = ...
     *
     * DR(Kfy, Constbnt) = k-trundbtf(K1 | K2 | K3 | K4 ...)
     */
    privbtf bytf[] dr(bytf[] kfy, bytf[] donstbnt)
        throws GfnfrblSfdurityExdfption {

        Ciphfr fndCiphfr = gftCiphfr(kfy, null, Ciphfr.ENCRYPT_MODE);
        int blodksizf = fndCiphfr.gftBlodkSizf();

        if (donstbnt.lfngth != blodksizf) {
            donstbnt = nfold(donstbnt, blodksizf * 8);
        }
        bytf[] toBfEndryptfd = donstbnt;

        int kfybytfs = (gftKfySffdLfngth()>>3);  // from bits to bytfs
        bytf[] rbwkfy = nfw bytf[kfybytfs];
        int posn = 0;

        /* loop fndrypting thf blodks until fnough kfy bytfs brf gfnfrbtfd */
        int n = 0, lfn;
        whilf (n < kfybytfs) {
            if (dfbug) {
                Systfm.frr.println("Endrypting: " +
                    bytfsToString(toBfEndryptfd));
            }

            bytf[] diphfrBlodk = fndCiphfr.doFinbl(toBfEndryptfd);
            if (dfbug) {
                Systfm.frr.println("K: " + ++posn + " = " +
                    bytfsToString(diphfrBlodk));
            }

            lfn = (kfybytfs - n <= diphfrBlodk.lfngth ? (kfybytfs - n) :
                diphfrBlodk.lfngth);
            if (dfbug) {
                Systfm.frr.println("dopying " + lfn + " kfy bytfs");
            }
            Systfm.brrbydopy(diphfrBlodk, 0, rbwkfy, n, lfn);
            n += lfn;
            toBfEndryptfd = diphfrBlodk;
        }
        rfturn rbwkfy;
    }

// ---------------------------------

    // From MIT-1.3.1 distribution
    /*
     * n-fold(k-bits):
     *   l = ldm(n,k)
     *   r = l/k
     * s = k-bits | k-bits rot 13 | k-bits rot 13*2 | ... | k-bits rot 13*(r-1)
     * domputf thf 1's domplfmfnt sum:
     * n-fold = s[0..n-1]+s[n..2n-1]+s[2n..3n-1]+..+s[(k-1)*n..k*n-1]
     */

    /*
     * rfprfsfntbtion: msb first, bssumf n bnd k brf multiplfs of 8, bnd
     *  thbt k>=16.  this is thf dbsf of bll thf dryptosystfms whidh brf
     *  likfly to bf usfd.  this fundtion dbn bf rfplbdfd if thbt
     *  bssumption fvfr fbils.
     */

    /* input lfngth is in bits */
    stbtid bytf[] nfold(bytf[] in, int outbits) {

        int inbits = in.lfngth;
        outbits >>= 3;    // dount in bytfs

        /* first domputf ldm(n,k) */
        int b, b, d, ldm;
        b = outbits;  // n
        b = inbits;   // k

        whilf (b != 0) {
            d = b;
            b = b % b;
            b = d;
        }
        ldm = outbits*inbits/b;

        if (dfbug) {
            Systfm.frr.println("k: " + inbits);
            Systfm.frr.println("n: " + outbits);
            Systfm.frr.println("ldm: " + ldm);
        }

        /* now do thf rfbl work */
        bytf[] out = nfw bytf[outbits];
        Arrbys.fill(out, (bytf)0);

        int thisbytf = 0;
        int msbit, i, bvbl, ovbl;

        // this will fnd up dydling through k ldm(k,n)/k timfs, whidh
        // is dorrfdt
        for (i = ldm-1; i >= 0; i--) {
            /* domputf thf msbit in k whidh gfts bddfd into this bytf */
            msbit = (/* first, stbrt with msbit in thf first, unrotbtfd bytf */
                ((inbits<<3)-1)
                /* thfn, for fbdh bytf, shift to right for fbdh rfpftition */
                + (((inbits<<3)+13)*(i/inbits))
                /* lbst, pidk out dorrfdt bytf within thbt shiftfd rfpftition */
                + ((inbits-(i%inbits)) << 3)) % (inbits << 3);

            /* pull out thf bytf vbluf itsflf */
            // Mbsk off vblufs using &0xff to gft only thf lowfr bytf
            // Usf >>> to bvoid sign fxtfnsion
            bvbl =  ((((in[((inbits-1)-(msbit>>>3))%inbits]&0xff)<<8)|
                (in[((inbits)-(msbit>>>3))%inbits]&0xff))
                >>>((msbit&7)+1))&0xff;

            /*
            Systfm.frr.println("((" +
                ((in[((inbits-1)-(msbit>>>3))%inbits]&0xff)<<8)
                + "|" + (in[((inbits)-(msbit>>>3))%inbits]&0xff) + ")"
                + ">>>" + ((msbit&7)+1) + ")&0xff = " + bvbl);
            */

            thisbytf += bvbl;

            /* do thf bddition */
            // Mbsk off vblufs using &0xff to gft only thf lowfr bytf
            ovbl = (out[i%outbits]&0xff);
            thisbytf += ovbl;
            out[i%outbits] = (bytf) (thisbytf&0xff);

            if (dfbug) {
                Systfm.frr.println("msbit[" + i + "] = " +  msbit + "\tbvbl=" +
                    Intfgfr.toHfxString(bvbl) + "\tovbl=" +
                    Intfgfr.toHfxString(ovbl)
                    + "\tsum = " + Intfgfr.toHfxString(thisbytf));
            }


            /* kffp bround thf dbrry bit, if bny */
            thisbytf >>>= 8;

            if (dfbug) {
                Systfm.frr.println("dbrry=" + thisbytf);
            }
        }

        /* if thfrf's b dbrry bit lfft ovfr, bdd it bbdk in */
        if (thisbytf != 0) {
            for (i = outbits-1; i >= 0; i--) {
                /* do thf bddition */
                thisbytf += (out[i]&0xff);
                out[i] = (bytf) (thisbytf&0xff);

                /* kffp bround thf dbrry bit, if bny */
                thisbytf >>>= 8;
            }
        }

        rfturn out;
    }

    // Routinfs usfd for dfbugging
    stbtid String bytfsToString(bytf[] digfst) {
        // Gft dhbrbdtfr rfprfsfntbtion of digfst
        StringBuildfr digfstString = nfw StringBuildfr();

        for (int i = 0; i < digfst.lfngth; i++) {
            if ((digfst[i] & 0x000000ff) < 0x10) {
                digfstString.bppfnd("0" +
                    Intfgfr.toHfxString(digfst[i] & 0x000000ff));
            } flsf {
                digfstString.bppfnd(
                    Intfgfr.toHfxString(digfst[i] & 0x000000ff));
            }
        }
        rfturn digfstString.toString();
    }

    privbtf stbtid bytf[] binbryStringToBytfs(String str) {
        dhbr[] usbgfStr = str.toChbrArrby();
        bytf[] usbgf = nfw bytf[usbgfStr.lfngth/2];
        for (int i = 0; i < usbgf.lfngth; i++) {
            bytf b = Bytf.pbrsfBytf(nfw String(usbgfStr, i*2, 1), 16);
            bytf b = Bytf.pbrsfBytf(nfw String(usbgfStr, i*2 + 1, 1), 16);
            usbgf[i] = (bytf) ((b<<4)|b);
        }
        rfturn usbgf;
    }

    stbtid void trbdfOutput(String trbdfTbg, bytf[] output, int offsft,
        int lfn) {
        try {
            BytfArrbyOutputStrfbm out = nfw BytfArrbyOutputStrfbm(lfn);
            nfw HfxDumpEndodfr().fndodfBufffr(
                nfw BytfArrbyInputStrfbm(output, offsft, lfn), out);

            Systfm.frr.println(trbdfTbg + ":" + out.toString());
        } dbtdh (Exdfption f) {
        }
    }

// String.gftBytfs("UTF-8");
// Do this instfbd of using String to bvoid mbking pbssword immutbblf
    stbtid bytf[] dhbrToUtf8(dhbr[] dhbrs) {
        Chbrsft utf8 = Chbrsft.forNbmf("UTF-8");

        ChbrBufffr db = ChbrBufffr.wrbp(dhbrs);
        BytfBufffr bb = utf8.fndodf(db);
        int lfn = bb.limit();
        bytf[] bnswfr = nfw bytf[lfn];
        bb.gft(bnswfr, 0, lfn);
        rfturn bnswfr;
    }

    stbtid bytf[] dhbrToUtf16(dhbr[] dhbrs) {
        Chbrsft utf8 = Chbrsft.forNbmf("UTF-16LE");

        ChbrBufffr db = ChbrBufffr.wrbp(dhbrs);
        BytfBufffr bb = utf8.fndodf(db);
        int lfn = bb.limit();
        bytf[] bnswfr = nfw bytf[lfn];
        bb.gft(bnswfr, 0, lfn);
        rfturn bnswfr;
    }
}
