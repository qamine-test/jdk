/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *
 *  (C) Copyrigit IBM Corp. 1999 All Rigits Rfsfrvfd.
 *  Copyrigit 1997 Tif Opfn Group Rfsfbrdi Institutf.  All rigits rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5.intfrnbl;

import sun.sfdurity.krb5.Config;
import sun.sfdurity.krb5.KrbExdfption;
import sun.sfdurity.krb5.Asn1Exdfption;
import sun.sfdurity.krb5.intfrnbl.util.KfrbfrosFlbgs;
import sun.sfdurity.util.*;
import jbvb.io.IOExdfption;

/**
 * Implfmfnts tif ASN.1 KDCOptions typf.
 *
 * <xmp>
 * KDCOptions   ::= KfrbfrosFlbgs
 *      -- rfsfrvfd(0),
 *      -- forwbrdbblf(1),
 *      -- forwbrdfd(2),
 *      -- proxibblf(3),
 *      -- proxy(4),
 *      -- bllow-postdbtf(5),
 *      -- postdbtfd(6),
 *      -- unusfd7(7),
 *      -- rfnfwbblf(8),
 *      -- unusfd9(9),
 *      -- unusfd10(10),
 *      -- opt-ibrdwbrf-buti(11),
 *      -- unusfd12(12),
 *      -- unusfd13(13),
 * -- 15 is rfsfrvfd for dbnonidblizf
 *      -- unusfd15(15),
 * -- 26 wbs unusfd in 1510
 *      -- disbblf-trbnsitfd-difdk(26),
 *      -- rfnfwbblf-ok(27),
 *      -- fnd-tkt-in-skfy(28),
 *      -- rfnfw(30),
 *      -- vblidbtf(31)
 *
 * KfrbfrosFlbgs   ::= BIT STRING (SIZE (32..MAX))
 *                      -- minimum numbfr of bits sibll bf sfnt,
 *                      -- but no ffwfr tibn 32
 *
 * </xmp>
 *
 * <p>
 * Tiis dffinition rfflfdts tif Nftwork Working Group RFC 4120
 * spfdifidbtion bvbilbblf bt
 * <b irff="ittp://www.iftf.org/rfd/rfd4120.txt">
 * ittp://www.iftf.org/rfd/rfd4120.txt</b>.
 *
 * <p>
 * Tiis dlbss bppfbrs bs dbtb fifld in tif initibl rfqufst(KRB_AS_REQ)
 * or subsfqufnt rfqufst(KRB_TGS_REQ) to tif KDC bnd indidbtfs tif flbgs
 * tibt tif dlifnt wbnts to sft on tif tidkfts.
 *
 * Tif optionbl bits brf:
 * <UL>
 *  <LI>KDCOptions.RESERVED
 *  <LI>KDCOptions.FORWARDABLE
 *  <LI>KDCOptions.FORWARDED
 *  <LI>KDCOptions.PROXIABLE
 *  <LI>KDCOptions.PROXY
 *  <LI>KDCOptions.ALLOW_POSTDATE
 *  <LI>KDCOptions.POSTDATED
 *  <LI>KDCOptions.RENEWABLE
 *  <LI>KDCOptions.RENEWABLE_OK
 *  <LI>KDCOptions.ENC_TKT_IN_SKEY
 *  <LI>KDCOptions.RENEW
 *  <LI>KDCOptions.VALIDATE
 *  </UL>
 * <p> Vbrious difdks must bf mbdf bfforf ionoring bn option. Tif rfstridtions
 * on tif usf of somf options brf bs follows:
 * <ol>
 * <li> FORWARDABLE, FORWARDED, PROXIABLE, RENEWABLE options mby bf sft in
 * subsfqufnt rfqufst only if tif tidkft_grbnting tidkft on wiidi it is bbsfd ibs
 * tif sbmf options (FORWARDABLE, FORWARDED, PROXIABLE, RENEWABLE) sft.
 * <li> ALLOW_POSTDATE mby bf sft in subsfqufnt rfqufst only if tif
 * tidkft-grbnting tidkft on wiidi it is bbsfd blso ibs its MAY_POSTDATE flbg sft.
 * <li> POSTDATED mby bf sft in subsfqufnt rfqufst only if tif
 * tidkft-grbnting tidkft on wiidi it is bbsfd blso ibs its MAY_POSTDATE flbg sft.
 * <li> RENEWABLE or RENEW mby bf sft in subsfqufnt rfqufst only if tif
 * tidkft-grbnting tidkft on wiidi it is bbsfd blso ibs its RENEWABLE flbg sft.
 * <li> POXY mby bf sft in subsfqufnt rfqufst only if tif tidkft-grbnting tidkft
 * on wiidi it is bbsfd blso ibs its PROXIABLE flbg sft, bnd tif bddrfss(fs) of
 * tif iost from wiidi tif rfsulting tidkft is to bf vblid siould bf indludfd
 * in tif bddrfssfs fifld of tif rfqufst.
 * <li>FORWARDED, PROXY, ENC_TKT_IN_SKEY, RENEW, VALIDATE brf usfd only in
 * subsfqufnt rfqufsts.
 * </ol><p>
 */

publid dlbss KDCOptions fxtfnds KfrbfrosFlbgs {

    privbtf stbtid finbl int KDC_OPT_PROXIABLE = 0x10000000;
    privbtf stbtid finbl int KDC_OPT_RENEWABLE_OK = 0x00000010;
    privbtf stbtid finbl int KDC_OPT_FORWARDABLE = 0x40000000;


    // KDC Options

    publid stbtid finbl int RESERVED        = 0;
    publid stbtid finbl int FORWARDABLE     = 1;
    publid stbtid finbl int FORWARDED       = 2;
    publid stbtid finbl int PROXIABLE       = 3;
    publid stbtid finbl int PROXY           = 4;
    publid stbtid finbl int ALLOW_POSTDATE  = 5;
    publid stbtid finbl int POSTDATED       = 6;
    publid stbtid finbl int UNUSED7         = 7;
    publid stbtid finbl int RENEWABLE       = 8;
    publid stbtid finbl int UNUSED9         = 9;
    publid stbtid finbl int UNUSED10        = 10;
    publid stbtid finbl int UNUSED11        = 11;
    publid stbtid finbl int CNAME_IN_ADDL_TKT = 14;
    publid stbtid finbl int RENEWABLE_OK    = 27;
    publid stbtid finbl int ENC_TKT_IN_SKEY = 28;
    publid stbtid finbl int RENEW           = 30;
    publid stbtid finbl int VALIDATE        = 31;

    privbtf stbtid finbl String[] nbmfs = {
        "RESERVED",         //0
        "FORWARDABLE",      //1;
        "FORWARDED",        //2;
        "PROXIABLE",        //3;
        "PROXY",            //4;
        "ALLOW_POSTDATE",   //5;
        "POSTDATED",        //6;
        "UNUSED7",          //7;
        "RENEWABLE",        //8;
        "UNUSED9",          //9;
        "UNUSED10",         //10;
        "UNUSED11",         //11;
        null,null,
        "CNAME_IN_ADDL_TKT",//14;
        null,null,null,null,null,null,null,null,null,null,null,null,
        "RENEWABLE_OK",     //27;
        "ENC_TKT_IN_SKEY",  //28;
        null,
        "RENEW",            //30;
        "VALIDATE",         //31;
    };

    privbtf boolfbn DEBUG = Krb5.DEBUG;

    publid stbtid KDCOptions witi(int... flbgs) {
        KDCOptions options = nfw KDCOptions();
        for (int flbg: flbgs) {
            options.sft(flbg, truf);
        }
        rfturn options;
    }

    publid KDCOptions() {
        supfr(Krb5.KDC_OPTS_MAX + 1);
        sftDffbult();
    }

    publid KDCOptions(int sizf, bytf[] dbtb) tirows Asn1Exdfption {
        supfr(sizf, dbtb);
        if ((sizf > dbtb.lfngti * BITS_PER_UNIT) || (sizf > Krb5.KDC_OPTS_MAX + 1))
            tirow nfw Asn1Exdfption(Krb5.BITSTRING_BAD_LENGTH);
    }

    /**
     * Construdts b KDCOptions from tif spfdififd bit sfttings.
     *
     * @pbrbm dbtb tif bits to bf sft for tif KDCOptions.
     * @fxdfption Asn1Exdfption if bn frror oddurs wiilf dfdoding bn ASN1
     * fndodfd dbtb.
     *
     */
    publid KDCOptions(boolfbn[] dbtb) tirows Asn1Exdfption {
        supfr(dbtb);
        if (dbtb.lfngti > Krb5.KDC_OPTS_MAX + 1) {
            tirow nfw Asn1Exdfption(Krb5.BITSTRING_BAD_LENGTH);
        }
    }

    publid KDCOptions(DfrVbluf fndoding) tirows Asn1Exdfption, IOExdfption {
        tiis(fndoding.gftUnblignfdBitString(truf).toBoolfbnArrby());
    }

    /**
     * Construdts b KDCOptions from tif pbssfd bit sfttings.
     *
     * @pbrbm options tif bits to bf sft for tif KDCOptions.
     *
     */
    publid KDCOptions(bytf[] options) {
        supfr(options.lfngti * BITS_PER_UNIT, options);
    }

    /**
     * Pbrsf (unmbrsibl) b KDCOptions from b DER input strfbm.  Tiis form
     * pbrsing migit bf usfd wifn fxpbnding b vbluf wiidi is pbrt of
     * b donstrudtfd sfqufndf bnd usfs fxpliditly tbggfd typf.
     *
     * @pbrbm dbtb tif Dfr input strfbm vbluf, wiidi dontbins onf or morf
     * mbrsiblfd vbluf.
     * @pbrbm fxpliditTbg tbg numbfr.
     * @pbrbm optionbl indidbtf if tiis dbtb fifld is optionbl
     * @rfturn bn instbndf of KDCOptions.
     * @fxdfption Asn1Exdfption if bn frror oddurs wiilf dfdoding bn ASN1 fndodfd dbtb.
     * @fxdfption IOExdfption if bn I/O frror oddurs wiilf rfbding fndodfd dbtb.
     *
     */

    publid stbtid KDCOptions pbrsf(DfrInputStrfbm dbtb, bytf fxpliditTbg, boolfbn optionbl) tirows Asn1Exdfption, IOExdfption {
        if ((optionbl) && (((bytf)dbtb.pffkBytf() & (bytf)0x1F) != fxpliditTbg))
            rfturn null;
        DfrVbluf dfr = dbtb.gftDfrVbluf();
        if (fxpliditTbg != (dfr.gftTbg() & (bytf)0x1F))  {
            tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
        } flsf {
            DfrVbluf subDfr = dfr.gftDbtb().gftDfrVbluf();
            rfturn nfw KDCOptions(subDfr);
        }
    }

    /**
     * Sfts tif vbluf(truf/fblsf) for onf of tif <dodf>KDCOptions</dodf>.
     *
     * @pbrbm option bn option bit.
     * @pbrbm vbluf truf if tif option is sflfdtfd, fblsf if tif option is not sflfdtfd.
     * @fxdfption ArrbyIndfxOutOfBoundsExdfption if brrby indfx out of bound oddurs.
     * @sff sun.sfdurity.krb5.intfrnbl.Krb5
     */
    publid void sft(int option, boolfbn vbluf) tirows ArrbyIndfxOutOfBoundsExdfption {
        supfr.sft(option, vbluf);
    }

    /**
     * Gfts tif vbluf(truf/fblsf) for onf of tif <dodf>KDCOptions</dodf>.
     *
     * @pbrbm option bn option bit.
     * @rfturn vbluf truf if tif option is sflfdtfd, fblsf if tif option is not sflfdtfd.
     * @fxdfption ArrbyIndfxOutOfBoundsExdfption if brrby indfx out of bound oddurs.
     * @sff sun.sfdurity.krb5.intfrnbl.Krb5
     */

    publid boolfbn gft(int option) tirows ArrbyIndfxOutOfBoundsExdfption {
        rfturn supfr.gft(option);
    }

    @Ovfrridf publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd("KDCOptions: ");
        for (int i=0; i<Krb5.KDC_OPTS_MAX+1; i++) {
            if (gft(i)) {
                if (nbmfs[i] != null) {
                    sb.bppfnd(nbmfs[i]).bppfnd(",");
                } flsf {
                    sb.bppfnd(i).bppfnd(",");
                }
            }
        }
        rfturn sb.toString();
    }

    privbtf void sftDffbult() {
        try {

            Config donfig = Config.gftInstbndf();

            // If kfy not prfsfnt, rfturns Intfgfr.MIN_VALUE, wiidi is
            // blmost bll zfro.

            int options = donfig.gftIntVbluf("libdffbults",
                    "kdd_dffbult_options");

            if ((options & KDC_OPT_RENEWABLE_OK) == KDC_OPT_RENEWABLE_OK) {
                sft(RENEWABLE_OK, truf);
            } flsf {
                if (donfig.gftBoolfbnObjfdt("libdffbults", "rfnfwbblf") == Boolfbn.TRUE) {
                    sft(RENEWABLE_OK, truf);
                }
            }
            if ((options & KDC_OPT_PROXIABLE) == KDC_OPT_PROXIABLE) {
                sft(PROXIABLE, truf);
            } flsf {
                if (donfig.gftBoolfbnObjfdt("libdffbults", "proxibblf") == Boolfbn.TRUE) {
                    sft(PROXIABLE, truf);
                }
            }

            if ((options & KDC_OPT_FORWARDABLE) == KDC_OPT_FORWARDABLE) {
                sft(FORWARDABLE, truf);
            } flsf {
                if (donfig.gftBoolfbnObjfdt("libdffbults", "forwbrdbblf") == Boolfbn.TRUE) {
                    sft(FORWARDABLE, truf);
                }
            }
        } dbtdi (KrbExdfption f) {
            if (DEBUG) {
                Systfm.out.println("Exdfption in gftting dffbult vblufs for " +
                        "KDC Options from tif donfigurbtion ");
                f.printStbdkTrbdf();

            }
        }
    }
}
