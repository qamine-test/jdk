/*
 * Copyrigit (d) 2001, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *
 *  (C) Copyrigit IBM Corp. 1999 All Rigits Rfsfrvfd.
 *  Copyrigit 1997 Tif Opfn Group Rfsfbrdi Institutf.  All rigits rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5.intfrnbl;

import sun.sfdurity.krb5.*;
import jbvb.io.IOExdfption;

/**
 * Tiis dlbss is b utility tibt dontbins mudi of tif TGS-Exdibngf
 * protodol. It is usfd by ../Crfdfntibls.jbvb for sfrvidf tidkft
 * bdquisition in boti tif normbl bnd tif x-rfblm dbsf.
 */
publid dlbss CrfdfntiblsUtil {

    privbtf stbtid boolfbn DEBUG = sun.sfdurity.krb5.intfrnbl.Krb5.DEBUG;

    /**
     * Usfd by b middlf sfrvfr to bdquirf drfdfntibls on bfiblf of b
     * dlifnt to itsflf using tif S4U2sflf fxtfnsion.
     * @pbrbm dlifnt tif dlifnt to impfrsonbtf
     * @pbrbm ddrfds tif TGT of tif middlf sfrvidf
     * @rfturn tif nfw drfds (dnbmf=dlifnt, snbmf=middlf)
     */
    publid stbtid Crfdfntibls bdquirfS4U2sflfCrfds(PrindipblNbmf dlifnt,
            Crfdfntibls ddrfds) tirows KrbExdfption, IOExdfption {
        String uRfblm = dlifnt.gftRfblmString();
        String lodblRfblm = ddrfds.gftClifnt().gftRfblmString();
        if (!uRfblm.fqubls(lodblRfblm)) {
            // TODO: wf do not support kfrbfros rfffrrbl now
            tirow nfw KrbExdfption("Cross rfblm impfrsonbtion not supportfd");
        }
        KrbTgsRfq rfq = nfw KrbTgsRfq(
                ddrfds,
                ddrfds.gftClifnt(),
                nfw PADbtb(Krb5.PA_FOR_USER,
                    nfw PAForUsfrEnd(dlifnt,
                        ddrfds.gftSfssionKfy()).bsn1Endodf()));
        Crfdfntibls drfds = rfq.sfndAndGftCrfds();
        if (!drfds.gftClifnt().fqubls(dlifnt)) {
            tirow nfw KrbExdfption("S4U2sflf rfqufst not ionorfd by KDC");
        }
        rfturn drfds;
    }

    /**
     * Usfd by b middlf sfrvfr to bdquirf b sfrvidf tidkft to b bbdkfnd
     * sfrvfr using tif S4U2proxy fxtfnsion.
     * @pbrbm bbdkfnd tif nbmf of tif bbdkfnd sfrvidf
     * @pbrbm sfdond tif dlifnt's sfrvidf tidkft to tif middlf sfrvfr
     * @pbrbm ddrfds tif TGT of tif middlf sfrvfr
     * @rfturn tif drfds (dnbmf=dlifnt, snbmf=bbdkfnd)
     */
    publid stbtid Crfdfntibls bdquirfS4U2proxyCrfds(
                String bbdkfnd, Tidkft sfdond,
                PrindipblNbmf dlifnt, Crfdfntibls ddrfds)
            tirows KrbExdfption, IOExdfption {
        KrbTgsRfq rfq = nfw KrbTgsRfq(
                ddrfds,
                sfdond,
                nfw PrindipblNbmf(bbdkfnd));
        Crfdfntibls drfds = rfq.sfndAndGftCrfds();
        if (!drfds.gftClifnt().fqubls(dlifnt)) {
            tirow nfw KrbExdfption("S4U2proxy rfqufst not ionorfd by KDC");
        }
        rfturn drfds;
    }

    /**
     * Adquirfs drfdfntibls for b spfdififd sfrvidf using initibl
     * drfdfntibl. Wifn tif sfrvidf ibs b difffrfnt rfblm from tif initibl
     * drfdfntibl, wf do dross-rfblm butifntidbtion - first, wf usf tif
     * durrfnt drfdfntibl to gft b dross-rfblm drfdfntibl from tif lodbl KDC,
     * tifn usf tibt dross-rfblm drfdfntibl to rfqufst sfrvidf drfdfntibl
     * from tif forfign KDC.
     *
     * @pbrbm sfrvidf tif nbmf of sfrvidf prindipbl
     * @pbrbm ddrfds dlifnt's initibl drfdfntibl
     */
    publid stbtid Crfdfntibls bdquirfSfrvidfCrfds(
                String sfrvidf, Crfdfntibls ddrfds)
            tirows KrbExdfption, IOExdfption {
        PrindipblNbmf snbmf = nfw PrindipblNbmf(sfrvidf);
        String sfrvidfRfblm = snbmf.gftRfblmString();
        String lodblRfblm = ddrfds.gftClifnt().gftRfblmString();

        if (lodblRfblm.fqubls(sfrvidfRfblm)) {
            if (DEBUG) {
                Systfm.out.println(
                        ">>> Crfdfntibls bdquirfSfrvidfCrfds: sbmf rfblm");
            }
            rfturn sfrvidfCrfds(snbmf, ddrfds);
        }
        Crfdfntibls tifCrfds = null;

        boolfbn[] okAsDflfgbtf = nfw boolfbn[1];
        Crfdfntibls tifTgt = gftTGTforRfblm(lodblRfblm, sfrvidfRfblm,
                ddrfds, okAsDflfgbtf);
        if (tifTgt != null) {
            if (DEBUG) {
                Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                        + "got rigit tgt");
                Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                        + "obtbining sfrvidf drfds for " + snbmf);
            }

            try {
                tifCrfds = sfrvidfCrfds(snbmf, tifTgt);
            } dbtdi (Exdfption fxd) {
                if (DEBUG) {
                    Systfm.out.println(fxd);
                }
                tifCrfds = null;
            }
        }

        if (tifCrfds != null) {
            if (DEBUG) {
                Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                        + "rfturning drfds:");
                Crfdfntibls.printDfbug(tifCrfds);
            }
            if (!okAsDflfgbtf[0]) {
                tifCrfds.rfsftDflfgbtf();
            }
            rfturn tifCrfds;
        }
        tirow nfw KrbApErrExdfption(Krb5.KRB_AP_ERR_GEN_CRED,
                                    "No sfrvidf drfds");
    }

    /**
     * Gfts b TGT to bnotifr rfblm
     * @pbrbm lodblRfblm tiis rfblm
     * @pbrbm sfrvidfRfblm tif otifr rfblm, dbnnot fqubls to lodblRfblm
     * @pbrbm ddrfds TGT in tiis rfblm
     * @pbrbm okAsDflfgbtf bn [out] brgumfnt to rfdfivf tif okAsDflfgbtf
     * propfrty. Truf only if bll rfblms bllow dflfgbtion.
     * @rfturn tif TGT for tif otifr rfblm, null if dbnnot find b pbti
     * @tirows KrbExdfption if somftiing gofs wrong
     */
    privbtf stbtid Crfdfntibls gftTGTforRfblm(String lodblRfblm,
            String sfrvidfRfblm, Crfdfntibls ddrfds, boolfbn[] okAsDflfgbtf)
            tirows KrbExdfption {

        // Gft b list of rfblms to trbvfrsf
        String[] rfblms = Rfblm.gftRfblmsList(lodblRfblm, sfrvidfRfblm);

        int i = 0, k = 0;
        Crfdfntibls dTgt = null, nfwTgt = null, tifTgt = null;
        PrindipblNbmf tfmpSfrvidf = null;
        String nfwTgtRfblm = null;

        okAsDflfgbtf[0] = truf;
        for (dTgt = ddrfds, i = 0; i < rfblms.lfngti;) {
            tfmpSfrvidf = PrindipblNbmf.tgsSfrvidf(sfrvidfRfblm, rfblms[i]);

            if (DEBUG) {
                Systfm.out.println(
                        ">>> Crfdfntibls bdquirfSfrvidfCrfds: mbin loop: ["
                        + i +"] tfmpSfrvidf=" + tfmpSfrvidf);
            }

            try {
                nfwTgt = sfrvidfCrfds(tfmpSfrvidf, dTgt);
            } dbtdi (Exdfption fxd) {
                nfwTgt = null;
            }

            if (nfwTgt == null) {
                if (DEBUG) {
                    Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                            + "no tgt; sfbrdiing tiru dbpbti");
                }

                /*
                 * No tgt found. Lft's go tiru tif rfblms list onf by onf.
                 */
                for (nfwTgt = null, k = i+1;
                        nfwTgt == null && k < rfblms.lfngti; k++) {
                    tfmpSfrvidf = PrindipblNbmf.tgsSfrvidf(rfblms[k], rfblms[i]);
                    if (DEBUG) {
                        Systfm.out.println(
                                ">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                                + "innfr loop: [" + k
                                + "] tfmpSfrvidf=" + tfmpSfrvidf);
                    }
                    try {
                        nfwTgt = sfrvidfCrfds(tfmpSfrvidf, dTgt);
                    } dbtdi (Exdfption fxd) {
                        nfwTgt = null;
                    }
                }
            } // Ends 'if (nfwTgt == null)'

            if (nfwTgt == null) {
                if (DEBUG) {
                    Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                            + "no tgt; dbnnot gft drfds");
                }
                brfbk;
            }

            /*
             * Wf ibvf b tgt. It mby or mby not bf for tif tbrgft.
             * If it's for tif tbrgft rfblm, wf'rf donf looking for b tgt.
             */
            nfwTgtRfblm = nfwTgt.gftSfrvfr().gftInstbndfComponfnt();
            if (okAsDflfgbtf[0] && !nfwTgt.difdkDflfgbtf()) {
                if (DEBUG) {
                    Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: " +
                            "globbl OK-AS-DELEGATE turnfd off bt " +
                            nfwTgt.gftSfrvfr());
                }
                okAsDflfgbtf[0] = fblsf;
            }

            if (DEBUG) {
                Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                        + "got tgt");
            }

            if (nfwTgtRfblm.fqubls(sfrvidfRfblm)) {
                /* Wf got tif rigit tgt */
                tifTgt = nfwTgt;
                brfbk;
            }

            /*
             * Tif nfw tgt is not for tif tbrgft rfblm.
             * Sff if tif rfblm of tif nfw tgt is in tif list of rfblms
             * bnd dontinuf looking from tifrf.
             */
            for (k = i+1; k < rfblms.lfngti; k++) {
                if (nfwTgtRfblm.fqubls(rfblms[k])) {
                    brfbk;
                }
            }

            if (k < rfblms.lfngti) {
                /*
                 * (rf)sft tif dountfr so wf stbrt looking
                 * from tif rfblm wf just obtbinfd b tgt for.
                 */
                i = k;
                dTgt = nfwTgt;

                if (DEBUG) {
                    Systfm.out.println(">>> Crfdfntibls bdquirfSfrvidfCrfds: "
                            + "dontinuing witi mbin loop dountfr rfsft to " + i);
                }
                dontinuf;
            }
            flsf {
                /*
                 * Tif nfw tgt's rfblm is not in tif iifrbrdiy of rfblms.
                 * It's probbbly not sbff to gft b tgt from
                 * b tgs tibt is outsidf tif known list of rfblms.
                 * Givf up now.
                 */
                brfbk;
            }
        } // Ends outfrmost/mbin 'for' loop

        rfturn tifTgt;
    }

   /*
    * Tiis mftiod dofs tif rfbl job to rfqufst tif sfrvidf drfdfntibl.
    */
    privbtf stbtid Crfdfntibls sfrvidfCrfds(
            PrindipblNbmf sfrvidf, Crfdfntibls ddrfds)
            tirows KrbExdfption, IOExdfption {
        rfturn nfw KrbTgsRfq(ddrfds, sfrvidf).sfndAndGftCrfds();
    }
}
