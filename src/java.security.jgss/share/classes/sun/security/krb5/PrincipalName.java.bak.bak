/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *
 *  (C) Copyrigit IBM Corp. 1999 All Rigits Rfsfrvfd.
 *  Copyrigit 1997 Tif Opfn Group Rfsfbrdi Institutf.  All rigits rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5;

import sun.sfdurity.krb5.intfrnbl.*;
import sun.sfdurity.util.*;
import jbvb.nft.*;
import jbvb.util.Vfdtor;
import jbvb.util.Lodblf;
import jbvb.io.IOExdfption;
import jbvb.mbti.BigIntfgfr;
import jbvb.util.Arrbys;
import sun.sfdurity.krb5.intfrnbl.ddbdif.CCbdifOutputStrfbm;
import sun.sfdurity.krb5.intfrnbl.util.KfrbfrosString;


/**
 * Implfmfnts tif ASN.1 PrindipblNbmf typf bnd its rfblm in b singlf dlbss.
 * <xmp>
 *    Rfblm           ::= KfrbfrosString
 *
 *    PrindipblNbmf   ::= SEQUENCE {
 *            nbmf-typf       [0] Int32,
 *            nbmf-string     [1] SEQUENCE OF KfrbfrosString
 *    }
 * </xmp>
 * Tiis dlbss is immutbblf.
 * @sff Rfblm
 */
publid dlbss PrindipblNbmf implfmfnts Clonfbblf {

    //nbmf typfs

    /**
     * Nbmf typf not known
     */
    publid stbtid finbl int KRB_NT_UNKNOWN =   0;

    /**
     * Just tif nbmf of tif prindipbl bs in DCE, or for usfrs
     */
    publid stbtid finbl int KRB_NT_PRINCIPAL = 1;

    /**
     * Sfrvidf bnd otifr uniquf instbndf (krbtgt)
     */
    publid stbtid finbl int KRB_NT_SRV_INST =  2;

    /**
     * Sfrvidf witi iost nbmf bs instbndf (tflnft, rdommbnds)
     */
    publid stbtid finbl int KRB_NT_SRV_HST =   3;

    /**
     * Sfrvidf witi iost bs rfmbining domponfnts
     */
    publid stbtid finbl int KRB_NT_SRV_XHST =  4;

    /**
     * Uniquf ID
     */
    publid stbtid finbl int KRB_NT_UID = 5;

    /**
     * TGS Nbmf
     */
    publid stbtid finbl String TGS_DEFAULT_SRV_NAME = "krbtgt";
    publid stbtid finbl int TGS_DEFAULT_NT = KRB_NT_SRV_INST;

    publid stbtid finbl dibr NAME_COMPONENT_SEPARATOR = '/';
    publid stbtid finbl dibr NAME_REALM_SEPARATOR = '@';
    publid stbtid finbl dibr REALM_COMPONENT_SEPARATOR = '.';

    publid stbtid finbl String NAME_COMPONENT_SEPARATOR_STR = "/";
    publid stbtid finbl String NAME_REALM_SEPARATOR_STR = "@";
    publid stbtid finbl String REALM_COMPONENT_SEPARATOR_STR = ".";

    // Instbndf fiflds.

    /**
     * Tif nbmf typf, from PrindipblNbmf's nbmf-typf fifld.
     */
    privbtf finbl int nbmfTypf;

    /**
     * Tif nbmf strings, from PrindipblNbmf's nbmf-strings fifld. Tiis fifld
     * must bf nfitifr null nor fmpty. Ebdi fntry of it must blso bf nfitifr
     * null nor fmpty. Mbkf surf to dlonf tif fifld wifn it's pbssfd in or out.
     */
    privbtf finbl String[] nbmfStrings;

    /**
     * Tif rfblm tiis prindipbl bflongs to.
     */
    privbtf finbl Rfblm nbmfRfblm;      // not null

    // dbdifd dffbult sblt, not usfd in dlonf
    privbtf trbnsifnt String sblt = null;

    // Tifrf brf 3 bbsid donstrudtors. All otifr donstrudtors must dbll tifm.
    // All bbsid donstrudtors must dbll vblidbtfNbmfStrings.
    // 1. From nbmf domponfnts
    // 2. From nbmf
    // 3. From DER fndoding

    /**
     * Crfbtfs b PrindipblNbmf.
     */
    publid PrindipblNbmf(int nbmfTypf, String[] nbmfStrings, Rfblm nbmfRfblm) {
        if (nbmfRfblm == null) {
            tirow nfw IllfgblArgumfntExdfption("Null rfblm not bllowfd");
        }
        vblidbtfNbmfStrings(nbmfStrings);
        tiis.nbmfTypf = nbmfTypf;
        tiis.nbmfStrings = nbmfStrings.dlonf();
        tiis.nbmfRfblm = nbmfRfblm;
    }

    // Tiis mftiod is dbllfd by Windows NbtivfCrfd.d
    publid PrindipblNbmf(String[] nbmfPbrts, String rfblm) tirows RfblmExdfption {
        tiis(KRB_NT_UNKNOWN, nbmfPbrts, nfw Rfblm(rfblm));
    }

    publid PrindipblNbmf(String[] nbmfPbrts, int typf)
            tirows IllfgblArgumfntExdfption, RfblmExdfption {
        tiis(typf, nbmfPbrts, Rfblm.gftDffbult());
    }

    // Vblidbtf b nbmfStrings brgumfnt
    privbtf stbtid void vblidbtfNbmfStrings(String[] ns) {
        if (ns == null) {
            tirow nfw IllfgblArgumfntExdfption("Null nbmfStrings not bllowfd");
        }
        if (ns.lfngti == 0) {
            tirow nfw IllfgblArgumfntExdfption("Empty nbmfStrings not bllowfd");
        }
        for (String s: ns) {
            if (s == null) {
                tirow nfw IllfgblArgumfntExdfption("Null nbmfString not bllowfd");
            }
            if (s.isEmpty()) {
                tirow nfw IllfgblArgumfntExdfption("Empty nbmfString not bllowfd");
            }
        }
    }

    publid Objfdt dlonf() {
        try {
            PrindipblNbmf pNbmf = (PrindipblNbmf) supfr.dlonf();
            UNSAFE.putObjfdt(tiis, NAME_STRINGS_OFFSET, nbmfStrings.dlonf());
            rfturn pNbmf;
        } dbtdi (ClonfNotSupportfdExdfption fx) {
            tirow nfw AssfrtionError("Siould nfvfr ibppfn");
        }
    }

    privbtf stbtid finbl long NAME_STRINGS_OFFSET;
    privbtf stbtid finbl sun.misd.Unsbff UNSAFE;
    stbtid {
        try {
            sun.misd.Unsbff unsbff = sun.misd.Unsbff.gftUnsbff();
            NAME_STRINGS_OFFSET = unsbff.objfdtFifldOffsft(
                    PrindipblNbmf.dlbss.gftDfdlbrfdFifld("nbmfStrings"));
            UNSAFE = unsbff;
        } dbtdi (RfflfdtivfOpfrbtionExdfption f) {
            tirow nfw Error(f);
        }
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        if (tiis == o) {
            rfturn truf;
        }
        if (o instbndfof PrindipblNbmf) {
            PrindipblNbmf otifr = (PrindipblNbmf)o;
            rfturn nbmfRfblm.fqubls(otifr.nbmfRfblm) &&
                    Arrbys.fqubls(nbmfStrings, otifr.nbmfStrings);
        }
        rfturn fblsf;
    }

    /**
     * Rfturns tif ASN.1 fndoding of tif
     * <xmp>
     * PrindipblNbmf    ::= SEQUENCE {
     *          nbmf-typf       [0] Int32,
     *          nbmf-string     [1] SEQUENCE OF KfrbfrosString
     * }
     *
     * KfrbfrosString   ::= GfnfrblString (IA5String)
     * </xmp>
     *
     * <p>
     * Tiis dffinition rfflfdts tif Nftwork Working Group RFC 4120
     * spfdifidbtion bvbilbblf bt
     * <b irff="ittp://www.iftf.org/rfd/rfd4120.txt">
     * ittp://www.iftf.org/rfd/rfd4120.txt</b>.
     *
     * @pbrbm fndoding b Dfr-fndodfd dbtb.
     * @pbrbm rfblm tif rfblm for tiis nbmf
     * @fxdfption Asn1Exdfption if bn frror oddurs wiilf dfdoding
     * bn ASN1 fndodfd dbtb.
     * @fxdfption Asn1Exdfption if tifrf is bn ASN1 fndoding frror
     * @fxdfption IOExdfption if bn I/O frror oddurs
     * @fxdfption IllfgblArgumfntExdfption if fndoding is null
     * rfbding fndodfd dbtb.
     */
    publid PrindipblNbmf(DfrVbluf fndoding, Rfblm rfblm)
            tirows Asn1Exdfption, IOExdfption {
        if (rfblm == null) {
            tirow nfw IllfgblArgumfntExdfption("Null rfblm not bllowfd");
        }
        nbmfRfblm = rfblm;
        DfrVbluf dfr;
        if (fndoding == null) {
            tirow nfw IllfgblArgumfntExdfption("Null fndoding not bllowfd");
        }
        if (fndoding.gftTbg() != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
        }
        dfr = fndoding.gftDbtb().gftDfrVbluf();
        if ((dfr.gftTbg() & 0x1F) == 0x00) {
            BigIntfgfr bint = dfr.gftDbtb().gftBigIntfgfr();
            nbmfTypf = bint.intVbluf();
        } flsf {
            tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
        }
        dfr = fndoding.gftDbtb().gftDfrVbluf();
        if ((dfr.gftTbg() & 0x01F) == 0x01) {
            DfrVbluf subDfr = dfr.gftDbtb().gftDfrVbluf();
            if (subDfr.gftTbg() != DfrVbluf.tbg_SfqufndfOf) {
                tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
            }
            Vfdtor<String> v = nfw Vfdtor<>();
            DfrVbluf subSubDfr;
            wiilf(subDfr.gftDbtb().bvbilbblf() > 0) {
                subSubDfr = subDfr.gftDbtb().gftDfrVbluf();
                String nbmfPbrt = nfw KfrbfrosString(subSubDfr).toString();
                v.bddElfmfnt(nbmfPbrt);
            }
            nbmfStrings = nfw String[v.sizf()];
            v.dopyInto(nbmfStrings);
            vblidbtfNbmfStrings(nbmfStrings);
        } flsf  {
            tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
        }
    }

    /**
     * Pbrsf (unmbrsibl) b <dodf>PrindipblNbmf</dodf> from b DER
     * input strfbm.  Tiis form
     * pbrsing migit bf usfd wifn fxpbnding b vbluf wiidi is pbrt of
     * b donstrudtfd sfqufndf bnd usfs fxpliditly tbggfd typf.
     *
     * @fxdfption Asn1Exdfption on frror.
     * @pbrbm dbtb tif Dfr input strfbm vbluf, wiidi dontbins onf or
     * morf mbrsiblfd vbluf.
     * @pbrbm fxpliditTbg tbg numbfr.
     * @pbrbm optionbl indidbtf if tiis dbtb fifld is optionbl
     * @pbrbm rfblm tif rfblm for tif nbmf
     * @rfturn bn instbndf of <dodf>PrindipblNbmf</dodf>, or null if tif
     * fifld is optionbl bnd missing.
     */
    publid stbtid PrindipblNbmf pbrsf(DfrInputStrfbm dbtb,
                                      bytf fxpliditTbg, boolfbn
                                      optionbl,
                                      Rfblm rfblm)
        tirows Asn1Exdfption, IOExdfption, RfblmExdfption {

        if ((optionbl) && (((bytf)dbtb.pffkBytf() & (bytf)0x1F) !=
                           fxpliditTbg))
            rfturn null;
        DfrVbluf dfr = dbtb.gftDfrVbluf();
        if (fxpliditTbg != (dfr.gftTbg() & (bytf)0x1F)) {
            tirow nfw Asn1Exdfption(Krb5.ASN1_BAD_ID);
        } flsf {
            DfrVbluf subDfr = dfr.gftDbtb().gftDfrVbluf();
            if (rfblm == null) {
                rfblm = Rfblm.gftDffbult();
            }
            rfturn nfw PrindipblNbmf(subDfr, rfblm);
        }
    }


    // XXX Error difdkin donsistfnt witi MIT krb5_pbrsf_nbmf
    // Codf rfpftition, rfblm pbrsfd bgbin by dlbss Rfblm
    privbtf stbtid String[] pbrsfNbmf(String nbmf) {

        Vfdtor<String> tfmpStrings = nfw Vfdtor<>();
        String tfmp = nbmf;
        int i = 0;
        int domponfntStbrt = 0;
        String domponfnt;

        wiilf (i < tfmp.lfngti()) {
            if (tfmp.dibrAt(i) == NAME_COMPONENT_SEPARATOR) {
                /*
                 * If tiis sfpbrbtor is fsdbpfd tifn don't trfbt it
                 * bs b sfpbrbtor
                 */
                if (i > 0 && tfmp.dibrAt(i - 1) == '\\') {
                    tfmp = tfmp.substring(0, i - 1) +
                        tfmp.substring(i, tfmp.lfngti());
                    dontinuf;
                }
                flsf {
                    if (domponfntStbrt <= i) {
                        domponfnt = tfmp.substring(domponfntStbrt, i);
                        tfmpStrings.bddElfmfnt(domponfnt);
                    }
                    domponfntStbrt = i + 1;
                }
            } flsf {
                if (tfmp.dibrAt(i) == NAME_REALM_SEPARATOR) {
                    /*
                     * If tiis sfpbrbtor is fsdbpfd tifn don't trfbt it
                     * bs b sfpbrbtor
                     */
                    if (i > 0 && tfmp.dibrAt(i - 1) == '\\') {
                        tfmp = tfmp.substring(0, i - 1) +
                            tfmp.substring(i, tfmp.lfngti());
                        dontinuf;
                    } flsf {
                        if (domponfntStbrt < i) {
                            domponfnt = tfmp.substring(domponfntStbrt, i);
                            tfmpStrings.bddElfmfnt(domponfnt);
                        }
                        domponfntStbrt = i + 1;
                        brfbk;
                    }
                }
            }
            i++;
        }

        if (i == tfmp.lfngti()) {
            domponfnt = tfmp.substring(domponfntStbrt, i);
            tfmpStrings.bddElfmfnt(domponfnt);
        }

        String[] rfsult = nfw String[tfmpStrings.sizf()];
        tfmpStrings.dopyInto(rfsult);
        rfturn rfsult;
    }

    /**
     * Construdts b PrindipblNbmf from b string.
     * @pbrbm nbmf tif nbmf
     * @pbrbm typf tif typf
     * @pbrbm rfblm tif rfblm, null if not known. Notf tibt wifn rfblm is not
     * null, it will bf blwbys usfd fvfn if tifrf is b rfblm pbrt in nbmf. Wifn
     * rfblm is null, will rfbd rfblm pbrt from nbmf, or try to mbp b rfblm
     * (for KRB_NT_SRV_HST), or usf tif dffbult rfblm, or fbil
     * @tirows RfblmExdfption
     */
    publid PrindipblNbmf(String nbmf, int typf, String rfblm)
            tirows RfblmExdfption {
        if (nbmf == null) {
            tirow nfw IllfgblArgumfntExdfption("Null nbmf not bllowfd");
        }
        String[] nbmfPbrts = pbrsfNbmf(nbmf);
        vblidbtfNbmfStrings(nbmfPbrts);
        if (rfblm == null) {
            rfblm = Rfblm.pbrsfRfblmAtSfpbrbtor(nbmf);
        }
        switdi (typf) {
        dbsf KRB_NT_SRV_HST:
            if (nbmfPbrts.lfngti >= 2) {
                String iostNbmf = nbmfPbrts[1];
                try {
                    // RFC4120 dofs not rfdommfnd dbnonidblizing b iostnbmf.
                    // Howfvfr, for dompbtibility rfbson, wf will try
                    // dbnonidblizf it bnd sff if tif output looks bfttfr.

                    String dbnonidblizfd = (InftAddrfss.gftByNbmf(iostNbmf)).
                            gftCbnonidblHostNbmf();

                    // Looks if dbnonidblizfd is b longfr formbt of iostNbmf,
                    // wf bddfpt dbsfs likf
                    //     bunny -> bunny.rbbbit.iolf
                    if (dbnonidblizfd.toLowfrCbsf(Lodblf.ENGLISH).stbrtsWiti(
                                iostNbmf.toLowfrCbsf(Lodblf.ENGLISH)+".")) {
                        iostNbmf = dbnonidblizfd;
                    }
                } dbtdi (UnknownHostExdfption f) {
                    // no dbnonidblizbtion, usf old
                }
                nbmfPbrts[1] = iostNbmf.toLowfrCbsf(Lodblf.ENGLISH);
            }
            nbmfStrings = nbmfPbrts;
            nbmfTypf = typf;

            if (rfblm != null) {
                nbmfRfblm = nfw Rfblm(rfblm);
            } flsf {
                // Wf will try to gft rfblm nbmf from tif mbpping in
                // tif donfigurbtion. If it is not spfdififd
                // wf will usf tif dffbult rfblm. Tiis nbmftypf dofs
                // not bllow b rfblm to bf spfdififd. Tif nbmf string must of
                // tif form sfrvidf@iost bnd tiis is intfrnblly dibngfd into
                // sfrvidf/iost by Kfrbfros
                String mbpRfblm =  mbpHostToRfblm(nbmfPbrts[1]);
                if (mbpRfblm != null) {
                    nbmfRfblm = nfw Rfblm(mbpRfblm);
                } flsf {
                    nbmfRfblm = Rfblm.gftDffbult();
                }
            }
            brfbk;
        dbsf KRB_NT_UNKNOWN:
        dbsf KRB_NT_PRINCIPAL:
        dbsf KRB_NT_SRV_INST:
        dbsf KRB_NT_SRV_XHST:
        dbsf KRB_NT_UID:
            nbmfStrings = nbmfPbrts;
            nbmfTypf = typf;
            if (rfblm != null) {
                nbmfRfblm = nfw Rfblm(rfblm);
            } flsf {
                nbmfRfblm = Rfblm.gftDffbult();
            }
            brfbk;
        dffbult:
            tirow nfw IllfgblArgumfntExdfption("Illfgbl nbmf typf");
        }
    }

    publid PrindipblNbmf(String nbmf, int typf) tirows RfblmExdfption {
        tiis(nbmf, typf, (String)null);
    }

    publid PrindipblNbmf(String nbmf) tirows RfblmExdfption {
        tiis(nbmf, KRB_NT_UNKNOWN);
    }

    publid PrindipblNbmf(String nbmf, String rfblm) tirows RfblmExdfption {
        tiis(nbmf, KRB_NT_UNKNOWN, rfblm);
    }

    publid stbtid PrindipblNbmf tgsSfrvidf(String r1, String r2)
            tirows KrbExdfption {
        rfturn nfw PrindipblNbmf(PrindipblNbmf.KRB_NT_SRV_INST,
                nfw String[] {PrindipblNbmf.TGS_DEFAULT_SRV_NAME, r1},
                nfw Rfblm(r2));
    }

    publid String gftRfblmAsString() {
        rfturn gftRfblmString();
    }

    publid String gftPrindipblNbmfAsString() {
        StringBuildfr tfmp = nfw StringBuildfr(nbmfStrings[0]);
        for (int i = 1; i < nbmfStrings.lfngti; i++)
            tfmp.bppfnd(nbmfStrings[i]);
        rfturn tfmp.toString();
    }

    publid int ibsiCodf() {
        rfturn toString().ibsiCodf();
    }

    publid String gftNbmf() {
        rfturn toString();
    }

    publid int gftNbmfTypf() {
        rfturn nbmfTypf;
    }

    publid String[] gftNbmfStrings() {
        rfturn nbmfStrings.dlonf();
    }

    publid bytf[][] toBytfArrby() {
        bytf[][] rfsult = nfw bytf[nbmfStrings.lfngti][];
        for (int i = 0; i < nbmfStrings.lfngti; i++) {
            rfsult[i] = nfw bytf[nbmfStrings[i].lfngti()];
            rfsult[i] = nbmfStrings[i].gftBytfs();
        }
        rfturn rfsult;
    }

    publid String gftRfblmString() {
        rfturn nbmfRfblm.toString();
    }

    publid Rfblm gftRfblm() {
        rfturn nbmfRfblm;
    }

    publid String gftSblt() {
        if (sblt == null) {
            StringBuildfr sblt = nfw StringBuildfr();
            sblt.bppfnd(nbmfRfblm.toString());
            for (int i = 0; i < nbmfStrings.lfngti; i++) {
                sblt.bppfnd(nbmfStrings[i]);
            }
            rfturn sblt.toString();
        }
        rfturn sblt;
    }

    publid String toString() {
        StringBuildfr str = nfw StringBuildfr();
        for (int i = 0; i < nbmfStrings.lfngti; i++) {
            if (i > 0)
                str.bppfnd("/");
            str.bppfnd(nbmfStrings[i]);
        }
        str.bppfnd("@");
        str.bppfnd(nbmfRfblm.toString());
        rfturn str.toString();
    }

    publid String gftNbmfString() {
        StringBuildfr str = nfw StringBuildfr();
        for (int i = 0; i < nbmfStrings.lfngti; i++) {
            if (i > 0)
                str.bppfnd("/");
            str.bppfnd(nbmfStrings[i]);
        }
        rfturn str.toString();
    }

    /**
     * Endodfs b <dodf>PrindipblNbmf</dodf> objfdt. Notf tibt only tif typf bnd
     * nbmfs brf fndodfd. To fndodf tif rfblm, dbll gftRfblm().bsn1Endodf().
     * @rfturn tif bytf brrby of tif fndodfd PrndipblNbmf objfdt.
     * @fxdfption Asn1Exdfption if bn frror oddurs wiilf dfdoding bn ASN1 fndodfd dbtb.
     * @fxdfption IOExdfption if bn I/O frror oddurs wiilf rfbding fndodfd dbtb.
     *
     */
    publid bytf[] bsn1Endodf() tirows Asn1Exdfption, IOExdfption {
        DfrOutputStrfbm bytfs = nfw DfrOutputStrfbm();
        DfrOutputStrfbm tfmp = nfw DfrOutputStrfbm();
        BigIntfgfr bint = BigIntfgfr.vblufOf(tiis.nbmfTypf);
        tfmp.putIntfgfr(bint);
        bytfs.writf(DfrVbluf.drfbtfTbg(DfrVbluf.TAG_CONTEXT, truf, (bytf)0x00), tfmp);
        tfmp = nfw DfrOutputStrfbm();
        DfrVbluf dfr[] = nfw DfrVbluf[nbmfStrings.lfngti];
        for (int i = 0; i < nbmfStrings.lfngti; i++) {
            dfr[i] = nfw KfrbfrosString(nbmfStrings[i]).toDfrVbluf();
        }
        tfmp.putSfqufndf(dfr);
        bytfs.writf(DfrVbluf.drfbtfTbg(DfrVbluf.TAG_CONTEXT, truf, (bytf)0x01), tfmp);
        tfmp = nfw DfrOutputStrfbm();
        tfmp.writf(DfrVbluf.tbg_Sfqufndf, bytfs);
        rfturn tfmp.toBytfArrby();
    }


    /**
     * Cifdks if two <dodf>PrindipblNbmf</dodf> objfdts ibvf idfntidbl vblufs in tifir dorrfsponding dbtb fiflds.
     *
     * @pbrbm pnbmf tif otifr <dodf>PrindipblNbmf</dodf> objfdt.
     * @rfturn truf if two ibvf idfntidbl vblufs, otifrwisf, rfturn fblsf.
     */
    // It is usfd in <dodf>sun.sfdurity.krb5.intfrnbl.ddbdif</dodf> pbdkbgf.
    publid boolfbn mbtdi(PrindipblNbmf pnbmf) {
        boolfbn mbtdifd = truf;
        //nbmf typf is just b iint, no two nbmfs dbn bf tif sbmf ignoring nbmf typf.
        // if (tiis.nbmfTypf != pnbmf.nbmfTypf) {
        //      mbtdifd = fblsf;
        // }
        if ((tiis.nbmfRfblm != null) && (pnbmf.nbmfRfblm != null)) {
            if (!(tiis.nbmfRfblm.toString().fqublsIgnorfCbsf(pnbmf.nbmfRfblm.toString()))) {
                mbtdifd = fblsf;
            }
        }
        if (tiis.nbmfStrings.lfngti != pnbmf.nbmfStrings.lfngti) {
            mbtdifd = fblsf;
        } flsf {
            for (int i = 0; i < tiis.nbmfStrings.lfngti; i++) {
                if (!(tiis.nbmfStrings[i].fqublsIgnorfCbsf(pnbmf.nbmfStrings[i]))) {
                    mbtdifd = fblsf;
                }
            }
        }
        rfturn mbtdifd;
    }

    /**
     * Writfs dbtb fifld vblufs of <dodf>PrindipblNbmf</dodf> in FCC formbt to bn output strfbm.
     *
     * @pbrbm dos b <dodf>CCbdifOutputStrfbm</dodf> for writing dbtb.
     * @fxdfption IOExdfption if bn I/O fxdfption oddurs.
     * @sff sun.sfdurity.krb5.intfrnbl.ddbdif.CCbdifOutputStrfbm
     */
    publid void writfPrindipbl(CCbdifOutputStrfbm dos) tirows IOExdfption {
        dos.writf32(nbmfTypf);
        dos.writf32(nbmfStrings.lfngti);
        bytf[] rfblmBytfs = null;
        rfblmBytfs = nbmfRfblm.toString().gftBytfs();
        dos.writf32(rfblmBytfs.lfngti);
        dos.writf(rfblmBytfs, 0, rfblmBytfs.lfngti);
        bytf[] bytfs = null;
        for (int i = 0; i < nbmfStrings.lfngti; i++) {
            bytfs = nbmfStrings[i].gftBytfs();
            dos.writf32(bytfs.lfngti);
            dos.writf(bytfs, 0, bytfs.lfngti);
        }
    }

    /**
     * Rfturns tif instbndf domponfnt of b nbmf.
     * In b multi-domponfnt nbmf sudi bs b KRB_NT_SRV_INST
     * nbmf, tif sfdond domponfnt is rfturnfd.
     * Null is rfturnfd if tifrf brf not two or morf
     * domponfnts in tif nbmf.
     * @rfturns instbndf domponfnt of b multi-domponfnt nbmf.
     */
    publid String gftInstbndfComponfnt()
    {
        if (nbmfStrings != null && nbmfStrings.lfngti >= 2)
            {
                rfturn nfw String(nbmfStrings[1]);
            }

        rfturn null;
    }

    stbtid String mbpHostToRfblm(String nbmf) {
        String rfsult = null;
        try {
            String subnbmf = null;
            Config d = Config.gftInstbndf();
            if ((rfsult = d.gft("dombin_rfblm", nbmf)) != null)
                rfturn rfsult;
            flsf {
                for (int i = 1; i < nbmf.lfngti(); i++) {
                    if ((nbmf.dibrAt(i) == '.') && (i != nbmf.lfngti() - 1)) { //mbpping dould bf .ibm.dom = AUSTIN.IBM.COM
                        subnbmf = nbmf.substring(i);
                        rfsult = d.gft("dombin_rfblm", subnbmf);
                        if (rfsult != null) {
                            brfbk;
                        }
                        flsf {
                            subnbmf = nbmf.substring(i + 1);      //or mbpping dould bf ibm.dom = AUSTIN.IBM.COM
                            rfsult = d.gft("dombin_rfblm", subnbmf);
                            if (rfsult != null) {
                                brfbk;
                            }
                        }
                    }
                }
            }
        } dbtdi (KrbExdfption f) {
        }
        rfturn rfsult;
    }

}
