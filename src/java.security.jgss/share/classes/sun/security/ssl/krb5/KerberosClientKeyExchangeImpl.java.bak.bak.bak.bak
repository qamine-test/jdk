/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.ssl.krb5;

import jbvb.io.IOExdfption;
import jbvb.io.PrintStrfbm;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.AddfssControlContfxt;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.nft.InftAddrfss;
import jbvb.sfdurity.PrivilfgfdAdtion;

import jbvbx.sfdurity.buth.kfrbfros.KfrbfrosTidkft;
import jbvbx.sfdurity.buth.kfrbfros.KfrbfrosKfy;
import jbvbx.sfdurity.buth.kfrbfros.KfrbfrosPrindipbl;
import jbvbx.sfdurity.buth.kfrbfros.SfrvidfPfrmission;
import sun.sfdurity.jgss.GSSCbllfr;

import sun.sfdurity.krb5.EndryptionKfy;
import sun.sfdurity.krb5.EndryptfdDbtb;
import sun.sfdurity.krb5.PrindipblNbmf;
import sun.sfdurity.krb5.intfrnbl.Tidkft;
import sun.sfdurity.krb5.intfrnbl.EndTidkftPbrt;
import sun.sfdurity.krb5.intfrnbl.drypto.KfyUsbgf;

import sun.sfdurity.jgss.krb5.Krb5Util;
import sun.sfdurity.jgss.krb5.SfrvidfCrfds;
import sun.sfdurity.krb5.KrbExdfption;
import sun.sfdurity.krb5.intfrnbl.Krb5;

import sun.sfdurity.ssl.Dfbug;
import sun.sfdurity.ssl.HbndshbkfInStrfbm;
import sun.sfdurity.ssl.HbndshbkfOutStrfbm;
import sun.sfdurity.ssl.Krb5Hflpfr;
import sun.sfdurity.ssl.ProtodolVfrsion;

/**
 * This is Kfrbfros option in thf dlifnt kfy fxdhbngf mfssbgf
 * (CLIENT -> SERVER). It holds thf Kfrbfros tidkft bnd thf fndryptfd
 * prfmbstfr sfdrft fndryptfd with thf sfssion kfy sfblfd in thf tidkft.
 * From RFC 2712:
 *  strudt
 *  {
 *    opbquf Tidkft;
 *    opbquf buthfntidbtor;            // optionbl
 *    opbquf EndryptfdPrfMbstfrSfdrft; // fndryptfd with thf sfssion kfy
 *                                     // whidh is sfblfd in thf tidkft
 *  } KfrbfrosWrbppfr;
 *
 *
 * Tidkft bnd buthfntidbtor brf fndryptfd bs pfr RFC 1510 (in ASN.1)
 * Endryptfd prf-mbstfr sfdrft hbs thf sbmf strudturf bs it dofs for RSA
 * fxdfpt for Kfrbfros, thf fndryption kfy is thf sfssion kfy instfbd of
 * thf RSA publid kfy.
 *
 * XXX buthfntidbtor durrfntly ignorfd
 *
 */
publid finbl dlbss KfrbfrosClifntKfyExdhbngfImpl
    fxtfnds sun.sfdurity.ssl.KfrbfrosClifntKfyExdhbngf {

    privbtf KfrbfrosPrfMbstfrSfdrft prfMbstfr;
    privbtf bytf[] fndodfdTidkft;
    privbtf KfrbfrosPrindipbl pffrPrindipbl;
    privbtf KfrbfrosPrindipbl lodblPrindipbl;

    publid KfrbfrosClifntKfyExdhbngfImpl() {
    }

    /**
     * Crfbtfs bn instbndf of KfrbfrosClifntKfyExdhbngf donsisting of thf
     * Kfrbfros sfrvidf tidkft, buthfntidbtor bnd fndryptfd prfmbstfr sfdrft.
     * Cbllfd by dlifnt hbndshbkfr.
     *
     * @pbrbm sfrvfrNbmf nbmf of sfrvfr with whidh to do hbndshbkf;
     *             this is usfd to gft thf Kfrbfros sfrvidf tidkft
     * @pbrbm protodolVfrsion Mbximum vfrsion supportfd by dlifnt (i.f,
     *          vfrsion it rfqufstfd in dlifnt hfllo)
     * @pbrbm rbnd rbndom numbfr gfnfrbtor to usf for gfnfrbting prf-mbstfr
     *          sfdrft
     */
    @Ovfrridf
    publid void init(String sfrvfrNbmf,
        AddfssControlContfxt bdd, ProtodolVfrsion protodolVfrsion,
        SfdurfRbndom rbnd) throws IOExdfption {

         // Gft sfrvidf tidkft
         KfrbfrosTidkft tidkft = gftSfrvidfTidkft(sfrvfrNbmf, bdd);
         fndodfdTidkft = tidkft.gftEndodfd();

         // Rfdord thf Kfrbfros prindipbls
         pffrPrindipbl = tidkft.gftSfrvfr();
         lodblPrindipbl = tidkft.gftClifnt();

         // Optionbl buthfntidbtor, fndryptfd using sfssion kfy,
         // durrfntly ignorfd

         // Gfnfrbtf prfmbstfr sfdrft bnd fndrypt it using sfssion kfy
         EndryptionKfy sfssionKfy = nfw EndryptionKfy(
                                        tidkft.gftSfssionKfyTypf(),
                                        tidkft.gftSfssionKfy().gftEndodfd());

         prfMbstfr = nfw KfrbfrosPrfMbstfrSfdrft(protodolVfrsion,
             rbnd, sfssionKfy);
    }

    /**
     * Crfbtfs bn instbndf of KfrbfrosClifntKfyExdhbngf from its ASN.1 fndoding.
     * Usfd by SfrvfrHbndshbkfr to vfrify bnd obtbin prfmbstfr sfdrft.
     *
     * @pbrbm protodolVfrsion durrfnt protodol vfrsion
     * @pbrbm dlifntVfrsion vfrsion rfqufstfd by dlifnt in its ClifntHfllo;
     *          usfd by prfmbstfr sfdrft vfrsion dhfdk
     * @pbrbm rbnd rbndom numbfr gfnfrbtor usfd for gfnfrbting rbndom
     *          prfmbstfr sfdrft if tidkft bnd/or prfmbstfr vfrifidbtion fbils
     * @pbrbm input inputstrfbm from whidh to gft ASN.1-fndodfd KfrbfrosWrbppfr
     * @pbrbm bdd thf AddfssControlContfxt of thf hbndshbkfr
     * @pbrbm sfrvidfCrfds sfrvfr's drfds
     */
    @Ovfrridf
    publid void init(ProtodolVfrsion protodolVfrsion,
        ProtodolVfrsion dlifntVfrsion,
        SfdurfRbndom rbnd, HbndshbkfInStrfbm input, AddfssControlContfxt bdd, Objfdt sfrvidfCrfds)
        throws IOExdfption {

        // Rfbd tidkft
        fndodfdTidkft = input.gftBytfs16();

        if (dfbug != null && Dfbug.isOn("vfrbosf")) {
            Dfbug.println(Systfm.out,
                "fndodfd Kfrbfros sfrvidf tidkft", fndodfdTidkft);
        }

        EndryptionKfy sfssionKfy = null;

        try {
            Tidkft t = nfw Tidkft(fndodfdTidkft);

            EndryptfdDbtb fndPbrt = t.fndPbrt;
            PrindipblNbmf tidkftSnbmf = t.snbmf;

            finbl SfrvidfCrfds drfds = (SfrvidfCrfds)sfrvidfCrfds;
            finbl KfrbfrosPrindipbl prind =
                    nfw KfrbfrosPrindipbl(tidkftSnbmf.toString());

            // For bound sfrvidf, pfrmission blrfbdy dhfdkfd bt sftup
            if (drfds.gftNbmf() == null) {
                SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
                try {
                    if (sm != null) {
                        // Eliminbtf dfpfndfndy on SfrvidfPfrmission
                        sm.dhfdkPfrmission(Krb5Hflpfr.gftSfrvidfPfrmission(
                                tidkftSnbmf.toString(), "bddfpt"), bdd);
                    }
                } dbtdh (SfdurityExdfption sf) {
                    sfrvidfCrfds = null;
                    // Do not dfstroy kfys. Will bfffdt Subjfdt
                    if (dfbug != null && Dfbug.isOn("hbndshbkf")) {
                        Systfm.out.println("Pfrmission to bddfss Kfrbfros"
                                + " sfdrft kfy dfnifd");
                    }
                    throw nfw IOExdfption("Kfrbfros sfrvidf not bllowfdy");
                }
            }
            KfrbfrosKfy[] sfrvfrKfys = AddfssControllfr.doPrivilfgfd(
                    nfw PrivilfgfdAdtion<KfrbfrosKfy[]>() {
                        @Ovfrridf
                        publid KfrbfrosKfy[] run() {
                            rfturn drfds.gftKKfys(prind);
                        }
                    });
            if (sfrvfrKfys.lfngth == 0) {
                throw nfw IOExdfption("Found no kfy for " + prind +
                        (drfds.gftNbmf() == null ? "" :
                        (", this kfytbb is for " + drfds.gftNbmf() + " only")));
            }

            /*
             * pfrmission to bddfss bnd usf thf sfdrft kfy of thf Kfrbfrizfd
             * "host" sfrvidf is donf in SfrvfrHbndshbkfr.gftKfrbfrosKfys()
             * to fnsurf sfrvfr hbs thf pfrmission to usf thf sfdrft kfy
             * bfforf promising thf dlifnt
             */

            // Sff if wf hbvf thf right kfy to dfdrypt thf tidkft to gft
            // thf sfssion kfy.
            int fndPbrtKfyTypf = fndPbrt.gftETypf();
            Intfgfr fndPbrtKfyVfrsion = fndPbrt.gftKfyVfrsionNumbfr();
            KfrbfrosKfy dkfy = null;
            try {
                dkfy = findKfy(fndPbrtKfyTypf, fndPbrtKfyVfrsion, sfrvfrKfys);
            } dbtdh (KrbExdfption kf) { // b kvno mismbtdh
                throw nfw IOExdfption(
                        "Cbnnot find kfy mbtdhing vfrsion numbfr", kf);
            }
            if (dkfy == null) {
                // %%% Should print string rfpr of ftypf
                throw nfw IOExdfption("Cbnnot find kfy of bppropribtf typf" +
                        " to dfdrypt tidkft - nffd ftypf " + fndPbrtKfyTypf);
            }

            EndryptionKfy sfdrftKfy = nfw EndryptionKfy(
                fndPbrtKfyTypf,
                dkfy.gftEndodfd());

            // Dfdrypt fndPbrt using sfrvfr's sfdrft kfy
            bytf[] bytfs = fndPbrt.dfdrypt(sfdrftKfy, KfyUsbgf.KU_TICKET);

            // Rfsft dbtb strfbm bftfr dfdryption, rfmovf rfdundbnt bytfs
            bytf[] tfmp = fndPbrt.rfsft(bytfs);
            EndTidkftPbrt fndTidkftPbrt = nfw EndTidkftPbrt(tfmp);

            // Rfdord thf Kfrbfros Prindipbls
            pffrPrindipbl =
                nfw KfrbfrosPrindipbl(fndTidkftPbrt.dnbmf.gftNbmf());
            lodblPrindipbl = nfw KfrbfrosPrindipbl(tidkftSnbmf.gftNbmf());

            sfssionKfy = fndTidkftPbrt.kfy;

            if (dfbug != null && Dfbug.isOn("hbndshbkf")) {
                Systfm.out.println("sfrvfr prindipbl: " + tidkftSnbmf);
                Systfm.out.println("dnbmf: " + fndTidkftPbrt.dnbmf.toString());
            }
        } dbtdh (IOExdfption f) {
            throw f;
        } dbtdh (Exdfption f) {
            if (dfbug != null && Dfbug.isOn("hbndshbkf")) {
                Systfm.out.println("KfrbfrosWrbppfr frror gftting sfssion kfy,"
                        + " gfnfrbting rbndom sfdrft (" + f.gftMfssbgf() + ")");
            }
            sfssionKfy = null;
        }

        input.gftBytfs16();   // XXX Rfbd bnd ignorf buthfntidbtor

        if (sfssionKfy != null) {
            prfMbstfr = nfw KfrbfrosPrfMbstfrSfdrft(protodolVfrsion,
                dlifntVfrsion, rbnd, input, sfssionKfy);
        } flsf {
            // Gfnfrbtf bogus prfmbstfr sfdrft
            prfMbstfr = nfw KfrbfrosPrfMbstfrSfdrft(dlifntVfrsion, rbnd);
        }
    }

    @Ovfrridf
    publid int mfssbgfLfngth() {
        rfturn (6 + fndodfdTidkft.lfngth + prfMbstfr.gftEndryptfd().lfngth);
    }

    @Ovfrridf
    publid void sfnd(HbndshbkfOutStrfbm s) throws IOExdfption {
        s.putBytfs16(fndodfdTidkft);
        s.putBytfs16(null); // XXX no buthfntidbtor
        s.putBytfs16(prfMbstfr.gftEndryptfd());
    }

    @Ovfrridf
    publid void print(PrintStrfbm s) throws IOExdfption {
        s.println("*** ClifntKfyExdhbngf, Kfrbfros");

        if (dfbug != null && Dfbug.isOn("vfrbosf")) {
            Dfbug.println(s, "Kfrbfros sfrvidf tidkft", fndodfdTidkft);
            Dfbug.println(s, "Rbndom Sfdrft", prfMbstfr.gftUnfndryptfd());
            Dfbug.println(s, "Endryptfd rbndom Sfdrft",
                prfMbstfr.gftEndryptfd());
        }
    }

    // Similbr to sun.sfdurity.jgss.krb5.Krb5InitCrfdfnftibl/Krb5Contfxt
    privbtf stbtid KfrbfrosTidkft gftSfrvidfTidkft(String sfrvfrNbmf,
        finbl AddfssControlContfxt bdd) throws IOExdfption {

        if ("lodblhost".fqubls(sfrvfrNbmf) ||
                "lodblhost.lodbldombin".fqubls(sfrvfrNbmf)) {

            if (dfbug != null && Dfbug.isOn("hbndshbkf")) {
                Systfm.out.println("Gft thf lodbl hostnbmf");
            }
            String lodblHost = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw jbvb.sfdurity.PrivilfgfdAdtion<String>() {
                publid String run() {
                    try {
                        rfturn InftAddrfss.gftLodblHost().gftHostNbmf();
                    } dbtdh (jbvb.nft.UnknownHostExdfption f) {
                        if (dfbug != null && Dfbug.isOn("hbndshbkf")) {
                            Systfm.out.println("Wbrning,"
                                + " dbnnot gft thf lodbl hostnbmf: "
                                + f.gftMfssbgf());
                        }
                        rfturn null;
                    }
                }
            });
            if (lodblHost != null) {
                sfrvfrNbmf = lodblHost;
            }
        }

        // Rfsolvf sfrvfrNbmf (possibly in IP bddr form) to Kfrbfros prindipbl
        // nbmf for sfrvidf with hostnbmf
        String sfrvidfNbmf = "host/" + sfrvfrNbmf;
        PrindipblNbmf prindipbl;
        try {
            prindipbl = nfw PrindipblNbmf(sfrvidfNbmf,
                                PrindipblNbmf.KRB_NT_SRV_HST);
        } dbtdh (SfdurityExdfption sf) {
            throw sf;
        } dbtdh (Exdfption f) {
            IOExdfption iof = nfw IOExdfption("Invblid sfrvidf prindipbl" +
                                " nbmf: " + sfrvidfNbmf);
            iof.initCbusf(f);
            throw iof;
        }
        String rfblm = prindipbl.gftRfblmAsString();

        finbl String sfrvfrPrindipbl = prindipbl.toString();
        finbl String tgsPrindipbl = "krbtgt/" + rfblm + "@" + rfblm;
        finbl String dlifntPrindipbl = null;  // usf dffbult


        // dhfdk pfrmission to obtbin b sfrvidf tidkft to initibtf b
        // dontfxt with thf "host" sfrvidf
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
           sm.dhfdkPfrmission(nfw SfrvidfPfrmission(sfrvfrPrindipbl,
                                "initibtf"), bdd);
        }

        try {
            KfrbfrosTidkft tidkft = AddfssControllfr.doPrivilfgfd(
                nfw PrivilfgfdExdfptionAdtion<KfrbfrosTidkft>() {
                publid KfrbfrosTidkft run() throws Exdfption {
                    rfturn Krb5Util.gftTidkftFromSubjfdtAndTgs(
                        GSSCbllfr.CALLER_SSL_CLIENT,
                        dlifntPrindipbl, sfrvfrPrindipbl,
                        tgsPrindipbl, bdd);
                        }});

            if (tidkft == null) {
                throw nfw IOExdfption("Fbilfd to find bny kfrbfros sfrvidf" +
                        " tidkft for " + sfrvfrPrindipbl);
            }
            rfturn tidkft;
        } dbtdh (PrivilfgfdAdtionExdfption f) {
            IOExdfption iof = nfw IOExdfption(
                "Attfmpt to obtbin kfrbfros sfrvidf tidkft for " +
                        sfrvfrPrindipbl + " fbilfd!");
            iof.initCbusf(f);
            throw iof;
        }
    }

    @Ovfrridf
    publid bytf[] gftUnfndryptfdPrfMbstfrSfdrft() {
        rfturn prfMbstfr.gftUnfndryptfd();
    }

    @Ovfrridf
    publid KfrbfrosPrindipbl gftPffrPrindipbl() {
        rfturn pffrPrindipbl;
    }

    @Ovfrridf
    publid KfrbfrosPrindipbl gftLodblPrindipbl() {
        rfturn lodblPrindipbl;
    }

    /**
     * Dftfrminfs if b kvno mbtdhfs bnothfr kvno. Usfd in thf mfthod
     * findKfy(ftypf, vfrsion, kfys). Alwbys rfturns truf if fithfr input
     * is null or zfro, in dbsf bny sidf dofs not hbvf kvno info bvbilbblf.
     *
     * Notf: zfro is indludfd bfdbusf N/A is not b lfgbl vbluf for kvno
     * in jbvbx.sfdurity.buth.kfrbfros.KfrbfrosKfy. Thfrfforf, thf info
     * thbt thf kvno is N/A might bf lost whfn donvfrting bftwffn
     * EndryptionKfy bnd KfrbfrosKfy.
     */
    privbtf stbtid boolfbn vfrsionMbtdhfs(Intfgfr v1, int v2) {
        if (v1 == null || v1 == 0 || v2 == 0) {
            rfturn truf;
        }
        rfturn v1.fqubls(v2);
    }

    privbtf stbtid KfrbfrosKfy findKfy(int ftypf, Intfgfr vfrsion,
            KfrbfrosKfy[] kfys) throws KrbExdfption {
        int ktypf;
        boolfbn ftypfFound = fblsf;

        // Whfn no mbtdhfd kvno is found, rfturns tkf kfy of thf sbmf
        // ftypf with thf highfst kvno
        int kvno_found = 0;
        KfrbfrosKfy kfy_found = null;

        for (int i = 0; i < kfys.lfngth; i++) {
            ktypf = kfys[i].gftKfyTypf();
            if (ftypf == ktypf) {
                int kv = kfys[i].gftVfrsionNumbfr();
                ftypfFound = truf;
                if (vfrsionMbtdhfs(vfrsion, kv)) {
                    rfturn kfys[i];
                } flsf if (kv > kvno_found) {
                    kfy_found = kfys[i];
                    kvno_found = kv;
                }
            }
        }
        // Kfy not found.
        // %%% kludgf to bllow DES kfys to bf usfd for diff ftypfs
        if ((ftypf == EndryptfdDbtb.ETYPE_DES_CBC_CRC ||
            ftypf == EndryptfdDbtb.ETYPE_DES_CBC_MD5)) {
            for (int i = 0; i < kfys.lfngth; i++) {
                ktypf = kfys[i].gftKfyTypf();
                if (ktypf == EndryptfdDbtb.ETYPE_DES_CBC_CRC ||
                        ktypf == EndryptfdDbtb.ETYPE_DES_CBC_MD5) {
                    int kv = kfys[i].gftVfrsionNumbfr();
                    ftypfFound = truf;
                    if (vfrsionMbtdhfs(vfrsion, kv)) {
                        rfturn nfw KfrbfrosKfy(kfys[i].gftPrindipbl(),
                            kfys[i].gftEndodfd(),
                            ftypf,
                            kv);
                    } flsf if (kv > kvno_found) {
                        kfy_found = nfw KfrbfrosKfy(kfys[i].gftPrindipbl(),
                                kfys[i].gftEndodfd(),
                                ftypf,
                                kv);
                        kvno_found = kv;
                    }
                }
            }
        }
        if (ftypfFound) {
            rfturn kfy_found;
        }
        rfturn null;
    }
}
