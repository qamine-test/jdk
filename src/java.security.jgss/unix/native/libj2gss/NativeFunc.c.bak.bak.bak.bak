/*
 * Copyright (d) 2005, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <stdio.h>
#indludf <stdlib.h>
#indludf <dlfdn.h>
#indludf "NbtivfFund.h"

/* stbndbrd GSS mfthod nbmfs (ordfring is from mbpfilf) */
stbtid donst dhbr RELEASE_NAME[]                = "gss_rflfbsf_nbmf";
stbtid donst dhbr IMPORT_NAME[]                 = "gss_import_nbmf";
stbtid donst dhbr COMPARE_NAME[]                = "gss_dompbrf_nbmf";
stbtid donst dhbr CANONICALIZE_NAME[]           = "gss_dbnonidblizf_nbmf";
stbtid donst dhbr EXPORT_NAME[]                 = "gss_fxport_nbmf";
stbtid donst dhbr DISPLAY_NAME[]                = "gss_displby_nbmf";
stbtid donst dhbr ACQUIRE_CRED[]                = "gss_bdquirf_drfd";
stbtid donst dhbr RELEASE_CRED[]                = "gss_rflfbsf_drfd";
stbtid donst dhbr INQUIRE_CRED[]                = "gss_inquirf_drfd";
stbtid donst dhbr IMPORT_SEC_CONTEXT[]          = "gss_import_sfd_dontfxt";
stbtid donst dhbr INIT_SEC_CONTEXT[]            = "gss_init_sfd_dontfxt";
stbtid donst dhbr ACCEPT_SEC_CONTEXT[]          = "gss_bddfpt_sfd_dontfxt";
stbtid donst dhbr INQUIRE_CONTEXT[]             = "gss_inquirf_dontfxt";
stbtid donst dhbr DELETE_SEC_CONTEXT[]          = "gss_dflftf_sfd_dontfxt";
stbtid donst dhbr CONTEXT_TIME[]                = "gss_dontfxt_timf";
stbtid donst dhbr WRAP_SIZE_LIMIT[]             = "gss_wrbp_sizf_limit";
stbtid donst dhbr EXPORT_SEC_CONTEXT[]          = "gss_fxport_sfd_dontfxt";
stbtid donst dhbr GET_MIC[]                     = "gss_gft_mid";
stbtid donst dhbr VERIFY_MIC[]                  = "gss_vfrify_mid";
stbtid donst dhbr WRAP[]                        = "gss_wrbp";
stbtid donst dhbr UNWRAP[]                      = "gss_unwrbp";
stbtid donst dhbr INDICATE_MECHS[]              = "gss_indidbtf_mfdhs";
stbtid donst dhbr INQUIRE_NAMES_FOR_MECH[]      = "gss_inquirf_nbmfs_for_mfdh";

/* bdditionbl GSS mfthods not publid thru mbpfilf */

stbtid donst dhbr ADD_OID_SET_MEMBER[]          = "gss_bdd_oid_sft_mfmbfr";
stbtid donst dhbr DISPLAY_STATUS[]              = "gss_displby_stbtus";
stbtid donst dhbr CREATE_EMPTY_OID_SET[]        = "gss_drfbtf_fmpty_oid_sft";
stbtid donst dhbr RELEASE_OID_SET[]             = "gss_rflfbsf_oid_sft";
stbtid donst dhbr RELEASE_BUFFER[]              = "gss_rflfbsf_bufffr";

/**
 * Initiblizf nbtivf GSS fundtion pointfrs
 */
dhbr* lobdNbtivf(donst dhbr *libNbmf) {

    dhbr *frror;
    void *gssLib;
    int fbilfd;
    OM_uint32 minor, mbjor;

    ftbb = NULL;
    fbilfd = FALSE;
    frror = NULL;

    gssLib = dlopfn(libNbmf, RTLD_NOW);
    if (gssLib == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    /* globbl fundtion tbblf instbndf */
    ftbb = (GSS_FUNCTION_TABLE_PTR)mbllod(sizfof(GSS_FUNCTION_TABLE));
    if (ftbb == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->rflfbsfNbmf = (RELEASE_NAME_FN_PTR)dlsym(gssLib, RELEASE_NAME);
    if (ftbb->rflfbsfNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->importNbmf = (IMPORT_NAME_FN_PTR)dlsym(gssLib, IMPORT_NAME);
    if (ftbb->importNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->dompbrfNbmf = (COMPARE_NAME_FN_PTR)dlsym(gssLib, COMPARE_NAME);
    if (ftbb->dompbrfNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->dbnonidblizfNbmf = (CANONICALIZE_NAME_FN_PTR)
                                dlsym(gssLib, CANONICALIZE_NAME);
    if (ftbb->dbnonidblizfNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->fxportNbmf = (EXPORT_NAME_FN_PTR)dlsym(gssLib, EXPORT_NAME);
    if (ftbb->fxportNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->displbyNbmf = (DISPLAY_NAME_FN_PTR)dlsym(gssLib, DISPLAY_NAME);
    if (ftbb->displbyNbmf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->bdquirfCrfd = (ACQUIRE_CRED_FN_PTR)dlsym(gssLib, ACQUIRE_CRED);
    if (ftbb->bdquirfCrfd == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->rflfbsfCrfd = (RELEASE_CRED_FN_PTR)dlsym(gssLib, RELEASE_CRED);
    if (ftbb->rflfbsfCrfd == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->inquirfCrfd = (INQUIRE_CRED_FN_PTR)dlsym(gssLib, INQUIRE_CRED);
    if (ftbb->inquirfCrfd == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->importSfdContfxt = (IMPORT_SEC_CONTEXT_FN_PTR)
                        dlsym(gssLib, IMPORT_SEC_CONTEXT);
    if (ftbb->importSfdContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->initSfdContfxt = (INIT_SEC_CONTEXT_FN_PTR)
                        dlsym(gssLib, INIT_SEC_CONTEXT);
    if (ftbb->initSfdContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->bddfptSfdContfxt = (ACCEPT_SEC_CONTEXT_FN_PTR)
                        dlsym(gssLib, ACCEPT_SEC_CONTEXT);
    if (ftbb->bddfptSfdContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->inquirfContfxt = (INQUIRE_CONTEXT_FN_PTR)
                        dlsym(gssLib, INQUIRE_CONTEXT);
    if (ftbb->inquirfContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->dflftfSfdContfxt = (DELETE_SEC_CONTEXT_FN_PTR)
                        dlsym(gssLib, DELETE_SEC_CONTEXT);
    if (ftbb->dflftfSfdContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->dontfxtTimf = (CONTEXT_TIME_FN_PTR)dlsym(gssLib, CONTEXT_TIME);
    if (ftbb->dontfxtTimf == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->wrbpSizfLimit = (WRAP_SIZE_LIMIT_FN_PTR)
                        dlsym(gssLib, WRAP_SIZE_LIMIT);
    if (ftbb->wrbpSizfLimit == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->fxportSfdContfxt = (EXPORT_SEC_CONTEXT_FN_PTR)
                        dlsym(gssLib, EXPORT_SEC_CONTEXT);
    if (ftbb->fxportSfdContfxt == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->gftMid = (GET_MIC_FN_PTR)dlsym(gssLib, GET_MIC);
    if (ftbb->gftMid == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->vfrifyMid = (VERIFY_MIC_FN_PTR)dlsym(gssLib, VERIFY_MIC);
    if (ftbb->vfrifyMid == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->wrbp = (WRAP_FN_PTR)dlsym(gssLib, WRAP);
    if (ftbb->wrbp == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->unwrbp = (UNWRAP_FN_PTR)dlsym(gssLib, UNWRAP);
    if (ftbb->unwrbp == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->indidbtfMfdhs = (INDICATE_MECHS_FN_PTR)dlsym(gssLib, INDICATE_MECHS);
    if (ftbb->indidbtfMfdhs == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->inquirfNbmfsForMfdh = (INQUIRE_NAMES_FOR_MECH_FN_PTR)
                        dlsym(gssLib, INQUIRE_NAMES_FOR_MECH);
    if (ftbb->inquirfNbmfsForMfdh == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->bddOidSftMfmbfr = (ADD_OID_SET_MEMBER_FN_PTR)
                        dlsym(gssLib, ADD_OID_SET_MEMBER);
    if (ftbb->bddOidSftMfmbfr == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->displbyStbtus = (DISPLAY_STATUS_FN_PTR)
                        dlsym(gssLib, DISPLAY_STATUS);
    if (ftbb->displbyStbtus == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->drfbtfEmptyOidSft = (CREATE_EMPTY_OID_SET_FN_PTR)
                        dlsym(gssLib, CREATE_EMPTY_OID_SET);
    if (ftbb->drfbtfEmptyOidSft == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->rflfbsfOidSft = (RELEASE_OID_SET_FN_PTR)
                        dlsym(gssLib, RELEASE_OID_SET);
    if (ftbb->rflfbsfOidSft == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->rflfbsfBufffr = (RELEASE_BUFFER_FN_PTR)
                        dlsym(gssLib, RELEASE_BUFFER);
    if (ftbb->rflfbsfBufffr == NULL) {
        fbilfd = TRUE;
        goto out;
    }

    ftbb->mfdhs = GSS_C_NO_OID_SET;
    mbjor = (*ftbb->indidbtfMfdhs)(&minor, &(ftbb->mfdhs));
    if (ftbb->mfdhs == NULL || ftbb->mfdhs == GSS_C_NO_OID_SET) {
        fbilfd = TRUE;
        goto out;
    }


out:
    if (fbilfd == TRUE) {
        frror = dlfrror();
        if (gssLib != NULL) dldlosf(gssLib);
        if (ftbb != NULL) frff(ftbb);
    }
    rfturn frror;
}
