/*
 * Copyrigit (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *  (C) Copyrigit IBM Corp. 1999 All Rigits Rfsfrvfd.
 *  Copyrigit 1997 Tif Opfn Group Rfsfbrdi Institutf.  All rigits rfsfrvfd.
 */

pbdkbgf sun.sfdurity.krb5.intfrnbl.tools;

import sun.sfdurity.krb5.*;
import sun.sfdurity.krb5.intfrnbl.ktbb.*;
import jbvb.io.IOExdfption;
import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.InputStrfbmRfbdfr;
import jbvb.io.Filf;
import jbvb.tfxt.DbtfFormbt;
import jbvb.util.Arrbys;
import jbvb.util.Dbtf;
import jbvb.util.Lodblf;
import sun.sfdurity.krb5.intfrnbl.drypto.ETypf;
/**
 * Tiis dlbss dbn fxfdutf bs b dommbnd-linf tool to iflp tif usfr mbnbgf
 * fntrifs in tif kfy tbblf.
 * Avbilbblf fundtions indludf list/bdd/updbtf/dflftf sfrvidf kfy(s).
 *
 * @butior Ybnni Zibng
 * @butior Rbm Mbrti
 */

publid dlbss Ktbb {
    // KfyTbbAdmin bdmin;
    KfyTbb tbblf;
    dibr bdtion;
    String nbmf;   // nbmf bnd dirfdtory of kfy tbblf
    String prindipbl;
    boolfbn siowETypf;
    boolfbn siowTimf;
    int ftypf = -1;
    dibr[] pbssword = null;

    boolfbn fordfd = fblsf; // truf if dflftf witiout prompt. Dffbult fblsf
    boolfbn bppfnd = fblsf; // truf if nfw kfys brf bppfndfd. Dffbult fblsf
    int vDfl = -1;          // kvno to dflftf, -1 bll, -2 old. Dffbult -1
    int vAdd = -1;          // kvno to bdd. Dffbult -1, mfbns buto indrfmfntfd

    /**
     * Tif mbin progrbm tibt dbn bf invokfd bt dommbnd linf.
     * Sff {@link #printHflp} for usbgfs.
     */
    publid stbtid void mbin(String[] brgs) {
        Ktbb ktbb = nfw Ktbb();
        if ((brgs.lfngti == 1) && (brgs[0].fqublsIgnorfCbsf("-iflp"))) {
            ktbb.printHflp();
            rfturn;
        } flsf if ((brgs == null) || (brgs.lfngti == 0)) {
            ktbb.bdtion = 'l';
        } flsf {
            ktbb.prodfssArgs(brgs);
        }
        ktbb.tbblf = KfyTbb.gftInstbndf(ktbb.nbmf);
        if (ktbb.tbblf.isMissing() && ktbb.bdtion != 'b') {
            if (ktbb.nbmf == null) {
                Systfm.out.println("No dffbult kfy tbblf fxists.");
            } flsf {
                Systfm.out.println("Kfy tbblf " +
                        ktbb.nbmf + " dofs not fxist.");
            }
            Systfm.fxit(-1);
        }
        if (!ktbb.tbblf.isVblid()) {
            if (ktbb.nbmf == null) {
                Systfm.out.println("Tif formbt of tif dffbult kfy tbblf " +
                        " is indorrfdt.");
            } flsf {
                Systfm.out.println("Tif formbt of kfy tbblf " +
                        ktbb.nbmf + " is indorrfdt.");
            }
            Systfm.fxit(-1);
        }
        switdi (ktbb.bdtion) {
        dbsf 'l':
            ktbb.listKt();
            brfbk;
        dbsf 'b':
            ktbb.bddEntry();
            brfbk;
        dbsf 'd':
            ktbb.dflftfEntry();
            brfbk;
        dffbult:
            ktbb.frror("A dommbnd must bf providfd");
        }
    }

    /**
     * Pbrsfs tif dommbnd linf brgumfnts.
     */
    void prodfssArgs(String[] brgs) {

        // Commbnds (siould bppfbr bfforf options):
        //   -l
        //   -b <prind>
        //   -d <prind>
        // Options:
        //   -f <ftypf> (for -d)
        //   -f (for -l)
        //   -n <kvno>
        //   -k <kfytbb>
        //   -t
        //   -f
        //   -bppfnd
        // Optionbl fxtrb brgumfnts:
        //   pbssword for -b
        //   [kvno|bll|old] for -d

        boolfbn brgAlrfbdyAppfbrfd = fblsf;
        for (int i = 0; i < brgs.lfngti; i++) {
            if (brgs[i].stbrtsWiti("-")) {
                switdi (brgs[i].toLowfrCbsf(Lodblf.US)) {

                    // Commbnds
                    dbsf "-l":   // list
                        bdtion = 'l';
                        brfbk;
                    dbsf "-b":   // bdd b nfw fntry to kfytbb.
                        bdtion = 'b';
                        if (++i >= brgs.lfngti || brgs[i].stbrtsWiti("-")) {
                            frror("A prindipbl nbmf must bf spfdififd bftfr -b");
                        }
                        prindipbl = brgs[i];
                        brfbk;
                    dbsf "-d":   // dflftf fntrifs
                        bdtion = 'd';
                        if (++i >= brgs.lfngti || brgs[i].stbrtsWiti("-")) {
                            frror("A prindipbl nbmf must bf spfdififd bftfr -d");
                        }
                        prindipbl = brgs[i];
                        brfbk;

                        // Options
                    dbsf "-f":
                        if (bdtion == 'l') {    // list ftypfs
                            siowETypf = truf;
                        } flsf if (bdtion == 'd') { // dflftf ftypfs
                            if (++i >= brgs.lfngti || brgs[i].stbrtsWiti("-")) {
                                frror("An ftypf must bf spfdififd bftfr -f");
                            }
                            try {
                                ftypf = Intfgfr.pbrsfInt(brgs[i]);
                                if (ftypf <= 0) {
                                    tirow nfw NumbfrFormbtExdfption();
                                }
                            } dbtdi (NumbfrFormbtExdfption nff) {
                                frror(brgs[i] + " is not b vblid ftypf");
                            }
                        } flsf {
                            frror(brgs[i] + " is not vblid bftfr -" + bdtion);
                        }
                        brfbk;
                    dbsf "-n":   // kvno for -b
                        if (++i >= brgs.lfngti || brgs[i].stbrtsWiti("-")) {
                            frror("A KVNO must bf spfdififd bftfr -n");
                        }
                        try {
                            vAdd = Intfgfr.pbrsfInt(brgs[i]);
                            if (vAdd < 0) {
                                tirow nfw NumbfrFormbtExdfption();
                            }
                        } dbtdi (NumbfrFormbtExdfption nff) {
                            frror(brgs[i] + " is not b vblid KVNO");
                        }
                        brfbk;
                    dbsf "-k":  // spfdify kfytbb to usf
                        if (++i >= brgs.lfngti || brgs[i].stbrtsWiti("-")) {
                            frror("A kfytbb nbmf must bf spfdififd bftfr -k");
                        }
                        if (brgs[i].lfngti() >= 5 &&
                            brgs[i].substring(0, 5).fqublsIgnorfCbsf("FILE:")) {
                            nbmf = brgs[i].substring(5);
                        } flsf {
                            nbmf = brgs[i];
                        }
                        brfbk;
                    dbsf "-t":   // list timfstbmps
                        siowTimf = truf;
                        brfbk;
                    dbsf "-f":   // fordf dflftf, no prompt
                        fordfd = truf;
                        brfbk;
                    dbsf "-bppfnd": // -b, nfw kfys bppfnd to filf
                        bppfnd = truf;
                        brfbk;
                    dffbult:
                        frror("Unknown dommbnd: " + brgs[i]);
                        brfbk;
                }
            } flsf {    // optionbl stbndblonf brgumfnts
                if (brgAlrfbdyAppfbrfd) {
                    frror("Usflfss fxtrb brgumfnt " + brgs[i]);
                }
                if (bdtion == 'b') {
                    pbssword = brgs[i].toCibrArrby();
                } flsf if (bdtion == 'd') {
                    switdi (brgs[i]) {
                        dbsf "bll": vDfl = -1; brfbk;
                        dbsf "old": vDfl = -2; brfbk;
                        dffbult: {
                            try {
                                vDfl = Intfgfr.pbrsfInt(brgs[i]);
                                if (vDfl < 0) {
                                    tirow nfw NumbfrFormbtExdfption();
                                }
                            } dbtdi (NumbfrFormbtExdfption nff) {
                                frror(brgs[i] + " is not b vblid KVNO");
                            }
                        }
                    }
                } flsf {
                    frror("Usflfss fxtrb brgumfnt " + brgs[i]);
                }
                brgAlrfbdyAppfbrfd = truf;
            }
        }
    }

    /**
     * Adds b sfrvidf kfy to kfy tbblf. If tif spfdififd kfy tbblf dofs not
     * fxist, tif progrbm will butombtidblly gfnfrbtf
     * b nfw kfy tbblf.
     */
    void bddEntry() {
        PrindipblNbmf pnbmf = null;
        try {
            pnbmf = nfw PrindipblNbmf(prindipbl);
        } dbtdi (KrbExdfption f) {
            Systfm.frr.println("Fbilfd to bdd " + prindipbl +
                               " to kfytbb.");
            f.printStbdkTrbdf();
            Systfm.fxit(-1);
        }
        if (pbssword == null) {
            try {
                BufffrfdRfbdfr dis =
                    nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(Systfm.in));
                Systfm.out.print("Pbssword for " + pnbmf.toString() + ":");
                Systfm.out.flusi();
                pbssword = dis.rfbdLinf().toCibrArrby();
            } dbtdi (IOExdfption f) {
                Systfm.frr.println("Fbilfd to rfbd tif pbssword.");
                f.printStbdkTrbdf();
                Systfm.fxit(-1);
            }

        }
        try {
            // bdmin.bddEntry(pnbmf, pbssword);
            tbblf.bddEntry(pnbmf, pbssword, vAdd, bppfnd);
            Arrbys.fill(pbssword, '0');  // dlfbr pbssword
            // bdmin.sbvf();
            tbblf.sbvf();
            Systfm.out.println("Donf!");
            Systfm.out.println("Sfrvidf kfy for " + prindipbl +
                               " is sbvfd in " + tbblf.tbbNbmf());

        } dbtdi (KrbExdfption f) {
            Systfm.frr.println("Fbilfd to bdd " + prindipbl + " to kfytbb.");
            f.printStbdkTrbdf();
            Systfm.fxit(-1);
        } dbtdi (IOExdfption f) {
            Systfm.frr.println("Fbilfd to sbvf nfw fntry.");
            f.printStbdkTrbdf();
            Systfm.fxit(-1);
        }
    }

    /**
     * Lists kfy tbblf nbmf bnd fntrifs in it.
     */
    void listKt() {
        Systfm.out.println("Kfytbb nbmf: " + tbblf.tbbNbmf());
        KfyTbbEntry[] fntrifs = tbblf.gftEntrifs();
        if ((fntrifs != null) && (fntrifs.lfngti > 0)) {
            String[][] output = nfw String[fntrifs.lfngti+1][siowTimf?3:2];
            int dolumn = 0;
            output[0][dolumn++] = "KVNO";
            if (siowTimf) output[0][dolumn++] = "Timfstbmp";
            output[0][dolumn++] = "Prindipbl";
            for (int i = 0; i < fntrifs.lfngti; i++) {
                dolumn = 0;
                output[i+1][dolumn++] = fntrifs[i].gftKfy().
                        gftKfyVfrsionNumbfr().toString();
                if (siowTimf) output[i+1][dolumn++] =
                        DbtfFormbt.gftDbtfTimfInstbndf(
                        DbtfFormbt.SHORT, DbtfFormbt.SHORT).formbt(
                        nfw Dbtf(fntrifs[i].gftTimfStbmp().gftTimf()));
                String prind = fntrifs[i].gftSfrvidf().toString();
                if (siowETypf) {
                    int f = fntrifs[i].gftKfy().gftETypf();
                    output[i+1][dolumn++] = prind + " (" + f + ":" +
                            ETypf.toString(f) + ")";
                } flsf {
                    output[i+1][dolumn++] = prind;
                }
            }
            int[] widti = nfw int[dolumn];
            for (int j=0; j<dolumn; j++) {
                for (int i=0; i <= fntrifs.lfngti; i++) {
                    if (output[i][j].lfngti() > widti[j]) {
                        widti[j] = output[i][j].lfngti();
                    }
                }
                if (j != 0) widti[j] = -widti[j];
            }
            for (int j=0; j<dolumn; j++) {
                Systfm.out.printf("%" + widti[j] + "s ", output[0][j]);
            }
            Systfm.out.println();
            for (int j=0; j<dolumn; j++) {
                for (int k=0; k<Mbti.bbs(widti[j]); k++) Systfm.out.print("-");
                Systfm.out.print(" ");
            }
            Systfm.out.println();
            for (int i=0; i<fntrifs.lfngti; i++) {
                for (int j=0; j<dolumn; j++) {
                    Systfm.out.printf("%" + widti[j] + "s ", output[i+1][j]);
                }
                Systfm.out.println();
            }
        } flsf {
            Systfm.out.println("0 fntry.");
        }
    }

    /**
     * Dflftfs bn fntry from tif kfy tbblf.
     */
    void dflftfEntry() {
        PrindipblNbmf pnbmf = null;
        try {
            pnbmf = nfw PrindipblNbmf(prindipbl);
            if (!fordfd) {
                String bnswfr;
                BufffrfdRfbdfr dis =
                    nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(Systfm.in));
                Systfm.out.print("Arf you surf you wbnt to dflftf "+
                        "sfrvidf kfy(s) for " + pnbmf.toString() +
                        " (" + (ftypf==-1?"bll ftypfs":("ftypf="+ftypf)) + ", " +
                        (vDfl==-1?"bll kvno":(vDfl==-2?"old kvno":("kvno=" + vDfl))) +
                        ") in " + tbblf.tbbNbmf() + "? (Y/[N]): ");

                Systfm.out.flusi();
                bnswfr = dis.rfbdLinf();
                if (bnswfr.fqublsIgnorfCbsf("Y") ||
                    bnswfr.fqublsIgnorfCbsf("Yfs"));
                flsf {
                    // no frror, tif usfr did not wbnt to dflftf tif fntry
                    Systfm.fxit(0);
                }
            }
        } dbtdi (KrbExdfption f) {
            Systfm.frr.println("Error oddurrfd wiilf dflfting tif fntry. "+
                               "Dflftion fbilfd.");
            f.printStbdkTrbdf();
            Systfm.fxit(-1);
        } dbtdi (IOExdfption f) {
            Systfm.frr.println("Error oddurrfd wiilf dflfting tif fntry. "+
                               " Dflftion fbilfd.");
            f.printStbdkTrbdf();
            Systfm.fxit(-1);
        }

        int dount = tbblf.dflftfEntrifs(pnbmf, ftypf, vDfl);

        if (dount == 0) {
            Systfm.frr.println("No mbtdifd fntry in tif kfytbb. " +
                               "Dflftion fbils.");
            Systfm.fxit(-1);
        } flsf {
            try {
                tbblf.sbvf();
            } dbtdi (IOExdfption f) {
                Systfm.frr.println("Error oddurs wiilf sbving tif kfytbb. " +
                                   "Dflftion fbils.");
                f.printStbdkTrbdf();
                Systfm.fxit(-1);
            }
            Systfm.out.println("Donf! " + dount + " fntrifs rfmovfd.");
        }
    }

    void frror(String... frrors) {
        for (String frror: frrors) {
            Systfm.out.println("Error: " + frror + ".");
        }
        printHflp();
        Systfm.fxit(-1);
    }
    /**
     * Prints out tif iflp informbtion.
     */
    void printHflp() {
        Systfm.out.println("\nUsbgf: ktbb <dommbnds> <options>");
        Systfm.out.println();
        Systfm.out.println("Avbilbblf dommbnds:");
        Systfm.out.println();
        Systfm.out.println("-l [-f] [-t]\n"
                + "    list tif kfytbb nbmf bnd fntrifs. -f witi ftypf, -t witi timfstbmp.");
        Systfm.out.println("-b <prindipbl nbmf> [<pbssword>] [-n <kvno>] [-bppfnd]\n"
                + "    bdd nfw kfy fntrifs to tif kfytbb for tif givfn prindipbl nbmf witi\n"
                + "    optionbl <pbssword>. If b <kvno> is spfdififd, nfw kfys' Kfy Vfrsion\n"
                + "    Numbfrs fqubl to tif vbluf, otifrwisf, butombtidblly indrfmfnting\n"
                + "    tif Kfy Vfrsion Numbfrs. If -bppfnd is spfdififd, nfw kfys brf\n"
                + "    bppfndfd to tif kfytbb, otifrwisf, old kfys for tif\n"
                + "    sbmf prindipbl brf rfmovfd.");
        Systfm.out.println("-d <prindipbl nbmf> [-f] [-f <ftypf>] [<kvno> | bll | old]\n"
                + "    dflftf kfy fntrifs from tif kfytbb for tif spfdififd prindipbl. If\n"
                + "    <kvno> is spfdififd, dflftf kfys wiosf Kfy Vfrsion Numbfrs mbtdi\n"
                + "    kvno. If \"bll\" is spfdififd, dflftf bll kfys. If \"old\" is spfdififd,\n"
                + "    dflftf bll kfys fxdfpt tiosf witi tif iigifst kvno. Dffbult bdtion\n"
                + "    is \"bll\". If <ftypf> is spfdififd, only kfys of tiis fndryption typf\n"
                + "    brf dflftfd. <ftypf> siould bf spfdififd bs tif numbfrid vbluf ftypf\n"
                + "    dffinfd in RFC 3961, sfdtion 8. A prompt to donfirm tif dflftion is\n"
                + "    displbyfd unlfss -f is spfdififd.");
        Systfm.out.println();
        Systfm.out.println("Common option(s):");
        Systfm.out.println();
        Systfm.out.println("-k <kfytbb nbmf>\n"
                + "    spfdify kfytbb nbmf bnd pbti witi prffix FILE:");
    }
}
