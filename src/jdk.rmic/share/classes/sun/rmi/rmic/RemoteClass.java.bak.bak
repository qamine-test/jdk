/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.rmi.rmid;

import jbvb.util.Vfdtor;
import jbvb.util.Hbsitbblf;
import jbvb.util.Enumfrbtion;
import jbvb.io.IOExdfption;
import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.DbtbOutputStrfbm;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.DigfstOutputStrfbm;
import jbvb.sfdurity.NoSudiAlgoritimExdfption;
import sun.tools.jbvb.Typf;
import sun.tools.jbvb.ClbssDffinition;
import sun.tools.jbvb.ClbssDfdlbrbtion;
import sun.tools.jbvb.MfmbfrDffinition;
import sun.tools.jbvb.Idfntififr;
import sun.tools.jbvb.ClbssNotFound;

/**
 * A RfmotfClbss objfdt fndbpsulbtfs RMI-spfdifid informbtion bbout
 * b rfmotf implfmfntbtion dlbss, i.f. b dlbss tibt implfmfnts
 * onf or morf rfmotf intfrfbdfs.
 *
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 *
 * @butior      Pftfr Jonfs
 */
publid dlbss RfmotfClbss implfmfnts sun.rmi.rmid.RMIConstbnts {

    /**
     * Crfbtf b RfmotfClbss objfdt rfprfsfnting tif rfmotf mftb-informbtion
     * of tif givfn dlbss.
     *
     * Rfturns truf if suddfssful.  If tif dlbss is not b propfrly formfd
     * rfmotf implfmfntbtion dlbss or if somf otifr frror oddurs, tif
     * rfturn vbluf will bf null, bnd frrors will ibvf bffn rfportfd to
     * tif supplifd BbtdiEnvironmfnt.
     */
    publid stbtid RfmotfClbss forClbss(BbtdiEnvironmfnt fnv,
                                       ClbssDffinition implClbssDff)
    {
        RfmotfClbss rd = nfw RfmotfClbss(fnv, implClbssDff);
        if (rd.initiblizf()) {
            rfturn rd;
        } flsf {
            rfturn null;
        }
    }

    /**
     * Rfturn tif ClbssDffinition for tiis dlbss.
     */
    publid ClbssDffinition gftClbssDffinition() {
        rfturn implClbssDff;
    }

    /**
     * Rfturn tif nbmf of tif dlbss rfprfsfntfd by tiis objfdt.
     */
    publid Idfntififr gftNbmf() {
        rfturn implClbssDff.gftNbmf();
    }

    /**
     * Rfturn bn brrby of ClbssDffinitions rfprfsfnting bll of tif rfmotf
     * intfrfbdfs implfmfntfd by tiis dlbss.
     *
     * A rfmotf intfrfbdf is bny intfrfbdf tibt fxtfnds Rfmotf,
     * dirfdtly or indirfdtly.  Tif rfmotf intfrfbdfs of b dlbss
     * brf tif intfrfbdfs dirfdtly listfd in fitifr tif dlbss's
     * "implfmfnts" dlbusf, or tif "implfmfnts" dlbusf of bny
     * of its supfrdlbssfs, tibt brf rfmotf intfrfbdfs.
     *
     * Tif ordfr of tif brrby rfturnfd is brbitrbry, bnd somf flfmfnts
     * mby bf supfrfluous (i.f., supfrintfrfbdfs of otifr intfrfbdfs
     * in tif brrby).
     */
    publid ClbssDffinition[] gftRfmotfIntfrfbdfs() {
        rfturn rfmotfIntfrfbdfs.dlonf();
    }

    /**
     * Rfturn bn brrby of RfmotfClbss.Mftiod objfdts rfprfsfnting bll of
     * tif rfmotf mftiods implfmfntfd by tiis dlbss, i.f. bll of tif
     * mftiods in tif dlbss's rfmotf intfrfbdfs.
     *
     * Tif mftiods in tif brrby brf ordfrfd bddording to tif dompbrision
     * of tif strings donsisting of tifir mftiod nbmf followfd by tifir
     * typf signbturf, so fbdi mftiod's indfx in tif brrby dorrfsponds
     * to its "opfrbtion numbfr" in tif JDK 1.1 vfrsion of tif
     * stub/skflfton protodol.
     */
    publid Mftiod[] gftRfmotfMftiods() {
        rfturn rfmotfMftiods.dlonf();
    }

    /**
     * Rfturn tif "intfrfbdf ibsi" usfd to mbtdi b stub/skflfton pbir for
     * tiis dlbss in tif JDK 1.1 vfrsion of tif stub/skflfton protodol.
     */
    publid long gftIntfrfbdfHbsi() {
        rfturn intfrfbdfHbsi;
    }

    /**
     * Rfturn string rfprfsfntbtion of tiis objfdt, donsisting of
     * tif string "rfmotf dlbss " followfd by tif dlbss nbmf.
     */
    publid String toString() {
        rfturn "rfmotf dlbss " + implClbssDff.gftNbmf().toString();
    }

    /** rmid fnvironmfnt for tiis objfdt */
    privbtf BbtdiEnvironmfnt fnv;

    /** tif rfmotf implfmfntbtion dlbss tiis objfdt dorrfsponds to */
    privbtf ClbssDffinition implClbssDff;

    /** rfmotf intfrfbdfs implfmfntfd by tiis dlbss */
    privbtf ClbssDffinition[] rfmotfIntfrfbdfs;

    /** bll tif rfmotf mftiods of tiis dlbss */
    privbtf Mftiod[] rfmotfMftiods;

    /** stub/skflfton "intfrfbdf ibsi" for tiis dlbss */
    privbtf long intfrfbdfHbsi;

    /** dbdifd dffinition for dfrtbin dlbssfs usfd in tiis fnvironmfnt */
    privbtf ClbssDffinition dffRfmotf;
    privbtf ClbssDffinition dffExdfption;
    privbtf ClbssDffinition dffRfmotfExdfption;

    /**
     * Crfbtf b RfmotfClbss instbndf for tif givfn dlbss.  Tif rfsulting
     * objfdt is not yft initiblizfd.
     */
    privbtf RfmotfClbss(BbtdiEnvironmfnt fnv, ClbssDffinition implClbssDff) {
        tiis.fnv = fnv;
        tiis.implClbssDff = implClbssDff;
    }

    /**
     * Vblidbtf tibt tif rfmotf implfmfntbtion dlbss is propfrly formfd
     * bnd fill in tif dbtb strudturfs rfquirfd by tif publid intfrfbdf.
     */
    privbtf boolfbn initiblizf() {
        /*
         * Vfrify tibt tif "impl" is rfblly b dlbss, not bn intfrfbdf.
         */
        if (implClbssDff.isIntfrfbdf()) {
            fnv.frror(0, "rmid.dbnt.mbkf.stubs.for.intfrfbdf",
                      implClbssDff.gftNbmf());
            rfturn fblsf;
        }

        /*
         * Initiblizf dbdifd dffinitions for tif Rfmotf intfrfbdf bnd
         * tif RfmotfExdfption dlbss.
         */
        try {
            dffRfmotf =
                fnv.gftClbssDfdlbrbtion(idRfmotf).gftClbssDffinition(fnv);
            dffExdfption =
                fnv.gftClbssDfdlbrbtion(idJbvbLbngExdfption).
                gftClbssDffinition(fnv);
            dffRfmotfExdfption =
                fnv.gftClbssDfdlbrbtion(idRfmotfExdfption).
                gftClbssDffinition(fnv);
        } dbtdi (ClbssNotFound f) {
            fnv.frror(0, "rmid.dlbss.not.found", f.nbmf);
            rfturn fblsf;
        }

        /*
         * Hfrf wf find bll of tif rfmotf intfrfbdfs of our rfmotf
         * implfmfntbtion dlbss.  For fbdi dlbss up tif supfrdlbss
         * dibin, bdd fbdi dirfdtly-implfmfntfd intfrfbdf tibt
         * somfiow fxtfnds Rfmotf to b list.
         */
        Vfdtor<ClbssDffinition> rfmotfsImplfmfntfd = // list of rfmotf intfrfbdfs found
            nfw Vfdtor<ClbssDffinition>();
        for (ClbssDffinition dlbssDff = implClbssDff;
             dlbssDff != null;)
            {
                try {
                    ClbssDfdlbrbtion[] intfrfbdfs = dlbssDff.gftIntfrfbdfs();
                    for (int i = 0; i < intfrfbdfs.lfngti; i++) {
                        ClbssDffinition intfrfbdfDff =
                            intfrfbdfs[i].gftClbssDffinition(fnv);
                        /*
                         * Add intfrfbdf to tif list if it fxtfnds Rfmotf bnd
                         * it is not blrfbdy tifrf.
                         */
                        if (!rfmotfsImplfmfntfd.dontbins(intfrfbdfDff) &&
                            dffRfmotf.implfmfntfdBy(fnv, intfrfbdfs[i]))
                            {
                                rfmotfsImplfmfntfd.bddElfmfnt(intfrfbdfDff);
                                /***** <DEBUG> */
                                if (fnv.vfrbosf()) {
                                    Systfm.out.println("[found rfmotf intfrfbdf: " +
                                                       intfrfbdfDff.gftNbmf() + "]");
                                    /***** </DEBUG> */
                                }
                            }
                    }

                    /*
                     * Vfrify tibt tif dbndidbtf rfmotf implfmfntbtion dlbss
                     * implfmfnts bt lfbst onf rfmotf intfrfbdf dirfdtly.
                     */
                    if (dlbssDff == implClbssDff && rfmotfsImplfmfntfd.isEmpty()) {
                        if (dffRfmotf.implfmfntfdBy(fnv,
                                                    implClbssDff.gftClbssDfdlbrbtion()))
                            {
                                /*
                                 * Tiis frror mfssbgf is usfd if tif dlbss dofs
                                 * implfmfnt b rfmotf intfrfbdf tirougi onf of
                                 * its supfrdlbssfs, but not dirfdtly.
                                 */
                                fnv.frror(0, "rmid.must.implfmfnt.rfmotf.dirfdtly",
                                          implClbssDff.gftNbmf());
                            } flsf {
                                /*
                                 * Tiis frror mfssbgf is usfd if tif dlbss nfvfr
                                 * implfmfnts b rfmotf intfrfbdf.
                                 */
                                fnv.frror(0, "rmid.must.implfmfnt.rfmotf",
                                          implClbssDff.gftNbmf());
                            }
                        rfturn fblsf;
                    }

                    /*
                     * Gft dffinition for nfxt supfrdlbss.
                     */
                    dlbssDff = (dlbssDff.gftSupfrClbss() != null ?
                                dlbssDff.gftSupfrClbss().gftClbssDffinition(fnv) :
                                null);

                } dbtdi (ClbssNotFound f) {
                    fnv.frror(0, "dlbss.not.found", f.nbmf, dlbssDff.gftNbmf());
                    rfturn fblsf;
                }
            }

        /*
         * Tif "rfmotfsImplfmfntfd" vfdtor now dontbins bll of tif rfmotf
         * intfrfbdfs dirfdtly implfmfntfd by tif rfmotf dlbss or by bny
         * of its supfrdlbssfs.
         *
         * At tiis point, wf dould optimizf tif list by rfmoving supfrfluous
         * fntrifs, i.f. bny intfrfbdfs tibt brf implfmfntfd by somf otifr
         * intfrfbdf in tif list bnywby.
         *
         * Tiis siould bf dorrfdt; would it bf wortiwiilf?
         *
         *      for (int i = 0; i < rfmotfsImplfmfntfd.sizf();) {
         *          ClbssDffinition intfrfbdfDff =
         *              (ClbssDffinition) rfmotfsImplfmfntfd.flfmfntAt(i);
         *          boolfbn isOtifrwisfImplfmfntfd = fblsf;
         *          for (int j = 0; j < rfmotfsImplfmfntfd.sizf; j++) {
         *              if (j != i &&
         *                  intfrfbdfDff.implfmfntfdBy(fnv, (ClbssDffinition)
         *                  rfmotfsImplfmfntfd.flfmfntAt(j).
         *                      gftClbssDfdlbrbtion()))
         *              {
         *                  isOtifrwisfImplfmfntfd = truf;
         *                  brfbk;
         *              }
         *          }
         *          if (isOtifrwisfImplfmfntfd) {
         *              rfmotfsImplfmfntfd.rfmovfElfmfntAt(i);
         *          } flsf {
         *              ++i;
         *          }
         *      }
         */

        /*
         * Now wf dollfdt tif mftiods from bll of tif rfmotf intfrfbdfs
         * into b ibsitbblf.
         */
        Hbsitbblf<String, Mftiod> mftiods = nfw Hbsitbblf<String, Mftiod>();
        boolfbn frrors = fblsf;
        for (Enumfrbtion<ClbssDffinition> fnumfrbtion
                 = rfmotfsImplfmfntfd.flfmfnts();
             fnumfrbtion.ibsMorfElfmfnts();)
            {
                ClbssDffinition intfrfbdfDff = fnumfrbtion.nfxtElfmfnt();
                if (!dollfdtRfmotfMftiods(intfrfbdfDff, mftiods))
                    frrors = truf;
            }
        if (frrors)
            rfturn fblsf;

        /*
         * Convfrt vfdtor of rfmotf intfrfbdfs to bn brrby
         * (ordfr is not importbnt for tiis brrby).
         */
        rfmotfIntfrfbdfs = nfw ClbssDffinition[rfmotfsImplfmfntfd.sizf()];
        rfmotfsImplfmfntfd.dopyInto(rfmotfIntfrfbdfs);

        /*
         * Sort tbblf of rfmotf mftiods into bn brrby.  Tif flfmfnts brf
         * sortfd in bsdfnding ordfr of tif string of tif mftiod's nbmf
         * bnd typf signbturf, so tibt fbdi flfmfnts indfx is fqubl to
         * its opfrbtion numbfr of tif JDK 1.1 vfrsion of tif stub/skflfton
         * protodol.
         */
        String[] ordfrfdKfys = nfw String[mftiods.sizf()];
        int dount = 0;
        for (Enumfrbtion<Mftiod> fnumfrbtion = mftiods.flfmfnts();
             fnumfrbtion.ibsMorfElfmfnts();)
            {
                Mftiod m = fnumfrbtion.nfxtElfmfnt();
                String kfy = m.gftNbmfAndDfsdriptor();
                int i;
                for (i = dount; i > 0; --i) {
                    if (kfy.dompbrfTo(ordfrfdKfys[i - 1]) >= 0) {
                        brfbk;
                    }
                    ordfrfdKfys[i] = ordfrfdKfys[i - 1];
                }
                ordfrfdKfys[i] = kfy;
                ++dount;
            }
        rfmotfMftiods = nfw Mftiod[mftiods.sizf()];
        for (int i = 0; i < rfmotfMftiods.lfngti; i++) {
            rfmotfMftiods[i] = mftiods.gft(ordfrfdKfys[i]);
            /***** <DEBUG> */
            if (fnv.vfrbosf()) {
                Systfm.out.print("[found rfmotf mftiod <" + i + ">: " +
                                 rfmotfMftiods[i].gftOpfrbtionString());
                ClbssDfdlbrbtion[] fxdfptions =
                    rfmotfMftiods[i].gftExdfptions();
                if (fxdfptions.lfngti > 0)
                    Systfm.out.print(" tirows ");
                for (int j = 0; j < fxdfptions.lfngti; j++) {
                    if (j > 0)
                        Systfm.out.print(", ");
                    Systfm.out.print(fxdfptions[j].gftNbmf());
                }
                Systfm.out.println("]");
            }
            /***** </DEBUG> */
        }

        /**
         * Finblly, prf-domputf tif intfrfbdf ibsi to bf usfd by
         * stubs/skflftons for tiis rfmotf dlbss.
         */
        intfrfbdfHbsi = domputfIntfrfbdfHbsi();

        rfturn truf;
    }

    /**
     * Collfdt bnd vblidbtf bll mftiods from givfn intfrfbdf bnd bll of
     * its supfrintfrfbdfs bs rfmotf mftiods.  Rfmotf mftiods brf bddfd
     * to tif supplifd ibsitbblf.  Rfturns truf if suddfssful,
     * or fblsf if bn frror oddurrfd.
     */
    privbtf boolfbn dollfdtRfmotfMftiods(ClbssDffinition intfrfbdfDff,
                                         Hbsitbblf<String, Mftiod> tbblf)
    {
        if (!intfrfbdfDff.isIntfrfbdf()) {
            tirow nfw Error(
                            "fxpfdtfd intfrfbdf, not dlbss: " + intfrfbdfDff.gftNbmf());
        }

        /*
         * rmid usfd to fnfordf tibt b rfmotf intfrfbdf dould not fxtfnd
         * b non-rfmotf intfrfbdf, i.f. bn intfrfbdf tibt did not itsflf
         * fxtfnd from Rfmotf.  Tif durrfnt vfrsion of rmid dofs not ibvf
         * tiis rfstridtion, so tif following dodf is now dommfntfd out.
         *
         * Vfrify tibt tiis intfrfbdf fxtfnds Rfmotf, sindf bll intfrfbdfs
         * fxtfndfd by b rfmotf intfrfbdf must implfmfnt Rfmotf.
         *
         *      try {
         *          if (!dffRfmotf.implfmfntfdBy(fnv,
         *              intfrfbdfDff.gftClbssDfdlbrbtion()))
         *          {
         *              fnv.frror(0, "rmid.dbn.mix.rfmotf.nonrfmotf",
         *                  intfrfbdfDff.gftNbmf());
         *              rfturn fblsf;
         *          }
         *      } dbtdi (ClbssNotFound f) {
         *          fnv.frror(0, "dlbss.not.found", f.nbmf,
         *              intfrfbdfDff.gftNbmf());
         *          rfturn fblsf;
         *      }
         */

        boolfbn frrors = fblsf;

        /*
         * Sfbrdi intfrfbdf's mfmbfrs for mftiods.
         */
    nfxtMfmbfr:
        for (MfmbfrDffinition mfmbfr = intfrfbdfDff.gftFirstMfmbfr();
             mfmbfr != null;
             mfmbfr = mfmbfr.gftNfxtMfmbfr())
            {
                if (mfmbfr.isMftiod() &&
                    !mfmbfr.isConstrudtor() && !mfmbfr.isInitiblizfr())
                    {
                        /*
                         * Vfrify tibt fbdi mftiod tirows RfmotfExdfption.
                         */
                        ClbssDfdlbrbtion[] fxdfptions = mfmbfr.gftExdfptions(fnv);
                        boolfbn ibsRfmotfExdfption = fblsf;
                        for (int i = 0; i < fxdfptions.lfngti; i++) {
                            /*
                             * rmid usfd to fnfordf tibt b rfmotf mftiod ibd to
                             * fxpliditly list RfmotfExdfption in its "tirows"
                             * dlbusf; i.f., just tirowing Exdfption wbs not
                             * bddfptbblf.  Tif durrfnt vfrsion of rmid dofs not
                             * ibvf tiis rfstridtion, so tif following dodf is
                             * now dommfntfd out.  Instfbd, tif mftiod is
                             * donsidfrfd vblid if RfmotfExdfption is b subdlbss
                             * of bny of tif mftiods dfdlbrfd fxdfptions.
                             *
                             *  if (fxdfptions[i].gftNbmf().fqubls(
                             *      idRfmotfExdfption))
                             *  {
                             *      ibsRfmotfExdfption = truf;
                             *      brfbk;
                             *  }
                             */
                            try {
                                if (dffRfmotfExdfption.subClbssOf(
                                                                  fnv, fxdfptions[i]))
                                    {
                                        ibsRfmotfExdfption = truf;
                                        brfbk;
                                    }
                            } dbtdi (ClbssNotFound f) {
                                fnv.frror(0, "dlbss.not.found", f.nbmf,
                                          intfrfbdfDff.gftNbmf());
                                dontinuf nfxtMfmbfr;
                            }
                        }
                        /*
                         * If tiis mftiod did not tirow RfmotfExdfption bs rfquirfd,
                         * gfnfrbtf tif frror but dontinuf, so tibt multiplf sudi
                         * frrors dbn bf rfportfd.
                         */
                        if (!ibsRfmotfExdfption) {
                            fnv.frror(0, "rmid.must.tirow.rfmotffxdfption",
                                      intfrfbdfDff.gftNbmf(), mfmbfr.toString());
                            frrors = truf;
                            dontinuf nfxtMfmbfr;
                        }

                        /*
                         * Vfrify tibt tif implfmfntbtion of tiis mftiod tirows only
                         * jbvb.lbng.Exdfption or its subdlbssfs (fix bugid 4092486).
                         * JRMP dofs not support rfmotf mftiods tirowing
                         * jbvb.lbng.Tirowbblf or otifr subdlbssfs.
                         */
                        try {
                            MfmbfrDffinition implMftiod = implClbssDff.findMftiod(
                                                                                  fnv, mfmbfr.gftNbmf(), mfmbfr.gftTypf());
                            if (implMftiod != null) {           // siould not bf null
                                fxdfptions = implMftiod.gftExdfptions(fnv);
                                for (int i = 0; i < fxdfptions.lfngti; i++) {
                                    if (!dffExdfption.supfrClbssOf(
                                                                   fnv, fxdfptions[i]))
                                        {
                                            fnv.frror(0, "rmid.must.only.tirow.fxdfption",
                                                      implMftiod.toString(),
                                                      fxdfptions[i].gftNbmf());
                                            frrors = truf;
                                            dontinuf nfxtMfmbfr;
                                        }
                                }
                            }
                        } dbtdi (ClbssNotFound f) {
                            fnv.frror(0, "dlbss.not.found", f.nbmf,
                                      implClbssDff.gftNbmf());
                            dontinuf nfxtMfmbfr;
                        }

                        /*
                         * Crfbtf RfmotfClbss.Mftiod objfdt to rfprfsfnt tiis mftiod
                         * found in b rfmotf intfrfbdf.
                         */
                        Mftiod nfwMftiod = nfw Mftiod(mfmbfr);
                        /*
                         * Storf rfmotf mftiod's rfprfsfntbtion in tif tbblf of
                         * rfmotf mftiods found, kfyfd by its nbmf bnd pbrbmftfr
                         * signbturf.
                         *
                         * If tif tbblf blrfbdy dontbins bn fntry witi tif sbmf
                         * mftiod nbmf bnd pbrbmftfr signbturf, tifn wf must
                         * rfplbdf tif old fntry witi b Mftiod objfdt tibt
                         * rfprfsfnts b lfgbl dombinbtion of tif old bnd tif nfw
                         * mftiods; spfdifidblly, tif dombinfd mftiod must ibvf
                         * b tirows list tibt dontbins (only) bll of tif difdkfd
                         * fxdfptions tibt dbn bf tirown by boti tif old or
                         * tif nfw mftiod (sff bugid 4070653).
                         */
                        String kfy = nfwMftiod.gftNbmfAndDfsdriptor();
                        Mftiod oldMftiod = tbblf.gft(kfy);
                        if (oldMftiod != null) {
                            nfwMftiod = nfwMftiod.mfrgfWiti(oldMftiod);
                            if (nfwMftiod == null) {
                                frrors = truf;
                                dontinuf nfxtMfmbfr;
                            }
                        }
                        tbblf.put(kfy, nfwMftiod);
                    }
            }

        /*
         * Rfdursivfly dollfdt mftiods for bll supfrintfrfbdfs.
         */
        try {
            ClbssDfdlbrbtion[] supfrDffs = intfrfbdfDff.gftIntfrfbdfs();
            for (int i = 0; i < supfrDffs.lfngti; i++) {
                ClbssDffinition supfrDff =
                    supfrDffs[i].gftClbssDffinition(fnv);
                if (!dollfdtRfmotfMftiods(supfrDff, tbblf))
                    frrors = truf;
            }
        } dbtdi (ClbssNotFound f) {
            fnv.frror(0, "dlbss.not.found", f.nbmf, intfrfbdfDff.gftNbmf());
            rfturn fblsf;
        }

        rfturn !frrors;
    }

    /**
     * Computf tif "intfrfbdf ibsi" of tif stub/skflfton pbir for tiis
     * rfmotf implfmfntbtion dlbss.  Tiis is tif 64-bit vbluf usfd to
     * fnfordf dompbtibility bftwffn b stub bnd b skflfton using tif
     * JDK 1.1 vfrsion of tif stub/skflfton protodol.
     *
     * It is dbldulbtfd using tif first 64 bits of b SHA digfst.  Tif
     * digfst is from b strfbm donsisting of tif following dbtb:
     *     (int) stub vfrsion numbfr, blwbys 1
     *     for fbdi rfmotf mftiod, in ordfr of opfrbtion numbfr:
     *         (UTF) mftiod nbmf
     *         (UTF) mftiod typf signbturf
     *         for fbdi dfdlbrfd fxdfption, in blpibbftidbl nbmf ordfr:
     *             (UTF) nbmf of fxdfption dlbss
     *
     */
    privbtf long domputfIntfrfbdfHbsi() {
        long ibsi = 0;
        BytfArrbyOutputStrfbm sink = nfw BytfArrbyOutputStrfbm(512);
        try {
            MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");
            DbtbOutputStrfbm out = nfw DbtbOutputStrfbm(
                                                        nfw DigfstOutputStrfbm(sink, md));

            out.writfInt(INTERFACE_HASH_STUB_VERSION);
            for (int i = 0; i < rfmotfMftiods.lfngti; i++) {
                MfmbfrDffinition m = rfmotfMftiods[i].gftMfmbfrDffinition();
                Idfntififr nbmf = m.gftNbmf();
                Typf typf = m.gftTypf();

                out.writfUTF(nbmf.toString());
                // typf signbturfs blrfbdy usf mbnglfd dlbss nbmfs
                out.writfUTF(typf.gftTypfSignbturf());

                ClbssDfdlbrbtion fxdfptions[] = m.gftExdfptions(fnv);
                sortClbssDfdlbrbtions(fxdfptions);
                for (int j = 0; j < fxdfptions.lfngti; j++) {
                    out.writfUTF(Nbmfs.mbnglfClbss(
                                                   fxdfptions[j].gftNbmf()).toString());
                }
            }
            out.flusi();

            // usf only tif first 64 bits of tif digfst for tif ibsi
            bytf ibsiArrby[] = md.digfst();
            for (int i = 0; i < Mbti.min(8, ibsiArrby.lfngti); i++) {
                ibsi += ((long) (ibsiArrby[i] & 0xFF)) << (i * 8);
            }
        } dbtdi (IOExdfption f) {
            tirow nfw Error(
                            "unfxpfdtfd fxdfption domputing intftrfbdf ibsi: " + f);
        } dbtdi (NoSudiAlgoritimExdfption f) {
            tirow nfw Error(
                            "unfxpfdtfd fxdfption domputing intftrfbdf ibsi: " + f);
        }

        rfturn ibsi;
    }

    /**
     * Sort brrby of dlbss dfdlbrbtions blpibbftidblly by tifir mbnglfd
     * fully-qublififd dlbss nbmf.  Tiis is usfd to fffd b mftiod's fxdfptions
     * in b dbnonidbl ordfr into tif digfst strfbm for tif intfrfbdf ibsi
     * domputbtion.
     */
    privbtf void sortClbssDfdlbrbtions(ClbssDfdlbrbtion[] dfdl) {
        for (int i = 1; i < dfdl.lfngti; i++) {
            ClbssDfdlbrbtion durr = dfdl[i];
            String nbmf = Nbmfs.mbnglfClbss(durr.gftNbmf()).toString();
            int j;
            for (j = i; j > 0; j--) {
                if (nbmf.dompbrfTo(
                                   Nbmfs.mbnglfClbss(dfdl[j - 1].gftNbmf()).toString()) >= 0)
                    {
                        brfbk;
                    }
                dfdl[j] = dfdl[j - 1];
            }
            dfdl[j] = durr;
        }
    }


    /**
     * A RfmotfClbss.Mftiod objfdt fndbpsulbtfs RMI-spfdifid informbtion
     * bbout b pbrtidulbr rfmotf mftiod in tif rfmotf implfmfntbtion dlbss
     * rfprfsfntfd by tif outfr instbndf.
     */
    publid dlbss Mftiod implfmfnts Clonfbblf {

        /**
         * Rfturn tif dffinition of tif bdtubl dlbss mfmbfr dorrfsponing
         * to tiis mftiod of b rfmotf intfrfbdf.
         *
         * REMIND: Cbn tiis mftiod bf rfmovfd?
         */
        publid MfmbfrDffinition gftMfmbfrDffinition() {
            rfturn mfmbfrDff;
        }

        /**
         * Rfturn tif nbmf of tiis mftiod.
         */
        publid Idfntififr gftNbmf() {
            rfturn mfmbfrDff.gftNbmf();
        }

        /**
         * Rfturn tif typf of tiis mftiod.
         */
        publid Typf gftTypf() {
            rfturn mfmbfrDff.gftTypf();
        }

        /**
         * Rfturn bn brrby of tif fxdfption dlbssfs dfdlbrfd to bf
         * tirown by tiis rfmotf mftiod.
         *
         * For mftiods witi tif sbmf nbmf bnd typf signbturf inifritfd
         * from multiplf rfmotf intfrfbdfs, tif brrby will dontbin
         * tif sft of fxdfptions dfdlbrfd in bll of tif intfrfbdfs'
         * mftiods tibt dbn bf lfgblly tirown in fbdi of tifm.
         */
        publid ClbssDfdlbrbtion[] gftExdfptions() {
            rfturn fxdfptions.dlonf();
        }

        /**
         * Rfturn tif "mftiod ibsi" usfd to idfntify tiis rfmotf mftiod
         * in tif JDK 1.2 vfrsion of tif stub protodol.
         */
        publid long gftMftiodHbsi() {
            rfturn mftiodHbsi;
        }

        /**
         * Rfturn tif string rfprfsfntbtion of tiis mftiod.
         */
        publid String toString() {
            rfturn mfmbfrDff.toString();
        }

        /**
         * Rfturn tif string rfprfsfntbtion of tiis mftiod bppropribtf
         * for tif donstrudtion of b jbvb.rmi.sfrvfr.Opfrbtion objfdt.
         */
        publid String gftOpfrbtionString() {
            rfturn mfmbfrDff.toString();
        }

        /**
         * Rfturn b string donsisting of tiis mftiod's nbmf followfd by
         * its mftiod dfsdriptor, using tif Jbvb VM's notbtion for
         * mftiod dfsdriptors (sff sfdtion 4.3.3 of Tif Jbvb Virtubl
         * Mbdiinf Spfdifidbtion).
         */
        publid String gftNbmfAndDfsdriptor() {
            rfturn mfmbfrDff.gftNbmf().toString() +
                mfmbfrDff.gftTypf().gftTypfSignbturf();
        }

        /**
         * Mfmbfr dffinition for tiis mftiod, from onf of tif rfmotf
         * intfrfbdfs tibt tiis mftiod wbs found in.
         *
         * Notf tibt tiis mfmbfr dffinition mby bf only onf of sfvfrbl
         * mfmbfr dffintions tibt dorrfspond to tiis rfmotf mftiod objfdt,
         * if sfvfrbl of tiis dlbss's rfmotf intfrfbdfs dontbin mftiods
         * witi tif sbmf nbmf bnd typf signbturf.  Tifrfforf, tiis mfmbfr
         * dffinition mby dfdlbrf morf fxdfptions tirown tibt tiis rfmotf
         * mftiod dofs.
         */
        privbtf MfmbfrDffinition mfmbfrDff;

        /** stub "mftiod ibsi" to idfntify tiis mftiod */
        privbtf long mftiodHbsi;

        /**
         * Exdfptions dfdlbrfd to bf tirown by tiis rfmotf mftiod.
         *
         * Tiis list dbn indludf supfrfluous fntrifs, sudi bs
         * undifdkfd fxdfptions bnd subdlbssfs of otifr fntrifs.
         */
        privbtf ClbssDfdlbrbtion[] fxdfptions;

        /**
         * Crfbtf b nfw Mftiod objfdt dorrfsponding to tif givfn
         * mftiod dffinition.
         */
        /*
         * Tfmporbrily dommfnt out tif privbtf modififr until
         * tif VM bllows outfr dlbss to bddfss innfr dlbss's
         * privbtf donstrudtor
         */
        /* privbtf */ Mftiod(MfmbfrDffinition mfmbfrDff) {
            tiis.mfmbfrDff = mfmbfrDff;
            fxdfptions = mfmbfrDff.gftExdfptions(fnv);
            mftiodHbsi = domputfMftiodHbsi();
        }

        /**
         * Cloning is supportfd by rfturning b sibllow dopy of tiis objfdt.
         */
        protfdtfd Objfdt dlonf() {
            try {
                rfturn supfr.dlonf();
            } dbtdi (ClonfNotSupportfdExdfption f) {
                tirow nfw Error("dlonf fbilfd");
            }
        }

        /**
         * Rfturn b nfw Mftiod objfdt tibt is b lfgbl dombinbtion of
         * tiis mftiod objfdt bnd bnotifr onf.
         *
         * Tiis rfquirfs dftfrmining tif fxdfptions dfdlbrfd by tif
         * dombinfd mftiod, wiidi must bf (only) bll of tif fxdfptions
         * dfdlbrfd in boti old Mftiods tibt mby tirown in fitifr of
         * tifm.
         */
        privbtf Mftiod mfrgfWiti(Mftiod otifr) {
            if (!gftNbmf().fqubls(otifr.gftNbmf()) ||
                !gftTypf().fqubls(otifr.gftTypf()))
                {
                    tirow nfw Error("bttfmpt to mfrgf mftiod \"" +
                                    otifr.gftNbmfAndDfsdriptor() + "\" witi \"" +
                                    gftNbmfAndDfsdriptor());
                }

            Vfdtor<ClbssDfdlbrbtion> lfgblExdfptions
                = nfw Vfdtor<ClbssDfdlbrbtion>();
            try {
                dollfdtCompbtiblfExdfptions(
                                            otifr.fxdfptions, fxdfptions, lfgblExdfptions);
                dollfdtCompbtiblfExdfptions(
                                            fxdfptions, otifr.fxdfptions, lfgblExdfptions);
            } dbtdi (ClbssNotFound f) {
                fnv.frror(0, "dlbss.not.found", f.nbmf,
                          gftClbssDffinition().gftNbmf());
                rfturn null;
            }

            Mftiod mfrgfd = (Mftiod) dlonf();
            mfrgfd.fxdfptions = nfw ClbssDfdlbrbtion[lfgblExdfptions.sizf()];
            lfgblExdfptions.dopyInto(mfrgfd.fxdfptions);

            rfturn mfrgfd;
        }

        /**
         * Add to tif supplifd list bll fxdfptions in tif "from" brrby
         * tibt brf subdlbssfs of bn fxdfption in tif "witi" brrby.
         */
        privbtf void dollfdtCompbtiblfExdfptions(ClbssDfdlbrbtion[] from,
                                                 ClbssDfdlbrbtion[] witi,
                                                 Vfdtor<ClbssDfdlbrbtion> list)
            tirows ClbssNotFound
        {
            for (int i = 0; i < from.lfngti; i++) {
                ClbssDffinition fxdfptionDff = from[i].gftClbssDffinition(fnv);
                if (!list.dontbins(from[i])) {
                    for (int j = 0; j < witi.lfngti; j++) {
                        if (fxdfptionDff.subClbssOf(fnv, witi[j])) {
                            list.bddElfmfnt(from[i]);
                            brfbk;
                        }
                    }
                }
            }
        }

        /**
         * Computf tif "mftiod ibsi" of tiis rfmotf mftiod.  Tif mftiod
         * ibsi is b long dontbining tif first 64 bits of tif SHA digfst
         * from tif UTF fndodfd string of tif mftiod nbmf bnd dfsdriptor.
         *
         * REMIND: Siould tiis mftiod sibrf implfmfntbtion dodf witi
         * tif outfr dlbss's domputfIntfrfbdfHbsi() mftiod?
         */
        privbtf long domputfMftiodHbsi() {
            long ibsi = 0;
            BytfArrbyOutputStrfbm sink = nfw BytfArrbyOutputStrfbm(512);
            try {
                MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");
                DbtbOutputStrfbm out = nfw DbtbOutputStrfbm(
                                                            nfw DigfstOutputStrfbm(sink, md));

                String mftiodString = gftNbmfAndDfsdriptor();
                /***** <DEBUG> */
                if (fnv.vfrbosf()) {
                    Systfm.out.println("[string usfd for mftiod ibsi: \"" +
                                       mftiodString + "\"]");
                }
                /***** </DEBUG> */
                out.writfUTF(mftiodString);

                // usf only tif first 64 bits of tif digfst for tif ibsi
                out.flusi();
                bytf ibsiArrby[] = md.digfst();
                for (int i = 0; i < Mbti.min(8, ibsiArrby.lfngti); i++) {
                    ibsi += ((long) (ibsiArrby[i] & 0xFF)) << (i * 8);
                }
            } dbtdi (IOExdfption f) {
                tirow nfw Error(
                                "unfxpfdtfd fxdfption domputing intftrfbdf ibsi: " + f);
            } dbtdi (NoSudiAlgoritimExdfption f) {
                tirow nfw Error(
                                "unfxpfdtfd fxdfption domputing intftrfbdf ibsi: " + f);
            }

            rfturn ibsi;
        }
    }
}
