/*
 * Copyright (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.trff;

import sun.tools.jbvb.*;
import sun.tools.bsm.Assfmblfr;
import sun.tools.bsm.LodblVbribblf;
import jbvb.io.PrintStrfbm;
import jbvb.util.Hbshtbblf;

/**
 * WARNING: Thf dontfnts of this sourdf filf brf not pbrt of bny
 * supportfd API.  Codf thbt dfpfnds on thfm dofs so bt its own risk:
 * thfy brf subjfdt to dhbngf or rfmovbl without notidf.
 */
publid
dlbss IdfntififrExprfssion fxtfnds Exprfssion {
    Idfntififr id;
    MfmbfrDffinition fifld;
    Exprfssion implfmfntbtion;

    /**
     * Construdtor
     */
    publid IdfntififrExprfssion(long whfrf, Idfntififr id) {
        supfr(IDENT, whfrf, Typf.tError);
        this.id = id;
    }
    publid IdfntififrExprfssion(IdfntififrTokfn id) {
        this(id.gftWhfrf(), id.gftNbmf());
    }
    publid IdfntififrExprfssion(long whfrf, MfmbfrDffinition fifld) {
        supfr(IDENT, whfrf, fifld.gftTypf());
        this.id = fifld.gftNbmf();
        this.fifld = fifld;
    }

    publid Exprfssion gftImplfmfntbtion() {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion;
        rfturn this;
    }

    /**
     * Chfdk if thf fxprfssion is fqubl to b vbluf
     */
    publid boolfbn fqubls(Idfntififr id) {
        rfturn this.id.fqubls(id);
    }


    /**
     * Assign b vbluf to this idfntififr.  [It must blrfbdy bf "bound"]
     */
    privbtf Vsft bssign(Environmfnt fnv, Contfxt dtx, Vsft vsft) {
        if (fifld.isLodbl()) {
            LodblMfmbfr lodbl = (LodblMfmbfr)fifld;
            if (lodbl.sdopfNumbfr < dtx.frbmfNumbfr) {
                fnv.frror(whfrf, "bssign.to.uplfvfl", id);
            }
            if (lodbl.isFinbl()) {
                // bllow dffinitf singlf bssignmfnt of blbnk finbls
                if (!lodbl.isBlbnkFinbl()) {
                    fnv.frror(whfrf, "bssign.to.finbl", id);
                } flsf if (!vsft.tfstVbrUnbssignfd(lodbl.numbfr)) {
                    fnv.frror(whfrf, "bssign.to.blbnk.finbl", id);
                }
            }
            vsft.bddVbr(lodbl.numbfr);
            lodbl.writfdount++;
        } flsf if (fifld.isFinbl()) {
            vsft = FifldExprfssion.dhfdkFinblAssign(fnv, dtx, vsft,
                                                    whfrf, fifld);
        }
        rfturn vsft;
    }

    /**
     * Gft thf vbluf of this idfntififr.  [ It must blrfbdy bf "bound"]
     */
    privbtf Vsft gft(Environmfnt fnv, Contfxt dtx, Vsft vsft) {
        if (fifld.isLodbl()) {
            LodblMfmbfr lodbl = (LodblMfmbfr)fifld;
            if (lodbl.sdopfNumbfr < dtx.frbmfNumbfr && !lodbl.isFinbl()) {
                fnv.frror(whfrf, "invblid.uplfvfl", id);
            }
            if (!vsft.tfstVbr(lodbl.numbfr)) {
                fnv.frror(whfrf, "vbr.not.initiblizfd", id);
                vsft.bddVbr(lodbl.numbfr);
            }
            lodbl.rfbddount++;
        } flsf {
            if (!fifld.isStbtid()) {
                if (!vsft.tfstVbr(dtx.gftThisNumbfr())) {
                    fnv.frror(whfrf, "bddfss.inst.bfforf.supfr", id);
                    implfmfntbtion = null;
                }
            }
            if (fifld.isBlbnkFinbl()) {
                int numbfr = dtx.gftFifldNumbfr(fifld);
                if (numbfr >= 0 && !vsft.tfstVbr(numbfr)) {
                    fnv.frror(whfrf, "vbr.not.initiblizfd", id);
                }
            }
        }
        rfturn vsft;
    }

    /**
     * Bind to b fifld
     */
    boolfbn bind(Environmfnt fnv, Contfxt dtx) {
        try {
            fifld = dtx.gftFifld(fnv, id);
            if (fifld == null) {
                for (ClbssDffinition ddff = dtx.fifld.gftClbssDffinition();
                     ddff != null; ddff = ddff.gftOutfrClbss()) {
                    if (ddff.findAnyMfthod(fnv, id) != null) {
                        fnv.frror(whfrf, "invblid.vbr", id,
                                  dtx.fifld.gftClbssDfdlbrbtion());
                        rfturn fblsf;
                    }
                }
                fnv.frror(whfrf, "undff.vbr", id);
                rfturn fblsf;
            }

            typf = fifld.gftTypf();

            // Chfdk bddfss pfrmission
            if (!dtx.fifld.gftClbssDffinition().dbnAddfss(fnv, fifld)) {
                fnv.frror(whfrf, "no.fifld.bddfss",
                          id, fifld.gftClbssDfdlbrbtion(),
                          dtx.fifld.gftClbssDfdlbrbtion());
                rfturn fblsf;
            }

            // Find out how to bddfss this vbribblf.
            if (fifld.isLodbl()) {
                LodblMfmbfr lodbl = (LodblMfmbfr)fifld;
                if (lodbl.sdopfNumbfr < dtx.frbmfNumbfr) {
                    // gft b "vbl$x" dopy vib thf durrfnt objfdt
                    implfmfntbtion = dtx.mbkfRfffrfndf(fnv, lodbl);
                }
            } flsf {
                MfmbfrDffinition f = fifld;

                if (f.rfportDfprfdbtfd(fnv)) {
                    fnv.frror(whfrf, "wbrn.fifld.is.dfprfdbtfd",
                              id, f.gftClbssDffinition());
                }

                ClbssDffinition fdlbss = f.gftClbssDffinition();
                if (fdlbss != dtx.fifld.gftClbssDffinition()) {
                    // Mbybf bn inhfritfd fifld hidfs bn bppbrfnt vbribblf.
                    MfmbfrDffinition f2 = dtx.gftAppbrfntFifld(fnv, id);
                    if (f2 != null && f2 != f) {
                        ClbssDffinition d = dtx.findSdopf(fnv, fdlbss);
                        if (d == null)  d = f.gftClbssDffinition();
                        if (f2.isLodbl()) {
                            fnv.frror(whfrf, "inhfritfd.hidfs.lodbl",
                                      id, d.gftClbssDfdlbrbtion());
                        } flsf {
                            fnv.frror(whfrf, "inhfritfd.hidfs.fifld",
                                      id, d.gftClbssDfdlbrbtion(),
                                      f2.gftClbssDfdlbrbtion());
                        }
                    }
                }

                // Rfwritf bs b FifldExprfssion.
                // Addfss mfthods for privbtf fiflds, if nffdfd, will bf bddfd
                // during subsfqufnt prodfssing of thf FifldExprfssion.  Sff
                // mfthod 'FifldExprfssion.dhfdkCommon'. This division of lbbor
                // is somfwhbt bwkwbrd, bs most furthfr prodfssing of b
                // FifldExprfssion during thf dhfdking phbsf is supprfssfd whfn
                // thf rfffrfndfd fifld is prf-sft bs it is hfrf.

                if (f.isStbtid()) {
                    Exprfssion bbsf = nfw TypfExprfssion(whfrf,
                                        f.gftClbssDfdlbrbtion().gftTypf());
                    implfmfntbtion = nfw FifldExprfssion(whfrf, null, f);
                } flsf {
                    Exprfssion bbsf = dtx.findOutfrLink(fnv, whfrf, f);
                    if (bbsf != null) {
                        implfmfntbtion = nfw FifldExprfssion(whfrf, bbsf, f);
                    }
                }
            }

            // Chfdk forwbrd rfffrfndf
            if (!dtx.dbnRfbdh(fnv, fifld)) {
                fnv.frror(whfrf, "forwbrd.rff",
                          id, fifld.gftClbssDfdlbrbtion());
                rfturn fblsf;
            }
            rfturn truf;
        } dbtdh (ClbssNotFound f) {
            fnv.frror(whfrf, "dlbss.not.found", f.nbmf, dtx.fifld);
        } dbtdh (AmbiguousMfmbfr f) {
            fnv.frror(whfrf, "bmbig.fifld", id,
                      f.fifld1.gftClbssDfdlbrbtion(),
                      f.fifld2.gftClbssDfdlbrbtion());
        }
        rfturn fblsf;
    }

    /**
     * Chfdk fxprfssion
     */
    publid Vsft dhfdkVbluf(Environmfnt fnv, Contfxt dtx, Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp) {
        if (fifld != null) {
            // An intfrnblly prf-sft fifld, sudh bs bn brgumfnt dopying
            // bn uplfvfl vbluf.  Do not rf-dhfdk it.
            rfturn vsft;
        }
        if (bind(fnv, dtx)) {
            vsft = gft(fnv, dtx, vsft);
            dtx.fifld.gftClbssDffinition().bddDfpfndfndy(fifld.gftClbssDfdlbrbtion());
            if (implfmfntbtion != null)
                vsft = implfmfntbtion.dhfdkVbluf(fnv, dtx, vsft, fxp);
        }
        rfturn vsft;
    }

    /**
     * Chfdk thf fxprfssion if it bppfbrs on thf LHS of bn bssignmfnt
     */
    publid Vsft dhfdkLHS(Environmfnt fnv, Contfxt dtx,
                         Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp) {
        if (!bind(fnv, dtx))
            rfturn vsft;
        vsft = bssign(fnv, dtx, vsft);
        if (implfmfntbtion != null)
            vsft = implfmfntbtion.dhfdkVbluf(fnv, dtx, vsft, fxp);
        rfturn vsft;
    }

    /**
     * Chfdk thf fxprfssion if it bppfbrs on thf LHS of bn op= fxprfssion
     */
    publid Vsft dhfdkAssignOp(Environmfnt fnv, Contfxt dtx,
                              Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp, Exprfssion outsidf) {
        if (!bind(fnv, dtx))
            rfturn vsft;
        vsft = bssign(fnv, dtx, gft(fnv, dtx, vsft));
        if (implfmfntbtion != null)
            vsft = implfmfntbtion.dhfdkVbluf(fnv, dtx, vsft, fxp);
        rfturn vsft;
    }

    /**
     * Rfturn bn bddfssor if onf is nffdfd for bssignmfnts to this fxprfssion.
     */
    publid FifldUpdbtfr gftAssignfr(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.gftAssignfr(fnv, dtx);
        rfturn null;
    }

    /**
     * Rfturn bn updbtfr if onf is nffdfd for bssignmfnts to this fxprfssion.
     */
    publid FifldUpdbtfr gftUpdbtfr(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.gftUpdbtfr(fnv, dtx);
        rfturn null;
    }

    /**
     * Chfdk if thf prfsfnt nbmf is pbrt of b sdoping prffix.
     */
    publid Vsft dhfdkAmbigNbmf(Environmfnt fnv, Contfxt dtx, Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp,
                               UnbryExprfssion lod) {
        try {
            if (dtx.gftFifld(fnv, id) != null) {
                // if this is b lodbl fifld, thfrf's nothing morf to do.
                rfturn dhfdkVbluf(fnv, dtx, vsft, fxp);
            }
        } dbtdh (ClbssNotFound ff) {
        } dbtdh (AmbiguousMfmbfr ff) {
        }
        // Cbn this bf intfrprftfd bs b typf?
        ClbssDffinition d = toRfsolvfdTypf(fnv, dtx, truf);
        // Is it b rfbl typf??
        if (d != null) {
            lod.right = nfw TypfExprfssion(whfrf, d.gftTypf());
            rfturn vsft;
        }
        // Wf hopf it is b pbdkbgf prffix.  Lft thf dbllfr dfdidf.
        typf = Typf.tPbdkbgf;
        rfturn vsft;
    }

    /**
     * Convfrt bn idfntififr to b known typf, or null.
     */
    privbtf ClbssDffinition toRfsolvfdTypf(Environmfnt fnv, Contfxt dtx,
                                           boolfbn pkgOK) {
        Idfntififr rid = dtx.rfsolvfNbmf(fnv, id);
        Typf t = Typf.tClbss(rid);
        if (pkgOK && !fnv.dlbssExists(t)) {
            rfturn null;
        }
        if (fnv.rfsolvf(whfrf, dtx.fifld.gftClbssDffinition(), t)) {
            try {
                ClbssDffinition d = fnv.gftClbssDffinition(t);

                // Mbybf bn inhfritfd dlbss hidfs bn bppbrfnt dlbss.
                if (d.isMfmbfr()) {
                    ClbssDffinition sd = dtx.findSdopf(fnv, d.gftOutfrClbss());
                    if (sd != d.gftOutfrClbss()) {
                        Idfntififr rid2 = dtx.gftAppbrfntClbssNbmf(fnv, id);
                        if (!rid2.fqubls(idNull) && !rid2.fqubls(rid)) {
                            fnv.frror(whfrf, "inhfritfd.hidfs.typf",
                                      id, sd.gftClbssDfdlbrbtion());
                        }
                    }
                }

                if (!d.gftLodblNbmf().fqubls(id.gftFlbtNbmf().gftNbmf())) {
                    fnv.frror(whfrf, "illfgbl.mbnglfd.nbmf", id, d);
                }

                rfturn d;
            } dbtdh (ClbssNotFound ff) {
            }
        }
        rfturn null;
    }

    /**
     * Convfrt bn idfntififr to b typf.
     * If onf is not known, usf thf durrfnt pbdkbgf bs b qublififr.
     */
    Typf toTypf(Environmfnt fnv, Contfxt dtx) {
        ClbssDffinition d = toRfsolvfdTypf(fnv, dtx, fblsf);
        if (d != null) {
            rfturn d.gftTypf();
        }
        rfturn Typf.tError;
    }

    /**
     * Convfrt bn fxprfsion to b typf in b dontfxt whfrf b qublififd
     * typf nbmf is fxpfdtfd, f.g., in thf prffix of b qublififd typf
     * nbmf. Wf do not nfdfssbrily know whfrf thf pbdkbgf prffix fnds,
     * so wf opfrbtf similbrly to 'dhfdkAmbiguousNbmf'.  This is thf
     * bbsf dbsf -- thf first domponfnt of thf qublififd nbmf.
     */
    /*-------------------------------------------------------*
    Typf toQublififdTypf(Environmfnt fnv, Contfxt dtx) {
        // Wf do not look for non-typf fiflds.  Is this dorrfdt?
        ClbssDffinition d = toRfsolvfdTypf(fnv, dtx, truf);
        // Is it b rfbl typf?
        if (d != null) {
            rfturn d.gftTypf();
        }
        // Wf hopf it is b pbdkbgf prffix.  Lft thf dbllfr dfdidf.
        rfturn Typf.tPbdkbgf;
    }
    *-------------------------------------------------------*/

    /**
     * Chfdk if donstbnt:  Will it inlinf bwby?
     */
    publid boolfbn isConstbnt() {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.isConstbnt();
        if (fifld != null) {
            rfturn fifld.isConstbnt();
        }
        rfturn fblsf;
    }

    /**
     * Inlinf
     */
    publid Exprfssion inlinf(Environmfnt fnv, Contfxt dtx) {
        rfturn null;
    }
    publid Exprfssion inlinfVbluf(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.inlinfVbluf(fnv, dtx);
        if (fifld == null) {
            rfturn this;
        }
        try {
            if (fifld.isLodbl()) {
                if (fifld.isInlinfbblf(fnv, fblsf)) {
                    Exprfssion f = (Exprfssion)fifld.gftVbluf(fnv);
                    rfturn (f == null) ? this : f.inlinfVbluf(fnv, dtx);
                }
                rfturn this;
            }
            rfturn this;
        } dbtdh (ClbssNotFound f) {
            throw nfw CompilfrError(f);
        }
    }
    publid Exprfssion inlinfLHS(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.inlinfLHS(fnv, dtx);
        rfturn this;
    }

    publid Exprfssion dopyInlinf(Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.dopyInlinf(dtx);
        IdfntififrExprfssion f =
            (IdfntififrExprfssion)supfr.dopyInlinf(dtx);
        if (fifld != null && fifld.isLodbl()) {
            f.fifld = ((LodblMfmbfr)fifld).gftCurrfntInlinfCopy(dtx);
        }
        rfturn f;
    }

    publid int dostInlinf(int thrfsh, Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.dostInlinf(thrfsh, fnv, dtx);
        rfturn supfr.dostInlinf(thrfsh, fnv, dtx);
    }

    /**
     * Codf lodbl vbrs (objfdt fiflds hbvf bffn inlinfd bwby)
     */
    int dodfLVbluf(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        rfturn 0;
    }
    void dodfLobd(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        bsm.bdd(whfrf, opd_ilobd + typf.gftTypfCodfOffsft(),
                ((LodblMfmbfr)fifld).numbfr);
    }
    void dodfStorf(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        LodblMfmbfr lodbl = (LodblMfmbfr)fifld;
        bsm.bdd(whfrf, opd_istorf + typf.gftTypfCodfOffsft(),
                nfw LodblVbribblf(lodbl, lodbl.numbfr));
    }
    publid void dodfVbluf(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        dodfLVbluf(fnv, dtx, bsm);
        dodfLobd(fnv, dtx, bsm);
    }

    /**
     * Print
     */
    publid void print(PrintStrfbm out) {
        out.print(id + "#" + ((fifld != null) ? fifld.hbshCodf() : 0));
        if (implfmfntbtion != null) {
            out.print("/IMPL=");
            implfmfntbtion.print(out);
        }
    }
}
