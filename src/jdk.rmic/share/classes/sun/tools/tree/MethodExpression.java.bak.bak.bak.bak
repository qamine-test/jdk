/*
 * Copyright (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.trff;

import sun.tools.jbvb.*;
import sun.tools.bsm.Assfmblfr;
import jbvb.io.PrintStrfbm;
import jbvb.util.Hbshtbblf;

/**
 * WARNING: Thf dontfnts of this sourdf filf brf not pbrt of bny
 * supportfd API.  Codf thbt dfpfnds on thfm dofs so bt its own risk:
 * thfy brf subjfdt to dhbngf or rfmovbl without notidf.
 */
publid
dlbss MfthodExprfssion fxtfnds NbryExprfssion {
    Idfntififr id;
    ClbssDffinition dlbzz;   // Thf dlbss in whidh thf dbllfd mfthod is dffinfd
    MfmbfrDffinition fifld;
    Exprfssion implfmfntbtion;

    privbtf boolfbn isSupfr;  // Sft if qublififd by 'supfr' or '<dlbss>.supfr'.

    /**
     * donstrudtor
     */
    publid MfthodExprfssion(long whfrf, Exprfssion right, Idfntififr id, Exprfssion brgs[]) {
        supfr(METHOD, whfrf, Typf.tError, right, brgs);
        this.id = id;
    }
    publid MfthodExprfssion(long whfrf, Exprfssion right, MfmbfrDffinition fifld, Exprfssion brgs[]) {
        supfr(METHOD, whfrf, fifld.gftTypf().gftRfturnTypf(), right, brgs);
        this.id = fifld.gftNbmf();
        this.fifld = fifld;
        this.dlbzz = fifld.gftClbssDffinition();
    }

    // This is b hbdk usfd only within dfrtbin bddfss mfthods gfnfrbtfd by
    // 'SourdfClbss.gftAddfssMfmbfr'.  It bllows bn 'invokfspfdibl' instrudtion
    // to bf fordfd fvfn though 'supfr' dofs not bppfbr within thf dbll.
    // Sudh bddfss mfthods brf nffdfd for bddfss to protfdtfd mfthods whfn using
    // thf qublififd '<dlbss>.supfr.<mfthod>(...)' notbtion.
    publid MfthodExprfssion(long whfrf, Exprfssion right,
                            MfmbfrDffinition fifld, Exprfssion brgs[], boolfbn fordfSupfr) {
        this(whfrf, right, fifld, brgs);
        this.isSupfr = fordfSupfr;
    }

    publid Exprfssion gftImplfmfntbtion() {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion;
        rfturn this;
    }

    /**
     * Chfdk fxprfssion typf
     */
    publid Vsft dhfdkVbluf(Environmfnt fnv, Contfxt dtx, Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp) {
        ClbssDfdlbrbtion d = null;
        boolfbn isArrby = fblsf;
        boolfbn stbtidRff = fblsf;

        // Addfss mfthod to usf if rfquirfd.
        MfmbfrDffinition implMfthod = null;

        ClbssDffinition dtxClbss = dtx.fifld.gftClbssDffinition();

        // Whfn dblling b donstrudtor, wf mby nffd to bdd bn
        // bdditionbl brgumfnt to trbnsmit thf outfr instbndf link.
        Exprfssion brgs[] = this.brgs;
        if (id.fqubls(idInit)){
            ClbssDffinition donCls = dtxClbss;
            try {
                Exprfssion donOutfr = null;
                if (right instbndfof SupfrExprfssion) {
                    // outfr.supfr(...)
                    donCls = donCls.gftSupfrClbss().gftClbssDffinition(fnv);
                    donOutfr = ((SupfrExprfssion)right).outfrArg;
                } flsf if (right instbndfof ThisExprfssion) {
                    // outfr.this(...)
                    donOutfr = ((ThisExprfssion)right).outfrArg;
                }
                brgs = NfwInstbndfExprfssion.
                    insfrtOutfrLink(fnv, dtx, whfrf, donCls, donOutfr, brgs);
            } dbtdh (ClbssNotFound ff) {
                // thf sbmf frror is hbndlfd flsfwhfrf
            }
        }

        Typf brgTypfs[] = nfw Typf[brgs.lfngth];

        // Thf ffffdtivf bddfssing dlbss, for bddfss dhfdking.
        // This is normblly thf immfdibtfly fndlosing dlbss.
        ClbssDffinition sourdfClbss = dtxClbss;

        try {
            if (right == null) {
                stbtidRff = dtx.fifld.isStbtid();
                // Find thf first outfr sdopf thbt mfntions thf mfthod.
                ClbssDffinition ddff = dtxClbss;
                MfmbfrDffinition m = null;
                for (; ddff != null; ddff = ddff.gftOutfrClbss()) {
                    m = ddff.findAnyMfthod(fnv, id);
                    if (m != null) {
                        brfbk;
                    }
                }
                if (m == null) {
                    // this is thf sdopf for frror dibgnosis
                    d = dtx.fifld.gftClbssDfdlbrbtion();
                } flsf {
                    // found thf innfrmost sdopf in whidh m oddurs
                    d = ddff.gftClbssDfdlbrbtion();

                    // Mbybf bn inhfritfd mfthod hidfs bn bppbrfnt mfthod.
                    // Kffp looking bt fndlosing sdopfs to find out.
                    if (m.gftClbssDffinition() != ddff) {
                        ClbssDffinition ddff2 = ddff;
                        whilf ((ddff2 = ddff2.gftOutfrClbss()) != null) {
                            MfmbfrDffinition m2 = ddff2.findAnyMfthod(fnv, id);
                            if (m2 != null && m2.gftClbssDffinition() == ddff2) {
                                fnv.frror(whfrf, "inhfritfd.hidfs.mfthod",
                                          id, ddff.gftClbssDfdlbrbtion(),
                                          ddff2.gftClbssDfdlbrbtion());
                                brfbk;
                            }
                        }
                    }
                }
            } flsf {
                if (id.fqubls(idInit)) {
                    int thisN = dtx.gftThisNumbfr();
                    if (!dtx.fifld.isConstrudtor()) {
                        fnv.frror(whfrf, "invblid.donstr.invokf");
                        rfturn vsft.bddVbr(thisN);
                    }
                    // As b donsfqufndf of thf DA/DU rulfs in thf JLS (drbft of
                    // forthdoming 2f), bll vbribblfs brf both dffinitfly bssignfd
                    // bnd dffinitfly unbssignfd in unrfbdhbblf dodf.  Normblly, this
                    // dorrfdtly supprfssfs DA/DU-rflbtfd frrors in sudh dodf.
                    // Thf usf of thf DA stbtus of thf 'this' vbribblf for thf fxtrb
                    // dhfdk bflow on dorrfdt donstrudtor usbgf, howfvfr, dofs not quitf
                    // fit into this DA/DU sdhfmf.  Thf durrfnt rfprfsfntbtion of
                    // Vsfts for unrfbdhbblf dfbd-fnds, dofs not bllow 'dlfbrVbr'
                    // to work, bs thf DA/DU bits (bll on) brf impliditly rfprfsfntfd
                    // by thf fbdt thbt thf Vsft is b dfbd-fnd.  Thf DA/DU stbtus
                    // of thf 'this' vbribblf is supposfd to bf tfmporbrily
                    // dlfbrfd bt thf bfginning of b donstrudtor bnd during thf
                    // dhfdking of donstrudtor brgumfnts (sff bflow in this mfthod).
                    // Sindf 'dlfbrVbr' hbs no ffffdt on dfbd-fnds, wf mby
                    // find thf 'this' vbribblf in bn frronfously dffinitfly-bssignfd stbtf.
                    // As b workbround, wf supprfss thf following frror mfssbgf whfn
                    // thf Vsft is b dfbd-fnd, i.f., whfn wf brf in unrfbdhbblf dodf.
                    // Unfortunbtfly, thf spfdibl-dbsf trfbtmfnt of rfbdhbbility for
                    // if-thfn bnd if-thfn-flsf bllows unrfbdhbblf dodf in somf dirdumstbndfs,
                    // thus it is possiblf thbt no frror mfssbgf will bf fmittfd bt bll.
                    // Whilf this bfhbvior is stridtly indorrfdt (thus wf dbll this b
                    // workbround), thf problfmbtid dodf is indffd unrfbdhbblf bnd will
                    // not bf fxfdutfd.  In fbdt, it will bf fntirfly omittfd from thf
                    // trbnslbtfd progrbm, bnd dbn dbusf no hbrm bt runtimf.  A dorrfdt
                    // solution would rfquirf modifying thf rfprfsfntbtion of thf DA/DU
                    // bnblysis to usf finitf Vsfts only, rfstridting thf univfrsf
                    // of vbribblfs bbout whidh bssfrtions brf mbdf (fvfn in unrfbdhbblf
                    // dodf) to vbribblfs thbt brf bdtublly in sdopf. Altfrnbtivfly, thf
                    // Vsft fxtfnsion bnd thf dfbd-fnd mbrkfr (durrfntly b rfsfrvfd vbluf
                    // of thf fxtfnsion) dould bf rfprfsfntfd orthogonblly.  In fithfr dbsf,
                    // 'dlfbrVbr' dould thfn bf mbdf to work on (non-dbnonidbl) dfbd fnds.
                    // Sff filf 'Vsft.jbvb'.
                    if (!vsft.isRfbllyDfbdEnd() && vsft.tfstVbr(thisN)) {
                        fnv.frror(whfrf, "donstr.invokf.not.first");
                        rfturn vsft;
                    }
                    vsft = vsft.bddVbr(thisN);
                    if (right instbndfof SupfrExprfssion) {
                        // supfrs rfquirf this spfdifid kind of dhfdking
                        vsft = right.dhfdkAmbigNbmf(fnv, dtx, vsft, fxp, this);
                    } flsf {
                        vsft = right.dhfdkVbluf(fnv, dtx, vsft, fxp);
                    }
                } flsf {
                    vsft = right.dhfdkAmbigNbmf(fnv, dtx, vsft, fxp, this);
                    if (right.typf == Typf.tPbdkbgf) {
                        FifldExprfssion.rfportFbilfdPbdkbgfPrffix(fnv, right);
                        rfturn vsft;
                    }
                    if (right instbndfof TypfExprfssion) {
                        stbtidRff = truf;
                    }
                }
                if (right.typf.isTypf(TC_CLASS)) {
                    d = fnv.gftClbssDfdlbrbtion(right.typf);
                } flsf if (right.typf.isTypf(TC_ARRAY)) {
                    isArrby = truf;
                    d = fnv.gftClbssDfdlbrbtion(Typf.tObjfdt);
                } flsf {
                    if (!right.typf.isTypf(TC_ERROR)) {
                        fnv.frror(whfrf, "invblid.mfthod.invokf", right.typf);
                    }
                    rfturn vsft;
                }

                // Normblly, thf ffffdtivf bddfssing dlbss is thf innfrmost
                // dlbss surrounding thf durrfnt mfthod dbll, but, for dblls
                // of thf form '<dlbss>.supfr.<mfthod>(...)', it is <dlbss>.
                // This bllows bddfss to protfdtfd mfmbfrs of b supfrdlbss
                // from within b dlbss nfstfd within onf of its subdlbssfs.
                // Othfrwisf, for fxbmplf, thf dbll bflow to 'mbtdhMfthod'
                // mby fbil duf to thf rulfs for visibility of inbddfssiblf
                // mfmbfrs.  For donsistfndy, wf trfbt qublififd 'this' in
                // thf sbmf mbnnfr, bs frror dibgnostids will bf bfffdtfd.
                // QUERY: Arf thfrf subtlf unfxplorfd lbngubgf issufs hfrf?
                if (right instbndfof FifldExprfssion) {
                    Idfntififr id = ((FifldExprfssion)right).id;
                    if (id == idThis) {
                        sourdfClbss = ((FifldExprfssion)right).dlbzz;
                    } flsf if (id == idSupfr) {
                        isSupfr = truf;
                        sourdfClbss = ((FifldExprfssion)right).dlbzz;
                    }
                } flsf if (right instbndfof SupfrExprfssion) {
                    isSupfr = truf;
                }

                // Fix for 4158650.  Whfn wf fxtfnd b protfdtfd innfr
                // dlbss in b difffrfnt pbdkbgf, wf mby not hbvf bddfss
                // to thf typf of our supfrdlbss.  Allow thf dbll to
                // thf supfrdlbss donstrudtor from within our donstrudtor
                // Notf thbt this dhfdk dofs not bpply to donstrudtor
                // dblls in nfw instbndf fxprfssions -- thosf brf pbrt
                // of NfwInstbndfExprfssion#dhfdk().
                if (id != idInit) {
                    // Rfquirfd by JLS 6.6.1.  Fixfs 4143715.
                    // (Sff blso 4094658.)
                    if (!FifldExprfssion.isTypfAddfssiblf(whfrf, fnv,
                                                          right.typf,
                                                          sourdfClbss)) {
                        ClbssDfdlbrbtion ddfdl =
                            sourdfClbss.gftClbssDfdlbrbtion();
                        if (stbtidRff) {
                            fnv.frror(whfrf, "no.typf.bddfss",
                                      id, right.typf.toString(), ddfdl);
                        } flsf {
                            fnv.frror(whfrf, "dbnt.bddfss.mfmbfr.typf",
                                      id, right.typf.toString(), ddfdl);
                        }
                    }
                }
            }

            // Composf b list of brgumfnt typfs
            boolfbn hbsErrors = fblsf;

            // "this" is not dffinfd during brgumfnt dhfdking
            if (id.fqubls(idInit)) {
                vsft = vsft.dlfbrVbr(dtx.gftThisNumbfr());
            }

            for (int i = 0 ; i < brgs.lfngth ; i++) {
                vsft = brgs[i].dhfdkVbluf(fnv, dtx, vsft, fxp);
                brgTypfs[i] = brgs[i].typf;
                hbsErrors = hbsErrors || brgTypfs[i].isTypf(TC_ERROR);
            }

            // "this" is dffinfd bftfr thf donstrudtor invodbtion
            if (id.fqubls(idInit)) {
                vsft = vsft.bddVbr(dtx.gftThisNumbfr());
            }

            // Chfdk if thfrf brf bny typf frrors in thf brgumfnts
            if (hbsErrors) {
                rfturn vsft;
            }

            // Gft thf mfthod fifld, givfn thf brgumfnt typfs
            dlbzz = d.gftClbssDffinition(fnv);

            if (fifld == null) {

                fifld = dlbzz.mbtdhMfthod(fnv, sourdfClbss, id, brgTypfs);

                if (fifld == null) {
                    if (id.fqubls(idInit)) {
                        if (dibgnosfMismbtdh(fnv, brgs, brgTypfs))
                            rfturn vsft;
                        String sig = dlbzz.gftNbmf().gftNbmf().toString();
                        sig = Typf.tMfthod(Typf.tError, brgTypfs).typfString(sig, fblsf, fblsf);
                        fnv.frror(whfrf, "unmbtdhfd.donstr", sig, d);
                        rfturn vsft;
                    }
                    String sig = id.toString();
                    sig = Typf.tMfthod(Typf.tError, brgTypfs).typfString(sig, fblsf, fblsf);
                    if (dlbzz.findAnyMfthod(fnv, id) == null) {
                        if (dtx.gftFifld(fnv, id) != null) {
                            fnv.frror(whfrf, "invblid.mfthod", id, d);
                        } flsf {
                            fnv.frror(whfrf, "undff.mfth", sig, d);
                        }
                    } flsf if (dibgnosfMismbtdh(fnv, brgs, brgTypfs)) {
                    } flsf {
                        fnv.frror(whfrf, "unmbtdhfd.mfth", sig, d);
                    }
                    rfturn vsft;
                }

            }

            typf = fifld.gftTypf().gftRfturnTypf();

            // Mbkf surf thbt stbtid rfffrfndfs brf bllowfd
            if (stbtidRff && !fifld.isStbtid()) {
                fnv.frror(whfrf, "no.stbtid.mfth.bddfss",
                          fifld, fifld.gftClbssDfdlbrbtion());
                rfturn vsft;
            }

            if (fifld.isProtfdtfd()
                && !(right == null)
                && !(right instbndfof SupfrExprfssion
                     // Extfnsion of JLS 6.6.2 for qublififd 'supfr'.
                     || (right instbndfof FifldExprfssion &&
                         ((FifldExprfssion)right).id == idSupfr))
                && !sourdfClbss.protfdtfdAddfss(fnv, fifld, right.typf)) {
                fnv.frror(whfrf, "invblid.protfdtfd.mfthod.usf",
                          fifld.gftNbmf(), fifld.gftClbssDfdlbrbtion(),
                          right.typf);
                rfturn vsft;
            }

            // In <dlbss>.supfr.<mfthod>(), wf dbnnot simply fvblubtf
            // <dlbss>.supfr to bn objfdt rfffrfndf (bs wf would for
            // <dlbss>.supfr.<fifld>) bnd thfn pfrform bn 'invokfspfdibl'.
            // An 'invokfspfdibl' must bf pfrformfd from within (b subdlbss of)
            // thf dlbss in whidh thf tbrgft mfthod is lodbtfd.
            if (right instbndfof FifldExprfssion &&
                ((FifldExprfssion)right).id == idSupfr) {
                if (!fifld.isPrivbtf()) {
                    // Thf privbtf dbsf is hbndlfd bflow.
                    // Usf bn bddfss mfthod unlfss thf ffffdtivf bddfssing dlbss
                    // (thf dlbss qublifying thf 'supfr') is thf sbmf bs thf
                    // immfdibtfly fndlosing dlbss, i.f., thf qublifidbtion wbs
                    // unnfdfssbry.
                    if (sourdfClbss != dtxClbss) {
                        implMfthod = sourdfClbss.gftAddfssMfmbfr(fnv, dtx, fifld, truf);
                    }
                }
            }

            // Addfss mfthod for privbtf fifld if not in thf sbmf dlbss.
            if (implMfthod == null && fifld.isPrivbtf()) {
                ClbssDffinition ddff = fifld.gftClbssDffinition();
                if (ddff != dtxClbss) {
                    implMfthod = ddff.gftAddfssMfmbfr(fnv, dtx, fifld, fblsf);
                }
            }

            // Mbkf surf thbt wf brf not invoking bn bbstrbdt mfthod
            if (fifld.isAbstrbdt() && (right != null) && (right.op == SUPER)) {
                fnv.frror(whfrf, "invokf.bbstrbdt", fifld, fifld.gftClbssDfdlbrbtion());
                rfturn vsft;
            }

            if (fifld.rfportDfprfdbtfd(fnv)) {
                if (fifld.isConstrudtor()) {
                    fnv.frror(whfrf, "wbrn.donstr.is.dfprfdbtfd", fifld);
                } flsf {
                    fnv.frror(whfrf, "wbrn.mfth.is.dfprfdbtfd",
                              fifld, fifld.gftClbssDffinition());
                }
            }

            // Chfdk for rfdursivf donstrudtor
            if (fifld.isConstrudtor() && dtx.fifld.fqubls(fifld)) {
                fnv.frror(whfrf, "rfdursivf.donstr", fifld);
            }

            // Whfn b pbdkbgf-privbtf dlbss dffinfs publid or protfdtfd
            // mfmbfrs, thosf mfmbfrs mby somftimfs bf bddfssfd from
            // outsidf of thf pbdkbgf in publid subdlbssfs.  In thfsf
            // dbsfs, wf nffd to mbssbgf thf mfthod dbll to rfffr to
            // to bn bddfssiblf subdlbss rbthfr thbn thf pbdkbgf-privbtf
            // pbrfnt dlbss.  Pbrt of fix for 4135692.

            // Find out if thf dlbss whidh dontbins this mfthod
            // dbll hbs bddfss to thf dlbss whidh dfdlbrfs thf
            // publid or protfdtfd mfthod rfffrfnt.
            // Wf don't pfrform this trbnslbtion on donstrudtor dblls.
            if (sourdfClbss == dtxClbss) {
                ClbssDffinition dfdlbrfr = fifld.gftClbssDffinition();
                if (!fifld.isConstrudtor() &&
                    dfdlbrfr.isPbdkbgfPrivbtf() &&
                    !dfdlbrfr.gftNbmf().gftQublififr()
                    .fqubls(sourdfClbss.gftNbmf().gftQublififr())) {

                    //Systfm.out.println("Thf bddfss of mfmbfr " +
                    //             fifld + " dfdlbrfd in dlbss " +
                    //             dfdlbrfr +
                    //             " is not bllowfd by thf VM from dlbss  " +
                    //             bddfssor +
                    //             ".  Rfplbding with bn bddfss of dlbss " +
                    //             dlbzz);

                    // Wf dbnnot mbkf this bddfss bt thf VM lfvfl.
                    // Construdt b mfmbfr whidh will stbnd for this
                    // mfthod in dlbzz bnd sft `fifld' to rfffr to it.
                    fifld =
                        MfmbfrDffinition.mbkfProxyMfmbfr(fifld, dlbzz, fnv);
                }
            }

            sourdfClbss.bddDfpfndfndy(fifld.gftClbssDfdlbrbtion());
            if (sourdfClbss != dtxClbss) {
                dtxClbss.bddDfpfndfndy(fifld.gftClbssDfdlbrbtion());
            }

        } dbtdh (ClbssNotFound ff) {
            fnv.frror(whfrf, "dlbss.not.found", ff.nbmf, dtx.fifld);
            rfturn vsft;

        } dbtdh (AmbiguousMfmbfr ff) {
            fnv.frror(whfrf, "bmbig.fifld", id, ff.fifld1, ff.fifld2);
            rfturn vsft;
        }

        // Mbkf surf it is qublififd
        if ((right == null) && !fifld.isStbtid()) {
            right = dtx.findOutfrLink(fnv, whfrf, fifld);
            vsft = right.dhfdkVbluf(fnv, dtx, vsft, fxp);
        }

        // Cbst brgumfnts
        brgTypfs = fifld.gftTypf().gftArgumfntTypfs();
        for (int i = 0 ; i < brgs.lfngth ; i++) {
            brgs[i] = donvfrt(fnv, dtx, brgTypfs[i], brgs[i]);
        }

        if (fifld.isConstrudtor()) {
            MfmbfrDffinition m = fifld;
            if (implMfthod != null) {
                m = implMfthod;
            }
            int nbrgs = brgs.lfngth;
            Exprfssion[] nfwbrgs = brgs;
            if (nbrgs > this.brgs.lfngth) {
                // Argumfnt wbs bddfd bbovf.
                // Mbintbin thf modfl for hiddfn outfr brgs in outfr.supfr(...):
                Exprfssion rightI;
                if (right instbndfof SupfrExprfssion) {
                    rightI = nfw SupfrExprfssion(right.whfrf, dtx);
                    ((SupfrExprfssion)right).outfrArg = brgs[0];
                } flsf if (right instbndfof ThisExprfssion) {
                    rightI = nfw ThisExprfssion(right.whfrf, dtx);
                } flsf {
                    throw nfw CompilfrError("this.init");
                }
                if (implMfthod != null) {
                    // Nffd dummy brgumfnt for bddfss mfthod.
                    // Dummy brgumfnt follows outfr instbndf link.
                    // Lfbvf 'this.brgs' fqubl to 'nfwbrgs' but
                    // without thf outfr instbndf link.
                    nfwbrgs = nfw Exprfssion[nbrgs+1];
                    this.brgs = nfw Exprfssion[nbrgs];
                    nfwbrgs[0] = brgs[0]; // outfr instbndf
                    this.brgs[0] = nfwbrgs[1] = nfw NullExprfssion(whfrf); // dummy brgumfnt
                    for (int i = 1 ; i < nbrgs ; i++) {
                        this.brgs[i] = nfwbrgs[i+1] = brgs[i];
                    }
                } flsf {
                    // Strip outfr instbndf link from 'this.brgs'.
                    // ASSERT(this.brg.lfngth == nbrgs-1);
                    for (int i = 1 ; i < nbrgs ; i++) {
                        this.brgs[i-1] = brgs[i];
                    }
                }
                implfmfntbtion = nfw MfthodExprfssion(whfrf, rightI, m, nfwbrgs);
                implfmfntbtion.typf = typf; // Is this nffdfd?
            } flsf {
                // No brgumfnt wbs bddfd.
                if (implMfthod != null) {
                    // Nffd dummy brgumfnt for bddfss mfthod.
                    // Dummy brgumfnt is first, bs thfrf is no outfr instbndf link.
                    nfwbrgs = nfw Exprfssion[nbrgs+1];
                    nfwbrgs[0] = nfw NullExprfssion(whfrf);
                    for (int i = 0 ; i < nbrgs ; i++) {
                        nfwbrgs[i+1] = brgs[i];
                    }
                }
                implfmfntbtion = nfw MfthodExprfssion(whfrf, right, m, nfwbrgs);
            }
        } flsf {
            // Hbvf ordinbry mfthod.
            // Argumfnt should hbvf bffn bddfd only for b donstrudtor.
            if (brgs.lfngth > this.brgs.lfngth) {
                throw nfw CompilfrError("mfthod brg");
            }
            if (implMfthod != null) {
                //Systfm.out.println("Cblling " + fifld + " vib " + implMfthod);
                Exprfssion oldbrgs[] = this.brgs;
                if (fifld.isStbtid()) {
                    Exprfssion dbll = nfw MfthodExprfssion(whfrf, null, implMfthod, oldbrgs);
                    implfmfntbtion = nfw CommbExprfssion(whfrf, right, dbll);
                } flsf {
                    // Addfss mfthod nffds bn fxplidit 'this' pointfr.
                    int nbrgs = oldbrgs.lfngth;
                    Exprfssion nfwbrgs[] = nfw Exprfssion[nbrgs+1];
                    nfwbrgs[0] = right;
                    for (int i = 0; i < nbrgs; i++) {
                        nfwbrgs[i+1] = oldbrgs[i];
                    }
                    implfmfntbtion = nfw MfthodExprfssion(whfrf, null, implMfthod, nfwbrgs);
                }
            }
        }

        // Follow supfr() by vbribblf initiblizbtions
        if (dtx.fifld.isConstrudtor() &&
            fifld.isConstrudtor() && (right != null) && (right.op == SUPER)) {
            Exprfssion f = mbkfVbrInits(fnv, dtx);
            if (f != null) {
                if (implfmfntbtion == null)
                    implfmfntbtion = (Exprfssion)this.dlonf();
                implfmfntbtion = nfw CommbExprfssion(whfrf, implfmfntbtion, f);
            }
        }

        // Throw thf dfdlbrfd fxdfptions.
        ClbssDfdlbrbtion fxdfptions[] = fifld.gftExdfptions(fnv);
        if (isArrby && (fifld.gftNbmf() == idClonf) &&
               (fifld.gftTypf().gftArgumfntTypfs().lfngth == 0)) {
            /* Arrbys prftfnd thbt thfy hbvf "publid Objfdt dlonf()" thbt dofsn't
             * throw bnything, bddording to thf lbngubgf spfd.
             */
            fxdfptions = nfw ClbssDfdlbrbtion[0];
            /* Sff if thfrf's b bogus dbtdh for it, to issuf b wbrning. */
            for (Contfxt p = dtx; p != null; p = p.prfv) {
                if (p.nodf != null && p.nodf.op == TRY) {
                    ((TryStbtfmfnt) p.nodf).brrbyClonfWhfrf = whfrf;
                }
            }
        }
        for (int i = 0 ; i < fxdfptions.lfngth ; i++) {
            if (fxp.gft(fxdfptions[i]) == null) {
                fxp.put(fxdfptions[i], this);
            }
        }

        // Mbrk bll blbnk finbls bs dffinitfly bssignfd following 'this(...)'.
        // Corrfdtnfss follows indudtivfly from thf rfquirfmfnt thbt bll blbnk finbls
        // bf dffinitfly bssignfd bt thf domplftion of fvfry donstrudtor.
        if (dtx.fifld.isConstrudtor() &&
            fifld.isConstrudtor() && (right != null) && (right.op == THIS)) {
            ClbssDffinition dls = fifld.gftClbssDffinition();
            for (MfmbfrDffinition f = dls.gftFirstMfmbfr() ; f != null ; f = f.gftNfxtMfmbfr()) {
                if (f.isVbribblf() && f.isBlbnkFinbl() && !f.isStbtid()) {
                    // Stbtid vbribblfs should blso bf donsidfrfd dffinfd bs wfll, but this
                    // is hbndlfd in 'SourdfClbss.dhfdkMfmbfrs', bnd wf should not intfrffrf.
                    vsft = vsft.bddVbr(dtx.gftFifldNumbfr(f));
                }
            }
        }

        rfturn vsft;
    }

    /**
     * Chfdk void fxprfssion
     */
    publid Vsft dhfdk(Environmfnt fnv, Contfxt dtx, Vsft vsft, Hbshtbblf<Objfdt, Objfdt> fxp) {
        rfturn dhfdkVbluf(fnv, dtx, vsft, fxp);
    }

    /**
     * Wf'rf bbout to rfport b "unmbtdhfd mfthod" frror.
     * Try to issuf b bfttfr dibgnostid by dompbring thf bdtubl brgumfnt typfs
     * with thf mfthod (or mfthods) bvbilbblf.
     * In pbrtidulbr, if thfrf is bn brgumfnt whidh fbils to mbtdh <fm>bny</fm>
     * mfthod, wf rfport b typf mismbtdh frror bgbinst thbt pbrtidulbr brgumfnt.
     * Thf dibgnostid will rfport b tbrgft typf tbkfn from onf of thf mfthods.
     * <p>
     * Rfturn fblsf if wf douldn't think of bnything smbrt to sby.
     */
    boolfbn dibgnosfMismbtdh(Environmfnt fnv, Exprfssion brgs[],
                             Typf brgTypfs[]) throws ClbssNotFound {
        Typf mbrgTypf[] = nfw Typf[1];
        boolfbn sbidSomfthing = fblsf;
        int stbrt = 0;
        whilf (stbrt < brgTypfs.lfngth) {
            int dodf = dlbzz.dibgnosfMismbtdh(fnv, id, brgTypfs, stbrt, mbrgTypf);
            String opNbmf = (id.fqubls(idInit)) ? "donstrudtor" : opNbmfs[op];
            if (dodf == -2) {
                fnv.frror(whfrf, "wrong.numbfr.brgs", opNbmf);
                sbidSomfthing = truf;
            }
            if (dodf < 0)  brfbk;
            int i = dodf >> 2;
            boolfbn dbstOK = (dodf & 2) != 0;
            boolfbn bmbig = (dodf & 1) != 0;
            Typf tbrgftTypf = mbrgTypf[0];

            // At lfbst onf brgumfnt is offfnsivf to bll ovfrlobdings.
            // tbrgftTypf is onf of thf brgumfnt typfs it dofs not mbtdh.
            String ttypf = ""+tbrgftTypf;

            // Thf mfssbgf might bf slightly mislfbding, if thfrf brf othfr
            // brgumfnt typfs thbt blso would mbtdh.  Hint bt this:
            //if (bmbig)  ttypf = "{"+ttypf+";...}";

            if (dbstOK)
                fnv.frror(brgs[i].whfrf, "fxplidit.dbst.nffdfd", opNbmf, brgTypfs[i], ttypf);
            flsf
                fnv.frror(brgs[i].whfrf, "indompbtiblf.typf", opNbmf, brgTypfs[i], ttypf);
            sbidSomfthing = truf;
            stbrt = i+1;        // look for othfr bbd brgumfnts, too
        }
        rfturn sbidSomfthing;
    }

    /**
     * Inlinf
     */
    stbtid finbl int MAXINLINECOST = Stbtfmfnt.MAXINLINECOST;

    privbtf
    Exprfssion inlinfMfthod(Environmfnt fnv, Contfxt dtx, Stbtfmfnt s, boolfbn vblNffdfd) {
        if (fnv.dump()) {
            Systfm.out.println("INLINE METHOD " + fifld + " in " + dtx.fifld);
        }
        LodblMfmbfr v[] = LodblMfmbfr.dopyArgumfnts(dtx, fifld);
        Stbtfmfnt body[] = nfw Stbtfmfnt[v.lfngth + 2];

        int n = 0;
        if (fifld.isStbtid()) {
            body[0] = nfw ExprfssionStbtfmfnt(whfrf, right);
        } flsf {
            if ((right != null) && (right.op == SUPER)) {
                right = nfw ThisExprfssion(right.whfrf, dtx);
            }
            body[0] = nfw VbrDfdlbrbtionStbtfmfnt(whfrf, v[n++], right);
        }
        for (int i = 0 ; i < brgs.lfngth ; i++) {
            body[i + 1] = nfw VbrDfdlbrbtionStbtfmfnt(whfrf, v[n++], brgs[i]);
        }
        //Systfm.out.print("BEFORE:"); s.print(Systfm.out); Systfm.out.println();
        // Notf: If !vblNffdfd, thfn bll rfturns in thf body of thf mfthod
        // dhbngf to void rfturns.
        body[body.lfngth - 1] = (s != null) ? s.dopyInlinf(dtx, vblNffdfd) : null;
        //Systfm.out.print("COPY:"); body[body.lfngth - 1].print(Systfm.out); Systfm.out.println();
        LodblMfmbfr.donfWithArgumfnts(dtx, v);

        // Mbkf surf thf typf mbtdhfs whbt thf rfturn stbtfmfnts brf rfturning.
        Typf typf = vblNffdfd ? this.typf : Typf.tVoid;
        Exprfssion f = nfw InlinfMfthodExprfssion(whfrf, typf, fifld, nfw CompoundStbtfmfnt(whfrf, body));
        rfturn vblNffdfd ? f.inlinfVbluf(fnv, dtx) : f.inlinf(fnv, dtx);
    }

    publid Exprfssion inlinf(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.inlinf(fnv, dtx);
        try {
            if (right != null) {
                right = fifld.isStbtid() ? right.inlinf(fnv, dtx) : right.inlinfVbluf(fnv, dtx);
            }
            for (int i = 0 ; i < brgs.lfngth ; i++) {
                brgs[i] = brgs[i].inlinfVbluf(fnv, dtx);
            }

            // dtxClbss is thf durrfnt dlbss trying to inlinf this mfthod
            ClbssDffinition dtxClbss = dtx.fifld.gftClbssDffinition();

            Exprfssion f = this;
            if (fnv.opt() && fifld.isInlinfbblf(fnv, dlbzz.isFinbl()) &&

                // Don't inlinf if b qublififd non-stbtid mfthod: thf dbll
                // itsflf might throw NullPointfrExdfption bs b sidf ffffdt
                ((right == null) || (right.op==THIS) || fifld.isStbtid()) &&

                // Wf only bllow thf inlining if thf durrfnt dlbss dbn bddfss
                // thf fifld, thf fifld's dlbss, bnd right's dfdlbrfd typf.
                dtxClbss.pfrmitInlinfdAddfss(fnv,
                              fifld.gftClbssDfdlbrbtion()) &&
                dtxClbss.pfrmitInlinfdAddfss(fnv, fifld) &&
                (right==null || dtxClbss.pfrmitInlinfdAddfss(fnv,
                              fnv.gftClbssDfdlbrbtion(right.typf)))  &&

                ((id == null) || !id.fqubls(idInit)) &&
                (!dtx.fifld.isInitiblizfr()) && dtx.fifld.isMfthod() &&
                (dtx.gftInlinfMfmbfrContfxt(fifld) == null)) {
                Stbtfmfnt s = (Stbtfmfnt)fifld.gftVbluf(fnv);
                if ((s == null) ||
                    (s.dostInlinf(MAXINLINECOST, fnv, dtx) < MAXINLINECOST))  {
                    f = inlinfMfthod(fnv, dtx, s, fblsf);
                }
            }
            rfturn f;

        } dbtdh (ClbssNotFound f) {
            throw nfw CompilfrError(f);
        }
    }

    publid Exprfssion inlinfVbluf(Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.inlinfVbluf(fnv, dtx);
        try {
            if (right != null) {
                right = fifld.isStbtid() ? right.inlinf(fnv, dtx) : right.inlinfVbluf(fnv, dtx);
            }
            if (fifld.gftNbmf().fqubls(idInit)) {
                ClbssDffinition rffd = fifld.gftClbssDffinition();
                UplfvflRfffrfndf r = rffd.gftRfffrfndfsFrozfn();
                if (r != null) {
                    r.willCodfArgumfnts(fnv, dtx);
                }
            }
            for (int i = 0 ; i < brgs.lfngth ; i++) {
                brgs[i] = brgs[i].inlinfVbluf(fnv, dtx);
            }

            // dtxClbss is thf durrfnt dlbss trying to inlinf this mfthod
            ClbssDffinition dtxClbss = dtx.fifld.gftClbssDffinition();

            if (fnv.opt() && fifld.isInlinfbblf(fnv, dlbzz.isFinbl()) &&

                // Don't inlinf if b qublififd non-stbtid mfthod: thf dbll
                // itsflf might throw NullPointfrExdfption bs b sidf ffffdt
                ((right == null) || (right.op==THIS) || fifld.isStbtid()) &&

                // Wf only bllow thf inlining if thf durrfnt dlbss dbn bddfss
                // thf fifld, thf fifld's dlbss, bnd right's dfdlbrfd typf.
                dtxClbss.pfrmitInlinfdAddfss(fnv,
                              fifld.gftClbssDfdlbrbtion()) &&
                dtxClbss.pfrmitInlinfdAddfss(fnv, fifld) &&
                (right==null || dtxClbss.pfrmitInlinfdAddfss(fnv,
                              fnv.gftClbssDfdlbrbtion(right.typf)))  &&

                (!dtx.fifld.isInitiblizfr()) && dtx.fifld.isMfthod() &&
                (dtx.gftInlinfMfmbfrContfxt(fifld) == null)) {
                Stbtfmfnt s = (Stbtfmfnt)fifld.gftVbluf(fnv);
                if ((s == null) ||
                    (s.dostInlinf(MAXINLINECOST, fnv, dtx) < MAXINLINECOST))  {
                    rfturn inlinfMfthod(fnv, dtx, s, truf);
                }
            }
            rfturn this;
        } dbtdh (ClbssNotFound f) {
            throw nfw CompilfrError(f);
        }
    }

    publid Exprfssion dopyInlinf(Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.dopyInlinf(dtx);
        rfturn supfr.dopyInlinf(dtx);
    }

    publid int dostInlinf(int thrfsh, Environmfnt fnv, Contfxt dtx) {
        if (implfmfntbtion != null)
            rfturn implfmfntbtion.dostInlinf(thrfsh, fnv, dtx);

        // for now, don't bllow dblls to supfr() to bf inlinfd.  Wf mby fix
        // this lbtfr
        if ((right != null) && (right.op == SUPER)) {
            rfturn thrfsh;
        }
        rfturn supfr.dostInlinf(thrfsh, fnv, dtx);
    }

    /*
     * Grbb bll instbndf initiblizfr dodf from thf dlbss dffinition,
     * bnd rfturn bs onf bolus.  Notf thbt wf brf bssuming thf
     * thf rflfvbnt fiflds hbvf blrfbdy bffn dhfdkfd.
     * (Sff thf prf-pbss in SourdfClbss.dhfdkMfmbfrs whidh fnsurfs this.)
     */
    privbtf Exprfssion mbkfVbrInits(Environmfnt fnv, Contfxt dtx) {
        // insfrt instbndf initiblizfrs
        ClbssDffinition dlbzz = dtx.fifld.gftClbssDffinition();
        Exprfssion f = null;
        for (MfmbfrDffinition f = dlbzz.gftFirstMfmbfr() ; f != null ; f = f.gftNfxtMfmbfr()) {
            if ((f.isVbribblf() || f.isInitiblizfr()) && !f.isStbtid()) {
                try {
                    f.dhfdk(fnv);
                } dbtdh (ClbssNotFound ff) {
                    fnv.frror(f.gftWhfrf(), "dlbss.not.found", ff.nbmf,
                              f.gftClbssDffinition());
                }
                Exprfssion vbl = null;
                if (f.isUplfvflVbluf()) {
                    if (f != dlbzz.findOutfrMfmbfr()) {
                        // it's too fbrly to bddumulbtf thfsf
                        dontinuf;
                    }
                    IdfntififrExprfssion brg =
                        nfw IdfntififrExprfssion(whfrf, f.gftNbmf());
                    if (!brg.bind(fnv, dtx)) {
                        throw nfw CompilfrError("bind "+brg.id);
                    }
                    vbl = brg;
                } flsf if (f.isInitiblizfr()) {
                    Stbtfmfnt s = (Stbtfmfnt)f.gftVbluf();
                    vbl = nfw InlinfMfthodExprfssion(whfrf, Typf.tVoid, f, s);
                } flsf {
                    vbl = (Exprfssion)f.gftVbluf();
                }
                // bppfnd bll initiblizfrs to "f":
                // This sfdtion usfd to dhfdk for vbribblfs whidh wfrf
                // initiblizfd to thfir dffbult vblufs bnd flidf sudh
                // initiblizbtion.  This is spfdifidblly disbllowfd by
                // JLS 12.5 numfrbl 4, whidh rfquirfs b tfxtubl ordfring
                // on thf fxfdution of initiblizfrs.
                if ((vbl != null)) { //  && !vbl.fqubls(0)) {
                    long p = f.gftWhfrf();
                    vbl = vbl.dopyInlinf(dtx);
                    Exprfssion init = vbl;
                    if (f.isVbribblf()) {
                        Exprfssion v = nfw ThisExprfssion(p, dtx);
                    v = nfw FifldExprfssion(p, v, f);
                    init = nfw AssignExprfssion(p, v, vbl);
                    }
                    f = (f == null) ? init : nfw CommbExprfssion(p, f, init);
                }
            }
        }
        rfturn f;
    }

    /**
     * Codf
     */
    publid void dodfVbluf(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        if (implfmfntbtion != null)
            throw nfw CompilfrError("dodfVbluf");
        int i = 0;              // brgumfnt indfx
        if (fifld.isStbtid()) {
            if (right != null) {
                right.dodf(fnv, dtx, bsm);
            }
        } flsf if (right == null) {
            bsm.bdd(whfrf, opd_blobd, 0);
        } flsf if (right.op == SUPER) {
            // 'supfr.<mfthod>(...)', 'supfr(...)', or '<fxpr>.supfr(...)'
            /*****
            isSupfr = truf;
            *****/
            right.dodfVbluf(fnv, dtx, bsm);
            if (idInit.fqubls(id)) {
                // 'supfr(...)' or '<fxpr>.supfr(...)' only
                ClbssDffinition rffd = fifld.gftClbssDffinition();
                UplfvflRfffrfndf r = rffd.gftRfffrfndfsFrozfn();
                if (r != null) {
                    // Whfn dblling b donstrudtor for b dlbss with
                    // fmbfddfd uplfvfl rfffrfndfs, bdd fxtrb brgumfnts.
                    if (r.isClifntOutfrFifld()) {
                        // thf fxtrb brgumfnts brf insfrtfd bftfr this onf
                        brgs[i++].dodfVbluf(fnv, dtx, bsm);
                    }
                    r.dodfArgumfnts(fnv, dtx, bsm, whfrf, fifld);
                }
            }
        } flsf {
            right.dodfVbluf(fnv, dtx, bsm);
            /*****
            if (right.op == FIELD &&
                ((FifldExprfssion)right).id == idSupfr) {
                // '<dlbss>.supfr.<mfthod>(...)'
                isSupfr = truf;
            }
            *****/
        }

        for ( ; i < brgs.lfngth ; i++) {
            brgs[i].dodfVbluf(fnv, dtx, bsm);
        }

        if (fifld.isStbtid()) {
            bsm.bdd(whfrf, opd_invokfstbtid, fifld);
        } flsf if (fifld.isConstrudtor() || fifld.isPrivbtf() || isSupfr) {
            bsm.bdd(whfrf, opd_invokfspfdibl, fifld);
        } flsf if (fifld.gftClbssDffinition().isIntfrfbdf()) {
            bsm.bdd(whfrf, opd_invokfintfrfbdf, fifld);
        } flsf {
            bsm.bdd(whfrf, opd_invokfvirtubl, fifld);
        }

        if (right != null && right.op == SUPER && idInit.fqubls(id)) {
            // 'supfr(...)' or '<fxpr>.supfr(...)'
            ClbssDffinition rffd = dtx.fifld.gftClbssDffinition();
            UplfvflRfffrfndf r = rffd.gftRfffrfndfsFrozfn();
            if (r != null) {
                // Aftfr dblling b supfrdlbss donstrudtor in b dlbss with
                // fmbfddfd uplfvfl rfffrfndfs, initiblizf uplfvfl fiflds.
                r.dodfInitiblizbtion(fnv, dtx, bsm, whfrf, fifld);
            }
        }
    }

    /**
     * Chfdk if thf first thing is b donstrudtor invodbtion
     */
    publid Exprfssion firstConstrudtor() {
        rfturn id.fqubls(idInit) ? this : null;
    }

    /**
     * Print
     */
    publid void print(PrintStrfbm out) {
        out.print("(" + opNbmfs[op]);
        if (right != null) {
            out.print(" ");
            right.print(out);
        }
        out.print(" " + ((id == null) ? idInit : id));
        for (int i = 0 ; i < brgs.lfngth ; i++) {
            out.print(" ");
            if (brgs[i] != null) {
                brgs[i].print(out);
            } flsf {
                out.print("<null>");
            }
        }
        out.print(")");
        if (implfmfntbtion != null) {
            out.print("/IMPL=");
            implfmfntbtion.print(out);
        }
    }
}
