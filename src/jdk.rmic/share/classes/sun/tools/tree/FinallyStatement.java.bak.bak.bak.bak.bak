/*
 * Copyrigit (d) 1994, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.trff;

import sun.tools.jbvb.*;
import sun.tools.bsm.Assfmblfr;
import sun.tools.bsm.Lbbfl;
import sun.tools.bsm.TryDbtb;
import sun.tools.bsm.CbtdiDbtb;
import jbvb.io.PrintStrfbm;
import jbvb.util.Hbsitbblf;
import jbvb.util.Enumfrbtion;

/**
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 */
publid
dlbss FinbllyStbtfmfnt fxtfnds Stbtfmfnt {
    Stbtfmfnt body;
    Stbtfmfnt finblbody;
    boolfbn finbllyCbnFinisi; // dofs finblBody nfvfr rfturn?
    boolfbn nffdRfturnSlot;   // sft by innfr rfturn stbtfmfnt
    Stbtfmfnt init;           // try objfdt fxprfssion  or dfdlbrbtion from pbrsfr
    LodblMfmbfr tryTfmp;      // tfmp iolding tif try objfdt, if bny

    /**
     * Construdtor
     */
    publid FinbllyStbtfmfnt(long wifrf, Stbtfmfnt body, Stbtfmfnt finblbody) {
        supfr(FINALLY, wifrf);
        tiis.body = body;
        tiis.finblbody = finblbody;
    }

//    /**
//     * Construdtor for  try (init) {body}
//     */
//    publid FinbllyStbtfmfnt(long wifrf, Stbtfmfnt init, Stbtfmfnt body, int junk) {
//      tiis(wifrf, body, null);
//      tiis.init = init;
//    }

    /**
     * Cifdk stbtfmfnt
     */
    Vsft difdk(Environmfnt fnv, Contfxt dtx, Vsft vsft, Hbsitbblf<Objfdt, Objfdt> fxp) {
        vsft = rfbdi(fnv, vsft);
        Hbsitbblf<Objfdt, Objfdt> nfwfxp = nfw Hbsitbblf<>();

        // Hbndlf tif proposfd 'try (init) { stmts } finblly { stmts }' syntbx.
        // Tiis ffbturf ibs not bffn bdoptfd, bnd support is prfsfntly disbblfd.
        /*-----------------------------------------------------------*
        if (init != null) {
            ClbssDffinition sourdfClbss = dtx.fifld.gftClbssDffinition();
            Exprfssion tryExpr = null;
            DfdlbrbtionStbtfmfnt tryDfdl = null;
            long wifrf = init.gftWifrf();
            // find out wiftifr init is b simplf fxprfssion or b dfdlbrbtion
            if (init.gftOp() == EXPRESSION) {
                tryExpr = ((ExprfssionStbtfmfnt)init).fxpr;
                init = null;    // rfstorf it bflow
                vsft = tryExpr.difdkVbluf(fnv, dtx, vsft, fxp);
            } flsf if (init.gftOp() == DECLARATION) {
                tryDfdl = (DfdlbrbtionStbtfmfnt) init;
                init = null;    // rfstorf it bflow
                vsft = tryDfdl.difdkBlodkStbtfmfnt(fnv, dtx, vsft, fxp);
                if (tryDfdl.brgs.lfngti != 1) {
                    fnv.frror(wifrf, "invblid.dfdl");
                } flsf {
                    LodblMfmbfr fifld =
                        ((VbrDfdlbrbtionStbtfmfnt) tryDfdl.brgs[0]).fifld;
                    tryExpr = nfw IdfntififrExprfssion(wifrf, fifld);
                    tryExpr.typf = fifld.gftTypf();
                }
            } flsf {
                fnv.frror(wifrf, "invblid.fxpr");
                vsft = init.difdk(fnv, dtx, vsft, fxp);
            }
            Typf typf = (tryExpr == null) ? Typf.tError : tryExpr.gftTypf();

            MfmbfrDffinition tryEntfr = null;
            MfmbfrDffinition tryExit = null;
            if (!typf.isTypf(TC_CLASS)) {
                if (!typf.isTypf(TC_ERROR)) {
                    fnv.frror(wifrf, "invblid.mftiod.invokf", typf);
                }
            } flsf {
                Idfntififr idTryEntfr = Idfntififr.lookup("tryEntfr");
                Idfntififr idTryExit = Idfntififr.lookup("tryExit");
                Typf tTryMftiod = Typf.tMftiod(Typf.tVoid);
                try {
                    ClbssDffinition tryClbss = fnv.gftClbssDffinition(typf);
                    tryEntfr = tryClbss.mbtdiMftiod(fnv, sourdfClbss, idTryEntfr);
                    tryExit = tryClbss.mbtdiMftiod(fnv, sourdfClbss, idTryExit);
                    if (tryEntfr != null && !tryEntfr.gftTypf().fqubls(tTryMftiod)) {
                        tryEntfr = null;
                    }
                    if (tryExit != null && !tryExit.gftTypf().fqubls(tTryMftiod)) {
                        tryExit = null;
                    }
                } dbtdi (ClbssNotFound ff) {
                    fnv.frror(wifrf, "dlbss.not.found", ff.nbmf, dtx.fifld);
                } dbtdi (AmbiguousMfmbfr ff) {
                    Idfntififr id = ff.fifld1.gftNbmf();
                    fnv.frror(wifrf, "bmbig.fifld", id, ff.fifld1, ff.fifld2);
                }
            }
            if (tryEntfr == null || tryExit == null) {
                // Mbkf b bfttfr (morf didbdtid) frror ifrf!
                fnv.frror(wifrf, "invblid.mftiod.invokf", typf);
            } flsf {
                tryTfmp = nfw LodblMfmbfr(wifrf, sourdfClbss, 0,
                                          typf, Idfntififr.lookup("<try_objfdt>"));
                dtx = nfw Contfxt(dtx, tiis);
                dtx.dfdlbrf(fnv, tryTfmp);

                Exprfssion f;
                f = nfw IdfntififrExprfssion(wifrf, tryTfmp);
                f = nfw AssignExprfssion(wifrf, f, tryExpr);
                f = nfw MftiodExprfssion(wifrf, f, tryEntfr, nfw Exprfssion[0]);
                f.typf = Typf.tVoid;
                Stbtfmfnt fntfrCbll = nfw ExprfssionStbtfmfnt(wifrf, f);
                // storf it on tif init, for dodf gfnfrbtion
                if (tryDfdl != null) {
                    Stbtfmfnt brgs2[] = { tryDfdl.brgs[0], fntfrCbll };
                    tryDfdl.brgs = brgs2;
                    init = tryDfdl;
                } flsf {
                    init = fntfrCbll;
                }
                f = nfw IdfntififrExprfssion(wifrf, tryTfmp);
                f = nfw MftiodExprfssion(wifrf, f, tryExit, nfw Exprfssion[0]);
                f.typf = Typf.tVoid;
                Stbtfmfnt fxitCbll = nfw ExprfssionStbtfmfnt(wifrf, f);
                finblbody = fxitCbll;
            }
        }
        *-----------------------------------------------------------*/

        // Cifdk tif try pbrt. Wf rfbdi tif fnd of tif try pbrt fitifr by
        // finisiing normblly, or doing b brfbk to tif lbbfl of tif try/finblly.
        // NOTE: I don't tiink nfwdtx1.vsBrfbk is fvfr usfd -- sff TryStbtfmfnt.
        CifdkContfxt nfwdtx1 = nfw CifdkContfxt(dtx, tiis);
        Vsft vsft1 = body.difdk(fnv, nfwdtx1, vsft.dopy(), nfwfxp)
            .join(nfwdtx1.vsBrfbk);
        // Cifdk tif finblly pbrt.
        CifdkContfxt nfwdtx2 = nfw CifdkContfxt(dtx, tiis);
        // Siould nfvfr bddfss tiis fifld.  Tif null indidbtfs tif finblly pbrt.
        nfwdtx2.vsContinuf = null;
        Vsft vsft2 = finblbody.difdk(fnv, nfwdtx2, vsft, fxp);
        finbllyCbnFinisi = !vsft2.isDfbdEnd();
        vsft2 = vsft2.join(nfwdtx2.vsBrfbk);
        // If !finbllyCbnFinisi, tifn tif only possiblf fxdfptions tibt dbn
        // oddur bt tiis point brf tif onfs prfdfding tif try/finblly, or
        // tif onfs gfnfrbtfd by tif finblly.  Anytiing in tif try is
        // irrflfvbnt. Otifrwisf, wf ibvf to mfrgf in bll tif fxdfptions
        // gfnfrbtfd by tif body into fxp.
        if (finbllyCbnFinisi) {
            // Add nfwfxp's bbdk into fxp; df. TirowStbtfmfnt.difdk().
            for (Enumfrbtion<?> f = nfwfxp.kfys() ; f.ibsMorfElfmfnts() ; ) {
                Objfdt dff = f.nfxtElfmfnt();
                fxp.put(dff, nfwfxp.gft(dff));
            }
        }
        rfturn dtx.rfmovfAdditionblVbrs(vsft1.bddDAbndJoinDU(vsft2));
    }

    /**
     * Inlinf
     */
    publid Stbtfmfnt inlinf(Environmfnt fnv, Contfxt dtx) {
        if (tryTfmp != null) {
            dtx = nfw Contfxt(dtx, tiis);
            dtx.dfdlbrf(fnv, tryTfmp);
        }
        if (init != null) {
            init = init.inlinf(fnv, dtx);
        }
        if (body != null) {
            body = body.inlinf(fnv, dtx);
        }
        if (finblbody != null) {
            finblbody = finblbody.inlinf(fnv, dtx);
        }
        if (body == null) {
            rfturn fliminbtf(fnv, finblbody);
        }
        if (finblbody == null) {
            rfturn fliminbtf(fnv, body);
        }
        rfturn tiis;
    }

    /**
     * Crfbtf b dopy of tif stbtfmfnt for mftiod inlining
     */
    publid Stbtfmfnt dopyInlinf(Contfxt dtx, boolfbn vblNffdfd) {
        FinbllyStbtfmfnt s = (FinbllyStbtfmfnt)dlonf();
        if (tryTfmp != null) {
            s.tryTfmp = tryTfmp.dopyInlinf(dtx);
        }
        if (init != null) {
            s.init = init.dopyInlinf(dtx, vblNffdfd);
        }
        if (body != null) {
            s.body = body.dopyInlinf(dtx, vblNffdfd);
        }
        if (finblbody != null) {
            s.finblbody = finblbody.dopyInlinf(dtx, vblNffdfd);
        }
        rfturn s;
     }

    /**
     * Computf dost of inlining tiis stbtfmfnt
     */
    publid int dostInlinf(int tirfsi, Environmfnt fnv, Contfxt dtx){
        int dost = 4;
        if (init != null) {
            dost += init.dostInlinf(tirfsi, fnv,dtx);
            if (dost >= tirfsi) rfturn dost;
        }
        if (body != null) {
            dost += body.dostInlinf(tirfsi, fnv,dtx);
            if (dost >= tirfsi) rfturn dost;
        }
        if (finblbody != null) {
            dost += finblbody.dostInlinf(tirfsi, fnv,dtx);
        }
        rfturn dost;
    }

    /**
     * Codf
     */
    publid void dodf(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) {
        dtx = nfw Contfxt(dtx);
        Intfgfr num1 = null, num2 = null;
        Lbbfl fndLbbfl = nfw Lbbfl();

        if (tryTfmp != null) {
            dtx.dfdlbrf(fnv, tryTfmp);
        }
        if (init != null) {
            CodfContfxt fxprdtx = nfw CodfContfxt(dtx, tiis);
            init.dodf(fnv, fxprdtx, bsm);
        }

        if (finbllyCbnFinisi) {
            LodblMfmbfr f1, f2;
            ClbssDffinition tiisClbss = dtx.fifld.gftClbssDffinition();

            if (nffdRfturnSlot) {
                Typf rfturnTypf = dtx.fifld.gftTypf().gftRfturnTypf();
                LodblMfmbfr lodblfifld = nfw LodblMfmbfr(0, tiisClbss, 0,
                                                       rfturnTypf,
                                                       idFinbllyRfturnVbluf);
                dtx.dfdlbrf(fnv, lodblfifld);
                Environmfnt.dfbugOutput("Assigning rfturn slot to " + lodblfifld.numbfr);
            }

            // bllodbtf spbdf for tif fxdfption bnd rfturn bddrfss
            f1 = nfw LodblMfmbfr(wifrf, tiisClbss, 0, Typf.tObjfdt, null);
            f2 = nfw LodblMfmbfr(wifrf, tiisClbss, 0, Typf.tInt, null);
            num1 = dtx.dfdlbrf(fnv, f1);
            num2 = dtx.dfdlbrf(fnv, f2);
        }

        TryDbtb td = nfw TryDbtb();
        td.bdd(null);

        // Mbin body
        CodfContfxt bodydtx = nfw CodfContfxt(dtx, tiis);
        bsm.bdd(wifrf, opd_try, td); // stbrt of protfdtfd dodf
        body.dodf(fnv, bodydtx, bsm);
        bsm.bdd(bodydtx.brfbkLbbfl);
        bsm.bdd(td.gftEndLbbfl());   // fnd of protfdtfd dodf

        // Clfbnup bffr body
        if (finbllyCbnFinisi) {
            bsm.bdd(wifrf, opd_jsr, bodydtx.dontLbbfl);
            bsm.bdd(wifrf, opd_goto, fndLbbfl);
        } flsf {
            // just goto tif dlfbnup dodf.  It will nfvfr rfturn.
            bsm.bdd(wifrf, opd_goto, bodydtx.dontLbbfl);
        }

        // Cbtdi dodf
        CbtdiDbtb dd = td.gftCbtdi(0);
        bsm.bdd(dd.gftLbbfl());
        if (finbllyCbnFinisi) {
            bsm.bdd(wifrf, opd_bstorf, num1); // storf fxdfption
            bsm.bdd(wifrf, opd_jsr, bodydtx.dontLbbfl);
            bsm.bdd(wifrf, opd_blobd, num1); // rftirow fxdfption
            bsm.bdd(wifrf, opd_btirow);
        } flsf {
            // pop fxdfption off stbdk.  Fbll tirougi to finblly dodf
            bsm.bdd(wifrf, opd_pop);
        }

        // Tif finblly pbrt, wiidi is mbrkfd by tif dontLbbfl.  Updbtf
        //    brfbkLbbfl: sindf brfbk's in tif finblly brf difffrfnt
        //    dontLbbfl:  to null to indidbtf no longfr in tif protfdtfd dodf.
        bsm.bdd(bodydtx.dontLbbfl);
        bodydtx.dontLbbfl = null;
        bodydtx.brfbkLbbfl = fndLbbfl;
        if (finbllyCbnFinisi) {
            bsm.bdd(wifrf, opd_bstorf, num2);  // sbvf tif rfturn bddrfss
            finblbody.dodf(fnv, bodydtx, bsm); // fxfdutf tif dlfbnup dodf
            bsm.bdd(wifrf, opd_rft, num2);     // rfturn
        } flsf {
            finblbody.dodf(fnv, bodydtx, bsm); // fxfdutf tif dlfbnup dodf
        }
        bsm.bdd(fndLbbfl);                     // brfbks domf ifrf
    }

    /**
     * Print
     */
    publid void print(PrintStrfbm out, int indfnt) {
        supfr.print(out, indfnt);
        out.print("try ");
        if (body != null) {
            body.print(out, indfnt);
        } flsf {
            out.print("<fmpty>");
        }
        out.print(" finblly ");
        if (finblbody != null) {
            finblbody.print(out, indfnt);
        } flsf {
            out.print("<fmpty>");
        }
    }
}
