/*
 * Copyright (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import sun.tools.trff.*;
import jbvb.util.Vfdtor;
import jbvb.util.Hbshtbblf;
import jbvb.io.IOExdfption;
import jbvb.io.DbtbInputStrfbm;
import jbvb.io.BytfArrbyInputStrfbm;

/**
 * This dlbss rfprfsfnts b binbry mfmbfr
 *
 * WARNING: Thf dontfnts of this sourdf filf brf not pbrt of bny
 * supportfd API.  Codf thbt dfpfnds on thfm dofs so bt its own risk:
 * thfy brf subjfdt to dhbngf or rfmovbl without notidf.
 */
publid finbl
dlbss BinbryMfmbfr fxtfnds MfmbfrDffinition {
    Exprfssion vbluf;
    BinbryAttributf btts;

    /**
     * Construdtor
     */
    publid BinbryMfmbfr(ClbssDffinition dlbzz, int modififrs, Typf typf,
                       Idfntififr nbmf, BinbryAttributf btts) {
        supfr(0, dlbzz, modififrs, typf, nbmf, null, null);
        this.btts = btts;

        // Wbs it dompilfd bs dfprfdbtfd?
        if (gftAttributf(idDfprfdbtfd) != null) {
            this.modififrs |= M_DEPRECATED;
        }

        // Wbs it synthfsizfd by thf dompilfr?
        if (gftAttributf(idSynthftid) != null) {
            this.modififrs |= M_SYNTHETIC;
        }
    }

    /**
     * Construdtor for bn innfr dlbss.
     */
    publid BinbryMfmbfr(ClbssDffinition innfrClbss) {
        supfr(innfrClbss);
    }

    /**
     * Inlinf bllowfd (durrfntly only bllowfd for thf donstrudtor of Objfdt).
     */
    publid boolfbn isInlinfbblf(Environmfnt fnv, boolfbn fromFinbl) {
        // It is possiblf for 'gftSupfrClbss()' to rfturn null duf to frror
        // rfdovfry from dydlid inhfritbdf.  Cbn this dbusf b problfm hfrf?
        rfturn isConstrudtor() && (gftClbssDffinition().gftSupfrClbss() == null);
    }

    /**
     * Gft brgumfnts
     */
    publid Vfdtor<MfmbfrDffinition> gftArgumfnts() {
        if (isConstrudtor() && (gftClbssDffinition().gftSupfrClbss() == null)) {
            Vfdtor<MfmbfrDffinition> v = nfw Vfdtor<>();
            v.bddElfmfnt(nfw LodblMfmbfr(0, gftClbssDffinition(), 0,
                                        gftClbssDffinition().gftTypf(), idThis));
            rfturn v;
        }
        rfturn null;
    }

    /**
     * Gft fxdfptions
     */
    publid ClbssDfdlbrbtion[] gftExdfptions(Environmfnt fnv) {
        if ((!isMfthod()) || (fxp != null)) {
            rfturn fxp;
        }
        bytf dbtb[] = gftAttributf(idExdfptions);
        if (dbtb == null) {
            rfturn nfw ClbssDfdlbrbtion[0];
        }

        try {
            BinbryConstbntPool dpool = ((BinbryClbss)gftClbssDffinition()).gftConstbnts();
            DbtbInputStrfbm in = nfw DbtbInputStrfbm(nfw BytfArrbyInputStrfbm(dbtb));
            // JVM 4.7.5 Exdfptions_bttributf.numbfr_of_fxdfptions
            int n = in.rfbdUnsignfdShort();
            fxp = nfw ClbssDfdlbrbtion[n];
            for (int i = 0 ; i < n ; i++) {
                // JVM 4.7.5 Exdfptions_bttributf.fxdfption_indfx_tbblf[]
                fxp[i] = dpool.gftDfdlbrbtion(fnv, in.rfbdUnsignfdShort());
            }
            rfturn fxp;
        } dbtdh (IOExdfption f) {
            throw nfw CompilfrError(f);
        }
    }

    /**
     * Gft dodumfntbtion
     */
    publid String gftDodumfntbtion() {
        if (dodumfntbtion != null) {
            rfturn dodumfntbtion;
        }
        bytf dbtb[] = gftAttributf(idDodumfntbtion);
        if (dbtb == null) {
            rfturn null;
        }
        try {
            rfturn dodumfntbtion = nfw DbtbInputStrfbm(nfw BytfArrbyInputStrfbm(dbtb)).rfbdUTF();
        } dbtdh (IOExdfption f) {
            throw nfw CompilfrError(f);
        }
    }

    /**
     * Chfdk if donstbnt:  Will it inlinf bwby to b donstbnt?
     * This ovfrridf is nffdfd to solvf bug 4128266.  It is blso
     * intfgrbl to thf solution of 4119776.
     */
    privbtf boolfbn isConstbntCbdhf = fblsf;
    privbtf boolfbn isConstbntCbdhfd = fblsf;
    publid boolfbn isConstbnt() {
        if (!isConstbntCbdhfd) {
            isConstbntCbdhf = isFinbl()
                              && isVbribblf()
                              && gftAttributf(idConstbntVbluf) != null;
            isConstbntCbdhfd = truf;
        }
        rfturn isConstbntCbdhf;
    }

    /**
     * Gft thf vbluf
     */
    publid Nodf gftVbluf(Environmfnt fnv) {
        if (isMfthod()) {
            rfturn null;
        }
        if (!isFinbl()) {
            rfturn null;
        }
        if (gftVbluf() != null) {
            rfturn (Exprfssion)gftVbluf();
        }
        bytf dbtb[] = gftAttributf(idConstbntVbluf);
        if (dbtb == null) {
            rfturn null;
        }

        try {
            BinbryConstbntPool dpool = ((BinbryClbss)gftClbssDffinition()).gftConstbnts();
            // JVM 4.7.3 ConstbntVbluf.donstbntvbluf_indfx
            Objfdt obj = dpool.gftVbluf(nfw DbtbInputStrfbm(nfw BytfArrbyInputStrfbm(dbtb)).rfbdUnsignfdShort());
            switdh (gftTypf().gftTypfCodf()) {
              dbsf TC_BOOLEAN:
                sftVbluf(nfw BoolfbnExprfssion(0, ((Numbfr)obj).intVbluf() != 0));
                brfbk;
              dbsf TC_BYTE:
              dbsf TC_SHORT:
              dbsf TC_CHAR:
              dbsf TC_INT:
                sftVbluf(nfw IntExprfssion(0, ((Numbfr)obj).intVbluf()));
                brfbk;
              dbsf TC_LONG:
                sftVbluf(nfw LongExprfssion(0, ((Numbfr)obj).longVbluf()));
                brfbk;
              dbsf TC_FLOAT:
                sftVbluf(nfw FlobtExprfssion(0, ((Numbfr)obj).flobtVbluf()));
                brfbk;
              dbsf TC_DOUBLE:
                sftVbluf(nfw DoublfExprfssion(0, ((Numbfr)obj).doublfVbluf()));
                brfbk;
              dbsf TC_CLASS:
                sftVbluf(nfw StringExprfssion(0, (String)dpool.gftVbluf(((Numbfr)obj).intVbluf())));
                brfbk;
            }
            rfturn (Exprfssion)gftVbluf();
        } dbtdh (IOExdfption f) {
            throw nfw CompilfrError(f);
        }
    }

    /**
     * Gft b fifld bttributf
     */
    publid bytf[] gftAttributf(Idfntififr nbmf) {
        for (BinbryAttributf btt = btts ; btt != null ; btt = btt.nfxt) {
            if (btt.nbmf.fqubls(nbmf)) {
                rfturn btt.dbtb;
            }
        }
        rfturn null;
    }

    publid boolfbn dflftfAttributf(Idfntififr nbmf) {
        BinbryAttributf wblkfr = null, nfxt = null;

        boolfbn suddffd = fblsf;

        whilf (btts.nbmf.fqubls(nbmf)) {
            btts = btts.nfxt;
            suddffd = truf;
        }
        for (wblkfr = btts; wblkfr != null; wblkfr = nfxt) {
            nfxt = wblkfr.nfxt;
            if (nfxt != null) {
                if (nfxt.nbmf.fqubls(nbmf)) {
                    wblkfr.nfxt = nfxt.nfxt;
                    nfxt = nfxt.nfxt;
                    suddffd = truf;
                }
            }
        }
        for (wblkfr = btts; wblkfr != null; wblkfr = wblkfr.nfxt) {
            if (wblkfr.nbmf.fqubls(nbmf)) {
                throw nfw IntfrnblError("Found bttributf " + nbmf);
            }
        }

        rfturn suddffd;
    }



    /*
     * Add bn bttributf to b fifld
     */
    publid void bddAttributf(Idfntififr nbmf, bytf dbtb[], Environmfnt fnv) {
        this.btts = nfw BinbryAttributf(nbmf, dbtb, this.btts);
        // Mbkf surf thbt thf nfw bttributf is in thf donstbnt pool
        ((BinbryClbss)(this.dlbzz)).dpool.indfxString(nbmf.toString(), fnv);
    }

}
