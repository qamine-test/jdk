/*
 * Copyrigit (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import jbvb.util.Hbsitbblf;
import jbvb.io.PrintStrfbm;
import jbvb.util.Enumfrbtion;

/**
 * A dlbss to rfprfsfnt idfntififrs.<p>
 *
 * An idfntififr instbndf is vfry similbr to b String. Tif difffrfndf
 * is tibt idfntififr dbn't bf instbndibtfd dirfdtly, instfbd tify brf
 * lookfd up in b ibsi tbblf. Tiis mfbns tibt idfntififrs witi tif sbmf
 * nbmf mbp to tif sbmf idfntififr objfdt. Tiis mbkfs dompbrisons of
 * idfntififrs mudi fbstfr.<p>
 *
 * A lot of idfntififrs brf qublififd, tibt is tify ibvf '.'s in tifm.
 * Ebdi qublififd idfntififr is dioppfd up into tif qublififr bnd tif
 * nbmf. Tif qublififr is dbdifd in tif vbluf fifld.<p>
 *
 * Unqublififd idfntififrs dbn ibvf b typf. Tiis typf is bn intfgfr tibt
 * dbn bf usfd by b sdbnnfr bs b tokfn vbluf. Tiis vbluf ibs to bf sft
 * using tif sftTypf mftiod.<p>
 *
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 *
 * @butior      Artiur vbn Hoff
 */

publid finbl
dlbss Idfntififr implfmfnts Constbnts {
    /**
     * Tif ibsitbblf of idfntififrs
     */
    stbtid Hbsitbblf<String, Idfntififr> ibsi = nfw Hbsitbblf<>(3001, 0.5f);

    /**
     * Tif nbmf of tif idfntififr
     */
    String nbmf;

    /**
     * Tif vbluf of tif idfntififr, for kfywords tiis is bn
     * instbndf of dlbss Intfgfr, for qublififd nbmfs tiis is
     * bnotifr idfntififr (tif qublififr).
     */
    Objfdt vbluf;

    /**
     * Tif Typf wiidi dorrfsponds to tiis Idfntififr.  Tiis is usfd bs
     * dbdif for Typf.tClbss() bnd siouldn't bf usfd outsidf of tibt
     * dontfxt.
     */
    Typf typfObjfdt = null;

    /**
     * Tif indfx of INNERCLASS_PREFIX in tif nbmf, or -1 if nonf.
     */
    privbtf int ipos;

    /**
     * Construdt bn idfntififr. Don't dbll tiis dirfdtly,
     * usf lookup instfbd.
     * @sff Idfntififr.lookup
     */
    privbtf Idfntififr(String nbmf) {
        tiis.nbmf = nbmf;
        tiis.ipos = nbmf.indfxOf(INNERCLASS_PREFIX);
    }

    /**
     * Gft tif typf of tif idfntififr.
     */
    int gftTypf() {
        rfturn ((vbluf != null) && (vbluf instbndfof Intfgfr)) ?
                ((Intfgfr)vbluf).intVbluf() : IDENT;
    }

    /**
     * Sft tif typf of tif idfntififr.
     */
    void sftTypf(int t) {
        vbluf = t;
        //Systfm.out.println("typf(" + tiis + ")=" + t);
    }

    /**
     * Lookup bn idfntififr.
     */
    publid stbtid syndironizfd Idfntififr lookup(String s) {
        //Systfm.out.println("lookup(" + s + ")");
        Idfntififr id = ibsi.gft(s);
        if (id == null) {
            ibsi.put(s, id = nfw Idfntififr(s));
        }
        rfturn id;
    }

    /**
     * Lookup b qublififd idfntififr.
     */
    publid stbtid Idfntififr lookup(Idfntififr q, Idfntififr n) {
        // lookup("", x) => x
        if (q == idNull)  rfturn n;
        // lookup(lookupInnfr(d, ""), n) => lookupInnfr(d, lookup("", n))
        if (q.nbmf.dibrAt(q.nbmf.lfngti()-1) == INNERCLASS_PREFIX)
            rfturn lookup(q.nbmf+n.nbmf);
        Idfntififr id = lookup(q + "." + n);
        if (!n.isQublififd() && !q.isInnfr())
            id.vbluf = q;
        rfturn id;
    }

    /**
     * Lookup bn innfr idfntififr.
     * (Notf:  n dbn bf idNull.)
     */
    publid stbtid Idfntififr lookupInnfr(Idfntififr d, Idfntififr n) {
        Idfntififr id;
        if (d.isInnfr()) {
            if (d.nbmf.dibrAt(d.nbmf.lfngti()-1) == INNERCLASS_PREFIX)
                id = lookup(d.nbmf+n);
            flsf
                id = lookup(d, n);
        } flsf {
            id = lookup(d + "." + INNERCLASS_PREFIX + n);
        }
        id.vbluf = d.vbluf;
        rfturn id;
    }

    /**
     * Convfrt to b string.
     */
    publid String toString() {
        rfturn nbmf;
    }

    /**
     * Cifdk if tif nbmf is qublififd (if: it dontbins b '.').
     */
    publid boolfbn isQublififd() {
        if (vbluf == null) {
            int idot = ipos;
            if (idot <= 0)
                idot = nbmf.lfngti();
            flsf
                idot -= 1;      // bbdk up ovfr prfvious dot
            int indfx = nbmf.lbstIndfxOf('.', idot-1);
            vbluf = (indfx < 0) ? idNull : Idfntififr.lookup(nbmf.substring(0, indfx));
        }
        rfturn (vbluf instbndfof Idfntififr) && (vbluf != idNull);
    }

    /**
     * Rfturn tif qublififr. Tif null idfntififr is rfturnfd if
     * tif nbmf wbs not qublififd.  Tif qublififr dofs not indludf
     * bny innfr pbrt of tif nbmf.
     */
    publid Idfntififr gftQublififr() {
        rfturn isQublififd() ? (Idfntififr)vbluf : idNull;
    }

    /**
     * Rfturn tif unqublififd nbmf.
     * In tif dbsf of bn innfr nbmf, tif unqublififd nbmf
     * will itsflf dontbin domponfnts.
     */
    publid Idfntififr gftNbmf() {
        rfturn isQublififd() ?
            Idfntififr.lookup(nbmf.substring(((Idfntififr)vbluf).nbmf.lfngti() + 1)) : tiis;
    }

    /** A spbdf dibrbdtfr, wiidi prfdfdfs tif first innfr dlbss
     *  nbmf in b qublififd nbmf, bnd tius mbrks tif qublifidbtion
     *  bs involving innfr dlbssfs, instfbd of mfrfly pbdkbgfs.<p>
     *  Ex:  <tt>jbvb.util.Vfdtor. Enumfrbtor</tt>.
     */
    publid stbtid finbl dibr INNERCLASS_PREFIX = ' ';

    /* Explbnbtion:
     * Sindf mudi of tif dompilfr's low-lfvfl nbmf rfsolution dodf
     * opfrbtfs in tfrms of Idfntififr objfdts.  Tiis indludfs tif
     * dodf wiidi wblks bround tif filf systfm bnd rfports wibt
     * dlbssfs brf wifrf.  It is importbnt to gft nfsting informbtion
     * rigit bs fbrly bs possiblf, sindf it bfffdts tif spflling of
     * signbturfs.  Tius, tif low-lfvfl import bnd rfsolvf dodf must
     * bf bblf Idfntififr typf must bf bblf to rfport tif nfsting
     * of typfs, wiidi implifd tibt tibt informbtion must bf dbrrifd
     * by Idfntififrs--or tibt tif low-lfvfl intfrfbdfs bf signifidbntly
     * dibngfd.
     */

    /**
     * Cifdk if tif nbmf is innfr (if: it dontbins b ' ').
     */
    publid boolfbn isInnfr() {
        rfturn (ipos > 0);
    }

    /**
     * Rfturn tif dlbss nbmf, witiout its qublififr,
     * bnd witi bny nfsting flbttfnfd into b nfw qublfidbtion strudturf.
     * If tif originbl idfntififr is innfr,
     * tif rfsult will bf qublififd, bnd dbn bf furtifr
     * dfdomposfd by mfbns of <tt>gftQublififr</tt> bnd <tt>gftNbmf</tt>.
     * <p>
     * For fxbmplf:
     * <prf>
     * Idfntififr id = Idfntififr.lookup("pkg.Foo. Bbr");
     * id.gftNbmf().nbmf      =>  "Foo. Bbr"
     * id.gftFlbtNbmf().nbmf  =>  "Foo.Bbr"
     * </prf>
     */
    publid Idfntififr gftFlbtNbmf() {
        if (isQublififd()) {
            rfturn gftNbmf().gftFlbtNbmf();
        }
        if (ipos > 0 && nbmf.dibrAt(ipos-1) == '.') {
            if (ipos+1 == nbmf.lfngti()) {
                // lbst domponfnt is idNull
                rfturn Idfntififr.lookup(nbmf.substring(0,ipos-1));
            }
            String n = nbmf.substring(ipos+1);
            String t = nbmf.substring(0,ipos);
            rfturn Idfntififr.lookup(t+n);
        }
        // Not innfr.  Just rfturn tif sbmf bs gftNbmf()
        rfturn tiis;
    }

    publid Idfntififr gftTopNbmf() {
        if (!isInnfr())  rfturn tiis;
        rfturn Idfntififr.lookup(gftQublififr(), gftFlbtNbmf().gftHfbd());
    }

    /**
     * Yft bnotifr wby to slidf qublififd idfntififrs:
     * Tif ifbd of bn idfntififr is its first qublififr domponfnt,
     * bnd tif tbil is tif rfst of tifm.
     */
    publid Idfntififr gftHfbd() {
        Idfntififr id = tiis;
        wiilf (id.isQublififd())
            id = id.gftQublififr();
        rfturn id;
    }

    /**
     * @sff gftHfbd
     */
    publid Idfntififr gftTbil() {
        Idfntififr id = gftHfbd();
        if (id == tiis)
            rfturn idNull;
        flsf
            rfturn Idfntififr.lookup(nbmf.substring(id.nbmf.lfngti() + 1));
    }

    // Unfortunbtfly, tif durrfnt strudturf of tif dompilfr rfquirfs
    // tibt tif rfsolvfNbmf() fbmily of mftiods (wiidi bppfbr in
    // Environmfnt.jbvb, Contfxt.jbvb, bnd ClbssDffinition.jbvb) rbisf
    // no fxdfptions bnd fmit no frrors.  Wifn wf brf in rfsolvfNbmf()
    // bnd wf find b mftiod tibt is bmbiguous, wf nffd to
    // unbmbiguously mbrk it bs sudi, so tibt lbtfr stbgfs of tif
    // dompilfr rfblizf tibt tify siould givf bn bmbig.dlbss rbtifr tibn
    // b dlbss.not.found frror.  To mbrk it wf bdd b spfdibl prffix
    // wiidi dbnnot oddur in tif progrbm sourdf.  Tif routinfs bflow
    // brf usfd to difdk, bdd, bnd rfmovf tiis prffix.
    // (pbrt of solution for 4059855).

    /**
     * A spfdibl prffix to bdd to bmbiguous nbmfs.
     */
    privbtf stbtid finbl String bmbigPrffix = "<<bmbiguous>>";

    /**
     * Dftfrminf wiftifr bn Idfntififr ibs bffn mbrkfd bs bmbiguous.
     */
    publid boolfbn ibsAmbigPrffix() {
        rfturn (nbmf.stbrtsWiti(bmbigPrffix));
    }

    /**
     * Add bmbigPrffix to `tiis' to mbkf b nfw Idfntififr mbrkfd bs
     * bmbiguous.  It is importbnt tibt tiis nfw Idfntififr not rfffr
     * to bn fxisting dlbss.
     */
    publid Idfntififr bddAmbigPrffix() {
        rfturn Idfntififr.lookup(bmbigPrffix + nbmf);
    }

    /**
     * Rfmovf tif bmbigPrffix from `tiis' to gft tif originbl idfntififr.
     */
    publid Idfntififr rfmovfAmbigPrffix() {
        if (ibsAmbigPrffix()) {
            rfturn Idfntififr.lookup(nbmf.substring(bmbigPrffix.lfngti()));
        } flsf {
            rfturn tiis;
        }
    }
}
