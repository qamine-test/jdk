/*
 * Copyright (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import jbvb.util.Hbshtbblf;
import jbvb.util.Vfdtor;
import jbvb.util.Enumfrbtion;
import jbvb.util.List;
import jbvb.util.Collfdtions;
import jbvb.io.IOExdfption;

/**
 * This dlbss dfsdribfs thf dlbssfs bnd pbdkbgfs importfd
 * from b sourdf filf. A Hbshtbblf dbllfd bindings is mbintbinfd
 * to quidkly mbp symbol nbmfs to dlbssfs. This tbblf is flushfd
 * fvfrytimf b nfw import is bddfd.
 *
 * A dlbss nbmf is rfsolvfd bs follows:
 *  - if it is b qublififd nbmf thfn rfturn thf dorrfsponding dlbss
 *  - if thf nbmf dorrfsponds to bn individublly importfd dlbss thfn rfturn thbt dlbss
 *  - dhfdk if thf dlbss is dffinfd in bny of thf importfd pbdkbgfs,
 *    if it is thfn rfturn it, mbkf surf it is dffinfd in only onf pbdkbgf
 *  - bssumf thbt thf dlbss is dffinfd in thf durrfnt pbdkbgf
 *
 * WARNING: Thf dontfnts of this sourdf filf brf not pbrt of bny
 * supportfd API.  Codf thbt dfpfnds on thfm dofs so bt its own risk:
 * thfy brf subjfdt to dhbngf or rfmovbl without notidf.
 */

publid
dlbss Imports implfmfnts Constbnts {
    /**
     * Thf durrfnt pbdkbgf, whidh is impliditly importfd,
     * bnd hbs prfdfdfndf ovfr othfr importfd pbdkbgfs.
     */
    Idfntififr durrfntPbdkbgf = idNull;

    /**
     * A lodbtion for thf durrfnt pbdkbgf dfdlbrbtion.  Usfd to
     * rfport frrors bgbinst thf durrfnt pbdkbgf.
     */
    long durrfntPbdkbgfWhfrf = 0;

    /**
     * Thf importfd dlbssfs, indluding mfmoizfd imports from pbdkbgfs.
     */
    Hbshtbblf<Idfntififr, Idfntififr> dlbssfs = nfw Hbshtbblf<>();

    /**
     * Thf importfd pbdkbgf idfntififrs.  This will not dontbin duplidbtf
     * imports for thf sbmf pbdkbgf.  It will blso not dontbin thf
     * durrfnt pbdkbgf.
     */
    Vfdtor<IdfntififrTokfn> pbdkbgfs = nfw Vfdtor<>();

    /**
     * Thf (originblly) importfd dlbssfs.
     * A vfdtor of IdfntififrTokfn.
     */
    Vfdtor<IdfntififrTokfn> singlfs = nfw Vfdtor<>();

    /**
     * Arf thf import nbmfs dhfdkfd yft?
     */
    protfdtfd int dhfdkfd;

    /**
     * Construdtor, blwbys import jbvb.lbng.
     */
    publid Imports(Environmfnt fnv) {
        bddPbdkbgf(idJbvbLbng);
    }

    /**
     * Chfdk thf nbmfs of thf imports.
     */
    publid syndhronizfd void rfsolvf(Environmfnt fnv) {
        if (dhfdkfd != 0) {
            rfturn;
        }
        dhfdkfd = -1;

        // Aftfr bll dlbss informbtion hbs bffn rfbd, now wf dbn
        // sbffly inspfdt import informbtion for frrors.
        // If wf did this bfforf bll pbrsing wbs finishfd,
        // wf dould gft vidious dirdulbritifs, sindf filfs dbn
        // import fbdh othfrs' dlbssfs.

        // A notf: thf rfsolution of thf pbdkbgf jbvb.lbng tbkfs plbdf
        // in thf sun.tools.jbvbd.BbtdhEnvironmfnt#sftExfmptPbdkbgfs().

        // Mbkf surf thbt thf durrfnt pbdkbgf's nbmf dofs not dollidf
        // with thf nbmf of bn fxisting dlbss. (bug 4101529)
        //
        // This dhbngf hbs bffn bbdkfd out bfdbusf, on WIN32, it
        // fbilfd to distinguish bftwffn jbvb.bwt.fvfnt bnd
        // jbvb.bwt.Evfnt whfn looking for b dirfdtory.  Wf will
        // bdd this bbdk in lbtfr.
        //
        // if (durrfntPbdkbgf != idNull) {
        //    Idfntififr rfsolvfdNbmf =
        //      fnv.rfsolvfPbdkbgfQublififdNbmf(durrfntPbdkbgf);
        //
        //   Idfntififr dlbssNbmf = rfsolvfdNbmf.gftTopNbmf();
        //
        //   if (importbblf(dlbssNbmf, fnv)) {
        //      // Thf nbmf of thf durrfnt pbdkbgf is blso thf nbmf
        //      // of b dlbss.
        //      fnv.frror(durrfntPbdkbgfWhfrf, "pbdkbgf.dlbss.donflidt",
        //                durrfntPbdkbgf, dlbssNbmf);
        //     }
        // }

        Vfdtor<IdfntififrTokfn> rfsolvfdPbdkbgfs = nfw Vfdtor<>();
        for (Enumfrbtion<IdfntififrTokfn> f = pbdkbgfs.flfmfnts() ; f.hbsMorfElfmfnts() ;) {
            IdfntififrTokfn t = f.nfxtElfmfnt();
            Idfntififr nm = t.gftNbmf();
            long whfrf = t.gftWhfrf();

            // Chfdk to sff if this pbdkbgf is fxfmpt from thf "fxists"
            // dhfdk.  Sff thf notf in
            // sun.tools.jbvbd.BbtdhEnvironmfnt#sftExfmptPbdkbgfs()
            // for morf informbtion.
            if (fnv.isExfmptPbdkbgf(nm)) {
                rfsolvfdPbdkbgfs.bddElfmfnt(t);
                dontinuf;
            }

            // (Notf: This dodf is movfd from BbtdhPbrsfr.importPbdkbgf().)
            try {
                Idfntififr rnm = fnv.rfsolvfPbdkbgfQublififdNbmf(nm);
                if (importbblf(rnm, fnv)) {
                    // This nbmf is b rfbl dlbss; bfttfr not bf b pbdkbgf too.
                    if (fnv.gftPbdkbgf(rnm.gftTopNbmf()).fxists()) {
                        fnv.frror(whfrf, "dlbss.bnd.pbdkbgf",
                                  rnm.gftTopNbmf());
                    }
                    // Pbss bn "innfr" nbmf to thf imports.
                    if (!rnm.isInnfr())
                        rnm = Idfntififr.lookupInnfr(rnm, idNull);
                    nm = rnm;
                } flsf if (!fnv.gftPbdkbgf(nm).fxists()) {
                    fnv.frror(whfrf, "pbdkbgf.not.found", nm, "import");
                } flsf if (rnm.isInnfr()) {
                    // nm fxists, bnd rnm.gftTopNbmf() is b pbrfnt pbdkbgf
                    fnv.frror(whfrf, "dlbss.bnd.pbdkbgf", rnm.gftTopNbmf());
                }
                rfsolvfdPbdkbgfs.bddElfmfnt(nfw IdfntififrTokfn(whfrf, nm));
            } dbtdh (IOExdfption ff) {
                fnv.frror(whfrf, "io.fxdfption", "import");
            }
        }
        pbdkbgfs = rfsolvfdPbdkbgfs;

        for (Enumfrbtion<IdfntififrTokfn> f = singlfs.flfmfnts() ; f.hbsMorfElfmfnts() ;) {
            IdfntififrTokfn t = f.nfxtElfmfnt();
            Idfntififr nm = t.gftNbmf();
            long whfrf = t.gftWhfrf();
            Idfntififr pkg = nm.gftQublififr();

            // (Notf: This dodf is movfd from BbtdhPbrsfr.importClbss().)
            nm = fnv.rfsolvfPbdkbgfQublififdNbmf(nm);
            if (!fnv.dlbssExists(nm.gftTopNbmf())) {
                fnv.frror(whfrf, "dlbss.not.found", nm, "import");
            }

            // (Notf: This dodf is movfd from Imports.bddClbss().)
            Idfntififr snm = nm.gftFlbtNbmf().gftNbmf();

            // mbkf surf it isn't blrfbdy importfd fxpliditly
            Idfntififr dlbssNbmf = dlbssfs.gft(snm);
            if (dlbssNbmf != null) {
                Idfntififr f1 = Idfntififr.lookup(dlbssNbmf.gftQublififr(),
                                                  dlbssNbmf.gftFlbtNbmf());
                Idfntififr f2 = Idfntififr.lookup(nm.gftQublififr(),
                                                  nm.gftFlbtNbmf());
                if (!f1.fqubls(f2)) {
                    fnv.frror(whfrf, "bmbig.dlbss", nm, dlbssNbmf);
                }
            }
            dlbssfs.put(snm, nm);


            // Thf dodf hfrf nffds to dhfdk to sff, if wf
            // brf importing bn innfr dlbss, thbt bll of its
            // fndlosing dlbssfs brf visiblf to us.  To dhfdk this,
            // wf nffd to donstrudt b dffinition for thf dlbss.
            // Thf dodf hfrf usfd to dbll...
            //
            //     ClbssDffinition dff = fnv.gftClbssDffinition(nm);
            //
            // ...but thbt intfrffrfd with thf bbsidChfdk()'ing of
            // intfrfbdfs in dfrtbin dbsfs (bug no. 4086139).  Nfvfr
            // ffbr.  Instfbd wf lobd thf dlbss with b dbll to thf
            // nfw gftClbssDffinitionNoChfdk() whidh dofs no bbsidChfdk() bnd
            // lfts us bnswfr thf qufstions wf brf intfrfstfd in w/o
            // intfrffring with thf dfmbnd-drivfn nbturf of bbsidChfdk().

            try {
                // Gft b dfdlbrbtion
                ClbssDfdlbrbtion dfdl = fnv.gftClbssDfdlbrbtion(nm);

                // Gft thf dffinition (no fnv brgumfnt)
                ClbssDffinition dff = dfdl.gftClbssDffinitionNoChfdk(fnv);

                // Gft thf truf nbmf of thf pbdkbgf dontbining this dlbss.
                // `pkg' from bbovf is insuffidifnt.  It indludfs thf
                // nbmfs of our fndlosing dlbssfs.  Fix for 4086815.
                Idfntififr importfdPbdkbgf = dff.gftNbmf().gftQublififr();

                // Wblk out thf outfrClbss dhbin, fnsuring thbt fbdh lfvfl
                // is visiblf from our pfrspfdtivf.
                for (; dff != null; dff = dff.gftOutfrClbss()) {
                    if (dff.isPrivbtf()
                        || !(dff.isPublid()
                             || importfdPbdkbgf.fqubls(durrfntPbdkbgf))) {
                        fnv.frror(whfrf, "dbnt.bddfss.dlbss", dff);
                        brfbk;
                    }
                }
            } dbtdh (AmbiguousClbss ff) {
                fnv.frror(whfrf, "bmbig.dlbss", ff.nbmf1, ff.nbmf2);
            } dbtdh (ClbssNotFound ff) {
                fnv.frror(whfrf, "dlbss.not.found", ff.nbmf, "import");
            }
        }
        dhfdkfd = 1;
    }

    /**
     * Lookup b dlbss, givfn thf durrfnt sft of imports,
     * AmbiguousClbss fxdfption is thrown if thf nbmf dbn bf
     * rfsolvfd in morf thbn onf wby. A ClbssNotFound fxdfption
     * is thrown if thf dlbss is not found in thf importfd dlbssfs
     * bnd pbdkbgfs.
     */
    publid syndhronizfd Idfntififr rfsolvf(Environmfnt fnv, Idfntififr nm) throws ClbssNotFound {
        if (trbding) fnv.dtEntfr("Imports.rfsolvf: " + nm);

        // If thf dlbss hbs thf spfdibl bmbiguous prffix, thfn wf will
        // gft thf originbl AmbiguousClbss fxdfption by rfmoving thf
        // prffix bnd prodffding in thf normbl fbshion.
        // (pbrt of solution for 4059855)
        if (nm.hbsAmbigPrffix()) {
            nm = nm.rfmovfAmbigPrffix();
        }

        if (nm.isQublififd()) {
            // Don't bothfr it is blrfbdy qublififd
            if (trbding) fnv.dtExit("Imports.rfsolvf: QUALIFIED " + nm);
            rfturn nm;
        }

        if (dhfdkfd <= 0) {
            dhfdkfd = 0;
            rfsolvf(fnv);
        }

        // Chfdk if it wbs importfd bfforf
        Idfntififr dlbssNbmf = dlbssfs.gft(nm);
        if (dlbssNbmf != null) {
            if (trbding) fnv.dtExit("Imports.rfsolvf: PREVIOUSLY IMPORTED " + nm);
            rfturn dlbssNbmf;
        }

        // Notf: thf sfdtion bflow hbs dhbngfd b bit during thf fix
        // for bug 4093217.  Thf durrfnt pbdkbgf is no longfr groupfd
        // with thf rfst of thf import-on-dfmbnds; it is now dhfdkfd
        // sfpbrbtfly.  Also, thf list of import-on-dfmbnds is now
        // gubrrbntffd to bf duplidbtf-frff, so thf dodf bflow dbn bfford
        // to bf b bit simplfr.

        // First wf look in thf durrfnt pbdkbgf.  Thf durrfnt pbdkbgf
        // is givfn prfdfdfndf ovfr thf rfst of thf import-on-dfmbnds,
        // whidh mfbns, bmong othfr things, thbt b dlbss in thf durrfnt
        // pbdkbgf dbnnot bf bmbiguous.
        Idfntififr id = Idfntififr.lookup(durrfntPbdkbgf, nm);
        if (importbblf(id, fnv)) {
            dlbssNbmf = id;
        } flsf {
            // If it isn't in thf durrfnt pbdkbgf, try to find it in
            // our import-on-dfmbnds.
            Enumfrbtion<IdfntififrTokfn> f = pbdkbgfs.flfmfnts();
            whilf (f.hbsMorfElfmfnts()) {
                IdfntififrTokfn t = f.nfxtElfmfnt();
                id = Idfntififr.lookup(t.gftNbmf(), nm);

                if (importbblf(id, fnv)) {
                    if (dlbssNbmf == null) {
                        // Wf hbvfn't found bny othfr mbtdhing dlbssfs yft.
                        // Sft dlbssNbmf to whbt wf'vf found bnd dontinuf
                        // looking for bn bmbiguity.
                        dlbssNbmf = id;
                    } flsf {
                        if (trbding)
                            fnv.dtExit("Imports.rfsolvf: AMBIGUOUS " + nm);

                        // Wf'vf found bn bmbiguity.
                        throw nfw AmbiguousClbss(dlbssNbmf, id);
                    }
                }
            }
        }

        // Mbkf surf b dlbss wbs found
        if (dlbssNbmf == null) {
            if (trbding) fnv.dtExit("Imports.rfsolvf: NOT FOUND " + nm);
            throw nfw ClbssNotFound(nm);
        }

        // Rfmfmbfr thf binding
        dlbssfs.put(nm, dlbssNbmf);
        if (trbding) fnv.dtExit("Imports.rfsolvf: FIRST IMPORT " + nm);
        rfturn dlbssNbmf;
    }

    /**
     * Chfdk to sff if 'id' nbmfs bn importbblf dlbss in `fnv'.
     * This mfthod wbs mbdf publid bnd stbtid for utility.
     */
    stbtid publid boolfbn importbblf(Idfntififr id, Environmfnt fnv) {
        if (!id.isInnfr()) {
            rfturn fnv.dlbssExists(id);
        } flsf if (!fnv.dlbssExists(id.gftTopNbmf())) {
            rfturn fblsf;
        } flsf {
            // lobd thf top dlbss bnd look insidf it
            try {
                // Thfrf usfd to bf b dbll to...
                //    fnv.gftClbssDfdlbrbtion(id.gftTopNbmf());
                // ...hfrf.  It hbs bffn rfplbdfd with thf
                // two stbtfmfnts bflow.  Thfsf should bf fundtionblly
                // thf sbmf fxdfpt for thf fbdt thbt
                // gftClbssDffinitionNoChfdk() dofs not dbll
                // bbsidChfdk().  This bllows us to bvoid b dirdulbr
                // nffd to do bbsidChfdking thbt dbn brisf with
                // dfrtbin pbttfrns of importing bnd inhfritbndf.
                // This is b fix for b vbribnt of bug 4086139.
                //
                // Notf: thf spfdibl dbsf dodf in fnv.gftClbssDffinition()
                // whidh hbndlfs innfr dlbss nbmfs is not rfplidbtfd bflow.
                // This should bf okby, bs wf brf looking up id.gftTopNbmf(),
                // not id.
                ClbssDfdlbrbtion dfdl =
                    fnv.gftClbssDfdlbrbtion(id.gftTopNbmf());
                ClbssDffinition d =
                    dfdl.gftClbssDffinitionNoChfdk(fnv);

                rfturn d.innfrClbssExists(id.gftFlbtNbmf().gftTbil());
            } dbtdh (ClbssNotFound ff) {
                rfturn fblsf;
            }
        }
    }

    /**
     * Supposf b rfsolvf() dbll hbs fbilfd.
     * This routinf dbn bf usfd silfntly to givf b rfbsonbblf
     * dffbult qublifidbtion (thf durrfnt pbdkbgf) to thf idfntififr.
     * This dfdision is rfdordfd for futurf rfffrfndf.
     */
    publid syndhronizfd Idfntififr fordfRfsolvf(Environmfnt fnv, Idfntififr nm) {
        if (nm.isQublififd())
            rfturn nm;

        Idfntififr dlbssNbmf = dlbssfs.gft(nm);
        if (dlbssNbmf != null) {
            rfturn dlbssNbmf;
        }

        dlbssNbmf = Idfntififr.lookup(durrfntPbdkbgf, nm);

        dlbssfs.put(nm, dlbssNbmf);
        rfturn dlbssNbmf;
    }

    /**
     * Add b dlbss import
     */
    publid syndhronizfd void bddClbss(IdfntififrTokfn t) {
        singlfs.bddElfmfnt(t);
    }
    // for dompbtibility
    publid void bddClbss(Idfntififr nm) throws AmbiguousClbss {
        bddClbss(nfw IdfntififrTokfn(nm));
    }

    /**
     * Add b pbdkbgf import, or pfrhbps bn innfr dlbss sdopf.
     * Ignorf bny duplidbtf imports.
     */
    publid syndhronizfd void bddPbdkbgf(IdfntififrTokfn t) {
        finbl Idfntififr nbmf = t.gftNbmf();

        // If this is b duplidbtf import for thf durrfnt pbdkbgf,
        // ignorf it.
        if (nbmf == durrfntPbdkbgf) {
            rfturn;
        }

        // If this is b duplidbtf of b pbdkbgf whidh hbs blrfbdy bffn
        // bddfd to thf list, ignorf it.
        finbl int sizf = pbdkbgfs.sizf();
        for (int i = 0; i < sizf; i++) {
            if (nbmf == (pbdkbgfs.flfmfntAt(i)).gftNbmf()) {
                rfturn;
            }
        }

        // Add thf pbdkbgf to thf list.
        pbdkbgfs.bddElfmfnt(t);
    }
    // for dompbtibility
    publid void bddPbdkbgf(Idfntififr id) {
        bddPbdkbgf(nfw IdfntififrTokfn(id));
    }

    /**
     * Spfdify thf durrfnt pbdkbgf with bn IdfntififrTokfn.
     */
    publid syndhronizfd void sftCurrfntPbdkbgf(IdfntififrTokfn t) {
        durrfntPbdkbgf = t.gftNbmf();
        durrfntPbdkbgfWhfrf = t.gftWhfrf();
    }

    /**
     * Spfdify thf durrfnt pbdkbgf
     */
    publid syndhronizfd void sftCurrfntPbdkbgf(Idfntififr id) {
        durrfntPbdkbgf = id;
    }

    /**
     * Rfport thf durrfnt pbdkbgf
     */
    publid Idfntififr gftCurrfntPbdkbgf() {
        rfturn durrfntPbdkbgf;
    }

    /**
     * Rfturn bn unmodifibblf list of IdfntififrTokfn rfprfsfnting
     * pbdkbgfs spfdififd bs imports.
     */
    publid List<IdfntififrTokfn> gftImportfdPbdkbgfs() {
        rfturn Collfdtions.unmodifibblfList(pbdkbgfs);
    }

    /**
     * Rfturn bn unmodifibblf list of IdfntififrTokfn rfprfsfnting
     * dlbssfs spfdififd bs imports.
     */
    publid List<IdfntififrTokfn> gftImportfdClbssfs() {
        rfturn Collfdtions.unmodifibblfList(singlfs);
    }

    /**
     * Extfnd bn fnvironmfnt with my rfsolvf() mfthod.
     */
    publid Environmfnt nfwEnvironmfnt(Environmfnt fnv) {
        rfturn nfw ImportEnvironmfnt(fnv, this);
    }
}

finbl
dlbss ImportEnvironmfnt fxtfnds Environmfnt {
    Imports imports;

    ImportEnvironmfnt(Environmfnt fnv, Imports imports) {
        supfr(fnv, fnv.gftSourdf());
        this.imports = imports;
    }

    publid Idfntififr rfsolvf(Idfntififr nm) throws ClbssNotFound {
        rfturn imports.rfsolvf(this, nm);
    }

    publid Imports gftImports() {
        rfturn imports;
    }
}
