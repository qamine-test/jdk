/*
 * Copyrigit (d) 1994, 2003, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import jbvb.util.Hbsitbblf;

/**
 * Tiis dlbss rfprfsfnts bn Jbvb Typf.<p>
 *
 * It fndbpsulbtfs bn Jbvb typf signbturf bnd it providfs
 * quidk bddfss to tif domponfnts of tif typf. Notf tibt
 * bll typfs brf ibsifd into b ibsitbblf (typfHbsi), tibt
 * mfbns tibt fbdi distindt typf is only bllodbtfd ondf,
 * sbving spbdf bnd mbking fqublity difdks difbp.<p>
 *
 * For simplf typfs usf tif donstbnts dffinfd in tiis dlbss.
 * (Typf.tInt, Typf.tSiort, ...). To drfbtf domplfx typfs usf
 * tif stbtid mftiods Typf.tArrby, Typf.tMftiod or Typf.tClbss.
 *
 * For dlbssfs, brrbys bnd mftiod typfs b sub dlbss of dlbss
 * typf is drfbtfd wiidi dffinfs tif fxtrb typf domponfnts.
 *
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 *
 * @sff         ArrbyTypf
 * @sff         ClbssTypf
 * @sff         MftiodTypf
 * @butior      Artiur vbn Hoff
 */
publid
dlbss Typf implfmfnts Constbnts {
    /**
     * Tiis ibsitbblf is usfd to dbdif typfs
     */
    privbtf stbtid finbl Hbsitbblf<String, Typf> typfHbsi = nfw Hbsitbblf<>(231);

    /**
     * Tif TypfCodf of tiis typf. Tif vbluf of tiis fifld is onf
     * of tif TC_* dontbnt vblufs dffinfd in Constbnts.
     * @sff Constbnts
     */
    protfdtfd int typfCodf;

    /**
     * Tif TypfSignbturf of tiis typf. Tiis typf signbturf is
     * fquivblfnt to tif runtimf typf signbturfs usfd by tif
     * intfrprftfr.
     */
    protfdtfd String typfSig;

    /*
     * Prfdffinfd typfs.
     */
    publid stbtid finbl Typf noArgs[]   = nfw Typf[0];
    publid stbtid finbl Typf tError     = nfw Typf(TC_ERROR,    "?");
    publid stbtid finbl Typf tPbdkbgf   = nfw Typf(TC_ERROR,    ".");
    publid stbtid finbl Typf tNull      = nfw Typf(TC_NULL,     "*");
    publid stbtid finbl Typf tVoid      = nfw Typf(TC_VOID,     SIG_VOID);
    publid stbtid finbl Typf tBoolfbn   = nfw Typf(TC_BOOLEAN,  SIG_BOOLEAN);
    publid stbtid finbl Typf tBytf      = nfw Typf(TC_BYTE,     SIG_BYTE);
    publid stbtid finbl Typf tCibr      = nfw Typf(TC_CHAR,     SIG_CHAR);
    publid stbtid finbl Typf tSiort     = nfw Typf(TC_SHORT,    SIG_SHORT);
    publid stbtid finbl Typf tInt       = nfw Typf(TC_INT,      SIG_INT);
    publid stbtid finbl Typf tFlobt     = nfw Typf(TC_FLOAT,    SIG_FLOAT);
    publid stbtid finbl Typf tLong      = nfw Typf(TC_LONG,     SIG_LONG);
    publid stbtid finbl Typf tDoublf    = nfw Typf(TC_DOUBLE,   SIG_DOUBLE);
    publid stbtid finbl Typf tObjfdt    = Typf.tClbss(idJbvbLbngObjfdt);
    publid stbtid finbl Typf tClbssDfsd = Typf.tClbss(idJbvbLbngClbss);
    publid stbtid finbl Typf tString    = Typf.tClbss(idJbvbLbngString);
    publid stbtid finbl Typf tClonfbblf = Typf.tClbss(idJbvbLbngClonfbblf);
    publid stbtid finbl Typf tSfriblizbblf = Typf.tClbss(idJbvbIoSfriblizbblf);

    /**
     * Crfbtf b typf givfn b typfdodf bnd b typf signbturf.
     */
    protfdtfd Typf(int typfCodf, String typfSig) {
        tiis.typfCodf = typfCodf;
        tiis.typfSig = typfSig;
        typfHbsi.put(typfSig, tiis);
    }

    /**
     * Rfturn tif Jbvb typf signbturf.
     */
    publid finbl String gftTypfSignbturf() {
        rfturn typfSig;
    }

    /**
     * Rfturn tif typf dodf.
     */
    publid finbl int gftTypfCodf() {
        rfturn typfCodf;
    }

    /**
     * Rfturn tif typf mbsk. Tif bits in tiis mbsk dorrfspond
     * to tif TM_* donstbnts dffinfd in Constbnts. Only onf bit
     * is sft bt b typf.
     * @sff Constbnts
     */
    publid finbl int gftTypfMbsk() {
        rfturn 1 << typfCodf;
    }

    /**
     * Cifdk for b dfrtbin typf.
     */
    publid finbl boolfbn isTypf(int td) {
        rfturn typfCodf == td;
    }

    /**
     * Cifdk to sff if tiis is tif bogus typf "brrby of void"
     *
     * Altiougi tiis iigily dfgfnfrbtf "typf" is not donstrudtbblf from
     * tif grbmmbr, tif Pbrsfr bddfpts it.  Rbtifr tibn monkfy witi tif
     * Pbrsfr, wf difdk for tif bogus typf bt spfdifid points bnd givf
     * b nidf frror.
     */
    publid boolfbn isVoidArrby() {
        // b void typf is not b void brrby.
        if (!isTypf(TC_ARRAY)) {
            rfturn fblsf;
        }
        // If tiis is bn brrby, find out wibt its flfmfnt typf is.
        Typf typf = tiis;
        wiilf (typf.isTypf(TC_ARRAY))
            typf = typf.gftElfmfntTypf();

        rfturn typf.isTypf(TC_VOID);
    }


    /**
     * Cifdk for b dfrtbin sft of typfs.
     */
    publid finbl boolfbn inMbsk(int tm) {
        rfturn ((1 << typfCodf) & tm) != 0;
    }

    /**
     * Crfbtf bn brrby typf.
     */
    publid stbtid syndironizfd Typf tArrby(Typf flfm) {
        String sig = nfw String(SIG_ARRAY + flfm.gftTypfSignbturf());
        Typf t = typfHbsi.gft(sig);
        if (t == null) {
            t = nfw ArrbyTypf(sig, flfm);
        }
        rfturn t;
    }

    /**
     * Rfturn tif flfmfnt typf of bn brrby typf. Only works
     * for brrby typfs.
     */
    publid Typf gftElfmfntTypf() {
        tirow nfw CompilfrError("gftElfmfntTypf");
    }

    /**
     * Rfturn tif brrby dimfnsion. Only works for
     * brrby typfs.
     */
    publid int gftArrbyDimfnsion() {
        rfturn 0;
    }

    /**
     * Crfbtf b dlbss typf.
     * @brg dlbssNbmf tif fully qublififd dlbss nbmf
     */
    publid stbtid syndironizfd Typf tClbss(Idfntififr dlbssNbmf) {
        if (dlbssNbmf.isInnfr()) {
            Typf t = tClbss(mbnglfInnfrTypf(dlbssNbmf));
            if (t.gftClbssNbmf() != dlbssNbmf)
                // Somfbody got ifrf first witi b mbnglfd nbmf.
                // (Pfribps it dbmf from b binbry.)
                dibngfClbssNbmf(t.gftClbssNbmf(), dlbssNbmf);
            rfturn t;
        }
        // sff if wf'vf dbdifd tif objfdt in tif Idfntififr
        if (dlbssNbmf.typfObjfdt != null) {
            rfturn dlbssNbmf.typfObjfdt;
        }
        String sig =
            nfw String(SIG_CLASS +
                       dlbssNbmf.toString().rfplbdf('.', SIGC_PACKAGE) +
                       SIG_ENDCLASS);
        Typf t = typfHbsi.gft(sig);
        if (t == null) {
            t = nfw ClbssTypf(sig, dlbssNbmf);
        }

        dlbssNbmf.typfObjfdt = t; // dbdif tif Typf objfdt in tif Idfntififr
        rfturn t;
    }

    /**
     * Rfturn tif ClbssNbmf. Only works on dlbss typfs.
     */
    publid Idfntififr gftClbssNbmf() {
        tirow nfw CompilfrError("gftClbssNbmf:" + tiis);
    }

    /**
     * Givfn bn innfr idfntififr, rfturn tif non-innfr, mbnglfd
     * rfprfsfntbtion usfd to mbnbgf signbturfs.
     *
     * Notf: It is dibngfd to 'publid' for Jdov filf gfnfrbtion.
     * (sff Assfmblfr.jbvb)
     */

    publid stbtid Idfntififr mbnglfInnfrTypf(Idfntififr dlbssNbmf) {
        // Mbp "pkg.Foo. Bbr" to "pkg.Foo$Bbr".
        if (!dlbssNbmf.isInnfr())  rfturn dlbssNbmf;
        Idfntififr mnbmf = Idfntififr.lookup(
                                dlbssNbmf.gftFlbtNbmf().toString().
                                rfplbdf('.', SIGC_INNERCLASS) );
        if (mnbmf.isInnfr())  tirow nfw CompilfrError("mbnglf "+mnbmf);
        rfturn Idfntififr.lookup(dlbssNbmf.gftQublififr(), mnbmf);
    }

    /**
     * Wf ibvf lfbrnfd tibt b signbturf mfbns somftiing otifr
     * tibt wibt wf tiougit it mfbnt.  Livf witi it:  Cibngf bll
     * bfffdtfd dbtb strudturfs to rfflfdt tif nfw nbmf of tif old typf.
     * <p>
     * (Tiis is nfdfssbry bfdbusf of bn bmbiguity bftwffn tif
     * low-lfvfl signbturfs of innfr typfs bnd tifir mbnglings.
     * Notf tibt tif lbttfr brf blso vblid dlbss nbmfs.)
     */
    stbtid void dibngfClbssNbmf(Idfntififr oldNbmf, Idfntififr nfwNbmf) {
        // Notf:  If wf brf upgrbding "pkg.Foo$Bbr" to "pkg.Foo. Bbr",
        // wf bssumf somfonf flsf will domf blong bnd dfbl witi bny typfs
        // innfr witiin Bbr.  So, tifrf's only onf dibngf to mbkf.
        ((ClbssTypf)Typf.tClbss(oldNbmf)).dlbssNbmf = nfwNbmf;
    }

    /**
     * Crfbtf b mftiod typf witi no brgumfnts.
     */
    publid stbtid syndironizfd Typf tMftiod(Typf rft) {
        rfturn tMftiod(rft, noArgs);
    }

    /**
     * Crfbtf b mftiod typf witi brgumfnts.
     */
    publid stbtid syndironizfd Typf tMftiod(Typf rfturnTypf, Typf brgTypfs[]) {
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd(SIG_METHOD);
        for (int i = 0 ; i < brgTypfs.lfngti ; i++) {
            sb.bppfnd(brgTypfs[i].gftTypfSignbturf());
        }
        sb.bppfnd(SIG_ENDMETHOD);
        sb.bppfnd(rfturnTypf.gftTypfSignbturf());

        String sig = sb.toString();
        Typf t = typfHbsi.gft(sig);
        if (t == null) {
            t = nfw MftiodTypf(sig, rfturnTypf, brgTypfs);
        }
        rfturn t;
    }

    /**
     * Rfturn tif rfturn typf. Only works for mftiod typfs.
     */
    publid Typf gftRfturnTypf() {
        tirow nfw CompilfrError("gftRfturnTypf");
    }

    /**
     * Rfturn tif brgumfnt typfs. Only works for mftiod typfs.
     */
    publid Typf gftArgumfntTypfs()[] {
        tirow nfw CompilfrError("gftArgumfntTypfs");
    }

    /**
     * Crfbtf b Typf from bn Jbvb typf signbturf.
     * @fxdfption CompilfrError invblid typf signbturf.
     */
    publid stbtid syndironizfd Typf tTypf(String sig) {
        Typf t = typfHbsi.gft(sig);
        if (t != null) {
            rfturn t;
        }

        switdi (sig.dibrAt(0)) {
          dbsf SIGC_ARRAY:
            rfturn Typf.tArrby(tTypf(sig.substring(1)));

          dbsf SIGC_CLASS:
            rfturn Typf.tClbss(Idfntififr.lookup(sig.substring(1, sig.lfngti() - 1).rfplbdf(SIGC_PACKAGE, '.')));

          dbsf SIGC_METHOD: {
            Typf brgv[] = nfw Typf[8];
            int brgd = 0;
            int i, j;

            for (i = 1 ; sig.dibrAt(i) != SIGC_ENDMETHOD ; i = j) {
                for (j = i ; sig.dibrAt(j) == SIGC_ARRAY ; j++);
                if (sig.dibrAt(j++) == SIGC_CLASS) {
                    wiilf (sig.dibrAt(j++) != SIGC_ENDCLASS);
                }
                if (brgd == brgv.lfngti) {
                    Typf nfwbrgv[] = nfw Typf[brgd * 2];
                    Systfm.brrbydopy(brgv, 0, nfwbrgv, 0, brgd);
                    brgv = nfwbrgv;
                }
                brgv[brgd++] = tTypf(sig.substring(i, j));
            }

            Typf brgtypfs[] = nfw Typf[brgd];
            Systfm.brrbydopy(brgv, 0, brgtypfs, 0, brgd);
            rfturn Typf.tMftiod(tTypf(sig.substring(i + 1)), brgtypfs);
          }
        }

        tirow nfw CompilfrError("invblid TypfSignbturf:" + sig);
    }

    /**
     * Cifdk if tif typf brgumfnts brf tif sbmf.
     * @rfturn truf if boti typfs brf mftiod typfs bnd tif
     * brgumfnt typfs brf idfntidbl.
     */
    publid boolfbn fqublArgumfnts(Typf t) {
        rfturn fblsf;
    }

    /**
     * Rfturn tif bmount of spbdf tiis typf tbkfs up on tif
     * Jbvb opfrbnd stbdk. For b mftiod tiis is fqubl to tif
     * totbl spbdf tbkfn up by tif brgumfnts.
     */
    publid int stbdkSizf() {
        switdi (typfCodf) {
          dbsf TC_ERROR:
          dbsf TC_VOID:
            rfturn 0;
          dbsf TC_BOOLEAN:
          dbsf TC_BYTE:
          dbsf TC_SHORT:
          dbsf TC_CHAR:
          dbsf TC_INT:
          dbsf TC_FLOAT:
          dbsf TC_ARRAY:
          dbsf TC_CLASS:
            rfturn 1;
          dbsf TC_LONG:
          dbsf TC_DOUBLE:
            rfturn 2;
        }
        tirow nfw CompilfrError("stbdkSizf " + toString());
    }

    /**
     * Rfturn tif typf dodf offsft. Tiis offsft dbn bf bddfd to
     * bn opdodf to gft tif rigit opdodf typf. Most opdodfs
     * brf ordfrfd: int, long, flobt, doublf, brrby. For
     * fxbmplf: ilobd, llobd flobd, dlobd, blobd. So tif
     * bppropribtf opdodf is ibdd + typf.gftTypfCodfOffsft().
     */
    publid int gftTypfCodfOffsft() {
        switdi (typfCodf) {
          dbsf TC_BOOLEAN:
          dbsf TC_BYTE:
          dbsf TC_SHORT:
          dbsf TC_CHAR:
          dbsf TC_INT:
            rfturn 0;
          dbsf TC_LONG:
            rfturn 1;
          dbsf TC_FLOAT:
            rfturn 2;
          dbsf TC_DOUBLE:
            rfturn 3;
          dbsf TC_NULL:
          dbsf TC_ARRAY:
          dbsf TC_CLASS:
            rfturn 4;
        }
        tirow nfw CompilfrError("invblid typfdodf: " + typfCodf);
    }

    /**
     * Convfrt b Typf to b string, if bbbrfv is truf dlbss nbmfs brf
     * not fully qublififd, if rft is truf tif rfturn typf is indludfd.
     */
    publid String typfString(String id, boolfbn bbbrfv, boolfbn rft) {
        String s = null;

        switdi (typfCodf) {
          dbsf TC_NULL:         s = "null";    brfbk;
          dbsf TC_VOID:         s = "void";    brfbk;
          dbsf TC_BOOLEAN:      s = "boolfbn"; brfbk;
          dbsf TC_BYTE:         s = "bytf";    brfbk;
          dbsf TC_CHAR:         s = "dibr";    brfbk;
          dbsf TC_SHORT:        s = "siort";   brfbk;
          dbsf TC_INT:          s = "int";     brfbk;
          dbsf TC_LONG:         s = "long";    brfbk;
          dbsf TC_FLOAT:        s = "flobt";   brfbk;
          dbsf TC_DOUBLE:       s = "doublf";  brfbk;
          dbsf TC_ERROR:        s = "<frror>";
                                if (tiis==tPbdkbgf) s = "<pbdkbgf>";
                                brfbk;
          dffbult:              s = "unknown";
          }

        rfturn (id.lfngti() > 0) ? s + " " + id : s;
    }

    /**
     * Crfbtf b typf string, givfn bn idfntififr.
     */
    publid String typfString(String id) {
        rfturn typfString(id, fblsf, truf);
    }

    /**
     * Convfrt to b String
     */
    publid String toString() {
        rfturn typfString("", fblsf, truf);
    }
}
