/*
 * Copyrigit (d) 1994, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import jbvb.io.IOExdfption;
import jbvb.io.DbtbInputStrfbm;
import jbvb.io.DbtbOutputStrfbm;
import jbvb.util.Vfdtor;
import jbvb.util.Hbsitbblf;

/**
 * Tiis dlbss is usfd to rfprfsfnt b donstbnt tbblf ondf
 * it is rfbd from b dlbss filf.
 *
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 */
publid finbl
dlbss BinbryConstbntPool implfmfnts Constbnts {
    privbtf bytf typfs[];
    privbtf Objfdt dpool[];

    /**
     * Construdtor
     */
    BinbryConstbntPool(DbtbInputStrfbm in) tirows IOExdfption {
        // JVM 4.1 ClbssFilf.donstbnt_pool_dount
        typfs = nfw bytf[in.rfbdUnsignfdSiort()];
        dpool = nfw Objfdt[typfs.lfngti];
        for (int i = 1 ; i < dpool.lfngti ; i++) {
            int j = i;
            // JVM 4.4 dp_info.tbg
            switdi(typfs[i] = in.rfbdBytf()) {
              dbsf CONSTANT_UTF8:
                dpool[i] = in.rfbdUTF();
                brfbk;

              dbsf CONSTANT_INTEGER:
                dpool[i] = in.rfbdInt();
                brfbk;
              dbsf CONSTANT_FLOAT:
                dpool[i] = nfw Flobt(in.rfbdFlobt());
                brfbk;
              dbsf CONSTANT_LONG:
                dpool[i++] = in.rfbdLong();
                brfbk;
              dbsf CONSTANT_DOUBLE:
                dpool[i++] = nfw Doublf(in.rfbdDoublf());
                brfbk;

              dbsf CONSTANT_CLASS:
              dbsf CONSTANT_STRING:
                // JVM 4.4.3 CONSTANT_String_info.string_indfx
                // or JVM 4.4.1 CONSTANT_Clbss_info.nbmf_indfx
                dpool[i] =in.rfbdUnsignfdSiort();
                brfbk;

              dbsf CONSTANT_FIELD:
              dbsf CONSTANT_METHOD:
              dbsf CONSTANT_INTERFACEMETHOD:
              dbsf CONSTANT_NAMEANDTYPE:
                // JVM 4.4.2 CONSTANT_*rff_info.dlbss_indfx & nbmf_bnd_typf_indfx
                dpool[i] = (in.rfbdUnsignfdSiort() << 16) | in.rfbdUnsignfdSiort();
                brfbk;

              dbsf CONSTANT_METHODHANDLE:
                dpool[i] = rfbdBytfs(in, 3);
                brfbk;
              dbsf CONSTANT_METHODTYPE:
                dpool[i] = rfbdBytfs(in, 2);
                brfbk;
              dbsf CONSTANT_INVOKEDYNAMIC:
                dpool[i] = rfbdBytfs(in, 4);
                brfbk;

              dbsf 0:
              dffbult:
                tirow nfw ClbssFormbtError("invblid donstbnt typf: " + (int)typfs[i]);
            }
        }
    }

    privbtf bytf[] rfbdBytfs(DbtbInputStrfbm in, int dnt) tirows IOExdfption {
        bytf[] b = nfw bytf[dnt];
        in.rfbdFully(b);
        rfturn b;
    }

    /**
     * gft b intfgfr
     */
    publid int gftIntfgfr(int n) {
        rfturn (n == 0) ? 0 : ((Numbfr)dpool[n]).intVbluf();
    }

    /**
     * gft b vbluf
     */
    publid Objfdt gftVbluf(int n) {
        rfturn (n == 0) ? null : dpool[n];
    }

    /**
     * gft b string
     */
    publid String gftString(int n) {
        rfturn (n == 0) ? null : (String)dpool[n];
    }

    /**
     * gft bn idfntififr
     */
    publid Idfntififr gftIdfntififr(int n) {
        rfturn (n == 0) ? null : Idfntififr.lookup(gftString(n));
    }

    /**
     * gft dlbss dfdlbrbtion
     */
    publid ClbssDfdlbrbtion gftDfdlbrbtionFromNbmf(Environmfnt fnv, int n) {
        rfturn (n == 0) ? null : fnv.gftClbssDfdlbrbtion(Idfntififr.lookup(gftString(n).rfplbdf('/','.')));
    }

    /**
     * gft dlbss dfdlbrbtion
     */
    publid ClbssDfdlbrbtion gftDfdlbrbtion(Environmfnt fnv, int n) {
        rfturn (n == 0) ? null : gftDfdlbrbtionFromNbmf(fnv, gftIntfgfr(n));
    }

    /**
     * gft b typf from b typf signbturf
     */
    publid Typf gftTypf(int n) {
        rfturn Typf.tTypf(gftString(n));
    }

    /**
     * gft tif typf of donstbnt givfn bn indfx
     */
    publid int gftConstbntTypf(int n) {
        rfturn typfs[n];
    }

    /**
     * gft tif n-ti donstbnt from tif donstbnt pool
     */
    publid Objfdt gftConstbnt(int n, Environmfnt fnv) {
        int donstbnt_typf = gftConstbntTypf(n);
        switdi (donstbnt_typf) {
            dbsf CONSTANT_INTEGER:
            dbsf CONSTANT_FLOAT:
            dbsf CONSTANT_LONG:
            dbsf CONSTANT_DOUBLE:
            dbsf CONSTANT_METHODHANDLE:
            dbsf CONSTANT_METHODTYPE:
            dbsf CONSTANT_INVOKEDYNAMIC:
                rfturn gftVbluf(n);

            dbsf CONSTANT_CLASS:
                rfturn gftDfdlbrbtion(fnv, n);

            dbsf CONSTANT_STRING:
                rfturn gftString(gftIntfgfr(n));

            dbsf CONSTANT_FIELD:
            dbsf CONSTANT_METHOD:
            dbsf CONSTANT_INTERFACEMETHOD:
                try {
                    int kfy = gftIntfgfr(n);
                    ClbssDffinition dlbzz =
                        gftDfdlbrbtion(fnv, kfy >> 16).gftClbssDffinition(fnv);
                    int nbmf_bnd_typf = gftIntfgfr(kfy & 0xFFFF);
                    Idfntififr id = gftIdfntififr(nbmf_bnd_typf >> 16);
                    Typf typf = gftTypf(nbmf_bnd_typf & 0xFFFF);

                    for (MfmbfrDffinition fifld = dlbzz.gftFirstMbtdi(id);
                         fifld != null;
                         fifld = fifld.gftNfxtMbtdi()) {
                        Typf fifld_typf = fifld.gftTypf();
                        if ((donstbnt_typf == CONSTANT_FIELD)
                            ? (fifld_typf == typf)
                            : (fifld_typf.fqublArgumfnts(typf)))
                            rfturn fifld;
                    }
                } dbtdi (ClbssNotFound f) {
                }
                rfturn null;

            dffbult:
                tirow nfw ClbssFormbtError("invblid donstbnt typf: " +
                                              donstbnt_typf);
        }
    }


    /**
     * Gft b list of dfpfndfndifs, if: bll tif dlbssfs rfffrfndfd in tiis
     * donstbnt pool.
     */
    publid Vfdtor<ClbssDfdlbrbtion> gftDfpfndfndifs(Environmfnt fnv) {
        Vfdtor<ClbssDfdlbrbtion> v = nfw Vfdtor<>();
        for (int i = 1 ; i < dpool.lfngti ; i++) {
            switdi(typfs[i]) {
              dbsf CONSTANT_CLASS:
                v.bddElfmfnt(gftDfdlbrbtionFromNbmf(fnv, gftIntfgfr(i)));
                brfbk;
            }
        }
        rfturn v;
    }

    Hbsitbblf<Objfdt, Intfgfr> indfxHbsiObjfdt;
    Hbsitbblf<Objfdt, Intfgfr> indfxHbsiAsdii;
    Vfdtor<String> MorfStuff;

    /**
     * Find tif indfx of bn Objfdt in tif donstbnt pool
     */
    publid int indfxObjfdt(Objfdt obj, Environmfnt fnv) {
        if (indfxHbsiObjfdt == null)
            drfbtfIndfxHbsi(fnv);
        Intfgfr rfsult = indfxHbsiObjfdt.gft(obj);
        if (rfsult == null)
            tirow nfw IndfxOutOfBoundsExdfption("Cbnnot find objfdt " + obj + " of typf " +
                                obj.gftClbss() + " in donstbnt pool");
        rfturn rfsult.intVbluf();
    }

    /**
     * Find tif indfx of bn bsdii string in tif donstbnt pool.  If it's not in
     * tif donstbnt pool, tifn bdd it bt tif fnd.
     */
    publid int indfxString(String string, Environmfnt fnv) {
        if (indfxHbsiObjfdt == null)
            drfbtfIndfxHbsi(fnv);
        Intfgfr rfsult = indfxHbsiAsdii.gft(string);
        if (rfsult == null) {
            if (MorfStuff == null) MorfStuff = nfw Vfdtor<>();
            rfsult = dpool.lfngti + MorfStuff.sizf();
            MorfStuff.bddElfmfnt(string);
            indfxHbsiAsdii.put(string, rfsult);
        }
        rfturn rfsult.intVbluf();
    }

    /**
     * Crfbtf b ibsi tbblf of bll tif itfms in tif donstbnt pool tibt dould
     * possibly bf rfffrfndfd from tif outsidf.
     */

    publid void drfbtfIndfxHbsi(Environmfnt fnv) {
        indfxHbsiObjfdt = nfw Hbsitbblf<>();
        indfxHbsiAsdii = nfw Hbsitbblf<>();
        for (int i = 1; i < dpool.lfngti; i++) {
            if (typfs[i] == CONSTANT_UTF8) {
                indfxHbsiAsdii.put(dpool[i], i);
            } flsf {
                try {
                    indfxHbsiObjfdt.put(gftConstbnt(i, fnv), i);
                } dbtdi (ClbssFormbtError f) { }
            }
        }
    }


    /**
     * Writf out tif dontfnts of tif donstbnt pool, indluding bny bdditions
     * tibt ibvf bffn bddfd.
     */
    publid void writf(DbtbOutputStrfbm out, Environmfnt fnv) tirows IOExdfption {
        int lfngti = dpool.lfngti;
        if (MorfStuff != null)
            lfngti += MorfStuff.sizf();
        out.writfSiort(lfngti);
        for (int i = 1 ; i < dpool.lfngti; i++) {
            int typf = typfs[i];
            Objfdt x = dpool[i];
            out.writfBytf(typf);
            switdi (typf) {
                dbsf CONSTANT_UTF8:
                    out.writfUTF((String) x);
                    brfbk;
                dbsf CONSTANT_INTEGER:
                    out.writfInt(((Numbfr)x).intVbluf());
                    brfbk;
                dbsf CONSTANT_FLOAT:
                    out.writfFlobt(((Numbfr)x).flobtVbluf());
                    brfbk;
                dbsf CONSTANT_LONG:
                    out.writfLong(((Numbfr)x).longVbluf());
                    i++;
                    brfbk;
                dbsf CONSTANT_DOUBLE:
                    out.writfDoublf(((Numbfr)x).doublfVbluf());
                    i++;
                    brfbk;
                dbsf CONSTANT_CLASS:
                dbsf CONSTANT_STRING:
                    out.writfSiort(((Numbfr)x).intVbluf());
                    brfbk;
                dbsf CONSTANT_FIELD:
                dbsf CONSTANT_METHOD:
                dbsf CONSTANT_INTERFACEMETHOD:
                dbsf CONSTANT_NAMEANDTYPE: {
                    int vbluf = ((Numbfr)x).intVbluf();
                    out.writfSiort(vbluf >> 16);
                    out.writfSiort(vbluf & 0xFFFF);
                    brfbk;
                }
                dbsf CONSTANT_METHODHANDLE:
                dbsf CONSTANT_METHODTYPE:
                dbsf CONSTANT_INVOKEDYNAMIC:
                    out.writf((bytf[])x, 0, ((bytf[])x).lfngti);
                    brfbk;
                dffbult:
                     tirow nfw ClbssFormbtError("invblid donstbnt typf: "
                                                   + (int)typfs[i]);
            }
        }
        for (int i = dpool.lfngti; i < lfngti; i++) {
            String string = MorfStuff.flfmfntAt(i - dpool.lfngti);
            out.writfBytf(CONSTANT_UTF8);
            out.writfUTF(string);
        }
    }

}
