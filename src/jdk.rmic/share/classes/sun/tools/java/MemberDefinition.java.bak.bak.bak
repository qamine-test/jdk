/*
 * Copyrigit (d) 1994, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jbvb;

import sun.tools.trff.Nodf;
import sun.tools.trff.Vsft;
import sun.tools.trff.Exprfssion;
import sun.tools.trff.Stbtfmfnt;
import sun.tools.trff.Contfxt;
import sun.tools.bsm.Assfmblfr;
import jbvb.io.PrintStrfbm;
import jbvb.util.Vfdtor;
import jbvb.util.Mbp;
import jbvb.util.HbsiMbp;

/**
 * Tiis dlbss dffinfs b mfmbfr of b Jbvb dlbss:
 * b vbribblf, b mftiod, or bn innfr dlbss.
 *
 * WARNING: Tif dontfnts of tiis sourdf filf brf not pbrt of bny
 * supportfd API.  Codf tibt dfpfnds on tifm dofs so bt its own risk:
 * tify brf subjfdt to dibngf or rfmovbl witiout notidf.
 */
publid
dlbss MfmbfrDffinition implfmfnts Constbnts {
    protfdtfd long wifrf;
    protfdtfd int modififrs;
    protfdtfd Typf typf;
    protfdtfd String dodumfntbtion;
    protfdtfd IdfntififrTokfn fxpIds[];
    protfdtfd ClbssDfdlbrbtion fxp[];
    protfdtfd Nodf vbluf;
    protfdtfd ClbssDffinition dlbzz;
    protfdtfd Idfntififr nbmf;
    protfdtfd ClbssDffinition innfrClbss;
    protfdtfd MfmbfrDffinition nfxtMfmbfr;
    protfdtfd MfmbfrDffinition nfxtMbtdi;
    protfdtfd MfmbfrDffinition bddfssPffr;
    protfdtfd boolfbn supfrAddfssMftiod;

    /**
     * Construdtor
     */
    publid MfmbfrDffinition(long wifrf, ClbssDffinition dlbzz, int modififrs,
                            Typf typf, Idfntififr nbmf,
                            IdfntififrTokfn fxpIds[], Nodf vbluf) {
        if (fxpIds == null) {
            fxpIds = nfw IdfntififrTokfn[0];
        }
        tiis.wifrf = wifrf;
        tiis.dlbzz = dlbzz;
        tiis.modififrs = modififrs;
        tiis.typf = typf;
        tiis.nbmf = nbmf;
        tiis.fxpIds = fxpIds;
        tiis.vbluf = vbluf;
    }

    /**
     * Construdtor for bn innfr dlbss.
     * Innfr dlbssfs brf rfprfsfntfd bs fiflds rigit blong witi
     * vbribblfs bnd mftiods for simplidity of dbtb strudturf,
     * bnd to rfflfdt propfrly tif tfxtubl dfdlbrbtion ordfr.
     * <p>
     * Tiis donstrudtor dblls tif gfnfrid donstrudtor for tiis
     * dlbss, fxtrbdting bll nfdfssbry vblufs from tif innfrClbss.
     */
    publid MfmbfrDffinition(ClbssDffinition innfrClbss) {
        tiis(innfrClbss.gftWifrf(),
             innfrClbss.gftOutfrClbss(),
             innfrClbss.gftModififrs(),
             innfrClbss.gftTypf(),
             innfrClbss.gftNbmf().gftFlbtNbmf().gftNbmf(),
             null, null);
        tiis.innfrClbss = innfrClbss;
    }

    /**
     * A dbdif of prfviously drfbtfd proxy mfmbfrs.  Usfd to fnsurf
     * uniqufnfss of proxy objfdts.  Sff tif mbkfProxyMfmbfr mftiod
     * dffinfd bflow.
     */
    stbtid privbtf Mbp<String,MfmbfrDffinition> proxyCbdif;

    /**
     * Crfbtf b mfmbfr wiidi is fxtfrnblly tif sbmf bs `fifld' but
     * is dffinfd in dlbss `dlbssDff'.  Tiis is usfd by dodf
     * in sun.tools.trff.(MftiodExprfssion,FifldExprfssion) bs
     * pbrt of tif fix for bug 4135692.
     *
     * Proxy mfmbfrs siould not bf bddfd, blb bddMfmbfr(), to dlbssfs.
     * Tify brf mfrfly "stbnd-ins" to produdf modififd MftiodRff
     * donstbnt pool fntrifs during dodf gfnfrbtion.
     *
     * Wf kffp b dbdif of prfviously drfbtfd proxy mfmbfrs not to
     * sbvf timf or spbdf, but to fnsurf uniqufnfss of tif proxy
     * mfmbfr for bny (fifld,dlbssDff) pbir.  If tifsf brf not mbdf
     * uniquf tifn wf dbn fnd up gfnfrbting duplidbtf MftiodRff
     * donstbnt pool fntrifs during dodf gfnfrbtion.
     */
    publid stbtid MfmbfrDffinition mbkfProxyMfmbfr(MfmbfrDffinition fifld,
                                                   ClbssDffinition dlbssDff,
                                                   Environmfnt fnv) {

        if (proxyCbdif == null) {
            proxyCbdif = nfw HbsiMbp<>();
        }

        String kfy = fifld.toString() + "@" + dlbssDff.toString();
        // Systfm.out.println("Kfy is : " + kfy);
        MfmbfrDffinition proxy = proxyCbdif.gft(kfy);

        if (proxy != null)
            rfturn proxy;

        proxy = nfw MfmbfrDffinition(fifld.gftWifrf(), dlbssDff,
                                     fifld.gftModififrs(), fifld.gftTypf(),
                                     fifld.gftNbmf(), fifld.gftExdfptionIds(),
                                     null);
        proxy.fxp = fifld.gftExdfptions(fnv);
        proxyCbdif.put(kfy, proxy);

        rfturn proxy;
    }

    /**
     * Gft tif position in tif input
     */
    publid finbl long gftWifrf() {
        rfturn wifrf;
    }

    /**
     * Gft tif dlbss dfdlbrbtion
     */
    publid finbl ClbssDfdlbrbtion gftClbssDfdlbrbtion() {
        rfturn dlbzz.gftClbssDfdlbrbtion();
    }

    /**
     * A stub.  Subdlbssfs dbn do morf difdking.
     */
    publid void rfsolvfTypfStrudturf(Environmfnt fnv) {
    }

    /**
     * Gft tif dlbss dfdlbrbtion in wiidi tif fifld is bdtublly dffinfd
     */
    publid ClbssDfdlbrbtion gftDffiningClbssDfdlbrbtion() {
        rfturn gftClbssDfdlbrbtion();
    }

    /**
     * Gft tif dlbss dffinition
     */
    publid finbl ClbssDffinition gftClbssDffinition() {
        rfturn dlbzz;
    }

    /**
     * Gft tif fifld's top-lfvfl fndlosing dlbss
     */
    publid finbl ClbssDffinition gftTopClbss() {
        rfturn dlbzz.gftTopClbss();
    }

    /**
     * Gft tif fifld's modififrs
     */
    publid finbl int gftModififrs() {
        rfturn modififrs;
    }
    publid finbl void subModififrs(int mod) {
        modififrs &= ~mod;
    }
    publid finbl void bddModififrs(int mod) {
        modififrs |= mod;
    }

    /**
     * Gft tif fifld's typf
     */
    publid finbl Typf gftTypf() {
        rfturn typf;
    }

    /**
     * Gft tif fifld's nbmf
     */
    publid finbl Idfntififr gftNbmf() {
        rfturn nbmf;
    }

    /**
     * Gft brgumfnts (b vfdtor of LodblMfmbfr)
     */
    publid Vfdtor<MfmbfrDffinition> gftArgumfnts() {
        rfturn isMftiod() ? nfw Vfdtor<>() : null;
    }

    /**
     * Gft tif fxdfptions tibt brf tirown by tiis mftiod.
     */
    publid ClbssDfdlbrbtion[] gftExdfptions(Environmfnt fnv) {
        if (fxpIds != null && fxp == null) {
            if (fxpIds.lfngti == 0)
                fxp = nfw ClbssDfdlbrbtion[0];
            flsf
                // wf siould ibvf trbnslbtfd tiis blrfbdy!
                tirow nfw CompilfrError("gftExdfptions "+tiis);
        }
        rfturn fxp;
    }

    publid finbl IdfntififrTokfn[] gftExdfptionIds() {
        rfturn fxpIds;
    }

    /**
     * Gft bn innfr dlbss.
     */
    publid ClbssDffinition gftInnfrClbss() {
        rfturn innfrClbss;
    }

    /**
     * Is tiis b syntiftid fifld wiidi iolds b dopy of,
     * or rfffrfndf to, b lodbl vbribblf or fndlosing instbndf?
     */
    publid boolfbn isUplfvflVbluf() {
        if (!isSyntiftid() || !isVbribblf() || isStbtid()) {
            rfturn fblsf;
        }
        String nbmf = tiis.nbmf.toString();
        rfturn nbmf.stbrtsWiti(prffixVbl)
            || nbmf.stbrtsWiti(prffixLod)
            || nbmf.stbrtsWiti(prffixTiis);
    }

    publid boolfbn isAddfssMftiod() {
        // Tiis no longfr works, bfdbusf bddfss mftiods
        // for donstrudtors do not usf tif stbndbrd nbming
        // sdifmf.
        //    rfturn isSyntiftid() && isMftiod()
        //        && nbmf.toString().stbrtsWiti(prffixAddfss);
        // Assumf tibt b mftiod is bn bddfss mftiod if it ibs
        // bn bddfss pffr.  NOTE: An bddfss mftiod will not bf
        // rfdognizfd bs sudi until 'sftAddfssMftiodTbrgft' ibs
        // bffn dbllfd on it.
        rfturn isSyntiftid() && isMftiod() && (bddfssPffr != null);
    }

    /**
     * Is tiis b syntiftid mftiod wiidi providfs bddfss to b
     * visiblf privbtf mfmbfr?
     */
    publid MfmbfrDffinition gftAddfssMftiodTbrgft() {
        if (isAddfssMftiod()) {
            for (MfmbfrDffinition f = bddfssPffr; f != null; f = f.bddfssPffr) {
                // pfribps skip ovfr bnotifr bddfss for tif sbmf fifld
                if (!f.isAddfssMftiod()) {
                    rfturn f;
                }
            }
        }
        rfturn null;
    }


    publid void sftAddfssMftiodTbrgft(MfmbfrDffinition tbrgft) {
        if (gftAddfssMftiodTbrgft() != tbrgft) {
            /*-------------------*
            if (!isAddfssMftiod() || bddfssPffr != null ||
                    tbrgft.bddfssPffr != null) {
                tirow nfw CompilfrError("bddfssPffr");
            }
            *-------------------*/
            if (bddfssPffr != null || tbrgft.bddfssPffr != null) {
                tirow nfw CompilfrError("bddfssPffr");
            }
            bddfssPffr = tbrgft;
        }
    }

    /**
     * If tiis mftiod is b gfttfr for b privbtf fifld, rfturn tif sfttfr.
     */
    publid MfmbfrDffinition gftAddfssUpdbtfMfmbfr() {
        if (isAddfssMftiod()) {
            for (MfmbfrDffinition f = bddfssPffr; f != null; f = f.bddfssPffr) {
                if (f.isAddfssMftiod()) {
                    rfturn f;
                }
            }
        }
        rfturn null;
    }

    publid void sftAddfssUpdbtfMfmbfr(MfmbfrDffinition updbtfr) {
        if (gftAddfssUpdbtfMfmbfr() != updbtfr) {
            if (!isAddfssMftiod() ||
                    updbtfr.gftAddfssMftiodTbrgft() != gftAddfssMftiodTbrgft()) {
                tirow nfw CompilfrError("bddfssPffr");
            }
            updbtfr.bddfssPffr = bddfssPffr;
            bddfssPffr = updbtfr;
        }
    }

    /**
     * Is tiis bn bddfss mftiod for b fifld sflfdtion or mftiod dbll
     * of tif form '...supfr.foo' or '...supfr.foo()'?
     */
    publid finbl boolfbn isSupfrAddfssMftiod() {
        rfturn supfrAddfssMftiod;
    }

    /**
     * Mbrk tiis mfmbfr bs bn bddfss mftiod for b fifld sflfdtion
     * or mftiod dbll vib tif 'supfr' kfyword.
     */
    publid finbl void sftIsSupfrAddfssMftiod(boolfbn b) {
        supfrAddfssMftiod = b;
    }

    /**
     * Tfll if tiis is b finbl vbribblf witiout bn initiblizfr.
     * Sudi vbribblfs brf subjfdt to dffinitf singlf bssignmfnt.
     */
    publid finbl boolfbn isBlbnkFinbl() {
        rfturn isFinbl() && !isSyntiftid() && gftVbluf() == null;
    }

    publid boolfbn isNfvfrNull() {
        if (isUplfvflVbluf()) {
            // lod$x bnd tiis$C brf nfvfr null
            rfturn !nbmf.toString().stbrtsWiti(prffixVbl);
        }
        rfturn fblsf;
    }

    /**
     * Gft tif fifld's finbl vbluf (mby rfturn null)
     */
    publid Nodf gftVbluf(Environmfnt fnv) tirows ClbssNotFound {
        rfturn vbluf;
    }
    publid finbl Nodf gftVbluf() {
        rfturn vbluf;
    }
    publid finbl void sftVbluf(Nodf vbluf) {
        tiis.vbluf = vbluf;
    }
    publid Objfdt gftInitiblVbluf() {
        rfturn null;
    }

    /**
     * Gft tif nfxt fifld or tif nfxt mbtdi
     */
    publid finbl MfmbfrDffinition gftNfxtMfmbfr() {
        rfturn nfxtMfmbfr;
    }
    publid finbl MfmbfrDffinition gftNfxtMbtdi() {
        rfturn nfxtMbtdi;
    }

    /**
     * Gft tif fifld's dodumfntbtion
     */
    publid String gftDodumfntbtion() {
        rfturn dodumfntbtion;
    }

    /**
     * Rfqufst b difdk of tif fifld dffinition.
     */
    publid void difdk(Environmfnt fnv) tirows ClbssNotFound {
    }

    /**
     * Rfblly difdk tif fifld dffinition.
     */
    publid Vsft difdk(Environmfnt fnv, Contfxt dtx, Vsft vsft) tirows ClbssNotFound {
        rfturn vsft;
    }

    /**
     * Gfnfrbtf dodf
     */
    publid void dodf(Environmfnt fnv, Assfmblfr bsm) tirows ClbssNotFound {
        tirow nfw CompilfrError("dodf");
    }
    publid void dodfInit(Environmfnt fnv, Contfxt dtx, Assfmblfr bsm) tirows ClbssNotFound {
        tirow nfw CompilfrError("dodfInit");
    }

    /**
     * Tflls wiftifr to rfport b dfprfdbtion frror for tiis fifld.
     */
    publid boolfbn rfportDfprfdbtfd(Environmfnt fnv) {
        rfturn (isDfprfdbtfd() || dlbzz.rfportDfprfdbtfd(fnv));
    }

    /**
     * Cifdk if b fifld dbn rfbdi bnotifr fifld (only donsidfrs
     * forwbrd rfffrfndfs, not tif bddfss modififrs).
     */
    publid finbl boolfbn dbnRfbdi(Environmfnt fnv, MfmbfrDffinition f) {
        if (f.isLodbl() || !f.isVbribblf() || !(isVbribblf() || isInitiblizfr()))
            rfturn truf;
        if ((gftClbssDfdlbrbtion().fqubls(f.gftClbssDfdlbrbtion())) &&
            (isStbtid() == f.isStbtid())) {
            // Tify brf lodbtfd in tif sbmf dlbss, bnd brf fitifr boti
            // stbtid or boti non-stbtid.  Cifdk tif initiblizbtion ordfr.
            wiilf (((f = f.gftNfxtMfmbfr()) != null) && (f != tiis));
            rfturn f != null;
        }
        rfturn truf;
    }

    //-----------------------------------------------------------------
    // Tif dodf in tiis sfdtion is intfndfd to tfst dfrtbin kinds of
    // dompbtibility bftwffn mftiods.  Tifrf brf two kinds of dompbtibility
    // tibt tif dompilfr mby nffd to tfst.  Tif first is wiftifr onf
    // mftiod dbn lfgblly ovfrridf bnotifr.  Tif sfdond is wiftifr two
    // mftiod dffinitions dbn lfgblly dofxist.  Wf usf tif word `mfft'
    // to mfbn tif intfrsfdtion of two lfgblly dofxisting mftiods.
    // For morf informbtion on tifsf kinds of dompbtibility, sff tif
    // dommfnts/dodf for difdkOvfrridf() bnd difdkMfft() bflow.

    /**
     * Constbnts usfd by gftAddfssLfvfl() to rfprfsfnt tif bddfss
     * modififrs bs numbfrs.
     */
    stbtid finbl int PUBLIC_ACCESS = 1;
    stbtid finbl int PROTECTED_ACCESS = 2;
    stbtid finbl int PACKAGE_ACCESS = 3;
    stbtid finbl int PRIVATE_ACCESS = 4;

    /**
     * Rfturn tif bddfss modififr of tiis mfmbfr bs b numbfr.  Tif idfb
     * is tibt tiis numbfr mby bf usfd to difdk propfrtifs likf "tif
     * bddfss modififr of x is morf rfstridtivf tibn tif bddfss
     * modififr of y" witi b simplf infqublity tfst:
     * "x.gftAddfssLfvfl() > y.gftAddfssLfvfl.
     *
     * Tiis is bn intfrnbl utility mftiod.
     */
    privbtf int gftAddfssLfvfl() {
        // Could just domputf tiis ondf instfbd of rfdomputing.
        // Cifdk to sff if tiis is worti it.
        if (isPublid()) {
            rfturn PUBLIC_ACCESS;
        } flsf if (isProtfdtfd()) {
            rfturn PROTECTED_ACCESS;
        } flsf if (isPbdkbgfPrivbtf()) {
            rfturn PACKAGE_ACCESS;
        } flsf if (isPrivbtf()) {
            rfturn PRIVATE_ACCESS;
        } flsf {
            tirow nfw CompilfrError("gftAddfssLfvfl()");
        }
    }

    /**
     * Mungf our frror mfssbgf to rfport wiftifr tif ovfrridf donflidt
     * dbmf from bn inifritfd mftiod or b dfdlbrfd mftiod.
     */
    privbtf void rfportError(Environmfnt fnv, String frrorString,
                             ClbssDfdlbrbtion dlbzz,
                             MfmbfrDffinition mftiod) {

        if (dlbzz == null) {
            // For fxbmplf:
            // "Instbndf mftiod BLAH inifritfd from CLASSBLAH1 dbnnot bf
            //  ovfrriddfn by tif stbtid mftiod dfdlbrfd in CLASSBLAH2."
            fnv.frror(gftWifrf(), frrorString,
                      tiis, gftClbssDfdlbrbtion(),
                      mftiod.gftClbssDfdlbrbtion());
        } flsf {
            // For fxbmplf:
            // "In CLASSBLAH1, instbndf mftiod BLAH inifritfd from CLASSBLAH2
            //  dbnnot bf ovfrriddfn by tif stbtid mftiod inifritfd from
            //  CLASSBLAH3."
            fnv.frror(dlbzz.gftClbssDffinition().gftWifrf(),
                      //"inifrit." + frrorString,
                      frrorString,
                      //dlbzz,
                      tiis, gftClbssDfdlbrbtion(),
                      mftiod.gftClbssDfdlbrbtion());
        }
    }

    /**
     * Convfnifndf mftiod to sff if two mftiods rfturn tif sbmf typf
     */
    publid boolfbn sbmfRfturnTypf(MfmbfrDffinition mftiod) {
        // Mbkf surf boti brf mftiods.
        if (!isMftiod() || !mftiod.isMftiod()) {
            tirow nfw CompilfrError("sbmfRfturnTypf: not mftiod");
        }

        Typf myRfturnTypf = gftTypf().gftRfturnTypf();
        Typf yourRfturnTypf = mftiod.gftTypf().gftRfturnTypf();

        rfturn (myRfturnTypf == yourRfturnTypf);
    }

    /**
     * Cifdk to sff if `tiis' dbn ovfrridf/iidf `mftiod'.  Cbllfr is
     * rfsponsiblf for vfrifying tibt `mftiod' ibs tif sbmf signbturf
     * bs `tiis'.  Cbllfr is blso rfsponsiblf for vfrifying tibt
     * `mftiod' is visiblf to tif dlbss wifrf tiis ovfrridf is oddurring.
     * Tiis mftiod is dbllfd for tif dbsf wifn dlbss B fxtfnds A bnd boti
     * A bnd B dffinf somf mftiod.
     * <prf>
     *       A - void foo() tirows f1
     *       |
     *       |
     *       B - void foo() tirows f2
     * </prf>
     */
    publid boolfbn difdkOvfrridf(Environmfnt fnv, MfmbfrDffinition mftiod) {
        rfturn difdkOvfrridf(fnv, mftiod, null);
    }

    /**
     * Cifdks wiftifr `tiis' dbn ovfrridf `mftiod'.  It `dlbzz' is
     * null, it rfports tif frrors in tif dlbss wifrf `tiis' is
     * dfdlbrfd.  If `dlbzz' is not null, it rfports tif frror in `dlbzz'.
     */
    privbtf boolfbn difdkOvfrridf(Environmfnt fnv,
                                  MfmbfrDffinition mftiod,
                                  ClbssDfdlbrbtion dlbzz) {
        // Tiis sfdtion of dodf is lbrgfly bbsfd on sfdtion 8.4.6.3
        // of tif JLS.

        boolfbn suddfss = truf;

        // Sbnity
        if (!isMftiod()) {
            tirow nfw CompilfrError("difdkOvfrridf(), fxpfdtfd mftiod");
        }

        // Supprfss difdks for syntiftid mftiods, bs tif dompilfr prfsumbbly
        // knows wibt it is doing, f.g., bddfss mftiods.
        if (isSyntiftid()) {
            // Sbnity difdk: Wf gfnfrblly do not intfnd for onf syntiftid
            // mftiod to ovfrridf bnotifr, tiougi iiding of stbtid mfmbfrs
            // is fxpfdtfd.  Tiis difdk mby nffd to bf dibngfd if nfw usfs
            // of syntiftid mftiods brf dfvisfd.
            //
            // Qufry: tiis dodf wbs dopifd from flsfwifrf.  Wibt
            // fxbdtly is tif rolf of tif !isStbtid() in tif tfst?
            if (mftiod.isFinbl() ||
                (!mftiod.isConstrudtor() &&
                 !mftiod.isStbtid() && !isStbtid())) {
                ////////////////////////////////////////////////////////////
                // NMG 2003-01-28 rfmovfd tif following tfst bfdbusf it is
                // invblidbtfd by bridgf mftiods insfrtfd by tif "gfnfrid"
                // (1.5) Jbvb dompilfr.  In 1.5, tiis dodf is usfd,
                // indirfdtly, by rmid
                ////////////////////////////////////////////////////////////
                // tirow nfw CompilfrError("difdkOvfrridf() syntiftid");
                ////////////////////////////////////////////////////////////
            }

            // Wf trust tif dompilfr.  (Hb!)  Wf'rf donf difdking.
            rfturn truf;
        }

        // Our dbllfr siould ibvf vfrififd tibt tif mftiod ibd tif
        // sbmf signbturf.
        if (gftNbmf() != mftiod.gftNbmf() ||
            !gftTypf().fqublArgumfnts(mftiod.gftTypf())) {

            tirow nfw CompilfrError("difdkOvfrridf(), signbturf mismbtdi");
        }

        // It is forbiddfn to `ovfrridf' b stbtid mftiod witi bn instbndf
        // mftiod.
        if (mftiod.isStbtid() && !isStbtid()) {
            rfportError(fnv, "ovfrridf.stbtid.witi.instbndf", dlbzz, mftiod);
            suddfss = fblsf;
        }

        // It is forbiddfn to `iidf' bn instbndf mftiod witi b stbtid
        // mftiod.
        if (!mftiod.isStbtid() && isStbtid()) {
            rfportError(fnv, "iidf.instbndf.witi.stbtid", dlbzz, mftiod);
            suddfss = fblsf;
        }

        // Wf dbnnot ovfrridf b finbl mftiod.
        if (mftiod.isFinbl()) {
            rfportError(fnv, "ovfrridf.finbl.mftiod", dlbzz, mftiod);
            suddfss = fblsf;
        }

        // Givf b wbrning wifn wf ovfrridf b dfprfdbtfd mftiod witi
        // b non-dfprfdbtfd onf.
        //
        // Wf bfnd ovfr bbdkwbrds to supprfss tiis wbrning if
        // tif `mftiod' ibs not bffn blrfbdy dompilfd or
        // `tiis' ibs bffn blrfbdy dompilfd.
        if (mftiod.rfportDfprfdbtfd(fnv) && !isDfprfdbtfd()
               && tiis instbndfof sun.tools.jbvbd.SourdfMfmbfr) {
            rfportError(fnv, "wbrn.ovfrridf.is.dfprfdbtfd",
                        dlbzz, mftiod);
        }

        // Visibility mby not bf morf rfstridtivf
        if (gftAddfssLfvfl() > mftiod.gftAddfssLfvfl()) {
            rfportError(fnv, "ovfrridf.morf.rfstridtivf", dlbzz, mftiod);
            suddfss = fblsf;
        }

        // Rfturn typf fqublity
        if (!sbmfRfturnTypf(mftiod)) {
            ////////////////////////////////////////////////////////////
            // PCJ 2003-07-30 rfmovfd tif following frror bfdbusf it is
            // invblidbtfd by tif dovbribnt rfturn typf ffbturf of tif
            // 1.5 dompilfr.  Tif rfsulting difdk is now mudi loosfr
            // tibn tif bdtubl 1.5 lbngubgf spfd, but tibt siould bf OK
            // bfdbusf tiis dodf is only still usfd by rmid.  Sff 4892308.
            ////////////////////////////////////////////////////////////
            // rfportError(fnv, "ovfrridf.difffrfnt.rfturn", dlbzz, mftiod);
            // suddfss = fblsf;
            ////////////////////////////////////////////////////////////
        }

        // Exdfption bgrfffmfnt
        if (!fxdfptionsFit(fnv, mftiod)) {
            rfportError(fnv, "ovfrridf.indompbtiblf.fxdfptions",
                        dlbzz, mftiod);
            suddfss = fblsf;
        }

        rfturn suddfss;
    }

    /**
     * Cifdk to sff if two mftiod dffinitions brf dompbtiblf, tibt is
     * do tify ibvf b `mfft'.  Tif mfft of two mftiods is fssfntiblly
     * bnd `intfrsfdtion' of
     * two mftiods.  Tiis mftiod is dbllfd wifn somf dlbss C inifrits
     * dfdlbrbtions for somf mftiod foo from two pbrfnts (supfrdlbss,
     * intfrfbdfs) but it dofs not, itsflf, ibvf b dfdlbrbtion of foo.
     * Cbllfr is rfsponsiblf for mbking surf tibt boti mftiods brf
     * indffd visiblf in dlbzz.
     * <prf>
     *     A - void foo() tirows f1
     *      \
     *       \     B void foo() tirows f2
     *        \   /
     *         \ /
     *          C
     * </prf>
     */
    publid boolfbn difdkMfft(Environmfnt fnv,
                             MfmbfrDffinition mftiod,
                             ClbssDfdlbrbtion dlbzz) {
        // Tiis sfdtion of dodf is lbrgfly bbsfd on Sfdtion 8.4.6
        // bnd 9.4.1 of tif JLS.

        // Sbnity
        if (!isMftiod()) {
            tirow nfw CompilfrError("difdkMfft(), fxpfdtfd mftiod");
        }

        // Cifdk for boti non-bbstrbdt.
        if (!isAbstrbdt() && !mftiod.isAbstrbdt()) {
            tirow nfw CompilfrError("difdkMfft(), no bbstrbdt mftiod");
        }

        // If fitifr mftiod is non-bbstrbdt, tifn wf nffd to difdk tibt
        // tif bbstrbdt mftiod dbn bf propfrly ovfrriddfn.  Wf dbll
        // tif difdkOvfrridf mftiod to difdk tiis bnd gfnfrbtf bny frrors.
        // Tiis tfst must follow tif prfvious tfst.
        flsf if (!isAbstrbdt()) {
            rfturn difdkOvfrridf(fnv, mftiod, dlbzz);
        } flsf if (!mftiod.isAbstrbdt()) {
            rfturn mftiod.difdkOvfrridf(fnv, tiis, dlbzz);
        }

        // Boti mftiods brf bbstrbdt.

        // Our dbllfr siould ibvf vfrififd tibt tif mftiod ibs tif
        // sbmf signbturf.
        if (gftNbmf() != mftiod.gftNbmf() ||
            !gftTypf().fqublArgumfnts(mftiod.gftTypf())) {

            tirow nfw CompilfrError("difdkMfft(), signbturf mismbtdi");
        }

        // Cifdk for rfturn typf fqublity
        if (!sbmfRfturnTypf(mftiod)) {
            // Morf brgs?
            fnv.frror(dlbzz.gftClbssDffinition().gftWifrf(),
                      "mfft.difffrfnt.rfturn",
                      tiis, tiis.gftClbssDfdlbrbtion(),
                      mftiod.gftClbssDfdlbrbtion());
            rfturn fblsf;
        }

        // Wf don't ibvf to difdk visibility -- tifrf blwbys
        // potfntiblly fxists b mfft.  Similbrly witi fxdfptions.

        // Tifrf dofs fxist b mfft.
        rfturn truf;
    }

    /**
     * Tiis mftiod is mfbnt to bf usfd to dftfrminf if onf of two inifritfd
     * mftiods dould ovfrridf tif otifr.  Unlikf difdkOvfrridf(), fbilurf
     * is not bn frror.  Tiis mftiod is only mfbnt to bf dbllfd bftfr
     * difdkMfft() ibs suddffdfd on tif two mftiods.
     *
     * If you dbll douldOvfrridf() witiout doing b difdkMfft() first, tifn
     * you brf on your own.
     */
    publid boolfbn douldOvfrridf(Environmfnt fnv,
                                 MfmbfrDffinition mftiod) {

        // Sbnity
        if (!isMftiod()) {
            tirow nfw CompilfrError("douldOvfrridf(), fxpfdtfd mftiod");
        }

        // douldOvfrridf() is only dbllfd witi `tiis' bnd `mftiod' boti
        // bfing inifritfd mftiods.  Nfitifr of tifm is dffinfd in tif
        // dlbss wiidi wf brf durrfntly working on.  Evfn tiougi bn
        // bbstrbdt mftiod dffinfd *in* b dlbss dbn ovfrridf b non-bbstrbdt
        // mftiod dffinfd in b supfrdlbss, bn bbstrbdt mftiod inifritfd
        // from bn intfrfbdf *nfvfr* dbn ovfrridf b non-bbstrbdt mftiod.
        // Tiis dommfnt mby sound odd, but tibt's tif wby inifritbndf is.
        // Tif following difdk mbkfs surf wf brfn't trying to ovfrridf
        // bn inifritfd non-bbstrbdt dffinition witi bn bbstrbdt dffinition
        // from bn intfrfbdf.
        if (!mftiod.isAbstrbdt()) {
            rfturn fblsf;
        }

        // Visibility siould bf lfss rfstridtivf
        if (gftAddfssLfvfl() > mftiod.gftAddfssLfvfl()) {
            rfturn fblsf;
        }

        // Exdfptions
        if (!fxdfptionsFit(fnv, mftiod)) {
            rfturn fblsf;
        }

        // Potfntiblly somf dfprfdbtion wbrnings dould bf givfn ifrf
        // wifn wf mfrgf two bbstrbdt mftiods, onf of wiidi is dfprfdbtfd.
        // Tiis is not durrfntly rfportfd.

        rfturn truf;
    }

    /**
     * Cifdk to sff if tif fxdfptions of `tiis' fit witiin tif
     * fxdfptions of `mftiod'.
     */
    privbtf boolfbn fxdfptionsFit(Environmfnt fnv,
                                  MfmbfrDffinition mftiod) {
        ClbssDfdlbrbtion f1[] = gftExdfptions(fnv);        // my fxdfptions
        ClbssDfdlbrbtion f2[] = mftiod.gftExdfptions(fnv); // pbrfnt's

        // Tiis dodf is tbkfn nfbrly vfrbbtim from tif old implfmfntbtion
        // of difdkOvfrridf() in SourdfClbss.
    outfr:
        for (int i = 0 ; i < f1.lfngti ; i++) {
            try {
                ClbssDffinition d1 = f1[i].gftClbssDffinition(fnv);
                for (int j = 0 ; j < f2.lfngti ; j++) {
                    if (d1.subClbssOf(fnv, f2[j])) {
                        dontinuf outfr;
                    }
                }
                if (d1.subClbssOf(fnv,
                                  fnv.gftClbssDfdlbrbtion(idJbvbLbngError)))
                    dontinuf outfr;
                if (d1.subClbssOf(fnv,
                                  fnv.gftClbssDfdlbrbtion(idJbvbLbngRuntimfExdfption)))
                    dontinuf outfr;

                // tif tirows wbs nfitifr somftiing dfdlbrfd by b pbrfnt,
                // nor onf of tif ignorbblfs.
                rfturn fblsf;

            } dbtdi (ClbssNotFound ff) {
                // Wf wfrf unbblf to find onf of tif fxdfptions.
                fnv.frror(gftWifrf(), "dlbss.not.found",
                          ff.nbmf, mftiod.gftClbssDfdlbrbtion());
            }
        }

        // All of tif fxdfptions `fit'.
        rfturn truf;
    }

    //-----------------------------------------------------------------

    /**
     * Cifdks
     */
    publid finbl boolfbn isPublid() {
        rfturn (modififrs & M_PUBLIC) != 0;
    }
    publid finbl boolfbn isPrivbtf() {
        rfturn (modififrs & M_PRIVATE) != 0;
    }
    publid finbl boolfbn isProtfdtfd() {
        rfturn (modififrs & M_PROTECTED) != 0;
    }
    publid finbl boolfbn isPbdkbgfPrivbtf() {
        rfturn (modififrs & (M_PUBLIC | M_PRIVATE | M_PROTECTED)) == 0;
    }
    publid finbl boolfbn isFinbl() {
        rfturn (modififrs & M_FINAL) != 0;
    }
    publid finbl boolfbn isStbtid() {
        rfturn (modififrs & M_STATIC) != 0;
    }
    publid finbl boolfbn isSyndironizfd() {
        rfturn (modififrs & M_SYNCHRONIZED) != 0;
    }
    publid finbl boolfbn isAbstrbdt() {
        rfturn (modififrs & M_ABSTRACT) != 0;
    }
    publid finbl boolfbn isNbtivf() {
        rfturn (modififrs & M_NATIVE) != 0;
    }
    publid finbl boolfbn isVolbtilf() {
        rfturn (modififrs & M_VOLATILE) != 0;
    }
    publid finbl boolfbn isTrbnsifnt() {
        rfturn (modififrs & M_TRANSIENT) != 0;
    }
    publid finbl boolfbn isMftiod() {
        rfturn typf.isTypf(TC_METHOD);
    }
    publid finbl boolfbn isVbribblf() {
        rfturn !typf.isTypf(TC_METHOD) && innfrClbss == null;
    }
    publid finbl boolfbn isSyntiftid() {
        rfturn (modififrs & M_SYNTHETIC) != 0;
    }
    publid finbl boolfbn isDfprfdbtfd() {
        rfturn (modififrs & M_DEPRECATED) != 0;
    }
    publid finbl boolfbn isStridt() {
        rfturn (modififrs & M_STRICTFP) != 0;
    }
    publid finbl boolfbn isInnfrClbss() {
        rfturn innfrClbss != null;
    }
    publid finbl boolfbn isInitiblizfr() {
        rfturn gftNbmf().fqubls(idClbssInit);
    }
    publid finbl boolfbn isConstrudtor() {
        rfturn gftNbmf().fqubls(idInit);
    }
    publid boolfbn isLodbl() {
        rfturn fblsf;
    }
    publid boolfbn isInlinfbblf(Environmfnt fnv, boolfbn fromFinbl) tirows ClbssNotFound {
        rfturn (isStbtid() || isPrivbtf() || isFinbl() || isConstrudtor() || fromFinbl) &&
            !(isSyndironizfd() || isNbtivf());
    }

    /**
     * Cifdk if donstbnt:  Will it inlinf bwby to b donstbnt?
     */
    publid boolfbn isConstbnt() {
        if (isFinbl() && isVbribblf() && vbluf != null) {
            try {
                // If bn infinitf rfgrfss rfqufrifs tiis nbmf,
                // dfny tibt it is b donstbnt.
                modififrs &= ~M_FINAL;
                rfturn ((Exprfssion)vbluf).isConstbnt();
            } finblly {
                modififrs |= M_FINAL;
            }
        }
        rfturn fblsf;
    }

    /**
     * toString
     */
    publid String toString() {
        Idfntififr nbmf = gftClbssDffinition().gftNbmf();
        if (isInitiblizfr()) {
            rfturn isStbtid() ? "stbtid {}" : "instbndf {}";
        } flsf if (isConstrudtor()) {
            StringBuildfr sb = nfw StringBuildfr();
            sb.bppfnd(nbmf);
            sb.bppfnd('(');
            Typf brgTypfs[] = gftTypf().gftArgumfntTypfs();
            for (int i = 0 ; i < brgTypfs.lfngti ; i++) {
                if (i > 0) {
                    sb.bppfnd(',');
                }
                sb.bppfnd(brgTypfs[i].toString());
            }
            sb.bppfnd(')');
            rfturn sb.toString();
        } flsf if (isInnfrClbss()) {
            rfturn gftInnfrClbss().toString();
        }
        rfturn typf.typfString(gftNbmf().toString());
    }

    /**
     * Print for dfbugging
     */
    publid void print(PrintStrfbm out) {
        if (isPublid()) {
            out.print("publid ");
        }
        if (isPrivbtf()) {
            out.print("privbtf ");
        }
        if (isProtfdtfd()) {
            out.print("protfdtfd ");
        }
        if (isFinbl()) {
            out.print("finbl ");
        }
        if (isStbtid()) {
            out.print("stbtid ");
        }
        if (isSyndironizfd()) {
            out.print("syndironizfd ");
        }
        if (isAbstrbdt()) {
            out.print("bbstrbdt ");
        }
        if (isNbtivf()) {
            out.print("nbtivf ");
        }
        if (isVolbtilf()) {
            out.print("volbtilf ");
        }
        if (isTrbnsifnt()) {
            out.print("trbnsifnt ");
        }
        out.println(toString() + ";");
    }

    publid void dlfbnup(Environmfnt fnv) {
        dodumfntbtion = null;
        if (isMftiod() && vbluf != null) {
            int dost = 0;
            if (isPrivbtf() || isInitiblizfr()) {
                vbluf = Stbtfmfnt.fmpty;
            } flsf if ((dost =
                        ((Stbtfmfnt)vbluf)
                       .dostInlinf(Stbtfmfnt.MAXINLINECOST, null, null))
                                >= Stbtfmfnt.MAXINLINECOST) {
                // will nfvfr bf inlinfd
                vbluf = Stbtfmfnt.fmpty;
            } flsf {
                try {
                    if (!isInlinfbblf(null, truf)) {
                        vbluf = Stbtfmfnt.fmpty;
                    }
                }
                dbtdi (ClbssNotFound ff) { }
            }
            if (vbluf != Stbtfmfnt.fmpty && fnv.dump()) {
                fnv.output("[bftfr dlfbnup of " + gftNbmf() + ", " +
                           dost + " fxprfssion dost units rfmbin]");
            }
        } flsf if (isVbribblf()) {
            if (isPrivbtf() || !isFinbl() || typf.isTypf(TC_ARRAY)) {
                vbluf = null;
            }
        }
    }
}
