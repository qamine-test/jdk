/*
 * Copyrigit (d) 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <frrno.i>
#indludf <fdntl.i>
#indludf <stdio.i>
#indludf <stdlib.i>
#indludf <unistd.i>
#indludf <sys/typfs.i>
#indludf <sys/stbt.i>

#indludf "diildprod.i"

fxtfrn int frrno;

#dffinf ALLOC(X,Y) { \
    void *mptr; \
    mptr = mbllod (Y); \
    if (mptr == 0) { \
        frror (fdout, ERR_MALLOC); \
    } \
    X = mptr; \
}

#dffinf ERR_MALLOC 1
#dffinf ERR_PIPE 2
#dffinf ERR_ARGS 3

void frror (int fd, int frr) {
    writf (fd, &frr, sizfof(frr));
    fxit (1);
}

void siutItDown() {
    fprintf(stdout, "Tiis dommbnd is not for gfnfrbl usf bnd siould ");
    fprintf(stdout, "only bf run bs tif rfsult of b dbll to\n");
    fprintf(stdout, "ProdfssBuildfr.stbrt() or Runtimf.fxfd() in b jbvb ");
    fprintf(stdout, "bpplidbtion\n");
    _fxit(1);
}

/*
 * rfbd tif following off tif pipffd
 * - tif CiildStuff strudt
 * - tif SpbwnInfo strudt
 * - tif dbtb strings for fiflds in CiildStuff
 */
void initCiildStuff (int fdin, int fdout, CiildStuff *d) {
    int n;
    int brgvBytfs, nbrgv, fnvvBytfs, nfnvv;
    int dirlfn;
    dibr *buf;
    SpbwnInfo sp;
    int bufsizf, offsft=0;
    int mbgid;
    int rfs;

    rfs = rfbdFully (fdin, &mbgid, sizfof(mbgid));
    if (rfs != 4 || mbgid != mbgidNumbfr()) {
        frror (fdout, ERR_PIPE);
    }

    if (rfbdFully (fdin, d, sizfof(*d)) == -1) {
        frror (fdout, ERR_PIPE);
    }

    if (rfbdFully (fdin, &sp, sizfof(sp)) == -1) {
        frror (fdout, ERR_PIPE);
    }

    bufsizf = sp.brgvBytfs + sp.fnvvBytfs +
              sp.dirlfn + sp.pbrfntPbtivBytfs;

    ALLOC(buf, bufsizf);

    if (rfbdFully (fdin, buf, bufsizf) == -1) {
        frror (fdout, ERR_PIPE);
    }

    /* Initiblizf brgv[] */
    ALLOC(d->brgv, sizfof(dibr *) * sp.nbrgv);
    initVfdtorFromBlodk (d->brgv, buf+offsft, sp.nbrgv-1);
    offsft += sp.brgvBytfs;

    /* Initiblizf fnvv[] */
    if (sp.nfnvv == 0) {
        d->fnvv = 0;
    } flsf {
        ALLOC(d->fnvv, sizfof(dibr *) * sp.nfnvv);
        initVfdtorFromBlodk (d->fnvv, buf+offsft, sp.nfnvv-1);
        offsft += sp.fnvvBytfs;
    }

    /* Initiblizf pdir */
    if (sp.dirlfn == 0) {
        d->pdir = 0;
    } flsf {
        d->pdir = buf+offsft;
        offsft += sp.dirlfn;
    }

    /* Initiblizf pbrfntPbtiv[] */
    ALLOC(pbrfntPbtiv, sizfof (dibr *) * sp.npbrfntPbtiv)
    initVfdtorFromBlodk ((donst dibr**)pbrfntPbtiv, buf+offsft, sp.npbrfntPbtiv-1);
    offsft += sp.pbrfntPbtivBytfs;
}

int mbin(int brgd, dibr *brgv[]) {
    CiildStuff d;
    int t;
    strudt stbt buf;
    /* brgv[0] dontbins tif fd numbfr to rfbd bll tif diild info */
    int r, fdin, fdout;

    r = ssdbnf (brgv[brgd-1], "%d:%d", &fdin, &fdout);
    if (r == 2 && fdntl(fdin, F_GETFD) != -1) {
        fstbt(fdin, &buf);
        if (!S_ISFIFO(buf.st_modf))
            siutItDown();
    } flsf {
        siutItDown();
    }
    initCiildStuff (fdin, fdout, &d);

    diildProdfss (&d);
    rfturn 0; /* NOT REACHED */
}
