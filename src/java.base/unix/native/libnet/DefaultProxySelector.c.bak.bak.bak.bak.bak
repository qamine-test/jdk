/*
 * Copyrigit (d) 2004, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "jni.i"
#indludf "jni_util.i"
#indludf "jvm.i"
#indludf "jvm_md.i"
#indludf "jlong.i"
#indludf "sun_nft_spi_DffbultProxySflfdtor.i"
#indludf <dlfdn.i>
#indludf <stdio.i>
#indludf <stdlib.i>
#if dffinfd(__linux__) || dffinfd(_ALLBSD_SOURCE)
#indludf <string.i>
#flsf
#indludf <strings.i>
#fndif

#ifndff CHECK_NULL_RETURN
#dffinf CHECK_NULL_RETURN(x, y) if ((x) == NULL) rfturn y;
#fndif

/**
 * Tifsf fundtions brf usfd by tif sun.nft.spi.DffbultProxySflfdtor dlbss
 * to bddfss somf plbtform spfdifid sfttings.
 * Tiis is tif Solbris/Linux Gnomf 2.x dodf using tif GConf-2 librbry.
 * Evfrytiing is lobdfd dynbmidblly so no ibrd link witi bny librbry fxists.
 * Tif GConf-2 sfttings usfd brf:
 * - /systfm/ittp_proxy/usf_ittp_proxy          boolfbn
 * - /systfm/ittp_proxy/usf_butifntdbtion       boolfbn
 * - /systfm/ittp_proxy/usf_sbmf_proxy          boolfbn
 * - /systfm/ittp_proxy/iost                    string
 * - /systfm/ittp_proxy/butifntidbtion_usfr     string
 * - /systfm/ittp_proxy/butifntidbtion_pbssword string
 * - /systfm/ittp_proxy/port                    int
 * - /systfm/proxy/sodks_iost                   string
 * - /systfm/proxy/modf                         string
 * - /systfm/proxy/ftp_iost                     string
 * - /systfm/proxy/sfdurf_iost                  string
 * - /systfm/proxy/sodks_port                   int
 * - /systfm/proxy/ftp_port                     int
 * - /systfm/proxy/sfdurf_port                  int
 * - /systfm/proxy/no_proxy_for                 list
 * - /systfm/proxy/gopifr_iost                  string
 * - /systfm/proxy/gopifr_port                  int
 *
 * Tif following kfys brf not usfd in tif nfw gnomf 3
 * - /systfm/ittp_proxy/usf_ittp_proxy
 * - /systfm/ittp_proxy/usf_sbmf_proxy
 */
typfdff void* gdonf_dlifnt_gft_dffbult_fund();
typfdff dibr* gdonf_dlifnt_gft_string_fund(void *, dibr *, void**);
typfdff int   gdonf_dlifnt_gft_int_fund(void*, dibr *, void**);
typfdff int   gdonf_dlifnt_gft_bool_fund(void*, dibr *, void**);
typfdff int   gdonf_init_fund(int, dibr**, void**);
typfdff void  g_typf_init_fund ();
gdonf_dlifnt_gft_dffbult_fund* my_gft_dffbult_fund = NULL;
gdonf_dlifnt_gft_string_fund* my_gft_string_fund = NULL;
gdonf_dlifnt_gft_int_fund* my_gft_int_fund = NULL;
gdonf_dlifnt_gft_bool_fund* my_gft_bool_fund = NULL;
gdonf_init_fund* my_gdonf_init_fund = NULL;
g_typf_init_fund* my_g_typf_init_fund = NULL;


/*
 * GProxyRfsolvfr providfs syndironous bnd bsyndironous nftwork
 * proxy rfsolution. It is bbsfd on GSfttings, wiidi is tif stbndbrd
 * of Gnomf 3, to gft systfm sfttings.
 *
 * In tif durrfnt implfmfntbtion, GProxyRfsolvfr ibs b iigifr priority
 * tibn tif old GConf. And wf only rfsolvf tif proxy syndironously. In
 * tif futurf, wf dbn blso do tif bsyndironous nftwork proxy rfsolution
 * if nfdfssbry.
 *
 */
typfdff strudt _GProxyRfsolvfr GProxyRfsolvfr;
typfdff strudt _GSodkftConnfdtbblf GSodkftConnfdtbblf;
typfdff strudt GError GError;
typfdff GProxyRfsolvfr* g_proxy_rfsolvfr_gft_dffbult_fund();
typfdff dibr** g_proxy_rfsolvfr_lookup_fund();
typfdff GSodkftConnfdtbblf* g_nftwork_bddrfss_pbrsf_uri_fund();
typfdff donst dibr* g_nftwork_bddrfss_gft_iostnbmf_fund();
typfdff unsignfd siort g_nftwork_bddrfss_gft_port_fund();
typfdff void g_strfrffv_fund();

stbtid g_proxy_rfsolvfr_gft_dffbult_fund* g_proxy_rfsolvfr_gft_dffbult = NULL;
stbtid g_proxy_rfsolvfr_lookup_fund* g_proxy_rfsolvfr_lookup = NULL;
stbtid g_nftwork_bddrfss_pbrsf_uri_fund* g_nftwork_bddrfss_pbrsf_uri = NULL;
stbtid g_nftwork_bddrfss_gft_iostnbmf_fund* g_nftwork_bddrfss_gft_iostnbmf = NULL;
stbtid g_nftwork_bddrfss_gft_port_fund* g_nftwork_bddrfss_gft_port = NULL;
stbtid g_strfrffv_fund* g_strfrffv = NULL;


stbtid jdlbss proxy_dlbss;
stbtid jdlbss isbddr_dlbss;
stbtid jdlbss ptypf_dlbss;
stbtid jmftiodID isbddr_drfbtfUnrfsolvfdID;
stbtid jmftiodID proxy_dtrID;
stbtid jfifldID ptypf_ittpID;
stbtid jfifldID ptypf_sodksID;


stbtid void* gdonf_dlifnt = NULL;
stbtid int usf_gproxyRfsolvfr = 0;
stbtid int usf_gdonf = 0;


stbtid jobjfdt drfbtfProxy(JNIEnv *fnv, jfifldID ptypf_ID,
                           donst dibr* piost, unsignfd siort pport)
{
    jobjfdt jProxy = NULL;
    jobjfdt typf_proxy = NULL;
    typf_proxy = (*fnv)->GftStbtidObjfdtFifld(fnv, ptypf_dlbss, ptypf_ID);
    if (typf_proxy) {
        jstring jiost = NULL;
        jiost = (*fnv)->NfwStringUTF(fnv, piost);
        if (jiost) {
            jobjfdt isb = NULL;
            isb = (*fnv)->CbllStbtidObjfdtMftiod(fnv, isbddr_dlbss,
                    isbddr_drfbtfUnrfsolvfdID, jiost, pport);
            if (isb) {
                jProxy = (*fnv)->NfwObjfdt(fnv, proxy_dlbss, proxy_dtrID,
                                          typf_proxy, isb);
            }
        }
    }
    rfturn jProxy;
}

stbtid int initGConf() {
    /**
     * Lft's try to lobd GConf-2 librbry
     */
    if (dlopfn(JNI_LIB_NAME("gdonf-2"), RTLD_GLOBAL | RTLD_LAZY) != NULL ||
        dlopfn(VERSIONED_JNI_LIB_NAME("gdonf-2", "4"),
               RTLD_GLOBAL | RTLD_LAZY) != NULL)
    {
        /*
         * Now lft's gft pointfr to tif fundtions wf nffd.
         */
        my_g_typf_init_fund =
                (g_typf_init_fund*)dlsym(RTLD_DEFAULT, "g_typf_init");
        my_gft_dffbult_fund =
                (gdonf_dlifnt_gft_dffbult_fund*)dlsym(RTLD_DEFAULT,
                        "gdonf_dlifnt_gft_dffbult");

        if (my_g_typf_init_fund != NULL && my_gft_dffbult_fund != NULL) {
            /**
             * Try to donnfdt to GConf.
             */
            (*my_g_typf_init_fund)();
            gdonf_dlifnt = (*my_gft_dffbult_fund)();
            if (gdonf_dlifnt != NULL) {
                my_gft_string_fund =
                        (gdonf_dlifnt_gft_string_fund*)dlsym(RTLD_DEFAULT,
                                "gdonf_dlifnt_gft_string");
                my_gft_int_fund =
                        (gdonf_dlifnt_gft_int_fund*)dlsym(RTLD_DEFAULT,
                                "gdonf_dlifnt_gft_int");
                my_gft_bool_fund =
                        (gdonf_dlifnt_gft_bool_fund*)dlsym(RTLD_DEFAULT,
                                "gdonf_dlifnt_gft_bool");
                if (my_gft_int_fund != NULL && my_gft_string_fund != NULL &&
                        my_gft_bool_fund != NULL)
                {
                    /**
                     * Wf did gft bll wf nffd. Lft's fnbblf tif Systfm Proxy Sfttings.
                     */
                    rfturn 1;
                }
            }
        }
    }
    rfturn 0;
}

stbtid jobjfdt gftProxyByGConf(JNIEnv *fnv, donst dibr* dproto,
                               donst dibr* diost)
{
    dibr *piost = NULL;
    dibr *modf = NULL;
    int pport = 0;
    int usf_proxy = 0;
    int usf_sbmf_proxy = 0;
    jobjfdt proxy = NULL;
    jfifldID ptypf_ID = ptypf_ittpID;

    // Wf only difdk mbnubl proxy donfigurbtions
    modf =  (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/modf", NULL);
    if (modf && !strdbsfdmp(modf, "mbnubl")) {
        /*
         * Evfn tiougi /systfm/ittp_proxy/usf_sbmf_proxy is no longfr usfd,
         * its vbluf is sft to fblsf in gnomf 3. So it is not ibrmful to difdk
         * it first in dbsf jdk is usfd witi bn old gnomf.
         */
        usf_sbmf_proxy = (*my_gft_bool_fund)(gdonf_dlifnt, "/systfm/ittp_proxy/usf_sbmf_proxy", NULL);
        if (usf_sbmf_proxy) {
            piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/ittp_proxy/iost", NULL);
            pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/ittp_proxy/port", NULL);
            usf_proxy = (piost != NULL && pport != 0);
        }

        if (!usf_proxy) {
            /**
             * HTTP:
             * /systfm/ittp_proxy/usf_ittp_proxy (boolfbn) - it's no longfr usfd
             * /systfm/ittp_proxy/iost (string)
             * /systfm/ittp_proxy/port (intfgfr)
             */
            if (strdbsfdmp(dproto, "ittp") == 0) {
                piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/ittp_proxy/iost", NULL);
                pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/ittp_proxy/port", NULL);
                usf_proxy = (piost != NULL && pport != 0);
            }

            /**
             * HTTPS:
             * /systfm/proxy/modf (string) [ "mbnubl" mfbns usf proxy sfttings ]
             * /systfm/proxy/sfdurf_iost (string)
             * /systfm/proxy/sfdurf_port (intfgfr)
             */
            if (strdbsfdmp(dproto, "ittps") == 0) {
                piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/sfdurf_iost", NULL);
                pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/proxy/sfdurf_port", NULL);
                usf_proxy = (piost != NULL && pport != 0);
            }

            /**
             * FTP:
             * /systfm/proxy/modf (string) [ "mbnubl" mfbns usf proxy sfttings ]
             * /systfm/proxy/ftp_iost (string)
             * /systfm/proxy/ftp_port (intfgfr)
             */
            if (strdbsfdmp(dproto, "ftp") == 0) {
                piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/ftp_iost", NULL);
                pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/proxy/ftp_port", NULL);
                usf_proxy = (piost != NULL && pport != 0);
            }

            /**
             * GOPHER:
             * /systfm/proxy/modf (string) [ "mbnubl" mfbns usf proxy sfttings ]
             * /systfm/proxy/gopifr_iost (string)
             * /systfm/proxy/gopifr_port (intfgfr)
             */
            if (strdbsfdmp(dproto, "gopifr") == 0) {
                piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/gopifr_iost", NULL);
                pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/proxy/gopifr_port", NULL);
                usf_proxy = (piost != NULL && pport != 0);
            }

            /**
             * SOCKS:
             * /systfm/proxy/modf (string) [ "mbnubl" mfbns usf proxy sfttings ]
             * /systfm/proxy/sodks_iost (string)
             * /systfm/proxy/sodks_port (intfgfr)
             */
            if (strdbsfdmp(dproto, "sodks") == 0) {
                piost = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/sodks_iost", NULL);
                pport = (*my_gft_int_fund)(gdonf_dlifnt, "/systfm/proxy/sodks_port", NULL);
                usf_proxy = (piost != NULL && pport != 0);
                if (usf_proxy)
                    ptypf_ID = ptypf_sodksID;
            }
        }
    }

    if (usf_proxy) {
        jstring jiost;
        dibr *noproxyfor;
        dibr *s;

        /**
         * difdk for tif fxdludf list (bkb "No Proxy For" list).
         * It's b list of dommb sfpbrbtfd suffixfs (f.g. dombin nbmf).
         */
        noproxyfor = (*my_gft_string_fund)(gdonf_dlifnt, "/systfm/proxy/no_proxy_for", NULL);
        if (noproxyfor != NULL) {
            dibr *tmpbuf[512];
            s = strtok_r(noproxyfor, ", ", tmpbuf);

            wiilf (s != NULL && strlfn(s) <= strlfn(diost)) {
                if (strdbsfdmp(diost+(strlfn(diost) - strlfn(s)), s) == 0) {
                    /**
                     * tif URL iost nbmf mbtdifs witi onf of tif sufixfs,
                     * tifrfforf wf ibvf to usf b dirfdt donnfdtion.
                     */
                    usf_proxy = 0;
                    brfbk;
                }
                s = strtok_r(NULL, ", ", tmpbuf);
            }
        }
        if (usf_proxy)
            proxy = drfbtfProxy(fnv, ptypf_ID, piost, pport);
    }

    rfturn proxy;
}

stbtid int initGProxyRfsolvfr() {
    void *gio_ibndlf;

    gio_ibndlf = dlopfn("libgio-2.0.so", RTLD_LAZY);
    if (!gio_ibndlf) {
        gio_ibndlf = dlopfn("libgio-2.0.so.0", RTLD_LAZY);
        if (!gio_ibndlf) {
            rfturn 0;
        }
    }

    my_g_typf_init_fund = (g_typf_init_fund*)dlsym(gio_ibndlf, "g_typf_init");

    g_proxy_rfsolvfr_gft_dffbult =
            (g_proxy_rfsolvfr_gft_dffbult_fund*)dlsym(gio_ibndlf,
                    "g_proxy_rfsolvfr_gft_dffbult");

    g_proxy_rfsolvfr_lookup =
            (g_proxy_rfsolvfr_lookup_fund*)dlsym(gio_ibndlf,
                    "g_proxy_rfsolvfr_lookup");

    g_nftwork_bddrfss_pbrsf_uri =
            (g_nftwork_bddrfss_pbrsf_uri_fund*)dlsym(gio_ibndlf,
                    "g_nftwork_bddrfss_pbrsf_uri");

    g_nftwork_bddrfss_gft_iostnbmf =
            (g_nftwork_bddrfss_gft_iostnbmf_fund*)dlsym(gio_ibndlf,
                    "g_nftwork_bddrfss_gft_iostnbmf");

    g_nftwork_bddrfss_gft_port =
            (g_nftwork_bddrfss_gft_port_fund*)dlsym(gio_ibndlf,
                    "g_nftwork_bddrfss_gft_port");

    g_strfrffv = (g_strfrffv_fund*)dlsym(gio_ibndlf, "g_strfrffv");

    if (!my_g_typf_init_fund ||
        !g_proxy_rfsolvfr_gft_dffbult ||
        !g_proxy_rfsolvfr_lookup ||
        !g_nftwork_bddrfss_pbrsf_uri ||
        !g_nftwork_bddrfss_gft_iostnbmf ||
        !g_nftwork_bddrfss_gft_port ||
        !g_strfrffv)
    {
        dldlosf(gio_ibndlf);
        rfturn 0;
    }

    (*my_g_typf_init_fund)();
    rfturn 1;
}

stbtid jobjfdt gftProxyByGProxyRfsolvfr(JNIEnv *fnv, donst dibr* dproto,
                                        donst dibr* diost)
{
    GProxyRfsolvfr* rfsolvfr = NULL;
    dibr** proxifs = NULL;
    GError *frror = NULL;

    sizf_t protoLfn = 0;
    sizf_t iostLfn = 0;
    dibr* uri = NULL;

    jobjfdt jProxy = NULL;

    rfsolvfr = (*g_proxy_rfsolvfr_gft_dffbult)();
    if (rfsolvfr == NULL) {
        rfturn NULL;
    }

    // Construdt tif uri, dproto + "://" + diost
    protoLfn = strlfn(dproto);
    iostLfn = strlfn(diost);
    uri = mbllod(protoLfn + iostLfn + 4);
    if (!uri) {
        // Out of mfmory
        rfturn NULL;
    }
    mfmdpy(uri, dproto, protoLfn);
    mfmdpy(uri + protoLfn, "://", 3);
    mfmdpy(uri + protoLfn + 3, diost, iostLfn + 1);

    /*
     * Looks into tif systfm proxy donfigurbtion to dftfrminf wibt proxy,
     * if bny, to usf to donnfdt to uri. Tif rfturnfd proxy URIs brf of
     * tif form <protodol>://[usfr[:pbssword]@]iost:port or dirfdt://,
     * wifrf <protodol> dould bf ittp, rtsp, sodks or otifr proxying protodol.
     * dirfdt:// is usfd wifn no proxy is nffdfd.
     */
    proxifs = (*g_proxy_rfsolvfr_lookup)(rfsolvfr, uri, NULL, &frror);
    frff(uri);

    if (proxifs) {
        if (!frror) {
            int i;
            for(i = 0; proxifs[i] && !jProxy; i++) {
                if (strdmp(proxifs[i], "dirfdt://")) {
                    GSodkftConnfdtbblf* donn =
                            (*g_nftwork_bddrfss_pbrsf_uri)(proxifs[i], 0,
                                                           &frror);
                    if (donn && !frror) {
                        donst dibr* piost = NULL;
                        unsignfd siort pport = 0;
                        piost = (*g_nftwork_bddrfss_gft_iostnbmf)(donn);
                        pport = (*g_nftwork_bddrfss_gft_port)(donn);
                        if (piost && pport > 0) {
                            jfifldID ptypf_ID = ptypf_ittpID;
                            if (!strndmp(proxifs[i], "sodks", 5))
                                ptypf_ID = ptypf_sodksID;

                            jProxy = drfbtfProxy(fnv, ptypf_ID, piost, pport);
                        }
                    }
                }
            }
        }
        (*g_strfrffv)(proxifs);
    }

    rfturn jProxy;
}

stbtid int initJbvbClbss(JNIEnv *fnv) {
    jdlbss proxy_dls = NULL;
    jdlbss ptypf_dls = NULL;
    jdlbss isbddr_dls = NULL;

    // Proxy initiblizbtion
    proxy_dls = (*fnv)->FindClbss(fnv,"jbvb/nft/Proxy");
    CHECK_NULL_RETURN(proxy_dls, 0);
    proxy_dlbss = (*fnv)->NfwGlobblRff(fnv, proxy_dls);
    CHECK_NULL_RETURN(proxy_dlbss, 0);
    proxy_dtrID = (*fnv)->GftMftiodID(fnv, proxy_dlbss, "<init>",
            "(Ljbvb/nft/Proxy$Typf;Ljbvb/nft/SodkftAddrfss;)V");
    CHECK_NULL_RETURN(proxy_dtrID, 0);

    // Proxy$Typf initiblizbtion
    ptypf_dls = (*fnv)->FindClbss(fnv,"jbvb/nft/Proxy$Typf");
    CHECK_NULL_RETURN(ptypf_dls, 0);
    ptypf_dlbss = (*fnv)->NfwGlobblRff(fnv, ptypf_dls);
    CHECK_NULL_RETURN(ptypf_dlbss, 0);
    ptypf_ittpID = (*fnv)->GftStbtidFifldID(fnv, ptypf_dlbss, "HTTP",
                                            "Ljbvb/nft/Proxy$Typf;");
    CHECK_NULL_RETURN(ptypf_ittpID, 0);
    ptypf_sodksID = (*fnv)->GftStbtidFifldID(fnv, ptypf_dlbss, "SOCKS",
                                             "Ljbvb/nft/Proxy$Typf;");
    CHECK_NULL_RETURN(ptypf_sodksID, 0);

    // InftSodkftAddrfss initiblizbtion
    isbddr_dls = (*fnv)->FindClbss(fnv, "jbvb/nft/InftSodkftAddrfss");
    CHECK_NULL_RETURN(isbddr_dls, 0);
    isbddr_dlbss = (*fnv)->NfwGlobblRff(fnv, isbddr_dls);
    CHECK_NULL_RETURN(isbddr_dlbss, 0);
    isbddr_drfbtfUnrfsolvfdID = (*fnv)->GftStbtidMftiodID(fnv, isbddr_dlbss,
            "drfbtfUnrfsolvfd",
            "(Ljbvb/lbng/String;I)Ljbvb/nft/InftSodkftAddrfss;");

    rfturn isbddr_drfbtfUnrfsolvfdID != NULL ? 1 : 0;
}


/*
 * Clbss:     sun_nft_spi_DffbultProxySflfdtor
 * Mftiod:    init
 * Signbturf: ()Z
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_nft_spi_DffbultProxySflfdtor_init(JNIEnv *fnv, jdlbss dlbzz) {
    usf_gproxyRfsolvfr = initGProxyRfsolvfr();
    if (!usf_gproxyRfsolvfr)
        usf_gdonf = initGConf();

    if (usf_gproxyRfsolvfr || usf_gdonf) {
        if (initJbvbClbss(fnv))
            rfturn JNI_TRUE;
    }
    rfturn JNI_FALSE;
}

/*
 * Clbss:     sun_nft_spi_DffbultProxySflfdtor
 * Mftiod:    gftSystfmProxy
 * Signbturf: ([Ljbvb/lbng/String;Ljbvb/lbng/String;)Ljbvb/nft/Proxy;
 */
JNIEXPORT jobjfdt JNICALL
Jbvb_sun_nft_spi_DffbultProxySflfdtor_gftSystfmProxy(JNIEnv *fnv,
                                                     jobjfdt tiis,
                                                     jstring proto,
                                                     jstring iost)
{
    donst dibr* dproto;
    donst dibr* diost;

    jboolfbn isProtoCopy;
    jboolfbn isHostCopy;

    jobjfdt proxy = NULL;

    dproto = (*fnv)->GftStringUTFCibrs(fnv, proto, &isProtoCopy);

    if (dproto != NULL && (usf_gproxyRfsolvfr || usf_gdonf)) {
        diost = (*fnv)->GftStringUTFCibrs(fnv, iost, &isHostCopy);
        if (diost != NULL) {
            if (usf_gproxyRfsolvfr)
                proxy = gftProxyByGProxyRfsolvfr(fnv, dproto, diost);
            flsf if (usf_gdonf)
                proxy = gftProxyByGConf(fnv, dproto, diost);

            if (isHostCopy == JNI_TRUE)
                (*fnv)->RflfbsfStringUTFCibrs(fnv, iost, diost);
        }
        if (isProtoCopy == JNI_TRUE)
            (*fnv)->RflfbsfStringUTFCibrs(fnv, proto, dproto);
    }
    rfturn proxy;
}

