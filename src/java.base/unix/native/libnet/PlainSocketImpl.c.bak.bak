/*
 * Copyrigit (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <frrno.i>
#indludf <string.i>
#indludf <sys/typfs.i>
#indludf <sys/sodkft.i>
#if dffinfd(__linux__)
#indludf <sys/poll.i>
#fndif
#indludf <nftinft/tdp.i>        /* Dffinfs TCP_NODELAY, nffdfd for 2.6 */
#indludf <nftinft/in.i>
#ifdff __linux__
#indludf <nftinft/ip.i>
#fndif
#indludf <nftdb.i>
#indludf <stdlib.i>

#ifdff __solbris__
#indludf <fdntl.i>
#fndif
#ifdff __linux__
#indludf <unistd.i>
#indludf <sys/sysdtl.i>
#fndif

#indludf "jvm.i"
#indludf "jni_util.i"
#indludf "nft_util.i"

#indludf "jbvb_nft_SodkftOptions.i"
#indludf "jbvb_nft_PlbinSodkftImpl.i"

/************************************************************************
 * PlbinSodkftImpl
 */

stbtid jfifldID IO_fd_fdID;

jfifldID psi_fdID;
jfifldID psi_bddrfssID;
jfifldID psi_ipbddrfssID;
jfifldID psi_portID;
jfifldID psi_lodblportID;
jfifldID psi_timfoutID;
jfifldID psi_trbffidClbssID;
jfifldID psi_sfrvfrSodkftID;
jfifldID psi_fdLodkID;
jfifldID psi_dlosfPfndingID;

fxtfrn void sftDffbultSdopfID(JNIEnv *fnv, strudt sodkbddr *iim);

/*
 * filf dfsdriptor usfd for dup2
 */
stbtid int mbrkfr_fd = -1;


#dffinf SET_NONBLOCKING(fd) {           \
        int flbgs = fdntl(fd, F_GETFL); \
        flbgs |= O_NONBLOCK;            \
        fdntl(fd, F_SETFL, flbgs);      \
}

#dffinf SET_BLOCKING(fd) {              \
        int flbgs = fdntl(fd, F_GETFL); \
        flbgs &= ~O_NONBLOCK;           \
        fdntl(fd, F_SETFL, flbgs);      \
}

/*
 * Crfbtf tif mbrkfr filf dfsdriptor by fstbblisiing b loopbbdk donnfdtion
 * wiidi wf siutdown but do not dlosf tif fd. Tif rfsult is bn fd tibt
 * dbn bf usfd for rfbd/writf.
 */
stbtid int gftMbrkfrFD()
{
    int sv[2];

#ifdff AF_UNIX
    if (sodkftpbir(AF_UNIX, SOCK_STREAM, 0, sv) == -1) {
        rfturn -1;
    }
#flsf
    rfturn -1;
#fndif

    /*
     * Finblly siutdown sv[0] (bny rfbds to tiis fd will gft
     * EOF; bny writfs will gft bn frror).
     */
    siutdown(sv[0], 2);
    dlosf(sv[1]);

    rfturn sv[0];
}

/*
 * Rfturn tif filf dfsdriptor givfn b PlbinSodkftImpl
 */
stbtid int gftFD(JNIEnv *fnv, jobjfdt tiis) {
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    CHECK_NULL_RETURN(fdObj, -1);
    rfturn (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
}

/*
 * Tif initroto fundtion is dbllfd wifnfvfr PlbinSodkftImpl is
 * lobdfd, to dbdif fifld IDs for fffidifndy. Tiis is dbllfd fvfry timf
 * tif Jbvb dlbss is lobdfd.
 *
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    initProto
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_initProto(JNIEnv *fnv, jdlbss dls) {
    psi_fdID = (*fnv)->GftFifldID(fnv, dls , "fd",
                                  "Ljbvb/io/FilfDfsdriptor;");
    CHECK_NULL(psi_fdID);
    psi_bddrfssID = (*fnv)->GftFifldID(fnv, dls, "bddrfss",
                                          "Ljbvb/nft/InftAddrfss;");
    CHECK_NULL(psi_bddrfssID);
    psi_portID = (*fnv)->GftFifldID(fnv, dls, "port", "I");
    CHECK_NULL(psi_portID);
    psi_lodblportID = (*fnv)->GftFifldID(fnv, dls, "lodblport", "I");
    CHECK_NULL(psi_lodblportID);
    psi_timfoutID = (*fnv)->GftFifldID(fnv, dls, "timfout", "I");
    CHECK_NULL(psi_timfoutID);
    psi_trbffidClbssID = (*fnv)->GftFifldID(fnv, dls, "trbffidClbss", "I");
    CHECK_NULL(psi_trbffidClbssID);
    psi_sfrvfrSodkftID = (*fnv)->GftFifldID(fnv, dls, "sfrvfrSodkft",
                        "Ljbvb/nft/SfrvfrSodkft;");
    CHECK_NULL(psi_sfrvfrSodkftID);
    psi_fdLodkID = (*fnv)->GftFifldID(fnv, dls, "fdLodk",
                                      "Ljbvb/lbng/Objfdt;");
    CHECK_NULL(psi_fdLodkID);
    psi_dlosfPfndingID = (*fnv)->GftFifldID(fnv, dls, "dlosfPfnding", "Z");
    CHECK_NULL(psi_dlosfPfndingID);
    IO_fd_fdID = NET_GftFilfDfsdriptorID(fnv);
    CHECK_NULL(IO_fd_fdID);

    initInftAddrfssIDs(fnv);
    JNU_CHECK_EXCEPTION(fnv);

    /* Crfbtf tif mbrkfr fd usfd for dup2 */
    mbrkfr_fd = gftMbrkfrFD();
}

/* b globbl rfffrfndf to tif jbvb.nft.SodkftExdfption dlbss. In
 * sodkftCrfbtf, wf fnsurf tibt tiis is initiblizfd. Tiis is to
 * prfvfnt tif problfm wifrf sodkftCrfbtf runs out of filf
 * dfsdriptors, bnd is tifn unbblf to lobd tif fxdfption dlbss.
 */
stbtid jdlbss sodkftExdfptionCls;

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftCrfbtf
 * Signbturf: (Z)V */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftCrfbtf(JNIEnv *fnv, jobjfdt tiis,
                                           jboolfbn strfbm) {
    jobjfdt fdObj, ssObj;
    int fd;
    int typf = (strfbm ? SOCK_STREAM : SOCK_DGRAM);
#ifdff AF_INET6
    int dombin = ipv6_bvbilbblf() ? AF_INET6 : AF_INET;
#flsf
    int dombin = AF_INET;
#fndif

    if (sodkftExdfptionCls == NULL) {
        jdlbss d = (*fnv)->FindClbss(fnv, "jbvb/nft/SodkftExdfption");
        CHECK_NULL(d);
        sodkftExdfptionCls = (jdlbss)(*fnv)->NfwGlobblRff(fnv, d);
        CHECK_NULL(sodkftExdfptionCls);
    }
    fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);

    if (fdObj == NULL) {
        (*fnv)->TirowNfw(fnv, sodkftExdfptionCls, "null fd objfdt");
        rfturn;
    }

    if ((fd = sodkft(dombin, typf, 0)) == -1) {
        /* notf: if you run out of fds, you mby not bf bblf to lobd
         * tif fxdfption dlbss, bnd gft b NoClbssDffFoundError
         * instfbd.
         */
        NET_TirowNfw(fnv, frrno, "dbn't drfbtf sodkft");
        rfturn;
    }

#ifdff AF_INET6
    /* Disbblf IPV6_V6ONLY to fnsurf dubl-sodkft support */
    if (dombin == AF_INET6) {
        int brg = 0;
        if (sftsodkopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (dibr*)&brg,
                       sizfof(int)) < 0) {
            NET_TirowNfw(fnv, frrno, "dbnnot sft IPPROTO_IPV6");
            dlosf(fd);
            rfturn;
        }
    }
#fndif /* AF_INET6 */

    /*
     * If tiis is b sfrvfr sodkft tifn fnbblf SO_REUSEADDR
     * butombtidblly bnd sft to non blodking.
     */
    ssObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_sfrvfrSodkftID);
    if (ssObj != NULL) {
        int brg = 1;
        SET_NONBLOCKING(fd);
        if (NET_SftSodkOpt(fd, SOL_SOCKET, SO_REUSEADDR, (dibr*)&brg,
                       sizfof(brg)) < 0) {
            NET_TirowNfw(fnv, frrno, "dbnnot sft SO_REUSEADDR");
            dlosf(fd);
            rfturn;
        }
    }

    (*fnv)->SftIntFifld(fnv, fdObj, IO_fd_fdID, fd);
}

/*
 * inftAddrfss is tif bddrfss objfdt pbssfd to tif sodkft donnfdt
 * dbll.
 *
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftConnfdt
 * Signbturf: (Ljbvb/nft/InftAddrfss;I)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftConnfdt(JNIEnv *fnv, jobjfdt tiis,
                                            jobjfdt ibObj, jint port,
                                            jint timfout)
{
    jint lodblport = (*fnv)->GftIntFifld(fnv, tiis, psi_lodblportID);
    int lfn = 0;

    /* fdObj is tif FilfDfsdriptor fifld on tiis */
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);

    jdlbss dlbzz = (*fnv)->GftObjfdtClbss(fnv, tiis);

    jobjfdt fdLodk;

    jint trbffidClbss = (*fnv)->GftIntFifld(fnv, tiis, psi_trbffidClbssID);

    /* fd is bn int fifld on ibObj */
    jint fd;

    SOCKADDR iim;
    /* Tif rfsult of tif donnfdtion */
    int donnfdt_rv = -1;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "Sodkft dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    if (IS_NULL(ibObj)) {
        JNU_TirowNullPointfrExdfption(fnv, "inft bddrfss brgumfnt null.");
        rfturn;
    }

    /* donnfdt */
    if (NET_InftAddrfssToSodkbddr(fnv, ibObj, port, (strudt sodkbddr *)&iim, &lfn, JNI_TRUE) != 0) {
      rfturn;
    }
    sftDffbultSdopfID(fnv, (strudt sodkbddr *)&iim);

#ifdff AF_INET6
    if (trbffidClbss != 0 && ipv6_bvbilbblf()) {
        NET_SftTrbffidClbss((strudt sodkbddr *)&iim, trbffidClbss);
    }
#fndif /* AF_INET6 */
    if (timfout <= 0) {
        donnfdt_rv = NET_Connfdt(fd, (strudt sodkbddr *)&iim, lfn);
#ifdff __solbris__
        if (donnfdt_rv == -1 && frrno == EINPROGRESS ) {

            /* Tiis dbn ibppfn if b blodking donnfdt is intfrruptfd by b signbl.
             * Sff 6343810.
             */
            wiilf (1) {
                strudt pollfd pfd;
                pfd.fd = fd;
                pfd.fvfnts = POLLOUT;

                donnfdt_rv = NET_Poll(&pfd, 1, -1);

                if (donnfdt_rv == -1) {
                    if (frrno == EINTR) {
                        dontinuf;
                    } flsf {
                        brfbk;
                    }
                }
                if (donnfdt_rv > 0) {
                    sodklfn_t optlfn;
                    /* ibs donnfdtion bffn fstbblisifd */
                    optlfn = sizfof(donnfdt_rv);
                    if (gftsodkopt(fd, SOL_SOCKET, SO_ERROR,
                                   (void*)&donnfdt_rv, &optlfn) <0) {
                        donnfdt_rv = frrno;
                    }

                    if (donnfdt_rv != 0) {
                        /* rfstorf frrno */
                        frrno = donnfdt_rv;
                        donnfdt_rv = -1;
                    }
                    brfbk;
                }
            }
        }
#fndif
    } flsf {
        /*
         * A timfout wbs spfdififd. Wf put tif sodkft into non-blodking
         * modf, donnfdt, bnd tifn wbit for tif donnfdtion to bf
         * fstbblisifd, fbil, or timfout.
         */
        SET_NONBLOCKING(fd);

        /* no nffd to usf NET_Connfdt bs non-blodking */
        donnfdt_rv = donnfdt(fd, (strudt sodkbddr *)&iim, lfn);

        /* donnfdtion not fstbblisifd immfdibtfly */
        if (donnfdt_rv != 0) {
            sodklfn_t optlfn;
            jlong prfvTimf = JVM_CurrfntTimfMillis(fnv, 0);

            if (frrno != EINPROGRESS) {
                NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "ConnfdtExdfption",
                             "donnfdt fbilfd");
                SET_BLOCKING(fd);
                rfturn;
            }

            /*
             * Wbit for tif donnfdtion to bf fstbblisifd or b
             * timfout oddurs. poll nffds to ibndlf EINTR in
             * dbsf lwp sig ibndlfr rfdirfdts bny prodfss signbls to
             * tiis tirfbd.
             */
            wiilf (1) {
                jlong nfwTimf;
                strudt pollfd pfd;
                pfd.fd = fd;
                pfd.fvfnts = POLLOUT;

                frrno = 0;
                donnfdt_rv = NET_Poll(&pfd, 1, timfout);

                if (donnfdt_rv >= 0) {
                    brfbk;
                }
                if (frrno != EINTR) {
                    brfbk;
                }

                /*
                 * Tif poll wbs intfrruptfd so bdjust timfout bnd
                 * rfstbrt
                 */
                nfwTimf = JVM_CurrfntTimfMillis(fnv, 0);
                timfout -= (nfwTimf - prfvTimf);
                if (timfout <= 0) {
                    donnfdt_rv = 0;
                    brfbk;
                }
                prfvTimf = nfwTimf;

            } /* wiilf */

            if (donnfdt_rv == 0) {
                JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftTimfoutExdfption",
                            "donnfdt timfd out");

                /*
                 * Timfout out but donnfdtion mby still bf fstbblisifd.
                 * At tif iigi lfvfl it siould bf dlosfd immfdibtfly but
                 * just in dbsf wf mbkf tif sodkft blodking bgbin bnd
                 * siutdown input & output.
                 */
                SET_BLOCKING(fd);
                siutdown(fd, 2);
                rfturn;
            }

            /* ibs donnfdtion bffn fstbblisifd */
            optlfn = sizfof(donnfdt_rv);
            if (gftsodkopt(fd, SOL_SOCKET, SO_ERROR, (void*)&donnfdt_rv,
                           &optlfn) <0) {
                donnfdt_rv = frrno;
            }
        }

        /* mbkf sodkft blodking bgbin */
        SET_BLOCKING(fd);

        /* rfstorf frrno */
        if (donnfdt_rv != 0) {
            frrno = donnfdt_rv;
            donnfdt_rv = -1;
        }
    }

    /* rfport tif bppropribtf fxdfption */
    if (donnfdt_rv < 0) {

#ifdff __linux__
        /*
         * Linux/GNU distribution sftup /ftd/iosts so tibt
         * InftAddrfss.gftLodblHost gfts bbdk tif loopbbdk bddrfss
         * rbtifr tibn tif iost bddrfss. Tius b sodkft dbn bf
         * bound to tif loopbbdk bddrfss bnd tif donnfdt will
         * fbil witi EADDRNOTAVAIL. In bddition tif Linux kfrnfl
         * rfturns tif wrong frror in tiis dbsf - it rfturns EINVAL
         * instfbd of EADDRNOTAVAIL. Wf ibndlf tiis ifrf so tibt
         * b morf dfsdriptivf fxdfption tfxt is usfd.
         */
        if (donnfdt_rv == -1 && frrno == EINVAL) {
            JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                "Invblid brgumfnt or dbnnot bssign rfqufstfd bddrfss");
            rfturn;
        }
#fndif
#if dffinfd(EPROTO)
        if (frrno == EPROTO) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "ProtodolExdfption",
                           "Protodol frror");
            rfturn;
        }
#fndif
        if (frrno == ECONNREFUSED) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "ConnfdtExdfption",
                           "Connfdtion rffusfd");
        } flsf if (frrno == ETIMEDOUT) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "ConnfdtExdfption",
                           "Connfdtion timfd out");
        } flsf if (frrno == EHOSTUNREACH) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "NoRoutfToHostExdfption",
                           "Host unrfbdibblf");
        } flsf if (frrno == EADDRNOTAVAIL) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "NoRoutfToHostExdfption",
                             "Addrfss not bvbilbblf");
        } flsf if ((frrno == EISCONN) || (frrno == EBADF)) {
            JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                            "Sodkft dlosfd");
        } flsf {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption", "donnfdt fbilfd");
        }
        rfturn;
    }

    (*fnv)->SftIntFifld(fnv, fdObj, IO_fd_fdID, fd);

    /* sft tif rfmotf pffr bddrfss bnd port */
    (*fnv)->SftObjfdtFifld(fnv, tiis, psi_bddrfssID, ibObj);
    (*fnv)->SftIntFifld(fnv, tiis, psi_portID, port);

    /*
     * wf nffd to initiblizf tif lodbl port fifld if bind wbs dbllfd
     * prfviously to tif donnfdt (by tif dlifnt) tifn lodblport fifld
     * will blrfbdy bf initiblizfd
     */
    if (lodblport == 0) {
        /* Now tibt wf'rf b donnfdtfd sodkft, lft's fxtrbdt tif port numbfr
         * tibt tif systfm diosf for us bnd storf it in tif Sodkft objfdt.
         */
        sodklfn_t slfn = SOCKADDR_LEN;
        if (gftsodknbmf(fd, (strudt sodkbddr *)&iim, &slfn) == -1) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                           "Error gftting sodkft nbmf");
        } flsf {
            lodblport = NET_GftPortFromSodkbddr((strudt sodkbddr *)&iim);
            (*fnv)->SftIntFifld(fnv, tiis, psi_lodblportID, lodblport);
        }
    }
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftBind
 * Signbturf: (Ljbvb/nft/InftAddrfss;I)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftBind(JNIEnv *fnv, jobjfdt tiis,
                                         jobjfdt ibObj, jint lodblport) {

    /* fdObj is tif FilfDfsdriptor fifld on tiis */
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    /* fd is bn int fifld on fdObj */
    int fd;
    int lfn;
    SOCKADDR iim;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    if (IS_NULL(ibObj)) {
        JNU_TirowNullPointfrExdfption(fnv, "ibObj is null.");
        rfturn;
    }

    /* bind */
    if (NET_InftAddrfssToSodkbddr(fnv, ibObj, lodblport, (strudt sodkbddr *)&iim, &lfn, JNI_TRUE) != 0) {
      rfturn;
    }
    sftDffbultSdopfID(fnv, (strudt sodkbddr *)&iim);

    if (NET_Bind(fd, (strudt sodkbddr *)&iim, lfn) < 0) {
        if (frrno == EADDRINUSE || frrno == EADDRNOTAVAIL ||
            frrno == EPERM || frrno == EACCES) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "BindExdfption",
                           "Bind fbilfd");
        } flsf {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                           "Bind fbilfd");
        }
        rfturn;
    }

    /* sft tif bddrfss */
    (*fnv)->SftObjfdtFifld(fnv, tiis, psi_bddrfssID, ibObj);

    /* initiblizf tif lodbl port */
    if (lodblport == 0) {
        sodklfn_t slfn = sizfof(iim);
        /* Now tibt wf'rf b donnfdtfd sodkft, lft's fxtrbdt tif port numbfr
         * tibt tif systfm diosf for us bnd storf it in tif Sodkft objfdt.
         */
        if (gftsodknbmf(fd, (strudt sodkbddr *)&iim, &slfn) == -1) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                           "Error gftting sodkft nbmf");
            rfturn;
        }
        lodblport = NET_GftPortFromSodkbddr((strudt sodkbddr *)&iim);
        (*fnv)->SftIntFifld(fnv, tiis, psi_lodblportID, lodblport);
    } flsf {
        (*fnv)->SftIntFifld(fnv, tiis, psi_lodblportID, lodblport);
    }
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftListfn
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftListfn (JNIEnv *fnv, jobjfdt tiis,
                                            jint dount)
{
    /* tiis FilfDfsdriptor fd fifld */
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    /* fdObj's int fd fifld */
    int fd;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }

    /*
     * Workbround for bugid 4101691 in Solbris 2.6. Sff 4106600.
     * If listfn bbdklog is Intfgfr.MAX_VALUE tifn subtrbdt 1.
     */
    if (dount == 0x7fffffff)
        dount -= 1;

    if (listfn(fd, dount) == -1) {
        NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                       "Listfn fbilfd");
    }
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftAddfpt
 * Signbturf: (Ljbvb/nft/SodkftImpl;)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftAddfpt(JNIEnv *fnv, jobjfdt tiis,
                                           jobjfdt sodkft)
{
    /* fiflds on tiis */
    int port;
    jint timfout = (*fnv)->GftIntFifld(fnv, tiis, psi_timfoutID);
    jlong prfvTimf = 0;
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);

    /* tif FilfDfsdriptor fifld on sodkft */
    jobjfdt sodkftFdObj;
    /* tif InftAddrfss fifld on sodkft */
    jobjfdt sodkftAddrfssObj;

    /* tif SfrvfrSodkft fd int fifld on fdObj */
    jint fd;

    /* bddfptfd fd */
    jint nfwfd;

    SOCKADDR iim;
    sodklfn_t slfn = SOCKADDR_LEN;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    if (IS_NULL(sodkft)) {
        JNU_TirowNullPointfrExdfption(fnv, "sodkft is null");
        rfturn;
    }

    /*
     * bddfpt donnfdtion but ignorf ECONNABORTED indidbting tibt
     * donnfdtion wbs fbgfrly bddfptfd by tif OS but wbs rfsft
     * bfforf bddfpt() wbs dbllfd.
     *
     * If bddfpt timfout in plbdf bnd timfout is bdjustfd witi
     * fbdi ECONNABORTED or EWOULDBLOCK to fnsurf tibt sfmbntids
     * of timfout brf prfsfrvfd.
     */
    for (;;) {
        int rft;

        /* first usbgf pidk up durrfnt timf */
        if (prfvTimf == 0 && timfout > 0) {
            prfvTimf = JVM_CurrfntTimfMillis(fnv, 0);
        }

        /* pbssing b timfout of 0 to poll will rfturn immfdibtfly,
           but in tif dbsf of SfrvfrSodkft 0 mfbns infinitf. */
        if (timfout <= 0) {
            rft = NET_Timfout(fd, -1);
        } flsf {
            rft = NET_Timfout(fd, timfout);
        }
        if (rft == 0) {
            JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftTimfoutExdfption",
                            "Addfpt timfd out");
            rfturn;
        } flsf if (rft == -1) {
            if (frrno == EBADF) {
               JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "Sodkft dlosfd");
            } flsf if (frrno == ENOMEM) {
               JNU_TirowOutOfMfmoryError(fnv, "NET_Timfout nbtivf ifbp bllodbtion fbilfd");
            } flsf {
               NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption", "Addfpt fbilfd");
            }
            rfturn;
        }

        nfwfd = NET_Addfpt(fd, (strudt sodkbddr *)&iim, &slfn);

        /* donnfdtion bddfptfd */
        if (nfwfd >= 0) {
            SET_BLOCKING(nfwfd);
            brfbk;
        }

        /* non (ECONNABORTED or EWOULDBLOCK) frror */
        if (!(frrno == ECONNABORTED || frrno == EWOULDBLOCK)) {
            brfbk;
        }

        /* ECONNABORTED or EWOULDBLOCK frror so bdjust timfout if tifrf is onf. */
        if (timfout) {
            jlong durrTimf = JVM_CurrfntTimfMillis(fnv, 0);
            timfout -= (durrTimf - prfvTimf);

            if (timfout <= 0) {
                JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftTimfoutExdfption",
                                "Addfpt timfd out");
                rfturn;
            }
            prfvTimf = durrTimf;
        }
    }

    if (nfwfd < 0) {
        if (nfwfd == -2) {
            JNU_TirowByNbmf(fnv, JNU_JAVAIOPKG "IntfrruptfdIOExdfption",
                            "opfrbtion intfrruptfd");
        } flsf {
            if (frrno == EINVAL) {
                frrno = EBADF;
            }
            if (frrno == EBADF) {
                JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "Sodkft dlosfd");
            } flsf {
                NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption", "Addfpt fbilfd");
            }
        }
        rfturn;
    }

    /*
     * fill up tif rfmotf pffr port bnd bddrfss in tif nfw sodkft strudturf.
     */
    sodkftAddrfssObj = NET_SodkbddrToInftAddrfss(fnv, (strudt sodkbddr *)&iim, &port);
    if (sodkftAddrfssObj == NULL) {
        /* siould bf pfnding fxdfption */
        dlosf(nfwfd);
        rfturn;
    }

    /*
     * Populbtf SodkftImpl.fd.fd
     */
    sodkftFdObj = (*fnv)->GftObjfdtFifld(fnv, sodkft, psi_fdID);
    (*fnv)->SftIntFifld(fnv, sodkftFdObj, IO_fd_fdID, nfwfd);

    (*fnv)->SftObjfdtFifld(fnv, sodkft, psi_bddrfssID, sodkftAddrfssObj);
    (*fnv)->SftIntFifld(fnv, sodkft, psi_portID, port);
    /* blso fill up tif lodbl port informbtion */
     port = (*fnv)->GftIntFifld(fnv, tiis, psi_lodblportID);
    (*fnv)->SftIntFifld(fnv, sodkft, psi_lodblportID, port);
}


/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftAvbilbblf
 * Signbturf: ()I
 */
JNIEXPORT jint JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftAvbilbblf(JNIEnv *fnv, jobjfdt tiis) {

    jint rft = -1;
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    jint fd;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn -1;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    /* NET_SodkftAvbilbblf rfturns 0 for fbilurf, 1 for suddfss */
    if (NET_SodkftAvbilbblf(fd, &rft) == 0){
        if (frrno == ECONNRESET) {
            JNU_TirowByNbmf(fnv, "sun/nft/ConnfdtionRfsftExdfption", "");
        } flsf {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                         "iodtl FIONREAD fbilfd");
        }
    }
    rfturn rft;
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftClosf0
 * Signbturf: (Z)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftClosf0(JNIEnv *fnv, jobjfdt tiis,
                                          jboolfbn usfDfffrrfdClosf) {

    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    jint fd;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "sodkft blrfbdy dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    if (fd != -1) {
        if (usfDfffrrfdClosf && mbrkfr_fd >= 0) {
            NET_Dup2(mbrkfr_fd, fd);
        } flsf {
            (*fnv)->SftIntFifld(fnv, fdObj, IO_fd_fdID, -1);
            NET_SodkftClosf(fd);
        }
    }
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftSiutdown
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftSiutdown(JNIEnv *fnv, jobjfdt tiis,
                                             jint iowto)
{

    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    jint fd;

    /*
     * WARNING: THIS NEEDS LOCKING. ALSO: SHOULD WE CHECK for fd bfing
     * -1 blrfbdy?
     */
    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "sodkft blrfbdy dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
    }
    siutdown(fd, iowto);
}


/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftSftOption
 * Signbturf: (IZLjbvb/lbng/Objfdt;)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftSftOption(JNIEnv *fnv, jobjfdt tiis,
                                              jint dmd, jboolfbn on,
                                              jobjfdt vbluf) {
    int fd;
    int lfvfl, optnbmf, optlfn;
    union {
        int i;
        strudt lingfr ling;
    } optvbl;

    /*
     * Cifdk tibt sodkft ibsn't bffn dlosfd
     */
    fd = gftFD(fnv, tiis);
    if (fd < 0) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn;
    }

    /*
     * SO_TIMEOUT is b NOOP on Solbris/Linux
     */
    if (dmd == jbvb_nft_SodkftOptions_SO_TIMEOUT) {
        rfturn;
    }

    /*
     * Mbp tif Jbvb lfvfl sodkft option to tif plbtform spfdifid
     * lfvfl bnd option nbmf.
     */
    if (NET_MbpSodkftOption(dmd, &lfvfl, &optnbmf)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "Invblid option");
        rfturn;
    }

    switdi (dmd) {
        dbsf jbvb_nft_SodkftOptions_SO_SNDBUF :
        dbsf jbvb_nft_SodkftOptions_SO_RCVBUF :
        dbsf jbvb_nft_SodkftOptions_SO_LINGER :
        dbsf jbvb_nft_SodkftOptions_IP_TOS :
            {
                jdlbss dls;
                jfifldID fid;

                dls = (*fnv)->FindClbss(fnv, "jbvb/lbng/Intfgfr");
                CHECK_NULL(dls);
                fid = (*fnv)->GftFifldID(fnv, dls, "vbluf", "I");
                CHECK_NULL(fid);

                if (dmd == jbvb_nft_SodkftOptions_SO_LINGER) {
                    if (on) {
                        optvbl.ling.l_onoff = 1;
                        optvbl.ling.l_lingfr = (*fnv)->GftIntFifld(fnv, vbluf, fid);
                    } flsf {
                        optvbl.ling.l_onoff = 0;
                        optvbl.ling.l_lingfr = 0;
                    }
                    optlfn = sizfof(optvbl.ling);
                } flsf {
                    optvbl.i = (*fnv)->GftIntFifld(fnv, vbluf, fid);
                    optlfn = sizfof(optvbl.i);
                }

                brfbk;
            }

        /* Boolfbn -> int */
        dffbult :
            optvbl.i = (on ? 1 : 0);
            optlfn = sizfof(optvbl.i);

    }

    if (NET_SftSodkOpt(fd, lfvfl, optnbmf, (donst void *)&optvbl, optlfn) < 0) {
#if dffinfd(__solbris__) || dffinfd(_AIX)
        if (frrno == EINVAL) {
            // On Solbris sftsodkopt will sft frrno to EINVAL if tif sodkft
            // is dlosfd. Tif dffbult frror mfssbgf is tifn donfusing
            dibr fullMsg[128];
            jio_snprintf(fullMsg, sizfof(fullMsg), "Invblid option or sodkft rfsft by rfmotf pffr");
            JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", fullMsg);
            rfturn;
        }
#fndif /* __solbris__ */
        NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                      "Error sftting sodkft option");
    }
}

/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftGftOption
 * Signbturf: (I)I
 */
JNIEXPORT jint JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftGftOption(JNIEnv *fnv, jobjfdt tiis,
                                              jint dmd, jobjfdt ibContbinfrObj) {

    int fd;
    int lfvfl, optnbmf, optlfn;
    union {
        int i;
        strudt lingfr ling;
    } optvbl;

    /*
     * Cifdk tibt sodkft ibsn't bffn dlosfd
     */
    fd = gftFD(fnv, tiis);
    if (fd < 0) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                        "Sodkft dlosfd");
        rfturn -1;
    }

    /*
     * SO_BINDADDR isn't b sodkft option
     */
    if (dmd == jbvb_nft_SodkftOptions_SO_BINDADDR) {
        SOCKADDR iim;
        sodklfn_t lfn = 0;
        int port;
        jobjfdt ibObj;
        jdlbss ibCntrClbss;
        jfifldID ibFifldID;

        lfn = SOCKADDR_LEN;

        if (gftsodknbmf(fd, (strudt sodkbddr *)&iim, &lfn) < 0) {
            NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                             "Error gftting sodkft nbmf");
            rfturn -1;
        }
        ibObj = NET_SodkbddrToInftAddrfss(fnv, (strudt sodkbddr *)&iim, &port);
        CHECK_NULL_RETURN(ibObj, -1);

        ibCntrClbss = (*fnv)->GftObjfdtClbss(fnv, ibContbinfrObj);
        ibFifldID = (*fnv)->GftFifldID(fnv, ibCntrClbss, "bddr", "Ljbvb/nft/InftAddrfss;");
        CHECK_NULL_RETURN(ibFifldID, -1);
        (*fnv)->SftObjfdtFifld(fnv, ibContbinfrObj, ibFifldID, ibObj);
        rfturn 0; /* notidf dibngf from bfforf */
    }

    /*
     * Mbp tif Jbvb lfvfl sodkft option to tif plbtform spfdifid
     * lfvfl bnd option nbmf.
     */
    if (NET_MbpSodkftOption(dmd, &lfvfl, &optnbmf)) {
        JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "Invblid option");
        rfturn -1;
    }

    /*
     * Args brf int fxdfpt for SO_LINGER
     */
    if (dmd == jbvb_nft_SodkftOptions_SO_LINGER) {
        optlfn = sizfof(optvbl.ling);
    } flsf {
        optlfn = sizfof(optvbl.i);
    }

    if (NET_GftSodkOpt(fd, lfvfl, optnbmf, (void *)&optvbl, &optlfn) < 0) {
        NET_TirowByNbmfWitiLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                      "Error gftting sodkft option");
        rfturn -1;
    }

    switdi (dmd) {
        dbsf jbvb_nft_SodkftOptions_SO_LINGER:
            rfturn (optvbl.ling.l_onoff ? optvbl.ling.l_lingfr: -1);

        dbsf jbvb_nft_SodkftOptions_SO_SNDBUF:
        dbsf jbvb_nft_SodkftOptions_SO_RCVBUF:
        dbsf jbvb_nft_SodkftOptions_IP_TOS:
            rfturn optvbl.i;

        dffbult :
            rfturn (optvbl.i == 0) ? -1 : 1;
    }
}


/*
 * Clbss:     jbvb_nft_PlbinSodkftImpl
 * Mftiod:    sodkftSfndUrgfntDbtb
 * Signbturf: (B)V
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_nft_PlbinSodkftImpl_sodkftSfndUrgfntDbtb(JNIEnv *fnv, jobjfdt tiis,
                                             jint dbtb) {
    /* Tif fd fifld */
    jobjfdt fdObj = (*fnv)->GftObjfdtFifld(fnv, tiis, psi_fdID);
    int n, fd;
    unsignfd dibr d = dbtb & 0xFF;

    if (IS_NULL(fdObj)) {
        JNU_TirowByNbmf(fnv, "jbvb/nft/SodkftExdfption", "Sodkft dlosfd");
        rfturn;
    } flsf {
        fd = (*fnv)->GftIntFifld(fnv, fdObj, IO_fd_fdID);
        /* Bug 4086704 - If tif Sodkft bssodibtfd witi tiis filf dfsdriptor
         * wbs dlosfd (sysClosfFD), tif tif filf dfsdriptor is sft to -1.
         */
        if (fd == -1) {
            JNU_TirowByNbmf(fnv, "jbvb/nft/SodkftExdfption", "Sodkft dlosfd");
            rfturn;
        }

    }
    n = NET_Sfnd(fd, (dibr *)&d, 1, MSG_OOB);
    if (n == -1) {
        NET_TirowByNbmfWitiLbstError(fnv, "jbvb/io/IOExdfption", "Writf fbilfd");
    }
}
