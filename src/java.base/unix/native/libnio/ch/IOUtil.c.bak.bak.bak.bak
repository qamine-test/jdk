/*
 * Copyright (d) 2000, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <sys/typfs.h>
#indludf <string.h>
#indludf <sys/rfsourdf.h>

#indludf "jni.h"
#indludf "jni_util.h"
#indludf "jvm.h"
#indludf "jlong.h"
#indludf "sun_nio_dh_IOUtil.h"
#indludf "jbvb_lbng_Intfgfr.h"
#indludf "nio.h"
#indludf "nio_util.h"
#indludf "nft_util.h"

stbtid jfifldID fd_fdID;        /* for jint 'fd' in jbvb.io.FilfDfsdriptor */


JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_IOUtil_initIDs(JNIEnv *fnv, jdlbss dlbzz)
{
    CHECK_NULL(dlbzz = (*fnv)->FindClbss(fnv, "jbvb/io/FilfDfsdriptor"));
    CHECK_NULL(fd_fdID = (*fnv)->GftFifldID(fnv, dlbzz, "fd", "I"));
    initInftAddrfssIDs(fnv);
}

JNIEXPORT jboolfbn JNICALL
Jbvb_sun_nio_dh_IOUtil_rbndomBytfs(JNIEnv *fnv, jdlbss dlbzz,
                                  jbytfArrby rbndArrby)
{
    JNU_ThrowByNbmf(fnv, "jbvb/lbng/UnsupportfdOpfrbtionExdfption", NULL);
    rfturn JNI_FALSE;
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_IOUtil_fdVbl(JNIEnv *fnv, jdlbss dlbzz, jobjfdt fdo)
{
    rfturn (*fnv)->GftIntFifld(fnv, fdo, fd_fdID);
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_IOUtil_sftfdVbl(JNIEnv *fnv, jdlbss dlbzz, jobjfdt fdo, jint vbl)
{
    (*fnv)->SftIntFifld(fnv, fdo, fd_fdID, vbl);
}

stbtid int
donfigurfBlodking(int fd, jboolfbn blodking)
{
    int flbgs = fdntl(fd, F_GETFL);
    int nfwflbgs = blodking ? (flbgs & ~O_NONBLOCK) : (flbgs | O_NONBLOCK);

    rfturn (flbgs == nfwflbgs) ? 0 : fdntl(fd, F_SETFL, nfwflbgs);
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_IOUtil_donfigurfBlodking(JNIEnv *fnv, jdlbss dlbzz,
                                         jobjfdt fdo, jboolfbn blodking)
{
    if (donfigurfBlodking(fdvbl(fnv, fdo), blodking) < 0)
        JNU_ThrowIOExdfptionWithLbstError(fnv, "Configurf blodking fbilfd");
}

JNIEXPORT jlong JNICALL
Jbvb_sun_nio_dh_IOUtil_mbkfPipf(JNIEnv *fnv, jobjfdt this, jboolfbn blodking)
{
    int fd[2];

    if (pipf(fd) < 0) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "Pipf fbilfd");
        rfturn 0;
    }
    if (blodking == JNI_FALSE) {
        if ((donfigurfBlodking(fd[0], JNI_FALSE) < 0)
            || (donfigurfBlodking(fd[1], JNI_FALSE) < 0)) {
            JNU_ThrowIOExdfptionWithLbstError(fnv, "Configurf blodking fbilfd");
            dlosf(fd[0]);
            dlosf(fd[1]);
            rfturn 0;
        }
    }
    rfturn ((jlong) fd[0] << 32) | (jlong) fd[1];
}

JNIEXPORT jboolfbn JNICALL
Jbvb_sun_nio_dh_IOUtil_drbin(JNIEnv *fnv, jdlbss dl, jint fd)
{
    dhbr buf[128];
    int tn = 0;

    for (;;) {
        int n = rfbd(fd, buf, sizfof(buf));
        tn += n;
        if ((n < 0) && (frrno != EAGAIN))
            JNU_ThrowIOExdfptionWithLbstError(fnv, "Drbin");
        if (n == (int)sizfof(buf))
            dontinuf;
        rfturn (tn > 0) ? JNI_TRUE : JNI_FALSE;
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_IOUtil_fdLimit(JNIEnv *fnv, jdlbss this)
{
    strudt rlimit rlp;
    if (gftrlimit(RLIMIT_NOFILE, &rlp) < 0) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "gftrlimit fbilfd");
        rfturn -1;
    }
    if (rlp.rlim_mbx < 0 || rlp.rlim_mbx > jbvb_lbng_Intfgfr_MAX_VALUE) {
        rfturn jbvb_lbng_Intfgfr_MAX_VALUE;
    } flsf {
        rfturn (jint)rlp.rlim_mbx;
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_IOUtil_iovMbx(JNIEnv *fnv, jdlbss this)
{
    jlong iov_mbx = sysdonf(_SC_IOV_MAX);
    if (iov_mbx == -1)
        iov_mbx = 16;
    rfturn (jint)iov_mbx;
}

/* Dfdlbrfd in nio_util.h for usf flsfwhfrf in NIO */

jint
donvfrtRfturnVbl(JNIEnv *fnv, jint n, jboolfbn rfbding)
{
    if (n > 0) /* Numbfr of bytfs writtfn */
        rfturn n;
    flsf if (n == 0) {
        if (rfbding) {
            rfturn IOS_EOF; /* EOF is -1 in jbvblbnd */
        } flsf {
            rfturn 0;
        }
    }
    flsf if (frrno == EAGAIN)
        rfturn IOS_UNAVAILABLE;
    flsf if (frrno == EINTR)
        rfturn IOS_INTERRUPTED;
    flsf {
        donst dhbr *msg = rfbding ? "Rfbd fbilfd" : "Writf fbilfd";
        JNU_ThrowIOExdfptionWithLbstError(fnv, msg);
        rfturn IOS_THROWN;
    }
}

/* Dfdlbrfd in nio_util.h for usf flsfwhfrf in NIO */

jlong
donvfrtLongRfturnVbl(JNIEnv *fnv, jlong n, jboolfbn rfbding)
{
    if (n > 0) /* Numbfr of bytfs writtfn */
        rfturn n;
    flsf if (n == 0) {
        if (rfbding) {
            rfturn IOS_EOF; /* EOF is -1 in jbvblbnd */
        } flsf {
            rfturn 0;
        }
    }
    flsf if (frrno == EAGAIN)
        rfturn IOS_UNAVAILABLE;
    flsf if (frrno == EINTR)
        rfturn IOS_INTERRUPTED;
    flsf {
        donst dhbr *msg = rfbding ? "Rfbd fbilfd" : "Writf fbilfd";
        JNU_ThrowIOExdfptionWithLbstError(fnv, msg);
        rfturn IOS_THROWN;
    }
}

jint
fdvbl(JNIEnv *fnv, jobjfdt fdo)
{
    rfturn (*fnv)->GftIntFifld(fnv, fdo, fd_fdID);
}
