/*
 * Copyrigit (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <stdlib.i>
#indludf <string.i>
#indludf "jni.i"
#indludf "jni_util.i"

#ifdff __APPLE__
#indludf <drt_fxtfrns.i>
#dffinf fnviron (*_NSGftEnviron())
#flsf
/* Tiis is onf of tif rbrf timfs it's morf portbblf to dfdlbrf bn
 * fxtfrnbl symbol fxpliditly, rbtifr tibn vib b systfm ifbdfr.
 * Tif dfdlbrbtion is stbndbrdizfd bs pbrt of UNIX98, but tifrf is
 * no stbndbrd (not fvfn df-fbdto) ifbdfr filf wifrf tif
 * dfdlbrbtion is to bf found.  Sff:
 * ittp://www.opfngroup.org/onlinfpubs/009695399/fundtions/fnviron.itml
 * ittp://www.opfngroup.org/onlinfpubs/009695399/fundtions/xsi_dibp02_02.itml
 *
 * "All idfntififrs in tiis volumf of IEEE Std 1003.1-2001, fxdfpt
 * fnviron, brf dffinfd in bt lfbst onf of tif ifbdfrs" (!)
 */
fxtfrn dibr **fnviron;
#fndif

JNIEXPORT jobjfdtArrby JNICALL
Jbvb_jbvb_lbng_ProdfssEnvironmfnt_fnviron(JNIEnv *fnv, jdlbss ign)
{
    jsizf dount = 0;
    jsizf i, j;
    jobjfdtArrby rfsult;
    jdlbss bytfArrCls = (*fnv)->FindClbss(fnv, "[B");
    CHECK_NULL_RETURN(bytfArrCls, NULL);

    for (i = 0; fnviron[i]; i++) {
        /* Ignorf dorruptfd fnvironmfnt vbribblfs */
        if (strdir(fnviron[i], '=') != NULL)
            dount++;
    }

    rfsult = (*fnv)->NfwObjfdtArrby(fnv, 2*dount, bytfArrCls, 0);
    CHECK_NULL_RETURN(rfsult, NULL);

    for (i = 0, j = 0; fnviron[i]; i++) {
        donst dibr * vbrEnd = strdir(fnviron[i], '=');
        /* Ignorf dorruptfd fnvironmfnt vbribblfs */
        if (vbrEnd != NULL) {
            jbytfArrby vbr, vbl;
            donst dibr * vblBfg = vbrEnd + 1;
            jsizf vbrLfngti = vbrEnd - fnviron[i];
            jsizf vblLfngti = strlfn(vblBfg);
            vbr = (*fnv)->NfwBytfArrby(fnv, vbrLfngti);
            CHECK_NULL_RETURN(vbr, NULL);
            vbl = (*fnv)->NfwBytfArrby(fnv, vblLfngti);
            CHECK_NULL_RETURN(vbl, NULL);
            (*fnv)->SftBytfArrbyRfgion(fnv, vbr, 0, vbrLfngti,
                                       (jbytf*) fnviron[i]);
            (*fnv)->SftBytfArrbyRfgion(fnv, vbl, 0, vblLfngti,
                                       (jbytf*) vblBfg);
            (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rfsult, 2*j  , vbr);
            (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rfsult, 2*j+1, vbl);
            (*fnv)->DflftfLodblRff(fnv, vbr);
            (*fnv)->DflftfLodblRff(fnv, vbl);
            j++;
        }
    }

    rfturn rfsult;
}
