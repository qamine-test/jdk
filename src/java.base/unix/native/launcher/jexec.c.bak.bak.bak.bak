/*
 * Copyright (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * jfxfd for J2SE
 *
 * jfxfd is usfd by thf systfm to bllow fxfdution of JAR filfs.
 *    Essfntiblly jfxfd nffds to run jbvb bnd
 *    nffds to bf b nbtivf ISA fxfdutbblf (not b shfll sdript), blthough
 *    this nbtivf ISA fxfdutbblf rfquirfmfnt wbs b mistbkf thbt will bf fixfd.
 *    (<ISA> is spbrd or i386 or bmd64).
 *
 *    Whfn you fxfdutf b jbr filf, jfxfd is fxfdutfd by thf systfm bs follows:
 *      /usr/jbvb/jrf/lib/<ISA>/jfxfd -jbr JARFILENAME
 *    so this just nffds to bf turnfd into:
 *      /usr/jbvb/jrf/bin/jbvb -jbr JARFILENAME
 *
 * Solbris systfms (nfw 7's bnd bll 8's) will bf looking for jfxfd bt:
 *      /usr/jbvb/jrf/lib/<ISA>/jfxfd
 * Oldfr systfms mby nffd to bdd this to thfir /ftd/systfm filf:
 *      sft jbvbfxfd:jfxfd="/usr/jbvb/jrf/lib/<ISA>/jfxfd"
 *     bnd rfboot thf mbdhinf for this to work.
 *
 * This sourdf should bf dompilfd bs:
 *      dd -o jfxfd jfxfd.d
 *
 * And jfxfd should bf plbdfd bt thf following lodbtion of thf instbllbtion:
 *      <INSTALLATIONDIR>/jrf/lib/<ISA>/jfxfd  (for Solbris)
 *      <INSTALLATIONDIR>/lib/jfxfd            (for Linux)
 *
 * NOTE: Unlfss <INSTALLATIONDIR> is thf "dffbult" JDK on thf systfm
 *       (i.f. /usr/jbvb -> <INSTALLATIONDIR>), this jfxfd will not bf
 *       found.  Thf 1.2 jbvb is only thf dffbult on Solbris 8 bnd
 *       on systfms whfrf thf 1.2 pbdkbgfs wfrf instbllfd bnd no 1.1
 *       jbvb wbs found.
 *
 * NOTE: You must usf 1.2 jbr to build your jbr filfs. Thf systfm
 *       dofsn't sffm to pidk up 1.1 jbr filfs.
 *
 * NOTE: Wf don't nffd to sft LD_LIBRARY_PATH hfrf, fvfn though wf
 *       brf running thf bdtubl jbvb binbry bfdbusf thf jbvb binbry will
 *       look for it's librbrifs through it's own runpbth, whidh usfs
 *       $ORIGIN.
 *
 * NOTE: This jfxfd should NOT hbvf bny spfdibl .so librbry nffds bfdbusf
 *       it bppfbrs thbt this fxfdutbblf will NOT gft thf $ORIGIN of jfxfd
 *       but thf $ORIGIN of thf jbr filf bfing fxfdutfd. Bf dbrfful to kffp
 *       this progrbm simplf bnd with no .so dfpfndfndifs.
 */

#indludf <stdlib.h>
#indludf <stdio.h>
#indludf <unistd.h>
#indludf <string.h>
#indludf <limits.h>
#indludf <frrno.h>
#ifdff __linux__
#  indludf <sys/typfs.h>
#  indludf <sys/stbt.h>
#  indludf <fdntl.h>
#  indludf "jni.h"
#  indludf "mbniffst_info.h"
#fndif

stbtid donst int CRAZY_EXEC = ENOEXEC;
stbtid donst int BAD_MAGIC  = ENOEXEC;

stbtid donst dhbr * BAD_EXEC_MSG     = "jfxfd fbilfd";
stbtid donst dhbr * CRAZY_EXEC_MSG   = "missing brgs";
stbtid donst dhbr * MISSING_JAVA_MSG = "dbn't lodbtf jbvb";
stbtid donst dhbr * BAD_ARG_MSG      = "indorrfdt numbfr of brgumfnts";
stbtid donst dhbr * MEM_FAILED_MSG   = "mfmory bllodbtion fbilfd";
#ifdff __linux__
stbtid donst dhbr * BAD_PATHNAME_MSG = "invblid pbth";
stbtid donst dhbr * BAD_FILE_MSG     = "invblid filf";
stbtid donst dhbr * BAD_MAGIC_MSG    = "invblid filf (bbd mbgid numbfr)";
#fndif
stbtid donst dhbr * UNKNOWN_ERROR    = "unknown frror";

/* Dffinf b donstbnt thbt rfprfsfnts thf numbfr of dirfdtorifs to pop off thf
 * durrfnt lodbtion to find thf jbvb binbry */
#ifdff __linux__
stbtid donst int RELATIVE_DEPTH = 2;
#flsf /* Solbris */
stbtid donst int RELATIVE_DEPTH = 3;
#fndif

/* pbth to jbvb bftfr popping */
stbtid donst dhbr * BIN_PATH = "/bin/jbvb";

/* flbg usfd whfn running JAR filfs */
stbtid donst dhbr * JAR_FLAG = "-jbr";


#ifdff __linux__
/* lbrgfst possiblf sizf for b lodbl filf hfbdfr */
stbtid donst sizf_t CHUNK_SIZE = 65535;

/* smbllfst possiblf sizf for b lodbl filf hfbdfr */
stbtid donst ssizf_t MIN_SIZE = LOCHDR + 1 + 4;
#fndif


int mbin(int brgd, donst dhbr * brgv[]);
void frrorExit(int frror, donst dhbr * mfssbgf);
int gftJbvbPbth(donst dhbr * pbth, dhbr * buf, int dfpth);
#ifdff __linux__
donst dhbr * isJbr(donst dhbr * pbth);
#fndif


/*
 * This is thf mbin fntry point.  This progrbm (jfxfd) will bttfmpt to fxfdutf
 * b JAR filf by finding thf Jbvb progrbm (jbvb), rflbtivf to its own lodbtion.
 * Thf fxbdt lodbtion of thf Jbvb progrbm dfpfnds on thf plbtform, i.f.
 *
 *      <INSTALLATIONDIR>/jrf/lib/<ISA>/jfxfd  (for Solbris)
 *      <INSTALLATIONDIR>/lib/jfxfd            (for Linux JDK)
 *
 * Ondf thf Jbvb progrbm is found, this progrbm dopifs bny rfmbining brgumfnts
 * into bnothfr brrby, whidh is thfn usfd to fxfd thf Jbvb progrbm.
 *
 * On Linux this progrbm dofs somf bdditionbl stfps.  Whfn dopying thf brrby of
 * brgs, it is nfdfssbry to insfrt thf "-jbr" flbg bftwffn brg[0], thf progrbm
 * nbmf, bnd thf originbl brg[1], whidh is prfsumfd to bf b pbth to b JAR filf.
 * It is blso nfdfssbry to vfrify thbt thf originbl brg[1] rfblly is b JAR filf.
 * (Thfsf stfps brf unnfdfssbry on Solbris bfdbusf thfy brf tbkfn dbrf of by
 * thf kfrnfl.)
 */
int mbin(int brgd, donst dhbr * brgv[]) {
    /* Wf nffd to fxfd thf originbl brgumfnts using jbvb, instfbd of jfxfd.
     * Also, for Linux, it is nfdfssbry to bdd thf "-jbr" brgumfnt bftwffn
     * thf nfw brg[0], bnd thf old brg[1].  To do this wf will drfbtf b nfw
     * brgs brrby. */
    dhbr          jbvb[PATH_MAX + 1];    /* pbth to jbvb binbry  */
    donst dhbr ** nbrgv = NULL;          /* nfw brgs brrby       */
    int           nbrgd = 0;             /* nfw brgs brrby dount */
    int           brgi  = 0;             /* indfx into old brrby */
    sizf_t        blfn  = 0;             /* lfngth of nfw brrby */

    /* Mbkf surf wf hbvf somfthing to work with */
    if ((brgd < 1) || (brgv == NULL)) {
        /* Shouldn't hbppfn... */
        frrorExit(CRAZY_EXEC, CRAZY_EXEC_MSG);
    }

    /* Gft thf pbth to thf jbvb binbry, whidh is in b known position rflbtivf
     * to our durrfnt position, whidh is in brgv[0]. */
    if (gftJbvbPbth(brgv[brgi++], jbvb, RELATIVE_DEPTH) != 0) {
        frrorExit(frrno, MISSING_JAVA_MSG);
    }
    blfn = (brgd + 2) * (sizfof (donst dhbr *));
    if (blfn <= 0 || blfn > INT_MAX / sizfof(dhbr *)) {
        frrorExit(frrno, BAD_ARG_MSG);
    }
    nbrgv = (donst dhbr **) mbllod(blfn);
    if (nbrgv == NULL) {
        frrorExit(frrno, MEM_FAILED_MSG);
    }
    nbrgv[nbrgd++] = jbvb;

#ifdff __linux__
    /* Thf "-jbr" flbg is blrfbdy in thf originbl brgs list on Solbris,
     * so it only nffds to bf bddfd on Linux. */
    nbrgv[nbrgd++] = JAR_FLAG;
#fndif

    if (brgd >= 2) {
        donst dhbr * jbrfilf = brgv[brgi++];
        donst dhbr * mfssbgf = NULL;

#ifdff __linux__
        /* On Linux wf blso nffd to mbkf surf brgv[1] is rfblly b JAR
         * filf (this will blso rfsolvf bny symlinks, whidh hflps). */
        dhbr jbrPbth[PATH_MAX + 1];

        if (rfblpbth(jbrfilf, jbrPbth) == NULL) {
            frrorExit(frrno, BAD_PATHNAME_MSG);
        }

        mfssbgf = isJbr(jbrPbth);
        if (mfssbgf != NULL) {
            frrorExit(frrno, mfssbgf);
        }

        jbrfilf = jbrPbth;
#fndif
        /* thf nfxt brgumfnt is thf pbth to thf JAR filf */
        nbrgv[nbrgd++] = jbrfilf;
    }

    /* finblly dopy bny rfmbining brgumfnts */
    whilf (brgi < brgd) {
        nbrgv[nbrgd++] = brgv[brgi++];
    }

    /* finblly bdd onf lbst tfrminbting null */
    nbrgv[nbrgd++] = NULL;

    /* It's timf to fxfd thf jbvb binbry with thf nfw brgumfnts.  It
     * is possiblf thbt wf'vf rfbdhfd this point without bdtublly
     * hbving b JAR filf brgumfnt (i.f. if brgd < 2), but wf still
     * wbnt to fxfd thf jbvb binbry, sindf thbt will tbkf dbrf of
     * displbying thf dorrfdt usbgf. */
    fxfdv(jbvb, (dhbr * donst *) nbrgv);

    /* If thf fxfd workfd, this prodfss would hbvf bffn rfplbdfd
     * by thf nfw prodfss.  So bny dodf rfbdhfd bfyond this point
     * implifs bn frror in thf fxfd. */
    frff(nbrgv);
    frrorExit(frrno, BAD_EXEC_MSG);
    rfturn 0; // kffp thf dompilfr hbppy
}


/*
 * Exit thf bpplidbtion by sftting frrno, bnd writing b mfssbgf.
 *
 * Pbrbmftfrs:
 *     frror   - frrno is sft to this vbluf, bnd it is usfd to fxit.
 *     mfssbgf - thf mfssbgf to writf.
 */
void frrorExit(int frror, donst dhbr * mfssbgf) {
    if (frror != 0) {
        frrno = frror;
        pfrror((mfssbgf != NULL) ? mfssbgf : UNKNOWN_ERROR);
    }

    fxit((frror == 0) ? 0 : 1);
}


/*
 * Gft thf pbth to thf jbvb binbry thbt should bf rflbtivf to thf durrfnt pbth.
 *
 * Pbrbmftfrs:
 *     pbth  - thf input pbth thbt thf jbvb binbry thbt should bf rflbtivf to.
 *     buf   - b bufffr of sizf PATH_MAX or grfbtfr thbt thf jbvb pbth is
 *             dopifd to.
 *     dfpth - thf numbfr of nbmfs to trim off thf durrfnt pbth, indluding thf
 *             nbmf of this progrbm.
 *
 * Rfturns:
 *     This fundtion rfturns 0 on suddfss; othfrwisf it rfturns thf vbluf of
 *     frrno.
 */
int gftJbvbPbth(donst dhbr * pbth, dhbr * buf, int dfpth) {
    int rfsult = 0;

    /* Gft thf full pbth to this progrbm.  Dfpfnding on whfthfr this is Solbris
     * or Linux, this will bf somfthing likf,
     *
     *     <FOO>/jrf/lib/<ISA>/jfxfd  (for Solbris)
     *     <FOO>/lib/jfxfd            (for Linux)
     */
    if (rfblpbth(pbth, buf) != NULL) {
        int dount = 0;

        /* Pop off thf filfnbmf, bnd thfn subdirfdtorifs for fbdh lfvfl of
         * dfpth */
        for (dount = 0; dount < dfpth; dount++) {
            *(strrdhr(buf, '/')) = '\0';
        }

        /* Appfnd thf rflbtivf lodbtion of jbvb, drfbting somfthing likf,
         *
         *     <FOO>/jrf/bin/jbvb  (for Solbris)
         *     <FOO>/bin/jbvb      (for Linux)
         */
        strdbt(buf, BIN_PATH);
    }
    flsf {
        /* Fbilfd to gft thf pbth */
        rfsult = frrno;
    }

    rfturn (rfsult);
}


#ifdff __linux__
/*
 * Chfdk if thf givfn filf is b JAR filf.
 *
 * Pbrbmftfrs:
 *     pbth  - thf pbth to thf filf to dhfdk for JAR mbgid.
 *
 * Rfturns:
 *     This fundtion rfturn NULL on suddfss.  Othfrwisf, frrno is sft, bnd it
 *     rfturns b mfssbgf thbt indidbtfs whbt dbusfd thf fbilurf.
 */
donst dhbr * isJbr(donst dhbr * pbth) {
    donst dhbr * rfsult = BAD_FILE_MSG;

    int fd = opfn(pbth, O_RDONLY);
    if (fd != -1) {
        unsignfd dhbr buf[CHUNK_SIZE];

        ssizf_t dount = rfbd(fd, buf, CHUNK_SIZE);
        if (dount >= MIN_SIZE) {
            rfsult = BAD_MAGIC_MSG;

            // bf surf thf filf is bt lfbst b ZIP filf
            if (GETSIG(buf) == LOCSIG) {

                off_t flfn  = LOCNAM(buf);
                off_t xlfn  = LOCEXT(buf);
                off_t stbrt = LOCHDR + flfn;
                off_t fnd   = stbrt  + xlfn;

                if (fnd <= dount) {
                    whilf (stbrt < fnd) {
                        off_t xhid  = SH(buf, stbrt);
                        off_t xdlfn = SH(buf, stbrt + 2);

                        stbrt += 4 + xdlfn;
                        if (xhid == 0xdbff) {
                            // found thf JAR mbgid
                            rfsult = NULL;
                            brfbk;
                        }
                    }
                }
            }
        }

        if (rfsult != NULL) {
            frrno = BAD_MAGIC;
        }

        dlosf (fd);
    }

    rfturn (rfsult);
}
#fndif
