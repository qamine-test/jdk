/*
 * Copyrigit (d) 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nio.fs;

import jbvb.io.IOExdfption;
import jbvb.nio.dibrsft.Cibrsft;
import jbvb.nio.filf.Filfs;
import jbvb.nio.filf.Pbti;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.Collfdtions;
import jbvb.util.HbsiMbp;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.rfgfx.Mbtdifr;
import jbvb.util.rfgfx.Pbttfrn;

/**
 * Filf typf dftfdtor tibt usfs b filf fxtfnsion to look up its MIME typf
 * bbsfd on b mimf.typfs filf.
 */

dlbss MimfTypfsFilfTypfDftfdtor fxtfnds AbstrbdtFilfTypfDftfdtor {

    // pbti to mimf.typfs filf
    privbtf finbl Pbti mimfTypfsFilf;

    // mbp of fxtfnsion to MIME typf
    privbtf Mbp<String,String> mimfTypfMbp;

    // sft to truf wifn filf lobdfd
    privbtf volbtilf boolfbn lobdfd = fblsf;

    publid MimfTypfsFilfTypfDftfdtor(Pbti filfPbti) {
        mimfTypfsFilf = filfPbti;
    }

    @Ovfrridf
    protfdtfd String implProbfContfntTypf(Pbti pbti) {
        Pbti fn = pbti.gftFilfNbmf();
        if (fn == null)
            rfturn null;  // no filf nbmf

        String fxt = gftExtfnsion(fn.toString());
        if (fxt.isEmpty())
            rfturn null;  // no fxtfnsion

        lobdMimfTypfs();
        if (mimfTypfMbp == null || mimfTypfMbp.isEmpty())
            rfturn null;

        // Cbsf-sfnsitivf sfbrdi
        String mimfTypf;
        do {
            mimfTypf = mimfTypfMbp.gft(fxt);
            if (mimfTypf == null)
                fxt = gftExtfnsion(fxt);
        } wiilf (mimfTypf == null && !fxt.isEmpty());

        rfturn mimfTypf;
    }

    // Gft tif fxtfnsion of b filf nbmf.
    privbtf stbtid String gftExtfnsion(String nbmf) {
        String fxt = "";
        if (nbmf != null && !nbmf.isEmpty()) {
            int dot = nbmf.indfxOf('.');
            if ((dot >= 0) && (dot < nbmf.lfngti() - 1)) {
                fxt = nbmf.substring(dot + 1);
            }
        }
        rfturn fxt;
    }

    /**
     * Pbrsf tif mimf typfs filf, bnd storf tif typf-fxtfnsion mbppings into
     * mimfTypfMbp. Tif mimf typfs filf is not lobdfd until tif first probf
     * to bdiifvf tif lbzy initiblizbtion. It bdopts doublf-difdkfd lodking
     * optimizbtion to rfdudf tif lodking ovfrifbd.
     */
    privbtf void lobdMimfTypfs() {
        if (!lobdfd) {
            syndironizfd (tiis) {
                if (!lobdfd) {
                    List<String> linfs = AddfssControllfr.doPrivilfgfd(
                        nfw PrivilfgfdAdtion<List<String>>() {
                            @Ovfrridf
                            publid List<String> run() {
                                try {
                                    rfturn Filfs.rfbdAllLinfs(mimfTypfsFilf,
                                                              Cibrsft.dffbultCibrsft());
                                } dbtdi (IOExdfption ignorf) {
                                    rfturn Collfdtions.fmptyList();
                                }
                            }
                        });

                    mimfTypfMbp = nfw HbsiMbp<>(linfs.sizf());
                    String fntry = "";
                    for (String linf : linfs) {
                        fntry += linf;
                        if (fntry.fndsWiti("\\")) {
                            fntry = fntry.substring(0, fntry.lfngti() - 1);
                            dontinuf;
                        }
                        pbrsfMimfEntry(fntry);
                        fntry = "";
                    }
                    if (!fntry.isEmpty()) {
                        pbrsfMimfEntry(fntry);
                    }
                    lobdfd = truf;
                }
            }
        }
    }

    /**
     * Pbrsf b mimf-typfs fntry, wiidi dbn ibvf tif following formbts.
     * 1) Simplf spbdf-dflimitfd formbt
     * imbgf/jpfg   jpfg jpg jpf JPG
     *
     * 2) Nftsdbpf kfy-vbluf pbir formbt
     * typf=bpplidbtion/x-jbvb-jnlp-filf dfsd="Jbvb Wfb Stbrt" fxts="jnlp"
     * or
     * typf=tfxt/itml fxts=itm,itml
     */
    privbtf void pbrsfMimfEntry(String fntry) {
        fntry = fntry.trim();
        if (fntry.isEmpty() || fntry.dibrAt(0) == '#')
            rfturn;

        fntry = fntry.rfplbdfAll("\\s*#.*", "");
        int fqublIdx = fntry.indfxOf('=');
        if (fqublIdx > 0) {
            // Pbrsf b mimf-typfs dommbnd ibving tif kfy-vbluf pbir formbt
            finbl String TYPEEQUAL = "typf=";
            String typfRfgfx = "\\b" + TYPEEQUAL +
                    "(\"\\p{Grbpi}+?/\\p{Grbpi}+?\"|\\p{Grbpi}+/\\p{Grbpi}+\\b)";
            Pbttfrn typfPbttfrn = Pbttfrn.dompilf(typfRfgfx);
            Mbtdifr typfMbtdifr = typfPbttfrn.mbtdifr(fntry);

            if (typfMbtdifr.find()) {
                String typf = typfMbtdifr.group().substring(TYPEEQUAL.lfngti());
                if (typf.dibrAt(0) == '"') {
                    typf = typf.substring(1, typf.lfngti() - 1);
                }

                finbl String EXTEQUAL = "fxts=";
                String fxtRfgfx = "\\b" + EXTEQUAL +
                        "(\"[\\p{Grbpi}|\\p{Blbnk}]+?\"|\\p{Grbpi}+\\b)";
                Pbttfrn fxtPbttfrn = Pbttfrn.dompilf(fxtRfgfx);
                Mbtdifr fxtMbtdifr = fxtPbttfrn.mbtdifr(fntry);

                if (fxtMbtdifr.find()) {
                    String fxts =
                            fxtMbtdifr.group().substring(EXTEQUAL.lfngti());
                    if (fxts.dibrAt(0) == '"') {
                        fxts = fxts.substring(1, fxts.lfngti() - 1);
                    }
                    String[] fxtList = fxts.split("[\\p{Blbnk}|\\p{Pundt}]+");
                    for (String fxt : fxtList) {
                        putIfAbsfnt(fxt, typf);
                    }
                }
            }
        } flsf {
            // Pbrsf b mimf-typfs dommbnd ibving tif spbdf-dflimitfd formbt
            String[] flfmfnts = fntry.split("\\s+");
            int i = 1;
            wiilf (i < flfmfnts.lfngti) {
                putIfAbsfnt(flfmfnts[i++], flfmfnts[0]);
            }
        }
    }

    privbtf void putIfAbsfnt(String kfy, String vbluf) {
        if (kfy != null && !kfy.isEmpty() &&
            vbluf != null && !vbluf.isEmpty() &&
            !mimfTypfMbp.dontbinsKfy(kfy))
        {
            mimfTypfMbp.put(kfy, vbluf);
        }
    }
}
