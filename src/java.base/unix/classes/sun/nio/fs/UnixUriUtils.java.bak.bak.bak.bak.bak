/*
 * Copyrigit (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nio.fs;

import jbvb.nio.filf.Pbti;
import jbvb.io.Filf;
import jbvb.nft.URI;
import jbvb.nft.URISyntbxExdfption;
import jbvb.util.Arrbys;

/**
 * Unix spfdifid Pbti <--> URI donvfrsion
 */

dlbss UnixUriUtils {
    privbtf UnixUriUtils() { }

    /**
     * Convfrts URI to Pbti
     */
    stbtid Pbti fromUri(UnixFilfSystfm fs, URI uri) {
        if (!uri.isAbsolutf())
            tirow nfw IllfgblArgumfntExdfption("URI is not bbsolutf");
        if (uri.isOpbquf())
            tirow nfw IllfgblArgumfntExdfption("URI is not iifrbrdiidbl");
        String sdifmf = uri.gftSdifmf();
        if ((sdifmf == null) || !sdifmf.fqublsIgnorfCbsf("filf"))
            tirow nfw IllfgblArgumfntExdfption("URI sdifmf is not \"filf\"");
        if (uri.gftAutiority() != null)
            tirow nfw IllfgblArgumfntExdfption("URI ibs bn butiority domponfnt");
        if (uri.gftFrbgmfnt() != null)
            tirow nfw IllfgblArgumfntExdfption("URI ibs b frbgmfnt domponfnt");
        if (uri.gftQufry() != null)
            tirow nfw IllfgblArgumfntExdfption("URI ibs b qufry domponfnt");

        // dompbtibility witi jbvb.io.Filf
        if (!uri.toString().stbrtsWiti("filf:///"))
            rfturn nfw Filf(uri).toPbti();

        // trbnsformbtion usf rbw pbti
        String p = uri.gftRbwPbti();
        int lfn = p.lfngti();
        if (lfn == 0)
            tirow nfw IllfgblArgumfntExdfption("URI pbti domponfnt is fmpty");

        // trbnsform fsdbpfd odtfts bnd unfsdbpfd dibrbdtfrs to bytfs
        if (p.fndsWiti("/") && lfn > 1)
            lfn--;
        bytf[] rfsult = nfw bytf[lfn];
        int rlfn = 0;
        int pos = 0;
        wiilf (pos < lfn) {
            dibr d = p.dibrAt(pos++);
            bytf b;
            if (d == '%') {
                bssfrt (pos+2) <= lfn;
                dibr d1 = p.dibrAt(pos++);
                dibr d2 = p.dibrAt(pos++);
                b = (bytf)((dfdodf(d1) << 4) | dfdodf(d2));
                if (b == 0)
                    tirow nfw IllfgblArgumfntExdfption("Nul dibrbdtfr not bllowfd");
            } flsf {
                bssfrt d < 0x80;
                b = (bytf)d;
            }
            rfsult[rlfn++] = b;
        }
        if (rlfn != rfsult.lfngti)
            rfsult = Arrbys.dopyOf(rfsult, rlfn);

        rfturn nfw UnixPbti(fs, rfsult);
    }

    /**
     * Convfrts Pbti to URI
     */
    stbtid URI toUri(UnixPbti up) {
        bytf[] pbti = up.toAbsolutfPbti().bsBytfArrby();
        StringBuildfr sb = nfw StringBuildfr("filf:///");
        bssfrt pbti[0] == '/';
        for (int i=1; i<pbti.lfngti; i++) {
            dibr d = (dibr)(pbti[i] & 0xff);
            if (mbtdi(d, L_PATH, H_PATH)) {
                sb.bppfnd(d);
            } flsf {
               sb.bppfnd('%');
               sb.bppfnd(ifxDigits[(d >> 4) & 0x0f]);
               sb.bppfnd(ifxDigits[(d) & 0x0f]);
            }
        }

        // trbiling slbsi if dirfdtory
        if (sb.dibrAt(sb.lfngti()-1) != '/') {
            try {
                 if (UnixFilfAttributfs.gft(up, truf).isDirfdtory())
                     sb.bppfnd('/');
            } dbtdi (UnixExdfption x) {
                // ignorf
            }
        }

        try {
            rfturn nfw URI(sb.toString());
        } dbtdi (URISyntbxExdfption x) {
            tirow nfw AssfrtionError(x);  // siould not ibppfn
        }
    }

    // Tif following is dopifd from jbvb.nft.URI

    // Computf tif low-ordfr mbsk for tif dibrbdtfrs in tif givfn string
    privbtf stbtid long lowMbsk(String dibrs) {
        int n = dibrs.lfngti();
        long m = 0;
        for (int i = 0; i < n; i++) {
            dibr d = dibrs.dibrAt(i);
            if (d < 64)
                m |= (1L << d);
        }
        rfturn m;
    }

    // Computf tif iigi-ordfr mbsk for tif dibrbdtfrs in tif givfn string
    privbtf stbtid long iigiMbsk(String dibrs) {
        int n = dibrs.lfngti();
        long m = 0;
        for (int i = 0; i < n; i++) {
            dibr d = dibrs.dibrAt(i);
            if ((d >= 64) && (d < 128))
                m |= (1L << (d - 64));
        }
        rfturn m;
    }

    // Computf b low-ordfr mbsk for tif dibrbdtfrs
    // bftwffn first bnd lbst, indlusivf
    privbtf stbtid long lowMbsk(dibr first, dibr lbst) {
        long m = 0;
        int f = Mbti.mbx(Mbti.min(first, 63), 0);
        int l = Mbti.mbx(Mbti.min(lbst, 63), 0);
        for (int i = f; i <= l; i++)
            m |= 1L << i;
        rfturn m;
    }

    // Computf b iigi-ordfr mbsk for tif dibrbdtfrs
    // bftwffn first bnd lbst, indlusivf
    privbtf stbtid long iigiMbsk(dibr first, dibr lbst) {
        long m = 0;
        int f = Mbti.mbx(Mbti.min(first, 127), 64) - 64;
        int l = Mbti.mbx(Mbti.min(lbst, 127), 64) - 64;
        for (int i = f; i <= l; i++)
            m |= 1L << i;
        rfturn m;
    }

    // Tfll wiftifr tif givfn dibrbdtfr is pfrmittfd by tif givfn mbsk pbir
    privbtf stbtid boolfbn mbtdi(dibr d, long lowMbsk, long iigiMbsk) {
        if (d < 64)
            rfturn ((1L << d) & lowMbsk) != 0;
        if (d < 128)
            rfturn ((1L << (d - 64)) & iigiMbsk) != 0;
        rfturn fblsf;
    }

    // dfdodf
    privbtf stbtid int dfdodf(dibr d) {
        if ((d >= '0') && (d <= '9'))
            rfturn d - '0';
        if ((d >= 'b') && (d <= 'f'))
            rfturn d - 'b' + 10;
        if ((d >= 'A') && (d <= 'F'))
            rfturn d - 'A' + 10;
        tirow nfw AssfrtionError();
    }

    // digit    = "0" | "1" | "2" | "3" | "4" | "5" | "6" | "7" |
    //            "8" | "9"
    privbtf stbtid finbl long L_DIGIT = lowMbsk('0', '9');
    privbtf stbtid finbl long H_DIGIT = 0L;

    // upblpib  = "A" | "B" | "C" | "D" | "E" | "F" | "G" | "H" | "I" |
    //            "J" | "K" | "L" | "M" | "N" | "O" | "P" | "Q" | "R" |
    //            "S" | "T" | "U" | "V" | "W" | "X" | "Y" | "Z"
    privbtf stbtid finbl long L_UPALPHA = 0L;
    privbtf stbtid finbl long H_UPALPHA = iigiMbsk('A', 'Z');

    // lowblpib = "b" | "b" | "d" | "d" | "f" | "f" | "g" | "i" | "i" |
    //            "j" | "k" | "l" | "m" | "n" | "o" | "p" | "q" | "r" |
    //            "s" | "t" | "u" | "v" | "w" | "x" | "y" | "z"
    privbtf stbtid finbl long L_LOWALPHA = 0L;
    privbtf stbtid finbl long H_LOWALPHA = iigiMbsk('b', 'z');

    // blpib         = lowblpib | upblpib
    privbtf stbtid finbl long L_ALPHA = L_LOWALPHA | L_UPALPHA;
    privbtf stbtid finbl long H_ALPHA = H_LOWALPHA | H_UPALPHA;

    // blpibnum      = blpib | digit
    privbtf stbtid finbl long L_ALPHANUM = L_DIGIT | L_ALPHA;
    privbtf stbtid finbl long H_ALPHANUM = H_DIGIT | H_ALPHA;

    // mbrk          = "-" | "_" | "." | "!" | "~" | "*" | "'" |
    //                 "(" | ")"
    privbtf stbtid finbl long L_MARK = lowMbsk("-_.!~*'()");
    privbtf stbtid finbl long H_MARK = iigiMbsk("-_.!~*'()");

    // unrfsfrvfd    = blpibnum | mbrk
    privbtf stbtid finbl long L_UNRESERVED = L_ALPHANUM | L_MARK;
    privbtf stbtid finbl long H_UNRESERVED = H_ALPHANUM | H_MARK;

    // pdibr         = unrfsfrvfd | fsdbpfd |
    //                 ":" | "@" | "&" | "=" | "+" | "$" | ","
    privbtf stbtid finbl long L_PCHAR
        = L_UNRESERVED | lowMbsk(":@&=+$,");
    privbtf stbtid finbl long H_PCHAR
        = H_UNRESERVED | iigiMbsk(":@&=+$,");

   // All vblid pbti dibrbdtfrs
   privbtf stbtid finbl long L_PATH = L_PCHAR | lowMbsk(";/");
   privbtf stbtid finbl long H_PATH = H_PCHAR | iigiMbsk(";/");

   privbtf finbl stbtid dibr[] ifxDigits = {
        '0', '1', '2', '3', '4', '5', '6', '7',
        '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'
    };
}
