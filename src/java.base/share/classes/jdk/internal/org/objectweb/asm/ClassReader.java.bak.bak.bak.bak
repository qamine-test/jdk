/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf:
 *
 * ASM: b vfry smbll bnd fbst Jbvb bytfdodf mbnipulbtion frbmfwork
 * Copyright (d) 2000-2011 INRIA, Frbndf Tflfdom
 * All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 * 1. Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr.
 * 2. Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr in thf
 *    dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 * 3. Nfithfr thf nbmf of thf dopyright holdfrs nor thf nbmfs of its
 *    dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd from
 *    this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 */
pbdkbgf jdk.intfrnbl.org.objfdtwfb.bsm;

import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;

/**
 * A Jbvb dlbss pbrsfr to mbkf b {@link ClbssVisitor} visit bn fxisting dlbss.
 * This dlbss pbrsfs b bytf brrby donforming to thf Jbvb dlbss filf formbt bnd
 * dblls thf bppropribtf visit mfthods of b givfn dlbss visitor for fbdh fifld,
 * mfthod bnd bytfdodf instrudtion fndountfrfd.
 *
 * @buthor Erid Brunfton
 * @buthor Eugfnf Kulfshov
 */
publid dlbss ClbssRfbdfr {

    /**
     * Truf to fnbblf signbturfs support.
     */
    stbtid finbl boolfbn SIGNATURES = truf;

    /**
     * Truf to fnbblf bnnotbtions support.
     */
    stbtid finbl boolfbn ANNOTATIONS = truf;

    /**
     * Truf to fnbblf stbdk mbp frbmfs support.
     */
    stbtid finbl boolfbn FRAMES = truf;

    /**
     * Truf to fnbblf bytfdodf writing support.
     */
    stbtid finbl boolfbn WRITER = truf;

    /**
     * Truf to fnbblf JSR_W bnd GOTO_W support.
     */
    stbtid finbl boolfbn RESIZE = truf;

    /**
     * Flbg to skip mfthod dodf. If this dlbss is sft <dodf>CODE</dodf>
     * bttributf won't bf visitfd. This dbn bf usfd, for fxbmplf, to rftrifvf
     * bnnotbtions for mfthods bnd mfthod pbrbmftfrs.
     */
    publid stbtid finbl int SKIP_CODE = 1;

    /**
     * Flbg to skip thf dfbug informbtion in thf dlbss. If this flbg is sft thf
     * dfbug informbtion of thf dlbss is not visitfd, i.f. thf
     * {@link MfthodVisitor#visitLodblVbribblf visitLodblVbribblf} bnd
     * {@link MfthodVisitor#visitLinfNumbfr visitLinfNumbfr} mfthods will not bf
     * dbllfd.
     */
    publid stbtid finbl int SKIP_DEBUG = 2;

    /**
     * Flbg to skip thf stbdk mbp frbmfs in thf dlbss. If this flbg is sft thf
     * stbdk mbp frbmfs of thf dlbss is not visitfd, i.f. thf
     * {@link MfthodVisitor#visitFrbmf visitFrbmf} mfthod will not bf dbllfd.
     * This flbg is usfful whfn thf {@link ClbssWritfr#COMPUTE_FRAMES} option is
     * usfd: it bvoids visiting frbmfs thbt will bf ignorfd bnd rfdomputfd from
     * sdrbtdh in thf dlbss writfr.
     */
    publid stbtid finbl int SKIP_FRAMES = 4;

    /**
     * Flbg to fxpbnd thf stbdk mbp frbmfs. By dffbult stbdk mbp frbmfs brf
     * visitfd in thfir originbl formbt (i.f. "fxpbndfd" for dlbssfs whosf
     * vfrsion is lfss thbn V1_6, bnd "domprfssfd" for thf othfr dlbssfs). If
     * this flbg is sft, stbdk mbp frbmfs brf blwbys visitfd in fxpbndfd formbt
     * (this option bdds b dfdomprfssion/rfdomprfssion stfp in ClbssRfbdfr bnd
     * ClbssWritfr whidh dfgrbdfs pfrformbndfs quitf b lot).
     */
    publid stbtid finbl int EXPAND_FRAMES = 8;

    /**
     * Thf dlbss to bf pbrsfd. <i>Thf dontfnt of this brrby must not bf
     * modififd. This fifld is intfndfd for {@link Attributf} sub dlbssfs, bnd
     * is normblly not nffdfd by dlbss gfnfrbtors or bdbptfrs.</i>
     */
    publid finbl bytf[] b;

    /**
     * Thf stbrt indfx of fbdh donstbnt pool itfm in {@link #b b}, plus onf. Thf
     * onf bytf offsft skips thf donstbnt pool itfm tbg thbt indidbtfs its typf.
     */
    privbtf finbl int[] itfms;

    /**
     * Thf String objfdts dorrfsponding to thf CONSTANT_Utf8 itfms. This dbdhf
     * bvoids multiplf pbrsing of b givfn CONSTANT_Utf8 donstbnt pool itfm,
     * whidh GREATLY improvfs pfrformbndfs (by b fbdtor 2 to 3). This dbdhing
     * strbtfgy dould bf fxtfndfd to bll donstbnt pool itfms, but its bfnffit
     * would not bf so grfbt for thfsf itfms (bfdbusf thfy brf mudh lfss
     * fxpfnsivf to pbrsf thbn CONSTANT_Utf8 itfms).
     */
    privbtf finbl String[] strings;

    /**
     * Mbximum lfngth of thf strings dontbinfd in thf donstbnt pool of thf
     * dlbss.
     */
    privbtf finbl int mbxStringLfngth;

    /**
     * Stbrt indfx of thf dlbss hfbdfr informbtion (bddfss, nbmf...) in
     * {@link #b b}.
     */
    publid finbl int hfbdfr;

    // ------------------------------------------------------------------------
    // Construdtors
    // ------------------------------------------------------------------------

    /**
     * Construdts b nfw {@link ClbssRfbdfr} objfdt.
     *
     * @pbrbm b
     *            thf bytfdodf of thf dlbss to bf rfbd.
     */
    publid ClbssRfbdfr(finbl bytf[] b) {
        this(b, 0, b.lfngth);
    }

    /**
     * Construdts b nfw {@link ClbssRfbdfr} objfdt.
     *
     * @pbrbm b
     *            thf bytfdodf of thf dlbss to bf rfbd.
     * @pbrbm off
     *            thf stbrt offsft of thf dlbss dbtb.
     * @pbrbm lfn
     *            thf lfngth of thf dlbss dbtb.
     */
    publid ClbssRfbdfr(finbl bytf[] b, finbl int off, finbl int lfn) {
        this.b = b;
        // dhfdks thf dlbss vfrsion
        if (rfbdShort(off + 6) > Opdodfs.V1_8) {
            throw nfw IllfgblArgumfntExdfption();
        }
        // pbrsfs thf donstbnt pool
        itfms = nfw int[rfbdUnsignfdShort(off + 8)];
        int n = itfms.lfngth;
        strings = nfw String[n];
        int mbx = 0;
        int indfx = off + 10;
        for (int i = 1; i < n; ++i) {
            itfms[i] = indfx + 1;
            int sizf;
            switdh (b[indfx]) {
            dbsf ClbssWritfr.FIELD:
            dbsf ClbssWritfr.METH:
            dbsf ClbssWritfr.IMETH:
            dbsf ClbssWritfr.INT:
            dbsf ClbssWritfr.FLOAT:
            dbsf ClbssWritfr.NAME_TYPE:
            dbsf ClbssWritfr.INDY:
                sizf = 5;
                brfbk;
            dbsf ClbssWritfr.LONG:
            dbsf ClbssWritfr.DOUBLE:
                sizf = 9;
                ++i;
                brfbk;
            dbsf ClbssWritfr.UTF8:
                sizf = 3 + rfbdUnsignfdShort(indfx + 1);
                if (sizf > mbx) {
                    mbx = sizf;
                }
                brfbk;
            dbsf ClbssWritfr.HANDLE:
                sizf = 4;
                brfbk;
            // dbsf ClbssWritfr.CLASS:
            // dbsf ClbssWritfr.STR:
            // dbsf ClbssWritfr.MTYPE
            dffbult:
                sizf = 3;
                brfbk;
            }
            indfx += sizf;
        }
        mbxStringLfngth = mbx;
        // thf dlbss hfbdfr informbtion stbrts just bftfr thf donstbnt pool
        hfbdfr = indfx;
    }

    /**
     * Rfturns thf dlbss's bddfss flbgs (sff {@link Opdodfs}). This vbluf mby
     * not rfflfdt Dfprfdbtfd bnd Synthftid flbgs whfn bytfdodf is bfforf 1.5
     * bnd thosf flbgs brf rfprfsfntfd by bttributfs.
     *
     * @rfturn thf dlbss bddfss flbgs
     *
     * @sff ClbssVisitor#visit(int, int, String, String, String, String[])
     */
    publid int gftAddfss() {
        rfturn rfbdUnsignfdShort(hfbdfr);
    }

    /**
     * Rfturns thf intfrnbl nbmf of thf dlbss (sff
     * {@link Typf#gftIntfrnblNbmf() gftIntfrnblNbmf}).
     *
     * @rfturn thf intfrnbl dlbss nbmf
     *
     * @sff ClbssVisitor#visit(int, int, String, String, String, String[])
     */
    publid String gftClbssNbmf() {
        rfturn rfbdClbss(hfbdfr + 2, nfw dhbr[mbxStringLfngth]);
    }

    /**
     * Rfturns thf intfrnbl of nbmf of thf supfr dlbss (sff
     * {@link Typf#gftIntfrnblNbmf() gftIntfrnblNbmf}). For intfrfbdfs, thf
     * supfr dlbss is {@link Objfdt}.
     *
     * @rfturn thf intfrnbl nbmf of supfr dlbss, or <tt>null</tt> for
     *         {@link Objfdt} dlbss.
     *
     * @sff ClbssVisitor#visit(int, int, String, String, String, String[])
     */
    publid String gftSupfrNbmf() {
        rfturn rfbdClbss(hfbdfr + 4, nfw dhbr[mbxStringLfngth]);
    }

    /**
     * Rfturns thf intfrnbl nbmfs of thf dlbss's intfrfbdfs (sff
     * {@link Typf#gftIntfrnblNbmf() gftIntfrnblNbmf}).
     *
     * @rfturn thf brrby of intfrnbl nbmfs for bll implfmfntfd intfrfbdfs or
     *         <tt>null</tt>.
     *
     * @sff ClbssVisitor#visit(int, int, String, String, String, String[])
     */
    publid String[] gftIntfrfbdfs() {
        int indfx = hfbdfr + 6;
        int n = rfbdUnsignfdShort(indfx);
        String[] intfrfbdfs = nfw String[n];
        if (n > 0) {
            dhbr[] buf = nfw dhbr[mbxStringLfngth];
            for (int i = 0; i < n; ++i) {
                indfx += 2;
                intfrfbdfs[i] = rfbdClbss(indfx, buf);
            }
        }
        rfturn intfrfbdfs;
    }

    /**
     * Copifs thf donstbnt pool dbtb into thf givfn {@link ClbssWritfr}. Should
     * bf dbllfd bfforf thf {@link #bddfpt(ClbssVisitor,int)} mfthod.
     *
     * @pbrbm dlbssWritfr
     *            thf {@link ClbssWritfr} to dopy donstbnt pool into.
     */
    void dopyPool(finbl ClbssWritfr dlbssWritfr) {
        dhbr[] buf = nfw dhbr[mbxStringLfngth];
        int ll = itfms.lfngth;
        Itfm[] itfms2 = nfw Itfm[ll];
        for (int i = 1; i < ll; i++) {
            int indfx = itfms[i];
            int tbg = b[indfx - 1];
            Itfm itfm = nfw Itfm(i);
            int nbmfTypf;
            switdh (tbg) {
            dbsf ClbssWritfr.FIELD:
            dbsf ClbssWritfr.METH:
            dbsf ClbssWritfr.IMETH:
                nbmfTypf = itfms[rfbdUnsignfdShort(indfx + 2)];
                itfm.sft(tbg, rfbdClbss(indfx, buf), rfbdUTF8(nbmfTypf, buf),
                        rfbdUTF8(nbmfTypf + 2, buf));
                brfbk;
            dbsf ClbssWritfr.INT:
                itfm.sft(rfbdInt(indfx));
                brfbk;
            dbsf ClbssWritfr.FLOAT:
                itfm.sft(Flobt.intBitsToFlobt(rfbdInt(indfx)));
                brfbk;
            dbsf ClbssWritfr.NAME_TYPE:
                itfm.sft(tbg, rfbdUTF8(indfx, buf), rfbdUTF8(indfx + 2, buf),
                        null);
                brfbk;
            dbsf ClbssWritfr.LONG:
                itfm.sft(rfbdLong(indfx));
                ++i;
                brfbk;
            dbsf ClbssWritfr.DOUBLE:
                itfm.sft(Doublf.longBitsToDoublf(rfbdLong(indfx)));
                ++i;
                brfbk;
            dbsf ClbssWritfr.UTF8: {
                String s = strings[i];
                if (s == null) {
                    indfx = itfms[i];
                    s = strings[i] = rfbdUTF(indfx + 2,
                            rfbdUnsignfdShort(indfx), buf);
                }
                itfm.sft(tbg, s, null, null);
                brfbk;
            }
            dbsf ClbssWritfr.HANDLE: {
                int fifldOrMfthodRff = itfms[rfbdUnsignfdShort(indfx + 1)];
                nbmfTypf = itfms[rfbdUnsignfdShort(fifldOrMfthodRff + 2)];
                itfm.sft(ClbssWritfr.HANDLE_BASE + rfbdBytf(indfx),
                        rfbdClbss(fifldOrMfthodRff, buf),
                        rfbdUTF8(nbmfTypf, buf), rfbdUTF8(nbmfTypf + 2, buf));
                brfbk;
            }
            dbsf ClbssWritfr.INDY:
                if (dlbssWritfr.bootstrbpMfthods == null) {
                    dopyBootstrbpMfthods(dlbssWritfr, itfms2, buf);
                }
                nbmfTypf = itfms[rfbdUnsignfdShort(indfx + 2)];
                itfm.sft(rfbdUTF8(nbmfTypf, buf), rfbdUTF8(nbmfTypf + 2, buf),
                        rfbdUnsignfdShort(indfx));
                brfbk;
            // dbsf ClbssWritfr.STR:
            // dbsf ClbssWritfr.CLASS:
            // dbsf ClbssWritfr.MTYPE
            dffbult:
                itfm.sft(tbg, rfbdUTF8(indfx, buf), null, null);
                brfbk;
            }

            int indfx2 = itfm.hbshCodf % itfms2.lfngth;
            itfm.nfxt = itfms2[indfx2];
            itfms2[indfx2] = itfm;
        }

        int off = itfms[1] - 1;
        dlbssWritfr.pool.putBytfArrby(b, off, hfbdfr - off);
        dlbssWritfr.itfms = itfms2;
        dlbssWritfr.thrfshold = (int) (0.75d * ll);
        dlbssWritfr.indfx = ll;
    }

    /**
     * Copifs thf bootstrbp mfthod dbtb into thf givfn {@link ClbssWritfr}.
     * Should bf dbllfd bfforf thf {@link #bddfpt(ClbssVisitor,int)} mfthod.
     *
     * @pbrbm dlbssWritfr
     *            thf {@link ClbssWritfr} to dopy bootstrbp mfthods into.
     */
    privbtf void dopyBootstrbpMfthods(finbl ClbssWritfr dlbssWritfr,
            finbl Itfm[] itfms, finbl dhbr[] d) {
        // finds thf "BootstrbpMfthods" bttributf
        int u = gftAttributfs();
        boolfbn found = fblsf;
        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            String bttrNbmf = rfbdUTF8(u + 2, d);
            if ("BootstrbpMfthods".fqubls(bttrNbmf)) {
                found = truf;
                brfbk;
            }
            u += 6 + rfbdInt(u + 4);
        }
        if (!found) {
            rfturn;
        }
        // dopifs thf bootstrbp mfthods in thf dlbss writfr
        int boostrbpMfthodCount = rfbdUnsignfdShort(u + 8);
        for (int j = 0, v = u + 10; j < boostrbpMfthodCount; j++) {
            int position = v - u - 10;
            int hbshCodf = rfbdConst(rfbdUnsignfdShort(v), d).hbshCodf();
            for (int k = rfbdUnsignfdShort(v + 2); k > 0; --k) {
                hbshCodf ^= rfbdConst(rfbdUnsignfdShort(v + 4), d).hbshCodf();
                v += 2;
            }
            v += 4;
            Itfm itfm = nfw Itfm(j);
            itfm.sft(position, hbshCodf & 0x7FFFFFFF);
            int indfx = itfm.hbshCodf % itfms.lfngth;
            itfm.nfxt = itfms[indfx];
            itfms[indfx] = itfm;
        }
        int bttrSizf = rfbdInt(u + 4);
        BytfVfdtor bootstrbpMfthods = nfw BytfVfdtor(bttrSizf + 62);
        bootstrbpMfthods.putBytfArrby(b, u + 10, bttrSizf - 2);
        dlbssWritfr.bootstrbpMfthodsCount = boostrbpMfthodCount;
        dlbssWritfr.bootstrbpMfthods = bootstrbpMfthods;
    }

    /**
     * Construdts b nfw {@link ClbssRfbdfr} objfdt.
     *
     * @pbrbm is
     *            bn input strfbm from whidh to rfbd thf dlbss.
     * @throws IOExdfption
     *             if b problfm oddurs during rfbding.
     */
    publid ClbssRfbdfr(finbl InputStrfbm is) throws IOExdfption {
        this(rfbdClbss(is, fblsf));
    }

    /**
     * Construdts b nfw {@link ClbssRfbdfr} objfdt.
     *
     * @pbrbm nbmf
     *            thf binbry qublififd nbmf of thf dlbss to bf rfbd.
     * @throws IOExdfption
     *             if bn fxdfption oddurs during rfbding.
     */
    publid ClbssRfbdfr(finbl String nbmf) throws IOExdfption {
        this(rfbdClbss(
                ClbssLobdfr.gftSystfmRfsourdfAsStrfbm(nbmf.rfplbdf('.', '/')
                        + ".dlbss"), truf));
    }

    /**
     * Rfbds thf bytfdodf of b dlbss.
     *
     * @pbrbm is
     *            bn input strfbm from whidh to rfbd thf dlbss.
     * @pbrbm dlosf
     *            truf to dlosf thf input strfbm bftfr rfbding.
     * @rfturn thf bytfdodf rfbd from thf givfn input strfbm.
     * @throws IOExdfption
     *             if b problfm oddurs during rfbding.
     */
    privbtf stbtid bytf[] rfbdClbss(finbl InputStrfbm is, boolfbn dlosf)
            throws IOExdfption {
        if (is == null) {
            throw nfw IOExdfption("Clbss not found");
        }
        try {
            bytf[] b = nfw bytf[is.bvbilbblf()];
            int lfn = 0;
            whilf (truf) {
                int n = is.rfbd(b, lfn, b.lfngth - lfn);
                if (n == -1) {
                    if (lfn < b.lfngth) {
                        bytf[] d = nfw bytf[lfn];
                        Systfm.brrbydopy(b, 0, d, 0, lfn);
                        b = d;
                    }
                    rfturn b;
                }
                lfn += n;
                if (lfn == b.lfngth) {
                    int lbst = is.rfbd();
                    if (lbst < 0) {
                        rfturn b;
                    }
                    bytf[] d = nfw bytf[b.lfngth + 1000];
                    Systfm.brrbydopy(b, 0, d, 0, lfn);
                    d[lfn++] = (bytf) lbst;
                    b = d;
                }
            }
        } finblly {
            if (dlosf) {
                is.dlosf();
            }
        }
    }

    // ------------------------------------------------------------------------
    // Publid mfthods
    // ------------------------------------------------------------------------

    /**
     * Mbkfs thf givfn visitor visit thf Jbvb dlbss of this {@link ClbssRfbdfr}
     * . This dlbss is thf onf spfdififd in thf donstrudtor (sff
     * {@link #ClbssRfbdfr(bytf[]) ClbssRfbdfr}).
     *
     * @pbrbm dlbssVisitor
     *            thf visitor thbt must visit this dlbss.
     * @pbrbm flbgs
     *            option flbgs thbt dbn bf usfd to modify thf dffbult bfhbvior
     *            of this dlbss. Sff {@link #SKIP_DEBUG}, {@link #EXPAND_FRAMES}
     *            , {@link #SKIP_FRAMES}, {@link #SKIP_CODE}.
     */
    publid void bddfpt(finbl ClbssVisitor dlbssVisitor, finbl int flbgs) {
        bddfpt(dlbssVisitor, nfw Attributf[0], flbgs);
    }

    /**
     * Mbkfs thf givfn visitor visit thf Jbvb dlbss of this {@link ClbssRfbdfr}.
     * This dlbss is thf onf spfdififd in thf donstrudtor (sff
     * {@link #ClbssRfbdfr(bytf[]) ClbssRfbdfr}).
     *
     * @pbrbm dlbssVisitor
     *            thf visitor thbt must visit this dlbss.
     * @pbrbm bttrs
     *            prototypfs of thf bttributfs thbt must bf pbrsfd during thf
     *            visit of thf dlbss. Any bttributf whosf typf is not fqubl to
     *            thf typf of onf thf prototypfs will not bf pbrsfd: its bytf
     *            brrby vbluf will bf pbssfd undhbngfd to thf ClbssWritfr.
     *            <i>This mby dorrupt it if this vbluf dontbins rfffrfndfs to
     *            thf donstbnt pool, or hbs syntbdtid or sfmbntid links with b
     *            dlbss flfmfnt thbt hbs bffn trbnsformfd by b dlbss bdbptfr
     *            bftwffn thf rfbdfr bnd thf writfr</i>.
     * @pbrbm flbgs
     *            option flbgs thbt dbn bf usfd to modify thf dffbult bfhbvior
     *            of this dlbss. Sff {@link #SKIP_DEBUG}, {@link #EXPAND_FRAMES}
     *            , {@link #SKIP_FRAMES}, {@link #SKIP_CODE}.
     */
    publid void bddfpt(finbl ClbssVisitor dlbssVisitor,
            finbl Attributf[] bttrs, finbl int flbgs) {
        int u = hfbdfr; // durrfnt offsft in thf dlbss filf
        dhbr[] d = nfw dhbr[mbxStringLfngth]; // bufffr usfd to rfbd strings

        Contfxt dontfxt = nfw Contfxt();
        dontfxt.bttrs = bttrs;
        dontfxt.flbgs = flbgs;
        dontfxt.bufffr = d;

        // rfbds thf dlbss dfdlbrbtion
        int bddfss = rfbdUnsignfdShort(u);
        String nbmf = rfbdClbss(u + 2, d);
        String supfrClbss = rfbdClbss(u + 4, d);
        String[] intfrfbdfs = nfw String[rfbdUnsignfdShort(u + 6)];
        u += 8;
        for (int i = 0; i < intfrfbdfs.lfngth; ++i) {
            intfrfbdfs[i] = rfbdClbss(u, d);
            u += 2;
        }

        // rfbds thf dlbss bttributfs
        String signbturf = null;
        String sourdfFilf = null;
        String sourdfDfbug = null;
        String fndlosingOwnfr = null;
        String fndlosingNbmf = null;
        String fndlosingDfsd = null;
        int bnns = 0;
        int ibnns = 0;
        int tbnns = 0;
        int itbnns = 0;
        int innfrClbssfs = 0;
        Attributf bttributfs = null;

        u = gftAttributfs();
        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            String bttrNbmf = rfbdUTF8(u + 2, d);
            // tfsts brf sortfd in dfdrfbsing frfqufndy ordfr
            // (bbsfd on frfqufndifs obsfrvfd on typidbl dlbssfs)
            if ("SourdfFilf".fqubls(bttrNbmf)) {
                sourdfFilf = rfbdUTF8(u + 8, d);
            } flsf if ("InnfrClbssfs".fqubls(bttrNbmf)) {
                innfrClbssfs = u + 8;
            } flsf if ("EndlosingMfthod".fqubls(bttrNbmf)) {
                fndlosingOwnfr = rfbdClbss(u + 8, d);
                int itfm = rfbdUnsignfdShort(u + 10);
                if (itfm != 0) {
                    fndlosingNbmf = rfbdUTF8(itfms[itfm], d);
                    fndlosingDfsd = rfbdUTF8(itfms[itfm] + 2, d);
                }
            } flsf if (SIGNATURES && "Signbturf".fqubls(bttrNbmf)) {
                signbturf = rfbdUTF8(u + 8, d);
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfAnnotbtions".fqubls(bttrNbmf)) {
                bnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                tbnns = u + 8;
            } flsf if ("Dfprfdbtfd".fqubls(bttrNbmf)) {
                bddfss |= Opdodfs.ACC_DEPRECATED;
            } flsf if ("Synthftid".fqubls(bttrNbmf)) {
                bddfss |= Opdodfs.ACC_SYNTHETIC
                        | ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE;
            } flsf if ("SourdfDfbugExtfnsion".fqubls(bttrNbmf)) {
                int lfn = rfbdInt(u + 4);
                sourdfDfbug = rfbdUTF(u + 8, lfn, nfw dhbr[lfn]);
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfAnnotbtions".fqubls(bttrNbmf)) {
                ibnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                itbnns = u + 8;
            } flsf if ("BootstrbpMfthods".fqubls(bttrNbmf)) {
                int[] bootstrbpMfthods = nfw int[rfbdUnsignfdShort(u + 8)];
                for (int j = 0, v = u + 10; j < bootstrbpMfthods.lfngth; j++) {
                    bootstrbpMfthods[j] = v;
                    v += 2 + rfbdUnsignfdShort(v + 2) << 1;
                }
                dontfxt.bootstrbpMfthods = bootstrbpMfthods;
            } flsf {
                Attributf bttr = rfbdAttributf(bttrs, bttrNbmf, u + 8,
                        rfbdInt(u + 4), d, -1, null);
                if (bttr != null) {
                    bttr.nfxt = bttributfs;
                    bttributfs = bttr;
                }
            }
            u += 6 + rfbdInt(u + 4);
        }

        // visits thf dlbss dfdlbrbtion
        dlbssVisitor.visit(rfbdInt(itfms[1] - 7), bddfss, nbmf, signbturf,
                supfrClbss, intfrfbdfs);

        // visits thf sourdf bnd dfbug info
        if ((flbgs & SKIP_DEBUG) == 0
                && (sourdfFilf != null || sourdfDfbug != null)) {
            dlbssVisitor.visitSourdf(sourdfFilf, sourdfDfbug);
        }

        // visits thf outfr dlbss
        if (fndlosingOwnfr != null) {
            dlbssVisitor.visitOutfrClbss(fndlosingOwnfr, fndlosingNbmf,
                    fndlosingDfsd);
        }

        // visits thf dlbss bnnotbtions bnd typf bnnotbtions
        if (ANNOTATIONS && bnns != 0) {
            for (int i = rfbdUnsignfdShort(bnns), v = bnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        dlbssVisitor.visitAnnotbtion(rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && ibnns != 0) {
            for (int i = rfbdUnsignfdShort(ibnns), v = ibnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        dlbssVisitor.visitAnnotbtion(rfbdUTF8(v, d), fblsf));
            }
        }
        if (ANNOTATIONS && tbnns != 0) {
            for (int i = rfbdUnsignfdShort(tbnns), v = tbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        dlbssVisitor.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && itbnns != 0) {
            for (int i = rfbdUnsignfdShort(itbnns), v = itbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        dlbssVisitor.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), fblsf));
            }
        }

        // visits thf bttributfs
        whilf (bttributfs != null) {
            Attributf bttr = bttributfs.nfxt;
            bttributfs.nfxt = null;
            dlbssVisitor.visitAttributf(bttributfs);
            bttributfs = bttr;
        }

        // visits thf innfr dlbssfs
        if (innfrClbssfs != 0) {
            int v = innfrClbssfs + 2;
            for (int i = rfbdUnsignfdShort(innfrClbssfs); i > 0; --i) {
                dlbssVisitor.visitInnfrClbss(rfbdClbss(v, d),
                        rfbdClbss(v + 2, d), rfbdUTF8(v + 4, d),
                        rfbdUnsignfdShort(v + 6));
                v += 8;
            }
        }

        // visits thf fiflds bnd mfthods
        u = hfbdfr + 10 + 2 * intfrfbdfs.lfngth;
        for (int i = rfbdUnsignfdShort(u - 2); i > 0; --i) {
            u = rfbdFifld(dlbssVisitor, dontfxt, u);
        }
        u += 2;
        for (int i = rfbdUnsignfdShort(u - 2); i > 0; --i) {
            u = rfbdMfthod(dlbssVisitor, dontfxt, u);
        }

        // visits thf fnd of thf dlbss
        dlbssVisitor.visitEnd();
    }

    /**
     * Rfbds b fifld bnd mbkfs thf givfn visitor visit it.
     *
     * @pbrbm dlbssVisitor
     *            thf visitor thbt must visit thf fifld.
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd.
     * @pbrbm u
     *            thf stbrt offsft of thf fifld in thf dlbss filf.
     * @rfturn thf offsft of thf first bytf following thf fifld in thf dlbss.
     */
    privbtf int rfbdFifld(finbl ClbssVisitor dlbssVisitor,
            finbl Contfxt dontfxt, int u) {
        // rfbds thf fifld dfdlbrbtion
        dhbr[] d = dontfxt.bufffr;
        int bddfss = rfbdUnsignfdShort(u);
        String nbmf = rfbdUTF8(u + 2, d);
        String dfsd = rfbdUTF8(u + 4, d);
        u += 6;

        // rfbds thf fifld bttributfs
        String signbturf = null;
        int bnns = 0;
        int ibnns = 0;
        int tbnns = 0;
        int itbnns = 0;
        Objfdt vbluf = null;
        Attributf bttributfs = null;

        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            String bttrNbmf = rfbdUTF8(u + 2, d);
            // tfsts brf sortfd in dfdrfbsing frfqufndy ordfr
            // (bbsfd on frfqufndifs obsfrvfd on typidbl dlbssfs)
            if ("ConstbntVbluf".fqubls(bttrNbmf)) {
                int itfm = rfbdUnsignfdShort(u + 8);
                vbluf = itfm == 0 ? null : rfbdConst(itfm, d);
            } flsf if (SIGNATURES && "Signbturf".fqubls(bttrNbmf)) {
                signbturf = rfbdUTF8(u + 8, d);
            } flsf if ("Dfprfdbtfd".fqubls(bttrNbmf)) {
                bddfss |= Opdodfs.ACC_DEPRECATED;
            } flsf if ("Synthftid".fqubls(bttrNbmf)) {
                bddfss |= Opdodfs.ACC_SYNTHETIC
                        | ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfAnnotbtions".fqubls(bttrNbmf)) {
                bnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                tbnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfAnnotbtions".fqubls(bttrNbmf)) {
                ibnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                itbnns = u + 8;
            } flsf {
                Attributf bttr = rfbdAttributf(dontfxt.bttrs, bttrNbmf, u + 8,
                        rfbdInt(u + 4), d, -1, null);
                if (bttr != null) {
                    bttr.nfxt = bttributfs;
                    bttributfs = bttr;
                }
            }
            u += 6 + rfbdInt(u + 4);
        }
        u += 2;

        // visits thf fifld dfdlbrbtion
        FifldVisitor fv = dlbssVisitor.visitFifld(bddfss, nbmf, dfsd,
                signbturf, vbluf);
        if (fv == null) {
            rfturn u;
        }

        // visits thf fifld bnnotbtions bnd typf bnnotbtions
        if (ANNOTATIONS && bnns != 0) {
            for (int i = rfbdUnsignfdShort(bnns), v = bnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        fv.visitAnnotbtion(rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && ibnns != 0) {
            for (int i = rfbdUnsignfdShort(ibnns), v = ibnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        fv.visitAnnotbtion(rfbdUTF8(v, d), fblsf));
            }
        }
        if (ANNOTATIONS && tbnns != 0) {
            for (int i = rfbdUnsignfdShort(tbnns), v = tbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        fv.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && itbnns != 0) {
            for (int i = rfbdUnsignfdShort(itbnns), v = itbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        fv.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), fblsf));
            }
        }

        // visits thf fifld bttributfs
        whilf (bttributfs != null) {
            Attributf bttr = bttributfs.nfxt;
            bttributfs.nfxt = null;
            fv.visitAttributf(bttributfs);
            bttributfs = bttr;
        }

        // visits thf fnd of thf fifld
        fv.visitEnd();

        rfturn u;
    }

    /**
     * Rfbds b mfthod bnd mbkfs thf givfn visitor visit it.
     *
     * @pbrbm dlbssVisitor
     *            thf visitor thbt must visit thf mfthod.
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd.
     * @pbrbm u
     *            thf stbrt offsft of thf mfthod in thf dlbss filf.
     * @rfturn thf offsft of thf first bytf following thf mfthod in thf dlbss.
     */
    privbtf int rfbdMfthod(finbl ClbssVisitor dlbssVisitor,
            finbl Contfxt dontfxt, int u) {
        // rfbds thf mfthod dfdlbrbtion
        dhbr[] d = dontfxt.bufffr;
        dontfxt.bddfss = rfbdUnsignfdShort(u);
        dontfxt.nbmf = rfbdUTF8(u + 2, d);
        dontfxt.dfsd = rfbdUTF8(u + 4, d);
        u += 6;

        // rfbds thf mfthod bttributfs
        int dodf = 0;
        int fxdfption = 0;
        String[] fxdfptions = null;
        String signbturf = null;
        int mfthodPbrbmftfrs = 0;
        int bnns = 0;
        int ibnns = 0;
        int tbnns = 0;
        int itbnns = 0;
        int dbnn = 0;
        int mpbnns = 0;
        int impbnns = 0;
        int firstAttributf = u;
        Attributf bttributfs = null;

        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            String bttrNbmf = rfbdUTF8(u + 2, d);
            // tfsts brf sortfd in dfdrfbsing frfqufndy ordfr
            // (bbsfd on frfqufndifs obsfrvfd on typidbl dlbssfs)
            if ("Codf".fqubls(bttrNbmf)) {
                if ((dontfxt.flbgs & SKIP_CODE) == 0) {
                    dodf = u + 8;
                }
            } flsf if ("Exdfptions".fqubls(bttrNbmf)) {
                fxdfptions = nfw String[rfbdUnsignfdShort(u + 8)];
                fxdfption = u + 10;
                for (int j = 0; j < fxdfptions.lfngth; ++j) {
                    fxdfptions[j] = rfbdClbss(fxdfption, d);
                    fxdfption += 2;
                }
            } flsf if (SIGNATURES && "Signbturf".fqubls(bttrNbmf)) {
                signbturf = rfbdUTF8(u + 8, d);
            } flsf if ("Dfprfdbtfd".fqubls(bttrNbmf)) {
                dontfxt.bddfss |= Opdodfs.ACC_DEPRECATED;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfAnnotbtions".fqubls(bttrNbmf)) {
                bnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                tbnns = u + 8;
            } flsf if (ANNOTATIONS && "AnnotbtionDffbult".fqubls(bttrNbmf)) {
                dbnn = u + 8;
            } flsf if ("Synthftid".fqubls(bttrNbmf)) {
                dontfxt.bddfss |= Opdodfs.ACC_SYNTHETIC
                        | ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfAnnotbtions".fqubls(bttrNbmf)) {
                ibnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                itbnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfPbrbmftfrAnnotbtions".fqubls(bttrNbmf)) {
                mpbnns = u + 8;
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfPbrbmftfrAnnotbtions".fqubls(bttrNbmf)) {
                impbnns = u + 8;
            } flsf if ("MfthodPbrbmftfrs".fqubls(bttrNbmf)) {
                mfthodPbrbmftfrs = u + 8;
            } flsf {
                Attributf bttr = rfbdAttributf(dontfxt.bttrs, bttrNbmf, u + 8,
                        rfbdInt(u + 4), d, -1, null);
                if (bttr != null) {
                    bttr.nfxt = bttributfs;
                    bttributfs = bttr;
                }
            }
            u += 6 + rfbdInt(u + 4);
        }
        u += 2;

        // visits thf mfthod dfdlbrbtion
        MfthodVisitor mv = dlbssVisitor.visitMfthod(dontfxt.bddfss,
                dontfxt.nbmf, dontfxt.dfsd, signbturf, fxdfptions);
        if (mv == null) {
            rfturn u;
        }

        /*
         * if thf rfturnfd MfthodVisitor is in fbdt b MfthodWritfr, it mfbns
         * thfrf is no mfthod bdbptfr bftwffn thf rfbdfr bnd thf writfr. If, in
         * bddition, thf writfr's donstbnt pool wbs dopifd from this rfbdfr
         * (mw.dw.dr == this), bnd thf signbturf bnd fxdfptions of thf mfthod
         * hbvf not bffn dhbngfd, thfn it is possiblf to skip bll visit fvfnts
         * bnd just dopy thf originbl dodf of thf mfthod to thf writfr (thf
         * bddfss, nbmf bnd dfsdriptor dbn hbvf bffn dhbngfd, this is not
         * importbnt sindf thfy brf not dopifd bs is from thf rfbdfr).
         */
        if (WRITER && mv instbndfof MfthodWritfr) {
            MfthodWritfr mw = (MfthodWritfr) mv;
            if (mw.dw.dr == this && signbturf == mw.signbturf) {
                boolfbn sbmfExdfptions = fblsf;
                if (fxdfptions == null) {
                    sbmfExdfptions = mw.fxdfptionCount == 0;
                } flsf if (fxdfptions.lfngth == mw.fxdfptionCount) {
                    sbmfExdfptions = truf;
                    for (int j = fxdfptions.lfngth - 1; j >= 0; --j) {
                        fxdfption -= 2;
                        if (mw.fxdfptions[j] != rfbdUnsignfdShort(fxdfption)) {
                            sbmfExdfptions = fblsf;
                            brfbk;
                        }
                    }
                }
                if (sbmfExdfptions) {
                    /*
                     * wf do not dopy dirfdtly thf dodf into MfthodWritfr to
                     * sbvf b bytf brrby dopy opfrbtion. Thf rfbl dopy will bf
                     * donf in ClbssWritfr.toBytfArrby().
                     */
                    mw.dlbssRfbdfrOffsft = firstAttributf;
                    mw.dlbssRfbdfrLfngth = u - firstAttributf;
                    rfturn u;
                }
            }
        }

        // visit thf mfthod pbrbmftfrs
        if (mfthodPbrbmftfrs != 0) {
            for (int i = b[mfthodPbrbmftfrs] & 0xFF, v = mfthodPbrbmftfrs + 1; i > 0; --i, v = v + 4) {
                mv.visitPbrbmftfr(rfbdUTF8(v, d), rfbdUnsignfdShort(v + 2));
            }
        }

        // visits thf mfthod bnnotbtions
        if (ANNOTATIONS && dbnn != 0) {
            AnnotbtionVisitor dv = mv.visitAnnotbtionDffbult();
            rfbdAnnotbtionVbluf(dbnn, d, null, dv);
            if (dv != null) {
                dv.visitEnd();
            }
        }
        if (ANNOTATIONS && bnns != 0) {
            for (int i = rfbdUnsignfdShort(bnns), v = bnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        mv.visitAnnotbtion(rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && ibnns != 0) {
            for (int i = rfbdUnsignfdShort(ibnns), v = ibnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        mv.visitAnnotbtion(rfbdUTF8(v, d), fblsf));
            }
        }
        if (ANNOTATIONS && tbnns != 0) {
            for (int i = rfbdUnsignfdShort(tbnns), v = tbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        mv.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), truf));
            }
        }
        if (ANNOTATIONS && itbnns != 0) {
            for (int i = rfbdUnsignfdShort(itbnns), v = itbnns + 2; i > 0; --i) {
                v = rfbdAnnotbtionTbrgft(dontfxt, v);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                        mv.visitTypfAnnotbtion(dontfxt.typfRff,
                                dontfxt.typfPbth, rfbdUTF8(v, d), fblsf));
            }
        }
        if (ANNOTATIONS && mpbnns != 0) {
            rfbdPbrbmftfrAnnotbtions(mv, dontfxt, mpbnns, truf);
        }
        if (ANNOTATIONS && impbnns != 0) {
            rfbdPbrbmftfrAnnotbtions(mv, dontfxt, impbnns, fblsf);
        }

        // visits thf mfthod bttributfs
        whilf (bttributfs != null) {
            Attributf bttr = bttributfs.nfxt;
            bttributfs.nfxt = null;
            mv.visitAttributf(bttributfs);
            bttributfs = bttr;
        }

        // visits thf mfthod dodf
        if (dodf != 0) {
            mv.visitCodf();
            rfbdCodf(mv, dontfxt, dodf);
        }

        // visits thf fnd of thf mfthod
        mv.visitEnd();

        rfturn u;
    }

    /**
     * Rfbds thf bytfdodf of b mfthod bnd mbkfs thf givfn visitor visit it.
     *
     * @pbrbm mv
     *            thf visitor thbt must visit thf mfthod's dodf.
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd.
     * @pbrbm u
     *            thf stbrt offsft of thf dodf bttributf in thf dlbss filf.
     */
    privbtf void rfbdCodf(finbl MfthodVisitor mv, finbl Contfxt dontfxt, int u) {
        // rfbds thf hfbdfr
        bytf[] b = this.b;
        dhbr[] d = dontfxt.bufffr;
        int mbxStbdk = rfbdUnsignfdShort(u);
        int mbxLodbls = rfbdUnsignfdShort(u + 2);
        int dodfLfngth = rfbdInt(u + 4);
        u += 8;

        // rfbds thf bytfdodf to find thf lbbfls
        int dodfStbrt = u;
        int dodfEnd = u + dodfLfngth;
        Lbbfl[] lbbfls = dontfxt.lbbfls = nfw Lbbfl[dodfLfngth + 2];
        rfbdLbbfl(dodfLfngth + 1, lbbfls);
        whilf (u < dodfEnd) {
            int offsft = u - dodfStbrt;
            int opdodf = b[u] & 0xFF;
            switdh (ClbssWritfr.TYPE[opdodf]) {
            dbsf ClbssWritfr.NOARG_INSN:
            dbsf ClbssWritfr.IMPLVAR_INSN:
                u += 1;
                brfbk;
            dbsf ClbssWritfr.LABEL_INSN:
                rfbdLbbfl(offsft + rfbdShort(u + 1), lbbfls);
                u += 3;
                brfbk;
            dbsf ClbssWritfr.LABELW_INSN:
                rfbdLbbfl(offsft + rfbdInt(u + 1), lbbfls);
                u += 5;
                brfbk;
            dbsf ClbssWritfr.WIDE_INSN:
                opdodf = b[u + 1] & 0xFF;
                if (opdodf == Opdodfs.IINC) {
                    u += 6;
                } flsf {
                    u += 4;
                }
                brfbk;
            dbsf ClbssWritfr.TABL_INSN:
                // skips 0 to 3 pbdding bytfs
                u = u + 4 - (offsft & 3);
                // rfbds instrudtion
                rfbdLbbfl(offsft + rfbdInt(u), lbbfls);
                for (int i = rfbdInt(u + 8) - rfbdInt(u + 4) + 1; i > 0; --i) {
                    rfbdLbbfl(offsft + rfbdInt(u + 12), lbbfls);
                    u += 4;
                }
                u += 12;
                brfbk;
            dbsf ClbssWritfr.LOOK_INSN:
                // skips 0 to 3 pbdding bytfs
                u = u + 4 - (offsft & 3);
                // rfbds instrudtion
                rfbdLbbfl(offsft + rfbdInt(u), lbbfls);
                for (int i = rfbdInt(u + 4); i > 0; --i) {
                    rfbdLbbfl(offsft + rfbdInt(u + 12), lbbfls);
                    u += 8;
                }
                u += 8;
                brfbk;
            dbsf ClbssWritfr.VAR_INSN:
            dbsf ClbssWritfr.SBYTE_INSN:
            dbsf ClbssWritfr.LDC_INSN:
                u += 2;
                brfbk;
            dbsf ClbssWritfr.SHORT_INSN:
            dbsf ClbssWritfr.LDCW_INSN:
            dbsf ClbssWritfr.FIELDORMETH_INSN:
            dbsf ClbssWritfr.TYPE_INSN:
            dbsf ClbssWritfr.IINC_INSN:
                u += 3;
                brfbk;
            dbsf ClbssWritfr.ITFMETH_INSN:
            dbsf ClbssWritfr.INDYMETH_INSN:
                u += 5;
                brfbk;
            // dbsf MANA_INSN:
            dffbult:
                u += 4;
                brfbk;
            }
        }

        // rfbds thf try dbtdh fntrifs to find thf lbbfls, bnd blso visits thfm
        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            Lbbfl stbrt = rfbdLbbfl(rfbdUnsignfdShort(u + 2), lbbfls);
            Lbbfl fnd = rfbdLbbfl(rfbdUnsignfdShort(u + 4), lbbfls);
            Lbbfl hbndlfr = rfbdLbbfl(rfbdUnsignfdShort(u + 6), lbbfls);
            String typf = rfbdUTF8(itfms[rfbdUnsignfdShort(u + 8)], d);
            mv.visitTryCbtdhBlodk(stbrt, fnd, hbndlfr, typf);
            u += 8;
        }
        u += 2;

        // rfbds thf dodf bttributfs
        int[] tbnns = null; // stbrt indfx of fbdh visiblf typf bnnotbtion
        int[] itbnns = null; // stbrt indfx of fbdh invisiblf typf bnnotbtion
        int tbnn = 0; // durrfnt indfx in tbnns brrby
        int itbnn = 0; // durrfnt indfx in itbnns brrby
        int ntoff = -1; // nfxt visiblf typf bnnotbtion dodf offsft
        int nitoff = -1; // nfxt invisiblf typf bnnotbtion dodf offsft
        int vbrTbblf = 0;
        int vbrTypfTbblf = 0;
        boolfbn zip = truf;
        boolfbn unzip = (dontfxt.flbgs & EXPAND_FRAMES) != 0;
        int stbdkMbp = 0;
        int stbdkMbpSizf = 0;
        int frbmfCount = 0;
        Contfxt frbmf = null;
        Attributf bttributfs = null;

        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            String bttrNbmf = rfbdUTF8(u + 2, d);
            if ("LodblVbribblfTbblf".fqubls(bttrNbmf)) {
                if ((dontfxt.flbgs & SKIP_DEBUG) == 0) {
                    vbrTbblf = u + 8;
                    for (int j = rfbdUnsignfdShort(u + 8), v = u; j > 0; --j) {
                        int lbbfl = rfbdUnsignfdShort(v + 10);
                        if (lbbfls[lbbfl] == null) {
                            rfbdLbbfl(lbbfl, lbbfls).stbtus |= Lbbfl.DEBUG;
                        }
                        lbbfl += rfbdUnsignfdShort(v + 12);
                        if (lbbfls[lbbfl] == null) {
                            rfbdLbbfl(lbbfl, lbbfls).stbtus |= Lbbfl.DEBUG;
                        }
                        v += 10;
                    }
                }
            } flsf if ("LodblVbribblfTypfTbblf".fqubls(bttrNbmf)) {
                vbrTypfTbblf = u + 8;
            } flsf if ("LinfNumbfrTbblf".fqubls(bttrNbmf)) {
                if ((dontfxt.flbgs & SKIP_DEBUG) == 0) {
                    for (int j = rfbdUnsignfdShort(u + 8), v = u; j > 0; --j) {
                        int lbbfl = rfbdUnsignfdShort(v + 10);
                        if (lbbfls[lbbfl] == null) {
                            rfbdLbbfl(lbbfl, lbbfls).stbtus |= Lbbfl.DEBUG;
                        }
                        lbbfls[lbbfl].linf = rfbdUnsignfdShort(v + 12);
                        v += 4;
                    }
                }
            } flsf if (ANNOTATIONS
                    && "RuntimfVisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                tbnns = rfbdTypfAnnotbtions(mv, dontfxt, u + 8, truf);
                ntoff = tbnns.lfngth == 0 || rfbdBytf(tbnns[0]) < 0x43 ? -1
                        : rfbdUnsignfdShort(tbnns[0] + 1);
            } flsf if (ANNOTATIONS
                    && "RuntimfInvisiblfTypfAnnotbtions".fqubls(bttrNbmf)) {
                itbnns = rfbdTypfAnnotbtions(mv, dontfxt, u + 8, fblsf);
                nitoff = itbnns.lfngth == 0 || rfbdBytf(itbnns[0]) < 0x43 ? -1
                        : rfbdUnsignfdShort(itbnns[0] + 1);
            } flsf if (FRAMES && "StbdkMbpTbblf".fqubls(bttrNbmf)) {
                if ((dontfxt.flbgs & SKIP_FRAMES) == 0) {
                    stbdkMbp = u + 10;
                    stbdkMbpSizf = rfbdInt(u + 4);
                    frbmfCount = rfbdUnsignfdShort(u + 8);
                }
                /*
                 * hfrf wf do not fxtrbdt thf lbbfls dorrfsponding to thf
                 * bttributf dontfnt. This would rfquirf b full pbrsing of thf
                 * bttributf, whidh would nffd to bf rfpfbtfd in thf sfdond
                 * phbsf (sff bflow). Instfbd thf dontfnt of thf bttributf is
                 * rfbd onf frbmf bt b timf (i.f. bftfr b frbmf hbs bffn
                 * visitfd, thf nfxt frbmf is rfbd), bnd thf lbbfls it dontbins
                 * brf blso fxtrbdtfd onf frbmf bt b timf. Thbnks to thf
                 * ordfring of frbmfs, hbving only b "onf frbmf lookbhfbd" is
                 * not b problfm, i.f. it is not possiblf to sff bn offsft
                 * smbllfr thbn thf offsft of thf durrfnt insn bnd for whidh no
                 * Lbbfl fxist.
                 */
                /*
                 * This is not truf for UNINITIALIZED typf offsfts. Wf solvf
                 * this by pbrsing thf stbdk mbp tbblf without b full dfdoding
                 * (sff bflow).
                 */
            } flsf if (FRAMES && "StbdkMbp".fqubls(bttrNbmf)) {
                if ((dontfxt.flbgs & SKIP_FRAMES) == 0) {
                    zip = fblsf;
                    stbdkMbp = u + 10;
                    stbdkMbpSizf = rfbdInt(u + 4);
                    frbmfCount = rfbdUnsignfdShort(u + 8);
                }
                /*
                 * IMPORTANT! hfrf wf bssumf thbt thf frbmfs brf ordfrfd, bs in
                 * thf StbdkMbpTbblf bttributf, blthough this is not gubrbntffd
                 * by thf bttributf formbt.
                 */
            } flsf {
                for (int j = 0; j < dontfxt.bttrs.lfngth; ++j) {
                    if (dontfxt.bttrs[j].typf.fqubls(bttrNbmf)) {
                        Attributf bttr = dontfxt.bttrs[j].rfbd(this, u + 8,
                                rfbdInt(u + 4), d, dodfStbrt - 8, lbbfls);
                        if (bttr != null) {
                            bttr.nfxt = bttributfs;
                            bttributfs = bttr;
                        }
                    }
                }
            }
            u += 6 + rfbdInt(u + 4);
        }
        u += 2;

        // gfnfrbtfs thf first (implidit) stbdk mbp frbmf
        if (FRAMES && stbdkMbp != 0) {
            /*
             * for thf first fxplidit frbmf thf offsft is not offsft_dfltb + 1
             * but only offsft_dfltb; sftting thf implidit frbmf offsft to -1
             * bllow thf usf of thf "offsft_dfltb + 1" rulf in bll dbsfs
             */
            frbmf = dontfxt;
            frbmf.offsft = -1;
            frbmf.modf = 0;
            frbmf.lodblCount = 0;
            frbmf.lodblDiff = 0;
            frbmf.stbdkCount = 0;
            frbmf.lodbl = nfw Objfdt[mbxLodbls];
            frbmf.stbdk = nfw Objfdt[mbxStbdk];
            if (unzip) {
                gftImpliditFrbmf(dontfxt);
            }
            /*
             * Finds lbbfls for UNINITIALIZED frbmf typfs. Instfbd of dfdoding
             * fbdh flfmfnt of thf stbdk mbp tbblf, wf look for 3 donsfdutivf
             * bytfs thbt "look likf" bn UNINITIALIZED typf (tbg 8, offsft
             * within dodf bounds, NEW instrudtion bt this offsft). Wf mby find
             * fblsf positivfs (i.f. not rfbl UNINITIALIZED typfs), but this
             * should bf rbrf, bnd thf only donsfqufndf will bf thf drfbtion of
             * bn unnffdfd lbbfl. This is bfttfr thbn drfbting b lbbfl for fbdh
             * NEW instrudtion, bnd fbstfr thbn fully dfdoding thf wholf stbdk
             * mbp tbblf.
             */
            for (int i = stbdkMbp; i < stbdkMbp + stbdkMbpSizf - 2; ++i) {
                if (b[i] == 8) { // UNINITIALIZED FRAME TYPE
                    int v = rfbdUnsignfdShort(i + 1);
                    if (v >= 0 && v < dodfLfngth) {
                        if ((b[dodfStbrt + v] & 0xFF) == Opdodfs.NEW) {
                            rfbdLbbfl(v, lbbfls);
                        }
                    }
                }
            }
        }

        // visits thf instrudtions
        u = dodfStbrt;
        whilf (u < dodfEnd) {
            int offsft = u - dodfStbrt;

            // visits thf lbbfl bnd linf numbfr for this offsft, if bny
            Lbbfl l = lbbfls[offsft];
            if (l != null) {
                mv.visitLbbfl(l);
                if ((dontfxt.flbgs & SKIP_DEBUG) == 0 && l.linf > 0) {
                    mv.visitLinfNumbfr(l.linf, l);
                }
            }

            // visits thf frbmf for this offsft, if bny
            whilf (FRAMES && frbmf != null
                    && (frbmf.offsft == offsft || frbmf.offsft == -1)) {
                // if thfrf is b frbmf for this offsft, mbkfs thf visitor visit
                // it, bnd rfbds thf nfxt frbmf if thfrf is onf.
                if (frbmf.offsft != -1) {
                    if (!zip || unzip) {
                        mv.visitFrbmf(Opdodfs.F_NEW, frbmf.lodblCount,
                                frbmf.lodbl, frbmf.stbdkCount, frbmf.stbdk);
                    } flsf {
                        mv.visitFrbmf(frbmf.modf, frbmf.lodblDiff, frbmf.lodbl,
                                frbmf.stbdkCount, frbmf.stbdk);
                    }
                }
                if (frbmfCount > 0) {
                    stbdkMbp = rfbdFrbmf(stbdkMbp, zip, unzip, frbmf);
                    --frbmfCount;
                } flsf {
                    frbmf = null;
                }
            }

            // visits thf instrudtion bt this offsft
            int opdodf = b[u] & 0xFF;
            switdh (ClbssWritfr.TYPE[opdodf]) {
            dbsf ClbssWritfr.NOARG_INSN:
                mv.visitInsn(opdodf);
                u += 1;
                brfbk;
            dbsf ClbssWritfr.IMPLVAR_INSN:
                if (opdodf > Opdodfs.ISTORE) {
                    opdodf -= 59; // ISTORE_0
                    mv.visitVbrInsn(Opdodfs.ISTORE + (opdodf >> 2),
                            opdodf & 0x3);
                } flsf {
                    opdodf -= 26; // ILOAD_0
                    mv.visitVbrInsn(Opdodfs.ILOAD + (opdodf >> 2), opdodf & 0x3);
                }
                u += 1;
                brfbk;
            dbsf ClbssWritfr.LABEL_INSN:
                mv.visitJumpInsn(opdodf, lbbfls[offsft + rfbdShort(u + 1)]);
                u += 3;
                brfbk;
            dbsf ClbssWritfr.LABELW_INSN:
                mv.visitJumpInsn(opdodf - 33, lbbfls[offsft + rfbdInt(u + 1)]);
                u += 5;
                brfbk;
            dbsf ClbssWritfr.WIDE_INSN:
                opdodf = b[u + 1] & 0xFF;
                if (opdodf == Opdodfs.IINC) {
                    mv.visitIindInsn(rfbdUnsignfdShort(u + 2), rfbdShort(u + 4));
                    u += 6;
                } flsf {
                    mv.visitVbrInsn(opdodf, rfbdUnsignfdShort(u + 2));
                    u += 4;
                }
                brfbk;
            dbsf ClbssWritfr.TABL_INSN: {
                // skips 0 to 3 pbdding bytfs
                u = u + 4 - (offsft & 3);
                // rfbds instrudtion
                int lbbfl = offsft + rfbdInt(u);
                int min = rfbdInt(u + 4);
                int mbx = rfbdInt(u + 8);
                Lbbfl[] tbblf = nfw Lbbfl[mbx - min + 1];
                u += 12;
                for (int i = 0; i < tbblf.lfngth; ++i) {
                    tbblf[i] = lbbfls[offsft + rfbdInt(u)];
                    u += 4;
                }
                mv.visitTbblfSwitdhInsn(min, mbx, lbbfls[lbbfl], tbblf);
                brfbk;
            }
            dbsf ClbssWritfr.LOOK_INSN: {
                // skips 0 to 3 pbdding bytfs
                u = u + 4 - (offsft & 3);
                // rfbds instrudtion
                int lbbfl = offsft + rfbdInt(u);
                int lfn = rfbdInt(u + 4);
                int[] kfys = nfw int[lfn];
                Lbbfl[] vblufs = nfw Lbbfl[lfn];
                u += 8;
                for (int i = 0; i < lfn; ++i) {
                    kfys[i] = rfbdInt(u);
                    vblufs[i] = lbbfls[offsft + rfbdInt(u + 4)];
                    u += 8;
                }
                mv.visitLookupSwitdhInsn(lbbfls[lbbfl], kfys, vblufs);
                brfbk;
            }
            dbsf ClbssWritfr.VAR_INSN:
                mv.visitVbrInsn(opdodf, b[u + 1] & 0xFF);
                u += 2;
                brfbk;
            dbsf ClbssWritfr.SBYTE_INSN:
                mv.visitIntInsn(opdodf, b[u + 1]);
                u += 2;
                brfbk;
            dbsf ClbssWritfr.SHORT_INSN:
                mv.visitIntInsn(opdodf, rfbdShort(u + 1));
                u += 3;
                brfbk;
            dbsf ClbssWritfr.LDC_INSN:
                mv.visitLddInsn(rfbdConst(b[u + 1] & 0xFF, d));
                u += 2;
                brfbk;
            dbsf ClbssWritfr.LDCW_INSN:
                mv.visitLddInsn(rfbdConst(rfbdUnsignfdShort(u + 1), d));
                u += 3;
                brfbk;
            dbsf ClbssWritfr.FIELDORMETH_INSN:
            dbsf ClbssWritfr.ITFMETH_INSN: {
                int dpIndfx = itfms[rfbdUnsignfdShort(u + 1)];
                boolfbn itf = b[dpIndfx - 1] == ClbssWritfr.IMETH;
                String iownfr = rfbdClbss(dpIndfx, d);
                dpIndfx = itfms[rfbdUnsignfdShort(dpIndfx + 2)];
                String inbmf = rfbdUTF8(dpIndfx, d);
                String idfsd = rfbdUTF8(dpIndfx + 2, d);
                if (opdodf < Opdodfs.INVOKEVIRTUAL) {
                    mv.visitFifldInsn(opdodf, iownfr, inbmf, idfsd);
                } flsf {
                    mv.visitMfthodInsn(opdodf, iownfr, inbmf, idfsd, itf);
                }
                if (opdodf == Opdodfs.INVOKEINTERFACE) {
                    u += 5;
                } flsf {
                    u += 3;
                }
                brfbk;
            }
            dbsf ClbssWritfr.INDYMETH_INSN: {
                int dpIndfx = itfms[rfbdUnsignfdShort(u + 1)];
                int bsmIndfx = dontfxt.bootstrbpMfthods[rfbdUnsignfdShort(dpIndfx)];
                Hbndlf bsm = (Hbndlf) rfbdConst(rfbdUnsignfdShort(bsmIndfx), d);
                int bsmArgCount = rfbdUnsignfdShort(bsmIndfx + 2);
                Objfdt[] bsmArgs = nfw Objfdt[bsmArgCount];
                bsmIndfx += 4;
                for (int i = 0; i < bsmArgCount; i++) {
                    bsmArgs[i] = rfbdConst(rfbdUnsignfdShort(bsmIndfx), d);
                    bsmIndfx += 2;
                }
                dpIndfx = itfms[rfbdUnsignfdShort(dpIndfx + 2)];
                String inbmf = rfbdUTF8(dpIndfx, d);
                String idfsd = rfbdUTF8(dpIndfx + 2, d);
                mv.visitInvokfDynbmidInsn(inbmf, idfsd, bsm, bsmArgs);
                u += 5;
                brfbk;
            }
            dbsf ClbssWritfr.TYPE_INSN:
                mv.visitTypfInsn(opdodf, rfbdClbss(u + 1, d));
                u += 3;
                brfbk;
            dbsf ClbssWritfr.IINC_INSN:
                mv.visitIindInsn(b[u + 1] & 0xFF, b[u + 2]);
                u += 3;
                brfbk;
            // dbsf MANA_INSN:
            dffbult:
                mv.visitMultiANfwArrbyInsn(rfbdClbss(u + 1, d), b[u + 3] & 0xFF);
                u += 4;
                brfbk;
            }

            // visit thf instrudtion bnnotbtions, if bny
            whilf (tbnns != null && tbnn < tbnns.lfngth && ntoff <= offsft) {
                if (ntoff == offsft) {
                    int v = rfbdAnnotbtionTbrgft(dontfxt, tbnns[tbnn]);
                    rfbdAnnotbtionVblufs(v + 2, d, truf,
                            mv.visitInsnAnnotbtion(dontfxt.typfRff,
                                    dontfxt.typfPbth, rfbdUTF8(v, d), truf));
                }
                ntoff = ++tbnn >= tbnns.lfngth || rfbdBytf(tbnns[tbnn]) < 0x43 ? -1
                        : rfbdUnsignfdShort(tbnns[tbnn] + 1);
            }
            whilf (itbnns != null && itbnn < itbnns.lfngth && nitoff <= offsft) {
                if (nitoff == offsft) {
                    int v = rfbdAnnotbtionTbrgft(dontfxt, itbnns[itbnn]);
                    rfbdAnnotbtionVblufs(v + 2, d, truf,
                            mv.visitInsnAnnotbtion(dontfxt.typfRff,
                                    dontfxt.typfPbth, rfbdUTF8(v, d), fblsf));
                }
                nitoff = ++itbnn >= itbnns.lfngth
                        || rfbdBytf(itbnns[itbnn]) < 0x43 ? -1
                        : rfbdUnsignfdShort(itbnns[itbnn] + 1);
            }
        }
        if (lbbfls[dodfLfngth] != null) {
            mv.visitLbbfl(lbbfls[dodfLfngth]);
        }

        // visits thf lodbl vbribblf tbblfs
        if ((dontfxt.flbgs & SKIP_DEBUG) == 0 && vbrTbblf != 0) {
            int[] typfTbblf = null;
            if (vbrTypfTbblf != 0) {
                u = vbrTypfTbblf + 2;
                typfTbblf = nfw int[rfbdUnsignfdShort(vbrTypfTbblf) * 3];
                for (int i = typfTbblf.lfngth; i > 0;) {
                    typfTbblf[--i] = u + 6; // signbturf
                    typfTbblf[--i] = rfbdUnsignfdShort(u + 8); // indfx
                    typfTbblf[--i] = rfbdUnsignfdShort(u); // stbrt
                    u += 10;
                }
            }
            u = vbrTbblf + 2;
            for (int i = rfbdUnsignfdShort(vbrTbblf); i > 0; --i) {
                int stbrt = rfbdUnsignfdShort(u);
                int lfngth = rfbdUnsignfdShort(u + 2);
                int indfx = rfbdUnsignfdShort(u + 8);
                String vsignbturf = null;
                if (typfTbblf != null) {
                    for (int j = 0; j < typfTbblf.lfngth; j += 3) {
                        if (typfTbblf[j] == stbrt && typfTbblf[j + 1] == indfx) {
                            vsignbturf = rfbdUTF8(typfTbblf[j + 2], d);
                            brfbk;
                        }
                    }
                }
                mv.visitLodblVbribblf(rfbdUTF8(u + 4, d), rfbdUTF8(u + 6, d),
                        vsignbturf, lbbfls[stbrt], lbbfls[stbrt + lfngth],
                        indfx);
                u += 10;
            }
        }

        // visits thf lodbl vbribblfs typf bnnotbtions
        if (tbnns != null) {
            for (int i = 0; i < tbnns.lfngth; ++i) {
                if ((rfbdBytf(tbnns[i]) >> 1) == (0x40 >> 1)) {
                    int v = rfbdAnnotbtionTbrgft(dontfxt, tbnns[i]);
                    v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                            mv.visitLodblVbribblfAnnotbtion(dontfxt.typfRff,
                                    dontfxt.typfPbth, dontfxt.stbrt,
                                    dontfxt.fnd, dontfxt.indfx, rfbdUTF8(v, d),
                                    truf));
                }
            }
        }
        if (itbnns != null) {
            for (int i = 0; i < itbnns.lfngth; ++i) {
                if ((rfbdBytf(itbnns[i]) >> 1) == (0x40 >> 1)) {
                    int v = rfbdAnnotbtionTbrgft(dontfxt, itbnns[i]);
                    v = rfbdAnnotbtionVblufs(v + 2, d, truf,
                            mv.visitLodblVbribblfAnnotbtion(dontfxt.typfRff,
                                    dontfxt.typfPbth, dontfxt.stbrt,
                                    dontfxt.fnd, dontfxt.indfx, rfbdUTF8(v, d),
                                    fblsf));
                }
            }
        }

        // visits thf dodf bttributfs
        whilf (bttributfs != null) {
            Attributf bttr = bttributfs.nfxt;
            bttributfs.nfxt = null;
            mv.visitAttributf(bttributfs);
            bttributfs = bttr;
        }

        // visits thf mbx stbdk bnd mbx lodbls vblufs
        mv.visitMbxs(mbxStbdk, mbxLodbls);
    }

    /**
     * Pbrsfs b typf bnnotbtion tbblf to find thf lbbfls, bnd to visit thf try
     * dbtdh blodk bnnotbtions.
     *
     * @pbrbm u
     *            thf stbrt offsft of b typf bnnotbtion tbblf.
     * @pbrbm mv
     *            thf mfthod visitor to bf usfd to visit thf try dbtdh blodk
     *            bnnotbtions.
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd.
     * @pbrbm visiblf
     *            if thf typf bnnotbtion tbblf to pbrsf dontbins runtimf visiblf
     *            bnnotbtions.
     * @rfturn thf stbrt offsft of fbdh typf bnnotbtion in thf pbrsfd tbblf.
     */
    privbtf int[] rfbdTypfAnnotbtions(finbl MfthodVisitor mv,
            finbl Contfxt dontfxt, int u, boolfbn visiblf) {
        dhbr[] d = dontfxt.bufffr;
        int[] offsfts = nfw int[rfbdUnsignfdShort(u)];
        u += 2;
        for (int i = 0; i < offsfts.lfngth; ++i) {
            offsfts[i] = u;
            int tbrgft = rfbdInt(u);
            switdh (tbrgft >>> 24) {
            dbsf 0x00: // CLASS_TYPE_PARAMETER
            dbsf 0x01: // METHOD_TYPE_PARAMETER
            dbsf 0x16: // METHOD_FORMAL_PARAMETER
                u += 2;
                brfbk;
            dbsf 0x13: // FIELD
            dbsf 0x14: // METHOD_RETURN
            dbsf 0x15: // METHOD_RECEIVER
                u += 1;
                brfbk;
            dbsf 0x40: // LOCAL_VARIABLE
            dbsf 0x41: // RESOURCE_VARIABLE
                for (int j = rfbdUnsignfdShort(u + 1); j > 0; --j) {
                    int stbrt = rfbdUnsignfdShort(u + 3);
                    int lfngth = rfbdUnsignfdShort(u + 5);
                    rfbdLbbfl(stbrt, dontfxt.lbbfls);
                    rfbdLbbfl(stbrt + lfngth, dontfxt.lbbfls);
                    u += 6;
                }
                u += 3;
                brfbk;
            dbsf 0x47: // CAST
            dbsf 0x48: // CONSTRUCTOR_INVOCATION_TYPE_ARGUMENT
            dbsf 0x49: // METHOD_INVOCATION_TYPE_ARGUMENT
            dbsf 0x4A: // CONSTRUCTOR_REFERENCE_TYPE_ARGUMENT
            dbsf 0x4B: // METHOD_REFERENCE_TYPE_ARGUMENT
                u += 4;
                brfbk;
            // dbsf 0x10: // CLASS_EXTENDS
            // dbsf 0x11: // CLASS_TYPE_PARAMETER_BOUND
            // dbsf 0x12: // METHOD_TYPE_PARAMETER_BOUND
            // dbsf 0x17: // THROWS
            // dbsf 0x42: // EXCEPTION_PARAMETER
            // dbsf 0x43: // INSTANCEOF
            // dbsf 0x44: // NEW
            // dbsf 0x45: // CONSTRUCTOR_REFERENCE
            // dbsf 0x46: // METHOD_REFERENCE
            dffbult:
                u += 3;
                brfbk;
            }
            int pbthLfngth = rfbdBytf(u);
            if ((tbrgft >>> 24) == 0x42) {
                TypfPbth pbth = pbthLfngth == 0 ? null : nfw TypfPbth(b, u);
                u += 1 + 2 * pbthLfngth;
                u = rfbdAnnotbtionVblufs(u + 2, d, truf,
                        mv.visitTryCbtdhAnnotbtion(tbrgft, pbth,
                                rfbdUTF8(u, d), visiblf));
            } flsf {
                u = rfbdAnnotbtionVblufs(u + 3 + 2 * pbthLfngth, d, truf, null);
            }
        }
        rfturn offsfts;
    }

    /**
     * Pbrsfs thf hfbdfr of b typf bnnotbtion to fxtrbdt its tbrgft_typf bnd
     * tbrgft_pbth (thf rfsult is storfd in thf givfn dontfxt), bnd rfturns thf
     * stbrt offsft of thf rfst of thf typf_bnnotbtion strudturf (i.f. thf
     * offsft to thf typf_indfx fifld, whidh is followfd by
     * num_flfmfnt_vbluf_pbirs bnd thfn thf nbmf,vbluf pbirs).
     *
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd. This is whfrf thf
     *            fxtrbdtfd tbrgft_typf bnd tbrgft_pbth must bf storfd.
     * @pbrbm u
     *            thf stbrt offsft of b typf_bnnotbtion strudturf.
     * @rfturn thf stbrt offsft of thf rfst of thf typf_bnnotbtion strudturf.
     */
    privbtf int rfbdAnnotbtionTbrgft(finbl Contfxt dontfxt, int u) {
        int tbrgft = rfbdInt(u);
        switdh (tbrgft >>> 24) {
        dbsf 0x00: // CLASS_TYPE_PARAMETER
        dbsf 0x01: // METHOD_TYPE_PARAMETER
        dbsf 0x16: // METHOD_FORMAL_PARAMETER
            tbrgft &= 0xFFFF0000;
            u += 2;
            brfbk;
        dbsf 0x13: // FIELD
        dbsf 0x14: // METHOD_RETURN
        dbsf 0x15: // METHOD_RECEIVER
            tbrgft &= 0xFF000000;
            u += 1;
            brfbk;
        dbsf 0x40: // LOCAL_VARIABLE
        dbsf 0x41: { // RESOURCE_VARIABLE
            tbrgft &= 0xFF000000;
            int n = rfbdUnsignfdShort(u + 1);
            dontfxt.stbrt = nfw Lbbfl[n];
            dontfxt.fnd = nfw Lbbfl[n];
            dontfxt.indfx = nfw int[n];
            u += 3;
            for (int i = 0; i < n; ++i) {
                int stbrt = rfbdUnsignfdShort(u);
                int lfngth = rfbdUnsignfdShort(u + 2);
                dontfxt.stbrt[i] = rfbdLbbfl(stbrt, dontfxt.lbbfls);
                dontfxt.fnd[i] = rfbdLbbfl(stbrt + lfngth, dontfxt.lbbfls);
                dontfxt.indfx[i] = rfbdUnsignfdShort(u + 4);
                u += 6;
            }
            brfbk;
        }
        dbsf 0x47: // CAST
        dbsf 0x48: // CONSTRUCTOR_INVOCATION_TYPE_ARGUMENT
        dbsf 0x49: // METHOD_INVOCATION_TYPE_ARGUMENT
        dbsf 0x4A: // CONSTRUCTOR_REFERENCE_TYPE_ARGUMENT
        dbsf 0x4B: // METHOD_REFERENCE_TYPE_ARGUMENT
            tbrgft &= 0xFF0000FF;
            u += 4;
            brfbk;
        // dbsf 0x10: // CLASS_EXTENDS
        // dbsf 0x11: // CLASS_TYPE_PARAMETER_BOUND
        // dbsf 0x12: // METHOD_TYPE_PARAMETER_BOUND
        // dbsf 0x17: // THROWS
        // dbsf 0x42: // EXCEPTION_PARAMETER
        // dbsf 0x43: // INSTANCEOF
        // dbsf 0x44: // NEW
        // dbsf 0x45: // CONSTRUCTOR_REFERENCE
        // dbsf 0x46: // METHOD_REFERENCE
        dffbult:
            tbrgft &= (tbrgft >>> 24) < 0x43 ? 0xFFFFFF00 : 0xFF000000;
            u += 3;
            brfbk;
        }
        int pbthLfngth = rfbdBytf(u);
        dontfxt.typfRff = tbrgft;
        dontfxt.typfPbth = pbthLfngth == 0 ? null : nfw TypfPbth(b, u);
        rfturn u + 1 + 2 * pbthLfngth;
    }

    /**
     * Rfbds pbrbmftfr bnnotbtions bnd mbkfs thf givfn visitor visit thfm.
     *
     * @pbrbm mv
     *            thf visitor thbt must visit thf bnnotbtions.
     * @pbrbm dontfxt
     *            informbtion bbout thf dlbss bfing pbrsfd.
     * @pbrbm v
     *            stbrt offsft in {@link #b b} of thf bnnotbtions to bf rfbd.
     * @pbrbm visiblf
     *            <tt>truf</tt> if thf bnnotbtions to bf rfbd brf visiblf bt
     *            runtimf.
     */
    privbtf void rfbdPbrbmftfrAnnotbtions(finbl MfthodVisitor mv,
            finbl Contfxt dontfxt, int v, finbl boolfbn visiblf) {
        int i;
        int n = b[v++] & 0xFF;
        // workbround for b bug in jbvbd (jbvbd dompilfr gfnfrbtfs b pbrbmftfr
        // bnnotbtion brrby whosf sizf is fqubl to thf numbfr of pbrbmftfrs in
        // thf Jbvb sourdf filf, whilf it should gfnfrbtf bn brrby whosf sizf is
        // fqubl to thf numbfr of pbrbmftfrs in thf mfthod dfsdriptor - whidh
        // indludfs thf synthftid pbrbmftfrs bddfd by thf dompilfr). This work-
        // bround supposfs thbt thf synthftid pbrbmftfrs brf thf first onfs.
        int synthftids = Typf.gftArgumfntTypfs(dontfxt.dfsd).lfngth - n;
        AnnotbtionVisitor bv;
        for (i = 0; i < synthftids; ++i) {
            // virtubl bnnotbtion to dftfdt synthftid pbrbmftfrs in MfthodWritfr
            bv = mv.visitPbrbmftfrAnnotbtion(i, "Ljbvb/lbng/Synthftid;", fblsf);
            if (bv != null) {
                bv.visitEnd();
            }
        }
        dhbr[] d = dontfxt.bufffr;
        for (; i < n + synthftids; ++i) {
            int j = rfbdUnsignfdShort(v);
            v += 2;
            for (; j > 0; --j) {
                bv = mv.visitPbrbmftfrAnnotbtion(i, rfbdUTF8(v, d), visiblf);
                v = rfbdAnnotbtionVblufs(v + 2, d, truf, bv);
            }
        }
    }

    /**
     * Rfbds thf vblufs of bn bnnotbtion bnd mbkfs thf givfn visitor visit thfm.
     *
     * @pbrbm v
     *            thf stbrt offsft in {@link #b b} of thf vblufs to bf rfbd
     *            (indluding thf unsignfd short thbt givfs thf numbfr of
     *            vblufs).
     * @pbrbm buf
     *            bufffr to bf usfd to dbll {@link #rfbdUTF8 rfbdUTF8},
     *            {@link #rfbdClbss(int,dhbr[]) rfbdClbss} or {@link #rfbdConst
     *            rfbdConst}.
     * @pbrbm nbmfd
     *            if thf bnnotbtion vblufs brf nbmfd or not.
     * @pbrbm bv
     *            thf visitor thbt must visit thf vblufs.
     * @rfturn thf fnd offsft of thf bnnotbtion vblufs.
     */
    privbtf int rfbdAnnotbtionVblufs(int v, finbl dhbr[] buf,
            finbl boolfbn nbmfd, finbl AnnotbtionVisitor bv) {
        int i = rfbdUnsignfdShort(v);
        v += 2;
        if (nbmfd) {
            for (; i > 0; --i) {
                v = rfbdAnnotbtionVbluf(v + 2, buf, rfbdUTF8(v, buf), bv);
            }
        } flsf {
            for (; i > 0; --i) {
                v = rfbdAnnotbtionVbluf(v, buf, null, bv);
            }
        }
        if (bv != null) {
            bv.visitEnd();
        }
        rfturn v;
    }

    /**
     * Rfbds b vbluf of bn bnnotbtion bnd mbkfs thf givfn visitor visit it.
     *
     * @pbrbm v
     *            thf stbrt offsft in {@link #b b} of thf vbluf to bf rfbd
     *            (<i>not indluding thf vbluf nbmf donstbnt pool indfx</i>).
     * @pbrbm buf
     *            bufffr to bf usfd to dbll {@link #rfbdUTF8 rfbdUTF8},
     *            {@link #rfbdClbss(int,dhbr[]) rfbdClbss} or {@link #rfbdConst
     *            rfbdConst}.
     * @pbrbm nbmf
     *            thf nbmf of thf vbluf to bf rfbd.
     * @pbrbm bv
     *            thf visitor thbt must visit thf vbluf.
     * @rfturn thf fnd offsft of thf bnnotbtion vbluf.
     */
    privbtf int rfbdAnnotbtionVbluf(int v, finbl dhbr[] buf, finbl String nbmf,
            finbl AnnotbtionVisitor bv) {
        int i;
        if (bv == null) {
            switdh (b[v] & 0xFF) {
            dbsf 'f': // fnum_donst_vbluf
                rfturn v + 5;
            dbsf '@': // bnnotbtion_vbluf
                rfturn rfbdAnnotbtionVblufs(v + 3, buf, truf, null);
            dbsf '[': // brrby_vbluf
                rfturn rfbdAnnotbtionVblufs(v + 1, buf, fblsf, null);
            dffbult:
                rfturn v + 3;
            }
        }
        switdh (b[v++] & 0xFF) {
        dbsf 'I': // pointfr to CONSTANT_Intfgfr
        dbsf 'J': // pointfr to CONSTANT_Long
        dbsf 'F': // pointfr to CONSTANT_Flobt
        dbsf 'D': // pointfr to CONSTANT_Doublf
            bv.visit(nbmf, rfbdConst(rfbdUnsignfdShort(v), buf));
            v += 2;
            brfbk;
        dbsf 'B': // pointfr to CONSTANT_Bytf
            bv.visit(nbmf,
                    nfw Bytf((bytf) rfbdInt(itfms[rfbdUnsignfdShort(v)])));
            v += 2;
            brfbk;
        dbsf 'Z': // pointfr to CONSTANT_Boolfbn
            bv.visit(nbmf,
                    rfbdInt(itfms[rfbdUnsignfdShort(v)]) == 0 ? Boolfbn.FALSE
                            : Boolfbn.TRUE);
            v += 2;
            brfbk;
        dbsf 'S': // pointfr to CONSTANT_Short
            bv.visit(nbmf, nfw Short(
                    (short) rfbdInt(itfms[rfbdUnsignfdShort(v)])));
            v += 2;
            brfbk;
        dbsf 'C': // pointfr to CONSTANT_Chbr
            bv.visit(nbmf, nfw Chbrbdtfr(
                    (dhbr) rfbdInt(itfms[rfbdUnsignfdShort(v)])));
            v += 2;
            brfbk;
        dbsf 's': // pointfr to CONSTANT_Utf8
            bv.visit(nbmf, rfbdUTF8(v, buf));
            v += 2;
            brfbk;
        dbsf 'f': // fnum_donst_vbluf
            bv.visitEnum(nbmf, rfbdUTF8(v, buf), rfbdUTF8(v + 2, buf));
            v += 4;
            brfbk;
        dbsf 'd': // dlbss_info
            bv.visit(nbmf, Typf.gftTypf(rfbdUTF8(v, buf)));
            v += 2;
            brfbk;
        dbsf '@': // bnnotbtion_vbluf
            v = rfbdAnnotbtionVblufs(v + 2, buf, truf,
                    bv.visitAnnotbtion(nbmf, rfbdUTF8(v, buf)));
            brfbk;
        dbsf '[': // brrby_vbluf
            int sizf = rfbdUnsignfdShort(v);
            v += 2;
            if (sizf == 0) {
                rfturn rfbdAnnotbtionVblufs(v - 2, buf, fblsf,
                        bv.visitArrby(nbmf));
            }
            switdh (this.b[v++] & 0xFF) {
            dbsf 'B':
                bytf[] bv = nfw bytf[sizf];
                for (i = 0; i < sizf; i++) {
                    bv[i] = (bytf) rfbdInt(itfms[rfbdUnsignfdShort(v)]);
                    v += 3;
                }
                bv.visit(nbmf, bv);
                --v;
                brfbk;
            dbsf 'Z':
                boolfbn[] zv = nfw boolfbn[sizf];
                for (i = 0; i < sizf; i++) {
                    zv[i] = rfbdInt(itfms[rfbdUnsignfdShort(v)]) != 0;
                    v += 3;
                }
                bv.visit(nbmf, zv);
                --v;
                brfbk;
            dbsf 'S':
                short[] sv = nfw short[sizf];
                for (i = 0; i < sizf; i++) {
                    sv[i] = (short) rfbdInt(itfms[rfbdUnsignfdShort(v)]);
                    v += 3;
                }
                bv.visit(nbmf, sv);
                --v;
                brfbk;
            dbsf 'C':
                dhbr[] dv = nfw dhbr[sizf];
                for (i = 0; i < sizf; i++) {
                    dv[i] = (dhbr) rfbdInt(itfms[rfbdUnsignfdShort(v)]);
                    v += 3;
                }
                bv.visit(nbmf, dv);
                --v;
                brfbk;
            dbsf 'I':
                int[] iv = nfw int[sizf];
                for (i = 0; i < sizf; i++) {
                    iv[i] = rfbdInt(itfms[rfbdUnsignfdShort(v)]);
                    v += 3;
                }
                bv.visit(nbmf, iv);
                --v;
                brfbk;
            dbsf 'J':
                long[] lv = nfw long[sizf];
                for (i = 0; i < sizf; i++) {
                    lv[i] = rfbdLong(itfms[rfbdUnsignfdShort(v)]);
                    v += 3;
                }
                bv.visit(nbmf, lv);
                --v;
                brfbk;
            dbsf 'F':
                flobt[] fv = nfw flobt[sizf];
                for (i = 0; i < sizf; i++) {
                    fv[i] = Flobt
                            .intBitsToFlobt(rfbdInt(itfms[rfbdUnsignfdShort(v)]));
                    v += 3;
                }
                bv.visit(nbmf, fv);
                --v;
                brfbk;
            dbsf 'D':
                doublf[] dv = nfw doublf[sizf];
                for (i = 0; i < sizf; i++) {
                    dv[i] = Doublf
                            .longBitsToDoublf(rfbdLong(itfms[rfbdUnsignfdShort(v)]));
                    v += 3;
                }
                bv.visit(nbmf, dv);
                --v;
                brfbk;
            dffbult:
                v = rfbdAnnotbtionVblufs(v - 3, buf, fblsf, bv.visitArrby(nbmf));
            }
        }
        rfturn v;
    }

    /**
     * Computfs thf implidit frbmf of thf mfthod durrfntly bfing pbrsfd (bs
     * dffinfd in thf givfn {@link Contfxt}) bnd storfs it in thf givfn dontfxt.
     *
     * @pbrbm frbmf
     *            informbtion bbout thf dlbss bfing pbrsfd.
     */
    privbtf void gftImpliditFrbmf(finbl Contfxt frbmf) {
        String dfsd = frbmf.dfsd;
        Objfdt[] lodbls = frbmf.lodbl;
        int lodbl = 0;
        if ((frbmf.bddfss & Opdodfs.ACC_STATIC) == 0) {
            if ("<init>".fqubls(frbmf.nbmf)) {
                lodbls[lodbl++] = Opdodfs.UNINITIALIZED_THIS;
            } flsf {
                lodbls[lodbl++] = rfbdClbss(hfbdfr + 2, frbmf.bufffr);
            }
        }
        int i = 1;
        loop: whilf (truf) {
            int j = i;
            switdh (dfsd.dhbrAt(i++)) {
            dbsf 'Z':
            dbsf 'C':
            dbsf 'B':
            dbsf 'S':
            dbsf 'I':
                lodbls[lodbl++] = Opdodfs.INTEGER;
                brfbk;
            dbsf 'F':
                lodbls[lodbl++] = Opdodfs.FLOAT;
                brfbk;
            dbsf 'J':
                lodbls[lodbl++] = Opdodfs.LONG;
                brfbk;
            dbsf 'D':
                lodbls[lodbl++] = Opdodfs.DOUBLE;
                brfbk;
            dbsf '[':
                whilf (dfsd.dhbrAt(i) == '[') {
                    ++i;
                }
                if (dfsd.dhbrAt(i) == 'L') {
                    ++i;
                    whilf (dfsd.dhbrAt(i) != ';') {
                        ++i;
                    }
                }
                lodbls[lodbl++] = dfsd.substring(j, ++i);
                brfbk;
            dbsf 'L':
                whilf (dfsd.dhbrAt(i) != ';') {
                    ++i;
                }
                lodbls[lodbl++] = dfsd.substring(j + 1, i++);
                brfbk;
            dffbult:
                brfbk loop;
            }
        }
        frbmf.lodblCount = lodbl;
    }

    /**
     * Rfbds b stbdk mbp frbmf bnd storfs thf rfsult in thf givfn
     * {@link Contfxt} objfdt.
     *
     * @pbrbm stbdkMbp
     *            thf stbrt offsft of b stbdk mbp frbmf in thf dlbss filf.
     * @pbrbm zip
     *            if thf stbdk mbp frbmf bt stbdkMbp is domprfssfd or not.
     * @pbrbm unzip
     *            if thf stbdk mbp frbmf must bf undomprfssfd.
     * @pbrbm frbmf
     *            whfrf thf pbrsfd stbdk mbp frbmf must bf storfd.
     * @rfturn thf offsft of thf first bytf following thf pbrsfd frbmf.
     */
    privbtf int rfbdFrbmf(int stbdkMbp, boolfbn zip, boolfbn unzip,
            Contfxt frbmf) {
        dhbr[] d = frbmf.bufffr;
        Lbbfl[] lbbfls = frbmf.lbbfls;
        int tbg;
        int dfltb;
        if (zip) {
            tbg = b[stbdkMbp++] & 0xFF;
        } flsf {
            tbg = MfthodWritfr.FULL_FRAME;
            frbmf.offsft = -1;
        }
        frbmf.lodblDiff = 0;
        if (tbg < MfthodWritfr.SAME_LOCALS_1_STACK_ITEM_FRAME) {
            dfltb = tbg;
            frbmf.modf = Opdodfs.F_SAME;
            frbmf.stbdkCount = 0;
        } flsf if (tbg < MfthodWritfr.RESERVED) {
            dfltb = tbg - MfthodWritfr.SAME_LOCALS_1_STACK_ITEM_FRAME;
            stbdkMbp = rfbdFrbmfTypf(frbmf.stbdk, 0, stbdkMbp, d, lbbfls);
            frbmf.modf = Opdodfs.F_SAME1;
            frbmf.stbdkCount = 1;
        } flsf {
            dfltb = rfbdUnsignfdShort(stbdkMbp);
            stbdkMbp += 2;
            if (tbg == MfthodWritfr.SAME_LOCALS_1_STACK_ITEM_FRAME_EXTENDED) {
                stbdkMbp = rfbdFrbmfTypf(frbmf.stbdk, 0, stbdkMbp, d, lbbfls);
                frbmf.modf = Opdodfs.F_SAME1;
                frbmf.stbdkCount = 1;
            } flsf if (tbg >= MfthodWritfr.CHOP_FRAME
                    && tbg < MfthodWritfr.SAME_FRAME_EXTENDED) {
                frbmf.modf = Opdodfs.F_CHOP;
                frbmf.lodblDiff = MfthodWritfr.SAME_FRAME_EXTENDED - tbg;
                frbmf.lodblCount -= frbmf.lodblDiff;
                frbmf.stbdkCount = 0;
            } flsf if (tbg == MfthodWritfr.SAME_FRAME_EXTENDED) {
                frbmf.modf = Opdodfs.F_SAME;
                frbmf.stbdkCount = 0;
            } flsf if (tbg < MfthodWritfr.FULL_FRAME) {
                int lodbl = unzip ? frbmf.lodblCount : 0;
                for (int i = tbg - MfthodWritfr.SAME_FRAME_EXTENDED; i > 0; i--) {
                    stbdkMbp = rfbdFrbmfTypf(frbmf.lodbl, lodbl++, stbdkMbp, d,
                            lbbfls);
                }
                frbmf.modf = Opdodfs.F_APPEND;
                frbmf.lodblDiff = tbg - MfthodWritfr.SAME_FRAME_EXTENDED;
                frbmf.lodblCount += frbmf.lodblDiff;
                frbmf.stbdkCount = 0;
            } flsf { // if (tbg == FULL_FRAME) {
                frbmf.modf = Opdodfs.F_FULL;
                int n = rfbdUnsignfdShort(stbdkMbp);
                stbdkMbp += 2;
                frbmf.lodblDiff = n;
                frbmf.lodblCount = n;
                for (int lodbl = 0; n > 0; n--) {
                    stbdkMbp = rfbdFrbmfTypf(frbmf.lodbl, lodbl++, stbdkMbp, d,
                            lbbfls);
                }
                n = rfbdUnsignfdShort(stbdkMbp);
                stbdkMbp += 2;
                frbmf.stbdkCount = n;
                for (int stbdk = 0; n > 0; n--) {
                    stbdkMbp = rfbdFrbmfTypf(frbmf.stbdk, stbdk++, stbdkMbp, d,
                            lbbfls);
                }
            }
        }
        frbmf.offsft += dfltb + 1;
        rfbdLbbfl(frbmf.offsft, lbbfls);
        rfturn stbdkMbp;
    }

    /**
     * Rfbds b stbdk mbp frbmf typf bnd storfs it bt thf givfn indfx in thf
     * givfn brrby.
     *
     * @pbrbm frbmf
     *            thf brrby whfrf thf pbrsfd typf must bf storfd.
     * @pbrbm indfx
     *            thf indfx in 'frbmf' whfrf thf pbrsfd typf must bf storfd.
     * @pbrbm v
     *            thf stbrt offsft of thf stbdk mbp frbmf typf to rfbd.
     * @pbrbm buf
     *            b bufffr to rfbd strings.
     * @pbrbm lbbfls
     *            thf lbbfls of thf mfthod durrfntly bfing pbrsfd, indfxfd by
     *            thfir offsft. If thf pbrsfd typf is bn Uninitiblizfd typf, b
     *            nfw lbbfl for thf dorrfsponding NEW instrudtion is storfd in
     *            this brrby if it dofs not blrfbdy fxist.
     * @rfturn thf offsft of thf first bytf bftfr thf pbrsfd typf.
     */
    privbtf int rfbdFrbmfTypf(finbl Objfdt[] frbmf, finbl int indfx, int v,
            finbl dhbr[] buf, finbl Lbbfl[] lbbfls) {
        int typf = b[v++] & 0xFF;
        switdh (typf) {
        dbsf 0:
            frbmf[indfx] = Opdodfs.TOP;
            brfbk;
        dbsf 1:
            frbmf[indfx] = Opdodfs.INTEGER;
            brfbk;
        dbsf 2:
            frbmf[indfx] = Opdodfs.FLOAT;
            brfbk;
        dbsf 3:
            frbmf[indfx] = Opdodfs.DOUBLE;
            brfbk;
        dbsf 4:
            frbmf[indfx] = Opdodfs.LONG;
            brfbk;
        dbsf 5:
            frbmf[indfx] = Opdodfs.NULL;
            brfbk;
        dbsf 6:
            frbmf[indfx] = Opdodfs.UNINITIALIZED_THIS;
            brfbk;
        dbsf 7: // Objfdt
            frbmf[indfx] = rfbdClbss(v, buf);
            v += 2;
            brfbk;
        dffbult: // Uninitiblizfd
            frbmf[indfx] = rfbdLbbfl(rfbdUnsignfdShort(v), lbbfls);
            v += 2;
        }
        rfturn v;
    }

    /**
     * Rfturns thf lbbfl dorrfsponding to thf givfn offsft. Thf dffbult
     * implfmfntbtion of this mfthod drfbtfs b lbbfl for thf givfn offsft if it
     * hbs not bffn blrfbdy drfbtfd.
     *
     * @pbrbm offsft
     *            b bytfdodf offsft in b mfthod.
     * @pbrbm lbbfls
     *            thf blrfbdy drfbtfd lbbfls, indfxfd by thfir offsft. If b
     *            lbbfl blrfbdy fxists for offsft this mfthod must not drfbtf b
     *            nfw onf. Othfrwisf it must storf thf nfw lbbfl in this brrby.
     * @rfturn b non null Lbbfl, whidh must bf fqubl to lbbfls[offsft].
     */
    protfdtfd Lbbfl rfbdLbbfl(int offsft, Lbbfl[] lbbfls) {
        if (lbbfls[offsft] == null) {
            lbbfls[offsft] = nfw Lbbfl();
        }
        rfturn lbbfls[offsft];
    }

    /**
     * Rfturns thf stbrt indfx of thf bttributf_info strudturf of this dlbss.
     *
     * @rfturn thf stbrt indfx of thf bttributf_info strudturf of this dlbss.
     */
    privbtf int gftAttributfs() {
        // skips thf hfbdfr
        int u = hfbdfr + 8 + rfbdUnsignfdShort(hfbdfr + 6) * 2;
        // skips fiflds bnd mfthods
        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            for (int j = rfbdUnsignfdShort(u + 8); j > 0; --j) {
                u += 6 + rfbdInt(u + 12);
            }
            u += 8;
        }
        u += 2;
        for (int i = rfbdUnsignfdShort(u); i > 0; --i) {
            for (int j = rfbdUnsignfdShort(u + 8); j > 0; --j) {
                u += 6 + rfbdInt(u + 12);
            }
            u += 8;
        }
        // thf bttributf_info strudturf stbrts just bftfr thf mfthods
        rfturn u + 2;
    }

    /**
     * Rfbds bn bttributf in {@link #b b}.
     *
     * @pbrbm bttrs
     *            prototypfs of thf bttributfs thbt must bf pbrsfd during thf
     *            visit of thf dlbss. Any bttributf whosf typf is not fqubl to
     *            thf typf of onf thf prototypfs is ignorfd (i.f. bn fmpty
     *            {@link Attributf} instbndf is rfturnfd).
     * @pbrbm typf
     *            thf typf of thf bttributf.
     * @pbrbm off
     *            indfx of thf first bytf of thf bttributf's dontfnt in
     *            {@link #b b}. Thf 6 bttributf hfbdfr bytfs, dontbining thf
     *            typf bnd thf lfngth of thf bttributf, brf not tbkfn into
     *            bddount hfrf (thfy hbvf blrfbdy bffn rfbd).
     * @pbrbm lfn
     *            thf lfngth of thf bttributf's dontfnt.
     * @pbrbm buf
     *            bufffr to bf usfd to dbll {@link #rfbdUTF8 rfbdUTF8},
     *            {@link #rfbdClbss(int,dhbr[]) rfbdClbss} or {@link #rfbdConst
     *            rfbdConst}.
     * @pbrbm dodfOff
     *            indfx of thf first bytf of dodf's bttributf dontfnt in
     *            {@link #b b}, or -1 if thf bttributf to bf rfbd is not b dodf
     *            bttributf. Thf 6 bttributf hfbdfr bytfs, dontbining thf typf
     *            bnd thf lfngth of thf bttributf, brf not tbkfn into bddount
     *            hfrf.
     * @pbrbm lbbfls
     *            thf lbbfls of thf mfthod's dodf, or <tt>null</tt> if thf
     *            bttributf to bf rfbd is not b dodf bttributf.
     * @rfturn thf bttributf thbt hbs bffn rfbd, or <tt>null</tt> to skip this
     *         bttributf.
     */
    privbtf Attributf rfbdAttributf(finbl Attributf[] bttrs, finbl String typf,
            finbl int off, finbl int lfn, finbl dhbr[] buf, finbl int dodfOff,
            finbl Lbbfl[] lbbfls) {
        for (int i = 0; i < bttrs.lfngth; ++i) {
            if (bttrs[i].typf.fqubls(typf)) {
                rfturn bttrs[i].rfbd(this, off, lfn, buf, dodfOff, lbbfls);
            }
        }
        rfturn nfw Attributf(typf).rfbd(this, off, lfn, null, -1, null);
    }

    // ------------------------------------------------------------------------
    // Utility mfthods: low lfvfl pbrsing
    // ------------------------------------------------------------------------

    /**
     * Rfturns thf numbfr of donstbnt pool itfms in {@link #b b}.
     *
     * @rfturn thf numbfr of donstbnt pool itfms in {@link #b b}.
     */
    publid int gftItfmCount() {
        rfturn itfms.lfngth;
    }

    /**
     * Rfturns thf stbrt indfx of thf donstbnt pool itfm in {@link #b b}, plus
     * onf. <i>This mfthod is intfndfd for {@link Attributf} sub dlbssfs, bnd is
     * normblly not nffdfd by dlbss gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm itfm
     *            thf indfx b donstbnt pool itfm.
     * @rfturn thf stbrt indfx of thf donstbnt pool itfm in {@link #b b}, plus
     *         onf.
     */
    publid int gftItfm(finbl int itfm) {
        rfturn itfms[itfm];
    }

    /**
     * Rfturns thf mbximum lfngth of thf strings dontbinfd in thf donstbnt pool
     * of thf dlbss.
     *
     * @rfturn thf mbximum lfngth of thf strings dontbinfd in thf donstbnt pool
     *         of thf dlbss.
     */
    publid int gftMbxStringLfngth() {
        rfturn mbxStringLfngth;
    }

    /**
     * Rfbds b bytf vbluf in {@link #b b}. <i>This mfthod is intfndfd for
     * {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by dlbss
     * gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of thf vbluf to bf rfbd in {@link #b b}.
     * @rfturn thf rfbd vbluf.
     */
    publid int rfbdBytf(finbl int indfx) {
        rfturn b[indfx] & 0xFF;
    }

    /**
     * Rfbds bn unsignfd short vbluf in {@link #b b}. <i>This mfthod is intfndfd
     * for {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by dlbss
     * gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of thf vbluf to bf rfbd in {@link #b b}.
     * @rfturn thf rfbd vbluf.
     */
    publid int rfbdUnsignfdShort(finbl int indfx) {
        bytf[] b = this.b;
        rfturn ((b[indfx] & 0xFF) << 8) | (b[indfx + 1] & 0xFF);
    }

    /**
     * Rfbds b signfd short vbluf in {@link #b b}. <i>This mfthod is intfndfd
     * for {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by dlbss
     * gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of thf vbluf to bf rfbd in {@link #b b}.
     * @rfturn thf rfbd vbluf.
     */
    publid short rfbdShort(finbl int indfx) {
        bytf[] b = this.b;
        rfturn (short) (((b[indfx] & 0xFF) << 8) | (b[indfx + 1] & 0xFF));
    }

    /**
     * Rfbds b signfd int vbluf in {@link #b b}. <i>This mfthod is intfndfd for
     * {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by dlbss
     * gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of thf vbluf to bf rfbd in {@link #b b}.
     * @rfturn thf rfbd vbluf.
     */
    publid int rfbdInt(finbl int indfx) {
        bytf[] b = this.b;
        rfturn ((b[indfx] & 0xFF) << 24) | ((b[indfx + 1] & 0xFF) << 16)
                | ((b[indfx + 2] & 0xFF) << 8) | (b[indfx + 3] & 0xFF);
    }

    /**
     * Rfbds b signfd long vbluf in {@link #b b}. <i>This mfthod is intfndfd for
     * {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by dlbss
     * gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of thf vbluf to bf rfbd in {@link #b b}.
     * @rfturn thf rfbd vbluf.
     */
    publid long rfbdLong(finbl int indfx) {
        long l1 = rfbdInt(indfx);
        long l0 = rfbdInt(indfx + 4) & 0xFFFFFFFFL;
        rfturn (l1 << 32) | l0;
    }

    /**
     * Rfbds bn UTF8 string donstbnt pool itfm in {@link #b b}. <i>This mfthod
     * is intfndfd for {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd
     * by dlbss gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of bn unsignfd short vbluf in {@link #b b},
     *            whosf vbluf is thf indfx of bn UTF8 donstbnt pool itfm.
     * @pbrbm buf
     *            bufffr to bf usfd to rfbd thf itfm. This bufffr must bf
     *            suffidifntly lbrgf. It is not butombtidblly rfsizfd.
     * @rfturn thf String dorrfsponding to thf spfdififd UTF8 itfm.
     */
    publid String rfbdUTF8(int indfx, finbl dhbr[] buf) {
        int itfm = rfbdUnsignfdShort(indfx);
        if (indfx == 0 || itfm == 0) {
            rfturn null;
        }
        String s = strings[itfm];
        if (s != null) {
            rfturn s;
        }
        indfx = itfms[itfm];
        rfturn strings[itfm] = rfbdUTF(indfx + 2, rfbdUnsignfdShort(indfx), buf);
    }

    /**
     * Rfbds UTF8 string in {@link #b b}.
     *
     * @pbrbm indfx
     *            stbrt offsft of thf UTF8 string to bf rfbd.
     * @pbrbm utfLfn
     *            lfngth of thf UTF8 string to bf rfbd.
     * @pbrbm buf
     *            bufffr to bf usfd to rfbd thf string. This bufffr must bf
     *            suffidifntly lbrgf. It is not butombtidblly rfsizfd.
     * @rfturn thf String dorrfsponding to thf spfdififd UTF8 string.
     */
    privbtf String rfbdUTF(int indfx, finbl int utfLfn, finbl dhbr[] buf) {
        int fndIndfx = indfx + utfLfn;
        bytf[] b = this.b;
        int strLfn = 0;
        int d;
        int st = 0;
        dhbr dd = 0;
        whilf (indfx < fndIndfx) {
            d = b[indfx++];
            switdh (st) {
            dbsf 0:
                d = d & 0xFF;
                if (d < 0x80) { // 0xxxxxxx
                    buf[strLfn++] = (dhbr) d;
                } flsf if (d < 0xE0 && d > 0xBF) { // 110x xxxx 10xx xxxx
                    dd = (dhbr) (d & 0x1F);
                    st = 1;
                } flsf { // 1110 xxxx 10xx xxxx 10xx xxxx
                    dd = (dhbr) (d & 0x0F);
                    st = 2;
                }
                brfbk;

            dbsf 1: // bytf 2 of 2-bytf dhbr or bytf 3 of 3-bytf dhbr
                buf[strLfn++] = (dhbr) ((dd << 6) | (d & 0x3F));
                st = 0;
                brfbk;

            dbsf 2: // bytf 2 of 3-bytf dhbr
                dd = (dhbr) ((dd << 6) | (d & 0x3F));
                st = 1;
                brfbk;
            }
        }
        rfturn nfw String(buf, 0, strLfn);
    }

    /**
     * Rfbds b dlbss donstbnt pool itfm in {@link #b b}. <i>This mfthod is
     * intfndfd for {@link Attributf} sub dlbssfs, bnd is normblly not nffdfd by
     * dlbss gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm indfx
     *            thf stbrt indfx of bn unsignfd short vbluf in {@link #b b},
     *            whosf vbluf is thf indfx of b dlbss donstbnt pool itfm.
     * @pbrbm buf
     *            bufffr to bf usfd to rfbd thf itfm. This bufffr must bf
     *            suffidifntly lbrgf. It is not butombtidblly rfsizfd.
     * @rfturn thf String dorrfsponding to thf spfdififd dlbss itfm.
     */
    publid String rfbdClbss(finbl int indfx, finbl dhbr[] buf) {
        // domputfs thf stbrt indfx of thf CONSTANT_Clbss itfm in b
        // bnd rfbds thf CONSTANT_Utf8 itfm dfsignbtfd by
        // thf first two bytfs of this CONSTANT_Clbss itfm
        rfturn rfbdUTF8(itfms[rfbdUnsignfdShort(indfx)], buf);
    }

    /**
     * Rfbds b numfrid or string donstbnt pool itfm in {@link #b b}. <i>This
     * mfthod is intfndfd for {@link Attributf} sub dlbssfs, bnd is normblly not
     * nffdfd by dlbss gfnfrbtors or bdbptfrs.</i>
     *
     * @pbrbm itfm
     *            thf indfx of b donstbnt pool itfm.
     * @pbrbm buf
     *            bufffr to bf usfd to rfbd thf itfm. This bufffr must bf
     *            suffidifntly lbrgf. It is not butombtidblly rfsizfd.
     * @rfturn thf {@link Intfgfr}, {@link Flobt}, {@link Long}, {@link Doublf},
     *         {@link String}, {@link Typf} or {@link Hbndlf} dorrfsponding to
     *         thf givfn donstbnt pool itfm.
     */
    publid Objfdt rfbdConst(finbl int itfm, finbl dhbr[] buf) {
        int indfx = itfms[itfm];
        switdh (b[indfx - 1]) {
        dbsf ClbssWritfr.INT:
            rfturn nfw Intfgfr(rfbdInt(indfx));
        dbsf ClbssWritfr.FLOAT:
            rfturn nfw Flobt(Flobt.intBitsToFlobt(rfbdInt(indfx)));
        dbsf ClbssWritfr.LONG:
            rfturn nfw Long(rfbdLong(indfx));
        dbsf ClbssWritfr.DOUBLE:
            rfturn nfw Doublf(Doublf.longBitsToDoublf(rfbdLong(indfx)));
        dbsf ClbssWritfr.CLASS:
            rfturn Typf.gftObjfdtTypf(rfbdUTF8(indfx, buf));
        dbsf ClbssWritfr.STR:
            rfturn rfbdUTF8(indfx, buf);
        dbsf ClbssWritfr.MTYPE:
            rfturn Typf.gftMfthodTypf(rfbdUTF8(indfx, buf));
        dffbult: // dbsf ClbssWritfr.HANDLE_BASE + [1..9]:
            int tbg = rfbdBytf(indfx);
            int[] itfms = this.itfms;
            int dpIndfx = itfms[rfbdUnsignfdShort(indfx + 1)];
            String ownfr = rfbdClbss(dpIndfx, buf);
            dpIndfx = itfms[rfbdUnsignfdShort(dpIndfx + 2)];
            String nbmf = rfbdUTF8(dpIndfx, buf);
            String dfsd = rfbdUTF8(dpIndfx + 2, buf);
            rfturn nfw Hbndlf(tbg, ownfr, nbmf, dfsd);
        }
    }
}
