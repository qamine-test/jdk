/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf:
 *
 * ASM: b vfry smbll bnd fbst Jbvb bytfdodf mbnipulbtion frbmfwork
 * Copyright (d) 2000-2011 INRIA, Frbndf Tflfdom
 * All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 * 1. Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr.
 * 2. Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr in thf
 *    dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 * 3. Nfithfr thf nbmf of thf dopyright holdfrs nor thf nbmfs of its
 *    dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd from
 *    this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 */
pbdkbgf jdk.intfrnbl.org.objfdtwfb.bsm.util;

import jbvb.io.PrintWritfr;
import jbvb.io.StringWritfr;
import jbvb.lbng.rfflfdt.Fifld;
import jbvb.util.ArrbyList;
import jbvb.util.HbshMbp;
import jbvb.util.HbshSft;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;

import jdk.intfrnbl.org.objfdtwfb.bsm.AnnotbtionVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.Attributf;
import jdk.intfrnbl.org.objfdtwfb.bsm.Hbndlf;
import jdk.intfrnbl.org.objfdtwfb.bsm.Lbbfl;
import jdk.intfrnbl.org.objfdtwfb.bsm.MfthodVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.Opdodfs;
import jdk.intfrnbl.org.objfdtwfb.bsm.Typf;
import jdk.intfrnbl.org.objfdtwfb.bsm.TypfPbth;
import jdk.intfrnbl.org.objfdtwfb.bsm.TypfRfffrfndf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.MfthodNodf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.Anblyzfr;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.BbsidVbluf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.BbsidVfrififr;

/**
 * A {@link MfthodVisitor} thbt dhfdks thbt its mfthods brf propfrly usfd. Morf
 * prfdisfly this mfthod bdbptfr dhfdks fbdh instrudtion individublly, i.f.,
 * fbdh visit mfthod dhfdks somf prfdonditions bbsfd <i>only</i> on its
 * brgumfnts - sudh bs thf fbdt thbt thf givfn opdodf is dorrfdt for b givfn
 * visit mfthod. This bdbptfr dbn blso pfrform somf bbsid dbtb flow dhfdks (morf
 * prfdisfly thosf thbt dbn bf pfrformfd without thf full dlbss hifrbrdhy - sff
 * {@link jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.BbsidVfrififr}). For instbndf in b
 * mfthod whosf signbturf is <tt>void m ()</tt>, thf invblid instrudtion
 * IRETURN, or thf invblid sfqufndf IADD L2I will bf dftfdtfd if thf dbtb flow
 * dhfdks brf fnbblfd. Thfsf dhfdks brf fnbblfd by using thf
 * {@link #ChfdkMfthodAdbptfr(int,String,String,MfthodVisitor,Mbp)} donstrudtor.
 * Thfy brf not pfrformfd if bny othfr donstrudtor is usfd.
 *
 * @buthor Erid Brunfton
 */
publid dlbss ChfdkMfthodAdbptfr fxtfnds MfthodVisitor {

    /**
     * Thf dlbss vfrsion numbfr.
     */
    publid int vfrsion;

    /**
     * Thf bddfss flbgs of thf mfthod.
     */
    privbtf int bddfss;

    /**
     * <tt>truf</tt> if thf visitCodf mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn stbrtCodf;

    /**
     * <tt>truf</tt> if thf visitMbxs mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn fndCodf;

    /**
     * <tt>truf</tt> if thf visitEnd mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn fndMfthod;

    /**
     * Numbfr of visitfd instrudtions.
     */
    privbtf int insnCount;

    /**
     * Thf blrfbdy visitfd lbbfls. This mbp bssodibtf Intfgfr vblufs to psfudo
     * dodf offsfts.
     */
    privbtf finbl Mbp<Lbbfl, Intfgfr> lbbfls;

    /**
     * Thf lbbfls usfd in this mfthod. Evfry usfd lbbfl must bf visitfd with
     * visitLbbfl bfforf thf fnd of thf mfthod (i.f. should bf in #lbbfls).
     */
    privbtf Sft<Lbbfl> usfdLbbfls;

    /**
     * Numbfr of visitfd frbmfs in fxpbndfd form.
     */
    privbtf int fxpbndfdFrbmfs;

    /**
     * Numbfr of visitfd frbmfs in domprfssfd form.
     */
    privbtf int domprfssfdFrbmfs;

    /**
     * Numbfr of instrudtions bfforf thf lbst visitfd frbmf.
     */
    privbtf int lbstFrbmf = -1;

    /**
     * Thf fxdfption hbndlfr rbngfs. Ebdh pbir of list flfmfnt dontbins thf
     * stbrt bnd fnd lbbfls of bn fxdfption hbndlfr blodk.
     */
    privbtf List<Lbbfl> hbndlfrs;

    /**
     * Codf of thf visit mfthod to bf usfd for fbdh opdodf.
     */
    privbtf stbtid finbl int[] TYPE;

    /**
     * Thf Lbbfl.stbtus fifld.
     */
    privbtf stbtid Fifld lbbflStbtusFifld;

    stbtid {
        String s = "BBBBBBBBBBBBBBBBCCIAADDDDDAAAAAAAAAAAAAAAAAAAABBBBBBBBDD"
                + "DDDAAAAAAAAAAAAAAAAAAAABBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB"
                + "BBBBBBBBBBBBBBBBBBBJBBBBBBBBBBBBBBBBBBBBHHHHHHHHHHHHHHHHD"
                + "KLBBBBBBFFFFGGGGAECEBBEEBBAMHHAA";
        TYPE = nfw int[s.lfngth()];
        for (int i = 0; i < TYPE.lfngth; ++i) {
            TYPE[i] = s.dhbrAt(i) - 'A' - 1;
        }
    }

    // dodf to gfnfrbtf thf bbovf string
    // publid stbtid void mbin (String[] brgs) {
    // int[] TYPE = nfw int[] {
    // 0, //NOP
    // 0, //ACONST_NULL
    // 0, //ICONST_M1
    // 0, //ICONST_0
    // 0, //ICONST_1
    // 0, //ICONST_2
    // 0, //ICONST_3
    // 0, //ICONST_4
    // 0, //ICONST_5
    // 0, //LCONST_0
    // 0, //LCONST_1
    // 0, //FCONST_0
    // 0, //FCONST_1
    // 0, //FCONST_2
    // 0, //DCONST_0
    // 0, //DCONST_1
    // 1, //BIPUSH
    // 1, //SIPUSH
    // 7, //LDC
    // -1, //LDC_W
    // -1, //LDC2_W
    // 2, //ILOAD
    // 2, //LLOAD
    // 2, //FLOAD
    // 2, //DLOAD
    // 2, //ALOAD
    // -1, //ILOAD_0
    // -1, //ILOAD_1
    // -1, //ILOAD_2
    // -1, //ILOAD_3
    // -1, //LLOAD_0
    // -1, //LLOAD_1
    // -1, //LLOAD_2
    // -1, //LLOAD_3
    // -1, //FLOAD_0
    // -1, //FLOAD_1
    // -1, //FLOAD_2
    // -1, //FLOAD_3
    // -1, //DLOAD_0
    // -1, //DLOAD_1
    // -1, //DLOAD_2
    // -1, //DLOAD_3
    // -1, //ALOAD_0
    // -1, //ALOAD_1
    // -1, //ALOAD_2
    // -1, //ALOAD_3
    // 0, //IALOAD
    // 0, //LALOAD
    // 0, //FALOAD
    // 0, //DALOAD
    // 0, //AALOAD
    // 0, //BALOAD
    // 0, //CALOAD
    // 0, //SALOAD
    // 2, //ISTORE
    // 2, //LSTORE
    // 2, //FSTORE
    // 2, //DSTORE
    // 2, //ASTORE
    // -1, //ISTORE_0
    // -1, //ISTORE_1
    // -1, //ISTORE_2
    // -1, //ISTORE_3
    // -1, //LSTORE_0
    // -1, //LSTORE_1
    // -1, //LSTORE_2
    // -1, //LSTORE_3
    // -1, //FSTORE_0
    // -1, //FSTORE_1
    // -1, //FSTORE_2
    // -1, //FSTORE_3
    // -1, //DSTORE_0
    // -1, //DSTORE_1
    // -1, //DSTORE_2
    // -1, //DSTORE_3
    // -1, //ASTORE_0
    // -1, //ASTORE_1
    // -1, //ASTORE_2
    // -1, //ASTORE_3
    // 0, //IASTORE
    // 0, //LASTORE
    // 0, //FASTORE
    // 0, //DASTORE
    // 0, //AASTORE
    // 0, //BASTORE
    // 0, //CASTORE
    // 0, //SASTORE
    // 0, //POP
    // 0, //POP2
    // 0, //DUP
    // 0, //DUP_X1
    // 0, //DUP_X2
    // 0, //DUP2
    // 0, //DUP2_X1
    // 0, //DUP2_X2
    // 0, //SWAP
    // 0, //IADD
    // 0, //LADD
    // 0, //FADD
    // 0, //DADD
    // 0, //ISUB
    // 0, //LSUB
    // 0, //FSUB
    // 0, //DSUB
    // 0, //IMUL
    // 0, //LMUL
    // 0, //FMUL
    // 0, //DMUL
    // 0, //IDIV
    // 0, //LDIV
    // 0, //FDIV
    // 0, //DDIV
    // 0, //IREM
    // 0, //LREM
    // 0, //FREM
    // 0, //DREM
    // 0, //INEG
    // 0, //LNEG
    // 0, //FNEG
    // 0, //DNEG
    // 0, //ISHL
    // 0, //LSHL
    // 0, //ISHR
    // 0, //LSHR
    // 0, //IUSHR
    // 0, //LUSHR
    // 0, //IAND
    // 0, //LAND
    // 0, //IOR
    // 0, //LOR
    // 0, //IXOR
    // 0, //LXOR
    // 8, //IINC
    // 0, //I2L
    // 0, //I2F
    // 0, //I2D
    // 0, //L2I
    // 0, //L2F
    // 0, //L2D
    // 0, //F2I
    // 0, //F2L
    // 0, //F2D
    // 0, //D2I
    // 0, //D2L
    // 0, //D2F
    // 0, //I2B
    // 0, //I2C
    // 0, //I2S
    // 0, //LCMP
    // 0, //FCMPL
    // 0, //FCMPG
    // 0, //DCMPL
    // 0, //DCMPG
    // 6, //IFEQ
    // 6, //IFNE
    // 6, //IFLT
    // 6, //IFGE
    // 6, //IFGT
    // 6, //IFLE
    // 6, //IF_ICMPEQ
    // 6, //IF_ICMPNE
    // 6, //IF_ICMPLT
    // 6, //IF_ICMPGE
    // 6, //IF_ICMPGT
    // 6, //IF_ICMPLE
    // 6, //IF_ACMPEQ
    // 6, //IF_ACMPNE
    // 6, //GOTO
    // 6, //JSR
    // 2, //RET
    // 9, //TABLESWITCH
    // 10, //LOOKUPSWITCH
    // 0, //IRETURN
    // 0, //LRETURN
    // 0, //FRETURN
    // 0, //DRETURN
    // 0, //ARETURN
    // 0, //RETURN
    // 4, //GETSTATIC
    // 4, //PUTSTATIC
    // 4, //GETFIELD
    // 4, //PUTFIELD
    // 5, //INVOKEVIRTUAL
    // 5, //INVOKESPECIAL
    // 5, //INVOKESTATIC
    // 5, //INVOKEINTERFACE
    // -1, //INVOKEDYNAMIC
    // 3, //NEW
    // 1, //NEWARRAY
    // 3, //ANEWARRAY
    // 0, //ARRAYLENGTH
    // 0, //ATHROW
    // 3, //CHECKCAST
    // 3, //INSTANCEOF
    // 0, //MONITORENTER
    // 0, //MONITOREXIT
    // -1, //WIDE
    // 11, //MULTIANEWARRAY
    // 6, //IFNULL
    // 6, //IFNONNULL
    // -1, //GOTO_W
    // -1 //JSR_W
    // };
    // for (int i = 0; i < TYPE.lfngth; ++i) {
    // Systfm.out.print((dhbr)(TYPE[i] + 1 + 'A'));
    // }
    // Systfm.out.println();
    // }

    /**
     * Construdts b nfw {@link ChfdkMfthodAdbptfr} objfdt. This mfthod bdbptfr
     * will not pfrform bny dbtb flow dhfdk (sff
     * {@link #ChfdkMfthodAdbptfr(int,String,String,MfthodVisitor,Mbp)}).
     * <i>Subdlbssfs must not usf this donstrudtor</i>. Instfbd, thfy must usf
     * thf {@link #ChfdkMfthodAdbptfr(int, MfthodVisitor, Mbp)} vfrsion.
     *
     * @pbrbm mv
     *            thf mfthod visitor to whidh this bdbptfr must dflfgbtf dblls.
     */
    publid ChfdkMfthodAdbptfr(finbl MfthodVisitor mv) {
        this(mv, nfw HbshMbp<Lbbfl, Intfgfr>());
    }

    /**
     * Construdts b nfw {@link ChfdkMfthodAdbptfr} objfdt. This mfthod bdbptfr
     * will not pfrform bny dbtb flow dhfdk (sff
     * {@link #ChfdkMfthodAdbptfr(int,String,String,MfthodVisitor,Mbp)}).
     * <i>Subdlbssfs must not usf this donstrudtor</i>. Instfbd, thfy must usf
     * thf {@link #ChfdkMfthodAdbptfr(int, MfthodVisitor, Mbp)} vfrsion.
     *
     * @pbrbm mv
     *            thf mfthod visitor to whidh this bdbptfr must dflfgbtf dblls.
     * @pbrbm lbbfls
     *            b mbp of blrfbdy visitfd lbbfls (in othfr mfthods).
     * @throws IllfgblStbtfExdfption
     *             If b subdlbss dblls this donstrudtor.
     */
    publid ChfdkMfthodAdbptfr(finbl MfthodVisitor mv,
            finbl Mbp<Lbbfl, Intfgfr> lbbfls) {
        this(Opdodfs.ASM5, mv, lbbfls);
        if (gftClbss() != ChfdkMfthodAdbptfr.dlbss) {
            throw nfw IllfgblStbtfExdfption();
        }
    }

    /**
     * Construdts b nfw {@link ChfdkMfthodAdbptfr} objfdt. This mfthod bdbptfr
     * will not pfrform bny dbtb flow dhfdk (sff
     * {@link #ChfdkMfthodAdbptfr(int,String,String,MfthodVisitor,Mbp)}).
     *
     * @pbrbm mv
     *            thf mfthod visitor to whidh this bdbptfr must dflfgbtf dblls.
     * @pbrbm lbbfls
     *            b mbp of blrfbdy visitfd lbbfls (in othfr mfthods).
     */
    protfdtfd ChfdkMfthodAdbptfr(finbl int bpi, finbl MfthodVisitor mv,
            finbl Mbp<Lbbfl, Intfgfr> lbbfls) {
        supfr(bpi, mv);
        this.lbbfls = lbbfls;
        this.usfdLbbfls = nfw HbshSft<Lbbfl>();
        this.hbndlfrs = nfw ArrbyList<Lbbfl>();
    }

    /**
     * Construdts b nfw {@link ChfdkMfthodAdbptfr} objfdt. This mfthod bdbptfr
     * will pfrform bbsid dbtb flow dhfdks. For instbndf in b mfthod whosf
     * signbturf is <tt>void m ()</tt>, thf invblid instrudtion IRETURN, or thf
     * invblid sfqufndf IADD L2I will bf dftfdtfd.
     *
     * @pbrbm bddfss
     *            thf mfthod's bddfss flbgs.
     * @pbrbm nbmf
     *            thf mfthod's nbmf.
     * @pbrbm dfsd
     *            thf mfthod's dfsdriptor (sff {@link Typf Typf}).
     * @pbrbm dmv
     *            thf mfthod visitor to whidh this bdbptfr must dflfgbtf dblls.
     * @pbrbm lbbfls
     *            b mbp of blrfbdy visitfd lbbfls (in othfr mfthods).
     */
    publid ChfdkMfthodAdbptfr(finbl int bddfss, finbl String nbmf,
            finbl String dfsd, finbl MfthodVisitor dmv,
            finbl Mbp<Lbbfl, Intfgfr> lbbfls) {
        this(nfw MfthodNodf(Opdodfs.ASM5, bddfss, nbmf, dfsd, null, null) {
            @Ovfrridf
            publid void visitEnd() {
                Anblyzfr<BbsidVbluf> b = nfw Anblyzfr<BbsidVbluf>(
                        nfw BbsidVfrififr());
                try {
                    b.bnblyzf("dummy", this);
                } dbtdh (Exdfption f) {
                    if (f instbndfof IndfxOutOfBoundsExdfption
                            && mbxLodbls == 0 && mbxStbdk == 0) {
                        throw nfw RuntimfExdfption(
                                "Dbtb flow dhfdking option rfquirfs vblid, non zfro mbxLodbls bnd mbxStbdk vblufs.");
                    }
                    f.printStbdkTrbdf();
                    StringWritfr sw = nfw StringWritfr();
                    PrintWritfr pw = nfw PrintWritfr(sw, truf);
                    ChfdkClbssAdbptfr.printAnblyzfrRfsult(this, b, pw);
                    pw.dlosf();
                    throw nfw RuntimfExdfption(f.gftMfssbgf() + ' '
                            + sw.toString());
                }
                bddfpt(dmv);
            }
        }, lbbfls);
        this.bddfss = bddfss;
    }

    @Ovfrridf
    publid void visitPbrbmftfr(String nbmf, int bddfss) {
        if (nbmf != null) {
            dhfdkUnqublififdNbmf(vfrsion, nbmf, "nbmf");
        }
        ChfdkClbssAdbptfr.dhfdkAddfss(bddfss, Opdodfs.ACC_FINAL
                + Opdodfs.ACC_MANDATED + Opdodfs.ACC_SYNTHETIC);
        supfr.visitPbrbmftfr(nbmf, bddfss);
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitAnnotbtion(finbl String dfsd,
            finbl boolfbn visiblf) {
        dhfdkEndMfthod();
        dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitAnnotbtion(dfsd, visiblf));
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitTypfAnnotbtion(finbl int typfRff,
            finbl TypfPbth typfPbth, finbl String dfsd, finbl boolfbn visiblf) {
        dhfdkEndMfthod();
        int sort = typfRff >>> 24;
        if (sort != TypfRfffrfndf.METHOD_TYPE_PARAMETER
                && sort != TypfRfffrfndf.METHOD_TYPE_PARAMETER_BOUND
                && sort != TypfRfffrfndf.METHOD_RETURN
                && sort != TypfRfffrfndf.METHOD_RECEIVER
                && sort != TypfRfffrfndf.METHOD_FORMAL_PARAMETER
                && sort != TypfRfffrfndf.THROWS) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(sort));
        }
        ChfdkClbssAdbptfr.dhfdkTypfRffAndPbth(typfRff, typfPbth);
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitTypfAnnotbtion(typfRff,
                typfPbth, dfsd, visiblf));
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitAnnotbtionDffbult() {
        dhfdkEndMfthod();
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitAnnotbtionDffbult(), fblsf);
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitPbrbmftfrAnnotbtion(finbl int pbrbmftfr,
            finbl String dfsd, finbl boolfbn visiblf) {
        dhfdkEndMfthod();
        dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitPbrbmftfrAnnotbtion(
                pbrbmftfr, dfsd, visiblf));
    }

    @Ovfrridf
    publid void visitAttributf(finbl Attributf bttr) {
        dhfdkEndMfthod();
        if (bttr == null) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid bttributf (must not bf null)");
        }
        supfr.visitAttributf(bttr);
    }

    @Ovfrridf
    publid void visitCodf() {
        if ((bddfss & Opdodfs.ACC_ABSTRACT) != 0) {
            throw nfw RuntimfExdfption("Abstrbdt mfthods dbnnot hbvf dodf");
        }
        stbrtCodf = truf;
        supfr.visitCodf();
    }

    @Ovfrridf
    publid void visitFrbmf(finbl int typf, finbl int nLodbl,
            finbl Objfdt[] lodbl, finbl int nStbdk, finbl Objfdt[] stbdk) {
        if (insnCount == lbstFrbmf) {
            throw nfw IllfgblStbtfExdfption(
                    "At most onf frbmf dbn bf visitfd bt b givfn dodf lodbtion.");
        }
        lbstFrbmf = insnCount;
        int mLodbl;
        int mStbdk;
        switdh (typf) {
        dbsf Opdodfs.F_NEW:
        dbsf Opdodfs.F_FULL:
            mLodbl = Intfgfr.MAX_VALUE;
            mStbdk = Intfgfr.MAX_VALUE;
            brfbk;

        dbsf Opdodfs.F_SAME:
            mLodbl = 0;
            mStbdk = 0;
            brfbk;

        dbsf Opdodfs.F_SAME1:
            mLodbl = 0;
            mStbdk = 1;
            brfbk;

        dbsf Opdodfs.F_APPEND:
        dbsf Opdodfs.F_CHOP:
            mLodbl = 3;
            mStbdk = 0;
            brfbk;

        dffbult:
            throw nfw IllfgblArgumfntExdfption("Invblid frbmf typf " + typf);
        }

        if (nLodbl > mLodbl) {
            throw nfw IllfgblArgumfntExdfption("Invblid nLodbl=" + nLodbl
                    + " for frbmf typf " + typf);
        }
        if (nStbdk > mStbdk) {
            throw nfw IllfgblArgumfntExdfption("Invblid nStbdk=" + nStbdk
                    + " for frbmf typf " + typf);
        }

        if (typf != Opdodfs.F_CHOP) {
            if (nLodbl > 0 && (lodbl == null || lodbl.lfngth < nLodbl)) {
                throw nfw IllfgblArgumfntExdfption(
                        "Arrby lodbl[] is shortfr thbn nLodbl");
            }
            for (int i = 0; i < nLodbl; ++i) {
                dhfdkFrbmfVbluf(lodbl[i]);
            }
        }
        if (nStbdk > 0 && (stbdk == null || stbdk.lfngth < nStbdk)) {
            throw nfw IllfgblArgumfntExdfption(
                    "Arrby stbdk[] is shortfr thbn nStbdk");
        }
        for (int i = 0; i < nStbdk; ++i) {
            dhfdkFrbmfVbluf(stbdk[i]);
        }
        if (typf == Opdodfs.F_NEW) {
            ++fxpbndfdFrbmfs;
        } flsf {
            ++domprfssfdFrbmfs;
        }
        if (fxpbndfdFrbmfs > 0 && domprfssfdFrbmfs > 0) {
            throw nfw RuntimfExdfption(
                    "Expbndfd bnd domprfssfd frbmfs must not bf mixfd.");
        }
        supfr.visitFrbmf(typf, nLodbl, lodbl, nStbdk, stbdk);
    }

    @Ovfrridf
    publid void visitInsn(finbl int opdodf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 0);
        supfr.visitInsn(opdodf);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitIntInsn(finbl int opdodf, finbl int opfrbnd) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 1);
        switdh (opdodf) {
        dbsf Opdodfs.BIPUSH:
            dhfdkSignfdBytf(opfrbnd, "Invblid opfrbnd");
            brfbk;
        dbsf Opdodfs.SIPUSH:
            dhfdkSignfdShort(opfrbnd, "Invblid opfrbnd");
            brfbk;
        // dbsf Constbnts.NEWARRAY:
        dffbult:
            if (opfrbnd < Opdodfs.T_BOOLEAN || opfrbnd > Opdodfs.T_LONG) {
                throw nfw IllfgblArgumfntExdfption(
                        "Invblid opfrbnd (must bf bn brrby typf dodf T_...): "
                                + opfrbnd);
            }
        }
        supfr.visitIntInsn(opdodf, opfrbnd);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitVbrInsn(finbl int opdodf, finbl int vbr) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 2);
        dhfdkUnsignfdShort(vbr, "Invblid vbribblf indfx");
        supfr.visitVbrInsn(opdodf, vbr);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitTypfInsn(finbl int opdodf, finbl String typf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 3);
        dhfdkIntfrnblNbmf(typf, "typf");
        if (opdodf == Opdodfs.NEW && typf.dhbrAt(0) == '[') {
            throw nfw IllfgblArgumfntExdfption(
                    "NEW dbnnot bf usfd to drfbtf brrbys: " + typf);
        }
        supfr.visitTypfInsn(opdodf, typf);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitFifldInsn(finbl int opdodf, finbl String ownfr,
            finbl String nbmf, finbl String dfsd) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 4);
        dhfdkIntfrnblNbmf(ownfr, "ownfr");
        dhfdkUnqublififdNbmf(vfrsion, nbmf, "nbmf");
        dhfdkDfsd(dfsd, fblsf);
        supfr.visitFifldInsn(opdodf, ownfr, nbmf, dfsd);
        ++insnCount;
    }

    @Dfprfdbtfd
    @Ovfrridf
    publid void visitMfthodInsn(int opdodf, String ownfr, String nbmf,
            String dfsd) {
        if (bpi >= Opdodfs.ASM5) {
            supfr.visitMfthodInsn(opdodf, ownfr, nbmf, dfsd);
            rfturn;
        }
        doVisitMfthodInsn(opdodf, ownfr, nbmf, dfsd,
                opdodf == Opdodfs.INVOKEINTERFACE);
    }

    @Ovfrridf
    publid void visitMfthodInsn(int opdodf, String ownfr, String nbmf,
            String dfsd, boolfbn itf) {
        if (bpi < Opdodfs.ASM5) {
            supfr.visitMfthodInsn(opdodf, ownfr, nbmf, dfsd, itf);
            rfturn;
        }
        doVisitMfthodInsn(opdodf, ownfr, nbmf, dfsd, itf);
    }

    privbtf void doVisitMfthodInsn(int opdodf, finbl String ownfr,
            finbl String nbmf, finbl String dfsd, finbl boolfbn itf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 5);
        if (opdodf != Opdodfs.INVOKESPECIAL || !"<init>".fqubls(nbmf)) {
            dhfdkMfthodIdfntififr(vfrsion, nbmf, "nbmf");
        }
        dhfdkIntfrnblNbmf(ownfr, "ownfr");
        dhfdkMfthodDfsd(dfsd);
        if (opdodf == Opdodfs.INVOKEVIRTUAL && itf) {
            throw nfw IllfgblArgumfntExdfption(
                    "INVOKEVIRTUAL dbn't bf usfd with intfrfbdfs");
        }
        if (opdodf == Opdodfs.INVOKEINTERFACE && !itf) {
            throw nfw IllfgblArgumfntExdfption(
                    "INVOKEINTERFACE dbn't bf usfd with dlbssfs");
        }
        // Cblling supfr.visitMfthodInsn rfquirfs to dbll thf dorrfdt vfrsion
        // dfpfnding on this.bpi (othfrwisf infinitf loops dbn oddur). To
        // simplify bnd to mbkf it fbsifr to butombtidblly rfmovf thf bbdkwbrd
        // dompbtibility dodf, wf inlinf thf dodf of thf ovfrriddfn mfthod hfrf.
        if (mv != null) {
            mv.visitMfthodInsn(opdodf, ownfr, nbmf, dfsd, itf);
        }
        ++insnCount;
    }

    @Ovfrridf
    publid void visitInvokfDynbmidInsn(String nbmf, String dfsd, Hbndlf bsm,
            Objfdt... bsmArgs) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkMfthodIdfntififr(vfrsion, nbmf, "nbmf");
        dhfdkMfthodDfsd(dfsd);
        if (bsm.gftTbg() != Opdodfs.H_INVOKESTATIC
                && bsm.gftTbg() != Opdodfs.H_NEWINVOKESPECIAL) {
            throw nfw IllfgblArgumfntExdfption("invblid hbndlf tbg "
                    + bsm.gftTbg());
        }
        for (int i = 0; i < bsmArgs.lfngth; i++) {
            dhfdkLDCConstbnt(bsmArgs[i]);
        }
        supfr.visitInvokfDynbmidInsn(nbmf, dfsd, bsm, bsmArgs);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitJumpInsn(finbl int opdodf, finbl Lbbfl lbbfl) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkOpdodf(opdodf, 6);
        dhfdkLbbfl(lbbfl, fblsf, "lbbfl");
        dhfdkNonDfbugLbbfl(lbbfl);
        supfr.visitJumpInsn(opdodf, lbbfl);
        usfdLbbfls.bdd(lbbfl);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitLbbfl(finbl Lbbfl lbbfl) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkLbbfl(lbbfl, fblsf, "lbbfl");
        if (lbbfls.gft(lbbfl) != null) {
            throw nfw IllfgblArgumfntExdfption("Alrfbdy visitfd lbbfl");
        }
        lbbfls.put(lbbfl, nfw Intfgfr(insnCount));
        supfr.visitLbbfl(lbbfl);
    }

    @Ovfrridf
    publid void visitLddInsn(finbl Objfdt dst) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkLDCConstbnt(dst);
        supfr.visitLddInsn(dst);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitIindInsn(finbl int vbr, finbl int indrfmfnt) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkUnsignfdShort(vbr, "Invblid vbribblf indfx");
        dhfdkSignfdShort(indrfmfnt, "Invblid indrfmfnt");
        supfr.visitIindInsn(vbr, indrfmfnt);
        ++insnCount;
    }

    @Ovfrridf
    publid void visitTbblfSwitdhInsn(finbl int min, finbl int mbx,
            finbl Lbbfl dflt, finbl Lbbfl... lbbfls) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        if (mbx < min) {
            throw nfw IllfgblArgumfntExdfption("Mbx = " + mbx
                    + " must bf grfbtfr thbn or fqubl to min = " + min);
        }
        dhfdkLbbfl(dflt, fblsf, "dffbult lbbfl");
        dhfdkNonDfbugLbbfl(dflt);
        if (lbbfls == null || lbbfls.lfngth != mbx - min + 1) {
            throw nfw IllfgblArgumfntExdfption(
                    "Thfrf must bf mbx - min + 1 lbbfls");
        }
        for (int i = 0; i < lbbfls.lfngth; ++i) {
            dhfdkLbbfl(lbbfls[i], fblsf, "lbbfl bt indfx " + i);
            dhfdkNonDfbugLbbfl(lbbfls[i]);
        }
        supfr.visitTbblfSwitdhInsn(min, mbx, dflt, lbbfls);
        for (int i = 0; i < lbbfls.lfngth; ++i) {
            usfdLbbfls.bdd(lbbfls[i]);
        }
        ++insnCount;
    }

    @Ovfrridf
    publid void visitLookupSwitdhInsn(finbl Lbbfl dflt, finbl int[] kfys,
            finbl Lbbfl[] lbbfls) {
        dhfdkEndCodf();
        dhfdkStbrtCodf();
        dhfdkLbbfl(dflt, fblsf, "dffbult lbbfl");
        dhfdkNonDfbugLbbfl(dflt);
        if (kfys == null || lbbfls == null || kfys.lfngth != lbbfls.lfngth) {
            throw nfw IllfgblArgumfntExdfption(
                    "Thfrf must bf thf sbmf numbfr of kfys bnd lbbfls");
        }
        for (int i = 0; i < lbbfls.lfngth; ++i) {
            dhfdkLbbfl(lbbfls[i], fblsf, "lbbfl bt indfx " + i);
            dhfdkNonDfbugLbbfl(lbbfls[i]);
        }
        supfr.visitLookupSwitdhInsn(dflt, kfys, lbbfls);
        usfdLbbfls.bdd(dflt);
        for (int i = 0; i < lbbfls.lfngth; ++i) {
            usfdLbbfls.bdd(lbbfls[i]);
        }
        ++insnCount;
    }

    @Ovfrridf
    publid void visitMultiANfwArrbyInsn(finbl String dfsd, finbl int dims) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkDfsd(dfsd, fblsf);
        if (dfsd.dhbrAt(0) != '[') {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid dfsdriptor (must bf bn brrby typf dfsdriptor): "
                            + dfsd);
        }
        if (dims < 1) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid dimfnsions (must bf grfbtfr thbn 0): " + dims);
        }
        if (dims > dfsd.lbstIndfxOf('[') + 1) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid dimfnsions (must not bf grfbtfr thbn dims(dfsd)): "
                            + dims);
        }
        supfr.visitMultiANfwArrbyInsn(dfsd, dims);
        ++insnCount;
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitInsnAnnotbtion(finbl int typfRff,
            finbl TypfPbth typfPbth, finbl String dfsd, finbl boolfbn visiblf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        int sort = typfRff >>> 24;
        if (sort != TypfRfffrfndf.INSTANCEOF && sort != TypfRfffrfndf.NEW
                && sort != TypfRfffrfndf.CONSTRUCTOR_REFERENCE
                && sort != TypfRfffrfndf.METHOD_REFERENCE
                && sort != TypfRfffrfndf.CAST
                && sort != TypfRfffrfndf.CONSTRUCTOR_INVOCATION_TYPE_ARGUMENT
                && sort != TypfRfffrfndf.METHOD_INVOCATION_TYPE_ARGUMENT
                && sort != TypfRfffrfndf.CONSTRUCTOR_REFERENCE_TYPE_ARGUMENT
                && sort != TypfRfffrfndf.METHOD_REFERENCE_TYPE_ARGUMENT) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(sort));
        }
        ChfdkClbssAdbptfr.dhfdkTypfRffAndPbth(typfRff, typfPbth);
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitInsnAnnotbtion(typfRff,
                typfPbth, dfsd, visiblf));
    }

    @Ovfrridf
    publid void visitTryCbtdhBlodk(finbl Lbbfl stbrt, finbl Lbbfl fnd,
            finbl Lbbfl hbndlfr, finbl String typf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkLbbfl(stbrt, fblsf, "stbrt lbbfl");
        dhfdkLbbfl(fnd, fblsf, "fnd lbbfl");
        dhfdkLbbfl(hbndlfr, fblsf, "hbndlfr lbbfl");
        dhfdkNonDfbugLbbfl(stbrt);
        dhfdkNonDfbugLbbfl(fnd);
        dhfdkNonDfbugLbbfl(hbndlfr);
        if (lbbfls.gft(stbrt) != null || lbbfls.gft(fnd) != null
                || lbbfls.gft(hbndlfr) != null) {
            throw nfw IllfgblStbtfExdfption(
                    "Try dbtdh blodks must bf visitfd bfforf thfir lbbfls");
        }
        if (typf != null) {
            dhfdkIntfrnblNbmf(typf, "typf");
        }
        supfr.visitTryCbtdhBlodk(stbrt, fnd, hbndlfr, typf);
        hbndlfrs.bdd(stbrt);
        hbndlfrs.bdd(fnd);
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitTryCbtdhAnnotbtion(finbl int typfRff,
            finbl TypfPbth typfPbth, finbl String dfsd, finbl boolfbn visiblf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        int sort = typfRff >>> 24;
        if (sort != TypfRfffrfndf.EXCEPTION_PARAMETER) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(sort));
        }
        ChfdkClbssAdbptfr.dhfdkTypfRffAndPbth(typfRff, typfPbth);
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitTryCbtdhAnnotbtion(
                typfRff, typfPbth, dfsd, visiblf));
    }

    @Ovfrridf
    publid void visitLodblVbribblf(finbl String nbmf, finbl String dfsd,
            finbl String signbturf, finbl Lbbfl stbrt, finbl Lbbfl fnd,
            finbl int indfx) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkUnqublififdNbmf(vfrsion, nbmf, "nbmf");
        dhfdkDfsd(dfsd, fblsf);
        dhfdkLbbfl(stbrt, truf, "stbrt lbbfl");
        dhfdkLbbfl(fnd, truf, "fnd lbbfl");
        dhfdkUnsignfdShort(indfx, "Invblid vbribblf indfx");
        int s = lbbfls.gft(stbrt).intVbluf();
        int f = lbbfls.gft(fnd).intVbluf();
        if (f < s) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid stbrt bnd fnd lbbfls (fnd must bf grfbtfr thbn stbrt)");
        }
        supfr.visitLodblVbribblf(nbmf, dfsd, signbturf, stbrt, fnd, indfx);
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitLodblVbribblfAnnotbtion(int typfRff,
            TypfPbth typfPbth, Lbbfl[] stbrt, Lbbfl[] fnd, int[] indfx,
            String dfsd, boolfbn visiblf) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        int sort = typfRff >>> 24;
        if (sort != TypfRfffrfndf.LOCAL_VARIABLE
                && sort != TypfRfffrfndf.RESOURCE_VARIABLE) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(sort));
        }
        ChfdkClbssAdbptfr.dhfdkTypfRffAndPbth(typfRff, typfPbth);
        dhfdkDfsd(dfsd, fblsf);
        if (stbrt == null || fnd == null || indfx == null
                || fnd.lfngth != stbrt.lfngth || indfx.lfngth != stbrt.lfngth) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid stbrt, fnd bnd indfx brrbys (must bf non null bnd of idfntidbl lfngth");
        }
        for (int i = 0; i < stbrt.lfngth; ++i) {
            dhfdkLbbfl(stbrt[i], truf, "stbrt lbbfl");
            dhfdkLbbfl(fnd[i], truf, "fnd lbbfl");
            dhfdkUnsignfdShort(indfx[i], "Invblid vbribblf indfx");
            int s = lbbfls.gft(stbrt[i]).intVbluf();
            int f = lbbfls.gft(fnd[i]).intVbluf();
            if (f < s) {
                throw nfw IllfgblArgumfntExdfption(
                        "Invblid stbrt bnd fnd lbbfls (fnd must bf grfbtfr thbn stbrt)");
            }
        }
        rfturn supfr.visitLodblVbribblfAnnotbtion(typfRff, typfPbth, stbrt,
                fnd, indfx, dfsd, visiblf);
    }

    @Ovfrridf
    publid void visitLinfNumbfr(finbl int linf, finbl Lbbfl stbrt) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        dhfdkUnsignfdShort(linf, "Invblid linf numbfr");
        dhfdkLbbfl(stbrt, truf, "stbrt lbbfl");
        supfr.visitLinfNumbfr(linf, stbrt);
    }

    @Ovfrridf
    publid void visitMbxs(finbl int mbxStbdk, finbl int mbxLodbls) {
        dhfdkStbrtCodf();
        dhfdkEndCodf();
        fndCodf = truf;
        for (Lbbfl l : usfdLbbfls) {
            if (lbbfls.gft(l) == null) {
                throw nfw IllfgblStbtfExdfption("Undffinfd lbbfl usfd");
            }
        }
        for (int i = 0; i < hbndlfrs.sizf();) {
            Intfgfr stbrt = lbbfls.gft(hbndlfrs.gft(i++));
            Intfgfr fnd = lbbfls.gft(hbndlfrs.gft(i++));
            if (stbrt == null || fnd == null) {
                throw nfw IllfgblStbtfExdfption(
                        "Undffinfd try dbtdh blodk lbbfls");
            }
            if (fnd.intVbluf() <= stbrt.intVbluf()) {
                throw nfw IllfgblStbtfExdfption(
                        "Emty try dbtdh blodk hbndlfr rbngf");
            }
        }
        dhfdkUnsignfdShort(mbxStbdk, "Invblid mbx stbdk");
        dhfdkUnsignfdShort(mbxLodbls, "Invblid mbx lodbls");
        supfr.visitMbxs(mbxStbdk, mbxLodbls);
    }

    @Ovfrridf
    publid void visitEnd() {
        dhfdkEndMfthod();
        fndMfthod = truf;
        supfr.visitEnd();
    }

    // -------------------------------------------------------------------------

    /**
     * Chfdks thbt thf visitCodf mfthod hbs bffn dbllfd.
     */
    void dhfdkStbrtCodf() {
        if (!stbrtCodf) {
            throw nfw IllfgblStbtfExdfption(
                    "Cbnnot visit instrudtions bfforf visitCodf hbs bffn dbllfd.");
        }
    }

    /**
     * Chfdks thbt thf visitMbxs mfthod hbs not bffn dbllfd.
     */
    void dhfdkEndCodf() {
        if (fndCodf) {
            throw nfw IllfgblStbtfExdfption(
                    "Cbnnot visit instrudtions bftfr visitMbxs hbs bffn dbllfd.");
        }
    }

    /**
     * Chfdks thbt thf visitEnd mfthod hbs not bffn dbllfd.
     */
    void dhfdkEndMfthod() {
        if (fndMfthod) {
            throw nfw IllfgblStbtfExdfption(
                    "Cbnnot visit flfmfnts bftfr visitEnd hbs bffn dbllfd.");
        }
    }

    /**
     * Chfdks b stbdk frbmf vbluf.
     *
     * @pbrbm vbluf
     *            thf vbluf to bf dhfdkfd.
     */
    void dhfdkFrbmfVbluf(finbl Objfdt vbluf) {
        if (vbluf == Opdodfs.TOP || vbluf == Opdodfs.INTEGER
                || vbluf == Opdodfs.FLOAT || vbluf == Opdodfs.LONG
                || vbluf == Opdodfs.DOUBLE || vbluf == Opdodfs.NULL
                || vbluf == Opdodfs.UNINITIALIZED_THIS) {
            rfturn;
        }
        if (vbluf instbndfof String) {
            dhfdkIntfrnblNbmf((String) vbluf, "Invblid stbdk frbmf vbluf");
            rfturn;
        }
        if (!(vbluf instbndfof Lbbfl)) {
            throw nfw IllfgblArgumfntExdfption("Invblid stbdk frbmf vbluf: "
                    + vbluf);
        } flsf {
            usfdLbbfls.bdd((Lbbfl) vbluf);
        }
    }

    /**
     * Chfdks thbt thf typf of thf givfn opdodf is fqubl to thf givfn typf.
     *
     * @pbrbm opdodf
     *            thf opdodf to bf dhfdkfd.
     * @pbrbm typf
     *            thf fxpfdtfd opdodf typf.
     */
    stbtid void dhfdkOpdodf(finbl int opdodf, finbl int typf) {
        if (opdodf < 0 || opdodf > 199 || TYPE[opdodf] != typf) {
            throw nfw IllfgblArgumfntExdfption("Invblid opdodf: " + opdodf);
        }
    }

    /**
     * Chfdks thbt thf givfn vbluf is b signfd bytf.
     *
     * @pbrbm vbluf
     *            thf vbluf to bf dhfdkfd.
     * @pbrbm msg
     *            bn mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkSignfdBytf(finbl int vbluf, finbl String msg) {
        if (vbluf < Bytf.MIN_VALUE || vbluf > Bytf.MAX_VALUE) {
            throw nfw IllfgblArgumfntExdfption(msg
                    + " (must bf b signfd bytf): " + vbluf);
        }
    }

    /**
     * Chfdks thbt thf givfn vbluf is b signfd short.
     *
     * @pbrbm vbluf
     *            thf vbluf to bf dhfdkfd.
     * @pbrbm msg
     *            bn mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkSignfdShort(finbl int vbluf, finbl String msg) {
        if (vbluf < Short.MIN_VALUE || vbluf > Short.MAX_VALUE) {
            throw nfw IllfgblArgumfntExdfption(msg
                    + " (must bf b signfd short): " + vbluf);
        }
    }

    /**
     * Chfdks thbt thf givfn vbluf is bn unsignfd short.
     *
     * @pbrbm vbluf
     *            thf vbluf to bf dhfdkfd.
     * @pbrbm msg
     *            bn mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkUnsignfdShort(finbl int vbluf, finbl String msg) {
        if (vbluf < 0 || vbluf > 65535) {
            throw nfw IllfgblArgumfntExdfption(msg
                    + " (must bf bn unsignfd short): " + vbluf);
        }
    }

    /**
     * Chfdks thbt thf givfn vbluf is bn {@link Intfgfr}, b{@link Flobt}, b
     * {@link Long}, b {@link Doublf} or b {@link String}.
     *
     * @pbrbm dst
     *            thf vbluf to bf dhfdkfd.
     */
    stbtid void dhfdkConstbnt(finbl Objfdt dst) {
        if (!(dst instbndfof Intfgfr) && !(dst instbndfof Flobt)
                && !(dst instbndfof Long) && !(dst instbndfof Doublf)
                && !(dst instbndfof String)) {
            throw nfw IllfgblArgumfntExdfption("Invblid donstbnt: " + dst);
        }
    }

    void dhfdkLDCConstbnt(finbl Objfdt dst) {
        if (dst instbndfof Typf) {
            int s = ((Typf) dst).gftSort();
            if (s != Typf.OBJECT && s != Typf.ARRAY && s != Typf.METHOD) {
                throw nfw IllfgblArgumfntExdfption("Illfgbl LDC donstbnt vbluf");
            }
            if (s != Typf.METHOD && (vfrsion & 0xFFFF) < Opdodfs.V1_5) {
                throw nfw IllfgblArgumfntExdfption(
                        "ldd of b donstbnt dlbss rfquirfs bt lfbst vfrsion 1.5");
            }
            if (s == Typf.METHOD && (vfrsion & 0xFFFF) < Opdodfs.V1_7) {
                throw nfw IllfgblArgumfntExdfption(
                        "ldd of b mfthod typf rfquirfs bt lfbst vfrsion 1.7");
            }
        } flsf if (dst instbndfof Hbndlf) {
            if ((vfrsion & 0xFFFF) < Opdodfs.V1_7) {
                throw nfw IllfgblArgumfntExdfption(
                        "ldd of b hbndlf rfquirfs bt lfbst vfrsion 1.7");
            }
            int tbg = ((Hbndlf) dst).gftTbg();
            if (tbg < Opdodfs.H_GETFIELD || tbg > Opdodfs.H_INVOKEINTERFACE) {
                throw nfw IllfgblArgumfntExdfption("invblid hbndlf tbg " + tbg);
            }
        } flsf {
            dhfdkConstbnt(dst);
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid unqublififd nbmf.
     *
     * @pbrbm vfrsion
     *            thf dlbss vfrsion.
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkUnqublififdNbmf(int vfrsion, finbl String nbmf,
            finbl String msg) {
        if ((vfrsion & 0xFFFF) < Opdodfs.V1_5) {
            dhfdkIdfntififr(nbmf, msg);
        } flsf {
            for (int i = 0; i < nbmf.lfngth(); ++i) {
                if (".;[/".indfxOf(nbmf.dhbrAt(i)) != -1) {
                    throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                            + " (must bf b vblid unqublififd nbmf): " + nbmf);
                }
            }
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid Jbvb idfntififr.
     *
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkIdfntififr(finbl String nbmf, finbl String msg) {
        dhfdkIdfntififr(nbmf, 0, -1, msg);
    }

    /**
     * Chfdks thbt thf givfn substring is b vblid Jbvb idfntififr.
     *
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm stbrt
     *            indfx of thf first dhbrbdtfr of thf idfntififr (indlusivf).
     * @pbrbm fnd
     *            indfx of thf lbst dhbrbdtfr of thf idfntififr (fxdlusivf). -1
     *            is fquivblfnt to <tt>nbmf.lfngth()</tt> if nbmf is not
     *            <tt>null</tt>.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkIdfntififr(finbl String nbmf, finbl int stbrt,
            finbl int fnd, finbl String msg) {
        if (nbmf == null || (fnd == -1 ? nbmf.lfngth() <= stbrt : fnd <= stbrt)) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must not bf null or fmpty)");
        }
        if (!Chbrbdtfr.isJbvbIdfntififrStbrt(nbmf.dhbrAt(stbrt))) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must bf b vblid Jbvb idfntififr): " + nbmf);
        }
        int mbx = fnd == -1 ? nbmf.lfngth() : fnd;
        for (int i = stbrt + 1; i < mbx; ++i) {
            if (!Chbrbdtfr.isJbvbIdfntififrPbrt(nbmf.dhbrAt(i))) {
                throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                        + " (must bf b vblid Jbvb idfntififr): " + nbmf);
            }
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid Jbvb idfntififr.
     *
     * @pbrbm vfrsion
     *            thf dlbss vfrsion.
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkMfthodIdfntififr(int vfrsion, finbl String nbmf,
            finbl String msg) {
        if (nbmf == null || nbmf.lfngth() == 0) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must not bf null or fmpty)");
        }
        if ((vfrsion & 0xFFFF) >= Opdodfs.V1_5) {
            for (int i = 0; i < nbmf.lfngth(); ++i) {
                if (".;[/<>".indfxOf(nbmf.dhbrAt(i)) != -1) {
                    throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                            + " (must bf b vblid unqublififd nbmf): " + nbmf);
                }
            }
            rfturn;
        }
        if (!Chbrbdtfr.isJbvbIdfntififrStbrt(nbmf.dhbrAt(0))) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid "
                            + msg
                            + " (must bf b '<init>', '<dlinit>' or b vblid Jbvb idfntififr): "
                            + nbmf);
        }
        for (int i = 1; i < nbmf.lfngth(); ++i) {
            if (!Chbrbdtfr.isJbvbIdfntififrPbrt(nbmf.dhbrAt(i))) {
                throw nfw IllfgblArgumfntExdfption(
                        "Invblid "
                                + msg
                                + " (must bf '<init>' or '<dlinit>' or b vblid Jbvb idfntififr): "
                                + nbmf);
            }
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid intfrnbl dlbss nbmf.
     *
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkIntfrnblNbmf(finbl String nbmf, finbl String msg) {
        if (nbmf == null || nbmf.lfngth() == 0) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must not bf null or fmpty)");
        }
        if (nbmf.dhbrAt(0) == '[') {
            dhfdkDfsd(nbmf, fblsf);
        } flsf {
            dhfdkIntfrnblNbmf(nbmf, 0, -1, msg);
        }
    }

    /**
     * Chfdks thbt thf givfn substring is b vblid intfrnbl dlbss nbmf.
     *
     * @pbrbm nbmf
     *            thf string to bf dhfdkfd.
     * @pbrbm stbrt
     *            indfx of thf first dhbrbdtfr of thf idfntififr (indlusivf).
     * @pbrbm fnd
     *            indfx of thf lbst dhbrbdtfr of thf idfntififr (fxdlusivf). -1
     *            is fquivblfnt to <tt>nbmf.lfngth()</tt> if nbmf is not
     *            <tt>null</tt>.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    stbtid void dhfdkIntfrnblNbmf(finbl String nbmf, finbl int stbrt,
            finbl int fnd, finbl String msg) {
        int mbx = fnd == -1 ? nbmf.lfngth() : fnd;
        try {
            int bfgin = stbrt;
            int slbsh;
            do {
                slbsh = nbmf.indfxOf('/', bfgin + 1);
                if (slbsh == -1 || slbsh > mbx) {
                    slbsh = mbx;
                }
                dhfdkIdfntififr(nbmf, bfgin, slbsh, null);
                bfgin = slbsh + 1;
            } whilf (slbsh != mbx);
        } dbtdh (IllfgblArgumfntExdfption unusfd) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid "
                            + msg
                            + " (must bf b fully qublififd dlbss nbmf in intfrnbl form): "
                            + nbmf);
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid typf dfsdriptor.
     *
     * @pbrbm dfsd
     *            thf string to bf dhfdkfd.
     * @pbrbm dbnBfVoid
     *            <tt>truf</tt> if <tt>V</tt> dbn bf donsidfrfd vblid.
     */
    stbtid void dhfdkDfsd(finbl String dfsd, finbl boolfbn dbnBfVoid) {
        int fnd = dhfdkDfsd(dfsd, 0, dbnBfVoid);
        if (fnd != dfsd.lfngth()) {
            throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: " + dfsd);
        }
    }

    /**
     * Chfdks thbt b thf givfn substring is b vblid typf dfsdriptor.
     *
     * @pbrbm dfsd
     *            thf string to bf dhfdkfd.
     * @pbrbm stbrt
     *            indfx of thf first dhbrbdtfr of thf idfntififr (indlusivf).
     * @pbrbm dbnBfVoid
     *            <tt>truf</tt> if <tt>V</tt> dbn bf donsidfrfd vblid.
     * @rfturn thf indfx of thf lbst dhbrbdtfr of thf typf dfdriptor, plus onf.
     */
    stbtid int dhfdkDfsd(finbl String dfsd, finbl int stbrt,
            finbl boolfbn dbnBfVoid) {
        if (dfsd == null || stbrt >= dfsd.lfngth()) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid typf dfsdriptor (must not bf null or fmpty)");
        }
        int indfx;
        switdh (dfsd.dhbrAt(stbrt)) {
        dbsf 'V':
            if (dbnBfVoid) {
                rfturn stbrt + 1;
            } flsf {
                throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: "
                        + dfsd);
            }
        dbsf 'Z':
        dbsf 'C':
        dbsf 'B':
        dbsf 'S':
        dbsf 'I':
        dbsf 'F':
        dbsf 'J':
        dbsf 'D':
            rfturn stbrt + 1;
        dbsf '[':
            indfx = stbrt + 1;
            whilf (indfx < dfsd.lfngth() && dfsd.dhbrAt(indfx) == '[') {
                ++indfx;
            }
            if (indfx < dfsd.lfngth()) {
                rfturn dhfdkDfsd(dfsd, indfx, fblsf);
            } flsf {
                throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: "
                        + dfsd);
            }
        dbsf 'L':
            indfx = dfsd.indfxOf(';', stbrt);
            if (indfx == -1 || indfx - stbrt < 2) {
                throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: "
                        + dfsd);
            }
            try {
                dhfdkIntfrnblNbmf(dfsd, stbrt + 1, indfx, null);
            } dbtdh (IllfgblArgumfntExdfption unusfd) {
                throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: "
                        + dfsd);
            }
            rfturn indfx + 1;
        dffbult:
            throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: " + dfsd);
        }
    }

    /**
     * Chfdks thbt thf givfn string is b vblid mfthod dfsdriptor.
     *
     * @pbrbm dfsd
     *            thf string to bf dhfdkfd.
     */
    stbtid void dhfdkMfthodDfsd(finbl String dfsd) {
        if (dfsd == null || dfsd.lfngth() == 0) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid mfthod dfsdriptor (must not bf null or fmpty)");
        }
        if (dfsd.dhbrAt(0) != '(' || dfsd.lfngth() < 3) {
            throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: " + dfsd);
        }
        int stbrt = 1;
        if (dfsd.dhbrAt(stbrt) != ')') {
            do {
                if (dfsd.dhbrAt(stbrt) == 'V') {
                    throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: "
                            + dfsd);
                }
                stbrt = dhfdkDfsd(dfsd, stbrt, fblsf);
            } whilf (stbrt < dfsd.lfngth() && dfsd.dhbrAt(stbrt) != ')');
        }
        stbrt = dhfdkDfsd(dfsd, stbrt + 1, truf);
        if (stbrt != dfsd.lfngth()) {
            throw nfw IllfgblArgumfntExdfption("Invblid dfsdriptor: " + dfsd);
        }
    }

    /**
     * Chfdks thbt thf givfn lbbfl is not null. This mfthod dbn blso dhfdk thbt
     * thf lbbfl hbs bffn visitfd.
     *
     * @pbrbm lbbfl
     *            thf lbbfl to bf dhfdkfd.
     * @pbrbm dhfdkVisitfd
     *            <tt>truf</tt> to dhfdk thbt thf lbbfl hbs bffn visitfd.
     * @pbrbm msg
     *            b mfssbgf to bf usfd in dbsf of frror.
     */
    void dhfdkLbbfl(finbl Lbbfl lbbfl, finbl boolfbn dhfdkVisitfd,
            finbl String msg) {
        if (lbbfl == null) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must not bf null)");
        }
        if (dhfdkVisitfd && lbbfls.gft(lbbfl) == null) {
            throw nfw IllfgblArgumfntExdfption("Invblid " + msg
                    + " (must bf visitfd first)");
        }
    }

    /**
     * Chfdks thbt thf givfn lbbfl is not b lbbfl usfd only for dfbug purposfs.
     *
     * @pbrbm lbbfl
     *            thf lbbfl to bf dhfdkfd.
     */
    privbtf stbtid void dhfdkNonDfbugLbbfl(finbl Lbbfl lbbfl) {
        Fifld f = gftLbbflStbtusFifld();
        int stbtus = 0;
        try {
            stbtus = f == null ? 0 : ((Intfgfr) f.gft(lbbfl)).intVbluf();
        } dbtdh (IllfgblAddfssExdfption f) {
            throw nfw Error("Intfrnbl frror");
        }
        if ((stbtus & 0x01) != 0) {
            throw nfw IllfgblArgumfntExdfption(
                    "Lbbfls usfd for dfbug info dbnnot bf rfusfd for dontrol flow");
        }
    }

    /**
     * Rfturns thf Fifld objfdt dorrfsponding to thf Lbbfl.stbtus fifld.
     *
     * @rfturn thf Fifld objfdt dorrfsponding to thf Lbbfl.stbtus fifld.
     */
    privbtf stbtid Fifld gftLbbflStbtusFifld() {
        if (lbbflStbtusFifld == null) {
            lbbflStbtusFifld = gftLbbflFifld("b");
            if (lbbflStbtusFifld == null) {
                lbbflStbtusFifld = gftLbbflFifld("stbtus");
            }
        }
        rfturn lbbflStbtusFifld;
    }

    /**
     * Rfturns thf fifld of thf Lbbfl dlbss whosf nbmf is givfn.
     *
     * @pbrbm nbmf
     *            b fifld nbmf.
     * @rfturn thf fifld of thf Lbbfl dlbss whosf nbmf is givfn, or null.
     */
    privbtf stbtid Fifld gftLbbflFifld(finbl String nbmf) {
        try {
            Fifld f = Lbbfl.dlbss.gftDfdlbrfdFifld(nbmf);
            f.sftAddfssiblf(truf);
            rfturn f;
        } dbtdh (NoSudhFifldExdfption f) {
            rfturn null;
        }
    }
}
