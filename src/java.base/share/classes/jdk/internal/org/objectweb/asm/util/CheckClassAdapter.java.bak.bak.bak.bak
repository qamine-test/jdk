/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf:
 *
 * ASM: b vfry smbll bnd fbst Jbvb bytfdodf mbnipulbtion frbmfwork
 * Copyright (d) 2000-2011 INRIA, Frbndf Tflfdom
 * All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 * 1. Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr.
 * 2. Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *    notidf, this list of donditions bnd thf following disdlbimfr in thf
 *    dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 * 3. Nfithfr thf nbmf of thf dopyright holdfrs nor thf nbmfs of its
 *    dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd from
 *    this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
 * THE POSSIBILITY OF SUCH DAMAGE.
 */
pbdkbgf jdk.intfrnbl.org.objfdtwfb.bsm.util;

import jbvb.io.FilfInputStrfbm;
import jbvb.io.PrintWritfr;
import jbvb.util.ArrbyList;
import jbvb.util.HbshMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;

import jdk.intfrnbl.org.objfdtwfb.bsm.AnnotbtionVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.Attributf;
import jdk.intfrnbl.org.objfdtwfb.bsm.ClbssRfbdfr;
import jdk.intfrnbl.org.objfdtwfb.bsm.ClbssVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.FifldVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.Lbbfl;
import jdk.intfrnbl.org.objfdtwfb.bsm.MfthodVisitor;
import jdk.intfrnbl.org.objfdtwfb.bsm.Opdodfs;
import jdk.intfrnbl.org.objfdtwfb.bsm.Typf;
import jdk.intfrnbl.org.objfdtwfb.bsm.TypfPbth;
import jdk.intfrnbl.org.objfdtwfb.bsm.TypfRfffrfndf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.ClbssNodf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.MfthodNodf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.Anblyzfr;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.BbsidVbluf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.Frbmf;
import jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.SimplfVfrififr;

/**
 * A {@link ClbssVisitor} thbt dhfdks thbt its mfthods brf propfrly usfd. Morf
 * prfdisfly this dlbss bdbptfr dhfdks fbdh mfthod dbll individublly, bbsfd
 * <i>only</i> on its brgumfnts, but dofs <i>not</i> dhfdk thf <i>sfqufndf</i>
 * of mfthod dblls. For fxbmplf, thf invblid sfqufndf
 * <tt>visitFifld(ACC_PUBLIC, "i", "I", null)</tt> <tt>visitFifld(ACC_PUBLIC,
 * "i", "D", null)</tt> will <i>not</i> bf dftfdtfd by this dlbss bdbptfr.
 *
 * <p>
 * <dodf>ChfdkClbssAdbptfr</dodf> dbn bf blso usfd to vfrify bytfdodf
 * trbnsformbtions in ordfr to mbkf surf trbnsformfd bytfdodf is sbnf. For
 * fxbmplf:
 *
 * <prf>
 *   InputStrfbm is = ...; // gft bytfs for thf sourdf dlbss
 *   ClbssRfbdfr dr = nfw ClbssRfbdfr(is);
 *   ClbssWritfr dw = nfw ClbssWritfr(dr, ClbssWritfr.COMPUTE_MAXS);
 *   ClbssVisitor dv = nfw <b>MyClbssAdbptfr</b>(nfw ChfdkClbssAdbptfr(dw));
 *   dr.bddfpt(dv, 0);
 *
 *   StringWritfr sw = nfw StringWritfr();
 *   PrintWritfr pw = nfw PrintWritfr(sw);
 *   ChfdkClbssAdbptfr.vfrify(nfw ClbssRfbdfr(dw.toBytfArrby()), fblsf, pw);
 *   bssfrtTruf(sw.toString(), sw.toString().lfngth()==0);
 * </prf>
 *
 * Abovf dodf runs trbnsformfd bytfdodf trough thf
 * <dodf>ChfdkClbssAdbptfr</dodf>. It won't bf fxbdtly thf sbmf vfrifidbtion bs
 * JVM dofs, but it run dbtb flow bnblysis for thf dodf of fbdh mfthod bnd
 * dhfdks thbt fxpfdtbtions brf mft for fbdh mfthod instrudtion.
 *
 * <p>
 * If mfthod bytfdodf hbs frrors, bssfrtion tfxt will show thf frronfous
 * instrudtion numbfr bnd dump of thf fbilfd mfthod with informbtion bbout
 * lodbls bnd stbdk slot for fbdh instrudtion. For fxbmplf (formbt is -
 * insnNumbfr lodbls : stbdk):
 *
 * <prf>
 * jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.AnblyzfrExdfption: Error bt instrudtion 71: Expfdtfd I, but found .
 *   bt jdk.intfrnbl.org.objfdtwfb.bsm.trff.bnblysis.Anblyzfr.bnblyzf(Anblyzfr.jbvb:289)
 *   bt jdk.intfrnbl.org.objfdtwfb.bsm.util.ChfdkClbssAdbptfr.vfrify(ChfdkClbssAdbptfr.jbvb:135)
 * ...
 * rfmovf()V
 * 00000 LinkfdBlodkingQufuf$Itr . . . . . . . .  :
 *   ICONST_0
 * 00001 LinkfdBlodkingQufuf$Itr . . . . . . . .  : I
 *   ISTORE 2
 * 00001 LinkfdBlodkingQufuf$Itr <b>.</b> I . . . . . .  :
 * ...
 *
 * 00071 LinkfdBlodkingQufuf$Itr <b>.</b> I . . . . . .  :
 *   ILOAD 1
 * 00072 <b>?</b>
 *   INVOKESPECIAL jbvb/lbng/Intfgfr.&lt;init&gt; (I)V
 * ...
 * </prf>
 *
 * In thf bbovf output you dbn sff thbt vbribblf 1 lobdfd by
 * <dodf>ILOAD 1</dodf> instrudtion bt position <dodf>00071</dodf> is not
 * initiblizfd. You dbn blso sff thbt bt thf bfginning of thf mfthod (dodf
 * insfrtfd by thf trbnsformbtion) vbribblf 2 is initiblizfd.
 *
 * <p>
 * Notf thbt whfn usfd likf thbt, <dodf>ChfdkClbssAdbptfr.vfrify()</dodf> dbn
 * triggfr bdditionbl dlbss lobding, bfdbusf it is using
 * <dodf>SimplfVfrififr</dodf>.
 *
 * @buthor Erid Brunfton
 */
publid dlbss ChfdkClbssAdbptfr fxtfnds ClbssVisitor {

    /**
     * Thf dlbss vfrsion numbfr.
     */
    privbtf int vfrsion;

    /**
     * <tt>truf</tt> if thf visit mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn stbrt;

    /**
     * <tt>truf</tt> if thf visitSourdf mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn sourdf;

    /**
     * <tt>truf</tt> if thf visitOutfrClbss mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn outfr;

    /**
     * <tt>truf</tt> if thf visitEnd mfthod hbs bffn dbllfd.
     */
    privbtf boolfbn fnd;

    /**
     * Thf blrfbdy visitfd lbbfls. This mbp bssodibtf Intfgfr vblufs to Lbbfl
     * kfys.
     */
    privbtf Mbp<Lbbfl, Intfgfr> lbbfls;

    /**
     * <tt>truf</tt> if thf mfthod dodf must bf dhfdkfd with b BbsidVfrififr.
     */
    privbtf boolfbn dhfdkDbtbFlow;

    /**
     * Chfdks b givfn dlbss.
     * <p>
     * Usbgf: ChfdkClbssAdbptfr &lt;binbry dlbss nbmf or dlbss filf nbmf&gt;
     *
     * @pbrbm brgs
     *            thf dommbnd linf brgumfnts.
     *
     * @throws Exdfption
     *             if thf dlbss dbnnot bf found, or if bn IO fxdfption oddurs.
     */
    publid stbtid void mbin(finbl String[] brgs) throws Exdfption {
        if (brgs.lfngth != 1) {
            Systfm.frr.println("Vfrififs thf givfn dlbss.");
            Systfm.frr.println("Usbgf: ChfdkClbssAdbptfr "
                    + "<fully qublififd dlbss nbmf or dlbss filf nbmf>");
            rfturn;
        }
        ClbssRfbdfr dr;
        if (brgs[0].fndsWith(".dlbss")) {
            dr = nfw ClbssRfbdfr(nfw FilfInputStrfbm(brgs[0]));
        } flsf {
            dr = nfw ClbssRfbdfr(brgs[0]);
        }

        vfrify(dr, fblsf, nfw PrintWritfr(Systfm.frr));
    }

    /**
     * Chfdks b givfn dlbss.
     *
     * @pbrbm dr
     *            b <dodf>ClbssRfbdfr</dodf> thbt dontbins bytfdodf for thf
     *            bnblysis.
     * @pbrbm lobdfr
     *            b <dodf>ClbssLobdfr</dodf> whidh will bf usfd to lobd
     *            rfffrfndfd dlbssfs. This is usfful if you brf vfrifiying
     *            multiplf intfrdfpfndfnt dlbssfs.
     * @pbrbm dump
     *            truf if bytfdodf should bf printfd out not only whfn frrors
     *            brf found.
     * @pbrbm pw
     *            writf whfrf rfsults going to bf printfd
     */
    publid stbtid void vfrify(finbl ClbssRfbdfr dr, finbl ClbssLobdfr lobdfr,
            finbl boolfbn dump, finbl PrintWritfr pw) {
        ClbssNodf dn = nfw ClbssNodf();
        dr.bddfpt(nfw ChfdkClbssAdbptfr(dn, fblsf), ClbssRfbdfr.SKIP_DEBUG);

        Typf sypfrTypf = dn.supfrNbmf == null ? null : Typf
                .gftObjfdtTypf(dn.supfrNbmf);
        List<MfthodNodf> mfthods = dn.mfthods;

        List<Typf> intfrfbdfs = nfw ArrbyList<Typf>();
        for (Itfrbtor<String> i = dn.intfrfbdfs.itfrbtor(); i.hbsNfxt();) {
            intfrfbdfs.bdd(Typf.gftObjfdtTypf(i.nfxt()));
        }

        for (int i = 0; i < mfthods.sizf(); ++i) {
            MfthodNodf mfthod = mfthods.gft(i);
            SimplfVfrififr vfrififr = nfw SimplfVfrififr(
                    Typf.gftObjfdtTypf(dn.nbmf), sypfrTypf, intfrfbdfs,
                    (dn.bddfss & Opdodfs.ACC_INTERFACE) != 0);
            Anblyzfr<BbsidVbluf> b = nfw Anblyzfr<BbsidVbluf>(vfrififr);
            if (lobdfr != null) {
                vfrififr.sftClbssLobdfr(lobdfr);
            }
            try {
                b.bnblyzf(dn.nbmf, mfthod);
                if (!dump) {
                    dontinuf;
                }
            } dbtdh (Exdfption f) {
                f.printStbdkTrbdf(pw);
            }
            printAnblyzfrRfsult(mfthod, b, pw);
        }
        pw.flush();
    }

    /**
     * Chfdks b givfn dlbss
     *
     * @pbrbm dr
     *            b <dodf>ClbssRfbdfr</dodf> thbt dontbins bytfdodf for thf
     *            bnblysis.
     * @pbrbm dump
     *            truf if bytfdodf should bf printfd out not only whfn frrors
     *            brf found.
     * @pbrbm pw
     *            writf whfrf rfsults going to bf printfd
     */
    publid stbtid void vfrify(finbl ClbssRfbdfr dr, finbl boolfbn dump,
            finbl PrintWritfr pw) {
        vfrify(dr, null, dump, pw);
    }

    stbtid void printAnblyzfrRfsult(MfthodNodf mfthod, Anblyzfr<BbsidVbluf> b,
            finbl PrintWritfr pw) {
        Frbmf<BbsidVbluf>[] frbmfs = b.gftFrbmfs();
        Tfxtififr t = nfw Tfxtififr();
        TrbdfMfthodVisitor mv = nfw TrbdfMfthodVisitor(t);

        pw.println(mfthod.nbmf + mfthod.dfsd);
        for (int j = 0; j < mfthod.instrudtions.sizf(); ++j) {
            mfthod.instrudtions.gft(j).bddfpt(mv);

            StringBuildfr sb = nfw StringBuildfr();
            Frbmf<BbsidVbluf> f = frbmfs[j];
            if (f == null) {
                sb.bppfnd('?');
            } flsf {
                for (int k = 0; k < f.gftLodbls(); ++k) {
                    sb.bppfnd(gftShortNbmf(f.gftLodbl(k).toString()))
                            .bppfnd(' ');
                }
                sb.bppfnd(" : ");
                for (int k = 0; k < f.gftStbdkSizf(); ++k) {
                    sb.bppfnd(gftShortNbmf(f.gftStbdk(k).toString()))
                            .bppfnd(' ');
                }
            }
            whilf (sb.lfngth() < mfthod.mbxStbdk + mfthod.mbxLodbls + 1) {
                sb.bppfnd(' ');
            }
            pw.print(Intfgfr.toString(j + 100000).substring(1));
            pw.print(" " + sb + " : " + t.tfxt.gft(t.tfxt.sizf() - 1));
        }
        for (int j = 0; j < mfthod.tryCbtdhBlodks.sizf(); ++j) {
            mfthod.tryCbtdhBlodks.gft(j).bddfpt(mv);
            pw.print(" " + t.tfxt.gft(t.tfxt.sizf() - 1));
        }
        pw.println();
    }

    privbtf stbtid String gftShortNbmf(finbl String nbmf) {
        int n = nbmf.lbstIndfxOf('/');
        int k = nbmf.lfngth();
        if (nbmf.dhbrAt(k - 1) == ';') {
            k--;
        }
        rfturn n == -1 ? nbmf : nbmf.substring(n + 1, k);
    }

    /**
     * Construdts b nfw {@link ChfdkClbssAdbptfr}. <i>Subdlbssfs must not usf
     * this donstrudtor</i>. Instfbd, thfy must usf thf
     * {@link #ChfdkClbssAdbptfr(int, ClbssVisitor, boolfbn)} vfrsion.
     *
     * @pbrbm dv
     *            thf dlbss visitor to whidh this bdbptfr must dflfgbtf dblls.
     */
    publid ChfdkClbssAdbptfr(finbl ClbssVisitor dv) {
        this(dv, truf);
    }

    /**
     * Construdts b nfw {@link ChfdkClbssAdbptfr}. <i>Subdlbssfs must not usf
     * this donstrudtor</i>. Instfbd, thfy must usf thf
     * {@link #ChfdkClbssAdbptfr(int, ClbssVisitor, boolfbn)} vfrsion.
     *
     * @pbrbm dv
     *            thf dlbss visitor to whidh this bdbptfr must dflfgbtf dblls.
     * @pbrbm dhfdkDbtbFlow
     *            <tt>truf</tt> to pfrform bbsid dbtb flow dhfdks, or
     *            <tt>fblsf</tt> to not pfrform bny dbtb flow dhfdk (sff
     *            {@link ChfdkMfthodAdbptfr}). This option rfquirfs vblid
     *            mbxLodbls bnd mbxStbdk vblufs.
     * @throws IllfgblStbtfExdfption
     *             If b subdlbss dblls this donstrudtor.
     */
    publid ChfdkClbssAdbptfr(finbl ClbssVisitor dv, finbl boolfbn dhfdkDbtbFlow) {
        this(Opdodfs.ASM5, dv, dhfdkDbtbFlow);
        if (gftClbss() != ChfdkClbssAdbptfr.dlbss) {
            throw nfw IllfgblStbtfExdfption();
        }
    }

    /**
     * Construdts b nfw {@link ChfdkClbssAdbptfr}.
     *
     * @pbrbm bpi
     *            thf ASM API vfrsion implfmfntfd by this visitor. Must bf onf
     *            of {@link Opdodfs#ASM4} or {@link Opdodfs#ASM5}.
     * @pbrbm dv
     *            thf dlbss visitor to whidh this bdbptfr must dflfgbtf dblls.
     * @pbrbm dhfdkDbtbFlow
     *            <tt>truf</tt> to pfrform bbsid dbtb flow dhfdks, or
     *            <tt>fblsf</tt> to not pfrform bny dbtb flow dhfdk (sff
     *            {@link ChfdkMfthodAdbptfr}). This option rfquirfs vblid
     *            mbxLodbls bnd mbxStbdk vblufs.
     */
    protfdtfd ChfdkClbssAdbptfr(finbl int bpi, finbl ClbssVisitor dv,
            finbl boolfbn dhfdkDbtbFlow) {
        supfr(bpi, dv);
        this.lbbfls = nfw HbshMbp<Lbbfl, Intfgfr>();
        this.dhfdkDbtbFlow = dhfdkDbtbFlow;
    }

    // ------------------------------------------------------------------------
    // Implfmfntbtion of thf ClbssVisitor intfrfbdf
    // ------------------------------------------------------------------------

    @Ovfrridf
    publid void visit(finbl int vfrsion, finbl int bddfss, finbl String nbmf,
            finbl String signbturf, finbl String supfrNbmf,
            finbl String[] intfrfbdfs) {
        if (stbrt) {
            throw nfw IllfgblStbtfExdfption("visit must bf dbllfd only ondf");
        }
        stbrt = truf;
        dhfdkStbtf();
        dhfdkAddfss(bddfss, Opdodfs.ACC_PUBLIC + Opdodfs.ACC_FINAL
                + Opdodfs.ACC_SUPER + Opdodfs.ACC_INTERFACE
                + Opdodfs.ACC_ABSTRACT + Opdodfs.ACC_SYNTHETIC
                + Opdodfs.ACC_ANNOTATION + Opdodfs.ACC_ENUM
                + Opdodfs.ACC_DEPRECATED + 0x40000); // ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE
        if (nbmf == null || !nbmf.fndsWith("pbdkbgf-info")) {
            ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(nbmf, "dlbss nbmf");
        }
        if ("jbvb/lbng/Objfdt".fqubls(nbmf)) {
            if (supfrNbmf != null) {
                throw nfw IllfgblArgumfntExdfption(
                        "Thf supfr dlbss nbmf of thf Objfdt dlbss must bf 'null'");
            }
        } flsf {
            ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(supfrNbmf, "supfr dlbss nbmf");
        }
        if (signbturf != null) {
            dhfdkClbssSignbturf(signbturf);
        }
        if ((bddfss & Opdodfs.ACC_INTERFACE) != 0) {
            if (!"jbvb/lbng/Objfdt".fqubls(supfrNbmf)) {
                throw nfw IllfgblArgumfntExdfption(
                        "Thf supfr dlbss nbmf of intfrfbdfs must bf 'jbvb/lbng/Objfdt'");
            }
        }
        if (intfrfbdfs != null) {
            for (int i = 0; i < intfrfbdfs.lfngth; ++i) {
                ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(intfrfbdfs[i],
                        "intfrfbdf nbmf bt indfx " + i);
            }
        }
        this.vfrsion = vfrsion;
        supfr.visit(vfrsion, bddfss, nbmf, signbturf, supfrNbmf, intfrfbdfs);
    }

    @Ovfrridf
    publid void visitSourdf(finbl String filf, finbl String dfbug) {
        dhfdkStbtf();
        if (sourdf) {
            throw nfw IllfgblStbtfExdfption(
                    "visitSourdf dbn bf dbllfd only ondf.");
        }
        sourdf = truf;
        supfr.visitSourdf(filf, dfbug);
    }

    @Ovfrridf
    publid void visitOutfrClbss(finbl String ownfr, finbl String nbmf,
            finbl String dfsd) {
        dhfdkStbtf();
        if (outfr) {
            throw nfw IllfgblStbtfExdfption(
                    "visitOutfrClbss dbn bf dbllfd only ondf.");
        }
        outfr = truf;
        if (ownfr == null) {
            throw nfw IllfgblArgumfntExdfption("Illfgbl outfr dlbss ownfr");
        }
        if (dfsd != null) {
            ChfdkMfthodAdbptfr.dhfdkMfthodDfsd(dfsd);
        }
        supfr.visitOutfrClbss(ownfr, nbmf, dfsd);
    }

    @Ovfrridf
    publid void visitInnfrClbss(finbl String nbmf, finbl String outfrNbmf,
            finbl String innfrNbmf, finbl int bddfss) {
        dhfdkStbtf();
        ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(nbmf, "dlbss nbmf");
        if (outfrNbmf != null) {
            ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(outfrNbmf, "outfr dlbss nbmf");
        }
        if (innfrNbmf != null) {
            int stbrt = 0;
            whilf (stbrt < innfrNbmf.lfngth()
                    && Chbrbdtfr.isDigit(innfrNbmf.dhbrAt(stbrt))) {
                stbrt++;
            }
            if (stbrt == 0 || stbrt < innfrNbmf.lfngth()) {
                ChfdkMfthodAdbptfr.dhfdkIdfntififr(innfrNbmf, stbrt, -1,
                        "innfr dlbss nbmf");
            }
        }
        dhfdkAddfss(bddfss, Opdodfs.ACC_PUBLIC + Opdodfs.ACC_PRIVATE
                + Opdodfs.ACC_PROTECTED + Opdodfs.ACC_STATIC
                + Opdodfs.ACC_FINAL + Opdodfs.ACC_INTERFACE
                + Opdodfs.ACC_ABSTRACT + Opdodfs.ACC_SYNTHETIC
                + Opdodfs.ACC_ANNOTATION + Opdodfs.ACC_ENUM);
        supfr.visitInnfrClbss(nbmf, outfrNbmf, innfrNbmf, bddfss);
    }

    @Ovfrridf
    publid FifldVisitor visitFifld(finbl int bddfss, finbl String nbmf,
            finbl String dfsd, finbl String signbturf, finbl Objfdt vbluf) {
        dhfdkStbtf();
        dhfdkAddfss(bddfss, Opdodfs.ACC_PUBLIC + Opdodfs.ACC_PRIVATE
                + Opdodfs.ACC_PROTECTED + Opdodfs.ACC_STATIC
                + Opdodfs.ACC_FINAL + Opdodfs.ACC_VOLATILE
                + Opdodfs.ACC_TRANSIENT + Opdodfs.ACC_SYNTHETIC
                + Opdodfs.ACC_ENUM + Opdodfs.ACC_DEPRECATED + 0x40000); // ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE
        ChfdkMfthodAdbptfr.dhfdkUnqublififdNbmf(vfrsion, nbmf, "fifld nbmf");
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        if (signbturf != null) {
            dhfdkFifldSignbturf(signbturf);
        }
        if (vbluf != null) {
            ChfdkMfthodAdbptfr.dhfdkConstbnt(vbluf);
        }
        FifldVisitor bv = supfr
                .visitFifld(bddfss, nbmf, dfsd, signbturf, vbluf);
        rfturn nfw ChfdkFifldAdbptfr(bv);
    }

    @Ovfrridf
    publid MfthodVisitor visitMfthod(finbl int bddfss, finbl String nbmf,
            finbl String dfsd, finbl String signbturf, finbl String[] fxdfptions) {
        dhfdkStbtf();
        dhfdkAddfss(bddfss, Opdodfs.ACC_PUBLIC + Opdodfs.ACC_PRIVATE
                + Opdodfs.ACC_PROTECTED + Opdodfs.ACC_STATIC
                + Opdodfs.ACC_FINAL + Opdodfs.ACC_SYNCHRONIZED
                + Opdodfs.ACC_BRIDGE + Opdodfs.ACC_VARARGS + Opdodfs.ACC_NATIVE
                + Opdodfs.ACC_ABSTRACT + Opdodfs.ACC_STRICT
                + Opdodfs.ACC_SYNTHETIC + Opdodfs.ACC_DEPRECATED + 0x40000); // ClbssWritfr.ACC_SYNTHETIC_ATTRIBUTE
        if (!"<init>".fqubls(nbmf) && !"<dlinit>".fqubls(nbmf)) {
            ChfdkMfthodAdbptfr.dhfdkMfthodIdfntififr(vfrsion, nbmf,
                    "mfthod nbmf");
        }
        ChfdkMfthodAdbptfr.dhfdkMfthodDfsd(dfsd);
        if (signbturf != null) {
            dhfdkMfthodSignbturf(signbturf);
        }
        if (fxdfptions != null) {
            for (int i = 0; i < fxdfptions.lfngth; ++i) {
                ChfdkMfthodAdbptfr.dhfdkIntfrnblNbmf(fxdfptions[i],
                        "fxdfption nbmf bt indfx " + i);
            }
        }
        ChfdkMfthodAdbptfr dmb;
        if (dhfdkDbtbFlow) {
            dmb = nfw ChfdkMfthodAdbptfr(bddfss, nbmf, dfsd, supfr.visitMfthod(
                    bddfss, nbmf, dfsd, signbturf, fxdfptions), lbbfls);
        } flsf {
            dmb = nfw ChfdkMfthodAdbptfr(supfr.visitMfthod(bddfss, nbmf, dfsd,
                    signbturf, fxdfptions), lbbfls);
        }
        dmb.vfrsion = vfrsion;
        rfturn dmb;
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitAnnotbtion(finbl String dfsd,
            finbl boolfbn visiblf) {
        dhfdkStbtf();
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitAnnotbtion(dfsd, visiblf));
    }

    @Ovfrridf
    publid AnnotbtionVisitor visitTypfAnnotbtion(finbl int typfRff,
            finbl TypfPbth typfPbth, finbl String dfsd, finbl boolfbn visiblf) {
        dhfdkStbtf();
        int sort = typfRff >>> 24;
        if (sort != TypfRfffrfndf.CLASS_TYPE_PARAMETER
                && sort != TypfRfffrfndf.CLASS_TYPE_PARAMETER_BOUND
                && sort != TypfRfffrfndf.CLASS_EXTENDS) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(sort));
        }
        dhfdkTypfRffAndPbth(typfRff, typfPbth);
        ChfdkMfthodAdbptfr.dhfdkDfsd(dfsd, fblsf);
        rfturn nfw ChfdkAnnotbtionAdbptfr(supfr.visitTypfAnnotbtion(typfRff,
                typfPbth, dfsd, visiblf));
    }

    @Ovfrridf
    publid void visitAttributf(finbl Attributf bttr) {
        dhfdkStbtf();
        if (bttr == null) {
            throw nfw IllfgblArgumfntExdfption(
                    "Invblid bttributf (must not bf null)");
        }
        supfr.visitAttributf(bttr);
    }

    @Ovfrridf
    publid void visitEnd() {
        dhfdkStbtf();
        fnd = truf;
        supfr.visitEnd();
    }

    // ------------------------------------------------------------------------
    // Utility mfthods
    // ------------------------------------------------------------------------

    /**
     * Chfdks thbt thf visit mfthod hbs bffn dbllfd bnd thbt visitEnd hbs not
     * bffn dbllfd.
     */
    privbtf void dhfdkStbtf() {
        if (!stbrt) {
            throw nfw IllfgblStbtfExdfption(
                    "Cbnnot visit mfmbfr bfforf visit hbs bffn dbllfd.");
        }
        if (fnd) {
            throw nfw IllfgblStbtfExdfption(
                    "Cbnnot visit mfmbfr bftfr visitEnd hbs bffn dbllfd.");
        }
    }

    /**
     * Chfdks thbt thf givfn bddfss flbgs do not dontbin invblid flbgs. This
     * mfthod blso dhfdks thbt mutublly indompbtiblf flbgs brf not sft
     * simultbnfously.
     *
     * @pbrbm bddfss
     *            thf bddfss flbgs to bf dhfdkfd
     * @pbrbm possiblfAddfss
     *            thf vblid bddfss flbgs.
     */
    stbtid void dhfdkAddfss(finbl int bddfss, finbl int possiblfAddfss) {
        if ((bddfss & ~possiblfAddfss) != 0) {
            throw nfw IllfgblArgumfntExdfption("Invblid bddfss flbgs: "
                    + bddfss);
        }
        int pub = (bddfss & Opdodfs.ACC_PUBLIC) == 0 ? 0 : 1;
        int pri = (bddfss & Opdodfs.ACC_PRIVATE) == 0 ? 0 : 1;
        int pro = (bddfss & Opdodfs.ACC_PROTECTED) == 0 ? 0 : 1;
        if (pub + pri + pro > 1) {
            throw nfw IllfgblArgumfntExdfption(
                    "publid privbtf bnd protfdtfd brf mutublly fxdlusivf: "
                            + bddfss);
        }
        int fin = (bddfss & Opdodfs.ACC_FINAL) == 0 ? 0 : 1;
        int bbs = (bddfss & Opdodfs.ACC_ABSTRACT) == 0 ? 0 : 1;
        if (fin + bbs > 1) {
            throw nfw IllfgblArgumfntExdfption(
                    "finbl bnd bbstrbdt brf mutublly fxdlusivf: " + bddfss);
        }
    }

    /**
     * Chfdks b dlbss signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     */
    publid stbtid void dhfdkClbssSignbturf(finbl String signbturf) {
        // ClbssSignbturf:
        // FormblTypfPbrbmftfrs? ClbssTypfSignbturf ClbssTypfSignbturf*

        int pos = 0;
        if (gftChbr(signbturf, 0) == '<') {
            pos = dhfdkFormblTypfPbrbmftfrs(signbturf, pos);
        }
        pos = dhfdkClbssTypfSignbturf(signbturf, pos);
        whilf (gftChbr(signbturf, pos) == 'L') {
            pos = dhfdkClbssTypfSignbturf(signbturf, pos);
        }
        if (pos != signbturf.lfngth()) {
            throw nfw IllfgblArgumfntExdfption(signbturf + ": frror bt indfx "
                    + pos);
        }
    }

    /**
     * Chfdks b mfthod signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     */
    publid stbtid void dhfdkMfthodSignbturf(finbl String signbturf) {
        // MfthodTypfSignbturf:
        // FormblTypfPbrbmftfrs? ( TypfSignbturf* ) ( TypfSignbturf | V ) (
        // ^ClbssTypfSignbturf | ^TypfVbribblfSignbturf )*

        int pos = 0;
        if (gftChbr(signbturf, 0) == '<') {
            pos = dhfdkFormblTypfPbrbmftfrs(signbturf, pos);
        }
        pos = dhfdkChbr('(', signbturf, pos);
        whilf ("ZCBSIFJDL[T".indfxOf(gftChbr(signbturf, pos)) != -1) {
            pos = dhfdkTypfSignbturf(signbturf, pos);
        }
        pos = dhfdkChbr(')', signbturf, pos);
        if (gftChbr(signbturf, pos) == 'V') {
            ++pos;
        } flsf {
            pos = dhfdkTypfSignbturf(signbturf, pos);
        }
        whilf (gftChbr(signbturf, pos) == '^') {
            ++pos;
            if (gftChbr(signbturf, pos) == 'L') {
                pos = dhfdkClbssTypfSignbturf(signbturf, pos);
            } flsf {
                pos = dhfdkTypfVbribblfSignbturf(signbturf, pos);
            }
        }
        if (pos != signbturf.lfngth()) {
            throw nfw IllfgblArgumfntExdfption(signbturf + ": frror bt indfx "
                    + pos);
        }
    }

    /**
     * Chfdks b fifld signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     */
    publid stbtid void dhfdkFifldSignbturf(finbl String signbturf) {
        int pos = dhfdkFifldTypfSignbturf(signbturf, 0);
        if (pos != signbturf.lfngth()) {
            throw nfw IllfgblArgumfntExdfption(signbturf + ": frror bt indfx "
                    + pos);
        }
    }

    /**
     * Chfdks thf rfffrfndf to b typf in b typf bnnotbtion.
     *
     * @pbrbm typfRff
     *            b rfffrfndf to bn bnnotbtfd typf.
     * @pbrbm typfPbth
     *            thf pbth to thf bnnotbtfd typf brgumfnt, wilddbrd bound, brrby
     *            flfmfnt typf, or stbtid innfr typf within 'typfRff'. Mby bf
     *            <tt>null</tt> if thf bnnotbtion tbrgfts 'typfRff' bs b wholf.
     */
    stbtid void dhfdkTypfRffAndPbth(int typfRff, TypfPbth typfPbth) {
        int mbsk = 0;
        switdh (typfRff >>> 24) {
        dbsf TypfRfffrfndf.CLASS_TYPE_PARAMETER:
        dbsf TypfRfffrfndf.METHOD_TYPE_PARAMETER:
        dbsf TypfRfffrfndf.METHOD_FORMAL_PARAMETER:
            mbsk = 0xFFFF0000;
            brfbk;
        dbsf TypfRfffrfndf.FIELD:
        dbsf TypfRfffrfndf.METHOD_RETURN:
        dbsf TypfRfffrfndf.METHOD_RECEIVER:
        dbsf TypfRfffrfndf.LOCAL_VARIABLE:
        dbsf TypfRfffrfndf.RESOURCE_VARIABLE:
        dbsf TypfRfffrfndf.INSTANCEOF:
        dbsf TypfRfffrfndf.NEW:
        dbsf TypfRfffrfndf.CONSTRUCTOR_REFERENCE:
        dbsf TypfRfffrfndf.METHOD_REFERENCE:
            mbsk = 0xFF000000;
            brfbk;
        dbsf TypfRfffrfndf.CLASS_EXTENDS:
        dbsf TypfRfffrfndf.CLASS_TYPE_PARAMETER_BOUND:
        dbsf TypfRfffrfndf.METHOD_TYPE_PARAMETER_BOUND:
        dbsf TypfRfffrfndf.THROWS:
        dbsf TypfRfffrfndf.EXCEPTION_PARAMETER:
            mbsk = 0xFFFFFF00;
            brfbk;
        dbsf TypfRfffrfndf.CAST:
        dbsf TypfRfffrfndf.CONSTRUCTOR_INVOCATION_TYPE_ARGUMENT:
        dbsf TypfRfffrfndf.METHOD_INVOCATION_TYPE_ARGUMENT:
        dbsf TypfRfffrfndf.CONSTRUCTOR_REFERENCE_TYPE_ARGUMENT:
        dbsf TypfRfffrfndf.METHOD_REFERENCE_TYPE_ARGUMENT:
            mbsk = 0xFF0000FF;
            brfbk;
        dffbult:
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf sort 0x"
                    + Intfgfr.toHfxString(typfRff >>> 24));
        }
        if ((typfRff & ~mbsk) != 0) {
            throw nfw IllfgblArgumfntExdfption("Invblid typf rfffrfndf 0x"
                    + Intfgfr.toHfxString(typfRff));
        }
        if (typfPbth != null) {
            for (int i = 0; i < typfPbth.gftLfngth(); ++i) {
                int stfp = typfPbth.gftStfp(i);
                if (stfp != TypfPbth.ARRAY_ELEMENT
                        && stfp != TypfPbth.INNER_TYPE
                        && stfp != TypfPbth.TYPE_ARGUMENT
                        && stfp != TypfPbth.WILDCARD_BOUND) {
                    throw nfw IllfgblArgumfntExdfption(
                            "Invblid typf pbth stfp " + i + " in " + typfPbth);
                }
                if (stfp != TypfPbth.TYPE_ARGUMENT
                        && typfPbth.gftStfpArgumfnt(i) != 0) {
                    throw nfw IllfgblArgumfntExdfption(
                            "Invblid typf pbth stfp brgumfnt for stfp " + i
                                    + " in " + typfPbth);
                }
            }
        }
    }

    /**
     * Chfdks thf formbl typf pbrbmftfrs of b dlbss or mfthod signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkFormblTypfPbrbmftfrs(finbl String signbturf, int pos) {
        // FormblTypfPbrbmftfrs:
        // < FormblTypfPbrbmftfr+ >

        pos = dhfdkChbr('<', signbturf, pos);
        pos = dhfdkFormblTypfPbrbmftfr(signbturf, pos);
        whilf (gftChbr(signbturf, pos) != '>') {
            pos = dhfdkFormblTypfPbrbmftfr(signbturf, pos);
        }
        rfturn pos + 1;
    }

    /**
     * Chfdks b formbl typf pbrbmftfr of b dlbss or mfthod signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkFormblTypfPbrbmftfr(finbl String signbturf, int pos) {
        // FormblTypfPbrbmftfr:
        // Idfntififr : FifldTypfSignbturf? (: FifldTypfSignbturf)*

        pos = dhfdkIdfntififr(signbturf, pos);
        pos = dhfdkChbr(':', signbturf, pos);
        if ("L[T".indfxOf(gftChbr(signbturf, pos)) != -1) {
            pos = dhfdkFifldTypfSignbturf(signbturf, pos);
        }
        whilf (gftChbr(signbturf, pos) == ':') {
            pos = dhfdkFifldTypfSignbturf(signbturf, pos + 1);
        }
        rfturn pos;
    }

    /**
     * Chfdks b fifld typf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkFifldTypfSignbturf(finbl String signbturf, int pos) {
        // FifldTypfSignbturf:
        // ClbssTypfSignbturf | ArrbyTypfSignbturf | TypfVbribblfSignbturf
        //
        // ArrbyTypfSignbturf:
        // [ TypfSignbturf

        switdh (gftChbr(signbturf, pos)) {
        dbsf 'L':
            rfturn dhfdkClbssTypfSignbturf(signbturf, pos);
        dbsf '[':
            rfturn dhfdkTypfSignbturf(signbturf, pos + 1);
        dffbult:
            rfturn dhfdkTypfVbribblfSignbturf(signbturf, pos);
        }
    }

    /**
     * Chfdks b dlbss typf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkClbssTypfSignbturf(finbl String signbturf, int pos) {
        // ClbssTypfSignbturf:
        // L Idfntififr ( / Idfntififr )* TypfArgumfnts? ( . Idfntififr
        // TypfArgumfnts? )* ;

        pos = dhfdkChbr('L', signbturf, pos);
        pos = dhfdkIdfntififr(signbturf, pos);
        whilf (gftChbr(signbturf, pos) == '/') {
            pos = dhfdkIdfntififr(signbturf, pos + 1);
        }
        if (gftChbr(signbturf, pos) == '<') {
            pos = dhfdkTypfArgumfnts(signbturf, pos);
        }
        whilf (gftChbr(signbturf, pos) == '.') {
            pos = dhfdkIdfntififr(signbturf, pos + 1);
            if (gftChbr(signbturf, pos) == '<') {
                pos = dhfdkTypfArgumfnts(signbturf, pos);
            }
        }
        rfturn dhfdkChbr(';', signbturf, pos);
    }

    /**
     * Chfdks thf typf brgumfnts in b dlbss typf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkTypfArgumfnts(finbl String signbturf, int pos) {
        // TypfArgumfnts:
        // < TypfArgumfnt+ >

        pos = dhfdkChbr('<', signbturf, pos);
        pos = dhfdkTypfArgumfnt(signbturf, pos);
        whilf (gftChbr(signbturf, pos) != '>') {
            pos = dhfdkTypfArgumfnt(signbturf, pos);
        }
        rfturn pos + 1;
    }

    /**
     * Chfdks b typf brgumfnt in b dlbss typf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkTypfArgumfnt(finbl String signbturf, int pos) {
        // TypfArgumfnt:
        // * | ( ( + | - )? FifldTypfSignbturf )

        dhbr d = gftChbr(signbturf, pos);
        if (d == '*') {
            rfturn pos + 1;
        } flsf if (d == '+' || d == '-') {
            pos++;
        }
        rfturn dhfdkFifldTypfSignbturf(signbturf, pos);
    }

    /**
     * Chfdks b typf vbribblf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkTypfVbribblfSignbturf(finbl String signbturf,
            int pos) {
        // TypfVbribblfSignbturf:
        // T Idfntififr ;

        pos = dhfdkChbr('T', signbturf, pos);
        pos = dhfdkIdfntififr(signbturf, pos);
        rfturn dhfdkChbr(';', signbturf, pos);
    }

    /**
     * Chfdks b typf signbturf.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkTypfSignbturf(finbl String signbturf, int pos) {
        // TypfSignbturf:
        // Z | C | B | S | I | F | J | D | FifldTypfSignbturf

        switdh (gftChbr(signbturf, pos)) {
        dbsf 'Z':
        dbsf 'C':
        dbsf 'B':
        dbsf 'S':
        dbsf 'I':
        dbsf 'F':
        dbsf 'J':
        dbsf 'D':
            rfturn pos + 1;
        dffbult:
            rfturn dhfdkFifldTypfSignbturf(signbturf, pos);
        }
    }

    /**
     * Chfdks bn idfntififr.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkIdfntififr(finbl String signbturf, int pos) {
        if (!Chbrbdtfr.isJbvbIdfntififrStbrt(gftChbr(signbturf, pos))) {
            throw nfw IllfgblArgumfntExdfption(signbturf
                    + ": idfntififr fxpfdtfd bt indfx " + pos);
        }
        ++pos;
        whilf (Chbrbdtfr.isJbvbIdfntififrPbrt(gftChbr(signbturf, pos))) {
            ++pos;
        }
        rfturn pos;
    }

    /**
     * Chfdks b singlf dhbrbdtfr.
     *
     * @pbrbm signbturf
     *            b string dontbining thf signbturf thbt must bf dhfdkfd.
     * @pbrbm pos
     *            indfx of first dhbrbdtfr to bf dhfdkfd.
     * @rfturn thf indfx of thf first dhbrbdtfr bftfr thf dhfdkfd pbrt.
     */
    privbtf stbtid int dhfdkChbr(finbl dhbr d, finbl String signbturf, int pos) {
        if (gftChbr(signbturf, pos) == d) {
            rfturn pos + 1;
        }
        throw nfw IllfgblArgumfntExdfption(signbturf + ": '" + d
                + "' fxpfdtfd bt indfx " + pos);
    }

    /**
     * Rfturns thf signbturf dbr bt thf givfn indfx.
     *
     * @pbrbm signbturf
     *            b signbturf.
     * @pbrbm pos
     *            bn indfx in signbturf.
     * @rfturn thf dhbrbdtfr bt thf givfn indfx, or 0 if thfrf is no sudh
     *         dhbrbdtfr.
     */
    privbtf stbtid dhbr gftChbr(finbl String signbturf, int pos) {
        rfturn pos < signbturf.lfngth() ? signbturf.dhbrAt(pos) : (dhbr) 0;
    }
}
