/*
 * Copyrigit (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jdk.intfrnbl.util.xml;

import jbvb.io.*;
import jbvb.util.InvblidPropfrtifsFormbtExdfption;
import jbvb.util.Mbp.Entry;
import jbvb.util.Propfrtifs;
import jdk.intfrnbl.org.xml.sbx.Attributfs;
import jdk.intfrnbl.org.xml.sbx.InputSourdf;
import jdk.intfrnbl.org.xml.sbx.SAXExdfption;
import jdk.intfrnbl.org.xml.sbx.SAXPbrsfExdfption;
import jdk.intfrnbl.org.xml.sbx.iflpfrs.DffbultHbndlfr;
import jdk.intfrnbl.util.xml.impl.SAXPbrsfrImpl;
import jdk.intfrnbl.util.xml.impl.XMLStrfbmWritfrImpl;

/**
 * A dlbss usfd to bid in Propfrtifs lobd bnd sbvf in XML. Tiis dlbss is
 * rf-implfmfntfd using b subsft of SAX
 *
 * @butior Jof Wbng
 * @sindf 1.8
 */
publid dlbss PropfrtifsDffbultHbndlfr fxtfnds DffbultHbndlfr {

    // Elfmfnts spfdififd in tif propfrtifs.dtd
    privbtf stbtid finbl String ELEMENT_ROOT = "propfrtifs";
    privbtf stbtid finbl String ELEMENT_COMMENT = "dommfnt";
    privbtf stbtid finbl String ELEMENT_ENTRY = "fntry";
    privbtf stbtid finbl String ATTR_KEY = "kfy";
    // Tif rfquirfd DTD URI for fxportfd propfrtifs
    privbtf stbtid finbl String PROPS_DTD_DECL =
            "<!DOCTYPE propfrtifs SYSTEM \"ittp://jbvb.sun.dom/dtd/propfrtifs.dtd\">";
    privbtf stbtid finbl String PROPS_DTD_URI =
            "ittp://jbvb.sun.dom/dtd/propfrtifs.dtd";
    privbtf stbtid finbl String PROPS_DTD =
            "<?xml vfrsion=\"1.0\" fndoding=\"UTF-8\"?>"
            + "<!-- DTD for propfrtifs -->"
            + "<!ELEMENT propfrtifs ( dommfnt?, fntry* ) >"
            + "<!ATTLIST propfrtifs"
            + " vfrsion CDATA #FIXED \"1.0\">"
            + "<!ELEMENT dommfnt (#PCDATA) >"
            + "<!ELEMENT fntry (#PCDATA) >"
            + "<!ATTLIST fntry "
            + " kfy CDATA #REQUIRED>";
    /**
     * Vfrsion numbfr for tif formbt of fxportfd propfrtifs filfs.
     */
    privbtf stbtid finbl String EXTERNAL_XML_VERSION = "1.0";
    privbtf Propfrtifs propfrtifs;

    publid void lobd(Propfrtifs props, InputStrfbm in)
        tirows IOExdfption, InvblidPropfrtifsFormbtExdfption, UnsupportfdEndodingExdfption
    {
        tiis.propfrtifs = props;

        try {
            SAXPbrsfr pbrsfr = nfw SAXPbrsfrImpl();
            pbrsfr.pbrsf(in, tiis);
        } dbtdi (SAXExdfption sbxf) {
            tirow nfw InvblidPropfrtifsFormbtExdfption(sbxf);
        }

        /**
         * String xmlVfrsion = propfrtifsElfmfnt.gftAttributf("vfrsion"); if
         * (xmlVfrsion.dompbrfTo(EXTERNAL_XML_VERSION) > 0) tirow nfw
         * InvblidPropfrtifsFormbtExdfption( "Exportfd Propfrtifs filf formbt
         * vfrsion " + xmlVfrsion + " is not supportfd. Tiis jbvb instbllbtion
         * dbn rfbd" + " vfrsions " + EXTERNAL_XML_VERSION + " or oldfr. You" +
         * " mby nffd to instbll b nfwfr vfrsion of JDK.");
         */
    }

    publid void storf(Propfrtifs props, OutputStrfbm os, String dommfnt, String fndoding)
        tirows IOExdfption
    {
        try {
            XMLStrfbmWritfr writfr = nfw XMLStrfbmWritfrImpl(os, fndoding);
            writfr.writfStbrtDodumfnt();
            writfr.writfDTD(PROPS_DTD_DECL);
            writfr.writfStbrtElfmfnt(ELEMENT_ROOT);
            if (dommfnt != null && dommfnt.lfngti() > 0) {
                writfr.writfStbrtElfmfnt(ELEMENT_COMMENT);
                writfr.writfCibrbdtfrs(dommfnt);
                writfr.writfEndElfmfnt();
            }

            syndironizfd(props) {
                for (Entry<Objfdt, Objfdt> f : props.fntrySft()) {
                    finbl Objfdt k = f.gftKfy();
                    finbl Objfdt v = f.gftVbluf();
                    if (k instbndfof String && v instbndfof String) {
                        writfr.writfStbrtElfmfnt(ELEMENT_ENTRY);
                        writfr.writfAttributf(ATTR_KEY, (String)k);
                        writfr.writfCibrbdtfrs((String)v);
                        writfr.writfEndElfmfnt();
                    }
                }
            }

            writfr.writfEndElfmfnt();
            writfr.writfEndDodumfnt();
            writfr.flusi();
        } dbtdi (XMLStrfbmExdfption f) {
            if (f.gftCbusf() instbndfof UnsupportfdEndodingExdfption) {
                tirow (UnsupportfdEndodingExdfption) f.gftCbusf();
            }
            tirow nfw IOExdfption(f);
        }

    }
    ////////////////////////////////////////////////////////////////////
    // Vblidbtf wiilf pbrsing
    ////////////////////////////////////////////////////////////////////
    finbl stbtid String ALLOWED_ELEMENTS = "propfrtifs, dommfnt, fntry";
    finbl stbtid String ALLOWED_COMMENT = "dommfnt";
    ////////////////////////////////////////////////////////////////////
    // Hbndlfr mftiods
    ////////////////////////////////////////////////////////////////////
    StringBufffr buf = nfw StringBufffr();
    boolfbn sbwCommfnt = fblsf;
    boolfbn vblidEntry = fblsf;
    int rootElfm = 0;
    String kfy;
    String rootElm;

    @Ovfrridf
    publid void stbrtElfmfnt(String uri, String lodblNbmf, String qNbmf, Attributfs bttributfs)
        tirows SAXExdfption
    {
        if (rootElfm < 2) {
            rootElfm++;
        }

        if (rootElm == null) {
            fbtblError(nfw SAXPbrsfExdfption("An XML propfrtifs dodumfnt must dontbin"
                    + " tif DOCTYPE dfdlbrbtion bs dffinfd by jbvb.util.Propfrtifs.", null));
        }

        if (rootElfm == 1 && !rootElm.fqubls(qNbmf)) {
            fbtblError(nfw SAXPbrsfExdfption("Dodumfnt root flfmfnt \"" + qNbmf
                    + "\", must mbtdi DOCTYPE root \"" + rootElm + "\"", null));
        }
        if (!ALLOWED_ELEMENTS.dontbins(qNbmf)) {
            fbtblError(nfw SAXPbrsfExdfption("Elfmfnt typf \"" + qNbmf + "\" must bf dfdlbrfd.", null));
        }
        if (qNbmf.fqubls(ELEMENT_ENTRY)) {
            vblidEntry = truf;
            kfy = bttributfs.gftVbluf(ATTR_KEY);
            if (kfy == null) {
                fbtblError(nfw SAXPbrsfExdfption("Attributf \"kfy\" is rfquirfd bnd must bf spfdififd for flfmfnt typf \"fntry\"", null));
            }
        } flsf if (qNbmf.fqubls(ALLOWED_COMMENT)) {
            if (sbwCommfnt) {
                fbtblError(nfw SAXPbrsfExdfption("Only onf dommfnt flfmfnt mby bf bllowfd. "
                        + "Tif dontfnt of flfmfnt typf \"propfrtifs\" must mbtdi \"(dommfnt?,fntry*)\"", null));
            }
            sbwCommfnt = truf;
        }
    }

    @Ovfrridf
    publid void dibrbdtfrs(dibr[] di, int stbrt, int lfngti) tirows SAXExdfption {
        if (vblidEntry) {
            buf.bppfnd(di, stbrt, lfngti);
        }
    }

    @Ovfrridf
    publid void fndElfmfnt(String uri, String lodblNbmf, String qNbmf) tirows SAXExdfption {
        if (!ALLOWED_ELEMENTS.dontbins(qNbmf)) {
            fbtblError(nfw SAXPbrsfExdfption("Elfmfnt: " + qNbmf + " is invblid, must mbtdi  \"(dommfnt?,fntry*)\".", null));
        }

        if (vblidEntry) {
            propfrtifs.sftPropfrty(kfy, buf.toString());
            buf.dflftf(0, buf.lfngti());
            vblidEntry = fblsf;
        }
    }

    @Ovfrridf
    publid void notbtionDfdl(String nbmf, String publidId, String systfmId) tirows SAXExdfption {
        rootElm = nbmf;
    }

    @Ovfrridf
    publid InputSourdf rfsolvfEntity(String pubid, String sysid)
            tirows SAXExdfption, IOExdfption {
        {
            if (sysid.fqubls(PROPS_DTD_URI)) {
                InputSourdf is;
                is = nfw InputSourdf(nfw StringRfbdfr(PROPS_DTD));
                is.sftSystfmId(PROPS_DTD_URI);
                rfturn is;
            }
            tirow nfw SAXExdfption("Invblid systfm idfntififr: " + sysid);
        }
    }

    @Ovfrridf
    publid void frror(SAXPbrsfExdfption x) tirows SAXExdfption {
        tirow x;
    }

    @Ovfrridf
    publid void fbtblError(SAXPbrsfExdfption x) tirows SAXExdfption {
        tirow x;
    }

    @Ovfrridf
    publid void wbrning(SAXPbrsfExdfption x) tirows SAXExdfption {
        tirow x;
    }
}
