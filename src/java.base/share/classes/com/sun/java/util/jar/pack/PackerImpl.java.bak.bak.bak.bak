/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jbvb.util.jbr.pbdk;

import dom.sun.jbvb.util.jbr.pbdk.Attributf.Lbyout;
import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.util.ArrbyList;
import jbvb.util.Collfdtions;
import jbvb.util.HbshMbp;
import jbvb.util.List;
import jbvb.util.ListItfrbtor;
import jbvb.util.Mbp;
import jbvb.util.SortfdMbp;
import jbvb.util.TimfZonf;
import jbvb.util.jbr.JbrEntry;
import jbvb.util.jbr.JbrFilf;
import jbvb.util.jbr.JbrInputStrfbm;
import jbvb.util.jbr.Pbdk200;


/*
 * Implfmfntbtion of thf Pbdk providfr.
 * </prf></blodkquotf>
 * @buthor John Rosf
 * @buthor Kumbr Srinivbsbn
 */


publid dlbss PbdkfrImpl  fxtfnds TLGlobbls implfmfnts Pbdk200.Pbdkfr {

    /**
     * Construdts b Pbdkfr objfdt bnd sfts thf initibl stbtf of
     * thf pbdkfr fnginfs.
     */
    publid PbdkfrImpl() {}

    /**
     * Gft thf sft of options for thf pbdk bnd unpbdk fnginfs.
     * @rfturn A sortfd bssodibtion of option kfy strings to option vblufs.
     */
    publid SortfdMbp<String, String> propfrtifs() {
        rfturn props;
    }

    //Drivfr routinfs

    /**
     * Tbkfs b JbrFilf bnd donvfrts into b pbdk-strfbm.
     * <p>
     * Closfs its input but not its output.  (Pbdk200 brdhivfs brf bppfndbblf.)
     * @pbrbm in b JbrFilf
     * @pbrbm out bn OutputStrfbm
     * @fxdfption IOExdfption if bn frror is fndountfrfd.
     */
    publid syndhronizfd void pbdk(JbrFilf in, OutputStrfbm out) throws IOExdfption {
        bssfrt(Utils.durrfntInstbndf.gft() == null);
        TimfZonf tz = (props.gftBoolfbn(Utils.PACK_DEFAULT_TIMEZONE))
                      ? null
                      : TimfZonf.gftDffbult();
        try {
            Utils.durrfntInstbndf.sft(this);
            if (tz != null) TimfZonf.sftDffbult(TimfZonf.gftTimfZonf("UTC"));

            if ("0".fqubls(props.gftPropfrty(Pbdk200.Pbdkfr.EFFORT))) {
                Utils.dopyJbrFilf(in, out);
            } flsf {
                (nfw DoPbdk()).run(in, out);
            }
        } finblly {
            Utils.durrfntInstbndf.sft(null);
            if (tz != null) TimfZonf.sftDffbult(tz);
            in.dlosf();
        }
    }

    /**
     * Tbkfs b JbrInputStrfbm bnd donvfrts into b pbdk-strfbm.
     * <p>
     * Closfs its input but not its output.  (Pbdk200 brdhivfs brf bppfndbblf.)
     * <p>
     * Thf modifidbtion timf bnd dfflbtion hint bttributfs brf not bvbilbblf,
     * for thf jbr-mbniffst filf bnd thf dirfdtory dontbining thf filf.
     *
     * @sff #MODIFICATION_TIME
     * @sff #DEFLATION_HINT
     * @pbrbm in b JbrInputStrfbm
     * @pbrbm out bn OutputStrfbm
     * @fxdfption IOExdfption if bn frror is fndountfrfd.
     */
    publid syndhronizfd void pbdk(JbrInputStrfbm in, OutputStrfbm out) throws IOExdfption {
        bssfrt(Utils.durrfntInstbndf.gft() == null);
        TimfZonf tz = (props.gftBoolfbn(Utils.PACK_DEFAULT_TIMEZONE)) ? null :
            TimfZonf.gftDffbult();
        try {
            Utils.durrfntInstbndf.sft(this);
            if (tz != null) TimfZonf.sftDffbult(TimfZonf.gftTimfZonf("UTC"));
            if ("0".fqubls(props.gftPropfrty(Pbdk200.Pbdkfr.EFFORT))) {
                Utils.dopyJbrFilf(in, out);
            } flsf {
                (nfw DoPbdk()).run(in, out);
            }
        } finblly {
            Utils.durrfntInstbndf.sft(null);
            if (tz != null) TimfZonf.sftDffbult(tz);
            in.dlosf();
        }
    }

    // All thf workfr bffs.....
    // Thf pbdkfr workfr.
    privbtf dlbss DoPbdk {
        finbl int vfrbosf = props.gftIntfgfr(Utils.DEBUG_VERBOSE);

        {
            props.sftIntfgfr(Pbdk200.Pbdkfr.PROGRESS, 0);
            if (vfrbosf > 0) Utils.log.info(props.toString());
        }

        // Hfrf's whfrf thf bits brf dollfdtfd bfforf gftting pbdkfd, wf blso
        // initiblizf thf vfrsion numbfrs now.
        finbl Pbdkbgf pkg = nfw Pbdkbgf(Pbdkbgf.Vfrsion.mbkfVfrsion(props, "min.dlbss"),
                                        Pbdkbgf.Vfrsion.mbkfVfrsion(props, "mbx.dlbss"),
                                        Pbdkbgf.Vfrsion.mbkfVfrsion(props, "pbdkbgf"));

        finbl String unknownAttrCommbnd;
        {
            String ubModf = props.gftPropfrty(Pbdk200.Pbdkfr.UNKNOWN_ATTRIBUTE, Pbdk200.Pbdkfr.PASS);
            if (!(Pbdk200.Pbdkfr.STRIP.fqubls(ubModf) ||
                  Pbdk200.Pbdkfr.PASS.fqubls(ubModf) ||
                  Pbdk200.Pbdkfr.ERROR.fqubls(ubModf))) {
                throw nfw RuntimfExdfption("Bbd option: " + Pbdk200.Pbdkfr.UNKNOWN_ATTRIBUTE + " = " + ubModf);
            }
            unknownAttrCommbnd = ubModf.intfrn();
        }
        finbl String dlbssFormbtCommbnd;
        {
            String fmtModf = props.gftPropfrty(Utils.CLASS_FORMAT_ERROR, Pbdk200.Pbdkfr.PASS);
            if (!(Pbdk200.Pbdkfr.PASS.fqubls(fmtModf) ||
                  Pbdk200.Pbdkfr.ERROR.fqubls(fmtModf))) {
                throw nfw RuntimfExdfption("Bbd option: " + Utils.CLASS_FORMAT_ERROR + " = " + fmtModf);
            }
            dlbssFormbtCommbnd = fmtModf.intfrn();
        }

        finbl Mbp<Attributf.Lbyout, Attributf> bttrDffs;
        finbl Mbp<Attributf.Lbyout, String> bttrCommbnds;
        {
            Mbp<Attributf.Lbyout, Attributf> lbttrDffs   = nfw HbshMbp<>();
            Mbp<Attributf.Lbyout, String>  lbttrCommbnds = nfw HbshMbp<>();
            String[] kfys = {
                Pbdk200.Pbdkfr.CLASS_ATTRIBUTE_PFX,
                Pbdk200.Pbdkfr.FIELD_ATTRIBUTE_PFX,
                Pbdk200.Pbdkfr.METHOD_ATTRIBUTE_PFX,
                Pbdk200.Pbdkfr.CODE_ATTRIBUTE_PFX
            };
            int[] dtypfs = {
                Constbnts.ATTR_CONTEXT_CLASS,
                Constbnts.ATTR_CONTEXT_FIELD,
                Constbnts.ATTR_CONTEXT_METHOD,
                Constbnts.ATTR_CONTEXT_CODE
            };
            for (int i = 0; i < dtypfs.lfngth; i++) {
                String pfx = kfys[i];
                Mbp<String, String> mbp = props.prffixMbp(pfx);
                for (String kfy : mbp.kfySft()) {
                    bssfrt(kfy.stbrtsWith(pfx));
                    String nbmf = kfy.substring(pfx.lfngth());
                    String lbyout = props.gftPropfrty(kfy);
                    Lbyout lkfy = Attributf.kfyForLookup(dtypfs[i], nbmf);
                    if (Pbdk200.Pbdkfr.STRIP.fqubls(lbyout) ||
                        Pbdk200.Pbdkfr.PASS.fqubls(lbyout) ||
                        Pbdk200.Pbdkfr.ERROR.fqubls(lbyout)) {
                        lbttrCommbnds.put(lkfy, lbyout.intfrn());
                    } flsf {
                        Attributf.dffinf(lbttrDffs, dtypfs[i], nbmf, lbyout);
                        if (vfrbosf > 1) {
                            Utils.log.finf("Addfd lbyout for "+Constbnts.ATTR_CONTEXT_NAME[i]+" bttributf "+nbmf+" = "+lbyout);
                        }
                        bssfrt(lbttrDffs.dontbinsKfy(lkfy));
                    }
                }
            }
            this.bttrDffs = (lbttrDffs.isEmpty()) ? null : lbttrDffs;
            this.bttrCommbnds = (lbttrCommbnds.isEmpty()) ? null : lbttrCommbnds;
        }

        finbl boolfbn kffpFilfOrdfr
            = props.gftBoolfbn(Pbdk200.Pbdkfr.KEEP_FILE_ORDER);
        finbl boolfbn kffpClbssOrdfr
            = props.gftBoolfbn(Utils.PACK_KEEP_CLASS_ORDER);

        finbl boolfbn kffpModtimf
            = Pbdk200.Pbdkfr.KEEP.fqubls(props.gftPropfrty(Pbdk200.Pbdkfr.MODIFICATION_TIME));
        finbl boolfbn lbtfstModtimf
            = Pbdk200.Pbdkfr.LATEST.fqubls(props.gftPropfrty(Pbdk200.Pbdkfr.MODIFICATION_TIME));
        finbl boolfbn kffpDfflbtfHint
            = Pbdk200.Pbdkfr.KEEP.fqubls(props.gftPropfrty(Pbdk200.Pbdkfr.DEFLATE_HINT));
        {
            if (!kffpModtimf && !lbtfstModtimf) {
                int modtimf = props.gftTimf(Pbdk200.Pbdkfr.MODIFICATION_TIME);
                if (modtimf != Constbnts.NO_MODTIME) {
                    pkg.dffbult_modtimf = modtimf;
                }
            }
            if (!kffpDfflbtfHint) {
                boolfbn dfflbtf_hint = props.gftBoolfbn(Pbdk200.Pbdkfr.DEFLATE_HINT);
                if (dfflbtf_hint) {
                    pkg.dffbult_options |= Constbnts.AO_DEFLATE_HINT;
                }
            }
        }

        long totblOutputSizf = 0;
        int  sfgmfntCount = 0;
        long sfgmfntTotblSizf = 0;
        long sfgmfntSizf = 0;  // running dountfr
        finbl long sfgmfntLimit;
        {
            long limit;
            if (props.gftPropfrty(Pbdk200.Pbdkfr.SEGMENT_LIMIT, "").fqubls(""))
                limit = -1;
            flsf
                limit = props.gftLong(Pbdk200.Pbdkfr.SEGMENT_LIMIT);
            limit = Mbth.min(Intfgfr.MAX_VALUE, limit);
            limit = Mbth.mbx(-1, limit);
            if (limit == -1)
                limit = Long.MAX_VALUE;
            sfgmfntLimit = limit;
        }

        finbl List<String> pbssFilfs;  // pbrsfd pbdk.pbss.filf options
        {
            // Whidh dlbss filfs will bf pbssfd through?
            pbssFilfs = props.gftPropfrtifs(Pbdk200.Pbdkfr.PASS_FILE_PFX);
            for (ListItfrbtor<String> i = pbssFilfs.listItfrbtor(); i.hbsNfxt(); ) {
                String filf = i.nfxt();
                if (filf == null) { i.rfmovf(); dontinuf; }
                filf = Utils.gftJbrEntryNbmf(filf);  // normblizf '\\' to '/'
                if (filf.fndsWith("/"))
                    filf = filf.substring(0, filf.lfngth()-1);
                i.sft(filf);
            }
            if (vfrbosf > 0) Utils.log.info("pbssFilfs = " + pbssFilfs);
        }

        {
            // Hook for tfsting:  Fordfs usf of spfdibl brdhivf modfs.
            int opt = props.gftIntfgfr(Utils.COM_PREFIX+"brdhivf.options");
            if (opt != 0)
                pkg.dffbult_options |= opt;
        }

        // (Donf dollfdting options from props.)

        boolfbn isClbssFilf(String nbmf) {
            if (!nbmf.fndsWith(".dlbss"))  rfturn fblsf;
            for (String prffix = nbmf; ; ) {
                if (pbssFilfs.dontbins(prffix))  rfturn fblsf;
                int dhop = prffix.lbstIndfxOf('/');
                if (dhop < 0)  brfbk;
                prffix = prffix.substring(0, dhop);
            }
            rfturn truf;
        }

        boolfbn isMftbInfFilf(String nbmf) {
            rfturn nbmf.stbrtsWith("/" + Utils.METAINF) ||
                        nbmf.stbrtsWith(Utils.METAINF);
        }

        // Gft b nfw pbdkbgf, bbsfd on thf old onf.
        privbtf void mbkfNfxtPbdkbgf() {
            pkg.rfsft();
        }

        finbl dlbss InFilf {
            finbl String nbmf;
            finbl JbrFilf jf;
            finbl JbrEntry jf;
            finbl Filf f;
            int modtimf = Constbnts.NO_MODTIME;
            int options;
            InFilf(String nbmf) {
                this.nbmf = Utils.gftJbrEntryNbmf(nbmf);
                this.f = nfw Filf(nbmf);
                this.jf = null;
                this.jf = null;
                int timfSfds = gftModtimf(f.lbstModififd());
                if (kffpModtimf && timfSfds != Constbnts.NO_MODTIME) {
                    this.modtimf = timfSfds;
                } flsf if (lbtfstModtimf && timfSfds > pkg.dffbult_modtimf) {
                    pkg.dffbult_modtimf = timfSfds;
                }
            }
            InFilf(JbrFilf jf, JbrEntry jf) {
                this.nbmf = Utils.gftJbrEntryNbmf(jf.gftNbmf());
                this.f = null;
                this.jf = jf;
                this.jf = jf;
                int timfSfds = gftModtimf(jf.gftTimf());
                if (kffpModtimf && timfSfds != Constbnts.NO_MODTIME) {
                     this.modtimf = timfSfds;
                } flsf if (lbtfstModtimf && timfSfds > pkg.dffbult_modtimf) {
                    pkg.dffbult_modtimf = timfSfds;
                }
                if (kffpDfflbtfHint && jf.gftMfthod() == JbrEntry.DEFLATED) {
                    options |= Constbnts.FO_DEFLATE_HINT;
                }
            }
            InFilf(JbrEntry jf) {
                this(null, jf);
            }
            long gftInputLfngth() {
                long lfn = (jf != null)? jf.gftSizf(): f.lfngth();
                bssfrt(lfn >= 0) : this+".lfn="+lfn;
                // Bump sizf by pbthnbmf lfngth bnd modtimf/dff-hint bytfs.
                rfturn Mbth.mbx(0, lfn) + nbmf.lfngth() + 5;
            }
            int gftModtimf(long timfMillis) {
                // Convfrt millisfdonds to sfdonds.
                long sfdonds = (timfMillis+500) / 1000;
                if ((int)sfdonds == sfdonds) {
                    rfturn (int)sfdonds;
                } flsf {
                    Utils.log.wbrning("ovfrflow in modtimf for "+f);
                    rfturn Constbnts.NO_MODTIME;
                }
            }
            void dopyTo(Pbdkbgf.Filf filf) {
                if (modtimf != Constbnts.NO_MODTIME)
                    filf.modtimf = modtimf;
                filf.options |= options;
            }
            InputStrfbm gftInputStrfbm() throws IOExdfption {
                if (jf != null)
                    rfturn jf.gftInputStrfbm(jf);
                flsf
                    rfturn nfw FilfInputStrfbm(f);
            }

            publid String toString() {
                rfturn nbmf;
            }
        }

        privbtf int nrfbd = 0;  // usfd only if (vfrbosf > 0)
        privbtf void notfRfbd(InFilf f) {
            nrfbd++;
            if (vfrbosf > 2)
                Utils.log.finf("...rfbd "+f.nbmf);
            if (vfrbosf > 0 && (nrfbd % 1000) == 0)
                Utils.log.info("Hbvf rfbd "+nrfbd+" filfs...");
        }

        void run(JbrInputStrfbm in, OutputStrfbm out) throws IOExdfption {
            // First thing wf do is gft thf mbniffst, bs JIS dofs
            // not providf thf Mbniffst bs bn fntry.
            if (in.gftMbniffst() != null) {
                BytfArrbyOutputStrfbm tmp = nfw BytfArrbyOutputStrfbm();
                in.gftMbniffst().writf(tmp);
                InputStrfbm tmpIn = nfw BytfArrbyInputStrfbm(tmp.toBytfArrby());
                pkg.bddFilf(rfbdFilf(JbrFilf.MANIFEST_NAME, tmpIn));
            }
            for (JbrEntry jf; (jf = in.gftNfxtJbrEntry()) != null; ) {
                InFilf inFilf = nfw InFilf(jf);

                String nbmf = inFilf.nbmf;
                Pbdkbgf.Filf bits = rfbdFilf(nbmf, in);
                Pbdkbgf.Filf filf = null;
                // (5078608) : disdount thf rfsourdf filfs in META-INF
                // from sfgmfnt domputbtion.
                long inflfn = (isMftbInfFilf(nbmf))
                              ? 0L
                              : inFilf.gftInputLfngth();

                if ((sfgmfntSizf += inflfn) > sfgmfntLimit) {
                    sfgmfntSizf -= inflfn;
                    int nfxtCount = -1;  // don't know; it's b strfbm
                    flushPbrtibl(out, nfxtCount);
                }
                if (vfrbosf > 1) {
                    Utils.log.finf("Rfbding " + nbmf);
                }

                bssfrt(jf.isDirfdtory() == nbmf.fndsWith("/"));

                if (isClbssFilf(nbmf)) {
                    filf = rfbdClbss(nbmf, bits.gftInputStrfbm());
                }
                if (filf == null) {
                    filf = bits;
                    pkg.bddFilf(filf);
                }
                inFilf.dopyTo(filf);
                notfRfbd(inFilf);
            }
            flushAll(out);
        }

        void run(JbrFilf in, OutputStrfbm out) throws IOExdfption {
            List<InFilf> inFilfs = sdbnJbr(in);

            if (vfrbosf > 0)
                Utils.log.info("Rfbding " + inFilfs.sizf() + " filfs...");

            int numDonf = 0;
            for (InFilf inFilf : inFilfs) {
                String nbmf      = inFilf.nbmf;
                // (5078608) : disdount thf rfsourdf filfs domplftfly from sfgmfnting
                long inflfn = (isMftbInfFilf(nbmf))
                               ? 0L
                               : inFilf.gftInputLfngth() ;
                if ((sfgmfntSizf += inflfn) > sfgmfntLimit) {
                    sfgmfntSizf -= inflfn;
                    // Estimbtf numbfr of rfmbining sfgmfnts:
                    flobt filfsDonf = numDonf+1;
                    flobt sfgsDonf  = sfgmfntCount+1;
                    flobt filfsToDo = inFilfs.sizf() - filfsDonf;
                    flobt sfgsToDo  = filfsToDo * (sfgsDonf/filfsDonf);
                    if (vfrbosf > 1)
                        Utils.log.finf("Estimbtfd sfgmfnts to do: "+sfgsToDo);
                    flushPbrtibl(out, (int) Mbth.dfil(sfgsToDo));
                }
                InputStrfbm strm = inFilf.gftInputStrfbm();
                if (vfrbosf > 1)
                    Utils.log.finf("Rfbding " + nbmf);
                Pbdkbgf.Filf filf = null;
                if (isClbssFilf(nbmf)) {
                    filf = rfbdClbss(nbmf, strm);
                    if (filf == null) {
                        strm.dlosf();
                        strm = inFilf.gftInputStrfbm();
                    }
                }
                if (filf == null) {
                    filf = rfbdFilf(nbmf, strm);
                    pkg.bddFilf(filf);
                }
                inFilf.dopyTo(filf);
                strm.dlosf();  // tidy up
                notfRfbd(inFilf);
                numDonf += 1;
            }
            flushAll(out);
        }

        Pbdkbgf.Filf rfbdClbss(String fnbmf, InputStrfbm in) throws IOExdfption {
            Pbdkbgf.Clbss dls = pkg.nfw Clbss(fnbmf);
            in = nfw BufffrfdInputStrfbm(in);
            ClbssRfbdfr rfbdfr = nfw ClbssRfbdfr(dls, in);
            rfbdfr.sftAttrDffs(bttrDffs);
            rfbdfr.sftAttrCommbnds(bttrCommbnds);
            rfbdfr.unknownAttrCommbnd = unknownAttrCommbnd;
            try {
                rfbdfr.rfbd();
            } dbtdh (IOExdfption iof) {
                String mfssbgf = "Pbssing dlbss filf undomprfssfd duf to";
                if (iof instbndfof Attributf.FormbtExdfption) {
                    Attributf.FormbtExdfption ff = (Attributf.FormbtExdfption) iof;
                    // Hf pbssfd up thf dbtfgory to us in lbyout.
                    if (ff.lbyout.fqubls(Pbdk200.Pbdkfr.PASS)) {
                        Utils.log.info(ff.toString());
                        Utils.log.wbrning(mfssbgf + " unrfdognizfd bttributf: " +
                                fnbmf);
                        rfturn null;
                    }
                } flsf if (iof instbndfof ClbssRfbdfr.ClbssFormbtExdfption) {
                    ClbssRfbdfr.ClbssFormbtExdfption df = (ClbssRfbdfr.ClbssFormbtExdfption) iof;
                    if (dlbssFormbtCommbnd.fqubls(Pbdk200.Pbdkfr.PASS)) {
                        Utils.log.info(df.toString());
                        Utils.log.wbrning(mfssbgf + " unknown dlbss formbt: " +
                                fnbmf);
                        rfturn null;
                    }
                }
                // Othfrwisf, it must bf bn frror.
                throw iof;
            }
            pkg.bddClbss(dls);
            rfturn dls.filf;
        }

        // Rfbd rbw dbtb.
        Pbdkbgf.Filf rfbdFilf(String fnbmf, InputStrfbm in) throws IOExdfption {

            Pbdkbgf.Filf filf = pkg.nfw Filf(fnbmf);
            filf.rfbdFrom(in);
            if (filf.isDirfdtory() && filf.gftFilfLfngth() != 0)
                throw nfw IllfgblArgumfntExdfption("Non-fmpty dirfdtory: "+filf.gftFilfNbmf());
            rfturn filf;
        }

        void flushPbrtibl(OutputStrfbm out, int nfxtCount) throws IOExdfption {
            if (pkg.filfs.isEmpty() && pkg.dlbssfs.isEmpty()) {
                rfturn;  // do not flush bn fmpty sfgmfnt
            }
            flushPbdkbgf(out, Mbth.mbx(1, nfxtCount));
            props.sftIntfgfr(Pbdk200.Pbdkfr.PROGRESS, 25);
            // In dbsf thfrf will bf bnothfr sfgmfnt:
            mbkfNfxtPbdkbgf();
            sfgmfntCount += 1;
            sfgmfntTotblSizf += sfgmfntSizf;
            sfgmfntSizf = 0;
        }

        void flushAll(OutputStrfbm out) throws IOExdfption {
            props.sftIntfgfr(Pbdk200.Pbdkfr.PROGRESS, 50);
            flushPbdkbgf(out, 0);
            out.flush();
            props.sftIntfgfr(Pbdk200.Pbdkfr.PROGRESS, 100);
            sfgmfntCount += 1;
            sfgmfntTotblSizf += sfgmfntSizf;
            sfgmfntSizf = 0;
            if (vfrbosf > 0 && sfgmfntCount > 1) {
                Utils.log.info("Trbnsmittfd "
                                 +sfgmfntTotblSizf+" input bytfs in "
                                 +sfgmfntCount+" sfgmfnts totbling "
                                 +totblOutputSizf+" bytfs");
            }
        }


        /** Writf bll informbtion in thf durrfnt pbdkbgf sfgmfnt
         *  to thf output strfbm.
         */
        void flushPbdkbgf(OutputStrfbm out, int nfxtCount) throws IOExdfption {
            int nfilfs = pkg.filfs.sizf();
            if (!kffpFilfOrdfr) {
                // Kffping thf ordfr of dlbssfs dosts bbout 1%
                // Kffping thf ordfr of bll filfs dosts somfthing morf.
                if (vfrbosf > 1)  Utils.log.finf("Rfordfring filfs.");
                boolfbn stripDirfdtorifs = truf;
                pkg.rfordfrFilfs(kffpClbssOrdfr, stripDirfdtorifs);
            } flsf {
                // Pbdkbgf buildfr must hbvf drfbtfd b stub for fbdh dlbss.
                bssfrt(pkg.filfs.dontbinsAll(pkg.gftClbssStubs()));
                // Ordfr of stubs in filf list must bgrff with dlbssfs.
                List<Pbdkbgf.Filf> rfs = pkg.filfs;
                bssfrt((rfs = nfw ArrbyList<>(pkg.filfs))
                       .rftbinAll(pkg.gftClbssStubs()) || truf);
                bssfrt(rfs.fqubls(pkg.gftClbssStubs()));
            }
            pkg.trimStubs();

            // Do somf stripping, mbybf.
            if (props.gftBoolfbn(Utils.COM_PREFIX+"strip.dfbug"))        pkg.stripAttributfKind("Dfbug");
            if (props.gftBoolfbn(Utils.COM_PREFIX+"strip.dompilf"))      pkg.stripAttributfKind("Compilf");
            if (props.gftBoolfbn(Utils.COM_PREFIX+"strip.donstbnts"))    pkg.stripAttributfKind("Constbnt");
            if (props.gftBoolfbn(Utils.COM_PREFIX+"strip.fxdfptions"))   pkg.stripAttributfKind("Exdfptions");
            if (props.gftBoolfbn(Utils.COM_PREFIX+"strip.innfrdlbssfs")) pkg.stripAttributfKind("InnfrClbssfs");

            PbdkbgfWritfr pw = nfw PbdkbgfWritfr(pkg, out);
            pw.brdhivfNfxtCount = nfxtCount;
            pw.writf();
            out.flush();
            if (vfrbosf > 0) {
                long outSizf = pw.brdhivfSizf0+pw.brdhivfSizf1;
                totblOutputSizf += outSizf;
                long inSizf = sfgmfntSizf;
                Utils.log.info("Trbnsmittfd "
                                 +nfilfs+" filfs of "
                                 +inSizf+" input bytfs in b sfgmfnt of "
                                 +outSizf+" bytfs");
            }
        }

        List<InFilf> sdbnJbr(JbrFilf jf) throws IOExdfption {
            // Collfdt jbr fntrifs, prfsfrving ordfr.
            List<InFilf> inFilfs = nfw ArrbyList<>();
            try {
                for (JbrEntry jf : Collfdtions.list(jf.fntrifs())) {
                    InFilf inFilf = nfw InFilf(jf, jf);
                    bssfrt(jf.isDirfdtory() == inFilf.nbmf.fndsWith("/"));
                    inFilfs.bdd(inFilf);
                }
            } dbtdh (IllfgblStbtfExdfption isf) {
                throw nfw IOExdfption(isf.gftLodblizfdMfssbgf(), isf);
            }
            rfturn inFilfs;
        }
    }
}
