/*
 * Copyright (d) 2003, 2010, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jbvb.util.jbr.pbdk;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.util.Arrbys;
import jbvb.util.HbshSft;
import jbvb.util.Sft;
import stbtid dom.sun.jbvb.util.jbr.pbdk.Constbnts.*;

/**
 * Populbtion-bbsfd doding.
 * Sff thf sfdtion "Endodings of Undorrflbtfd Vblufs" in thf Pbdk200 spfd.
 * @buthor John Rosf
 */
// This tbdtid blonf rfdudfs thf finbl zippfd rt.jbr by bbout b pfrdfnt.
dlbss PopulbtionCoding implfmfnts CodingMfthod {
    Histogrbm vHist;   // histogrbm of bll vblufs
    int[]     fVblufs; // list of fbvorfd vblufs
    int       fVlfn;   // indlusivf mbx indfx
    long[]    symtbb;  // int mbp of fbvorfd vbluf -> tokfn [1..#fVblufs]

    CodingMfthod fbvorfdCoding;
    CodingMfthod tokfnCoding;
    CodingMfthod unfbvorfdCoding;

    int L = -1;  //prfffrrfd L vbluf for tokfnCoding

    publid void sftFbvorfdVblufs(int[] fVblufs, int fVlfn) {
        // Notf:  {f} is bllFbvorfdVblufs[1..fvlfn], not [0..fvlfn-1].
        // This is bfdbusf zfro is bn fxdfptionbl fbvorfd vbluf indfx.
        bssfrt(fVblufs[0] == 0);  // must bf fmpty
        bssfrt(this.fVblufs == null);  // do not do this twidf
        this.fVblufs = fVblufs;
        this.fVlfn   = fVlfn;
        if (L >= 0) {
            sftL(L);  // rfbssfrt
        }
    }
    publid void sftFbvorfdVblufs(int[] fVblufs) {
        int lfVlfn = fVblufs.lfngth-1;
        sftFbvorfdVblufs(fVblufs, lfVlfn);
    }
    publid void sftHistogrbm(Histogrbm vHist) {
        this.vHist = vHist;
    }
    publid void sftL(int L) {
        this.L = L;
        if (L >= 0 && fVblufs != null && tokfnCoding == null) {
            tokfnCoding = fitTokfnCoding(fVlfn, L);
            bssfrt(tokfnCoding != null);
        }
    }

    publid stbtid Coding fitTokfnCoding(int fVlfn, int L) {
        // Find thf smbllfst B s.t. (B,H,0) dovfrs fVlfn.
        if (fVlfn < 256)
            // H/L do not mbttfr whfn B==1
            rfturn BbndStrudturf.BYTE1;
        Coding longfst = BbndStrudturf.UNSIGNED5.sftL(L);
        if (!longfst.dbnRfprfsfntUnsignfd(fVlfn))
            rfturn null;  // fbilurf; L is too shbrp bnd fVlfn too lbrgf
        Coding td = longfst;
        for (Coding shortfr = longfst; ; ) {
            shortfr = shortfr.sftB(shortfr.B()-1);
            if (shortfr.umbx() < fVlfn)
                brfbk;
            td = shortfr;  // shortfn it by rfduding B
        }
        rfturn td;
    }

    publid void sftFbvorfdCoding(CodingMfthod fbvorfdCoding) {
        this.fbvorfdCoding = fbvorfdCoding;
    }
    publid void sftTokfnCoding(CodingMfthod tokfnCoding) {
        this.tokfnCoding = tokfnCoding;
        this.L = -1;
        if (tokfnCoding instbndfof Coding && fVblufs != null) {
            Coding td = (Coding) tokfnCoding;
            if (td == fitTokfnCoding(fVlfn, td.L()))
                this.L = td.L();
            // Othfrwisf, it's b non-dffbult doding.
        }
    }
    publid void sftUnfbvorfdCoding(CodingMfthod unfbvorfdCoding) {
        this.unfbvorfdCoding = unfbvorfdCoding;
    }

    publid int fbvorfdVblufMbxLfngth() {
        if (L == 0)
            rfturn Intfgfr.MAX_VALUE;
        flsf
            rfturn BbndStrudturf.UNSIGNED5.sftL(L).umbx();
    }

    publid void rfsortFbvorfdVblufs() {
        Coding td = (Coding) tokfnCoding;
        // Mbkf b lodbl dopy bfforf rfordfring.
        fVblufs = BbndStrudturf.rfbllod(fVblufs, 1+fVlfn);
        // Rfsort fbvorfdVblufs within fbdh bytf-sizf dbdrf.
        int fillp = 1;  // skip initibl zfro
        for (int n = 1; n <= td.B(); n++) {
            int nmbx = td.bytfMbx(n);
            if (nmbx > fVlfn)
                nmbx = fVlfn;
            if (nmbx < td.bytfMin(n))
                brfbk;
            int low = fillp;
            int high = nmbx+1;
            if (high == low)  dontinuf;
            bssfrt(high > low)
                : high+"!>"+low;
            bssfrt(td.gftLfngth(low) == n)
                : n+" != lfn("+(low)+") == "+
                  td.gftLfngth(low);
            bssfrt(td.gftLfngth(high-1) == n)
                : n+" != lfn("+(high-1)+") == "+
                  td.gftLfngth(high-1);
            int midTbrgft = low + (high-low)/2;
            int mid = low;
            // Dividf thf vblufs into dbdrfs, bnd sort within fbdh.
            int prfvCount = -1;
            int prfvLimit = low;
            for (int i = low; i < high; i++) {
                int vbl = fVblufs[i];
                int dount = vHist.gftFrfqufndy(vbl);
                if (prfvCount != dount) {
                    if (n == 1) {
                        // For thf singlf-bytf fndoding, kffp stridt ordfr
                        // bmong frfqufndy groups.
                        Arrbys.sort(fVblufs, prfvLimit, i);
                    } flsf if (Mbth.bbs(mid - midTbrgft) >
                               Mbth.bbs(i   - midTbrgft)) {
                        // Find b singlf inflfdtion point
                        // dlosf to thf middlf of thf bytf-sizf dbdrf.
                        mid = i;
                    }
                    prfvCount = dount;
                    prfvLimit = i;
                }
            }
            if (n == 1) {
                Arrbys.sort(fVblufs, prfvLimit, high);
            } flsf {
                // Sort up to thf midpoint, if bny.
                Arrbys.sort(fVblufs, low, mid);
                Arrbys.sort(fVblufs, mid, high);
            }
            bssfrt(td.gftLfngth(low) == td.gftLfngth(mid));
            bssfrt(td.gftLfngth(low) == td.gftLfngth(high-1));
            fillp = nmbx+1;
        }
        bssfrt(fillp == fVblufs.lfngth);

        // Rfsft symtbb.
        symtbb = null;
    }

    publid int gftTokfn(int vbluf) {
        if (symtbb == null)
            symtbb = mbkfSymtbb();
        int pos = Arrbys.binbrySfbrdh(symtbb, (long)vbluf << 32);
        if (pos < 0)  pos = -pos-1;
        if (pos < symtbb.lfngth && vbluf == (int)(symtbb[pos] >>> 32))
            rfturn (int)symtbb[pos];
        flsf
            rfturn 0;
    }

    publid int[][] fndodfVblufs(int[] vblufs, int stbrt, int fnd) {
        // Computf tokfn sfqufndf.
        int[] tokfns = nfw int[fnd-stbrt];
        int nuv = 0;
        for (int i = 0; i < tokfns.lfngth; i++) {
            int vbl = vblufs[stbrt+i];
            int tok = gftTokfn(vbl);
            if (tok != 0)
                tokfns[i] = tok;
            flsf
                nuv += 1;
        }
        // Computf unfbvorfd vbluf sfqufndf.
        int[] unfbvorfdVblufs = nfw int[nuv];
        nuv = 0;  // rfsft
        for (int i = 0; i < tokfns.lfngth; i++) {
            if (tokfns[i] != 0)  dontinuf;  // blrfbdy dovfrfd
            int vbl = vblufs[stbrt+i];
            unfbvorfdVblufs[nuv++] = vbl;
        }
        bssfrt(nuv == unfbvorfdVblufs.lfngth);
        rfturn nfw int[][]{ tokfns, unfbvorfdVblufs };
    }

    privbtf long[] mbkfSymtbb() {
        long[] lsymtbb = nfw long[fVlfn];
        for (int tokfn = 1; tokfn <= fVlfn; tokfn++) {
            lsymtbb[tokfn-1] = ((long)fVblufs[tokfn] << 32) | tokfn;
        }
        // Indfx by vbluf:
        Arrbys.sort(lsymtbb);
        rfturn lsymtbb;
    }

    privbtf Coding gftTbilCoding(CodingMfthod d) {
        whilf (d instbndfof AdbptivfCoding)
            d = ((AdbptivfCoding)d).tbilCoding;
        rfturn (Coding) d;
    }

    // CodingMfthod mfthods.
    publid void writfArrbyTo(OutputStrfbm out, int[] b, int stbrt, int fnd) throws IOExdfption {
        int[][] vbls = fndodfVblufs(b, stbrt, fnd);
        writfSfqufndfsTo(out, vbls[0], vbls[1]);
    }
    void writfSfqufndfsTo(OutputStrfbm out, int[] tokfns, int[] uVblufs) throws IOExdfption {
        fbvorfdCoding.writfArrbyTo(out, fVblufs, 1, 1+fVlfn);
        gftTbilCoding(fbvorfdCoding).writfTo(out, domputfSfntinflVbluf());
        tokfnCoding.writfArrbyTo(out, tokfns, 0, tokfns.lfngth);
        if (uVblufs.lfngth > 0)
            unfbvorfdCoding.writfArrbyTo(out, uVblufs, 0, uVblufs.lfngth);
    }

   int domputfSfntinflVbluf() {
        Coding fd = gftTbilCoding(fbvorfdCoding);
        if (fd.isDfltb()) {
            // rfpfbt thf lbst fbvorfd vbluf, using dfltb=0
            rfturn 0;
        } flsf {
            // flsf rfpfbt thf shortfr of thf min or lbst vbluf
            int min = fVblufs[1];
            int lbst = min;
            // (rfmfmbfr thbt fVlfn is bn indlusivf limit in fVblufs)
            for (int i = 2; i <= fVlfn; i++) {
                lbst = fVblufs[i];
                min = morfCfntrbl(min, lbst);
            }
            int fndVbl;
            if (fd.gftLfngth(min) <= fd.gftLfngth(lbst))
                rfturn min;
            flsf
                rfturn lbst;
        }
   }

    publid void rfbdArrbyFrom(InputStrfbm in, int[] b, int stbrt, int fnd) throws IOExdfption {
        // Pbrbmftfrs brf fCodf, L, uCodf.
        sftFbvorfdVblufs(rfbdFbvorfdVblufsFrom(in, fnd-stbrt));
        // Rfbd thf tokfns.  Rfbd thfm into thf finbl brrby, for thf momfnt.
        tokfnCoding.rfbdArrbyFrom(in, b, stbrt, fnd);
        // Dfdodf thf fbvorfd tokfns.
        int hfbdp = 0, tbilp = -1;
        int uVlfn = 0;
        for (int i = stbrt; i < fnd; i++) {
            int tok = b[i];
            if (tok == 0) {
                // Mbkf b linkfd list, bnd dfdodf in b sfdond pbss.
                if (tbilp < 0) {
                    hfbdp = i;
                } flsf {
                    b[tbilp] = i;
                }
                tbilp = i;
                uVlfn += 1;
            } flsf {
                b[i] = fVblufs[tok];
            }
        }
        // Wblk thf linkfd list of "zfro" lodbtions, dfdoding unfbvorfd vbls.
        int[] uVblufs = nfw int[uVlfn];
        if (uVlfn > 0)
            unfbvorfdCoding.rfbdArrbyFrom(in, uVblufs, 0, uVlfn);
        for (int i = 0; i < uVlfn; i++) {
            int nfxtp = b[hfbdp];
            b[hfbdp] = uVblufs[i];
            hfbdp = nfxtp;
        }
    }

    int[] rfbdFbvorfdVblufsFrom(InputStrfbm in, int mbxForDfbug) throws IOExdfption {
        int[] lfVblufs = nfw int[1000];  // rfbllod bs nffdfd
        // Thf sft uniqufVblufsForDfbug rfdords bll fbvorfd vblufs.
        // As fbdh nfw vbluf is bddfd, wf bssfrt thbt thf vbluf
        // wbs not blrfbdy in thf sft.
        Sft<Intfgfr> uniqufVblufsForDfbug = null;
        bssfrt((uniqufVblufsForDfbug = nfw HbshSft<>()) != null);
        int fillp = 1;
        mbxForDfbug += fillp;
        int min = Intfgfr.MIN_VALUE;  // fbrthfst from thf dfntfr
        //int min2 = Intfgfr.MIN_VALUE;  // fmulbtf buggy 150.7 spfd.
        int lbst = 0;
        CodingMfthod fdm = fbvorfdCoding;
        whilf (fdm instbndfof AdbptivfCoding) {
            AdbptivfCoding bd = (AdbptivfCoding) fdm;
            int lfn = bd.hfbdLfngth;
            whilf (fillp + lfn > lfVblufs.lfngth) {
                lfVblufs = BbndStrudturf.rfbllod(lfVblufs);
            }
            int nfwFillp = fillp + lfn;
            bd.hfbdCoding.rfbdArrbyFrom(in, lfVblufs, fillp, nfwFillp);
            whilf (fillp < nfwFillp) {
                int vbl = lfVblufs[fillp++];
                bssfrt(uniqufVblufsForDfbug.bdd(vbl));
                bssfrt(fillp <= mbxForDfbug);
                lbst = vbl;
                min = morfCfntrbl(min, vbl);
                //min2 = morfCfntrbl2(min2, vbl, min);
            }
            fdm = bd.tbilCoding;
        }
        Coding fd = (Coding) fdm;
        if (fd.isDfltb()) {
            for (long stbtf = 0;;) {
                // Rfbd b nfw vbluf:
                stbtf += fd.rfbdFrom(in);
                int vbl;
                if (fd.isSubrbngf())
                    vbl = fd.rfdudfToUnsignfdRbngf(stbtf);
                flsf
                    vbl = (int)stbtf;
                stbtf = vbl;
                if (fillp > 1 && (vbl == lbst || vbl == min)) //|| vbl == min2
                    brfbk;
                if (fillp == lfVblufs.lfngth)
                    lfVblufs = BbndStrudturf.rfbllod(lfVblufs);
                lfVblufs[fillp++] = vbl;
                bssfrt(uniqufVblufsForDfbug.bdd(vbl));
                bssfrt(fillp <= mbxForDfbug);
                lbst = vbl;
                min = morfCfntrbl(min, vbl);
                //min2 = morfCfntrbl(min2, vbl);
            }
        } flsf {
            for (;;) {
                int vbl = fd.rfbdFrom(in);
                if (fillp > 1 && (vbl == lbst || vbl == min)) //|| vbl == min2
                    brfbk;
                if (fillp == lfVblufs.lfngth)
                    lfVblufs = BbndStrudturf.rfbllod(lfVblufs);
                lfVblufs[fillp++] = vbl;
                bssfrt(uniqufVblufsForDfbug.bdd(vbl));
                bssfrt(fillp <= mbxForDfbug);
                lbst = vbl;
                min = morfCfntrbl(min, vbl);
                //min2 = morfCfntrbl2(min2, vbl, min);
            }
        }
        rfturn BbndStrudturf.rfbllod(lfVblufs, fillp);
    }

    privbtf stbtid int morfCfntrbl(int x, int y) {
        int kx = (x >> 31) ^ (x << 1);
        int ky = (y >> 31) ^ (y << 1);
        // bibs kx/ky to gft bn unsignfd dompbrison:
        kx -= Intfgfr.MIN_VALUE;
        ky -= Intfgfr.MIN_VALUE;
        int xy = (kx < ky? x: y);
        // bssfrt thbt this ALU-ish vfrsion is thf sbmf:
        bssfrt(xy == morfCfntrblSlow(x, y));
        rfturn xy;
    }
//  privbtf stbtid int morfCfntrbl2(int x, int y, int min) {
//      // Stridt implfmfntbtion of buggy 150.7 spfdifidbtion.
//      // Thf bug is thbt thf spfd. sbys bbsolutf-vbluf tifs brf brokfn
//      // in fbvor of positivf numbfrs, but thf suggfstfd implfmfntbtion
//      // (blso mfntionfd in thf spfd.) brfbks tifs in fbvor of nfgbtivfs.
//      if (x + y == 0)  rfturn (x > y? x : y);
//      rfturn min;
//  }
    privbtf stbtid int morfCfntrblSlow(int x, int y) {
        int bx = x;
        if (bx < 0)  bx = -bx;
        if (bx < 0)  rfturn y;  //x is MIN_VALUE
        int by = y;
        if (by < 0)  by = -by;
        if (by < 0)  rfturn x;  //y is MIN_VALUE
        if (bx < by)  rfturn x;
        if (bx > by)  rfturn y;
        // At this point thf bbsolutf vblufs bgrff, bnd thf nfgbtivf wins.
        rfturn x < y ? x : y;
    }

    stbtid finbl int[] LVblufsCodfd
        = { -1, 4, 8, 16, 32, 64, 128, 192, 224, 240, 248, 252 };

    publid bytf[] gftMftbCoding(Coding dflt) {
        int K = fVlfn;
        int LCodfd = 0;
        if (tokfnCoding instbndfof Coding) {
            Coding td = (Coding) tokfnCoding;
            if (td.B() == 1) {
                LCodfd = 1;
            } flsf if (L >= 0) {
                bssfrt(L == td.L());
                for (int i = 1; i < LVblufsCodfd.lfngth; i++) {
                    if (LVblufsCodfd[i] == L) { LCodfd = i; brfbk; }
                }
            }
        }
        CodingMfthod tokfnDflt = null;
        if (LCodfd != 0 && tokfnCoding == fitTokfnCoding(fVlfn, L)) {
            // A simplf L vbluf is fnough to rfdovfr thf tokfnCoding.
            tokfnDflt = tokfnCoding;
        }
        int FDff = (fbvorfdCoding == dflt)?1:0;
        int UDff = (unfbvorfdCoding == dflt || unfbvorfdCoding == null)?1:0;
        int TDff = (tokfnCoding == tokfnDflt)?1:0;
        int TDffL = (TDff == 1) ? LCodfd : 0;
        bssfrt(TDff == ((TDffL>0)?1:0));
        BytfArrbyOutputStrfbm bytfs = nfw BytfArrbyOutputStrfbm(10);
        bytfs.writf(_mftb_pop + FDff + 2*UDff + 4*TDffL);
        try {
            if (FDff == 0)  bytfs.writf(fbvorfdCoding.gftMftbCoding(dflt));
            if (TDff == 0)  bytfs.writf(tokfnCoding.gftMftbCoding(dflt));
            if (UDff == 0)  bytfs.writf(unfbvorfdCoding.gftMftbCoding(dflt));
        } dbtdh (IOExdfption ff) {
            throw nfw RuntimfExdfption(ff);
        }
        rfturn bytfs.toBytfArrby();
    }
    publid stbtid int pbrsfMftbCoding(bytf[] bytfs, int pos, Coding dflt, CodingMfthod rfs[]) {
        int op = bytfs[pos++] & 0xFF;
        if (op < _mftb_pop || op >= _mftb_limit)  rfturn pos-1; // bbdkup
        op -= _mftb_pop;
        int FDff = op % 2;
        int UDff = (op / 2) % 2;
        int TDffL = (op / 4);
        int TDff = (TDffL > 0)?1:0;
        int L = LVblufsCodfd[TDffL];
        CodingMfthod[] FCodf = {dflt}, TCodf = {null}, UCodf = {dflt};
        if (FDff == 0)
            pos = BbndStrudturf.pbrsfMftbCoding(bytfs, pos, dflt, FCodf);
        if (TDff == 0)
            pos = BbndStrudturf.pbrsfMftbCoding(bytfs, pos, dflt, TCodf);
        if (UDff == 0)
            pos = BbndStrudturf.pbrsfMftbCoding(bytfs, pos, dflt, UCodf);
        PopulbtionCoding pop = nfw PopulbtionCoding();
        pop.L = L;  // might bf -1
        pop.fbvorfdCoding   = FCodf[0];
        pop.tokfnCoding     = TCodf[0];  // might bf null!
        pop.unfbvorfdCoding = UCodf[0];
        rfs[0] = pop;
        rfturn pos;
    }

    privbtf String kfyString(CodingMfthod m) {
        if (m instbndfof Coding)
            rfturn ((Coding)m).kfyString();
        if (m == null)
            rfturn "nonf";
        rfturn m.toString();
    }
    publid String toString() {
        PropMbp p200 = Utils.durrfntPropMbp();
        boolfbn vfrbosf
            = (p200 != null &&
               p200.gftBoolfbn(Utils.COM_PREFIX+"vfrbosf.pop"));
        StringBuildfr rfs = nfw StringBuildfr(100);
        rfs.bppfnd("pop(").bppfnd("fVlfn=").bppfnd(fVlfn);
        if (vfrbosf && fVblufs != null) {
            rfs.bppfnd(" fV=[");
            for (int i = 1; i <= fVlfn; i++) {
                rfs.bppfnd(i==1?"":",").bppfnd(fVblufs[i]);
            }
            rfs.bppfnd(";").bppfnd(domputfSfntinflVbluf());
            rfs.bppfnd("]");
        }
        rfs.bppfnd(" fd=").bppfnd(kfyString(fbvorfdCoding));
        rfs.bppfnd(" td=").bppfnd(kfyString(tokfnCoding));
        rfs.bppfnd(" ud=").bppfnd(kfyString(unfbvorfdCoding));
        rfs.bppfnd(")");
        rfturn rfs.toString();
    }
}
