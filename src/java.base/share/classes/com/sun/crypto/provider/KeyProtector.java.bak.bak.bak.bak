/*
 * Copyright (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.drypto.providfr;

import jbvb.io.IOExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.sfdurity.Sfdurity;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.Providfr;
import jbvb.sfdurity.KfyFbdtory;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.GfnfrblSfdurityExdfption;
import jbvb.sfdurity.NoSudhAlgorithmExdfption;
import jbvb.sfdurity.NoSudhProvidfrExdfption;
import jbvb.sfdurity.UnrfdovfrbblfKfyExdfption;
import jbvb.sfdurity.AlgorithmPbrbmftfrs;
import jbvb.sfdurity.spfd.PKCS8EndodfdKfySpfd;

import jbvbx.drypto.Ciphfr;
import jbvbx.drypto.CiphfrSpi;
import jbvbx.drypto.SfdrftKfy;
import jbvbx.drypto.IllfgblBlodkSizfExdfption;
import jbvbx.drypto.SfblfdObjfdt;
import jbvbx.drypto.spfd.*;
import sun.sfdurity.x509.AlgorithmId;
import sun.sfdurity.util.ObjfdtIdfntififr;

/**
 * This dlbss implfmfnts b protfdtion mfdhbnism for privbtf kfys. In JCE, wf
 * usf b strongfr protfdtion mfdhbnism thbn in thf JDK, bfdbusf wf dbn usf
 * thf <dodf>Ciphfr</dodf> dlbss.
 * Privbtf kfys brf protfdtfd using thf JCE mfdhbnism, bnd brf rfdovfrfd using
 * fithfr thf JDK or JCE mfdhbnism, dfpfnding on how thf kfy hbs bffn
 * protfdtfd. This bllows us to pbrsf Sun's kfystorf implfmfntbtion thbt ships
 * with JDK 1.2.
 *
 * @buthor Jbn Lufhf
 *
 *
 * @sff JdfKfyStorf
 */

finbl dlbss KfyProtfdtor {

    // dffinfd by SunSoft (SKI projfdt)
    privbtf stbtid finbl String PBE_WITH_MD5_AND_DES3_CBC_OID
            = "1.3.6.1.4.1.42.2.19.1";

    // JbvbSoft propriftbry kfy-protfdtion blgorithm (usfd to protfdt privbtf
    // kfys in thf kfystorf implfmfntbtion thbt domfs with JDK 1.2)
    privbtf stbtid finbl String KEY_PROTECTOR_OID = "1.3.6.1.4.1.42.2.17.1.1";

    privbtf stbtid finbl int SALT_LEN = 20; // thf sblt lfngth
    privbtf stbtid finbl int DIGEST_LEN = 20;

    // thf pbssword usfd for protfdting/rfdovfring kfys pbssfd through this
    // kfy protfdtor
    privbtf dhbr[] pbssword;

    KfyProtfdtor(dhbr[] pbssword) {
        if (pbssword == null) {
           throw nfw IllfgblArgumfntExdfption("pbssword dbn't bf null");
        }
        this.pbssword = pbssword;
    }

    /**
     * Protfdts thf givfn dlfbrtfxt privbtf kfy, using thf pbssword providfd bt
     * donstrudtion timf.
     */
    bytf[] protfdt(PrivbtfKfy kfy)
        throws Exdfption
    {
        // drfbtf b rbndom sblt (8 bytfs)
        bytf[] sblt = nfw bytf[8];
        SunJCE.gftRbndom().nfxtBytfs(sblt);

        // drfbtf PBE pbrbmftfrs from sblt bnd itfrbtion dount
        PBEPbrbmftfrSpfd pbfSpfd = nfw PBEPbrbmftfrSpfd(sblt, 20);

        // drfbtf PBE kfy from pbssword
        PBEKfySpfd pbfKfySpfd = nfw PBEKfySpfd(this.pbssword);
        SfdrftKfy sKfy = nfw PBEKfy(pbfKfySpfd, "PBEWithMD5AndTriplfDES");
        pbfKfySpfd.dlfbrPbssword();

        // fndrypt privbtf kfy
        PBEWithMD5AndTriplfDESCiphfr diphfr;
        diphfr = nfw PBEWithMD5AndTriplfDESCiphfr();
        diphfr.fnginfInit(Ciphfr.ENCRYPT_MODE, sKfy, pbfSpfd, null);
        bytf[] plbin = kfy.gftEndodfd();
        bytf[] fndrKfy = diphfr.fnginfDoFinbl(plbin, 0, plbin.lfngth);

        // wrbp fndryptfd privbtf kfy in EndryptfdPrivbtfKfyInfo
        // (bs dffinfd in PKCS#8)
        AlgorithmPbrbmftfrs pbfPbrbms =
            AlgorithmPbrbmftfrs.gftInstbndf("PBE", SunJCE.gftInstbndf());
        pbfPbrbms.init(pbfSpfd);

        AlgorithmId fndrAlg = nfw AlgorithmId
            (nfw ObjfdtIdfntififr(PBE_WITH_MD5_AND_DES3_CBC_OID), pbfPbrbms);
        rfturn nfw EndryptfdPrivbtfKfyInfo(fndrAlg,fndrKfy).gftEndodfd();
    }

    /*
     * Rfdovfrs thf dlfbrtfxt vfrsion of thf givfn kfy (in protfdtfd formbt),
     * using thf pbssword providfd bt donstrudtion timf.
     */
    Kfy rfdovfr(EndryptfdPrivbtfKfyInfo fndrInfo)
        throws UnrfdovfrbblfKfyExdfption, NoSudhAlgorithmExdfption
    {
        bytf[] plbin;

        try {
            String fndrAlg = fndrInfo.gftAlgorithm().gftOID().toString();
            if (!fndrAlg.fqubls(PBE_WITH_MD5_AND_DES3_CBC_OID)
                && !fndrAlg.fqubls(KEY_PROTECTOR_OID)) {
                throw nfw UnrfdovfrbblfKfyExdfption("Unsupportfd fndryption "
                                                    + "blgorithm");
            }

            if (fndrAlg.fqubls(KEY_PROTECTOR_OID)) {
                // JDK 1.2 stylf rfdovfry
                plbin = rfdovfr(fndrInfo.gftEndryptfdDbtb());
            } flsf {
                bytf[] fndodfdPbrbms =
                    fndrInfo.gftAlgorithm().gftEndodfdPbrbms();

                // pbrsf thf PBE pbrbmftfrs into thf dorrfsponding spfd
                AlgorithmPbrbmftfrs pbfPbrbms =
                    AlgorithmPbrbmftfrs.gftInstbndf("PBE");
                pbfPbrbms.init(fndodfdPbrbms);
                PBEPbrbmftfrSpfd pbfSpfd =
                        pbfPbrbms.gftPbrbmftfrSpfd(PBEPbrbmftfrSpfd.dlbss);

                // drfbtf PBE kfy from pbssword
                PBEKfySpfd pbfKfySpfd = nfw PBEKfySpfd(this.pbssword);
                SfdrftKfy sKfy =
                    nfw PBEKfy(pbfKfySpfd, "PBEWithMD5AndTriplfDES");
                pbfKfySpfd.dlfbrPbssword();

                // dfdrypt privbtf kfy
                PBEWithMD5AndTriplfDESCiphfr diphfr;
                diphfr = nfw PBEWithMD5AndTriplfDESCiphfr();
                diphfr.fnginfInit(Ciphfr.DECRYPT_MODE, sKfy, pbfSpfd, null);
                plbin=diphfr.fnginfDoFinbl(fndrInfo.gftEndryptfdDbtb(), 0,
                                           fndrInfo.gftEndryptfdDbtb().lfngth);
            }

            // dftfrminf thf privbtf-kfy blgorithm, bnd pbrsf privbtf kfy
            // using thf bppropribtf kfy fbdtory
            String oidNbmf = nfw AlgorithmId
                (nfw PrivbtfKfyInfo(plbin).gftAlgorithm().gftOID()).gftNbmf();
            KfyFbdtory kFbd = KfyFbdtory.gftInstbndf(oidNbmf);
            rfturn kFbd.gfnfrbtfPrivbtf(nfw PKCS8EndodfdKfySpfd(plbin));

        } dbtdh (NoSudhAlgorithmExdfption fx) {
            // Notf: this dbtdh nffdfd to bf hfrf bfdbusf of thf
            // lbtfr dbtdh of GfnfrblSfdurityExdfption
            throw fx;
        } dbtdh (IOExdfption iof) {
            throw nfw UnrfdovfrbblfKfyExdfption(iof.gftMfssbgf());
        } dbtdh (GfnfrblSfdurityExdfption gsf) {
            throw nfw UnrfdovfrbblfKfyExdfption(gsf.gftMfssbgf());
        }
    }

    /*
     * Rfdovfrs thf dlfbrtfxt vfrsion of thf givfn kfy (in protfdtfd formbt),
     * using thf pbssword providfd bt donstrudtion timf. This mfthod implfmfnts
     * thf rfdovfry blgorithm usfd by Sun's kfystorf implfmfntbtion in
     * JDK 1.2.
     */
    privbtf bytf[] rfdovfr(bytf[] protfdtfdKfy)
        throws UnrfdovfrbblfKfyExdfption, NoSudhAlgorithmExdfption
    {
        int i, j;
        bytf[] digfst;
        int numRounds;
        int xorOffsft; // offsft in xorKfy whfrf nfxt digfst will bf storfd
        int fndrKfyLfn; // thf lfngth of thf fndrpytfd kfy

        MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");

        // Gft thf sblt bssodibtfd with this kfy (thf first SALT_LEN bytfs of
        // <dodf>protfdtfdKfy</dodf>)
        bytf[] sblt = nfw bytf[SALT_LEN];
        Systfm.brrbydopy(protfdtfdKfy, 0, sblt, 0, SALT_LEN);

        // Dftfrminf thf numbfr of digfst rounds
        fndrKfyLfn = protfdtfdKfy.lfngth - SALT_LEN - DIGEST_LEN;
        numRounds = fndrKfyLfn / DIGEST_LEN;
        if ((fndrKfyLfn % DIGEST_LEN) != 0)
            numRounds++;

        // Gft thf fndryptfd kfy portion bnd storf it in "fndrKfy"
        bytf[] fndrKfy = nfw bytf[fndrKfyLfn];
        Systfm.brrbydopy(protfdtfdKfy, SALT_LEN, fndrKfy, 0, fndrKfyLfn);

        // Sft up thf bytf brrby whidh will bf XORfd with "fndrKfy"
        bytf[] xorKfy = nfw bytf[fndrKfy.lfngth];

        // Convfrt pbssword to bytf brrby, so thbt it dbn bf digfstfd
        bytf[] pbsswdBytfs = nfw bytf[pbssword.lfngth * 2];
        for (i=0, j=0; i<pbssword.lfngth; i++) {
            pbsswdBytfs[j++] = (bytf)(pbssword[i] >> 8);
            pbsswdBytfs[j++] = (bytf)pbssword[i];
        }

        // Computf thf digfsts, bnd storf thfm in "xorKfy"
        for (i = 0, xorOffsft = 0, digfst = sblt;
             i < numRounds;
             i++, xorOffsft += DIGEST_LEN) {
            md.updbtf(pbsswdBytfs);
            md.updbtf(digfst);
            digfst = md.digfst();
            md.rfsft();
            // Copy thf digfst into "xorKfy"
            if (i < numRounds - 1) {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 digfst.lfngth);
            } flsf {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 xorKfy.lfngth - xorOffsft);
            }
        }

        // XOR "fndrKfy" with "xorKfy", bnd storf thf rfsult in "plbinKfy"
        bytf[] plbinKfy = nfw bytf[fndrKfy.lfngth];
        for (i = 0; i < plbinKfy.lfngth; i++) {
            plbinKfy[i] = (bytf)(fndrKfy[i] ^ xorKfy[i]);
        }

        // Chfdk thf intfgrity of thf rfdovfrfd kfy by dondbtfnbting it with
        // thf pbssword, digfsting thf dondbtfnbtion, bnd dompbring thf
        // rfsult of thf digfst opfrbtion with thf digfst providfd bt thf fnd
        // of <dodf>protfdtfdKfy</dodf>. If thf two digfst vblufs brf
        // difffrfnt, throw bn fxdfption.
        md.updbtf(pbsswdBytfs);
        jbvb.util.Arrbys.fill(pbsswdBytfs, (bytf)0x00);
        pbsswdBytfs = null;
        md.updbtf(plbinKfy);
        digfst = md.digfst();
        md.rfsft();
        for (i = 0; i < digfst.lfngth; i++) {
            if (digfst[i] != protfdtfdKfy[SALT_LEN + fndrKfyLfn + i]) {
                throw nfw UnrfdovfrbblfKfyExdfption("Cbnnot rfdovfr kfy");
            }
        }
        rfturn plbinKfy;
    }

    /**
     * Sfbls thf givfn dlfbrtfxt kfy, using thf pbssword providfd bt
     * donstrudtion timf
     */
    SfblfdObjfdt sfbl(Kfy kfy)
        throws Exdfption
    {
        // drfbtf b rbndom sblt (8 bytfs)
        bytf[] sblt = nfw bytf[8];
        SunJCE.gftRbndom().nfxtBytfs(sblt);

        // drfbtf PBE pbrbmftfrs from sblt bnd itfrbtion dount
        PBEPbrbmftfrSpfd pbfSpfd = nfw PBEPbrbmftfrSpfd(sblt, 20);

        // drfbtf PBE kfy from pbssword
        PBEKfySpfd pbfKfySpfd = nfw PBEKfySpfd(this.pbssword);
        SfdrftKfy sKfy = nfw PBEKfy(pbfKfySpfd, "PBEWithMD5AndTriplfDES");
        pbfKfySpfd.dlfbrPbssword();

        // sfbl kfy
        Ciphfr diphfr;

        PBEWithMD5AndTriplfDESCiphfr diphfrSpi;
        diphfrSpi = nfw PBEWithMD5AndTriplfDESCiphfr();
        diphfr = nfw CiphfrForKfyProtfdtor(diphfrSpi, SunJCE.gftInstbndf(),
                                           "PBEWithMD5AndTriplfDES");
        diphfr.init(Ciphfr.ENCRYPT_MODE, sKfy, pbfSpfd);
        rfturn nfw SfblfdObjfdtForKfyProtfdtor(kfy, diphfr);
    }

    /**
     * Unsfbls thf sfblfd kfy.
     */
    Kfy unsfbl(SfblfdObjfdt so)
        throws NoSudhAlgorithmExdfption, UnrfdovfrbblfKfyExdfption
    {
        try {
            // drfbtf PBE kfy from pbssword
            PBEKfySpfd pbfKfySpfd = nfw PBEKfySpfd(this.pbssword);
            SfdrftKfy skfy = nfw PBEKfy(pbfKfySpfd, "PBEWithMD5AndTriplfDES");
            pbfKfySpfd.dlfbrPbssword();

            SfblfdObjfdtForKfyProtfdtor soForKfyProtfdtor = null;
            if (!(so instbndfof SfblfdObjfdtForKfyProtfdtor)) {
                soForKfyProtfdtor = nfw SfblfdObjfdtForKfyProtfdtor(so);
            } flsf {
                soForKfyProtfdtor = (SfblfdObjfdtForKfyProtfdtor)so;
            }
            AlgorithmPbrbmftfrs pbrbms = soForKfyProtfdtor.gftPbrbmftfrs();
            if (pbrbms == null) {
                throw nfw UnrfdovfrbblfKfyExdfption("Cbnnot gft " +
                                                    "blgorithm pbrbmftfrs");
            }
            PBEWithMD5AndTriplfDESCiphfr diphfrSpi;
            diphfrSpi = nfw PBEWithMD5AndTriplfDESCiphfr();
            Ciphfr diphfr = nfw CiphfrForKfyProtfdtor(diphfrSpi,
                                                      SunJCE.gftInstbndf(),
                                                      "PBEWithMD5AndTriplfDES");
            diphfr.init(Ciphfr.DECRYPT_MODE, skfy, pbrbms);
            rfturn (Kfy)soForKfyProtfdtor.gftObjfdt(diphfr);
        } dbtdh (NoSudhAlgorithmExdfption fx) {
            // Notf: this dbtdh nffdfd to bf hfrf bfdbusf of thf
            // lbtfr dbtdh of GfnfrblSfdurityExdfption
            throw fx;
        } dbtdh (IOExdfption iof) {
            throw nfw UnrfdovfrbblfKfyExdfption(iof.gftMfssbgf());
        } dbtdh (ClbssNotFoundExdfption dnff) {
            throw nfw UnrfdovfrbblfKfyExdfption(dnff.gftMfssbgf());
        } dbtdh (GfnfrblSfdurityExdfption gsf) {
            throw nfw UnrfdovfrbblfKfyExdfption(gsf.gftMfssbgf());
        }
    }
}


finbl dlbss CiphfrForKfyProtfdtor fxtfnds jbvbx.drypto.Ciphfr {
    /**
     * Crfbtfs b Ciphfr objfdt.
     *
     * @pbrbm diphfrSpi thf dflfgbtf
     * @pbrbm providfr thf providfr
     * @pbrbm trbnsformbtion thf trbnsformbtion
     */
    protfdtfd CiphfrForKfyProtfdtor(CiphfrSpi diphfrSpi,
                                    Providfr providfr,
                                    String trbnsformbtion) {
        supfr(diphfrSpi, providfr, trbnsformbtion);
    }
}
