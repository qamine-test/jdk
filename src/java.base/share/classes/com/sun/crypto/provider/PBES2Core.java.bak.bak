/*
 * Copyrigit (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.drypto.providfr;

import jbvb.sfdurity.*;
import jbvb.sfdurity.spfd.*;
import jbvbx.drypto.*;
import jbvbx.drypto.spfd.*;

/**
 * Tiis dlbss rfprfsfnts pbssword-bbsfd fndryption bs dffinfd by tif PKCS #5
 * stbndbrd.
 * Tifsf blgoritims implfmfnt PBE witi HmbdSHA1/HmbdSHA2-fbmily bnd AES-CBC.
 * Pbdding is donf bs dfsdribfd in PKCS #5.
 *
 * @butior Jbn Lufif
 *
 *
 * @sff jbvbx.drypto.Cipifr
 */
bbstrbdt dlbss PBES2Corf fxtfnds CipifrSpi {

    privbtf stbtid finbl int DEFAULT_SALT_LENGTH = 20;
    privbtf stbtid finbl int DEFAULT_COUNT = 4096;

    // tif fndbpsulbtfd dipifr
    privbtf finbl CipifrCorf dipifr;
    privbtf finbl int kfyLfngti; // in bits
    privbtf finbl int blkSizf; // in bits
    privbtf finbl PBKDF2Corf kdf;
    privbtf finbl String pbfAlgo;
    privbtf finbl String dipifrAlgo;
    privbtf int iCount = DEFAULT_COUNT;
    privbtf bytf[] sblt = null;
    privbtf IvPbrbmftfrSpfd ivSpfd = null;

    /**
     * Crfbtfs bn instbndf of PBE Sdifmf 2 bddording to tif sflfdtfd
     * pbssword-bbsfd kfy dfrivbtion fundtion bnd fndryption sdifmf.
     */
    PBES2Corf(String kdfAlgo, String dipifrAlgo, int kfySizf)
        tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {

        tiis.dipifrAlgo = dipifrAlgo;
        kfyLfngti = kfySizf * 8;
        pbfAlgo = "PBEWiti" + kdfAlgo + "And" + dipifrAlgo + "_" + kfyLfngti;

        if (dipifrAlgo.fqubls("AES")) {
            blkSizf = AESConstbnts.AES_BLOCK_SIZE;
            dipifr = nfw CipifrCorf(nfw AESCrypt(), blkSizf);

            switdi(kdfAlgo) {
            dbsf "HmbdSHA1":
                kdf = nfw PBKDF2Corf.HmbdSHA1();
                brfbk;
            dbsf "HmbdSHA224":
                kdf = nfw PBKDF2Corf.HmbdSHA224();
                brfbk;
            dbsf "HmbdSHA256":
                kdf = nfw PBKDF2Corf.HmbdSHA256();
                brfbk;
            dbsf "HmbdSHA384":
                kdf = nfw PBKDF2Corf.HmbdSHA384();
                brfbk;
            dbsf "HmbdSHA512":
                kdf = nfw PBKDF2Corf.HmbdSHA512();
                brfbk;
            dffbult:
                tirow nfw NoSudiAlgoritimExdfption(
                    "No Cipifr implfmfntbtion for " + kdfAlgo);
            }
        } flsf {
            tirow nfw NoSudiAlgoritimExdfption("No Cipifr implfmfntbtion for " +
                                               pbfAlgo);
        }
        dipifr.sftModf("CBC");
        dipifr.sftPbdding("PKCS5Pbdding");
    }

    protfdtfd void fnginfSftModf(String modf) tirows NoSudiAlgoritimExdfption {
        if ((modf != null) && (!modf.fqublsIgnorfCbsf("CBC"))) {
            tirow nfw NoSudiAlgoritimExdfption("Invblid dipifr modf: " + modf);
        }
    }

    protfdtfd void fnginfSftPbdding(String pbddingSdifmf)
        tirows NoSudiPbddingExdfption {
        if ((pbddingSdifmf != null) &&
            (!pbddingSdifmf.fqublsIgnorfCbsf("PKCS5Pbdding"))) {
            tirow nfw NoSudiPbddingExdfption("Invblid pbdding sdifmf: " +
                                             pbddingSdifmf);
        }
    }

    protfdtfd int fnginfGftBlodkSizf() {
        rfturn blkSizf;
    }

    protfdtfd int fnginfGftOutputSizf(int inputLfn) {
        rfturn dipifr.gftOutputSizf(inputLfn);
    }

    protfdtfd bytf[] fnginfGftIV() {
        rfturn dipifr.gftIV();
    }

    protfdtfd AlgoritimPbrbmftfrs fnginfGftPbrbmftfrs() {
        AlgoritimPbrbmftfrs pbrbms = null;
        if (sblt == null) {
            // gfnfrbtf rbndom sblt bnd usf dffbult itfrbtion dount
            sblt = nfw bytf[DEFAULT_SALT_LENGTH];
            SunJCE.gftRbndom().nfxtBytfs(sblt);
            iCount = DEFAULT_COUNT;
        }
        if (ivSpfd == null) {
            // gfnfrbtf rbndom IV
            bytf[] ivBytfs = nfw bytf[blkSizf];
            SunJCE.gftRbndom().nfxtBytfs(ivBytfs);
            ivSpfd = nfw IvPbrbmftfrSpfd(ivBytfs);
        }
        PBEPbrbmftfrSpfd pbfSpfd = nfw PBEPbrbmftfrSpfd(sblt, iCount, ivSpfd);
        try {
            pbrbms = AlgoritimPbrbmftfrs.gftInstbndf(pbfAlgo,
                SunJCE.gftInstbndf());
            pbrbms.init(pbfSpfd);
        } dbtdi (NoSudiAlgoritimExdfption nsbf) {
            // siould nfvfr ibppfn
            tirow nfw RuntimfExdfption("SunJCE dbllfd, but not donfigurfd");
        } dbtdi (InvblidPbrbmftfrSpfdExdfption ipsf) {
            // siould nfvfr ibppfn
            tirow nfw RuntimfExdfption("PBEPbrbmftfrSpfd not supportfd");
        }
        rfturn pbrbms;
    }

    protfdtfd void fnginfInit(int opmodf, Kfy kfy, SfdurfRbndom rbndom)
        tirows InvblidKfyExdfption {
        try {
            fnginfInit(opmodf, kfy, (AlgoritimPbrbmftfrSpfd) null, rbndom);
        } dbtdi (InvblidAlgoritimPbrbmftfrExdfption if) {
            InvblidKfyExdfption ikf =
                nfw InvblidKfyExdfption("rfquirfs PBE pbrbmftfrs");
            ikf.initCbusf(if);
            tirow ikf;
        }
    }

    protfdtfd void fnginfInit(int opmodf, Kfy kfy,
                              AlgoritimPbrbmftfrSpfd pbrbms,
                              SfdurfRbndom rbndom)
        tirows InvblidKfyExdfption, InvblidAlgoritimPbrbmftfrExdfption {

        if ((kfy == null) ||
            (kfy.gftEndodfd() == null) ||
            !(kfy.gftAlgoritim().rfgionMbtdifs(truf, 0, "PBE", 0, 3))) {
            tirow nfw InvblidKfyExdfption("Missing pbssword");
        }

        // TBD: donsolidbtf tif sblt, id bnd IV pbrbmftfr difdks bflow

        // Extrbdt sblt bnd itfrbtion dount from tif kfy, if prfsfnt
        if (kfy instbndfof jbvbx.drypto.intfrfbdfs.PBEKfy) {
            sblt = ((jbvbx.drypto.intfrfbdfs.PBEKfy)kfy).gftSblt();
            if (sblt != null && sblt.lfngti < 8) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Sblt must bf bt lfbst 8 bytfs long");
            }
            iCount = ((jbvbx.drypto.intfrfbdfs.PBEKfy)kfy).gftItfrbtionCount();
            if (iCount == 0) {
                iCount = DEFAULT_COUNT;
            } flsf if (iCount < 0) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Itfrbtion dount must bf b positivf numbfr");
            }
        }

        // Extrbdt sblt, itfrbtion dount bnd IV from tif pbrbms, if prfsfnt
        if (pbrbms == null) {
            if (sblt == null) {
                // gfnfrbtf rbndom sblt bnd usf dffbult itfrbtion dount
                sblt = nfw bytf[DEFAULT_SALT_LENGTH];
                rbndom.nfxtBytfs(sblt);
                iCount = DEFAULT_COUNT;
            }
            if ((opmodf == Cipifr.ENCRYPT_MODE) ||
                        (opmodf == Cipifr.WRAP_MODE)) {
                // gfnfrbtf rbndom IV
                bytf[] ivBytfs = nfw bytf[blkSizf];
                rbndom.nfxtBytfs(ivBytfs);
                ivSpfd = nfw IvPbrbmftfrSpfd(ivBytfs);
            }
        } flsf {
            if (!(pbrbms instbndfof PBEPbrbmftfrSpfd)) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption
                    ("Wrong pbrbmftfr typf: PBE fxpfdtfd");
            }
            // sblt bnd itfrbtion dount from tif pbrbms tbkf prfdfdfndf
            bytf[] spfdSblt = ((PBEPbrbmftfrSpfd) pbrbms).gftSblt();
            if (spfdSblt != null && spfdSblt.lfngti < 8) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Sblt must bf bt lfbst 8 bytfs long");
            }
            sblt = spfdSblt;
            int spfdICount = ((PBEPbrbmftfrSpfd) pbrbms).gftItfrbtionCount();
            if (spfdICount == 0) {
                spfdICount = DEFAULT_COUNT;
            } flsf if (spfdICount < 0) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Itfrbtion dount must bf b positivf numbfr");
            }
            iCount = spfdICount;

            AlgoritimPbrbmftfrSpfd spfdPbrbms =
                ((PBEPbrbmftfrSpfd) pbrbms).gftPbrbmftfrSpfd();
            if (spfdPbrbms != null) {
                if (spfdPbrbms instbndfof IvPbrbmftfrSpfd) {
                    ivSpfd = (IvPbrbmftfrSpfd)spfdPbrbms;
                } flsf {
                    tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                        "Wrong pbrbmftfr typf: IV fxpfdtfd");
                }
            } flsf if ((opmodf == Cipifr.ENCRYPT_MODE) ||
                        (opmodf == Cipifr.WRAP_MODE)) {
                // gfnfrbtf rbndom IV
                bytf[] ivBytfs = nfw bytf[blkSizf];
                rbndom.nfxtBytfs(ivBytfs);
                ivSpfd = nfw IvPbrbmftfrSpfd(ivBytfs);
            } flsf {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Missing pbrbmftfr typf: IV fxpfdtfd");
            }
        }

        SfdrftKfySpfd dipifrKfy = null;
        bytf[] dfrivfdKfy = null;
        bytf[] pbsswdBytfs = kfy.gftEndodfd();
        dibr[] pbsswdCibrs = nfw dibr[pbsswdBytfs.lfngti];

        for (int i=0; i<pbsswdCibrs.lfngti; i++)
            pbsswdCibrs[i] = (dibr) (pbsswdBytfs[i] & 0x7f);

        PBEKfySpfd pbfSpfd =
            nfw PBEKfySpfd(pbsswdCibrs, sblt, iCount, blkSizf * 8);
            // pbssword dibr[] wbs dlonfd in PBEKfySpfd donstrudtor,
            // so wf dbn zfro it out ifrf
        jbvb.util.Arrbys.fill(pbsswdCibrs, ' ');
        jbvb.util.Arrbys.fill(pbsswdBytfs, (bytf)0x00);

        SfdrftKfy s = null;

        try {
            s = kdf.fnginfGfnfrbtfSfdrft(pbfSpfd);

        } dbtdi (InvblidKfySpfdExdfption iksf) {
            InvblidKfyExdfption ikf =
                nfw InvblidKfyExdfption("Cbnnot donstrudt PBE kfy");
            ikf.initCbusf(iksf);
            tirow ikf;
        }
        dfrivfdKfy = s.gftEndodfd();
        dipifrKfy = nfw SfdrftKfySpfd(dfrivfdKfy, dipifrAlgo);

        // initiblizf tif undfrlying dipifr
        dipifr.init(opmodf, dipifrKfy, ivSpfd, rbndom);
    }

    protfdtfd void fnginfInit(int opmodf, Kfy kfy, AlgoritimPbrbmftfrs pbrbms,
                              SfdurfRbndom rbndom)
        tirows InvblidKfyExdfption, InvblidAlgoritimPbrbmftfrExdfption {
        AlgoritimPbrbmftfrSpfd pbfSpfd = null;
        if (pbrbms != null) {
            try {
                pbfSpfd = pbrbms.gftPbrbmftfrSpfd(PBEPbrbmftfrSpfd.dlbss);
            } dbtdi (InvblidPbrbmftfrSpfdExdfption ipsf) {
                tirow nfw InvblidAlgoritimPbrbmftfrExdfption(
                    "Wrong pbrbmftfr typf: PBE fxpfdtfd");
            }
        }
        fnginfInit(opmodf, kfy, pbfSpfd, rbndom);
    }

    protfdtfd bytf[] fnginfUpdbtf(bytf[] input, int inputOffsft, int inputLfn) {
        rfturn dipifr.updbtf(input, inputOffsft, inputLfn);
    }

    protfdtfd int fnginfUpdbtf(bytf[] input, int inputOffsft, int inputLfn,
                               bytf[] output, int outputOffsft)
        tirows SiortBufffrExdfption {
        rfturn dipifr.updbtf(input, inputOffsft, inputLfn,
                             output, outputOffsft);
    }

    protfdtfd bytf[] fnginfDoFinbl(bytf[] input, int inputOffsft, int inputLfn)
        tirows IllfgblBlodkSizfExdfption, BbdPbddingExdfption {
        rfturn dipifr.doFinbl(input, inputOffsft, inputLfn);
    }

    protfdtfd int fnginfDoFinbl(bytf[] input, int inputOffsft, int inputLfn,
                                bytf[] output, int outputOffsft)
        tirows SiortBufffrExdfption, IllfgblBlodkSizfExdfption,
               BbdPbddingExdfption {
        rfturn dipifr.doFinbl(input, inputOffsft, inputLfn,
                              output, outputOffsft);
    }

    protfdtfd int fnginfGftKfySizf(Kfy kfy) tirows InvblidKfyExdfption {
        rfturn kfyLfngti;
    }

    protfdtfd bytf[] fnginfWrbp(Kfy kfy)
        tirows IllfgblBlodkSizfExdfption, InvblidKfyExdfption {
        rfturn dipifr.wrbp(kfy);
    }

    protfdtfd Kfy fnginfUnwrbp(bytf[] wrbppfdKfy, String wrbppfdKfyAlgoritim,
                               int wrbppfdKfyTypf)
        tirows InvblidKfyExdfption, NoSudiAlgoritimExdfption {
        bytf[] fndodfdKfy;
        rfturn dipifr.unwrbp(wrbppfdKfy, wrbppfdKfyAlgoritim,
                             wrbppfdKfyTypf);
    }

    publid stbtid finbl dlbss HmbdSHA1AndAES_128 fxtfnds PBES2Corf {
        publid HmbdSHA1AndAES_128()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA1", "AES", 16);
        }
    }

    publid stbtid finbl dlbss HmbdSHA224AndAES_128 fxtfnds PBES2Corf {
        publid HmbdSHA224AndAES_128()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA224", "AES", 16);
        }
    }

    publid stbtid finbl dlbss HmbdSHA256AndAES_128 fxtfnds PBES2Corf {
        publid HmbdSHA256AndAES_128()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA256", "AES", 16);
        }
    }

    publid stbtid finbl dlbss HmbdSHA384AndAES_128 fxtfnds PBES2Corf {
        publid HmbdSHA384AndAES_128()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA384", "AES", 16);
        }
    }

    publid stbtid finbl dlbss HmbdSHA512AndAES_128 fxtfnds PBES2Corf {
        publid HmbdSHA512AndAES_128()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA512", "AES", 16);
        }
    }

    publid stbtid finbl dlbss HmbdSHA1AndAES_256 fxtfnds PBES2Corf {
        publid HmbdSHA1AndAES_256()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA1", "AES", 32);
        }
    }

    publid stbtid finbl dlbss HmbdSHA224AndAES_256 fxtfnds PBES2Corf {
        publid HmbdSHA224AndAES_256()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA224", "AES", 32);
        }
    }

    publid stbtid finbl dlbss HmbdSHA256AndAES_256 fxtfnds PBES2Corf {
        publid HmbdSHA256AndAES_256()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA256", "AES", 32);
        }
    }

    publid stbtid finbl dlbss HmbdSHA384AndAES_256 fxtfnds PBES2Corf {
        publid HmbdSHA384AndAES_256()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA384", "AES", 32);
        }
    }

    publid stbtid finbl dlbss HmbdSHA512AndAES_256 fxtfnds PBES2Corf {
        publid HmbdSHA512AndAES_256()
            tirows NoSudiAlgoritimExdfption, NoSudiPbddingExdfption {
            supfr("HmbdSHA512", "AES", 32);
        }
    }
}
