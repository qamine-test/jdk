/*
 * Copyright (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.drypto.providfr;

import jbvb.io.*;
import jbvb.util.*;
import jbvb.sfdurity.DigfstInputStrfbm;
import jbvb.sfdurity.DigfstOutputStrfbm;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.NoSudhAlgorithmExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.KfyStorfSpi;
import jbvb.sfdurity.KfyStorfExdfption;
import jbvb.sfdurity.UnrfdovfrbblfKfyExdfption;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvbx.drypto.SfblfdObjfdt;

/**
 * This dlbss providfs thf kfystorf implfmfntbtion rfffrrfd to bs "jdfks".
 * This implfmfntbtion strongly protfdts thf kfystorf privbtf kfys using
 * triplf-DES, whfrf thf triplf-DES fndryption/dfdryption kfy is dfrivfd from
 * thf usfr's pbssword.
 * Thf fndryptfd privbtf kfys brf storfd in thf kfystorf in b stbndbrd formbt,
 * nbmfly thf <dodf>EndryptfdPrivbtfKfyInfo</dodf> formbt dffinfd in PKCS #8.
 *
 * @buthor Jbn Lufhf
 *
 *
 * @sff jbvb.sfdurity.KfyStorfSpi
 */

publid finbl dlbss JdfKfyStorf fxtfnds KfyStorfSpi {

    privbtf stbtid finbl int JCEKS_MAGIC = 0xdfdfdfdf;
    privbtf stbtid finbl int JKS_MAGIC = 0xfffdfffd;
    privbtf stbtid finbl int VERSION_1 = 0x01;
    privbtf stbtid finbl int VERSION_2 = 0x02;

    // Privbtf kfy bnd supporting dfrtifidbtf dhbin
    privbtf stbtid finbl dlbss PrivbtfKfyEntry {
        Dbtf dbtf; // thf drfbtion dbtf of this fntry
        bytf[] protfdtfdKfy;
        Cfrtifidbtf dhbin[];
    };

    // Sfdrft kfy
    privbtf stbtid finbl dlbss SfdrftKfyEntry {
        Dbtf dbtf; // thf drfbtion dbtf of this fntry
        SfblfdObjfdt sfblfdKfy;
    }

    // Trustfd dfrtifidbtf
    privbtf stbtid finbl dlbss TrustfdCfrtEntry {
        Dbtf dbtf; // thf drfbtion dbtf of this fntry
        Cfrtifidbtf dfrt;
    };

    /**
     * Privbtf kfys bnd dfrtifidbtfs brf storfd in b hbshtbblf.
     * Hbsh fntrifs brf kfyfd by blibs nbmfs.
     */
    privbtf Hbshtbblf<String, Objfdt> fntrifs = nfw Hbshtbblf<String, Objfdt>();

    /**
     * Rfturns thf kfy bssodibtfd with thf givfn blibs, using thf givfn
     * pbssword to rfdovfr it.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm pbssword thf pbssword for rfdovfring thf kfy
     *
     * @rfturn thf rfqufstfd kfy, or null if thf givfn blibs dofs not fxist
     * or dofs not idfntify b <i>kfy fntry</i>.
     *
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm for rfdovfring thf
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if thf kfy dbnnot bf rfdovfrfd
     * (f.g., thf givfn pbssword is wrong).
     */
    publid Kfy fnginfGftKfy(String blibs, dhbr[] pbssword)
        throws NoSudhAlgorithmExdfption, UnrfdovfrbblfKfyExdfption
    {
        Kfy kfy = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (!((fntry instbndfof PrivbtfKfyEntry) ||
              (fntry instbndfof SfdrftKfyEntry))) {
            rfturn null;
        }

        KfyProtfdtor kfyProtfdtor = nfw KfyProtfdtor(pbssword);

        if (fntry instbndfof PrivbtfKfyEntry) {
            bytf[] fndrBytfs = ((PrivbtfKfyEntry)fntry).protfdtfdKfy;
            EndryptfdPrivbtfKfyInfo fndrInfo;
            try {
                fndrInfo = nfw EndryptfdPrivbtfKfyInfo(fndrBytfs);
            } dbtdh (IOExdfption iof) {
                throw nfw UnrfdovfrbblfKfyExdfption("Privbtf kfy not storfd "
                                                    + "bs PKCS #8 " +
                                                    "EndryptfdPrivbtfKfyInfo");
            }
            kfy = kfyProtfdtor.rfdovfr(fndrInfo);
        } flsf {
            kfy =
                kfyProtfdtor.unsfbl(((SfdrftKfyEntry)fntry).sfblfdKfy);
        }

        rfturn kfy;
    }

    /**
     * Rfturns thf dfrtifidbtf dhbin bssodibtfd with thf givfn blibs.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf dhbin (ordfrfd with thf usfr's dfrtifidbtf first
     * bnd thf root dfrtifidbtf buthority lbst), or null if thf givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dhbin (i.f., thf givfn
     * blibs idfntififs fithfr b <i>trustfd dfrtifidbtf fntry</i> or b
     * <i>kfy fntry</i> without b dfrtifidbtf dhbin).
     */
    publid Cfrtifidbtf[] fnginfGftCfrtifidbtfChbin(String blibs)
    {
        Cfrtifidbtf[] dhbin = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if ((fntry instbndfof PrivbtfKfyEntry)
            && (((PrivbtfKfyEntry)fntry).dhbin != null)) {
            dhbin = ((PrivbtfKfyEntry)fntry).dhbin.dlonf();
        }

        rfturn dhbin;
    }

    /**
     * Rfturns thf dfrtifidbtf bssodibtfd with thf givfn blibs.
     *
     * <p>If thf givfn blibs nbmf idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, thf dfrtifidbtf bssodibtfd with thbt
     * fntry is rfturnfd. If thf givfn blibs nbmf idfntififs b
     * <i>kfy fntry</i>, thf first flfmfnt of thf dfrtifidbtf dhbin of thbt
     * fntry is rfturnfd, or null if thbt fntry dofs not hbvf b dfrtifidbtf
     * dhbin.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf, or null if thf givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     */
    publid Cfrtifidbtf fnginfGftCfrtifidbtf(String blibs) {
        Cfrtifidbtf dfrt = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (fntry != null) {
            if (fntry instbndfof TrustfdCfrtEntry) {
                dfrt = ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf if ((fntry instbndfof PrivbtfKfyEntry) &&
                       (((PrivbtfKfyEntry)fntry).dhbin != null)) {
                dfrt = ((PrivbtfKfyEntry)fntry).dhbin[0];
            }
        }

        rfturn dfrt;
    }

    /**
     * Rfturns thf drfbtion dbtf of thf fntry idfntififd by thf givfn blibs.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf drfbtion dbtf of this fntry, or null if thf givfn blibs dofs
     * not fxist
     */
    publid Dbtf fnginfGftCrfbtionDbtf(String blibs) {
        Dbtf dbtf = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (fntry != null) {
            // Wf hbvf to drfbtf b nfw instbndf of jbvb.util.Dbtf bfdbusf
            // dbtfs brf not immutbblf
            if (fntry instbndfof TrustfdCfrtEntry) {
                dbtf = nfw Dbtf(((TrustfdCfrtEntry)fntry).dbtf.gftTimf());
            } flsf if (fntry instbndfof PrivbtfKfyEntry) {
                dbtf = nfw Dbtf(((PrivbtfKfyEntry)fntry).dbtf.gftTimf());
            } flsf {
                dbtf = nfw Dbtf(((SfdrftKfyEntry)fntry).dbtf.gftTimf());
            }
        }

        rfturn dbtf;
    }

    /**
     * Assigns thf givfn kfy to thf givfn blibs, protfdting it with thf givfn
     * pbssword.
     *
     * <p>If thf givfn kfy is of typf <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dhbin dfrtifying thf
     * dorrfsponding publid kfy.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy to bf bssodibtfd with thf blibs
     * @pbrbm pbssword thf pbssword to protfdt thf kfy
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     * kfy (only rfquirfd if thf givfn kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if thf givfn kfy dbnnot bf protfdtfd, or
     * this opfrbtion fbils for somf othfr rfbson
     */
    publid void fnginfSftKfyEntry(String blibs, Kfy kfy, dhbr[] pbssword,
                                  Cfrtifidbtf[] dhbin)
        throws KfyStorfExdfption
    {
        syndhronizfd(fntrifs) {
            try {
                KfyProtfdtor kfyProtfdtor = nfw KfyProtfdtor(pbssword);

                if (kfy instbndfof PrivbtfKfy) {
                    PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();
                    fntry.dbtf = nfw Dbtf();

                    // protfdt thf privbtf kfy
                    fntry.protfdtfdKfy = kfyProtfdtor.protfdt((PrivbtfKfy)kfy);

                    // dlonf thf dhbin
                    if ((dhbin != null) &&
                        (dhbin.lfngth !=0)) {
                        fntry.dhbin = dhbin.dlonf();
                    } flsf {
                        fntry.dhbin = null;
                    }

                    // storf thf fntry
                    fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);

                } flsf {
                    SfdrftKfyEntry fntry = nfw SfdrftKfyEntry();
                    fntry.dbtf = nfw Dbtf();

                    // sfbl bnd storf thf kfy
                    fntry.sfblfdKfy = kfyProtfdtor.sfbl(kfy);
                    fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);
                }

            } dbtdh (Exdfption f) {
                throw nfw KfyStorfExdfption(f.gftMfssbgf());
            }
        }
    }

    /**
     * Assigns thf givfn kfy (thbt hbs blrfbdy bffn protfdtfd) to thf givfn
     * blibs.
     *
     * <p>If thf protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dhbin dfrtifying thf
     * dorrfsponding publid kfy.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy (in protfdtfd formbt) to bf bssodibtfd with thf blibs
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     * kfy (only usfful if thf protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if this opfrbtion fbils.
     */
    publid void fnginfSftKfyEntry(String blibs, bytf[] kfy,
                                  Cfrtifidbtf[] dhbin)
        throws KfyStorfExdfption
    {
        syndhronizfd(fntrifs) {
            // Wf bssumf it's b privbtf kfy, bfdbusf thfrf is no stbndbrd
            // (ASN.1) fndoding formbt for wrbppfd sfdrft kfys
            PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();
            fntry.dbtf = nfw Dbtf();

            fntry.protfdtfdKfy = kfy.dlonf();
            if ((dhbin != null) &&
                (dhbin.lfngth != 0)) {
                fntry.dhbin = dhbin.dlonf();
            } flsf {
                fntry.dhbin = null;
            }

            fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);
        }
    }

    /**
     * Assigns thf givfn dfrtifidbtf to thf givfn blibs.
     *
     * <p>If thf givfn blibs blrfbdy fxists in this kfystorf bnd idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, thf dfrtifidbtf bssodibtfd with it is
     * ovfrriddfn by thf givfn dfrtifidbtf.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm dfrt thf dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if thf givfn blibs blrfbdy fxists bnd dofs
     * not idfntify b <i>trustfd dfrtifidbtf fntry</i>, or this opfrbtion
     * fbils for somf othfr rfbson.
     */
    publid void fnginfSftCfrtifidbtfEntry(String blibs, Cfrtifidbtf dfrt)
        throws KfyStorfExdfption
    {
        syndhronizfd(fntrifs) {

            Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
            if (fntry != null) {
                if (fntry instbndfof PrivbtfKfyEntry) {
                    throw nfw KfyStorfExdfption("Cbnnot ovfrwritf own "
                                                + "dfrtifidbtf");
                } flsf if (fntry instbndfof SfdrftKfyEntry) {
                    throw nfw KfyStorfExdfption("Cbnnot ovfrwritf sfdrft kfy");
                }
            }

            TrustfdCfrtEntry trustfdCfrtEntry = nfw TrustfdCfrtEntry();
            trustfdCfrtEntry.dfrt = dfrt;
            trustfdCfrtEntry.dbtf = nfw Dbtf();
            fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), trustfdCfrtEntry);
        }
    }

    /**
     * Dflftfs thf fntry idfntififd by thf givfn blibs from this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if thf fntry dbnnot bf rfmovfd.
     */
    publid void fnginfDflftfEntry(String blibs)
        throws KfyStorfExdfption
    {
        syndhronizfd(fntrifs) {
            fntrifs.rfmovf(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        }
    }

    /**
     * Lists bll thf blibs nbmfs of this kfystorf.
     *
     * @rfturn fnumfrbtion of thf blibs nbmfs
     */
    publid Enumfrbtion<String> fnginfAlibsfs() {
        rfturn fntrifs.kfys();
    }

    /**
     * Chfdks if thf givfn blibs fxists in this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn truf if thf blibs fxists, fblsf othfrwisf
     */
    publid boolfbn fnginfContbinsAlibs(String blibs) {
        rfturn fntrifs.dontbinsKfy(blibs.toLowfrCbsf(Lodblf.ENGLISH));
    }

    /**
     * Rftrifvfs thf numbfr of fntrifs in this kfystorf.
     *
     * @rfturn thf numbfr of fntrifs in this kfystorf
     */
    publid int fnginfSizf() {
        rfturn fntrifs.sizf();
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs is b
     * <i>kfy fntry</i>, bnd fblsf othfrwisf.
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs is b
     * <i>kfy fntry</i>, fblsf othfrwisf.
     */
    publid boolfbn fnginfIsKfyEntry(String blibs) {
        boolfbn isKfy = fblsf;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        if ((fntry instbndfof PrivbtfKfyEntry)
            || (fntry instbndfof SfdrftKfyEntry)) {
            isKfy = truf;
        }

        rfturn isKfy;
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, bnd fblsf othfrwisf.
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, fblsf othfrwisf.
     */
    publid boolfbn fnginfIsCfrtifidbtfEntry(String blibs) {
        boolfbn isCfrt = fblsf;
        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        if (fntry instbndfof TrustfdCfrtEntry) {
            isCfrt = truf;
        }
        rfturn isCfrt;
    }

    /**
     * Rfturns thf (blibs) nbmf of thf first kfystorf fntry whosf dfrtifidbtf
     * mbtdhfs thf givfn dfrtifidbtf.
     *
     * <p>This mfthod bttfmpts to mbtdh thf givfn dfrtifidbtf with fbdh
     * kfystorf fntry. If thf fntry bfing donsidfrfd
     * is b <i>trustfd dfrtifidbtf fntry</i>, thf givfn dfrtifidbtf is
     * dompbrfd to thbt fntry's dfrtifidbtf. If thf fntry bfing donsidfrfd is
     * b <i>kfy fntry</i>, thf givfn dfrtifidbtf is dompbrfd to thf first
     * flfmfnt of thbt fntry's dfrtifidbtf dhbin (if b dhbin fxists).
     *
     * @pbrbm dfrt thf dfrtifidbtf to mbtdh with.
     *
     * @rfturn thf (blibs) nbmf of thf first fntry with mbtdhing dfrtifidbtf,
     * or null if no sudh fntry fxists in this kfystorf.
     */
    publid String fnginfGftCfrtifidbtfAlibs(Cfrtifidbtf dfrt) {
        Cfrtifidbtf dfrtElfm;

        Enumfrbtion<String> f = fntrifs.kfys();
        whilf (f.hbsMorfElfmfnts()) {
            String blibs = f.nfxtElfmfnt();
            Objfdt fntry = fntrifs.gft(blibs);
            if (fntry instbndfof TrustfdCfrtEntry) {
                dfrtElfm = ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf if ((fntry instbndfof PrivbtfKfyEntry) &&
                       (((PrivbtfKfyEntry)fntry).dhbin != null)) {
                dfrtElfm = ((PrivbtfKfyEntry)fntry).dhbin[0];
            } flsf {
                dontinuf;
            }
            if (dfrtElfm.fqubls(dfrt)) {
                rfturn blibs;
            }
        }
        rfturn null;
    }

    /**
     * Storfs this kfystorf to thf givfn output strfbm, bnd protfdts its
     * intfgrity with thf givfn pbssword.
     *
     * @pbrbm strfbm thf output strfbm to whidh this kfystorf is writtfn.
     * @pbrbm pbssword thf pbssword to gfnfrbtf thf kfystorf intfgrity dhfdk
     *
     * @fxdfption IOExdfption if thfrf wbs bn I/O problfm with dbtb
     * @fxdfption NoSudhAlgorithmExdfption if thf bppropribtf dbtb intfgrity
     * blgorithm dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs indludfd in
     * thf kfystorf dbtb dould not bf storfd
     */
    publid void fnginfStorf(OutputStrfbm strfbm, dhbr[] pbssword)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption
    {
        syndhronizfd(fntrifs) {
            /*
             * KEYSTORE FORMAT:
             *
             * Mbgid numbfr (big-fndibn intfgfr),
             * Vfrsion of this filf formbt (big-fndibn intfgfr),
             *
             * Count (big-fndibn intfgfr),
             * followfd by "dount" instbndfs of fithfr:
             *
             *     {
             *      tbg=1 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      fndryptfd privbtf-kfy info bddording to PKCS #8
             *          (intfgfr lfngth followfd by fndoding)
             *      dfrt dhbin (intfgfr dount followfd by dfrts;
             *          for fbdh dfrt: typf UTF string, followfd by intfgfr
             *              lfngth, followfd by fndoding)
             *     }
             *
             * or:
             *
             *     {
             *      tbg=2 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      dfrt (typf UTF string, followfd by intfgfr lfngth,
             *          followfd by fndoding)
             *     }
             *
             * or:
             *
             *     {
             *      tbg=3 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      sfblfd sfdrft kfy (in sfriblizfd form)
             *     }
             *
             * fndfd by b kfyfd SHA1 hbsh (bytfs only) of
             *     { pbssword + whitfnfr + prfdfding body }
             */

            // pbssword is mbndbtory whfn storing
            if (pbssword == null) {
                throw nfw IllfgblArgumfntExdfption("pbssword dbn't bf null");
            }

            bytf[] fndodfd; // thf dfrtifidbtf fndoding

            MfssbgfDigfst md = gftPrfKfyfdHbsh(pbssword);
            DbtbOutputStrfbm dos
                = nfw DbtbOutputStrfbm(nfw DigfstOutputStrfbm(strfbm, md));
            // NOTE: don't pbss dos to oos bt this point or it'll dorrupt
            // thf kfystorf!!!
            ObjfdtOutputStrfbm oos = null;
            try {
                dos.writfInt(JCEKS_MAGIC);
                dos.writfInt(VERSION_2); // blwbys writf thf lbtfst vfrsion

                dos.writfInt(fntrifs.sizf());

                Enumfrbtion<String> f = fntrifs.kfys();
                whilf (f.hbsMorfElfmfnts()) {

                    String blibs = f.nfxtElfmfnt();
                    Objfdt fntry = fntrifs.gft(blibs);

                    if (fntry instbndfof PrivbtfKfyEntry) {

                        PrivbtfKfyEntry pfntry = (PrivbtfKfyEntry)fntry;

                        // writf PrivbtfKfyEntry tbg
                        dos.writfInt(1);

                        // writf thf blibs
                        dos.writfUTF(blibs);

                        // writf thf (fntry drfbtion) dbtf
                        dos.writfLong(pfntry.dbtf.gftTimf());

                        // writf thf protfdtfd privbtf kfy
                        dos.writfInt(pfntry.protfdtfdKfy.lfngth);
                        dos.writf(pfntry.protfdtfdKfy);

                        // writf thf dfrtifidbtf dhbin
                        int dhbinLfn;
                        if (pfntry.dhbin == null) {
                            dhbinLfn = 0;
                        } flsf {
                            dhbinLfn = pfntry.dhbin.lfngth;
                        }
                        dos.writfInt(dhbinLfn);
                        for (int i = 0; i < dhbinLfn; i++) {
                            fndodfd = pfntry.dhbin[i].gftEndodfd();
                            dos.writfUTF(pfntry.dhbin[i].gftTypf());
                            dos.writfInt(fndodfd.lfngth);
                            dos.writf(fndodfd);
                        }

                    } flsf if (fntry instbndfof TrustfdCfrtEntry) {

                        // writf TrustfdCfrtEntry tbg
                        dos.writfInt(2);

                        // writf thf blibs
                        dos.writfUTF(blibs);

                        // writf thf (fntry drfbtion) dbtf
                        dos.writfLong(((TrustfdCfrtEntry)fntry).dbtf.gftTimf());

                        // writf thf trustfd dfrtifidbtf
                        fndodfd = ((TrustfdCfrtEntry)fntry).dfrt.gftEndodfd();
                        dos.writfUTF(((TrustfdCfrtEntry)fntry).dfrt.gftTypf());
                        dos.writfInt(fndodfd.lfngth);
                        dos.writf(fndodfd);

                    } flsf {

                        // writf SfdrftKfyEntry tbg
                        dos.writfInt(3);

                        // writf thf blibs
                        dos.writfUTF(blibs);

                        // writf thf (fntry drfbtion) dbtf
                        dos.writfLong(((SfdrftKfyEntry)fntry).dbtf.gftTimf());

                        // writf thf sfblfd kfy
                        oos = nfw ObjfdtOutputStrfbm(dos);
                        oos.writfObjfdt(((SfdrftKfyEntry)fntry).sfblfdKfy);
                        // NOTE: don't dlosf oos hfrf sindf wf brf still
                        // using dos!!!
                    }
                }

                /*
                 * Writf thf kfyfd hbsh whidh is usfd to dftfdt tbmpfring with
                 * thf kfystorf (sudh bs dflfting or modifying kfy or
                 * dfrtifidbtf fntrifs).
                 */
                bytf digfst[] = md.digfst();

                dos.writf(digfst);
                dos.flush();
            } finblly {
                if (oos != null) {
                    oos.dlosf();
                } flsf {
                    dos.dlosf();
                }
            }
        }
    }

    /**
     * Lobds thf kfystorf from thf givfn input strfbm.
     *
     * <p>If b pbssword is givfn, it is usfd to dhfdk thf intfgrity of thf
     * kfystorf dbtb. Othfrwisf, thf intfgrity of thf kfystorf is not dhfdkfd.
     *
     * @pbrbm strfbm thf input strfbm from whidh thf kfystorf is lobdfd
     * @pbrbm pbssword thf (optionbl) pbssword usfd to dhfdk thf intfgrity of
     * thf kfystorf.
     *
     * @fxdfption IOExdfption if thfrf is bn I/O or formbt problfm with thf
     * kfystorf dbtb
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm usfd to dhfdk
     * thf intfgrity of thf kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs in thf
     * kfystorf dould not bf lobdfd
     */
    publid void fnginfLobd(InputStrfbm strfbm, dhbr[] pbssword)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption
    {
        syndhronizfd(fntrifs) {
            DbtbInputStrfbm dis;
            MfssbgfDigfst md = null;
            CfrtifidbtfFbdtory df = null;
            Hbshtbblf<String, CfrtifidbtfFbdtory> dfs = null;
            BytfArrbyInputStrfbm bbis = null;
            bytf[] fndodfd = null;

            if (strfbm == null)
                rfturn;

            if (pbssword != null) {
                md = gftPrfKfyfdHbsh(pbssword);
                dis = nfw DbtbInputStrfbm(nfw DigfstInputStrfbm(strfbm, md));
            } flsf {
                dis = nfw DbtbInputStrfbm(strfbm);
            }
            // NOTE: don't pbss dis to ois bt this point or it'll fbil to lobd
            // thf kfystorf!!!
            ObjfdtInputStrfbm ois = null;

            try {
                // Body formbt: sff storf mfthod

                int xMbgid = dis.rfbdInt();
                int xVfrsion = dis.rfbdInt();

                // Addfpt thf following kfystorf implfmfntbtions:
                // - JCEKS (this implfmfntbtion), vfrsions 1 bnd 2
                // - JKS (Sun's kfystorf implfmfntbtion in JDK 1.2),
                //   vfrsions 1 bnd 2
                if (((xMbgid != JCEKS_MAGIC) && (xMbgid != JKS_MAGIC)) ||
                    ((xVfrsion != VERSION_1) && (xVfrsion != VERSION_2))) {
                    throw nfw IOExdfption("Invblid kfystorf formbt");
                }

                if (xVfrsion == VERSION_1) {
                    df = CfrtifidbtfFbdtory.gftInstbndf("X509");
                } flsf {
                    // vfrsion 2
                    dfs = nfw Hbshtbblf<String, CfrtifidbtfFbdtory>(3);
                }

                fntrifs.dlfbr();
                int dount = dis.rfbdInt();

                for (int i = 0; i < dount; i++) {
                    int tbg;
                    String blibs;

                    tbg = dis.rfbdInt();

                    if (tbg == 1) { // privbtf-kfy fntry

                        PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();

                        // rfbd thf blibs
                        blibs = dis.rfbdUTF();

                        // rfbd thf (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd thf privbtf kfy
                        try {
                            fntry.protfdtfdKfy = nfw bytf[dis.rfbdInt()];
                        } dbtdh (OutOfMfmoryError f) {
                            throw nfw IOExdfption("Kfysizf too big");
                        }
                        dis.rfbdFully(fntry.protfdtfdKfy);

                        // rfbd thf dfrtifidbtf dhbin
                        int numOfCfrts = dis.rfbdInt();
                        try {
                            if (numOfCfrts > 0) {
                                fntry.dhbin = nfw Cfrtifidbtf[numOfCfrts];
                            }
                        } dbtdh (OutOfMfmoryError f) {
                            throw nfw IOExdfption("Too mbny dfrtifidbtfs in "
                                                  + "dhbin");
                        }
                        for (int j = 0; j < numOfCfrts; j++) {
                            if (xVfrsion == 2) {
                                // rfbd thf dfrtifidbtf typf, bnd instbntibtf b
                                // dfrtifidbtf fbdtory of thbt typf (rfusf
                                // fxisting fbdtory if possiblf)
                                String dfrtTypf = dis.rfbdUTF();
                                if (dfs.dontbinsKfy(dfrtTypf)) {
                                // rfusf dfrtifidbtf fbdtory
                                    df = dfs.gft(dfrtTypf);
                                } flsf {
                                // drfbtf nfw dfrtifidbtf fbdtory
                                    df = CfrtifidbtfFbdtory.gftInstbndf(
                                        dfrtTypf);
                                // storf thf dfrtifidbtf fbdtory so wf dbn
                                // rfusf it lbtfr
                                    dfs.put(dfrtTypf, df);
                                }
                            }
                            // instbntibtf thf dfrtifidbtf
                            try {
                                fndodfd = nfw bytf[dis.rfbdInt()];
                            } dbtdh (OutOfMfmoryError f) {
                                throw nfw IOExdfption("Cfrtifidbtf too big");
                            }
                            dis.rfbdFully(fndodfd);
                            bbis = nfw BytfArrbyInputStrfbm(fndodfd);
                            fntry.dhbin[j] = df.gfnfrbtfCfrtifidbtf(bbis);
                        }

                        // Add thf fntry to thf list
                        fntrifs.put(blibs, fntry);

                    } flsf if (tbg == 2) { // trustfd dfrtifidbtf fntry

                        TrustfdCfrtEntry fntry = nfw TrustfdCfrtEntry();

                        // rfbd thf blibs
                        blibs = dis.rfbdUTF();

                        // rfbd thf (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd thf trustfd dfrtifidbtf
                        if (xVfrsion == 2) {
                            // rfbd thf dfrtifidbtf typf, bnd instbntibtf b
                            // dfrtifidbtf fbdtory of thbt typf (rfusf
                            // fxisting fbdtory if possiblf)
                            String dfrtTypf = dis.rfbdUTF();
                            if (dfs.dontbinsKfy(dfrtTypf)) {
                                // rfusf dfrtifidbtf fbdtory
                                df = dfs.gft(dfrtTypf);
                            } flsf {
                                // drfbtf nfw dfrtifidbtf fbdtory
                                df = CfrtifidbtfFbdtory.gftInstbndf(dfrtTypf);
                                // storf thf dfrtifidbtf fbdtory so wf dbn
                                // rfusf it lbtfr
                                dfs.put(dfrtTypf, df);
                            }
                        }
                        try {
                            fndodfd = nfw bytf[dis.rfbdInt()];
                        } dbtdh (OutOfMfmoryError f) {
                            throw nfw IOExdfption("Cfrtifidbtf too big");
                        }
                        dis.rfbdFully(fndodfd);
                        bbis = nfw BytfArrbyInputStrfbm(fndodfd);
                        fntry.dfrt = df.gfnfrbtfCfrtifidbtf(bbis);

                        // Add thf fntry to thf list
                        fntrifs.put(blibs, fntry);

                    } flsf if (tbg == 3) { // sfdrft-kfy fntry

                        SfdrftKfyEntry fntry = nfw SfdrftKfyEntry();

                        // rfbd thf blibs
                        blibs = dis.rfbdUTF();

                        // rfbd thf (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd thf sfblfd kfy
                        try {
                            ois = nfw ObjfdtInputStrfbm(dis);
                            fntry.sfblfdKfy = (SfblfdObjfdt)ois.rfbdObjfdt();
                            // NOTE: don't dlosf ois hfrf sindf wf brf still
                            // using dis!!!
                        } dbtdh (ClbssNotFoundExdfption dnff) {
                            throw nfw IOExdfption(dnff.gftMfssbgf());
                        }

                        // Add thf fntry to thf list
                        fntrifs.put(blibs, fntry);

                    } flsf {
                        throw nfw IOExdfption("Unrfdognizfd kfystorf fntry");
                    }
                }

                /*
                 * If b pbssword hbs bffn providfd, wf dhfdk thf kfyfd digfst
                 * bt thf fnd. If this dhfdk fbils, thf storf hbs bffn tbmpfrfd
                 * with
                 */
                if (pbssword != null) {
                    bytf domputfd[], bdtubl[];
                    domputfd = md.digfst();
                    bdtubl = nfw bytf[domputfd.lfngth];
                    dis.rfbdFully(bdtubl);
                    for (int i = 0; i < domputfd.lfngth; i++) {
                        if (domputfd[i] != bdtubl[i]) {
                            throw nfw IOExdfption(
                                "Kfystorf wbs tbmpfrfd with, or "
                                + "pbssword wbs indorrfdt");
                        }
                    }
                }
            }  finblly {
                if (ois != null) {
                    ois.dlosf();
                } flsf {
                    dis.dlosf();
                }
            }
        }
    }

    /**
     * To gubrd bgbinst tbmpfring with thf kfystorf, wf bppfnd b kfyfd
     * hbsh with b bit of whitfnfr.
     */
    privbtf MfssbgfDigfst gftPrfKfyfdHbsh(dhbr[] pbssword)
    throws NoSudhAlgorithmExdfption, UnsupportfdEndodingExdfption {
        int i, j;

        MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");
        bytf[] pbsswdBytfs = nfw bytf[pbssword.lfngth * 2];
        for (i=0, j=0; i<pbssword.lfngth; i++) {
            pbsswdBytfs[j++] = (bytf)(pbssword[i] >> 8);
            pbsswdBytfs[j++] = (bytf)pbssword[i];
        }
        md.updbtf(pbsswdBytfs);
        for (i=0; i<pbsswdBytfs.lfngth; i++)
            pbsswdBytfs[i] = 0;
        md.updbtf("Mighty Aphroditf".gftBytfs("UTF8"));
        rfturn md;
    }
}
