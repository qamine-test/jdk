/*
 * Copyrigit (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.drypto.providfr;

import jbvb.io.*;
import jbvb.util.*;
import jbvb.sfdurity.DigfstInputStrfbm;
import jbvb.sfdurity.DigfstOutputStrfbm;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.NoSudiAlgoritimExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.KfyStorfSpi;
import jbvb.sfdurity.KfyStorfExdfption;
import jbvb.sfdurity.UnrfdovfrbblfKfyExdfption;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvbx.drypto.SfblfdObjfdt;

/**
 * Tiis dlbss providfs tif kfystorf implfmfntbtion rfffrrfd to bs "jdfks".
 * Tiis implfmfntbtion strongly protfdts tif kfystorf privbtf kfys using
 * triplf-DES, wifrf tif triplf-DES fndryption/dfdryption kfy is dfrivfd from
 * tif usfr's pbssword.
 * Tif fndryptfd privbtf kfys brf storfd in tif kfystorf in b stbndbrd formbt,
 * nbmfly tif <dodf>EndryptfdPrivbtfKfyInfo</dodf> formbt dffinfd in PKCS #8.
 *
 * @butior Jbn Lufif
 *
 *
 * @sff jbvb.sfdurity.KfyStorfSpi
 */

publid finbl dlbss JdfKfyStorf fxtfnds KfyStorfSpi {

    privbtf stbtid finbl int JCEKS_MAGIC = 0xdfdfdfdf;
    privbtf stbtid finbl int JKS_MAGIC = 0xfffdfffd;
    privbtf stbtid finbl int VERSION_1 = 0x01;
    privbtf stbtid finbl int VERSION_2 = 0x02;

    // Privbtf kfy bnd supporting dfrtifidbtf dibin
    privbtf stbtid finbl dlbss PrivbtfKfyEntry {
        Dbtf dbtf; // tif drfbtion dbtf of tiis fntry
        bytf[] protfdtfdKfy;
        Cfrtifidbtf dibin[];
    };

    // Sfdrft kfy
    privbtf stbtid finbl dlbss SfdrftKfyEntry {
        Dbtf dbtf; // tif drfbtion dbtf of tiis fntry
        SfblfdObjfdt sfblfdKfy;
    }

    // Trustfd dfrtifidbtf
    privbtf stbtid finbl dlbss TrustfdCfrtEntry {
        Dbtf dbtf; // tif drfbtion dbtf of tiis fntry
        Cfrtifidbtf dfrt;
    };

    /**
     * Privbtf kfys bnd dfrtifidbtfs brf storfd in b ibsitbblf.
     * Hbsi fntrifs brf kfyfd by blibs nbmfs.
     */
    privbtf Hbsitbblf<String, Objfdt> fntrifs = nfw Hbsitbblf<String, Objfdt>();

    /**
     * Rfturns tif kfy bssodibtfd witi tif givfn blibs, using tif givfn
     * pbssword to rfdovfr it.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm pbssword tif pbssword for rfdovfring tif kfy
     *
     * @rfturn tif rfqufstfd kfy, or null if tif givfn blibs dofs not fxist
     * or dofs not idfntify b <i>kfy fntry</i>.
     *
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim for rfdovfring tif
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if tif kfy dbnnot bf rfdovfrfd
     * (f.g., tif givfn pbssword is wrong).
     */
    publid Kfy fnginfGftKfy(String blibs, dibr[] pbssword)
        tirows NoSudiAlgoritimExdfption, UnrfdovfrbblfKfyExdfption
    {
        Kfy kfy = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (!((fntry instbndfof PrivbtfKfyEntry) ||
              (fntry instbndfof SfdrftKfyEntry))) {
            rfturn null;
        }

        KfyProtfdtor kfyProtfdtor = nfw KfyProtfdtor(pbssword);

        if (fntry instbndfof PrivbtfKfyEntry) {
            bytf[] fndrBytfs = ((PrivbtfKfyEntry)fntry).protfdtfdKfy;
            EndryptfdPrivbtfKfyInfo fndrInfo;
            try {
                fndrInfo = nfw EndryptfdPrivbtfKfyInfo(fndrBytfs);
            } dbtdi (IOExdfption iof) {
                tirow nfw UnrfdovfrbblfKfyExdfption("Privbtf kfy not storfd "
                                                    + "bs PKCS #8 " +
                                                    "EndryptfdPrivbtfKfyInfo");
            }
            kfy = kfyProtfdtor.rfdovfr(fndrInfo);
        } flsf {
            kfy =
                kfyProtfdtor.unsfbl(((SfdrftKfyEntry)fntry).sfblfdKfy);
        }

        rfturn kfy;
    }

    /**
     * Rfturns tif dfrtifidbtf dibin bssodibtfd witi tif givfn blibs.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf dibin (ordfrfd witi tif usfr's dfrtifidbtf first
     * bnd tif root dfrtifidbtf butiority lbst), or null if tif givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dibin (i.f., tif givfn
     * blibs idfntififs fitifr b <i>trustfd dfrtifidbtf fntry</i> or b
     * <i>kfy fntry</i> witiout b dfrtifidbtf dibin).
     */
    publid Cfrtifidbtf[] fnginfGftCfrtifidbtfCibin(String blibs)
    {
        Cfrtifidbtf[] dibin = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if ((fntry instbndfof PrivbtfKfyEntry)
            && (((PrivbtfKfyEntry)fntry).dibin != null)) {
            dibin = ((PrivbtfKfyEntry)fntry).dibin.dlonf();
        }

        rfturn dibin;
    }

    /**
     * Rfturns tif dfrtifidbtf bssodibtfd witi tif givfn blibs.
     *
     * <p>If tif givfn blibs nbmf idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, tif dfrtifidbtf bssodibtfd witi tibt
     * fntry is rfturnfd. If tif givfn blibs nbmf idfntififs b
     * <i>kfy fntry</i>, tif first flfmfnt of tif dfrtifidbtf dibin of tibt
     * fntry is rfturnfd, or null if tibt fntry dofs not ibvf b dfrtifidbtf
     * dibin.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf, or null if tif givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     */
    publid Cfrtifidbtf fnginfGftCfrtifidbtf(String blibs) {
        Cfrtifidbtf dfrt = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (fntry != null) {
            if (fntry instbndfof TrustfdCfrtEntry) {
                dfrt = ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf if ((fntry instbndfof PrivbtfKfyEntry) &&
                       (((PrivbtfKfyEntry)fntry).dibin != null)) {
                dfrt = ((PrivbtfKfyEntry)fntry).dibin[0];
            }
        }

        rfturn dfrt;
    }

    /**
     * Rfturns tif drfbtion dbtf of tif fntry idfntififd by tif givfn blibs.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif drfbtion dbtf of tiis fntry, or null if tif givfn blibs dofs
     * not fxist
     */
    publid Dbtf fnginfGftCrfbtionDbtf(String blibs) {
        Dbtf dbtf = null;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));

        if (fntry != null) {
            // Wf ibvf to drfbtf b nfw instbndf of jbvb.util.Dbtf bfdbusf
            // dbtfs brf not immutbblf
            if (fntry instbndfof TrustfdCfrtEntry) {
                dbtf = nfw Dbtf(((TrustfdCfrtEntry)fntry).dbtf.gftTimf());
            } flsf if (fntry instbndfof PrivbtfKfyEntry) {
                dbtf = nfw Dbtf(((PrivbtfKfyEntry)fntry).dbtf.gftTimf());
            } flsf {
                dbtf = nfw Dbtf(((SfdrftKfyEntry)fntry).dbtf.gftTimf());
            }
        }

        rfturn dbtf;
    }

    /**
     * Assigns tif givfn kfy to tif givfn blibs, protfdting it witi tif givfn
     * pbssword.
     *
     * <p>If tif givfn kfy is of typf <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dibin dfrtifying tif
     * dorrfsponding publid kfy.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
     * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy to bf bssodibtfd witi tif blibs
     * @pbrbm pbssword tif pbssword to protfdt tif kfy
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only rfquirfd if tif givfn kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if tif givfn kfy dbnnot bf protfdtfd, or
     * tiis opfrbtion fbils for somf otifr rfbson
     */
    publid void fnginfSftKfyEntry(String blibs, Kfy kfy, dibr[] pbssword,
                                  Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption
    {
        syndironizfd(fntrifs) {
            try {
                KfyProtfdtor kfyProtfdtor = nfw KfyProtfdtor(pbssword);

                if (kfy instbndfof PrivbtfKfy) {
                    PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();
                    fntry.dbtf = nfw Dbtf();

                    // protfdt tif privbtf kfy
                    fntry.protfdtfdKfy = kfyProtfdtor.protfdt((PrivbtfKfy)kfy);

                    // dlonf tif dibin
                    if ((dibin != null) &&
                        (dibin.lfngti !=0)) {
                        fntry.dibin = dibin.dlonf();
                    } flsf {
                        fntry.dibin = null;
                    }

                    // storf tif fntry
                    fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);

                } flsf {
                    SfdrftKfyEntry fntry = nfw SfdrftKfyEntry();
                    fntry.dbtf = nfw Dbtf();

                    // sfbl bnd storf tif kfy
                    fntry.sfblfdKfy = kfyProtfdtor.sfbl(kfy);
                    fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);
                }

            } dbtdi (Exdfption f) {
                tirow nfw KfyStorfExdfption(f.gftMfssbgf());
            }
        }
    }

    /**
     * Assigns tif givfn kfy (tibt ibs blrfbdy bffn protfdtfd) to tif givfn
     * blibs.
     *
     * <p>If tif protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dibin dfrtifying tif
     * dorrfsponding publid kfy.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
     * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy (in protfdtfd formbt) to bf bssodibtfd witi tif blibs
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only usfful if tif protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if tiis opfrbtion fbils.
     */
    publid void fnginfSftKfyEntry(String blibs, bytf[] kfy,
                                  Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption
    {
        syndironizfd(fntrifs) {
            // Wf bssumf it's b privbtf kfy, bfdbusf tifrf is no stbndbrd
            // (ASN.1) fndoding formbt for wrbppfd sfdrft kfys
            PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();
            fntry.dbtf = nfw Dbtf();

            fntry.protfdtfdKfy = kfy.dlonf();
            if ((dibin != null) &&
                (dibin.lfngti != 0)) {
                fntry.dibin = dibin.dlonf();
            } flsf {
                fntry.dibin = null;
            }

            fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), fntry);
        }
    }

    /**
     * Assigns tif givfn dfrtifidbtf to tif givfn blibs.
     *
     * <p>If tif givfn blibs blrfbdy fxists in tiis kfystorf bnd idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, tif dfrtifidbtf bssodibtfd witi it is
     * ovfrriddfn by tif givfn dfrtifidbtf.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm dfrt tif dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if tif givfn blibs blrfbdy fxists bnd dofs
     * not idfntify b <i>trustfd dfrtifidbtf fntry</i>, or tiis opfrbtion
     * fbils for somf otifr rfbson.
     */
    publid void fnginfSftCfrtifidbtfEntry(String blibs, Cfrtifidbtf dfrt)
        tirows KfyStorfExdfption
    {
        syndironizfd(fntrifs) {

            Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
            if (fntry != null) {
                if (fntry instbndfof PrivbtfKfyEntry) {
                    tirow nfw KfyStorfExdfption("Cbnnot ovfrwritf own "
                                                + "dfrtifidbtf");
                } flsf if (fntry instbndfof SfdrftKfyEntry) {
                    tirow nfw KfyStorfExdfption("Cbnnot ovfrwritf sfdrft kfy");
                }
            }

            TrustfdCfrtEntry trustfdCfrtEntry = nfw TrustfdCfrtEntry();
            trustfdCfrtEntry.dfrt = dfrt;
            trustfdCfrtEntry.dbtf = nfw Dbtf();
            fntrifs.put(blibs.toLowfrCbsf(Lodblf.ENGLISH), trustfdCfrtEntry);
        }
    }

    /**
     * Dflftfs tif fntry idfntififd by tif givfn blibs from tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if tif fntry dbnnot bf rfmovfd.
     */
    publid void fnginfDflftfEntry(String blibs)
        tirows KfyStorfExdfption
    {
        syndironizfd(fntrifs) {
            fntrifs.rfmovf(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        }
    }

    /**
     * Lists bll tif blibs nbmfs of tiis kfystorf.
     *
     * @rfturn fnumfrbtion of tif blibs nbmfs
     */
    publid Enumfrbtion<String> fnginfAlibsfs() {
        rfturn fntrifs.kfys();
    }

    /**
     * Cifdks if tif givfn blibs fxists in tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn truf if tif blibs fxists, fblsf otifrwisf
     */
    publid boolfbn fnginfContbinsAlibs(String blibs) {
        rfturn fntrifs.dontbinsKfy(blibs.toLowfrCbsf(Lodblf.ENGLISH));
    }

    /**
     * Rftrifvfs tif numbfr of fntrifs in tiis kfystorf.
     *
     * @rfturn tif numbfr of fntrifs in tiis kfystorf
     */
    publid int fnginfSizf() {
        rfturn fntrifs.sizf();
    }

    /**
     * Rfturns truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>kfy fntry</i>, bnd fblsf otifrwisf.
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>kfy fntry</i>, fblsf otifrwisf.
     */
    publid boolfbn fnginfIsKfyEntry(String blibs) {
        boolfbn isKfy = fblsf;

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        if ((fntry instbndfof PrivbtfKfyEntry)
            || (fntry instbndfof SfdrftKfyEntry)) {
            isKfy = truf;
        }

        rfturn isKfy;
    }

    /**
     * Rfturns truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, bnd fblsf otifrwisf.
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, fblsf otifrwisf.
     */
    publid boolfbn fnginfIsCfrtifidbtfEntry(String blibs) {
        boolfbn isCfrt = fblsf;
        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf(Lodblf.ENGLISH));
        if (fntry instbndfof TrustfdCfrtEntry) {
            isCfrt = truf;
        }
        rfturn isCfrt;
    }

    /**
     * Rfturns tif (blibs) nbmf of tif first kfystorf fntry wiosf dfrtifidbtf
     * mbtdifs tif givfn dfrtifidbtf.
     *
     * <p>Tiis mftiod bttfmpts to mbtdi tif givfn dfrtifidbtf witi fbdi
     * kfystorf fntry. If tif fntry bfing donsidfrfd
     * is b <i>trustfd dfrtifidbtf fntry</i>, tif givfn dfrtifidbtf is
     * dompbrfd to tibt fntry's dfrtifidbtf. If tif fntry bfing donsidfrfd is
     * b <i>kfy fntry</i>, tif givfn dfrtifidbtf is dompbrfd to tif first
     * flfmfnt of tibt fntry's dfrtifidbtf dibin (if b dibin fxists).
     *
     * @pbrbm dfrt tif dfrtifidbtf to mbtdi witi.
     *
     * @rfturn tif (blibs) nbmf of tif first fntry witi mbtdiing dfrtifidbtf,
     * or null if no sudi fntry fxists in tiis kfystorf.
     */
    publid String fnginfGftCfrtifidbtfAlibs(Cfrtifidbtf dfrt) {
        Cfrtifidbtf dfrtElfm;

        Enumfrbtion<String> f = fntrifs.kfys();
        wiilf (f.ibsMorfElfmfnts()) {
            String blibs = f.nfxtElfmfnt();
            Objfdt fntry = fntrifs.gft(blibs);
            if (fntry instbndfof TrustfdCfrtEntry) {
                dfrtElfm = ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf if ((fntry instbndfof PrivbtfKfyEntry) &&
                       (((PrivbtfKfyEntry)fntry).dibin != null)) {
                dfrtElfm = ((PrivbtfKfyEntry)fntry).dibin[0];
            } flsf {
                dontinuf;
            }
            if (dfrtElfm.fqubls(dfrt)) {
                rfturn blibs;
            }
        }
        rfturn null;
    }

    /**
     * Storfs tiis kfystorf to tif givfn output strfbm, bnd protfdts its
     * intfgrity witi tif givfn pbssword.
     *
     * @pbrbm strfbm tif output strfbm to wiidi tiis kfystorf is writtfn.
     * @pbrbm pbssword tif pbssword to gfnfrbtf tif kfystorf intfgrity difdk
     *
     * @fxdfption IOExdfption if tifrf wbs bn I/O problfm witi dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif bppropribtf dbtb intfgrity
     * blgoritim dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs indludfd in
     * tif kfystorf dbtb dould not bf storfd
     */
    publid void fnginfStorf(OutputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        syndironizfd(fntrifs) {
            /*
             * KEYSTORE FORMAT:
             *
             * Mbgid numbfr (big-fndibn intfgfr),
             * Vfrsion of tiis filf formbt (big-fndibn intfgfr),
             *
             * Count (big-fndibn intfgfr),
             * followfd by "dount" instbndfs of fitifr:
             *
             *     {
             *      tbg=1 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      fndryptfd privbtf-kfy info bddording to PKCS #8
             *          (intfgfr lfngti followfd by fndoding)
             *      dfrt dibin (intfgfr dount followfd by dfrts;
             *          for fbdi dfrt: typf UTF string, followfd by intfgfr
             *              lfngti, followfd by fndoding)
             *     }
             *
             * or:
             *
             *     {
             *      tbg=2 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      dfrt (typf UTF string, followfd by intfgfr lfngti,
             *          followfd by fndoding)
             *     }
             *
             * or:
             *
             *     {
             *      tbg=3 (big-fndibn intfgfr)
             *      blibs (UTF string)
             *      timfstbmp
             *      sfblfd sfdrft kfy (in sfriblizfd form)
             *     }
             *
             * fndfd by b kfyfd SHA1 ibsi (bytfs only) of
             *     { pbssword + wiitfnfr + prfdfding body }
             */

            // pbssword is mbndbtory wifn storing
            if (pbssword == null) {
                tirow nfw IllfgblArgumfntExdfption("pbssword dbn't bf null");
            }

            bytf[] fndodfd; // tif dfrtifidbtf fndoding

            MfssbgfDigfst md = gftPrfKfyfdHbsi(pbssword);
            DbtbOutputStrfbm dos
                = nfw DbtbOutputStrfbm(nfw DigfstOutputStrfbm(strfbm, md));
            // NOTE: don't pbss dos to oos bt tiis point or it'll dorrupt
            // tif kfystorf!!!
            ObjfdtOutputStrfbm oos = null;
            try {
                dos.writfInt(JCEKS_MAGIC);
                dos.writfInt(VERSION_2); // blwbys writf tif lbtfst vfrsion

                dos.writfInt(fntrifs.sizf());

                Enumfrbtion<String> f = fntrifs.kfys();
                wiilf (f.ibsMorfElfmfnts()) {

                    String blibs = f.nfxtElfmfnt();
                    Objfdt fntry = fntrifs.gft(blibs);

                    if (fntry instbndfof PrivbtfKfyEntry) {

                        PrivbtfKfyEntry pfntry = (PrivbtfKfyEntry)fntry;

                        // writf PrivbtfKfyEntry tbg
                        dos.writfInt(1);

                        // writf tif blibs
                        dos.writfUTF(blibs);

                        // writf tif (fntry drfbtion) dbtf
                        dos.writfLong(pfntry.dbtf.gftTimf());

                        // writf tif protfdtfd privbtf kfy
                        dos.writfInt(pfntry.protfdtfdKfy.lfngti);
                        dos.writf(pfntry.protfdtfdKfy);

                        // writf tif dfrtifidbtf dibin
                        int dibinLfn;
                        if (pfntry.dibin == null) {
                            dibinLfn = 0;
                        } flsf {
                            dibinLfn = pfntry.dibin.lfngti;
                        }
                        dos.writfInt(dibinLfn);
                        for (int i = 0; i < dibinLfn; i++) {
                            fndodfd = pfntry.dibin[i].gftEndodfd();
                            dos.writfUTF(pfntry.dibin[i].gftTypf());
                            dos.writfInt(fndodfd.lfngti);
                            dos.writf(fndodfd);
                        }

                    } flsf if (fntry instbndfof TrustfdCfrtEntry) {

                        // writf TrustfdCfrtEntry tbg
                        dos.writfInt(2);

                        // writf tif blibs
                        dos.writfUTF(blibs);

                        // writf tif (fntry drfbtion) dbtf
                        dos.writfLong(((TrustfdCfrtEntry)fntry).dbtf.gftTimf());

                        // writf tif trustfd dfrtifidbtf
                        fndodfd = ((TrustfdCfrtEntry)fntry).dfrt.gftEndodfd();
                        dos.writfUTF(((TrustfdCfrtEntry)fntry).dfrt.gftTypf());
                        dos.writfInt(fndodfd.lfngti);
                        dos.writf(fndodfd);

                    } flsf {

                        // writf SfdrftKfyEntry tbg
                        dos.writfInt(3);

                        // writf tif blibs
                        dos.writfUTF(blibs);

                        // writf tif (fntry drfbtion) dbtf
                        dos.writfLong(((SfdrftKfyEntry)fntry).dbtf.gftTimf());

                        // writf tif sfblfd kfy
                        oos = nfw ObjfdtOutputStrfbm(dos);
                        oos.writfObjfdt(((SfdrftKfyEntry)fntry).sfblfdKfy);
                        // NOTE: don't dlosf oos ifrf sindf wf brf still
                        // using dos!!!
                    }
                }

                /*
                 * Writf tif kfyfd ibsi wiidi is usfd to dftfdt tbmpfring witi
                 * tif kfystorf (sudi bs dflfting or modifying kfy or
                 * dfrtifidbtf fntrifs).
                 */
                bytf digfst[] = md.digfst();

                dos.writf(digfst);
                dos.flusi();
            } finblly {
                if (oos != null) {
                    oos.dlosf();
                } flsf {
                    dos.dlosf();
                }
            }
        }
    }

    /**
     * Lobds tif kfystorf from tif givfn input strfbm.
     *
     * <p>If b pbssword is givfn, it is usfd to difdk tif intfgrity of tif
     * kfystorf dbtb. Otifrwisf, tif intfgrity of tif kfystorf is not difdkfd.
     *
     * @pbrbm strfbm tif input strfbm from wiidi tif kfystorf is lobdfd
     * @pbrbm pbssword tif (optionbl) pbssword usfd to difdk tif intfgrity of
     * tif kfystorf.
     *
     * @fxdfption IOExdfption if tifrf is bn I/O or formbt problfm witi tif
     * kfystorf dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim usfd to difdk
     * tif intfgrity of tif kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs in tif
     * kfystorf dould not bf lobdfd
     */
    publid void fnginfLobd(InputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        syndironizfd(fntrifs) {
            DbtbInputStrfbm dis;
            MfssbgfDigfst md = null;
            CfrtifidbtfFbdtory df = null;
            Hbsitbblf<String, CfrtifidbtfFbdtory> dfs = null;
            BytfArrbyInputStrfbm bbis = null;
            bytf[] fndodfd = null;

            if (strfbm == null)
                rfturn;

            if (pbssword != null) {
                md = gftPrfKfyfdHbsi(pbssword);
                dis = nfw DbtbInputStrfbm(nfw DigfstInputStrfbm(strfbm, md));
            } flsf {
                dis = nfw DbtbInputStrfbm(strfbm);
            }
            // NOTE: don't pbss dis to ois bt tiis point or it'll fbil to lobd
            // tif kfystorf!!!
            ObjfdtInputStrfbm ois = null;

            try {
                // Body formbt: sff storf mftiod

                int xMbgid = dis.rfbdInt();
                int xVfrsion = dis.rfbdInt();

                // Addfpt tif following kfystorf implfmfntbtions:
                // - JCEKS (tiis implfmfntbtion), vfrsions 1 bnd 2
                // - JKS (Sun's kfystorf implfmfntbtion in JDK 1.2),
                //   vfrsions 1 bnd 2
                if (((xMbgid != JCEKS_MAGIC) && (xMbgid != JKS_MAGIC)) ||
                    ((xVfrsion != VERSION_1) && (xVfrsion != VERSION_2))) {
                    tirow nfw IOExdfption("Invblid kfystorf formbt");
                }

                if (xVfrsion == VERSION_1) {
                    df = CfrtifidbtfFbdtory.gftInstbndf("X509");
                } flsf {
                    // vfrsion 2
                    dfs = nfw Hbsitbblf<String, CfrtifidbtfFbdtory>(3);
                }

                fntrifs.dlfbr();
                int dount = dis.rfbdInt();

                for (int i = 0; i < dount; i++) {
                    int tbg;
                    String blibs;

                    tbg = dis.rfbdInt();

                    if (tbg == 1) { // privbtf-kfy fntry

                        PrivbtfKfyEntry fntry = nfw PrivbtfKfyEntry();

                        // rfbd tif blibs
                        blibs = dis.rfbdUTF();

                        // rfbd tif (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd tif privbtf kfy
                        try {
                            fntry.protfdtfdKfy = nfw bytf[dis.rfbdInt()];
                        } dbtdi (OutOfMfmoryError f) {
                            tirow nfw IOExdfption("Kfysizf too big");
                        }
                        dis.rfbdFully(fntry.protfdtfdKfy);

                        // rfbd tif dfrtifidbtf dibin
                        int numOfCfrts = dis.rfbdInt();
                        try {
                            if (numOfCfrts > 0) {
                                fntry.dibin = nfw Cfrtifidbtf[numOfCfrts];
                            }
                        } dbtdi (OutOfMfmoryError f) {
                            tirow nfw IOExdfption("Too mbny dfrtifidbtfs in "
                                                  + "dibin");
                        }
                        for (int j = 0; j < numOfCfrts; j++) {
                            if (xVfrsion == 2) {
                                // rfbd tif dfrtifidbtf typf, bnd instbntibtf b
                                // dfrtifidbtf fbdtory of tibt typf (rfusf
                                // fxisting fbdtory if possiblf)
                                String dfrtTypf = dis.rfbdUTF();
                                if (dfs.dontbinsKfy(dfrtTypf)) {
                                // rfusf dfrtifidbtf fbdtory
                                    df = dfs.gft(dfrtTypf);
                                } flsf {
                                // drfbtf nfw dfrtifidbtf fbdtory
                                    df = CfrtifidbtfFbdtory.gftInstbndf(
                                        dfrtTypf);
                                // storf tif dfrtifidbtf fbdtory so wf dbn
                                // rfusf it lbtfr
                                    dfs.put(dfrtTypf, df);
                                }
                            }
                            // instbntibtf tif dfrtifidbtf
                            try {
                                fndodfd = nfw bytf[dis.rfbdInt()];
                            } dbtdi (OutOfMfmoryError f) {
                                tirow nfw IOExdfption("Cfrtifidbtf too big");
                            }
                            dis.rfbdFully(fndodfd);
                            bbis = nfw BytfArrbyInputStrfbm(fndodfd);
                            fntry.dibin[j] = df.gfnfrbtfCfrtifidbtf(bbis);
                        }

                        // Add tif fntry to tif list
                        fntrifs.put(blibs, fntry);

                    } flsf if (tbg == 2) { // trustfd dfrtifidbtf fntry

                        TrustfdCfrtEntry fntry = nfw TrustfdCfrtEntry();

                        // rfbd tif blibs
                        blibs = dis.rfbdUTF();

                        // rfbd tif (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd tif trustfd dfrtifidbtf
                        if (xVfrsion == 2) {
                            // rfbd tif dfrtifidbtf typf, bnd instbntibtf b
                            // dfrtifidbtf fbdtory of tibt typf (rfusf
                            // fxisting fbdtory if possiblf)
                            String dfrtTypf = dis.rfbdUTF();
                            if (dfs.dontbinsKfy(dfrtTypf)) {
                                // rfusf dfrtifidbtf fbdtory
                                df = dfs.gft(dfrtTypf);
                            } flsf {
                                // drfbtf nfw dfrtifidbtf fbdtory
                                df = CfrtifidbtfFbdtory.gftInstbndf(dfrtTypf);
                                // storf tif dfrtifidbtf fbdtory so wf dbn
                                // rfusf it lbtfr
                                dfs.put(dfrtTypf, df);
                            }
                        }
                        try {
                            fndodfd = nfw bytf[dis.rfbdInt()];
                        } dbtdi (OutOfMfmoryError f) {
                            tirow nfw IOExdfption("Cfrtifidbtf too big");
                        }
                        dis.rfbdFully(fndodfd);
                        bbis = nfw BytfArrbyInputStrfbm(fndodfd);
                        fntry.dfrt = df.gfnfrbtfCfrtifidbtf(bbis);

                        // Add tif fntry to tif list
                        fntrifs.put(blibs, fntry);

                    } flsf if (tbg == 3) { // sfdrft-kfy fntry

                        SfdrftKfyEntry fntry = nfw SfdrftKfyEntry();

                        // rfbd tif blibs
                        blibs = dis.rfbdUTF();

                        // rfbd tif (fntry drfbtion) dbtf
                        fntry.dbtf = nfw Dbtf(dis.rfbdLong());

                        // rfbd tif sfblfd kfy
                        try {
                            ois = nfw ObjfdtInputStrfbm(dis);
                            fntry.sfblfdKfy = (SfblfdObjfdt)ois.rfbdObjfdt();
                            // NOTE: don't dlosf ois ifrf sindf wf brf still
                            // using dis!!!
                        } dbtdi (ClbssNotFoundExdfption dnff) {
                            tirow nfw IOExdfption(dnff.gftMfssbgf());
                        }

                        // Add tif fntry to tif list
                        fntrifs.put(blibs, fntry);

                    } flsf {
                        tirow nfw IOExdfption("Unrfdognizfd kfystorf fntry");
                    }
                }

                /*
                 * If b pbssword ibs bffn providfd, wf difdk tif kfyfd digfst
                 * bt tif fnd. If tiis difdk fbils, tif storf ibs bffn tbmpfrfd
                 * witi
                 */
                if (pbssword != null) {
                    bytf domputfd[], bdtubl[];
                    domputfd = md.digfst();
                    bdtubl = nfw bytf[domputfd.lfngti];
                    dis.rfbdFully(bdtubl);
                    for (int i = 0; i < domputfd.lfngti; i++) {
                        if (domputfd[i] != bdtubl[i]) {
                            tirow nfw IOExdfption(
                                "Kfystorf wbs tbmpfrfd witi, or "
                                + "pbssword wbs indorrfdt");
                        }
                    }
                }
            }  finblly {
                if (ois != null) {
                    ois.dlosf();
                } flsf {
                    dis.dlosf();
                }
            }
        }
    }

    /**
     * To gubrd bgbinst tbmpfring witi tif kfystorf, wf bppfnd b kfyfd
     * ibsi witi b bit of wiitfnfr.
     */
    privbtf MfssbgfDigfst gftPrfKfyfdHbsi(dibr[] pbssword)
    tirows NoSudiAlgoritimExdfption, UnsupportfdEndodingExdfption {
        int i, j;

        MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf("SHA");
        bytf[] pbsswdBytfs = nfw bytf[pbssword.lfngti * 2];
        for (i=0, j=0; i<pbssword.lfngti; i++) {
            pbsswdBytfs[j++] = (bytf)(pbssword[i] >> 8);
            pbsswdBytfs[j++] = (bytf)pbssword[i];
        }
        md.updbtf(pbsswdBytfs);
        for (i=0; i<pbsswdBytfs.lfngti; i++)
            pbsswdBytfs[i] = 0;
        md.updbtf("Migity Apiroditf".gftBytfs("UTF8"));
        rfturn md;
    }
}
