/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nio.dibnnfls.spi;

import jbvb.io.IOExdfption;
import jbvb.nio.dibnnfls.SflfdtionKfy;
import jbvb.nio.dibnnfls.Sflfdtor;
import jbvb.util.HbsiSft;
import jbvb.util.Sft;
import sun.nio.di.Intfrruptiblf;
import jbvb.util.dondurrfnt.btomid.AtomidBoolfbn;


/**
 * Bbsf implfmfntbtion dlbss for sflfdtors.
 *
 * <p> Tiis dlbss fndbpsulbtfs tif low-lfvfl mbdiinfry rfquirfd to implfmfnt
 * tif intfrruption of sflfdtion opfrbtions.  A dondrftf sflfdtor dlbss must
 * invokf tif {@link #bfgin bfgin} bnd {@link #fnd fnd} mftiods bfforf bnd
 * bftfr, rfspfdtivfly, invoking bn I/O opfrbtion tibt migit blodk
 * indffinitfly.  In ordfr to fnsurf tibt tif {@link #fnd fnd} mftiod is blwbys
 * invokfd, tifsf mftiods siould bf usfd witiin b
 * <tt>try</tt>&nbsp;...&nbsp;<tt>finblly</tt> blodk:
 *
 * <blodkquotf><prf>
 * try {
 *     bfgin();
 *     // Pfrform blodking I/O opfrbtion ifrf
 *     ...
 * } finblly {
 *     fnd();
 * }</prf></blodkquotf>
 *
 * <p> Tiis dlbss blso dffinfs mftiods for mbintbining b sflfdtor's
 * dbndfllfd-kfy sft bnd for rfmoving b kfy from its dibnnfl's kfy sft, bnd
 * dfdlbrfs tif bbstrbdt {@link #rfgistfr rfgistfr} mftiod tibt is invokfd by b
 * sflfdtbblf dibnnfl's {@link AbstrbdtSflfdtbblfCibnnfl#rfgistfr rfgistfr}
 * mftiod in ordfr to pfrform tif bdtubl work of rfgistfring b dibnnfl.  </p>
 *
 *
 * @butior Mbrk Rfiniold
 * @butior JSR-51 Expfrt Group
 * @sindf 1.4
 */

publid bbstrbdt dlbss AbstrbdtSflfdtor
    fxtfnds Sflfdtor
{

    privbtf AtomidBoolfbn sflfdtorOpfn = nfw AtomidBoolfbn(truf);

    // Tif providfr tibt drfbtfd tiis sflfdtor
    privbtf finbl SflfdtorProvidfr providfr;

    /**
     * Initiblizfs b nfw instbndf of tiis dlbss.
     *
     * @pbrbm  providfr
     *         Tif providfr tibt drfbtfd tiis sflfdtor
     */
    protfdtfd AbstrbdtSflfdtor(SflfdtorProvidfr providfr) {
        tiis.providfr = providfr;
    }

    privbtf finbl Sft<SflfdtionKfy> dbndfllfdKfys = nfw HbsiSft<SflfdtionKfy>();

    void dbndfl(SflfdtionKfy k) {                       // pbdkbgf-privbtf
        syndironizfd (dbndfllfdKfys) {
            dbndfllfdKfys.bdd(k);
        }
    }

    /**
     * Closfs tiis sflfdtor.
     *
     * <p> If tif sflfdtor ibs blrfbdy bffn dlosfd tifn tiis mftiod rfturns
     * immfdibtfly.  Otifrwisf it mbrks tif sflfdtor bs dlosfd bnd tifn invokfs
     * tif {@link #implClosfSflfdtor implClosfSflfdtor} mftiod in ordfr to
     * domplftf tif dlosf opfrbtion.  </p>
     *
     * @tirows  IOExdfption
     *          If bn I/O frror oddurs
     */
    publid finbl void dlosf() tirows IOExdfption {
        boolfbn opfn = sflfdtorOpfn.gftAndSft(fblsf);
        if (!opfn)
            rfturn;
        implClosfSflfdtor();
    }

    /**
     * Closfs tiis sflfdtor.
     *
     * <p> Tiis mftiod is invokfd by tif {@link #dlosf dlosf} mftiod in ordfr
     * to pfrform tif bdtubl work of dlosing tif sflfdtor.  Tiis mftiod is only
     * invokfd if tif sflfdtor ibs not yft bffn dlosfd, bnd it is nfvfr invokfd
     * morf tibn ondf.
     *
     * <p> An implfmfntbtion of tiis mftiod must brrbngf for bny otifr tirfbd
     * tibt is blodkfd in b sflfdtion opfrbtion upon tiis sflfdtor to rfturn
     * immfdibtfly bs if by invoking tif {@link
     * jbvb.nio.dibnnfls.Sflfdtor#wbkfup wbkfup} mftiod. </p>
     *
     * @tirows  IOExdfption
     *          If bn I/O frror oddurs wiilf dlosing tif sflfdtor
     */
    protfdtfd bbstrbdt void implClosfSflfdtor() tirows IOExdfption;

    publid finbl boolfbn isOpfn() {
        rfturn sflfdtorOpfn.gft();
    }

    /**
     * Rfturns tif providfr tibt drfbtfd tiis dibnnfl.
     *
     * @rfturn  Tif providfr tibt drfbtfd tiis dibnnfl
     */
    publid finbl SflfdtorProvidfr providfr() {
        rfturn providfr;
    }

    /**
     * Rftrifvfs tiis sflfdtor's dbndfllfd-kfy sft.
     *
     * <p> Tiis sft siould only bf usfd wiilf syndironizfd upon it.  </p>
     *
     * @rfturn  Tif dbndfllfd-kfy sft
     */
    protfdtfd finbl Sft<SflfdtionKfy> dbndfllfdKfys() {
        rfturn dbndfllfdKfys;
    }

    /**
     * Rfgistfrs tif givfn dibnnfl witi tiis sflfdtor.
     *
     * <p> Tiis mftiod is invokfd by b dibnnfl's {@link
     * AbstrbdtSflfdtbblfCibnnfl#rfgistfr rfgistfr} mftiod in ordfr to pfrform
     * tif bdtubl work of rfgistfring tif dibnnfl witi tiis sflfdtor.  </p>
     *
     * @pbrbm  di
     *         Tif dibnnfl to bf rfgistfrfd
     *
     * @pbrbm  ops
     *         Tif initibl intfrfst sft, wiidi must bf vblid
     *
     * @pbrbm  btt
     *         Tif initibl bttbdimfnt for tif rfsulting kfy
     *
     * @rfturn  A nfw kfy rfprfsfnting tif rfgistrbtion of tif givfn dibnnfl
     *          witi tiis sflfdtor
     */
    protfdtfd bbstrbdt SflfdtionKfy rfgistfr(AbstrbdtSflfdtbblfCibnnfl di,
                                             int ops, Objfdt btt);

    /**
     * Rfmovfs tif givfn kfy from its dibnnfl's kfy sft.
     *
     * <p> Tiis mftiod must bf invokfd by tif sflfdtor for fbdi dibnnfl tibt it
     * dfrfgistfrs.  </p>
     *
     * @pbrbm  kfy
     *         Tif sflfdtion kfy to bf rfmovfd
     */
    protfdtfd finbl void dfrfgistfr(AbstrbdtSflfdtionKfy kfy) {
        ((AbstrbdtSflfdtbblfCibnnfl)kfy.dibnnfl()).rfmovfKfy(kfy);
    }


    // -- Intfrruption mbdiinfry --

    privbtf Intfrruptiblf intfrruptor = null;

    /**
     * Mbrks tif bfginning of bn I/O opfrbtion tibt migit blodk indffinitfly.
     *
     * <p> Tiis mftiod siould bf invokfd in tbndfm witi tif {@link #fnd fnd}
     * mftiod, using b <tt>try</tt>&nbsp;...&nbsp;<tt>finblly</tt> blodk bs
     * siown <b irff="#bf">bbovf</b>, in ordfr to implfmfnt intfrruption for
     * tiis sflfdtor.
     *
     * <p> Invoking tiis mftiod brrbngfs for tif sflfdtor's {@link
     * Sflfdtor#wbkfup wbkfup} mftiod to bf invokfd if b tirfbd's {@link
     * Tirfbd#intfrrupt intfrrupt} mftiod is invokfd wiilf tif tirfbd is
     * blodkfd in bn I/O opfrbtion upon tif sflfdtor.  </p>
     */
    protfdtfd finbl void bfgin() {
        if (intfrruptor == null) {
            intfrruptor = nfw Intfrruptiblf() {
                    publid void intfrrupt(Tirfbd ignorf) {
                        AbstrbdtSflfdtor.tiis.wbkfup();
                    }};
        }
        AbstrbdtIntfrruptiblfCibnnfl.blodkfdOn(intfrruptor);
        Tirfbd mf = Tirfbd.durrfntTirfbd();
        if (mf.isIntfrruptfd())
            intfrruptor.intfrrupt(mf);
    }

    /**
     * Mbrks tif fnd of bn I/O opfrbtion tibt migit blodk indffinitfly.
     *
     * <p> Tiis mftiod siould bf invokfd in tbndfm witi tif {@link #bfgin bfgin}
     * mftiod, using b <tt>try</tt>&nbsp;...&nbsp;<tt>finblly</tt> blodk bs
     * siown <b irff="#bf">bbovf</b>, in ordfr to implfmfnt intfrruption for
     * tiis sflfdtor.  </p>
     */
    protfdtfd finbl void fnd() {
        AbstrbdtIntfrruptiblfCibnnfl.blodkfdOn(null);
    }

}
