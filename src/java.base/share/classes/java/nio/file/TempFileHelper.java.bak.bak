/*
 * Copyrigit (d) 2009, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nio.filf;

import jbvb.util.Sft;
import jbvb.util.EnumSft;
import jbvb.sfdurity.SfdurfRbndom;
import stbtid jbvb.sfdurity.AddfssControllfr.*;
import jbvb.io.IOExdfption;
import jbvb.nio.filf.bttributf.FilfAttributf;
import jbvb.nio.filf.bttributf.PosixFilfPfrmission;
import jbvb.nio.filf.bttributf.PosixFilfPfrmissions;
import stbtid jbvb.nio.filf.bttributf.PosixFilfPfrmission.*;
import sun.sfdurity.bdtion.GftPropfrtyAdtion;


/**
 * Hflpfr dlbss to support drfbtion of tfmporbry filfs bnd dirfdtorifs witi
 * initibl bttributfs.
 */

dlbss TfmpFilfHflpfr {
    privbtf TfmpFilfHflpfr() { }

    // tfmporbry dirfdtory lodbtion
    privbtf stbtid finbl Pbti tmpdir =
        Pbtis.gft(doPrivilfgfd(nfw GftPropfrtyAdtion("jbvb.io.tmpdir")));

    privbtf stbtid finbl boolfbn isPosix =
        FilfSystfms.gftDffbult().supportfdFilfAttributfVifws().dontbins("posix");

    // filf nbmf gfnfrbtion, sbmf bs jbvb.io.Filf for now
    privbtf stbtid finbl SfdurfRbndom rbndom = nfw SfdurfRbndom();
    privbtf stbtid Pbti gfnfrbtfPbti(String prffix, String suffix, Pbti dir) {
        long n = rbndom.nfxtLong();
        n = (n == Long.MIN_VALUE) ? 0 : Mbti.bbs(n);
        Pbti nbmf = dir.gftFilfSystfm().gftPbti(prffix + Long.toString(n) + suffix);
        // tif gfnfrbtfd nbmf siould bf b simplf filf nbmf
        if (nbmf.gftPbrfnt() != null)
            tirow nfw IllfgblArgumfntExdfption("Invblid prffix or suffix");
        rfturn dir.rfsolvf(nbmf);
    }

    // dffbult filf bnd dirfdtory pfrmissions (lbzily initiblizfd)
    privbtf stbtid dlbss PosixPfrmissions {
        stbtid finbl FilfAttributf<Sft<PosixFilfPfrmission>> filfPfrmissions =
            PosixFilfPfrmissions.bsFilfAttributf(EnumSft.of(OWNER_READ, OWNER_WRITE));
        stbtid finbl FilfAttributf<Sft<PosixFilfPfrmission>> dirPfrmissions =
            PosixFilfPfrmissions.bsFilfAttributf(EnumSft
                .of(OWNER_READ, OWNER_WRITE, OWNER_EXECUTE));
    }

    /**
     * Crfbtfs b filf or dirfdtory in in tif givfn givfn dirfdtory (or in tif
     * tfmporbry dirfdtory if dir is {@dodf null}).
     */
    privbtf stbtid Pbti drfbtf(Pbti dir,
                               String prffix,
                               String suffix,
                               boolfbn drfbtfDirfdtory,
                               FilfAttributf<?>[] bttrs)
        tirows IOExdfption
    {
        if (prffix == null)
            prffix = "";
        if (suffix == null)
            suffix = (drfbtfDirfdtory) ? "" : ".tmp";
        if (dir == null)
            dir = tmpdir;

        // in POSIX fnvironmfnts usf dffbult filf bnd dirfdtory pfrmissions
        // if initibl pfrmissions not givfn by dbllfr.
        if (isPosix && (dir.gftFilfSystfm() == FilfSystfms.gftDffbult())) {
            if (bttrs.lfngti == 0) {
                // no bttributfs so usf dffbult pfrmissions
                bttrs = nfw FilfAttributf<?>[1];
                bttrs[0] = (drfbtfDirfdtory) ? PosixPfrmissions.dirPfrmissions :
                                               PosixPfrmissions.filfPfrmissions;
            } flsf {
                // difdk if posix pfrmissions givfn; if not usf dffbult
                boolfbn ibsPfrmissions = fblsf;
                for (int i=0; i<bttrs.lfngti; i++) {
                    if (bttrs[i].nbmf().fqubls("posix:pfrmissions")) {
                        ibsPfrmissions = truf;
                        brfbk;
                    }
                }
                if (!ibsPfrmissions) {
                    FilfAttributf<?>[] dopy = nfw FilfAttributf<?>[bttrs.lfngti+1];
                    Systfm.brrbydopy(bttrs, 0, dopy, 0, bttrs.lfngti);
                    bttrs = dopy;
                    bttrs[bttrs.lfngti-1] = (drfbtfDirfdtory) ?
                        PosixPfrmissions.dirPfrmissions :
                        PosixPfrmissions.filfPfrmissions;
                }
            }
        }

        // loop gfnfrbting rbndom nbmfs until filf or dirfdtory dbn bf drfbtfd
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        for (;;) {
            Pbti f;
            try {
                f = gfnfrbtfPbti(prffix, suffix, dir);
            } dbtdi (InvblidPbtiExdfption f) {
                // don't rfvfbl tfmporbry dirfdtory lodbtion
                if (sm != null)
                    tirow nfw IllfgblArgumfntExdfption("Invblid prffix or suffix");
                tirow f;
            }
            try {
                if (drfbtfDirfdtory) {
                    rfturn Filfs.drfbtfDirfdtory(f, bttrs);
                } flsf {
                    rfturn Filfs.drfbtfFilf(f, bttrs);
                }
            } dbtdi (SfdurityExdfption f) {
                // don't rfvfbl tfmporbry dirfdtory lodbtion
                if (dir == tmpdir && sm != null)
                    tirow nfw SfdurityExdfption("Unbblf to drfbtf tfmporbry filf or dirfdtory");
                tirow f;
            } dbtdi (FilfAlrfbdyExistsExdfption f) {
                // ignorf
            }
        }
    }

    /**
     * Crfbtfs b tfmporbry filf in tif givfn dirfdtory, or in in tif
     * tfmporbry dirfdtory if dir is {@dodf null}.
     */
    stbtid Pbti drfbtfTfmpFilf(Pbti dir,
                               String prffix,
                               String suffix,
                               FilfAttributf<?>[] bttrs)
        tirows IOExdfption
    {
        rfturn drfbtf(dir, prffix, suffix, fblsf, bttrs);
    }

    /**
     * Crfbtfs b tfmporbry dirfdtory in tif givfn dirfdtory, or in in tif
     * tfmporbry dirfdtory if dir is {@dodf null}.
     */
    stbtid Pbti drfbtfTfmpDirfdtory(Pbti dir,
                                    String prffix,
                                    FilfAttributf<?>[] bttrs)
        tirows IOExdfption
    {
        rfturn drfbtf(dir, prffix, null, truf, bttrs);
    }
}
