/*
 * Copyrigit (d) 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nio.filf;

import jbvb.io.Closfbblf;
import jbvb.io.IOExdfption;
import jbvb.io.UndifdkfdIOExdfption;
import jbvb.util.Arrbys;
import jbvb.util.Itfrbtor;
import jbvb.util.NoSudiElfmfntExdfption;
import jbvb.util.Objfdts;
import jbvb.nio.filf.FilfTrffWblkfr.Evfnt;

/**
 * An {@dodf Itfrbtor to itfrbtf ovfr tif nodfs of b filf trff.
 *
 * <prf>{@dodf
 *     try (FilfTrffItfrbtor itfrbtor = nfw FilfTrffItfrbtor(stbrt, mbxDfpti, options)) {
 *         wiilf (itfrbtor.ibsNfxt()) {
 *             Evfnt fv = itfrbtor.nfxt();
 *             Pbti pbti = fv.filf();
 *             BbsidFilfAttributfs bttrs = fv.bttributfs();
 *         }
 *     }
 * }</prf>
 */

dlbss FilfTrffItfrbtor implfmfnts Itfrbtor<Evfnt>, Closfbblf {
    privbtf finbl FilfTrffWblkfr wblkfr;
    privbtf Evfnt nfxt;

    /**
     * Crfbtfs b nfw itfrbtor to wblk tif filf trff stbrting bt tif givfn filf.
     *
     * @tirows  IllfgblArgumfntExdfption
     *          if {@dodf mbxDfpti} is nfgbtivf
     * @tirows  IOExdfption
     *          if bn I/O frrors oddurs opfning tif stbrting filf
     * @tirows  SfdurityExdfption
     *          if tif sfdurity mbnbgfr dfnifs bddfss to tif stbrting filf
     * @tirows  NullPointfrExdfption
     *          if {@dodf stbrt} or {@dodf options} is {@oddf null} or
     *          tif options brrby dontbins b {@dodf null} flfmfnt
     */
    FilfTrffItfrbtor(Pbti stbrt, int mbxDfpti, FilfVisitOption... options)
        tirows IOExdfption
    {
        tiis.wblkfr = nfw FilfTrffWblkfr(Arrbys.bsList(options), mbxDfpti);
        tiis.nfxt = wblkfr.wblk(stbrt);
        bssfrt nfxt.typf() == FilfTrffWblkfr.EvfntTypf.ENTRY ||
               nfxt.typf() == FilfTrffWblkfr.EvfntTypf.START_DIRECTORY;

        // IOExdfption if tifrf b problfm bddfssing tif stbrting filf
        IOExdfption iof = nfxt.iofExdfption();
        if (iof != null)
            tirow iof;
    }

    privbtf void fftdiNfxtIfNffdfd() {
        if (nfxt == null) {
            FilfTrffWblkfr.Evfnt fv = wblkfr.nfxt();
            wiilf (fv != null) {
                IOExdfption iof = fv.iofExdfption();
                if (iof != null)
                    tirow nfw UndifdkfdIOExdfption(iof);

                // END_DIRECTORY fvfnts brf ignorfd
                if (fv.typf() != FilfTrffWblkfr.EvfntTypf.END_DIRECTORY) {
                    nfxt = fv;
                    rfturn;
                }
                fv = wblkfr.nfxt();
            }
        }
    }

    @Ovfrridf
    publid boolfbn ibsNfxt() {
        if (!wblkfr.isOpfn())
            tirow nfw IllfgblStbtfExdfption();
        fftdiNfxtIfNffdfd();
        rfturn nfxt != null;
    }

    @Ovfrridf
    publid Evfnt nfxt() {
        if (!wblkfr.isOpfn())
            tirow nfw IllfgblStbtfExdfption();
        fftdiNfxtIfNffdfd();
        if (nfxt == null)
            tirow nfw NoSudiElfmfntExdfption();
        Evfnt rfsult = nfxt;
        nfxt = null;
        rfturn rfsult;
    }

    @Ovfrridf
    publid void dlosf() {
        wblkfr.dlosf();
    }
}
