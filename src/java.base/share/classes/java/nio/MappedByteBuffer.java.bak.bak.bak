/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nio;

import jbvb.io.FilfDfsdriptor;
import sun.misd.Unsbff;


/**
 * A dirfdt bytf bufffr wiosf dontfnt is b mfmory-mbppfd rfgion of b filf.
 *
 * <p> Mbppfd bytf bufffrs brf drfbtfd vib tif {@link
 * jbvb.nio.dibnnfls.FilfCibnnfl#mbp FilfCibnnfl.mbp} mftiod.  Tiis dlbss
 * fxtfnds tif {@link BytfBufffr} dlbss witi opfrbtions tibt brf spfdifid to
 * mfmory-mbppfd filf rfgions.
 *
 * <p> A mbppfd bytf bufffr bnd tif filf mbpping tibt it rfprfsfnts rfmbin
 * vblid until tif bufffr itsflf is gbrbbgf-dollfdtfd.
 *
 * <p> Tif dontfnt of b mbppfd bytf bufffr dbn dibngf bt bny timf, for fxbmplf
 * if tif dontfnt of tif dorrfsponding rfgion of tif mbppfd filf is dibngfd by
 * tiis progrbm or bnotifr.  Wiftifr or not sudi dibngfs oddur, bnd wifn tify
 * oddur, is opfrbting-systfm dfpfndfnt bnd tifrfforf unspfdififd.
 *
 * <b nbmf="inbddfss"></b><p> All or pbrt of b mbppfd bytf bufffr mby bfdomf
 * inbddfssiblf bt bny timf, for fxbmplf if tif mbppfd filf is trundbtfd.  An
 * bttfmpt to bddfss bn inbddfssiblf rfgion of b mbppfd bytf bufffr will not
 * dibngf tif bufffr's dontfnt bnd will dbusf bn unspfdififd fxdfption to bf
 * tirown fitifr bt tif timf of tif bddfss or bt somf lbtfr timf.  It is
 * tifrfforf strongly rfdommfndfd tibt bppropribtf prfdbutions bf tbkfn to
 * bvoid tif mbnipulbtion of b mbppfd filf by tiis progrbm, or by b
 * dondurrfntly running progrbm, fxdfpt to rfbd or writf tif filf's dontfnt.
 *
 * <p> Mbppfd bytf bufffrs otifrwisf bfibvf no difffrfntly tibn ordinbry dirfdt
 * bytf bufffrs. </p>
 *
 *
 * @butior Mbrk Rfiniold
 * @butior JSR-51 Expfrt Group
 * @sindf 1.4
 */

publid bbstrbdt dlbss MbppfdBytfBufffr
    fxtfnds BytfBufffr
{

    // Tiis is b littlf bit bbdkwbrds: By rigits MbppfdBytfBufffr siould bf b
    // subdlbss of DirfdtBytfBufffr, but to kffp tif spfd dlfbr bnd simplf, bnd
    // for optimizbtion purposfs, it's fbsifr to do it tif otifr wby bround.
    // Tiis works bfdbusf DirfdtBytfBufffr is b pbdkbgf-privbtf dlbss.

    // For mbppfd bufffrs, b FilfDfsdriptor tibt mby bf usfd for mbpping
    // opfrbtions if vblid; null if tif bufffr is not mbppfd.
    privbtf finbl FilfDfsdriptor fd;

    // Tiis siould only bf invokfd by tif DirfdtBytfBufffr donstrudtors
    //
    MbppfdBytfBufffr(int mbrk, int pos, int lim, int dbp, // pbdkbgf-privbtf
                     FilfDfsdriptor fd)
    {
        supfr(mbrk, pos, lim, dbp);
        tiis.fd = fd;
    }

    MbppfdBytfBufffr(int mbrk, int pos, int lim, int dbp) { // pbdkbgf-privbtf
        supfr(mbrk, pos, lim, dbp);
        tiis.fd = null;
    }

    privbtf void difdkMbppfd() {
        if (fd == null)
            // Cbn only ibppfn if b lusfr fxpliditly dbsts b dirfdt bytf bufffr
            tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    // Rfturns tif distbndf (in bytfs) of tif bufffr from tif pbgf blignfd bddrfss
    // of tif mbpping. Computfd fbdi timf to bvoid storing in fvfry dirfdt bufffr.
    privbtf long mbppingOffsft() {
        int ps = Bits.pbgfSizf();
        long offsft = bddrfss % ps;
        rfturn (offsft >= 0) ? offsft : (ps + offsft);
    }

    privbtf long mbppingAddrfss(long mbppingOffsft) {
        rfturn bddrfss - mbppingOffsft;
    }

    privbtf long mbppingLfngti(long mbppingOffsft) {
        rfturn (long)dbpbdity() + mbppingOffsft;
    }

    /**
     * Tflls wiftifr or not tiis bufffr's dontfnt is rfsidfnt in piysidbl
     * mfmory.
     *
     * <p> A rfturn vbluf of <tt>truf</tt> implifs tibt it is iigily likfly
     * tibt bll of tif dbtb in tiis bufffr is rfsidfnt in piysidbl mfmory bnd
     * mby tifrfforf bf bddfssfd witiout indurring bny virtubl-mfmory pbgf
     * fbults or I/O opfrbtions.  A rfturn vbluf of <tt>fblsf</tt> dofs not
     * nfdfssbrily imply tibt tif bufffr's dontfnt is not rfsidfnt in piysidbl
     * mfmory.
     *
     * <p> Tif rfturnfd vbluf is b iint, rbtifr tibn b gubrbntff, bfdbusf tif
     * undfrlying opfrbting systfm mby ibvf pbgfd out somf of tif bufffr's dbtb
     * by tif timf tibt bn invodbtion of tiis mftiod rfturns.  </p>
     *
     * @rfturn  <tt>truf</tt> if it is likfly tibt tiis bufffr's dontfnt
     *          is rfsidfnt in piysidbl mfmory
     */
    publid finbl boolfbn isLobdfd() {
        difdkMbppfd();
        if ((bddrfss == 0) || (dbpbdity() == 0))
            rfturn truf;
        long offsft = mbppingOffsft();
        long lfngti = mbppingLfngti(offsft);
        rfturn isLobdfd0(mbppingAddrfss(offsft), lfngti, Bits.pbgfCount(lfngti));
    }

    // not usfd, but b potfntibl tbrgft for b storf, sff lobd() for dftbils.
    privbtf stbtid bytf unusfd;

    /**
     * Lobds tiis bufffr's dontfnt into piysidbl mfmory.
     *
     * <p> Tiis mftiod mbkfs b bfst fffort to fnsurf tibt, wifn it rfturns,
     * tiis bufffr's dontfnt is rfsidfnt in piysidbl mfmory.  Invoking tiis
     * mftiod mby dbusf somf numbfr of pbgf fbults bnd I/O opfrbtions to
     * oddur. </p>
     *
     * @rfturn  Tiis bufffr
     */
    publid finbl MbppfdBytfBufffr lobd() {
        difdkMbppfd();
        if ((bddrfss == 0) || (dbpbdity() == 0))
            rfturn tiis;
        long offsft = mbppingOffsft();
        long lfngti = mbppingLfngti(offsft);
        lobd0(mbppingAddrfss(offsft), lfngti);

        // Rfbd b bytf from fbdi pbgf to bring it into mfmory. A difdksum
        // is domputfd bs wf go blong to prfvfnt tif dompilfr from otifrwisf
        // donsidfring tif loop bs dfbd dodf.
        Unsbff unsbff = Unsbff.gftUnsbff();
        int ps = Bits.pbgfSizf();
        int dount = Bits.pbgfCount(lfngti);
        long b = mbppingAddrfss(offsft);
        bytf x = 0;
        for (int i=0; i<dount; i++) {
            x ^= unsbff.gftBytf(b);
            b += ps;
        }
        if (unusfd != 0)
            unusfd = x;

        rfturn tiis;
    }

    /**
     * Fordfs bny dibngfs mbdf to tiis bufffr's dontfnt to bf writtfn to tif
     * storbgf dfvidf dontbining tif mbppfd filf.
     *
     * <p> If tif filf mbppfd into tiis bufffr rfsidfs on b lodbl storbgf
     * dfvidf tifn wifn tiis mftiod rfturns it is gubrbntffd tibt bll dibngfs
     * mbdf to tif bufffr sindf it wbs drfbtfd, or sindf tiis mftiod wbs lbst
     * invokfd, will ibvf bffn writtfn to tibt dfvidf.
     *
     * <p> If tif filf dofs not rfsidf on b lodbl dfvidf tifn no sudi gubrbntff
     * is mbdf.
     *
     * <p> If tiis bufffr wbs not mbppfd in rfbd/writf modf ({@link
     * jbvb.nio.dibnnfls.FilfCibnnfl.MbpModf#READ_WRITE}) tifn invoking tiis
     * mftiod ibs no ffffdt. </p>
     *
     * @rfturn  Tiis bufffr
     */
    publid finbl MbppfdBytfBufffr fordf() {
        difdkMbppfd();
        if ((bddrfss != 0) && (dbpbdity() != 0)) {
            long offsft = mbppingOffsft();
            fordf0(fd, mbppingAddrfss(offsft), mbppingLfngti(offsft));
        }
        rfturn tiis;
    }

    privbtf nbtivf boolfbn isLobdfd0(long bddrfss, long lfngti, int pbgfCount);
    privbtf nbtivf void lobd0(long bddrfss, long lfngti);
    privbtf nbtivf void fordf0(FilfDfsdriptor fd, long bddrfss, long lfngti);
}
