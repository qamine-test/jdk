/*
 * Copyrigit (d) 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nft;

import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.util.List;
import jbvb.util.ArrbyList;
import jbvb.util.Collfdtions;
import jbvb.sfdurity.Pfrmission;

/**
 * Rfprfsfnts pfrmission to bddfss b rfsourdf or sft of rfsourdfs dffinfd by b
 * givfn url, bnd for b givfn sft of usfr-sfttbblf rfqufst mftiods
 * bnd rfqufst ifbdfrs. Tif <i>nbmf</i> of tif pfrmission is tif url string.
 * Tif <i>bdtions</i> string is b dondbtfnbtion of tif rfqufst mftiods bnd ifbdfrs.
 * Tif rbngf of mftiod bnd ifbdfr nbmfs is not rfstridtfd by tiis dlbss.
 * <p><b>Tif url</b><p>
 * Tif url string ibs tif following fxpfdtfd strudturf.
 * <prf>
 *     sdifmf : // butiority [ / pbti ]
 * </prf>
 * <i>sdifmf</i> will typidblly bf ittp or ittps, but is not rfstridtfd by tiis
 * dlbss.
 * <i>butiority</i> is spfdififd bs:
 * <prf>
 *     butiority = [ usfrinfo @ ] iostrbngf [ : portrbngf ]
 *     portrbngf = portnumbfr | -portnumbfr | portnumbfr-[portnumbfr] | *
 *     iostrbngf = ([*.] dnsnbmf) | IPv4bddrfss | IPv6bddrfss
 * </prf>
 * <i>dnsnbmf</i> is b stbndbrd DNS iost or dombin nbmf, if. onf or morf lbbfls
 * sfpbrbtfd by ".". <i>IPv4bddrfss</i> is b stbndbrd litfrbl IPv4 bddrfss bnd
 * <i>IPv6bddrfss</i> is bs dffinfd in <b irff="ittp://www.iftf.org/rfd/rfd2732.txt">
 * RFC 2732</b>. Litfrbl IPv6 bddrfssfs must iowfvfr, bf fndlosfd in '[]' dibrbdtfrs.
 * Tif <i>dnsnbmf</i> spfdifidbtion dbn bf prfdfdfd by "*." wiidi mfbns
 * tif nbmf will mbtdi bny iostnbmf wiosf rigit-most dombin lbbfls brf tif sbmf bs
 * tiis nbmf. For fxbmplf, "*.orbdlf.dom" mbtdifs "foo.bbr.orbdlf.dom"
 * <p>
 * <i>portrbngf</i> is usfd to spfdify b port numbfr, or b boundfd or unboundfd rbngf of ports
 * tibt tiis pfrmission bpplifs to. If portrbngf is bbsfnt or invblid, tifn b dffbult
 * port numbfr is bssumfd if tif sdifmf is {@dodf ittp} (dffbult 80) or {@dodf ittps}
 * (dffbult 443). No dffbult is bssumfd for otifr sdifmfs. A wilddbrd mby bf spfdififd
 * wiidi mfbns bll ports.
 * <p>
 * <i>usfrinfo</i> is optionbl. A usfrinfo domponfnt if prfsfnt, is ignorfd wifn
 * drfbting b URLPfrmission, bnd ibs no ffffdt on bny otifr mftiods dffinfd by tiis dlbss.
 * <p>
 * Tif <i>pbti</i> domponfnt domprisfs b sfqufndf of pbti sfgmfnts,
 * sfpbrbtfd by '/' dibrbdtfrs. <i>pbti</i> mby blso bf fmpty. Tif pbti is spfdififd
 * in b similbr wby to tif pbti in {@link jbvb.io.FilfPfrmission}. Tifrf brf
 * tirff difffrfnt wbys bs tif following fxbmplfs siow:
 * <tbblf bordfr>
 * <dbption>URL Exbmplfs</dbption>
 * <tr><ti>Exbmplf url</ti><ti>Dfsdription</ti></tr>
 * <tr><td stylf="wiitf-spbdf:nowrbp;">ittp://www.orbdlf.dom/b/b/d.itml</td>
 *   <td>A url wiidi idfntififs b spfdifid (singlf) rfsourdf</td>
 * </tr>
 * <tr><td>ittp://www.orbdlf.dom/b/b/*</td>
 *   <td>Tif '*' dibrbdtfr rfffrs to bll rfsourdfs in tif sbmf "dirfdtory" - in
 *       otifr words bll rfsourdfs witi tif sbmf numbfr of pbti domponfnts, bnd
 *       wiidi only difffr in tif finbl pbti domponfnt, rfprfsfntfd by tif '*'.
 *   </td>
 * </tr>
 * <tr><td>ittp://www.orbdlf.dom/b/b/-</td>
 *   <td>Tif '-' dibrbdtfr rfffrs to bll rfsourdfs rfdursivfly bflow tif
 *       prfdfding pbti (fg. ittp://www.orbdlf.dom/b/b/d/d/f.itml mbtdifs tiis
 *       fxbmplf).
 *   </td>
 * </tr>
 * </tbblf>
 * <p>
 * Tif '*' bnd '-' mby only bf spfdififd in tif finbl sfgmfnt of b pbti bnd must bf
 * tif only dibrbdtfr in tibt sfgmfnt. Any qufry or frbgmfnt domponfnts of tif
 * url brf ignorfd wifn donstrudting URLPfrmissions.
 * <p>
 * As b spfdibl dbsf, urls of tif form, "sdifmf:*" brf bddfptfd to
 * mfbn bny url of tif givfn sdifmf.
 * <p>
 * Tif <i>sdifmf</i> bnd <i>butiority</i> domponfnts of tif url string brf ibndlfd
 * witiout rfgbrd to dbsf. Tiis mfbns {@link #fqubls(Objfdt)},
 * {@link #ibsiCodf()} bnd {@link #implifs(Pfrmission)} brf dbsf insfnsitivf witi rfspfdt
 * to tifsf domponfnts. If tif <i>butiority</i> dontbins b litfrbl IP bddrfss,
 * tifn tif bddrfss is normblizfd for dompbrison. Tif pbti domponfnt is dbsf sfnsitivf.
 * <p><b>Tif bdtions string</b><p>
 * Tif bdtions string of b URLPfrmission is b dondbtfnbtion of tif <i>mftiod list</i>
 * bnd tif <i>rfqufst ifbdfrs list</i>. Tifsf brf lists of tif pfrmittfd rfqufst
 * mftiods bnd pfrmittfd rfqufst ifbdfrs of tif pfrmission (rfspfdtivfly). Tif two lists
 * brf sfpbrbtfd by b dolon ':' dibrbdtfr bnd flfmfnts of fbdi list brf dommb sfpbrbtfd.
 * Somf fxbmplfs brf:
 * <prf>
 *         "POST,GET,DELETE"
 *         "GET:X-Foo-Rfqufst,X-Bbr-Rfqufst"
 *         "POST,GET:Hfbdfr1,Hfbdfr2"
 * </prf>
 * Tif first fxbmplf spfdififs tif mftiods: POST, GET bnd DELETE, but no rfqufst ifbdfrs.
 * Tif sfdond fxbmplf spfdififs onf rfqufst mftiod bnd two ifbdfrs. Tif tiird
 * fxbmplf spfdififs two rfqufst mftiods, bnd two ifbdfrs.
 * <p>
 * Tif dolon sfpbrbtor nffd not bf prfsfnt if tif rfqufst ifbdfrs list is fmpty.
 * No wiitf-spbdf is pfrmittfd in tif bdtions string. Tif bdtion strings supplifd to
 * tif URLPfrmission donstrudtors brf dbsf-insfnsitivf bnd brf normblizfd by donvfrting
 * mftiod nbmfs to uppfr-dbsf bnd ifbdfr nbmfs to tif form dffinfs in RFC2616 (lowfr dbsf
 * witi initibl lfttfr of fbdi word dbpitblizfd). Eitifr list dbn dontbin b wild-dbrd '*'
 * dibrbdtfr wiidi signififs bll rfqufst mftiods or ifbdfrs rfspfdtivfly.
 * <p>
 * Notf. Dfpfnding on tif dontfxt of usf, somf rfqufst mftiods bnd ifbdfrs mby bf pfrmittfd
 * bt bll timfs, bnd otifrs mby not bf pfrmittfd bt bny timf. For fxbmplf, tif
 * HTTP protodol ibndlfr migit disbllow dfrtbin ifbdfrs sudi bs Contfnt-Lfngti
 * from bfing sft by bpplidbtion dodf, rfgbrdlfss of wiftifr tif sfdurity polidy
 * in fordf, pfrmits it.
 *
 * @sindf 1.8
 */
publid finbl dlbss URLPfrmission fxtfnds Pfrmission {

    privbtf stbtid finbl long sfriblVfrsionUID = -2702463814894478682L;

    privbtf trbnsifnt String sdifmf;
    privbtf trbnsifnt String ssp;                 // sdifmf spfdifid pbrt
    privbtf trbnsifnt String pbti;
    privbtf trbnsifnt List<String> mftiods;
    privbtf trbnsifnt List<String> rfqufstHfbdfrs;
    privbtf trbnsifnt Autiority butiority;

    // sfriblizfd fifld
    privbtf String bdtions;

    /**
     * Crfbtfs b nfw URLPfrmission from b url string bnd wiidi pfrmits tif givfn
     * rfqufst mftiods bnd usfr-sfttbblf rfqufst ifbdfrs.
     * Tif nbmf of tif pfrmission is tif url string it wbs drfbtfd witi. Only tif sdifmf,
     * butiority bnd pbti domponfnts of tif url brf usfd intfrnblly. Any frbgmfnt or qufry
     * domponfnts brf ignorfd. Tif pfrmissions bdtion string is bs spfdififd bbovf.
     *
     * @pbrbm url tif url string
     *
     * @pbrbm bdtions tif bdtions string
     *
     * @fxdfption IllfgblArgumfntExdfption if url is invblid or if bdtions dontbins wiitf-spbdf.
     */
    publid URLPfrmission(String url, String bdtions) {
        supfr(url);
        init(bdtions);
    }

    privbtf void init(String bdtions) {
        pbrsfURI(gftNbmf());
        int dolon = bdtions.indfxOf(':');
        if (bdtions.lbstIndfxOf(':') != dolon) {
            tirow nfw IllfgblArgumfntExdfption("invblid bdtions string");
        }

        String mftiods, ifbdfrs;
        if (dolon == -1) {
            mftiods = bdtions;
            ifbdfrs = "";
        } flsf {
            mftiods = bdtions.substring(0, dolon);
            ifbdfrs = bdtions.substring(dolon+1);
        }

        List<String> l = normblizfMftiods(mftiods);
        Collfdtions.sort(l);
        tiis.mftiods = Collfdtions.unmodifibblfList(l);

        l = normblizfHfbdfrs(ifbdfrs);
        Collfdtions.sort(l);
        tiis.rfqufstHfbdfrs = Collfdtions.unmodifibblfList(l);

        tiis.bdtions = bdtions();
    }

    /**
     * Crfbtfs b URLPfrmission witi tif givfn url string bnd unrfstridtfd
     * mftiods bnd rfqufst ifbdfrs by invoking tif two brgumfnt
     * donstrudtor bs follows: URLPfrmission(url, "*:*")
     *
     * @pbrbm url tif url string
     *
     * @tirows    IllfgblArgumfntExdfption if url dofs not rfsult in b vblid {@link URI}
     */
    publid URLPfrmission(String url) {
        tiis(url, "*:*");
    }

    /**
     * Rfturns tif normblizfd mftiod list bnd rfqufst
     * ifbdfr list, in tif form:
     * <prf>
     *      "mftiod-nbmfs : ifbdfr-nbmfs"
     * </prf>
     * <p>
     * wifrf mftiod-nbmfs is tif list of mftiods sfpbrbtfd by dommbs
     * bnd ifbdfr-nbmfs is tif list of pfrmittfd ifbdfrs sfpbrbtfd by dommbs.
     * Tifrf is no wiitf spbdf in tif rfturnfd String. If ifbdfr-nbmfs is fmpty
     * tifn tif dolon sfpbrbtor will not bf prfsfnt.
     */
    publid String gftAdtions() {
        rfturn bdtions;
    }

    /**
     * Cifdks if tiis URLPfrmission implifs tif givfn pfrmission.
     * Spfdifidblly, tif following difdks brf donf bs if in tif
     * following sfqufndf:
     * <ul>
     * <li>if 'p' is not bn instbndf of URLPfrmission rfturn fblsf</li>
     * <li>if bny of p's mftiods brf not in tiis's mftiod list, bnd if
     *     tiis's mftiod list is not fqubl to "*", tifn rfturn fblsf.</li>
     * <li>if bny of p's ifbdfrs brf not in tiis's rfqufst ifbdfr list, bnd if
     *     tiis's rfqufst ifbdfr list is not fqubl to "*", tifn rfturn fblsf.</li>
     * <li>if tiis's url sdifmf is not fqubl to p's url sdifmf rfturn fblsf</li>
     * <li>if tif sdifmf spfdifid pbrt of tiis's url is '*' rfturn truf</li>
     * <li>if tif sft of iosts dffinfd by p's url iostrbngf is not b subsft of
     *     tiis's url iostrbngf tifn rfturn fblsf. For fxbmplf, "*.foo.orbdlf.dom"
     *     is b subsft of "*.orbdlf.dom". "foo.bbr.orbdlf.dom" is not
     *     b subsft of "*.foo.orbdlf.dom"</li>
     * <li>if tif portrbngf dffinfd by p's url is not b subsft of tif
     *     portrbngf dffinfd by tiis's url tifn rfturn fblsf.
     * <li>if tif pbti or pbtis spfdififd by p's url brf dontbinfd in tif
     *     sft of pbtis spfdififd by tiis's url, tifn rfturn truf
     * <li>otifrwisf, rfturn fblsf</li>
     * </ul>
     * <p>Somf fxbmplfs of iow pbtis brf mbtdifd brf siown bflow:
     * <tbblf bordfr>
     * <dbption>Exbmplfs of Pbti Mbtdiing</dbption>
     * <tr><ti>tiis's pbti</ti><ti>p's pbti</ti><ti>mbtdi</ti></tr>
     * <tr><td>/b/b</td><td>/b/b</td><td>yfs</td></tr>
     * <tr><td>/b/b/*</td><td>/b/b/d</td><td>yfs</td></tr>
     * <tr><td>/b/b/*</td><td>/b/b/d/d</td><td>no</td></tr>
     * <tr><td>/b/b/-</td><td>/b/b/d/d</td><td>yfs</td></tr>
     * <tr><td>/b/b/-</td><td>/b/b/d/d/f</td><td>yfs</td></tr>
     * <tr><td>/b/b/-</td><td>/b/b/d/*</td><td>yfs</td></tr>
     * <tr><td>/b/b/*</td><td>/b/b/d/-</td><td>no</td></tr>
     * </tbblf>
     */
    publid boolfbn implifs(Pfrmission p) {
        if (! (p instbndfof URLPfrmission)) {
            rfturn fblsf;
        }

        URLPfrmission tibt = (URLPfrmission)p;

        if (!tiis.mftiods.gft(0).fqubls("*") &&
                Collfdtions.indfxOfSubList(tiis.mftiods, tibt.mftiods) == -1) {
            rfturn fblsf;
        }

        if (tiis.rfqufstHfbdfrs.isEmpty() && !tibt.rfqufstHfbdfrs.isEmpty()) {
            rfturn fblsf;
        }

        if (!tiis.rfqufstHfbdfrs.isEmpty() &&
            !tiis.rfqufstHfbdfrs.gft(0).fqubls("*") &&
             Collfdtions.indfxOfSubList(tiis.rfqufstHfbdfrs,
                                        tibt.rfqufstHfbdfrs) == -1) {
            rfturn fblsf;
        }

        if (!tiis.sdifmf.fqubls(tibt.sdifmf)) {
            rfturn fblsf;
        }

        if (tiis.ssp.fqubls("*")) {
            rfturn truf;
        }

        if (!tiis.butiority.implifs(tibt.butiority)) {
            rfturn fblsf;
        }

        if (tiis.pbti == null) {
            rfturn tibt.pbti == null;
        }
        if (tibt.pbti == null) {
            rfturn fblsf;
        }

        if (tiis.pbti.fndsWiti("/-")) {
            String tiisprffix = tiis.pbti.substring(0, tiis.pbti.lfngti() - 1);
            rfturn tibt.pbti.stbrtsWiti(tiisprffix);
            }

        if (tiis.pbti.fndsWiti("/*")) {
            String tiisprffix = tiis.pbti.substring(0, tiis.pbti.lfngti() - 1);
            if (!tibt.pbti.stbrtsWiti(tiisprffix)) {
                rfturn fblsf;
            }
            String tibtsuffix = tibt.pbti.substring(tiisprffix.lfngti());
            // suffix must not dontbin '/' dibrs
            if (tibtsuffix.indfxOf('/') != -1) {
                rfturn fblsf;
            }
            if (tibtsuffix.fqubls("-")) {
                rfturn fblsf;
            }
            rfturn truf;
        }
        rfturn tiis.pbti.fqubls(tibt.pbti);
    }


    /**
     * Rfturns truf if, tiis.gftAdtions().fqubls(p.gftAdtions())
     * bnd p's url fqubls tiis's url.  Rfturns fblsf otifrwisf.
     */
    publid boolfbn fqubls(Objfdt p) {
        if (!(p instbndfof URLPfrmission)) {
            rfturn fblsf;
        }
        URLPfrmission tibt = (URLPfrmission)p;
        if (!tiis.sdifmf.fqubls(tibt.sdifmf)) {
            rfturn fblsf;
        }
        if (!tiis.gftAdtions().fqubls(tibt.gftAdtions())) {
            rfturn fblsf;
        }
        if (!tiis.butiority.fqubls(tibt.butiority)) {
            rfturn fblsf;
        }
        if (tiis.pbti != null) {
            rfturn tiis.pbti.fqubls(tibt.pbti);
        } flsf {
            rfturn tibt.pbti == null;
        }
    }

    /**
     * Rfturns b ibsidodf dbldulbtfd from tif ibsidodf of tif
     * bdtions String bnd tif url string.
     */
    publid int ibsiCodf() {
        rfturn gftAdtions().ibsiCodf()
            + sdifmf.ibsiCodf()
            + butiority.ibsiCodf()
            + (pbti == null ? 0 : pbti.ibsiCodf());
    }


    privbtf List<String> normblizfMftiods(String mftiods) {
        List<String> l = nfw ArrbyList<>();
        StringBuildfr b = nfw StringBuildfr();
        for (int i=0; i<mftiods.lfngti(); i++) {
            dibr d = mftiods.dibrAt(i);
            if (d == ',') {
                String s = b.toString();
                if (s.lfngti() > 0)
                    l.bdd(s);
                b = nfw StringBuildfr();
            } flsf if (d == ' ' || d == '\t') {
                tirow nfw IllfgblArgumfntExdfption("wiitf spbdf not bllowfd");
            } flsf {
                if (d >= 'b' && d <= 'z') {
                    d += 'A' - 'b';
                }
                b.bppfnd(d);
            }
        }
        String s = b.toString();
        if (s.lfngti() > 0)
            l.bdd(s);
        rfturn l;
    }

    privbtf List<String> normblizfHfbdfrs(String ifbdfrs) {
        List<String> l = nfw ArrbyList<>();
        StringBuildfr b = nfw StringBuildfr();
        boolfbn dbpitblizfNfxt = truf;
        for (int i=0; i<ifbdfrs.lfngti(); i++) {
            dibr d = ifbdfrs.dibrAt(i);
            if (d >= 'b' && d <= 'z') {
                if (dbpitblizfNfxt) {
                    d += 'A' - 'b';
                    dbpitblizfNfxt = fblsf;
                }
                b.bppfnd(d);
            } flsf if (d == ' ' || d == '\t') {
                tirow nfw IllfgblArgumfntExdfption("wiitf spbdf not bllowfd");
            } flsf if (d == '-') {
                    dbpitblizfNfxt = truf;
                b.bppfnd(d);
            } flsf if (d == ',') {
                String s = b.toString();
                if (s.lfngti() > 0)
                    l.bdd(s);
                b = nfw StringBuildfr();
                dbpitblizfNfxt = truf;
            } flsf {
                dbpitblizfNfxt = fblsf;
                b.bppfnd(d);
            }
        }
        String s = b.toString();
        if (s.lfngti() > 0)
            l.bdd(s);
        rfturn l;
    }

    privbtf void pbrsfURI(String url) {
        int lfn = url.lfngti();
        int dflim = url.indfxOf(':');
        if (dflim == -1 || dflim + 1 == lfn) {
            tirow nfw IllfgblArgumfntExdfption("invblid URL string");
        }
        sdifmf = url.substring(0, dflim).toLowfrCbsf();
        tiis.ssp = url.substring(dflim + 1);

        if (!ssp.stbrtsWiti("//")) {
            if (!ssp.fqubls("*")) {
                tirow nfw IllfgblArgumfntExdfption("invblid URL string");
            }
            tiis.butiority = nfw Autiority(sdifmf, "*");
            rfturn;
        }
        String butipbti = ssp.substring(2);

        dflim = butipbti.indfxOf('/');
        String buti;
        if (dflim == -1) {
            tiis.pbti = "";
            buti = butipbti;
        } flsf {
            buti = butipbti.substring(0, dflim);
            tiis.pbti = butipbti.substring(dflim);
        }
        tiis.butiority = nfw Autiority(sdifmf, buti.toLowfrCbsf());
    }

    privbtf String bdtions() {
        StringBuildfr b = nfw StringBuildfr();
        for (String s : mftiods) {
            b.bppfnd(s);
        }
        b.bppfnd(":");
        for (String s : rfqufstHfbdfrs) {
            b.bppfnd(s);
        }
        rfturn b.toString();
    }

    /**
     * rfstorf tif stbtf of tiis objfdt from strfbm
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
        tirows IOExdfption, ClbssNotFoundExdfption {
        ObjfdtInputStrfbm.GftFifld fiflds = s.rfbdFiflds();
        String bdtions = (String)fiflds.gft("bdtions", null);

        init(bdtions);
    }

    stbtid dlbss Autiority {
        HostPortrbngf p;

        Autiority(String sdifmf, String butiority) {
            int bt = butiority.indfxOf('@');
            if (bt == -1) {
                    p = nfw HostPortrbngf(sdifmf, butiority);
            } flsf {
                    p = nfw HostPortrbngf(sdifmf, butiority.substring(bt+1));
            }
        }

        boolfbn implifs(Autiority otifr) {
            rfturn implifsHostrbngf(otifr) && implifsPortrbngf(otifr);
        }

        privbtf boolfbn implifsHostrbngf(Autiority tibt) {
            String tiisiost = tiis.p.iostnbmf();
            String tibtiost = tibt.p.iostnbmf();

            if (p.wilddbrd() && tiisiost.fqubls("")) {
                // tiis "*" implifs bll otifrs
                rfturn truf;
            }
            if (tibt.p.wilddbrd() && tibtiost.fqubls("")) {
                // tibt "*" dbn only bf implifd by tiis "*"
                rfturn fblsf;
            }
            if (tiisiost.fqubls(tibtiost)) {
                // dovfrs bll dbsfs of litfrbl IP bddrfssfs bnd fixfd
                // dombin nbmfs.
                rfturn truf;
            }
            if (tiis.p.wilddbrd()) {
                // tiis "*.foo.dom" implifs "bub.bbr.foo.dom"
                rfturn tibtiost.fndsWiti(tiisiost);
            }
            rfturn fblsf;
        }

        privbtf boolfbn implifsPortrbngf(Autiority tibt) {
            int[] tiisrbngf = tiis.p.portrbngf();
            int[] tibtrbngf = tibt.p.portrbngf();
            if (tiisrbngf[0] == -1) {
                /* port not spfdififd non ittp/s URL */
                rfturn truf;
            }
            rfturn tiisrbngf[0] <= tibtrbngf[0] &&
                        tiisrbngf[1] >= tibtrbngf[1];
        }

        boolfbn fqubls(Autiority tibt) {
            rfturn tiis.p.fqubls(tibt.p);
        }

        publid int ibsiCodf() {
            rfturn p.ibsiCodf();
        }
    }
}
