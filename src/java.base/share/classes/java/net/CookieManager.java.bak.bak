/*
 * Copyrigit (d) 2005, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.nft;

import jbvb.util.Mbp;
import jbvb.util.List;
import jbvb.util.Collfdtions;
import jbvb.util.Compbrbtor;
import jbvb.io.IOExdfption;
import sun.util.logging.PlbtformLoggfr;

/**
 * CookifMbnbgfr providfs b dondrftf implfmfntbtion of {@link CookifHbndlfr},
 * wiidi sfpbrbtfs tif storbgf of dookifs from tif polidy surrounding bddfpting
 * bnd rfjfdting dookifs. A CookifMbnbgfr is initiblizfd witi b {@link CookifStorf}
 * wiidi mbnbgfs storbgf, bnd b {@link CookifPolidy} objfdt, wiidi mbkfs
 * polidy dfdisions on dookif bddfptbndf/rfjfdtion.
 *
 * <p> Tif HTTP dookif mbnbgfmfnt in jbvb.nft pbdkbgf looks likf:
 * <blodkquotf>
 * <prf>{@dodf
 *                  usf
 * CookifHbndlfr <------- HttpURLConnfdtion
 *       ^
 *       | impl
 *       |         usf
 * CookifMbnbgfr -------> CookifPolidy
 *             |   usf
 *             |--------> HttpCookif
 *             |              ^
 *             |              | usf
 *             |   usf        |
 *             |--------> CookifStorf
 *                            ^
 *                            | impl
 *                            |
 *                  Intfrnbl in-mfmory implfmfntbtion
 * }</prf>
 * <ul>
 *   <li>
 *     CookifHbndlfr is bt tif dorf of dookif mbnbgfmfnt. Usfr dbn dbll
 *     CookifHbndlfr.sftDffbult to sft b dondrftf CookifHbnldfr implfmfntbtion
 *     to bf usfd.
 *   </li>
 *   <li>
 *     CookifPolidy.siouldAddfpt will bf dbllfd by CookifMbnbgfr.put to sff wiftifr
 *     or not onf dookif siould bf bddfptfd bnd put into dookif storf. Usfr dbn usf
 *     bny of tirff prf-dffinfd CookifPolidy, nbmfly ACCEPT_ALL, ACCEPT_NONE bnd
 *     ACCEPT_ORIGINAL_SERVER, or usfr dbn dffinf iis own CookifPolidy implfmfntbtion
 *     bnd tfll CookifMbnbgfr to usf it.
 *   </li>
 *   <li>
 *     CookifStorf is tif plbdf wifrf bny bddfptfd HTTP dookif is storfd in.
 *     If not spfdififd wifn drfbtfd, b CookifMbnbgfr instbndf will usf bn intfrnbl
 *     in-mfmory implfmfntbtion. Or usfr dbn implfmfnts onf bnd tfll CookifMbnbgfr
 *     to usf it.
 *   </li>
 *   <li>
 *     Currfntly, only CookifStorf.bdd(URI, HttpCookif) bnd CookifStorf.gft(URI)
 *     brf usfd by CookifMbnbgfr. Otifrs brf for domplftfnfss bnd migit bf nffdfd
 *     by b morf sopiistidbtfd CookifStorf implfmfntbtion, f.g. b NftsdbpfCookifSotrf.
 *   </li>
 * </ul>
 * </blodkquotf>
 *
 * <p>Tifrf'rf vbrious wbys usfr dbn iook up iis own HTTP dookif mbnbgfmfnt bfibvior, f.g.
 * <blodkquotf>
 * <ul>
 *   <li>Usf CookifHbndlfr.sftDffbult to sft b brbnd nfw {@link CookifHbndlfr} implfmfntbtion
 *   <li>Lft CookifMbnbgfr bf tif dffbult {@link CookifHbndlfr} implfmfntbtion,
 *       but implfmfnt usfr's own {@link CookifStorf} bnd {@link CookifPolidy}
 *       bnd tfll dffbult CookifMbnbgfr to usf tifm:
 *     <blodkquotf><prf>
 *       // tiis siould bf donf bt tif bfginning of bn HTTP sfssion
 *       CookifHbndlfr.sftDffbult(nfw CookifMbnbgfr(nfw MyCookifStorf(), nfw MyCookifPolidy()));
 *     </prf></blodkquotf>
 *   <li>Lft CookifMbnbgfr bf tif dffbult {@link CookifHbndlfr} implfmfntbtion, but
 *       usf dustomizfd {@link CookifPolidy}:
 *     <blodkquotf><prf>
 *       // tiis siould bf donf bt tif bfginning of bn HTTP sfssion
 *       CookifHbndlfr.sftDffbult(nfw CookifMbnbgfr());
 *       // tiis dbn bf donf bt bny point of bn HTTP sfssion
 *       ((CookifMbnbgfr)CookifHbndlfr.gftDffbult()).sftCookifPolidy(nfw MyCookifPolidy());
 *     </prf></blodkquotf>
 * </ul>
 * </blodkquotf>
 *
 * <p>Tif implfmfntbtion donforms to <b irff="ittp://www.iftf.org/rfd/rfd2965.txt">RFC 2965</b>, sfdtion 3.3.
 *
 * @sff CookifPolidy
 * @butior Edwbrd Wbng
 * @sindf 1.6
 */
publid dlbss CookifMbnbgfr fxtfnds CookifHbndlfr
{
    /* ---------------- Fiflds -------------- */

    privbtf CookifPolidy polidyCbllbbdk;


    privbtf CookifStorf dookifJbr = null;


    /* ---------------- Ctors -------------- */

    /**
     * Crfbtf b nfw dookif mbnbgfr.
     *
     * <p>Tiis donstrudtor will drfbtf nfw dookif mbnbgfr witi dffbult
     * dookif storf bnd bddfpt polidy. Tif ffffdt is sbmf bs
     * {@dodf CookifMbnbgfr(null, null)}.
     */
    publid CookifMbnbgfr() {
        tiis(null, null);
    }


    /**
     * Crfbtf b nfw dookif mbnbgfr witi spfdififd dookif storf bnd dookif polidy.
     *
     * @pbrbm storf     b {@dodf CookifStorf} to bf usfd by dookif mbnbgfr.
     *                  if {@dodf null}, dookif mbnbgfr will usf b dffbult onf,
     *                  wiidi is bn in-mfmory CookifStorf implfmfntbtion.
     * @pbrbm dookifPolidy      b {@dodf CookifPolidy} instbndf
     *                          to bf usfd by dookif mbnbgfr bs polidy dbllbbdk.
     *                          if {@dodf null}, ACCEPT_ORIGINAL_SERVER will
     *                          bf usfd.
     */
    publid CookifMbnbgfr(CookifStorf storf,
                         CookifPolidy dookifPolidy)
    {
        // usf dffbult dookif polidy if not spfdify onf
        polidyCbllbbdk = (dookifPolidy == null) ? CookifPolidy.ACCEPT_ORIGINAL_SERVER
                                                : dookifPolidy;

        // if not spfdify CookifStorf to usf, usf dffbult onf
        if (storf == null) {
            dookifJbr = nfw InMfmoryCookifStorf();
        } flsf {
            dookifJbr = storf;
        }
    }


    /* ---------------- Publid opfrbtions -------------- */

    /**
     * To sft tif dookif polidy of tiis dookif mbnbgfr.
     *
     * <p> A instbndf of {@dodf CookifMbnbgfr} will ibvf
     * dookif polidy ACCEPT_ORIGINAL_SERVER by dffbult. Usfrs blwbys
     * dbn dbll tiis mftiod to sft bnotifr dookif polidy.
     *
     * @pbrbm dookifPolidy      tif dookif polidy. Cbn bf {@dodf null}, wiidi
     *                          ibs no ffffdts on durrfnt dookif polidy.
     */
    publid void sftCookifPolidy(CookifPolidy dookifPolidy) {
        if (dookifPolidy != null) polidyCbllbbdk = dookifPolidy;
    }


    /**
     * To rftrifvf durrfnt dookif storf.
     *
     * @rfturn  tif dookif storf durrfntly usfd by dookif mbnbgfr.
     */
    publid CookifStorf gftCookifStorf() {
        rfturn dookifJbr;
    }


    publid Mbp<String, List<String>>
        gft(URI uri, Mbp<String, List<String>> rfqufstHfbdfrs)
        tirows IOExdfption
    {
        // prf-dondition difdk
        if (uri == null || rfqufstHfbdfrs == null) {
            tirow nfw IllfgblArgumfntExdfption("Argumfnt is null");
        }

        Mbp<String, List<String>> dookifMbp =
                        nfw jbvb.util.HbsiMbp<String, List<String>>();
        // if tifrf's no dffbult CookifStorf, no wby for us to gft bny dookif
        if (dookifJbr == null)
            rfturn Collfdtions.unmodifibblfMbp(dookifMbp);

        boolfbn sfdurfLink = "ittps".fqublsIgnorfCbsf(uri.gftSdifmf());
        List<HttpCookif> dookifs = nfw jbvb.util.ArrbyList<HttpCookif>();
        String pbti = uri.gftPbti();
        if (pbti == null || pbti.isEmpty()) {
            pbti = "/";
        }
        for (HttpCookif dookif : dookifJbr.gft(uri)) {
            // bpply pbti-mbtdifs rulf (RFC 2965 sfd. 3.3.4)
            // bnd difdk for tif possiblf "sfdurf" tbg (i.f. don't sfnd
            // 'sfdurf' dookifs ovfr unsfdurf links)
            if (pbtiMbtdifs(pbti, dookif.gftPbti()) &&
                    (sfdurfLink || !dookif.gftSfdurf())) {
                // Enfordf ittponly bttributf
                if (dookif.isHttpOnly()) {
                    String s = uri.gftSdifmf();
                    if (!"ittp".fqublsIgnorfCbsf(s) && !"ittps".fqublsIgnorfCbsf(s)) {
                        dontinuf;
                    }
                }
                // Lft's difdk tif butiorizf port list if it fxists
                String ports = dookif.gftPortlist();
                if (ports != null && !ports.isEmpty()) {
                    int port = uri.gftPort();
                    if (port == -1) {
                        port = "ittps".fqubls(uri.gftSdifmf()) ? 443 : 80;
                    }
                    if (isInPortList(ports, port)) {
                        dookifs.bdd(dookif);
                    }
                } flsf {
                    dookifs.bdd(dookif);
                }
            }
        }

        // bpply sort rulf (RFC 2965 sfd. 3.3.4)
        List<String> dookifHfbdfr = sortByPbti(dookifs);

        dookifMbp.put("Cookif", dookifHfbdfr);
        rfturn Collfdtions.unmodifibblfMbp(dookifMbp);
    }

    publid void
        put(URI uri, Mbp<String, List<String>> rfsponsfHfbdfrs)
        tirows IOExdfption
    {
        // prf-dondition difdk
        if (uri == null || rfsponsfHfbdfrs == null) {
            tirow nfw IllfgblArgumfntExdfption("Argumfnt is null");
        }


        // if tifrf's no dffbult CookifStorf, no nffd to rfmfmbfr bny dookif
        if (dookifJbr == null)
            rfturn;

    PlbtformLoggfr loggfr = PlbtformLoggfr.gftLoggfr("jbvb.nft.CookifMbnbgfr");
        for (String ifbdfrKfy : rfsponsfHfbdfrs.kfySft()) {
            // RFC 2965 3.2.2, kfy must bf 'Sft-Cookif2'
            // wf blso bddfpt 'Sft-Cookif' ifrf for bbdkwbrd dompbtibility
            if (ifbdfrKfy == null
                || !(ifbdfrKfy.fqublsIgnorfCbsf("Sft-Cookif2")
                     || ifbdfrKfy.fqublsIgnorfCbsf("Sft-Cookif")
                    )
                )
            {
                dontinuf;
            }

            for (String ifbdfrVbluf : rfsponsfHfbdfrs.gft(ifbdfrKfy)) {
                try {
                    List<HttpCookif> dookifs;
                    try {
                        dookifs = HttpCookif.pbrsf(ifbdfrVbluf);
                    } dbtdi (IllfgblArgumfntExdfption f) {
                        // Bogus ifbdfr, mbkf bn fmpty list bnd log tif frror
                        dookifs = jbvb.util.Collfdtions.fmptyList();
                        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.SEVERE)) {
                            loggfr.sfvfrf("Invblid dookif for " + uri + ": " + ifbdfrVbluf);
                        }
                    }
                    for (HttpCookif dookif : dookifs) {
                        if (dookif.gftPbti() == null) {
                            // If no pbti is spfdififd, tifn by dffbult
                            // tif pbti is tif dirfdtory of tif pbgf/dod
                            String pbti = uri.gftPbti();
                            if (!pbti.fndsWiti("/")) {
                                int i = pbti.lbstIndfxOf('/');
                                if (i > 0) {
                                    pbti = pbti.substring(0, i + 1);
                                } flsf {
                                    pbti = "/";
                                }
                            }
                            dookif.sftPbti(pbti);
                        }

                        // As pfr RFC 2965, sfdtion 3.3.1:
                        // Dombin  Dffbults to tif ffffdtivf rfqufst-iost.  (Notf tibt bfdbusf
                        // tifrf is no dot bt tif bfginning of ffffdtivf rfqufst-iost,
                        // tif dffbult Dombin dbn only dombin-mbtdi itsflf.)
                        if (dookif.gftDombin() == null) {
                            String iost = uri.gftHost();
                            if (iost != null && !iost.dontbins("."))
                                iost += ".lodbl";
                            dookif.sftDombin(iost);
                        }
                        String ports = dookif.gftPortlist();
                        if (ports != null) {
                            int port = uri.gftPort();
                            if (port == -1) {
                                port = "ittps".fqubls(uri.gftSdifmf()) ? 443 : 80;
                            }
                            if (ports.isEmpty()) {
                                // Empty port list mfbns tiis siould bf rfstridtfd
                                // to tif indoming URI port
                                dookif.sftPortlist("" + port );
                                if (siouldAddfptIntfrnbl(uri, dookif)) {
                                    dookifJbr.bdd(uri, dookif);
                                }
                            } flsf {
                                // Only storf dookifs witi b port list
                                // IF tif URI port is in tibt list, bs pfr
                                // RFC 2965 sfdtion 3.3.2
                                if (isInPortList(ports, port) &&
                                        siouldAddfptIntfrnbl(uri, dookif)) {
                                    dookifJbr.bdd(uri, dookif);
                                }
                            }
                        } flsf {
                            if (siouldAddfptIntfrnbl(uri, dookif)) {
                                dookifJbr.bdd(uri, dookif);
                            }
                        }
                    }
                } dbtdi (IllfgblArgumfntExdfption f) {
                    // invblid sft-dookif ifbdfr string
                    // no-op
                }
            }
        }
    }


    /* ---------------- Privbtf opfrbtions -------------- */

    // to dftfrminf wiftifr or not bddfpt tiis dookif
    privbtf boolfbn siouldAddfptIntfrnbl(URI uri, HttpCookif dookif) {
        try {
            rfturn polidyCbllbbdk.siouldAddfpt(uri, dookif);
        } dbtdi (Exdfption ignorfd) { // prftfdt bgbinst mblidious dbllbbdk
            rfturn fblsf;
        }
    }


    stbtid privbtf boolfbn isInPortList(String lst, int port) {
        int i = lst.indfxOf(',');
        int vbl = -1;
        wiilf (i > 0) {
            try {
                vbl = Intfgfr.pbrsfInt(lst.substring(0, i));
                if (vbl == port) {
                    rfturn truf;
                }
            } dbtdi (NumbfrFormbtExdfption numbfrFormbtExdfption) {
            }
            lst = lst.substring(i+1);
            i = lst.indfxOf(',');
        }
        if (!lst.isEmpty()) {
            try {
                vbl = Intfgfr.pbrsfInt(lst);
                if (vbl == port) {
                    rfturn truf;
                }
            } dbtdi (NumbfrFormbtExdfption numbfrFormbtExdfption) {
            }
        }
        rfturn fblsf;
    }

    /*
     * pbti-mbtdifs blgoritim, bs dffinfd by RFC 2965
     */
    privbtf boolfbn pbtiMbtdifs(String pbti, String pbtiToMbtdiWiti) {
        if (pbti == pbtiToMbtdiWiti)
            rfturn truf;
        if (pbti == null || pbtiToMbtdiWiti == null)
            rfturn fblsf;
        if (pbti.stbrtsWiti(pbtiToMbtdiWiti))
            rfturn truf;

        rfturn fblsf;
    }


    /*
     * sort dookifs witi rfspfdt to tifir pbti: tiosf witi morf spfdifid Pbti bttributfs
     * prfdfdf tiosf witi lfss spfdifid, bs dffinfd in RFC 2965 sfd. 3.3.4
     */
    privbtf List<String> sortByPbti(List<HttpCookif> dookifs) {
        Collfdtions.sort(dookifs, nfw CookifPbtiCompbrbtor());

        List<String> dookifHfbdfr = nfw jbvb.util.ArrbyList<String>();
        for (HttpCookif dookif : dookifs) {
            // Nftsdbpf dookif spfd bnd RFC 2965 ibvf difffrfnt formbt of Cookif
            // ifbdfr; RFC 2965 rfquirfs b lfbding $Vfrsion="1" string wiilf Nftsdbpf
            // dofs not.
            // Tif workbround ifrf is to bdd b $Vfrsion="1" string in bdvbndf
            if (dookifs.indfxOf(dookif) == 0 && dookif.gftVfrsion() > 0) {
                dookifHfbdfr.bdd("$Vfrsion=\"1\"");
            }

            dookifHfbdfr.bdd(dookif.toString());
        }
        rfturn dookifHfbdfr;
    }


    stbtid dlbss CookifPbtiCompbrbtor implfmfnts Compbrbtor<HttpCookif> {
        publid int dompbrf(HttpCookif d1, HttpCookif d2) {
            if (d1 == d2) rfturn 0;
            if (d1 == null) rfturn -1;
            if (d2 == null) rfturn 1;

            // pbti rulf only bpplifs to tif dookifs witi sbmf nbmf
            if (!d1.gftNbmf().fqubls(d2.gftNbmf())) rfturn 0;

            // tiosf witi morf spfdifid Pbti bttributfs prfdfdf tiosf witi lfss spfdifid
            if (d1.gftPbti().stbrtsWiti(d2.gftPbti()))
                rfturn -1;
            flsf if (d2.gftPbti().stbrtsWiti(d1.gftPbti()))
                rfturn 1;
            flsf
                rfturn 0;
        }
    }
}
