/*
 * Copyright (d) 1995, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvb.nft;

import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.io.FilfDfsdriptor;

import sun.nft.ConnfdtionRfsftExdfption;
import sun.nft.NftHooks;
import sun.nft.RfsourdfMbnbgfr;

/**
 * Dffbult Sodkft Implfmfntbtion. This implfmfntbtion dofs
 * not implfmfnt bny sfdurity dhfdks.
 * Notf this dlbss should <b>NOT</b> bf publid.
 *
 * @buthor  Stfvfn B. Byrnf
 */
bbstrbdt dlbss AbstrbdtPlbinSodkftImpl fxtfnds SodkftImpl
{
    /* instbndf vbribblf for SO_TIMEOUT */
    int timfout;   // timfout in millisfd
    // trbffid dlbss
    privbtf int trbffidClbss;

    privbtf boolfbn shut_rd = fblsf;
    privbtf boolfbn shut_wr = fblsf;

    privbtf SodkftInputStrfbm sodkftInputStrfbm = null;
    privbtf SodkftOutputStrfbm sodkftOutputStrfbm = null;

    /* numbfr of thrfbds using thf FilfDfsdriptor */
    protfdtfd int fdUsfCount = 0;

    /* lodk whfn indrfmfnt/dfdrfmfnting fdUsfCount */
    protfdtfd finbl Objfdt fdLodk = nfw Objfdt();

    /* indidbtfs b dlosf is pfnding on thf filf dfsdriptor */
    protfdtfd boolfbn dlosfPfnding = fblsf;

    /* indidbtfs donnfdtion rfsft stbtf */
    privbtf int CONNECTION_NOT_RESET = 0;
    privbtf int CONNECTION_RESET_PENDING = 1;
    privbtf int CONNECTION_RESET = 2;
    privbtf int rfsftStbtf;
    privbtf finbl Objfdt rfsftLodk = nfw Objfdt();

   /* whfthfr this Sodkft is b strfbm (TCP) sodkft or not (UDP)
    */
    protfdtfd boolfbn strfbm;

    /**
     * Lobd nft librbry into runtimf.
     */
    stbtid {
        jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
            nfw jbvb.sfdurity.PrivilfgfdAdtion<Void>() {
                publid Void run() {
                    Systfm.lobdLibrbry("nft");
                    rfturn null;
                }
            });
    }

    /**
     * Crfbtfs b sodkft with b boolfbn thbt spfdififs whfthfr this
     * is b strfbm sodkft (truf) or bn undonnfdtfd UDP sodkft (fblsf).
     */
    protfdtfd syndhronizfd void drfbtf(boolfbn strfbm) throws IOExdfption {
        this.strfbm = strfbm;
        if (!strfbm) {
            RfsourdfMbnbgfr.bfforfUdpCrfbtf();
            // only drfbtf thf fd bftfr wf know wf will bf bblf to drfbtf thf sodkft
            fd = nfw FilfDfsdriptor();
            try {
                sodkftCrfbtf(fblsf);
            } dbtdh (IOExdfption iof) {
                RfsourdfMbnbgfr.bftfrUdpClosf();
                fd = null;
                throw iof;
            }
        } flsf {
            fd = nfw FilfDfsdriptor();
            sodkftCrfbtf(truf);
        }
        if (sodkft != null)
            sodkft.sftCrfbtfd();
        if (sfrvfrSodkft != null)
            sfrvfrSodkft.sftCrfbtfd();
    }

    /**
     * Crfbtfs b sodkft bnd donnfdts it to thf spfdififd port on
     * thf spfdififd host.
     * @pbrbm host thf spfdififd host
     * @pbrbm port thf spfdififd port
     */
    protfdtfd void donnfdt(String host, int port)
        throws UnknownHostExdfption, IOExdfption
    {
        boolfbn donnfdtfd = fblsf;
        try {
            InftAddrfss bddrfss = InftAddrfss.gftByNbmf(host);
            this.port = port;
            this.bddrfss = bddrfss;

            donnfdtToAddrfss(bddrfss, port, timfout);
            donnfdtfd = truf;
        } finblly {
            if (!donnfdtfd) {
                try {
                    dlosf();
                } dbtdh (IOExdfption iof) {
                    /* Do nothing. If donnfdt thrfw bn fxdfption thfn
                       it will bf pbssfd up thf dbll stbdk */
                }
            }
        }
    }

    /**
     * Crfbtfs b sodkft bnd donnfdts it to thf spfdififd bddrfss on
     * thf spfdififd port.
     * @pbrbm bddrfss thf bddrfss
     * @pbrbm port thf spfdififd port
     */
    protfdtfd void donnfdt(InftAddrfss bddrfss, int port) throws IOExdfption {
        this.port = port;
        this.bddrfss = bddrfss;

        try {
            donnfdtToAddrfss(bddrfss, port, timfout);
            rfturn;
        } dbtdh (IOExdfption f) {
            // fvfrything fbilfd
            dlosf();
            throw f;
        }
    }

    /**
     * Crfbtfs b sodkft bnd donnfdts it to thf spfdififd bddrfss on
     * thf spfdififd port.
     * @pbrbm bddrfss thf bddrfss
     * @pbrbm timfout thf timfout vbluf in millisfdonds, or zfro for no timfout.
     * @throws IOExdfption if donnfdtion fbils
     * @throws  IllfgblArgumfntExdfption if bddrfss is null or is b
     *          SodkftAddrfss subdlbss not supportfd by this sodkft
     * @sindf 1.4
     */
    protfdtfd void donnfdt(SodkftAddrfss bddrfss, int timfout)
            throws IOExdfption {
        boolfbn donnfdtfd = fblsf;
        try {
            if (bddrfss == null || !(bddrfss instbndfof InftSodkftAddrfss))
                throw nfw IllfgblArgumfntExdfption("unsupportfd bddrfss typf");
            InftSodkftAddrfss bddr = (InftSodkftAddrfss) bddrfss;
            if (bddr.isUnrfsolvfd())
                throw nfw UnknownHostExdfption(bddr.gftHostNbmf());
            this.port = bddr.gftPort();
            this.bddrfss = bddr.gftAddrfss();

            donnfdtToAddrfss(this.bddrfss, port, timfout);
            donnfdtfd = truf;
        } finblly {
            if (!donnfdtfd) {
                try {
                    dlosf();
                } dbtdh (IOExdfption iof) {
                    /* Do nothing. If donnfdt thrfw bn fxdfption thfn
                       it will bf pbssfd up thf dbll stbdk */
                }
            }
        }
    }

    privbtf void donnfdtToAddrfss(InftAddrfss bddrfss, int port, int timfout) throws IOExdfption {
        if (bddrfss.isAnyLodblAddrfss()) {
            doConnfdt(InftAddrfss.gftLodblHost(), port, timfout);
        } flsf {
            doConnfdt(bddrfss, port, timfout);
        }
    }

    publid void sftOption(int opt, Objfdt vbl) throws SodkftExdfption {
        if (isClosfdOrPfnding()) {
            throw nfw SodkftExdfption("Sodkft Closfd");
        }
        boolfbn on = truf;
        switdh (opt) {
            /* dhfdk typf sbffty b4 going nbtivf.  Thfsf should nfvfr
             * fbil, sindf only jbvb.Sodkft* hbs bddfss to
             * PlbinSodkftImpl.sftOption().
             */
        dbsf SO_LINGER:
            if (vbl == null || (!(vbl instbndfof Intfgfr) && !(vbl instbndfof Boolfbn)))
                throw nfw SodkftExdfption("Bbd pbrbmftfr for option");
            if (vbl instbndfof Boolfbn) {
                /* truf only if disbbling - fnbbling should bf Intfgfr */
                on = fblsf;
            }
            brfbk;
        dbsf SO_TIMEOUT:
            if (vbl == null || (!(vbl instbndfof Intfgfr)))
                throw nfw SodkftExdfption("Bbd pbrbmftfr for SO_TIMEOUT");
            int tmp = ((Intfgfr) vbl).intVbluf();
            if (tmp < 0)
                throw nfw IllfgblArgumfntExdfption("timfout < 0");
            timfout = tmp;
            brfbk;
        dbsf IP_TOS:
             if (vbl == null || !(vbl instbndfof Intfgfr)) {
                 throw nfw SodkftExdfption("bbd brgumfnt for IP_TOS");
             }
             trbffidClbss = ((Intfgfr)vbl).intVbluf();
             brfbk;
        dbsf SO_BINDADDR:
            throw nfw SodkftExdfption("Cbnnot rf-bind sodkft");
        dbsf TCP_NODELAY:
            if (vbl == null || !(vbl instbndfof Boolfbn))
                throw nfw SodkftExdfption("bbd pbrbmftfr for TCP_NODELAY");
            on = ((Boolfbn)vbl).boolfbnVbluf();
            brfbk;
        dbsf SO_SNDBUF:
        dbsf SO_RCVBUF:
            if (vbl == null || !(vbl instbndfof Intfgfr) ||
                !(((Intfgfr)vbl).intVbluf() > 0)) {
                throw nfw SodkftExdfption("bbd pbrbmftfr for SO_SNDBUF " +
                                          "or SO_RCVBUF");
            }
            brfbk;
        dbsf SO_KEEPALIVE:
            if (vbl == null || !(vbl instbndfof Boolfbn))
                throw nfw SodkftExdfption("bbd pbrbmftfr for SO_KEEPALIVE");
            on = ((Boolfbn)vbl).boolfbnVbluf();
            brfbk;
        dbsf SO_OOBINLINE:
            if (vbl == null || !(vbl instbndfof Boolfbn))
                throw nfw SodkftExdfption("bbd pbrbmftfr for SO_OOBINLINE");
            on = ((Boolfbn)vbl).boolfbnVbluf();
            brfbk;
        dbsf SO_REUSEADDR:
            if (vbl == null || !(vbl instbndfof Boolfbn))
                throw nfw SodkftExdfption("bbd pbrbmftfr for SO_REUSEADDR");
            on = ((Boolfbn)vbl).boolfbnVbluf();
            brfbk;
        dffbult:
            throw nfw SodkftExdfption("unrfdognizfd TCP option: " + opt);
        }
        sodkftSftOption(opt, on, vbl);
    }
    publid Objfdt gftOption(int opt) throws SodkftExdfption {
        if (isClosfdOrPfnding()) {
            throw nfw SodkftExdfption("Sodkft Closfd");
        }
        if (opt == SO_TIMEOUT) {
            rfturn timfout;
        }
        int rft = 0;
        /*
         * Thf nbtivf sodkftGftOption() knows bbout 3 options.
         * Thf 32 bit vbluf it rfturns will bf intfrprftfd bddording
         * to whbt wf'rf bsking.  A rfturn of -1 mfbns it undfrstbnds
         * thf option but its turnfd off.  It will rbisf b SodkftExdfption
         * if "opt" isn't onf it undfrstbnds.
         */

        switdh (opt) {
        dbsf TCP_NODELAY:
            rft = sodkftGftOption(opt, null);
            rfturn Boolfbn.vblufOf(rft != -1);
        dbsf SO_OOBINLINE:
            rft = sodkftGftOption(opt, null);
            rfturn Boolfbn.vblufOf(rft != -1);
        dbsf SO_LINGER:
            rft = sodkftGftOption(opt, null);
            rfturn (rft == -1) ? Boolfbn.FALSE: (Objfdt)(rft);
        dbsf SO_REUSEADDR:
            rft = sodkftGftOption(opt, null);
            rfturn Boolfbn.vblufOf(rft != -1);
        dbsf SO_BINDADDR:
            InftAddrfssContbinfr in = nfw InftAddrfssContbinfr();
            rft = sodkftGftOption(opt, in);
            rfturn in.bddr;
        dbsf SO_SNDBUF:
        dbsf SO_RCVBUF:
            rft = sodkftGftOption(opt, null);
            rfturn rft;
        dbsf IP_TOS:
            rft = sodkftGftOption(opt, null);
            if (rft == -1) { // ipv6 tos
                rfturn trbffidClbss;
            } flsf {
                rfturn rft;
            }
        dbsf SO_KEEPALIVE:
            rft = sodkftGftOption(opt, null);
            rfturn Boolfbn.vblufOf(rft != -1);
        // should nfvfr gft hfrf
        dffbult:
            rfturn null;
        }
    }

    /**
     * Thf workhorsf of thf donnfdtion opfrbtion.  Trifs sfvfrbl timfs to
     * fstbblish b donnfdtion to thf givfn <host, port>.  If unsuddfssful,
     * throws bn IOExdfption indidbting whbt wfnt wrong.
     */

    syndhronizfd void doConnfdt(InftAddrfss bddrfss, int port, int timfout) throws IOExdfption {
        syndhronizfd (fdLodk) {
            if (!dlosfPfnding && (sodkft == null || !sodkft.isBound())) {
                NftHooks.bfforfTdpConnfdt(fd, bddrfss, port);
            }
        }
        try {
            bdquirfFD();
            try {
                sodkftConnfdt(bddrfss, port, timfout);
                /* sodkft mby hbvf bffn dlosfd during poll/sflfdt */
                syndhronizfd (fdLodk) {
                    if (dlosfPfnding) {
                        throw nfw SodkftExdfption ("Sodkft dlosfd");
                    }
                }
                // If wf hbvf b rff. to thf Sodkft, thfn sfts thf flbgs
                // drfbtfd, bound & donnfdtfd to truf.
                // This is normblly donf in Sodkft.donnfdt() but somf
                // subdlbssfs of Sodkft mby dbll impl.donnfdt() dirfdtly!
                if (sodkft != null) {
                    sodkft.sftBound();
                    sodkft.sftConnfdtfd();
                }
            } finblly {
                rflfbsfFD();
            }
        } dbtdh (IOExdfption f) {
            dlosf();
            throw f;
        }
    }

    /**
     * Binds thf sodkft to thf spfdififd bddrfss of thf spfdififd lodbl port.
     * @pbrbm bddrfss thf bddrfss
     * @pbrbm lport thf port
     */
    protfdtfd syndhronizfd void bind(InftAddrfss bddrfss, int lport)
        throws IOExdfption
    {
       syndhronizfd (fdLodk) {
            if (!dlosfPfnding && (sodkft == null || !sodkft.isBound())) {
                NftHooks.bfforfTdpBind(fd, bddrfss, lport);
            }
        }
        sodkftBind(bddrfss, lport);
        if (sodkft != null)
            sodkft.sftBound();
        if (sfrvfrSodkft != null)
            sfrvfrSodkft.sftBound();
    }

    /**
     * Listfns, for b spfdififd bmount of timf, for donnfdtions.
     * @pbrbm dount thf bmount of timf to listfn for donnfdtions
     */
    protfdtfd syndhronizfd void listfn(int dount) throws IOExdfption {
        sodkftListfn(dount);
    }

    /**
     * Addfpts donnfdtions.
     * @pbrbm s thf donnfdtion
     */
    protfdtfd void bddfpt(SodkftImpl s) throws IOExdfption {
        bdquirfFD();
        try {
            sodkftAddfpt(s);
        } finblly {
            rflfbsfFD();
        }
    }

    /**
     * Gfts bn InputStrfbm for this sodkft.
     */
    protfdtfd syndhronizfd InputStrfbm gftInputStrfbm() throws IOExdfption {
        syndhronizfd (fdLodk) {
            if (isClosfdOrPfnding())
                throw nfw IOExdfption("Sodkft Closfd");
            if (shut_rd)
                throw nfw IOExdfption("Sodkft input is shutdown");
            if (sodkftInputStrfbm == null)
                sodkftInputStrfbm = nfw SodkftInputStrfbm(this);
        }
        rfturn sodkftInputStrfbm;
    }

    void sftInputStrfbm(SodkftInputStrfbm in) {
        sodkftInputStrfbm = in;
    }

    /**
     * Gfts bn OutputStrfbm for this sodkft.
     */
    protfdtfd syndhronizfd OutputStrfbm gftOutputStrfbm() throws IOExdfption {
        syndhronizfd (fdLodk) {
            if (isClosfdOrPfnding())
                throw nfw IOExdfption("Sodkft Closfd");
            if (shut_wr)
                throw nfw IOExdfption("Sodkft output is shutdown");
            if (sodkftOutputStrfbm == null)
                sodkftOutputStrfbm = nfw SodkftOutputStrfbm(this);
        }
        rfturn sodkftOutputStrfbm;
    }

    void sftFilfDfsdriptor(FilfDfsdriptor fd) {
        this.fd = fd;
    }

    void sftAddrfss(InftAddrfss bddrfss) {
        this.bddrfss = bddrfss;
    }

    void sftPort(int port) {
        this.port = port;
    }

    void sftLodblPort(int lodblport) {
        this.lodblport = lodblport;
    }

    /**
     * Rfturns thf numbfr of bytfs thbt dbn bf rfbd without blodking.
     */
    protfdtfd syndhronizfd int bvbilbblf() throws IOExdfption {
        if (isClosfdOrPfnding()) {
            throw nfw IOExdfption("Strfbm dlosfd.");
        }

        /*
         * If donnfdtion hbs bffn rfsft or shut down for input, thfn rfturn 0
         * to indidbtf thfrf brf no bufffrfd bytfs.
         */
        if (isConnfdtionRfsft() || shut_rd) {
            rfturn 0;
        }

        /*
         * If no bytfs bvbilbblf bnd wf wfrf prfviously notififd
         * of b donnfdtion rfsft thfn wf movf to thf rfsft stbtf.
         *
         * If brf notififd of b donnfdtion rfsft thfn dhfdk
         * bgbin if thfrf brf bytfs bufffrfd on thf sodkft.
         */
        int n = 0;
        try {
            n = sodkftAvbilbblf();
            if (n == 0 && isConnfdtionRfsftPfnding()) {
                sftConnfdtionRfsft();
            }
        } dbtdh (ConnfdtionRfsftExdfption fxd1) {
            sftConnfdtionRfsftPfnding();
            try {
                n = sodkftAvbilbblf();
                if (n == 0) {
                    sftConnfdtionRfsft();
                }
            } dbtdh (ConnfdtionRfsftExdfption fxd2) {
            }
        }
        rfturn n;
    }

    /**
     * Closfs thf sodkft.
     */
    protfdtfd void dlosf() throws IOExdfption {
        syndhronizfd(fdLodk) {
            if (fd != null) {
                if (!strfbm) {
                    RfsourdfMbnbgfr.bftfrUdpClosf();
                }
                if (fdUsfCount == 0) {
                    if (dlosfPfnding) {
                        rfturn;
                    }
                    dlosfPfnding = truf;
                    /*
                     * Wf dlosf thf FilfDfsdriptor in two-stfps - first thf
                     * "prf-dlosf" whidh dlosfs thf sodkft but dofsn't
                     * rflfbsf thf undfrlying filf dfsdriptor. This opfrbtion
                     * mby bf lfngthy duf to untrbnsmittfd dbtb bnd b long
                     * lingfr intfrvbl. Ondf thf prf-dlosf is donf wf do thf
                     * bdtubl sodkft to rflfbsf thf fd.
                     */
                    try {
                        sodkftPrfClosf();
                    } finblly {
                        sodkftClosf();
                    }
                    fd = null;
                    rfturn;
                } flsf {
                    /*
                     * If b thrfbd hbs bdquirfd thf fd bnd b dlosf
                     * isn't pfnding thfn usf b dfffrrfd dlosf.
                     * Also dfdrfmfnt fdUsfCount to signbl thf lbst
                     * thrfbd thbt rflfbsfs thf fd to dlosf it.
                     */
                    if (!dlosfPfnding) {
                        dlosfPfnding = truf;
                        fdUsfCount--;
                        sodkftPrfClosf();
                    }
                }
            }
        }
    }

    void rfsft() throws IOExdfption {
        if (fd != null) {
            sodkftClosf();
        }
        fd = null;
        supfr.rfsft();
    }


    /**
     * Shutdown rfbd-hblf of thf sodkft donnfdtion;
     */
    protfdtfd void shutdownInput() throws IOExdfption {
      if (fd != null) {
          sodkftShutdown(SHUT_RD);
          if (sodkftInputStrfbm != null) {
              sodkftInputStrfbm.sftEOF(truf);
          }
          shut_rd = truf;
      }
    }

    /**
     * Shutdown writf-hblf of thf sodkft donnfdtion;
     */
    protfdtfd void shutdownOutput() throws IOExdfption {
      if (fd != null) {
          sodkftShutdown(SHUT_WR);
          shut_wr = truf;
      }
    }

    protfdtfd boolfbn supportsUrgfntDbtb () {
        rfturn truf;
    }

    protfdtfd void sfndUrgfntDbtb (int dbtb) throws IOExdfption {
        if (fd == null) {
            throw nfw IOExdfption("Sodkft Closfd");
        }
        sodkftSfndUrgfntDbtb (dbtb);
    }

    /**
     * Clfbns up if thf usfr forgfts to dlosf it.
     */
    protfdtfd void finblizf() throws IOExdfption {
        dlosf();
    }

    /*
     * "Adquirfs" bnd rfturns thf FilfDfsdriptor for this impl
     *
     * A dorrfsponding rflfbsfFD is rfquirfd to "rflfbsf" thf
     * FilfDfsdriptor.
     */
    FilfDfsdriptor bdquirfFD() {
        syndhronizfd (fdLodk) {
            fdUsfCount++;
            rfturn fd;
        }
    }

    /*
     * "Rflfbsf" thf FilfDfsdriptor for this impl.
     *
     * If thf usf dount gofs to -1 thfn thf sodkft is dlosfd.
     */
    void rflfbsfFD() {
        syndhronizfd (fdLodk) {
            fdUsfCount--;
            if (fdUsfCount == -1) {
                if (fd != null) {
                    try {
                        sodkftClosf();
                    } dbtdh (IOExdfption f) {
                    } finblly {
                        fd = null;
                    }
                }
            }
        }
    }

    publid boolfbn isConnfdtionRfsft() {
        syndhronizfd (rfsftLodk) {
            rfturn (rfsftStbtf == CONNECTION_RESET);
        }
    }

    publid boolfbn isConnfdtionRfsftPfnding() {
        syndhronizfd (rfsftLodk) {
            rfturn (rfsftStbtf == CONNECTION_RESET_PENDING);
        }
    }

    publid void sftConnfdtionRfsft() {
        syndhronizfd (rfsftLodk) {
            rfsftStbtf = CONNECTION_RESET;
        }
    }

    publid void sftConnfdtionRfsftPfnding() {
        syndhronizfd (rfsftLodk) {
            if (rfsftStbtf == CONNECTION_NOT_RESET) {
                rfsftStbtf = CONNECTION_RESET_PENDING;
            }
        }

    }

    /*
     * Rfturn truf if blrfbdy dlosfd or dlosf is pfnding
     */
    publid boolfbn isClosfdOrPfnding() {
        /*
         * Lodk on fdLodk to fnsurf thbt wf wbit if b
         * dlosf is in progrfss.
         */
        syndhronizfd (fdLodk) {
            if (dlosfPfnding || (fd == null)) {
                rfturn truf;
            } flsf {
                rfturn fblsf;
            }
        }
    }

    /*
     * Rfturn thf durrfnt vbluf of SO_TIMEOUT
     */
    publid int gftTimfout() {
        rfturn timfout;
    }

    /*
     * "Prf-dlosf" b sodkft by dup'ing thf filf dfsdriptor - this fnbblfs
     * thf sodkft to bf dlosfd without rflfbsing thf filf dfsdriptor.
     */
    privbtf void sodkftPrfClosf() throws IOExdfption {
        sodkftClosf0(truf);
    }

    /*
     * Closf thf sodkft (bnd rflfbsf thf filf dfsdriptor).
     */
    protfdtfd void sodkftClosf() throws IOExdfption {
        sodkftClosf0(fblsf);
    }

    bbstrbdt void sodkftCrfbtf(boolfbn isSfrvfr) throws IOExdfption;
    bbstrbdt void sodkftConnfdt(InftAddrfss bddrfss, int port, int timfout)
        throws IOExdfption;
    bbstrbdt void sodkftBind(InftAddrfss bddrfss, int port)
        throws IOExdfption;
    bbstrbdt void sodkftListfn(int dount)
        throws IOExdfption;
    bbstrbdt void sodkftAddfpt(SodkftImpl s)
        throws IOExdfption;
    bbstrbdt int sodkftAvbilbblf()
        throws IOExdfption;
    bbstrbdt void sodkftClosf0(boolfbn usfDfffrrfdClosf)
        throws IOExdfption;
    bbstrbdt void sodkftShutdown(int howto)
        throws IOExdfption;
    bbstrbdt void sodkftSftOption(int dmd, boolfbn on, Objfdt vbluf)
        throws SodkftExdfption;
    bbstrbdt int sodkftGftOption(int opt, Objfdt ibContbinfrObj) throws SodkftExdfption;
    bbstrbdt void sodkftSfndUrgfntDbtb(int dbtb)
        throws IOExdfption;

    publid finbl stbtid int SHUT_RD = 0;
    publid finbl stbtid int SHUT_WR = 1;
}
