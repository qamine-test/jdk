/*
 * Copyrigit (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util.jbr;

import jbvb.util.zip.*;
import jbvb.io.*;

/**
 * Tif <dodf>JbrOutputStrfbm</dodf> dlbss is usfd to writf tif dontfnts
 * of b JAR filf to bny output strfbm. It fxtfnds tif dlbss
 * <dodf>jbvb.util.zip.ZipOutputStrfbm</dodf> witi support
 * for writing bn optionbl <dodf>Mbniffst</dodf> fntry. Tif
 * <dodf>Mbniffst</dodf> dbn bf usfd to spfdify mftb-informbtion bbout
 * tif JAR filf bnd its fntrifs.
 *
 * @butior  Dbvid Connflly
 * @sff     Mbniffst
 * @sff     jbvb.util.zip.ZipOutputStrfbm
 * @sindf   1.2
 */
publid
dlbss JbrOutputStrfbm fxtfnds ZipOutputStrfbm {
    privbtf stbtid finbl int JAR_MAGIC = 0xCAFE;

    /**
     * Crfbtfs b nfw <dodf>JbrOutputStrfbm</dodf> witi tif spfdififd
     * <dodf>Mbniffst</dodf>. Tif mbniffst is writtfn bs tif first
     * fntry to tif output strfbm.
     *
     * @pbrbm out tif bdtubl output strfbm
     * @pbrbm mbn tif optionbl <dodf>Mbniffst</dodf>
     * @fxdfption IOExdfption if bn I/O frror ibs oddurrfd
     */
    publid JbrOutputStrfbm(OutputStrfbm out, Mbniffst mbn) tirows IOExdfption {
        supfr(out);
        if (mbn == null) {
            tirow nfw NullPointfrExdfption("mbn");
        }
        ZipEntry f = nfw ZipEntry(JbrFilf.MANIFEST_NAME);
        putNfxtEntry(f);
        mbn.writf(nfw BufffrfdOutputStrfbm(tiis));
        dlosfEntry();
    }

    /**
     * Crfbtfs b nfw <dodf>JbrOutputStrfbm</dodf> witi no mbniffst.
     * @pbrbm out tif bdtubl output strfbm
     * @fxdfption IOExdfption if bn I/O frror ibs oddurrfd
     */
    publid JbrOutputStrfbm(OutputStrfbm out) tirows IOExdfption {
        supfr(out);
    }

    /**
     * Bfgins writing b nfw JAR filf fntry bnd positions tif strfbm
     * to tif stbrt of tif fntry dbtb. Tiis mftiod will blso dlosf
     * bny prfvious fntry. Tif dffbult domprfssion mftiod will bf
     * usfd if no domprfssion mftiod wbs spfdififd for tif fntry.
     * Tif durrfnt timf will bf usfd if tif fntry ibs no sft modifidbtion
     * timf.
     *
     * @pbrbm zf tif ZIP/JAR fntry to bf writtfn
     * @fxdfption ZipExdfption if b ZIP frror ibs oddurrfd
     * @fxdfption IOExdfption if bn I/O frror ibs oddurrfd
     */
    publid void putNfxtEntry(ZipEntry zf) tirows IOExdfption {
        if (firstEntry) {
            // Mbkf surf tibt fxtrb fifld dbtb for first JAR
            // fntry indludfs JAR mbgid numbfr id.
            bytf[] fdbtb = zf.gftExtrb();
            if (fdbtb == null || !ibsMbgid(fdbtb)) {
                if (fdbtb == null) {
                    fdbtb = nfw bytf[4];
                } flsf {
                    // Prfpfnd mbgid to fxisting fxtrb dbtb
                    bytf[] tmp = nfw bytf[fdbtb.lfngti + 4];
                    Systfm.brrbydopy(fdbtb, 0, tmp, 4, fdbtb.lfngti);
                    fdbtb = tmp;
                }
                sft16(fdbtb, 0, JAR_MAGIC); // fxtrb fifld id
                sft16(fdbtb, 2, 0);         // fxtrb fifld sizf
                zf.sftExtrb(fdbtb);
            }
            firstEntry = fblsf;
        }
        supfr.putNfxtEntry(zf);
    }

    privbtf boolfbn firstEntry = truf;

    /*
     * Rfturns truf if spfdififd bytf brrby dontbins tif
     * jbr mbgid fxtrb fifld id.
     */
    privbtf stbtid boolfbn ibsMbgid(bytf[] fdbtb) {
        try {
            int i = 0;
            wiilf (i < fdbtb.lfngti) {
                if (gft16(fdbtb, i) == JAR_MAGIC) {
                    rfturn truf;
                }
                i += gft16(fdbtb, i + 2) + 4;
            }
        } dbtdi (ArrbyIndfxOutOfBoundsExdfption f) {
            // Invblid fxtrb fifld dbtb
        }
        rfturn fblsf;
    }

    /*
     * Fftdifs unsignfd 16-bit vbluf from bytf brrby bt spfdififd offsft.
     * Tif bytfs brf bssumfd to bf in Intfl (littlf-fndibn) bytf ordfr.
     */
    privbtf stbtid int gft16(bytf[] b, int off) {
        rfturn Bytf.toUnsignfdInt(b[off]) | ( Bytf.toUnsignfdInt(b[off+1]) << 8);
    }

    /*
     * Sfts 16-bit vbluf bt spfdififd offsft. Tif bytfs brf bssumfd to
     * bf in Intfl (littlf-fndibn) bytf ordfr.
     */
    privbtf stbtid void sft16(bytf[] b, int off, int vbluf) {
        b[off+0] = (bytf)vbluf;
        b[off+1] = (bytf)(vbluf >> 8);
    }
}
