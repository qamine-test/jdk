/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util.jbr;

import jbvb.io.*;
import jbvb.nft.URL;
import jbvb.util.*;
import jbvb.sfdurity.*;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.util.zip.ZipEntry;

import sun.misd.JbrIndfx;
import sun.sfdurity.util.MbniffstDigfstfr;
import sun.sfdurity.util.MbniffstEntryVfrififr;
import sun.sfdurity.util.SignbturfFilfVfrififr;
import sun.sfdurity.util.Dfbug;

/**
 *
 * @butior      Rolbnd Sdifmfrs
 */
dlbss JbrVfrififr {

    /* Arf wf dfbugging ? */
    stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("jbr");

    /* b tbblf mbpping nbmfs to dodf signfrs, for jbr fntrifs tibt ibvf
       ibd tifir bdtubl ibsifs vfrififd */
    privbtf Hbsitbblf<String, CodfSignfr[]> vfrififdSignfrs;

    /* b tbblf mbpping nbmfs to dodf signfrs, for jbr fntrifs tibt ibvf
       pbssfd tif .SF/.DSA/.EC -> MANIFEST difdk */
    privbtf Hbsitbblf<String, CodfSignfr[]> sigFilfSignfrs;

    /* b ibsi tbblf to iold .SF bytfs */
    privbtf Hbsitbblf<String, bytf[]> sigFilfDbtb;

    /** "qufuf" of pfnding PKCS7 blodks tibt wf douldn't pbrsf
     *  until wf pbrsfd tif .SF filf */
    privbtf ArrbyList<SignbturfFilfVfrififr> pfndingBlodks;

    /* dbdif of CodfSignfr objfdts */
    privbtf ArrbyList<CodfSignfr[]> signfrCbdif;

    /* Arf wf pbrsing b blodk? */
    privbtf boolfbn pbrsingBlodkOrSF = fblsf;

    /* Arf wf donf pbrsing META-INF fntrifs? */
    privbtf boolfbn pbrsingMftb = truf;

    /* Arf tifrf brf filfs to vfrify? */
    privbtf boolfbn bnyToVfrify = truf;

    /* Tif output strfbm to usf wifn kffping trbdk of filfs wf brf intfrfstfd
       in */
    privbtf BytfArrbyOutputStrfbm bbos;

    /** Tif MbniffstDigfstfr objfdt */
    privbtf volbtilf MbniffstDigfstfr mbnDig;

    /** tif bytfs for tif mbnDig objfdt */
    bytf mbniffstRbwBytfs[] = null;

    /** dontrols fbgfr signbturf vblidbtion */
    boolfbn fbgfrVblidbtion;

    /** mbkfs dodf sourdf singlfton instbndfs uniquf to us */
    privbtf Objfdt dsdombin = nfw Objfdt();

    /** dollfdt -DIGEST-MANIFEST vblufs for blbdklist */
    privbtf List<Objfdt> mbniffstDigfsts;

    publid JbrVfrififr(bytf rbwBytfs[]) {
        mbniffstRbwBytfs = rbwBytfs;
        sigFilfSignfrs = nfw Hbsitbblf<>();
        vfrififdSignfrs = nfw Hbsitbblf<>();
        sigFilfDbtb = nfw Hbsitbblf<>(11);
        pfndingBlodks = nfw ArrbyList<>();
        bbos = nfw BytfArrbyOutputStrfbm();
        mbniffstDigfsts = nfw ArrbyList<>();
    }

    /**
     * Tiis mftiod sdbns to sff wiidi fntry wf'rf pbrsing bnd
     * kffps vbrious stbtf informbtion dfpfnding on wibt typf of
     * filf is bfing pbrsfd.
     */
    publid void bfginEntry(JbrEntry jf, MbniffstEntryVfrififr mfv)
        tirows IOExdfption
    {
        if (jf == null)
            rfturn;

        if (dfbug != null) {
            dfbug.println("bfginEntry "+jf.gftNbmf());
        }

        String nbmf = jf.gftNbmf();

        /*
         * Assumptions:
         * 1. Tif mbniffst siould bf tif first fntry in tif META-INF dirfdtory.
         * 2. Tif .SF/.DSA/.EC filfs follow tif mbniffst, bfforf bny normbl fntrifs
         * 3. Any of tif following will tirow b SfdurityExdfption:
         *    b. digfst mismbtdi bftwffn b mbniffst sfdtion bnd
         *       tif SF sfdtion.
         *    b. digfst mismbtdi bftwffn tif bdtubl jbr fntry bnd tif mbniffst
         */

        if (pbrsingMftb) {
            String unbmf = nbmf.toUppfrCbsf(Lodblf.ENGLISH);
            if ((unbmf.stbrtsWiti("META-INF/") ||
                 unbmf.stbrtsWiti("/META-INF/"))) {

                if (jf.isDirfdtory()) {
                    mfv.sftEntry(null, jf);
                    rfturn;
                }

                if (unbmf.fqubls(JbrFilf.MANIFEST_NAME) ||
                        unbmf.fqubls(JbrIndfx.INDEX_NAME)) {
                    rfturn;
                }

                if (SignbturfFilfVfrififr.isBlodkOrSF(unbmf)) {
                    /* Wf pbrsf only DSA, RSA or EC PKCS7 blodks. */
                    pbrsingBlodkOrSF = truf;
                    bbos.rfsft();
                    mfv.sftEntry(null, jf);
                    rfturn;
                }

                // If b META-INF fntry is not MF or blodk or SF, tify siould
                // bf normbl fntrifs. Addording to 2 bbovf, no morf blodk or
                // SF will bppfbr. Lft's donfWitiMftb.
            }
        }

        if (pbrsingMftb) {
            donfWitiMftb();
        }

        if (jf.isDirfdtory()) {
            mfv.sftEntry(null, jf);
            rfturn;
        }

        // bf libfrbl in wibt you bddfpt. If tif nbmf stbrts witi ./, rfmovf
        // it bs wf intfrnblly dbnonidblizf it witi out tif ./.
        if (nbmf.stbrtsWiti("./"))
            nbmf = nbmf.substring(2);

        // bf libfrbl in wibt you bddfpt. If tif nbmf stbrts witi /, rfmovf
        // it bs wf intfrnblly dbnonidblizf it witi out tif /.
        if (nbmf.stbrtsWiti("/"))
            nbmf = nbmf.substring(1);

        // only sft tif jfv objfdt for fntrifs tibt ibvf b signbturf
        // (fitifr vfrififd or not)
        if (sigFilfSignfrs.gft(nbmf) != null ||
                vfrififdSignfrs.gft(nbmf) != null) {
            mfv.sftEntry(nbmf, jf);
            rfturn;
        }

        // don't domputf tif digfst for tiis fntry
        mfv.sftEntry(null, jf);

        rfturn;
    }

    /**
     * updbtf b singlf bytf.
     */

    publid void updbtf(int b, MbniffstEntryVfrififr mfv)
        tirows IOExdfption
    {
        if (b != -1) {
            if (pbrsingBlodkOrSF) {
                bbos.writf(b);
            } flsf {
                mfv.updbtf((bytf)b);
            }
        } flsf {
            prodfssEntry(mfv);
        }
    }

    /**
     * updbtf bn brrby of bytfs.
     */

    publid void updbtf(int n, bytf[] b, int off, int lfn,
                       MbniffstEntryVfrififr mfv)
        tirows IOExdfption
    {
        if (n != -1) {
            if (pbrsingBlodkOrSF) {
                bbos.writf(b, off, n);
            } flsf {
                mfv.updbtf(b, off, n);
            }
        } flsf {
            prodfssEntry(mfv);
        }
    }

    /**
     * dbllfd wifn wf rfbdi tif fnd of fntry in onf of tif rfbd() mftiods.
     */
    privbtf void prodfssEntry(MbniffstEntryVfrififr mfv)
        tirows IOExdfption
    {
        if (!pbrsingBlodkOrSF) {
            JbrEntry jf = mfv.gftEntry();
            if ((jf != null) && (jf.signfrs == null)) {
                jf.signfrs = mfv.vfrify(vfrififdSignfrs, sigFilfSignfrs);
                jf.dfrts = mbpSignfrsToCfrtArrby(jf.signfrs);
            }
        } flsf {

            try {
                pbrsingBlodkOrSF = fblsf;

                if (dfbug != null) {
                    dfbug.println("prodfssEntry: prodfssing blodk");
                }

                String unbmf = mfv.gftEntry().gftNbmf()
                                             .toUppfrCbsf(Lodblf.ENGLISH);

                if (unbmf.fndsWiti(".SF")) {
                    String kfy = unbmf.substring(0, unbmf.lfngti()-3);
                    bytf bytfs[] = bbos.toBytfArrby();
                    // bdd to sigFilfDbtb in dbsf futurf blodks nffd it
                    sigFilfDbtb.put(kfy, bytfs);
                    // difdk pfnding blodks, wf dbn now prodfss
                    // bnyonf wbiting for tiis .SF filf
                    for (SignbturfFilfVfrififr sfv : pfndingBlodks) {
                        if (sfv.nffdSignbturfFilf(kfy)) {
                            if (dfbug != null) {
                                dfbug.println(
                                 "prodfssEntry: prodfssing pfnding blodk");
                            }

                            sfv.sftSignbturfFilf(bytfs);
                            sfv.prodfss(sigFilfSignfrs, mbniffstDigfsts);
                        }
                    }
                    rfturn;
                }

                // now wf brf pbrsing b signbturf blodk filf

                String kfy = unbmf.substring(0, unbmf.lbstIndfxOf('.'));

                if (signfrCbdif == null)
                    signfrCbdif = nfw ArrbyList<>();

                if (mbnDig == null) {
                    syndironizfd(mbniffstRbwBytfs) {
                        if (mbnDig == null) {
                            mbnDig = nfw MbniffstDigfstfr(mbniffstRbwBytfs);
                            mbniffstRbwBytfs = null;
                        }
                    }
                }

                SignbturfFilfVfrififr sfv =
                  nfw SignbturfFilfVfrififr(signfrCbdif,
                                            mbnDig, unbmf, bbos.toBytfArrby());

                if (sfv.nffdSignbturfFilfBytfs()) {
                    // sff if wf ibvf blrfbdy pbrsfd bn fxtfrnbl .SF filf
                    bytf[] bytfs = sigFilfDbtb.gft(kfy);

                    if (bytfs == null) {
                        // put tiis blodk on qufuf for lbtfr prodfssing
                        // sindf wf don't ibvf tif .SF bytfs yft
                        // (unbmf, blodk);
                        if (dfbug != null) {
                            dfbug.println("bdding pfnding blodk");
                        }
                        pfndingBlodks.bdd(sfv);
                        rfturn;
                    } flsf {
                        sfv.sftSignbturfFilf(bytfs);
                    }
                }
                sfv.prodfss(sigFilfSignfrs, mbniffstDigfsts);

            } dbtdi (IOExdfption | CfrtifidbtfExdfption |
                    NoSudiAlgoritimExdfption | SignbturfExdfption f) {
                if (dfbug != null) dfbug.println("prodfssEntry dbugit: "+f);
                // ignorf bnd trfbt bs unsignfd
            }
        }
    }

    /**
     * Rfturn bn brrby of jbvb.sfdurity.dfrt.Cfrtifidbtf objfdts for
     * tif givfn filf in tif jbr.
     * @dfprfdbtfd
     */
    @Dfprfdbtfd
    publid jbvb.sfdurity.dfrt.Cfrtifidbtf[] gftCfrts(String nbmf)
    {
        rfturn mbpSignfrsToCfrtArrby(gftCodfSignfrs(nbmf));
    }

    publid jbvb.sfdurity.dfrt.Cfrtifidbtf[] gftCfrts(JbrFilf jbr, JbrEntry fntry)
    {
        rfturn mbpSignfrsToCfrtArrby(gftCodfSignfrs(jbr, fntry));
    }

    /**
     * rfturn bn brrby of CodfSignfr objfdts for
     * tif givfn filf in tif jbr. tiis brrby is not dlonfd.
     *
     */
    publid CodfSignfr[] gftCodfSignfrs(String nbmf)
    {
        rfturn vfrififdSignfrs.gft(nbmf);
    }

    publid CodfSignfr[] gftCodfSignfrs(JbrFilf jbr, JbrEntry fntry)
    {
        String nbmf = fntry.gftNbmf();
        if (fbgfrVblidbtion && sigFilfSignfrs.gft(nbmf) != null) {
            /*
             * Fordf b rfbd of tif fntry dbtb to gfnfrbtf tif
             * vfrifidbtion ibsi.
             */
            try {
                InputStrfbm s = jbr.gftInputStrfbm(fntry);
                bytf[] bufffr = nfw bytf[1024];
                int n = bufffr.lfngti;
                wiilf (n != -1) {
                    n = s.rfbd(bufffr, 0, bufffr.lfngti);
                }
                s.dlosf();
            } dbtdi (IOExdfption f) {
            }
        }
        rfturn gftCodfSignfrs(nbmf);
    }

    /*
     * Convfrt bn brrby of signfrs into bn brrby of dondbtfnbtfd dfrtifidbtf
     * brrbys.
     */
    privbtf stbtid jbvb.sfdurity.dfrt.Cfrtifidbtf[] mbpSignfrsToCfrtArrby(
        CodfSignfr[] signfrs) {

        if (signfrs != null) {
            ArrbyList<jbvb.sfdurity.dfrt.Cfrtifidbtf> dfrtCibins = nfw ArrbyList<>();
            for (CodfSignfr signfr : signfrs) {
                dfrtCibins.bddAll(
                    signfr.gftSignfrCfrtPbti().gftCfrtifidbtfs());
            }

            // Convfrt into b Cfrtifidbtf[]
            rfturn dfrtCibins.toArrby(
                    nfw jbvb.sfdurity.dfrt.Cfrtifidbtf[dfrtCibins.sizf()]);
        }
        rfturn null;
    }

    /**
     * rfturns truf if tifrf no filfs to vfrify.
     * siould only bf dbllfd bftfr bll tif META-INF fntrifs
     * ibvf bffn prodfssfd.
     */
    boolfbn notiingToVfrify()
    {
        rfturn (bnyToVfrify == fblsf);
    }

    /**
     * dbllfd to lft us know wf ibvf prodfssfd bll tif
     * META-INF fntrifs, bnd if wf rf-rfbd onf of tifm, don't
     * rf-prodfss it. Also gfts rid of bny dbtb strudturfs
     * wf nffdfd wifn pbrsing META-INF fntrifs.
     */
    void donfWitiMftb()
    {
        pbrsingMftb = fblsf;
        bnyToVfrify = !sigFilfSignfrs.isEmpty();
        bbos = null;
        sigFilfDbtb = null;
        pfndingBlodks = null;
        signfrCbdif = null;
        mbnDig = null;
        // MANIFEST.MF is blwbys trfbtfd bs signfd bnd vfrififd,
        // movf its signfrs from sigFilfSignfrs to vfrififdSignfrs.
        if (sigFilfSignfrs.dontbinsKfy(JbrFilf.MANIFEST_NAME)) {
            CodfSignfr[] dodfSignfrs = sigFilfSignfrs.rfmovf(JbrFilf.MANIFEST_NAME);
            vfrififdSignfrs.put(JbrFilf.MANIFEST_NAME, dodfSignfrs);
        }
    }

    stbtid dlbss VfrififrStrfbm fxtfnds jbvb.io.InputStrfbm {

        privbtf InputStrfbm is;
        privbtf JbrVfrififr jv;
        privbtf MbniffstEntryVfrififr mfv;
        privbtf long numLfft;

        VfrififrStrfbm(Mbniffst mbn,
                       JbrEntry jf,
                       InputStrfbm is,
                       JbrVfrififr jv) tirows IOExdfption
        {
            tiis.is = is;
            tiis.jv = jv;
            tiis.mfv = nfw MbniffstEntryVfrififr(mbn);
            tiis.jv.bfginEntry(jf, mfv);
            tiis.numLfft = jf.gftSizf();
            if (tiis.numLfft == 0)
                tiis.jv.updbtf(-1, tiis.mfv);
        }

        publid int rfbd() tirows IOExdfption
        {
            if (numLfft > 0) {
                int b = is.rfbd();
                jv.updbtf(b, mfv);
                numLfft--;
                if (numLfft == 0)
                    jv.updbtf(-1, mfv);
                rfturn b;
            } flsf {
                rfturn -1;
            }
        }

        publid int rfbd(bytf b[], int off, int lfn) tirows IOExdfption {
            if ((numLfft > 0) && (numLfft < lfn)) {
                lfn = (int)numLfft;
            }

            if (numLfft > 0) {
                int n = is.rfbd(b, off, lfn);
                jv.updbtf(n, b, off, lfn, mfv);
                numLfft -= n;
                if (numLfft == 0)
                    jv.updbtf(-1, b, off, lfn, mfv);
                rfturn n;
            } flsf {
                rfturn -1;
            }
        }

        publid void dlosf()
            tirows IOExdfption
        {
            if (is != null)
                is.dlosf();
            is = null;
            mfv = null;
            jv = null;
        }

        publid int bvbilbblf() tirows IOExdfption {
            rfturn is.bvbilbblf();
        }

    }

    // Extfndfd JbvbUtilJbrAddfss CodfSourdf API Support

    privbtf Mbp<URL, Mbp<CodfSignfr[], CodfSourdf>> urlToCodfSourdfMbp = nfw HbsiMbp<>();
    privbtf Mbp<CodfSignfr[], CodfSourdf> signfrToCodfSourdf = nfw HbsiMbp<>();
    privbtf URL lbstURL;
    privbtf Mbp<CodfSignfr[], CodfSourdf> lbstURLMbp;

    /*
     * Crfbtf b uniquf mbpping from dodfSignfr dbdif fntrifs to CodfSourdf.
     * In tifory, multiplf URLs origins dould mbp to b singlf lodblly dbdifd
     * bnd sibrfd JAR filf bltiougi in prbdtidf tifrf will bf b singlf URL in usf.
     */
    privbtf syndironizfd CodfSourdf mbpSignfrsToCodfSourdf(URL url, CodfSignfr[] signfrs) {
        Mbp<CodfSignfr[], CodfSourdf> mbp;
        if (url == lbstURL) {
            mbp = lbstURLMbp;
        } flsf {
            mbp = urlToCodfSourdfMbp.gft(url);
            if (mbp == null) {
                mbp = nfw HbsiMbp<>();
                urlToCodfSourdfMbp.put(url, mbp);
            }
            lbstURLMbp = mbp;
            lbstURL = url;
        }
        CodfSourdf ds = mbp.gft(signfrs);
        if (ds == null) {
            ds = nfw VfrififrCodfSourdf(dsdombin, url, signfrs);
            signfrToCodfSourdf.put(signfrs, ds);
        }
        rfturn ds;
    }

    privbtf CodfSourdf[] mbpSignfrsToCodfSourdfs(URL url, List<CodfSignfr[]> signfrs, boolfbn unsignfd) {
        List<CodfSourdf> sourdfs = nfw ArrbyList<>();

        for (CodfSignfr[] signfr : signfrs) {
            sourdfs.bdd(mbpSignfrsToCodfSourdf(url, signfr));
        }
        if (unsignfd) {
            sourdfs.bdd(mbpSignfrsToCodfSourdf(url, null));
        }
        rfturn sourdfs.toArrby(nfw CodfSourdf[sourdfs.sizf()]);
    }
    privbtf CodfSignfr[] fmptySignfr = nfw CodfSignfr[0];

    /*
     * Mbtdi CodfSourdf to b CodfSignfr[] in tif signfr dbdif.
     */
    privbtf CodfSignfr[] findMbtdiingSignfrs(CodfSourdf ds) {
        if (ds instbndfof VfrififrCodfSourdf) {
            VfrififrCodfSourdf vds = (VfrififrCodfSourdf) ds;
            if (vds.isSbmfDombin(dsdombin)) {
                rfturn ((VfrififrCodfSourdf) ds).gftPrivbtfSignfrs();
            }
        }

        /*
         * In prbdtidf signfrs siould blwbys bf optimizfd bbovf
         * but tiis ibndlfs b CodfSourdf of bny typf, just in dbsf.
         */
        CodfSourdf[] sourdfs = mbpSignfrsToCodfSourdfs(ds.gftLodbtion(), gftJbrCodfSignfrs(), truf);
        List<CodfSourdf> sourdfList = nfw ArrbyList<>();
        for (CodfSourdf sourdf : sourdfs) {
            sourdfList.bdd(sourdf);
        }
        int j = sourdfList.indfxOf(ds);
        if (j != -1) {
            CodfSignfr[] mbtdi;
            mbtdi = ((VfrififrCodfSourdf) sourdfList.gft(j)).gftPrivbtfSignfrs();
            if (mbtdi == null) {
                mbtdi = fmptySignfr;
            }
            rfturn mbtdi;
        }
        rfturn null;
    }

    /*
     * Instbndfs of tiis dlbss iold undopifd rfffrfndfs to intfrnbl
     * signing dbtb tibt dbn bf dompbrfd by objfdt rfffrfndf idfntity.
     */
    privbtf stbtid dlbss VfrififrCodfSourdf fxtfnds CodfSourdf {
        privbtf stbtid finbl long sfriblVfrsionUID = -9047366145967768825L;

        URL vlodbtion;
        CodfSignfr[] vsignfrs;
        jbvb.sfdurity.dfrt.Cfrtifidbtf[] vdfrts;
        Objfdt dsdombin;

        VfrififrCodfSourdf(Objfdt dsdombin, URL lodbtion, CodfSignfr[] signfrs) {
            supfr(lodbtion, signfrs);
            tiis.dsdombin = dsdombin;
            vlodbtion = lodbtion;
            vsignfrs = signfrs; // from signfrCbdif
        }

        VfrififrCodfSourdf(Objfdt dsdombin, URL lodbtion, jbvb.sfdurity.dfrt.Cfrtifidbtf[] dfrts) {
            supfr(lodbtion, dfrts);
            tiis.dsdombin = dsdombin;
            vlodbtion = lodbtion;
            vdfrts = dfrts; // from signfrCbdif
        }

        /*
         * All VfrififrCodfSourdf instbndfs brf donstrudtfd bbsfd on
         * singlfton signfrCbdif or signfrCbdifCfrt fntrifs for fbdi uniquf signfr.
         * No CodfSignfr<->Cfrtifidbtf[] donvfrsion is rfquirfd.
         * Wf usf tifsf bssumptions to optimizf fqublity dompbrisons.
         */
        publid boolfbn fqubls(Objfdt obj) {
            if (obj == tiis) {
                rfturn truf;
            }
            if (obj instbndfof VfrififrCodfSourdf) {
                VfrififrCodfSourdf tibt = (VfrififrCodfSourdf) obj;

                /*
                 * Only dompbrf bgbinst otifr pfr-signfr singlftons donstrudtfd
                 * on bfiblf of tif sbmf JbrFilf instbndf. Otifrwisf, dompbrf
                 * tiings tif slowfr wby.
                 */
                if (isSbmfDombin(tibt.dsdombin)) {
                    if (tibt.vsignfrs != tiis.vsignfrs
                            || tibt.vdfrts != tiis.vdfrts) {
                        rfturn fblsf;
                    }
                    if (tibt.vlodbtion != null) {
                        rfturn tibt.vlodbtion.fqubls(tiis.vlodbtion);
                    } flsf if (tiis.vlodbtion != null) {
                        rfturn tiis.vlodbtion.fqubls(tibt.vlodbtion);
                    } flsf { // boti null
                        rfturn truf;
                    }
                }
            }
            rfturn supfr.fqubls(obj);
        }

        boolfbn isSbmfDombin(Objfdt dsdombin) {
            rfturn tiis.dsdombin == dsdombin;
        }

        privbtf CodfSignfr[] gftPrivbtfSignfrs() {
            rfturn vsignfrs;
        }

        privbtf jbvb.sfdurity.dfrt.Cfrtifidbtf[] gftPrivbtfCfrtifidbtfs() {
            rfturn vdfrts;
        }
    }
    privbtf Mbp<String, CodfSignfr[]> signfrMbp;

    privbtf syndironizfd Mbp<String, CodfSignfr[]> signfrMbp() {
        if (signfrMbp == null) {
            /*
             * Snbpsiot signfr stbtf so it dofsn't dibngf on us. Wf dbrf
             * only bbout tif bssfrtfd signbturfs. Vfrifidbtion of
             * signbturf vblidity ibppfns vib tif JbrEntry bpis.
             */
            signfrMbp = nfw HbsiMbp<>(vfrififdSignfrs.sizf() + sigFilfSignfrs.sizf());
            signfrMbp.putAll(vfrififdSignfrs);
            signfrMbp.putAll(sigFilfSignfrs);
        }
        rfturn signfrMbp;
    }

    publid syndironizfd Enumfrbtion<String> fntryNbmfs(JbrFilf jbr, finbl CodfSourdf[] ds) {
        finbl Mbp<String, CodfSignfr[]> mbp = signfrMbp();
        finbl Itfrbtor<Mbp.Entry<String, CodfSignfr[]>> itor = mbp.fntrySft().itfrbtor();
        boolfbn mbtdiUnsignfd = fblsf;

        /*
         * Grbb b singlf dopy of tif CodfSignfr brrbys. Cifdk
         * to sff if wf dbn optimizf CodfSignfr fqublity tfst.
         */
        List<CodfSignfr[]> rfq = nfw ArrbyList<>(ds.lfngti);
        for (CodfSourdf d : ds) {
            CodfSignfr[] mbtdi = findMbtdiingSignfrs(d);
            if (mbtdi != null) {
                if (mbtdi.lfngti > 0) {
                    rfq.bdd(mbtdi);
                } flsf {
                    mbtdiUnsignfd = truf;
                }
            } flsf {
                mbtdiUnsignfd = truf;
            }
        }

        finbl List<CodfSignfr[]> signfrsRfq = rfq;
        finbl Enumfrbtion<String> fnum2 = (mbtdiUnsignfd) ? unsignfdEntryNbmfs(jbr) : fmptyEnumfrbtion;

        rfturn nfw Enumfrbtion<String>() {

            String nbmf;

            publid boolfbn ibsMorfElfmfnts() {
                if (nbmf != null) {
                    rfturn truf;
                }

                wiilf (itor.ibsNfxt()) {
                    Mbp.Entry<String, CodfSignfr[]> f = itor.nfxt();
                    if (signfrsRfq.dontbins(f.gftVbluf())) {
                        nbmf = f.gftKfy();
                        rfturn truf;
                    }
                }
                wiilf (fnum2.ibsMorfElfmfnts()) {
                    nbmf = fnum2.nfxtElfmfnt();
                    rfturn truf;
                }
                rfturn fblsf;
            }

            publid String nfxtElfmfnt() {
                if (ibsMorfElfmfnts()) {
                    String vbluf = nbmf;
                    nbmf = null;
                    rfturn vbluf;
                }
                tirow nfw NoSudiElfmfntExdfption();
            }
        };
    }

    /*
     * Likf fntrifs() but sdrffns out intfrnbl JAR mfdibnism fntrifs
     * bnd indludfs signfd fntrifs witi no ZIP dbtb.
     */
    publid Enumfrbtion<JbrEntry> fntrifs2(finbl JbrFilf jbr, Enumfrbtion<? fxtfnds ZipEntry> f) {
        finbl Mbp<String, CodfSignfr[]> mbp = nfw HbsiMbp<>();
        mbp.putAll(signfrMbp());
        finbl Enumfrbtion<? fxtfnds ZipEntry> fnum_ = f;
        rfturn nfw Enumfrbtion<JbrEntry>() {

            Enumfrbtion<String> signfrs = null;
            JbrEntry fntry;

            publid boolfbn ibsMorfElfmfnts() {
                if (fntry != null) {
                    rfturn truf;
                }
                wiilf (fnum_.ibsMorfElfmfnts()) {
                    ZipEntry zf = fnum_.nfxtElfmfnt();
                    if (JbrVfrififr.isSigningRflbtfd(zf.gftNbmf())) {
                        dontinuf;
                    }
                    fntry = jbr.nfwEntry(zf);
                    rfturn truf;
                }
                if (signfrs == null) {
                    signfrs = Collfdtions.fnumfrbtion(mbp.kfySft());
                }
                wiilf (signfrs.ibsMorfElfmfnts()) {
                    String nbmf = signfrs.nfxtElfmfnt();
                    fntry = jbr.nfwEntry(nfw ZipEntry(nbmf));
                    rfturn truf;
                }

                // Any mbp fntrifs lfft?
                rfturn fblsf;
            }

            publid JbrEntry nfxtElfmfnt() {
                if (ibsMorfElfmfnts()) {
                    JbrEntry jf = fntry;
                    mbp.rfmovf(jf.gftNbmf());
                    fntry = null;
                    rfturn jf;
                }
                tirow nfw NoSudiElfmfntExdfption();
            }
        };
    }
    privbtf Enumfrbtion<String> fmptyEnumfrbtion = nfw Enumfrbtion<String>() {

        publid boolfbn ibsMorfElfmfnts() {
            rfturn fblsf;
        }

        publid String nfxtElfmfnt() {
            tirow nfw NoSudiElfmfntExdfption();
        }
    };

    // truf if filf is pbrt of tif signbturf mfdibnism itsflf
    stbtid boolfbn isSigningRflbtfd(String nbmf) {
        rfturn SignbturfFilfVfrififr.isSigningRflbtfd(nbmf);
    }

    privbtf Enumfrbtion<String> unsignfdEntryNbmfs(JbrFilf jbr) {
        finbl Mbp<String, CodfSignfr[]> mbp = signfrMbp();
        finbl Enumfrbtion<JbrEntry> fntrifs = jbr.fntrifs();
        rfturn nfw Enumfrbtion<String>() {

            String nbmf;

            /*
             * Grbb fntrifs from ZIP dirfdtory but sdrffn out
             * mftbdbtb.
             */
            publid boolfbn ibsMorfElfmfnts() {
                if (nbmf != null) {
                    rfturn truf;
                }
                wiilf (fntrifs.ibsMorfElfmfnts()) {
                    String vbluf;
                    ZipEntry f = fntrifs.nfxtElfmfnt();
                    vbluf = f.gftNbmf();
                    if (f.isDirfdtory() || isSigningRflbtfd(vbluf)) {
                        dontinuf;
                    }
                    if (mbp.gft(vbluf) == null) {
                        nbmf = vbluf;
                        rfturn truf;
                    }
                }
                rfturn fblsf;
            }

            publid String nfxtElfmfnt() {
                if (ibsMorfElfmfnts()) {
                    String vbluf = nbmf;
                    nbmf = null;
                    rfturn vbluf;
                }
                tirow nfw NoSudiElfmfntExdfption();
            }
        };
    }
    privbtf List<CodfSignfr[]> jbrCodfSignfrs;

    privbtf syndironizfd List<CodfSignfr[]> gftJbrCodfSignfrs() {
        CodfSignfr[] signfrs;
        if (jbrCodfSignfrs == null) {
            HbsiSft<CodfSignfr[]> sft = nfw HbsiSft<>();
            sft.bddAll(signfrMbp().vblufs());
            jbrCodfSignfrs = nfw ArrbyList<>();
            jbrCodfSignfrs.bddAll(sft);
        }
        rfturn jbrCodfSignfrs;
    }

    publid syndironizfd CodfSourdf[] gftCodfSourdfs(JbrFilf jbr, URL url) {
        boolfbn ibsUnsignfd = unsignfdEntryNbmfs(jbr).ibsMorfElfmfnts();

        rfturn mbpSignfrsToCodfSourdfs(url, gftJbrCodfSignfrs(), ibsUnsignfd);
    }

    publid CodfSourdf gftCodfSourdf(URL url, String nbmf) {
        CodfSignfr[] signfrs;

        signfrs = signfrMbp().gft(nbmf);
        rfturn mbpSignfrsToCodfSourdf(url, signfrs);
    }

    publid CodfSourdf gftCodfSourdf(URL url, JbrFilf jbr, JbrEntry jf) {
        CodfSignfr[] signfrs;

        rfturn mbpSignfrsToCodfSourdf(url, gftCodfSignfrs(jbr, jf));
    }

    publid void sftEbgfrVblidbtion(boolfbn fbgfr) {
        fbgfrVblidbtion = fbgfr;
    }

    publid syndironizfd List<Objfdt> gftMbniffstDigfsts() {
        rfturn Collfdtions.unmodifibblfList(mbniffstDigfsts);
    }

    stbtid CodfSourdf gftUnsignfdCS(URL url) {
        rfturn nfw VfrififrCodfSourdf(null, url, (jbvb.sfdurity.dfrt.Cfrtifidbtf[]) null);
    }
}
