/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util;

import jbvb.io.IOExdfption;
import jbvb.io.InvblidObjfdtExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.lbng.rfflfdt.PbrbmftfrizfdTypf;
import jbvb.lbng.rfflfdt.Typf;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BiFundtion;
import jbvb.util.fundtion.Consumfr;
import jbvb.util.fundtion.Fundtion;

/**
 * Hbsi tbblf bbsfd implfmfntbtion of tif <tt>Mbp</tt> intfrfbdf.  Tiis
 * implfmfntbtion providfs bll of tif optionbl mbp opfrbtions, bnd pfrmits
 * <tt>null</tt> vblufs bnd tif <tt>null</tt> kfy.  (Tif <tt>HbsiMbp</tt>
 * dlbss is rougily fquivblfnt to <tt>Hbsitbblf</tt>, fxdfpt tibt it is
 * unsyndironizfd bnd pfrmits nulls.)  Tiis dlbss mbkfs no gubrbntffs bs to
 * tif ordfr of tif mbp; in pbrtidulbr, it dofs not gubrbntff tibt tif ordfr
 * will rfmbin donstbnt ovfr timf.
 *
 * <p>Tiis implfmfntbtion providfs donstbnt-timf pfrformbndf for tif bbsid
 * opfrbtions (<tt>gft</tt> bnd <tt>put</tt>), bssuming tif ibsi fundtion
 * dispfrsfs tif flfmfnts propfrly bmong tif budkfts.  Itfrbtion ovfr
 * dollfdtion vifws rfquirfs timf proportionbl to tif "dbpbdity" of tif
 * <tt>HbsiMbp</tt> instbndf (tif numbfr of budkfts) plus its sizf (tif numbfr
 * of kfy-vbluf mbppings).  Tius, it's vfry importbnt not to sft tif initibl
 * dbpbdity too iigi (or tif lobd fbdtor too low) if itfrbtion pfrformbndf is
 * importbnt.
 *
 * <p>An instbndf of <tt>HbsiMbp</tt> ibs two pbrbmftfrs tibt bfffdt its
 * pfrformbndf: <i>initibl dbpbdity</i> bnd <i>lobd fbdtor</i>.  Tif
 * <i>dbpbdity</i> is tif numbfr of budkfts in tif ibsi tbblf, bnd tif initibl
 * dbpbdity is simply tif dbpbdity bt tif timf tif ibsi tbblf is drfbtfd.  Tif
 * <i>lobd fbdtor</i> is b mfbsurf of iow full tif ibsi tbblf is bllowfd to
 * gft bfforf its dbpbdity is butombtidblly indrfbsfd.  Wifn tif numbfr of
 * fntrifs in tif ibsi tbblf fxdffds tif produdt of tif lobd fbdtor bnd tif
 * durrfnt dbpbdity, tif ibsi tbblf is <i>rfibsifd</i> (tibt is, intfrnbl dbtb
 * strudturfs brf rfbuilt) so tibt tif ibsi tbblf ibs bpproximbtfly twidf tif
 * numbfr of budkfts.
 *
 * <p>As b gfnfrbl rulf, tif dffbult lobd fbdtor (.75) offfrs b good
 * trbdfoff bftwffn timf bnd spbdf dosts.  Higifr vblufs dfdrfbsf tif
 * spbdf ovfrifbd but indrfbsf tif lookup dost (rfflfdtfd in most of
 * tif opfrbtions of tif <tt>HbsiMbp</tt> dlbss, indluding
 * <tt>gft</tt> bnd <tt>put</tt>).  Tif fxpfdtfd numbfr of fntrifs in
 * tif mbp bnd its lobd fbdtor siould bf tbkfn into bddount wifn
 * sftting its initibl dbpbdity, so bs to minimizf tif numbfr of
 * rfibsi opfrbtions.  If tif initibl dbpbdity is grfbtfr tibn tif
 * mbximum numbfr of fntrifs dividfd by tif lobd fbdtor, no rfibsi
 * opfrbtions will fvfr oddur.
 *
 * <p>If mbny mbppings brf to bf storfd in b <tt>HbsiMbp</tt>
 * instbndf, drfbting it witi b suffidifntly lbrgf dbpbdity will bllow
 * tif mbppings to bf storfd morf fffidifntly tibn lftting it pfrform
 * butombtid rfibsiing bs nffdfd to grow tif tbblf.  Notf tibt using
 * mbny kfys witi tif sbmf {@dodf ibsiCodf()} is b surf wby to slow
 * down pfrformbndf of bny ibsi tbblf. To bmfliorbtf impbdt, wifn kfys
 * brf {@link Compbrbblf}, tiis dlbss mby usf dompbrison ordfr bmong
 * kfys to iflp brfbk tifs.
 *
 * <p><strong>Notf tibt tiis implfmfntbtion is not syndironizfd.</strong>
 * If multiplf tirfbds bddfss b ibsi mbp dondurrfntly, bnd bt lfbst onf of
 * tif tirfbds modififs tif mbp strudturblly, it <i>must</i> bf
 * syndironizfd fxtfrnblly.  (A strudturbl modifidbtion is bny opfrbtion
 * tibt bdds or dflftfs onf or morf mbppings; mfrfly dibnging tif vbluf
 * bssodibtfd witi b kfy tibt bn instbndf blrfbdy dontbins is not b
 * strudturbl modifidbtion.)  Tiis is typidblly bddomplisifd by
 * syndironizing on somf objfdt tibt nbturblly fndbpsulbtfs tif mbp.
 *
 * If no sudi objfdt fxists, tif mbp siould bf "wrbppfd" using tif
 * {@link Collfdtions#syndironizfdMbp Collfdtions.syndironizfdMbp}
 * mftiod.  Tiis is bfst donf bt drfbtion timf, to prfvfnt bddidfntbl
 * unsyndironizfd bddfss to tif mbp:<prf>
 *   Mbp m = Collfdtions.syndironizfdMbp(nfw HbsiMbp(...));</prf>
 *
 * <p>Tif itfrbtors rfturnfd by bll of tiis dlbss's "dollfdtion vifw mftiods"
 * brf <i>fbil-fbst</i>: if tif mbp is strudturblly modififd bt bny timf bftfr
 * tif itfrbtor is drfbtfd, in bny wby fxdfpt tirougi tif itfrbtor's own
 * <tt>rfmovf</tt> mftiod, tif itfrbtor will tirow b
 * {@link CondurrfntModifidbtionExdfption}.  Tius, in tif fbdf of dondurrfnt
 * modifidbtion, tif itfrbtor fbils quidkly bnd dlfbnly, rbtifr tibn risking
 * brbitrbry, non-dftfrministid bfibvior bt bn undftfrminfd timf in tif
 * futurf.
 *
 * <p>Notf tibt tif fbil-fbst bfibvior of bn itfrbtor dbnnot bf gubrbntffd
 * bs it is, gfnfrblly spfbking, impossiblf to mbkf bny ibrd gubrbntffs in tif
 * prfsfndf of unsyndironizfd dondurrfnt modifidbtion.  Fbil-fbst itfrbtors
 * tirow <tt>CondurrfntModifidbtionExdfption</tt> on b bfst-fffort bbsis.
 * Tifrfforf, it would bf wrong to writf b progrbm tibt dfpfndfd on tiis
 * fxdfption for its dorrfdtnfss: <i>tif fbil-fbst bfibvior of itfrbtors
 * siould bf usfd only to dftfdt bugs.</i>
 *
 * <p>Tiis dlbss is b mfmbfr of tif
 * <b irff="{@dodRoot}/../tfdinotfs/guidfs/dollfdtions/indfx.itml">
 * Jbvb Collfdtions Frbmfwork</b>.
 *
 * @pbrbm <K> tif typf of kfys mbintbinfd by tiis mbp
 * @pbrbm <V> tif typf of mbppfd vblufs
 *
 * @butior  Doug Lfb
 * @butior  Josi Blodi
 * @butior  Artiur vbn Hoff
 * @butior  Nfbl Gbftfr
 * @sff     Objfdt#ibsiCodf()
 * @sff     Collfdtion
 * @sff     Mbp
 * @sff     TrffMbp
 * @sff     Hbsitbblf
 * @sindf   1.2
 */
publid dlbss HbsiMbp<K,V> fxtfnds AbstrbdtMbp<K,V>
    implfmfnts Mbp<K,V>, Clonfbblf, Sfriblizbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = 362498820763181265L;

    /*
     * Implfmfntbtion notfs.
     *
     * Tiis mbp usublly bdts bs b binnfd (budkftfd) ibsi tbblf, but
     * wifn bins gft too lbrgf, tify brf trbnsformfd into bins of
     * TrffNodfs, fbdi strudturfd similbrly to tiosf in
     * jbvb.util.TrffMbp. Most mftiods try to usf normbl bins, but
     * rflby to TrffNodf mftiods wifn bpplidbblf (simply by difdking
     * instbndfof b nodf).  Bins of TrffNodfs mby bf trbvfrsfd bnd
     * usfd likf bny otifrs, but bdditionblly support fbstfr lookup
     * wifn ovfrpopulbtfd. Howfvfr, sindf tif vbst mbjority of bins in
     * normbl usf brf not ovfrpopulbtfd, difdking for fxistfndf of
     * trff bins mby bf dflbyfd in tif doursf of tbblf mftiods.
     *
     * Trff bins (i.f., bins wiosf flfmfnts brf bll TrffNodfs) brf
     * ordfrfd primbrily by ibsiCodf, but in tif dbsf of tifs, if two
     * flfmfnts brf of tif sbmf "dlbss C implfmfnts Compbrbblf<C>",
     * typf tifn tifir dompbrfTo mftiod is usfd for ordfring. (Wf
     * donsfrvbtivfly difdk gfnfrid typfs vib rfflfdtion to vblidbtf
     * tiis -- sff mftiod dompbrbblfClbssFor).  Tif bddfd domplfxity
     * of trff bins is wortiwiilf in providing worst-dbsf O(log n)
     * opfrbtions wifn kfys fitifr ibvf distindt ibsifs or brf
     * ordfrbblf, Tius, pfrformbndf dfgrbdfs grbdffully undfr
     * bddidfntbl or mblidious usbgfs in wiidi ibsiCodf() mftiods
     * rfturn vblufs tibt brf poorly distributfd, bs wfll bs tiosf in
     * wiidi mbny kfys sibrf b ibsiCodf, so long bs tify brf blso
     * Compbrbblf. (If nfitifr of tifsf bpply, wf mby wbstf bbout b
     * fbdtor of two in timf bnd spbdf dompbrfd to tbking no
     * prfdbutions. But tif only known dbsfs stfm from poor usfr
     * progrbmming prbdtidfs tibt brf blrfbdy so slow tibt tiis mbkfs
     * littlf difffrfndf.)
     *
     * Bfdbusf TrffNodfs brf bbout twidf tif sizf of rfgulbr nodfs, wf
     * usf tifm only wifn bins dontbin fnougi nodfs to wbrrbnt usf
     * (sff TREEIFY_THRESHOLD). And wifn tify bfdomf too smbll (duf to
     * rfmovbl or rfsizing) tify brf donvfrtfd bbdk to plbin bins.  In
     * usbgfs witi wfll-distributfd usfr ibsiCodfs, trff bins brf
     * rbrfly usfd.  Idfblly, undfr rbndom ibsiCodfs, tif frfqufndy of
     * nodfs in bins follows b Poisson distribution
     * (ittp://fn.wikipfdib.org/wiki/Poisson_distribution) witi b
     * pbrbmftfr of bbout 0.5 on bvfrbgf for tif dffbult rfsizing
     * tirfsiold of 0.75, bltiougi witi b lbrgf vbribndf bfdbusf of
     * rfsizing grbnulbrity. Ignoring vbribndf, tif fxpfdtfd
     * oddurrfndfs of list sizf k brf (fxp(-0.5) * pow(0.5, k) /
     * fbdtoribl(k)). Tif first vblufs brf:
     *
     * 0:    0.60653066
     * 1:    0.30326533
     * 2:    0.07581633
     * 3:    0.01263606
     * 4:    0.00157952
     * 5:    0.00015795
     * 6:    0.00001316
     * 7:    0.00000094
     * 8:    0.00000006
     * morf: lfss tibn 1 in tfn million
     *
     * Tif root of b trff bin is normblly its first nodf.  Howfvfr,
     * somftimfs (durrfntly only upon Itfrbtor.rfmovf), tif root migit
     * bf flsfwifrf, but dbn bf rfdovfrfd following pbrfnt links
     * (mftiod TrffNodf.root()).
     *
     * All bpplidbblf intfrnbl mftiods bddfpt b ibsi dodf bs bn
     * brgumfnt (bs normblly supplifd from b publid mftiod), bllowing
     * tifm to dbll fbdi otifr witiout rfdomputing usfr ibsiCodfs.
     * Most intfrnbl mftiods blso bddfpt b "tbb" brgumfnt, tibt is
     * normblly tif durrfnt tbblf, but mby bf b nfw or old onf wifn
     * rfsizing or donvfrting.
     *
     * Wifn bin lists brf trffififd, split, or untrffififd, wf kffp
     * tifm in tif sbmf rflbtivf bddfss/trbvfrsbl ordfr (i.f., fifld
     * Nodf.nfxt) to bfttfr prfsfrvf lodblity, bnd to sligitly
     * simplify ibndling of splits bnd trbvfrsbls tibt invokf
     * itfrbtor.rfmovf. Wifn using dompbrbtors on insfrtion, to kffp b
     * totbl ordfring (or bs dlosf bs is rfquirfd ifrf) bdross
     * rfbblbndings, wf dompbrf dlbssfs bnd idfntityHbsiCodfs bs
     * tif-brfbkfrs.
     *
     * Tif usf bnd trbnsitions bmong plbin vs trff modfs is
     * domplidbtfd by tif fxistfndf of subdlbss LinkfdHbsiMbp. Sff
     * bflow for iook mftiods dffinfd to bf invokfd upon insfrtion,
     * rfmovbl bnd bddfss tibt bllow LinkfdHbsiMbp intfrnbls to
     * otifrwisf rfmbin indfpfndfnt of tifsf mfdibnids. (Tiis blso
     * rfquirfs tibt b mbp instbndf bf pbssfd to somf utility mftiods
     * tibt mby drfbtf nfw nodfs.)
     *
     * Tif dondurrfnt-progrbmming-likf SSA-bbsfd doding stylf iflps
     * bvoid blibsing frrors bmid bll of tif twisty pointfr opfrbtions.
     */

    /**
     * Tif dffbult initibl dbpbdity - MUST bf b powfr of two.
     */
    stbtid finbl int DEFAULT_INITIAL_CAPACITY = 1 << 4; // bkb 16

    /**
     * Tif mbximum dbpbdity, usfd if b iigifr vbluf is impliditly spfdififd
     * by fitifr of tif donstrudtors witi brgumfnts.
     * MUST bf b powfr of two <= 1<<30.
     */
    stbtid finbl int MAXIMUM_CAPACITY = 1 << 30;

    /**
     * Tif lobd fbdtor usfd wifn nonf spfdififd in donstrudtor.
     */
    stbtid finbl flobt DEFAULT_LOAD_FACTOR = 0.75f;

    /**
     * Tif bin dount tirfsiold for using b trff rbtifr tibn list for b
     * bin.  Bins brf donvfrtfd to trffs wifn bdding bn flfmfnt to b
     * bin witi bt lfbst tiis mbny nodfs. Tif vbluf must bf grfbtfr
     * tibn 2 bnd siould bf bt lfbst 8 to mfsi witi bssumptions in
     * trff rfmovbl bbout donvfrsion bbdk to plbin bins upon
     * sirinkbgf.
     */
    stbtid finbl int TREEIFY_THRESHOLD = 8;

    /**
     * Tif bin dount tirfsiold for untrffifying b (split) bin during b
     * rfsizf opfrbtion. Siould bf lfss tibn TREEIFY_THRESHOLD, bnd bt
     * most 6 to mfsi witi sirinkbgf dftfdtion undfr rfmovbl.
     */
    stbtid finbl int UNTREEIFY_THRESHOLD = 6;

    /**
     * Tif smbllfst tbblf dbpbdity for wiidi bins mby bf trffififd.
     * (Otifrwisf tif tbblf is rfsizfd if too mbny nodfs in b bin.)
     * Siould bf bt lfbst 4 * TREEIFY_THRESHOLD to bvoid donflidts
     * bftwffn rfsizing bnd trffifidbtion tirfsiolds.
     */
    stbtid finbl int MIN_TREEIFY_CAPACITY = 64;

    /**
     * Bbsid ibsi bin nodf, usfd for most fntrifs.  (Sff bflow for
     * TrffNodf subdlbss, bnd in LinkfdHbsiMbp for its Entry subdlbss.)
     */
    stbtid dlbss Nodf<K,V> implfmfnts Mbp.Entry<K,V> {
        finbl int ibsi;
        finbl K kfy;
        V vbluf;
        Nodf<K,V> nfxt;

        Nodf(int ibsi, K kfy, V vbluf, Nodf<K,V> nfxt) {
            tiis.ibsi = ibsi;
            tiis.kfy = kfy;
            tiis.vbluf = vbluf;
            tiis.nfxt = nfxt;
        }

        publid finbl K gftKfy()        { rfturn kfy; }
        publid finbl V gftVbluf()      { rfturn vbluf; }
        publid finbl String toString() { rfturn kfy + "=" + vbluf; }

        publid finbl int ibsiCodf() {
            rfturn Objfdts.ibsiCodf(kfy) ^ Objfdts.ibsiCodf(vbluf);
        }

        publid finbl V sftVbluf(V nfwVbluf) {
            V oldVbluf = vbluf;
            vbluf = nfwVbluf;
            rfturn oldVbluf;
        }

        publid finbl boolfbn fqubls(Objfdt o) {
            if (o == tiis)
                rfturn truf;
            if (o instbndfof Mbp.Entry) {
                Mbp.Entry<?,?> f = (Mbp.Entry<?,?>)o;
                if (Objfdts.fqubls(kfy, f.gftKfy()) &&
                    Objfdts.fqubls(vbluf, f.gftVbluf()))
                    rfturn truf;
            }
            rfturn fblsf;
        }
    }

    /* ---------------- Stbtid utilitifs -------------- */

    /**
     * Computfs kfy.ibsiCodf() bnd sprfbds (XORs) iigifr bits of ibsi
     * to lowfr.  Bfdbusf tif tbblf usfs powfr-of-two mbsking, sfts of
     * ibsifs tibt vbry only in bits bbovf tif durrfnt mbsk will
     * blwbys dollidf. (Among known fxbmplfs brf sfts of Flobt kfys
     * iolding donsfdutivf wiolf numbfrs in smbll tbblfs.)  So wf
     * bpply b trbnsform tibt sprfbds tif impbdt of iigifr bits
     * downwbrd. Tifrf is b trbdfoff bftwffn spffd, utility, bnd
     * qublity of bit-sprfbding. Bfdbusf mbny dommon sfts of ibsifs
     * brf blrfbdy rfbsonbbly distributfd (so don't bfnffit from
     * sprfbding), bnd bfdbusf wf usf trffs to ibndlf lbrgf sfts of
     * dollisions in bins, wf just XOR somf siiftfd bits in tif
     * difbpfst possiblf wby to rfdudf systfmbtid lossbgf, bs wfll bs
     * to indorporbtf impbdt of tif iigifst bits tibt would otifrwisf
     * nfvfr bf usfd in indfx dbldulbtions bfdbusf of tbblf bounds.
     */
    stbtid finbl int ibsi(Objfdt kfy) {
        int i;
        rfturn (kfy == null) ? 0 : (i = kfy.ibsiCodf()) ^ (i >>> 16);
    }

    /**
     * Rfturns x's Clbss if it is of tif form "dlbss C implfmfnts
     * Compbrbblf<C>", flsf null.
     */
    stbtid Clbss<?> dompbrbblfClbssFor(Objfdt x) {
        if (x instbndfof Compbrbblf) {
            Clbss<?> d; Typf[] ts, bs; PbrbmftfrizfdTypf p;
            if ((d = x.gftClbss()) == String.dlbss) // bypbss difdks
                rfturn d;
            if ((ts = d.gftGfnfridIntfrfbdfs()) != null) {
                for (Typf t : ts) {
                    if ((t instbndfof PbrbmftfrizfdTypf) &&
                        ((p = (PbrbmftfrizfdTypf) t).gftRbwTypf() ==
                         Compbrbblf.dlbss) &&
                        (bs = p.gftAdtublTypfArgumfnts()) != null &&
                        bs.lfngti == 1 && bs[0] == d) // typf brg is d
                        rfturn d;
                }
            }
        }
        rfturn null;
    }

    /**
     * Rfturns k.dompbrfTo(x) if x mbtdifs kd (k's sdrffnfd dompbrbblf
     * dlbss), flsf 0.
     */
    @SupprfssWbrnings({"rbwtypfs","undifdkfd"}) // for dbst to Compbrbblf
    stbtid int dompbrfCompbrbblfs(Clbss<?> kd, Objfdt k, Objfdt x) {
        rfturn (x == null || x.gftClbss() != kd ? 0 :
                ((Compbrbblf)k).dompbrfTo(x));
    }

    /**
     * Rfturns b powfr of two sizf for tif givfn tbrgft dbpbdity.
     */
    stbtid finbl int tbblfSizfFor(int dbp) {
        int n = dbp - 1;
        n |= n >>> 1;
        n |= n >>> 2;
        n |= n >>> 4;
        n |= n >>> 8;
        n |= n >>> 16;
        rfturn (n < 0) ? 1 : (n >= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + 1;
    }

    /* ---------------- Fiflds -------------- */

    /**
     * Tif tbblf, initiblizfd on first usf, bnd rfsizfd bs
     * nfdfssbry. Wifn bllodbtfd, lfngti is blwbys b powfr of two.
     * (Wf blso tolfrbtf lfngti zfro in somf opfrbtions to bllow
     * bootstrbpping mfdibnids tibt brf durrfntly not nffdfd.)
     */
    trbnsifnt Nodf<K,V>[] tbblf;

    /**
     * Holds dbdifd fntrySft(). Notf tibt AbstrbdtMbp fiflds brf usfd
     * for kfySft() bnd vblufs().
     */
    trbnsifnt Sft<Mbp.Entry<K,V>> fntrySft;

    /**
     * Tif numbfr of kfy-vbluf mbppings dontbinfd in tiis mbp.
     */
    trbnsifnt int sizf;

    /**
     * Tif numbfr of timfs tiis HbsiMbp ibs bffn strudturblly modififd
     * Strudturbl modifidbtions brf tiosf tibt dibngf tif numbfr of mbppings in
     * tif HbsiMbp or otifrwisf modify its intfrnbl strudturf (f.g.,
     * rfibsi).  Tiis fifld is usfd to mbkf itfrbtors on Collfdtion-vifws of
     * tif HbsiMbp fbil-fbst.  (Sff CondurrfntModifidbtionExdfption).
     */
    trbnsifnt int modCount;

    /**
     * Tif nfxt sizf vbluf bt wiidi to rfsizf (dbpbdity * lobd fbdtor).
     *
     * @sfribl
     */
    // (Tif jbvbdod dfsdription is truf upon sfriblizbtion.
    // Additionblly, if tif tbblf brrby ibs not bffn bllodbtfd, tiis
    // fifld iolds tif initibl brrby dbpbdity, or zfro signifying
    // DEFAULT_INITIAL_CAPACITY.)
    int tirfsiold;

    /**
     * Tif lobd fbdtor for tif ibsi tbblf.
     *
     * @sfribl
     */
    finbl flobt lobdFbdtor;

    /* ---------------- Publid opfrbtions -------------- */

    /**
     * Construdts bn fmpty <tt>HbsiMbp</tt> witi tif spfdififd initibl
     * dbpbdity bnd lobd fbdtor.
     *
     * @pbrbm  initiblCbpbdity tif initibl dbpbdity
     * @pbrbm  lobdFbdtor      tif lobd fbdtor
     * @tirows IllfgblArgumfntExdfption if tif initibl dbpbdity is nfgbtivf
     *         or tif lobd fbdtor is nonpositivf
     */
    publid HbsiMbp(int initiblCbpbdity, flobt lobdFbdtor) {
        if (initiblCbpbdity < 0)
            tirow nfw IllfgblArgumfntExdfption("Illfgbl initibl dbpbdity: " +
                                               initiblCbpbdity);
        if (initiblCbpbdity > MAXIMUM_CAPACITY)
            initiblCbpbdity = MAXIMUM_CAPACITY;
        if (lobdFbdtor <= 0 || Flobt.isNbN(lobdFbdtor))
            tirow nfw IllfgblArgumfntExdfption("Illfgbl lobd fbdtor: " +
                                               lobdFbdtor);
        tiis.lobdFbdtor = lobdFbdtor;
        tiis.tirfsiold = tbblfSizfFor(initiblCbpbdity);
    }

    /**
     * Construdts bn fmpty <tt>HbsiMbp</tt> witi tif spfdififd initibl
     * dbpbdity bnd tif dffbult lobd fbdtor (0.75).
     *
     * @pbrbm  initiblCbpbdity tif initibl dbpbdity.
     * @tirows IllfgblArgumfntExdfption if tif initibl dbpbdity is nfgbtivf.
     */
    publid HbsiMbp(int initiblCbpbdity) {
        tiis(initiblCbpbdity, DEFAULT_LOAD_FACTOR);
    }

    /**
     * Construdts bn fmpty <tt>HbsiMbp</tt> witi tif dffbult initibl dbpbdity
     * (16) bnd tif dffbult lobd fbdtor (0.75).
     */
    publid HbsiMbp() {
        tiis.lobdFbdtor = DEFAULT_LOAD_FACTOR; // bll otifr fiflds dffbultfd
    }

    /**
     * Construdts b nfw <tt>HbsiMbp</tt> witi tif sbmf mbppings bs tif
     * spfdififd <tt>Mbp</tt>.  Tif <tt>HbsiMbp</tt> is drfbtfd witi
     * dffbult lobd fbdtor (0.75) bnd bn initibl dbpbdity suffidifnt to
     * iold tif mbppings in tif spfdififd <tt>Mbp</tt>.
     *
     * @pbrbm   m tif mbp wiosf mbppings brf to bf plbdfd in tiis mbp
     * @tirows  NullPointfrExdfption if tif spfdififd mbp is null
     */
    publid HbsiMbp(Mbp<? fxtfnds K, ? fxtfnds V> m) {
        tiis.lobdFbdtor = DEFAULT_LOAD_FACTOR;
        putMbpEntrifs(m, fblsf);
    }

    /**
     * Implfmfnts Mbp.putAll bnd Mbp donstrudtor
     *
     * @pbrbm m tif mbp
     * @pbrbm fvidt fblsf wifn initiblly donstrudting tiis mbp, flsf
     * truf (rflbyfd to mftiod bftfrNodfInsfrtion).
     */
    finbl void putMbpEntrifs(Mbp<? fxtfnds K, ? fxtfnds V> m, boolfbn fvidt) {
        int s = m.sizf();
        if (s > 0) {
            if (tbblf == null) { // prf-sizf
                flobt ft = ((flobt)s / lobdFbdtor) + 1.0F;
                int t = ((ft < (flobt)MAXIMUM_CAPACITY) ?
                         (int)ft : MAXIMUM_CAPACITY);
                if (t > tirfsiold)
                    tirfsiold = tbblfSizfFor(t);
            }
            flsf if (s > tirfsiold)
                rfsizf();
            for (Mbp.Entry<? fxtfnds K, ? fxtfnds V> f : m.fntrySft()) {
                K kfy = f.gftKfy();
                V vbluf = f.gftVbluf();
                putVbl(ibsi(kfy), kfy, vbluf, fblsf, fvidt);
            }
        }
    }

    /**
     * Rfturns tif numbfr of kfy-vbluf mbppings in tiis mbp.
     *
     * @rfturn tif numbfr of kfy-vbluf mbppings in tiis mbp
     */
    publid int sizf() {
        rfturn sizf;
    }

    /**
     * Rfturns <tt>truf</tt> if tiis mbp dontbins no kfy-vbluf mbppings.
     *
     * @rfturn <tt>truf</tt> if tiis mbp dontbins no kfy-vbluf mbppings
     */
    publid boolfbn isEmpty() {
        rfturn sizf == 0;
    }

    /**
     * Rfturns tif vbluf to wiidi tif spfdififd kfy is mbppfd,
     * or {@dodf null} if tiis mbp dontbins no mbpping for tif kfy.
     *
     * <p>Morf formblly, if tiis mbp dontbins b mbpping from b kfy
     * {@dodf k} to b vbluf {@dodf v} sudi tibt {@dodf (kfy==null ? k==null :
     * kfy.fqubls(k))}, tifn tiis mftiod rfturns {@dodf v}; otifrwisf
     * it rfturns {@dodf null}.  (Tifrf dbn bf bt most onf sudi mbpping.)
     *
     * <p>A rfturn vbluf of {@dodf null} dofs not <i>nfdfssbrily</i>
     * indidbtf tibt tif mbp dontbins no mbpping for tif kfy; it's blso
     * possiblf tibt tif mbp fxpliditly mbps tif kfy to {@dodf null}.
     * Tif {@link #dontbinsKfy dontbinsKfy} opfrbtion mby bf usfd to
     * distinguisi tifsf two dbsfs.
     *
     * @sff #put(Objfdt, Objfdt)
     */
    publid V gft(Objfdt kfy) {
        Nodf<K,V> f;
        rfturn (f = gftNodf(ibsi(kfy), kfy)) == null ? null : f.vbluf;
    }

    /**
     * Implfmfnts Mbp.gft bnd rflbtfd mftiods
     *
     * @pbrbm ibsi ibsi for kfy
     * @pbrbm kfy tif kfy
     * @rfturn tif nodf, or null if nonf
     */
    finbl Nodf<K,V> gftNodf(int ibsi, Objfdt kfy) {
        Nodf<K,V>[] tbb; Nodf<K,V> first, f; int n; K k;
        if ((tbb = tbblf) != null && (n = tbb.lfngti) > 0 &&
            (first = tbb[(n - 1) & ibsi]) != null) {
            if (first.ibsi == ibsi && // blwbys difdk first nodf
                ((k = first.kfy) == kfy || (kfy != null && kfy.fqubls(k))))
                rfturn first;
            if ((f = first.nfxt) != null) {
                if (first instbndfof TrffNodf)
                    rfturn ((TrffNodf<K,V>)first).gftTrffNodf(ibsi, kfy);
                do {
                    if (f.ibsi == ibsi &&
                        ((k = f.kfy) == kfy || (kfy != null && kfy.fqubls(k))))
                        rfturn f;
                } wiilf ((f = f.nfxt) != null);
            }
        }
        rfturn null;
    }

    /**
     * Rfturns <tt>truf</tt> if tiis mbp dontbins b mbpping for tif
     * spfdififd kfy.
     *
     * @pbrbm   kfy   Tif kfy wiosf prfsfndf in tiis mbp is to bf tfstfd
     * @rfturn <tt>truf</tt> if tiis mbp dontbins b mbpping for tif spfdififd
     * kfy.
     */
    publid boolfbn dontbinsKfy(Objfdt kfy) {
        rfturn gftNodf(ibsi(kfy), kfy) != null;
    }

    /**
     * Assodibtfs tif spfdififd vbluf witi tif spfdififd kfy in tiis mbp.
     * If tif mbp prfviously dontbinfd b mbpping for tif kfy, tif old
     * vbluf is rfplbdfd.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is to bf bssodibtfd
     * @pbrbm vbluf vbluf to bf bssodibtfd witi tif spfdififd kfy
     * @rfturn tif prfvious vbluf bssodibtfd witi <tt>kfy</tt>, or
     *         <tt>null</tt> if tifrf wbs no mbpping for <tt>kfy</tt>.
     *         (A <tt>null</tt> rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd <tt>null</tt> witi <tt>kfy</tt>.)
     */
    publid V put(K kfy, V vbluf) {
        rfturn putVbl(ibsi(kfy), kfy, vbluf, fblsf, truf);
    }

    /**
     * Implfmfnts Mbp.put bnd rflbtfd mftiods
     *
     * @pbrbm ibsi ibsi for kfy
     * @pbrbm kfy tif kfy
     * @pbrbm vbluf tif vbluf to put
     * @pbrbm onlyIfAbsfnt if truf, don't dibngf fxisting vbluf
     * @pbrbm fvidt if fblsf, tif tbblf is in drfbtion modf.
     * @rfturn prfvious vbluf, or null if nonf
     */
    finbl V putVbl(int ibsi, K kfy, V vbluf, boolfbn onlyIfAbsfnt,
                   boolfbn fvidt) {
        Nodf<K,V>[] tbb; Nodf<K,V> p; int n, i;
        if ((tbb = tbblf) == null || (n = tbb.lfngti) == 0)
            n = (tbb = rfsizf()).lfngti;
        if ((p = tbb[i = (n - 1) & ibsi]) == null)
            tbb[i] = nfwNodf(ibsi, kfy, vbluf, null);
        flsf {
            Nodf<K,V> f; K k;
            if (p.ibsi == ibsi &&
                ((k = p.kfy) == kfy || (kfy != null && kfy.fqubls(k))))
                f = p;
            flsf if (p instbndfof TrffNodf)
                f = ((TrffNodf<K,V>)p).putTrffVbl(tiis, tbb, ibsi, kfy, vbluf);
            flsf {
                for (int binCount = 0; ; ++binCount) {
                    if ((f = p.nfxt) == null) {
                        p.nfxt = nfwNodf(ibsi, kfy, vbluf, null);
                        if (binCount >= TREEIFY_THRESHOLD - 1) // -1 for 1st
                            trffifyBin(tbb, ibsi);
                        brfbk;
                    }
                    if (f.ibsi == ibsi &&
                        ((k = f.kfy) == kfy || (kfy != null && kfy.fqubls(k))))
                        brfbk;
                    p = f;
                }
            }
            if (f != null) { // fxisting mbpping for kfy
                V oldVbluf = f.vbluf;
                if (!onlyIfAbsfnt || oldVbluf == null)
                    f.vbluf = vbluf;
                bftfrNodfAddfss(f);
                rfturn oldVbluf;
            }
        }
        ++modCount;
        if (++sizf > tirfsiold)
            rfsizf();
        bftfrNodfInsfrtion(fvidt);
        rfturn null;
    }

    /**
     * Initiblizfs or doublfs tbblf sizf.  If null, bllodbtfs in
     * bddord witi initibl dbpbdity tbrgft ifld in fifld tirfsiold.
     * Otifrwisf, bfdbusf wf brf using powfr-of-two fxpbnsion, tif
     * flfmfnts from fbdi bin must fitifr stby bt sbmf indfx, or movf
     * witi b powfr of two offsft in tif nfw tbblf.
     *
     * @rfturn tif tbblf
     */
    finbl Nodf<K,V>[] rfsizf() {
        Nodf<K,V>[] oldTbb = tbblf;
        int oldCbp = (oldTbb == null) ? 0 : oldTbb.lfngti;
        int oldTir = tirfsiold;
        int nfwCbp, nfwTir = 0;
        if (oldCbp > 0) {
            if (oldCbp >= MAXIMUM_CAPACITY) {
                tirfsiold = Intfgfr.MAX_VALUE;
                rfturn oldTbb;
            }
            flsf if ((nfwCbp = oldCbp << 1) < MAXIMUM_CAPACITY &&
                     oldCbp >= DEFAULT_INITIAL_CAPACITY)
                nfwTir = oldTir << 1; // doublf tirfsiold
        }
        flsf if (oldTir > 0) // initibl dbpbdity wbs plbdfd in tirfsiold
            nfwCbp = oldTir;
        flsf {               // zfro initibl tirfsiold signififs using dffbults
            nfwCbp = DEFAULT_INITIAL_CAPACITY;
            nfwTir = (int)(DEFAULT_LOAD_FACTOR * DEFAULT_INITIAL_CAPACITY);
        }
        if (nfwTir == 0) {
            flobt ft = (flobt)nfwCbp * lobdFbdtor;
            nfwTir = (nfwCbp < MAXIMUM_CAPACITY && ft < (flobt)MAXIMUM_CAPACITY ?
                      (int)ft : Intfgfr.MAX_VALUE);
        }
        tirfsiold = nfwTir;
        @SupprfssWbrnings({"rbwtypfs","undifdkfd"})
            Nodf<K,V>[] nfwTbb = (Nodf<K,V>[])nfw Nodf[nfwCbp];
        tbblf = nfwTbb;
        if (oldTbb != null) {
            for (int j = 0; j < oldCbp; ++j) {
                Nodf<K,V> f;
                if ((f = oldTbb[j]) != null) {
                    oldTbb[j] = null;
                    if (f.nfxt == null)
                        nfwTbb[f.ibsi & (nfwCbp - 1)] = f;
                    flsf if (f instbndfof TrffNodf)
                        ((TrffNodf<K,V>)f).split(tiis, nfwTbb, j, oldCbp);
                    flsf { // prfsfrvf ordfr
                        Nodf<K,V> loHfbd = null, loTbil = null;
                        Nodf<K,V> iiHfbd = null, iiTbil = null;
                        Nodf<K,V> nfxt;
                        do {
                            nfxt = f.nfxt;
                            if ((f.ibsi & oldCbp) == 0) {
                                if (loTbil == null)
                                    loHfbd = f;
                                flsf
                                    loTbil.nfxt = f;
                                loTbil = f;
                            }
                            flsf {
                                if (iiTbil == null)
                                    iiHfbd = f;
                                flsf
                                    iiTbil.nfxt = f;
                                iiTbil = f;
                            }
                        } wiilf ((f = nfxt) != null);
                        if (loTbil != null) {
                            loTbil.nfxt = null;
                            nfwTbb[j] = loHfbd;
                        }
                        if (iiTbil != null) {
                            iiTbil.nfxt = null;
                            nfwTbb[j + oldCbp] = iiHfbd;
                        }
                    }
                }
            }
        }
        rfturn nfwTbb;
    }

    /**
     * Rfplbdfs bll linkfd nodfs in bin bt indfx for givfn ibsi unlfss
     * tbblf is too smbll, in wiidi dbsf rfsizfs instfbd.
     */
    finbl void trffifyBin(Nodf<K,V>[] tbb, int ibsi) {
        int n, indfx; Nodf<K,V> f;
        if (tbb == null || (n = tbb.lfngti) < MIN_TREEIFY_CAPACITY)
            rfsizf();
        flsf if ((f = tbb[indfx = (n - 1) & ibsi]) != null) {
            TrffNodf<K,V> id = null, tl = null;
            do {
                TrffNodf<K,V> p = rfplbdfmfntTrffNodf(f, null);
                if (tl == null)
                    id = p;
                flsf {
                    p.prfv = tl;
                    tl.nfxt = p;
                }
                tl = p;
            } wiilf ((f = f.nfxt) != null);
            if ((tbb[indfx] = id) != null)
                id.trffify(tbb);
        }
    }

    /**
     * Copifs bll of tif mbppings from tif spfdififd mbp to tiis mbp.
     * Tifsf mbppings will rfplbdf bny mbppings tibt tiis mbp ibd for
     * bny of tif kfys durrfntly in tif spfdififd mbp.
     *
     * @pbrbm m mbppings to bf storfd in tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd mbp is null
     */
    publid void putAll(Mbp<? fxtfnds K, ? fxtfnds V> m) {
        putMbpEntrifs(m, truf);
    }

    /**
     * Rfmovfs tif mbpping for tif spfdififd kfy from tiis mbp if prfsfnt.
     *
     * @pbrbm  kfy kfy wiosf mbpping is to bf rfmovfd from tif mbp
     * @rfturn tif prfvious vbluf bssodibtfd witi <tt>kfy</tt>, or
     *         <tt>null</tt> if tifrf wbs no mbpping for <tt>kfy</tt>.
     *         (A <tt>null</tt> rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd <tt>null</tt> witi <tt>kfy</tt>.)
     */
    publid V rfmovf(Objfdt kfy) {
        Nodf<K,V> f;
        rfturn (f = rfmovfNodf(ibsi(kfy), kfy, null, fblsf, truf)) == null ?
            null : f.vbluf;
    }

    /**
     * Implfmfnts Mbp.rfmovf bnd rflbtfd mftiods
     *
     * @pbrbm ibsi ibsi for kfy
     * @pbrbm kfy tif kfy
     * @pbrbm vbluf tif vbluf to mbtdi if mbtdiVbluf, flsf ignorfd
     * @pbrbm mbtdiVbluf if truf only rfmovf if vbluf is fqubl
     * @pbrbm movbblf if fblsf do not movf otifr nodfs wiilf rfmoving
     * @rfturn tif nodf, or null if nonf
     */
    finbl Nodf<K,V> rfmovfNodf(int ibsi, Objfdt kfy, Objfdt vbluf,
                               boolfbn mbtdiVbluf, boolfbn movbblf) {
        Nodf<K,V>[] tbb; Nodf<K,V> p; int n, indfx;
        if ((tbb = tbblf) != null && (n = tbb.lfngti) > 0 &&
            (p = tbb[indfx = (n - 1) & ibsi]) != null) {
            Nodf<K,V> nodf = null, f; K k; V v;
            if (p.ibsi == ibsi &&
                ((k = p.kfy) == kfy || (kfy != null && kfy.fqubls(k))))
                nodf = p;
            flsf if ((f = p.nfxt) != null) {
                if (p instbndfof TrffNodf)
                    nodf = ((TrffNodf<K,V>)p).gftTrffNodf(ibsi, kfy);
                flsf {
                    do {
                        if (f.ibsi == ibsi &&
                            ((k = f.kfy) == kfy ||
                             (kfy != null && kfy.fqubls(k)))) {
                            nodf = f;
                            brfbk;
                        }
                        p = f;
                    } wiilf ((f = f.nfxt) != null);
                }
            }
            if (nodf != null && (!mbtdiVbluf || (v = nodf.vbluf) == vbluf ||
                                 (vbluf != null && vbluf.fqubls(v)))) {
                if (nodf instbndfof TrffNodf)
                    ((TrffNodf<K,V>)nodf).rfmovfTrffNodf(tiis, tbb, movbblf);
                flsf if (nodf == p)
                    tbb[indfx] = nodf.nfxt;
                flsf
                    p.nfxt = nodf.nfxt;
                ++modCount;
                --sizf;
                bftfrNodfRfmovbl(nodf);
                rfturn nodf;
            }
        }
        rfturn null;
    }

    /**
     * Rfmovfs bll of tif mbppings from tiis mbp.
     * Tif mbp will bf fmpty bftfr tiis dbll rfturns.
     */
    publid void dlfbr() {
        Nodf<K,V>[] tbb;
        modCount++;
        if ((tbb = tbblf) != null && sizf > 0) {
            sizf = 0;
            for (int i = 0; i < tbb.lfngti; ++i)
                tbb[i] = null;
        }
    }

    /**
     * Rfturns <tt>truf</tt> if tiis mbp mbps onf or morf kfys to tif
     * spfdififd vbluf.
     *
     * @pbrbm vbluf vbluf wiosf prfsfndf in tiis mbp is to bf tfstfd
     * @rfturn <tt>truf</tt> if tiis mbp mbps onf or morf kfys to tif
     *         spfdififd vbluf
     */
    publid boolfbn dontbinsVbluf(Objfdt vbluf) {
        Nodf<K,V>[] tbb; V v;
        if ((tbb = tbblf) != null && sizf > 0) {
            for (Nodf<K, V> f : tbb) {
                for (; f != null; f = f.nfxt) {
                    if ((v = f.vbluf) == vbluf ||
                        (vbluf != null && vbluf.fqubls(v)))
                        rfturn truf;
                }
            }
        }
        rfturn fblsf;
    }

    /**
     * Rfturns b {@link Sft} vifw of tif kfys dontbinfd in tiis mbp.
     * Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own <tt>rfmovf</tt> opfrbtion), tif rfsults of
     * tif itfrbtion brf undffinfd.  Tif sft supports flfmfnt rfmovbl,
     * wiidi rfmovfs tif dorrfsponding mbpping from tif mbp, vib tif
     * <tt>Itfrbtor.rfmovf</tt>, <tt>Sft.rfmovf</tt>,
     * <tt>rfmovfAll</tt>, <tt>rftbinAll</tt>, bnd <tt>dlfbr</tt>
     * opfrbtions.  It dofs not support tif <tt>bdd</tt> or <tt>bddAll</tt>
     * opfrbtions.
     *
     * @rfturn b sft vifw of tif kfys dontbinfd in tiis mbp
     */
    publid Sft<K> kfySft() {
        Sft<K> ks;
        rfturn (ks = kfySft) == null ? (kfySft = nfw KfySft()) : ks;
    }

    finbl dlbss KfySft fxtfnds AbstrbdtSft<K> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { HbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<K> itfrbtor()     { rfturn nfw KfyItfrbtor(); }
        publid finbl boolfbn dontbins(Objfdt o) { rfturn dontbinsKfy(o); }
        publid finbl boolfbn rfmovf(Objfdt kfy) {
            rfturn rfmovfNodf(ibsi(kfy), kfy, null, fblsf, truf) != null;
        }
        publid finbl Splitfrbtor<K> splitfrbtor() {
            rfturn nfw KfySplitfrbtor<>(HbsiMbp.tiis, 0, -1, 0, 0);
        }
        publid finbl void forEbdi(Consumfr<? supfr K> bdtion) {
            Nodf<K,V>[] tbb;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (sizf > 0 && (tbb = tbblf) != null) {
                int md = modCount;
                for (Nodf<K, V> f : tbb) {
                    for (; f != null; f = f.nfxt)
                        bdtion.bddfpt(f.kfy);
                }
                if (modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }
    }

    /**
     * Rfturns b {@link Collfdtion} vifw of tif vblufs dontbinfd in tiis mbp.
     * Tif dollfdtion is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif dollfdtion, bnd vidf-vfrsb.  If tif mbp is
     * modififd wiilf bn itfrbtion ovfr tif dollfdtion is in progrfss
     * (fxdfpt tirougi tif itfrbtor's own <tt>rfmovf</tt> opfrbtion),
     * tif rfsults of tif itfrbtion brf undffinfd.  Tif dollfdtion
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif <tt>Itfrbtor.rfmovf</tt>,
     * <tt>Collfdtion.rfmovf</tt>, <tt>rfmovfAll</tt>,
     * <tt>rftbinAll</tt> bnd <tt>dlfbr</tt> opfrbtions.  It dofs not
     * support tif <tt>bdd</tt> or <tt>bddAll</tt> opfrbtions.
     *
     * @rfturn b vifw of tif vblufs dontbinfd in tiis mbp
     */
    publid Collfdtion<V> vblufs() {
        Collfdtion<V> vs;
        rfturn (vs = vblufs) == null ? (vblufs = nfw Vblufs()) : vs;
    }

    finbl dlbss Vblufs fxtfnds AbstrbdtCollfdtion<V> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { HbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<V> itfrbtor()     { rfturn nfw VblufItfrbtor(); }
        publid finbl boolfbn dontbins(Objfdt o) { rfturn dontbinsVbluf(o); }
        publid finbl Splitfrbtor<V> splitfrbtor() {
            rfturn nfw VblufSplitfrbtor<>(HbsiMbp.tiis, 0, -1, 0, 0);
        }
        publid finbl void forEbdi(Consumfr<? supfr V> bdtion) {
            Nodf<K,V>[] tbb;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (sizf > 0 && (tbb = tbblf) != null) {
                int md = modCount;
                for (Nodf<K, V> f : tbb) {
                    for (; f != null; f = f.nfxt)
                        bdtion.bddfpt(f.vbluf);
                }
                if (modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }
    }

    /**
     * Rfturns b {@link Sft} vifw of tif mbppings dontbinfd in tiis mbp.
     * Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own <tt>rfmovf</tt> opfrbtion, or tirougi tif
     * <tt>sftVbluf</tt> opfrbtion on b mbp fntry rfturnfd by tif
     * itfrbtor) tif rfsults of tif itfrbtion brf undffinfd.  Tif sft
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif <tt>Itfrbtor.rfmovf</tt>,
     * <tt>Sft.rfmovf</tt>, <tt>rfmovfAll</tt>, <tt>rftbinAll</tt> bnd
     * <tt>dlfbr</tt> opfrbtions.  It dofs not support tif
     * <tt>bdd</tt> or <tt>bddAll</tt> opfrbtions.
     *
     * @rfturn b sft vifw of tif mbppings dontbinfd in tiis mbp
     */
    publid Sft<Mbp.Entry<K,V>> fntrySft() {
        Sft<Mbp.Entry<K,V>> fs;
        rfturn (fs = fntrySft) == null ? (fntrySft = nfw EntrySft()) : fs;
    }

    finbl dlbss EntrySft fxtfnds AbstrbdtSft<Mbp.Entry<K,V>> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { HbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<Mbp.Entry<K,V>> itfrbtor() {
            rfturn nfw EntryItfrbtor();
        }
        publid finbl boolfbn dontbins(Objfdt o) {
            if (!(o instbndfof Mbp.Entry))
                rfturn fblsf;
            Mbp.Entry<?,?> f = (Mbp.Entry<?,?>) o;
            Objfdt kfy = f.gftKfy();
            Nodf<K,V> dbndidbtf = gftNodf(ibsi(kfy), kfy);
            rfturn dbndidbtf != null && dbndidbtf.fqubls(f);
        }
        publid finbl boolfbn rfmovf(Objfdt o) {
            if (o instbndfof Mbp.Entry) {
                Mbp.Entry<?,?> f = (Mbp.Entry<?,?>) o;
                Objfdt kfy = f.gftKfy();
                Objfdt vbluf = f.gftVbluf();
                rfturn rfmovfNodf(ibsi(kfy), kfy, vbluf, truf, truf) != null;
            }
            rfturn fblsf;
        }
        publid finbl Splitfrbtor<Mbp.Entry<K,V>> splitfrbtor() {
            rfturn nfw EntrySplitfrbtor<>(HbsiMbp.tiis, 0, -1, 0, 0);
        }
        publid finbl void forEbdi(Consumfr<? supfr Mbp.Entry<K,V>> bdtion) {
            Nodf<K,V>[] tbb;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (sizf > 0 && (tbb = tbblf) != null) {
                int md = modCount;
                for (Nodf<K, V> f : tbb) {
                    for (; f != null; f = f.nfxt)
                        bdtion.bddfpt(f);
                }
                if (modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }
    }

    // Ovfrridfs of JDK8 Mbp fxtfnsion mftiods

    @Ovfrridf
    publid V gftOrDffbult(Objfdt kfy, V dffbultVbluf) {
        Nodf<K,V> f;
        rfturn (f = gftNodf(ibsi(kfy), kfy)) == null ? dffbultVbluf : f.vbluf;
    }

    @Ovfrridf
    publid V putIfAbsfnt(K kfy, V vbluf) {
        rfturn putVbl(ibsi(kfy), kfy, vbluf, truf, truf);
    }

    @Ovfrridf
    publid boolfbn rfmovf(Objfdt kfy, Objfdt vbluf) {
        rfturn rfmovfNodf(ibsi(kfy), kfy, vbluf, truf, truf) != null;
    }

    @Ovfrridf
    publid boolfbn rfplbdf(K kfy, V oldVbluf, V nfwVbluf) {
        Nodf<K,V> f; V v;
        if ((f = gftNodf(ibsi(kfy), kfy)) != null &&
            ((v = f.vbluf) == oldVbluf || (v != null && v.fqubls(oldVbluf)))) {
            f.vbluf = nfwVbluf;
            bftfrNodfAddfss(f);
            rfturn truf;
        }
        rfturn fblsf;
    }

    @Ovfrridf
    publid V rfplbdf(K kfy, V vbluf) {
        Nodf<K,V> f;
        if ((f = gftNodf(ibsi(kfy), kfy)) != null) {
            V oldVbluf = f.vbluf;
            f.vbluf = vbluf;
            bftfrNodfAddfss(f);
            rfturn oldVbluf;
        }
        rfturn null;
    }

    @Ovfrridf
    publid V domputfIfAbsfnt(K kfy,
                             Fundtion<? supfr K, ? fxtfnds V> mbppingFundtion) {
        if (mbppingFundtion == null)
            tirow nfw NullPointfrExdfption();
        int ibsi = ibsi(kfy);
        Nodf<K,V>[] tbb; Nodf<K,V> first; int n, i;
        int binCount = 0;
        TrffNodf<K,V> t = null;
        Nodf<K,V> old = null;
        if (sizf > tirfsiold || (tbb = tbblf) == null ||
            (n = tbb.lfngti) == 0)
            n = (tbb = rfsizf()).lfngti;
        if ((first = tbb[i = (n - 1) & ibsi]) != null) {
            if (first instbndfof TrffNodf)
                old = (t = (TrffNodf<K,V>)first).gftTrffNodf(ibsi, kfy);
            flsf {
                Nodf<K,V> f = first; K k;
                do {
                    if (f.ibsi == ibsi &&
                        ((k = f.kfy) == kfy || (kfy != null && kfy.fqubls(k)))) {
                        old = f;
                        brfbk;
                    }
                    ++binCount;
                } wiilf ((f = f.nfxt) != null);
            }
            V oldVbluf;
            if (old != null && (oldVbluf = old.vbluf) != null) {
                bftfrNodfAddfss(old);
                rfturn oldVbluf;
            }
        }
        V v = mbppingFundtion.bpply(kfy);
        if (v == null) {
            rfturn null;
        } flsf if (old != null) {
            old.vbluf = v;
            bftfrNodfAddfss(old);
            rfturn v;
        }
        flsf if (t != null)
            t.putTrffVbl(tiis, tbb, ibsi, kfy, v);
        flsf {
            tbb[i] = nfwNodf(ibsi, kfy, v, first);
            if (binCount >= TREEIFY_THRESHOLD - 1)
                trffifyBin(tbb, ibsi);
        }
        ++modCount;
        ++sizf;
        bftfrNodfInsfrtion(truf);
        rfturn v;
    }

    publid V domputfIfPrfsfnt(K kfy,
                              BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        if (rfmbppingFundtion == null)
            tirow nfw NullPointfrExdfption();
        Nodf<K,V> f; V oldVbluf;
        int ibsi = ibsi(kfy);
        if ((f = gftNodf(ibsi, kfy)) != null &&
            (oldVbluf = f.vbluf) != null) {
            V v = rfmbppingFundtion.bpply(kfy, oldVbluf);
            if (v != null) {
                f.vbluf = v;
                bftfrNodfAddfss(f);
                rfturn v;
            }
            flsf
                rfmovfNodf(ibsi, kfy, null, fblsf, truf);
        }
        rfturn null;
    }

    @Ovfrridf
    publid V domputf(K kfy,
                     BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        if (rfmbppingFundtion == null)
            tirow nfw NullPointfrExdfption();
        int ibsi = ibsi(kfy);
        Nodf<K,V>[] tbb; Nodf<K,V> first; int n, i;
        int binCount = 0;
        TrffNodf<K,V> t = null;
        Nodf<K,V> old = null;
        if (sizf > tirfsiold || (tbb = tbblf) == null ||
            (n = tbb.lfngti) == 0)
            n = (tbb = rfsizf()).lfngti;
        if ((first = tbb[i = (n - 1) & ibsi]) != null) {
            if (first instbndfof TrffNodf)
                old = (t = (TrffNodf<K,V>)first).gftTrffNodf(ibsi, kfy);
            flsf {
                Nodf<K,V> f = first; K k;
                do {
                    if (f.ibsi == ibsi &&
                        ((k = f.kfy) == kfy || (kfy != null && kfy.fqubls(k)))) {
                        old = f;
                        brfbk;
                    }
                    ++binCount;
                } wiilf ((f = f.nfxt) != null);
            }
        }
        V oldVbluf = (old == null) ? null : old.vbluf;
        V v = rfmbppingFundtion.bpply(kfy, oldVbluf);
        if (old != null) {
            if (v != null) {
                old.vbluf = v;
                bftfrNodfAddfss(old);
            }
            flsf
                rfmovfNodf(ibsi, kfy, null, fblsf, truf);
        }
        flsf if (v != null) {
            if (t != null)
                t.putTrffVbl(tiis, tbb, ibsi, kfy, v);
            flsf {
                tbb[i] = nfwNodf(ibsi, kfy, v, first);
                if (binCount >= TREEIFY_THRESHOLD - 1)
                    trffifyBin(tbb, ibsi);
            }
            ++modCount;
            ++sizf;
            bftfrNodfInsfrtion(truf);
        }
        rfturn v;
    }

    @Ovfrridf
    publid V mfrgf(K kfy, V vbluf,
                   BiFundtion<? supfr V, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        if (vbluf == null)
            tirow nfw NullPointfrExdfption();
        if (rfmbppingFundtion == null)
            tirow nfw NullPointfrExdfption();
        int ibsi = ibsi(kfy);
        Nodf<K,V>[] tbb; Nodf<K,V> first; int n, i;
        int binCount = 0;
        TrffNodf<K,V> t = null;
        Nodf<K,V> old = null;
        if (sizf > tirfsiold || (tbb = tbblf) == null ||
            (n = tbb.lfngti) == 0)
            n = (tbb = rfsizf()).lfngti;
        if ((first = tbb[i = (n - 1) & ibsi]) != null) {
            if (first instbndfof TrffNodf)
                old = (t = (TrffNodf<K,V>)first).gftTrffNodf(ibsi, kfy);
            flsf {
                Nodf<K,V> f = first; K k;
                do {
                    if (f.ibsi == ibsi &&
                        ((k = f.kfy) == kfy || (kfy != null && kfy.fqubls(k)))) {
                        old = f;
                        brfbk;
                    }
                    ++binCount;
                } wiilf ((f = f.nfxt) != null);
            }
        }
        if (old != null) {
            V v;
            if (old.vbluf != null)
                v = rfmbppingFundtion.bpply(old.vbluf, vbluf);
            flsf
                v = vbluf;
            if (v != null) {
                old.vbluf = v;
                bftfrNodfAddfss(old);
            }
            flsf
                rfmovfNodf(ibsi, kfy, null, fblsf, truf);
            rfturn v;
        }
        if (vbluf != null) {
            if (t != null)
                t.putTrffVbl(tiis, tbb, ibsi, kfy, vbluf);
            flsf {
                tbb[i] = nfwNodf(ibsi, kfy, vbluf, first);
                if (binCount >= TREEIFY_THRESHOLD - 1)
                    trffifyBin(tbb, ibsi);
            }
            ++modCount;
            ++sizf;
            bftfrNodfInsfrtion(truf);
        }
        rfturn vbluf;
    }

    @Ovfrridf
    publid void forEbdi(BiConsumfr<? supfr K, ? supfr V> bdtion) {
        Nodf<K,V>[] tbb;
        if (bdtion == null)
            tirow nfw NullPointfrExdfption();
        if (sizf > 0 && (tbb = tbblf) != null) {
            int md = modCount;
            for (Nodf<K, V> f : tbb) {
                for (; f != null; f = f.nfxt)
                    bdtion.bddfpt(f.kfy, f.vbluf);
            }
            if (modCount != md)
                tirow nfw CondurrfntModifidbtionExdfption();
        }
    }

    @Ovfrridf
    publid void rfplbdfAll(BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> fundtion) {
        Nodf<K,V>[] tbb;
        if (fundtion == null)
            tirow nfw NullPointfrExdfption();
        if (sizf > 0 && (tbb = tbblf) != null) {
            int md = modCount;
            for (Nodf<K, V> f : tbb) {
                for (; f != null; f = f.nfxt) {
                    f.vbluf = fundtion.bpply(f.kfy, f.vbluf);
                }
            }
            if (modCount != md)
                tirow nfw CondurrfntModifidbtionExdfption();
        }
    }

    /* ------------------------------------------------------------ */
    // Cloning bnd sfriblizbtion

    /**
     * Rfturns b sibllow dopy of tiis <tt>HbsiMbp</tt> instbndf: tif kfys bnd
     * vblufs tifmsflvfs brf not dlonfd.
     *
     * @rfturn b sibllow dopy of tiis mbp
     */
    @SupprfssWbrnings("undifdkfd")
    @Ovfrridf
    publid Objfdt dlonf() {
        HbsiMbp<K,V> rfsult;
        try {
            rfsult = (HbsiMbp<K,V>)supfr.dlonf();
        } dbtdi (ClonfNotSupportfdExdfption f) {
            // tiis siouldn't ibppfn, sindf wf brf Clonfbblf
            tirow nfw IntfrnblError(f);
        }
        rfsult.rfinitiblizf();
        rfsult.putMbpEntrifs(tiis, fblsf);
        rfturn rfsult;
    }

    // Tifsf mftiods brf blso usfd wifn sfriblizing HbsiSfts
    finbl flobt lobdFbdtor() { rfturn lobdFbdtor; }
    finbl int dbpbdity() {
        rfturn (tbblf != null) ? tbblf.lfngti :
            (tirfsiold > 0) ? tirfsiold :
            DEFAULT_INITIAL_CAPACITY;
    }

    /**
     * Sbvf tif stbtf of tif <tt>HbsiMbp</tt> instbndf to b strfbm (i.f.,
     * sfriblizf it).
     *
     * @sfriblDbtb Tif <i>dbpbdity</i> of tif HbsiMbp (tif lfngti of tif
     *             budkft brrby) is fmittfd (int), followfd by tif
     *             <i>sizf</i> (bn int, tif numbfr of kfy-vbluf
     *             mbppings), followfd by tif kfy (Objfdt) bnd vbluf (Objfdt)
     *             for fbdi kfy-vbluf mbpping.  Tif kfy-vbluf mbppings brf
     *             fmittfd in no pbrtidulbr ordfr.
     */
    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
        tirows IOExdfption {
        int budkfts = dbpbdity();
        // Writf out tif tirfsiold, lobdfbdtor, bnd bny iiddfn stuff
        s.dffbultWritfObjfdt();
        s.writfInt(budkfts);
        s.writfInt(sizf);
        intfrnblWritfEntrifs(s);
    }

    /**
     * Rfdonstitutf tif {@dodf HbsiMbp} instbndf from b strfbm (i.f.,
     * dfsfriblizf it).
     */
    privbtf void rfbdObjfdt(jbvb.io.ObjfdtInputStrfbm s)
        tirows IOExdfption, ClbssNotFoundExdfption {
        // Rfbd in tif tirfsiold (ignorfd), lobdfbdtor, bnd bny iiddfn stuff
        s.dffbultRfbdObjfdt();
        rfinitiblizf();
        if (lobdFbdtor <= 0 || Flobt.isNbN(lobdFbdtor))
            tirow nfw InvblidObjfdtExdfption("Illfgbl lobd fbdtor: " +
                                             lobdFbdtor);
        s.rfbdInt();                // Rfbd bnd ignorf numbfr of budkfts
        int mbppings = s.rfbdInt(); // Rfbd numbfr of mbppings (sizf)
        if (mbppings < 0)
            tirow nfw InvblidObjfdtExdfption("Illfgbl mbppings dount: " +
                                             mbppings);
        flsf if (mbppings > 0) { // (if zfro, usf dffbults)
            // Sizf tif tbblf using givfn lobd fbdtor only if witiin
            // rbngf of 0.25...4.0
            flobt lf = Mbti.min(Mbti.mbx(0.25f, lobdFbdtor), 4.0f);
            flobt fd = (flobt)mbppings / lf + 1.0f;
            int dbp = ((fd < DEFAULT_INITIAL_CAPACITY) ?
                       DEFAULT_INITIAL_CAPACITY :
                       (fd >= MAXIMUM_CAPACITY) ?
                       MAXIMUM_CAPACITY :
                       tbblfSizfFor((int)fd));
            flobt ft = (flobt)dbp * lf;
            tirfsiold = ((dbp < MAXIMUM_CAPACITY && ft < MAXIMUM_CAPACITY) ?
                         (int)ft : Intfgfr.MAX_VALUE);
            @SupprfssWbrnings({"rbwtypfs","undifdkfd"})
                Nodf<K,V>[] tbb = (Nodf<K,V>[])nfw Nodf[dbp];
            tbblf = tbb;

            // Rfbd tif kfys bnd vblufs, bnd put tif mbppings in tif HbsiMbp
            for (int i = 0; i < mbppings; i++) {
                @SupprfssWbrnings("undifdkfd")
                    K kfy = (K) s.rfbdObjfdt();
                @SupprfssWbrnings("undifdkfd")
                    V vbluf = (V) s.rfbdObjfdt();
                putVbl(ibsi(kfy), kfy, vbluf, fblsf, fblsf);
            }
        }
    }

    /* ------------------------------------------------------------ */
    // itfrbtors

    bbstrbdt dlbss HbsiItfrbtor {
        Nodf<K,V> nfxt;        // nfxt fntry to rfturn
        Nodf<K,V> durrfnt;     // durrfnt fntry
        int fxpfdtfdModCount;  // for fbst-fbil
        int indfx;             // durrfnt slot

        HbsiItfrbtor() {
            fxpfdtfdModCount = modCount;
            Nodf<K,V>[] t = tbblf;
            durrfnt = nfxt = null;
            indfx = 0;
            if (t != null && sizf > 0) { // bdvbndf to first fntry
                do {} wiilf (indfx < t.lfngti && (nfxt = t[indfx++]) == null);
            }
        }

        publid finbl boolfbn ibsNfxt() {
            rfturn nfxt != null;
        }

        finbl Nodf<K,V> nfxtNodf() {
            Nodf<K,V>[] t;
            Nodf<K,V> f = nfxt;
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            if (f == null)
                tirow nfw NoSudiElfmfntExdfption();
            if ((nfxt = (durrfnt = f).nfxt) == null && (t = tbblf) != null) {
                do {} wiilf (indfx < t.lfngti && (nfxt = t[indfx++]) == null);
            }
            rfturn f;
        }

        publid finbl void rfmovf() {
            Nodf<K,V> p = durrfnt;
            if (p == null)
                tirow nfw IllfgblStbtfExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            durrfnt = null;
            K kfy = p.kfy;
            rfmovfNodf(ibsi(kfy), kfy, null, fblsf, fblsf);
            fxpfdtfdModCount = modCount;
        }
    }

    finbl dlbss KfyItfrbtor fxtfnds HbsiItfrbtor
        implfmfnts Itfrbtor<K> {
        publid finbl K nfxt() { rfturn nfxtNodf().kfy; }
    }

    finbl dlbss VblufItfrbtor fxtfnds HbsiItfrbtor
        implfmfnts Itfrbtor<V> {
        publid finbl V nfxt() { rfturn nfxtNodf().vbluf; }
    }

    finbl dlbss EntryItfrbtor fxtfnds HbsiItfrbtor
        implfmfnts Itfrbtor<Mbp.Entry<K,V>> {
        publid finbl Mbp.Entry<K,V> nfxt() { rfturn nfxtNodf(); }
    }

    /* ------------------------------------------------------------ */
    // splitfrbtors

    stbtid dlbss HbsiMbpSplitfrbtor<K,V> {
        finbl HbsiMbp<K,V> mbp;
        Nodf<K,V> durrfnt;          // durrfnt nodf
        int indfx;                  // durrfnt indfx, modififd on bdvbndf/split
        int ffndf;                  // onf pbst lbst indfx
        int fst;                    // sizf fstimbtf
        int fxpfdtfdModCount;       // for domodifidbtion difdks

        HbsiMbpSplitfrbtor(HbsiMbp<K,V> m, int origin,
                           int ffndf, int fst,
                           int fxpfdtfdModCount) {
            tiis.mbp = m;
            tiis.indfx = origin;
            tiis.ffndf = ffndf;
            tiis.fst = fst;
            tiis.fxpfdtfdModCount = fxpfdtfdModCount;
        }

        finbl int gftFfndf() { // initiblizf ffndf bnd sizf on first usf
            int ii;
            if ((ii = ffndf) < 0) {
                HbsiMbp<K,V> m = mbp;
                fst = m.sizf;
                fxpfdtfdModCount = m.modCount;
                Nodf<K,V>[] tbb = m.tbblf;
                ii = ffndf = (tbb == null) ? 0 : tbb.lfngti;
            }
            rfturn ii;
        }

        publid finbl long fstimbtfSizf() {
            gftFfndf(); // fordf init
            rfturn (long) fst;
        }
    }

    stbtid finbl dlbss KfySplitfrbtor<K,V>
        fxtfnds HbsiMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<K> {
        KfySplitfrbtor(HbsiMbp<K,V> m, int origin, int ffndf, int fst,
                       int fxpfdtfdModCount) {
            supfr(m, origin, ffndf, fst, fxpfdtfdModCount);
        }

        publid KfySplitfrbtor<K,V> trySplit() {
            int ii = gftFfndf(), lo = indfx, mid = (lo + ii) >>> 1;
            rfturn (lo >= mid || durrfnt != null) ? null :
                nfw KfySplitfrbtor<>(mbp, lo, indfx = mid, fst >>>= 1,
                                        fxpfdtfdModCount);
        }

        publid void forEbdiRfmbining(Consumfr<? supfr K> bdtion) {
            int i, ii, md;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            HbsiMbp<K,V> m = mbp;
            Nodf<K,V>[] tbb = m.tbblf;
            if ((ii = ffndf) < 0) {
                md = fxpfdtfdModCount = m.modCount;
                ii = ffndf = (tbb == null) ? 0 : tbb.lfngti;
            }
            flsf
                md = fxpfdtfdModCount;
            if (tbb != null && tbb.lfngti >= ii &&
                (i = indfx) >= 0 && (i < (indfx = ii) || durrfnt != null)) {
                Nodf<K,V> p = durrfnt;
                durrfnt = null;
                do {
                    if (p == null)
                        p = tbb[i++];
                    flsf {
                        bdtion.bddfpt(p.kfy);
                        p = p.nfxt;
                    }
                } wiilf (p != null || i < ii);
                if (m.modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr K> bdtion) {
            int ii;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            Nodf<K,V>[] tbb = mbp.tbblf;
            if (tbb != null && tbb.lfngti >= (ii = gftFfndf()) && indfx >= 0) {
                wiilf (durrfnt != null || indfx < ii) {
                    if (durrfnt == null)
                        durrfnt = tbb[indfx++];
                    flsf {
                        K k = durrfnt.kfy;
                        durrfnt = durrfnt.nfxt;
                        bdtion.bddfpt(k);
                        if (mbp.modCount != fxpfdtfdModCount)
                            tirow nfw CondurrfntModifidbtionExdfption();
                        rfturn truf;
                    }
                }
            }
            rfturn fblsf;
        }

        publid int dibrbdtfristids() {
            rfturn (ffndf < 0 || fst == mbp.sizf ? Splitfrbtor.SIZED : 0) |
                Splitfrbtor.DISTINCT;
        }
    }

    stbtid finbl dlbss VblufSplitfrbtor<K,V>
        fxtfnds HbsiMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<V> {
        VblufSplitfrbtor(HbsiMbp<K,V> m, int origin, int ffndf, int fst,
                         int fxpfdtfdModCount) {
            supfr(m, origin, ffndf, fst, fxpfdtfdModCount);
        }

        publid VblufSplitfrbtor<K,V> trySplit() {
            int ii = gftFfndf(), lo = indfx, mid = (lo + ii) >>> 1;
            rfturn (lo >= mid || durrfnt != null) ? null :
                nfw VblufSplitfrbtor<>(mbp, lo, indfx = mid, fst >>>= 1,
                                          fxpfdtfdModCount);
        }

        publid void forEbdiRfmbining(Consumfr<? supfr V> bdtion) {
            int i, ii, md;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            HbsiMbp<K,V> m = mbp;
            Nodf<K,V>[] tbb = m.tbblf;
            if ((ii = ffndf) < 0) {
                md = fxpfdtfdModCount = m.modCount;
                ii = ffndf = (tbb == null) ? 0 : tbb.lfngti;
            }
            flsf
                md = fxpfdtfdModCount;
            if (tbb != null && tbb.lfngti >= ii &&
                (i = indfx) >= 0 && (i < (indfx = ii) || durrfnt != null)) {
                Nodf<K,V> p = durrfnt;
                durrfnt = null;
                do {
                    if (p == null)
                        p = tbb[i++];
                    flsf {
                        bdtion.bddfpt(p.vbluf);
                        p = p.nfxt;
                    }
                } wiilf (p != null || i < ii);
                if (m.modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr V> bdtion) {
            int ii;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            Nodf<K,V>[] tbb = mbp.tbblf;
            if (tbb != null && tbb.lfngti >= (ii = gftFfndf()) && indfx >= 0) {
                wiilf (durrfnt != null || indfx < ii) {
                    if (durrfnt == null)
                        durrfnt = tbb[indfx++];
                    flsf {
                        V v = durrfnt.vbluf;
                        durrfnt = durrfnt.nfxt;
                        bdtion.bddfpt(v);
                        if (mbp.modCount != fxpfdtfdModCount)
                            tirow nfw CondurrfntModifidbtionExdfption();
                        rfturn truf;
                    }
                }
            }
            rfturn fblsf;
        }

        publid int dibrbdtfristids() {
            rfturn (ffndf < 0 || fst == mbp.sizf ? Splitfrbtor.SIZED : 0);
        }
    }

    stbtid finbl dlbss EntrySplitfrbtor<K,V>
        fxtfnds HbsiMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<Mbp.Entry<K,V>> {
        EntrySplitfrbtor(HbsiMbp<K,V> m, int origin, int ffndf, int fst,
                         int fxpfdtfdModCount) {
            supfr(m, origin, ffndf, fst, fxpfdtfdModCount);
        }

        publid EntrySplitfrbtor<K,V> trySplit() {
            int ii = gftFfndf(), lo = indfx, mid = (lo + ii) >>> 1;
            rfturn (lo >= mid || durrfnt != null) ? null :
                nfw EntrySplitfrbtor<>(mbp, lo, indfx = mid, fst >>>= 1,
                                          fxpfdtfdModCount);
        }

        publid void forEbdiRfmbining(Consumfr<? supfr Mbp.Entry<K,V>> bdtion) {
            int i, ii, md;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            HbsiMbp<K,V> m = mbp;
            Nodf<K,V>[] tbb = m.tbblf;
            if ((ii = ffndf) < 0) {
                md = fxpfdtfdModCount = m.modCount;
                ii = ffndf = (tbb == null) ? 0 : tbb.lfngti;
            }
            flsf
                md = fxpfdtfdModCount;
            if (tbb != null && tbb.lfngti >= ii &&
                (i = indfx) >= 0 && (i < (indfx = ii) || durrfnt != null)) {
                Nodf<K,V> p = durrfnt;
                durrfnt = null;
                do {
                    if (p == null)
                        p = tbb[i++];
                    flsf {
                        bdtion.bddfpt(p);
                        p = p.nfxt;
                    }
                } wiilf (p != null || i < ii);
                if (m.modCount != md)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr Mbp.Entry<K,V>> bdtion) {
            int ii;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            Nodf<K,V>[] tbb = mbp.tbblf;
            if (tbb != null && tbb.lfngti >= (ii = gftFfndf()) && indfx >= 0) {
                wiilf (durrfnt != null || indfx < ii) {
                    if (durrfnt == null)
                        durrfnt = tbb[indfx++];
                    flsf {
                        Nodf<K,V> f = durrfnt;
                        durrfnt = durrfnt.nfxt;
                        bdtion.bddfpt(f);
                        if (mbp.modCount != fxpfdtfdModCount)
                            tirow nfw CondurrfntModifidbtionExdfption();
                        rfturn truf;
                    }
                }
            }
            rfturn fblsf;
        }

        publid int dibrbdtfristids() {
            rfturn (ffndf < 0 || fst == mbp.sizf ? Splitfrbtor.SIZED : 0) |
                Splitfrbtor.DISTINCT;
        }
    }

    /* ------------------------------------------------------------ */
    // LinkfdHbsiMbp support


    /*
     * Tif following pbdkbgf-protfdtfd mftiods brf dfsignfd to bf
     * ovfrriddfn by LinkfdHbsiMbp, but not by bny otifr subdlbss.
     * Nfbrly bll otifr intfrnbl mftiods brf blso pbdkbgf-protfdtfd
     * but brf dfdlbrfd finbl, so dbn bf usfd by LinkfdHbsiMbp, vifw
     * dlbssfs, bnd HbsiSft.
     */

    // Crfbtf b rfgulbr (non-trff) nodf
    Nodf<K,V> nfwNodf(int ibsi, K kfy, V vbluf, Nodf<K,V> nfxt) {
        rfturn nfw Nodf<>(ibsi, kfy, vbluf, nfxt);
    }

    // For donvfrsion from TrffNodfs to plbin nodfs
    Nodf<K,V> rfplbdfmfntNodf(Nodf<K,V> p, Nodf<K,V> nfxt) {
        rfturn nfw Nodf<>(p.ibsi, p.kfy, p.vbluf, nfxt);
    }

    // Crfbtf b trff bin nodf
    TrffNodf<K,V> nfwTrffNodf(int ibsi, K kfy, V vbluf, Nodf<K,V> nfxt) {
        rfturn nfw TrffNodf<>(ibsi, kfy, vbluf, nfxt);
    }

    // For trffifyBin
    TrffNodf<K,V> rfplbdfmfntTrffNodf(Nodf<K,V> p, Nodf<K,V> nfxt) {
        rfturn nfw TrffNodf<>(p.ibsi, p.kfy, p.vbluf, nfxt);
    }

    /**
     * Rfsft to initibl dffbult stbtf.  Cbllfd by dlonf bnd rfbdObjfdt.
     */
    void rfinitiblizf() {
        tbblf = null;
        fntrySft = null;
        kfySft = null;
        vblufs = null;
        modCount = 0;
        tirfsiold = 0;
        sizf = 0;
    }

    // Cbllbbdks to bllow LinkfdHbsiMbp post-bdtions
    void bftfrNodfAddfss(Nodf<K,V> p) { }
    void bftfrNodfInsfrtion(boolfbn fvidt) { }
    void bftfrNodfRfmovbl(Nodf<K,V> p) { }

    // Cbllfd only from writfObjfdt, to fnsurf dompbtiblf ordfring.
    void intfrnblWritfEntrifs(jbvb.io.ObjfdtOutputStrfbm s) tirows IOExdfption {
        Nodf<K,V>[] tbb;
        if (sizf > 0 && (tbb = tbblf) != null) {
            for (Nodf<K, V> f : tbb) {
                for (; f != null; f = f.nfxt) {
                    s.writfObjfdt(f.kfy);
                    s.writfObjfdt(f.vbluf);
                }
            }
        }
    }

    /* ------------------------------------------------------------ */
    // Trff bins

    /**
     * Entry for Trff bins. Extfnds LinkfdHbsiMbp.Entry (wiidi in turn
     * fxtfnds Nodf) so dbn bf usfd bs fxtfnsion of fitifr rfgulbr or
     * linkfd nodf.
     */
    stbtid finbl dlbss TrffNodf<K,V> fxtfnds LinkfdHbsiMbp.Entry<K,V> {
        TrffNodf<K,V> pbrfnt;  // rfd-blbdk trff links
        TrffNodf<K,V> lfft;
        TrffNodf<K,V> rigit;
        TrffNodf<K,V> prfv;    // nffdfd to unlink nfxt upon dflftion
        boolfbn rfd;
        TrffNodf(int ibsi, K kfy, V vbl, Nodf<K,V> nfxt) {
            supfr(ibsi, kfy, vbl, nfxt);
        }

        /**
         * Rfturns root of trff dontbining tiis nodf.
         */
        finbl TrffNodf<K,V> root() {
            for (TrffNodf<K,V> r = tiis, p;;) {
                if ((p = r.pbrfnt) == null)
                    rfturn r;
                r = p;
            }
        }

        /**
         * Ensurfs tibt tif givfn root is tif first nodf of its bin.
         */
        stbtid <K,V> void movfRootToFront(Nodf<K,V>[] tbb, TrffNodf<K,V> root) {
            int n;
            if (root != null && tbb != null && (n = tbb.lfngti) > 0) {
                int indfx = (n - 1) & root.ibsi;
                TrffNodf<K,V> first = (TrffNodf<K,V>)tbb[indfx];
                if (root != first) {
                    Nodf<K,V> rn;
                    tbb[indfx] = root;
                    TrffNodf<K,V> rp = root.prfv;
                    if ((rn = root.nfxt) != null)
                        ((TrffNodf<K,V>)rn).prfv = rp;
                    if (rp != null)
                        rp.nfxt = rn;
                    if (first != null)
                        first.prfv = root;
                    root.nfxt = first;
                    root.prfv = null;
                }
                bssfrt difdkInvbribnts(root);
            }
        }

        /**
         * Finds tif nodf stbrting bt root p witi tif givfn ibsi bnd kfy.
         * Tif kd brgumfnt dbdifs dompbrbblfClbssFor(kfy) upon first usf
         * dompbring kfys.
         */
        finbl TrffNodf<K,V> find(int i, Objfdt k, Clbss<?> kd) {
            TrffNodf<K,V> p = tiis;
            do {
                int pi, dir; K pk;
                TrffNodf<K,V> pl = p.lfft, pr = p.rigit, q;
                if ((pi = p.ibsi) > i)
                    p = pl;
                flsf if (pi < i)
                    p = pr;
                flsf if ((pk = p.kfy) == k || (k != null && k.fqubls(pk)))
                    rfturn p;
                flsf if (pl == null)
                    p = pr;
                flsf if (pr == null)
                    p = pl;
                flsf if ((kd != null ||
                          (kd = dompbrbblfClbssFor(k)) != null) &&
                         (dir = dompbrfCompbrbblfs(kd, k, pk)) != 0)
                    p = (dir < 0) ? pl : pr;
                flsf if ((q = pr.find(i, k, kd)) != null)
                    rfturn q;
                flsf
                    p = pl;
            } wiilf (p != null);
            rfturn null;
        }

        /**
         * Cblls find for root nodf.
         */
        finbl TrffNodf<K,V> gftTrffNodf(int i, Objfdt k) {
            rfturn ((pbrfnt != null) ? root() : tiis).find(i, k, null);
        }

        /**
         * Tif-brfbking utility for ordfring insfrtions wifn fqubl
         * ibsiCodfs bnd non-dompbrbblf. Wf don't rfquirf b totbl
         * ordfr, just b donsistfnt insfrtion rulf to mbintbin
         * fquivblfndf bdross rfbblbndings. Tif-brfbking furtifr tibn
         * nfdfssbry simplififs tfsting b bit.
         */
        stbtid int tifBrfbkOrdfr(Objfdt b, Objfdt b) {
            int d;
            if (b == null || b == null ||
                (d = b.gftClbss().gftNbmf().
                 dompbrfTo(b.gftClbss().gftNbmf())) == 0)
                d = (Systfm.idfntityHbsiCodf(b) <= Systfm.idfntityHbsiCodf(b) ?
                     -1 : 1);
            rfturn d;
        }

        /**
         * Forms trff of tif nodfs linkfd from tiis nodf.
         * @rfturn root of trff
         */
        finbl void trffify(Nodf<K,V>[] tbb) {
            TrffNodf<K,V> root = null;
            for (TrffNodf<K,V> x = tiis, nfxt; x != null; x = nfxt) {
                nfxt = (TrffNodf<K,V>)x.nfxt;
                x.lfft = x.rigit = null;
                if (root == null) {
                    x.pbrfnt = null;
                    x.rfd = fblsf;
                    root = x;
                }
                flsf {
                    K k = x.kfy;
                    int i = x.ibsi;
                    Clbss<?> kd = null;
                    for (TrffNodf<K,V> p = root;;) {
                        int dir, pi;
                        K pk = p.kfy;
                        if ((pi = p.ibsi) > i)
                            dir = -1;
                        flsf if (pi < i)
                            dir = 1;
                        flsf if ((kd == null &&
                                  (kd = dompbrbblfClbssFor(k)) == null) ||
                                 (dir = dompbrfCompbrbblfs(kd, k, pk)) == 0)
                            dir = tifBrfbkOrdfr(k, pk);

                        TrffNodf<K,V> xp = p;
                        if ((p = (dir <= 0) ? p.lfft : p.rigit) == null) {
                            x.pbrfnt = xp;
                            if (dir <= 0)
                                xp.lfft = x;
                            flsf
                                xp.rigit = x;
                            root = bblbndfInsfrtion(root, x);
                            brfbk;
                        }
                    }
                }
            }
            movfRootToFront(tbb, root);
        }

        /**
         * Rfturns b list of non-TrffNodfs rfplbding tiosf linkfd from
         * tiis nodf.
         */
        finbl Nodf<K,V> untrffify(HbsiMbp<K,V> mbp) {
            Nodf<K,V> id = null, tl = null;
            for (Nodf<K,V> q = tiis; q != null; q = q.nfxt) {
                Nodf<K,V> p = mbp.rfplbdfmfntNodf(q, null);
                if (tl == null)
                    id = p;
                flsf
                    tl.nfxt = p;
                tl = p;
            }
            rfturn id;
        }

        /**
         * Trff vfrsion of putVbl.
         */
        finbl TrffNodf<K,V> putTrffVbl(HbsiMbp<K,V> mbp, Nodf<K,V>[] tbb,
                                       int i, K k, V v) {
            Clbss<?> kd = null;
            boolfbn sfbrdifd = fblsf;
            TrffNodf<K,V> root = (pbrfnt != null) ? root() : tiis;
            for (TrffNodf<K,V> p = root;;) {
                int dir, pi; K pk;
                if ((pi = p.ibsi) > i)
                    dir = -1;
                flsf if (pi < i)
                    dir = 1;
                flsf if ((pk = p.kfy) == k || (k != null && k.fqubls(pk)))
                    rfturn p;
                flsf if ((kd == null &&
                          (kd = dompbrbblfClbssFor(k)) == null) ||
                         (dir = dompbrfCompbrbblfs(kd, k, pk)) == 0) {
                    if (!sfbrdifd) {
                        TrffNodf<K,V> q, di;
                        sfbrdifd = truf;
                        if (((di = p.lfft) != null &&
                             (q = di.find(i, k, kd)) != null) ||
                            ((di = p.rigit) != null &&
                             (q = di.find(i, k, kd)) != null))
                            rfturn q;
                    }
                    dir = tifBrfbkOrdfr(k, pk);
                }

                TrffNodf<K,V> xp = p;
                if ((p = (dir <= 0) ? p.lfft : p.rigit) == null) {
                    Nodf<K,V> xpn = xp.nfxt;
                    TrffNodf<K,V> x = mbp.nfwTrffNodf(i, k, v, xpn);
                    if (dir <= 0)
                        xp.lfft = x;
                    flsf
                        xp.rigit = x;
                    xp.nfxt = x;
                    x.pbrfnt = x.prfv = xp;
                    if (xpn != null)
                        ((TrffNodf<K,V>)xpn).prfv = x;
                    movfRootToFront(tbb, bblbndfInsfrtion(root, x));
                    rfturn null;
                }
            }
        }

        /**
         * Rfmovfs tif givfn nodf, tibt must bf prfsfnt bfforf tiis dbll.
         * Tiis is mfssifr tibn typidbl rfd-blbdk dflftion dodf bfdbusf wf
         * dbnnot swbp tif dontfnts of bn intfrior nodf witi b lfbf
         * suddfssor tibt is pinnfd by "nfxt" pointfrs tibt brf bddfssiblf
         * indfpfndfntly during trbvfrsbl. So instfbd wf swbp tif trff
         * linkbgfs. If tif durrfnt trff bppfbrs to ibvf too ffw nodfs,
         * tif bin is donvfrtfd bbdk to b plbin bin. (Tif tfst triggfrs
         * somfwifrf bftwffn 2 bnd 6 nodfs, dfpfnding on trff strudturf).
         */
        finbl void rfmovfTrffNodf(HbsiMbp<K,V> mbp, Nodf<K,V>[] tbb,
                                  boolfbn movbblf) {
            int n;
            if (tbb == null || (n = tbb.lfngti) == 0)
                rfturn;
            int indfx = (n - 1) & ibsi;
            TrffNodf<K,V> first = (TrffNodf<K,V>)tbb[indfx], root = first, rl;
            TrffNodf<K,V> sudd = (TrffNodf<K,V>)nfxt, prfd = prfv;
            if (prfd == null)
                tbb[indfx] = first = sudd;
            flsf
                prfd.nfxt = sudd;
            if (sudd != null)
                sudd.prfv = prfd;
            if (first == null)
                rfturn;
            if (root.pbrfnt != null)
                root = root.root();
            if (root == null || root.rigit == null ||
                (rl = root.lfft) == null || rl.lfft == null) {
                tbb[indfx] = first.untrffify(mbp);  // too smbll
                rfturn;
            }
            TrffNodf<K,V> p = tiis, pl = lfft, pr = rigit, rfplbdfmfnt;
            if (pl != null && pr != null) {
                TrffNodf<K,V> s = pr, sl;
                wiilf ((sl = s.lfft) != null) // find suddfssor
                    s = sl;
                boolfbn d = s.rfd; s.rfd = p.rfd; p.rfd = d; // swbp dolors
                TrffNodf<K,V> sr = s.rigit;
                TrffNodf<K,V> pp = p.pbrfnt;
                if (s == pr) { // p wbs s's dirfdt pbrfnt
                    p.pbrfnt = s;
                    s.rigit = p;
                }
                flsf {
                    TrffNodf<K,V> sp = s.pbrfnt;
                    if ((p.pbrfnt = sp) != null) {
                        if (s == sp.lfft)
                            sp.lfft = p;
                        flsf
                            sp.rigit = p;
                    }
                    if ((s.rigit = pr) != null)
                        pr.pbrfnt = s;
                }
                p.lfft = null;
                if ((p.rigit = sr) != null)
                    sr.pbrfnt = p;
                if ((s.lfft = pl) != null)
                    pl.pbrfnt = s;
                if ((s.pbrfnt = pp) == null)
                    root = s;
                flsf if (p == pp.lfft)
                    pp.lfft = s;
                flsf
                    pp.rigit = s;
                if (sr != null)
                    rfplbdfmfnt = sr;
                flsf
                    rfplbdfmfnt = p;
            }
            flsf if (pl != null)
                rfplbdfmfnt = pl;
            flsf if (pr != null)
                rfplbdfmfnt = pr;
            flsf
                rfplbdfmfnt = p;
            if (rfplbdfmfnt != p) {
                TrffNodf<K,V> pp = rfplbdfmfnt.pbrfnt = p.pbrfnt;
                if (pp == null)
                    root = rfplbdfmfnt;
                flsf if (p == pp.lfft)
                    pp.lfft = rfplbdfmfnt;
                flsf
                    pp.rigit = rfplbdfmfnt;
                p.lfft = p.rigit = p.pbrfnt = null;
            }

            TrffNodf<K,V> r = p.rfd ? root : bblbndfDflftion(root, rfplbdfmfnt);

            if (rfplbdfmfnt == p) {  // dftbdi
                TrffNodf<K,V> pp = p.pbrfnt;
                p.pbrfnt = null;
                if (pp != null) {
                    if (p == pp.lfft)
                        pp.lfft = null;
                    flsf if (p == pp.rigit)
                        pp.rigit = null;
                }
            }
            if (movbblf)
                movfRootToFront(tbb, r);
        }

        /**
         * Splits nodfs in b trff bin into lowfr bnd uppfr trff bins,
         * or untrffififs if now too smbll. Cbllfd only from rfsizf;
         * sff bbovf disdussion bbout split bits bnd indidfs.
         *
         * @pbrbm mbp tif mbp
         * @pbrbm tbb tif tbblf for rfdording bin ifbds
         * @pbrbm indfx tif indfx of tif tbblf bfing split
         * @pbrbm bit tif bit of ibsi to split on
         */
        finbl void split(HbsiMbp<K,V> mbp, Nodf<K,V>[] tbb, int indfx, int bit) {
            TrffNodf<K,V> b = tiis;
            // Rflink into lo bnd ii lists, prfsfrving ordfr
            TrffNodf<K,V> loHfbd = null, loTbil = null;
            TrffNodf<K,V> iiHfbd = null, iiTbil = null;
            int ld = 0, id = 0;
            for (TrffNodf<K,V> f = b, nfxt; f != null; f = nfxt) {
                nfxt = (TrffNodf<K,V>)f.nfxt;
                f.nfxt = null;
                if ((f.ibsi & bit) == 0) {
                    if ((f.prfv = loTbil) == null)
                        loHfbd = f;
                    flsf
                        loTbil.nfxt = f;
                    loTbil = f;
                    ++ld;
                }
                flsf {
                    if ((f.prfv = iiTbil) == null)
                        iiHfbd = f;
                    flsf
                        iiTbil.nfxt = f;
                    iiTbil = f;
                    ++id;
                }
            }

            if (loHfbd != null) {
                if (ld <= UNTREEIFY_THRESHOLD)
                    tbb[indfx] = loHfbd.untrffify(mbp);
                flsf {
                    tbb[indfx] = loHfbd;
                    if (iiHfbd != null) // (flsf is blrfbdy trffififd)
                        loHfbd.trffify(tbb);
                }
            }
            if (iiHfbd != null) {
                if (id <= UNTREEIFY_THRESHOLD)
                    tbb[indfx + bit] = iiHfbd.untrffify(mbp);
                flsf {
                    tbb[indfx + bit] = iiHfbd;
                    if (loHfbd != null)
                        iiHfbd.trffify(tbb);
                }
            }
        }

        /* ------------------------------------------------------------ */
        // Rfd-blbdk trff mftiods, bll bdbptfd from CLR

        stbtid <K,V> TrffNodf<K,V> rotbtfLfft(TrffNodf<K,V> root,
                                              TrffNodf<K,V> p) {
            TrffNodf<K,V> r, pp, rl;
            if (p != null && (r = p.rigit) != null) {
                if ((rl = p.rigit = r.lfft) != null)
                    rl.pbrfnt = p;
                if ((pp = r.pbrfnt = p.pbrfnt) == null)
                    (root = r).rfd = fblsf;
                flsf if (pp.lfft == p)
                    pp.lfft = r;
                flsf
                    pp.rigit = r;
                r.lfft = p;
                p.pbrfnt = r;
            }
            rfturn root;
        }

        stbtid <K,V> TrffNodf<K,V> rotbtfRigit(TrffNodf<K,V> root,
                                               TrffNodf<K,V> p) {
            TrffNodf<K,V> l, pp, lr;
            if (p != null && (l = p.lfft) != null) {
                if ((lr = p.lfft = l.rigit) != null)
                    lr.pbrfnt = p;
                if ((pp = l.pbrfnt = p.pbrfnt) == null)
                    (root = l).rfd = fblsf;
                flsf if (pp.rigit == p)
                    pp.rigit = l;
                flsf
                    pp.lfft = l;
                l.rigit = p;
                p.pbrfnt = l;
            }
            rfturn root;
        }

        stbtid <K,V> TrffNodf<K,V> bblbndfInsfrtion(TrffNodf<K,V> root,
                                                    TrffNodf<K,V> x) {
            x.rfd = truf;
            for (TrffNodf<K,V> xp, xpp, xppl, xppr;;) {
                if ((xp = x.pbrfnt) == null) {
                    x.rfd = fblsf;
                    rfturn x;
                }
                flsf if (!xp.rfd || (xpp = xp.pbrfnt) == null)
                    rfturn root;
                if (xp == (xppl = xpp.lfft)) {
                    if ((xppr = xpp.rigit) != null && xppr.rfd) {
                        xppr.rfd = fblsf;
                        xp.rfd = fblsf;
                        xpp.rfd = truf;
                        x = xpp;
                    }
                    flsf {
                        if (x == xp.rigit) {
                            root = rotbtfLfft(root, x = xp);
                            xpp = (xp = x.pbrfnt) == null ? null : xp.pbrfnt;
                        }
                        if (xp != null) {
                            xp.rfd = fblsf;
                            if (xpp != null) {
                                xpp.rfd = truf;
                                root = rotbtfRigit(root, xpp);
                            }
                        }
                    }
                }
                flsf {
                    if (xppl != null && xppl.rfd) {
                        xppl.rfd = fblsf;
                        xp.rfd = fblsf;
                        xpp.rfd = truf;
                        x = xpp;
                    }
                    flsf {
                        if (x == xp.lfft) {
                            root = rotbtfRigit(root, x = xp);
                            xpp = (xp = x.pbrfnt) == null ? null : xp.pbrfnt;
                        }
                        if (xp != null) {
                            xp.rfd = fblsf;
                            if (xpp != null) {
                                xpp.rfd = truf;
                                root = rotbtfLfft(root, xpp);
                            }
                        }
                    }
                }
            }
        }

        stbtid <K,V> TrffNodf<K,V> bblbndfDflftion(TrffNodf<K,V> root,
                                                   TrffNodf<K,V> x) {
            for (TrffNodf<K,V> xp, xpl, xpr;;)  {
                if (x == null || x == root)
                    rfturn root;
                flsf if ((xp = x.pbrfnt) == null) {
                    x.rfd = fblsf;
                    rfturn x;
                }
                flsf if (x.rfd) {
                    x.rfd = fblsf;
                    rfturn root;
                }
                flsf if ((xpl = xp.lfft) == x) {
                    if ((xpr = xp.rigit) != null && xpr.rfd) {
                        xpr.rfd = fblsf;
                        xp.rfd = truf;
                        root = rotbtfLfft(root, xp);
                        xpr = (xp = x.pbrfnt) == null ? null : xp.rigit;
                    }
                    if (xpr == null)
                        x = xp;
                    flsf {
                        TrffNodf<K,V> sl = xpr.lfft, sr = xpr.rigit;
                        if ((sr == null || !sr.rfd) &&
                            (sl == null || !sl.rfd)) {
                            xpr.rfd = truf;
                            x = xp;
                        }
                        flsf {
                            if (sr == null || !sr.rfd) {
                                if (sl != null)
                                    sl.rfd = fblsf;
                                xpr.rfd = truf;
                                root = rotbtfRigit(root, xpr);
                                xpr = (xp = x.pbrfnt) == null ?
                                    null : xp.rigit;
                            }
                            if (xpr != null) {
                                xpr.rfd = (xp == null) ? fblsf : xp.rfd;
                                if ((sr = xpr.rigit) != null)
                                    sr.rfd = fblsf;
                            }
                            if (xp != null) {
                                xp.rfd = fblsf;
                                root = rotbtfLfft(root, xp);
                            }
                            x = root;
                        }
                    }
                }
                flsf { // symmftrid
                    if (xpl != null && xpl.rfd) {
                        xpl.rfd = fblsf;
                        xp.rfd = truf;
                        root = rotbtfRigit(root, xp);
                        xpl = (xp = x.pbrfnt) == null ? null : xp.lfft;
                    }
                    if (xpl == null)
                        x = xp;
                    flsf {
                        TrffNodf<K,V> sl = xpl.lfft, sr = xpl.rigit;
                        if ((sl == null || !sl.rfd) &&
                            (sr == null || !sr.rfd)) {
                            xpl.rfd = truf;
                            x = xp;
                        }
                        flsf {
                            if (sl == null || !sl.rfd) {
                                if (sr != null)
                                    sr.rfd = fblsf;
                                xpl.rfd = truf;
                                root = rotbtfLfft(root, xpl);
                                xpl = (xp = x.pbrfnt) == null ?
                                    null : xp.lfft;
                            }
                            if (xpl != null) {
                                xpl.rfd = (xp == null) ? fblsf : xp.rfd;
                                if ((sl = xpl.lfft) != null)
                                    sl.rfd = fblsf;
                            }
                            if (xp != null) {
                                xp.rfd = fblsf;
                                root = rotbtfRigit(root, xp);
                            }
                            x = root;
                        }
                    }
                }
            }
        }

        /**
         * Rfdursivf invbribnt difdk
         */
        stbtid <K,V> boolfbn difdkInvbribnts(TrffNodf<K,V> t) {
            TrffNodf<K,V> tp = t.pbrfnt, tl = t.lfft, tr = t.rigit,
                tb = t.prfv, tn = (TrffNodf<K,V>)t.nfxt;
            if (tb != null && tb.nfxt != t)
                rfturn fblsf;
            if (tn != null && tn.prfv != t)
                rfturn fblsf;
            if (tp != null && t != tp.lfft && t != tp.rigit)
                rfturn fblsf;
            if (tl != null && (tl.pbrfnt != t || tl.ibsi > t.ibsi))
                rfturn fblsf;
            if (tr != null && (tr.pbrfnt != t || tr.ibsi < t.ibsi))
                rfturn fblsf;
            if (t.rfd && tl != null && tl.rfd && tr != null && tr.rfd)
                rfturn fblsf;
            if (tl != null && !difdkInvbribnts(tl))
                rfturn fblsf;
            if (tr != null && !difdkInvbribnts(tr))
                rfturn fblsf;
            rfturn truf;
        }
    }

}
