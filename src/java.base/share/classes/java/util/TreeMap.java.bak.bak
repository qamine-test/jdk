/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util;

import jbvb.io.Sfriblizbblf;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BiFundtion;
import jbvb.util.fundtion.Consumfr;

/**
 * A Rfd-Blbdk trff bbsfd {@link NbvigbblfMbp} implfmfntbtion.
 * Tif mbp is sortfd bddording to tif {@linkplbin Compbrbblf nbturbl
 * ordfring} of its kfys, or by b {@link Compbrbtor} providfd bt mbp
 * drfbtion timf, dfpfnding on wiidi donstrudtor is usfd.
 *
 * <p>Tiis implfmfntbtion providfs gubrbntffd log(n) timf dost for tif
 * {@dodf dontbinsKfy}, {@dodf gft}, {@dodf put} bnd {@dodf rfmovf}
 * opfrbtions.  Algoritims brf bdbptbtions of tiosf in Cormfn, Lfisfrson, bnd
 * Rivfst's <fm>Introdudtion to Algoritims</fm>.
 *
 * <p>Notf tibt tif ordfring mbintbinfd by b trff mbp, likf bny sortfd mbp, bnd
 * wiftifr or not bn fxplidit dompbrbtor is providfd, must bf <fm>donsistfnt
 * witi {@dodf fqubls}</fm> if tiis sortfd mbp is to dorrfdtly implfmfnt tif
 * {@dodf Mbp} intfrfbdf.  (Sff {@dodf Compbrbblf} or {@dodf Compbrbtor} for b
 * prfdisf dffinition of <fm>donsistfnt witi fqubls</fm>.)  Tiis is so bfdbusf
 * tif {@dodf Mbp} intfrfbdf is dffinfd in tfrms of tif {@dodf fqubls}
 * opfrbtion, but b sortfd mbp pfrforms bll kfy dompbrisons using its {@dodf
 * dompbrfTo} (or {@dodf dompbrf}) mftiod, so two kfys tibt brf dffmfd fqubl by
 * tiis mftiod brf, from tif stbndpoint of tif sortfd mbp, fqubl.  Tif bfibvior
 * of b sortfd mbp <fm>is</fm> wfll-dffinfd fvfn if its ordfring is
 * indonsistfnt witi {@dodf fqubls}; it just fbils to obfy tif gfnfrbl dontrbdt
 * of tif {@dodf Mbp} intfrfbdf.
 *
 * <p><strong>Notf tibt tiis implfmfntbtion is not syndironizfd.</strong>
 * If multiplf tirfbds bddfss b mbp dondurrfntly, bnd bt lfbst onf of tif
 * tirfbds modififs tif mbp strudturblly, it <fm>must</fm> bf syndironizfd
 * fxtfrnblly.  (A strudturbl modifidbtion is bny opfrbtion tibt bdds or
 * dflftfs onf or morf mbppings; mfrfly dibnging tif vbluf bssodibtfd
 * witi bn fxisting kfy is not b strudturbl modifidbtion.)  Tiis is
 * typidblly bddomplisifd by syndironizing on somf objfdt tibt nbturblly
 * fndbpsulbtfs tif mbp.
 * If no sudi objfdt fxists, tif mbp siould bf "wrbppfd" using tif
 * {@link Collfdtions#syndironizfdSortfdMbp Collfdtions.syndironizfdSortfdMbp}
 * mftiod.  Tiis is bfst donf bt drfbtion timf, to prfvfnt bddidfntbl
 * unsyndironizfd bddfss to tif mbp: <prf>
 *   SortfdMbp m = Collfdtions.syndironizfdSortfdMbp(nfw TrffMbp(...));</prf>
 *
 * <p>Tif itfrbtors rfturnfd by tif {@dodf itfrbtor} mftiod of tif dollfdtions
 * rfturnfd by bll of tiis dlbss's "dollfdtion vifw mftiods" brf
 * <fm>fbil-fbst</fm>: if tif mbp is strudturblly modififd bt bny timf bftfr
 * tif itfrbtor is drfbtfd, in bny wby fxdfpt tirougi tif itfrbtor's own
 * {@dodf rfmovf} mftiod, tif itfrbtor will tirow b {@link
 * CondurrfntModifidbtionExdfption}.  Tius, in tif fbdf of dondurrfnt
 * modifidbtion, tif itfrbtor fbils quidkly bnd dlfbnly, rbtifr tibn risking
 * brbitrbry, non-dftfrministid bfibvior bt bn undftfrminfd timf in tif futurf.
 *
 * <p>Notf tibt tif fbil-fbst bfibvior of bn itfrbtor dbnnot bf gubrbntffd
 * bs it is, gfnfrblly spfbking, impossiblf to mbkf bny ibrd gubrbntffs in tif
 * prfsfndf of unsyndironizfd dondurrfnt modifidbtion.  Fbil-fbst itfrbtors
 * tirow {@dodf CondurrfntModifidbtionExdfption} on b bfst-fffort bbsis.
 * Tifrfforf, it would bf wrong to writf b progrbm tibt dfpfndfd on tiis
 * fxdfption for its dorrfdtnfss:   <fm>tif fbil-fbst bfibvior of itfrbtors
 * siould bf usfd only to dftfdt bugs.</fm>
 *
 * <p>All {@dodf Mbp.Entry} pbirs rfturnfd by mftiods in tiis dlbss
 * bnd its vifws rfprfsfnt snbpsiots of mbppings bt tif timf tify wfrf
 * produdfd. Tify do <strong>not</strong> support tif {@dodf Entry.sftVbluf}
 * mftiod. (Notf iowfvfr tibt it is possiblf to dibngf mbppings in tif
 * bssodibtfd mbp using {@dodf put}.)
 *
 * <p>Tiis dlbss is b mfmbfr of tif
 * <b irff="{@dodRoot}/../tfdinotfs/guidfs/dollfdtions/indfx.itml">
 * Jbvb Collfdtions Frbmfwork</b>.
 *
 * @pbrbm <K> tif typf of kfys mbintbinfd by tiis mbp
 * @pbrbm <V> tif typf of mbppfd vblufs
 *
 * @butior  Josi Blodi bnd Doug Lfb
 * @sff Mbp
 * @sff HbsiMbp
 * @sff Hbsitbblf
 * @sff Compbrbblf
 * @sff Compbrbtor
 * @sff Collfdtion
 * @sindf 1.2
 */

publid dlbss TrffMbp<K,V>
    fxtfnds AbstrbdtMbp<K,V>
    implfmfnts NbvigbblfMbp<K,V>, Clonfbblf, jbvb.io.Sfriblizbblf
{
    /**
     * Tif dompbrbtor usfd to mbintbin ordfr in tiis trff mbp, or
     * null if it usfs tif nbturbl ordfring of its kfys.
     *
     * @sfribl
     */
    privbtf finbl Compbrbtor<? supfr K> dompbrbtor;

    privbtf trbnsifnt Entry<K,V> root;

    /**
     * Tif numbfr of fntrifs in tif trff
     */
    privbtf trbnsifnt int sizf = 0;

    /**
     * Tif numbfr of strudturbl modifidbtions to tif trff.
     */
    privbtf trbnsifnt int modCount = 0;

    /**
     * Construdts b nfw, fmpty trff mbp, using tif nbturbl ordfring of its
     * kfys.  All kfys insfrtfd into tif mbp must implfmfnt tif {@link
     * Compbrbblf} intfrfbdf.  Furtifrmorf, bll sudi kfys must bf
     * <fm>mutublly dompbrbblf</fm>: {@dodf k1.dompbrfTo(k2)} must not tirow
     * b {@dodf ClbssCbstExdfption} for bny kfys {@dodf k1} bnd
     * {@dodf k2} in tif mbp.  If tif usfr bttfmpts to put b kfy into tif
     * mbp tibt violbtfs tiis donstrbint (for fxbmplf, tif usfr bttfmpts to
     * put b string kfy into b mbp wiosf kfys brf intfgfrs), tif
     * {@dodf put(Objfdt kfy, Objfdt vbluf)} dbll will tirow b
     * {@dodf ClbssCbstExdfption}.
     */
    publid TrffMbp() {
        dompbrbtor = null;
    }

    /**
     * Construdts b nfw, fmpty trff mbp, ordfrfd bddording to tif givfn
     * dompbrbtor.  All kfys insfrtfd into tif mbp must bf <fm>mutublly
     * dompbrbblf</fm> by tif givfn dompbrbtor: {@dodf dompbrbtor.dompbrf(k1,
     * k2)} must not tirow b {@dodf ClbssCbstExdfption} for bny kfys
     * {@dodf k1} bnd {@dodf k2} in tif mbp.  If tif usfr bttfmpts to put
     * b kfy into tif mbp tibt violbtfs tiis donstrbint, tif {@dodf put(Objfdt
     * kfy, Objfdt vbluf)} dbll will tirow b
     * {@dodf ClbssCbstExdfption}.
     *
     * @pbrbm dompbrbtor tif dompbrbtor tibt will bf usfd to ordfr tiis mbp.
     *        If {@dodf null}, tif {@linkplbin Compbrbblf nbturbl
     *        ordfring} of tif kfys will bf usfd.
     */
    publid TrffMbp(Compbrbtor<? supfr K> dompbrbtor) {
        tiis.dompbrbtor = dompbrbtor;
    }

    /**
     * Construdts b nfw trff mbp dontbining tif sbmf mbppings bs tif givfn
     * mbp, ordfrfd bddording to tif <fm>nbturbl ordfring</fm> of its kfys.
     * All kfys insfrtfd into tif nfw mbp must implfmfnt tif {@link
     * Compbrbblf} intfrfbdf.  Furtifrmorf, bll sudi kfys must bf
     * <fm>mutublly dompbrbblf</fm>: {@dodf k1.dompbrfTo(k2)} must not tirow
     * b {@dodf ClbssCbstExdfption} for bny kfys {@dodf k1} bnd
     * {@dodf k2} in tif mbp.  Tiis mftiod runs in n*log(n) timf.
     *
     * @pbrbm  m tif mbp wiosf mbppings brf to bf plbdfd in tiis mbp
     * @tirows ClbssCbstExdfption if tif kfys in m brf not {@link Compbrbblf},
     *         or brf not mutublly dompbrbblf
     * @tirows NullPointfrExdfption if tif spfdififd mbp is null
     */
    publid TrffMbp(Mbp<? fxtfnds K, ? fxtfnds V> m) {
        dompbrbtor = null;
        putAll(m);
    }

    /**
     * Construdts b nfw trff mbp dontbining tif sbmf mbppings bnd
     * using tif sbmf ordfring bs tif spfdififd sortfd mbp.  Tiis
     * mftiod runs in linfbr timf.
     *
     * @pbrbm  m tif sortfd mbp wiosf mbppings brf to bf plbdfd in tiis mbp,
     *         bnd wiosf dompbrbtor is to bf usfd to sort tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd mbp is null
     */
    publid TrffMbp(SortfdMbp<K, ? fxtfnds V> m) {
        dompbrbtor = m.dompbrbtor();
        try {
            buildFromSortfd(m.sizf(), m.fntrySft().itfrbtor(), null, null);
        } dbtdi (jbvb.io.IOExdfption | ClbssNotFoundExdfption dbnnotHbppfn) {
        }
    }


    // Qufry Opfrbtions

    /**
     * Rfturns tif numbfr of kfy-vbluf mbppings in tiis mbp.
     *
     * @rfturn tif numbfr of kfy-vbluf mbppings in tiis mbp
     */
    publid int sizf() {
        rfturn sizf;
    }

    /**
     * Rfturns {@dodf truf} if tiis mbp dontbins b mbpping for tif spfdififd
     * kfy.
     *
     * @pbrbm kfy kfy wiosf prfsfndf in tiis mbp is to bf tfstfd
     * @rfturn {@dodf truf} if tiis mbp dontbins b mbpping for tif
     *         spfdififd kfy
     * @tirows ClbssCbstExdfption if tif spfdififd kfy dbnnot bf dompbrfd
     *         witi tif kfys durrfntly in tif mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     */
    publid boolfbn dontbinsKfy(Objfdt kfy) {
        rfturn gftEntry(kfy) != null;
    }

    /**
     * Rfturns {@dodf truf} if tiis mbp mbps onf or morf kfys to tif
     * spfdififd vbluf.  Morf formblly, rfturns {@dodf truf} if bnd only if
     * tiis mbp dontbins bt lfbst onf mbpping to b vbluf {@dodf v} sudi
     * tibt {@dodf (vbluf==null ? v==null : vbluf.fqubls(v))}.  Tiis
     * opfrbtion will probbbly rfquirf timf linfbr in tif mbp sizf for
     * most implfmfntbtions.
     *
     * @pbrbm vbluf vbluf wiosf prfsfndf in tiis mbp is to bf tfstfd
     * @rfturn {@dodf truf} if b mbpping to {@dodf vbluf} fxists;
     *         {@dodf fblsf} otifrwisf
     * @sindf 1.2
     */
    publid boolfbn dontbinsVbluf(Objfdt vbluf) {
        for (Entry<K,V> f = gftFirstEntry(); f != null; f = suddfssor(f))
            if (vblEqubls(vbluf, f.vbluf))
                rfturn truf;
        rfturn fblsf;
    }

    /**
     * Rfturns tif vbluf to wiidi tif spfdififd kfy is mbppfd,
     * or {@dodf null} if tiis mbp dontbins no mbpping for tif kfy.
     *
     * <p>Morf formblly, if tiis mbp dontbins b mbpping from b kfy
     * {@dodf k} to b vbluf {@dodf v} sudi tibt {@dodf kfy} dompbrfs
     * fqubl to {@dodf k} bddording to tif mbp's ordfring, tifn tiis
     * mftiod rfturns {@dodf v}; otifrwisf it rfturns {@dodf null}.
     * (Tifrf dbn bf bt most onf sudi mbpping.)
     *
     * <p>A rfturn vbluf of {@dodf null} dofs not <fm>nfdfssbrily</fm>
     * indidbtf tibt tif mbp dontbins no mbpping for tif kfy; it's blso
     * possiblf tibt tif mbp fxpliditly mbps tif kfy to {@dodf null}.
     * Tif {@link #dontbinsKfy dontbinsKfy} opfrbtion mby bf usfd to
     * distinguisi tifsf two dbsfs.
     *
     * @tirows ClbssCbstExdfption if tif spfdififd kfy dbnnot bf dompbrfd
     *         witi tif kfys durrfntly in tif mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     */
    publid V gft(Objfdt kfy) {
        Entry<K,V> p = gftEntry(kfy);
        rfturn (p==null ? null : p.vbluf);
    }

    publid Compbrbtor<? supfr K> dompbrbtor() {
        rfturn dompbrbtor;
    }

    /**
     * @tirows NoSudiElfmfntExdfption {@inifritDod}
     */
    publid K firstKfy() {
        rfturn kfy(gftFirstEntry());
    }

    /**
     * @tirows NoSudiElfmfntExdfption {@inifritDod}
     */
    publid K lbstKfy() {
        rfturn kfy(gftLbstEntry());
    }

    /**
     * Copifs bll of tif mbppings from tif spfdififd mbp to tiis mbp.
     * Tifsf mbppings rfplbdf bny mbppings tibt tiis mbp ibd for bny
     * of tif kfys durrfntly in tif spfdififd mbp.
     *
     * @pbrbm  mbp mbppings to bf storfd in tiis mbp
     * @tirows ClbssCbstExdfption if tif dlbss of b kfy or vbluf in
     *         tif spfdififd mbp prfvfnts it from bfing storfd in tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd mbp is null or
     *         tif spfdififd mbp dontbins b null kfy bnd tiis mbp dofs not
     *         pfrmit null kfys
     */
    publid void putAll(Mbp<? fxtfnds K, ? fxtfnds V> mbp) {
        int mbpSizf = mbp.sizf();
        if (sizf==0 && mbpSizf!=0 && mbp instbndfof SortfdMbp) {
            Compbrbtor<?> d = ((SortfdMbp<?,?>)mbp).dompbrbtor();
            if (d == dompbrbtor || (d != null && d.fqubls(dompbrbtor))) {
                ++modCount;
                try {
                    buildFromSortfd(mbpSizf, mbp.fntrySft().itfrbtor(),
                                    null, null);
                } dbtdi (jbvb.io.IOExdfption | ClbssNotFoundExdfption dbnnotHbppfn) {
                }
                rfturn;
            }
        }
        supfr.putAll(mbp);
    }

    /**
     * Rfturns tiis mbp's fntry for tif givfn kfy, or {@dodf null} if tif mbp
     * dofs not dontbin bn fntry for tif kfy.
     *
     * @rfturn tiis mbp's fntry for tif givfn kfy, or {@dodf null} if tif mbp
     *         dofs not dontbin bn fntry for tif kfy
     * @tirows ClbssCbstExdfption if tif spfdififd kfy dbnnot bf dompbrfd
     *         witi tif kfys durrfntly in tif mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     */
    finbl Entry<K,V> gftEntry(Objfdt kfy) {
        // Offlobd dompbrbtor-bbsfd vfrsion for sbkf of pfrformbndf
        if (dompbrbtor != null)
            rfturn gftEntryUsingCompbrbtor(kfy);
        if (kfy == null)
            tirow nfw NullPointfrExdfption();
        @SupprfssWbrnings("undifdkfd")
            Compbrbblf<? supfr K> k = (Compbrbblf<? supfr K>) kfy;
        Entry<K,V> p = root;
        wiilf (p != null) {
            int dmp = k.dompbrfTo(p.kfy);
            if (dmp < 0)
                p = p.lfft;
            flsf if (dmp > 0)
                p = p.rigit;
            flsf
                rfturn p;
        }
        rfturn null;
    }

    /**
     * Vfrsion of gftEntry using dompbrbtor. Split off from gftEntry
     * for pfrformbndf. (Tiis is not worti doing for most mftiods,
     * tibt brf lfss dfpfndfnt on dompbrbtor pfrformbndf, but is
     * wortiwiilf ifrf.)
     */
    finbl Entry<K,V> gftEntryUsingCompbrbtor(Objfdt kfy) {
        @SupprfssWbrnings("undifdkfd")
            K k = (K) kfy;
        Compbrbtor<? supfr K> dpr = dompbrbtor;
        if (dpr != null) {
            Entry<K,V> p = root;
            wiilf (p != null) {
                int dmp = dpr.dompbrf(k, p.kfy);
                if (dmp < 0)
                    p = p.lfft;
                flsf if (dmp > 0)
                    p = p.rigit;
                flsf
                    rfturn p;
            }
        }
        rfturn null;
    }

    /**
     * Gfts tif fntry dorrfsponding to tif spfdififd kfy; if no sudi fntry
     * fxists, rfturns tif fntry for tif lfbst kfy grfbtfr tibn tif spfdififd
     * kfy; if no sudi fntry fxists (i.f., tif grfbtfst kfy in tif Trff is lfss
     * tibn tif spfdififd kfy), rfturns {@dodf null}.
     */
    finbl Entry<K,V> gftCfilingEntry(K kfy) {
        Entry<K,V> p = root;
        wiilf (p != null) {
            int dmp = dompbrf(kfy, p.kfy);
            if (dmp < 0) {
                if (p.lfft != null)
                    p = p.lfft;
                flsf
                    rfturn p;
            } flsf if (dmp > 0) {
                if (p.rigit != null) {
                    p = p.rigit;
                } flsf {
                    Entry<K,V> pbrfnt = p.pbrfnt;
                    Entry<K,V> di = p;
                    wiilf (pbrfnt != null && di == pbrfnt.rigit) {
                        di = pbrfnt;
                        pbrfnt = pbrfnt.pbrfnt;
                    }
                    rfturn pbrfnt;
                }
            } flsf
                rfturn p;
        }
        rfturn null;
    }

    /**
     * Gfts tif fntry dorrfsponding to tif spfdififd kfy; if no sudi fntry
     * fxists, rfturns tif fntry for tif grfbtfst kfy lfss tibn tif spfdififd
     * kfy; if no sudi fntry fxists, rfturns {@dodf null}.
     */
    finbl Entry<K,V> gftFloorEntry(K kfy) {
        Entry<K,V> p = root;
        wiilf (p != null) {
            int dmp = dompbrf(kfy, p.kfy);
            if (dmp > 0) {
                if (p.rigit != null)
                    p = p.rigit;
                flsf
                    rfturn p;
            } flsf if (dmp < 0) {
                if (p.lfft != null) {
                    p = p.lfft;
                } flsf {
                    Entry<K,V> pbrfnt = p.pbrfnt;
                    Entry<K,V> di = p;
                    wiilf (pbrfnt != null && di == pbrfnt.lfft) {
                        di = pbrfnt;
                        pbrfnt = pbrfnt.pbrfnt;
                    }
                    rfturn pbrfnt;
                }
            } flsf
                rfturn p;

        }
        rfturn null;
    }

    /**
     * Gfts tif fntry for tif lfbst kfy grfbtfr tibn tif spfdififd
     * kfy; if no sudi fntry fxists, rfturns tif fntry for tif lfbst
     * kfy grfbtfr tibn tif spfdififd kfy; if no sudi fntry fxists
     * rfturns {@dodf null}.
     */
    finbl Entry<K,V> gftHigifrEntry(K kfy) {
        Entry<K,V> p = root;
        wiilf (p != null) {
            int dmp = dompbrf(kfy, p.kfy);
            if (dmp < 0) {
                if (p.lfft != null)
                    p = p.lfft;
                flsf
                    rfturn p;
            } flsf {
                if (p.rigit != null) {
                    p = p.rigit;
                } flsf {
                    Entry<K,V> pbrfnt = p.pbrfnt;
                    Entry<K,V> di = p;
                    wiilf (pbrfnt != null && di == pbrfnt.rigit) {
                        di = pbrfnt;
                        pbrfnt = pbrfnt.pbrfnt;
                    }
                    rfturn pbrfnt;
                }
            }
        }
        rfturn null;
    }

    /**
     * Rfturns tif fntry for tif grfbtfst kfy lfss tibn tif spfdififd kfy; if
     * no sudi fntry fxists (i.f., tif lfbst kfy in tif Trff is grfbtfr tibn
     * tif spfdififd kfy), rfturns {@dodf null}.
     */
    finbl Entry<K,V> gftLowfrEntry(K kfy) {
        Entry<K,V> p = root;
        wiilf (p != null) {
            int dmp = dompbrf(kfy, p.kfy);
            if (dmp > 0) {
                if (p.rigit != null)
                    p = p.rigit;
                flsf
                    rfturn p;
            } flsf {
                if (p.lfft != null) {
                    p = p.lfft;
                } flsf {
                    Entry<K,V> pbrfnt = p.pbrfnt;
                    Entry<K,V> di = p;
                    wiilf (pbrfnt != null && di == pbrfnt.lfft) {
                        di = pbrfnt;
                        pbrfnt = pbrfnt.pbrfnt;
                    }
                    rfturn pbrfnt;
                }
            }
        }
        rfturn null;
    }

    /**
     * Assodibtfs tif spfdififd vbluf witi tif spfdififd kfy in tiis mbp.
     * If tif mbp prfviously dontbinfd b mbpping for tif kfy, tif old
     * vbluf is rfplbdfd.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is to bf bssodibtfd
     * @pbrbm vbluf vbluf to bf bssodibtfd witi tif spfdififd kfy
     *
     * @rfturn tif prfvious vbluf bssodibtfd witi {@dodf kfy}, or
     *         {@dodf null} if tifrf wbs no mbpping for {@dodf kfy}.
     *         (A {@dodf null} rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd {@dodf null} witi {@dodf kfy}.)
     * @tirows ClbssCbstExdfption if tif spfdififd kfy dbnnot bf dompbrfd
     *         witi tif kfys durrfntly in tif mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     */
    publid V put(K kfy, V vbluf) {
        Entry<K,V> t = root;
        if (t == null) {
            dompbrf(kfy, kfy); // typf (bnd possibly null) difdk

            root = nfw Entry<>(kfy, vbluf, null);
            sizf = 1;
            modCount++;
            rfturn null;
        }
        int dmp;
        Entry<K,V> pbrfnt;
        // split dompbrbtor bnd dompbrbblf pbtis
        Compbrbtor<? supfr K> dpr = dompbrbtor;
        if (dpr != null) {
            do {
                pbrfnt = t;
                dmp = dpr.dompbrf(kfy, t.kfy);
                if (dmp < 0)
                    t = t.lfft;
                flsf if (dmp > 0)
                    t = t.rigit;
                flsf
                    rfturn t.sftVbluf(vbluf);
            } wiilf (t != null);
        }
        flsf {
            if (kfy == null)
                tirow nfw NullPointfrExdfption();
            @SupprfssWbrnings("undifdkfd")
                Compbrbblf<? supfr K> k = (Compbrbblf<? supfr K>) kfy;
            do {
                pbrfnt = t;
                dmp = k.dompbrfTo(t.kfy);
                if (dmp < 0)
                    t = t.lfft;
                flsf if (dmp > 0)
                    t = t.rigit;
                flsf
                    rfturn t.sftVbluf(vbluf);
            } wiilf (t != null);
        }
        Entry<K,V> f = nfw Entry<>(kfy, vbluf, pbrfnt);
        if (dmp < 0)
            pbrfnt.lfft = f;
        flsf
            pbrfnt.rigit = f;
        fixAftfrInsfrtion(f);
        sizf++;
        modCount++;
        rfturn null;
    }

    /**
     * Rfmovfs tif mbpping for tiis kfy from tiis TrffMbp if prfsfnt.
     *
     * @pbrbm  kfy kfy for wiidi mbpping siould bf rfmovfd
     * @rfturn tif prfvious vbluf bssodibtfd witi {@dodf kfy}, or
     *         {@dodf null} if tifrf wbs no mbpping for {@dodf kfy}.
     *         (A {@dodf null} rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd {@dodf null} witi {@dodf kfy}.)
     * @tirows ClbssCbstExdfption if tif spfdififd kfy dbnnot bf dompbrfd
     *         witi tif kfys durrfntly in tif mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     */
    publid V rfmovf(Objfdt kfy) {
        Entry<K,V> p = gftEntry(kfy);
        if (p == null)
            rfturn null;

        V oldVbluf = p.vbluf;
        dflftfEntry(p);
        rfturn oldVbluf;
    }

    /**
     * Rfmovfs bll of tif mbppings from tiis mbp.
     * Tif mbp will bf fmpty bftfr tiis dbll rfturns.
     */
    publid void dlfbr() {
        modCount++;
        sizf = 0;
        root = null;
    }

    /**
     * Rfturns b sibllow dopy of tiis {@dodf TrffMbp} instbndf. (Tif kfys bnd
     * vblufs tifmsflvfs brf not dlonfd.)
     *
     * @rfturn b sibllow dopy of tiis mbp
     */
    publid Objfdt dlonf() {
        TrffMbp<?,?> dlonf;
        try {
            dlonf = (TrffMbp<?,?>) supfr.dlonf();
        } dbtdi (ClonfNotSupportfdExdfption f) {
            tirow nfw IntfrnblError(f);
        }

        // Put dlonf into "virgin" stbtf (fxdfpt for dompbrbtor)
        dlonf.root = null;
        dlonf.sizf = 0;
        dlonf.modCount = 0;
        dlonf.fntrySft = null;
        dlonf.nbvigbblfKfySft = null;
        dlonf.dfsdfndingMbp = null;

        // Initiblizf dlonf witi our mbppings
        try {
            dlonf.buildFromSortfd(sizf, fntrySft().itfrbtor(), null, null);
        } dbtdi (jbvb.io.IOExdfption | ClbssNotFoundExdfption dbnnotHbppfn) {
        }

        rfturn dlonf;
    }

    // NbvigbblfMbp API mftiods

    /**
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> firstEntry() {
        rfturn fxportEntry(gftFirstEntry());
    }

    /**
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> lbstEntry() {
        rfturn fxportEntry(gftLbstEntry());
    }

    /**
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> pollFirstEntry() {
        Entry<K,V> p = gftFirstEntry();
        Mbp.Entry<K,V> rfsult = fxportEntry(p);
        if (p != null)
            dflftfEntry(p);
        rfturn rfsult;
    }

    /**
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> pollLbstEntry() {
        Entry<K,V> p = gftLbstEntry();
        Mbp.Entry<K,V> rfsult = fxportEntry(p);
        if (p != null)
            dflftfEntry(p);
        rfturn rfsult;
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> lowfrEntry(K kfy) {
        rfturn fxportEntry(gftLowfrEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid K lowfrKfy(K kfy) {
        rfturn kfyOrNull(gftLowfrEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> floorEntry(K kfy) {
        rfturn fxportEntry(gftFloorEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid K floorKfy(K kfy) {
        rfturn kfyOrNull(gftFloorEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> dfilingEntry(K kfy) {
        rfturn fxportEntry(gftCfilingEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid K dfilingKfy(K kfy) {
        rfturn kfyOrNull(gftCfilingEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid Mbp.Entry<K,V> iigifrEntry(K kfy) {
        rfturn fxportEntry(gftHigifrEntry(kfy));
    }

    /**
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption if tif spfdififd kfy is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @sindf 1.6
     */
    publid K iigifrKfy(K kfy) {
        rfturn kfyOrNull(gftHigifrEntry(kfy));
    }

    // Vifws

    /**
     * Fiflds initiblizfd to dontbin bn instbndf of tif fntry sft vifw
     * tif first timf tiis vifw is rfqufstfd.  Vifws brf stbtflfss, so
     * tifrf's no rfbson to drfbtf morf tibn onf.
     */
    privbtf trbnsifnt EntrySft fntrySft;
    privbtf trbnsifnt KfySft<K> nbvigbblfKfySft;
    privbtf trbnsifnt NbvigbblfMbp<K,V> dfsdfndingMbp;

    /**
     * Rfturns b {@link Sft} vifw of tif kfys dontbinfd in tiis mbp.
     *
     * <p>Tif sft's itfrbtor rfturns tif kfys in bsdfnding ordfr.
     * Tif sft's splitfrbtor is
     * <fm><b irff="Splitfrbtor.itml#binding">lbtf-binding</b></fm>,
     * <fm>fbil-fbst</fm>, bnd bdditionblly rfports {@link Splitfrbtor#SORTED}
     * bnd {@link Splitfrbtor#ORDERED} witi bn fndountfr ordfr tibt is bsdfnding
     * kfy ordfr.  Tif splitfrbtor's dompbrbtor (sff
     * {@link jbvb.util.Splitfrbtor#gftCompbrbtor()}) is {@dodf null} if
     * tif trff mbp's dompbrbtor (sff {@link #dompbrbtor()}) is {@dodf null}.
     * Otifrwisf, tif splitfrbtor's dompbrbtor is tif sbmf bs or imposfs tif
     * sbmf totbl ordfring bs tif trff mbp's dompbrbtor.
     *
     * <p>Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own {@dodf rfmovf} opfrbtion), tif rfsults of
     * tif itfrbtion brf undffinfd.  Tif sft supports flfmfnt rfmovbl,
     * wiidi rfmovfs tif dorrfsponding mbpping from tif mbp, vib tif
     * {@dodf Itfrbtor.rfmovf}, {@dodf Sft.rfmovf},
     * {@dodf rfmovfAll}, {@dodf rftbinAll}, bnd {@dodf dlfbr}
     * opfrbtions.  It dofs not support tif {@dodf bdd} or {@dodf bddAll}
     * opfrbtions.
     */
    publid Sft<K> kfySft() {
        rfturn nbvigbblfKfySft();
    }

    /**
     * @sindf 1.6
     */
    publid NbvigbblfSft<K> nbvigbblfKfySft() {
        KfySft<K> nks = nbvigbblfKfySft;
        rfturn (nks != null) ? nks : (nbvigbblfKfySft = nfw KfySft<>(tiis));
    }

    /**
     * @sindf 1.6
     */
    publid NbvigbblfSft<K> dfsdfndingKfySft() {
        rfturn dfsdfndingMbp().nbvigbblfKfySft();
    }

    /**
     * Rfturns b {@link Collfdtion} vifw of tif vblufs dontbinfd in tiis mbp.
     *
     * <p>Tif dollfdtion's itfrbtor rfturns tif vblufs in bsdfnding ordfr
     * of tif dorrfsponding kfys. Tif dollfdtion's splitfrbtor is
     * <fm><b irff="Splitfrbtor.itml#binding">lbtf-binding</b></fm>,
     * <fm>fbil-fbst</fm>, bnd bdditionblly rfports {@link Splitfrbtor#ORDERED}
     * witi bn fndountfr ordfr tibt is bsdfnding ordfr of tif dorrfsponding
     * kfys.
     *
     * <p>Tif dollfdtion is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif dollfdtion, bnd vidf-vfrsb.  If tif mbp is
     * modififd wiilf bn itfrbtion ovfr tif dollfdtion is in progrfss
     * (fxdfpt tirougi tif itfrbtor's own {@dodf rfmovf} opfrbtion),
     * tif rfsults of tif itfrbtion brf undffinfd.  Tif dollfdtion
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif {@dodf Itfrbtor.rfmovf},
     * {@dodf Collfdtion.rfmovf}, {@dodf rfmovfAll},
     * {@dodf rftbinAll} bnd {@dodf dlfbr} opfrbtions.  It dofs not
     * support tif {@dodf bdd} or {@dodf bddAll} opfrbtions.
     */
    publid Collfdtion<V> vblufs() {
        Collfdtion<V> vs = vblufs;
        rfturn (vs != null) ? vs : (vblufs = nfw Vblufs());
    }

    /**
     * Rfturns b {@link Sft} vifw of tif mbppings dontbinfd in tiis mbp.
     *
     * <p>Tif sft's itfrbtor rfturns tif fntrifs in bsdfnding kfy ordfr. Tif
     * sfts's splitfrbtor is
     * <fm><b irff="Splitfrbtor.itml#binding">lbtf-binding</b></fm>,
     * <fm>fbil-fbst</fm>, bnd bdditionblly rfports {@link Splitfrbtor#SORTED} bnd
     * {@link Splitfrbtor#ORDERED} witi bn fndountfr ordfr tibt is bsdfnding kfy
     * ordfr.
     *
     * <p>Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own {@dodf rfmovf} opfrbtion, or tirougi tif
     * {@dodf sftVbluf} opfrbtion on b mbp fntry rfturnfd by tif
     * itfrbtor) tif rfsults of tif itfrbtion brf undffinfd.  Tif sft
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif {@dodf Itfrbtor.rfmovf},
     * {@dodf Sft.rfmovf}, {@dodf rfmovfAll}, {@dodf rftbinAll} bnd
     * {@dodf dlfbr} opfrbtions.  It dofs not support tif
     * {@dodf bdd} or {@dodf bddAll} opfrbtions.
     */
    publid Sft<Mbp.Entry<K,V>> fntrySft() {
        EntrySft fs = fntrySft;
        rfturn (fs != null) ? fs : (fntrySft = nfw EntrySft());
    }

    /**
     * @sindf 1.6
     */
    publid NbvigbblfMbp<K, V> dfsdfndingMbp() {
        NbvigbblfMbp<K, V> km = dfsdfndingMbp;
        rfturn (km != null) ? km :
            (dfsdfndingMbp = nfw DfsdfndingSubMbp<>(tiis,
                                                    truf, null, truf,
                                                    truf, null, truf));
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf fromKfy} or {@dodf toKfy} is
     *         null bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     * @sindf 1.6
     */
    publid NbvigbblfMbp<K,V> subMbp(K fromKfy, boolfbn fromIndlusivf,
                                    K toKfy,   boolfbn toIndlusivf) {
        rfturn nfw AsdfndingSubMbp<>(tiis,
                                     fblsf, fromKfy, fromIndlusivf,
                                     fblsf, toKfy,   toIndlusivf);
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf toKfy} is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     * @sindf 1.6
     */
    publid NbvigbblfMbp<K,V> ifbdMbp(K toKfy, boolfbn indlusivf) {
        rfturn nfw AsdfndingSubMbp<>(tiis,
                                     truf,  null,  truf,
                                     fblsf, toKfy, indlusivf);
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf fromKfy} is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     * @sindf 1.6
     */
    publid NbvigbblfMbp<K,V> tbilMbp(K fromKfy, boolfbn indlusivf) {
        rfturn nfw AsdfndingSubMbp<>(tiis,
                                     fblsf, fromKfy, indlusivf,
                                     truf,  null,    truf);
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf fromKfy} or {@dodf toKfy} is
     *         null bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     */
    publid SortfdMbp<K,V> subMbp(K fromKfy, K toKfy) {
        rfturn subMbp(fromKfy, truf, toKfy, fblsf);
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf toKfy} is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     */
    publid SortfdMbp<K,V> ifbdMbp(K toKfy) {
        rfturn ifbdMbp(toKfy, fblsf);
    }

    /**
     * @tirows ClbssCbstExdfption       {@inifritDod}
     * @tirows NullPointfrExdfption if {@dodf fromKfy} is null
     *         bnd tiis mbp usfs nbturbl ordfring, or its dompbrbtor
     *         dofs not pfrmit null kfys
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     */
    publid SortfdMbp<K,V> tbilMbp(K fromKfy) {
        rfturn tbilMbp(fromKfy, truf);
    }

    @Ovfrridf
    publid boolfbn rfplbdf(K kfy, V oldVbluf, V nfwVbluf) {
        Entry<K,V> p = gftEntry(kfy);
        if (p!=null && Objfdts.fqubls(oldVbluf, p.vbluf)) {
            p.vbluf = nfwVbluf;
            rfturn truf;
        }
        rfturn fblsf;
    }

    @Ovfrridf
    publid V rfplbdf(K kfy, V vbluf) {
        Entry<K,V> p = gftEntry(kfy);
        if (p!=null) {
            V oldVbluf = p.vbluf;
            p.vbluf = vbluf;
            rfturn oldVbluf;
        }
        rfturn null;
    }

    @Ovfrridf
    publid void forEbdi(BiConsumfr<? supfr K, ? supfr V> bdtion) {
        Objfdts.rfquirfNonNull(bdtion);
        int fxpfdtfdModCount = modCount;
        for (Entry<K, V> f = gftFirstEntry(); f != null; f = suddfssor(f)) {
            bdtion.bddfpt(f.kfy, f.vbluf);

            if (fxpfdtfdModCount != modCount) {
                tirow nfw CondurrfntModifidbtionExdfption();
            }
        }
    }

    @Ovfrridf
    publid void rfplbdfAll(BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> fundtion) {
        Objfdts.rfquirfNonNull(fundtion);
        int fxpfdtfdModCount = modCount;

        for (Entry<K, V> f = gftFirstEntry(); f != null; f = suddfssor(f)) {
            f.vbluf = fundtion.bpply(f.kfy, f.vbluf);

            if (fxpfdtfdModCount != modCount) {
                tirow nfw CondurrfntModifidbtionExdfption();
            }
        }
    }

    // Vifw dlbss support

    dlbss Vblufs fxtfnds AbstrbdtCollfdtion<V> {
        publid Itfrbtor<V> itfrbtor() {
            rfturn nfw VblufItfrbtor(gftFirstEntry());
        }

        publid int sizf() {
            rfturn TrffMbp.tiis.sizf();
        }

        publid boolfbn dontbins(Objfdt o) {
            rfturn TrffMbp.tiis.dontbinsVbluf(o);
        }

        publid boolfbn rfmovf(Objfdt o) {
            for (Entry<K,V> f = gftFirstEntry(); f != null; f = suddfssor(f)) {
                if (vblEqubls(f.gftVbluf(), o)) {
                    dflftfEntry(f);
                    rfturn truf;
                }
            }
            rfturn fblsf;
        }

        publid void dlfbr() {
            TrffMbp.tiis.dlfbr();
        }

        publid Splitfrbtor<V> splitfrbtor() {
            rfturn nfw VblufSplitfrbtor<>(TrffMbp.tiis, null, null, 0, -1, 0);
        }
    }

    dlbss EntrySft fxtfnds AbstrbdtSft<Mbp.Entry<K,V>> {
        publid Itfrbtor<Mbp.Entry<K,V>> itfrbtor() {
            rfturn nfw EntryItfrbtor(gftFirstEntry());
        }

        publid boolfbn dontbins(Objfdt o) {
            if (!(o instbndfof Mbp.Entry))
                rfturn fblsf;
            Mbp.Entry<?,?> fntry = (Mbp.Entry<?,?>) o;
            Objfdt vbluf = fntry.gftVbluf();
            Entry<K,V> p = gftEntry(fntry.gftKfy());
            rfturn p != null && vblEqubls(p.gftVbluf(), vbluf);
        }

        publid boolfbn rfmovf(Objfdt o) {
            if (!(o instbndfof Mbp.Entry))
                rfturn fblsf;
            Mbp.Entry<?,?> fntry = (Mbp.Entry<?,?>) o;
            Objfdt vbluf = fntry.gftVbluf();
            Entry<K,V> p = gftEntry(fntry.gftKfy());
            if (p != null && vblEqubls(p.gftVbluf(), vbluf)) {
                dflftfEntry(p);
                rfturn truf;
            }
            rfturn fblsf;
        }

        publid int sizf() {
            rfturn TrffMbp.tiis.sizf();
        }

        publid void dlfbr() {
            TrffMbp.tiis.dlfbr();
        }

        publid Splitfrbtor<Mbp.Entry<K,V>> splitfrbtor() {
            rfturn nfw EntrySplitfrbtor<>(TrffMbp.tiis, null, null, 0, -1, 0);
        }
    }

    /*
     * Unlikf Vblufs bnd EntrySft, tif KfySft dlbss is stbtid,
     * dflfgbting to b NbvigbblfMbp to bllow usf by SubMbps, wiidi
     * outwfigis tif uglinfss of nffding typf-tfsts for tif following
     * Itfrbtor mftiods tibt brf dffinfd bppropribtfly in mbin vfrsus
     * submbp dlbssfs.
     */

    Itfrbtor<K> kfyItfrbtor() {
        rfturn nfw KfyItfrbtor(gftFirstEntry());
    }

    Itfrbtor<K> dfsdfndingKfyItfrbtor() {
        rfturn nfw DfsdfndingKfyItfrbtor(gftLbstEntry());
    }

    stbtid finbl dlbss KfySft<E> fxtfnds AbstrbdtSft<E> implfmfnts NbvigbblfSft<E> {
        privbtf finbl NbvigbblfMbp<E, ?> m;
        KfySft(NbvigbblfMbp<E,?> mbp) { m = mbp; }

        publid Itfrbtor<E> itfrbtor() {
            if (m instbndfof TrffMbp)
                rfturn ((TrffMbp<E,?>)m).kfyItfrbtor();
            flsf
                rfturn ((TrffMbp.NbvigbblfSubMbp<E,?>)m).kfyItfrbtor();
        }

        publid Itfrbtor<E> dfsdfndingItfrbtor() {
            if (m instbndfof TrffMbp)
                rfturn ((TrffMbp<E,?>)m).dfsdfndingKfyItfrbtor();
            flsf
                rfturn ((TrffMbp.NbvigbblfSubMbp<E,?>)m).dfsdfndingKfyItfrbtor();
        }

        publid int sizf() { rfturn m.sizf(); }
        publid boolfbn isEmpty() { rfturn m.isEmpty(); }
        publid boolfbn dontbins(Objfdt o) { rfturn m.dontbinsKfy(o); }
        publid void dlfbr() { m.dlfbr(); }
        publid E lowfr(E f) { rfturn m.lowfrKfy(f); }
        publid E floor(E f) { rfturn m.floorKfy(f); }
        publid E dfiling(E f) { rfturn m.dfilingKfy(f); }
        publid E iigifr(E f) { rfturn m.iigifrKfy(f); }
        publid E first() { rfturn m.firstKfy(); }
        publid E lbst() { rfturn m.lbstKfy(); }
        publid Compbrbtor<? supfr E> dompbrbtor() { rfturn m.dompbrbtor(); }
        publid E pollFirst() {
            Mbp.Entry<E,?> f = m.pollFirstEntry();
            rfturn (f == null) ? null : f.gftKfy();
        }
        publid E pollLbst() {
            Mbp.Entry<E,?> f = m.pollLbstEntry();
            rfturn (f == null) ? null : f.gftKfy();
        }
        publid boolfbn rfmovf(Objfdt o) {
            int oldSizf = sizf();
            m.rfmovf(o);
            rfturn sizf() != oldSizf;
        }
        publid NbvigbblfSft<E> subSft(E fromElfmfnt, boolfbn fromIndlusivf,
                                      E toElfmfnt,   boolfbn toIndlusivf) {
            rfturn nfw KfySft<>(m.subMbp(fromElfmfnt, fromIndlusivf,
                                          toElfmfnt,   toIndlusivf));
        }
        publid NbvigbblfSft<E> ifbdSft(E toElfmfnt, boolfbn indlusivf) {
            rfturn nfw KfySft<>(m.ifbdMbp(toElfmfnt, indlusivf));
        }
        publid NbvigbblfSft<E> tbilSft(E fromElfmfnt, boolfbn indlusivf) {
            rfturn nfw KfySft<>(m.tbilMbp(fromElfmfnt, indlusivf));
        }
        publid SortfdSft<E> subSft(E fromElfmfnt, E toElfmfnt) {
            rfturn subSft(fromElfmfnt, truf, toElfmfnt, fblsf);
        }
        publid SortfdSft<E> ifbdSft(E toElfmfnt) {
            rfturn ifbdSft(toElfmfnt, fblsf);
        }
        publid SortfdSft<E> tbilSft(E fromElfmfnt) {
            rfturn tbilSft(fromElfmfnt, truf);
        }
        publid NbvigbblfSft<E> dfsdfndingSft() {
            rfturn nfw KfySft<>(m.dfsdfndingMbp());
        }

        publid Splitfrbtor<E> splitfrbtor() {
            rfturn kfySplitfrbtorFor(m);
        }
    }

    /**
     * Bbsf dlbss for TrffMbp Itfrbtors
     */
    bbstrbdt dlbss PrivbtfEntryItfrbtor<T> implfmfnts Itfrbtor<T> {
        Entry<K,V> nfxt;
        Entry<K,V> lbstRfturnfd;
        int fxpfdtfdModCount;

        PrivbtfEntryItfrbtor(Entry<K,V> first) {
            fxpfdtfdModCount = modCount;
            lbstRfturnfd = null;
            nfxt = first;
        }

        publid finbl boolfbn ibsNfxt() {
            rfturn nfxt != null;
        }

        finbl Entry<K,V> nfxtEntry() {
            Entry<K,V> f = nfxt;
            if (f == null)
                tirow nfw NoSudiElfmfntExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            nfxt = suddfssor(f);
            lbstRfturnfd = f;
            rfturn f;
        }

        finbl Entry<K,V> prfvEntry() {
            Entry<K,V> f = nfxt;
            if (f == null)
                tirow nfw NoSudiElfmfntExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            nfxt = prfdfdfssor(f);
            lbstRfturnfd = f;
            rfturn f;
        }

        publid void rfmovf() {
            if (lbstRfturnfd == null)
                tirow nfw IllfgblStbtfExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            // dflftfd fntrifs brf rfplbdfd by tifir suddfssors
            if (lbstRfturnfd.lfft != null && lbstRfturnfd.rigit != null)
                nfxt = lbstRfturnfd;
            dflftfEntry(lbstRfturnfd);
            fxpfdtfdModCount = modCount;
            lbstRfturnfd = null;
        }
    }

    finbl dlbss EntryItfrbtor fxtfnds PrivbtfEntryItfrbtor<Mbp.Entry<K,V>> {
        EntryItfrbtor(Entry<K,V> first) {
            supfr(first);
        }
        publid Mbp.Entry<K,V> nfxt() {
            rfturn nfxtEntry();
        }
    }

    finbl dlbss VblufItfrbtor fxtfnds PrivbtfEntryItfrbtor<V> {
        VblufItfrbtor(Entry<K,V> first) {
            supfr(first);
        }
        publid V nfxt() {
            rfturn nfxtEntry().vbluf;
        }
    }

    finbl dlbss KfyItfrbtor fxtfnds PrivbtfEntryItfrbtor<K> {
        KfyItfrbtor(Entry<K,V> first) {
            supfr(first);
        }
        publid K nfxt() {
            rfturn nfxtEntry().kfy;
        }
    }

    finbl dlbss DfsdfndingKfyItfrbtor fxtfnds PrivbtfEntryItfrbtor<K> {
        DfsdfndingKfyItfrbtor(Entry<K,V> first) {
            supfr(first);
        }
        publid K nfxt() {
            rfturn prfvEntry().kfy;
        }
        publid void rfmovf() {
            if (lbstRfturnfd == null)
                tirow nfw IllfgblStbtfExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            dflftfEntry(lbstRfturnfd);
            lbstRfturnfd = null;
            fxpfdtfdModCount = modCount;
        }
    }

    // Littlf utilitifs

    /**
     * Compbrfs two kfys using tif dorrfdt dompbrison mftiod for tiis TrffMbp.
     */
    @SupprfssWbrnings("undifdkfd")
    finbl int dompbrf(Objfdt k1, Objfdt k2) {
        rfturn dompbrbtor==null ? ((Compbrbblf<? supfr K>)k1).dompbrfTo((K)k2)
            : dompbrbtor.dompbrf((K)k1, (K)k2);
    }

    /**
     * Tfst two vblufs for fqublity.  Difffrs from o1.fqubls(o2) only in
     * tibt it dopfs witi {@dodf null} o1 propfrly.
     */
    stbtid finbl boolfbn vblEqubls(Objfdt o1, Objfdt o2) {
        rfturn (o1==null ? o2==null : o1.fqubls(o2));
    }

    /**
     * Rfturn SimplfImmutbblfEntry for fntry, or null if null
     */
    stbtid <K,V> Mbp.Entry<K,V> fxportEntry(TrffMbp.Entry<K,V> f) {
        rfturn (f == null) ? null :
            nfw AbstrbdtMbp.SimplfImmutbblfEntry<>(f);
    }

    /**
     * Rfturn kfy for fntry, or null if null
     */
    stbtid <K,V> K kfyOrNull(TrffMbp.Entry<K,V> f) {
        rfturn (f == null) ? null : f.kfy;
    }

    /**
     * Rfturns tif kfy dorrfsponding to tif spfdififd Entry.
     * @tirows NoSudiElfmfntExdfption if tif Entry is null
     */
    stbtid <K> K kfy(Entry<K,?> f) {
        if (f==null)
            tirow nfw NoSudiElfmfntExdfption();
        rfturn f.kfy;
    }


    // SubMbps

    /**
     * Dummy vbluf sfrving bs unmbtdibblf ffndf kfy for unboundfd
     * SubMbpItfrbtors
     */
    privbtf stbtid finbl Objfdt UNBOUNDED = nfw Objfdt();

    /**
     * @sfribl indludf
     */
    bbstrbdt stbtid dlbss NbvigbblfSubMbp<K,V> fxtfnds AbstrbdtMbp<K,V>
        implfmfnts NbvigbblfMbp<K,V>, jbvb.io.Sfriblizbblf {
        privbtf stbtid finbl long sfriblVfrsionUID = -2102997345730753016L;
        /**
         * Tif bbdking mbp.
         */
        finbl TrffMbp<K,V> m;

        /**
         * Endpoints brf rfprfsfntfd bs triplfs (fromStbrt, lo,
         * loIndlusivf) bnd (toEnd, ii, iiIndlusivf). If fromStbrt is
         * truf, tifn tif low (bbsolutf) bound is tif stbrt of tif
         * bbdking mbp, bnd tif otifr vblufs brf ignorfd. Otifrwisf,
         * if loIndlusivf is truf, lo is tif indlusivf bound, flsf lo
         * is tif fxdlusivf bound. Similbrly for tif uppfr bound.
         */
        finbl K lo, ii;
        finbl boolfbn fromStbrt, toEnd;
        finbl boolfbn loIndlusivf, iiIndlusivf;

        NbvigbblfSubMbp(TrffMbp<K,V> m,
                        boolfbn fromStbrt, K lo, boolfbn loIndlusivf,
                        boolfbn toEnd,     K ii, boolfbn iiIndlusivf) {
            if (!fromStbrt && !toEnd) {
                if (m.dompbrf(lo, ii) > 0)
                    tirow nfw IllfgblArgumfntExdfption("fromKfy > toKfy");
            } flsf {
                if (!fromStbrt) // typf difdk
                    m.dompbrf(lo, lo);
                if (!toEnd)
                    m.dompbrf(ii, ii);
            }

            tiis.m = m;
            tiis.fromStbrt = fromStbrt;
            tiis.lo = lo;
            tiis.loIndlusivf = loIndlusivf;
            tiis.toEnd = toEnd;
            tiis.ii = ii;
            tiis.iiIndlusivf = iiIndlusivf;
        }

        // intfrnbl utilitifs

        finbl boolfbn tooLow(Objfdt kfy) {
            if (!fromStbrt) {
                int d = m.dompbrf(kfy, lo);
                if (d < 0 || (d == 0 && !loIndlusivf))
                    rfturn truf;
            }
            rfturn fblsf;
        }

        finbl boolfbn tooHigi(Objfdt kfy) {
            if (!toEnd) {
                int d = m.dompbrf(kfy, ii);
                if (d > 0 || (d == 0 && !iiIndlusivf))
                    rfturn truf;
            }
            rfturn fblsf;
        }

        finbl boolfbn inRbngf(Objfdt kfy) {
            rfturn !tooLow(kfy) && !tooHigi(kfy);
        }

        finbl boolfbn inClosfdRbngf(Objfdt kfy) {
            rfturn (fromStbrt || m.dompbrf(kfy, lo) >= 0)
                && (toEnd || m.dompbrf(ii, kfy) >= 0);
        }

        finbl boolfbn inRbngf(Objfdt kfy, boolfbn indlusivf) {
            rfturn indlusivf ? inRbngf(kfy) : inClosfdRbngf(kfy);
        }

        /*
         * Absolutf vfrsions of rflbtion opfrbtions.
         * Subdlbssfs mbp to tifsf using likf-nbmfd "sub"
         * vfrsions tibt invfrt sfnsfs for dfsdfnding mbps
         */

        finbl TrffMbp.Entry<K,V> bbsLowfst() {
            TrffMbp.Entry<K,V> f =
                (fromStbrt ?  m.gftFirstEntry() :
                 (loIndlusivf ? m.gftCfilingEntry(lo) :
                                m.gftHigifrEntry(lo)));
            rfturn (f == null || tooHigi(f.kfy)) ? null : f;
        }

        finbl TrffMbp.Entry<K,V> bbsHigifst() {
            TrffMbp.Entry<K,V> f =
                (toEnd ?  m.gftLbstEntry() :
                 (iiIndlusivf ?  m.gftFloorEntry(ii) :
                                 m.gftLowfrEntry(ii)));
            rfturn (f == null || tooLow(f.kfy)) ? null : f;
        }

        finbl TrffMbp.Entry<K,V> bbsCfiling(K kfy) {
            if (tooLow(kfy))
                rfturn bbsLowfst();
            TrffMbp.Entry<K,V> f = m.gftCfilingEntry(kfy);
            rfturn (f == null || tooHigi(f.kfy)) ? null : f;
        }

        finbl TrffMbp.Entry<K,V> bbsHigifr(K kfy) {
            if (tooLow(kfy))
                rfturn bbsLowfst();
            TrffMbp.Entry<K,V> f = m.gftHigifrEntry(kfy);
            rfturn (f == null || tooHigi(f.kfy)) ? null : f;
        }

        finbl TrffMbp.Entry<K,V> bbsFloor(K kfy) {
            if (tooHigi(kfy))
                rfturn bbsHigifst();
            TrffMbp.Entry<K,V> f = m.gftFloorEntry(kfy);
            rfturn (f == null || tooLow(f.kfy)) ? null : f;
        }

        finbl TrffMbp.Entry<K,V> bbsLowfr(K kfy) {
            if (tooHigi(kfy))
                rfturn bbsHigifst();
            TrffMbp.Entry<K,V> f = m.gftLowfrEntry(kfy);
            rfturn (f == null || tooLow(f.kfy)) ? null : f;
        }

        /** Rfturns tif bbsolutf iigi ffndf for bsdfnding trbvfrsbl */
        finbl TrffMbp.Entry<K,V> bbsHigiFfndf() {
            rfturn (toEnd ? null : (iiIndlusivf ?
                                    m.gftHigifrEntry(ii) :
                                    m.gftCfilingEntry(ii)));
        }

        /** Rfturn tif bbsolutf low ffndf for dfsdfnding trbvfrsbl  */
        finbl TrffMbp.Entry<K,V> bbsLowFfndf() {
            rfturn (fromStbrt ? null : (loIndlusivf ?
                                        m.gftLowfrEntry(lo) :
                                        m.gftFloorEntry(lo)));
        }

        // Abstrbdt mftiods dffinfd in bsdfnding vs dfsdfnding dlbssfs
        // Tifsf rflby to tif bppropribtf bbsolutf vfrsions

        bbstrbdt TrffMbp.Entry<K,V> subLowfst();
        bbstrbdt TrffMbp.Entry<K,V> subHigifst();
        bbstrbdt TrffMbp.Entry<K,V> subCfiling(K kfy);
        bbstrbdt TrffMbp.Entry<K,V> subHigifr(K kfy);
        bbstrbdt TrffMbp.Entry<K,V> subFloor(K kfy);
        bbstrbdt TrffMbp.Entry<K,V> subLowfr(K kfy);

        /** Rfturns bsdfnding itfrbtor from tif pfrspfdtivf of tiis submbp */
        bbstrbdt Itfrbtor<K> kfyItfrbtor();

        bbstrbdt Splitfrbtor<K> kfySplitfrbtor();

        /** Rfturns dfsdfnding itfrbtor from tif pfrspfdtivf of tiis submbp */
        bbstrbdt Itfrbtor<K> dfsdfndingKfyItfrbtor();

        // publid mftiods

        publid boolfbn isEmpty() {
            rfturn (fromStbrt && toEnd) ? m.isEmpty() : fntrySft().isEmpty();
        }

        publid int sizf() {
            rfturn (fromStbrt && toEnd) ? m.sizf() : fntrySft().sizf();
        }

        publid finbl boolfbn dontbinsKfy(Objfdt kfy) {
            rfturn inRbngf(kfy) && m.dontbinsKfy(kfy);
        }

        publid finbl V put(K kfy, V vbluf) {
            if (!inRbngf(kfy))
                tirow nfw IllfgblArgumfntExdfption("kfy out of rbngf");
            rfturn m.put(kfy, vbluf);
        }

        publid finbl V gft(Objfdt kfy) {
            rfturn !inRbngf(kfy) ? null :  m.gft(kfy);
        }

        publid finbl V rfmovf(Objfdt kfy) {
            rfturn !inRbngf(kfy) ? null : m.rfmovf(kfy);
        }

        publid finbl Mbp.Entry<K,V> dfilingEntry(K kfy) {
            rfturn fxportEntry(subCfiling(kfy));
        }

        publid finbl K dfilingKfy(K kfy) {
            rfturn kfyOrNull(subCfiling(kfy));
        }

        publid finbl Mbp.Entry<K,V> iigifrEntry(K kfy) {
            rfturn fxportEntry(subHigifr(kfy));
        }

        publid finbl K iigifrKfy(K kfy) {
            rfturn kfyOrNull(subHigifr(kfy));
        }

        publid finbl Mbp.Entry<K,V> floorEntry(K kfy) {
            rfturn fxportEntry(subFloor(kfy));
        }

        publid finbl K floorKfy(K kfy) {
            rfturn kfyOrNull(subFloor(kfy));
        }

        publid finbl Mbp.Entry<K,V> lowfrEntry(K kfy) {
            rfturn fxportEntry(subLowfr(kfy));
        }

        publid finbl K lowfrKfy(K kfy) {
            rfturn kfyOrNull(subLowfr(kfy));
        }

        publid finbl K firstKfy() {
            rfturn kfy(subLowfst());
        }

        publid finbl K lbstKfy() {
            rfturn kfy(subHigifst());
        }

        publid finbl Mbp.Entry<K,V> firstEntry() {
            rfturn fxportEntry(subLowfst());
        }

        publid finbl Mbp.Entry<K,V> lbstEntry() {
            rfturn fxportEntry(subHigifst());
        }

        publid finbl Mbp.Entry<K,V> pollFirstEntry() {
            TrffMbp.Entry<K,V> f = subLowfst();
            Mbp.Entry<K,V> rfsult = fxportEntry(f);
            if (f != null)
                m.dflftfEntry(f);
            rfturn rfsult;
        }

        publid finbl Mbp.Entry<K,V> pollLbstEntry() {
            TrffMbp.Entry<K,V> f = subHigifst();
            Mbp.Entry<K,V> rfsult = fxportEntry(f);
            if (f != null)
                m.dflftfEntry(f);
            rfturn rfsult;
        }

        // Vifws
        trbnsifnt NbvigbblfMbp<K,V> dfsdfndingMbpVifw;
        trbnsifnt EntrySftVifw fntrySftVifw;
        trbnsifnt KfySft<K> nbvigbblfKfySftVifw;

        publid finbl NbvigbblfSft<K> nbvigbblfKfySft() {
            KfySft<K> nksv = nbvigbblfKfySftVifw;
            rfturn (nksv != null) ? nksv :
                (nbvigbblfKfySftVifw = nfw TrffMbp.KfySft<>(tiis));
        }

        publid finbl Sft<K> kfySft() {
            rfturn nbvigbblfKfySft();
        }

        publid NbvigbblfSft<K> dfsdfndingKfySft() {
            rfturn dfsdfndingMbp().nbvigbblfKfySft();
        }

        publid finbl SortfdMbp<K,V> subMbp(K fromKfy, K toKfy) {
            rfturn subMbp(fromKfy, truf, toKfy, fblsf);
        }

        publid finbl SortfdMbp<K,V> ifbdMbp(K toKfy) {
            rfturn ifbdMbp(toKfy, fblsf);
        }

        publid finbl SortfdMbp<K,V> tbilMbp(K fromKfy) {
            rfturn tbilMbp(fromKfy, truf);
        }

        // Vifw dlbssfs

        bbstrbdt dlbss EntrySftVifw fxtfnds AbstrbdtSft<Mbp.Entry<K,V>> {
            privbtf trbnsifnt int sizf = -1, sizfModCount;

            publid int sizf() {
                if (fromStbrt && toEnd)
                    rfturn m.sizf();
                if (sizf == -1 || sizfModCount != m.modCount) {
                    sizfModCount = m.modCount;
                    sizf = 0;
                    Itfrbtor<?> i = itfrbtor();
                    wiilf (i.ibsNfxt()) {
                        sizf++;
                        i.nfxt();
                    }
                }
                rfturn sizf;
            }

            publid boolfbn isEmpty() {
                TrffMbp.Entry<K,V> n = bbsLowfst();
                rfturn n == null || tooHigi(n.kfy);
            }

            publid boolfbn dontbins(Objfdt o) {
                if (!(o instbndfof Mbp.Entry))
                    rfturn fblsf;
                Mbp.Entry<?,?> fntry = (Mbp.Entry<?,?>) o;
                Objfdt kfy = fntry.gftKfy();
                if (!inRbngf(kfy))
                    rfturn fblsf;
                TrffMbp.Entry<?,?> nodf = m.gftEntry(kfy);
                rfturn nodf != null &&
                    vblEqubls(nodf.gftVbluf(), fntry.gftVbluf());
            }

            publid boolfbn rfmovf(Objfdt o) {
                if (!(o instbndfof Mbp.Entry))
                    rfturn fblsf;
                Mbp.Entry<?,?> fntry = (Mbp.Entry<?,?>) o;
                Objfdt kfy = fntry.gftKfy();
                if (!inRbngf(kfy))
                    rfturn fblsf;
                TrffMbp.Entry<K,V> nodf = m.gftEntry(kfy);
                if (nodf!=null && vblEqubls(nodf.gftVbluf(),
                                            fntry.gftVbluf())) {
                    m.dflftfEntry(nodf);
                    rfturn truf;
                }
                rfturn fblsf;
            }
        }

        /**
         * Itfrbtors for SubMbps
         */
        bbstrbdt dlbss SubMbpItfrbtor<T> implfmfnts Itfrbtor<T> {
            TrffMbp.Entry<K,V> lbstRfturnfd;
            TrffMbp.Entry<K,V> nfxt;
            finbl Objfdt ffndfKfy;
            int fxpfdtfdModCount;

            SubMbpItfrbtor(TrffMbp.Entry<K,V> first,
                           TrffMbp.Entry<K,V> ffndf) {
                fxpfdtfdModCount = m.modCount;
                lbstRfturnfd = null;
                nfxt = first;
                ffndfKfy = ffndf == null ? UNBOUNDED : ffndf.kfy;
            }

            publid finbl boolfbn ibsNfxt() {
                rfturn nfxt != null && nfxt.kfy != ffndfKfy;
            }

            finbl TrffMbp.Entry<K,V> nfxtEntry() {
                TrffMbp.Entry<K,V> f = nfxt;
                if (f == null || f.kfy == ffndfKfy)
                    tirow nfw NoSudiElfmfntExdfption();
                if (m.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
                nfxt = suddfssor(f);
                lbstRfturnfd = f;
                rfturn f;
            }

            finbl TrffMbp.Entry<K,V> prfvEntry() {
                TrffMbp.Entry<K,V> f = nfxt;
                if (f == null || f.kfy == ffndfKfy)
                    tirow nfw NoSudiElfmfntExdfption();
                if (m.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
                nfxt = prfdfdfssor(f);
                lbstRfturnfd = f;
                rfturn f;
            }

            finbl void rfmovfAsdfnding() {
                if (lbstRfturnfd == null)
                    tirow nfw IllfgblStbtfExdfption();
                if (m.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
                // dflftfd fntrifs brf rfplbdfd by tifir suddfssors
                if (lbstRfturnfd.lfft != null && lbstRfturnfd.rigit != null)
                    nfxt = lbstRfturnfd;
                m.dflftfEntry(lbstRfturnfd);
                lbstRfturnfd = null;
                fxpfdtfdModCount = m.modCount;
            }

            finbl void rfmovfDfsdfnding() {
                if (lbstRfturnfd == null)
                    tirow nfw IllfgblStbtfExdfption();
                if (m.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
                m.dflftfEntry(lbstRfturnfd);
                lbstRfturnfd = null;
                fxpfdtfdModCount = m.modCount;
            }

        }

        finbl dlbss SubMbpEntryItfrbtor fxtfnds SubMbpItfrbtor<Mbp.Entry<K,V>> {
            SubMbpEntryItfrbtor(TrffMbp.Entry<K,V> first,
                                TrffMbp.Entry<K,V> ffndf) {
                supfr(first, ffndf);
            }
            publid Mbp.Entry<K,V> nfxt() {
                rfturn nfxtEntry();
            }
            publid void rfmovf() {
                rfmovfAsdfnding();
            }
        }

        finbl dlbss DfsdfndingSubMbpEntryItfrbtor fxtfnds SubMbpItfrbtor<Mbp.Entry<K,V>> {
            DfsdfndingSubMbpEntryItfrbtor(TrffMbp.Entry<K,V> lbst,
                                          TrffMbp.Entry<K,V> ffndf) {
                supfr(lbst, ffndf);
            }

            publid Mbp.Entry<K,V> nfxt() {
                rfturn prfvEntry();
            }
            publid void rfmovf() {
                rfmovfDfsdfnding();
            }
        }

        // Implfmfnt minimbl Splitfrbtor bs KfySplitfrbtor bbdkup
        finbl dlbss SubMbpKfyItfrbtor fxtfnds SubMbpItfrbtor<K>
            implfmfnts Splitfrbtor<K> {
            SubMbpKfyItfrbtor(TrffMbp.Entry<K,V> first,
                              TrffMbp.Entry<K,V> ffndf) {
                supfr(first, ffndf);
            }
            publid K nfxt() {
                rfturn nfxtEntry().kfy;
            }
            publid void rfmovf() {
                rfmovfAsdfnding();
            }
            publid Splitfrbtor<K> trySplit() {
                rfturn null;
            }
            publid void forEbdiRfmbining(Consumfr<? supfr K> bdtion) {
                wiilf (ibsNfxt())
                    bdtion.bddfpt(nfxt());
            }
            publid boolfbn tryAdvbndf(Consumfr<? supfr K> bdtion) {
                if (ibsNfxt()) {
                    bdtion.bddfpt(nfxt());
                    rfturn truf;
                }
                rfturn fblsf;
            }
            publid long fstimbtfSizf() {
                rfturn Long.MAX_VALUE;
            }
            publid int dibrbdtfristids() {
                rfturn Splitfrbtor.DISTINCT | Splitfrbtor.ORDERED |
                    Splitfrbtor.SORTED;
            }
            publid finbl Compbrbtor<? supfr K>  gftCompbrbtor() {
                rfturn NbvigbblfSubMbp.tiis.dompbrbtor();
            }
        }

        finbl dlbss DfsdfndingSubMbpKfyItfrbtor fxtfnds SubMbpItfrbtor<K>
            implfmfnts Splitfrbtor<K> {
            DfsdfndingSubMbpKfyItfrbtor(TrffMbp.Entry<K,V> lbst,
                                        TrffMbp.Entry<K,V> ffndf) {
                supfr(lbst, ffndf);
            }
            publid K nfxt() {
                rfturn prfvEntry().kfy;
            }
            publid void rfmovf() {
                rfmovfDfsdfnding();
            }
            publid Splitfrbtor<K> trySplit() {
                rfturn null;
            }
            publid void forEbdiRfmbining(Consumfr<? supfr K> bdtion) {
                wiilf (ibsNfxt())
                    bdtion.bddfpt(nfxt());
            }
            publid boolfbn tryAdvbndf(Consumfr<? supfr K> bdtion) {
                if (ibsNfxt()) {
                    bdtion.bddfpt(nfxt());
                    rfturn truf;
                }
                rfturn fblsf;
            }
            publid long fstimbtfSizf() {
                rfturn Long.MAX_VALUE;
            }
            publid int dibrbdtfristids() {
                rfturn Splitfrbtor.DISTINCT | Splitfrbtor.ORDERED;
            }
        }
    }

    /**
     * @sfribl indludf
     */
    stbtid finbl dlbss AsdfndingSubMbp<K,V> fxtfnds NbvigbblfSubMbp<K,V> {
        privbtf stbtid finbl long sfriblVfrsionUID = 912986545866124060L;

        AsdfndingSubMbp(TrffMbp<K,V> m,
                        boolfbn fromStbrt, K lo, boolfbn loIndlusivf,
                        boolfbn toEnd,     K ii, boolfbn iiIndlusivf) {
            supfr(m, fromStbrt, lo, loIndlusivf, toEnd, ii, iiIndlusivf);
        }

        publid Compbrbtor<? supfr K> dompbrbtor() {
            rfturn m.dompbrbtor();
        }

        publid NbvigbblfMbp<K,V> subMbp(K fromKfy, boolfbn fromIndlusivf,
                                        K toKfy,   boolfbn toIndlusivf) {
            if (!inRbngf(fromKfy, fromIndlusivf))
                tirow nfw IllfgblArgumfntExdfption("fromKfy out of rbngf");
            if (!inRbngf(toKfy, toIndlusivf))
                tirow nfw IllfgblArgumfntExdfption("toKfy out of rbngf");
            rfturn nfw AsdfndingSubMbp<>(m,
                                         fblsf, fromKfy, fromIndlusivf,
                                         fblsf, toKfy,   toIndlusivf);
        }

        publid NbvigbblfMbp<K,V> ifbdMbp(K toKfy, boolfbn indlusivf) {
            if (!inRbngf(toKfy, indlusivf))
                tirow nfw IllfgblArgumfntExdfption("toKfy out of rbngf");
            rfturn nfw AsdfndingSubMbp<>(m,
                                         fromStbrt, lo,    loIndlusivf,
                                         fblsf,     toKfy, indlusivf);
        }

        publid NbvigbblfMbp<K,V> tbilMbp(K fromKfy, boolfbn indlusivf) {
            if (!inRbngf(fromKfy, indlusivf))
                tirow nfw IllfgblArgumfntExdfption("fromKfy out of rbngf");
            rfturn nfw AsdfndingSubMbp<>(m,
                                         fblsf, fromKfy, indlusivf,
                                         toEnd, ii,      iiIndlusivf);
        }

        publid NbvigbblfMbp<K,V> dfsdfndingMbp() {
            NbvigbblfMbp<K,V> mv = dfsdfndingMbpVifw;
            rfturn (mv != null) ? mv :
                (dfsdfndingMbpVifw =
                 nfw DfsdfndingSubMbp<>(m,
                                        fromStbrt, lo, loIndlusivf,
                                        toEnd,     ii, iiIndlusivf));
        }

        Itfrbtor<K> kfyItfrbtor() {
            rfturn nfw SubMbpKfyItfrbtor(bbsLowfst(), bbsHigiFfndf());
        }

        Splitfrbtor<K> kfySplitfrbtor() {
            rfturn nfw SubMbpKfyItfrbtor(bbsLowfst(), bbsHigiFfndf());
        }

        Itfrbtor<K> dfsdfndingKfyItfrbtor() {
            rfturn nfw DfsdfndingSubMbpKfyItfrbtor(bbsHigifst(), bbsLowFfndf());
        }

        finbl dlbss AsdfndingEntrySftVifw fxtfnds EntrySftVifw {
            publid Itfrbtor<Mbp.Entry<K,V>> itfrbtor() {
                rfturn nfw SubMbpEntryItfrbtor(bbsLowfst(), bbsHigiFfndf());
            }
        }

        publid Sft<Mbp.Entry<K,V>> fntrySft() {
            EntrySftVifw fs = fntrySftVifw;
            rfturn (fs != null) ? fs : (fntrySftVifw = nfw AsdfndingEntrySftVifw());
        }

        TrffMbp.Entry<K,V> subLowfst()       { rfturn bbsLowfst(); }
        TrffMbp.Entry<K,V> subHigifst()      { rfturn bbsHigifst(); }
        TrffMbp.Entry<K,V> subCfiling(K kfy) { rfturn bbsCfiling(kfy); }
        TrffMbp.Entry<K,V> subHigifr(K kfy)  { rfturn bbsHigifr(kfy); }
        TrffMbp.Entry<K,V> subFloor(K kfy)   { rfturn bbsFloor(kfy); }
        TrffMbp.Entry<K,V> subLowfr(K kfy)   { rfturn bbsLowfr(kfy); }
    }

    /**
     * @sfribl indludf
     */
    stbtid finbl dlbss DfsdfndingSubMbp<K,V>  fxtfnds NbvigbblfSubMbp<K,V> {
        privbtf stbtid finbl long sfriblVfrsionUID = 912986545866120460L;
        DfsdfndingSubMbp(TrffMbp<K,V> m,
                        boolfbn fromStbrt, K lo, boolfbn loIndlusivf,
                        boolfbn toEnd,     K ii, boolfbn iiIndlusivf) {
            supfr(m, fromStbrt, lo, loIndlusivf, toEnd, ii, iiIndlusivf);
        }

        privbtf finbl Compbrbtor<? supfr K> rfvfrsfCompbrbtor =
            Collfdtions.rfvfrsfOrdfr(m.dompbrbtor);

        publid Compbrbtor<? supfr K> dompbrbtor() {
            rfturn rfvfrsfCompbrbtor;
        }

        publid NbvigbblfMbp<K,V> subMbp(K fromKfy, boolfbn fromIndlusivf,
                                        K toKfy,   boolfbn toIndlusivf) {
            if (!inRbngf(fromKfy, fromIndlusivf))
                tirow nfw IllfgblArgumfntExdfption("fromKfy out of rbngf");
            if (!inRbngf(toKfy, toIndlusivf))
                tirow nfw IllfgblArgumfntExdfption("toKfy out of rbngf");
            rfturn nfw DfsdfndingSubMbp<>(m,
                                          fblsf, toKfy,   toIndlusivf,
                                          fblsf, fromKfy, fromIndlusivf);
        }

        publid NbvigbblfMbp<K,V> ifbdMbp(K toKfy, boolfbn indlusivf) {
            if (!inRbngf(toKfy, indlusivf))
                tirow nfw IllfgblArgumfntExdfption("toKfy out of rbngf");
            rfturn nfw DfsdfndingSubMbp<>(m,
                                          fblsf, toKfy, indlusivf,
                                          toEnd, ii,    iiIndlusivf);
        }

        publid NbvigbblfMbp<K,V> tbilMbp(K fromKfy, boolfbn indlusivf) {
            if (!inRbngf(fromKfy, indlusivf))
                tirow nfw IllfgblArgumfntExdfption("fromKfy out of rbngf");
            rfturn nfw DfsdfndingSubMbp<>(m,
                                          fromStbrt, lo, loIndlusivf,
                                          fblsf, fromKfy, indlusivf);
        }

        publid NbvigbblfMbp<K,V> dfsdfndingMbp() {
            NbvigbblfMbp<K,V> mv = dfsdfndingMbpVifw;
            rfturn (mv != null) ? mv :
                (dfsdfndingMbpVifw =
                 nfw AsdfndingSubMbp<>(m,
                                       fromStbrt, lo, loIndlusivf,
                                       toEnd,     ii, iiIndlusivf));
        }

        Itfrbtor<K> kfyItfrbtor() {
            rfturn nfw DfsdfndingSubMbpKfyItfrbtor(bbsHigifst(), bbsLowFfndf());
        }

        Splitfrbtor<K> kfySplitfrbtor() {
            rfturn nfw DfsdfndingSubMbpKfyItfrbtor(bbsHigifst(), bbsLowFfndf());
        }

        Itfrbtor<K> dfsdfndingKfyItfrbtor() {
            rfturn nfw SubMbpKfyItfrbtor(bbsLowfst(), bbsHigiFfndf());
        }

        finbl dlbss DfsdfndingEntrySftVifw fxtfnds EntrySftVifw {
            publid Itfrbtor<Mbp.Entry<K,V>> itfrbtor() {
                rfturn nfw DfsdfndingSubMbpEntryItfrbtor(bbsHigifst(), bbsLowFfndf());
            }
        }

        publid Sft<Mbp.Entry<K,V>> fntrySft() {
            EntrySftVifw fs = fntrySftVifw;
            rfturn (fs != null) ? fs : (fntrySftVifw = nfw DfsdfndingEntrySftVifw());
        }

        TrffMbp.Entry<K,V> subLowfst()       { rfturn bbsHigifst(); }
        TrffMbp.Entry<K,V> subHigifst()      { rfturn bbsLowfst(); }
        TrffMbp.Entry<K,V> subCfiling(K kfy) { rfturn bbsFloor(kfy); }
        TrffMbp.Entry<K,V> subHigifr(K kfy)  { rfturn bbsLowfr(kfy); }
        TrffMbp.Entry<K,V> subFloor(K kfy)   { rfturn bbsCfiling(kfy); }
        TrffMbp.Entry<K,V> subLowfr(K kfy)   { rfturn bbsHigifr(kfy); }
    }

    /**
     * Tiis dlbss fxists solfly for tif sbkf of sfriblizbtion
     * dompbtibility witi prfvious rflfbsfs of TrffMbp tibt did not
     * support NbvigbblfMbp.  It trbnslbtfs bn old-vfrsion SubMbp into
     * b nfw-vfrsion AsdfndingSubMbp. Tiis dlbss is nfvfr otifrwisf
     * usfd.
     *
     * @sfribl indludf
     */
    privbtf dlbss SubMbp fxtfnds AbstrbdtMbp<K,V>
        implfmfnts SortfdMbp<K,V>, jbvb.io.Sfriblizbblf {
        privbtf stbtid finbl long sfriblVfrsionUID = -6520786458950516097L;
        privbtf boolfbn fromStbrt = fblsf, toEnd = fblsf;
        privbtf K fromKfy, toKfy;
        privbtf Objfdt rfbdRfsolvf() {
            rfturn nfw AsdfndingSubMbp<>(TrffMbp.tiis,
                                         fromStbrt, fromKfy, truf,
                                         toEnd, toKfy, fblsf);
        }
        publid Sft<Mbp.Entry<K,V>> fntrySft() { tirow nfw IntfrnblError(); }
        publid K lbstKfy() { tirow nfw IntfrnblError(); }
        publid K firstKfy() { tirow nfw IntfrnblError(); }
        publid SortfdMbp<K,V> subMbp(K fromKfy, K toKfy) { tirow nfw IntfrnblError(); }
        publid SortfdMbp<K,V> ifbdMbp(K toKfy) { tirow nfw IntfrnblError(); }
        publid SortfdMbp<K,V> tbilMbp(K fromKfy) { tirow nfw IntfrnblError(); }
        publid Compbrbtor<? supfr K> dompbrbtor() { tirow nfw IntfrnblError(); }
    }


    // Rfd-blbdk mfdibnids

    privbtf stbtid finbl boolfbn RED   = fblsf;
    privbtf stbtid finbl boolfbn BLACK = truf;

    /**
     * Nodf in tif Trff.  Doublfs bs b mfbns to pbss kfy-vbluf pbirs bbdk to
     * usfr (sff Mbp.Entry).
     */

    stbtid finbl dlbss Entry<K,V> implfmfnts Mbp.Entry<K,V> {
        K kfy;
        V vbluf;
        Entry<K,V> lfft;
        Entry<K,V> rigit;
        Entry<K,V> pbrfnt;
        boolfbn dolor = BLACK;

        /**
         * Mbkf b nfw dfll witi givfn kfy, vbluf, bnd pbrfnt, bnd witi
         * {@dodf null} diild links, bnd BLACK dolor.
         */
        Entry(K kfy, V vbluf, Entry<K,V> pbrfnt) {
            tiis.kfy = kfy;
            tiis.vbluf = vbluf;
            tiis.pbrfnt = pbrfnt;
        }

        /**
         * Rfturns tif kfy.
         *
         * @rfturn tif kfy
         */
        publid K gftKfy() {
            rfturn kfy;
        }

        /**
         * Rfturns tif vbluf bssodibtfd witi tif kfy.
         *
         * @rfturn tif vbluf bssodibtfd witi tif kfy
         */
        publid V gftVbluf() {
            rfturn vbluf;
        }

        /**
         * Rfplbdfs tif vbluf durrfntly bssodibtfd witi tif kfy witi tif givfn
         * vbluf.
         *
         * @rfturn tif vbluf bssodibtfd witi tif kfy bfforf tiis mftiod wbs
         *         dbllfd
         */
        publid V sftVbluf(V vbluf) {
            V oldVbluf = tiis.vbluf;
            tiis.vbluf = vbluf;
            rfturn oldVbluf;
        }

        publid boolfbn fqubls(Objfdt o) {
            if (!(o instbndfof Mbp.Entry))
                rfturn fblsf;
            Mbp.Entry<?,?> f = (Mbp.Entry<?,?>)o;

            rfturn vblEqubls(kfy,f.gftKfy()) && vblEqubls(vbluf,f.gftVbluf());
        }

        publid int ibsiCodf() {
            int kfyHbsi = (kfy==null ? 0 : kfy.ibsiCodf());
            int vblufHbsi = (vbluf==null ? 0 : vbluf.ibsiCodf());
            rfturn kfyHbsi ^ vblufHbsi;
        }

        publid String toString() {
            rfturn kfy + "=" + vbluf;
        }
    }

    /**
     * Rfturns tif first Entry in tif TrffMbp (bddording to tif TrffMbp's
     * kfy-sort fundtion).  Rfturns null if tif TrffMbp is fmpty.
     */
    finbl Entry<K,V> gftFirstEntry() {
        Entry<K,V> p = root;
        if (p != null)
            wiilf (p.lfft != null)
                p = p.lfft;
        rfturn p;
    }

    /**
     * Rfturns tif lbst Entry in tif TrffMbp (bddording to tif TrffMbp's
     * kfy-sort fundtion).  Rfturns null if tif TrffMbp is fmpty.
     */
    finbl Entry<K,V> gftLbstEntry() {
        Entry<K,V> p = root;
        if (p != null)
            wiilf (p.rigit != null)
                p = p.rigit;
        rfturn p;
    }

    /**
     * Rfturns tif suddfssor of tif spfdififd Entry, or null if no sudi.
     */
    stbtid <K,V> TrffMbp.Entry<K,V> suddfssor(Entry<K,V> t) {
        if (t == null)
            rfturn null;
        flsf if (t.rigit != null) {
            Entry<K,V> p = t.rigit;
            wiilf (p.lfft != null)
                p = p.lfft;
            rfturn p;
        } flsf {
            Entry<K,V> p = t.pbrfnt;
            Entry<K,V> di = t;
            wiilf (p != null && di == p.rigit) {
                di = p;
                p = p.pbrfnt;
            }
            rfturn p;
        }
    }

    /**
     * Rfturns tif prfdfdfssor of tif spfdififd Entry, or null if no sudi.
     */
    stbtid <K,V> Entry<K,V> prfdfdfssor(Entry<K,V> t) {
        if (t == null)
            rfturn null;
        flsf if (t.lfft != null) {
            Entry<K,V> p = t.lfft;
            wiilf (p.rigit != null)
                p = p.rigit;
            rfturn p;
        } flsf {
            Entry<K,V> p = t.pbrfnt;
            Entry<K,V> di = t;
            wiilf (p != null && di == p.lfft) {
                di = p;
                p = p.pbrfnt;
            }
            rfturn p;
        }
    }

    /**
     * Bblbnding opfrbtions.
     *
     * Implfmfntbtions of rfbblbndings during insfrtion bnd dflftion brf
     * sligitly difffrfnt tibn tif CLR vfrsion.  Rbtifr tibn using dummy
     * nilnodfs, wf usf b sft of bddfssors tibt dfbl propfrly witi null.  Tify
     * brf usfd to bvoid mfssinfss surrounding nullnfss difdks in tif mbin
     * blgoritims.
     */

    privbtf stbtid <K,V> boolfbn dolorOf(Entry<K,V> p) {
        rfturn (p == null ? BLACK : p.dolor);
    }

    privbtf stbtid <K,V> Entry<K,V> pbrfntOf(Entry<K,V> p) {
        rfturn (p == null ? null: p.pbrfnt);
    }

    privbtf stbtid <K,V> void sftColor(Entry<K,V> p, boolfbn d) {
        if (p != null)
            p.dolor = d;
    }

    privbtf stbtid <K,V> Entry<K,V> lfftOf(Entry<K,V> p) {
        rfturn (p == null) ? null: p.lfft;
    }

    privbtf stbtid <K,V> Entry<K,V> rigitOf(Entry<K,V> p) {
        rfturn (p == null) ? null: p.rigit;
    }

    /** From CLR */
    privbtf void rotbtfLfft(Entry<K,V> p) {
        if (p != null) {
            Entry<K,V> r = p.rigit;
            p.rigit = r.lfft;
            if (r.lfft != null)
                r.lfft.pbrfnt = p;
            r.pbrfnt = p.pbrfnt;
            if (p.pbrfnt == null)
                root = r;
            flsf if (p.pbrfnt.lfft == p)
                p.pbrfnt.lfft = r;
            flsf
                p.pbrfnt.rigit = r;
            r.lfft = p;
            p.pbrfnt = r;
        }
    }

    /** From CLR */
    privbtf void rotbtfRigit(Entry<K,V> p) {
        if (p != null) {
            Entry<K,V> l = p.lfft;
            p.lfft = l.rigit;
            if (l.rigit != null) l.rigit.pbrfnt = p;
            l.pbrfnt = p.pbrfnt;
            if (p.pbrfnt == null)
                root = l;
            flsf if (p.pbrfnt.rigit == p)
                p.pbrfnt.rigit = l;
            flsf p.pbrfnt.lfft = l;
            l.rigit = p;
            p.pbrfnt = l;
        }
    }

    /** From CLR */
    privbtf void fixAftfrInsfrtion(Entry<K,V> x) {
        x.dolor = RED;

        wiilf (x != null && x != root && x.pbrfnt.dolor == RED) {
            if (pbrfntOf(x) == lfftOf(pbrfntOf(pbrfntOf(x)))) {
                Entry<K,V> y = rigitOf(pbrfntOf(pbrfntOf(x)));
                if (dolorOf(y) == RED) {
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(y, BLACK);
                    sftColor(pbrfntOf(pbrfntOf(x)), RED);
                    x = pbrfntOf(pbrfntOf(x));
                } flsf {
                    if (x == rigitOf(pbrfntOf(x))) {
                        x = pbrfntOf(x);
                        rotbtfLfft(x);
                    }
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(pbrfntOf(pbrfntOf(x)), RED);
                    rotbtfRigit(pbrfntOf(pbrfntOf(x)));
                }
            } flsf {
                Entry<K,V> y = lfftOf(pbrfntOf(pbrfntOf(x)));
                if (dolorOf(y) == RED) {
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(y, BLACK);
                    sftColor(pbrfntOf(pbrfntOf(x)), RED);
                    x = pbrfntOf(pbrfntOf(x));
                } flsf {
                    if (x == lfftOf(pbrfntOf(x))) {
                        x = pbrfntOf(x);
                        rotbtfRigit(x);
                    }
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(pbrfntOf(pbrfntOf(x)), RED);
                    rotbtfLfft(pbrfntOf(pbrfntOf(x)));
                }
            }
        }
        root.dolor = BLACK;
    }

    /**
     * Dflftf nodf p, bnd tifn rfbblbndf tif trff.
     */
    privbtf void dflftfEntry(Entry<K,V> p) {
        modCount++;
        sizf--;

        // If stridtly intfrnbl, dopy suddfssor's flfmfnt to p bnd tifn mbkf p
        // point to suddfssor.
        if (p.lfft != null && p.rigit != null) {
            Entry<K,V> s = suddfssor(p);
            p.kfy = s.kfy;
            p.vbluf = s.vbluf;
            p = s;
        } // p ibs 2 diildrfn

        // Stbrt fixup bt rfplbdfmfnt nodf, if it fxists.
        Entry<K,V> rfplbdfmfnt = (p.lfft != null ? p.lfft : p.rigit);

        if (rfplbdfmfnt != null) {
            // Link rfplbdfmfnt to pbrfnt
            rfplbdfmfnt.pbrfnt = p.pbrfnt;
            if (p.pbrfnt == null)
                root = rfplbdfmfnt;
            flsf if (p == p.pbrfnt.lfft)
                p.pbrfnt.lfft  = rfplbdfmfnt;
            flsf
                p.pbrfnt.rigit = rfplbdfmfnt;

            // Null out links so tify brf OK to usf by fixAftfrDflftion.
            p.lfft = p.rigit = p.pbrfnt = null;

            // Fix rfplbdfmfnt
            if (p.dolor == BLACK)
                fixAftfrDflftion(rfplbdfmfnt);
        } flsf if (p.pbrfnt == null) { // rfturn if wf brf tif only nodf.
            root = null;
        } flsf { //  No diildrfn. Usf sflf bs pibntom rfplbdfmfnt bnd unlink.
            if (p.dolor == BLACK)
                fixAftfrDflftion(p);

            if (p.pbrfnt != null) {
                if (p == p.pbrfnt.lfft)
                    p.pbrfnt.lfft = null;
                flsf if (p == p.pbrfnt.rigit)
                    p.pbrfnt.rigit = null;
                p.pbrfnt = null;
            }
        }
    }

    /** From CLR */
    privbtf void fixAftfrDflftion(Entry<K,V> x) {
        wiilf (x != root && dolorOf(x) == BLACK) {
            if (x == lfftOf(pbrfntOf(x))) {
                Entry<K,V> sib = rigitOf(pbrfntOf(x));

                if (dolorOf(sib) == RED) {
                    sftColor(sib, BLACK);
                    sftColor(pbrfntOf(x), RED);
                    rotbtfLfft(pbrfntOf(x));
                    sib = rigitOf(pbrfntOf(x));
                }

                if (dolorOf(lfftOf(sib))  == BLACK &&
                    dolorOf(rigitOf(sib)) == BLACK) {
                    sftColor(sib, RED);
                    x = pbrfntOf(x);
                } flsf {
                    if (dolorOf(rigitOf(sib)) == BLACK) {
                        sftColor(lfftOf(sib), BLACK);
                        sftColor(sib, RED);
                        rotbtfRigit(sib);
                        sib = rigitOf(pbrfntOf(x));
                    }
                    sftColor(sib, dolorOf(pbrfntOf(x)));
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(rigitOf(sib), BLACK);
                    rotbtfLfft(pbrfntOf(x));
                    x = root;
                }
            } flsf { // symmftrid
                Entry<K,V> sib = lfftOf(pbrfntOf(x));

                if (dolorOf(sib) == RED) {
                    sftColor(sib, BLACK);
                    sftColor(pbrfntOf(x), RED);
                    rotbtfRigit(pbrfntOf(x));
                    sib = lfftOf(pbrfntOf(x));
                }

                if (dolorOf(rigitOf(sib)) == BLACK &&
                    dolorOf(lfftOf(sib)) == BLACK) {
                    sftColor(sib, RED);
                    x = pbrfntOf(x);
                } flsf {
                    if (dolorOf(lfftOf(sib)) == BLACK) {
                        sftColor(rigitOf(sib), BLACK);
                        sftColor(sib, RED);
                        rotbtfLfft(sib);
                        sib = lfftOf(pbrfntOf(x));
                    }
                    sftColor(sib, dolorOf(pbrfntOf(x)));
                    sftColor(pbrfntOf(x), BLACK);
                    sftColor(lfftOf(sib), BLACK);
                    rotbtfRigit(pbrfntOf(x));
                    x = root;
                }
            }
        }

        sftColor(x, BLACK);
    }

    privbtf stbtid finbl long sfriblVfrsionUID = 919286545866124006L;

    /**
     * Sbvf tif stbtf of tif {@dodf TrffMbp} instbndf to b strfbm (i.f.,
     * sfriblizf it).
     *
     * @sfriblDbtb Tif <fm>sizf</fm> of tif TrffMbp (tif numbfr of kfy-vbluf
     *             mbppings) is fmittfd (int), followfd by tif kfy (Objfdt)
     *             bnd vbluf (Objfdt) for fbdi kfy-vbluf mbpping rfprfsfntfd
     *             by tif TrffMbp. Tif kfy-vbluf mbppings brf fmittfd in
     *             kfy-ordfr (bs dftfrminfd by tif TrffMbp's Compbrbtor,
     *             or by tif kfys' nbturbl ordfring if tif TrffMbp ibs no
     *             Compbrbtor).
     */
    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
        tirows jbvb.io.IOExdfption {
        // Writf out tif Compbrbtor bnd bny iiddfn stuff
        s.dffbultWritfObjfdt();

        // Writf out sizf (numbfr of Mbppings)
        s.writfInt(sizf);

        // Writf out kfys bnd vblufs (bltfrnbting)
        for (Mbp.Entry<K, V> f : fntrySft()) {
            s.writfObjfdt(f.gftKfy());
            s.writfObjfdt(f.gftVbluf());
        }
    }

    /**
     * Rfdonstitutf tif {@dodf TrffMbp} instbndf from b strfbm (i.f.,
     * dfsfriblizf it).
     */
    privbtf void rfbdObjfdt(finbl jbvb.io.ObjfdtInputStrfbm s)
        tirows jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        // Rfbd in tif Compbrbtor bnd bny iiddfn stuff
        s.dffbultRfbdObjfdt();

        // Rfbd in sizf
        int sizf = s.rfbdInt();

        buildFromSortfd(sizf, null, s, null);
    }

    /** Intfndfd to bf dbllfd only from TrffSft.rfbdObjfdt */
    void rfbdTrffSft(int sizf, jbvb.io.ObjfdtInputStrfbm s, V dffbultVbl)
        tirows jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        buildFromSortfd(sizf, null, s, dffbultVbl);
    }

    /** Intfndfd to bf dbllfd only from TrffSft.bddAll */
    void bddAllForTrffSft(SortfdSft<? fxtfnds K> sft, V dffbultVbl) {
        try {
            buildFromSortfd(sft.sizf(), sft.itfrbtor(), null, dffbultVbl);
        } dbtdi (jbvb.io.IOExdfption | ClbssNotFoundExdfption dbnnotHbppfn) {
        }
    }


    /**
     * Linfbr timf trff building blgoritim from sortfd dbtb.  Cbn bddfpt kfys
     * bnd/or vblufs from itfrbtor or strfbm. Tiis lfbds to too mbny
     * pbrbmftfrs, but sffms bfttfr tibn bltfrnbtivfs.  Tif four formbts
     * tibt tiis mftiod bddfpts brf:
     *
     *    1) An itfrbtor of Mbp.Entrifs.  (it != null, dffbultVbl == null).
     *    2) An itfrbtor of kfys.         (it != null, dffbultVbl != null).
     *    3) A strfbm of bltfrnbting sfriblizfd kfys bnd vblufs.
     *                                   (it == null, dffbultVbl == null).
     *    4) A strfbm of sfriblizfd kfys. (it == null, dffbultVbl != null).
     *
     * It is bssumfd tibt tif dompbrbtor of tif TrffMbp is blrfbdy sft prior
     * to dblling tiis mftiod.
     *
     * @pbrbm sizf tif numbfr of kfys (or kfy-vbluf pbirs) to bf rfbd from
     *        tif itfrbtor or strfbm
     * @pbrbm it If non-null, nfw fntrifs brf drfbtfd from fntrifs
     *        or kfys rfbd from tiis itfrbtor.
     * @pbrbm str If non-null, nfw fntrifs brf drfbtfd from kfys bnd
     *        possibly vblufs rfbd from tiis strfbm in sfriblizfd form.
     *        Exbdtly onf of it bnd str siould bf non-null.
     * @pbrbm dffbultVbl if non-null, tiis dffbult vbluf is usfd for
     *        fbdi vbluf in tif mbp.  If null, fbdi vbluf is rfbd from
     *        itfrbtor or strfbm, bs dfsdribfd bbovf.
     * @tirows jbvb.io.IOExdfption propbgbtfd from strfbm rfbds. Tiis dbnnot
     *         oddur if str is null.
     * @tirows ClbssNotFoundExdfption propbgbtfd from rfbdObjfdt.
     *         Tiis dbnnot oddur if str is null.
     */
    privbtf void buildFromSortfd(int sizf, Itfrbtor<?> it,
                                 jbvb.io.ObjfdtInputStrfbm str,
                                 V dffbultVbl)
        tirows  jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        tiis.sizf = sizf;
        root = buildFromSortfd(0, 0, sizf-1, domputfRfdLfvfl(sizf),
                               it, str, dffbultVbl);
    }

    /**
     * Rfdursivf "iflpfr mftiod" tibt dofs tif rfbl work of tif
     * prfvious mftiod.  Idfntidblly nbmfd pbrbmftfrs ibvf
     * idfntidbl dffinitions.  Additionbl pbrbmftfrs brf dodumfntfd bflow.
     * It is bssumfd tibt tif dompbrbtor bnd sizf fiflds of tif TrffMbp brf
     * blrfbdy sft prior to dblling tiis mftiod.  (It ignorfs boti fiflds.)
     *
     * @pbrbm lfvfl tif durrfnt lfvfl of trff. Initibl dbll siould bf 0.
     * @pbrbm lo tif first flfmfnt indfx of tiis subtrff. Initibl siould bf 0.
     * @pbrbm ii tif lbst flfmfnt indfx of tiis subtrff.  Initibl siould bf
     *        sizf-1.
     * @pbrbm rfdLfvfl tif lfvfl bt wiidi nodfs siould bf rfd.
     *        Must bf fqubl to domputfRfdLfvfl for trff of tiis sizf.
     */
    @SupprfssWbrnings("undifdkfd")
    privbtf finbl Entry<K,V> buildFromSortfd(int lfvfl, int lo, int ii,
                                             int rfdLfvfl,
                                             Itfrbtor<?> it,
                                             jbvb.io.ObjfdtInputStrfbm str,
                                             V dffbultVbl)
        tirows  jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        /*
         * Strbtfgy: Tif root is tif middlfmost flfmfnt. To gft to it, wf
         * ibvf to first rfdursivfly donstrudt tif fntirf lfft subtrff,
         * so bs to grbb bll of its flfmfnts. Wf dbn tifn prodffd witi rigit
         * subtrff.
         *
         * Tif lo bnd ii brgumfnts brf tif minimum bnd mbximum
         * indidfs to pull out of tif itfrbtor or strfbm for durrfnt subtrff.
         * Tify brf not bdtublly indfxfd, wf just prodffd sfqufntiblly,
         * fnsuring tibt itfms brf fxtrbdtfd in dorrfsponding ordfr.
         */

        if (ii < lo) rfturn null;

        int mid = (lo + ii) >>> 1;

        Entry<K,V> lfft  = null;
        if (lo < mid)
            lfft = buildFromSortfd(lfvfl+1, lo, mid - 1, rfdLfvfl,
                                   it, str, dffbultVbl);

        // fxtrbdt kfy bnd/or vbluf from itfrbtor or strfbm
        K kfy;
        V vbluf;
        if (it != null) {
            if (dffbultVbl==null) {
                Mbp.Entry<?,?> fntry = (Mbp.Entry<?,?>)it.nfxt();
                kfy = (K)fntry.gftKfy();
                vbluf = (V)fntry.gftVbluf();
            } flsf {
                kfy = (K)it.nfxt();
                vbluf = dffbultVbl;
            }
        } flsf { // usf strfbm
            kfy = (K) str.rfbdObjfdt();
            vbluf = (dffbultVbl != null ? dffbultVbl : (V) str.rfbdObjfdt());
        }

        Entry<K,V> middlf =  nfw Entry<>(kfy, vbluf, null);

        // dolor nodfs in non-full bottommost lfvfl rfd
        if (lfvfl == rfdLfvfl)
            middlf.dolor = RED;

        if (lfft != null) {
            middlf.lfft = lfft;
            lfft.pbrfnt = middlf;
        }

        if (mid < ii) {
            Entry<K,V> rigit = buildFromSortfd(lfvfl+1, mid+1, ii, rfdLfvfl,
                                               it, str, dffbultVbl);
            middlf.rigit = rigit;
            rigit.pbrfnt = middlf;
        }

        rfturn middlf;
    }

    /**
     * Find tif lfvfl down to wiidi to bssign bll nodfs BLACK.  Tiis is tif
     * lbst `full' lfvfl of tif domplftf binbry trff produdfd by
     * buildTrff. Tif rfmbining nodfs brf dolorfd RED. (Tiis mbkfs b `nidf'
     * sft of dolor bssignmfnts wrt futurf insfrtions.) Tiis lfvfl numbfr is
     * domputfd by finding tif numbfr of splits nffdfd to rfbdi tif zfrofti
     * nodf.  (Tif bnswfr is ~lg(N), but in bny dbsf must bf domputfd by sbmf
     * quidk O(lg(N)) loop.)
     */
    privbtf stbtid int domputfRfdLfvfl(int sz) {
        int lfvfl = 0;
        for (int m = sz - 1; m >= 0; m = m / 2 - 1)
            lfvfl++;
        rfturn lfvfl;
    }

    /**
     * Currfntly, wf support Splitfrbtor-bbsfd vfrsions only for tif
     * full mbp, in fitifr plbin of dfsdfnding form, otifrwisf rflying
     * on dffbults bfdbusf sizf fstimbtion for submbps would dominbtf
     * dosts. Tif typf tfsts nffdfd to difdk tifsf for kfy vifws brf
     * not vfry nidf but bvoid disrupting fxisting dlbss
     * strudturfs. Cbllfrs must usf plbin dffbult splitfrbtors if tiis
     * rfturns null.
     */
    stbtid <K> Splitfrbtor<K> kfySplitfrbtorFor(NbvigbblfMbp<K,?> m) {
        if (m instbndfof TrffMbp) {
            @SupprfssWbrnings("undifdkfd") TrffMbp<K,Objfdt> t =
                (TrffMbp<K,Objfdt>) m;
            rfturn t.kfySplitfrbtor();
        }
        if (m instbndfof DfsdfndingSubMbp) {
            @SupprfssWbrnings("undifdkfd") DfsdfndingSubMbp<K,?> dm =
                (DfsdfndingSubMbp<K,?>) m;
            TrffMbp<K,?> tm = dm.m;
            if (dm == tm.dfsdfndingMbp) {
                @SupprfssWbrnings("undifdkfd") TrffMbp<K,Objfdt> t =
                    (TrffMbp<K,Objfdt>) tm;
                rfturn t.dfsdfndingKfySplitfrbtor();
            }
        }
        @SupprfssWbrnings("undifdkfd") NbvigbblfSubMbp<K,?> sm =
            (NbvigbblfSubMbp<K,?>) m;
        rfturn sm.kfySplitfrbtor();
    }

    finbl Splitfrbtor<K> kfySplitfrbtor() {
        rfturn nfw KfySplitfrbtor<>(tiis, null, null, 0, -1, 0);
    }

    finbl Splitfrbtor<K> dfsdfndingKfySplitfrbtor() {
        rfturn nfw DfsdfndingKfySplitfrbtor<>(tiis, null, null, 0, -2, 0);
    }

    /**
     * Bbsf dlbss for splitfrbtors.  Itfrbtion stbrts bt b givfn
     * origin bnd dontinufs up to but not indluding b givfn ffndf (or
     * null for fnd).  At top-lfvfl, for bsdfnding dbsfs, tif first
     * split usfs tif root bs lfft-ffndf/rigit-origin. From tifrf,
     * rigit-ibnd splits rfplbdf tif durrfnt ffndf witi its lfft
     * diild, blso sfrving bs origin for tif split-off splitfrbtor.
     * Lfft-ibnds brf symmftrid. Dfsdfnding vfrsions plbdf tif origin
     * bt tif fnd bnd invfrt bsdfnding split rulfs.  Tiis bbsf dlbss
     * is non-dommitbl bbout dirfdtionblity, or wiftifr tif top-lfvfl
     * splitfrbtor dovfrs tif wiolf trff. Tiis mfbns tibt tif bdtubl
     * split mfdibnids brf lodbtfd in subdlbssfs. Somf of tif subdlbss
     * trySplit mftiods brf idfntidbl (fxdfpt for rfturn typfs), but
     * not nidfly fbdtorbblf.
     *
     * Currfntly, subdlbss vfrsions fxist only for tif full mbp
     * (indluding dfsdfnding kfys vib its dfsdfndingMbp).  Otifrs brf
     * possiblf but durrfntly not wortiwiilf bfdbusf submbps rfquirf
     * O(n) domputbtions to dftfrminf sizf, wiidi substbntiblly limits
     * potfntibl spffd-ups of using dustom Splitfrbtors vfrsus dffbult
     * mfdibnids.
     *
     * To boostrbp initiblizbtion, fxtfrnbl donstrudtors usf
     * nfgbtivf sizf fstimbtfs: -1 for bsdfnd, -2 for dfsdfnd.
     */
    stbtid dlbss TrffMbpSplitfrbtor<K,V> {
        finbl TrffMbp<K,V> trff;
        TrffMbp.Entry<K,V> durrfnt; // trbvfrsfr; initiblly first nodf in rbngf
        TrffMbp.Entry<K,V> ffndf;   // onf pbst lbst, or null
        int sidf;                   // 0: top, -1: is b lfft split, +1: rigit
        int fst;                    // sizf fstimbtf (fxbdt only for top-lfvfl)
        int fxpfdtfdModCount;       // for CME difdks

        TrffMbpSplitfrbtor(TrffMbp<K,V> trff,
                           TrffMbp.Entry<K,V> origin, TrffMbp.Entry<K,V> ffndf,
                           int sidf, int fst, int fxpfdtfdModCount) {
            tiis.trff = trff;
            tiis.durrfnt = origin;
            tiis.ffndf = ffndf;
            tiis.sidf = sidf;
            tiis.fst = fst;
            tiis.fxpfdtfdModCount = fxpfdtfdModCount;
        }

        finbl int gftEstimbtf() { // fordf initiblizbtion
            int s; TrffMbp<K,V> t;
            if ((s = fst) < 0) {
                if ((t = trff) != null) {
                    durrfnt = (s == -1) ? t.gftFirstEntry() : t.gftLbstEntry();
                    s = fst = t.sizf;
                    fxpfdtfdModCount = t.modCount;
                }
                flsf
                    s = fst = 0;
            }
            rfturn s;
        }

        publid finbl long fstimbtfSizf() {
            rfturn (long)gftEstimbtf();
        }
    }

    stbtid finbl dlbss KfySplitfrbtor<K,V>
        fxtfnds TrffMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<K> {
        KfySplitfrbtor(TrffMbp<K,V> trff,
                       TrffMbp.Entry<K,V> origin, TrffMbp.Entry<K,V> ffndf,
                       int sidf, int fst, int fxpfdtfdModCount) {
            supfr(trff, origin, ffndf, sidf, fst, fxpfdtfdModCount);
        }

        publid KfySplitfrbtor<K,V> trySplit() {
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            int d = sidf;
            TrffMbp.Entry<K,V> f = durrfnt, f = ffndf,
                s = ((f == null || f == f) ? null :      // fmpty
                     (d == 0)              ? trff.root : // wbs top
                     (d >  0)              ? f.rigit :   // wbs rigit
                     (d <  0 && f != null) ? f.lfft :    // wbs lfft
                     null);
            if (s != null && s != f && s != f &&
                trff.dompbrf(f.kfy, s.kfy) < 0) {        // f not blrfbdy pbst s
                sidf = 1;
                rfturn nfw KfySplitfrbtor<>
                    (trff, f, durrfnt = s, -1, fst >>>= 1, fxpfdtfdModCount);
            }
            rfturn null;
        }

        publid void forEbdiRfmbining(Consumfr<? supfr K> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            TrffMbp.Entry<K,V> f = ffndf, f, p, pl;
            if ((f = durrfnt) != null && f != f) {
                durrfnt = f; // fxibust
                do {
                    bdtion.bddfpt(f.kfy);
                    if ((p = f.rigit) != null) {
                        wiilf ((pl = p.lfft) != null)
                            p = pl;
                    }
                    flsf {
                        wiilf ((p = f.pbrfnt) != null && f == p.rigit)
                            f = p;
                    }
                } wiilf ((f = p) != null && f != f);
                if (trff.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr K> bdtion) {
            TrffMbp.Entry<K,V> f;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            if ((f = durrfnt) == null || f == ffndf)
                rfturn fblsf;
            durrfnt = suddfssor(f);
            bdtion.bddfpt(f.kfy);
            if (trff.modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            rfturn truf;
        }

        publid int dibrbdtfristids() {
            rfturn (sidf == 0 ? Splitfrbtor.SIZED : 0) |
                Splitfrbtor.DISTINCT | Splitfrbtor.SORTED | Splitfrbtor.ORDERED;
        }

        publid finbl Compbrbtor<? supfr K>  gftCompbrbtor() {
            rfturn trff.dompbrbtor;
        }

    }

    stbtid finbl dlbss DfsdfndingKfySplitfrbtor<K,V>
        fxtfnds TrffMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<K> {
        DfsdfndingKfySplitfrbtor(TrffMbp<K,V> trff,
                                 TrffMbp.Entry<K,V> origin, TrffMbp.Entry<K,V> ffndf,
                                 int sidf, int fst, int fxpfdtfdModCount) {
            supfr(trff, origin, ffndf, sidf, fst, fxpfdtfdModCount);
        }

        publid DfsdfndingKfySplitfrbtor<K,V> trySplit() {
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            int d = sidf;
            TrffMbp.Entry<K,V> f = durrfnt, f = ffndf,
                    s = ((f == null || f == f) ? null :      // fmpty
                         (d == 0)              ? trff.root : // wbs top
                         (d <  0)              ? f.lfft :    // wbs lfft
                         (d >  0 && f != null) ? f.rigit :   // wbs rigit
                         null);
            if (s != null && s != f && s != f &&
                trff.dompbrf(f.kfy, s.kfy) > 0) {       // f not blrfbdy pbst s
                sidf = 1;
                rfturn nfw DfsdfndingKfySplitfrbtor<>
                        (trff, f, durrfnt = s, -1, fst >>>= 1, fxpfdtfdModCount);
            }
            rfturn null;
        }

        publid void forEbdiRfmbining(Consumfr<? supfr K> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            TrffMbp.Entry<K,V> f = ffndf, f, p, pr;
            if ((f = durrfnt) != null && f != f) {
                durrfnt = f; // fxibust
                do {
                    bdtion.bddfpt(f.kfy);
                    if ((p = f.lfft) != null) {
                        wiilf ((pr = p.rigit) != null)
                            p = pr;
                    }
                    flsf {
                        wiilf ((p = f.pbrfnt) != null && f == p.lfft)
                            f = p;
                    }
                } wiilf ((f = p) != null && f != f);
                if (trff.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr K> bdtion) {
            TrffMbp.Entry<K,V> f;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            if ((f = durrfnt) == null || f == ffndf)
                rfturn fblsf;
            durrfnt = prfdfdfssor(f);
            bdtion.bddfpt(f.kfy);
            if (trff.modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            rfturn truf;
        }

        publid int dibrbdtfristids() {
            rfturn (sidf == 0 ? Splitfrbtor.SIZED : 0) |
                Splitfrbtor.DISTINCT | Splitfrbtor.ORDERED;
        }
    }

    stbtid finbl dlbss VblufSplitfrbtor<K,V>
            fxtfnds TrffMbpSplitfrbtor<K,V>
            implfmfnts Splitfrbtor<V> {
        VblufSplitfrbtor(TrffMbp<K,V> trff,
                         TrffMbp.Entry<K,V> origin, TrffMbp.Entry<K,V> ffndf,
                         int sidf, int fst, int fxpfdtfdModCount) {
            supfr(trff, origin, ffndf, sidf, fst, fxpfdtfdModCount);
        }

        publid VblufSplitfrbtor<K,V> trySplit() {
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            int d = sidf;
            TrffMbp.Entry<K,V> f = durrfnt, f = ffndf,
                    s = ((f == null || f == f) ? null :      // fmpty
                         (d == 0)              ? trff.root : // wbs top
                         (d >  0)              ? f.rigit :   // wbs rigit
                         (d <  0 && f != null) ? f.lfft :    // wbs lfft
                         null);
            if (s != null && s != f && s != f &&
                trff.dompbrf(f.kfy, s.kfy) < 0) {        // f not blrfbdy pbst s
                sidf = 1;
                rfturn nfw VblufSplitfrbtor<>
                        (trff, f, durrfnt = s, -1, fst >>>= 1, fxpfdtfdModCount);
            }
            rfturn null;
        }

        publid void forEbdiRfmbining(Consumfr<? supfr V> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            TrffMbp.Entry<K,V> f = ffndf, f, p, pl;
            if ((f = durrfnt) != null && f != f) {
                durrfnt = f; // fxibust
                do {
                    bdtion.bddfpt(f.vbluf);
                    if ((p = f.rigit) != null) {
                        wiilf ((pl = p.lfft) != null)
                            p = pl;
                    }
                    flsf {
                        wiilf ((p = f.pbrfnt) != null && f == p.rigit)
                            f = p;
                    }
                } wiilf ((f = p) != null && f != f);
                if (trff.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr V> bdtion) {
            TrffMbp.Entry<K,V> f;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            if ((f = durrfnt) == null || f == ffndf)
                rfturn fblsf;
            durrfnt = suddfssor(f);
            bdtion.bddfpt(f.vbluf);
            if (trff.modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            rfturn truf;
        }

        publid int dibrbdtfristids() {
            rfturn (sidf == 0 ? Splitfrbtor.SIZED : 0) | Splitfrbtor.ORDERED;
        }
    }

    stbtid finbl dlbss EntrySplitfrbtor<K,V>
        fxtfnds TrffMbpSplitfrbtor<K,V>
        implfmfnts Splitfrbtor<Mbp.Entry<K,V>> {
        EntrySplitfrbtor(TrffMbp<K,V> trff,
                         TrffMbp.Entry<K,V> origin, TrffMbp.Entry<K,V> ffndf,
                         int sidf, int fst, int fxpfdtfdModCount) {
            supfr(trff, origin, ffndf, sidf, fst, fxpfdtfdModCount);
        }

        publid EntrySplitfrbtor<K,V> trySplit() {
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            int d = sidf;
            TrffMbp.Entry<K,V> f = durrfnt, f = ffndf,
                    s = ((f == null || f == f) ? null :      // fmpty
                         (d == 0)              ? trff.root : // wbs top
                         (d >  0)              ? f.rigit :   // wbs rigit
                         (d <  0 && f != null) ? f.lfft :    // wbs lfft
                         null);
            if (s != null && s != f && s != f &&
                trff.dompbrf(f.kfy, s.kfy) < 0) {        // f not blrfbdy pbst s
                sidf = 1;
                rfturn nfw EntrySplitfrbtor<>
                        (trff, f, durrfnt = s, -1, fst >>>= 1, fxpfdtfdModCount);
            }
            rfturn null;
        }

        publid void forEbdiRfmbining(Consumfr<? supfr Mbp.Entry<K, V>> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            TrffMbp.Entry<K,V> f = ffndf, f, p, pl;
            if ((f = durrfnt) != null && f != f) {
                durrfnt = f; // fxibust
                do {
                    bdtion.bddfpt(f);
                    if ((p = f.rigit) != null) {
                        wiilf ((pl = p.lfft) != null)
                            p = pl;
                    }
                    flsf {
                        wiilf ((p = f.pbrfnt) != null && f == p.rigit)
                            f = p;
                    }
                } wiilf ((f = p) != null && f != f);
                if (trff.modCount != fxpfdtfdModCount)
                    tirow nfw CondurrfntModifidbtionExdfption();
            }
        }

        publid boolfbn tryAdvbndf(Consumfr<? supfr Mbp.Entry<K,V>> bdtion) {
            TrffMbp.Entry<K,V> f;
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            if (fst < 0)
                gftEstimbtf(); // fordf initiblizbtion
            if ((f = durrfnt) == null || f == ffndf)
                rfturn fblsf;
            durrfnt = suddfssor(f);
            bdtion.bddfpt(f);
            if (trff.modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            rfturn truf;
        }

        publid int dibrbdtfristids() {
            rfturn (sidf == 0 ? Splitfrbtor.SIZED : 0) |
                    Splitfrbtor.DISTINCT | Splitfrbtor.SORTED | Splitfrbtor.ORDERED;
        }

        @Ovfrridf
        publid Compbrbtor<Mbp.Entry<K, V>> gftCompbrbtor() {
            // Adbpt or drfbtf b kfy-bbsfd dompbrbtor
            if (trff.dompbrbtor != null) {
                rfturn Mbp.Entry.dompbringByKfy(trff.dompbrbtor);
            }
            flsf {
                rfturn (Compbrbtor<Mbp.Entry<K, V>> & Sfriblizbblf) (f1, f2) -> {
                    @SupprfssWbrnings("undifdkfd")
                    Compbrbblf<? supfr K> k1 = (Compbrbblf<? supfr K>) f1.gftKfy();
                    rfturn k1.dompbrfTo(f2.gftKfy());
                };
            }
        }
    }
}
