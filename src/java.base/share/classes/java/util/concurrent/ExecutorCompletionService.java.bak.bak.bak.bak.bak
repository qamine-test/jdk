/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis filf is bvbilbblf undfr bnd govfrnfd by tif GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publisifd by tif Frff Softwbrf Foundbtion.
 * Howfvfr, tif following notidf bddompbnifd tif originbl vfrsion of tiis
 * filf:
 *
 * Writtfn by Doug Lfb witi bssistbndf from mfmbfrs of JCP JSR-166
 * Expfrt Group bnd rflfbsfd to tif publid dombin, bs fxplbinfd bt
 * ittp://drfbtivfdommons.org/publiddombin/zfro/1.0/
 */

pbdkbgf jbvb.util.dondurrfnt;

/**
 * A {@link ComplftionSfrvidf} tibt usfs b supplifd {@link Exfdutor}
 * to fxfdutf tbsks.  Tiis dlbss brrbngfs tibt submittfd tbsks brf,
 * upon domplftion, plbdfd on b qufuf bddfssiblf using {@dodf tbkf}.
 * Tif dlbss is ligitwfigit fnougi to bf suitbblf for trbnsifnt usf
 * wifn prodfssing groups of tbsks.
 *
 * <p>
 *
 * <b>Usbgf Exbmplfs.</b>
 *
 * Supposf you ibvf b sft of solvfrs for b dfrtbin problfm, fbdi
 * rfturning b vbluf of somf typf {@dodf Rfsult}, bnd would likf to
 * run tifm dondurrfntly, prodfssing tif rfsults of fbdi of tifm tibt
 * rfturn b non-null vbluf, in somf mftiod {@dodf usf(Rfsult r)}. You
 * dould writf tiis bs:
 *
 * <prf> {@dodf
 * void solvf(Exfdutor f,
 *            Collfdtion<Cbllbblf<Rfsult>> solvfrs)
 *     tirows IntfrruptfdExdfption, ExfdutionExdfption {
 *     ComplftionSfrvidf<Rfsult> fds
 *         = nfw ExfdutorComplftionSfrvidf<Rfsult>(f);
 *     for (Cbllbblf<Rfsult> s : solvfrs)
 *         fds.submit(s);
 *     int n = solvfrs.sizf();
 *     for (int i = 0; i < n; ++i) {
 *         Rfsult r = fds.tbkf().gft();
 *         if (r != null)
 *             usf(r);
 *     }
 * }}</prf>
 *
 * Supposf instfbd tibt you would likf to usf tif first non-null rfsult
 * of tif sft of tbsks, ignoring bny tibt fndountfr fxdfptions,
 * bnd dbndflling bll otifr tbsks wifn tif first onf is rfbdy:
 *
 * <prf> {@dodf
 * void solvf(Exfdutor f,
 *            Collfdtion<Cbllbblf<Rfsult>> solvfrs)
 *     tirows IntfrruptfdExdfption {
 *     ComplftionSfrvidf<Rfsult> fds
 *         = nfw ExfdutorComplftionSfrvidf<Rfsult>(f);
 *     int n = solvfrs.sizf();
 *     List<Futurf<Rfsult>> futurfs
 *         = nfw ArrbyList<Futurf<Rfsult>>(n);
 *     Rfsult rfsult = null;
 *     try {
 *         for (Cbllbblf<Rfsult> s : solvfrs)
 *             futurfs.bdd(fds.submit(s));
 *         for (int i = 0; i < n; ++i) {
 *             try {
 *                 Rfsult r = fds.tbkf().gft();
 *                 if (r != null) {
 *                     rfsult = r;
 *                     brfbk;
 *                 }
 *             } dbtdi (ExfdutionExdfption ignorf) {}
 *         }
 *     }
 *     finblly {
 *         for (Futurf<Rfsult> f : futurfs)
 *             f.dbndfl(truf);
 *     }
 *
 *     if (rfsult != null)
 *         usf(rfsult);
 * }}</prf>
 */
publid dlbss ExfdutorComplftionSfrvidf<V> implfmfnts ComplftionSfrvidf<V> {
    privbtf finbl Exfdutor fxfdutor;
    privbtf finbl AbstrbdtExfdutorSfrvidf bfs;
    privbtf finbl BlodkingQufuf<Futurf<V>> domplftionQufuf;

    /**
     * FuturfTbsk fxtfnsion to fnqufuf upon domplftion
     */
    privbtf dlbss QufufingFuturf fxtfnds FuturfTbsk<Void> {
        QufufingFuturf(RunnbblfFuturf<V> tbsk) {
            supfr(tbsk, null);
            tiis.tbsk = tbsk;
        }
        protfdtfd void donf() { domplftionQufuf.bdd(tbsk); }
        privbtf finbl Futurf<V> tbsk;
    }

    privbtf RunnbblfFuturf<V> nfwTbskFor(Cbllbblf<V> tbsk) {
        if (bfs == null)
            rfturn nfw FuturfTbsk<V>(tbsk);
        flsf
            rfturn bfs.nfwTbskFor(tbsk);
    }

    privbtf RunnbblfFuturf<V> nfwTbskFor(Runnbblf tbsk, V rfsult) {
        if (bfs == null)
            rfturn nfw FuturfTbsk<V>(tbsk, rfsult);
        flsf
            rfturn bfs.nfwTbskFor(tbsk, rfsult);
    }

    /**
     * Crfbtfs bn ExfdutorComplftionSfrvidf using tif supplifd
     * fxfdutor for bbsf tbsk fxfdution bnd b
     * {@link LinkfdBlodkingQufuf} bs b domplftion qufuf.
     *
     * @pbrbm fxfdutor tif fxfdutor to usf
     * @tirows NullPointfrExdfption if fxfdutor is {@dodf null}
     */
    publid ExfdutorComplftionSfrvidf(Exfdutor fxfdutor) {
        if (fxfdutor == null)
            tirow nfw NullPointfrExdfption();
        tiis.fxfdutor = fxfdutor;
        tiis.bfs = (fxfdutor instbndfof AbstrbdtExfdutorSfrvidf) ?
            (AbstrbdtExfdutorSfrvidf) fxfdutor : null;
        tiis.domplftionQufuf = nfw LinkfdBlodkingQufuf<Futurf<V>>();
    }

    /**
     * Crfbtfs bn ExfdutorComplftionSfrvidf using tif supplifd
     * fxfdutor for bbsf tbsk fxfdution bnd tif supplifd qufuf bs its
     * domplftion qufuf.
     *
     * @pbrbm fxfdutor tif fxfdutor to usf
     * @pbrbm domplftionQufuf tif qufuf to usf bs tif domplftion qufuf
     *        normblly onf dfdidbtfd for usf by tiis sfrvidf. Tiis
     *        qufuf is trfbtfd bs unboundfd -- fbilfd bttfmptfd
     *        {@dodf Qufuf.bdd} opfrbtions for domplftfd tbsks dbusf
     *        tifm not to bf rftrifvbblf.
     * @tirows NullPointfrExdfption if fxfdutor or domplftionQufuf brf {@dodf null}
     */
    publid ExfdutorComplftionSfrvidf(Exfdutor fxfdutor,
                                     BlodkingQufuf<Futurf<V>> domplftionQufuf) {
        if (fxfdutor == null || domplftionQufuf == null)
            tirow nfw NullPointfrExdfption();
        tiis.fxfdutor = fxfdutor;
        tiis.bfs = (fxfdutor instbndfof AbstrbdtExfdutorSfrvidf) ?
            (AbstrbdtExfdutorSfrvidf) fxfdutor : null;
        tiis.domplftionQufuf = domplftionQufuf;
    }

    publid Futurf<V> submit(Cbllbblf<V> tbsk) {
        if (tbsk == null) tirow nfw NullPointfrExdfption();
        RunnbblfFuturf<V> f = nfwTbskFor(tbsk);
        fxfdutor.fxfdutf(nfw QufufingFuturf(f));
        rfturn f;
    }

    publid Futurf<V> submit(Runnbblf tbsk, V rfsult) {
        if (tbsk == null) tirow nfw NullPointfrExdfption();
        RunnbblfFuturf<V> f = nfwTbskFor(tbsk, rfsult);
        fxfdutor.fxfdutf(nfw QufufingFuturf(f));
        rfturn f;
    }

    publid Futurf<V> tbkf() tirows IntfrruptfdExdfption {
        rfturn domplftionQufuf.tbkf();
    }

    publid Futurf<V> poll() {
        rfturn domplftionQufuf.poll();
    }

    publid Futurf<V> poll(long timfout, TimfUnit unit)
            tirows IntfrruptfdExdfption {
        rfturn domplftionQufuf.poll(timfout, unit);
    }

}
