/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis filf is bvbilbblf undfr bnd govfrnfd by tif GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publisifd by tif Frff Softwbrf Foundbtion.
 * Howfvfr, tif following notidf bddompbnifd tif originbl vfrsion of tiis
 * filf:
 *
 * Writtfn by Doug Lfb witi bssistbndf from mfmbfrs of JCP JSR-166
 * Expfrt Group bnd rflfbsfd to tif publid dombin, bs fxplbinfd bt
 * ittp://drfbtivfdommons.org/publiddombin/zfro/1.0/
 */

pbdkbgf jbvb.util.dondurrfnt;
import jbvb.util.Mbp;
import jbvb.util.Objfdts;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BiFundtion;
import jbvb.util.fundtion.Fundtion;

/**
 * A {@link jbvb.util.Mbp} providing tirfbd sbffty bnd btomidity
 * gubrbntffs.
 *
 * <p>Mfmory donsistfndy ffffdts: As witi otifr dondurrfnt
 * dollfdtions, bdtions in b tirfbd prior to plbding bn objfdt into b
 * {@dodf CondurrfntMbp} bs b kfy or vbluf
 * <b irff="pbdkbgf-summbry.itml#MfmoryVisibility"><i>ibppfn-bfforf</i></b>
 * bdtions subsfqufnt to tif bddfss or rfmovbl of tibt objfdt from
 * tif {@dodf CondurrfntMbp} in bnotifr tirfbd.
 *
 * <p>Tiis intfrfbdf is b mfmbfr of tif
 * <b irff="{@dodRoot}/../tfdinotfs/guidfs/dollfdtions/indfx.itml">
 * Jbvb Collfdtions Frbmfwork</b>.
 *
 * @sindf 1.5
 * @butior Doug Lfb
 * @pbrbm <K> tif typf of kfys mbintbinfd by tiis mbp
 * @pbrbm <V> tif typf of mbppfd vblufs
 */
publid intfrfbdf CondurrfntMbp<K, V> fxtfnds Mbp<K, V> {

    /**
     * {@inifritDod}
     *
     * @implNotf Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot
     * dontbin null vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns
     * tif kfy is bbsfnt. Implfmfntbtions wiidi support null vblufs
     * <strong>must</strong> ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult V gftOrDffbult(Objfdt kfy, V dffbultVbluf) {
        V v;
        rfturn ((v = gft(kfy)) != null) ? v : dffbultVbluf;
    }

   /**
     * {@inifritDod}
     *
     * @implSpfd Tif dffbult implfmfntbtion is fquivblfnt to, for tiis
     * {@dodf mbp}:
     * <prf> {@dodf
     * for ((Mbp.Entry<K, V> fntry : mbp.fntrySft())
     *     bdtion.bddfpt(fntry.gftKfy(), fntry.gftVbluf());
     * }</prf>
     *
     * @implNotf Tif dffbult implfmfntbtion bssumfs tibt
     * {@dodf IllfgblStbtfExdfption} tirown by {@dodf gftKfy()} or
     * {@dodf gftVbluf()} indidbtfs tibt tif fntry ibs bffn rfmovfd bnd dbnnot
     * bf prodfssfd. Opfrbtion dontinufs for subsfqufnt fntrifs.
     *
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult void forEbdi(BiConsumfr<? supfr K, ? supfr V> bdtion) {
        Objfdts.rfquirfNonNull(bdtion);
        for (Mbp.Entry<K, V> fntry : fntrySft()) {
            K k;
            V v;
            try {
                k = fntry.gftKfy();
                v = fntry.gftVbluf();
            } dbtdi(IllfgblStbtfExdfption isf) {
                // tiis usublly mfbns tif fntry is no longfr in tif mbp.
                dontinuf;
            }
            bdtion.bddfpt(k, v);
        }
    }

    /**
     * If tif spfdififd kfy is not blrfbdy bssodibtfd
     * witi b vbluf, bssodibtf it witi tif givfn vbluf.
     * Tiis is fquivblfnt to
     *  <prf> {@dodf
     * if (!mbp.dontbinsKfy(kfy))
     *   rfturn mbp.put(kfy, vbluf);
     * flsf
     *   rfturn mbp.gft(kfy);
     * }</prf>
     *
     * fxdfpt tibt tif bdtion is pfrformfd btomidblly.
     *
     * @implNotf Tiis implfmfntbtion intfntionblly rf-bbstrbdts tif
     * inbppropribtf dffbult providfd in {@dodf Mbp}.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is to bf bssodibtfd
     * @pbrbm vbluf vbluf to bf bssodibtfd witi tif spfdififd kfy
     * @rfturn tif prfvious vbluf bssodibtfd witi tif spfdififd kfy, or
     *         {@dodf null} if tifrf wbs no mbpping for tif kfy.
     *         (A {@dodf null} rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd {@dodf null} witi tif kfy,
     *         if tif implfmfntbtion supports null vblufs.)
     * @tirows UnsupportfdOpfrbtionExdfption if tif {@dodf put} opfrbtion
     *         is not supportfd by tiis mbp
     * @tirows ClbssCbstExdfption if tif dlbss of tif spfdififd kfy or vbluf
     *         prfvfnts it from bfing storfd in tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy or vbluf is null,
     *         bnd tiis mbp dofs not pfrmit null kfys or vblufs
     * @tirows IllfgblArgumfntExdfption if somf propfrty of tif spfdififd kfy
     *         or vbluf prfvfnts it from bfing storfd in tiis mbp
     */
     V putIfAbsfnt(K kfy, V vbluf);

    /**
     * Rfmovfs tif fntry for b kfy only if durrfntly mbppfd to b givfn vbluf.
     * Tiis is fquivblfnt to
     *  <prf> {@dodf
     * if (mbp.dontbinsKfy(kfy) && Objfdts.fqubls(mbp.gft(kfy), vbluf)) {
     *   mbp.rfmovf(kfy);
     *   rfturn truf;
     * } flsf
     *   rfturn fblsf;
     * }</prf>
     *
     * fxdfpt tibt tif bdtion is pfrformfd btomidblly.
     *
     * @implNotf Tiis implfmfntbtion intfntionblly rf-bbstrbdts tif
     * inbppropribtf dffbult providfd in {@dodf Mbp}.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is bssodibtfd
     * @pbrbm vbluf vbluf fxpfdtfd to bf bssodibtfd witi tif spfdififd kfy
     * @rfturn {@dodf truf} if tif vbluf wbs rfmovfd
     * @tirows UnsupportfdOpfrbtionExdfption if tif {@dodf rfmovf} opfrbtion
     *         is not supportfd by tiis mbp
     * @tirows ClbssCbstExdfption if tif kfy or vbluf is of bn inbppropribtf
     *         typf for tiis mbp
     *         (<b irff="../Collfdtion.itml#optionbl-rfstridtions">optionbl</b>)
     * @tirows NullPointfrExdfption if tif spfdififd kfy or vbluf is null,
     *         bnd tiis mbp dofs not pfrmit null kfys or vblufs
     *         (<b irff="../Collfdtion.itml#optionbl-rfstridtions">optionbl</b>)
     */
    boolfbn rfmovf(Objfdt kfy, Objfdt vbluf);

    /**
     * Rfplbdfs tif fntry for b kfy only if durrfntly mbppfd to b givfn vbluf.
     * Tiis is fquivblfnt to
     *  <prf> {@dodf
     * if (mbp.dontbinsKfy(kfy) && Objfdts.fqubls(mbp.gft(kfy), oldVbluf)) {
     *   mbp.put(kfy, nfwVbluf);
     *   rfturn truf;
     * } flsf
     *   rfturn fblsf;
     * }</prf>
     *
     * fxdfpt tibt tif bdtion is pfrformfd btomidblly.
     *
     * @implNotf Tiis implfmfntbtion intfntionblly rf-bbstrbdts tif
     * inbppropribtf dffbult providfd in {@dodf Mbp}.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is bssodibtfd
     * @pbrbm oldVbluf vbluf fxpfdtfd to bf bssodibtfd witi tif spfdififd kfy
     * @pbrbm nfwVbluf vbluf to bf bssodibtfd witi tif spfdififd kfy
     * @rfturn {@dodf truf} if tif vbluf wbs rfplbdfd
     * @tirows UnsupportfdOpfrbtionExdfption if tif {@dodf put} opfrbtion
     *         is not supportfd by tiis mbp
     * @tirows ClbssCbstExdfption if tif dlbss of b spfdififd kfy or vbluf
     *         prfvfnts it from bfing storfd in tiis mbp
     * @tirows NullPointfrExdfption if b spfdififd kfy or vbluf is null,
     *         bnd tiis mbp dofs not pfrmit null kfys or vblufs
     * @tirows IllfgblArgumfntExdfption if somf propfrty of b spfdififd kfy
     *         or vbluf prfvfnts it from bfing storfd in tiis mbp
     */
    boolfbn rfplbdf(K kfy, V oldVbluf, V nfwVbluf);

    /**
     * Rfplbdfs tif fntry for b kfy only if durrfntly mbppfd to somf vbluf.
     * Tiis is fquivblfnt to
     *  <prf> {@dodf
     * if (mbp.dontbinsKfy(kfy)) {
     *   rfturn mbp.put(kfy, vbluf);
     * } flsf
     *   rfturn null;
     * }</prf>
     *
     * fxdfpt tibt tif bdtion is pfrformfd btomidblly.
     *
     * @implNotf Tiis implfmfntbtion intfntionblly rf-bbstrbdts tif
     * inbppropribtf dffbult providfd in {@dodf Mbp}.
     *
     * @pbrbm kfy kfy witi wiidi tif spfdififd vbluf is bssodibtfd
     * @pbrbm vbluf vbluf to bf bssodibtfd witi tif spfdififd kfy
     * @rfturn tif prfvious vbluf bssodibtfd witi tif spfdififd kfy, or
     *         {@dodf null} if tifrf wbs no mbpping for tif kfy.
     *         (A {@dodf null} rfturn dbn blso indidbtf tibt tif mbp
     *         prfviously bssodibtfd {@dodf null} witi tif kfy,
     *         if tif implfmfntbtion supports null vblufs.)
     * @tirows UnsupportfdOpfrbtionExdfption if tif {@dodf put} opfrbtion
     *         is not supportfd by tiis mbp
     * @tirows ClbssCbstExdfption if tif dlbss of tif spfdififd kfy or vbluf
     *         prfvfnts it from bfing storfd in tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd kfy or vbluf is null,
     *         bnd tiis mbp dofs not pfrmit null kfys or vblufs
     * @tirows IllfgblArgumfntExdfption if somf propfrty of tif spfdififd kfy
     *         or vbluf prfvfnts it from bfing storfd in tiis mbp
     */
    V rfplbdf(K kfy, V vbluf);

    /**
     * {@inifritDod}
     *
     * @implSpfd
     * <p>Tif dffbult implfmfntbtion is fquivblfnt to, for tiis {@dodf mbp}:
     * <prf> {@dodf
     * for ((Mbp.Entry<K, V> fntry : mbp.fntrySft())
     *     do {
     *        K k = fntry.gftKfy();
     *        V v = fntry.gftVbluf();
     *     } wiilf(!rfplbdf(k, v, fundtion.bpply(k, v)));
     * }</prf>
     *
     * Tif dffbult implfmfntbtion mby rftry tifsf stfps wifn multiplf
     * tirfbds bttfmpt updbtfs indluding potfntiblly dblling tif fundtion
     * rfpfbtfdly for b givfn kfy.
     *
     * <p>Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot dontbin null
     * vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns tif kfy is
     * bbsfnt. Implfmfntbtions wiidi support null vblufs <strong>must</strong>
     * ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows UnsupportfdOpfrbtionExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult void rfplbdfAll(BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> fundtion) {
        Objfdts.rfquirfNonNull(fundtion);
        forEbdi((k,v) -> {
            wiilf(!rfplbdf(k, v, fundtion.bpply(k, v))) {
                // v dibngfd or k is gonf
                if ( (v = gft(k)) == null) {
                    // k is no longfr in tif mbp.
                    brfbk;
                }
            }
        });
    }

    /**
     * {@inifritDod}
     *
     * @implSpfd
     * Tif dffbult implfmfntbtion is fquivblfnt to tif following stfps for tiis
     * {@dodf mbp}, tifn rfturning tif durrfnt vbluf or {@dodf null} if now
     * bbsfnt:
     *
     * <prf> {@dodf
     * if (mbp.gft(kfy) == null) {
     *     V nfwVbluf = mbppingFundtion.bpply(kfy);
     *     if (nfwVbluf != null)
     *         rfturn mbp.putIfAbsfnt(kfy, nfwVbluf);
     * }
     * }</prf>
     *
     * Tif dffbult implfmfntbtion mby rftry tifsf stfps wifn multiplf
     * tirfbds bttfmpt updbtfs indluding potfntiblly dblling tif mbpping
     * fundtion multiplf timfs.
     *
     * <p>Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot dontbin null
     * vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns tif kfy is
     * bbsfnt. Implfmfntbtions wiidi support null vblufs <strong>must</strong>
     * ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows UnsupportfdOpfrbtionExdfption {@inifritDod}
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult V domputfIfAbsfnt(K kfy,
            Fundtion<? supfr K, ? fxtfnds V> mbppingFundtion) {
        Objfdts.rfquirfNonNull(mbppingFundtion);
        V v, nfwVbluf;
        rfturn ((v = gft(kfy)) == null &&
                (nfwVbluf = mbppingFundtion.bpply(kfy)) != null &&
                (v = putIfAbsfnt(kfy, nfwVbluf)) == null) ? nfwVbluf : v;
    }

    /**
     * {@inifritDod}
     *
     * @implSpfd
     * Tif dffbult implfmfntbtion is fquivblfnt to pfrforming tif following
     * stfps for tiis {@dodf mbp}, tifn rfturning tif durrfnt vbluf or
     * {@dodf null} if now bbsfnt. :
     *
     * <prf> {@dodf
     * if (mbp.gft(kfy) != null) {
     *     V oldVbluf = mbp.gft(kfy);
     *     V nfwVbluf = rfmbppingFundtion.bpply(kfy, oldVbluf);
     *     if (nfwVbluf != null)
     *         mbp.rfplbdf(kfy, oldVbluf, nfwVbluf);
     *     flsf
     *         mbp.rfmovf(kfy, oldVbluf);
     * }
     * }</prf>
     *
     * Tif dffbult implfmfntbtion mby rftry tifsf stfps wifn multiplf tirfbds
     * bttfmpt updbtfs indluding potfntiblly dblling tif rfmbpping fundtion
     * multiplf timfs.
     *
     * <p>Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot dontbin null
     * vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns tif kfy is
     * bbsfnt. Implfmfntbtions wiidi support null vblufs <strong>must</strong>
     * ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows UnsupportfdOpfrbtionExdfption {@inifritDod}
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult V domputfIfPrfsfnt(K kfy,
            BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        Objfdts.rfquirfNonNull(rfmbppingFundtion);
        V oldVbluf;
        wiilf((oldVbluf = gft(kfy)) != null) {
            V nfwVbluf = rfmbppingFundtion.bpply(kfy, oldVbluf);
            if (nfwVbluf != null) {
                if (rfplbdf(kfy, oldVbluf, nfwVbluf))
                    rfturn nfwVbluf;
            } flsf if (rfmovf(kfy, oldVbluf))
               rfturn null;
        }
        rfturn oldVbluf;
    }

    /**
     * {@inifritDod}
     *
     * @implSpfd
     * Tif dffbult implfmfntbtion is fquivblfnt to pfrforming tif following
     * stfps for tiis {@dodf mbp}, tifn rfturning tif durrfnt vbluf or
     * {@dodf null} if bbsfnt:
     *
     * <prf> {@dodf
     * V oldVbluf = mbp.gft(kfy);
     * V nfwVbluf = rfmbppingFundtion.bpply(kfy, oldVbluf);
     * if (oldVbluf != null ) {
     *    if (nfwVbluf != null)
     *       mbp.rfplbdf(kfy, oldVbluf, nfwVbluf);
     *    flsf
     *       mbp.rfmovf(kfy, oldVbluf);
     * } flsf {
     *    if (nfwVbluf != null)
     *       mbp.putIfAbsfnt(kfy, nfwVbluf);
     *    flsf
     *       rfturn null;
     * }
     * }</prf>
     *
     * Tif dffbult implfmfntbtion mby rftry tifsf stfps wifn multiplf
     * tirfbds bttfmpt updbtfs indluding potfntiblly dblling tif rfmbpping
     * fundtion multiplf timfs.
     *
     * <p>Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot dontbin null
     * vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns tif kfy is
     * bbsfnt. Implfmfntbtions wiidi support null vblufs <strong>must</strong>
     * ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows UnsupportfdOpfrbtionExdfption {@inifritDod}
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult V domputf(K kfy,
            BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        Objfdts.rfquirfNonNull(rfmbppingFundtion);
        V oldVbluf = gft(kfy);
        for(;;) {
            V nfwVbluf = rfmbppingFundtion.bpply(kfy, oldVbluf);
            if (nfwVbluf == null) {
                // dflftf mbpping
                if (oldVbluf != null || dontbinsKfy(kfy)) {
                    // somftiing to rfmovf
                    if (rfmovf(kfy, oldVbluf)) {
                        // rfmovfd tif old vbluf bs fxpfdtfd
                        rfturn null;
                    }

                    // somf otifr vbluf rfplbdfd old vbluf. try bgbin.
                    oldVbluf = gft(kfy);
                } flsf {
                    // notiing to do. Lfbvf tiings bs tify wfrf.
                    rfturn null;
                }
            } flsf {
                // bdd or rfplbdf old mbpping
                if (oldVbluf != null) {
                    // rfplbdf
                    if (rfplbdf(kfy, oldVbluf, nfwVbluf)) {
                        // rfplbdfd bs fxpfdtfd.
                        rfturn nfwVbluf;
                    }

                    // somf otifr vbluf rfplbdfd old vbluf. try bgbin.
                    oldVbluf = gft(kfy);
                } flsf {
                    // bdd (rfplbdf if oldVbluf wbs null)
                    if ((oldVbluf = putIfAbsfnt(kfy, nfwVbluf)) == null) {
                        // rfplbdfd
                        rfturn nfwVbluf;
                    }

                    // somf otifr vbluf rfplbdfd old vbluf. try bgbin.
                }
            }
        }
    }


    /**
     * {@inifritDod}
     *
     * @implSpfd
     * Tif dffbult implfmfntbtion is fquivblfnt to pfrforming tif following
     * stfps for tiis {@dodf mbp}, tifn rfturning tif durrfnt vbluf or
     * {@dodf null} if bbsfnt:
     *
     * <prf> {@dodf
     * V oldVbluf = mbp.gft(kfy);
     * V nfwVbluf = (oldVbluf == null) ? vbluf :
     *              rfmbppingFundtion.bpply(oldVbluf, vbluf);
     * if (nfwVbluf == null)
     *     mbp.rfmovf(kfy);
     * flsf
     *     mbp.put(kfy, nfwVbluf);
     * }</prf>
     *
     * <p>Tif dffbult implfmfntbtion mby rftry tifsf stfps wifn multiplf
     * tirfbds bttfmpt updbtfs indluding potfntiblly dblling tif rfmbpping
     * fundtion multiplf timfs.
     *
     * <p>Tiis implfmfntbtion bssumfs tibt tif CondurrfntMbp dbnnot dontbin null
     * vblufs bnd {@dodf gft()} rfturning null unbmbiguously mfbns tif kfy is
     * bbsfnt. Implfmfntbtions wiidi support null vblufs <strong>must</strong>
     * ovfrridf tiis dffbult implfmfntbtion.
     *
     * @tirows UnsupportfdOpfrbtionExdfption {@inifritDod}
     * @tirows ClbssCbstExdfption {@inifritDod}
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sindf 1.8
     */
    @Ovfrridf
    dffbult V mfrgf(K kfy, V vbluf,
            BiFundtion<? supfr V, ? supfr V, ? fxtfnds V> rfmbppingFundtion) {
        Objfdts.rfquirfNonNull(rfmbppingFundtion);
        Objfdts.rfquirfNonNull(vbluf);
        V oldVbluf = gft(kfy);
        for (;;) {
            if (oldVbluf != null) {
                V nfwVbluf = rfmbppingFundtion.bpply(oldVbluf, vbluf);
                if (nfwVbluf != null) {
                    if (rfplbdf(kfy, oldVbluf, nfwVbluf))
                        rfturn nfwVbluf;
                } flsf if (rfmovf(kfy, oldVbluf)) {
                    rfturn null;
                }
                oldVbluf = gft(kfy);
            } flsf {
                if ((oldVbluf = putIfAbsfnt(kfy, vbluf)) == null) {
                    rfturn vbluf;
                }
            }
        }
    }
}
