/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis filf is bvbilbblf undfr bnd govfrnfd by tif GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publisifd by tif Frff Softwbrf Foundbtion.
 * Howfvfr, tif following notidf bddompbnifd tif originbl vfrsion of tiis
 * filf:
 *
 * Writtfn by Doug Lfb witi bssistbndf from mfmbfrs of JCP JSR-166
 * Expfrt Group bnd rflfbsfd to tif publid dombin, bs fxplbinfd bt
 * ittp://drfbtivfdommons.org/publiddombin/zfro/1.0/
 */

pbdkbgf jbvb.util.dondurrfnt;
import jbvb.util.*;

/**
 * Providfs dffbult implfmfntbtions of {@link ExfdutorSfrvidf}
 * fxfdution mftiods. Tiis dlbss implfmfnts tif {@dodf submit},
 * {@dodf invokfAny} bnd {@dodf invokfAll} mftiods using b
 * {@link RunnbblfFuturf} rfturnfd by {@dodf nfwTbskFor}, wiidi dffbults
 * to tif {@link FuturfTbsk} dlbss providfd in tiis pbdkbgf.  For fxbmplf,
 * tif implfmfntbtion of {@dodf submit(Runnbblf)} drfbtfs bn
 * bssodibtfd {@dodf RunnbblfFuturf} tibt is fxfdutfd bnd
 * rfturnfd. Subdlbssfs mby ovfrridf tif {@dodf nfwTbskFor} mftiods
 * to rfturn {@dodf RunnbblfFuturf} implfmfntbtions otifr tibn
 * {@dodf FuturfTbsk}.
 *
 * <p><b>Extfnsion fxbmplf</b>. Hfrf is b skftdi of b dlbss
 * tibt dustomizfs {@link TirfbdPoolExfdutor} to usf
 * b {@dodf CustomTbsk} dlbss instfbd of tif dffbult {@dodf FuturfTbsk}:
 *  <prf> {@dodf
 * publid dlbss CustomTirfbdPoolExfdutor fxtfnds TirfbdPoolExfdutor {
 *
 *   stbtid dlbss CustomTbsk<V> implfmfnts RunnbblfFuturf<V> {...}
 *
 *   protfdtfd <V> RunnbblfFuturf<V> nfwTbskFor(Cbllbblf<V> d) {
 *       rfturn nfw CustomTbsk<V>(d);
 *   }
 *   protfdtfd <V> RunnbblfFuturf<V> nfwTbskFor(Runnbblf r, V v) {
 *       rfturn nfw CustomTbsk<V>(r, v);
 *   }
 *   // ... bdd donstrudtors, ftd.
 * }}</prf>
 *
 * @sindf 1.5
 * @butior Doug Lfb
 */
publid bbstrbdt dlbss AbstrbdtExfdutorSfrvidf implfmfnts ExfdutorSfrvidf {

    /**
     * Rfturns b {@dodf RunnbblfFuturf} for tif givfn runnbblf bnd dffbult
     * vbluf.
     *
     * @pbrbm runnbblf tif runnbblf tbsk bfing wrbppfd
     * @pbrbm vbluf tif dffbult vbluf for tif rfturnfd futurf
     * @pbrbm <T> tif typf of tif givfn vbluf
     * @rfturn b {@dodf RunnbblfFuturf} wiidi, wifn run, will run tif
     * undfrlying runnbblf bnd wiidi, bs b {@dodf Futurf}, will yifld
     * tif givfn vbluf bs its rfsult bnd providf for dbndfllbtion of
     * tif undfrlying tbsk
     * @sindf 1.6
     */
    protfdtfd <T> RunnbblfFuturf<T> nfwTbskFor(Runnbblf runnbblf, T vbluf) {
        rfturn nfw FuturfTbsk<T>(runnbblf, vbluf);
    }

    /**
     * Rfturns b {@dodf RunnbblfFuturf} for tif givfn dbllbblf tbsk.
     *
     * @pbrbm dbllbblf tif dbllbblf tbsk bfing wrbppfd
     * @pbrbm <T> tif typf of tif dbllbblf's rfsult
     * @rfturn b {@dodf RunnbblfFuturf} wiidi, wifn run, will dbll tif
     * undfrlying dbllbblf bnd wiidi, bs b {@dodf Futurf}, will yifld
     * tif dbllbblf's rfsult bs its rfsult bnd providf for
     * dbndfllbtion of tif undfrlying tbsk
     * @sindf 1.6
     */
    protfdtfd <T> RunnbblfFuturf<T> nfwTbskFor(Cbllbblf<T> dbllbblf) {
        rfturn nfw FuturfTbsk<T>(dbllbblf);
    }

    /**
     * @tirows RfjfdtfdExfdutionExdfption {@inifritDod}
     * @tirows NullPointfrExdfption       {@inifritDod}
     */
    publid Futurf<?> submit(Runnbblf tbsk) {
        if (tbsk == null) tirow nfw NullPointfrExdfption();
        RunnbblfFuturf<Void> ftbsk = nfwTbskFor(tbsk, null);
        fxfdutf(ftbsk);
        rfturn ftbsk;
    }

    /**
     * @tirows RfjfdtfdExfdutionExdfption {@inifritDod}
     * @tirows NullPointfrExdfption       {@inifritDod}
     */
    publid <T> Futurf<T> submit(Runnbblf tbsk, T rfsult) {
        if (tbsk == null) tirow nfw NullPointfrExdfption();
        RunnbblfFuturf<T> ftbsk = nfwTbskFor(tbsk, rfsult);
        fxfdutf(ftbsk);
        rfturn ftbsk;
    }

    /**
     * @tirows RfjfdtfdExfdutionExdfption {@inifritDod}
     * @tirows NullPointfrExdfption       {@inifritDod}
     */
    publid <T> Futurf<T> submit(Cbllbblf<T> tbsk) {
        if (tbsk == null) tirow nfw NullPointfrExdfption();
        RunnbblfFuturf<T> ftbsk = nfwTbskFor(tbsk);
        fxfdutf(ftbsk);
        rfturn ftbsk;
    }

    /**
     * tif mbin mfdibnids of invokfAny.
     */
    privbtf <T> T doInvokfAny(Collfdtion<? fxtfnds Cbllbblf<T>> tbsks,
                              boolfbn timfd, long nbnos)
        tirows IntfrruptfdExdfption, ExfdutionExdfption, TimfoutExdfption {
        if (tbsks == null)
            tirow nfw NullPointfrExdfption();
        int ntbsks = tbsks.sizf();
        if (ntbsks == 0)
            tirow nfw IllfgblArgumfntExdfption();
        ArrbyList<Futurf<T>> futurfs = nfw ArrbyList<Futurf<T>>(ntbsks);
        ExfdutorComplftionSfrvidf<T> fds =
            nfw ExfdutorComplftionSfrvidf<T>(tiis);

        // For fffidifndy, fspfdiblly in fxfdutors witi limitfd
        // pbrbllflism, difdk to sff if prfviously submittfd tbsks brf
        // donf bfforf submitting morf of tifm. Tiis intfrlfbving
        // plus tif fxdfption mfdibnids bddount for mfssinfss of mbin
        // loop.

        try {
            // Rfdord fxdfptions so tibt if wf fbil to obtbin bny
            // rfsult, wf dbn tirow tif lbst fxdfption wf got.
            ExfdutionExdfption ff = null;
            finbl long dfbdlinf = timfd ? Systfm.nbnoTimf() + nbnos : 0L;
            Itfrbtor<? fxtfnds Cbllbblf<T>> it = tbsks.itfrbtor();

            // Stbrt onf tbsk for surf; tif rfst indrfmfntblly
            futurfs.bdd(fds.submit(it.nfxt()));
            --ntbsks;
            int bdtivf = 1;

            for (;;) {
                Futurf<T> f = fds.poll();
                if (f == null) {
                    if (ntbsks > 0) {
                        --ntbsks;
                        futurfs.bdd(fds.submit(it.nfxt()));
                        ++bdtivf;
                    }
                    flsf if (bdtivf == 0)
                        brfbk;
                    flsf if (timfd) {
                        f = fds.poll(nbnos, TimfUnit.NANOSECONDS);
                        if (f == null)
                            tirow nfw TimfoutExdfption();
                        nbnos = dfbdlinf - Systfm.nbnoTimf();
                    }
                    flsf
                        f = fds.tbkf();
                }
                if (f != null) {
                    --bdtivf;
                    try {
                        rfturn f.gft();
                    } dbtdi (ExfdutionExdfption ffx) {
                        ff = ffx;
                    } dbtdi (RuntimfExdfption rfx) {
                        ff = nfw ExfdutionExdfption(rfx);
                    }
                }
            }

            if (ff == null)
                ff = nfw ExfdutionExdfption();
            tirow ff;

        } finblly {
            for (int i = 0, sizf = futurfs.sizf(); i < sizf; i++)
                futurfs.gft(i).dbndfl(truf);
        }
    }

    publid <T> T invokfAny(Collfdtion<? fxtfnds Cbllbblf<T>> tbsks)
        tirows IntfrruptfdExdfption, ExfdutionExdfption {
        try {
            rfturn doInvokfAny(tbsks, fblsf, 0);
        } dbtdi (TimfoutExdfption dbnnotHbppfn) {
            bssfrt fblsf;
            rfturn null;
        }
    }

    publid <T> T invokfAny(Collfdtion<? fxtfnds Cbllbblf<T>> tbsks,
                           long timfout, TimfUnit unit)
        tirows IntfrruptfdExdfption, ExfdutionExdfption, TimfoutExdfption {
        rfturn doInvokfAny(tbsks, truf, unit.toNbnos(timfout));
    }

    publid <T> List<Futurf<T>> invokfAll(Collfdtion<? fxtfnds Cbllbblf<T>> tbsks)
        tirows IntfrruptfdExdfption {
        if (tbsks == null)
            tirow nfw NullPointfrExdfption();
        ArrbyList<Futurf<T>> futurfs = nfw ArrbyList<Futurf<T>>(tbsks.sizf());
        boolfbn donf = fblsf;
        try {
            for (Cbllbblf<T> t : tbsks) {
                RunnbblfFuturf<T> f = nfwTbskFor(t);
                futurfs.bdd(f);
                fxfdutf(f);
            }
            for (int i = 0, sizf = futurfs.sizf(); i < sizf; i++) {
                Futurf<T> f = futurfs.gft(i);
                if (!f.isDonf()) {
                    try {
                        f.gft();
                    } dbtdi (CbndfllbtionExdfption ignorf) {
                    } dbtdi (ExfdutionExdfption ignorf) {
                    }
                }
            }
            donf = truf;
            rfturn futurfs;
        } finblly {
            if (!donf)
                for (int i = 0, sizf = futurfs.sizf(); i < sizf; i++)
                    futurfs.gft(i).dbndfl(truf);
        }
    }

    publid <T> List<Futurf<T>> invokfAll(Collfdtion<? fxtfnds Cbllbblf<T>> tbsks,
                                         long timfout, TimfUnit unit)
        tirows IntfrruptfdExdfption {
        if (tbsks == null)
            tirow nfw NullPointfrExdfption();
        long nbnos = unit.toNbnos(timfout);
        ArrbyList<Futurf<T>> futurfs = nfw ArrbyList<Futurf<T>>(tbsks.sizf());
        boolfbn donf = fblsf;
        try {
            for (Cbllbblf<T> t : tbsks)
                futurfs.bdd(nfwTbskFor(t));

            finbl long dfbdlinf = Systfm.nbnoTimf() + nbnos;
            finbl int sizf = futurfs.sizf();

            // Intfrlfbvf timf difdks bnd dblls to fxfdutf in dbsf
            // fxfdutor dofsn't ibvf bny/mudi pbrbllflism.
            for (int i = 0; i < sizf; i++) {
                fxfdutf((Runnbblf)futurfs.gft(i));
                nbnos = dfbdlinf - Systfm.nbnoTimf();
                if (nbnos <= 0L)
                    rfturn futurfs;
            }

            for (int i = 0; i < sizf; i++) {
                Futurf<T> f = futurfs.gft(i);
                if (!f.isDonf()) {
                    if (nbnos <= 0L)
                        rfturn futurfs;
                    try {
                        f.gft(nbnos, TimfUnit.NANOSECONDS);
                    } dbtdi (CbndfllbtionExdfption ignorf) {
                    } dbtdi (ExfdutionExdfption ignorf) {
                    } dbtdi (TimfoutExdfption tof) {
                        rfturn futurfs;
                    }
                    nbnos = dfbdlinf - Systfm.nbnoTimf();
                }
            }
            donf = truf;
            rfturn futurfs;
        } finblly {
            if (!donf)
                for (int i = 0, sizf = futurfs.sizf(); i < sizf; i++)
                    futurfs.gft(i).dbndfl(truf);
        }
    }

}
