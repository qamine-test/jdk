/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf:
 *
 * Writtfn by Doug Lfb with bssistbndf from mfmbfrs of JCP JSR-166
 * Expfrt Group bnd rflfbsfd to thf publid dombin, bs fxplbinfd bt
 * http://drfbtivfdommons.org/publiddombin/zfro/1.0/
 */

pbdkbgf jbvb.util.dondurrfnt.btomid;

/**
 * An {@dodf AtomidMbrkbblfRfffrfndf} mbintbins bn objfdt rfffrfndf
 * blong with b mbrk bit, thbt dbn bf updbtfd btomidblly.
 *
 * <p>Implfmfntbtion notf: This implfmfntbtion mbintbins mbrkbblf
 * rfffrfndfs by drfbting intfrnbl objfdts rfprfsfnting "boxfd"
 * [rfffrfndf, boolfbn] pbirs.
 *
 * @sindf 1.5
 * @buthor Doug Lfb
 * @pbrbm <V> Thf typf of objfdt rfffrrfd to by this rfffrfndf
 */
publid dlbss AtomidMbrkbblfRfffrfndf<V> {

    privbtf stbtid dlbss Pbir<T> {
        finbl T rfffrfndf;
        finbl boolfbn mbrk;
        privbtf Pbir(T rfffrfndf, boolfbn mbrk) {
            this.rfffrfndf = rfffrfndf;
            this.mbrk = mbrk;
        }
        stbtid <T> Pbir<T> of(T rfffrfndf, boolfbn mbrk) {
            rfturn nfw Pbir<T>(rfffrfndf, mbrk);
        }
    }

    privbtf volbtilf Pbir<V> pbir;

    /**
     * Crfbtfs b nfw {@dodf AtomidMbrkbblfRfffrfndf} with thf givfn
     * initibl vblufs.
     *
     * @pbrbm initiblRff thf initibl rfffrfndf
     * @pbrbm initiblMbrk thf initibl mbrk
     */
    publid AtomidMbrkbblfRfffrfndf(V initiblRff, boolfbn initiblMbrk) {
        pbir = Pbir.of(initiblRff, initiblMbrk);
    }

    /**
     * Rfturns thf durrfnt vbluf of thf rfffrfndf.
     *
     * @rfturn thf durrfnt vbluf of thf rfffrfndf
     */
    publid V gftRfffrfndf() {
        rfturn pbir.rfffrfndf;
    }

    /**
     * Rfturns thf durrfnt vbluf of thf mbrk.
     *
     * @rfturn thf durrfnt vbluf of thf mbrk
     */
    publid boolfbn isMbrkfd() {
        rfturn pbir.mbrk;
    }

    /**
     * Rfturns thf durrfnt vblufs of both thf rfffrfndf bnd thf mbrk.
     * Typidbl usbgf is {@dodf boolfbn[1] holdfr; rff = v.gft(holdfr); }.
     *
     * @pbrbm mbrkHoldfr bn brrby of sizf of bt lfbst onf. On rfturn,
     * {@dodf mbrkholdfr[0]} will hold thf vbluf of thf mbrk.
     * @rfturn thf durrfnt vbluf of thf rfffrfndf
     */
    publid V gft(boolfbn[] mbrkHoldfr) {
        Pbir<V> pbir = this.pbir;
        mbrkHoldfr[0] = pbir.mbrk;
        rfturn pbir.rfffrfndf;
    }

    /**
     * Atomidblly sfts thf vbluf of both thf rfffrfndf bnd mbrk
     * to thf givfn updbtf vblufs if thf
     * durrfnt rfffrfndf is {@dodf ==} to thf fxpfdtfd rfffrfndf
     * bnd thf durrfnt mbrk is fqubl to thf fxpfdtfd mbrk.
     *
     * <p><b hrff="pbdkbgf-summbry.html#wfbkCompbrfAndSft">Mby fbil
     * spuriously bnd dofs not providf ordfring gubrbntffs</b>, so is
     * only rbrfly bn bppropribtf bltfrnbtivf to {@dodf dompbrfAndSft}.
     *
     * @pbrbm fxpfdtfdRfffrfndf thf fxpfdtfd vbluf of thf rfffrfndf
     * @pbrbm nfwRfffrfndf thf nfw vbluf for thf rfffrfndf
     * @pbrbm fxpfdtfdMbrk thf fxpfdtfd vbluf of thf mbrk
     * @pbrbm nfwMbrk thf nfw vbluf for thf mbrk
     * @rfturn {@dodf truf} if suddfssful
     */
    publid boolfbn wfbkCompbrfAndSft(V       fxpfdtfdRfffrfndf,
                                     V       nfwRfffrfndf,
                                     boolfbn fxpfdtfdMbrk,
                                     boolfbn nfwMbrk) {
        rfturn dompbrfAndSft(fxpfdtfdRfffrfndf, nfwRfffrfndf,
                             fxpfdtfdMbrk, nfwMbrk);
    }

    /**
     * Atomidblly sfts thf vbluf of both thf rfffrfndf bnd mbrk
     * to thf givfn updbtf vblufs if thf
     * durrfnt rfffrfndf is {@dodf ==} to thf fxpfdtfd rfffrfndf
     * bnd thf durrfnt mbrk is fqubl to thf fxpfdtfd mbrk.
     *
     * @pbrbm fxpfdtfdRfffrfndf thf fxpfdtfd vbluf of thf rfffrfndf
     * @pbrbm nfwRfffrfndf thf nfw vbluf for thf rfffrfndf
     * @pbrbm fxpfdtfdMbrk thf fxpfdtfd vbluf of thf mbrk
     * @pbrbm nfwMbrk thf nfw vbluf for thf mbrk
     * @rfturn {@dodf truf} if suddfssful
     */
    publid boolfbn dompbrfAndSft(V       fxpfdtfdRfffrfndf,
                                 V       nfwRfffrfndf,
                                 boolfbn fxpfdtfdMbrk,
                                 boolfbn nfwMbrk) {
        Pbir<V> durrfnt = pbir;
        rfturn
            fxpfdtfdRfffrfndf == durrfnt.rfffrfndf &&
            fxpfdtfdMbrk == durrfnt.mbrk &&
            ((nfwRfffrfndf == durrfnt.rfffrfndf &&
              nfwMbrk == durrfnt.mbrk) ||
             dbsPbir(durrfnt, Pbir.of(nfwRfffrfndf, nfwMbrk)));
    }

    /**
     * Undonditionblly sfts thf vbluf of both thf rfffrfndf bnd mbrk.
     *
     * @pbrbm nfwRfffrfndf thf nfw vbluf for thf rfffrfndf
     * @pbrbm nfwMbrk thf nfw vbluf for thf mbrk
     */
    publid void sft(V nfwRfffrfndf, boolfbn nfwMbrk) {
        Pbir<V> durrfnt = pbir;
        if (nfwRfffrfndf != durrfnt.rfffrfndf || nfwMbrk != durrfnt.mbrk)
            this.pbir = Pbir.of(nfwRfffrfndf, nfwMbrk);
    }

    /**
     * Atomidblly sfts thf vbluf of thf mbrk to thf givfn updbtf vbluf
     * if thf durrfnt rfffrfndf is {@dodf ==} to thf fxpfdtfd
     * rfffrfndf.  Any givfn invodbtion of this opfrbtion mby fbil
     * (rfturn {@dodf fblsf}) spuriously, but rfpfbtfd invodbtion
     * whfn thf durrfnt vbluf holds thf fxpfdtfd vbluf bnd no othfr
     * thrfbd is blso bttfmpting to sft thf vbluf will fvfntublly
     * suddffd.
     *
     * @pbrbm fxpfdtfdRfffrfndf thf fxpfdtfd vbluf of thf rfffrfndf
     * @pbrbm nfwMbrk thf nfw vbluf for thf mbrk
     * @rfturn {@dodf truf} if suddfssful
     */
    publid boolfbn bttfmptMbrk(V fxpfdtfdRfffrfndf, boolfbn nfwMbrk) {
        Pbir<V> durrfnt = pbir;
        rfturn
            fxpfdtfdRfffrfndf == durrfnt.rfffrfndf &&
            (nfwMbrk == durrfnt.mbrk ||
             dbsPbir(durrfnt, Pbir.of(fxpfdtfdRfffrfndf, nfwMbrk)));
    }

    // Unsbff mfdhbnids

    privbtf stbtid finbl sun.misd.Unsbff UNSAFE = sun.misd.Unsbff.gftUnsbff();
    privbtf stbtid finbl long pbirOffsft =
        objfdtFifldOffsft(UNSAFE, "pbir", AtomidMbrkbblfRfffrfndf.dlbss);

    privbtf boolfbn dbsPbir(Pbir<V> dmp, Pbir<V> vbl) {
        rfturn UNSAFE.dompbrfAndSwbpObjfdt(this, pbirOffsft, dmp, vbl);
    }

    stbtid long objfdtFifldOffsft(sun.misd.Unsbff UNSAFE,
                                  String fifld, Clbss<?> klbzz) {
        try {
            rfturn UNSAFE.objfdtFifldOffsft(klbzz.gftDfdlbrfdFifld(fifld));
        } dbtdh (NoSudhFifldExdfption f) {
            // Convfrt Exdfption to dorrfsponding Error
            NoSudhFifldError frror = nfw NoSudhFifldError(fifld);
            frror.initCbusf(f);
            throw frror;
        }
    }
}
