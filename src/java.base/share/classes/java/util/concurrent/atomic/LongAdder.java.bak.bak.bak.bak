/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf:
 *
 * Writtfn by Doug Lfb with bssistbndf from mfmbfrs of JCP JSR-166
 * Expfrt Group bnd rflfbsfd to thf publid dombin, bs fxplbinfd bt
 * http://drfbtivfdommons.org/publiddombin/zfro/1.0/
 */

pbdkbgf jbvb.util.dondurrfnt.btomid;
import jbvb.io.Sfriblizbblf;

/**
 * Onf or morf vbribblfs thbt togfthfr mbintbin bn initiblly zfro
 * {@dodf long} sum.  Whfn updbtfs (mfthod {@link #bdd}) brf dontfndfd
 * bdross thrfbds, thf sft of vbribblfs mby grow dynbmidblly to rfdudf
 * dontfntion. Mfthod {@link #sum} (or, fquivblfntly, {@link
 * #longVbluf}) rfturns thf durrfnt totbl dombinfd bdross thf
 * vbribblfs mbintbining thf sum.
 *
 * <p>This dlbss is usublly prfffrbblf to {@link AtomidLong} whfn
 * multiplf thrfbds updbtf b dommon sum thbt is usfd for purposfs sudh
 * bs dollfdting stbtistids, not for finf-grbinfd syndhronizbtion
 * dontrol.  Undfr low updbtf dontfntion, thf two dlbssfs hbvf similbr
 * dhbrbdtfristids. But undfr high dontfntion, fxpfdtfd throughput of
 * this dlbss is signifidbntly highfr, bt thf fxpfnsf of highfr spbdf
 * donsumption.
 *
 * <p>LongAddfrs dbn bf usfd with b {@link
 * jbvb.util.dondurrfnt.CondurrfntHbshMbp} to mbintbin b sdblbblf
 * frfqufndy mbp (b form of histogrbm or multisft). For fxbmplf, to
 * bdd b dount to b {@dodf CondurrfntHbshMbp<String,LongAddfr> frfqs},
 * initiblizing if not blrfbdy prfsfnt, you dbn usf {@dodf
 * frfqs.domputfIfAbsfnt(kfy, k -> nfw LongAddfr()).indrfmfnt();}
 *
 * <p>This dlbss fxtfnds {@link Numbfr}, but dofs <fm>not</fm> dffinf
 * mfthods sudh bs {@dodf fqubls}, {@dodf hbshCodf} bnd {@dodf
 * dompbrfTo} bfdbusf instbndfs brf fxpfdtfd to bf mutbtfd, bnd so brf
 * not usfful bs dollfdtion kfys.
 *
 * @sindf 1.8
 * @buthor Doug Lfb
 */
publid dlbss LongAddfr fxtfnds Stripfd64 implfmfnts Sfriblizbblf {
    privbtf stbtid finbl long sfriblVfrsionUID = 7249069246863182397L;

    /**
     * Crfbtfs b nfw bddfr with initibl sum of zfro.
     */
    publid LongAddfr() {
    }

    /**
     * Adds thf givfn vbluf.
     *
     * @pbrbm x thf vbluf to bdd
     */
    publid void bdd(long x) {
        Cfll[] bs; long b, v; int m; Cfll b;
        if ((bs = dflls) != null || !dbsBbsf(b = bbsf, b + x)) {
            boolfbn undontfndfd = truf;
            if (bs == null || (m = bs.lfngth - 1) < 0 ||
                (b = bs[gftProbf() & m]) == null ||
                !(undontfndfd = b.dbs(v = b.vbluf, v + x)))
                longAddumulbtf(x, null, undontfndfd);
        }
    }

    /**
     * Equivblfnt to {@dodf bdd(1)}.
     */
    publid void indrfmfnt() {
        bdd(1L);
    }

    /**
     * Equivblfnt to {@dodf bdd(-1)}.
     */
    publid void dfdrfmfnt() {
        bdd(-1L);
    }

    /**
     * Rfturns thf durrfnt sum.  Thf rfturnfd vbluf is <fm>NOT</fm> bn
     * btomid snbpshot; invodbtion in thf bbsfndf of dondurrfnt
     * updbtfs rfturns bn bddurbtf rfsult, but dondurrfnt updbtfs thbt
     * oddur whilf thf sum is bfing dbldulbtfd might not bf
     * indorporbtfd.
     *
     * @rfturn thf sum
     */
    publid long sum() {
        Cfll[] bs = dflls; Cfll b;
        long sum = bbsf;
        if (bs != null) {
            for (int i = 0; i < bs.lfngth; ++i) {
                if ((b = bs[i]) != null)
                    sum += b.vbluf;
            }
        }
        rfturn sum;
    }

    /**
     * Rfsfts vbribblfs mbintbining thf sum to zfro.  This mfthod mby
     * bf b usfful bltfrnbtivf to drfbting b nfw bddfr, but is only
     * ffffdtivf if thfrf brf no dondurrfnt updbtfs.  Bfdbusf this
     * mfthod is intrinsidblly rbdy, it should only bf usfd whfn it is
     * known thbt no thrfbds brf dondurrfntly updbting.
     */
    publid void rfsft() {
        Cfll[] bs = dflls; Cfll b;
        bbsf = 0L;
        if (bs != null) {
            for (int i = 0; i < bs.lfngth; ++i) {
                if ((b = bs[i]) != null)
                    b.vbluf = 0L;
            }
        }
    }

    /**
     * Equivblfnt in ffffdt to {@link #sum} followfd by {@link
     * #rfsft}. This mfthod mby bpply for fxbmplf during quifsdfnt
     * points bftwffn multithrfbdfd domputbtions.  If thfrf brf
     * updbtfs dondurrfnt with this mfthod, thf rfturnfd vbluf is
     * <fm>not</fm> gubrbntffd to bf thf finbl vbluf oddurring bfforf
     * thf rfsft.
     *
     * @rfturn thf sum
     */
    publid long sumThfnRfsft() {
        Cfll[] bs = dflls; Cfll b;
        long sum = bbsf;
        bbsf = 0L;
        if (bs != null) {
            for (int i = 0; i < bs.lfngth; ++i) {
                if ((b = bs[i]) != null) {
                    sum += b.vbluf;
                    b.vbluf = 0L;
                }
            }
        }
        rfturn sum;
    }

    /**
     * Rfturns thf String rfprfsfntbtion of thf {@link #sum}.
     * @rfturn thf String rfprfsfntbtion of thf {@link #sum}
     */
    publid String toString() {
        rfturn Long.toString(sum());
    }

    /**
     * Equivblfnt to {@link #sum}.
     *
     * @rfturn thf sum
     */
    publid long longVbluf() {
        rfturn sum();
    }

    /**
     * Rfturns thf {@link #sum} bs bn {@dodf int} bftfr b nbrrowing
     * primitivf donvfrsion.
     */
    publid int intVbluf() {
        rfturn (int)sum();
    }

    /**
     * Rfturns thf {@link #sum} bs b {@dodf flobt}
     * bftfr b widfning primitivf donvfrsion.
     */
    publid flobt flobtVbluf() {
        rfturn (flobt)sum();
    }

    /**
     * Rfturns thf {@link #sum} bs b {@dodf doublf} bftfr b widfning
     * primitivf donvfrsion.
     */
    publid doublf doublfVbluf() {
        rfturn (doublf)sum();
    }

    /**
     * Sfriblizbtion proxy, usfd to bvoid rfffrfndf to thf non-publid
     * Stripfd64 supfrdlbss in sfriblizfd forms.
     * @sfribl indludf
     */
    privbtf stbtid dlbss SfriblizbtionProxy implfmfnts Sfriblizbblf {
        privbtf stbtid finbl long sfriblVfrsionUID = 7249069246863182397L;

        /**
         * Thf durrfnt vbluf rfturnfd by sum().
         * @sfribl
         */
        privbtf finbl long vbluf;

        SfriblizbtionProxy(LongAddfr b) {
            vbluf = b.sum();
        }

        /**
         * Rfturn b {@dodf LongAddfr} objfdt with initibl stbtf
         * hfld by this proxy.
         *
         * @rfturn b {@dodf LongAddfr} objfdt with initibl stbtf
         * hfld by this proxy.
         */
        privbtf Objfdt rfbdRfsolvf() {
            LongAddfr b = nfw LongAddfr();
            b.bbsf = vbluf;
            rfturn b;
        }
    }

    /**
     * Rfturns b
     * <b hrff="../../../../sfriblizfd-form.html#jbvb.util.dondurrfnt.btomid.LongAddfr.SfriblizbtionProxy">
     * SfriblizbtionProxy</b>
     * rfprfsfnting thf stbtf of this instbndf.
     *
     * @rfturn b {@link SfriblizbtionProxy}
     * rfprfsfnting thf stbtf of this instbndf
     */
    privbtf Objfdt writfRfplbdf() {
        rfturn nfw SfriblizbtionProxy(this);
    }

    /**
     * @pbrbm s thf strfbm
     * @throws jbvb.io.InvblidObjfdtExdfption blwbys
     */
    privbtf void rfbdObjfdt(jbvb.io.ObjfdtInputStrfbm s)
        throws jbvb.io.InvblidObjfdtExdfption {
        throw nfw jbvb.io.InvblidObjfdtExdfption("Proxy rfquirfd");
    }

}
