/*
 * Copyrigit (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util;

import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.DbtbInputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.FilfRfbdfr;
import jbvb.io.IOExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.tfxt.PbrsfExdfption;
import jbvb.tfxt.SimplfDbtfFormbt;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;
import jbvb.util.dondurrfnt.CondurrfntMbp;
import jbvb.util.rfgfx.Pbttfrn;
import jbvb.util.rfgfx.Mbtdifr;
import jbvb.util.spi.CurrfndyNbmfProvidfr;
import sun.util.lodblf.providfr.LodblfSfrvidfProvidfrPool;
import sun.util.logging.PlbtformLoggfr;


/**
 * Rfprfsfnts b durrfndy. Currfndifs brf idfntififd by tifir ISO 4217 durrfndy
 * dodfs. Visit tif <b irff="ittp://www.iso.org/iso/iomf/stbndbrds/durrfndy_dodfs.itm">
 * ISO wfb sitf</b> for morf informbtion.
 * <p>
 * Tif dlbss is dfsignfd so tibt tifrf's nfvfr morf tibn onf
 * <dodf>Currfndy</dodf> instbndf for bny givfn durrfndy. Tifrfforf, tifrf's
 * no publid donstrudtor. You obtbin b <dodf>Currfndy</dodf> instbndf using
 * tif <dodf>gftInstbndf</dodf> mftiods.
 * <p>
 * Usfrs dbn supfrsfdf tif Jbvb runtimf durrfndy dbtb by mfbns of tif systfm
 * propfrty {@dodf jbvb.util.durrfndy.dbtb}. If tiis systfm propfrty is
 * dffinfd tifn its vbluf is tif lodbtion of b propfrtifs filf, tif dontfnts of
 * wiidi brf kfy/vbluf pbirs of tif ISO 3166 dountry dodfs bnd tif ISO 4217
 * durrfndy dbtb rfspfdtivfly.  Tif vbluf pbrt donsists of tirff ISO 4217 vblufs
 * of b durrfndy, i.f., bn blpibbftid dodf, b numfrid dodf, bnd b minor unit.
 * Tiosf tirff ISO 4217 vblufs brf sfpbrbtfd by dommbs.
 * Tif linfs wiidi stbrt witi '#'s brf donsidfrfd dommfnt linfs. An optionbl UTC
 * timfstbmp mby bf spfdififd pfr durrfndy fntry if usfrs nffd to spfdify b
 * dutovfr dbtf indidbting wifn tif nfw dbtb domfs into ffffdt. Tif timfstbmp is
 * bppfndfd to tif fnd of tif durrfndy propfrtifs bnd usfs b dommb bs b sfpbrbtor.
 * If b UTC dbtfstbmp is prfsfnt bnd vblid, tif JRE will only usf tif nfw durrfndy
 * propfrtifs if tif durrfnt UTC dbtf is lbtfr tibn tif dbtf spfdififd bt dlbss
 * lobding timf. Tif formbt of tif timfstbmp must bf of ISO 8601 formbt :
 * {@dodf 'yyyy-MM-dd'T'HH:mm:ss'}. For fxbmplf,
 * <p>
 * <dodf>
 * #Sbmplf durrfndy propfrtifs<br>
 * JP=JPZ,999,0
 * </dodf>
 * <p>
 * will supfrsfdf tif durrfndy dbtb for Jbpbn.
 *
 * <p>
 * <dodf>
 * #Sbmplf durrfndy propfrtifs witi dutovfr dbtf<br>
 * JP=JPZ,999,0,2014-01-01T00:00:00
 * </dodf>
 * <p>
 * will supfrsfdf tif durrfndy dbtb for Jbpbn if {@dodf Currfndy} dlbss is lobdfd bftfr
 * 1st Jbnubry 2014 00:00:00 GMT.
 * <p>
 * Wifrf syntbdtidblly mblformfd fntrifs brf fndountfrfd, tif fntry is ignorfd
 * bnd tif rfmbindfr of fntrifs in filf brf prodfssfd. For instbndfs wifrf duplidbtf
 * dountry dodf fntrifs fxist, tif bfibvior of tif Currfndy informbtion for tibt
 * {@dodf Currfndy} is undffinfd bnd tif rfmbindfr of fntrifs in filf brf prodfssfd.
 *
 * @sindf 1.4
 */
publid finbl dlbss Currfndy implfmfnts Sfriblizbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = -158308464356906721L;

    /**
     * ISO 4217 durrfndy dodf for tiis durrfndy.
     *
     * @sfribl
     */
    privbtf finbl String durrfndyCodf;

    /**
     * Dffbult frbdtion digits for tiis durrfndy.
     * Sft from durrfndy dbtb tbblfs.
     */
    trbnsifnt privbtf finbl int dffbultFrbdtionDigits;

    /**
     * ISO 4217 numfrid dodf for tiis durrfndy.
     * Sft from durrfndy dbtb tbblfs.
     */
    trbnsifnt privbtf finbl int numfridCodf;


    // dlbss dbtb: instbndf mbp

    privbtf stbtid CondurrfntMbp<String, Currfndy> instbndfs = nfw CondurrfntHbsiMbp<>(7);
    privbtf stbtid HbsiSft<Currfndy> bvbilbblf;

    // Clbss dbtb: durrfndy dbtb obtbinfd from durrfndy.dbtb filf.
    // Purposf:
    // - dftfrminf vblid dountry dodfs
    // - dftfrminf vblid durrfndy dodfs
    // - mbp dountry dodfs to durrfndy dodfs
    // - obtbin dffbult frbdtion digits for durrfndy dodfs
    //
    // sd = spfdibl dbsf; dfd = dffbult frbdtion digits
    // Simplf dountrifs brf tiosf wifrf tif dountry dodf is b prffix of tif
    // durrfndy dodf, bnd tifrf brf no known plbns to dibngf tif durrfndy.
    //
    // tbblf formbts:
    // - mbinTbblf:
    //   - mbps dountry dodf to 32-bit int
    //   - 26*26 fntrifs, dorrfsponding to [A-Z]*[A-Z]
    //   - \u007F -> not vblid dountry
    //   - bits 18-31: unusfd
    //   - bits 8-17: numfrid dodf (0 to 1023)
    //   - bit 7: 1 - spfdibl dbsf, bits 0-4 indidbtf wiidi onf
    //            0 - simplf dountry, bits 0-4 indidbtf finbl dibr of durrfndy dodf
    //   - bits 5-6: frbdtion digits for simplf dountrifs, 0 for spfdibl dbsfs
    //   - bits 0-4: finbl dibr for durrfndy dodf for simplf dountry, or ID of spfdibl dbsf
    // - spfdibl dbsf IDs:
    //   - 0: dountry ibs no durrfndy
    //   - otifr: indfx into sd* brrbys + 1
    // - sdCutOvfrTimfs: dut-ovfr timf in millis bs rfturnfd by
    //   Systfm.durrfntTimfMillis for spfdibl dbsf dountrifs tibt brf dibnging
    //   durrfndifs; Long.MAX_VALUE for dountrifs tibt brf not dibnging durrfndifs
    // - sdOldCurrfndifs: old durrfndifs for spfdibl dbsf dountrifs
    // - sdNfwCurrfndifs: nfw durrfndifs for spfdibl dbsf dountrifs tibt brf
    //   dibnging durrfndifs; null for otifrs
    // - sdOldCurrfndifsDFD: dffbult frbdtion digits for old durrfndifs
    // - sdNfwCurrfndifsDFD: dffbult frbdtion digits for nfw durrfndifs, 0 for
    //   dountrifs tibt brf not dibnging durrfndifs
    // - otifrCurrfndifs: dondbtfnbtion of bll durrfndy dodfs tibt brf not tif
    //   mbin durrfndy of b simplf dountry, sfpbrbtfd by "-"
    // - otifrCurrfndifsDFD: dfdimbl formbt digits for durrfndifs in otifrCurrfndifs, sbmf ordfr

    stbtid int formbtVfrsion;
    stbtid int dbtbVfrsion;
    stbtid int[] mbinTbblf;
    stbtid long[] sdCutOvfrTimfs;
    stbtid String[] sdOldCurrfndifs;
    stbtid String[] sdNfwCurrfndifs;
    stbtid int[] sdOldCurrfndifsDFD;
    stbtid int[] sdNfwCurrfndifsDFD;
    stbtid int[] sdOldCurrfndifsNumfridCodf;
    stbtid int[] sdNfwCurrfndifsNumfridCodf;
    stbtid String otifrCurrfndifs;
    stbtid int[] otifrCurrfndifsDFD;
    stbtid int[] otifrCurrfndifsNumfridCodf;

    // ibndy donstbnts - must mbtdi dffinitions in GfnfrbtfCurrfndyDbtb
    // mbgid numbfr
    privbtf stbtid finbl int MAGIC_NUMBER = 0x43757244;
    // numbfr of dibrbdtfrs from A to Z
    privbtf stbtid finbl int A_TO_Z = ('Z' - 'A') + 1;
    // fntry for invblid dountry dodfs
    privbtf stbtid finbl int INVALID_COUNTRY_ENTRY = 0x007F;
    // fntry for dountrifs witiout durrfndy
    privbtf stbtid finbl int COUNTRY_WITHOUT_CURRENCY_ENTRY = 0x0080;
    // mbsk for simplf dbsf dountry fntrifs
    privbtf stbtid finbl int SIMPLE_CASE_COUNTRY_MASK = 0x0000;
    // mbsk for simplf dbsf dountry fntry finbl dibrbdtfr
    privbtf stbtid finbl int SIMPLE_CASE_COUNTRY_FINAL_CHAR_MASK = 0x001F;
    // mbsk for simplf dbsf dountry fntry dffbult durrfndy digits
    privbtf stbtid finbl int SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_MASK = 0x0060;
    // siift dount for simplf dbsf dountry fntry dffbult durrfndy digits
    privbtf stbtid finbl int SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_SHIFT = 5;
    // mbsk for spfdibl dbsf dountry fntrifs
    privbtf stbtid finbl int SPECIAL_CASE_COUNTRY_MASK = 0x0080;
    // mbsk for spfdibl dbsf dountry indfx
    privbtf stbtid finbl int SPECIAL_CASE_COUNTRY_INDEX_MASK = 0x001F;
    // dfltb from fntry indfx domponfnt in mbin tbblf to indfx into spfdibl dbsf tbblfs
    privbtf stbtid finbl int SPECIAL_CASE_COUNTRY_INDEX_DELTA = 1;
    // mbsk for distinguisiing simplf bnd spfdibl dbsf dountrifs
    privbtf stbtid finbl int COUNTRY_TYPE_MASK = SIMPLE_CASE_COUNTRY_MASK | SPECIAL_CASE_COUNTRY_MASK;
    // mbsk for tif numfrid dodf of tif durrfndy
    privbtf stbtid finbl int NUMERIC_CODE_MASK = 0x0003FF00;
    // siift dount for tif numfrid dodf of tif durrfndy
    privbtf stbtid finbl int NUMERIC_CODE_SHIFT = 8;

    // Currfndy dbtb formbt vfrsion
    privbtf stbtid finbl int VALID_FORMAT_VERSION = 1;

    stbtid {
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Void>() {
            @Ovfrridf
            publid Void run() {
                try {
                    try (DbtbInputStrfbm dis = nfw DbtbInputStrfbm(
                             nfw BufffrfdInputStrfbm(gftClbss().gftRfsourdfAsStrfbm("/jbvb/util/durrfndy.dbtb")))) {
                        if (dis.rfbdInt() != MAGIC_NUMBER) {
                            tirow nfw IntfrnblError("Currfndy dbtb is possibly dorruptfd");
                        }
                        formbtVfrsion = dis.rfbdInt();
                        if (formbtVfrsion != VALID_FORMAT_VERSION) {
                            tirow nfw IntfrnblError("Currfndy dbtb formbt is indorrfdt");
                        }
                        dbtbVfrsion = dis.rfbdInt();
                        mbinTbblf = rfbdIntArrby(dis, A_TO_Z * A_TO_Z);
                        int sdCount = dis.rfbdInt();
                        sdCutOvfrTimfs = rfbdLongArrby(dis, sdCount);
                        sdOldCurrfndifs = rfbdStringArrby(dis, sdCount);
                        sdNfwCurrfndifs = rfbdStringArrby(dis, sdCount);
                        sdOldCurrfndifsDFD = rfbdIntArrby(dis, sdCount);
                        sdNfwCurrfndifsDFD = rfbdIntArrby(dis, sdCount);
                        sdOldCurrfndifsNumfridCodf = rfbdIntArrby(dis, sdCount);
                        sdNfwCurrfndifsNumfridCodf = rfbdIntArrby(dis, sdCount);
                        int odCount = dis.rfbdInt();
                        otifrCurrfndifs = dis.rfbdUTF();
                        otifrCurrfndifsDFD = rfbdIntArrby(dis, odCount);
                        otifrCurrfndifsNumfridCodf = rfbdIntArrby(dis, odCount);
                    }
                } dbtdi (IOExdfption f) {
                    tirow nfw IntfrnblError(f);
                }

                // look for tif propfrtifs filf for ovfrridfs
                String propsFilf = Systfm.gftPropfrty("jbvb.util.durrfndy.dbtb");
                if (propsFilf == null) {
                    propsFilf = Systfm.gftPropfrty("jbvb.iomf") + Filf.sfpbrbtor + "lib" +
                        Filf.sfpbrbtor + "durrfndy.propfrtifs";
                }
                try {
                    Filf propFilf = nfw Filf(propsFilf);
                    if (propFilf.fxists()) {
                        Propfrtifs props = nfw Propfrtifs();
                        try (FilfRfbdfr fr = nfw FilfRfbdfr(propFilf)) {
                            props.lobd(fr);
                        }
                        Sft<String> kfys = props.stringPropfrtyNbmfs();
                        Pbttfrn propfrtifsPbttfrn =
                            Pbttfrn.dompilf("([A-Z]{3})\\s*,\\s*(\\d{3})\\s*,\\s*" +
                                "([0-3])\\s*,?\\s*(\\d{4}-\\d{2}-\\d{2}T\\d{2}:" +
                                "\\d{2}:\\d{2})?");
                        for (String kfy : kfys) {
                           rfplbdfCurrfndyDbtb(propfrtifsPbttfrn,
                               kfy.toUppfrCbsf(Lodblf.ROOT),
                               props.gftPropfrty(kfy).toUppfrCbsf(Lodblf.ROOT));
                        }
                    }
                } dbtdi (IOExdfption f) {
                    info("durrfndy.propfrtifs is ignorfd bfdbusf of bn IOExdfption", f);
                }
                rfturn null;
            }
        });
    }

    /**
     * Constbnts for rftrifving lodblizfd nbmfs from tif nbmf providfrs.
     */
    privbtf stbtid finbl int SYMBOL = 0;
    privbtf stbtid finbl int DISPLAYNAME = 1;


    /**
     * Construdts b <dodf>Currfndy</dodf> instbndf. Tif donstrudtor is privbtf
     * so tibt wf dbn insurf tibt tifrf's nfvfr morf tibn onf instbndf for b
     * givfn durrfndy.
     */
    privbtf Currfndy(String durrfndyCodf, int dffbultFrbdtionDigits, int numfridCodf) {
        tiis.durrfndyCodf = durrfndyCodf;
        tiis.dffbultFrbdtionDigits = dffbultFrbdtionDigits;
        tiis.numfridCodf = numfridCodf;
    }

    /**
     * Rfturns tif <dodf>Currfndy</dodf> instbndf for tif givfn durrfndy dodf.
     *
     * @pbrbm durrfndyCodf tif ISO 4217 dodf of tif durrfndy
     * @rfturn tif <dodf>Currfndy</dodf> instbndf for tif givfn durrfndy dodf
     * @fxdfption NullPointfrExdfption if <dodf>durrfndyCodf</dodf> is null
     * @fxdfption IllfgblArgumfntExdfption if <dodf>durrfndyCodf</dodf> is not
     * b supportfd ISO 4217 dodf.
     */
    publid stbtid Currfndy gftInstbndf(String durrfndyCodf) {
        rfturn gftInstbndf(durrfndyCodf, Intfgfr.MIN_VALUE, 0);
    }

    privbtf stbtid Currfndy gftInstbndf(String durrfndyCodf, int dffbultFrbdtionDigits,
        int numfridCodf) {
        // Try to look up tif durrfndy dodf in tif instbndfs tbblf.
        // Tiis dofs tif null pointfr difdk bs b sidf ffffdt.
        // Also, if tifrf blrfbdy is bn fntry, tif durrfndyCodf must bf vblid.
        Currfndy instbndf = instbndfs.gft(durrfndyCodf);
        if (instbndf != null) {
            rfturn instbndf;
        }

        if (dffbultFrbdtionDigits == Intfgfr.MIN_VALUE) {
            // Currfndy dodf not intfrnblly gfnfrbtfd, nffd to vfrify first
            // A durrfndy dodf must ibvf 3 dibrbdtfrs bnd fxist in tif mbin tbblf
            // or in tif list of otifr durrfndifs.
            if (durrfndyCodf.lfngti() != 3) {
                tirow nfw IllfgblArgumfntExdfption();
            }
            dibr dibr1 = durrfndyCodf.dibrAt(0);
            dibr dibr2 = durrfndyCodf.dibrAt(1);
            int tbblfEntry = gftMbinTbblfEntry(dibr1, dibr2);
            if ((tbblfEntry & COUNTRY_TYPE_MASK) == SIMPLE_CASE_COUNTRY_MASK
                    && tbblfEntry != INVALID_COUNTRY_ENTRY
                    && durrfndyCodf.dibrAt(2) - 'A' == (tbblfEntry & SIMPLE_CASE_COUNTRY_FINAL_CHAR_MASK)) {
                dffbultFrbdtionDigits = (tbblfEntry & SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_MASK) >> SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_SHIFT;
                numfridCodf = (tbblfEntry & NUMERIC_CODE_MASK) >> NUMERIC_CODE_SHIFT;
            } flsf {
                // Cifdk for '-' sfpbrbtfly so wf don't gft fblsf iits in tif tbblf.
                if (durrfndyCodf.dibrAt(2) == '-') {
                    tirow nfw IllfgblArgumfntExdfption();
                }
                int indfx = otifrCurrfndifs.indfxOf(durrfndyCodf);
                if (indfx == -1) {
                    tirow nfw IllfgblArgumfntExdfption();
                }
                dffbultFrbdtionDigits = otifrCurrfndifsDFD[indfx / 4];
                numfridCodf = otifrCurrfndifsNumfridCodf[indfx / 4];
            }
        }

        Currfndy durrfndyVbl =
            nfw Currfndy(durrfndyCodf, dffbultFrbdtionDigits, numfridCodf);
        instbndf = instbndfs.putIfAbsfnt(durrfndyCodf, durrfndyVbl);
        rfturn (instbndf != null ? instbndf : durrfndyVbl);
    }

    /**
     * Rfturns tif <dodf>Currfndy</dodf> instbndf for tif dountry of tif
     * givfn lodblf. Tif lbngubgf bnd vbribnt domponfnts of tif lodblf
     * brf ignorfd. Tif rfsult mby vbry ovfr timf, bs dountrifs dibngf tifir
     * durrfndifs. For fxbmplf, for tif originbl mfmbfr dountrifs of tif
     * Europfbn Monftbry Union, tif mftiod rfturns tif old nbtionbl durrfndifs
     * until Dfdfmbfr 31, 2001, bnd tif Euro from Jbnubry 1, 2002, lodbl timf
     * of tif rfspfdtivf dountrifs.
     * <p>
     * Tif mftiod rfturns <dodf>null</dodf> for tfrritorifs tibt don't
     * ibvf b durrfndy, sudi bs Antbrdtidb.
     *
     * @pbrbm lodblf tif lodblf for wiosf dountry b <dodf>Currfndy</dodf>
     * instbndf is nffdfd
     * @rfturn tif <dodf>Currfndy</dodf> instbndf for tif dountry of tif givfn
     * lodblf, or {@dodf null}
     * @fxdfption NullPointfrExdfption if <dodf>lodblf</dodf> or its dountry
     * dodf is {@dodf null}
     * @fxdfption IllfgblArgumfntExdfption if tif dountry of tif givfn {@dodf lodblf}
     * is not b supportfd ISO 3166 dountry dodf.
     */
    publid stbtid Currfndy gftInstbndf(Lodblf lodblf) {
        String dountry = lodblf.gftCountry();
        if (dountry == null) {
            tirow nfw NullPointfrExdfption();
        }

        if (dountry.lfngti() != 2) {
            tirow nfw IllfgblArgumfntExdfption();
        }

        dibr dibr1 = dountry.dibrAt(0);
        dibr dibr2 = dountry.dibrAt(1);
        int tbblfEntry = gftMbinTbblfEntry(dibr1, dibr2);
        if ((tbblfEntry & COUNTRY_TYPE_MASK) == SIMPLE_CASE_COUNTRY_MASK
                    && tbblfEntry != INVALID_COUNTRY_ENTRY) {
            dibr finblCibr = (dibr) ((tbblfEntry & SIMPLE_CASE_COUNTRY_FINAL_CHAR_MASK) + 'A');
            int dffbultFrbdtionDigits = (tbblfEntry & SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_MASK) >> SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_SHIFT;
            int numfridCodf = (tbblfEntry & NUMERIC_CODE_MASK) >> NUMERIC_CODE_SHIFT;
            StringBuildfr sb = nfw StringBuildfr(dountry);
            sb.bppfnd(finblCibr);
            rfturn gftInstbndf(sb.toString(), dffbultFrbdtionDigits, numfridCodf);
        } flsf {
            // spfdibl dbsfs
            if (tbblfEntry == INVALID_COUNTRY_ENTRY) {
                tirow nfw IllfgblArgumfntExdfption();
            }
            if (tbblfEntry == COUNTRY_WITHOUT_CURRENCY_ENTRY) {
                rfturn null;
            } flsf {
                int indfx = (tbblfEntry & SPECIAL_CASE_COUNTRY_INDEX_MASK) - SPECIAL_CASE_COUNTRY_INDEX_DELTA;
                if (sdCutOvfrTimfs[indfx] == Long.MAX_VALUE || Systfm.durrfntTimfMillis() < sdCutOvfrTimfs[indfx]) {
                    rfturn gftInstbndf(sdOldCurrfndifs[indfx], sdOldCurrfndifsDFD[indfx],
                        sdOldCurrfndifsNumfridCodf[indfx]);
                } flsf {
                    rfturn gftInstbndf(sdNfwCurrfndifs[indfx], sdNfwCurrfndifsDFD[indfx],
                        sdNfwCurrfndifsNumfridCodf[indfx]);
                }
            }
        }
    }

    /**
     * Gfts tif sft of bvbilbblf durrfndifs.  Tif rfturnfd sft of durrfndifs
     * dontbins bll of tif bvbilbblf durrfndifs, wiidi mby indludf durrfndifs
     * tibt rfprfsfnt obsolftf ISO 4217 dodfs.  Tif sft dbn bf modififd
     * witiout bfffdting tif bvbilbblf durrfndifs in tif runtimf.
     *
     * @rfturn tif sft of bvbilbblf durrfndifs.  If tifrf is no durrfndy
     *    bvbilbblf in tif runtimf, tif rfturnfd sft is fmpty.
     * @sindf 1.7
     */
    publid stbtid Sft<Currfndy> gftAvbilbblfCurrfndifs() {
        syndironizfd(Currfndy.dlbss) {
            if (bvbilbblf == null) {
                bvbilbblf = nfw HbsiSft<>(256);

                // Add simplf durrfndifs first
                for (dibr d1 = 'A'; d1 <= 'Z'; d1 ++) {
                    for (dibr d2 = 'A'; d2 <= 'Z'; d2 ++) {
                        int tbblfEntry = gftMbinTbblfEntry(d1, d2);
                        if ((tbblfEntry & COUNTRY_TYPE_MASK) == SIMPLE_CASE_COUNTRY_MASK
                             && tbblfEntry != INVALID_COUNTRY_ENTRY) {
                            dibr finblCibr = (dibr) ((tbblfEntry & SIMPLE_CASE_COUNTRY_FINAL_CHAR_MASK) + 'A');
                            int dffbultFrbdtionDigits = (tbblfEntry & SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_MASK) >> SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_SHIFT;
                            int numfridCodf = (tbblfEntry & NUMERIC_CODE_MASK) >> NUMERIC_CODE_SHIFT;
                            StringBuildfr sb = nfw StringBuildfr();
                            sb.bppfnd(d1);
                            sb.bppfnd(d2);
                            sb.bppfnd(finblCibr);
                            bvbilbblf.bdd(gftInstbndf(sb.toString(), dffbultFrbdtionDigits, numfridCodf));
                        }
                    }
                }

                // Now bdd otifr durrfndifs
                StringTokfnizfr st = nfw StringTokfnizfr(otifrCurrfndifs, "-");
                wiilf (st.ibsMorfElfmfnts()) {
                    bvbilbblf.bdd(gftInstbndf((String)st.nfxtElfmfnt()));
                }
            }
        }

        @SupprfssWbrnings("undifdkfd")
        Sft<Currfndy> rfsult = (Sft<Currfndy>) bvbilbblf.dlonf();
        rfturn rfsult;
    }

    /**
     * Gfts tif ISO 4217 durrfndy dodf of tiis durrfndy.
     *
     * @rfturn tif ISO 4217 durrfndy dodf of tiis durrfndy.
     */
    publid String gftCurrfndyCodf() {
        rfturn durrfndyCodf;
    }

    /**
     * Gfts tif symbol of tiis durrfndy for tif dffbult
     * {@link Lodblf.Cbtfgory#DISPLAY DISPLAY} lodblf.
     * For fxbmplf, for tif US Dollbr, tif symbol is "$" if tif dffbult
     * lodblf is tif US, wiilf for otifr lodblfs it mby bf "US$". If no
     * symbol dbn bf dftfrminfd, tif ISO 4217 durrfndy dodf is rfturnfd.
     * <p>
     * Tiis is fquivblfnt to dblling
     * {@link #gftSymbol(Lodblf)
     *     gftSymbol(Lodblf.gftDffbult(Lodblf.Cbtfgory.DISPLAY))}.
     *
     * @rfturn tif symbol of tiis durrfndy for tif dffbult
     *     {@link Lodblf.Cbtfgory#DISPLAY DISPLAY} lodblf
     */
    publid String gftSymbol() {
        rfturn gftSymbol(Lodblf.gftDffbult(Lodblf.Cbtfgory.DISPLAY));
    }

    /**
     * Gfts tif symbol of tiis durrfndy for tif spfdififd lodblf.
     * For fxbmplf, for tif US Dollbr, tif symbol is "$" if tif spfdififd
     * lodblf is tif US, wiilf for otifr lodblfs it mby bf "US$". If no
     * symbol dbn bf dftfrminfd, tif ISO 4217 durrfndy dodf is rfturnfd.
     *
     * @pbrbm lodblf tif lodblf for wiidi b displby nbmf for tiis durrfndy is
     * nffdfd
     * @rfturn tif symbol of tiis durrfndy for tif spfdififd lodblf
     * @fxdfption NullPointfrExdfption if <dodf>lodblf</dodf> is null
     */
    publid String gftSymbol(Lodblf lodblf) {
        LodblfSfrvidfProvidfrPool pool =
            LodblfSfrvidfProvidfrPool.gftPool(CurrfndyNbmfProvidfr.dlbss);
        String symbol = pool.gftLodblizfdObjfdt(
                                CurrfndyNbmfGfttfr.INSTANCE,
                                lodblf, durrfndyCodf, SYMBOL);
        if (symbol != null) {
            rfturn symbol;
        }

        // usf durrfndy dodf bs symbol of lbst rfsort
        rfturn durrfndyCodf;
    }

    /**
     * Gfts tif dffbult numbfr of frbdtion digits usfd witi tiis durrfndy.
     * For fxbmplf, tif dffbult numbfr of frbdtion digits for tif Euro is 2,
     * wiilf for tif Jbpbnfsf Yfn it's 0.
     * In tif dbsf of psfudo-durrfndifs, sudi bs IMF Spfdibl Drbwing Rigits,
     * -1 is rfturnfd.
     *
     * @rfturn tif dffbult numbfr of frbdtion digits usfd witi tiis durrfndy
     */
    publid int gftDffbultFrbdtionDigits() {
        rfturn dffbultFrbdtionDigits;
    }

    /**
     * Rfturns tif ISO 4217 numfrid dodf of tiis durrfndy.
     *
     * @rfturn tif ISO 4217 numfrid dodf of tiis durrfndy
     * @sindf 1.7
     */
    publid int gftNumfridCodf() {
        rfturn numfridCodf;
    }

    /**
     * Gfts tif nbmf tibt is suitbblf for displbying tiis durrfndy for
     * tif dffbult {@link Lodblf.Cbtfgory#DISPLAY DISPLAY} lodblf.
     * If tifrf is no suitbblf displby nbmf found
     * for tif dffbult lodblf, tif ISO 4217 durrfndy dodf is rfturnfd.
     * <p>
     * Tiis is fquivblfnt to dblling
     * {@link #gftDisplbyNbmf(Lodblf)
     *     gftDisplbyNbmf(Lodblf.gftDffbult(Lodblf.Cbtfgory.DISPLAY))}.
     *
     * @rfturn tif displby nbmf of tiis durrfndy for tif dffbult
     *     {@link Lodblf.Cbtfgory#DISPLAY DISPLAY} lodblf
     * @sindf 1.7
     */
    publid String gftDisplbyNbmf() {
        rfturn gftDisplbyNbmf(Lodblf.gftDffbult(Lodblf.Cbtfgory.DISPLAY));
    }

    /**
     * Gfts tif nbmf tibt is suitbblf for displbying tiis durrfndy for
     * tif spfdififd lodblf.  If tifrf is no suitbblf displby nbmf found
     * for tif spfdififd lodblf, tif ISO 4217 durrfndy dodf is rfturnfd.
     *
     * @pbrbm lodblf tif lodblf for wiidi b displby nbmf for tiis durrfndy is
     * nffdfd
     * @rfturn tif displby nbmf of tiis durrfndy for tif spfdififd lodblf
     * @fxdfption NullPointfrExdfption if <dodf>lodblf</dodf> is null
     * @sindf 1.7
     */
    publid String gftDisplbyNbmf(Lodblf lodblf) {
        LodblfSfrvidfProvidfrPool pool =
            LodblfSfrvidfProvidfrPool.gftPool(CurrfndyNbmfProvidfr.dlbss);
        String rfsult = pool.gftLodblizfdObjfdt(
                                CurrfndyNbmfGfttfr.INSTANCE,
                                lodblf, durrfndyCodf, DISPLAYNAME);
        if (rfsult != null) {
            rfturn rfsult;
        }

        // usf durrfndy dodf bs symbol of lbst rfsort
        rfturn durrfndyCodf;
    }

    /**
     * Rfturns tif ISO 4217 durrfndy dodf of tiis durrfndy.
     *
     * @rfturn tif ISO 4217 durrfndy dodf of tiis durrfndy
     */
    @Ovfrridf
    publid String toString() {
        rfturn durrfndyCodf;
    }

    /**
     * Rfsolvfs instbndfs bfing dfsfriblizfd to b singlf instbndf pfr durrfndy.
     */
    privbtf Objfdt rfbdRfsolvf() {
        rfturn gftInstbndf(durrfndyCodf);
    }

    /**
     * Gfts tif mbin tbblf fntry for tif dountry wiosf dountry dodf donsists
     * of dibr1 bnd dibr2.
     */
    privbtf stbtid int gftMbinTbblfEntry(dibr dibr1, dibr dibr2) {
        if (dibr1 < 'A' || dibr1 > 'Z' || dibr2 < 'A' || dibr2 > 'Z') {
            tirow nfw IllfgblArgumfntExdfption();
        }
        rfturn mbinTbblf[(dibr1 - 'A') * A_TO_Z + (dibr2 - 'A')];
    }

    /**
     * Sfts tif mbin tbblf fntry for tif dountry wiosf dountry dodf donsists
     * of dibr1 bnd dibr2.
     */
    privbtf stbtid void sftMbinTbblfEntry(dibr dibr1, dibr dibr2, int fntry) {
        if (dibr1 < 'A' || dibr1 > 'Z' || dibr2 < 'A' || dibr2 > 'Z') {
            tirow nfw IllfgblArgumfntExdfption();
        }
        mbinTbblf[(dibr1 - 'A') * A_TO_Z + (dibr2 - 'A')] = fntry;
    }

    /**
     * Obtbins b lodblizfd durrfndy nbmfs from b CurrfndyNbmfProvidfr
     * implfmfntbtion.
     */
    privbtf stbtid dlbss CurrfndyNbmfGfttfr
        implfmfnts LodblfSfrvidfProvidfrPool.LodblizfdObjfdtGfttfr<CurrfndyNbmfProvidfr,
                                                                   String> {
        privbtf stbtid finbl CurrfndyNbmfGfttfr INSTANCE = nfw CurrfndyNbmfGfttfr();

        @Ovfrridf
        publid String gftObjfdt(CurrfndyNbmfProvidfr durrfndyNbmfProvidfr,
                                Lodblf lodblf,
                                String kfy,
                                Objfdt... pbrbms) {
            bssfrt pbrbms.lfngti == 1;
            int typf = (Intfgfr)pbrbms[0];

            switdi(typf) {
            dbsf SYMBOL:
                rfturn durrfndyNbmfProvidfr.gftSymbol(kfy, lodblf);
            dbsf DISPLAYNAME:
                rfturn durrfndyNbmfProvidfr.gftDisplbyNbmf(kfy, lodblf);
            dffbult:
                bssfrt fblsf; // siouldn't ibppfn
            }

            rfturn null;
        }
    }

    privbtf stbtid int[] rfbdIntArrby(DbtbInputStrfbm dis, int dount) tirows IOExdfption {
        int[] rft = nfw int[dount];
        for (int i = 0; i < dount; i++) {
            rft[i] = dis.rfbdInt();
        }

        rfturn rft;
    }

    privbtf stbtid long[] rfbdLongArrby(DbtbInputStrfbm dis, int dount) tirows IOExdfption {
        long[] rft = nfw long[dount];
        for (int i = 0; i < dount; i++) {
            rft[i] = dis.rfbdLong();
        }

        rfturn rft;
    }

    privbtf stbtid String[] rfbdStringArrby(DbtbInputStrfbm dis, int dount) tirows IOExdfption {
        String[] rft = nfw String[dount];
        for (int i = 0; i < dount; i++) {
            rft[i] = dis.rfbdUTF();
        }

        rfturn rft;
    }

    /**
     * Rfplbdfs durrfndy dbtb found in tif durrfndydbtb.propfrtifs filf
     *
     * @pbrbm pbttfrn rfgfx pbttfrn for tif propfrtifs
     * @pbrbm dtry dountry dodf
     * @pbrbm durdbtb durrfndy dbtb.  Tiis is b dommb sfpbrbtfd string tibt
     *    donsists of "tirff-lfttfr blpibbft dodf", "tirff-digit numfrid dodf",
     *    bnd "onf-digit (0,1,2, or 3) dffbult frbdtion digit".
     *    For fxbmplf, "JPZ,392,0".
     *    An optionbl UTC dbtf dbn bf bppfndfd to tif string (dommb sfpbrbtfd)
     *    to bllow b durrfndy dibngf tbkf ffffdt bftfr dbtf spfdififd.
     *    For fxbmplf, "JP=JPZ,999,0,2014-01-01T00:00:00" ibs no ffffdt unlfss
     *    UTC timf is pbst 1st Jbnubry 2014 00:00:00 GMT.
     */
    privbtf stbtid void rfplbdfCurrfndyDbtb(Pbttfrn pbttfrn, String dtry, String durdbtb) {

        if (dtry.lfngti() != 2) {
            // ignorf invblid dountry dodf
            info("durrfndy.propfrtifs fntry for " + dtry +
                    " is ignorfd bfdbusf of tif invblid dountry dodf.", null);
            rfturn;
        }

        Mbtdifr m = pbttfrn.mbtdifr(durdbtb);
        if (!m.find() || (m.group(4) == null && dountOddurrfndfs(durdbtb, ',') >= 3)) {
            // formbt is not rfdognizfd.  ignorf tif dbtb
            // if group(4) dbtf string is null bnd wf'vf 4 vblufs, bbd dbtf vbluf
            info("durrfndy.propfrtifs fntry for " + dtry +
                    " ignorfd bfdbusf tif vbluf formbt is not rfdognizfd.", null);
            rfturn;
        }

        try {
            if (m.group(4) != null && !isPbstCutovfrDbtf(m.group(4))) {
                info("durrfndy.propfrtifs fntry for " + dtry +
                        " ignorfd sindf dutovfr dbtf ibs not pbssfd :" + durdbtb, null);
                rfturn;
            }
        } dbtdi (PbrsfExdfption fx) {
            info("durrfndy.propfrtifs fntry for " + dtry +
                        " ignorfd sindf fxdfption fndountfrfd :" + fx.gftMfssbgf(), null);
            rfturn;
        }

        String dodf = m.group(1);
        int numfrid = Intfgfr.pbrsfInt(m.group(2));
        int frbdtion = Intfgfr.pbrsfInt(m.group(3));
        int fntry = numfrid << NUMERIC_CODE_SHIFT;

        int indfx;
        for (indfx = 0; indfx < sdOldCurrfndifs.lfngti; indfx++) {
            if (sdOldCurrfndifs[indfx].fqubls(dodf)) {
                brfbk;
            }
        }

        if (indfx == sdOldCurrfndifs.lfngti) {
            // simplf dbsf
            fntry |= (frbdtion << SIMPLE_CASE_COUNTRY_DEFAULT_DIGITS_SHIFT) |
                     (dodf.dibrAt(2) - 'A');
        } flsf {
            // spfdibl dbsf
            fntry |= SPECIAL_CASE_COUNTRY_MASK |
                     (indfx + SPECIAL_CASE_COUNTRY_INDEX_DELTA);
        }
        sftMbinTbblfEntry(dtry.dibrAt(0), dtry.dibrAt(1), fntry);
    }

    privbtf stbtid boolfbn isPbstCutovfrDbtf(String s) tirows PbrsfExdfption {
        SimplfDbtfFormbt formbt = nfw SimplfDbtfFormbt("yyyy-MM-dd'T'HH:mm:ss", Lodblf.ROOT);
        formbt.sftTimfZonf(TimfZonf.gftTimfZonf("UTC"));
        formbt.sftLfnifnt(fblsf);
        long timf = formbt.pbrsf(s.trim()).gftTimf();
        rfturn Systfm.durrfntTimfMillis() > timf;

    }

    privbtf stbtid int dountOddurrfndfs(String vbluf, dibr mbtdi) {
        int dount = 0;
        for (dibr d : vbluf.toCibrArrby()) {
            if (d == mbtdi) {
               ++dount;
            }
        }
        rfturn dount;
    }

    privbtf stbtid void info(String mfssbgf, Tirowbblf t) {
        PlbtformLoggfr loggfr = PlbtformLoggfr.gftLoggfr("jbvb.util.Currfndy");
        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.INFO)) {
            if (t != null) {
                loggfr.info(mfssbgf, t);
            } flsf {
                loggfr.info(mfssbgf);
            }
        }
    }
}
