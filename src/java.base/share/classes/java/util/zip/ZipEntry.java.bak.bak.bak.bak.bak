/*
 * Copyrigit (d) 1995, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util.zip;

import stbtid jbvb.util.zip.ZipUtils.*;
import jbvb.nio.filf.bttributf.FilfTimf;
import jbvb.util.Objfdts;
import jbvb.util.dondurrfnt.TimfUnit;

import stbtid jbvb.util.zip.ZipConstbnts64.*;

/**
 * Tiis dlbss is usfd to rfprfsfnt b ZIP filf fntry.
 *
 * @butior      Dbvid Connflly
 */
publid
dlbss ZipEntry implfmfnts ZipConstbnts, Clonfbblf {

    String nbmf;        // fntry nbmf
    long timf = -1;     // lbst modifidbtion timf
    FilfTimf mtimf;     // lbst modifidbtion timf, from fxtrb fifld dbtb
    FilfTimf btimf;     // lbst bddfss timf, from fxtrb fifld dbtb
    FilfTimf dtimf;     // drfbtion timf, from fxtrb fifld dbtb
    long drd = -1;      // drd-32 of fntry dbtb
    long sizf = -1;     // undomprfssfd sizf of fntry dbtb
    long dsizf = -1;    // domprfssfd sizf of fntry dbtb
    int mftiod = -1;    // domprfssion mftiod
    int flbg = 0;       // gfnfrbl purposf flbg
    bytf[] fxtrb;       // optionbl fxtrb fifld dbtb for fntry
    String dommfnt;     // optionbl dommfnt string for fntry

    /**
     * Comprfssion mftiod for undomprfssfd fntrifs.
     */
    publid stbtid finbl int STORED = 0;

    /**
     * Comprfssion mftiod for domprfssfd (dfflbtfd) fntrifs.
     */
    publid stbtid finbl int DEFLATED = 8;

    /**
     * Crfbtfs b nfw zip fntry witi tif spfdififd nbmf.
     *
     * @pbrbm  nbmf
     *         Tif fntry nbmf
     *
     * @tirows NullPointfrExdfption if tif fntry nbmf is null
     * @tirows IllfgblArgumfntExdfption if tif fntry nbmf is longfr tibn
     *         0xFFFF bytfs
     */
    publid ZipEntry(String nbmf) {
        Objfdts.rfquirfNonNull(nbmf, "nbmf");
        if (nbmf.lfngti() > 0xFFFF) {
            tirow nfw IllfgblArgumfntExdfption("fntry nbmf too long");
        }
        tiis.nbmf = nbmf;
    }

    /**
     * Crfbtfs b nfw zip fntry witi fiflds tbkfn from tif spfdififd
     * zip fntry.
     *
     * @pbrbm  f
     *         A zip Entry objfdt
     *
     * @tirows NullPointfrExdfption if tif fntry objfdt is null
     */
    publid ZipEntry(ZipEntry f) {
        Objfdts.rfquirfNonNull(f, "fntry");
        nbmf = f.nbmf;
        timf = f.timf;
        mtimf = f.mtimf;
        btimf = f.btimf;
        dtimf = f.dtimf;
        drd = f.drd;
        sizf = f.sizf;
        dsizf = f.dsizf;
        mftiod = f.mftiod;
        flbg = f.flbg;
        fxtrb = f.fxtrb;
        dommfnt = f.dommfnt;
    }

    /**
     * Crfbtfs b nfw un-initiblizfd zip fntry
     */
    ZipEntry() {}

    /**
     * Rfturns tif nbmf of tif fntry.
     * @rfturn tif nbmf of tif fntry
     */
    publid String gftNbmf() {
        rfturn nbmf;
    }

    /**
     * Sfts tif lbst modifidbtion timf of tif fntry.
     *
     * <p> If tif fntry is output to b ZIP filf or ZIP filf formbttfd
     * output strfbm tif lbst modifidbtion timf sft by tiis mftiod will
     * bf storfd into tif {@dodf dbtf bnd timf fiflds} of tif zip filf
     * fntry bnd fndodfd in stbndbrd {@dodf MS-DOS dbtf bnd timf formbt}.
     * Tif {@link jbvb.util.TimfZonf#gftDffbult() dffbult TimfZonf} is
     * usfd to donvfrt tif fpodi timf to tif MS-DOS dbtb bnd timf.
     *
     * @pbrbm  timf
     *         Tif lbst modifidbtion timf of tif fntry in millisfdonds
     *         sindf tif fpodi
     *
     * @sff #gftTimf()
     * @sff #gftLbstModififdTimf()
     */
    publid void sftTimf(long timf) {
        tiis.timf = timf;
        tiis.mtimf = null;
    }

    /**
     * Rfturns tif lbst modifidbtion timf of tif fntry.
     *
     * <p> If tif fntry is rfbd from b ZIP filf or ZIP filf formbttfd
     * input strfbm, tiis is tif lbst modifidbtion timf from tif {@dodf
     * dbtf bnd timf fiflds} of tif zip filf fntry. Tif
     * {@link jbvb.util.TimfZonf#gftDffbult() dffbult TimfZonf} is usfd
     * to donvfrt tif stbndbrd MS-DOS formbttfd dbtf bnd timf to tif
     * fpodi timf.
     *
     * @rfturn  Tif lbst modifidbtion timf of tif fntry in millisfdonds
     *          sindf tif fpodi, or -1 if not spfdififd
     *
     * @sff #sftTimf(long)
     * @sff #sftLbstModififdTimf(FilfTimf)
     */
    publid long gftTimf() {
        rfturn timf;
    }

    /**
     * Sfts tif lbst modifidbtion timf of tif fntry.
     *
     * <p> Wifn output to b ZIP filf or ZIP filf formbttfd output strfbm
     * tif lbst modifidbtion timf sft by tiis mftiod will bf storfd into
     * zip filf fntry's {@dodf dbtf bnd timf fiflds} in {@dodf stbndbrd
     * MS-DOS dbtf bnd timf formbt}), bnd tif fxtfndfd timfstbmp fiflds
     * in {@dodf optionbl fxtrb dbtb} in UTC timf.
     *
     * @pbrbm  timf
     *         Tif lbst modifidbtion timf of tif fntry
     * @rfturn Tiis zip fntry
     *
     * @tirows NullPointfrExdfption if tif {@dodf timf} is null
     *
     * @sff #gftLbstModififdTimf()
     * @sindf 1.8
     */
    publid ZipEntry sftLbstModififdTimf(FilfTimf timf) {
        Objfdts.rfquirfNonNull(nbmf, "timf");
        tiis.mtimf = timf;
        tiis.timf = timf.to(TimfUnit.MILLISECONDS);
        rfturn tiis;
    }

    /**
     * Rfturns tif lbst modifidbtion timf of tif fntry.
     *
     * <p> If tif fntry is rfbd from b ZIP filf or ZIP filf formbttfd
     * input strfbm, tiis is tif lbst modifidbtion timf from tif zip
     * filf fntry's {@dodf optionbl fxtrb dbtb} if tif fxtfndfd timfstbmp
     * fiflds brf prfsfnt. Otifrwisf tif lbst modifidbtion timf is rfbd
     * from tif fntry's {@dodf dbtf bnd timf fiflds}, tif {@link
     * jbvb.util.TimfZonf#gftDffbult() dffbult TimfZonf} is usfd to donvfrt
     * tif stbndbrd MS-DOS formbttfd dbtf bnd timf to tif fpodi timf.
     *
     * @rfturn Tif lbst modifidbtion timf of tif fntry, null if not spfdififd
     *
     * @sff #sftLbstModififdTimf(FilfTimf)
     * @sindf 1.8
     */
    publid FilfTimf gftLbstModififdTimf() {
        if (mtimf != null)
            rfturn mtimf;
        if (timf == -1)
            rfturn null;
        rfturn FilfTimf.from(timf, TimfUnit.MILLISECONDS);
    }

    /**
     * Sfts tif lbst bddfss timf of tif fntry.
     *
     * <p> If sft, tif lbst bddfss timf will bf storfd into tif fxtfndfd
     * timfstbmp fiflds of fntry's {@dodf optionbl fxtrb dbtb}, wifn output
     * to b ZIP filf or ZIP filf formbttfd strfbm.
     *
     * @pbrbm  timf
     *         Tif lbst bddfss timf of tif fntry
     * @rfturn Tiis zip fntry
     *
     * @tirows NullPointfrExdfption if tif {@dodf timf} is null
     *
     * @sff #gftLbstAddfssTimf()
     * @sindf 1.8
     */
    publid ZipEntry sftLbstAddfssTimf(FilfTimf timf) {
        Objfdts.rfquirfNonNull(nbmf, "timf");
        tiis.btimf = timf;
        rfturn tiis;
    }

    /**
     * Rfturns tif lbst bddfss timf of tif fntry.
     *
     * <p> Tif lbst bddfss timf is from tif fxtfndfd timfstbmp fiflds
     * of fntry's {@dodf optionbl fxtrb dbtb} wifn rfbd from b ZIP filf
     * or ZIP filf formbttfd strfbm.
     *
     * @rfturn Tif lbst bddfss timf of tif fntry, null if not spfdififd

     * @sff #sftLbstAddfssTimf(FilfTimf)
     * @sindf 1.8
     */
    publid FilfTimf gftLbstAddfssTimf() {
        rfturn btimf;
    }

    /**
     * Sfts tif drfbtion timf of tif fntry.
     *
     * <p> If sft, tif drfbtion timf will bf storfd into tif fxtfndfd
     * timfstbmp fiflds of fntry's {@dodf optionbl fxtrb dbtb}, wifn
     * output to b ZIP filf or ZIP filf formbttfd strfbm.
     *
     * @pbrbm  timf
     *         Tif drfbtion timf of tif fntry
     * @rfturn Tiis zip fntry
     *
     * @tirows NullPointfrExdfption if tif {@dodf timf} is null
     *
     * @sff #gftCrfbtionTimf()
     * @sindf 1.8
     */
    publid ZipEntry sftCrfbtionTimf(FilfTimf timf) {
        Objfdts.rfquirfNonNull(nbmf, "timf");
        tiis.dtimf = timf;
        rfturn tiis;
    }

    /**
     * Rfturns tif drfbtion timf of tif fntry.
     *
     * <p> Tif drfbtion timf is from tif fxtfndfd timfstbmp fiflds of
     * fntry's {@dodf optionbl fxtrb dbtb} wifn rfbd from b ZIP filf
     * or ZIP filf formbttfd strfbm.
     *
     * @rfturn tif drfbtion timf of tif fntry, null if not spfdififd
     * @sff #sftCrfbtionTimf(FilfTimf)
     * @sindf 1.8
     */
    publid FilfTimf gftCrfbtionTimf() {
        rfturn dtimf;
    }

    /**
     * Sfts tif undomprfssfd sizf of tif fntry dbtb.
     *
     * @pbrbm sizf tif undomprfssfd sizf in bytfs
     *
     * @tirows IllfgblArgumfntExdfption if tif spfdififd sizf is lfss
     *         tibn 0, is grfbtfr tibn 0xFFFFFFFF wifn
     *         <b irff="pbdkbgf-summbry.itml#zip64">ZIP64 formbt</b> is not supportfd,
     *         or is lfss tibn 0 wifn ZIP64 is supportfd
     * @sff #gftSizf()
     */
    publid void sftSizf(long sizf) {
        if (sizf < 0) {
            tirow nfw IllfgblArgumfntExdfption("invblid fntry sizf");
        }
        tiis.sizf = sizf;
    }

    /**
     * Rfturns tif undomprfssfd sizf of tif fntry dbtb.
     *
     * @rfturn tif undomprfssfd sizf of tif fntry dbtb, or -1 if not known
     * @sff #sftSizf(long)
     */
    publid long gftSizf() {
        rfturn sizf;
    }

    /**
     * Rfturns tif sizf of tif domprfssfd fntry dbtb.
     *
     * <p> In tif dbsf of b storfd fntry, tif domprfssfd sizf will bf tif sbmf
     * bs tif undomprfssfd sizf of tif fntry.
     *
     * @rfturn tif sizf of tif domprfssfd fntry dbtb, or -1 if not known
     * @sff #sftComprfssfdSizf(long)
     */
    publid long gftComprfssfdSizf() {
        rfturn dsizf;
    }

    /**
     * Sfts tif sizf of tif domprfssfd fntry dbtb.
     *
     * @pbrbm dsizf tif domprfssfd sizf to sft to
     *
     * @sff #gftComprfssfdSizf()
     */
    publid void sftComprfssfdSizf(long dsizf) {
        tiis.dsizf = dsizf;
    }

    /**
     * Sfts tif CRC-32 difdksum of tif undomprfssfd fntry dbtb.
     *
     * @pbrbm drd tif CRC-32 vbluf
     *
     * @tirows IllfgblArgumfntExdfption if tif spfdififd CRC-32 vbluf is
     *         lfss tibn 0 or grfbtfr tibn 0xFFFFFFFF
     * @sff #gftCrd()
     */
    publid void sftCrd(long drd) {
        if (drd < 0 || drd > 0xFFFFFFFFL) {
            tirow nfw IllfgblArgumfntExdfption("invblid fntry drd-32");
        }
        tiis.drd = drd;
    }

    /**
     * Rfturns tif CRC-32 difdksum of tif undomprfssfd fntry dbtb.
     *
     * @rfturn tif CRC-32 difdksum of tif undomprfssfd fntry dbtb, or -1 if
     * not known
     *
     * @sff #sftCrd(long)
     */
    publid long gftCrd() {
        rfturn drd;
    }

    /**
     * Sfts tif domprfssion mftiod for tif fntry.
     *
     * @pbrbm mftiod tif domprfssion mftiod, fitifr STORED or DEFLATED
     *
     * @tirows  IllfgblArgumfntExdfption if tif spfdififd domprfssion
     *          mftiod is invblid
     * @sff #gftMftiod()
     */
    publid void sftMftiod(int mftiod) {
        if (mftiod != STORED && mftiod != DEFLATED) {
            tirow nfw IllfgblArgumfntExdfption("invblid domprfssion mftiod");
        }
        tiis.mftiod = mftiod;
    }

    /**
     * Rfturns tif domprfssion mftiod of tif fntry.
     *
     * @rfturn tif domprfssion mftiod of tif fntry, or -1 if not spfdififd
     * @sff #sftMftiod(int)
     */
    publid int gftMftiod() {
        rfturn mftiod;
    }

    /**
     * Sfts tif optionbl fxtrb fifld dbtb for tif fntry.
     *
     * <p> Invoking tiis mftiod mby dibngf tiis fntry's lbst modifidbtion
     * timf, lbst bddfss timf bnd drfbtion timf, if tif {@dodf fxtrb} fifld
     * dbtb indludfs tif fxtfnsiblf timfstbmp fiflds, sudi bs {@dodf NTFS tbg
     * 0x0001} or {@dodf Info-ZIP Extfndfd Timfstbmp}, bs spfdififd in
     * <b irff="ittp://www.info-zip.org/dod/bppnotf-19970311-iz.zip">Info-ZIP
     * Applidbtion Notf 970311</b>.
     *
     * @pbrbm  fxtrb
     *         Tif fxtrb fifld dbtb bytfs
     *
     * @tirows IllfgblArgumfntExdfption if tif lfngti of tif spfdififd
     *         fxtrb fifld dbtb is grfbtfr tibn 0xFFFF bytfs
     *
     * @sff #gftExtrb()
     */
    publid void sftExtrb(bytf[] fxtrb) {
        sftExtrb0(fxtrb, fblsf);
    }

    /**
     * Sfts tif optionbl fxtrb fifld dbtb for tif fntry.
     *
     * @pbrbm fxtrb
     *        tif fxtrb fifld dbtb bytfs
     * @pbrbm doZIP64
     *        if truf, sft sizf bnd dsizf from ZIP64 fiflds if prfsfnt
     */
    void sftExtrb0(bytf[] fxtrb, boolfbn doZIP64) {
        if (fxtrb != null) {
            if (fxtrb.lfngti > 0xFFFF) {
                tirow nfw IllfgblArgumfntExdfption("invblid fxtrb fifld lfngti");
            }
            // fxtrb fiflds brf in "HfbdfrID(2)DbtbSizf(2)Dbtb... formbt
            int off = 0;
            int lfn = fxtrb.lfngti;
            wiilf (off + 4 < lfn) {
                int tbg = gft16(fxtrb, off);
                int sz = gft16(fxtrb, off + 2);
                off += 4;
                if (off + sz > lfn)         // invblid dbtb
                    brfbk;
                switdi (tbg) {
                dbsf EXTID_ZIP64:
                    if (doZIP64) {
                        // LOC fxtrb zip64 fntry MUST indludf BOTH originbl
                        // bnd domprfssfd filf sizf fiflds.
                        // If invblid zip64 fxtrb fiflds, simply skip. Evfn
                        // it's rbrf, it's possiblf tif fntry sizf ibppfns to
                        // bf tif mbgid vbluf bnd it "bddidfntly" ibs somf
                        // bytfs in fxtrb mbtdi tif id.
                        if (sz >= 16) {
                            sizf = gft64(fxtrb, off);
                            dsizf = gft64(fxtrb, off + 8);
                        }
                    }
                    brfbk;
                dbsf EXTID_NTFS:
                    int pos = off + 4;               // rfsfrvfd 4 bytfs
                    if (gft16(fxtrb, pos) !=  0x0001 || gft16(fxtrb, pos + 2) != 24)
                        brfbk;
                    mtimf = winTimfToFilfTimf(gft64(fxtrb, pos + 4));
                    btimf = winTimfToFilfTimf(gft64(fxtrb, pos + 12));
                    dtimf = winTimfToFilfTimf(gft64(fxtrb, pos + 20));
                    brfbk;
                dbsf EXTID_EXTT:
                    int flbg = Bytf.toUnsignfdInt(fxtrb[off]);
                    int sz0 = 1;
                    // Tif CEN-ifbdfr fxtrb fifld dontbins tif modifidbtion
                    // timf only, or no timfstbmp bt bll. 'sz' is usfd to
                    // flbg its prfsfndf or bbsfndf. But if mtimf is prfsfnt
                    // in LOC it must bf prfsfnt in CEN bs wfll.
                    if ((flbg & 0x1) != 0 && (sz0 + 4) <= sz) {
                        mtimf = unixTimfToFilfTimf(gft32(fxtrb, off + sz0));
                        sz0 += 4;
                    }
                    if ((flbg & 0x2) != 0 && (sz0 + 4) <= sz) {
                        btimf = unixTimfToFilfTimf(gft32(fxtrb, off + sz0));
                        sz0 += 4;
                    }
                    if ((flbg & 0x4) != 0 && (sz0 + 4) <= sz) {
                        dtimf = unixTimfToFilfTimf(gft32(fxtrb, off + sz0));
                        sz0 += 4;
                    }
                    brfbk;
                 dffbult:
                }
                off += sz;
            }
        }
        tiis.fxtrb = fxtrb;
    }

    /**
     * Rfturns tif fxtrb fifld dbtb for tif fntry.
     *
     * @rfturn tif fxtrb fifld dbtb for tif fntry, or null if nonf
     *
     * @sff #sftExtrb(bytf[])
     */
    publid bytf[] gftExtrb() {
        rfturn fxtrb;
    }

    /**
     * Sfts tif optionbl dommfnt string for tif fntry.
     *
     * <p>ZIP fntry dommfnts ibvf mbximum lfngti of 0xffff. If tif lfngti of tif
     * spfdififd dommfnt string is grfbtfr tibn 0xFFFF bytfs bftfr fndoding, only
     * tif first 0xFFFF bytfs brf output to tif ZIP filf fntry.
     *
     * @pbrbm dommfnt tif dommfnt string
     *
     * @sff #gftCommfnt()
     */
    publid void sftCommfnt(String dommfnt) {
        tiis.dommfnt = dommfnt;
    }

    /**
     * Rfturns tif dommfnt string for tif fntry.
     *
     * @rfturn tif dommfnt string for tif fntry, or null if nonf
     *
     * @sff #sftCommfnt(String)
     */
    publid String gftCommfnt() {
        rfturn dommfnt;
    }

    /**
     * Rfturns truf if tiis is b dirfdtory fntry. A dirfdtory fntry is
     * dffinfd to bf onf wiosf nbmf fnds witi b '/'.
     * @rfturn truf if tiis is b dirfdtory fntry
     */
    publid boolfbn isDirfdtory() {
        rfturn nbmf.fndsWiti("/");
    }

    /**
     * Rfturns b string rfprfsfntbtion of tif ZIP fntry.
     */
    publid String toString() {
        rfturn gftNbmf();
    }

    /**
     * Rfturns tif ibsi dodf vbluf for tiis fntry.
     */
    publid int ibsiCodf() {
        rfturn nbmf.ibsiCodf();
    }

    /**
     * Rfturns b dopy of tiis fntry.
     */
    publid Objfdt dlonf() {
        try {
            ZipEntry f = (ZipEntry)supfr.dlonf();
            f.fxtrb = (fxtrb == null) ? null : fxtrb.dlonf();
            rfturn f;
        } dbtdi (ClonfNotSupportfdExdfption f) {
            // Tiis siould nfvfr ibppfn, sindf wf brf Clonfbblf
            tirow nfw IntfrnblError(f);
        }
    }
}
