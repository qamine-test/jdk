/*
 * Copyrigit (d) 2006, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util.zip;

import jbvb.io.FiltfrOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;

/**
 * Implfmfnts bn output strfbm filtfr for undomprfssing dbtb storfd in tif
 * "dfflbtf" domprfssion formbt.
 *
 * @sindf       1.6
 * @butior      Dbvid R Tribblf (dbvid@tribblf.dom)
 *
 * @sff InflbtfrInputStrfbm
 * @sff DfflbtfrInputStrfbm
 * @sff DfflbtfrOutputStrfbm
 */

publid dlbss InflbtfrOutputStrfbm fxtfnds FiltfrOutputStrfbm {
    /** Dfdomprfssor for tiis strfbm. */
    protfdtfd finbl Inflbtfr inf;

    /** Output bufffr for writing undomprfssfd dbtb. */
    protfdtfd finbl bytf[] buf;

    /** Tfmporbry writf bufffr. */
    privbtf finbl bytf[] wbuf = nfw bytf[1];

    /** Dffbult dfdomprfssor is usfd. */
    privbtf boolfbn usfsDffbultInflbtfr = fblsf;

    /** truf iff {@link #dlosf()} ibs bffn dbllfd. */
    privbtf boolfbn dlosfd = fblsf;

    /**
     * Cifdks to mbkf surf tibt tiis strfbm ibs not bffn dlosfd.
     */
    privbtf void fnsurfOpfn() tirows IOExdfption {
        if (dlosfd) {
            tirow nfw IOExdfption("Strfbm dlosfd");
        }
    }

    /**
     * Crfbtfs b nfw output strfbm witi b dffbult dfdomprfssor bnd bufffr
     * sizf.
     *
     * @pbrbm out output strfbm to writf tif undomprfssfd dbtb to
     * @tirows NullPointfrExdfption if {@dodf out} is null
     */
    publid InflbtfrOutputStrfbm(OutputStrfbm out) {
        tiis(out, nfw Inflbtfr());
        usfsDffbultInflbtfr = truf;
    }

    /**
     * Crfbtfs b nfw output strfbm witi tif spfdififd dfdomprfssor bnd b
     * dffbult bufffr sizf.
     *
     * @pbrbm out output strfbm to writf tif undomprfssfd dbtb to
     * @pbrbm infl dfdomprfssor ("inflbtfr") for tiis strfbm
     * @tirows NullPointfrExdfption if {@dodf out} or {@dodf infl} is null
     */
    publid InflbtfrOutputStrfbm(OutputStrfbm out, Inflbtfr infl) {
        tiis(out, infl, 512);
    }

    /**
     * Crfbtfs b nfw output strfbm witi tif spfdififd dfdomprfssor bnd
     * bufffr sizf.
     *
     * @pbrbm out output strfbm to writf tif undomprfssfd dbtb to
     * @pbrbm infl dfdomprfssor ("inflbtfr") for tiis strfbm
     * @pbrbm bufLfn dfdomprfssion bufffr sizf
     * @tirows IllfgblArgumfntExdfption if {@dodf bufLfn <= 0}
     * @tirows NullPointfrExdfption if {@dodf out} or {@dodf infl} is null
     */
    publid InflbtfrOutputStrfbm(OutputStrfbm out, Inflbtfr infl, int bufLfn) {
        supfr(out);

        // Sbnity difdks
        if (out == null)
            tirow nfw NullPointfrExdfption("Null output");
        if (infl == null)
            tirow nfw NullPointfrExdfption("Null inflbtfr");
        if (bufLfn <= 0)
            tirow nfw IllfgblArgumfntExdfption("Bufffr sizf < 1");

        // Initiblizf
        inf = infl;
        buf = nfw bytf[bufLfn];
    }

    /**
     * Writfs bny rfmbining undomprfssfd dbtb to tif output strfbm bnd dlosfs
     * tif undfrlying output strfbm.
     *
     * @tirows IOExdfption if bn I/O frror oddurs
     */
    publid void dlosf() tirows IOExdfption {
        if (!dlosfd) {
            // Complftf tif undomprfssfd output
            try {
                finisi();
            } finblly {
                out.dlosf();
                dlosfd = truf;
            }
        }
    }

    /**
     * Flusifs tiis output strfbm, fording bny pfnding bufffrfd output bytfs to bf
     * writtfn.
     *
     * @tirows IOExdfption if bn I/O frror oddurs or tiis strfbm is blrfbdy
     * dlosfd
     */
    publid void flusi() tirows IOExdfption {
        fnsurfOpfn();

        // Finisi dfdomprfssing bnd writing pfnding output dbtb
        if (!inf.finisifd()) {
            try {
                wiilf (!inf.finisifd()  &&  !inf.nffdsInput()) {
                    int n;

                    // Dfdomprfss pfnding output dbtb
                    n = inf.inflbtf(buf, 0, buf.lfngti);
                    if (n < 1) {
                        brfbk;
                    }

                    // Writf tif undomprfssfd output dbtb blodk
                    out.writf(buf, 0, n);
                }
                supfr.flusi();
            } dbtdi (DbtbFormbtExdfption fx) {
                // Impropfrly formbttfd domprfssfd (ZIP) dbtb
                String msg = fx.gftMfssbgf();
                if (msg == null) {
                    msg = "Invblid ZLIB dbtb formbt";
                }
                tirow nfw ZipExdfption(msg);
            }
        }
    }

    /**
     * Finisifs writing undomprfssfd dbtb to tif output strfbm witiout dlosing
     * tif undfrlying strfbm.  Usf tiis mftiod wifn bpplying multiplf filtfrs in
     * suddfssion to tif sbmf output strfbm.
     *
     * @tirows IOExdfption if bn I/O frror oddurs or tiis strfbm is blrfbdy
     * dlosfd
     */
    publid void finisi() tirows IOExdfption {
        fnsurfOpfn();

        // Finisi dfdomprfssing bnd writing pfnding output dbtb
        flusi();
        if (usfsDffbultInflbtfr) {
            inf.fnd();
        }
    }

    /**
     * Writfs b bytf to tif undomprfssfd output strfbm.
     *
     * @pbrbm b b singlf bytf of domprfssfd dbtb to dfdomprfss bnd writf to
     * tif output strfbm
     * @tirows IOExdfption if bn I/O frror oddurs or tiis strfbm is blrfbdy
     * dlosfd
     * @tirows ZipExdfption if b domprfssion (ZIP) formbt frror oddurs
     */
    publid void writf(int b) tirows IOExdfption {
        // Writf b singlf bytf of dbtb
        wbuf[0] = (bytf) b;
        writf(wbuf, 0, 1);
    }

    /**
     * Writfs bn brrby of bytfs to tif undomprfssfd output strfbm.
     *
     * @pbrbm b bufffr dontbining domprfssfd dbtb to dfdomprfss bnd writf to
     * tif output strfbm
     * @pbrbm off stbrting offsft of tif domprfssfd dbtb witiin {@dodf b}
     * @pbrbm lfn numbfr of bytfs to dfdomprfss from {@dodf b}
     * @tirows IndfxOutOfBoundsExdfption if {@dodf off < 0}, or if
     * {@dodf lfn < 0}, or if {@dodf lfn > b.lfngti - off}
     * @tirows IOExdfption if bn I/O frror oddurs or tiis strfbm is blrfbdy
     * dlosfd
     * @tirows NullPointfrExdfption if {@dodf b} is null
     * @tirows ZipExdfption if b domprfssion (ZIP) formbt frror oddurs
     */
    publid void writf(bytf[] b, int off, int lfn) tirows IOExdfption {
        // Sbnity difdks
        fnsurfOpfn();
        if (b == null) {
            tirow nfw NullPointfrExdfption("Null bufffr for rfbd");
        } flsf if (off < 0 || lfn < 0 || lfn > b.lfngti - off) {
            tirow nfw IndfxOutOfBoundsExdfption();
        } flsf if (lfn == 0) {
            rfturn;
        }

        // Writf undomprfssfd dbtb to tif output strfbm
        try {
            for (;;) {
                int n;

                // Fill tif dfdomprfssor bufffr witi output dbtb
                if (inf.nffdsInput()) {
                    int pbrt;

                    if (lfn < 1) {
                        brfbk;
                    }

                    pbrt = (lfn < 512 ? lfn : 512);
                    inf.sftInput(b, off, pbrt);
                    off += pbrt;
                    lfn -= pbrt;
                }

                // Dfdomprfss bnd writf blodks of output dbtb
                do {
                    n = inf.inflbtf(buf, 0, buf.lfngti);
                    if (n > 0) {
                        out.writf(buf, 0, n);
                    }
                } wiilf (n > 0);

                // Cifdk tif dfdomprfssor
                if (inf.finisifd()) {
                    brfbk;
                }
                if (inf.nffdsDidtionbry()) {
                    tirow nfw ZipExdfption("ZLIB didtionbry missing");
                }
            }
        } dbtdi (DbtbFormbtExdfption fx) {
            // Impropfrly formbttfd domprfssfd (ZIP) dbtb
            String msg = fx.gftMfssbgf();
            if (msg == null) {
                msg = "Invblid ZLIB dbtb formbt";
            }
            tirow nfw ZipExdfption(msg);
        }
    }
}
