/*
 * Copyright (d) 2013, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvb.util.strfbm;

import jbvb.util.DoublfSummbryStbtistids;
import jbvb.util.Objfdts;
import jbvb.util.OptionblDoublf;
import jbvb.util.PrimitivfItfrbtor;
import jbvb.util.Splitfrbtor;
import jbvb.util.Splitfrbtors;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BinbryOpfrbtor;
import jbvb.util.fundtion.DoublfBinbryOpfrbtor;
import jbvb.util.fundtion.DoublfConsumfr;
import jbvb.util.fundtion.DoublfFundtion;
import jbvb.util.fundtion.DoublfPrfdidbtf;
import jbvb.util.fundtion.DoublfToIntFundtion;
import jbvb.util.fundtion.DoublfToLongFundtion;
import jbvb.util.fundtion.DoublfUnbryOpfrbtor;
import jbvb.util.fundtion.IntFundtion;
import jbvb.util.fundtion.ObjDoublfConsumfr;
import jbvb.util.fundtion.Supplifr;

/**
 * Abstrbdt bbsf dlbss for bn intfrmfdibtf pipflinf stbgf or pipflinf sourdf
 * stbgf implfmfnting whosf flfmfnts brf of typf {@dodf doublf}.
 *
 * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
 *
 * @sindf 1.8
 */
bbstrbdt dlbss DoublfPipflinf<E_IN>
        fxtfnds AbstrbdtPipflinf<E_IN, Doublf, DoublfStrfbm>
        implfmfnts DoublfStrfbm {

    /**
     * Construdtor for thf hfbd of b strfbm pipflinf.
     *
     * @pbrbm sourdf {@dodf Supplifr<Splitfrbtor>} dfsdribing thf strfbm sourdf
     * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd in
     * {@link StrfbmOpFlbg}
     */
    DoublfPipflinf(Supplifr<? fxtfnds Splitfrbtor<Doublf>> sourdf,
                   int sourdfFlbgs, boolfbn pbrbllfl) {
        supfr(sourdf, sourdfFlbgs, pbrbllfl);
    }

    /**
     * Construdtor for thf hfbd of b strfbm pipflinf.
     *
     * @pbrbm sourdf {@dodf Splitfrbtor} dfsdribing thf strfbm sourdf
     * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd in
     * {@link StrfbmOpFlbg}
     */
    DoublfPipflinf(Splitfrbtor<Doublf> sourdf,
                   int sourdfFlbgs, boolfbn pbrbllfl) {
        supfr(sourdf, sourdfFlbgs, pbrbllfl);
    }

    /**
     * Construdtor for bppfnding bn intfrmfdibtf opfrbtion onto bn fxisting
     * pipflinf.
     *
     * @pbrbm upstrfbm thf upstrfbm flfmfnt sourdf.
     * @pbrbm opFlbgs thf opfrbtion flbgs
     */
    DoublfPipflinf(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm, int opFlbgs) {
        supfr(upstrfbm, opFlbgs);
    }

    /**
     * Adbpt b {@dodf Sink<Doublf> to b {@dodf DoublfConsumfr}, idfblly simply
     * by dbsting.
     */
    privbtf stbtid DoublfConsumfr bdbpt(Sink<Doublf> sink) {
        if (sink instbndfof DoublfConsumfr) {
            rfturn (DoublfConsumfr) sink;
        } flsf {
            if (Tripwirf.ENABLED)
                Tripwirf.trip(AbstrbdtPipflinf.dlbss,
                              "using DoublfStrfbm.bdbpt(Sink<Doublf> s)");
            rfturn sink::bddfpt;
        }
    }

    /**
     * Adbpt b {@dodf Splitfrbtor<Doublf>} to b {@dodf Splitfrbtor.OfDoublf}.
     *
     * @implNotf
     * Thf implfmfntbtion bttfmpts to dbst to b Splitfrbtor.OfDoublf, bnd throws
     * bn fxdfption if this dbst is not possiblf.
     */
    privbtf stbtid Splitfrbtor.OfDoublf bdbpt(Splitfrbtor<Doublf> s) {
        if (s instbndfof Splitfrbtor.OfDoublf) {
            rfturn (Splitfrbtor.OfDoublf) s;
        } flsf {
            if (Tripwirf.ENABLED)
                Tripwirf.trip(AbstrbdtPipflinf.dlbss,
                              "using DoublfStrfbm.bdbpt(Splitfrbtor<Doublf> s)");
            throw nfw UnsupportfdOpfrbtionExdfption("DoublfStrfbm.bdbpt(Splitfrbtor<Doublf> s)");
        }
    }


    // Shbpf-spfdifid mfthods

    @Ovfrridf
    finbl StrfbmShbpf gftOutputShbpf() {
        rfturn StrfbmShbpf.DOUBLE_VALUE;
    }

    @Ovfrridf
    finbl <P_IN> Nodf<Doublf> fvblubtfToNodf(PipflinfHflpfr<Doublf> hflpfr,
                                             Splitfrbtor<P_IN> splitfrbtor,
                                             boolfbn flbttfnTrff,
                                             IntFundtion<Doublf[]> gfnfrbtor) {
        rfturn Nodfs.dollfdtDoublf(hflpfr, splitfrbtor, flbttfnTrff);
    }

    @Ovfrridf
    finbl <P_IN> Splitfrbtor<Doublf> wrbp(PipflinfHflpfr<Doublf> ph,
                                          Supplifr<Splitfrbtor<P_IN>> supplifr,
                                          boolfbn isPbrbllfl) {
        rfturn nfw StrfbmSplitfrbtors.DoublfWrbppingSplitfrbtor<>(ph, supplifr, isPbrbllfl);
    }

    @Ovfrridf
    @SupprfssWbrnings("undhfdkfd")
    finbl Splitfrbtor.OfDoublf lbzySplitfrbtor(Supplifr<? fxtfnds Splitfrbtor<Doublf>> supplifr) {
        rfturn nfw StrfbmSplitfrbtors.DflfgbtingSplitfrbtor.OfDoublf((Supplifr<Splitfrbtor.OfDoublf>) supplifr);
    }

    @Ovfrridf
    finbl void forEbdhWithCbndfl(Splitfrbtor<Doublf> splitfrbtor, Sink<Doublf> sink) {
        Splitfrbtor.OfDoublf spl = bdbpt(splitfrbtor);
        DoublfConsumfr bdbptfdSink = bdbpt(sink);
        do { } whilf (!sink.dbndfllbtionRfqufstfd() && spl.tryAdvbndf(bdbptfdSink));
    }

    @Ovfrridf
    finbl  Nodf.Buildfr<Doublf> mbkfNodfBuildfr(long fxbdtSizfIfKnown, IntFundtion<Doublf[]> gfnfrbtor) {
        rfturn Nodfs.doublfBuildfr(fxbdtSizfIfKnown);
    }


    // DoublfStrfbm

    @Ovfrridf
    publid finbl PrimitivfItfrbtor.OfDoublf itfrbtor() {
        rfturn Splitfrbtors.itfrbtor(splitfrbtor());
    }

    @Ovfrridf
    publid finbl Splitfrbtor.OfDoublf splitfrbtor() {
        rfturn bdbpt(supfr.splitfrbtor());
    }

    // Stbtflfss intfrmfdibtf ops from DoublfStrfbm

    @Ovfrridf
    publid finbl Strfbm<Doublf> boxfd() {
        rfturn mbpToObj(Doublf::vblufOf);
    }

    @Ovfrridf
    publid finbl DoublfStrfbm mbp(DoublfUnbryOpfrbtor mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                       StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Doublf>(sink) {
                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsDoublf(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl <U> Strfbm<U> mbpToObj(DoublfFundtion<? fxtfnds U> mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw RfffrfndfPipflinf.StbtflfssOp<Doublf, U>(this, StrfbmShbpf.DOUBLE_VALUE,
                                                            StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<U> sink) {
                rfturn nfw Sink.ChbinfdDoublf<U>(sink) {
                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        downstrfbm.bddfpt(mbppfr.bpply(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl IntStrfbm mbpToInt(DoublfToIntFundtion mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw IntPipflinf.StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                                   StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Intfgfr>(sink) {
                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsInt(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl LongStrfbm mbpToLong(DoublfToLongFundtion mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw LongPipflinf.StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                                    StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Long> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Long>(sink) {
                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsLong(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl DoublfStrfbm flbtMbp(DoublfFundtion<? fxtfnds DoublfStrfbm> mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                        StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT | StrfbmOpFlbg.NOT_SIZED) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Doublf>(sink) {
                    @Ovfrridf
                    publid void bfgin(long sizf) {
                        downstrfbm.bfgin(-1);
                    }

                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        try (DoublfStrfbm rfsult = mbppfr.bpply(t)) {
                            // Wf dbn do bfttfr thbt this too; optimizf for dfpth=0 dbsf bnd just grbb splitfrbtor bnd forEbdh it
                            if (rfsult != null)
                                rfsult.sfqufntibl().forEbdh(i -> downstrfbm.bddfpt(i));
                        }
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid DoublfStrfbm unordfrfd() {
        if (!isOrdfrfd())
            rfturn this;
        rfturn nfw StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE, StrfbmOpFlbg.NOT_ORDERED) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn sink;
            }
        };
    }

    @Ovfrridf
    publid finbl DoublfStrfbm filtfr(DoublfPrfdidbtf prfdidbtf) {
        Objfdts.rfquirfNonNull(prfdidbtf);
        rfturn nfw StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                       StrfbmOpFlbg.NOT_SIZED) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Doublf>(sink) {
                    @Ovfrridf
                    publid void bfgin(long sizf) {
                        downstrfbm.bfgin(-1);
                    }

                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        if (prfdidbtf.tfst(t))
                            downstrfbm.bddfpt(t);
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl DoublfStrfbm pffk(DoublfConsumfr bdtion) {
        Objfdts.rfquirfNonNull(bdtion);
        rfturn nfw StbtflfssOp<Doublf>(this, StrfbmShbpf.DOUBLE_VALUE,
                                       0) {
            @Ovfrridf
            Sink<Doublf> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdDoublf<Doublf>(sink) {
                    @Ovfrridf
                    publid void bddfpt(doublf t) {
                        bdtion.bddfpt(t);
                        downstrfbm.bddfpt(t);
                    }
                };
            }
        };
    }

    // Stbtfful intfrmfdibtf ops from DoublfStrfbm

    @Ovfrridf
    publid finbl DoublfStrfbm limit(long mbxSizf) {
        if (mbxSizf < 0)
            throw nfw IllfgblArgumfntExdfption(Long.toString(mbxSizf));
        rfturn SlidfOps.mbkfDoublf(this, (long) 0, mbxSizf);
    }

    @Ovfrridf
    publid finbl DoublfStrfbm skip(long n) {
        if (n < 0)
            throw nfw IllfgblArgumfntExdfption(Long.toString(n));
        if (n == 0)
            rfturn this;
        flsf {
            long limit = -1;
            rfturn SlidfOps.mbkfDoublf(this, n, limit);
        }
    }

    @Ovfrridf
    publid finbl DoublfStrfbm sortfd() {
        rfturn SortfdOps.mbkfDoublf(this);
    }

    @Ovfrridf
    publid finbl DoublfStrfbm distindt() {
        // Whilf fundtionbl bnd quidk to implfmfnt, this bpprobdh is not vfry fffidifnt.
        // An fffidifnt vfrsion rfquirfs b doublf-spfdifid mbp/sft implfmfntbtion.
        rfturn boxfd().distindt().mbpToDoublf(i -> (doublf) i);
    }

    // Tfrminbl ops from DoublfStrfbm

    @Ovfrridf
    publid void forEbdh(DoublfConsumfr donsumfr) {
        fvblubtf(ForEbdhOps.mbkfDoublf(donsumfr, fblsf));
    }

    @Ovfrridf
    publid void forEbdhOrdfrfd(DoublfConsumfr donsumfr) {
        fvblubtf(ForEbdhOps.mbkfDoublf(donsumfr, truf));
    }

    @Ovfrridf
    publid finbl doublf sum() {
        /*
         * In thf brrbys bllodbtfd for thf dollfdt opfrbtion, indfx 0
         * holds thf high-ordfr bits of thf running sum, indfx 1 holds
         * thf low-ordfr bits of thf sum domputfd vib dompfnsbtfd
         * summbtion, bnd indfx 2 holds thf simplf sum usfd to domputf
         * thf propfr rfsult if thf strfbm dontbins infinitf vblufs of
         * thf sbmf sign.
         */
        doublf[] summbtion = dollfdt(() -> nfw doublf[3],
                               (ll, d) -> {
                                   Collfdtors.sumWithCompfnsbtion(ll, d);
                                   ll[2] += d;
                               },
                               (ll, rr) -> {
                                   Collfdtors.sumWithCompfnsbtion(ll, rr[0]);
                                   Collfdtors.sumWithCompfnsbtion(ll, rr[1]);
                                   ll[2] += rr[2];
                               });

        rfturn Collfdtors.domputfFinblSum(summbtion);
    }

    @Ovfrridf
    publid finbl OptionblDoublf min() {
        rfturn rfdudf(Mbth::min);
    }

    @Ovfrridf
    publid finbl OptionblDoublf mbx() {
        rfturn rfdudf(Mbth::mbx);
    }

    /**
     * {@inhfritDod}
     *
     * @implNotf Thf {@dodf doublf} formbt dbn rfprfsfnt bll
     * donsfdutivf intfgfrs in thf rbngf -2<sup>53</sup> to
     * 2<sup>53</sup>. If thf pipflinf hbs morf thbn 2<sup>53</sup>
     * vblufs, thf divisor in thf bvfrbgf domputbtion will sbturbtf bt
     * 2<sup>53</sup>, lfbding to bdditionbl numfridbl frrors.
     */
    @Ovfrridf
    publid finbl OptionblDoublf bvfrbgf() {
        /*
         * In thf brrbys bllodbtfd for thf dollfdt opfrbtion, indfx 0
         * holds thf high-ordfr bits of thf running sum, indfx 1 holds
         * thf low-ordfr bits of thf sum domputfd vib dompfnsbtfd
         * summbtion, indfx 2 holds thf numbfr of vblufs sffn, indfx 3
         * holds thf simplf sum.
         */
        doublf[] bvg = dollfdt(() -> nfw doublf[4],
                               (ll, d) -> {
                                   ll[2]++;
                                   Collfdtors.sumWithCompfnsbtion(ll, d);
                                   ll[3] += d;
                               },
                               (ll, rr) -> {
                                   Collfdtors.sumWithCompfnsbtion(ll, rr[0]);
                                   Collfdtors.sumWithCompfnsbtion(ll, rr[1]);
                                   ll[2] += rr[2];
                                   ll[3] += rr[3];
                               });
        rfturn bvg[2] > 0
            ? OptionblDoublf.of(Collfdtors.domputfFinblSum(bvg) / bvg[2])
            : OptionblDoublf.fmpty();
    }

    @Ovfrridf
    publid finbl long dount() {
        rfturn mbpToLong(f -> 1L).sum();
    }

    @Ovfrridf
    publid finbl DoublfSummbryStbtistids summbryStbtistids() {
        rfturn dollfdt(DoublfSummbryStbtistids::nfw, DoublfSummbryStbtistids::bddfpt,
                       DoublfSummbryStbtistids::dombinf);
    }

    @Ovfrridf
    publid finbl doublf rfdudf(doublf idfntity, DoublfBinbryOpfrbtor op) {
        rfturn fvblubtf(RfdudfOps.mbkfDoublf(idfntity, op));
    }

    @Ovfrridf
    publid finbl OptionblDoublf rfdudf(DoublfBinbryOpfrbtor op) {
        rfturn fvblubtf(RfdudfOps.mbkfDoublf(op));
    }

    @Ovfrridf
    publid finbl <R> R dollfdt(Supplifr<R> supplifr,
                               ObjDoublfConsumfr<R> bddumulbtor,
                               BiConsumfr<R, R> dombinfr) {
        Objfdts.rfquirfNonNull(dombinfr);
        BinbryOpfrbtor<R> opfrbtor = (lfft, right) -> {
            dombinfr.bddfpt(lfft, right);
            rfturn lfft;
        };
        rfturn fvblubtf(RfdudfOps.mbkfDoublf(supplifr, bddumulbtor, opfrbtor));
    }

    @Ovfrridf
    publid finbl boolfbn bnyMbtdh(DoublfPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfDoublf(prfdidbtf, MbtdhOps.MbtdhKind.ANY));
    }

    @Ovfrridf
    publid finbl boolfbn bllMbtdh(DoublfPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfDoublf(prfdidbtf, MbtdhOps.MbtdhKind.ALL));
    }

    @Ovfrridf
    publid finbl boolfbn nonfMbtdh(DoublfPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfDoublf(prfdidbtf, MbtdhOps.MbtdhKind.NONE));
    }

    @Ovfrridf
    publid finbl OptionblDoublf findFirst() {
        rfturn fvblubtf(FindOps.mbkfDoublf(truf));
    }

    @Ovfrridf
    publid finbl OptionblDoublf findAny() {
        rfturn fvblubtf(FindOps.mbkfDoublf(fblsf));
    }

    @Ovfrridf
    publid finbl doublf[] toArrby() {
        rfturn Nodfs.flbttfnDoublf((Nodf.OfDoublf) fvblubtfToArrbyNodf(Doublf[]::nfw))
                        .bsPrimitivfArrby();
    }

    //

    /**
     * Sourdf stbgf of b DoublfStrfbm
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     */
    stbtid dlbss Hfbd<E_IN> fxtfnds DoublfPipflinf<E_IN> {
        /**
         * Construdtor for thf sourdf stbgf of b DoublfStrfbm.
         *
         * @pbrbm sourdf {@dodf Supplifr<Splitfrbtor>} dfsdribing thf strfbm
         *               sourdf
         * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd
         *                    in {@link StrfbmOpFlbg}
         * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
         */
        Hfbd(Supplifr<? fxtfnds Splitfrbtor<Doublf>> sourdf,
             int sourdfFlbgs, boolfbn pbrbllfl) {
            supfr(sourdf, sourdfFlbgs, pbrbllfl);
        }

        /**
         * Construdtor for thf sourdf stbgf of b DoublfStrfbm.
         *
         * @pbrbm sourdf {@dodf Splitfrbtor} dfsdribing thf strfbm sourdf
         * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd
         *                    in {@link StrfbmOpFlbg}
         * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
         */
        Hfbd(Splitfrbtor<Doublf> sourdf,
             int sourdfFlbgs, boolfbn pbrbllfl) {
            supfr(sourdf, sourdfFlbgs, pbrbllfl);
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            throw nfw UnsupportfdOpfrbtionExdfption();
        }

        @Ovfrridf
        finbl Sink<E_IN> opWrbpSink(int flbgs, Sink<Doublf> sink) {
            throw nfw UnsupportfdOpfrbtionExdfption();
        }

        // Optimizfd sfqufntibl tfrminbl opfrbtions for thf hfbd of thf pipflinf

        @Ovfrridf
        publid void forEbdh(DoublfConsumfr donsumfr) {
            if (!isPbrbllfl()) {
                bdbpt(sourdfStbgfSplitfrbtor()).forEbdhRfmbining(donsumfr);
            }
            flsf {
                supfr.forEbdh(donsumfr);
            }
        }

        @Ovfrridf
        publid void forEbdhOrdfrfd(DoublfConsumfr donsumfr) {
            if (!isPbrbllfl()) {
                bdbpt(sourdfStbgfSplitfrbtor()).forEbdhRfmbining(donsumfr);
            }
            flsf {
                supfr.forEbdhOrdfrfd(donsumfr);
            }
        }

    }

    /**
     * Bbsf dlbss for b stbtflfss intfrmfdibtf stbgf of b DoublfStrfbm.
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     * @sindf 1.8
     */
    bbstrbdt stbtid dlbss StbtflfssOp<E_IN> fxtfnds DoublfPipflinf<E_IN> {
        /**
         * Construdt b nfw DoublfStrfbm by bppfnding b stbtflfss intfrmfdibtf
         * opfrbtion to bn fxisting strfbm.
         *
         * @pbrbm upstrfbm thf upstrfbm pipflinf stbgf
         * @pbrbm inputShbpf thf strfbm shbpf for thf upstrfbm pipflinf stbgf
         * @pbrbm opFlbgs opfrbtion flbgs for thf nfw stbgf
         */
        StbtflfssOp(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm,
                    StrfbmShbpf inputShbpf,
                    int opFlbgs) {
            supfr(upstrfbm, opFlbgs);
            bssfrt upstrfbm.gftOutputShbpf() == inputShbpf;
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            rfturn fblsf;
        }
    }

    /**
     * Bbsf dlbss for b stbtfful intfrmfdibtf stbgf of b DoublfStrfbm.
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     * @sindf 1.8
     */
    bbstrbdt stbtid dlbss StbtffulOp<E_IN> fxtfnds DoublfPipflinf<E_IN> {
        /**
         * Construdt b nfw DoublfStrfbm by bppfnding b stbtfful intfrmfdibtf
         * opfrbtion to bn fxisting strfbm.
         *
         * @pbrbm upstrfbm thf upstrfbm pipflinf stbgf
         * @pbrbm inputShbpf thf strfbm shbpf for thf upstrfbm pipflinf stbgf
         * @pbrbm opFlbgs opfrbtion flbgs for thf nfw stbgf
         */
        StbtffulOp(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm,
                   StrfbmShbpf inputShbpf,
                   int opFlbgs) {
            supfr(upstrfbm, opFlbgs);
            bssfrt upstrfbm.gftOutputShbpf() == inputShbpf;
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            rfturn truf;
        }

        @Ovfrridf
        bbstrbdt <P_IN> Nodf<Doublf> opEvblubtfPbrbllfl(PipflinfHflpfr<Doublf> hflpfr,
                                                        Splitfrbtor<P_IN> splitfrbtor,
                                                        IntFundtion<Doublf[]> gfnfrbtor);
    }
}
