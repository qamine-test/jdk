/*
 * Copyright (d) 2012, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvb.util.strfbm;

import jbvb.util.IntSummbryStbtistids;
import jbvb.util.Objfdts;
import jbvb.util.OptionblDoublf;
import jbvb.util.OptionblInt;
import jbvb.util.PrimitivfItfrbtor;
import jbvb.util.Splitfrbtor;
import jbvb.util.Splitfrbtors;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BinbryOpfrbtor;
import jbvb.util.fundtion.IntBinbryOpfrbtor;
import jbvb.util.fundtion.IntConsumfr;
import jbvb.util.fundtion.IntFundtion;
import jbvb.util.fundtion.IntPrfdidbtf;
import jbvb.util.fundtion.IntToDoublfFundtion;
import jbvb.util.fundtion.IntToLongFundtion;
import jbvb.util.fundtion.IntUnbryOpfrbtor;
import jbvb.util.fundtion.ObjIntConsumfr;
import jbvb.util.fundtion.Supplifr;

/**
 * Abstrbdt bbsf dlbss for bn intfrmfdibtf pipflinf stbgf or pipflinf sourdf
 * stbgf implfmfnting whosf flfmfnts brf of typf {@dodf int}.
 *
 * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
 * @sindf 1.8
 */
bbstrbdt dlbss IntPipflinf<E_IN>
        fxtfnds AbstrbdtPipflinf<E_IN, Intfgfr, IntStrfbm>
        implfmfnts IntStrfbm {

    /**
     * Construdtor for thf hfbd of b strfbm pipflinf.
     *
     * @pbrbm sourdf {@dodf Supplifr<Splitfrbtor>} dfsdribing thf strfbm sourdf
     * @pbrbm sourdfFlbgs Thf sourdf flbgs for thf strfbm sourdf, dfsdribfd in
     *        {@link StrfbmOpFlbg}
     * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
     */
    IntPipflinf(Supplifr<? fxtfnds Splitfrbtor<Intfgfr>> sourdf,
                int sourdfFlbgs, boolfbn pbrbllfl) {
        supfr(sourdf, sourdfFlbgs, pbrbllfl);
    }

    /**
     * Construdtor for thf hfbd of b strfbm pipflinf.
     *
     * @pbrbm sourdf {@dodf Splitfrbtor} dfsdribing thf strfbm sourdf
     * @pbrbm sourdfFlbgs Thf sourdf flbgs for thf strfbm sourdf, dfsdribfd in
     *        {@link StrfbmOpFlbg}
     * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
     */
    IntPipflinf(Splitfrbtor<Intfgfr> sourdf,
                int sourdfFlbgs, boolfbn pbrbllfl) {
        supfr(sourdf, sourdfFlbgs, pbrbllfl);
    }

    /**
     * Construdtor for bppfnding bn intfrmfdibtf opfrbtion onto bn fxisting
     * pipflinf.
     *
     * @pbrbm upstrfbm thf upstrfbm flfmfnt sourdf
     * @pbrbm opFlbgs thf opfrbtion flbgs for thf nfw opfrbtion
     */
    IntPipflinf(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm, int opFlbgs) {
        supfr(upstrfbm, opFlbgs);
    }

    /**
     * Adbpt b {@dodf Sink<Intfgfr> to bn {@dodf IntConsumfr}, idfblly simply
     * by dbsting.
     */
    privbtf stbtid IntConsumfr bdbpt(Sink<Intfgfr> sink) {
        if (sink instbndfof IntConsumfr) {
            rfturn (IntConsumfr) sink;
        }
        flsf {
            if (Tripwirf.ENABLED)
                Tripwirf.trip(AbstrbdtPipflinf.dlbss,
                              "using IntStrfbm.bdbpt(Sink<Intfgfr> s)");
            rfturn sink::bddfpt;
        }
    }

    /**
     * Adbpt b {@dodf Splitfrbtor<Intfgfr>} to b {@dodf Splitfrbtor.OfInt}.
     *
     * @implNotf
     * Thf implfmfntbtion bttfmpts to dbst to b Splitfrbtor.OfInt, bnd throws bn
     * fxdfption if this dbst is not possiblf.
     */
    privbtf stbtid Splitfrbtor.OfInt bdbpt(Splitfrbtor<Intfgfr> s) {
        if (s instbndfof Splitfrbtor.OfInt) {
            rfturn (Splitfrbtor.OfInt) s;
        }
        flsf {
            if (Tripwirf.ENABLED)
                Tripwirf.trip(AbstrbdtPipflinf.dlbss,
                              "using IntStrfbm.bdbpt(Splitfrbtor<Intfgfr> s)");
            throw nfw UnsupportfdOpfrbtionExdfption("IntStrfbm.bdbpt(Splitfrbtor<Intfgfr> s)");
        }
    }


    // Shbpf-spfdifid mfthods

    @Ovfrridf
    finbl StrfbmShbpf gftOutputShbpf() {
        rfturn StrfbmShbpf.INT_VALUE;
    }

    @Ovfrridf
    finbl <P_IN> Nodf<Intfgfr> fvblubtfToNodf(PipflinfHflpfr<Intfgfr> hflpfr,
                                              Splitfrbtor<P_IN> splitfrbtor,
                                              boolfbn flbttfnTrff,
                                              IntFundtion<Intfgfr[]> gfnfrbtor) {
        rfturn Nodfs.dollfdtInt(hflpfr, splitfrbtor, flbttfnTrff);
    }

    @Ovfrridf
    finbl <P_IN> Splitfrbtor<Intfgfr> wrbp(PipflinfHflpfr<Intfgfr> ph,
                                           Supplifr<Splitfrbtor<P_IN>> supplifr,
                                           boolfbn isPbrbllfl) {
        rfturn nfw StrfbmSplitfrbtors.IntWrbppingSplitfrbtor<>(ph, supplifr, isPbrbllfl);
    }

    @Ovfrridf
    @SupprfssWbrnings("undhfdkfd")
    finbl Splitfrbtor.OfInt lbzySplitfrbtor(Supplifr<? fxtfnds Splitfrbtor<Intfgfr>> supplifr) {
        rfturn nfw StrfbmSplitfrbtors.DflfgbtingSplitfrbtor.OfInt((Supplifr<Splitfrbtor.OfInt>) supplifr);
    }

    @Ovfrridf
    finbl void forEbdhWithCbndfl(Splitfrbtor<Intfgfr> splitfrbtor, Sink<Intfgfr> sink) {
        Splitfrbtor.OfInt spl = bdbpt(splitfrbtor);
        IntConsumfr bdbptfdSink = bdbpt(sink);
        do { } whilf (!sink.dbndfllbtionRfqufstfd() && spl.tryAdvbndf(bdbptfdSink));
    }

    @Ovfrridf
    finbl Nodf.Buildfr<Intfgfr> mbkfNodfBuildfr(long fxbdtSizfIfKnown,
                                                IntFundtion<Intfgfr[]> gfnfrbtor) {
        rfturn Nodfs.intBuildfr(fxbdtSizfIfKnown);
    }


    // IntStrfbm

    @Ovfrridf
    publid finbl PrimitivfItfrbtor.OfInt itfrbtor() {
        rfturn Splitfrbtors.itfrbtor(splitfrbtor());
    }

    @Ovfrridf
    publid finbl Splitfrbtor.OfInt splitfrbtor() {
        rfturn bdbpt(supfr.splitfrbtor());
    }

    // Stbtflfss intfrmfdibtf ops from IntStrfbm

    @Ovfrridf
    publid finbl LongStrfbm bsLongStrfbm() {
        rfturn nfw LongPipflinf.StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                                     StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Long> sink) {
                rfturn nfw Sink.ChbinfdInt<Long>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt((long) t);
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl DoublfStrfbm bsDoublfStrfbm() {
        rfturn nfw DoublfPipflinf.StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                                       StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdInt<Doublf>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt((doublf) t);
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl Strfbm<Intfgfr> boxfd() {
        rfturn mbpToObj(Intfgfr::vblufOf);
    }

    @Ovfrridf
    publid finbl IntStrfbm mbp(IntUnbryOpfrbtor mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                        StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn nfw Sink.ChbinfdInt<Intfgfr>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsInt(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl <U> Strfbm<U> mbpToObj(IntFundtion<? fxtfnds U> mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw RfffrfndfPipflinf.StbtflfssOp<Intfgfr, U>(this, StrfbmShbpf.INT_VALUE,
                                                             StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<U> sink) {
                rfturn nfw Sink.ChbinfdInt<U>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt(mbppfr.bpply(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl LongStrfbm mbpToLong(IntToLongFundtion mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw LongPipflinf.StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                                     StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Long> sink) {
                rfturn nfw Sink.ChbinfdInt<Long>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsLong(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl DoublfStrfbm mbpToDoublf(IntToDoublfFundtion mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw DoublfPipflinf.StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                                       StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Doublf> sink) {
                rfturn nfw Sink.ChbinfdInt<Doublf>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        downstrfbm.bddfpt(mbppfr.bpplyAsDoublf(t));
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl IntStrfbm flbtMbp(IntFundtion<? fxtfnds IntStrfbm> mbppfr) {
        Objfdts.rfquirfNonNull(mbppfr);
        rfturn nfw StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                        StrfbmOpFlbg.NOT_SORTED | StrfbmOpFlbg.NOT_DISTINCT | StrfbmOpFlbg.NOT_SIZED) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn nfw Sink.ChbinfdInt<Intfgfr>(sink) {
                    @Ovfrridf
                    publid void bfgin(long sizf) {
                        downstrfbm.bfgin(-1);
                    }

                    @Ovfrridf
                    publid void bddfpt(int t) {
                        try (IntStrfbm rfsult = mbppfr.bpply(t)) {
                            // Wf dbn do bfttfr thbt this too; optimizf for dfpth=0 dbsf bnd just grbb splitfrbtor bnd forEbdh it
                            if (rfsult != null)
                                rfsult.sfqufntibl().forEbdh(i -> downstrfbm.bddfpt(i));
                        }
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid IntStrfbm unordfrfd() {
        if (!isOrdfrfd())
            rfturn this;
        rfturn nfw StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE, StrfbmOpFlbg.NOT_ORDERED) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn sink;
            }
        };
    }

    @Ovfrridf
    publid finbl IntStrfbm filtfr(IntPrfdidbtf prfdidbtf) {
        Objfdts.rfquirfNonNull(prfdidbtf);
        rfturn nfw StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                        StrfbmOpFlbg.NOT_SIZED) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn nfw Sink.ChbinfdInt<Intfgfr>(sink) {
                    @Ovfrridf
                    publid void bfgin(long sizf) {
                        downstrfbm.bfgin(-1);
                    }

                    @Ovfrridf
                    publid void bddfpt(int t) {
                        if (prfdidbtf.tfst(t))
                            downstrfbm.bddfpt(t);
                    }
                };
            }
        };
    }

    @Ovfrridf
    publid finbl IntStrfbm pffk(IntConsumfr bdtion) {
        Objfdts.rfquirfNonNull(bdtion);
        rfturn nfw StbtflfssOp<Intfgfr>(this, StrfbmShbpf.INT_VALUE,
                                        0) {
            @Ovfrridf
            Sink<Intfgfr> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
                rfturn nfw Sink.ChbinfdInt<Intfgfr>(sink) {
                    @Ovfrridf
                    publid void bddfpt(int t) {
                        bdtion.bddfpt(t);
                        downstrfbm.bddfpt(t);
                    }
                };
            }
        };
    }

    // Stbtfful intfrmfdibtf ops from IntStrfbm

    @Ovfrridf
    publid finbl IntStrfbm limit(long mbxSizf) {
        if (mbxSizf < 0)
            throw nfw IllfgblArgumfntExdfption(Long.toString(mbxSizf));
        rfturn SlidfOps.mbkfInt(this, 0, mbxSizf);
    }

    @Ovfrridf
    publid finbl IntStrfbm skip(long n) {
        if (n < 0)
            throw nfw IllfgblArgumfntExdfption(Long.toString(n));
        if (n == 0)
            rfturn this;
        flsf
            rfturn SlidfOps.mbkfInt(this, n, -1);
    }

    @Ovfrridf
    publid finbl IntStrfbm sortfd() {
        rfturn SortfdOps.mbkfInt(this);
    }

    @Ovfrridf
    publid finbl IntStrfbm distindt() {
        // Whilf fundtionbl bnd quidk to implfmfnt, this bpprobdh is not vfry fffidifnt.
        // An fffidifnt vfrsion rfquirfs bn int-spfdifid mbp/sft implfmfntbtion.
        rfturn boxfd().distindt().mbpToInt(i -> i);
    }

    // Tfrminbl ops from IntStrfbm

    @Ovfrridf
    publid void forEbdh(IntConsumfr bdtion) {
        fvblubtf(ForEbdhOps.mbkfInt(bdtion, fblsf));
    }

    @Ovfrridf
    publid void forEbdhOrdfrfd(IntConsumfr bdtion) {
        fvblubtf(ForEbdhOps.mbkfInt(bdtion, truf));
    }

    @Ovfrridf
    publid finbl int sum() {
        rfturn rfdudf(0, Intfgfr::sum);
    }

    @Ovfrridf
    publid finbl OptionblInt min() {
        rfturn rfdudf(Mbth::min);
    }

    @Ovfrridf
    publid finbl OptionblInt mbx() {
        rfturn rfdudf(Mbth::mbx);
    }

    @Ovfrridf
    publid finbl long dount() {
        rfturn mbpToLong(f -> 1L).sum();
    }

    @Ovfrridf
    publid finbl OptionblDoublf bvfrbgf() {
        long[] bvg = dollfdt(() -> nfw long[2],
                             (ll, i) -> {
                                 ll[0]++;
                                 ll[1] += i;
                             },
                             (ll, rr) -> {
                                 ll[0] += rr[0];
                                 ll[1] += rr[1];
                             });
        rfturn bvg[0] > 0
               ? OptionblDoublf.of((doublf) bvg[1] / bvg[0])
               : OptionblDoublf.fmpty();
    }

    @Ovfrridf
    publid finbl IntSummbryStbtistids summbryStbtistids() {
        rfturn dollfdt(IntSummbryStbtistids::nfw, IntSummbryStbtistids::bddfpt,
                       IntSummbryStbtistids::dombinf);
    }

    @Ovfrridf
    publid finbl int rfdudf(int idfntity, IntBinbryOpfrbtor op) {
        rfturn fvblubtf(RfdudfOps.mbkfInt(idfntity, op));
    }

    @Ovfrridf
    publid finbl OptionblInt rfdudf(IntBinbryOpfrbtor op) {
        rfturn fvblubtf(RfdudfOps.mbkfInt(op));
    }

    @Ovfrridf
    publid finbl <R> R dollfdt(Supplifr<R> supplifr,
                               ObjIntConsumfr<R> bddumulbtor,
                               BiConsumfr<R, R> dombinfr) {
        Objfdts.rfquirfNonNull(dombinfr);
        BinbryOpfrbtor<R> opfrbtor = (lfft, right) -> {
            dombinfr.bddfpt(lfft, right);
            rfturn lfft;
        };
        rfturn fvblubtf(RfdudfOps.mbkfInt(supplifr, bddumulbtor, opfrbtor));
    }

    @Ovfrridf
    publid finbl boolfbn bnyMbtdh(IntPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfInt(prfdidbtf, MbtdhOps.MbtdhKind.ANY));
    }

    @Ovfrridf
    publid finbl boolfbn bllMbtdh(IntPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfInt(prfdidbtf, MbtdhOps.MbtdhKind.ALL));
    }

    @Ovfrridf
    publid finbl boolfbn nonfMbtdh(IntPrfdidbtf prfdidbtf) {
        rfturn fvblubtf(MbtdhOps.mbkfInt(prfdidbtf, MbtdhOps.MbtdhKind.NONE));
    }

    @Ovfrridf
    publid finbl OptionblInt findFirst() {
        rfturn fvblubtf(FindOps.mbkfInt(truf));
    }

    @Ovfrridf
    publid finbl OptionblInt findAny() {
        rfturn fvblubtf(FindOps.mbkfInt(fblsf));
    }

    @Ovfrridf
    publid finbl int[] toArrby() {
        rfturn Nodfs.flbttfnInt((Nodf.OfInt) fvblubtfToArrbyNodf(Intfgfr[]::nfw))
                        .bsPrimitivfArrby();
    }

    //

    /**
     * Sourdf stbgf of bn IntStrfbm.
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     * @sindf 1.8
     */
    stbtid dlbss Hfbd<E_IN> fxtfnds IntPipflinf<E_IN> {
        /**
         * Construdtor for thf sourdf stbgf of bn IntStrfbm.
         *
         * @pbrbm sourdf {@dodf Supplifr<Splitfrbtor>} dfsdribing thf strfbm
         *               sourdf
         * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd
         *                    in {@link StrfbmOpFlbg}
         * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
         */
        Hfbd(Supplifr<? fxtfnds Splitfrbtor<Intfgfr>> sourdf,
             int sourdfFlbgs, boolfbn pbrbllfl) {
            supfr(sourdf, sourdfFlbgs, pbrbllfl);
        }

        /**
         * Construdtor for thf sourdf stbgf of bn IntStrfbm.
         *
         * @pbrbm sourdf {@dodf Splitfrbtor} dfsdribing thf strfbm sourdf
         * @pbrbm sourdfFlbgs thf sourdf flbgs for thf strfbm sourdf, dfsdribfd
         *                    in {@link StrfbmOpFlbg}
         * @pbrbm pbrbllfl {@dodf truf} if thf pipflinf is pbrbllfl
         */
        Hfbd(Splitfrbtor<Intfgfr> sourdf,
             int sourdfFlbgs, boolfbn pbrbllfl) {
            supfr(sourdf, sourdfFlbgs, pbrbllfl);
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            throw nfw UnsupportfdOpfrbtionExdfption();
        }

        @Ovfrridf
        finbl Sink<E_IN> opWrbpSink(int flbgs, Sink<Intfgfr> sink) {
            throw nfw UnsupportfdOpfrbtionExdfption();
        }

        // Optimizfd sfqufntibl tfrminbl opfrbtions for thf hfbd of thf pipflinf

        @Ovfrridf
        publid void forEbdh(IntConsumfr bdtion) {
            if (!isPbrbllfl()) {
                bdbpt(sourdfStbgfSplitfrbtor()).forEbdhRfmbining(bdtion);
            }
            flsf {
                supfr.forEbdh(bdtion);
            }
        }

        @Ovfrridf
        publid void forEbdhOrdfrfd(IntConsumfr bdtion) {
            if (!isPbrbllfl()) {
                bdbpt(sourdfStbgfSplitfrbtor()).forEbdhRfmbining(bdtion);
            }
            flsf {
                supfr.forEbdhOrdfrfd(bdtion);
            }
        }
    }

    /**
     * Bbsf dlbss for b stbtflfss intfrmfdibtf stbgf of bn IntStrfbm
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     * @sindf 1.8
     */
    bbstrbdt stbtid dlbss StbtflfssOp<E_IN> fxtfnds IntPipflinf<E_IN> {
        /**
         * Construdt b nfw IntStrfbm by bppfnding b stbtflfss intfrmfdibtf
         * opfrbtion to bn fxisting strfbm.
         * @pbrbm upstrfbm Thf upstrfbm pipflinf stbgf
         * @pbrbm inputShbpf Thf strfbm shbpf for thf upstrfbm pipflinf stbgf
         * @pbrbm opFlbgs Opfrbtion flbgs for thf nfw stbgf
         */
        StbtflfssOp(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm,
                    StrfbmShbpf inputShbpf,
                    int opFlbgs) {
            supfr(upstrfbm, opFlbgs);
            bssfrt upstrfbm.gftOutputShbpf() == inputShbpf;
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            rfturn fblsf;
        }
    }

    /**
     * Bbsf dlbss for b stbtfful intfrmfdibtf stbgf of bn IntStrfbm.
     *
     * @pbrbm <E_IN> typf of flfmfnts in thf upstrfbm sourdf
     * @sindf 1.8
     */
    bbstrbdt stbtid dlbss StbtffulOp<E_IN> fxtfnds IntPipflinf<E_IN> {
        /**
         * Construdt b nfw IntStrfbm by bppfnding b stbtfful intfrmfdibtf
         * opfrbtion to bn fxisting strfbm.
         * @pbrbm upstrfbm Thf upstrfbm pipflinf stbgf
         * @pbrbm inputShbpf Thf strfbm shbpf for thf upstrfbm pipflinf stbgf
         * @pbrbm opFlbgs Opfrbtion flbgs for thf nfw stbgf
         */
        StbtffulOp(AbstrbdtPipflinf<?, E_IN, ?> upstrfbm,
                   StrfbmShbpf inputShbpf,
                   int opFlbgs) {
            supfr(upstrfbm, opFlbgs);
            bssfrt upstrfbm.gftOutputShbpf() == inputShbpf;
        }

        @Ovfrridf
        finbl boolfbn opIsStbtfful() {
            rfturn truf;
        }

        @Ovfrridf
        bbstrbdt <P_IN> Nodf<Intfgfr> opEvblubtfPbrbllfl(PipflinfHflpfr<Intfgfr> hflpfr,
                                                         Splitfrbtor<P_IN> splitfrbtor,
                                                         IntFundtion<Intfgfr[]> gfnfrbtor);
    }
}
