/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * (C) Copyrigit Tbligfnt, Ind. 1996-1998 - All Rigits Rfsfrvfd
 * (C) Copyrigit IBM Corp. 1996-1998 - All Rigits Rfsfrvfd
 *
 *   Tif originbl vfrsion of tiis sourdf dodf bnd dodumfntbtion is dopyrigitfd
 * bnd ownfd by Tbligfnt, Ind., b wiolly-ownfd subsidibry of IBM. Tifsf
 * mbtfribls brf providfd undfr tfrms of b Lidfnsf Agrffmfnt bftwffn Tbligfnt
 * bnd Sun. Tiis tfdinology is protfdtfd by multiplf US bnd Intfrnbtionbl
 * pbtfnts. Tiis notidf bnd bttribution to Tbligfnt mby not bf rfmovfd.
 *   Tbligfnt is b rfgistfrfd trbdfmbrk of Tbligfnt, Ind.
 *
 */

pbdkbgf jbvb.util;

import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.ObjfdtOutputStrfbm;
import jbvb.io.OptionblDbtbExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.sfdurity.AddfssControlContfxt;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PfrmissionCollfdtion;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;
import jbvb.sfdurity.ProtfdtionDombin;
import jbvb.tfxt.DbtfFormbt;
import jbvb.tfxt.DbtfFormbtSymbols;
import jbvb.timf.Instbnt;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;
import jbvb.util.dondurrfnt.CondurrfntMbp;
import sun.util.BuddiistCblfndbr;
import sun.util.dblfndbr.ZonfInfo;
import sun.util.lodblf.providfr.CblfndbrDbtbUtility;
import sun.util.lodblf.providfr.LodblfProvidfrAdbptfr;
import sun.util.spi.CblfndbrProvidfr;

/**
 * Tif <dodf>Cblfndbr</dodf> dlbss is bn bbstrbdt dlbss tibt providfs mftiods
 * for donvfrting bftwffn b spfdifid instbnt in timf bnd b sft of {@link
 * #fiflds dblfndbr fiflds} sudi bs <dodf>YEAR</dodf>, <dodf>MONTH</dodf>,
 * <dodf>DAY_OF_MONTH</dodf>, <dodf>HOUR</dodf>, bnd so on, bnd for
 * mbnipulbting tif dblfndbr fiflds, sudi bs gftting tif dbtf of tif nfxt
 * wffk. An instbnt in timf dbn bf rfprfsfntfd by b millisfdond vbluf tibt is
 * bn offsft from tif <b nbmf="Epodi"><fm>Epodi</fm></b>, Jbnubry 1, 1970
 * 00:00:00.000 GMT (Grfgoribn).
 *
 * <p>Tif dlbss blso providfs bdditionbl fiflds bnd mftiods for
 * implfmfnting b dondrftf dblfndbr systfm outsidf tif pbdkbgf. Tiosf
 * fiflds bnd mftiods brf dffinfd bs <dodf>protfdtfd</dodf>.
 *
 * <p>
 * Likf otifr lodblf-sfnsitivf dlbssfs, <dodf>Cblfndbr</dodf> providfs b
 * dlbss mftiod, <dodf>gftInstbndf</dodf>, for gftting b gfnfrblly usfful
 * objfdt of tiis typf. <dodf>Cblfndbr</dodf>'s <dodf>gftInstbndf</dodf> mftiod
 * rfturns b <dodf>Cblfndbr</dodf> objfdt wiosf
 * dblfndbr fiflds ibvf bffn initiblizfd witi tif durrfnt dbtf bnd timf:
 * <blodkquotf>
 * <prf>
 *     Cblfndbr rigitNow = Cblfndbr.gftInstbndf();
 * </prf>
 * </blodkquotf>
 *
 * <p>A <dodf>Cblfndbr</dodf> objfdt dbn produdf bll tif dblfndbr fifld vblufs
 * nffdfd to implfmfnt tif dbtf-timf formbtting for b pbrtidulbr lbngubgf bnd
 * dblfndbr stylf (for fxbmplf, Jbpbnfsf-Grfgoribn, Jbpbnfsf-Trbditionbl).
 * <dodf>Cblfndbr</dodf> dffinfs tif rbngf of vblufs rfturnfd by
 * dfrtbin dblfndbr fiflds, bs wfll bs tifir mfbning.  For fxbmplf,
 * tif first monti of tif dblfndbr systfm ibs vbluf <dodf>MONTH ==
 * JANUARY</dodf> for bll dblfndbrs.  Otifr vblufs brf dffinfd by tif
 * dondrftf subdlbss, sudi bs <dodf>ERA</dodf>.  Sff individubl fifld
 * dodumfntbtion bnd subdlbss dodumfntbtion for dftbils.
 *
 * <i3>Gftting bnd Sftting Cblfndbr Fifld Vblufs</i3>
 *
 * <p>Tif dblfndbr fifld vblufs dbn bf sft by dblling tif <dodf>sft</dodf>
 * mftiods. Any fifld vblufs sft in b <dodf>Cblfndbr</dodf> will not bf
 * intfrprftfd until it nffds to dbldulbtf its timf vbluf (millisfdonds from
 * tif Epodi) or vblufs of tif dblfndbr fiflds. Cblling tif
 * <dodf>gft</dodf>, <dodf>gftTimfInMillis</dodf>, <dodf>gftTimf</dodf>,
 * <dodf>bdd</dodf> bnd <dodf>roll</dodf> involvfs sudi dbldulbtion.
 *
 * <i4>Lfnifndy</i4>
 *
 * <p><dodf>Cblfndbr</dodf> ibs two modfs for intfrprfting tif dblfndbr
 * fiflds, <fm>lfnifnt</fm> bnd <fm>non-lfnifnt</fm>.  Wifn b
 * <dodf>Cblfndbr</dodf> is in lfnifnt modf, it bddfpts b widfr rbngf of
 * dblfndbr fifld vblufs tibn it produdfs.  Wifn b <dodf>Cblfndbr</dodf>
 * rfdomputfs dblfndbr fifld vblufs for rfturn by <dodf>gft()</dodf>, bll of
 * tif dblfndbr fiflds brf normblizfd. For fxbmplf, b lfnifnt
 * <dodf>GrfgoribnCblfndbr</dodf> intfrprfts <dodf>MONTH == JANUARY</dodf>,
 * <dodf>DAY_OF_MONTH == 32</dodf> bs Ffbrubry 1.

 * <p>Wifn b <dodf>Cblfndbr</dodf> is in non-lfnifnt modf, it tirows bn
 * fxdfption if tifrf is bny indonsistfndy in its dblfndbr fiflds. For
 * fxbmplf, b <dodf>GrfgoribnCblfndbr</dodf> blwbys produdfs
 * <dodf>DAY_OF_MONTH</dodf> vblufs bftwffn 1 bnd tif lfngti of tif monti. A
 * non-lfnifnt <dodf>GrfgoribnCblfndbr</dodf> tirows bn fxdfption upon
 * dbldulbting its timf or dblfndbr fifld vblufs if bny out-of-rbngf fifld
 * vbluf ibs bffn sft.
 *
 * <i4><b nbmf="first_wffk">First Wffk</b></i4>
 *
 * <dodf>Cblfndbr</dodf> dffinfs b lodblf-spfdifid sfvfn dby wffk using two
 * pbrbmftfrs: tif first dby of tif wffk bnd tif minimbl dbys in first wffk
 * (from 1 to 7).  Tifsf numbfrs brf tbkfn from tif lodblf rfsourdf dbtb wifn b
 * <dodf>Cblfndbr</dodf> is donstrudtfd.  Tify mby blso bf spfdififd fxpliditly
 * tirougi tif mftiods for sftting tifir vblufs.
 *
 * <p>Wifn sftting or gftting tif <dodf>WEEK_OF_MONTH</dodf> or
 * <dodf>WEEK_OF_YEAR</dodf> fiflds, <dodf>Cblfndbr</dodf> must dftfrminf tif
 * first wffk of tif monti or yfbr bs b rfffrfndf point.  Tif first wffk of b
 * monti or yfbr is dffinfd bs tif fbrlifst sfvfn dby pfriod bfginning on
 * <dodf>gftFirstDbyOfWffk()</dodf> bnd dontbining bt lfbst
 * <dodf>gftMinimblDbysInFirstWffk()</dodf> dbys of tibt monti or yfbr.  Wffks
 * numbfrfd ..., -1, 0 prfdfdf tif first wffk; wffks numbfrfd 2, 3,... follow
 * it.  Notf tibt tif normblizfd numbfring rfturnfd by <dodf>gft()</dodf> mby bf
 * difffrfnt.  For fxbmplf, b spfdifid <dodf>Cblfndbr</dodf> subdlbss mby
 * dfsignbtf tif wffk bfforf wffk 1 of b yfbr bs wffk <dodf><i>n</i></dodf> of
 * tif prfvious yfbr.
 *
 * <i4>Cblfndbr Fiflds Rfsolution</i4>
 *
 * Wifn domputing b dbtf bnd timf from tif dblfndbr fiflds, tifrf
 * mby bf insuffidifnt informbtion for tif domputbtion (sudi bs only
 * yfbr bnd monti witi no dby of monti), or tifrf mby bf indonsistfnt
 * informbtion (sudi bs Tufsdby, July 15, 1996 (Grfgoribn) -- July 15,
 * 1996 is bdtublly b Mondby). <dodf>Cblfndbr</dodf> will rfsolvf
 * dblfndbr fifld vblufs to dftfrminf tif dbtf bnd timf in tif
 * following wby.
 *
 * <p><b nbmf="rfsolution">If tifrf is bny donflidt in dblfndbr fifld vblufs,
 * <dodf>Cblfndbr</dodf> givfs prioritifs to dblfndbr fiflds tibt ibvf bffn sft
 * morf rfdfntly.</b> Tif following brf tif dffbult dombinbtions of tif
 * dblfndbr fiflds. Tif most rfdfnt dombinbtion, bs dftfrminfd by tif
 * most rfdfntly sft singlf fifld, will bf usfd.
 *
 * <p><b nbmf="dbtf_rfsolution">For tif dbtf fiflds</b>:
 * <blodkquotf>
 * <prf>
 * YEAR + MONTH + DAY_OF_MONTH
 * YEAR + MONTH + WEEK_OF_MONTH + DAY_OF_WEEK
 * YEAR + MONTH + DAY_OF_WEEK_IN_MONTH + DAY_OF_WEEK
 * YEAR + DAY_OF_YEAR
 * YEAR + DAY_OF_WEEK + WEEK_OF_YEAR
 * </prf></blodkquotf>
 *
 * <b nbmf="timf_rfsolution">For tif timf of dby fiflds</b>:
 * <blodkquotf>
 * <prf>
 * HOUR_OF_DAY
 * AM_PM + HOUR
 * </prf></blodkquotf>
 *
 * <p>If tifrf brf bny dblfndbr fiflds wiosf vblufs ibvfn't bffn sft in tif sflfdtfd
 * fifld dombinbtion, <dodf>Cblfndbr</dodf> usfs tifir dffbult vblufs. Tif dffbult
 * vbluf of fbdi fifld mby vbry by dondrftf dblfndbr systfms. For fxbmplf, in
 * <dodf>GrfgoribnCblfndbr</dodf>, tif dffbult of b fifld is tif sbmf bs tibt
 * of tif stbrt of tif Epodi: i.f., <dodf>YEAR = 1970</dodf>, <dodf>MONTH =
 * JANUARY</dodf>, <dodf>DAY_OF_MONTH = 1</dodf>, ftd.
 *
 * <p>
 * <strong>Notf:</strong> Tifrf brf dfrtbin possiblf bmbiguitifs in
 * intfrprftbtion of dfrtbin singulbr timfs, wiidi brf rfsolvfd in tif
 * following wbys:
 * <ol>
 *     <li> 23:59 is tif lbst minutf of tif dby bnd 00:00 is tif first
 *          minutf of tif nfxt dby. Tius, 23:59 on Dfd 31, 1999 &lt; 00:00 on
 *          Jbn 1, 2000 &lt; 00:01 on Jbn 1, 2000.
 *
 *     <li> Altiougi iistoridblly not prfdisf, midnigit blso bflongs to "bm",
 *          bnd noon bflongs to "pm", so on tif sbmf dby,
 *          12:00 bm (midnigit) &lt; 12:01 bm, bnd 12:00 pm (noon) &lt; 12:01 pm
 * </ol>
 *
 * <p>
 * Tif dbtf or timf formbt strings brf not pbrt of tif dffinition of b
 * dblfndbr, bs tiosf must bf modifibblf or ovfrridbblf by tif usfr bt
 * runtimf. Usf {@link DbtfFormbt}
 * to formbt dbtfs.
 *
 * <i4>Fifld Mbnipulbtion</i4>
 *
 * Tif dblfndbr fiflds dbn bf dibngfd using tirff mftiods:
 * <dodf>sft()</dodf>, <dodf>bdd()</dodf>, bnd <dodf>roll()</dodf>.
 *
 * <p><strong><dodf>sft(f, vbluf)</dodf></strong> dibngfs dblfndbr fifld
 * <dodf>f</dodf> to <dodf>vbluf</dodf>.  In bddition, it sfts bn
 * intfrnbl mfmbfr vbribblf to indidbtf tibt dblfndbr fifld <dodf>f</dodf> ibs
 * bffn dibngfd. Altiougi dblfndbr fifld <dodf>f</dodf> is dibngfd immfdibtfly,
 * tif dblfndbr's timf vbluf in millisfdonds is not rfdomputfd until tif nfxt dbll to
 * <dodf>gft()</dodf>, <dodf>gftTimf()</dodf>, <dodf>gftTimfInMillis()</dodf>,
 * <dodf>bdd()</dodf>, or <dodf>roll()</dodf> is mbdf. Tius, multiplf dblls to
 * <dodf>sft()</dodf> do not triggfr multiplf, unnfdfssbry
 * domputbtions. As b rfsult of dibnging b dblfndbr fifld using
 * <dodf>sft()</dodf>, otifr dblfndbr fiflds mby blso dibngf, dfpfnding on tif
 * dblfndbr fifld, tif dblfndbr fifld vbluf, bnd tif dblfndbr systfm. In bddition,
 * <dodf>gft(f)</dodf> will not nfdfssbrily rfturn <dodf>vbluf</dodf> sft by
 * tif dbll to tif <dodf>sft</dodf> mftiod
 * bftfr tif dblfndbr fiflds ibvf bffn rfdomputfd. Tif spfdifids brf dftfrminfd by
 * tif dondrftf dblfndbr dlbss.</p>
 *
 * <p><fm>Exbmplf</fm>: Considfr b <dodf>GrfgoribnCblfndbr</dodf>
 * originblly sft to August 31, 1999. Cblling <dodf>sft(Cblfndbr.MONTH,
 * Cblfndbr.SEPTEMBER)</dodf> sfts tif dbtf to Sfptfmbfr 31,
 * 1999. Tiis is b tfmporbry intfrnbl rfprfsfntbtion tibt rfsolvfs to
 * Odtobfr 1, 1999 if <dodf>gftTimf()</dodf>is tifn dbllfd. Howfvfr, b
 * dbll to <dodf>sft(Cblfndbr.DAY_OF_MONTH, 30)</dodf> bfforf tif dbll to
 * <dodf>gftTimf()</dodf> sfts tif dbtf to Sfptfmbfr 30, 1999, sindf
 * no rfdomputbtion oddurs bftfr <dodf>sft()</dodf> itsflf.</p>
 *
 * <p><strong><dodf>bdd(f, dfltb)</dodf></strong> bdds <dodf>dfltb</dodf>
 * to fifld <dodf>f</dodf>.  Tiis is fquivblfnt to dblling <dodf>sft(f,
 * gft(f) + dfltb)</dodf> witi two bdjustmfnts:</p>
 *
 * <blodkquotf>
 *   <p><strong>Add rulf 1</strong>. Tif vbluf of fifld <dodf>f</dodf>
 *   bftfr tif dbll minus tif vbluf of fifld <dodf>f</dodf> bfforf tif
 *   dbll is <dodf>dfltb</dodf>, modulo bny ovfrflow tibt ibs oddurrfd in
 *   fifld <dodf>f</dodf>. Ovfrflow oddurs wifn b fifld vbluf fxdffds its
 *   rbngf bnd, bs b rfsult, tif nfxt lbrgfr fifld is indrfmfntfd or
 *   dfdrfmfntfd bnd tif fifld vbluf is bdjustfd bbdk into its rbngf.</p>
 *
 *   <p><strong>Add rulf 2</strong>. If b smbllfr fifld is fxpfdtfd to bf
 *   invbribnt, but it is impossiblf for it to bf fqubl to its
 *   prior vbluf bfdbusf of dibngfs in its minimum or mbximum bftfr fifld
 *   <dodf>f</dodf> is dibngfd or otifr donstrbints, sudi bs timf zonf
 *   offsft dibngfs, tifn its vbluf is bdjustfd to bf bs dlosf
 *   bs possiblf to its fxpfdtfd vbluf. A smbllfr fifld rfprfsfnts b
 *   smbllfr unit of timf. <dodf>HOUR</dodf> is b smbllfr fifld tibn
 *   <dodf>DAY_OF_MONTH</dodf>. No bdjustmfnt is mbdf to smbllfr fiflds
 *   tibt brf not fxpfdtfd to bf invbribnt. Tif dblfndbr systfm
 *   dftfrminfs wibt fiflds brf fxpfdtfd to bf invbribnt.</p>
 * </blodkquotf>
 *
 * <p>In bddition, unlikf <dodf>sft()</dodf>, <dodf>bdd()</dodf> fordfs
 * bn immfdibtf rfdomputbtion of tif dblfndbr's millisfdonds bnd bll
 * fiflds.</p>
 *
 * <p><fm>Exbmplf</fm>: Considfr b <dodf>GrfgoribnCblfndbr</dodf>
 * originblly sft to August 31, 1999. Cblling <dodf>bdd(Cblfndbr.MONTH,
 * 13)</dodf> sfts tif dblfndbr to Sfptfmbfr 30, 2000. <strong>Add rulf
 * 1</strong> sfts tif <dodf>MONTH</dodf> fifld to Sfptfmbfr, sindf
 * bdding 13 montis to August givfs Sfptfmbfr of tif nfxt yfbr. Sindf
 * <dodf>DAY_OF_MONTH</dodf> dbnnot bf 31 in Sfptfmbfr in b
 * <dodf>GrfgoribnCblfndbr</dodf>, <strong>bdd rulf 2</strong> sfts tif
 * <dodf>DAY_OF_MONTH</dodf> to 30, tif dlosfst possiblf vbluf. Altiougi
 * it is b smbllfr fifld, <dodf>DAY_OF_WEEK</dodf> is not bdjustfd by
 * rulf 2, sindf it is fxpfdtfd to dibngf wifn tif monti dibngfs in b
 * <dodf>GrfgoribnCblfndbr</dodf>.</p>
 *
 * <p><strong><dodf>roll(f, dfltb)</dodf></strong> bdds
 * <dodf>dfltb</dodf> to fifld <dodf>f</dodf> witiout dibnging lbrgfr
 * fiflds. Tiis is fquivblfnt to dblling <dodf>bdd(f, dfltb)</dodf> witi
 * tif following bdjustmfnt:</p>
 *
 * <blodkquotf>
 *   <p><strong>Roll rulf</strong>. Lbrgfr fiflds brf undibngfd bftfr tif
 *   dbll. A lbrgfr fifld rfprfsfnts b lbrgfr unit of
 *   timf. <dodf>DAY_OF_MONTH</dodf> is b lbrgfr fifld tibn
 *   <dodf>HOUR</dodf>.</p>
 * </blodkquotf>
 *
 * <p><fm>Exbmplf</fm>: Sff {@link jbvb.util.GrfgoribnCblfndbr#roll(int, int)}.
 *
 * <p><strong>Usbgf modfl</strong>. To motivbtf tif bfibvior of
 * <dodf>bdd()</dodf> bnd <dodf>roll()</dodf>, donsidfr b usfr intfrfbdf
 * domponfnt witi indrfmfnt bnd dfdrfmfnt buttons for tif monti, dby, bnd
 * yfbr, bnd bn undfrlying <dodf>GrfgoribnCblfndbr</dodf>. If tif
 * intfrfbdf rfbds Jbnubry 31, 1999 bnd tif usfr prfssfs tif monti
 * indrfmfnt button, wibt siould it rfbd? If tif undfrlying
 * implfmfntbtion usfs <dodf>sft()</dodf>, it migit rfbd Mbrdi 3, 1999. A
 * bfttfr rfsult would bf Ffbrubry 28, 1999. Furtifrmorf, if tif usfr
 * prfssfs tif monti indrfmfnt button bgbin, it siould rfbd Mbrdi 31,
 * 1999, not Mbrdi 28, 1999. By sbving tif originbl dbtf bnd using fitifr
 * <dodf>bdd()</dodf> or <dodf>roll()</dodf>, dfpfnding on wiftifr lbrgfr
 * fiflds siould bf bfffdtfd, tif usfr intfrfbdf dbn bfibvf bs most usfrs
 * will intuitivfly fxpfdt.</p>
 *
 * @sff          jbvb.lbng.Systfm#durrfntTimfMillis()
 * @sff          Dbtf
 * @sff          GrfgoribnCblfndbr
 * @sff          TimfZonf
 * @sff          jbvb.tfxt.DbtfFormbt
 * @butior Mbrk Dbvis, Dbvid Goldsmiti, Cifn-Lifi Hubng, Albn Liu
 * @sindf 1.1
 */
publid bbstrbdt dlbss Cblfndbr implfmfnts Sfriblizbblf, Clonfbblf, Compbrbblf<Cblfndbr> {

    // Dbtb flow in Cblfndbr
    // ---------------------

    // Tif durrfnt timf is rfprfsfntfd in two wbys by Cblfndbr: bs UTC
    // millisfdonds from tif fpodi (1 Jbnubry 1970 0:00 UTC), bnd bs lodbl
    // fiflds sudi bs MONTH, HOUR, AM_PM, ftd.  It is possiblf to domputf tif
    // millis from tif fiflds, bnd vidf vfrsb.  Tif dbtb nffdfd to do tiis
    // donvfrsion is fndbpsulbtfd by b TimfZonf objfdt ownfd by tif Cblfndbr.
    // Tif dbtb providfd by tif TimfZonf objfdt mby blso bf ovfrriddfn if tif
    // usfr sfts tif ZONE_OFFSET bnd/or DST_OFFSET fiflds dirfdtly. Tif dlbss
    // kffps trbdk of wibt informbtion wbs most rfdfntly sft by tif dbllfr, bnd
    // usfs tibt to domputf bny otifr informbtion bs nffdfd.

    // If tif usfr sfts tif fiflds using sft(), tif dbtb flow is bs follows.
    // Tiis is implfmfntfd by tif Cblfndbr subdlbss's domputfTimf() mftiod.
    // During tiis prodfss, dfrtbin fiflds mby bf ignorfd.  Tif disbmbigubtion
    // blgoritim for rfsolving wiidi fiflds to pby bttfntion to is dfsdribfd
    // in tif dlbss dodumfntbtion.

    //   lodbl fiflds (YEAR, MONTH, DATE, HOUR, MINUTE, ftd.)
    //           |
    //           | Using Cblfndbr-spfdifid blgoritim
    //           V
    //   lodbl stbndbrd millis
    //           |
    //           | Using TimfZonf or usfr-sft ZONE_OFFSET / DST_OFFSET
    //           V
    //   UTC millis (in timf dbtb mfmbfr)

    // If tif usfr sfts tif UTC millis using sftTimf() or sftTimfInMillis(),
    // tif dbtb flow is bs follows.  Tiis is implfmfntfd by tif Cblfndbr
    // subdlbss's domputfFiflds() mftiod.

    //   UTC millis (in timf dbtb mfmbfr)
    //           |
    //           | Using TimfZonf gftOffsft()
    //           V
    //   lodbl stbndbrd millis
    //           |
    //           | Using Cblfndbr-spfdifid blgoritim
    //           V
    //   lodbl fiflds (YEAR, MONTH, DATE, HOUR, MINUTE, ftd.)

    // In gfnfrbl, b round trip from fiflds, tirougi lodbl bnd UTC millis, bnd
    // bbdk out to fiflds is mbdf wifn nfdfssbry.  Tiis is implfmfntfd by tif
    // domplftf() mftiod.  Rfsolving b pbrtibl sft of fiflds into b UTC millis
    // vbluf bllows bll rfmbining fiflds to bf gfnfrbtfd from tibt vbluf.  If
    // tif Cblfndbr is lfnifnt, tif fiflds brf blso rfnormblizfd to stbndbrd
    // rbngfs wifn tify brf rfgfnfrbtfd.

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * frb, f.g., AD or BC in tif Julibn dblfndbr. Tiis is b dblfndbr-spfdifid
     * vbluf; sff subdlbss dodumfntbtion.
     *
     * @sff GrfgoribnCblfndbr#AD
     * @sff GrfgoribnCblfndbr#BC
     */
    publid finbl stbtid int ERA = 0;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * yfbr. Tiis is b dblfndbr-spfdifid vbluf; sff subdlbss dodumfntbtion.
     */
    publid finbl stbtid int YEAR = 1;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * monti. Tiis is b dblfndbr-spfdifid vbluf. Tif first monti of
     * tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs is
     * <dodf>JANUARY</dodf> wiidi is 0; tif lbst dfpfnds on tif numbfr
     * of montis in b yfbr.
     *
     * @sff #JANUARY
     * @sff #FEBRUARY
     * @sff #MARCH
     * @sff #APRIL
     * @sff #MAY
     * @sff #JUNE
     * @sff #JULY
     * @sff #AUGUST
     * @sff #SEPTEMBER
     * @sff #OCTOBER
     * @sff #NOVEMBER
     * @sff #DECEMBER
     * @sff #UNDECIMBER
     */
    publid finbl stbtid int MONTH = 2;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * wffk numbfr witiin tif durrfnt yfbr.  Tif first wffk of tif yfbr, bs
     * dffinfd by <dodf>gftFirstDbyOfWffk()</dodf> bnd
     * <dodf>gftMinimblDbysInFirstWffk()</dodf>, ibs vbluf 1.  Subdlbssfs dffinf
     * tif vbluf of <dodf>WEEK_OF_YEAR</dodf> for dbys bfforf tif first wffk of
     * tif yfbr.
     *
     * @sff #gftFirstDbyOfWffk
     * @sff #gftMinimblDbysInFirstWffk
     */
    publid finbl stbtid int WEEK_OF_YEAR = 3;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * wffk numbfr witiin tif durrfnt monti.  Tif first wffk of tif monti, bs
     * dffinfd by <dodf>gftFirstDbyOfWffk()</dodf> bnd
     * <dodf>gftMinimblDbysInFirstWffk()</dodf>, ibs vbluf 1.  Subdlbssfs dffinf
     * tif vbluf of <dodf>WEEK_OF_MONTH</dodf> for dbys bfforf tif first wffk of
     * tif monti.
     *
     * @sff #gftFirstDbyOfWffk
     * @sff #gftMinimblDbysInFirstWffk
     */
    publid finbl stbtid int WEEK_OF_MONTH = 4;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * dby of tif monti. Tiis is b synonym for <dodf>DAY_OF_MONTH</dodf>.
     * Tif first dby of tif monti ibs vbluf 1.
     *
     * @sff #DAY_OF_MONTH
     */
    publid finbl stbtid int DATE = 5;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * dby of tif monti. Tiis is b synonym for <dodf>DATE</dodf>.
     * Tif first dby of tif monti ibs vbluf 1.
     *
     * @sff #DATE
     */
    publid finbl stbtid int DAY_OF_MONTH = 5;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif dby
     * numbfr witiin tif durrfnt yfbr.  Tif first dby of tif yfbr ibs vbluf 1.
     */
    publid finbl stbtid int DAY_OF_YEAR = 6;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif dby
     * of tif wffk.  Tiis fifld tbkfs vblufs <dodf>SUNDAY</dodf>,
     * <dodf>MONDAY</dodf>, <dodf>TUESDAY</dodf>, <dodf>WEDNESDAY</dodf>,
     * <dodf>THURSDAY</dodf>, <dodf>FRIDAY</dodf>, bnd <dodf>SATURDAY</dodf>.
     *
     * @sff #SUNDAY
     * @sff #MONDAY
     * @sff #TUESDAY
     * @sff #WEDNESDAY
     * @sff #THURSDAY
     * @sff #FRIDAY
     * @sff #SATURDAY
     */
    publid finbl stbtid int DAY_OF_WEEK = 7;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * ordinbl numbfr of tif dby of tif wffk witiin tif durrfnt monti. Togftifr
     * witi tif <dodf>DAY_OF_WEEK</dodf> fifld, tiis uniqufly spfdififs b dby
     * witiin b monti.  Unlikf <dodf>WEEK_OF_MONTH</dodf> bnd
     * <dodf>WEEK_OF_YEAR</dodf>, tiis fifld's vbluf dofs <fm>not</fm> dfpfnd on
     * <dodf>gftFirstDbyOfWffk()</dodf> or
     * <dodf>gftMinimblDbysInFirstWffk()</dodf>.  <dodf>DAY_OF_MONTH 1</dodf>
     * tirougi <dodf>7</dodf> blwbys dorrfspond to <dodf>DAY_OF_WEEK_IN_MONTH
     * 1</dodf>; <dodf>8</dodf> tirougi <dodf>14</dodf> dorrfspond to
     * <dodf>DAY_OF_WEEK_IN_MONTH 2</dodf>, bnd so on.
     * <dodf>DAY_OF_WEEK_IN_MONTH 0</dodf> indidbtfs tif wffk bfforf
     * <dodf>DAY_OF_WEEK_IN_MONTH 1</dodf>.  Nfgbtivf vblufs dount bbdk from tif
     * fnd of tif monti, so tif lbst Sundby of b monti is spfdififd bs
     * <dodf>DAY_OF_WEEK = SUNDAY, DAY_OF_WEEK_IN_MONTH = -1</dodf>.  Bfdbusf
     * nfgbtivf vblufs dount bbdkwbrd tify will usublly bf blignfd difffrfntly
     * witiin tif monti tibn positivf vblufs.  For fxbmplf, if b monti ibs 31
     * dbys, <dodf>DAY_OF_WEEK_IN_MONTH -1</dodf> will ovfrlbp
     * <dodf>DAY_OF_WEEK_IN_MONTH 5</dodf> bnd tif fnd of <dodf>4</dodf>.
     *
     * @sff #DAY_OF_WEEK
     * @sff #WEEK_OF_MONTH
     */
    publid finbl stbtid int DAY_OF_WEEK_IN_MONTH = 8;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting
     * wiftifr tif <dodf>HOUR</dodf> is bfforf or bftfr noon.
     * E.g., bt 10:04:15.250 PM tif <dodf>AM_PM</dodf> is <dodf>PM</dodf>.
     *
     * @sff #AM
     * @sff #PM
     * @sff #HOUR
     */
    publid finbl stbtid int AM_PM = 9;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * iour of tif morning or bftfrnoon. <dodf>HOUR</dodf> is usfd for tif
     * 12-iour dlodk (0 - 11). Noon bnd midnigit brf rfprfsfntfd by 0, not by 12.
     * E.g., bt 10:04:15.250 PM tif <dodf>HOUR</dodf> is 10.
     *
     * @sff #AM_PM
     * @sff #HOUR_OF_DAY
     */
    publid finbl stbtid int HOUR = 10;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * iour of tif dby. <dodf>HOUR_OF_DAY</dodf> is usfd for tif 24-iour dlodk.
     * E.g., bt 10:04:15.250 PM tif <dodf>HOUR_OF_DAY</dodf> is 22.
     *
     * @sff #HOUR
     */
    publid finbl stbtid int HOUR_OF_DAY = 11;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * minutf witiin tif iour.
     * E.g., bt 10:04:15.250 PM tif <dodf>MINUTE</dodf> is 4.
     */
    publid finbl stbtid int MINUTE = 12;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * sfdond witiin tif minutf.
     * E.g., bt 10:04:15.250 PM tif <dodf>SECOND</dodf> is 15.
     */
    publid finbl stbtid int SECOND = 13;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * millisfdond witiin tif sfdond.
     * E.g., bt 10:04:15.250 PM tif <dodf>MILLISECOND</dodf> is 250.
     */
    publid finbl stbtid int MILLISECOND = 14;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf>
     * indidbting tif rbw offsft from GMT in millisfdonds.
     * <p>
     * Tiis fifld rfflfdts tif dorrfdt GMT offsft vbluf of tif timf
     * zonf of tiis <dodf>Cblfndbr</dodf> if tif
     * <dodf>TimfZonf</dodf> implfmfntbtion subdlbss supports
     * iistoridbl GMT offsft dibngfs.
     */
    publid finbl stbtid int ZONE_OFFSET = 15;

    /**
     * Fifld numbfr for <dodf>gft</dodf> bnd <dodf>sft</dodf> indidbting tif
     * dbyligit sbving offsft in millisfdonds.
     * <p>
     * Tiis fifld rfflfdts tif dorrfdt dbyligit sbving offsft vbluf of
     * tif timf zonf of tiis <dodf>Cblfndbr</dodf> if tif
     * <dodf>TimfZonf</dodf> implfmfntbtion subdlbss supports
     * iistoridbl Dbyligit Sbving Timf sdifdulf dibngfs.
     */
    publid finbl stbtid int DST_OFFSET = 16;

    /**
     * Tif numbfr of distindt fiflds rfdognizfd by <dodf>gft</dodf> bnd <dodf>sft</dodf>.
     * Fifld numbfrs rbngf from <dodf>0..FIELD_COUNT-1</dodf>.
     */
    publid finbl stbtid int FIELD_COUNT = 17;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Sundby.
     */
    publid finbl stbtid int SUNDAY = 1;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Mondby.
     */
    publid finbl stbtid int MONDAY = 2;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Tufsdby.
     */
    publid finbl stbtid int TUESDAY = 3;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Wfdnfsdby.
     */
    publid finbl stbtid int WEDNESDAY = 4;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Tiursdby.
     */
    publid finbl stbtid int THURSDAY = 5;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Fridby.
     */
    publid finbl stbtid int FRIDAY = 6;

    /**
     * Vbluf of tif {@link #DAY_OF_WEEK} fifld indidbting
     * Sbturdby.
     */
    publid finbl stbtid int SATURDAY = 7;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * first monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int JANUARY = 0;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * sfdond monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int FEBRUARY = 1;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * tiird monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int MARCH = 2;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * fourti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int APRIL = 3;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * fifti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int MAY = 4;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * sixti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int JUNE = 5;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * sfvfnti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int JULY = 6;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * figiti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int AUGUST = 7;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * ninti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int SEPTEMBER = 8;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * tfnti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int OCTOBER = 9;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * flfvfnti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int NOVEMBER = 10;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * twflfti monti of tif yfbr in tif Grfgoribn bnd Julibn dblfndbrs.
     */
    publid finbl stbtid int DECEMBER = 11;

    /**
     * Vbluf of tif {@link #MONTH} fifld indidbting tif
     * tiirtffnti monti of tif yfbr. Altiougi <dodf>GrfgoribnCblfndbr</dodf>
     * dofs not usf tiis vbluf, lunbr dblfndbrs do.
     */
    publid finbl stbtid int UNDECIMBER = 12;

    /**
     * Vbluf of tif {@link #AM_PM} fifld indidbting tif
     * pfriod of tif dby from midnigit to just bfforf noon.
     */
    publid finbl stbtid int AM = 0;

    /**
     * Vbluf of tif {@link #AM_PM} fifld indidbting tif
     * pfriod of tif dby from noon to just bfforf midnigit.
     */
    publid finbl stbtid int PM = 1;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting nbmfs in bll stylfs, sudi bs
     * "Jbnubry" bnd "Jbn".
     *
     * @sff #SHORT_FORMAT
     * @sff #LONG_FORMAT
     * @sff #SHORT_STANDALONE
     * @sff #LONG_STANDALONE
     * @sff #SHORT
     * @sff #LONG
     * @sindf 1.6
     */
    publid stbtid finbl int ALL_STYLES = 0;

    stbtid finbl int STANDALONE_MASK = 0x8000;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} fquivblfnt to {@link #SHORT_FORMAT}.
     *
     * @sff #SHORT_STANDALONE
     * @sff #LONG
     * @sindf 1.6
     */
    publid stbtid finbl int SHORT = 1;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} fquivblfnt to {@link #LONG_FORMAT}.
     *
     * @sff #LONG_STANDALONE
     * @sff #SHORT
     * @sindf 1.6
     */
    publid stbtid finbl int LONG = 2;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b nbrrow nbmf usfd for formbt. Nbrrow nbmfs
     * brf typidblly singlf dibrbdtfr strings, sudi bs "M" for Mondby.
     *
     * @sff #NARROW_STANDALONE
     * @sff #SHORT_FORMAT
     * @sff #LONG_FORMAT
     * @sindf 1.8
     */
    publid stbtid finbl int NARROW_FORMAT = 4;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b nbrrow nbmf indfpfndfntly. Nbrrow nbmfs
     * brf typidblly singlf dibrbdtfr strings, sudi bs "M" for Mondby.
     *
     * @sff #NARROW_FORMAT
     * @sff #SHORT_STANDALONE
     * @sff #LONG_STANDALONE
     * @sindf 1.8
     */
    publid stbtid finbl int NARROW_STANDALONE = NARROW_FORMAT | STANDALONE_MASK;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b siort nbmf usfd for formbt.
     *
     * @sff #SHORT_STANDALONE
     * @sff #LONG_FORMAT
     * @sff #LONG_STANDALONE
     * @sindf 1.8
     */
    publid stbtid finbl int SHORT_FORMAT = 1;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b long nbmf usfd for formbt.
     *
     * @sff #LONG_STANDALONE
     * @sff #SHORT_FORMAT
     * @sff #SHORT_STANDALONE
     * @sindf 1.8
     */
    publid stbtid finbl int LONG_FORMAT = 2;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b siort nbmf usfd indfpfndfntly,
     * sudi bs b monti bbbrfvibtion bs dblfndbr ifbdfrs.
     *
     * @sff #SHORT_FORMAT
     * @sff #LONG_FORMAT
     * @sff #LONG_STANDALONE
     * @sindf 1.8
     */
    publid stbtid finbl int SHORT_STANDALONE = SHORT | STANDALONE_MASK;

    /**
     * A stylf spfdififr for {@link #gftDisplbyNbmf(int, int, Lodblf)
     * gftDisplbyNbmf} bnd {@link #gftDisplbyNbmfs(int, int, Lodblf)
     * gftDisplbyNbmfs} indidbting b long nbmf usfd indfpfndfntly,
     * sudi bs b monti nbmf bs dblfndbr ifbdfrs.
     *
     * @sff #LONG_FORMAT
     * @sff #SHORT_FORMAT
     * @sff #SHORT_STANDALONE
     * @sindf 1.8
     */
    publid stbtid finbl int LONG_STANDALONE = LONG | STANDALONE_MASK;

    // Intfrnbl notfs:
    // Cblfndbr dontbins two kinds of timf rfprfsfntbtions: durrfnt "timf" in
    // millisfdonds, bnd b sft of dblfndbr "fiflds" rfprfsfnting tif durrfnt timf.
    // Tif two rfprfsfntbtions brf usublly in synd, but dbn gft out of synd
    // bs follows.
    // 1. Initiblly, no fiflds brf sft, bnd tif timf is invblid.
    // 2. If tif timf is sft, bll fiflds brf domputfd bnd in synd.
    // 3. If b singlf fifld is sft, tif timf is invblid.
    // Rfdomputbtion of tif timf bnd fiflds ibppfns wifn tif objfdt nffds
    // to rfturn b rfsult to tif usfr, or usf b rfsult for b domputbtion.

    /**
     * Tif dblfndbr fifld vblufs for tif durrfntly sft timf for tiis dblfndbr.
     * Tiis is bn brrby of <dodf>FIELD_COUNT</dodf> intfgfrs, witi indfx vblufs
     * <dodf>ERA</dodf> tirougi <dodf>DST_OFFSET</dodf>.
     * @sfribl
     */
    @SupprfssWbrnings("ProtfdtfdFifld")
    protfdtfd int           fiflds[];

    /**
     * Tif flbgs wiidi tfll if b spfdififd dblfndbr fifld for tif dblfndbr is sft.
     * A nfw objfdt ibs no fiflds sft.  Aftfr tif first dbll to b mftiod
     * wiidi gfnfrbtfs tif fiflds, tify bll rfmbin sft bftfr tibt.
     * Tiis is bn brrby of <dodf>FIELD_COUNT</dodf> boolfbns, witi indfx vblufs
     * <dodf>ERA</dodf> tirougi <dodf>DST_OFFSET</dodf>.
     * @sfribl
     */
    @SupprfssWbrnings("ProtfdtfdFifld")
    protfdtfd boolfbn       isSft[];

    /**
     * Psfudo-timf-stbmps wiidi spfdify wifn fbdi fifld wbs sft. Tifrf
     * brf two spfdibl vblufs, UNSET bnd COMPUTED. Vblufs from
     * MINIMUM_USER_SET to Intfgfr.MAX_VALUE brf lfgbl usfr sft vblufs.
     */
    trbnsifnt privbtf int   stbmp[];

    /**
     * Tif durrfntly sft timf for tiis dblfndbr, fxprfssfd in millisfdonds bftfr
     * Jbnubry 1, 1970, 0:00:00 GMT.
     * @sff #isTimfSft
     * @sfribl
     */
    @SupprfssWbrnings("ProtfdtfdFifld")
    protfdtfd long          timf;

    /**
     * Truf if tifn tif vbluf of <dodf>timf</dodf> is vblid.
     * Tif timf is mbdf invblid by b dibngf to bn itfm of <dodf>fifld[]</dodf>.
     * @sff #timf
     * @sfribl
     */
    @SupprfssWbrnings("ProtfdtfdFifld")
    protfdtfd boolfbn       isTimfSft;

    /**
     * Truf if <dodf>fiflds[]</dodf> brf in synd witi tif durrfntly sft timf.
     * If fblsf, tifn tif nfxt bttfmpt to gft tif vbluf of b fifld will
     * fordf b rfdomputbtion of bll fiflds from tif durrfnt vbluf of
     * <dodf>timf</dodf>.
     * @sfribl
     */
    @SupprfssWbrnings("ProtfdtfdFifld")
    protfdtfd boolfbn       brfFifldsSft;

    /**
     * Truf if bll fiflds ibvf bffn sft.
     * @sfribl
     */
    trbnsifnt boolfbn       brfAllFifldsSft;

    /**
     * <dodf>Truf</dodf> if tiis dblfndbr bllows out-of-rbngf fifld vblufs during domputbtion
     * of <dodf>timf</dodf> from <dodf>fiflds[]</dodf>.
     * @sff #sftLfnifnt
     * @sff #isLfnifnt
     * @sfribl
     */
    privbtf boolfbn         lfnifnt = truf;

    /**
     * Tif <dodf>TimfZonf</dodf> usfd by tiis dblfndbr. <dodf>Cblfndbr</dodf>
     * usfs tif timf zonf dbtb to trbnslbtf bftwffn lodblf bnd GMT timf.
     * @sfribl
     */
    privbtf TimfZonf        zonf;

    /**
     * <dodf>Truf</dodf> if zonf rfffrfndfs to b sibrfd TimfZonf objfdt.
     */
    trbnsifnt privbtf boolfbn sibrfdZonf = fblsf;

    /**
     * Tif first dby of tif wffk, witi possiblf vblufs <dodf>SUNDAY</dodf>,
     * <dodf>MONDAY</dodf>, ftd.  Tiis is b lodblf-dfpfndfnt vbluf.
     * @sfribl
     */
    privbtf int             firstDbyOfWffk;

    /**
     * Tif numbfr of dbys rfquirfd for tif first wffk in b monti or yfbr,
     * witi possiblf vblufs from 1 to 7.  Tiis is b lodblf-dfpfndfnt vbluf.
     * @sfribl
     */
    privbtf int             minimblDbysInFirstWffk;

    /**
     * Cbdif to iold tif firstDbyOfWffk bnd minimblDbysInFirstWffk
     * of b Lodblf.
     */
    privbtf stbtid finbl CondurrfntMbp<Lodblf, int[]> dbdifdLodblfDbtb
        = nfw CondurrfntHbsiMbp<>(3);

    // Spfdibl vblufs of stbmp[]
    /**
     * Tif dorrfsponding fiflds[] ibs no vbluf.
     */
    privbtf stbtid finbl int        UNSET = 0;

    /**
     * Tif vbluf of tif dorrfsponding fiflds[] ibs bffn dbldulbtfd intfrnblly.
     */
    privbtf stbtid finbl int        COMPUTED = 1;

    /**
     * Tif vbluf of tif dorrfsponding fiflds[] ibs bffn sft fxtfrnblly. Stbmp
     * vblufs wiidi brf grfbtfr tibn 1 rfprfsfnts tif (psfudo) timf wifn tif
     * dorrfsponding fiflds[] vbluf wbs sft.
     */
    privbtf stbtid finbl int        MINIMUM_USER_STAMP = 2;

    /**
     * Tif mbsk vbluf tibt rfprfsfnts bll of tif fiflds.
     */
    stbtid finbl int ALL_FIELDS = (1 << FIELD_COUNT) - 1;

    /**
     * Tif nfxt bvbilbblf vbluf for <dodf>stbmp[]</dodf>, bn intfrnbl brrby.
     * Tiis bdtublly siould not bf writtfn out to tif strfbm, bnd will probbbly
     * bf rfmovfd from tif strfbm in tif nfbr futurf.  In tif mfbntimf,
     * b vbluf of <dodf>MINIMUM_USER_STAMP</dodf> siould bf usfd.
     * @sfribl
     */
    privbtf int             nfxtStbmp = MINIMUM_USER_STAMP;

    // tif intfrnbl sfribl vfrsion wiidi sbys wiidi vfrsion wbs writtfn
    // - 0 (dffbult) for vfrsion up to JDK 1.1.5
    // - 1 for vfrsion from JDK 1.1.6, wiidi writfs b dorrfdt 'timf' vbluf
    //     bs wfll bs dompbtiblf vblufs for otifr fiflds.  Tiis is b
    //     trbnsitionbl formbt.
    // - 2 (not implfmfntfd yft) b futurf vfrsion, in wiidi fiflds[],
    //     brfFifldsSft, bnd isTimfSft bfdomf trbnsifnt, bnd isSft[] is
    //     rfmovfd. In JDK 1.1.6 wf writf b formbt dompbtiblf witi vfrsion 2.
    stbtid finbl int        durrfntSfriblVfrsion = 1;

    /**
     * Tif vfrsion of tif sfriblizfd dbtb on tif strfbm.  Possiblf vblufs:
     * <dl>
     * <dt><b>0</b> or not prfsfnt on strfbm</dt>
     * <dd>
     * JDK 1.1.5 or fbrlifr.
     * </dd>
     * <dt><b>1</b></dt>
     * <dd>
     * JDK 1.1.6 or lbtfr.  Writfs b dorrfdt 'timf' vbluf
     * bs wfll bs dompbtiblf vblufs for otifr fiflds.  Tiis is b
     * trbnsitionbl formbt.
     * </dd>
     * </dl>
     * Wifn strfbming out tiis dlbss, tif most rfdfnt formbt
     * bnd tif iigifst bllowbblf <dodf>sfriblVfrsionOnStrfbm</dodf>
     * is writtfn.
     * @sfribl
     * @sindf 1.1.6
     */
    privbtf int             sfriblVfrsionOnStrfbm = durrfntSfriblVfrsion;

    // Prodlbim sfriblizbtion dompbtibility witi JDK 1.1
    stbtid finbl long       sfriblVfrsionUID = -1807547505821590642L;

    // Mbsk vblufs for dblfndbr fiflds
    @SupprfssWbrnings("PointlfssBitwisfExprfssion")
    finbl stbtid int ERA_MASK           = (1 << ERA);
    finbl stbtid int YEAR_MASK          = (1 << YEAR);
    finbl stbtid int MONTH_MASK         = (1 << MONTH);
    finbl stbtid int WEEK_OF_YEAR_MASK  = (1 << WEEK_OF_YEAR);
    finbl stbtid int WEEK_OF_MONTH_MASK = (1 << WEEK_OF_MONTH);
    finbl stbtid int DAY_OF_MONTH_MASK  = (1 << DAY_OF_MONTH);
    finbl stbtid int DATE_MASK          = DAY_OF_MONTH_MASK;
    finbl stbtid int DAY_OF_YEAR_MASK   = (1 << DAY_OF_YEAR);
    finbl stbtid int DAY_OF_WEEK_MASK   = (1 << DAY_OF_WEEK);
    finbl stbtid int DAY_OF_WEEK_IN_MONTH_MASK  = (1 << DAY_OF_WEEK_IN_MONTH);
    finbl stbtid int AM_PM_MASK         = (1 << AM_PM);
    finbl stbtid int HOUR_MASK          = (1 << HOUR);
    finbl stbtid int HOUR_OF_DAY_MASK   = (1 << HOUR_OF_DAY);
    finbl stbtid int MINUTE_MASK        = (1 << MINUTE);
    finbl stbtid int SECOND_MASK        = (1 << SECOND);
    finbl stbtid int MILLISECOND_MASK   = (1 << MILLISECOND);
    finbl stbtid int ZONE_OFFSET_MASK   = (1 << ZONE_OFFSET);
    finbl stbtid int DST_OFFSET_MASK    = (1 << DST_OFFSET);

    /**
     * {@dodf Cblfndbr.Buildfr} is usfd for drfbting b {@dodf Cblfndbr} from
     * vbrious dbtf-timf pbrbmftfrs.
     *
     * <p>Tifrf brf two wbys to sft b {@dodf Cblfndbr} to b dbtf-timf vbluf. Onf
     * is to sft tif instbnt pbrbmftfr to b millisfdond offsft from tif <b
     * irff="Cblfndbr.itml#Epodi">Epodi</b>. Tif otifr is to sft individubl
     * fifld pbrbmftfrs, sudi bs {@link Cblfndbr#YEAR YEAR}, to tifir dfsirfd
     * vblufs. Tifsf two wbys dbn't bf mixfd. Trying to sft boti tif instbnt bnd
     * individubl fiflds will dbusf bn {@link IllfgblStbtfExdfption} to bf
     * tirown. Howfvfr, it is pfrmittfd to ovfrridf prfvious vblufs of tif
     * instbnt or fifld pbrbmftfrs.
     *
     * <p>If no fnougi fifld pbrbmftfrs brf givfn for dftfrmining dbtf bnd/or
     * timf, dblfndbr spfdifid dffbult vblufs brf usfd wifn building b
     * {@dodf Cblfndbr}. For fxbmplf, if tif {@link Cblfndbr#YEAR YEAR} vbluf
     * isn't givfn for tif Grfgoribn dblfndbr, 1970 will bf usfd. If tifrf brf
     * bny donflidts bmong fifld pbrbmftfrs, tif <b
     * irff="Cblfndbr.itml#rfsolution"> rfsolution rulfs</b> brf bpplifd.
     * Tifrfforf, tif ordfr of fifld sftting mbttfrs.
     *
     * <p>In bddition to tif dbtf-timf pbrbmftfrs,
     * tif {@linkplbin #sftLodblf(Lodblf) lodblf},
     * {@linkplbin #sftTimfZonf(TimfZonf) timf zonf},
     * {@linkplbin #sftWffkDffinition(int, int) wffk dffinition}, bnd
     * {@linkplbin #sftLfnifnt(boolfbn) lfnifndy modf} pbrbmftfrs dbn bf sft.
     *
     * <p><b>Exbmplfs</b>
     * <p>Tif following brf sbmplf usbgfs. Sbmplf dodf bssumfs tibt tif
     * {@dodf Cblfndbr} donstbnts brf stbtidblly importfd.
     *
     * <p>Tif following dodf produdfs b {@dodf Cblfndbr} witi dbtf 2012-12-31
     * (Grfgoribn) bfdbusf Mondby is tif first dby of b wffk witi tif <b
     * irff="GrfgoribnCblfndbr.itml#iso8601_dompbtiblf_sftting"> ISO 8601
     * dompbtiblf wffk pbrbmftfrs</b>.
     * <prf>
     *   Cblfndbr dbl = nfw Cblfndbr.Buildfr().sftCblfndbrTypf("iso8601")
     *                        .sftWffkDbtf(2013, 1, MONDAY).build();</prf>
     * <p>Tif following dodf produdfs b Jbpbnfsf {@dodf Cblfndbr} witi dbtf
     * 1989-01-08 (Grfgoribn), bssuming tibt tif dffbult {@link Cblfndbr#ERA ERA}
     * is <fm>Hfisfi</fm> tibt stbrtfd on tibt dby.
     * <prf>
     *   Cblfndbr dbl = nfw Cblfndbr.Buildfr().sftCblfndbrTypf("jbpbnfsf")
     *                        .sftFiflds(YEAR, 1, DAY_OF_YEAR, 1).build();</prf>
     *
     * @sindf 1.8
     * @sff Cblfndbr#gftInstbndf(TimfZonf, Lodblf)
     * @sff Cblfndbr#fiflds
     */
    publid stbtid dlbss Buildfr {
        privbtf stbtid finbl int NFIELDS = FIELD_COUNT + 1; // +1 for WEEK_YEAR
        privbtf stbtid finbl int WEEK_YEAR = FIELD_COUNT;

        privbtf long instbnt;
        // Cblfndbr.stbmp[] (lowfr iblf) bnd Cblfndbr.fiflds[] (uppfr iblf) dombinfd
        privbtf int[] fiflds;
        // Psfudo timfstbmp stbrting from MINIMUM_USER_STAMP.
        // (COMPUTED is usfd to indidbtf tibt tif instbnt ibs bffn sft.)
        privbtf int nfxtStbmp;
        // mbxFifldIndfx kffps tif mbx indfx of fiflds wiidi ibvf bffn sft.
        // (WEEK_YEAR is nfvfr indludfd.)
        privbtf int mbxFifldIndfx;
        privbtf String typf;
        privbtf TimfZonf zonf;
        privbtf boolfbn lfnifnt = truf;
        privbtf Lodblf lodblf;
        privbtf int firstDbyOfWffk, minimblDbysInFirstWffk;

        /**
         * Construdts b {@dodf Cblfndbr.Buildfr}.
         */
        publid Buildfr() {
        }

        /**
         * Sfts tif instbnt pbrbmftfr to tif givfn {@dodf instbnt} vbluf tibt is
         * b millisfdond offsft from <b irff="Cblfndbr.itml#Epodi">tif
         * Epodi</b>.
         *
         * @pbrbm instbnt b millisfdond offsft from tif Epodi
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows IllfgblStbtfExdfption if bny of tif fifld pbrbmftfrs ibvf
         *                               blrfbdy bffn sft
         * @sff Cblfndbr#sftTimf(Dbtf)
         * @sff Cblfndbr#sftTimfInMillis(long)
         * @sff Cblfndbr#timf
         */
        publid Buildfr sftInstbnt(long instbnt) {
            if (fiflds != null) {
                tirow nfw IllfgblStbtfExdfption();
            }
            tiis.instbnt = instbnt;
            nfxtStbmp = COMPUTED;
            rfturn tiis;
        }

        /**
         * Sfts tif instbnt pbrbmftfr to tif {@dodf instbnt} vbluf givfn by b
         * {@link Dbtf}. Tiis mftiod is fquivblfnt to b dbll to
         * {@link #sftInstbnt(long) sftInstbnt(instbnt.gftTimf())}.
         *
         * @pbrbm instbnt b {@dodf Dbtf} rfprfsfnting b millisfdond offsft from
         *                tif Epodi
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows NullPointfrExdfption  if {@dodf instbnt} is {@dodf null}
         * @tirows IllfgblStbtfExdfption if bny of tif fifld pbrbmftfrs ibvf
         *                               blrfbdy bffn sft
         * @sff Cblfndbr#sftTimf(Dbtf)
         * @sff Cblfndbr#sftTimfInMillis(long)
         * @sff Cblfndbr#timf
         */
        publid Buildfr sftInstbnt(Dbtf instbnt) {
            rfturn sftInstbnt(instbnt.gftTimf()); // NPE if instbnt == null
        }

        /**
         * Sfts tif {@dodf fifld} pbrbmftfr to tif givfn {@dodf vbluf}.
         * {@dodf fifld} is bn indfx to tif {@link Cblfndbr#fiflds}, sudi bs
         * {@link Cblfndbr#DAY_OF_MONTH DAY_OF_MONTH}. Fifld vbluf vblidbtion is
         * not pfrformfd in tiis mftiod. Any out of rbngf vblufs brf fitifr
         * normblizfd in lfnifnt modf or dftfdtfd bs bn invblid vbluf in
         * non-lfnifnt modf wifn building b {@dodf Cblfndbr}.
         *
         * @pbrbm fifld bn indfx to tif {@dodf Cblfndbr} fiflds
         * @pbrbm vbluf tif fifld vbluf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows IllfgblArgumfntExdfption if {@dodf fifld} is invblid
         * @tirows IllfgblStbtfExdfption if tif instbnt vbluf ibs blrfbdy bffn sft,
         *                      or if fiflds ibvf bffn sft too mbny
         *                      (bpproximbtfly {@link Intfgfr#MAX_VALUE}) timfs.
         * @sff Cblfndbr#sft(int, int)
         */
        publid Buildfr sft(int fifld, int vbluf) {
            // Notf: WEEK_YEAR dbn't bf sft witi tiis mftiod.
            if (fifld < 0 || fifld >= FIELD_COUNT) {
                tirow nfw IllfgblArgumfntExdfption("fifld is invblid");
            }
            if (isInstbntSft()) {
                tirow nfw IllfgblStbtfExdfption("instbnt ibs bffn sft");
            }
            bllodbtfFiflds();
            intfrnblSft(fifld, vbluf);
            rfturn tiis;
        }

        /**
         * Sfts fifld pbrbmftfrs to tifir vblufs givfn by
         * {@dodf fifldVblufPbirs} tibt brf pbirs of b fifld bnd its vbluf.
         * For fxbmplf,
         * <prf>
         *   sftFfilds(Cblfndbr.YEAR, 2013,
         *             Cblfndbr.MONTH, Cblfndbr.DECEMBER,
         *             Cblfndbr.DAY_OF_MONTH, 23);</prf>
         * is fquivblfnt to tif sfqufndf of tif following
         * {@link #sft(int, int) sft} dblls:
         * <prf>
         *   sft(Cblfndbr.YEAR, 2013)
         *   .sft(Cblfndbr.MONTH, Cblfndbr.DECEMBER)
         *   .sft(Cblfndbr.DAY_OF_MONTH, 23);</prf>
         *
         * @pbrbm fifldVblufPbirs fifld-vbluf pbirs
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows NullPointfrExdfption if {@dodf fifldVblufPbirs} is {@dodf null}
         * @tirows IllfgblArgumfntExdfption if bny of fiflds brf invblid,
         *             or if {@dodf fifldVblufPbirs.lfngti} is bn odd numbfr.
         * @tirows IllfgblStbtfExdfption    if tif instbnt vbluf ibs bffn sft,
         *             or if fiflds ibvf bffn sft too mbny (bpproximbtfly
         *             {@link Intfgfr#MAX_VALUE}) timfs.
         */
        publid Buildfr sftFiflds(int... fifldVblufPbirs) {
            int lfn = fifldVblufPbirs.lfngti;
            if ((lfn % 2) != 0) {
                tirow nfw IllfgblArgumfntExdfption();
            }
            if (isInstbntSft()) {
                tirow nfw IllfgblStbtfExdfption("instbnt ibs bffn sft");
            }
            if ((nfxtStbmp + lfn / 2) < 0) {
                tirow nfw IllfgblStbtfExdfption("stbmp dountfr ovfrflow");
            }
            bllodbtfFiflds();
            for (int i = 0; i < lfn; ) {
                int fifld = fifldVblufPbirs[i++];
                // Notf: WEEK_YEAR dbn't bf sft witi tiis mftiod.
                if (fifld < 0 || fifld >= FIELD_COUNT) {
                    tirow nfw IllfgblArgumfntExdfption("fifld is invblid");
                }
                intfrnblSft(fifld, fifldVblufPbirs[i++]);
            }
            rfturn tiis;
        }

        /**
         * Sfts tif dbtf fifld pbrbmftfrs to tif vblufs givfn by {@dodf yfbr},
         * {@dodf monti}, bnd {@dodf dbyOfMonti}. Tiis mftiod is fquivblfnt to
         * b dbll to:
         * <prf>
         *   sftFiflds(Cblfndbr.YEAR, yfbr,
         *             Cblfndbr.MONTH, monti,
         *             Cblfndbr.DAY_OF_MONTH, dbyOfMonti);</prf>
         *
         * @pbrbm yfbr       tif {@link Cblfndbr#YEAR YEAR} vbluf
         * @pbrbm monti      tif {@link Cblfndbr#MONTH MONTH} vbluf
         *                   (tif monti numbfring is <fm>0-bbsfd</fm>).
         * @pbrbm dbyOfMonti tif {@link Cblfndbr#DAY_OF_MONTH DAY_OF_MONTH} vbluf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         */
        publid Buildfr sftDbtf(int yfbr, int monti, int dbyOfMonti) {
            rfturn sftFiflds(YEAR, yfbr, MONTH, monti, DAY_OF_MONTH, dbyOfMonti);
        }

        /**
         * Sfts tif timf of dby fifld pbrbmftfrs to tif vblufs givfn by
         * {@dodf iourOfDby}, {@dodf minutf}, bnd {@dodf sfdond}. Tiis mftiod is
         * fquivblfnt to b dbll to:
         * <prf>
         *   sftTimfOfDby(iourOfDby, minutf, sfdond, 0);</prf>
         *
         * @pbrbm iourOfDby tif {@link Cblfndbr#HOUR_OF_DAY HOUR_OF_DAY} vbluf
         *                  (24-iour dlodk)
         * @pbrbm minutf    tif {@link Cblfndbr#MINUTE MINUTE} vbluf
         * @pbrbm sfdond    tif {@link Cblfndbr#SECOND SECOND} vbluf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         */
        publid Buildfr sftTimfOfDby(int iourOfDby, int minutf, int sfdond) {
            rfturn sftTimfOfDby(iourOfDby, minutf, sfdond, 0);
        }

        /**
         * Sfts tif timf of dby fifld pbrbmftfrs to tif vblufs givfn by
         * {@dodf iourOfDby}, {@dodf minutf}, {@dodf sfdond}, bnd
         * {@dodf millis}. Tiis mftiod is fquivblfnt to b dbll to:
         * <prf>
         *   sftFiflds(Cblfndbr.HOUR_OF_DAY, iourOfDby,
         *             Cblfndbr.MINUTE, minutf,
         *             Cblfndbr.SECOND, sfdond,
         *             Cblfndbr.MILLISECOND, millis);</prf>
         *
         * @pbrbm iourOfDby tif {@link Cblfndbr#HOUR_OF_DAY HOUR_OF_DAY} vbluf
         *                  (24-iour dlodk)
         * @pbrbm minutf    tif {@link Cblfndbr#MINUTE MINUTE} vbluf
         * @pbrbm sfdond    tif {@link Cblfndbr#SECOND SECOND} vbluf
         * @pbrbm millis    tif {@link Cblfndbr#MILLISECOND MILLISECOND} vbluf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         */
        publid Buildfr sftTimfOfDby(int iourOfDby, int minutf, int sfdond, int millis) {
            rfturn sftFiflds(HOUR_OF_DAY, iourOfDby, MINUTE, minutf,
                             SECOND, sfdond, MILLISECOND, millis);
        }

        /**
         * Sfts tif wffk-bbsfd dbtf pbrbmftfrs to tif vblufs witi tif givfn
         * dbtf spfdififrs - wffk yfbr, wffk of yfbr, bnd dby of wffk.
         *
         * <p>If tif spfdififd dblfndbr dofsn't support wffk dbtfs, tif
         * {@link #build() build} mftiod will tirow bn {@link IllfgblArgumfntExdfption}.
         *
         * @pbrbm wffkYfbr   tif wffk yfbr
         * @pbrbm wffkOfYfbr tif wffk numbfr bbsfd on {@dodf wffkYfbr}
         * @pbrbm dbyOfWffk  tif dby of wffk vbluf: onf of tif donstbnts
         *     for tif {@link Cblfndbr#DAY_OF_WEEK DAY_OF_WEEK} fifld:
         *     {@link Cblfndbr#SUNDAY SUNDAY}, ..., {@link Cblfndbr#SATURDAY SATURDAY}.
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @sff Cblfndbr#sftWffkDbtf(int, int, int)
         * @sff Cblfndbr#isWffkDbtfSupportfd()
         */
        publid Buildfr sftWffkDbtf(int wffkYfbr, int wffkOfYfbr, int dbyOfWffk) {
            bllodbtfFiflds();
            intfrnblSft(WEEK_YEAR, wffkYfbr);
            intfrnblSft(WEEK_OF_YEAR, wffkOfYfbr);
            intfrnblSft(DAY_OF_WEEK, dbyOfWffk);
            rfturn tiis;
        }

        /**
         * Sfts tif timf zonf pbrbmftfr to tif givfn {@dodf zonf}. If no timf
         * zonf pbrbmftfr is givfn to tiis {@dodf Cblfdbr.Buildfr}, tif
         * {@linkplbin TimfZonf#gftDffbult() dffbult
         * <dodf>TimfZonf</dodf>} will bf usfd in tif {@link #build() build}
         * mftiod.
         *
         * @pbrbm zonf tif {@link TimfZonf}
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows NullPointfrExdfption if {@dodf zonf} is {@dodf null}
         * @sff Cblfndbr#sftTimfZonf(TimfZonf)
         */
        publid Buildfr sftTimfZonf(TimfZonf zonf) {
            if (zonf == null) {
                tirow nfw NullPointfrExdfption();
            }
            tiis.zonf = zonf;
            rfturn tiis;
        }

        /**
         * Sfts tif lfnifnt modf pbrbmftfr to tif vbluf givfn by {@dodf lfnifnt}.
         * If no lfnifnt pbrbmftfr is givfn to tiis {@dodf Cblfndbr.Buildfr},
         * lfnifnt modf will bf usfd in tif {@link #build() build} mftiod.
         *
         * @pbrbm lfnifnt {@dodf truf} for lfnifnt modf;
         *                {@dodf fblsf} for non-lfnifnt modf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @sff Cblfndbr#sftLfnifnt(boolfbn)
         */
        publid Buildfr sftLfnifnt(boolfbn lfnifnt) {
            tiis.lfnifnt = lfnifnt;
            rfturn tiis;
        }

        /**
         * Sfts tif dblfndbr typf pbrbmftfr to tif givfn {@dodf typf}. Tif
         * dblfndbr typf givfn by tiis mftiod ibs prfdfdfndf ovfr bny fxplidit
         * or implidit dblfndbr typf givfn by tif
         * {@linkplbin #sftLodblf(Lodblf) lodblf}.
         *
         * <p>In bddition to tif bvbilbblf dblfndbr typfs rfturnfd by tif
         * {@link Cblfndbr#gftAvbilbblfCblfndbrTypfs() Cblfndbr.gftAvbilbblfCblfndbrTypfs}
         * mftiod, {@dodf "grfgoribn"} bnd {@dodf "iso8601"} bs blibsfs of
         * {@dodf "grfgory"} dbn bf usfd witi tiis mftiod.
         *
         * @pbrbm typf tif dblfndbr typf
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows NullPointfrExdfption if {@dodf typf} is {@dodf null}
         * @tirows IllfgblArgumfntExdfption if {@dodf typf} is unknown
         * @tirows IllfgblStbtfExdfption if bnotifr dblfndbr typf ibs blrfbdy bffn sft
         * @sff Cblfndbr#gftCblfndbrTypf()
         * @sff Cblfndbr#gftAvbilbblfCblfndbrTypfs()
         */
        publid Buildfr sftCblfndbrTypf(String typf) {
            if (typf.fqubls("grfgoribn")) { // NPE if typf == null
                typf = "grfgory";
            }
            if (!Cblfndbr.gftAvbilbblfCblfndbrTypfs().dontbins(typf)
                    && !typf.fqubls("iso8601")) {
                tirow nfw IllfgblArgumfntExdfption("unknown dblfndbr typf: " + typf);
            }
            if (tiis.typf == null) {
                tiis.typf = typf;
            } flsf {
                if (!tiis.typf.fqubls(typf)) {
                    tirow nfw IllfgblStbtfExdfption("dblfndbr typf ovfrridf");
                }
            }
            rfturn tiis;
        }

        /**
         * Sfts tif lodblf pbrbmftfr to tif givfn {@dodf lodblf}. If no lodblf
         * is givfn to tiis {@dodf Cblfndbr.Buildfr}, tif {@linkplbin
         * Lodblf#gftDffbult(Lodblf.Cbtfgory) dffbult <dodf>Lodblf</dodf>}
         * for {@link Lodblf.Cbtfgory#FORMAT} will bf usfd.
         *
         * <p>If no dblfndbr typf is fxpliditly givfn by b dbll to tif
         * {@link #sftCblfndbrTypf(String) sftCblfndbrTypf} mftiod,
         * tif {@dodf Lodblf} vbluf is usfd to dftfrminf wibt typf of
         * {@dodf Cblfndbr} to bf built.
         *
         * <p>If no wffk dffinition pbrbmftfrs brf fxpliditly givfn by b dbll to
         * tif {@link #sftWffkDffinition(int,int) sftWffkDffinition} mftiod, tif
         * {@dodf Lodblf}'s dffbult vblufs brf usfd.
         *
         * @pbrbm lodblf tif {@link Lodblf}
         * @tirows NullPointfrExdfption if {@dodf lodblf} is {@dodf null}
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @sff Cblfndbr#gftInstbndf(Lodblf)
         */
        publid Buildfr sftLodblf(Lodblf lodblf) {
            if (lodblf == null) {
                tirow nfw NullPointfrExdfption();
            }
            tiis.lodblf = lodblf;
            rfturn tiis;
        }

        /**
         * Sfts tif wffk dffinition pbrbmftfrs to tif vblufs givfn by
         * {@dodf firstDbyOfWffk} bnd {@dodf minimblDbysInFirstWffk} tibt brf
         * usfd to dftfrminf tif <b irff="Cblfndbr.itml#First_Wffk">first
         * wffk</b> of b yfbr. Tif pbrbmftfrs givfn by tiis mftiod ibvf
         * prfdfdfndf ovfr tif dffbult vblufs givfn by tif
         * {@linkplbin #sftLodblf(Lodblf) lodblf}.
         *
         * @pbrbm firstDbyOfWffk tif first dby of b wffk; onf of
         *                       {@link Cblfndbr#SUNDAY} to {@link Cblfndbr#SATURDAY}
         * @pbrbm minimblDbysInFirstWffk tif minimbl numbfr of dbys in tif first
         *                               wffk (1..7)
         * @rfturn tiis {@dodf Cblfndbr.Buildfr}
         * @tirows IllfgblArgumfntExdfption if {@dodf firstDbyOfWffk} or
         *                                  {@dodf minimblDbysInFirstWffk} is invblid
         * @sff Cblfndbr#gftFirstDbyOfWffk()
         * @sff Cblfndbr#gftMinimblDbysInFirstWffk()
         */
        publid Buildfr sftWffkDffinition(int firstDbyOfWffk, int minimblDbysInFirstWffk) {
            if (!isVblidWffkPbrbmftfr(firstDbyOfWffk)
                    || !isVblidWffkPbrbmftfr(minimblDbysInFirstWffk)) {
                tirow nfw IllfgblArgumfntExdfption();
            }
            tiis.firstDbyOfWffk = firstDbyOfWffk;
            tiis.minimblDbysInFirstWffk = minimblDbysInFirstWffk;
            rfturn tiis;
        }

        /**
         * Rfturns b {@dodf Cblfndbr} built from tif pbrbmftfrs sft by tif
         * sfttfr mftiods. Tif dblfndbr typf givfn by tif {@link #sftCblfndbrTypf(String)
         * sftCblfndbrTypf} mftiod or tif {@linkplbin #sftLodblf(Lodblf) lodblf} is
         * usfd to dftfrminf wibt {@dodf Cblfndbr} to bf drfbtfd. If no fxplidit
         * dblfndbr typf is givfn, tif lodblf's dffbult dblfndbr is drfbtfd.
         *
         * <p>If tif dblfndbr typf is {@dodf "iso8601"}, tif
         * {@linkplbin GrfgoribnCblfndbr#sftGrfgoribnCibngf(Dbtf) Grfgoribn dibngf dbtf}
         * of b {@link GrfgoribnCblfndbr} is sft to {@dodf Dbtf(Long.MIN_VALUE)}
         * to bf tif <fm>prolfptid</fm> Grfgoribn dblfndbr. Its wffk dffinition
         * pbrbmftfrs brf blso sft to bf <b
         * irff="GrfgoribnCblfndbr.itml#iso8601_dompbtiblf_sftting">dompbtiblf
         * witi tif ISO 8601 stbndbrd</b>. Notf tibt tif
         * {@link GrfgoribnCblfndbr#gftCblfndbrTypf() gftCblfndbrTypf} mftiod of
         * b {@dodf GrfgoribnCblfndbr} drfbtfd witi {@dodf "iso8601"} rfturns
         * {@dodf "grfgory"}.
         *
         * <p>Tif dffbult vblufs brf usfd for lodblf bnd timf zonf if tifsf
         * pbrbmftfrs ibvfn't bffn givfn fxpliditly.
         *
         * <p>Any out of rbngf fifld vblufs brf fitifr normblizfd in lfnifnt
         * modf or dftfdtfd bs bn invblid vbluf in non-lfnifnt modf.
         *
         * @rfturn b {@dodf Cblfndbr} built witi pbrbmftfrs of tiis {@dodf
         *         Cblfndbr.Buildfr}
         * @tirows IllfgblArgumfntExdfption if tif dblfndbr typf is unknown, or
         *             if bny invblid fifld vblufs brf givfn in non-lfnifnt modf, or
         *             if b wffk dbtf is givfn for tif dblfndbr typf tibt dofsn't
         *             support wffk dbtfs.
         * @sff Cblfndbr#gftInstbndf(TimfZonf, Lodblf)
         * @sff Lodblf#gftDffbult(Lodblf.Cbtfgory)
         * @sff TimfZonf#gftDffbult()
         */
        publid Cblfndbr build() {
            if (lodblf == null) {
                lodblf = Lodblf.gftDffbult();
            }
            if (zonf == null) {
                zonf = TimfZonf.gftDffbult();
            }
            Cblfndbr dbl;
            if (typf == null) {
                typf = lodblf.gftUnidodfLodblfTypf("db");
            }
            if (typf == null) {
                if (lodblf.gftCountry() == "TH"
                    && lodblf.gftLbngubgf() == "ti") {
                    typf = "buddiist";
                } flsf {
                    typf = "grfgory";
                }
            }
            switdi (typf) {
            dbsf "grfgory":
                dbl = nfw GrfgoribnCblfndbr(zonf, lodblf, truf);
                brfbk;
            dbsf "iso8601":
                GrfgoribnCblfndbr gdbl = nfw GrfgoribnCblfndbr(zonf, lodblf, truf);
                // mbkf gdbl b prolfptid Grfgoribn
                gdbl.sftGrfgoribnCibngf(nfw Dbtf(Long.MIN_VALUE));
                // bnd wffk dffinition to bf dompbtiblf witi ISO 8601
                sftWffkDffinition(MONDAY, 4);
                dbl = gdbl;
                brfbk;
            dbsf "buddiist":
                dbl = nfw BuddiistCblfndbr(zonf, lodblf);
                dbl.dlfbr();
                brfbk;
            dbsf "jbpbnfsf":
                dbl = nfw JbpbnfsfImpfriblCblfndbr(zonf, lodblf, truf);
                brfbk;
            dffbult:
                tirow nfw IllfgblArgumfntExdfption("unknown dblfndbr typf: " + typf);
            }
            dbl.sftLfnifnt(lfnifnt);
            if (firstDbyOfWffk != 0) {
                dbl.sftFirstDbyOfWffk(firstDbyOfWffk);
                dbl.sftMinimblDbysInFirstWffk(minimblDbysInFirstWffk);
            }
            if (isInstbntSft()) {
                dbl.sftTimfInMillis(instbnt);
                dbl.domplftf();
                rfturn dbl;
            }

            if (fiflds != null) {
                boolfbn wffkDbtf = isSft(WEEK_YEAR)
                                       && fiflds[WEEK_YEAR] > fiflds[YEAR];
                if (wffkDbtf && !dbl.isWffkDbtfSupportfd()) {
                    tirow nfw IllfgblArgumfntExdfption("wffk dbtf is unsupportfd by " + typf);
                }

                // Sft tif fiflds from tif min stbmp to tif mbx stbmp so tibt
                // tif fiflds rfsolution works in tif Cblfndbr.
                for (int stbmp = MINIMUM_USER_STAMP; stbmp < nfxtStbmp; stbmp++) {
                    for (int indfx = 0; indfx <= mbxFifldIndfx; indfx++) {
                        if (fiflds[indfx] == stbmp) {
                            dbl.sft(indfx, fiflds[NFIELDS + indfx]);
                            brfbk;
                        }
                    }
                }

                if (wffkDbtf) {
                    int wffkOfYfbr = isSft(WEEK_OF_YEAR) ? fiflds[NFIELDS + WEEK_OF_YEAR] : 1;
                    int dbyOfWffk = isSft(DAY_OF_WEEK)
                                    ? fiflds[NFIELDS + DAY_OF_WEEK] : dbl.gftFirstDbyOfWffk();
                    dbl.sftWffkDbtf(fiflds[NFIELDS + WEEK_YEAR], wffkOfYfbr, dbyOfWffk);
                }
                dbl.domplftf();
            }

            rfturn dbl;
        }

        privbtf void bllodbtfFiflds() {
            if (fiflds == null) {
                fiflds = nfw int[NFIELDS * 2];
                nfxtStbmp = MINIMUM_USER_STAMP;
                mbxFifldIndfx = -1;
            }
        }

        privbtf void intfrnblSft(int fifld, int vbluf) {
            fiflds[fifld] = nfxtStbmp++;
            if (nfxtStbmp < 0) {
                tirow nfw IllfgblStbtfExdfption("stbmp dountfr ovfrflow");
            }
            fiflds[NFIELDS + fifld] = vbluf;
            if (fifld > mbxFifldIndfx && fifld < WEEK_YEAR) {
                mbxFifldIndfx = fifld;
            }
        }

        privbtf boolfbn isInstbntSft() {
            rfturn nfxtStbmp == COMPUTED;
        }

        privbtf boolfbn isSft(int indfx) {
            rfturn fiflds != null && fiflds[indfx] > UNSET;
        }

        privbtf boolfbn isVblidWffkPbrbmftfr(int vbluf) {
            rfturn vbluf > 0 && vbluf <= 7;
        }
    }

    /**
     * Construdts b Cblfndbr witi tif dffbult timf zonf
     * bnd tif dffbult {@link jbvb.util.Lodblf.Cbtfgory#FORMAT FORMAT}
     * lodblf.
     * @sff     TimfZonf#gftDffbult
     */
    protfdtfd Cblfndbr()
    {
        tiis(TimfZonf.gftDffbultRff(), Lodblf.gftDffbult(Lodblf.Cbtfgory.FORMAT));
        sibrfdZonf = truf;
    }

    /**
     * Construdts b dblfndbr witi tif spfdififd timf zonf bnd lodblf.
     *
     * @pbrbm zonf tif timf zonf to usf
     * @pbrbm bLodblf tif lodblf for tif wffk dbtb
     */
    protfdtfd Cblfndbr(TimfZonf zonf, Lodblf bLodblf)
    {
        fiflds = nfw int[FIELD_COUNT];
        isSft = nfw boolfbn[FIELD_COUNT];
        stbmp = nfw int[FIELD_COUNT];

        tiis.zonf = zonf;
        sftWffkCountDbtb(bLodblf);
    }

    /**
     * Gfts b dblfndbr using tif dffbult timf zonf bnd lodblf. Tif
     * <dodf>Cblfndbr</dodf> rfturnfd is bbsfd on tif durrfnt timf
     * in tif dffbult timf zonf witi tif dffbult
     * {@link Lodblf.Cbtfgory#FORMAT FORMAT} lodblf.
     *
     * @rfturn b Cblfndbr.
     */
    publid stbtid Cblfndbr gftInstbndf()
    {
        rfturn drfbtfCblfndbr(TimfZonf.gftDffbult(), Lodblf.gftDffbult(Lodblf.Cbtfgory.FORMAT));
    }

    /**
     * Gfts b dblfndbr using tif spfdififd timf zonf bnd dffbult lodblf.
     * Tif <dodf>Cblfndbr</dodf> rfturnfd is bbsfd on tif durrfnt timf
     * in tif givfn timf zonf witi tif dffbult
     * {@link Lodblf.Cbtfgory#FORMAT FORMAT} lodblf.
     *
     * @pbrbm zonf tif timf zonf to usf
     * @rfturn b Cblfndbr.
     */
    publid stbtid Cblfndbr gftInstbndf(TimfZonf zonf)
    {
        rfturn drfbtfCblfndbr(zonf, Lodblf.gftDffbult(Lodblf.Cbtfgory.FORMAT));
    }

    /**
     * Gfts b dblfndbr using tif dffbult timf zonf bnd spfdififd lodblf.
     * Tif <dodf>Cblfndbr</dodf> rfturnfd is bbsfd on tif durrfnt timf
     * in tif dffbult timf zonf witi tif givfn lodblf.
     *
     * @pbrbm bLodblf tif lodblf for tif wffk dbtb
     * @rfturn b Cblfndbr.
     */
    publid stbtid Cblfndbr gftInstbndf(Lodblf bLodblf)
    {
        rfturn drfbtfCblfndbr(TimfZonf.gftDffbult(), bLodblf);
    }

    /**
     * Gfts b dblfndbr witi tif spfdififd timf zonf bnd lodblf.
     * Tif <dodf>Cblfndbr</dodf> rfturnfd is bbsfd on tif durrfnt timf
     * in tif givfn timf zonf witi tif givfn lodblf.
     *
     * @pbrbm zonf tif timf zonf to usf
     * @pbrbm bLodblf tif lodblf for tif wffk dbtb
     * @rfturn b Cblfndbr.
     */
    publid stbtid Cblfndbr gftInstbndf(TimfZonf zonf,
                                       Lodblf bLodblf)
    {
        rfturn drfbtfCblfndbr(zonf, bLodblf);
    }

    privbtf stbtid Cblfndbr drfbtfCblfndbr(TimfZonf zonf,
                                           Lodblf bLodblf)
    {
        CblfndbrProvidfr providfr =
            LodblfProvidfrAdbptfr.gftAdbptfr(CblfndbrProvidfr.dlbss, bLodblf)
                                 .gftCblfndbrProvidfr();
        if (providfr != null) {
            try {
                rfturn providfr.gftInstbndf(zonf, bLodblf);
            } dbtdi (IllfgblArgumfntExdfption ibf) {
                // fbll bbdk to tif dffbult instbntibtion
            }
        }

        Cblfndbr dbl = null;

        if (bLodblf.ibsExtfnsions()) {
            String dbltypf = bLodblf.gftUnidodfLodblfTypf("db");
            if (dbltypf != null) {
                switdi (dbltypf) {
                dbsf "buddiist":
                dbl = nfw BuddiistCblfndbr(zonf, bLodblf);
                    brfbk;
                dbsf "jbpbnfsf":
                    dbl = nfw JbpbnfsfImpfriblCblfndbr(zonf, bLodblf);
                    brfbk;
                dbsf "grfgory":
                    dbl = nfw GrfgoribnCblfndbr(zonf, bLodblf);
                    brfbk;
                }
            }
        }
        if (dbl == null) {
            // If no known dblfndbr typf is fxpliditly spfdififd,
            // pfrform tif trbditionbl wby to drfbtf b Cblfndbr:
            // drfbtf b BuddiistCblfndbr for ti_TH lodblf,
            // b JbpbnfsfImpfriblCblfndbr for jb_JP_JP lodblf, or
            // b GrfgoribnCblfndbr for bny otifr lodblfs.
            // NOTE: Tif lbngubgf, dountry bnd vbribnt strings brf intfrnfd.
            if (bLodblf.gftLbngubgf() == "ti" && bLodblf.gftCountry() == "TH") {
                dbl = nfw BuddiistCblfndbr(zonf, bLodblf);
            } flsf if (bLodblf.gftVbribnt() == "JP" && bLodblf.gftLbngubgf() == "jb"
                       && bLodblf.gftCountry() == "JP") {
                dbl = nfw JbpbnfsfImpfriblCblfndbr(zonf, bLodblf);
            } flsf {
                dbl = nfw GrfgoribnCblfndbr(zonf, bLodblf);
            }
        }
        rfturn dbl;
    }

    /**
     * Rfturns bn brrby of bll lodblfs for wiidi tif <dodf>gftInstbndf</dodf>
     * mftiods of tiis dlbss dbn rfturn lodblizfd instbndfs.
     * Tif brrby rfturnfd must dontbin bt lfbst b <dodf>Lodblf</dodf>
     * instbndf fqubl to {@link jbvb.util.Lodblf#US Lodblf.US}.
     *
     * @rfturn An brrby of lodblfs for wiidi lodblizfd
     *         <dodf>Cblfndbr</dodf> instbndfs brf bvbilbblf.
     */
    publid stbtid syndironizfd Lodblf[] gftAvbilbblfLodblfs()
    {
        rfturn DbtfFormbt.gftAvbilbblfLodblfs();
    }

    /**
     * Convfrts tif durrfnt dblfndbr fifld vblufs in {@link #fiflds fiflds[]}
     * to tif millisfdond timf vbluf
     * {@link #timf}.
     *
     * @sff #domplftf()
     * @sff #domputfFiflds()
     */
    protfdtfd bbstrbdt void domputfTimf();

    /**
     * Convfrts tif durrfnt millisfdond timf vbluf {@link #timf}
     * to dblfndbr fifld vblufs in {@link #fiflds fiflds[]}.
     * Tiis bllows you to synd up tif dblfndbr fifld vblufs witi
     * b nfw timf tibt is sft for tif dblfndbr.  Tif timf is <fm>not</fm>
     * rfdomputfd first; to rfdomputf tif timf, tifn tif fiflds, dbll tif
     * {@link #domplftf()} mftiod.
     *
     * @sff #domputfTimf()
     */
    protfdtfd bbstrbdt void domputfFiflds();

    /**
     * Rfturns b <dodf>Dbtf</dodf> objfdt rfprfsfnting tiis
     * <dodf>Cblfndbr</dodf>'s timf vbluf (millisfdond offsft from tif <b
     * irff="#Epodi">Epodi</b>").
     *
     * @rfturn b <dodf>Dbtf</dodf> rfprfsfnting tif timf vbluf.
     * @sff #sftTimf(Dbtf)
     * @sff #gftTimfInMillis()
     */
    publid finbl Dbtf gftTimf() {
        rfturn nfw Dbtf(gftTimfInMillis());
    }

    /**
     * Sfts tiis Cblfndbr's timf witi tif givfn <dodf>Dbtf</dodf>.
     * <p>
     * Notf: Cblling <dodf>sftTimf()</dodf> witi
     * <dodf>Dbtf(Long.MAX_VALUE)</dodf> or <dodf>Dbtf(Long.MIN_VALUE)</dodf>
     * mby yifld indorrfdt fifld vblufs from <dodf>gft()</dodf>.
     *
     * @pbrbm dbtf tif givfn Dbtf.
     * @sff #gftTimf()
     * @sff #sftTimfInMillis(long)
     */
    publid finbl void sftTimf(Dbtf dbtf) {
        sftTimfInMillis(dbtf.gftTimf());
    }

    /**
     * Rfturns tiis Cblfndbr's timf vbluf in millisfdonds.
     *
     * @rfturn tif durrfnt timf bs UTC millisfdonds from tif fpodi.
     * @sff #gftTimf()
     * @sff #sftTimfInMillis(long)
     */
    publid long gftTimfInMillis() {
        if (!isTimfSft) {
            updbtfTimf();
        }
        rfturn timf;
    }

    /**
     * Sfts tiis Cblfndbr's durrfnt timf from tif givfn long vbluf.
     *
     * @pbrbm millis tif nfw timf in UTC millisfdonds from tif fpodi.
     * @sff #sftTimf(Dbtf)
     * @sff #gftTimfInMillis()
     */
    publid void sftTimfInMillis(long millis) {
        // If wf don't nffd to rfdbldulbtf tif dblfndbr fifld vblufs,
        // do notiing.
        if (timf == millis && isTimfSft && brfFifldsSft && brfAllFifldsSft
            && (zonf instbndfof ZonfInfo) && !((ZonfInfo)zonf).isDirty()) {
            rfturn;
        }
        timf = millis;
        isTimfSft = truf;
        brfFifldsSft = fblsf;
        domputfFiflds();
        brfAllFifldsSft = brfFifldsSft = truf;
    }

    /**
     * Rfturns tif vbluf of tif givfn dblfndbr fifld. In lfnifnt modf,
     * bll dblfndbr fiflds brf normblizfd. In non-lfnifnt modf, bll
     * dblfndbr fiflds brf vblidbtfd bnd tiis mftiod tirows bn
     * fxdfption if bny dblfndbr fiflds ibvf out-of-rbngf vblufs. Tif
     * normblizbtion bnd vblidbtion brf ibndlfd by tif
     * {@link #domplftf()} mftiod, wiidi prodfss is dblfndbr
     * systfm dfpfndfnt.
     *
     * @pbrbm fifld tif givfn dblfndbr fifld.
     * @rfturn tif vbluf for tif givfn dblfndbr fifld.
     * @tirows ArrbyIndfxOutOfBoundsExdfption if tif spfdififd fifld is out of rbngf
     *             (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * @sff #sft(int,int)
     * @sff #domplftf()
     */
    publid int gft(int fifld)
    {
        domplftf();
        rfturn intfrnblGft(fifld);
    }

    /**
     * Rfturns tif vbluf of tif givfn dblfndbr fifld. Tiis mftiod dofs
     * not involvf normblizbtion or vblidbtion of tif fifld vbluf.
     *
     * @pbrbm fifld tif givfn dblfndbr fifld.
     * @rfturn tif vbluf for tif givfn dblfndbr fifld.
     * @sff #gft(int)
     */
    protfdtfd finbl int intfrnblGft(int fifld)
    {
        rfturn fiflds[fifld];
    }

    /**
     * Sfts tif vbluf of tif givfn dblfndbr fifld. Tiis mftiod dofs
     * not bfffdt bny sftting stbtf of tif fifld in tiis
     * <dodf>Cblfndbr</dodf> instbndf.
     *
     * @tirows IndfxOutOfBoundsExdfption if tif spfdififd fifld is out of rbngf
     *             (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * @sff #brfFifldsSft
     * @sff #isTimfSft
     * @sff #brfAllFifldsSft
     * @sff #sft(int,int)
     */
    finbl void intfrnblSft(int fifld, int vbluf)
    {
        fiflds[fifld] = vbluf;
    }

    /**
     * Sfts tif givfn dblfndbr fifld to tif givfn vbluf. Tif vbluf is not
     * intfrprftfd by tiis mftiod rfgbrdlfss of tif lfnifndy modf.
     *
     * @pbrbm fifld tif givfn dblfndbr fifld.
     * @pbrbm vbluf tif vbluf to bf sft for tif givfn dblfndbr fifld.
     * @tirows ArrbyIndfxOutOfBoundsExdfption if tif spfdififd fifld is out of rbngf
     *             (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * in non-lfnifnt modf.
     * @sff #sft(int,int,int)
     * @sff #sft(int,int,int,int,int)
     * @sff #sft(int,int,int,int,int,int)
     * @sff #gft(int)
     */
    publid void sft(int fifld, int vbluf)
    {
        // If tif fiflds brf pbrtiblly normblizfd, dbldulbtf bll tif
        // fiflds bfforf dibnging bny fiflds.
        if (brfFifldsSft && !brfAllFifldsSft) {
            domputfFiflds();
        }
        intfrnblSft(fifld, vbluf);
        isTimfSft = fblsf;
        brfFifldsSft = fblsf;
        isSft[fifld] = truf;
        stbmp[fifld] = nfxtStbmp++;
        if (nfxtStbmp == Intfgfr.MAX_VALUE) {
            bdjustStbmp();
        }
    }

    /**
     * Sfts tif vblufs for tif dblfndbr fiflds <dodf>YEAR</dodf>,
     * <dodf>MONTH</dodf>, bnd <dodf>DAY_OF_MONTH</dodf>.
     * Prfvious vblufs of otifr dblfndbr fiflds brf rftbinfd.  If tiis is not dfsirfd,
     * dbll {@link #dlfbr()} first.
     *
     * @pbrbm yfbr tif vbluf usfd to sft tif <dodf>YEAR</dodf> dblfndbr fifld.
     * @pbrbm monti tif vbluf usfd to sft tif <dodf>MONTH</dodf> dblfndbr fifld.
     * Monti vbluf is 0-bbsfd. f.g., 0 for Jbnubry.
     * @pbrbm dbtf tif vbluf usfd to sft tif <dodf>DAY_OF_MONTH</dodf> dblfndbr fifld.
     * @sff #sft(int,int)
     * @sff #sft(int,int,int,int,int)
     * @sff #sft(int,int,int,int,int,int)
     */
    publid finbl void sft(int yfbr, int monti, int dbtf)
    {
        sft(YEAR, yfbr);
        sft(MONTH, monti);
        sft(DATE, dbtf);
    }

    /**
     * Sfts tif vblufs for tif dblfndbr fiflds <dodf>YEAR</dodf>,
     * <dodf>MONTH</dodf>, <dodf>DAY_OF_MONTH</dodf>,
     * <dodf>HOUR_OF_DAY</dodf>, bnd <dodf>MINUTE</dodf>.
     * Prfvious vblufs of otifr fiflds brf rftbinfd.  If tiis is not dfsirfd,
     * dbll {@link #dlfbr()} first.
     *
     * @pbrbm yfbr tif vbluf usfd to sft tif <dodf>YEAR</dodf> dblfndbr fifld.
     * @pbrbm monti tif vbluf usfd to sft tif <dodf>MONTH</dodf> dblfndbr fifld.
     * Monti vbluf is 0-bbsfd. f.g., 0 for Jbnubry.
     * @pbrbm dbtf tif vbluf usfd to sft tif <dodf>DAY_OF_MONTH</dodf> dblfndbr fifld.
     * @pbrbm iourOfDby tif vbluf usfd to sft tif <dodf>HOUR_OF_DAY</dodf> dblfndbr fifld.
     * @pbrbm minutf tif vbluf usfd to sft tif <dodf>MINUTE</dodf> dblfndbr fifld.
     * @sff #sft(int,int)
     * @sff #sft(int,int,int)
     * @sff #sft(int,int,int,int,int,int)
     */
    publid finbl void sft(int yfbr, int monti, int dbtf, int iourOfDby, int minutf)
    {
        sft(YEAR, yfbr);
        sft(MONTH, monti);
        sft(DATE, dbtf);
        sft(HOUR_OF_DAY, iourOfDby);
        sft(MINUTE, minutf);
    }

    /**
     * Sfts tif vblufs for tif fiflds <dodf>YEAR</dodf>, <dodf>MONTH</dodf>,
     * <dodf>DAY_OF_MONTH</dodf>, <dodf>HOUR_OF_DAY</dodf>, <dodf>MINUTE</dodf>, bnd
     * <dodf>SECOND</dodf>.
     * Prfvious vblufs of otifr fiflds brf rftbinfd.  If tiis is not dfsirfd,
     * dbll {@link #dlfbr()} first.
     *
     * @pbrbm yfbr tif vbluf usfd to sft tif <dodf>YEAR</dodf> dblfndbr fifld.
     * @pbrbm monti tif vbluf usfd to sft tif <dodf>MONTH</dodf> dblfndbr fifld.
     * Monti vbluf is 0-bbsfd. f.g., 0 for Jbnubry.
     * @pbrbm dbtf tif vbluf usfd to sft tif <dodf>DAY_OF_MONTH</dodf> dblfndbr fifld.
     * @pbrbm iourOfDby tif vbluf usfd to sft tif <dodf>HOUR_OF_DAY</dodf> dblfndbr fifld.
     * @pbrbm minutf tif vbluf usfd to sft tif <dodf>MINUTE</dodf> dblfndbr fifld.
     * @pbrbm sfdond tif vbluf usfd to sft tif <dodf>SECOND</dodf> dblfndbr fifld.
     * @sff #sft(int,int)
     * @sff #sft(int,int,int)
     * @sff #sft(int,int,int,int,int)
     */
    publid finbl void sft(int yfbr, int monti, int dbtf, int iourOfDby, int minutf,
                          int sfdond)
    {
        sft(YEAR, yfbr);
        sft(MONTH, monti);
        sft(DATE, dbtf);
        sft(HOUR_OF_DAY, iourOfDby);
        sft(MINUTE, minutf);
        sft(SECOND, sfdond);
    }

    /**
     * Sfts bll tif dblfndbr fifld vblufs bnd tif timf vbluf
     * (millisfdond offsft from tif <b irff="#Epodi">Epodi</b>) of
     * tiis <dodf>Cblfndbr</dodf> undffinfd. Tiis mfbns tibt {@link
     * #isSft(int) isSft()} will rfturn <dodf>fblsf</dodf> for bll tif
     * dblfndbr fiflds, bnd tif dbtf bnd timf dbldulbtions will trfbt
     * tif fiflds bs if tify ibd nfvfr bffn sft. A
     * <dodf>Cblfndbr</dodf> implfmfntbtion dlbss mby usf its spfdifid
     * dffbult fifld vblufs for dbtf/timf dbldulbtions. For fxbmplf,
     * <dodf>GrfgoribnCblfndbr</dodf> usfs 1970 if tif
     * <dodf>YEAR</dodf> fifld vbluf is undffinfd.
     *
     * @sff #dlfbr(int)
     */
    publid finbl void dlfbr()
    {
        for (int i = 0; i < fiflds.lfngti; ) {
            stbmp[i] = fiflds[i] = 0; // UNSET == 0
            isSft[i++] = fblsf;
        }
        brfAllFifldsSft = brfFifldsSft = fblsf;
        isTimfSft = fblsf;
    }

    /**
     * Sfts tif givfn dblfndbr fifld vbluf bnd tif timf vbluf
     * (millisfdond offsft from tif <b irff="#Epodi">Epodi</b>) of
     * tiis <dodf>Cblfndbr</dodf> undffinfd. Tiis mfbns tibt {@link
     * #isSft(int) isSft(fifld)} will rfturn <dodf>fblsf</dodf>, bnd
     * tif dbtf bnd timf dbldulbtions will trfbt tif fifld bs if it
     * ibd nfvfr bffn sft. A <dodf>Cblfndbr</dodf> implfmfntbtion
     * dlbss mby usf tif fifld's spfdifid dffbult vbluf for dbtf bnd
     * timf dbldulbtions.
     *
     * <p>Tif {@link #HOUR_OF_DAY}, {@link #HOUR} bnd {@link #AM_PM}
     * fiflds brf ibndlfd indfpfndfntly bnd tif <b
     * irff="#timf_rfsolution">tif rfsolution rulf for tif timf of
     * dby</b> is bpplifd. Clfbring onf of tif fiflds dofsn't rfsft
     * tif iour of dby vbluf of tiis <dodf>Cblfndbr</dodf>. Usf {@link
     * #sft(int,int) sft(Cblfndbr.HOUR_OF_DAY, 0)} to rfsft tif iour
     * vbluf.
     *
     * @pbrbm fifld tif dblfndbr fifld to bf dlfbrfd.
     * @sff #dlfbr()
     */
    publid finbl void dlfbr(int fifld)
    {
        fiflds[fifld] = 0;
        stbmp[fifld] = UNSET;
        isSft[fifld] = fblsf;

        brfAllFifldsSft = brfFifldsSft = fblsf;
        isTimfSft = fblsf;
    }

    /**
     * Dftfrminfs if tif givfn dblfndbr fifld ibs b vbluf sft,
     * indluding dbsfs tibt tif vbluf ibs bffn sft by intfrnbl fiflds
     * dbldulbtions triggfrfd by b <dodf>gft</dodf> mftiod dbll.
     *
     * @pbrbm fifld tif dblfndbr fifld to tfst
     * @rfturn <dodf>truf</dodf> if tif givfn dblfndbr fifld ibs b vbluf sft;
     * <dodf>fblsf</dodf> otifrwisf.
     */
    publid finbl boolfbn isSft(int fifld)
    {
        rfturn stbmp[fifld] != UNSET;
    }

    /**
     * Rfturns tif string rfprfsfntbtion of tif dblfndbr
     * <dodf>fifld</dodf> vbluf in tif givfn <dodf>stylf</dodf> bnd
     * <dodf>lodblf</dodf>.  If no string rfprfsfntbtion is
     * bpplidbblf, <dodf>null</dodf> is rfturnfd. Tiis mftiod dblls
     * {@link Cblfndbr#gft(int) gft(fifld)} to gft tif dblfndbr
     * <dodf>fifld</dodf> vbluf if tif string rfprfsfntbtion is
     * bpplidbblf to tif givfn dblfndbr <dodf>fifld</dodf>.
     *
     * <p>For fxbmplf, if tiis <dodf>Cblfndbr</dodf> is b
     * <dodf>GrfgoribnCblfndbr</dodf> bnd its dbtf is 2005-01-01, tifn
     * tif string rfprfsfntbtion of tif {@link #MONTH} fifld would bf
     * "Jbnubry" in tif long stylf in bn Englisi lodblf or "Jbn" in
     * tif siort stylf. Howfvfr, no string rfprfsfntbtion would bf
     * bvbilbblf for tif {@link #DAY_OF_MONTH} fifld, bnd tiis mftiod
     * would rfturn <dodf>null</dodf>.
     *
     * <p>Tif dffbult implfmfntbtion supports tif dblfndbr fiflds for
     * wiidi b {@link DbtfFormbtSymbols} ibs nbmfs in tif givfn
     * <dodf>lodblf</dodf>.
     *
     * @pbrbm fifld
     *        tif dblfndbr fifld for wiidi tif string rfprfsfntbtion
     *        is rfturnfd
     * @pbrbm stylf
     *        tif stylf bpplifd to tif string rfprfsfntbtion; onf of {@link
     *        #SHORT_FORMAT} ({@link #SHORT}), {@link #SHORT_STANDALONE},
     *        {@link #LONG_FORMAT} ({@link #LONG}), {@link #LONG_STANDALONE},
     *        {@link #NARROW_FORMAT}, or {@link #NARROW_STANDALONE}.
     * @pbrbm lodblf
     *        tif lodblf for tif string rfprfsfntbtion
     *        (bny dblfndbr typfs spfdififd by {@dodf lodblf} brf ignorfd)
     * @rfturn tif string rfprfsfntbtion of tif givfn
     *        {@dodf fifld} in tif givfn {@dodf stylf}, or
     *        {@dodf null} if no string rfprfsfntbtion is
     *        bpplidbblf.
     * @fxdfption IllfgblArgumfntExdfption
     *        if {@dodf fifld} or {@dodf stylf} is invblid,
     *        or if tiis {@dodf Cblfndbr} is non-lfnifnt bnd bny
     *        of tif dblfndbr fiflds ibvf invblid vblufs
     * @fxdfption NullPointfrExdfption
     *        if {@dodf lodblf} is null
     * @sindf 1.6
     */
    publid String gftDisplbyNbmf(int fifld, int stylf, Lodblf lodblf) {
        if (!difdkDisplbyNbmfPbrbms(fifld, stylf, SHORT, NARROW_FORMAT, lodblf,
                            ERA_MASK|MONTH_MASK|DAY_OF_WEEK_MASK|AM_PM_MASK)) {
            rfturn null;
        }

        // tif stbndblonf bnd nbrrow stylfs brf supportfd only tirougi CblfndbrDbtbProvidfrs.
        if (isStbndblonfStylf(stylf) || isNbrrowStylf(stylf)) {
            rfturn CblfndbrDbtbUtility.rftrifvfFifldVblufNbmf(gftCblfndbrTypf(),
                                                              fifld, gft(fifld),
                                                              stylf, lodblf);
        }

        DbtfFormbtSymbols symbols = DbtfFormbtSymbols.gftInstbndf(lodblf);
        String[] strings = gftFifldStrings(fifld, stylf, symbols);
        if (strings != null) {
            int fifldVbluf = gft(fifld);
            if (fifldVbluf < strings.lfngti) {
                rfturn strings[fifldVbluf];
            }
        }
        rfturn null;
    }

    /**
     * Rfturns b {@dodf Mbp} dontbining bll nbmfs of tif dblfndbr
     * {@dodf fifld} in tif givfn {@dodf stylf} bnd
     * {@dodf lodblf} bnd tifir dorrfsponding fifld vblufs. For
     * fxbmplf, if tiis {@dodf Cblfndbr} is b {@link
     * GrfgoribnCblfndbr}, tif rfturnfd mbp would dontbin "Jbn" to
     * {@link #JANUARY}, "Ffb" to {@link #FEBRUARY}, bnd so on, in tif
     * {@linkplbin #SHORT siort} stylf in bn Englisi lodblf.
     *
     * <p>Nbrrow nbmfs mby not bf uniquf duf to usf of singlf dibrbdtfrs,
     * sudi bs "S" for Sundby bnd Sbturdby. In tibt dbsf nbrrow nbmfs brf not
     * indludfd in tif rfturnfd {@dodf Mbp}.
     *
     * <p>Tif vblufs of otifr dblfndbr fiflds mby bf tbkfn into
     * bddount to dftfrminf b sft of displby nbmfs. For fxbmplf, if
     * tiis {@dodf Cblfndbr} is b lunisolbr dblfndbr systfm bnd
     * tif yfbr vbluf givfn by tif {@link #YEAR} fifld ibs b lfbp
     * monti, tiis mftiod would rfturn monti nbmfs dontbining tif lfbp
     * monti nbmf, bnd monti nbmfs brf mbppfd to tifir vblufs spfdifid
     * for tif yfbr.
     *
     * <p>Tif dffbult implfmfntbtion supports displby nbmfs dontbinfd in
     * b {@link DbtfFormbtSymbols}. For fxbmplf, if {@dodf fifld}
     * is {@link #MONTH} bnd {@dodf stylf} is {@link
     * #ALL_STYLES}, tiis mftiod rfturns b {@dodf Mbp} dontbining
     * bll strings rfturnfd by {@link DbtfFormbtSymbols#gftSiortMontis()}
     * bnd {@link DbtfFormbtSymbols#gftMontis()}.
     *
     * @pbrbm fifld
     *        tif dblfndbr fifld for wiidi tif displby nbmfs brf rfturnfd
     * @pbrbm stylf
     *        tif stylf bpplifd to tif string rfprfsfntbtion; onf of {@link
     *        #SHORT_FORMAT} ({@link #SHORT}), {@link #SHORT_STANDALONE},
     *        {@link #LONG_FORMAT} ({@link #LONG}), {@link #LONG_STANDALONE},
     *        {@link #NARROW_FORMAT}, or {@link #NARROW_STANDALONE}
     * @pbrbm lodblf
     *        tif lodblf for tif displby nbmfs
     * @rfturn b {@dodf Mbp} dontbining bll displby nbmfs in
     *        {@dodf stylf} bnd {@dodf lodblf} bnd tifir
     *        fifld vblufs, or {@dodf null} if no displby nbmfs
     *        brf dffinfd for {@dodf fifld}
     * @fxdfption IllfgblArgumfntExdfption
     *        if {@dodf fifld} or {@dodf stylf} is invblid,
     *        or if tiis {@dodf Cblfndbr} is non-lfnifnt bnd bny
     *        of tif dblfndbr fiflds ibvf invblid vblufs
     * @fxdfption NullPointfrExdfption
     *        if {@dodf lodblf} is null
     * @sindf 1.6
     */
    publid Mbp<String, Intfgfr> gftDisplbyNbmfs(int fifld, int stylf, Lodblf lodblf) {
        if (!difdkDisplbyNbmfPbrbms(fifld, stylf, ALL_STYLES, NARROW_FORMAT, lodblf,
                                    ERA_MASK|MONTH_MASK|DAY_OF_WEEK_MASK|AM_PM_MASK)) {
            rfturn null;
        }
        if (stylf == ALL_STYLES || isStbndblonfStylf(stylf)) {
            rfturn CblfndbrDbtbUtility.rftrifvfFifldVblufNbmfs(gftCblfndbrTypf(), fifld, stylf, lodblf);
        }
        // SHORT, LONG, or NARROW
        rfturn gftDisplbyNbmfsImpl(fifld, stylf, lodblf);
    }

    privbtf Mbp<String,Intfgfr> gftDisplbyNbmfsImpl(int fifld, int stylf, Lodblf lodblf) {
        DbtfFormbtSymbols symbols = DbtfFormbtSymbols.gftInstbndf(lodblf);
        String[] strings = gftFifldStrings(fifld, stylf, symbols);
        if (strings != null) {
            Mbp<String,Intfgfr> nbmfs = nfw HbsiMbp<>();
            for (int i = 0; i < strings.lfngti; i++) {
                if (strings[i].lfngti() == 0) {
                    dontinuf;
                }
                nbmfs.put(strings[i], i);
            }
            rfturn nbmfs;
        }
        rfturn null;
    }

    boolfbn difdkDisplbyNbmfPbrbms(int fifld, int stylf, int minStylf, int mbxStylf,
                                   Lodblf lodblf, int fifldMbsk) {
        int bbsfStylf = gftBbsfStylf(stylf); // Ignorf tif stbndblonf mbsk
        if (fifld < 0 || fifld >= fiflds.lfngti ||
            bbsfStylf < minStylf || bbsfStylf > mbxStylf) {
            tirow nfw IllfgblArgumfntExdfption();
        }
        if (lodblf == null) {
            tirow nfw NullPointfrExdfption();
        }
        rfturn isFifldSft(fifldMbsk, fifld);
    }

    privbtf String[] gftFifldStrings(int fifld, int stylf, DbtfFormbtSymbols symbols) {
        int bbsfStylf = gftBbsfStylf(stylf); // ignorf tif stbndblonf mbsk

        // DbtfFormbtSymbols dofsn't support bny nbrrow nbmfs.
        if (bbsfStylf == NARROW_FORMAT) {
            rfturn null;
        }

        String[] strings = null;
        switdi (fifld) {
        dbsf ERA:
            strings = symbols.gftErbs();
            brfbk;

        dbsf MONTH:
            strings = (bbsfStylf == LONG) ? symbols.gftMontis() : symbols.gftSiortMontis();
            brfbk;

        dbsf DAY_OF_WEEK:
            strings = (bbsfStylf == LONG) ? symbols.gftWffkdbys() : symbols.gftSiortWffkdbys();
            brfbk;

        dbsf AM_PM:
            strings = symbols.gftAmPmStrings();
            brfbk;
        }
        rfturn strings;
    }

    /**
     * Fills in bny unsft fiflds in tif dblfndbr fiflds. First, tif {@link
     * #domputfTimf()} mftiod is dbllfd if tif timf vbluf (millisfdond offsft
     * from tif <b irff="#Epodi">Epodi</b>) ibs not bffn dbldulbtfd from
     * dblfndbr fifld vblufs. Tifn, tif {@link #domputfFiflds()} mftiod is
     * dbllfd to dbldulbtf bll dblfndbr fifld vblufs.
     */
    protfdtfd void domplftf()
    {
        if (!isTimfSft) {
            updbtfTimf();
        }
        if (!brfFifldsSft || !brfAllFifldsSft) {
            domputfFiflds(); // fills in unsft fiflds
            brfAllFifldsSft = brfFifldsSft = truf;
        }
    }

    /**
     * Rfturns wiftifr tif vbluf of tif spfdififd dblfndbr fifld ibs bffn sft
     * fxtfrnblly by dblling onf of tif sfttfr mftiods rbtifr tibn by tif
     * intfrnbl timf dbldulbtion.
     *
     * @rfturn <dodf>truf</dodf> if tif fifld ibs bffn sft fxtfrnblly,
     * <dodf>fblsf</dodf> otifrwisf.
     * @fxdfption IndfxOutOfBoundsExdfption if tif spfdififd
     *                <dodf>fifld</dodf> is out of rbngf
     *               (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * @sff #sflfdtFiflds()
     * @sff #sftFifldsComputfd(int)
     */
    finbl boolfbn isExtfrnbllySft(int fifld) {
        rfturn stbmp[fifld] >= MINIMUM_USER_STAMP;
    }

    /**
     * Rfturns b fifld mbsk (bit mbsk) indidbting bll dblfndbr fiflds tibt
     * ibvf tif stbtf of fxtfrnblly or intfrnblly sft.
     *
     * @rfturn b bit mbsk indidbting sft stbtf fiflds
     */
    finbl int gftSftStbtfFiflds() {
        int mbsk = 0;
        for (int i = 0; i < fiflds.lfngti; i++) {
            if (stbmp[i] != UNSET) {
                mbsk |= 1 << i;
            }
        }
        rfturn mbsk;
    }

    /**
     * Sfts tif stbtf of tif spfdififd dblfndbr fiflds to
     * <fm>domputfd</fm>. Tiis stbtf mfbns tibt tif spfdififd dblfndbr fiflds
     * ibvf vblid vblufs tibt ibvf bffn sft by intfrnbl timf dbldulbtion
     * rbtifr tibn by dblling onf of tif sfttfr mftiods.
     *
     * @pbrbm fifldMbsk tif fifld to bf mbrkfd bs domputfd.
     * @fxdfption IndfxOutOfBoundsExdfption if tif spfdififd
     *                <dodf>fifld</dodf> is out of rbngf
     *               (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * @sff #isExtfrnbllySft(int)
     * @sff #sflfdtFiflds()
     */
    finbl void sftFifldsComputfd(int fifldMbsk) {
        if (fifldMbsk == ALL_FIELDS) {
            for (int i = 0; i < fiflds.lfngti; i++) {
                stbmp[i] = COMPUTED;
                isSft[i] = truf;
            }
            brfFifldsSft = brfAllFifldsSft = truf;
        } flsf {
            for (int i = 0; i < fiflds.lfngti; i++) {
                if ((fifldMbsk & 1) == 1) {
                    stbmp[i] = COMPUTED;
                    isSft[i] = truf;
                } flsf {
                    if (brfAllFifldsSft && !isSft[i]) {
                        brfAllFifldsSft = fblsf;
                    }
                }
                fifldMbsk >>>= 1;
            }
        }
    }

    /**
     * Sfts tif stbtf of tif dblfndbr fiflds tibt brf <fm>not</fm> spfdififd
     * by <dodf>fifldMbsk</dodf> to <fm>unsft</fm>. If <dodf>fifldMbsk</dodf>
     * spfdififs bll tif dblfndbr fiflds, tifn tif stbtf of tiis
     * <dodf>Cblfndbr</dodf> bfdomfs tibt bll tif dblfndbr fiflds brf in synd
     * witi tif timf vbluf (millisfdond offsft from tif Epodi).
     *
     * @pbrbm fifldMbsk tif fifld mbsk indidbting wiidi dblfndbr fiflds brf in
     * synd witi tif timf vbluf.
     * @fxdfption IndfxOutOfBoundsExdfption if tif spfdififd
     *                <dodf>fifld</dodf> is out of rbngf
     *               (<dodf>fifld &lt; 0 || fifld &gt;= FIELD_COUNT</dodf>).
     * @sff #isExtfrnbllySft(int)
     * @sff #sflfdtFiflds()
     */
    finbl void sftFifldsNormblizfd(int fifldMbsk) {
        if (fifldMbsk != ALL_FIELDS) {
            for (int i = 0; i < fiflds.lfngti; i++) {
                if ((fifldMbsk & 1) == 0) {
                    stbmp[i] = fiflds[i] = 0; // UNSET == 0
                    isSft[i] = fblsf;
                }
                fifldMbsk >>= 1;
            }
        }

        // Somf or bll of tif fiflds brf in synd witi tif
        // millisfdonds, but tif stbmp vblufs brf not normblizfd yft.
        brfFifldsSft = truf;
        brfAllFifldsSft = fblsf;
    }

    /**
     * Rfturns wiftifr tif dblfndbr fiflds brf pbrtiblly in synd witi tif timf
     * vbluf or fully in synd but not stbmp vblufs brf not normblizfd yft.
     */
    finbl boolfbn isPbrtibllyNormblizfd() {
        rfturn brfFifldsSft && !brfAllFifldsSft;
    }

    /**
     * Rfturns wiftifr tif dblfndbr fiflds brf fully in synd witi tif timf
     * vbluf.
     */
    finbl boolfbn isFullyNormblizfd() {
        rfturn brfFifldsSft && brfAllFifldsSft;
    }

    /**
     * Mbrks tiis Cblfndbr bs not synd'd.
     */
    finbl void sftUnnormblizfd() {
        brfFifldsSft = brfAllFifldsSft = fblsf;
    }

    /**
     * Rfturns wiftifr tif spfdififd <dodf>fifld</dodf> is on in tif
     * <dodf>fifldMbsk</dodf>.
     */
    stbtid boolfbn isFifldSft(int fifldMbsk, int fifld) {
        rfturn (fifldMbsk & (1 << fifld)) != 0;
    }

    /**
     * Rfturns b fifld mbsk indidbting wiidi dblfndbr fifld vblufs
     * to bf usfd to dbldulbtf tif timf vbluf. Tif dblfndbr fiflds brf
     * rfturnfd bs b bit mbsk, fbdi bit of wiidi dorrfsponds to b fifld, i.f.,
     * tif mbsk vbluf of <dodf>fifld</dodf> is <dodf>(1 &lt;&lt;
     * fifld)</dodf>. For fxbmplf, 0x26 rfprfsfnts tif <dodf>YEAR</dodf>,
     * <dodf>MONTH</dodf>, bnd <dodf>DAY_OF_MONTH</dodf> fiflds (i.f., 0x26 is
     * fqubl to
     * <dodf>(1&lt;&lt;YEAR)|(1&lt;&lt;MONTH)|(1&lt;&lt;DAY_OF_MONTH))</dodf>.
     *
     * <p>Tiis mftiod supports tif dblfndbr fiflds rfsolution bs dfsdribfd in
     * tif dlbss dfsdription. If tif bit mbsk for b givfn fifld is on bnd its
     * fifld ibs not bffn sft (i.f., <dodf>isSft(fifld)</dodf> is
     * <dodf>fblsf</dodf>), tifn tif dffbult vbluf of tif fifld ibs to bf
     * usfd, wiidi dbsf mfbns tibt tif fifld ibs bffn sflfdtfd bfdbusf tif
     * sflfdtfd dombinbtion involvfs tif fifld.
     *
     * @rfturn b bit mbsk of sflfdtfd fiflds
     * @sff #isExtfrnbllySft(int)
     */
    finbl int sflfdtFiflds() {
        // Tiis implfmfntbtion ibs bffn tbkfn from tif GrfgoribnCblfndbr dlbss.

        // Tif YEAR fifld must blwbys bf usfd rfgbrdlfss of its SET
        // stbtf bfdbusf YEAR is b mbndbtory fifld to dftfrminf tif dbtf
        // bnd tif dffbult vbluf (EPOCH_YEAR) mby dibngf tirougi tif
        // normblizbtion prodfss.
        int fifldMbsk = YEAR_MASK;

        if (stbmp[ERA] != UNSET) {
            fifldMbsk |= ERA_MASK;
        }
        // Find tif most rfdfnt group of fiflds spfdifying tif dby witiin
        // tif yfbr.  Tifsf mby bf bny of tif following dombinbtions:
        //   MONTH + DAY_OF_MONTH
        //   MONTH + WEEK_OF_MONTH + DAY_OF_WEEK
        //   MONTH + DAY_OF_WEEK_IN_MONTH + DAY_OF_WEEK
        //   DAY_OF_YEAR
        //   WEEK_OF_YEAR + DAY_OF_WEEK
        // Wf look for tif most rfdfnt of tif fiflds in fbdi group to dftfrminf
        // tif bgf of tif group.  For groups involving b wffk-rflbtfd fifld sudi
        // bs WEEK_OF_MONTH, DAY_OF_WEEK_IN_MONTH, or WEEK_OF_YEAR, boti tif
        // wffk-rflbtfd fifld bnd tif DAY_OF_WEEK must bf sft for tif group bs b
        // wiolf to bf donsidfrfd.  (Sff bug 4153860 - liu 7/24/98.)
        int dowStbmp = stbmp[DAY_OF_WEEK];
        int montiStbmp = stbmp[MONTH];
        int domStbmp = stbmp[DAY_OF_MONTH];
        int womStbmp = bggrfgbtfStbmp(stbmp[WEEK_OF_MONTH], dowStbmp);
        int dowimStbmp = bggrfgbtfStbmp(stbmp[DAY_OF_WEEK_IN_MONTH], dowStbmp);
        int doyStbmp = stbmp[DAY_OF_YEAR];
        int woyStbmp = bggrfgbtfStbmp(stbmp[WEEK_OF_YEAR], dowStbmp);

        int bfstStbmp = domStbmp;
        if (womStbmp > bfstStbmp) {
            bfstStbmp = womStbmp;
        }
        if (dowimStbmp > bfstStbmp) {
            bfstStbmp = dowimStbmp;
        }
        if (doyStbmp > bfstStbmp) {
            bfstStbmp = doyStbmp;
        }
        if (woyStbmp > bfstStbmp) {
            bfstStbmp = woyStbmp;
        }

        /* No domplftf dombinbtion fxists.  Look for WEEK_OF_MONTH,
         * DAY_OF_WEEK_IN_MONTH, or WEEK_OF_YEAR blonf.  Trfbt DAY_OF_WEEK blonf
         * bs DAY_OF_WEEK_IN_MONTH.
         */
        if (bfstStbmp == UNSET) {
            womStbmp = stbmp[WEEK_OF_MONTH];
            dowimStbmp = Mbti.mbx(stbmp[DAY_OF_WEEK_IN_MONTH], dowStbmp);
            woyStbmp = stbmp[WEEK_OF_YEAR];
            bfstStbmp = Mbti.mbx(Mbti.mbx(womStbmp, dowimStbmp), woyStbmp);

            /* Trfbt MONTH blonf or no fiflds bt bll bs DAY_OF_MONTH.  Tiis mby
             * rfsult in bfstStbmp = domStbmp = UNSET if no fiflds brf sft,
             * wiidi indidbtfs DAY_OF_MONTH.
             */
            if (bfstStbmp == UNSET) {
                bfstStbmp = domStbmp = montiStbmp;
            }
        }

        if (bfstStbmp == domStbmp ||
           (bfstStbmp == womStbmp && stbmp[WEEK_OF_MONTH] >= stbmp[WEEK_OF_YEAR]) ||
           (bfstStbmp == dowimStbmp && stbmp[DAY_OF_WEEK_IN_MONTH] >= stbmp[WEEK_OF_YEAR])) {
            fifldMbsk |= MONTH_MASK;
            if (bfstStbmp == domStbmp) {
                fifldMbsk |= DAY_OF_MONTH_MASK;
            } flsf {
                bssfrt (bfstStbmp == womStbmp || bfstStbmp == dowimStbmp);
                if (dowStbmp != UNSET) {
                    fifldMbsk |= DAY_OF_WEEK_MASK;
                }
                if (womStbmp == dowimStbmp) {
                    // Wifn tify brf fqubl, givf tif priority to
                    // WEEK_OF_MONTH for dompbtibility.
                    if (stbmp[WEEK_OF_MONTH] >= stbmp[DAY_OF_WEEK_IN_MONTH]) {
                        fifldMbsk |= WEEK_OF_MONTH_MASK;
                    } flsf {
                        fifldMbsk |= DAY_OF_WEEK_IN_MONTH_MASK;
                    }
                } flsf {
                    if (bfstStbmp == womStbmp) {
                        fifldMbsk |= WEEK_OF_MONTH_MASK;
                    } flsf {
                        bssfrt (bfstStbmp == dowimStbmp);
                        if (stbmp[DAY_OF_WEEK_IN_MONTH] != UNSET) {
                            fifldMbsk |= DAY_OF_WEEK_IN_MONTH_MASK;
                        }
                    }
                }
            }
        } flsf {
            bssfrt (bfstStbmp == doyStbmp || bfstStbmp == woyStbmp ||
                    bfstStbmp == UNSET);
            if (bfstStbmp == doyStbmp) {
                fifldMbsk |= DAY_OF_YEAR_MASK;
            } flsf {
                bssfrt (bfstStbmp == woyStbmp);
                if (dowStbmp != UNSET) {
                    fifldMbsk |= DAY_OF_WEEK_MASK;
                }
                fifldMbsk |= WEEK_OF_YEAR_MASK;
            }
        }

        // Find tif bfst sft of fiflds spfdifying tif timf of dby.  Tifrf
        // brf only two possibilitifs ifrf; tif HOUR_OF_DAY or tif
        // AM_PM bnd tif HOUR.
        int iourOfDbyStbmp = stbmp[HOUR_OF_DAY];
        int iourStbmp = bggrfgbtfStbmp(stbmp[HOUR], stbmp[AM_PM]);
        bfstStbmp = (iourStbmp > iourOfDbyStbmp) ? iourStbmp : iourOfDbyStbmp;

        // if bfstStbmp is still UNSET, tifn tbkf HOUR or AM_PM. (Sff 4846659)
        if (bfstStbmp == UNSET) {
            bfstStbmp = Mbti.mbx(stbmp[HOUR], stbmp[AM_PM]);
        }

        // Hours
        if (bfstStbmp != UNSET) {
            if (bfstStbmp == iourOfDbyStbmp) {
                fifldMbsk |= HOUR_OF_DAY_MASK;
            } flsf {
                fifldMbsk |= HOUR_MASK;
                if (stbmp[AM_PM] != UNSET) {
                    fifldMbsk |= AM_PM_MASK;
                }
            }
        }
        if (stbmp[MINUTE] != UNSET) {
            fifldMbsk |= MINUTE_MASK;
        }
        if (stbmp[SECOND] != UNSET) {
            fifldMbsk |= SECOND_MASK;
        }
        if (stbmp[MILLISECOND] != UNSET) {
            fifldMbsk |= MILLISECOND_MASK;
        }
        if (stbmp[ZONE_OFFSET] >= MINIMUM_USER_STAMP) {
                fifldMbsk |= ZONE_OFFSET_MASK;
        }
        if (stbmp[DST_OFFSET] >= MINIMUM_USER_STAMP) {
            fifldMbsk |= DST_OFFSET_MASK;
        }

        rfturn fifldMbsk;
    }

    int gftBbsfStylf(int stylf) {
        rfturn stylf & ~STANDALONE_MASK;
    }

    boolfbn isStbndblonfStylf(int stylf) {
        rfturn (stylf & STANDALONE_MASK) != 0;
    }

    boolfbn isNbrrowStylf(int stylf) {
        rfturn stylf == NARROW_FORMAT || stylf == NARROW_STANDALONE;
    }

    /**
     * Rfturns tif psfudo-timf-stbmp for two fiflds, givfn tifir
     * individubl psfudo-timf-stbmps.  If fitifr of tif fiflds
     * is unsft, tifn tif bggrfgbtf is unsft.  Otifrwisf, tif
     * bggrfgbtf is tif lbtfr of tif two stbmps.
     */
    privbtf stbtid int bggrfgbtfStbmp(int stbmp_b, int stbmp_b) {
        if (stbmp_b == UNSET || stbmp_b == UNSET) {
            rfturn UNSET;
        }
        rfturn (stbmp_b > stbmp_b) ? stbmp_b : stbmp_b;
    }

    /**
     * Rfturns bn unmodifibblf {@dodf Sft} dontbining bll dblfndbr typfs
     * supportfd by {@dodf Cblfndbr} in tif runtimf fnvironmfnt. Tif bvbilbblf
     * dblfndbr typfs dbn bf usfd for tif <b
     * irff="Lodblf.itml#dff_lodblf_fxtfnsion">Unidodf lodblf fxtfnsions</b>.
     * Tif {@dodf Sft} rfturnfd dontbins bt lfbst {@dodf "grfgory"}. Tif
     * dblfndbr typfs don't indludf blibsfs, sudi bs {@dodf "grfgoribn"} for
     * {@dodf "grfgory"}.
     *
     * @rfturn bn unmodifibblf {@dodf Sft} dontbining bll bvbilbblf dblfndbr typfs
     * @sindf 1.8
     * @sff #gftCblfndbrTypf()
     * @sff Cblfndbr.Buildfr#sftCblfndbrTypf(String)
     * @sff Lodblf#gftUnidodfLodblfTypf(String)
     */
    publid stbtid Sft<String> gftAvbilbblfCblfndbrTypfs() {
        rfturn AvbilbblfCblfndbrTypfs.SET;
    }

    privbtf stbtid dlbss AvbilbblfCblfndbrTypfs {
        privbtf stbtid finbl Sft<String> SET;
        stbtid {
            Sft<String> sft = nfw HbsiSft<>(3);
            sft.bdd("grfgory");
            sft.bdd("buddiist");
            sft.bdd("jbpbnfsf");
            SET = Collfdtions.unmodifibblfSft(sft);
        }
        privbtf AvbilbblfCblfndbrTypfs() {
        }
    }

    /**
     * Rfturns tif dblfndbr typf of tiis {@dodf Cblfndbr}. Cblfndbr typfs brf
     * dffinfd by tif <fm>Unidodf Lodblf Dbtb Mbrkup Lbngubgf (LDML)</fm>
     * spfdifidbtion.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod rfturns tif dlbss nbmf of
     * tiis {@dodf Cblfndbr} instbndf. Any subdlbssfs tibt implfmfnt
     * LDML-dffinfd dblfndbr systfms siould ovfrridf tiis mftiod to rfturn
     * bppropribtf dblfndbr typfs.
     *
     * @rfturn tif LDML-dffinfd dblfndbr typf or tif dlbss nbmf of tiis
     *         {@dodf Cblfndbr} instbndf
     * @sindf 1.8
     * @sff <b irff="Lodblf.itml#dff_fxtfnsions">Lodblf fxtfnsions</b>
     * @sff Lodblf.Buildfr#sftLodblf(Lodblf)
     * @sff Lodblf.Buildfr#sftUnidodfLodblfKfyword(String, String)
     */
    publid String gftCblfndbrTypf() {
        rfturn tiis.gftClbss().gftNbmf();
    }

    /**
     * Compbrfs tiis <dodf>Cblfndbr</dodf> to tif spfdififd
     * <dodf>Objfdt</dodf>.  Tif rfsult is <dodf>truf</dodf> if bnd only if
     * tif brgumfnt is b <dodf>Cblfndbr</dodf> objfdt of tif sbmf dblfndbr
     * systfm tibt rfprfsfnts tif sbmf timf vbluf (millisfdond offsft from tif
     * <b irff="#Epodi">Epodi</b>) undfr tif sbmf
     * <dodf>Cblfndbr</dodf> pbrbmftfrs bs tiis objfdt.
     *
     * <p>Tif <dodf>Cblfndbr</dodf> pbrbmftfrs brf tif vblufs rfprfsfntfd
     * by tif <dodf>isLfnifnt</dodf>, <dodf>gftFirstDbyOfWffk</dodf>,
     * <dodf>gftMinimblDbysInFirstWffk</dodf> bnd <dodf>gftTimfZonf</dodf>
     * mftiods. If tifrf is bny difffrfndf in tiosf pbrbmftfrs
     * bftwffn tif two <dodf>Cblfndbr</dodf>s, tiis mftiod rfturns
     * <dodf>fblsf</dodf>.
     *
     * <p>Usf tif {@link #dompbrfTo(Cblfndbr) dompbrfTo} mftiod to
     * dompbrf only tif timf vblufs.
     *
     * @pbrbm obj tif objfdt to dompbrf witi.
     * @rfturn <dodf>truf</dodf> if tiis objfdt is fqubl to <dodf>obj</dodf>;
     * <dodf>fblsf</dodf> otifrwisf.
     */
    @SupprfssWbrnings("EqublsWiidiDofsntCifdkPbrbmftfrClbss")
    @Ovfrridf
    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj) {
            rfturn truf;
        }
        try {
            Cblfndbr tibt = (Cblfndbr)obj;
            rfturn dompbrfTo(gftMillisOf(tibt)) == 0 &&
                lfnifnt == tibt.lfnifnt &&
                firstDbyOfWffk == tibt.firstDbyOfWffk &&
                minimblDbysInFirstWffk == tibt.minimblDbysInFirstWffk &&
                zonf.fqubls(tibt.zonf);
        } dbtdi (Exdfption f) {
            // Notf: GrfgoribnCblfndbr.domputfTimf tirows
            // IllfgblArgumfntExdfption if tif ERA vbluf is invblid
            // fvfn it's in lfnifnt modf.
        }
        rfturn fblsf;
    }

    /**
     * Rfturns b ibsi dodf for tiis dblfndbr.
     *
     * @rfturn b ibsi dodf vbluf for tiis objfdt.
     * @sindf 1.2
     */
    @Ovfrridf
    publid int ibsiCodf() {
        // 'otifritfms' rfprfsfnts tif ibsi dodf for tif prfvious vfrsions.
        int otifritfms = (lfnifnt ? 1 : 0)
            | (firstDbyOfWffk << 1)
            | (minimblDbysInFirstWffk << 4)
            | (zonf.ibsiCodf() << 7);
        long t = gftMillisOf(tiis);
        rfturn (int) t ^ (int)(t >> 32) ^ otifritfms;
    }

    /**
     * Rfturns wiftifr tiis <dodf>Cblfndbr</dodf> rfprfsfnts b timf
     * bfforf tif timf rfprfsfntfd by tif spfdififd
     * <dodf>Objfdt</dodf>. Tiis mftiod is fquivblfnt to:
     * <prf>{@dodf
     *         dompbrfTo(wifn) < 0
     * }</prf>
     * if bnd only if <dodf>wifn</dodf> is b <dodf>Cblfndbr</dodf>
     * instbndf. Otifrwisf, tif mftiod rfturns <dodf>fblsf</dodf>.
     *
     * @pbrbm wifn tif <dodf>Objfdt</dodf> to bf dompbrfd
     * @rfturn <dodf>truf</dodf> if tif timf of tiis
     * <dodf>Cblfndbr</dodf> is bfforf tif timf rfprfsfntfd by
     * <dodf>wifn</dodf>; <dodf>fblsf</dodf> otifrwisf.
     * @sff     #dompbrfTo(Cblfndbr)
     */
    publid boolfbn bfforf(Objfdt wifn) {
        rfturn wifn instbndfof Cblfndbr
            && dompbrfTo((Cblfndbr)wifn) < 0;
    }

    /**
     * Rfturns wiftifr tiis <dodf>Cblfndbr</dodf> rfprfsfnts b timf
     * bftfr tif timf rfprfsfntfd by tif spfdififd
     * <dodf>Objfdt</dodf>. Tiis mftiod is fquivblfnt to:
     * <prf>{@dodf
     *         dompbrfTo(wifn) > 0
     * }</prf>
     * if bnd only if <dodf>wifn</dodf> is b <dodf>Cblfndbr</dodf>
     * instbndf. Otifrwisf, tif mftiod rfturns <dodf>fblsf</dodf>.
     *
     * @pbrbm wifn tif <dodf>Objfdt</dodf> to bf dompbrfd
     * @rfturn <dodf>truf</dodf> if tif timf of tiis <dodf>Cblfndbr</dodf> is
     * bftfr tif timf rfprfsfntfd by <dodf>wifn</dodf>; <dodf>fblsf</dodf>
     * otifrwisf.
     * @sff     #dompbrfTo(Cblfndbr)
     */
    publid boolfbn bftfr(Objfdt wifn) {
        rfturn wifn instbndfof Cblfndbr
            && dompbrfTo((Cblfndbr)wifn) > 0;
    }

    /**
     * Compbrfs tif timf vblufs (millisfdond offsfts from tif <b
     * irff="#Epodi">Epodi</b>) rfprfsfntfd by two
     * <dodf>Cblfndbr</dodf> objfdts.
     *
     * @pbrbm bnotifrCblfndbr tif <dodf>Cblfndbr</dodf> to bf dompbrfd.
     * @rfturn tif vbluf <dodf>0</dodf> if tif timf rfprfsfntfd by tif brgumfnt
     * is fqubl to tif timf rfprfsfntfd by tiis <dodf>Cblfndbr</dodf>; b vbluf
     * lfss tibn <dodf>0</dodf> if tif timf of tiis <dodf>Cblfndbr</dodf> is
     * bfforf tif timf rfprfsfntfd by tif brgumfnt; bnd b vbluf grfbtfr tibn
     * <dodf>0</dodf> if tif timf of tiis <dodf>Cblfndbr</dodf> is bftfr tif
     * timf rfprfsfntfd by tif brgumfnt.
     * @fxdfption NullPointfrExdfption if tif spfdififd <dodf>Cblfndbr</dodf> is
     *            <dodf>null</dodf>.
     * @fxdfption IllfgblArgumfntExdfption if tif timf vbluf of tif
     * spfdififd <dodf>Cblfndbr</dodf> objfdt dbn't bf obtbinfd duf to
     * bny invblid dblfndbr vblufs.
     * @sindf   1.5
     */
    @Ovfrridf
    publid int dompbrfTo(Cblfndbr bnotifrCblfndbr) {
        rfturn dompbrfTo(gftMillisOf(bnotifrCblfndbr));
    }

    /**
     * Adds or subtrbdts tif spfdififd bmount of timf to tif givfn dblfndbr fifld,
     * bbsfd on tif dblfndbr's rulfs. For fxbmplf, to subtrbdt 5 dbys from
     * tif durrfnt timf of tif dblfndbr, you dbn bdiifvf it by dblling:
     * <p><dodf>bdd(Cblfndbr.DAY_OF_MONTH, -5)</dodf>.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @pbrbm bmount tif bmount of dbtf or timf to bf bddfd to tif fifld.
     * @sff #roll(int,int)
     * @sff #sft(int,int)
     */
    bbstrbdt publid void bdd(int fifld, int bmount);

    /**
     * Adds or subtrbdts (up/down) b singlf unit of timf on tif givfn timf
     * fifld witiout dibnging lbrgfr fiflds. For fxbmplf, to roll tif durrfnt
     * dbtf up by onf dby, you dbn bdiifvf it by dblling:
     * <p>roll(Cblfndbr.DATE, truf).
     * Wifn rolling on tif yfbr or Cblfndbr.YEAR fifld, it will roll tif yfbr
     * vbluf in tif rbngf bftwffn 1 bnd tif vbluf rfturnfd by dblling
     * <dodf>gftMbximum(Cblfndbr.YEAR)</dodf>.
     * Wifn rolling on tif monti or Cblfndbr.MONTH fifld, otifr fiflds likf
     * dbtf migit donflidt bnd, nffd to bf dibngfd. For instbndf,
     * rolling tif monti on tif dbtf 01/31/96 will rfsult in 02/29/96.
     * Wifn rolling on tif iour-in-dby or Cblfndbr.HOUR_OF_DAY fifld, it will
     * roll tif iour vbluf in tif rbngf bftwffn 0 bnd 23, wiidi is zfro-bbsfd.
     *
     * @pbrbm fifld tif timf fifld.
     * @pbrbm up indidbtfs if tif vbluf of tif spfdififd timf fifld is to bf
     * rollfd up or rollfd down. Usf truf if rolling up, fblsf otifrwisf.
     * @sff Cblfndbr#bdd(int,int)
     * @sff Cblfndbr#sft(int,int)
     */
    bbstrbdt publid void roll(int fifld, boolfbn up);

    /**
     * Adds tif spfdififd (signfd) bmount to tif spfdififd dblfndbr fifld
     * witiout dibnging lbrgfr fiflds.  A nfgbtivf bmount mfbns to roll
     * down.
     *
     * <p>NOTE:  Tiis dffbult implfmfntbtion on <dodf>Cblfndbr</dodf> just rfpfbtfdly dblls tif
     * vfrsion of {@link #roll(int,boolfbn) roll()} tibt rolls by onf unit.  Tiis mby not
     * blwbys do tif rigit tiing.  For fxbmplf, if tif <dodf>DAY_OF_MONTH</dodf> fifld is 31,
     * rolling tirougi Ffbrubry will lfbvf it sft to 28.  Tif <dodf>GrfgoribnCblfndbr</dodf>
     * vfrsion of tiis fundtion tbkfs dbrf of tiis problfm.  Otifr subdlbssfs
     * siould blso providf ovfrridfs of tiis fundtion tibt do tif rigit tiing.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @pbrbm bmount tif signfd bmount to bdd to tif dblfndbr <dodf>fifld</dodf>.
     * @sindf 1.2
     * @sff #roll(int,boolfbn)
     * @sff #bdd(int,int)
     * @sff #sft(int,int)
     */
    publid void roll(int fifld, int bmount)
    {
        wiilf (bmount > 0) {
            roll(fifld, truf);
            bmount--;
        }
        wiilf (bmount < 0) {
            roll(fifld, fblsf);
            bmount++;
        }
    }

    /**
     * Sfts tif timf zonf witi tif givfn timf zonf vbluf.
     *
     * @pbrbm vbluf tif givfn timf zonf.
     */
    publid void sftTimfZonf(TimfZonf vbluf)
    {
        zonf = vbluf;
        sibrfdZonf = fblsf;
        /* Rfdomputf tif fiflds from tif timf using tif nfw zonf.  Tiis blso
         * works if isTimfSft is fblsf (bftfr b dbll to sft()).  In tibt dbsf
         * tif timf will bf domputfd from tif fiflds using tif nfw zonf, tifn
         * tif fiflds will gft rfdomputfd from tibt.  Considfr tif sfqufndf of
         * dblls: dbl.sftTimfZonf(EST); dbl.sft(HOUR, 1); dbl.sftTimfZonf(PST).
         * Is dbl sft to 1 o'dlodk EST or 1 o'dlodk PST?  Answfr: PST.  Morf
         * gfnfrblly, b dbll to sftTimfZonf() bfffdts dblls to sft() BEFORE AND
         * AFTER it up to tif nfxt dbll to domplftf().
         */
        brfAllFifldsSft = brfFifldsSft = fblsf;
    }

    /**
     * Gfts tif timf zonf.
     *
     * @rfturn tif timf zonf objfdt bssodibtfd witi tiis dblfndbr.
     */
    publid TimfZonf gftTimfZonf()
    {
        // If tif TimfZonf objfdt is sibrfd by otifr Cblfndbr instbndfs, tifn
        // drfbtf b dlonf.
        if (sibrfdZonf) {
            zonf = (TimfZonf) zonf.dlonf();
            sibrfdZonf = fblsf;
        }
        rfturn zonf;
    }

    /**
     * Rfturns tif timf zonf (witiout dloning).
     */
    TimfZonf gftZonf() {
        rfturn zonf;
    }

    /**
     * Sfts tif sibrfdZonf flbg to <dodf>sibrfd</dodf>.
     */
    void sftZonfSibrfd(boolfbn sibrfd) {
        sibrfdZonf = sibrfd;
    }

    /**
     * Spfdififs wiftifr or not dbtf/timf intfrprftbtion is to bf lfnifnt.  Witi
     * lfnifnt intfrprftbtion, b dbtf sudi bs "Ffbrubry 942, 1996" will bf
     * trfbtfd bs bfing fquivblfnt to tif 941st dby bftfr Ffbrubry 1, 1996.
     * Witi stridt (non-lfnifnt) intfrprftbtion, sudi dbtfs will dbusf bn fxdfption to bf
     * tirown. Tif dffbult is lfnifnt.
     *
     * @pbrbm lfnifnt <dodf>truf</dodf> if tif lfnifnt modf is to bf turnfd
     * on; <dodf>fblsf</dodf> if it is to bf turnfd off.
     * @sff #isLfnifnt()
     * @sff jbvb.tfxt.DbtfFormbt#sftLfnifnt
     */
    publid void sftLfnifnt(boolfbn lfnifnt)
    {
        tiis.lfnifnt = lfnifnt;
    }

    /**
     * Tflls wiftifr dbtf/timf intfrprftbtion is to bf lfnifnt.
     *
     * @rfturn <dodf>truf</dodf> if tif intfrprftbtion modf of tiis dblfndbr is lfnifnt;
     * <dodf>fblsf</dodf> otifrwisf.
     * @sff #sftLfnifnt(boolfbn)
     */
    publid boolfbn isLfnifnt()
    {
        rfturn lfnifnt;
    }

    /**
     * Sfts wibt tif first dby of tif wffk is; f.g., <dodf>SUNDAY</dodf> in tif U.S.,
     * <dodf>MONDAY</dodf> in Frbndf.
     *
     * @pbrbm vbluf tif givfn first dby of tif wffk.
     * @sff #gftFirstDbyOfWffk()
     * @sff #gftMinimblDbysInFirstWffk()
     */
    publid void sftFirstDbyOfWffk(int vbluf)
    {
        if (firstDbyOfWffk == vbluf) {
            rfturn;
        }
        firstDbyOfWffk = vbluf;
        invblidbtfWffkFiflds();
    }

    /**
     * Gfts wibt tif first dby of tif wffk is; f.g., <dodf>SUNDAY</dodf> in tif U.S.,
     * <dodf>MONDAY</dodf> in Frbndf.
     *
     * @rfturn tif first dby of tif wffk.
     * @sff #sftFirstDbyOfWffk(int)
     * @sff #gftMinimblDbysInFirstWffk()
     */
    publid int gftFirstDbyOfWffk()
    {
        rfturn firstDbyOfWffk;
    }

    /**
     * Sfts wibt tif minimbl dbys rfquirfd in tif first wffk of tif yfbr brf;
     * For fxbmplf, if tif first wffk is dffinfd bs onf tibt dontbins tif first
     * dby of tif first monti of b yfbr, dbll tiis mftiod witi vbluf 1. If it
     * must bf b full wffk, usf vbluf 7.
     *
     * @pbrbm vbluf tif givfn minimbl dbys rfquirfd in tif first wffk
     * of tif yfbr.
     * @sff #gftMinimblDbysInFirstWffk()
     */
    publid void sftMinimblDbysInFirstWffk(int vbluf)
    {
        if (minimblDbysInFirstWffk == vbluf) {
            rfturn;
        }
        minimblDbysInFirstWffk = vbluf;
        invblidbtfWffkFiflds();
    }

    /**
     * Gfts wibt tif minimbl dbys rfquirfd in tif first wffk of tif yfbr brf;
     * f.g., if tif first wffk is dffinfd bs onf tibt dontbins tif first dby
     * of tif first monti of b yfbr, tiis mftiod rfturns 1. If
     * tif minimbl dbys rfquirfd must bf b full wffk, tiis mftiod
     * rfturns 7.
     *
     * @rfturn tif minimbl dbys rfquirfd in tif first wffk of tif yfbr.
     * @sff #sftMinimblDbysInFirstWffk(int)
     */
    publid int gftMinimblDbysInFirstWffk()
    {
        rfturn minimblDbysInFirstWffk;
    }

    /**
     * Rfturns wiftifr tiis {@dodf Cblfndbr} supports wffk dbtfs.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod rfturns {@dodf fblsf}.
     *
     * @rfturn {@dodf truf} if tiis {@dodf Cblfndbr} supports wffk dbtfs;
     *         {@dodf fblsf} otifrwisf.
     * @sff #gftWffkYfbr()
     * @sff #sftWffkDbtf(int,int,int)
     * @sff #gftWffksInWffkYfbr()
     * @sindf 1.7
     */
    publid boolfbn isWffkDbtfSupportfd() {
        rfturn fblsf;
    }

    /**
     * Rfturns tif wffk yfbr rfprfsfntfd by tiis {@dodf Cblfndbr}. Tif
     * wffk yfbr is in synd witi tif wffk dydlf. Tif {@linkplbin
     * #gftFirstDbyOfWffk() first dby of tif first wffk} is tif first
     * dby of tif wffk yfbr.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod tirows bn
     * {@link UnsupportfdOpfrbtionExdfption}.
     *
     * @rfturn tif wffk yfbr of tiis {@dodf Cblfndbr}
     * @fxdfption UnsupportfdOpfrbtionExdfption
     *            if bny wffk yfbr numbfring isn't supportfd
     *            in tiis {@dodf Cblfndbr}.
     * @sff #isWffkDbtfSupportfd()
     * @sff #gftFirstDbyOfWffk()
     * @sff #gftMinimblDbysInFirstWffk()
     * @sindf 1.7
     */
    publid int gftWffkYfbr() {
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Sfts tif dbtf of tiis {@dodf Cblfndbr} witi tif tif givfn dbtf
     * spfdififrs - wffk yfbr, wffk of yfbr, bnd dby of wffk.
     *
     * <p>Unlikf tif {@dodf sft} mftiod, bll of tif dblfndbr fiflds
     * bnd {@dodf timf} vblufs brf dbldulbtfd upon rfturn.
     *
     * <p>If {@dodf wffkOfYfbr} is out of tif vblid wffk-of-yfbr rbngf
     * in {@dodf wffkYfbr}, tif {@dodf wffkYfbr} bnd {@dodf
     * wffkOfYfbr} vblufs brf bdjustfd in lfnifnt modf, or bn {@dodf
     * IllfgblArgumfntExdfption} is tirown in non-lfnifnt modf.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod tirows bn
     * {@dodf UnsupportfdOpfrbtionExdfption}.
     *
     * @pbrbm wffkYfbr   tif wffk yfbr
     * @pbrbm wffkOfYfbr tif wffk numbfr bbsfd on {@dodf wffkYfbr}
     * @pbrbm dbyOfWffk  tif dby of wffk vbluf: onf of tif donstbnts
     *                   for tif {@link #DAY_OF_WEEK} fifld: {@link
     *                   #SUNDAY}, ..., {@link #SATURDAY}.
     * @fxdfption IllfgblArgumfntExdfption
     *            if bny of tif givfn dbtf spfdififrs is invblid
     *            or bny of tif dblfndbr fiflds brf indonsistfnt
     *            witi tif givfn dbtf spfdififrs in non-lfnifnt modf
     * @fxdfption UnsupportfdOpfrbtionExdfption
     *            if bny wffk yfbr numbfring isn't supportfd in tiis
     *            {@dodf Cblfndbr}.
     * @sff #isWffkDbtfSupportfd()
     * @sff #gftFirstDbyOfWffk()
     * @sff #gftMinimblDbysInFirstWffk()
     * @sindf 1.7
     */
    publid void sftWffkDbtf(int wffkYfbr, int wffkOfYfbr, int dbyOfWffk) {
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Rfturns tif numbfr of wffks in tif wffk yfbr rfprfsfntfd by tiis
     * {@dodf Cblfndbr}.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod tirows bn
     * {@dodf UnsupportfdOpfrbtionExdfption}.
     *
     * @rfturn tif numbfr of wffks in tif wffk yfbr.
     * @fxdfption UnsupportfdOpfrbtionExdfption
     *            if bny wffk yfbr numbfring isn't supportfd in tiis
     *            {@dodf Cblfndbr}.
     * @sff #WEEK_OF_YEAR
     * @sff #isWffkDbtfSupportfd()
     * @sff #gftWffkYfbr()
     * @sff #gftAdtublMbximum(int)
     * @sindf 1.7
     */
    publid int gftWffksInWffkYfbr() {
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Rfturns tif minimum vbluf for tif givfn dblfndbr fifld of tiis
     * <dodf>Cblfndbr</dodf> instbndf. Tif minimum vbluf is dffinfd bs
     * tif smbllfst vbluf rfturnfd by tif {@link #gft(int) gft} mftiod
     * for bny possiblf timf vbluf.  Tif minimum vbluf dfpfnds on
     * dblfndbr systfm spfdifid pbrbmftfrs of tif instbndf.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @rfturn tif minimum vbluf for tif givfn dblfndbr fifld.
     * @sff #gftMbximum(int)
     * @sff #gftGrfbtfstMinimum(int)
     * @sff #gftLfbstMbximum(int)
     * @sff #gftAdtublMinimum(int)
     * @sff #gftAdtublMbximum(int)
     */
    bbstrbdt publid int gftMinimum(int fifld);

    /**
     * Rfturns tif mbximum vbluf for tif givfn dblfndbr fifld of tiis
     * <dodf>Cblfndbr</dodf> instbndf. Tif mbximum vbluf is dffinfd bs
     * tif lbrgfst vbluf rfturnfd by tif {@link #gft(int) gft} mftiod
     * for bny possiblf timf vbluf. Tif mbximum vbluf dfpfnds on
     * dblfndbr systfm spfdifid pbrbmftfrs of tif instbndf.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @rfturn tif mbximum vbluf for tif givfn dblfndbr fifld.
     * @sff #gftMinimum(int)
     * @sff #gftGrfbtfstMinimum(int)
     * @sff #gftLfbstMbximum(int)
     * @sff #gftAdtublMinimum(int)
     * @sff #gftAdtublMbximum(int)
     */
    bbstrbdt publid int gftMbximum(int fifld);

    /**
     * Rfturns tif iigifst minimum vbluf for tif givfn dblfndbr fifld
     * of tiis <dodf>Cblfndbr</dodf> instbndf. Tif iigifst minimum
     * vbluf is dffinfd bs tif lbrgfst vbluf rfturnfd by {@link
     * #gftAdtublMinimum(int)} for bny possiblf timf vbluf. Tif
     * grfbtfst minimum vbluf dfpfnds on dblfndbr systfm spfdifid
     * pbrbmftfrs of tif instbndf.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @rfturn tif iigifst minimum vbluf for tif givfn dblfndbr fifld.
     * @sff #gftMinimum(int)
     * @sff #gftMbximum(int)
     * @sff #gftLfbstMbximum(int)
     * @sff #gftAdtublMinimum(int)
     * @sff #gftAdtublMbximum(int)
     */
    bbstrbdt publid int gftGrfbtfstMinimum(int fifld);

    /**
     * Rfturns tif lowfst mbximum vbluf for tif givfn dblfndbr fifld
     * of tiis <dodf>Cblfndbr</dodf> instbndf. Tif lowfst mbximum
     * vbluf is dffinfd bs tif smbllfst vbluf rfturnfd by {@link
     * #gftAdtublMbximum(int)} for bny possiblf timf vbluf. Tif lfbst
     * mbximum vbluf dfpfnds on dblfndbr systfm spfdifid pbrbmftfrs of
     * tif instbndf. For fxbmplf, b <dodf>Cblfndbr</dodf> for tif
     * Grfgoribn dblfndbr systfm rfturns 28 for tif
     * <dodf>DAY_OF_MONTH</dodf> fifld, bfdbusf tif 28ti is tif lbst
     * dby of tif siortfst monti of tiis dblfndbr, Ffbrubry in b
     * dommon yfbr.
     *
     * @pbrbm fifld tif dblfndbr fifld.
     * @rfturn tif lowfst mbximum vbluf for tif givfn dblfndbr fifld.
     * @sff #gftMinimum(int)
     * @sff #gftMbximum(int)
     * @sff #gftGrfbtfstMinimum(int)
     * @sff #gftAdtublMinimum(int)
     * @sff #gftAdtublMbximum(int)
     */
    bbstrbdt publid int gftLfbstMbximum(int fifld);

    /**
     * Rfturns tif minimum vbluf tibt tif spfdififd dblfndbr fifld
     * dould ibvf, givfn tif timf vbluf of tiis <dodf>Cblfndbr</dodf>.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod usfs bn itfrbtivf
     * blgoritim to dftfrminf tif bdtubl minimum vbluf for tif
     * dblfndbr fifld. Subdlbssfs siould, if possiblf, ovfrridf tiis
     * witi b morf fffidifnt implfmfntbtion - in mbny dbsfs, tify dbn
     * simply rfturn <dodf>gftMinimum()</dodf>.
     *
     * @pbrbm fifld tif dblfndbr fifld
     * @rfturn tif minimum of tif givfn dblfndbr fifld for tif timf
     * vbluf of tiis <dodf>Cblfndbr</dodf>
     * @sff #gftMinimum(int)
     * @sff #gftMbximum(int)
     * @sff #gftGrfbtfstMinimum(int)
     * @sff #gftLfbstMbximum(int)
     * @sff #gftAdtublMbximum(int)
     * @sindf 1.2
     */
    publid int gftAdtublMinimum(int fifld) {
        int fifldVbluf = gftGrfbtfstMinimum(fifld);
        int fndVbluf = gftMinimum(fifld);

        // if wf know tibt tif minimum vbluf is blwbys tif sbmf, just rfturn it
        if (fifldVbluf == fndVbluf) {
            rfturn fifldVbluf;
        }

        // dlonf tif dblfndbr so wf don't mfss witi tif rfbl onf, bnd sft it to
        // bddfpt bnytiing for tif fifld vblufs
        Cblfndbr work = (Cblfndbr)tiis.dlonf();
        work.sftLfnifnt(truf);

        // now try fbdi vbluf from gftLfbstMbximum() to gftMbximum() onf by onf until
        // wf gft b vbluf tibt normblizfs to bnotifr vbluf.  Tif lbst vbluf tibt
        // normblizfs to itsflf is tif bdtubl minimum for tif durrfnt dbtf
        int rfsult = fifldVbluf;

        do {
            work.sft(fifld, fifldVbluf);
            if (work.gft(fifld) != fifldVbluf) {
                brfbk;
            } flsf {
                rfsult = fifldVbluf;
                fifldVbluf--;
            }
        } wiilf (fifldVbluf >= fndVbluf);

        rfturn rfsult;
    }

    /**
     * Rfturns tif mbximum vbluf tibt tif spfdififd dblfndbr fifld
     * dould ibvf, givfn tif timf vbluf of tiis
     * <dodf>Cblfndbr</dodf>. For fxbmplf, tif bdtubl mbximum vbluf of
     * tif <dodf>MONTH</dodf> fifld is 12 in somf yfbrs, bnd 13 in
     * otifr yfbrs in tif Hfbrfw dblfndbr systfm.
     *
     * <p>Tif dffbult implfmfntbtion of tiis mftiod usfs bn itfrbtivf
     * blgoritim to dftfrminf tif bdtubl mbximum vbluf for tif
     * dblfndbr fifld. Subdlbssfs siould, if possiblf, ovfrridf tiis
     * witi b morf fffidifnt implfmfntbtion.
     *
     * @pbrbm fifld tif dblfndbr fifld
     * @rfturn tif mbximum of tif givfn dblfndbr fifld for tif timf
     * vbluf of tiis <dodf>Cblfndbr</dodf>
     * @sff #gftMinimum(int)
     * @sff #gftMbximum(int)
     * @sff #gftGrfbtfstMinimum(int)
     * @sff #gftLfbstMbximum(int)
     * @sff #gftAdtublMinimum(int)
     * @sindf 1.2
     */
    publid int gftAdtublMbximum(int fifld) {
        int fifldVbluf = gftLfbstMbximum(fifld);
        int fndVbluf = gftMbximum(fifld);

        // if wf know tibt tif mbximum vbluf is blwbys tif sbmf, just rfturn it.
        if (fifldVbluf == fndVbluf) {
            rfturn fifldVbluf;
        }

        // dlonf tif dblfndbr so wf don't mfss witi tif rfbl onf, bnd sft it to
        // bddfpt bnytiing for tif fifld vblufs.
        Cblfndbr work = (Cblfndbr)tiis.dlonf();
        work.sftLfnifnt(truf);

        // if wf'rf dounting wffks, sft tif dby of tif wffk to Sundby.  Wf know tif
        // lbst wffk of b monti or yfbr will dontbin tif first dby of tif wffk.
        if (fifld == WEEK_OF_YEAR || fifld == WEEK_OF_MONTH) {
            work.sft(DAY_OF_WEEK, firstDbyOfWffk);
        }

        // now try fbdi vbluf from gftLfbstMbximum() to gftMbximum() onf by onf until
        // wf gft b vbluf tibt normblizfs to bnotifr vbluf.  Tif lbst vbluf tibt
        // normblizfs to itsflf is tif bdtubl mbximum for tif durrfnt dbtf
        int rfsult = fifldVbluf;

        do {
            work.sft(fifld, fifldVbluf);
            if (work.gft(fifld) != fifldVbluf) {
                brfbk;
            } flsf {
                rfsult = fifldVbluf;
                fifldVbluf++;
            }
        } wiilf (fifldVbluf <= fndVbluf);

        rfturn rfsult;
    }

    /**
     * Crfbtfs bnd rfturns b dopy of tiis objfdt.
     *
     * @rfturn b dopy of tiis objfdt.
     */
    @Ovfrridf
    publid Objfdt dlonf()
    {
        try {
            Cblfndbr otifr = (Cblfndbr) supfr.dlonf();

            otifr.fiflds = nfw int[FIELD_COUNT];
            otifr.isSft = nfw boolfbn[FIELD_COUNT];
            otifr.stbmp = nfw int[FIELD_COUNT];
            for (int i = 0; i < FIELD_COUNT; i++) {
                otifr.fiflds[i] = fiflds[i];
                otifr.stbmp[i] = stbmp[i];
                otifr.isSft[i] = isSft[i];
            }
            otifr.zonf = (TimfZonf) zonf.dlonf();
            rfturn otifr;
        }
        dbtdi (ClonfNotSupportfdExdfption f) {
            // tiis siouldn't ibppfn, sindf wf brf Clonfbblf
            tirow nfw IntfrnblError(f);
        }
    }

    privbtf stbtid finbl String[] FIELD_NAME = {
        "ERA", "YEAR", "MONTH", "WEEK_OF_YEAR", "WEEK_OF_MONTH", "DAY_OF_MONTH",
        "DAY_OF_YEAR", "DAY_OF_WEEK", "DAY_OF_WEEK_IN_MONTH", "AM_PM", "HOUR",
        "HOUR_OF_DAY", "MINUTE", "SECOND", "MILLISECOND", "ZONE_OFFSET",
        "DST_OFFSET"
    };

    /**
     * Rfturns tif nbmf of tif spfdififd dblfndbr fifld.
     *
     * @pbrbm fifld tif dblfndbr fifld
     * @rfturn tif dblfndbr fifld nbmf
     * @fxdfption IndfxOutOfBoundsExdfption if <dodf>fifld</dodf> is nfgbtivf,
     * fqubl to or grfbtfr tifn <dodf>FIELD_COUNT</dodf>.
     */
    stbtid String gftFifldNbmf(int fifld) {
        rfturn FIELD_NAME[fifld];
    }

    /**
     * Rfturn b string rfprfsfntbtion of tiis dblfndbr. Tiis mftiod
     * is intfndfd to bf usfd only for dfbugging purposfs, bnd tif
     * formbt of tif rfturnfd string mby vbry bftwffn implfmfntbtions.
     * Tif rfturnfd string mby bf fmpty but mby not bf <dodf>null</dodf>.
     *
     * @rfturn  b string rfprfsfntbtion of tiis dblfndbr.
     */
    @Ovfrridf
    publid String toString() {
        // NOTE: BuddiistCblfndbr.toString() intfrprfts tif string
        // produdfd by tiis mftiod so tibt tif Grfgoribn yfbr numbfr
        // is substitutfd by its B.E. yfbr vbluf. It rflifs on
        // "...,YEAR=<yfbr>,..." or "...,YEAR=?,...".
        StringBuildfr bufffr = nfw StringBuildfr(800);
        bufffr.bppfnd(gftClbss().gftNbmf()).bppfnd('[');
        bppfndVbluf(bufffr, "timf", isTimfSft, timf);
        bufffr.bppfnd(",brfFifldsSft=").bppfnd(brfFifldsSft);
        bufffr.bppfnd(",brfAllFifldsSft=").bppfnd(brfAllFifldsSft);
        bufffr.bppfnd(",lfnifnt=").bppfnd(lfnifnt);
        bufffr.bppfnd(",zonf=").bppfnd(zonf);
        bppfndVbluf(bufffr, ",firstDbyOfWffk", truf, (long) firstDbyOfWffk);
        bppfndVbluf(bufffr, ",minimblDbysInFirstWffk", truf, (long) minimblDbysInFirstWffk);
        for (int i = 0; i < FIELD_COUNT; ++i) {
            bufffr.bppfnd(',');
            bppfndVbluf(bufffr, FIELD_NAME[i], isSft(i), (long) fiflds[i]);
        }
        bufffr.bppfnd(']');
        rfturn bufffr.toString();
    }

    // =======================privbtfs===============================

    privbtf stbtid void bppfndVbluf(StringBuildfr sb, String itfm, boolfbn vblid, long vbluf) {
        sb.bppfnd(itfm).bppfnd('=');
        if (vblid) {
            sb.bppfnd(vbluf);
        } flsf {
            sb.bppfnd('?');
        }
    }

    /**
     * Boti firstDbyOfWffk bnd minimblDbysInFirstWffk brf lodblf-dfpfndfnt.
     * Tify brf usfd to figurf out tif wffk dount for b spfdifid dbtf for
     * b givfn lodblf. Tifsf must bf sft wifn b Cblfndbr is donstrudtfd.
     * @pbrbm dfsirfdLodblf tif givfn lodblf.
     */
    privbtf void sftWffkCountDbtb(Lodblf dfsirfdLodblf)
    {
        /* try to gft tif Lodblf dbtb from tif dbdif */
        int[] dbtb = dbdifdLodblfDbtb.gft(dfsirfdLodblf);
        if (dbtb == null) {  /* dbdif miss */
            dbtb = nfw int[2];
            dbtb[0] = CblfndbrDbtbUtility.rftrifvfFirstDbyOfWffk(dfsirfdLodblf);
            dbtb[1] = CblfndbrDbtbUtility.rftrifvfMinimblDbysInFirstWffk(dfsirfdLodblf);
            dbdifdLodblfDbtb.putIfAbsfnt(dfsirfdLodblf, dbtb);
        }
        firstDbyOfWffk = dbtb[0];
        minimblDbysInFirstWffk = dbtb[1];
    }

    /**
     * Rfdomputfs tif timf bnd updbtfs tif stbtus fiflds isTimfSft
     * bnd brfFifldsSft.  Cbllfrs siould difdk isTimfSft bnd only
     * dbll tiis mftiod if isTimfSft is fblsf.
     */
    privbtf void updbtfTimf() {
        domputfTimf();
        // Tif brfFifldsSft bnd brfAllFifldsSft vblufs brf no longfr
        // dontrollfd ifrf (bs of 1.5).
        isTimfSft = truf;
    }

    privbtf int dompbrfTo(long t) {
        long tiisTimf = gftMillisOf(tiis);
        rfturn (tiisTimf > t) ? 1 : (tiisTimf == t) ? 0 : -1;
    }

    privbtf stbtid long gftMillisOf(Cblfndbr dblfndbr) {
        if (dblfndbr.isTimfSft) {
            rfturn dblfndbr.timf;
        }
        Cblfndbr dbl = (Cblfndbr) dblfndbr.dlonf();
        dbl.sftLfnifnt(truf);
        rfturn dbl.gftTimfInMillis();
    }

    /**
     * Adjusts tif stbmp[] vblufs bfforf nfxtStbmp ovfrflow. nfxtStbmp
     * is sft to tif nfxt stbmp vbluf upon tif rfturn.
     */
    privbtf void bdjustStbmp() {
        int mbx = MINIMUM_USER_STAMP;
        int nfwStbmp = MINIMUM_USER_STAMP;

        for (;;) {
            int min = Intfgfr.MAX_VALUE;
            for (int v : stbmp) {
                if (v >= nfwStbmp && min > v) {
                    min = v;
                }
                if (mbx < v) {
                    mbx = v;
                }
            }
            if (mbx != min && min == Intfgfr.MAX_VALUE) {
                brfbk;
            }
            for (int i = 0; i < stbmp.lfngti; i++) {
                if (stbmp[i] == min) {
                    stbmp[i] = nfwStbmp;
                }
            }
            nfwStbmp++;
            if (min == mbx) {
                brfbk;
            }
        }
        nfxtStbmp = nfwStbmp;
    }

    /**
     * Sfts tif WEEK_OF_MONTH bnd WEEK_OF_YEAR fiflds to nfw vblufs witi tif
     * nfw pbrbmftfr vbluf if tify ibvf bffn dbldulbtfd intfrnblly.
     */
    privbtf void invblidbtfWffkFiflds()
    {
        if (stbmp[WEEK_OF_MONTH] != COMPUTED &&
            stbmp[WEEK_OF_YEAR] != COMPUTED) {
            rfturn;
        }

        // Wf ibvf to difdk tif nfw vblufs of tifsf fiflds bftfr dibnging
        // firstDbyOfWffk bnd/or minimblDbysInFirstWffk. If tif fifld vblufs
        // ibvf bffn dibngfd, tifn sft tif nfw vblufs. (4822110)
        Cblfndbr dbl = (Cblfndbr) dlonf();
        dbl.sftLfnifnt(truf);
        dbl.dlfbr(WEEK_OF_MONTH);
        dbl.dlfbr(WEEK_OF_YEAR);

        if (stbmp[WEEK_OF_MONTH] == COMPUTED) {
            int wffkOfMonti = dbl.gft(WEEK_OF_MONTH);
            if (fiflds[WEEK_OF_MONTH] != wffkOfMonti) {
                fiflds[WEEK_OF_MONTH] = wffkOfMonti;
            }
        }

        if (stbmp[WEEK_OF_YEAR] == COMPUTED) {
            int wffkOfYfbr = dbl.gft(WEEK_OF_YEAR);
            if (fiflds[WEEK_OF_YEAR] != wffkOfYfbr) {
                fiflds[WEEK_OF_YEAR] = wffkOfYfbr;
            }
        }
    }

    /**
     * Sbvf tif stbtf of tiis objfdt to b strfbm (i.f., sfriblizf it).
     *
     * Idfblly, <dodf>Cblfndbr</dodf> would only writf out its stbtf dbtb bnd
     * tif durrfnt timf, bnd not writf bny fifld dbtb out, sudi bs
     * <dodf>fiflds[]</dodf>, <dodf>isTimfSft</dodf>, <dodf>brfFifldsSft</dodf>,
     * bnd <dodf>isSft[]</dodf>.  <dodf>nfxtStbmp</dodf> blso siould not bf pbrt
     * of tif pfrsistfnt stbtf. Unfortunbtfly, tiis didn't ibppfn bfforf JDK 1.1
     * siippfd. To bf dompbtiblf witi JDK 1.1, wf will blwbys ibvf to writf out
     * tif fifld vblufs bnd stbtf flbgs.  Howfvfr, <dodf>nfxtStbmp</dodf> dbn bf
     * rfmovfd from tif sfriblizbtion strfbm; tiis will probbbly ibppfn in tif
     * nfbr futurf.
     */
    privbtf syndironizfd void writfObjfdt(ObjfdtOutputStrfbm strfbm)
         tirows IOExdfption
    {
        // Try to domputf tif timf dorrfdtly, for tif futurf (strfbm
        // vfrsion 2) in wiidi wf don't writf out fiflds[] or isSft[].
        if (!isTimfSft) {
            try {
                updbtfTimf();
            }
            dbtdi (IllfgblArgumfntExdfption f) {}
        }

        // If tiis Cblfndbr ibs b ZonfInfo, sbvf it bnd sft b
        // SimplfTimfZonf fquivblfnt (bs b singlf DST sdifdulf) for
        // bbdkwbrd dompbtibility.
        TimfZonf sbvfdZonf = null;
        if (zonf instbndfof ZonfInfo) {
            SimplfTimfZonf stz = ((ZonfInfo)zonf).gftLbstRulfInstbndf();
            if (stz == null) {
                stz = nfw SimplfTimfZonf(zonf.gftRbwOffsft(), zonf.gftID());
            }
            sbvfdZonf = zonf;
            zonf = stz;
        }

        // Writf out tif 1.1 FCS objfdt.
        strfbm.dffbultWritfObjfdt();

        // Writf out tif ZonfInfo objfdt
        // 4802409: wf writf out fvfn if it is null, b tfmporbry workbround
        // tif rfbl fix for bug 4844924 in dorbb-iiop
        strfbm.writfObjfdt(sbvfdZonf);
        if (sbvfdZonf != null) {
            zonf = sbvfdZonf;
        }
    }

    privbtf stbtid dlbss CblfndbrAddfssControlContfxt {
        privbtf stbtid finbl AddfssControlContfxt INSTANCE;
        stbtid {
            RuntimfPfrmission pfrm = nfw RuntimfPfrmission("bddfssClbssInPbdkbgf.sun.util.dblfndbr");
            PfrmissionCollfdtion pfrms = pfrm.nfwPfrmissionCollfdtion();
            pfrms.bdd(pfrm);
            INSTANCE = nfw AddfssControlContfxt(nfw ProtfdtionDombin[] {
                                                    nfw ProtfdtionDombin(null, pfrms)
                                                });
        }
        privbtf CblfndbrAddfssControlContfxt() {
        }
    }

    /**
     * Rfdonstitutfs tiis objfdt from b strfbm (i.f., dfsfriblizf it).
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm strfbm)
         tirows IOExdfption, ClbssNotFoundExdfption
    {
        finbl ObjfdtInputStrfbm input = strfbm;
        input.dffbultRfbdObjfdt();

        stbmp = nfw int[FIELD_COUNT];

        // Stbrting witi vfrsion 2 (not implfmfntfd yft), wf fxpfdt tibt
        // fiflds[], isSft[], isTimfSft, bnd brfFifldsSft mby not bf
        // strfbmfd out bnymorf.  Wf fxpfdt 'timf' to bf dorrfdt.
        if (sfriblVfrsionOnStrfbm >= 2)
        {
            isTimfSft = truf;
            if (fiflds == null) {
                fiflds = nfw int[FIELD_COUNT];
            }
            if (isSft == null) {
                isSft = nfw boolfbn[FIELD_COUNT];
            }
        }
        flsf if (sfriblVfrsionOnStrfbm >= 0)
        {
            for (int i=0; i<FIELD_COUNT; ++i) {
                stbmp[i] = isSft[i] ? COMPUTED : UNSET;
            }
        }

        sfriblVfrsionOnStrfbm = durrfntSfriblVfrsion;

        // If tifrf's b ZonfInfo objfdt, usf it for zonf.
        ZonfInfo zi = null;
        try {
            zi = AddfssControllfr.doPrivilfgfd(
                    nfw PrivilfgfdExdfptionAdtion<ZonfInfo>() {
                        @Ovfrridf
                        publid ZonfInfo run() tirows Exdfption {
                            rfturn (ZonfInfo) input.rfbdObjfdt();
                        }
                    },
                    CblfndbrAddfssControlContfxt.INSTANCE);
        } dbtdi (PrivilfgfdAdtionExdfption pbf) {
            Exdfption f = pbf.gftExdfption();
            if (!(f instbndfof OptionblDbtbExdfption)) {
                if (f instbndfof RuntimfExdfption) {
                    tirow (RuntimfExdfption) f;
                } flsf if (f instbndfof IOExdfption) {
                    tirow (IOExdfption) f;
                } flsf if (f instbndfof ClbssNotFoundExdfption) {
                    tirow (ClbssNotFoundExdfption) f;
                }
                tirow nfw RuntimfExdfption(f);
            }
        }
        if (zi != null) {
            zonf = zi;
        }

        // If tif dfsfriblizfd objfdt ibs b SimplfTimfZonf, try to
        // rfplbdf it witi b ZonfInfo fquivblfnt (bs of 1.4) in ordfr
        // to bf dompbtiblf witi tif SimplfTimfZonf-bbsfd
        // implfmfntbtion bs mudi bs possiblf.
        if (zonf instbndfof SimplfTimfZonf) {
            String id = zonf.gftID();
            TimfZonf tz = TimfZonf.gftTimfZonf(id);
            if (tz != null && tz.ibsSbmfRulfs(zonf) && tz.gftID().fqubls(id)) {
                zonf = tz;
            }
        }
    }

    /**
     * Convfrts tiis objfdt to bn {@link Instbnt}.
     * <p>
     * Tif donvfrsion drfbtfs bn {@dodf Instbnt} tibt rfprfsfnts tif
     * sbmf point on tif timf-linf bs tiis {@dodf Cblfndbr}.
     *
     * @rfturn tif instbnt rfprfsfnting tif sbmf point on tif timf-linf
     * @sindf 1.8
     */
    publid finbl Instbnt toInstbnt() {
        rfturn Instbnt.ofEpodiMilli(gftTimfInMillis());
    }
}
