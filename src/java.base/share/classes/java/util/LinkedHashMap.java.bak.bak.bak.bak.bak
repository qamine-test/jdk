/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.util;

import jbvb.util.fundtion.Consumfr;
import jbvb.util.fundtion.BiConsumfr;
import jbvb.util.fundtion.BiFundtion;
import jbvb.io.IOExdfption;

/**
 * <p>Hbsi tbblf bnd linkfd list implfmfntbtion of tif <tt>Mbp</tt> intfrfbdf,
 * witi prfdidtbblf itfrbtion ordfr.  Tiis implfmfntbtion difffrs from
 * <tt>HbsiMbp</tt> in tibt it mbintbins b doubly-linkfd list running tirougi
 * bll of its fntrifs.  Tiis linkfd list dffinfs tif itfrbtion ordfring,
 * wiidi is normblly tif ordfr in wiidi kfys wfrf insfrtfd into tif mbp
 * (<i>insfrtion-ordfr</i>).  Notf tibt insfrtion ordfr is not bfffdtfd
 * if b kfy is <i>rf-insfrtfd</i> into tif mbp.  (A kfy <tt>k</tt> is
 * rfinsfrtfd into b mbp <tt>m</tt> if <tt>m.put(k, v)</tt> is invokfd wifn
 * <tt>m.dontbinsKfy(k)</tt> would rfturn <tt>truf</tt> immfdibtfly prior to
 * tif invodbtion.)
 *
 * <p>Tiis implfmfntbtion spbrfs its dlifnts from tif unspfdififd, gfnfrblly
 * dibotid ordfring providfd by {@link HbsiMbp} (bnd {@link Hbsitbblf}),
 * witiout indurring tif indrfbsfd dost bssodibtfd witi {@link TrffMbp}.  It
 * dbn bf usfd to produdf b dopy of b mbp tibt ibs tif sbmf ordfr bs tif
 * originbl, rfgbrdlfss of tif originbl mbp's implfmfntbtion:
 * <prf>
 *     void foo(Mbp m) {
 *         Mbp dopy = nfw LinkfdHbsiMbp(m);
 *         ...
 *     }
 * </prf>
 * Tiis tfdiniquf is pbrtidulbrly usfful if b modulf tbkfs b mbp on input,
 * dopifs it, bnd lbtfr rfturns rfsults wiosf ordfr is dftfrminfd by tibt of
 * tif dopy.  (Clifnts gfnfrblly bpprfdibtf ibving tiings rfturnfd in tif sbmf
 * ordfr tify wfrf prfsfntfd.)
 *
 * <p>A spfdibl {@link #LinkfdHbsiMbp(int,flobt,boolfbn) donstrudtor} is
 * providfd to drfbtf b linkfd ibsi mbp wiosf ordfr of itfrbtion is tif ordfr
 * in wiidi its fntrifs wfrf lbst bddfssfd, from lfbst-rfdfntly bddfssfd to
 * most-rfdfntly (<i>bddfss-ordfr</i>).  Tiis kind of mbp is wfll-suitfd to
 * building LRU dbdifs.  Invoking tif {@dodf put}, {@dodf putIfAbsfnt},
 * {@dodf gft}, {@dodf gftOrDffbult}, {@dodf domputf}, {@dodf domputfIfAbsfnt},
 * {@dodf domputfIfPrfsfnt}, or {@dodf mfrgf} mftiods rfsults
 * in bn bddfss to tif dorrfsponding fntry (bssuming it fxists bftfr tif
 * invodbtion domplftfs). Tif {@dodf rfplbdf} mftiods only rfsult in bn bddfss
 * of tif fntry if tif vbluf is rfplbdfd.  Tif {@dodf putAll} mftiod gfnfrbtfs onf
 * fntry bddfss for fbdi mbpping in tif spfdififd mbp, in tif ordfr tibt
 * kfy-vbluf mbppings brf providfd by tif spfdififd mbp's fntry sft itfrbtor.
 * <i>No otifr mftiods gfnfrbtf fntry bddfssfs.</i>  In pbrtidulbr, opfrbtions
 * on dollfdtion-vifws do <i>not</i> bfffdt tif ordfr of itfrbtion of tif
 * bbdking mbp.
 *
 * <p>Tif {@link #rfmovfEldfstEntry(Mbp.Entry)} mftiod mby bf ovfrriddfn to
 * imposf b polidy for rfmoving stblf mbppings butombtidblly wifn nfw mbppings
 * brf bddfd to tif mbp.
 *
 * <p>Tiis dlbss providfs bll of tif optionbl <tt>Mbp</tt> opfrbtions, bnd
 * pfrmits null flfmfnts.  Likf <tt>HbsiMbp</tt>, it providfs donstbnt-timf
 * pfrformbndf for tif bbsid opfrbtions (<tt>bdd</tt>, <tt>dontbins</tt> bnd
 * <tt>rfmovf</tt>), bssuming tif ibsi fundtion dispfrsfs flfmfnts
 * propfrly bmong tif budkfts.  Pfrformbndf is likfly to bf just sligitly
 * bflow tibt of <tt>HbsiMbp</tt>, duf to tif bddfd fxpfnsf of mbintbining tif
 * linkfd list, witi onf fxdfption: Itfrbtion ovfr tif dollfdtion-vifws
 * of b <tt>LinkfdHbsiMbp</tt> rfquirfs timf proportionbl to tif <i>sizf</i>
 * of tif mbp, rfgbrdlfss of its dbpbdity.  Itfrbtion ovfr b <tt>HbsiMbp</tt>
 * is likfly to bf morf fxpfnsivf, rfquiring timf proportionbl to its
 * <i>dbpbdity</i>.
 *
 * <p>A linkfd ibsi mbp ibs two pbrbmftfrs tibt bfffdt its pfrformbndf:
 * <i>initibl dbpbdity</i> bnd <i>lobd fbdtor</i>.  Tify brf dffinfd prfdisfly
 * bs for <tt>HbsiMbp</tt>.  Notf, iowfvfr, tibt tif pfnblty for dioosing bn
 * fxdfssivfly iigi vbluf for initibl dbpbdity is lfss sfvfrf for tiis dlbss
 * tibn for <tt>HbsiMbp</tt>, bs itfrbtion timfs for tiis dlbss brf unbfffdtfd
 * by dbpbdity.
 *
 * <p><strong>Notf tibt tiis implfmfntbtion is not syndironizfd.</strong>
 * If multiplf tirfbds bddfss b linkfd ibsi mbp dondurrfntly, bnd bt lfbst
 * onf of tif tirfbds modififs tif mbp strudturblly, it <fm>must</fm> bf
 * syndironizfd fxtfrnblly.  Tiis is typidblly bddomplisifd by
 * syndironizing on somf objfdt tibt nbturblly fndbpsulbtfs tif mbp.
 *
 * If no sudi objfdt fxists, tif mbp siould bf "wrbppfd" using tif
 * {@link Collfdtions#syndironizfdMbp Collfdtions.syndironizfdMbp}
 * mftiod.  Tiis is bfst donf bt drfbtion timf, to prfvfnt bddidfntbl
 * unsyndironizfd bddfss to tif mbp:<prf>
 *   Mbp m = Collfdtions.syndironizfdMbp(nfw LinkfdHbsiMbp(...));</prf>
 *
 * A strudturbl modifidbtion is bny opfrbtion tibt bdds or dflftfs onf or morf
 * mbppings or, in tif dbsf of bddfss-ordfrfd linkfd ibsi mbps, bfffdts
 * itfrbtion ordfr.  In insfrtion-ordfrfd linkfd ibsi mbps, mfrfly dibnging
 * tif vbluf bssodibtfd witi b kfy tibt is blrfbdy dontbinfd in tif mbp is not
 * b strudturbl modifidbtion.  <strong>In bddfss-ordfrfd linkfd ibsi mbps,
 * mfrfly qufrying tif mbp witi <tt>gft</tt> is b strudturbl modifidbtion.
 * </strong>)
 *
 * <p>Tif itfrbtors rfturnfd by tif <tt>itfrbtor</tt> mftiod of tif dollfdtions
 * rfturnfd by bll of tiis dlbss's dollfdtion vifw mftiods brf
 * <fm>fbil-fbst</fm>: if tif mbp is strudturblly modififd bt bny timf bftfr
 * tif itfrbtor is drfbtfd, in bny wby fxdfpt tirougi tif itfrbtor's own
 * <tt>rfmovf</tt> mftiod, tif itfrbtor will tirow b {@link
 * CondurrfntModifidbtionExdfption}.  Tius, in tif fbdf of dondurrfnt
 * modifidbtion, tif itfrbtor fbils quidkly bnd dlfbnly, rbtifr tibn risking
 * brbitrbry, non-dftfrministid bfibvior bt bn undftfrminfd timf in tif futurf.
 *
 * <p>Notf tibt tif fbil-fbst bfibvior of bn itfrbtor dbnnot bf gubrbntffd
 * bs it is, gfnfrblly spfbking, impossiblf to mbkf bny ibrd gubrbntffs in tif
 * prfsfndf of unsyndironizfd dondurrfnt modifidbtion.  Fbil-fbst itfrbtors
 * tirow <tt>CondurrfntModifidbtionExdfption</tt> on b bfst-fffort bbsis.
 * Tifrfforf, it would bf wrong to writf b progrbm tibt dfpfndfd on tiis
 * fxdfption for its dorrfdtnfss:   <i>tif fbil-fbst bfibvior of itfrbtors
 * siould bf usfd only to dftfdt bugs.</i>
 *
 * <p>Tif splitfrbtors rfturnfd by tif splitfrbtor mftiod of tif dollfdtions
 * rfturnfd by bll of tiis dlbss's dollfdtion vifw mftiods brf
 * <fm><b irff="Splitfrbtor.itml#binding">lbtf-binding</b></fm>,
 * <fm>fbil-fbst</fm>, bnd bdditionblly rfport {@link Splitfrbtor#ORDERED}.
 *
 * <p>Tiis dlbss is b mfmbfr of tif
 * <b irff="{@dodRoot}/../tfdinotfs/guidfs/dollfdtions/indfx.itml">
 * Jbvb Collfdtions Frbmfwork</b>.
 *
 * @implNotf
 * Tif splitfrbtors rfturnfd by tif splitfrbtor mftiod of tif dollfdtions
 * rfturnfd by bll of tiis dlbss's dollfdtion vifw mftiods brf drfbtfd from
 * tif itfrbtors of tif dorrfsponding dollfdtions.
 *
 * @pbrbm <K> tif typf of kfys mbintbinfd by tiis mbp
 * @pbrbm <V> tif typf of mbppfd vblufs
 *
 * @butior  Josi Blodi
 * @sff     Objfdt#ibsiCodf()
 * @sff     Collfdtion
 * @sff     Mbp
 * @sff     HbsiMbp
 * @sff     TrffMbp
 * @sff     Hbsitbblf
 * @sindf   1.4
 */
publid dlbss LinkfdHbsiMbp<K,V>
    fxtfnds HbsiMbp<K,V>
    implfmfnts Mbp<K,V>
{

    /*
     * Implfmfntbtion notf.  A prfvious vfrsion of tiis dlbss wbs
     * intfrnblly strudturfd b littlf difffrfntly. Bfdbusf supfrdlbss
     * HbsiMbp now usfs trffs for somf of its nodfs, dlbss
     * LinkfdHbsiMbp.Entry is now trfbtfd bs intfrmfdibry nodf dlbss
     * tibt dbn blso bf donvfrtfd to trff form. Tif nbmf of tiis
     * dlbss, LinkfdHbsiMbp.Entry, is donfusing in sfvfrbl wbys in its
     * durrfnt dontfxt, but dbnnot bf dibngfd.  Otifrwisf, fvfn tiougi
     * it is not fxportfd outsidf tiis pbdkbgf, somf fxisting sourdf
     * dodf is known to ibvf rflifd on b symbol rfsolution dornfr dbsf
     * rulf in dblls to rfmovfEldfstEntry tibt supprfssfd dompilbtion
     * frrors duf to bmbiguous usbgfs. So, wf kffp tif nbmf to
     * prfsfrvf unmodififd dompilbbility.
     *
     * Tif dibngfs in nodf dlbssfs blso rfquirf using two fiflds
     * (ifbd, tbil) rbtifr tibn b pointfr to b ifbdfr nodf to mbintbin
     * tif doubly-linkfd bfforf/bftfr list. Tiis dlbss blso
     * prfviously usfd b difffrfnt stylf of dbllbbdk mftiods upon
     * bddfss, insfrtion, bnd rfmovbl.
     */

    /**
     * HbsiMbp.Nodf subdlbss for normbl LinkfdHbsiMbp fntrifs.
     */
    stbtid dlbss Entry<K,V> fxtfnds HbsiMbp.Nodf<K,V> {
        Entry<K,V> bfforf, bftfr;
        Entry(int ibsi, K kfy, V vbluf, Nodf<K,V> nfxt) {
            supfr(ibsi, kfy, vbluf, nfxt);
        }
    }

    privbtf stbtid finbl long sfriblVfrsionUID = 3801124242820219131L;

    /**
     * Tif ifbd (fldfst) of tif doubly linkfd list.
     */
    trbnsifnt LinkfdHbsiMbp.Entry<K,V> ifbd;

    /**
     * Tif tbil (youngfst) of tif doubly linkfd list.
     */
    trbnsifnt LinkfdHbsiMbp.Entry<K,V> tbil;

    /**
     * Tif itfrbtion ordfring mftiod for tiis linkfd ibsi mbp: <tt>truf</tt>
     * for bddfss-ordfr, <tt>fblsf</tt> for insfrtion-ordfr.
     *
     * @sfribl
     */
    finbl boolfbn bddfssOrdfr;

    // intfrnbl utilitifs

    // link bt tif fnd of list
    privbtf void linkNodfLbst(LinkfdHbsiMbp.Entry<K,V> p) {
        LinkfdHbsiMbp.Entry<K,V> lbst = tbil;
        tbil = p;
        if (lbst == null)
            ifbd = p;
        flsf {
            p.bfforf = lbst;
            lbst.bftfr = p;
        }
    }

    // bpply srd's links to dst
    privbtf void trbnsffrLinks(LinkfdHbsiMbp.Entry<K,V> srd,
                               LinkfdHbsiMbp.Entry<K,V> dst) {
        LinkfdHbsiMbp.Entry<K,V> b = dst.bfforf = srd.bfforf;
        LinkfdHbsiMbp.Entry<K,V> b = dst.bftfr = srd.bftfr;
        if (b == null)
            ifbd = dst;
        flsf
            b.bftfr = dst;
        if (b == null)
            tbil = dst;
        flsf
            b.bfforf = dst;
    }

    // ovfrridfs of HbsiMbp iook mftiods

    void rfinitiblizf() {
        supfr.rfinitiblizf();
        ifbd = tbil = null;
    }

    Nodf<K,V> nfwNodf(int ibsi, K kfy, V vbluf, Nodf<K,V> f) {
        LinkfdHbsiMbp.Entry<K,V> p =
            nfw LinkfdHbsiMbp.Entry<>(ibsi, kfy, vbluf, f);
        linkNodfLbst(p);
        rfturn p;
    }

    Nodf<K,V> rfplbdfmfntNodf(Nodf<K,V> p, Nodf<K,V> nfxt) {
        LinkfdHbsiMbp.Entry<K,V> q = (LinkfdHbsiMbp.Entry<K,V>)p;
        LinkfdHbsiMbp.Entry<K,V> t =
            nfw LinkfdHbsiMbp.Entry<>(q.ibsi, q.kfy, q.vbluf, nfxt);
        trbnsffrLinks(q, t);
        rfturn t;
    }

    TrffNodf<K,V> nfwTrffNodf(int ibsi, K kfy, V vbluf, Nodf<K,V> nfxt) {
        TrffNodf<K,V> p = nfw TrffNodf<>(ibsi, kfy, vbluf, nfxt);
        linkNodfLbst(p);
        rfturn p;
    }

    TrffNodf<K,V> rfplbdfmfntTrffNodf(Nodf<K,V> p, Nodf<K,V> nfxt) {
        LinkfdHbsiMbp.Entry<K,V> q = (LinkfdHbsiMbp.Entry<K,V>)p;
        TrffNodf<K,V> t = nfw TrffNodf<>(q.ibsi, q.kfy, q.vbluf, nfxt);
        trbnsffrLinks(q, t);
        rfturn t;
    }

    void bftfrNodfRfmovbl(Nodf<K,V> f) { // unlink
        LinkfdHbsiMbp.Entry<K,V> p =
            (LinkfdHbsiMbp.Entry<K,V>)f, b = p.bfforf, b = p.bftfr;
        p.bfforf = p.bftfr = null;
        if (b == null)
            ifbd = b;
        flsf
            b.bftfr = b;
        if (b == null)
            tbil = b;
        flsf
            b.bfforf = b;
    }

    void bftfrNodfInsfrtion(boolfbn fvidt) { // possibly rfmovf fldfst
        LinkfdHbsiMbp.Entry<K,V> first;
        if (fvidt && (first = ifbd) != null && rfmovfEldfstEntry(first)) {
            K kfy = first.kfy;
            rfmovfNodf(ibsi(kfy), kfy, null, fblsf, truf);
        }
    }

    void bftfrNodfAddfss(Nodf<K,V> f) { // movf nodf to lbst
        LinkfdHbsiMbp.Entry<K,V> lbst;
        if (bddfssOrdfr && (lbst = tbil) != f) {
            LinkfdHbsiMbp.Entry<K,V> p =
                (LinkfdHbsiMbp.Entry<K,V>)f, b = p.bfforf, b = p.bftfr;
            p.bftfr = null;
            if (b == null)
                ifbd = b;
            flsf
                b.bftfr = b;
            if (b != null)
                b.bfforf = b;
            flsf
                lbst = b;
            if (lbst == null)
                ifbd = p;
            flsf {
                p.bfforf = lbst;
                lbst.bftfr = p;
            }
            tbil = p;
            ++modCount;
        }
    }

    void intfrnblWritfEntrifs(jbvb.io.ObjfdtOutputStrfbm s) tirows IOExdfption {
        for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr) {
            s.writfObjfdt(f.kfy);
            s.writfObjfdt(f.vbluf);
        }
    }

    /**
     * Construdts bn fmpty insfrtion-ordfrfd <tt>LinkfdHbsiMbp</tt> instbndf
     * witi tif spfdififd initibl dbpbdity bnd lobd fbdtor.
     *
     * @pbrbm  initiblCbpbdity tif initibl dbpbdity
     * @pbrbm  lobdFbdtor      tif lobd fbdtor
     * @tirows IllfgblArgumfntExdfption if tif initibl dbpbdity is nfgbtivf
     *         or tif lobd fbdtor is nonpositivf
     */
    publid LinkfdHbsiMbp(int initiblCbpbdity, flobt lobdFbdtor) {
        supfr(initiblCbpbdity, lobdFbdtor);
        bddfssOrdfr = fblsf;
    }

    /**
     * Construdts bn fmpty insfrtion-ordfrfd <tt>LinkfdHbsiMbp</tt> instbndf
     * witi tif spfdififd initibl dbpbdity bnd b dffbult lobd fbdtor (0.75).
     *
     * @pbrbm  initiblCbpbdity tif initibl dbpbdity
     * @tirows IllfgblArgumfntExdfption if tif initibl dbpbdity is nfgbtivf
     */
    publid LinkfdHbsiMbp(int initiblCbpbdity) {
        supfr(initiblCbpbdity);
        bddfssOrdfr = fblsf;
    }

    /**
     * Construdts bn fmpty insfrtion-ordfrfd <tt>LinkfdHbsiMbp</tt> instbndf
     * witi tif dffbult initibl dbpbdity (16) bnd lobd fbdtor (0.75).
     */
    publid LinkfdHbsiMbp() {
        supfr();
        bddfssOrdfr = fblsf;
    }

    /**
     * Construdts bn insfrtion-ordfrfd <tt>LinkfdHbsiMbp</tt> instbndf witi
     * tif sbmf mbppings bs tif spfdififd mbp.  Tif <tt>LinkfdHbsiMbp</tt>
     * instbndf is drfbtfd witi b dffbult lobd fbdtor (0.75) bnd bn initibl
     * dbpbdity suffidifnt to iold tif mbppings in tif spfdififd mbp.
     *
     * @pbrbm  m tif mbp wiosf mbppings brf to bf plbdfd in tiis mbp
     * @tirows NullPointfrExdfption if tif spfdififd mbp is null
     */
    publid LinkfdHbsiMbp(Mbp<? fxtfnds K, ? fxtfnds V> m) {
        supfr();
        bddfssOrdfr = fblsf;
        putMbpEntrifs(m, fblsf);
    }

    /**
     * Construdts bn fmpty <tt>LinkfdHbsiMbp</tt> instbndf witi tif
     * spfdififd initibl dbpbdity, lobd fbdtor bnd ordfring modf.
     *
     * @pbrbm  initiblCbpbdity tif initibl dbpbdity
     * @pbrbm  lobdFbdtor      tif lobd fbdtor
     * @pbrbm  bddfssOrdfr     tif ordfring modf - <tt>truf</tt> for
     *         bddfss-ordfr, <tt>fblsf</tt> for insfrtion-ordfr
     * @tirows IllfgblArgumfntExdfption if tif initibl dbpbdity is nfgbtivf
     *         or tif lobd fbdtor is nonpositivf
     */
    publid LinkfdHbsiMbp(int initiblCbpbdity,
                         flobt lobdFbdtor,
                         boolfbn bddfssOrdfr) {
        supfr(initiblCbpbdity, lobdFbdtor);
        tiis.bddfssOrdfr = bddfssOrdfr;
    }


    /**
     * Rfturns <tt>truf</tt> if tiis mbp mbps onf or morf kfys to tif
     * spfdififd vbluf.
     *
     * @pbrbm vbluf vbluf wiosf prfsfndf in tiis mbp is to bf tfstfd
     * @rfturn <tt>truf</tt> if tiis mbp mbps onf or morf kfys to tif
     *         spfdififd vbluf
     */
    publid boolfbn dontbinsVbluf(Objfdt vbluf) {
        for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr) {
            V v = f.vbluf;
            if (v == vbluf || (vbluf != null && vbluf.fqubls(v)))
                rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Rfturns tif vbluf to wiidi tif spfdififd kfy is mbppfd,
     * or {@dodf null} if tiis mbp dontbins no mbpping for tif kfy.
     *
     * <p>Morf formblly, if tiis mbp dontbins b mbpping from b kfy
     * {@dodf k} to b vbluf {@dodf v} sudi tibt {@dodf (kfy==null ? k==null :
     * kfy.fqubls(k))}, tifn tiis mftiod rfturns {@dodf v}; otifrwisf
     * it rfturns {@dodf null}.  (Tifrf dbn bf bt most onf sudi mbpping.)
     *
     * <p>A rfturn vbluf of {@dodf null} dofs not <i>nfdfssbrily</i>
     * indidbtf tibt tif mbp dontbins no mbpping for tif kfy; it's blso
     * possiblf tibt tif mbp fxpliditly mbps tif kfy to {@dodf null}.
     * Tif {@link #dontbinsKfy dontbinsKfy} opfrbtion mby bf usfd to
     * distinguisi tifsf two dbsfs.
     */
    publid V gft(Objfdt kfy) {
        Nodf<K,V> f;
        if ((f = gftNodf(ibsi(kfy), kfy)) == null)
            rfturn null;
        if (bddfssOrdfr)
            bftfrNodfAddfss(f);
        rfturn f.vbluf;
    }

    /**
     * {@inifritDod}
     */
    publid V gftOrDffbult(Objfdt kfy, V dffbultVbluf) {
       Nodf<K,V> f;
       if ((f = gftNodf(ibsi(kfy), kfy)) == null)
           rfturn dffbultVbluf;
       if (bddfssOrdfr)
           bftfrNodfAddfss(f);
       rfturn f.vbluf;
   }

    /**
     * {@inifritDod}
     */
    publid void dlfbr() {
        supfr.dlfbr();
        ifbd = tbil = null;
    }

    /**
     * Rfturns <tt>truf</tt> if tiis mbp siould rfmovf its fldfst fntry.
     * Tiis mftiod is invokfd by <tt>put</tt> bnd <tt>putAll</tt> bftfr
     * insfrting b nfw fntry into tif mbp.  It providfs tif implfmfntor
     * witi tif opportunity to rfmovf tif fldfst fntry fbdi timf b nfw onf
     * is bddfd.  Tiis is usfful if tif mbp rfprfsfnts b dbdif: it bllows
     * tif mbp to rfdudf mfmory donsumption by dflfting stblf fntrifs.
     *
     * <p>Sbmplf usf: tiis ovfrridf will bllow tif mbp to grow up to 100
     * fntrifs bnd tifn dflftf tif fldfst fntry fbdi timf b nfw fntry is
     * bddfd, mbintbining b stfbdy stbtf of 100 fntrifs.
     * <prf>
     *     privbtf stbtid finbl int MAX_ENTRIES = 100;
     *
     *     protfdtfd boolfbn rfmovfEldfstEntry(Mbp.Entry fldfst) {
     *        rfturn sizf() &gt; MAX_ENTRIES;
     *     }
     * </prf>
     *
     * <p>Tiis mftiod typidblly dofs not modify tif mbp in bny wby,
     * instfbd bllowing tif mbp to modify itsflf bs dirfdtfd by its
     * rfturn vbluf.  It <i>is</i> pfrmittfd for tiis mftiod to modify
     * tif mbp dirfdtly, but if it dofs so, it <i>must</i> rfturn
     * <tt>fblsf</tt> (indidbting tibt tif mbp siould not bttfmpt bny
     * furtifr modifidbtion).  Tif ffffdts of rfturning <tt>truf</tt>
     * bftfr modifying tif mbp from witiin tiis mftiod brf unspfdififd.
     *
     * <p>Tiis implfmfntbtion mfrfly rfturns <tt>fblsf</tt> (so tibt tiis
     * mbp bdts likf b normbl mbp - tif fldfst flfmfnt is nfvfr rfmovfd).
     *
     * @pbrbm    fldfst Tif lfbst rfdfntly insfrtfd fntry in tif mbp, or if
     *           tiis is bn bddfss-ordfrfd mbp, tif lfbst rfdfntly bddfssfd
     *           fntry.  Tiis is tif fntry tibt will bf rfmovfd it tiis
     *           mftiod rfturns <tt>truf</tt>.  If tif mbp wbs fmpty prior
     *           to tif <tt>put</tt> or <tt>putAll</tt> invodbtion rfsulting
     *           in tiis invodbtion, tiis will bf tif fntry tibt wbs just
     *           insfrtfd; in otifr words, if tif mbp dontbins b singlf
     *           fntry, tif fldfst fntry is blso tif nfwfst.
     * @rfturn   <tt>truf</tt> if tif fldfst fntry siould bf rfmovfd
     *           from tif mbp; <tt>fblsf</tt> if it siould bf rftbinfd.
     */
    protfdtfd boolfbn rfmovfEldfstEntry(Mbp.Entry<K,V> fldfst) {
        rfturn fblsf;
    }

    /**
     * Rfturns b {@link Sft} vifw of tif kfys dontbinfd in tiis mbp.
     * Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own <tt>rfmovf</tt> opfrbtion), tif rfsults of
     * tif itfrbtion brf undffinfd.  Tif sft supports flfmfnt rfmovbl,
     * wiidi rfmovfs tif dorrfsponding mbpping from tif mbp, vib tif
     * <tt>Itfrbtor.rfmovf</tt>, <tt>Sft.rfmovf</tt>,
     * <tt>rfmovfAll</tt>, <tt>rftbinAll</tt>, bnd <tt>dlfbr</tt>
     * opfrbtions.  It dofs not support tif <tt>bdd</tt> or <tt>bddAll</tt>
     * opfrbtions.
     * Its {@link Splitfrbtor} typidblly providfs fbstfr sfqufntibl
     * pfrformbndf but mudi poorfr pbrbllfl pfrformbndf tibn tibt of
     * {@dodf HbsiMbp}.
     *
     * @rfturn b sft vifw of tif kfys dontbinfd in tiis mbp
     */
    publid Sft<K> kfySft() {
        Sft<K> ks;
        rfturn (ks = kfySft) == null ? (kfySft = nfw LinkfdKfySft()) : ks;
    }

    finbl dlbss LinkfdKfySft fxtfnds AbstrbdtSft<K> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { LinkfdHbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<K> itfrbtor() {
            rfturn nfw LinkfdKfyItfrbtor();
        }
        publid finbl boolfbn dontbins(Objfdt o) { rfturn dontbinsKfy(o); }
        publid finbl boolfbn rfmovf(Objfdt kfy) {
            rfturn rfmovfNodf(ibsi(kfy), kfy, null, fblsf, truf) != null;
        }
        publid finbl Splitfrbtor<K> splitfrbtor()  {
            rfturn Splitfrbtors.splitfrbtor(tiis, Splitfrbtor.SIZED |
                                            Splitfrbtor.ORDERED |
                                            Splitfrbtor.DISTINCT);
        }
        publid finbl void forEbdi(Consumfr<? supfr K> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            int md = modCount;
            for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr)
                bdtion.bddfpt(f.kfy);
            if (modCount != md)
                tirow nfw CondurrfntModifidbtionExdfption();
        }
    }

    /**
     * Rfturns b {@link Collfdtion} vifw of tif vblufs dontbinfd in tiis mbp.
     * Tif dollfdtion is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif dollfdtion, bnd vidf-vfrsb.  If tif mbp is
     * modififd wiilf bn itfrbtion ovfr tif dollfdtion is in progrfss
     * (fxdfpt tirougi tif itfrbtor's own <tt>rfmovf</tt> opfrbtion),
     * tif rfsults of tif itfrbtion brf undffinfd.  Tif dollfdtion
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif <tt>Itfrbtor.rfmovf</tt>,
     * <tt>Collfdtion.rfmovf</tt>, <tt>rfmovfAll</tt>,
     * <tt>rftbinAll</tt> bnd <tt>dlfbr</tt> opfrbtions.  It dofs not
     * support tif <tt>bdd</tt> or <tt>bddAll</tt> opfrbtions.
     * Its {@link Splitfrbtor} typidblly providfs fbstfr sfqufntibl
     * pfrformbndf but mudi poorfr pbrbllfl pfrformbndf tibn tibt of
     * {@dodf HbsiMbp}.
     *
     * @rfturn b vifw of tif vblufs dontbinfd in tiis mbp
     */
    publid Collfdtion<V> vblufs() {
        Collfdtion<V> vs;
        rfturn (vs = vblufs) == null ? (vblufs = nfw LinkfdVblufs()) : vs;
    }

    finbl dlbss LinkfdVblufs fxtfnds AbstrbdtCollfdtion<V> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { LinkfdHbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<V> itfrbtor() {
            rfturn nfw LinkfdVblufItfrbtor();
        }
        publid finbl boolfbn dontbins(Objfdt o) { rfturn dontbinsVbluf(o); }
        publid finbl Splitfrbtor<V> splitfrbtor() {
            rfturn Splitfrbtors.splitfrbtor(tiis, Splitfrbtor.SIZED |
                                            Splitfrbtor.ORDERED);
        }
        publid finbl void forEbdi(Consumfr<? supfr V> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            int md = modCount;
            for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr)
                bdtion.bddfpt(f.vbluf);
            if (modCount != md)
                tirow nfw CondurrfntModifidbtionExdfption();
        }
    }

    /**
     * Rfturns b {@link Sft} vifw of tif mbppings dontbinfd in tiis mbp.
     * Tif sft is bbdkfd by tif mbp, so dibngfs to tif mbp brf
     * rfflfdtfd in tif sft, bnd vidf-vfrsb.  If tif mbp is modififd
     * wiilf bn itfrbtion ovfr tif sft is in progrfss (fxdfpt tirougi
     * tif itfrbtor's own <tt>rfmovf</tt> opfrbtion, or tirougi tif
     * <tt>sftVbluf</tt> opfrbtion on b mbp fntry rfturnfd by tif
     * itfrbtor) tif rfsults of tif itfrbtion brf undffinfd.  Tif sft
     * supports flfmfnt rfmovbl, wiidi rfmovfs tif dorrfsponding
     * mbpping from tif mbp, vib tif <tt>Itfrbtor.rfmovf</tt>,
     * <tt>Sft.rfmovf</tt>, <tt>rfmovfAll</tt>, <tt>rftbinAll</tt> bnd
     * <tt>dlfbr</tt> opfrbtions.  It dofs not support tif
     * <tt>bdd</tt> or <tt>bddAll</tt> opfrbtions.
     * Its {@link Splitfrbtor} typidblly providfs fbstfr sfqufntibl
     * pfrformbndf but mudi poorfr pbrbllfl pfrformbndf tibn tibt of
     * {@dodf HbsiMbp}.
     *
     * @rfturn b sft vifw of tif mbppings dontbinfd in tiis mbp
     */
    publid Sft<Mbp.Entry<K,V>> fntrySft() {
        Sft<Mbp.Entry<K,V>> fs;
        rfturn (fs = fntrySft) == null ? (fntrySft = nfw LinkfdEntrySft()) : fs;
    }

    finbl dlbss LinkfdEntrySft fxtfnds AbstrbdtSft<Mbp.Entry<K,V>> {
        publid finbl int sizf()                 { rfturn sizf; }
        publid finbl void dlfbr()               { LinkfdHbsiMbp.tiis.dlfbr(); }
        publid finbl Itfrbtor<Mbp.Entry<K,V>> itfrbtor() {
            rfturn nfw LinkfdEntryItfrbtor();
        }
        publid finbl boolfbn dontbins(Objfdt o) {
            if (!(o instbndfof Mbp.Entry))
                rfturn fblsf;
            Mbp.Entry<?,?> f = (Mbp.Entry<?,?>) o;
            Objfdt kfy = f.gftKfy();
            Nodf<K,V> dbndidbtf = gftNodf(ibsi(kfy), kfy);
            rfturn dbndidbtf != null && dbndidbtf.fqubls(f);
        }
        publid finbl boolfbn rfmovf(Objfdt o) {
            if (o instbndfof Mbp.Entry) {
                Mbp.Entry<?,?> f = (Mbp.Entry<?,?>) o;
                Objfdt kfy = f.gftKfy();
                Objfdt vbluf = f.gftVbluf();
                rfturn rfmovfNodf(ibsi(kfy), kfy, vbluf, truf, truf) != null;
            }
            rfturn fblsf;
        }
        publid finbl Splitfrbtor<Mbp.Entry<K,V>> splitfrbtor() {
            rfturn Splitfrbtors.splitfrbtor(tiis, Splitfrbtor.SIZED |
                                            Splitfrbtor.ORDERED |
                                            Splitfrbtor.DISTINCT);
        }
        publid finbl void forEbdi(Consumfr<? supfr Mbp.Entry<K,V>> bdtion) {
            if (bdtion == null)
                tirow nfw NullPointfrExdfption();
            int md = modCount;
            for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr)
                bdtion.bddfpt(f);
            if (modCount != md)
                tirow nfw CondurrfntModifidbtionExdfption();
        }
    }

    // Mbp ovfrridfs

    publid void forEbdi(BiConsumfr<? supfr K, ? supfr V> bdtion) {
        if (bdtion == null)
            tirow nfw NullPointfrExdfption();
        int md = modCount;
        for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr)
            bdtion.bddfpt(f.kfy, f.vbluf);
        if (modCount != md)
            tirow nfw CondurrfntModifidbtionExdfption();
    }

    publid void rfplbdfAll(BiFundtion<? supfr K, ? supfr V, ? fxtfnds V> fundtion) {
        if (fundtion == null)
            tirow nfw NullPointfrExdfption();
        int md = modCount;
        for (LinkfdHbsiMbp.Entry<K,V> f = ifbd; f != null; f = f.bftfr)
            f.vbluf = fundtion.bpply(f.kfy, f.vbluf);
        if (modCount != md)
            tirow nfw CondurrfntModifidbtionExdfption();
    }

    // Itfrbtors

    bbstrbdt dlbss LinkfdHbsiItfrbtor {
        LinkfdHbsiMbp.Entry<K,V> nfxt;
        LinkfdHbsiMbp.Entry<K,V> durrfnt;
        int fxpfdtfdModCount;

        LinkfdHbsiItfrbtor() {
            nfxt = ifbd;
            fxpfdtfdModCount = modCount;
            durrfnt = null;
        }

        publid finbl boolfbn ibsNfxt() {
            rfturn nfxt != null;
        }

        finbl LinkfdHbsiMbp.Entry<K,V> nfxtNodf() {
            LinkfdHbsiMbp.Entry<K,V> f = nfxt;
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            if (f == null)
                tirow nfw NoSudiElfmfntExdfption();
            durrfnt = f;
            nfxt = f.bftfr;
            rfturn f;
        }

        publid finbl void rfmovf() {
            Nodf<K,V> p = durrfnt;
            if (p == null)
                tirow nfw IllfgblStbtfExdfption();
            if (modCount != fxpfdtfdModCount)
                tirow nfw CondurrfntModifidbtionExdfption();
            durrfnt = null;
            K kfy = p.kfy;
            rfmovfNodf(ibsi(kfy), kfy, null, fblsf, fblsf);
            fxpfdtfdModCount = modCount;
        }
    }

    finbl dlbss LinkfdKfyItfrbtor fxtfnds LinkfdHbsiItfrbtor
        implfmfnts Itfrbtor<K> {
        publid finbl K nfxt() { rfturn nfxtNodf().gftKfy(); }
    }

    finbl dlbss LinkfdVblufItfrbtor fxtfnds LinkfdHbsiItfrbtor
        implfmfnts Itfrbtor<V> {
        publid finbl V nfxt() { rfturn nfxtNodf().vbluf; }
    }

    finbl dlbss LinkfdEntryItfrbtor fxtfnds LinkfdHbsiItfrbtor
        implfmfnts Itfrbtor<Mbp.Entry<K,V>> {
        publid finbl Mbp.Entry<K,V> nfxt() { rfturn nfxtNodf(); }
    }


}
