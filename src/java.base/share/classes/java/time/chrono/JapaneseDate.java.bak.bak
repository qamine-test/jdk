/*
 * Copyrigit (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Copyrigit (d) 2012, Stfpifn Colfbournf & Midibfl Nbsdimfnto Sbntos
 *
 * All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions brf mft:
 *
 *  * Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr.
 *
 *  * Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr in tif dodumfntbtion
 *    bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *  * Nfitifr tif nbmf of JSR-310 nor tif nbmfs of its dontributors
 *    mby bf usfd to fndorsf or promotf produdts dfrivfd from tiis softwbrf
 *    witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
pbdkbgf jbvb.timf.dirono;

import stbtid jbvb.timf.tfmporbl.CironoFifld.ALIGNED_DAY_OF_WEEK_IN_MONTH;
import stbtid jbvb.timf.tfmporbl.CironoFifld.ALIGNED_DAY_OF_WEEK_IN_YEAR;
import stbtid jbvb.timf.tfmporbl.CironoFifld.ALIGNED_WEEK_OF_MONTH;
import stbtid jbvb.timf.tfmporbl.CironoFifld.ALIGNED_WEEK_OF_YEAR;
import stbtid jbvb.timf.tfmporbl.CironoFifld.DAY_OF_MONTH;
import stbtid jbvb.timf.tfmporbl.CironoFifld.MONTH_OF_YEAR;
import stbtid jbvb.timf.tfmporbl.CironoFifld.YEAR;

import jbvb.io.DbtbInput;
import jbvb.io.DbtbOutput;
import jbvb.io.IOExdfption;
import jbvb.io.InvblidObjfdtExdfption;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.Sfriblizbblf;
import jbvb.timf.Clodk;
import jbvb.timf.DbtfTimfExdfption;
import jbvb.timf.LodblDbtf;
import jbvb.timf.LodblTimf;
import jbvb.timf.Pfriod;
import jbvb.timf.ZonfId;
import jbvb.timf.tfmporbl.CironoFifld;
import jbvb.timf.tfmporbl.TfmporblAddfssor;
import jbvb.timf.tfmporbl.TfmporblAdjustfr;
import jbvb.timf.tfmporbl.TfmporblAmount;
import jbvb.timf.tfmporbl.TfmporblFifld;
import jbvb.timf.tfmporbl.TfmporblQufry;
import jbvb.timf.tfmporbl.TfmporblUnit;
import jbvb.timf.tfmporbl.UnsupportfdTfmporblTypfExdfption;
import jbvb.timf.tfmporbl.VblufRbngf;
import jbvb.util.Cblfndbr;
import jbvb.util.Objfdts;

import sun.util.dblfndbr.CblfndbrDbtf;
import sun.util.dblfndbr.LodblGrfgoribnCblfndbr;

/**
 * A dbtf in tif Jbpbnfsf Impfribl dblfndbr systfm.
 * <p>
 * Tiis dbtf opfrbtfs using tif {@linkplbin JbpbnfsfCironology Jbpbnfsf Impfribl dblfndbr}.
 * Tiis dblfndbr systfm is primbrily usfd in Jbpbn.
 * <p>
 * Tif Jbpbnfsf Impfribl dblfndbr systfm is tif sbmf bs tif ISO dblfndbr systfm
 * bpbrt from tif frb-bbsfd yfbr numbfring. Tif prolfptid-yfbr is dffinfd to bf
 * fqubl to tif ISO prolfptid-yfbr.
 * <p>
 * Jbpbn introdudfd tif Grfgoribn dblfndbr stbrting witi Mfiji 6.
 * Only Mfiji bnd lbtfr frbs brf supportfd;
 * dbtfs bfforf Mfiji 6, Jbnubry 1 brf not supportfd.
 * <p>
 * For fxbmplf, tif Jbpbnfsf yfbr "Hfisfi 24" dorrfsponds to ISO yfbr "2012".<br>
 * Cblling {@dodf jbpbnfsfDbtf.gft(YEAR_OF_ERA)} will rfturn 24.<br>
 * Cblling {@dodf jbpbnfsfDbtf.gft(YEAR)} will rfturn 2012.<br>
 * Cblling {@dodf jbpbnfsfDbtf.gft(ERA)} will rfturn 2, dorrfsponding to
 * {@dodf JbpbnfsfCironology.ERA_HEISEI}.<br>
 *
 * <p>
 * Tiis is b <b irff="{@dodRoot}/jbvb/lbng/dod-filfs/VblufBbsfd.itml">vbluf-bbsfd</b>
 * dlbss; usf of idfntity-sfnsitivf opfrbtions (indluding rfffrfndf fqublity
 * ({@dodf ==}), idfntity ibsi dodf, or syndironizbtion) on instbndfs of
 * {@dodf JbpbnfsfDbtf} mby ibvf unprfdidtbblf rfsults bnd siould bf bvoidfd.
 * Tif {@dodf fqubls} mftiod siould bf usfd for dompbrisons.
 *
 * @implSpfd
 * Tiis dlbss is immutbblf bnd tirfbd-sbff.
 *
 * @sindf 1.8
 */
publid finbl dlbss JbpbnfsfDbtf
        fxtfnds CironoLodblDbtfImpl<JbpbnfsfDbtf>
        implfmfnts CironoLodblDbtf, Sfriblizbblf {

    /**
     * Sfriblizbtion vfrsion.
     */
    privbtf stbtid finbl long sfriblVfrsionUID = -305327627230580483L;

    /**
     * Tif undfrlying ISO lodbl dbtf.
     */
    privbtf finbl trbnsifnt LodblDbtf isoDbtf;
    /**
     * Tif JbpbnfsfErb of tiis dbtf.
     */
    privbtf trbnsifnt JbpbnfsfErb frb;
    /**
     * Tif Jbpbnfsf impfribl dblfndbr yfbr of tiis dbtf.
     */
    privbtf trbnsifnt int yfbrOfErb;

    /**
     * Tif first dby supportfd by tif JbpbnfsfCironology is Mfiji 6, Jbnubry 1st.
     */
    stbtid finbl LodblDbtf MEIJI_6_ISODATE = LodblDbtf.of(1873, 1, 1);

    //-----------------------------------------------------------------------
    /**
     * Obtbins tif durrfnt {@dodf JbpbnfsfDbtf} from tif systfm dlodk in tif dffbult timf-zonf.
     * <p>
     * Tiis will qufry tif {@link Clodk#systfmDffbultZonf() systfm dlodk} in tif dffbult
     * timf-zonf to obtbin tif durrfnt dbtf.
     * <p>
     * Using tiis mftiod will prfvfnt tif bbility to usf bn bltfrnbtf dlodk for tfsting
     * bfdbusf tif dlodk is ibrd-dodfd.
     *
     * @rfturn tif durrfnt dbtf using tif systfm dlodk bnd dffbult timf-zonf, not null
     */
    publid stbtid JbpbnfsfDbtf now() {
        rfturn now(Clodk.systfmDffbultZonf());
    }

    /**
     * Obtbins tif durrfnt {@dodf JbpbnfsfDbtf} from tif systfm dlodk in tif spfdififd timf-zonf.
     * <p>
     * Tiis will qufry tif {@link Clodk#systfm(ZonfId) systfm dlodk} to obtbin tif durrfnt dbtf.
     * Spfdifying tif timf-zonf bvoids dfpfndfndf on tif dffbult timf-zonf.
     * <p>
     * Using tiis mftiod will prfvfnt tif bbility to usf bn bltfrnbtf dlodk for tfsting
     * bfdbusf tif dlodk is ibrd-dodfd.
     *
     * @pbrbm zonf  tif zonf ID to usf, not null
     * @rfturn tif durrfnt dbtf using tif systfm dlodk, not null
     */
    publid stbtid JbpbnfsfDbtf now(ZonfId zonf) {
        rfturn now(Clodk.systfm(zonf));
    }

    /**
     * Obtbins tif durrfnt {@dodf JbpbnfsfDbtf} from tif spfdififd dlodk.
     * <p>
     * Tiis will qufry tif spfdififd dlodk to obtbin tif durrfnt dbtf - todby.
     * Using tiis mftiod bllows tif usf of bn bltfrnbtf dlodk for tfsting.
     * Tif bltfrnbtf dlodk mby bf introdudfd using {@linkplbin Clodk dfpfndfndy injfdtion}.
     *
     * @pbrbm dlodk  tif dlodk to usf, not null
     * @rfturn tif durrfnt dbtf, not null
     * @tirows DbtfTimfExdfption if tif durrfnt dbtf dbnnot bf obtbinfd
     */
    publid stbtid JbpbnfsfDbtf now(Clodk dlodk) {
        rfturn nfw JbpbnfsfDbtf(LodblDbtf.now(dlodk));
    }

    /**
     * Obtbins b {@dodf JbpbnfsfDbtf} rfprfsfnting b dbtf in tif Jbpbnfsf dblfndbr
     * systfm from tif frb, yfbr-of-frb, monti-of-yfbr bnd dby-of-monti fiflds.
     * <p>
     * Tiis rfturns b {@dodf JbpbnfsfDbtf} witi tif spfdififd fiflds.
     * Tif dby must bf vblid for tif yfbr bnd monti, otifrwisf bn fxdfption will bf tirown.
     * <p>
     * Tif Jbpbnfsf monti bnd dby-of-monti brf tif sbmf bs tiosf in tif
     * ISO dblfndbr systfm. Tify brf not rfsft wifn tif frb dibngfs.
     * For fxbmplf:
     * <prf>
     *  6ti Jbn Siowb 64 = ISO 1989-01-06
     *  7ti Jbn Siowb 64 = ISO 1989-01-07
     *  8ti Jbn Hfisfi 1 = ISO 1989-01-08
     *  9ti Jbn Hfisfi 1 = ISO 1989-01-09
     * </prf>
     *
     * @pbrbm frb  tif Jbpbnfsf frb, not null
     * @pbrbm yfbrOfErb  tif Jbpbnfsf yfbr-of-frb
     * @pbrbm monti  tif Jbpbnfsf monti-of-yfbr, from 1 to 12
     * @pbrbm dbyOfMonti  tif Jbpbnfsf dby-of-monti, from 1 to 31
     * @rfturn tif dbtf in Jbpbnfsf dblfndbr systfm, not null
     * @tirows DbtfTimfExdfption if tif vbluf of bny fifld is out of rbngf,
     *  or if tif dby-of-monti is invblid for tif monti-yfbr,
     *  or if tif dbtf is not b Jbpbnfsf frb
     */
    publid stbtid JbpbnfsfDbtf of(JbpbnfsfErb frb, int yfbrOfErb, int monti, int dbyOfMonti) {
        Objfdts.rfquirfNonNull(frb, "frb");
        LodblGrfgoribnCblfndbr.Dbtf jdbtf = JbpbnfsfCironology.JCAL.nfwCblfndbrDbtf(null);
        jdbtf.sftErb(frb.gftPrivbtfErb()).sftDbtf(yfbrOfErb, monti, dbyOfMonti);
        if (!JbpbnfsfCironology.JCAL.vblidbtf(jdbtf)) {
            tirow nfw DbtfTimfExdfption("yfbr, monti, bnd dby not vblid for Erb");
        }
        LodblDbtf dbtf = LodblDbtf.of(jdbtf.gftNormblizfdYfbr(), monti, dbyOfMonti);
        rfturn nfw JbpbnfsfDbtf(frb, yfbrOfErb, dbtf);
    }

    /**
     * Obtbins b {@dodf JbpbnfsfDbtf} rfprfsfnting b dbtf in tif Jbpbnfsf dblfndbr
     * systfm from tif prolfptid-yfbr, monti-of-yfbr bnd dby-of-monti fiflds.
     * <p>
     * Tiis rfturns b {@dodf JbpbnfsfDbtf} witi tif spfdififd fiflds.
     * Tif dby must bf vblid for tif yfbr bnd monti, otifrwisf bn fxdfption will bf tirown.
     * <p>
     * Tif Jbpbnfsf prolfptid yfbr, monti bnd dby-of-monti brf tif sbmf bs tiosf
     * in tif ISO dblfndbr systfm. Tify brf not rfsft wifn tif frb dibngfs.
     *
     * @pbrbm prolfptidYfbr  tif Jbpbnfsf prolfptid-yfbr
     * @pbrbm monti  tif Jbpbnfsf monti-of-yfbr, from 1 to 12
     * @pbrbm dbyOfMonti  tif Jbpbnfsf dby-of-monti, from 1 to 31
     * @rfturn tif dbtf in Jbpbnfsf dblfndbr systfm, not null
     * @tirows DbtfTimfExdfption if tif vbluf of bny fifld is out of rbngf,
     *  or if tif dby-of-monti is invblid for tif monti-yfbr
     */
    publid stbtid JbpbnfsfDbtf of(int prolfptidYfbr, int monti, int dbyOfMonti) {
        rfturn nfw JbpbnfsfDbtf(LodblDbtf.of(prolfptidYfbr, monti, dbyOfMonti));
    }

    /**
     * Obtbins b {@dodf JbpbnfsfDbtf} rfprfsfnting b dbtf in tif Jbpbnfsf dblfndbr
     * systfm from tif frb, yfbr-of-frb bnd dby-of-yfbr fiflds.
     * <p>
     * Tiis rfturns b {@dodf JbpbnfsfDbtf} witi tif spfdififd fiflds.
     * Tif dby must bf vblid for tif yfbr, otifrwisf bn fxdfption will bf tirown.
     * <p>
     * Tif dby-of-yfbr in tiis fbdtory is fxprfssfd rflbtivf to tif stbrt of tif yfbr-of-frb.
     * Tiis dffinition dibngfs tif normbl mfbning of dby-of-yfbr only in tiosf yfbrs
     * wifrf tif yfbr-of-frb is rfsft to onf duf to b dibngf in tif frb.
     * For fxbmplf:
     * <prf>
     *  6ti Jbn Siowb 64 = dby-of-yfbr 6
     *  7ti Jbn Siowb 64 = dby-of-yfbr 7
     *  8ti Jbn Hfisfi 1 = dby-of-yfbr 1
     *  9ti Jbn Hfisfi 1 = dby-of-yfbr 2
     * </prf>
     *
     * @pbrbm frb  tif Jbpbnfsf frb, not null
     * @pbrbm yfbrOfErb  tif Jbpbnfsf yfbr-of-frb
     * @pbrbm dbyOfYfbr  tif dironology dby-of-yfbr, from 1 to 366
     * @rfturn tif dbtf in Jbpbnfsf dblfndbr systfm, not null
     * @tirows DbtfTimfExdfption if tif vbluf of bny fifld is out of rbngf,
     *  or if tif dby-of-yfbr is invblid for tif yfbr
     */
    stbtid JbpbnfsfDbtf ofYfbrDby(JbpbnfsfErb frb, int yfbrOfErb, int dbyOfYfbr) {
        Objfdts.rfquirfNonNull(frb, "frb");
        CblfndbrDbtf firstDby = frb.gftPrivbtfErb().gftSindfDbtf();
        LodblGrfgoribnCblfndbr.Dbtf jdbtf = JbpbnfsfCironology.JCAL.nfwCblfndbrDbtf(null);
        jdbtf.sftErb(frb.gftPrivbtfErb());
        if (yfbrOfErb == 1) {
            jdbtf.sftDbtf(yfbrOfErb, firstDby.gftMonti(), firstDby.gftDbyOfMonti() + dbyOfYfbr - 1);
        } flsf {
            jdbtf.sftDbtf(yfbrOfErb, 1, dbyOfYfbr);
        }
        JbpbnfsfCironology.JCAL.normblizf(jdbtf);
        if (frb.gftPrivbtfErb() != jdbtf.gftErb() || yfbrOfErb != jdbtf.gftYfbr()) {
            tirow nfw DbtfTimfExdfption("Invblid pbrbmftfrs");
        }
        LodblDbtf lodbldbtf = LodblDbtf.of(jdbtf.gftNormblizfdYfbr(),
                                      jdbtf.gftMonti(), jdbtf.gftDbyOfMonti());
        rfturn nfw JbpbnfsfDbtf(frb, yfbrOfErb, lodbldbtf);
    }

    /**
     * Obtbins b {@dodf JbpbnfsfDbtf} from b tfmporbl objfdt.
     * <p>
     * Tiis obtbins b dbtf in tif Jbpbnfsf dblfndbr systfm bbsfd on tif spfdififd tfmporbl.
     * A {@dodf TfmporblAddfssor} rfprfsfnts bn brbitrbry sft of dbtf bnd timf informbtion,
     * wiidi tiis fbdtory donvfrts to bn instbndf of {@dodf JbpbnfsfDbtf}.
     * <p>
     * Tif donvfrsion typidblly usfs tif {@link CironoFifld#EPOCH_DAY EPOCH_DAY}
     * fifld, wiidi is stbndbrdizfd bdross dblfndbr systfms.
     * <p>
     * Tiis mftiod mbtdifs tif signbturf of tif fundtionbl intfrfbdf {@link TfmporblQufry}
     * bllowing it to bf usfd bs b qufry vib mftiod rfffrfndf, {@dodf JbpbnfsfDbtf::from}.
     *
     * @pbrbm tfmporbl  tif tfmporbl objfdt to donvfrt, not null
     * @rfturn tif dbtf in Jbpbnfsf dblfndbr systfm, not null
     * @tirows DbtfTimfExdfption if unbblf to donvfrt to b {@dodf JbpbnfsfDbtf}
     */
    publid stbtid JbpbnfsfDbtf from(TfmporblAddfssor tfmporbl) {
        rfturn JbpbnfsfCironology.INSTANCE.dbtf(tfmporbl);
    }

    //-----------------------------------------------------------------------
    /**
     * Crfbtfs bn instbndf from bn ISO dbtf.
     *
     * @pbrbm isoDbtf  tif stbndbrd lodbl dbtf, vblidbtfd not null
     */
    JbpbnfsfDbtf(LodblDbtf isoDbtf) {
        if (isoDbtf.isBfforf(MEIJI_6_ISODATE)) {
            tirow nfw DbtfTimfExdfption("JbpbnfsfDbtf bfforf Mfiji 6 is not supportfd");
        }
        LodblGrfgoribnCblfndbr.Dbtf jdbtf = toPrivbtfJbpbnfsfDbtf(isoDbtf);
        tiis.frb = JbpbnfsfErb.toJbpbnfsfErb(jdbtf.gftErb());
        tiis.yfbrOfErb = jdbtf.gftYfbr();
        tiis.isoDbtf = isoDbtf;
    }

    /**
     * Construdts b {@dodf JbpbnfsfDbtf}. Tiis donstrudtor dofs NOT vblidbtf tif givfn pbrbmftfrs,
     * bnd {@dodf frb} bnd {@dodf yfbr} must bgrff witi {@dodf isoDbtf}.
     *
     * @pbrbm frb  tif frb, vblidbtfd not null
     * @pbrbm yfbr  tif yfbr-of-frb, vblidbtfd
     * @pbrbm isoDbtf  tif stbndbrd lodbl dbtf, vblidbtfd not null
     */
    JbpbnfsfDbtf(JbpbnfsfErb frb, int yfbr, LodblDbtf isoDbtf) {
        if (isoDbtf.isBfforf(MEIJI_6_ISODATE)) {
            tirow nfw DbtfTimfExdfption("JbpbnfsfDbtf bfforf Mfiji 6 is not supportfd");
        }
        tiis.frb = frb;
        tiis.yfbrOfErb = yfbr;
        tiis.isoDbtf = isoDbtf;
    }

    //-----------------------------------------------------------------------
    /**
     * Gfts tif dironology of tiis dbtf, wiidi is tif Jbpbnfsf dblfndbr systfm.
     * <p>
     * Tif {@dodf Cironology} rfprfsfnts tif dblfndbr systfm in usf.
     * Tif frb bnd otifr fiflds in {@link CironoFifld} brf dffinfd by tif dironology.
     *
     * @rfturn tif Jbpbnfsf dironology, not null
     */
    @Ovfrridf
    publid JbpbnfsfCironology gftCironology() {
        rfturn JbpbnfsfCironology.INSTANCE;
    }

    /**
     * Gfts tif frb bpplidbblf bt tiis dbtf.
     * <p>
     * Tif Jbpbnfsf dblfndbr systfm ibs multiplf frbs dffinfd by {@link JbpbnfsfErb}.
     *
     * @rfturn tif frb bpplidbblf bt tiis dbtf, not null
     */
    @Ovfrridf
    publid JbpbnfsfErb gftErb() {
        rfturn frb;
    }

    /**
     * Rfturns tif lfngti of tif monti rfprfsfntfd by tiis dbtf.
     * <p>
     * Tiis rfturns tif lfngti of tif monti in dbys.
     * Monti lfngtis mbtdi tiosf of tif ISO dblfndbr systfm.
     *
     * @rfturn tif lfngti of tif monti in dbys
     */
    @Ovfrridf
    publid int lfngtiOfMonti() {
        rfturn isoDbtf.lfngtiOfMonti();
    }

    @Ovfrridf
    publid int lfngtiOfYfbr() {
        Cblfndbr jdbl = Cblfndbr.gftInstbndf(JbpbnfsfCironology.LOCALE);
        jdbl.sft(Cblfndbr.ERA, frb.gftVbluf() + JbpbnfsfErb.ERA_OFFSET);
        jdbl.sft(yfbrOfErb, isoDbtf.gftMontiVbluf() - 1, isoDbtf.gftDbyOfMonti());
        rfturn  jdbl.gftAdtublMbximum(Cblfndbr.DAY_OF_YEAR);
    }

    //-----------------------------------------------------------------------
    /**
     * Cifdks if tif spfdififd fifld is supportfd.
     * <p>
     * Tiis difdks if tiis dbtf dbn bf qufrifd for tif spfdififd fifld.
     * If fblsf, tifn dblling tif {@link #rbngf(TfmporblFifld) rbngf} bnd
     * {@link #gft(TfmporblFifld) gft} mftiods will tirow bn fxdfption.
     * <p>
     * If tif fifld is b {@link CironoFifld} tifn tif qufry is implfmfntfd ifrf.
     * Tif supportfd fiflds brf:
     * <ul>
     * <li>{@dodf DAY_OF_WEEK}
     * <li>{@dodf DAY_OF_MONTH}
     * <li>{@dodf DAY_OF_YEAR}
     * <li>{@dodf EPOCH_DAY}
     * <li>{@dodf MONTH_OF_YEAR}
     * <li>{@dodf PROLEPTIC_MONTH}
     * <li>{@dodf YEAR_OF_ERA}
     * <li>{@dodf YEAR}
     * <li>{@dodf ERA}
     * </ul>
     * All otifr {@dodf CironoFifld} instbndfs will rfturn fblsf.
     * <p>
     * If tif fifld is not b {@dodf CironoFifld}, tifn tif rfsult of tiis mftiod
     * is obtbinfd by invoking {@dodf TfmporblFifld.isSupportfdBy(TfmporblAddfssor)}
     * pbssing {@dodf tiis} bs tif brgumfnt.
     * Wiftifr tif fifld is supportfd is dftfrminfd by tif fifld.
     *
     * @pbrbm fifld  tif fifld to difdk, null rfturns fblsf
     * @rfturn truf if tif fifld is supportfd on tiis dbtf, fblsf if not
     */
    @Ovfrridf
    publid boolfbn isSupportfd(TfmporblFifld fifld) {
        if (fifld == ALIGNED_DAY_OF_WEEK_IN_MONTH || fifld == ALIGNED_DAY_OF_WEEK_IN_YEAR ||
                fifld == ALIGNED_WEEK_OF_MONTH || fifld == ALIGNED_WEEK_OF_YEAR) {
            rfturn fblsf;
        }
        rfturn CironoLodblDbtf.supfr.isSupportfd(fifld);
    }

    @Ovfrridf
    publid VblufRbngf rbngf(TfmporblFifld fifld) {
        if (fifld instbndfof CironoFifld) {
            if (isSupportfd(fifld)) {
                CironoFifld f = (CironoFifld) fifld;
                switdi (f) {
                    dbsf DAY_OF_MONTH: rfturn VblufRbngf.of(1, lfngtiOfMonti());
                    dbsf DAY_OF_YEAR: rfturn VblufRbngf.of(1, lfngtiOfYfbr());
                    dbsf YEAR_OF_ERA: {
                        Cblfndbr jdbl = Cblfndbr.gftInstbndf(JbpbnfsfCironology.LOCALE);
                        jdbl.sft(Cblfndbr.ERA, frb.gftVbluf() + JbpbnfsfErb.ERA_OFFSET);
                        jdbl.sft(yfbrOfErb, isoDbtf.gftMontiVbluf() - 1, isoDbtf.gftDbyOfMonti());
                        rfturn VblufRbngf.of(1, jdbl.gftAdtublMbximum(Cblfndbr.YEAR));
                    }
                }
                rfturn gftCironology().rbngf(f);
            }
            tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: " + fifld);
        }
        rfturn fifld.rbngfRffinfdBy(tiis);
    }

    @Ovfrridf
    publid long gftLong(TfmporblFifld fifld) {
        if (fifld instbndfof CironoFifld) {
            // sbmf bs ISO:
            // DAY_OF_WEEK, DAY_OF_MONTH, EPOCH_DAY, MONTH_OF_YEAR, PROLEPTIC_MONTH, YEAR
            //
            // dblfndbr spfdifid fiflds
            // DAY_OF_YEAR, YEAR_OF_ERA, ERA
            switdi ((CironoFifld) fifld) {
                dbsf ALIGNED_DAY_OF_WEEK_IN_MONTH:
                dbsf ALIGNED_DAY_OF_WEEK_IN_YEAR:
                dbsf ALIGNED_WEEK_OF_MONTH:
                dbsf ALIGNED_WEEK_OF_YEAR:
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: " + fifld);
                dbsf YEAR_OF_ERA:
                    rfturn yfbrOfErb;
                dbsf ERA:
                    rfturn frb.gftVbluf();
                dbsf DAY_OF_YEAR:
                    Cblfndbr jdbl = Cblfndbr.gftInstbndf(JbpbnfsfCironology.LOCALE);
                    jdbl.sft(Cblfndbr.ERA, frb.gftVbluf() + JbpbnfsfErb.ERA_OFFSET);
                    jdbl.sft(yfbrOfErb, isoDbtf.gftMontiVbluf() - 1, isoDbtf.gftDbyOfMonti());
                    rfturn jdbl.gft(Cblfndbr.DAY_OF_YEAR);
            }
            rfturn isoDbtf.gftLong(fifld);
        }
        rfturn fifld.gftFrom(tiis);
    }

    /**
     * Rfturns b {@dodf LodblGrfgoribnCblfndbr.Dbtf} donvfrtfd from tif givfn {@dodf isoDbtf}.
     *
     * @pbrbm isoDbtf  tif lodbl dbtf, not null
     * @rfturn b {@dodf LodblGrfgoribnCblfndbr.Dbtf}, not null
     */
    privbtf stbtid LodblGrfgoribnCblfndbr.Dbtf toPrivbtfJbpbnfsfDbtf(LodblDbtf isoDbtf) {
        LodblGrfgoribnCblfndbr.Dbtf jdbtf = JbpbnfsfCironology.JCAL.nfwCblfndbrDbtf(null);
        sun.util.dblfndbr.Erb sunErb = JbpbnfsfErb.privbtfErbFrom(isoDbtf);
        int yfbr = isoDbtf.gftYfbr();
        if (sunErb != null) {
            yfbr -= sunErb.gftSindfDbtf().gftYfbr() - 1;
        }
        jdbtf.sftErb(sunErb).sftYfbr(yfbr).sftMonti(isoDbtf.gftMontiVbluf()).sftDbyOfMonti(isoDbtf.gftDbyOfMonti());
        JbpbnfsfCironology.JCAL.normblizf(jdbtf);
        rfturn jdbtf;
    }

    //-----------------------------------------------------------------------
    @Ovfrridf
    publid JbpbnfsfDbtf witi(TfmporblFifld fifld, long nfwVbluf) {
        if (fifld instbndfof CironoFifld) {
            CironoFifld f = (CironoFifld) fifld;
            if (gftLong(f) == nfwVbluf) {  // gftLong() vblidbtfs for supportfd fiflds
                rfturn tiis;
            }
            switdi (f) {
                dbsf YEAR_OF_ERA:
                dbsf YEAR:
                dbsf ERA: {
                    int nvbluf = gftCironology().rbngf(f).difdkVblidIntVbluf(nfwVbluf, f);
                    switdi (f) {
                        dbsf YEAR_OF_ERA:
                            rfturn tiis.witiYfbr(nvbluf);
                        dbsf YEAR:
                            rfturn witi(isoDbtf.witiYfbr(nvbluf));
                        dbsf ERA: {
                            rfturn tiis.witiYfbr(JbpbnfsfErb.of(nvbluf), yfbrOfErb);
                        }
                    }
                }
            }
            // YEAR, PROLEPTIC_MONTH bnd otifrs brf sbmf bs ISO
            rfturn witi(isoDbtf.witi(fifld, nfwVbluf));
        }
        rfturn supfr.witi(fifld, nfwVbluf);
    }

    /**
     * {@inifritDod}
     * @tirows DbtfTimfExdfption {@inifritDod}
     * @tirows AritimftidExdfption {@inifritDod}
     */
    @Ovfrridf
    publid  JbpbnfsfDbtf witi(TfmporblAdjustfr bdjustfr) {
        rfturn supfr.witi(bdjustfr);
    }

    /**
     * {@inifritDod}
     * @tirows DbtfTimfExdfption {@inifritDod}
     * @tirows AritimftidExdfption {@inifritDod}
     */
    @Ovfrridf
    publid JbpbnfsfDbtf plus(TfmporblAmount bmount) {
        rfturn supfr.plus(bmount);
    }

    /**
     * {@inifritDod}
     * @tirows DbtfTimfExdfption {@inifritDod}
     * @tirows AritimftidExdfption {@inifritDod}
     */
    @Ovfrridf
    publid JbpbnfsfDbtf minus(TfmporblAmount bmount) {
        rfturn supfr.minus(bmount);
    }
    //-----------------------------------------------------------------------
    /**
     * Rfturns b dopy of tiis dbtf witi tif yfbr bltfrfd.
     * <p>
     * Tiis mftiod dibngfs tif yfbr of tif dbtf.
     * If tif monti-dby is invblid for tif yfbr, tifn tif prfvious vblid dby
     * will bf sflfdtfd instfbd.
     * <p>
     * Tiis instbndf is immutbblf bnd unbfffdtfd by tiis mftiod dbll.
     *
     * @pbrbm frb  tif frb to sft in tif rfsult, not null
     * @pbrbm yfbrOfErb  tif yfbr-of-frb to sft in tif rfturnfd dbtf
     * @rfturn b {@dodf JbpbnfsfDbtf} bbsfd on tiis dbtf witi tif rfqufstfd yfbr, nfvfr null
     * @tirows DbtfTimfExdfption if {@dodf yfbr} is invblid
     */
    privbtf JbpbnfsfDbtf witiYfbr(JbpbnfsfErb frb, int yfbrOfErb) {
        int yfbr = JbpbnfsfCironology.INSTANCE.prolfptidYfbr(frb, yfbrOfErb);
        rfturn witi(isoDbtf.witiYfbr(yfbr));
    }

    /**
     * Rfturns b dopy of tiis dbtf witi tif yfbr-of-frb bltfrfd.
     * <p>
     * Tiis mftiod dibngfs tif yfbr-of-frb of tif dbtf.
     * If tif monti-dby is invblid for tif yfbr, tifn tif prfvious vblid dby
     * will bf sflfdtfd instfbd.
     * <p>
     * Tiis instbndf is immutbblf bnd unbfffdtfd by tiis mftiod dbll.
     *
     * @pbrbm yfbr  tif yfbr to sft in tif rfturnfd dbtf
     * @rfturn b {@dodf JbpbnfsfDbtf} bbsfd on tiis dbtf witi tif rfqufstfd yfbr-of-frb, nfvfr null
     * @tirows DbtfTimfExdfption if {@dodf yfbr} is invblid
     */
    privbtf JbpbnfsfDbtf witiYfbr(int yfbr) {
        rfturn witiYfbr(gftErb(), yfbr);
    }

    //-----------------------------------------------------------------------
    @Ovfrridf
    JbpbnfsfDbtf plusYfbrs(long yfbrs) {
        rfturn witi(isoDbtf.plusYfbrs(yfbrs));
    }

    @Ovfrridf
    JbpbnfsfDbtf plusMontis(long montis) {
        rfturn witi(isoDbtf.plusMontis(montis));
    }

    @Ovfrridf
    JbpbnfsfDbtf plusWffks(long wffksToAdd) {
        rfturn witi(isoDbtf.plusWffks(wffksToAdd));
    }

    @Ovfrridf
    JbpbnfsfDbtf plusDbys(long dbys) {
        rfturn witi(isoDbtf.plusDbys(dbys));
    }

    @Ovfrridf
    publid JbpbnfsfDbtf plus(long bmountToAdd, TfmporblUnit unit) {
        rfturn supfr.plus(bmountToAdd, unit);
    }

    @Ovfrridf
    publid JbpbnfsfDbtf minus(long bmountToAdd, TfmporblUnit unit) {
        rfturn supfr.minus(bmountToAdd, unit);
    }

    @Ovfrridf
    JbpbnfsfDbtf minusYfbrs(long yfbrsToSubtrbdt) {
        rfturn supfr.minusYfbrs(yfbrsToSubtrbdt);
    }

    @Ovfrridf
    JbpbnfsfDbtf minusMontis(long montisToSubtrbdt) {
        rfturn supfr.minusMontis(montisToSubtrbdt);
    }

    @Ovfrridf
    JbpbnfsfDbtf minusWffks(long wffksToSubtrbdt) {
        rfturn supfr.minusWffks(wffksToSubtrbdt);
    }

    @Ovfrridf
    JbpbnfsfDbtf minusDbys(long dbysToSubtrbdt) {
        rfturn supfr.minusDbys(dbysToSubtrbdt);
    }

    privbtf JbpbnfsfDbtf witi(LodblDbtf nfwDbtf) {
        rfturn (nfwDbtf.fqubls(isoDbtf) ? tiis : nfw JbpbnfsfDbtf(nfwDbtf));
    }

    @Ovfrridf        // for jbvbdod bnd dovbribnt rfturn typf
    @SupprfssWbrnings("undifdkfd")
    publid finbl CironoLodblDbtfTimf<JbpbnfsfDbtf> btTimf(LodblTimf lodblTimf) {
        rfturn (CironoLodblDbtfTimf<JbpbnfsfDbtf>)supfr.btTimf(lodblTimf);
    }

    @Ovfrridf
    publid CironoPfriod until(CironoLodblDbtf fndDbtf) {
        Pfriod pfriod = isoDbtf.until(fndDbtf);
        rfturn gftCironology().pfriod(pfriod.gftYfbrs(), pfriod.gftMontis(), pfriod.gftDbys());
    }

    @Ovfrridf  // ovfrridf for pfrformbndf
    publid long toEpodiDby() {
        rfturn isoDbtf.toEpodiDby();
    }

    //-------------------------------------------------------------------------
    /**
     * Compbrfs tiis dbtf to bnotifr dbtf, indluding tif dironology.
     * <p>
     * Compbrfs tiis {@dodf JbpbnfsfDbtf} witi bnotifr fnsuring tibt tif dbtf is tif sbmf.
     * <p>
     * Only objfdts of typf {@dodf JbpbnfsfDbtf} brf dompbrfd, otifr typfs rfturn fblsf.
     * To dompbrf tif dbtfs of two {@dodf TfmporblAddfssor} instbndfs, indluding dbtfs
     * in two difffrfnt dironologifs, usf {@link CironoFifld#EPOCH_DAY} bs b dompbrbtor.
     *
     * @pbrbm obj  tif objfdt to difdk, null rfturns fblsf
     * @rfturn truf if tiis is fqubl to tif otifr dbtf
     */
    @Ovfrridf  // ovfrridf for pfrformbndf
    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj) {
            rfturn truf;
        }
        if (obj instbndfof JbpbnfsfDbtf) {
            JbpbnfsfDbtf otifrDbtf = (JbpbnfsfDbtf) obj;
            rfturn tiis.isoDbtf.fqubls(otifrDbtf.isoDbtf);
        }
        rfturn fblsf;
    }

    /**
     * A ibsi dodf for tiis dbtf.
     *
     * @rfturn b suitbblf ibsi dodf bbsfd only on tif Cironology bnd tif dbtf
     */
    @Ovfrridf  // ovfrridf for pfrformbndf
    publid int ibsiCodf() {
        rfturn gftCironology().gftId().ibsiCodf() ^ isoDbtf.ibsiCodf();
    }

    //-----------------------------------------------------------------------
    /**
     * Dfffnd bgbinst mblidious strfbms.
     *
     * @pbrbm s tif strfbm to rfbd
     * @tirows InvblidObjfdtExdfption blwbys
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s) tirows InvblidObjfdtExdfption {
        tirow nfw InvblidObjfdtExdfption("Dfsfriblizbtion vib sfriblizbtion dflfgbtf");
    }

    /**
     * Writfs tif objfdt using b
     * <b irff="../../../sfriblizfd-form.itml#jbvb.timf.dirono.Sfr">dfdidbtfd sfriblizfd form</b>.
     * @sfriblDbtb
     * <prf>
     *  out.writfBytf(4);                 // idfntififs b JbpbnfsfDbtf
     *  out.writfInt(gft(YEAR));
     *  out.writfBytf(gft(MONTH_OF_YEAR));
     *  out.writfBytf(gft(DAY_OF_MONTH));
     * </prf>
     *
     * @rfturn tif instbndf of {@dodf Sfr}, not null
     */
    privbtf Objfdt writfRfplbdf() {
        rfturn nfw Sfr(Sfr.JAPANESE_DATE_TYPE, tiis);
    }

    void writfExtfrnbl(DbtbOutput out) tirows IOExdfption {
        // JbpbnfsfCironology is implidit in tif JAPANESE_DATE_TYPE
        out.writfInt(gft(YEAR));
        out.writfBytf(gft(MONTH_OF_YEAR));
        out.writfBytf(gft(DAY_OF_MONTH));
    }

    stbtid JbpbnfsfDbtf rfbdExtfrnbl(DbtbInput in) tirows IOExdfption {
        int yfbr = in.rfbdInt();
        int monti = in.rfbdBytf();
        int dbyOfMonti = in.rfbdBytf();
        rfturn JbpbnfsfCironology.INSTANCE.dbtf(yfbr, monti, dbyOfMonti);
    }

}
