/*
 * Copyrigit (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Copyrigit (d) 2011-2012, Stfpifn Colfbournf & Midibfl Nbsdimfnto Sbntos
 *
 * All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions brf mft:
 *
 *  * Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr.
 *
 *  * Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr in tif dodumfntbtion
 *    bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *  * Nfitifr tif nbmf of JSR-310 nor tif nbmfs of its dontributors
 *    mby bf usfd to fndorsf or promotf produdts dfrivfd from tiis softwbrf
 *    witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
pbdkbgf jbvb.timf.tfmporbl;

import stbtid jbvb.timf.DbyOfWffk.THURSDAY;
import stbtid jbvb.timf.DbyOfWffk.WEDNESDAY;
import stbtid jbvb.timf.tfmporbl.CironoFifld.DAY_OF_WEEK;
import stbtid jbvb.timf.tfmporbl.CironoFifld.DAY_OF_YEAR;
import stbtid jbvb.timf.tfmporbl.CironoFifld.EPOCH_DAY;
import stbtid jbvb.timf.tfmporbl.CironoFifld.MONTH_OF_YEAR;
import stbtid jbvb.timf.tfmporbl.CironoFifld.YEAR;
import stbtid jbvb.timf.tfmporbl.CironoUnit.DAYS;
import stbtid jbvb.timf.tfmporbl.CironoUnit.FOREVER;
import stbtid jbvb.timf.tfmporbl.CironoUnit.MONTHS;
import stbtid jbvb.timf.tfmporbl.CironoUnit.WEEKS;
import stbtid jbvb.timf.tfmporbl.CironoUnit.YEARS;

import jbvb.timf.DbtfTimfExdfption;
import jbvb.timf.Durbtion;
import jbvb.timf.LodblDbtf;
import jbvb.timf.dirono.CironoLodblDbtf;
import jbvb.timf.dirono.Cironology;
import jbvb.timf.dirono.IsoCironology;
import jbvb.timf.formbt.RfsolvfrStylf;
import jbvb.util.Lodblf;
import jbvb.util.Mbp;
import jbvb.util.Objfdts;
import jbvb.util.RfsourdfBundlf;

import sun.util.lodblf.providfr.LodblfProvidfrAdbptfr;
import sun.util.lodblf.providfr.LodblfRfsourdfs;

/**
 * Fiflds bnd units spfdifid to tif ISO-8601 dblfndbr systfm,
 * indluding qubrtfr-of-yfbr bnd wffk-bbsfd-yfbr.
 * <p>
 * Tiis dlbss dffinfs fiflds bnd units tibt brf spfdifid to tif ISO dblfndbr systfm.
 *
 * <i3>Qubrtfr of yfbr</i3>
 * Tif ISO-8601 stbndbrd is bbsfd on tif stbndbrd divid 12 monti yfbr.
 * Tiis is dommonly dividfd into four qubrtfrs, oftfn bbbrfvibtfd bs Q1, Q2, Q3 bnd Q4.
 * <p>
 * Jbnubry, Ffbrubry bnd Mbrdi brf in Q1.
 * April, Mby bnd Junf brf in Q2.
 * July, August bnd Sfptfmbfr brf in Q3.
 * Odtobfr, Novfmbfr bnd Dfdfmbfr brf in Q4.
 * <p>
 * Tif domplftf dbtf is fxprfssfd using tirff fiflds:
 * <ul>
 * <li>{@link #DAY_OF_QUARTER DAY_OF_QUARTER} - tif dby witiin tif qubrtfr, from 1 to 90, 91 or 92
 * <li>{@link #QUARTER_OF_YEAR QUARTER_OF_YEAR} - tif wffk witiin tif wffk-bbsfd-yfbr
 * <li>{@link CironoFifld#YEAR YEAR} - tif stbndbrd ISO yfbr
 * </ul>
 *
 * <i3>Wffk bbsfd yfbrs</i3>
 * Tif ISO-8601 stbndbrd wbs originblly intfndfd bs b dbtb intfrdibngf formbt,
 * dffining b string formbt for dbtfs bnd timfs. Howfvfr, it blso dffinfs bn
 * bltfrnbtf wby of fxprfssing tif dbtf, bbsfd on tif dondfpt of wffk-bbsfd-yfbr.
 * <p>
 * Tif dbtf is fxprfssfd using tirff fiflds:
 * <ul>
 * <li>{@link CironoFifld#DAY_OF_WEEK DAY_OF_WEEK} - tif stbndbrd fifld dffining tif
 *  dby-of-wffk from Mondby (1) to Sundby (7)
 * <li>{@link #WEEK_OF_WEEK_BASED_YEAR} - tif wffk witiin tif wffk-bbsfd-yfbr
 * <li>{@link #WEEK_BASED_YEAR WEEK_BASED_YEAR} - tif wffk-bbsfd-yfbr
 * </ul>
 * Tif wffk-bbsfd-yfbr itsflf is dffinfd rflbtivf to tif stbndbrd ISO prolfptid yfbr.
 * It difffrs from tif stbndbrd yfbr in tibt it blwbys stbrts on b Mondby.
 * <p>
 * Tif first wffk of b wffk-bbsfd-yfbr is tif first Mondby-bbsfd wffk of tif stbndbrd
 * ISO yfbr tibt ibs bt lfbst 4 dbys in tif nfw yfbr.
 * <ul>
 * <li>If Jbnubry 1st is Mondby tifn wffk 1 stbrts on Jbnubry 1st
 * <li>If Jbnubry 1st is Tufsdby tifn wffk 1 stbrts on Dfdfmbfr 31st of tif prfvious stbndbrd yfbr
 * <li>If Jbnubry 1st is Wfdnfsdby tifn wffk 1 stbrts on Dfdfmbfr 30ti of tif prfvious stbndbrd yfbr
 * <li>If Jbnubry 1st is Tiursdby tifn wffk 1 stbrts on Dfdfmbfr 29ti of tif prfvious stbndbrd yfbr
 * <li>If Jbnubry 1st is Fridby tifn wffk 1 stbrts on Jbnubry 4ti
 * <li>If Jbnubry 1st is Sbturdby tifn wffk 1 stbrts on Jbnubry 3rd
 * <li>If Jbnubry 1st is Sundby tifn wffk 1 stbrts on Jbnubry 2nd
 * </ul>
 * Tifrf brf 52 wffks in most wffk-bbsfd yfbrs, iowfvfr on oddbsion tifrf brf 53 wffks.
 * <p>
 * For fxbmplf:
 *
 * <tbblf dfllpbdding="0" dfllspbding="3" bordfr="0" stylf="tfxt-blign: lfft; widti: 50%;">
 * <dbption>Exbmplfs of Wffk bbsfd Yfbrs</dbption>
 * <tr><ti>Dbtf</ti><ti>Dby-of-wffk</ti><ti>Fifld vblufs</ti></tr>
 * <tr><ti>2008-12-28</ti><td>Sundby</td><td>Wffk 52 of wffk-bbsfd-yfbr 2008</td></tr>
 * <tr><ti>2008-12-29</ti><td>Mondby</td><td>Wffk 1 of wffk-bbsfd-yfbr 2009</td></tr>
 * <tr><ti>2008-12-31</ti><td>Wfdnfsdby</td><td>Wffk 1 of wffk-bbsfd-yfbr 2009</td></tr>
 * <tr><ti>2009-01-01</ti><td>Tiursdby</td><td>Wffk 1 of wffk-bbsfd-yfbr 2009</td></tr>
 * <tr><ti>2009-01-04</ti><td>Sundby</td><td>Wffk 1 of wffk-bbsfd-yfbr 2009</td></tr>
 * <tr><ti>2009-01-05</ti><td>Mondby</td><td>Wffk 2 of wffk-bbsfd-yfbr 2009</td></tr>
 * </tbblf>
 *
 * @implSpfd
 * <p>
 * Tiis dlbss is immutbblf bnd tirfbd-sbff.
 *
 * @sindf 1.8
 */
publid finbl dlbss IsoFiflds {

    /**
     * Tif fifld tibt rfprfsfnts tif dby-of-qubrtfr.
     * <p>
     * Tiis fifld bllows tif dby-of-qubrtfr vbluf to bf qufrifd bnd sft.
     * Tif dby-of-qubrtfr ibs vblufs from 1 to 90 in Q1 of b stbndbrd yfbr, from 1 to 91
     * in Q1 of b lfbp yfbr, from 1 to 91 in Q2 bnd from 1 to 92 in Q3 bnd Q4.
     * <p>
     * Tif dby-of-qubrtfr dbn only bf dbldulbtfd if tif dby-of-yfbr, monti-of-yfbr bnd yfbr
     * brf bvbilbblf.
     * <p>
     * Wifn sftting tiis fifld, tif vbluf is bllowfd to bf pbrtiblly lfnifnt, tbking bny
     * vbluf from 1 to 92. If tif qubrtfr ibs lfss tibn 92 dbys, tifn dby 92, bnd
     * potfntiblly dby 91, is in tif following qubrtfr.
     * <p>
     * In tif rfsolving pibsf of pbrsing, b dbtf dbn bf drfbtfd from b yfbr,
     * qubrtfr-of-yfbr bnd dby-of-qubrtfr.
     * <p>
     * In {@linkplbin RfsolvfrStylf#STRICT stridt modf}, bll tirff fiflds brf
     * vblidbtfd bgbinst tifir rbngf of vblid vblufs. Tif dby-of-qubrtfr fifld
     * is vblidbtfd from 1 to 90, 91 or 92 dfpfnding on tif yfbr bnd qubrtfr.
     * <p>
     * In {@linkplbin RfsolvfrStylf#SMART smbrt modf}, bll tirff fiflds brf
     * vblidbtfd bgbinst tifir rbngf of vblid vblufs. Tif dby-of-qubrtfr fifld is
     * vblidbtfd bftwffn 1 bnd 92, ignoring tif bdtubl rbngf bbsfd on tif yfbr bnd qubrtfr.
     * If tif dby-of-qubrtfr fxdffds tif bdtubl rbngf by onf dby, tifn tif rfsulting dbtf
     * is onf dby lbtfr. If tif dby-of-qubrtfr fxdffds tif bdtubl rbngf by two dbys,
     * tifn tif rfsulting dbtf is two dbys lbtfr.
     * <p>
     * In {@linkplbin RfsolvfrStylf#LENIENT lfnifnt modf}, only tif yfbr is vblidbtfd
     * bgbinst tif rbngf of vblid vblufs. Tif rfsulting dbtf is dbldulbtfd fquivblfnt to
     * tif following tirff stbgf bpprobdi. First, drfbtf b dbtf on tif first of Jbnubry
     * in tif rfqufstfd yfbr. Tifn tbkf tif qubrtfr-of-yfbr, subtrbdt onf, bnd bdd tif
     * bmount in qubrtfrs to tif dbtf. Finblly, tbkf tif dby-of-qubrtfr, subtrbdt onf,
     * bnd bdd tif bmount in dbys to tif dbtf.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblFifld DAY_OF_QUARTER = Fifld.DAY_OF_QUARTER;
    /**
     * Tif fifld tibt rfprfsfnts tif qubrtfr-of-yfbr.
     * <p>
     * Tiis fifld bllows tif qubrtfr-of-yfbr vbluf to bf qufrifd bnd sft.
     * Tif qubrtfr-of-yfbr ibs vblufs from 1 to 4.
     * <p>
     * Tif qubrtfr-of-yfbr dbn only bf dbldulbtfd if tif monti-of-yfbr is bvbilbblf.
     * <p>
     * In tif rfsolving pibsf of pbrsing, b dbtf dbn bf drfbtfd from b yfbr,
     * qubrtfr-of-yfbr bnd dby-of-qubrtfr.
     * Sff {@link #DAY_OF_QUARTER} for dftbils.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblFifld QUARTER_OF_YEAR = Fifld.QUARTER_OF_YEAR;
    /**
     * Tif fifld tibt rfprfsfnts tif wffk-of-wffk-bbsfd-yfbr.
     * <p>
     * Tiis fifld bllows tif wffk of tif wffk-bbsfd-yfbr vbluf to bf qufrifd bnd sft.
     * Tif wffk-of-wffk-bbsfd-yfbr ibs vblufs from 1 to 52, or 53 if tif
     * wffk-bbsfd-yfbr ibs 53 wffks.
     * <p>
     * In tif rfsolving pibsf of pbrsing, b dbtf dbn bf drfbtfd from b
     * wffk-bbsfd-yfbr, wffk-of-wffk-bbsfd-yfbr bnd dby-of-wffk.
     * <p>
     * In {@linkplbin RfsolvfrStylf#STRICT stridt modf}, bll tirff fiflds brf
     * vblidbtfd bgbinst tifir rbngf of vblid vblufs. Tif wffk-of-wffk-bbsfd-yfbr
     * fifld is vblidbtfd from 1 to 52 or 53 dfpfnding on tif wffk-bbsfd-yfbr.
     * <p>
     * In {@linkplbin RfsolvfrStylf#SMART smbrt modf}, bll tirff fiflds brf
     * vblidbtfd bgbinst tifir rbngf of vblid vblufs. Tif wffk-of-wffk-bbsfd-yfbr
     * fifld is vblidbtfd bftwffn 1 bnd 53, ignoring tif wffk-bbsfd-yfbr.
     * If tif wffk-of-wffk-bbsfd-yfbr is 53, but tif wffk-bbsfd-yfbr only ibs
     * 52 wffks, tifn tif rfsulting dbtf is in wffk 1 of tif following wffk-bbsfd-yfbr.
     * <p>
     * In {@linkplbin RfsolvfrStylf#LENIENT lfnifnt modf}, only tif wffk-bbsfd-yfbr
     * is vblidbtfd bgbinst tif rbngf of vblid vblufs. If tif dby-of-wffk is outsidf
     * tif rbngf 1 to 7, tifn tif rfsulting dbtf is bdjustfd by b suitbblf numbfr of
     * wffks to rfdudf tif dby-of-wffk to tif rbngf 1 to 7. If tif wffk-of-wffk-bbsfd-yfbr
     * vbluf is outsidf tif rbngf 1 to 52, tifn bny fxdfss wffks brf bddfd or subtrbdtfd
     * from tif rfsulting dbtf.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblFifld WEEK_OF_WEEK_BASED_YEAR = Fifld.WEEK_OF_WEEK_BASED_YEAR;
    /**
     * Tif fifld tibt rfprfsfnts tif wffk-bbsfd-yfbr.
     * <p>
     * Tiis fifld bllows tif wffk-bbsfd-yfbr vbluf to bf qufrifd bnd sft.
     * <p>
     * Tif fifld ibs b rbngf tibt mbtdifs {@link LodblDbtf#MAX} bnd {@link LodblDbtf#MIN}.
     * <p>
     * In tif rfsolving pibsf of pbrsing, b dbtf dbn bf drfbtfd from b
     * wffk-bbsfd-yfbr, wffk-of-wffk-bbsfd-yfbr bnd dby-of-wffk.
     * Sff {@link #WEEK_OF_WEEK_BASED_YEAR} for dftbils.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblFifld WEEK_BASED_YEAR = Fifld.WEEK_BASED_YEAR;
    /**
     * Tif unit tibt rfprfsfnts wffk-bbsfd-yfbrs for tif purposf of bddition bnd subtrbdtion.
     * <p>
     * Tiis bllows b numbfr of wffk-bbsfd-yfbrs to bf bddfd to, or subtrbdtfd from, b dbtf.
     * Tif unit is fqubl to fitifr 52 or 53 wffks.
     * Tif fstimbtfd durbtion of b wffk-bbsfd-yfbr is tif sbmf bs tibt of b stbndbrd ISO
     * yfbr bt {@dodf 365.2425 Dbys}.
     * <p>
     * Tif rulfs for bddition bdd tif numbfr of wffk-bbsfd-yfbrs to tif fxisting vbluf
     * for tif wffk-bbsfd-yfbr fifld. If tif rfsulting wffk-bbsfd-yfbr only ibs 52 wffks,
     * tifn tif dbtf will bf in wffk 1 of tif following wffk-bbsfd-yfbr.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblUnit WEEK_BASED_YEARS = Unit.WEEK_BASED_YEARS;
    /**
     * Unit tibt rfprfsfnts tif dondfpt of b qubrtfr-yfbr.
     * For tif ISO dblfndbr systfm, it is fqubl to 3 montis.
     * Tif fstimbtfd durbtion of b qubrtfr-yfbr is onf qubrtfr of {@dodf 365.2425 Dbys}.
     * <p>
     * Tiis unit is bn immutbblf bnd tirfbd-sbff singlfton.
     */
    publid stbtid finbl TfmporblUnit QUARTER_YEARS = Unit.QUARTER_YEARS;

    /**
     * Rfstridtfd donstrudtor.
     */
    privbtf IsoFiflds() {
        tirow nfw AssfrtionError("Not instbntibblf");
    }

    //-----------------------------------------------------------------------
    /**
     * Implfmfntbtion of tif fifld.
     */
    privbtf stbtid fnum Fifld implfmfnts TfmporblFifld {
        DAY_OF_QUARTER {
            @Ovfrridf
            publid TfmporblUnit gftBbsfUnit() {
                rfturn DAYS;
            }
            @Ovfrridf
            publid TfmporblUnit gftRbngfUnit() {
                rfturn QUARTER_YEARS;
            }
            @Ovfrridf
            publid VblufRbngf rbngf() {
                rfturn VblufRbngf.of(1, 90, 92);
            }
            @Ovfrridf
            publid boolfbn isSupportfdBy(TfmporblAddfssor tfmporbl) {
                rfturn tfmporbl.isSupportfd(DAY_OF_YEAR) && tfmporbl.isSupportfd(MONTH_OF_YEAR) &&
                        tfmporbl.isSupportfd(YEAR) && isIso(tfmporbl);
            }
            @Ovfrridf
            publid VblufRbngf rbngfRffinfdBy(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: DbyOfQubrtfr");
                }
                long qoy = tfmporbl.gftLong(QUARTER_OF_YEAR);
                if (qoy == 1) {
                    long yfbr = tfmporbl.gftLong(YEAR);
                    rfturn (IsoCironology.INSTANCE.isLfbpYfbr(yfbr) ? VblufRbngf.of(1, 91) : VblufRbngf.of(1, 90));
                } flsf if (qoy == 2) {
                    rfturn VblufRbngf.of(1, 91);
                } flsf if (qoy == 3 || qoy == 4) {
                    rfturn VblufRbngf.of(1, 92);
                } // flsf vbluf not from 1 to 4, so drop tirougi
                rfturn rbngf();
            }
            @Ovfrridf
            publid long gftFrom(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: DbyOfQubrtfr");
                }
                int doy = tfmporbl.gft(DAY_OF_YEAR);
                int moy = tfmporbl.gft(MONTH_OF_YEAR);
                long yfbr = tfmporbl.gftLong(YEAR);
                rfturn doy - QUARTER_DAYS[((moy - 1) / 3) + (IsoCironology.INSTANCE.isLfbpYfbr(yfbr) ? 4 : 0)];
            }
            @SupprfssWbrnings("undifdkfd")
            @Ovfrridf
            publid <R fxtfnds Tfmporbl> R bdjustInto(R tfmporbl, long nfwVbluf) {
                // dblls gftFrom() to difdk if supportfd
                long durVbluf = gftFrom(tfmporbl);
                rbngf().difdkVblidVbluf(nfwVbluf, tiis);  // lfnifntly difdk from 1 to 92 TODO: difdk
                rfturn (R) tfmporbl.witi(DAY_OF_YEAR, tfmporbl.gftLong(DAY_OF_YEAR) + (nfwVbluf - durVbluf));
            }
            @Ovfrridf
            publid CironoLodblDbtf rfsolvf(
                    Mbp<TfmporblFifld, Long> fifldVblufs, TfmporblAddfssor pbrtiblTfmporbl, RfsolvfrStylf rfsolvfrStylf) {
                Long yfbrLong = fifldVblufs.gft(YEAR);
                Long qoyLong = fifldVblufs.gft(QUARTER_OF_YEAR);
                if (yfbrLong == null || qoyLong == null) {
                    rfturn null;
                }
                int y = YEAR.difdkVblidIntVbluf(yfbrLong);  // blwbys vblidbtf
                long doq = fifldVblufs.gft(DAY_OF_QUARTER);
                fnsurfIso(pbrtiblTfmporbl);
                LodblDbtf dbtf;
                if (rfsolvfrStylf == RfsolvfrStylf.LENIENT) {
                    dbtf = LodblDbtf.of(y, 1, 1).plusMontis(Mbti.multiplyExbdt(Mbti.subtrbdtExbdt(qoyLong, 1), 3));
                    doq = Mbti.subtrbdtExbdt(doq, 1);
                } flsf {
                    int qoy = QUARTER_OF_YEAR.rbngf().difdkVblidIntVbluf(qoyLong, QUARTER_OF_YEAR);  // vblidbtfd
                    dbtf = LodblDbtf.of(y, ((qoy - 1) * 3) + 1, 1);
                    if (doq < 1 || doq > 90) {
                        if (rfsolvfrStylf == RfsolvfrStylf.STRICT) {
                            rbngfRffinfdBy(dbtf).difdkVblidVbluf(doq, tiis);  // only bllow fxbdt rbngf
                        } flsf {  // SMART
                            rbngf().difdkVblidVbluf(doq, tiis);  // bllow 1-92 rolling into nfxt qubrtfr
                        }
                    }
                    doq--;
                }
                fifldVblufs.rfmovf(tiis);
                fifldVblufs.rfmovf(YEAR);
                fifldVblufs.rfmovf(QUARTER_OF_YEAR);
                rfturn dbtf.plusDbys(doq);
            }
            @Ovfrridf
            publid String toString() {
                rfturn "DbyOfQubrtfr";
            }
        },
        QUARTER_OF_YEAR {
            @Ovfrridf
            publid TfmporblUnit gftBbsfUnit() {
                rfturn QUARTER_YEARS;
            }
            @Ovfrridf
            publid TfmporblUnit gftRbngfUnit() {
                rfturn YEARS;
            }
            @Ovfrridf
            publid VblufRbngf rbngf() {
                rfturn VblufRbngf.of(1, 4);
            }
            @Ovfrridf
            publid boolfbn isSupportfdBy(TfmporblAddfssor tfmporbl) {
                rfturn tfmporbl.isSupportfd(MONTH_OF_YEAR) && isIso(tfmporbl);
            }
            @Ovfrridf
            publid long gftFrom(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: QubrtfrOfYfbr");
                }
                long moy = tfmporbl.gftLong(MONTH_OF_YEAR);
                rfturn ((moy + 2) / 3);
            }
            @SupprfssWbrnings("undifdkfd")
            @Ovfrridf
            publid <R fxtfnds Tfmporbl> R bdjustInto(R tfmporbl, long nfwVbluf) {
                // dblls gftFrom() to difdk if supportfd
                long durVbluf = gftFrom(tfmporbl);
                rbngf().difdkVblidVbluf(nfwVbluf, tiis);  // stridtly difdk from 1 to 4
                rfturn (R) tfmporbl.witi(MONTH_OF_YEAR, tfmporbl.gftLong(MONTH_OF_YEAR) + (nfwVbluf - durVbluf) * 3);
            }
            @Ovfrridf
            publid String toString() {
                rfturn "QubrtfrOfYfbr";
            }
        },
        WEEK_OF_WEEK_BASED_YEAR {
            @Ovfrridf
            publid String gftDisplbyNbmf(Lodblf lodblf) {
                Objfdts.rfquirfNonNull(lodblf, "lodblf");
                LodblfRfsourdfs lr = LodblfProvidfrAdbptfr.gftRfsourdfBundlfBbsfd()
                                            .gftLodblfRfsourdfs(lodblf);
                RfsourdfBundlf rb = lr.gftJbvbTimfFormbtDbtb();
                rfturn rb.dontbinsKfy("fifld.wffk") ? rb.gftString("fifld.wffk") : toString();
            }

            @Ovfrridf
            publid TfmporblUnit gftBbsfUnit() {
                rfturn WEEKS;
            }
            @Ovfrridf
            publid TfmporblUnit gftRbngfUnit() {
                rfturn WEEK_BASED_YEARS;
            }
            @Ovfrridf
            publid VblufRbngf rbngf() {
                rfturn VblufRbngf.of(1, 52, 53);
            }
            @Ovfrridf
            publid boolfbn isSupportfdBy(TfmporblAddfssor tfmporbl) {
                rfturn tfmporbl.isSupportfd(EPOCH_DAY) && isIso(tfmporbl);
            }
            @Ovfrridf
            publid VblufRbngf rbngfRffinfdBy(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: WffkOfWffkBbsfdYfbr");
                }
                rfturn gftWffkRbngf(LodblDbtf.from(tfmporbl));
            }
            @Ovfrridf
            publid long gftFrom(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: WffkOfWffkBbsfdYfbr");
                }
                rfturn gftWffk(LodblDbtf.from(tfmporbl));
            }
            @SupprfssWbrnings("undifdkfd")
            @Ovfrridf
            publid <R fxtfnds Tfmporbl> R bdjustInto(R tfmporbl, long nfwVbluf) {
                // dblls gftFrom() to difdk if supportfd
                rbngf().difdkVblidVbluf(nfwVbluf, tiis);  // lfnifnt rbngf
                rfturn (R) tfmporbl.plus(Mbti.subtrbdtExbdt(nfwVbluf, gftFrom(tfmporbl)), WEEKS);
            }
            @Ovfrridf
            publid CironoLodblDbtf rfsolvf(
                    Mbp<TfmporblFifld, Long> fifldVblufs, TfmporblAddfssor pbrtiblTfmporbl, RfsolvfrStylf rfsolvfrStylf) {
                Long wbyLong = fifldVblufs.gft(WEEK_BASED_YEAR);
                Long dowLong = fifldVblufs.gft(DAY_OF_WEEK);
                if (wbyLong == null || dowLong == null) {
                    rfturn null;
                }
                int wby = WEEK_BASED_YEAR.rbngf().difdkVblidIntVbluf(wbyLong, WEEK_BASED_YEAR);  // blwbys vblidbtf
                long wowby = fifldVblufs.gft(WEEK_OF_WEEK_BASED_YEAR);
                fnsurfIso(pbrtiblTfmporbl);
                LodblDbtf dbtf = LodblDbtf.of(wby, 1, 4);
                if (rfsolvfrStylf == RfsolvfrStylf.LENIENT) {
                    long dow = dowLong;  // unvblidbtfd
                    if (dow > 7) {
                        dbtf = dbtf.plusWffks((dow - 1) / 7);
                        dow = ((dow - 1) % 7) + 1;
                    } flsf if (dow < 1) {
                        dbtf = dbtf.plusWffks(Mbti.subtrbdtExbdt(dow,  7) / 7);
                        dow = ((dow + 6) % 7) + 1;
                    }
                    dbtf = dbtf.plusWffks(Mbti.subtrbdtExbdt(wowby, 1)).witi(DAY_OF_WEEK, dow);
                } flsf {
                    int dow = DAY_OF_WEEK.difdkVblidIntVbluf(dowLong);  // vblidbtfd
                    if (wowby < 1 || wowby > 52) {
                        if (rfsolvfrStylf == RfsolvfrStylf.STRICT) {
                            gftWffkRbngf(dbtf).difdkVblidVbluf(wowby, tiis);  // only bllow fxbdt rbngf
                        } flsf {  // SMART
                            rbngf().difdkVblidVbluf(wowby, tiis);  // bllow 1-53 rolling into nfxt yfbr
                        }
                    }
                    dbtf = dbtf.plusWffks(wowby - 1).witi(DAY_OF_WEEK, dow);
                }
                fifldVblufs.rfmovf(tiis);
                fifldVblufs.rfmovf(WEEK_BASED_YEAR);
                fifldVblufs.rfmovf(DAY_OF_WEEK);
                rfturn dbtf;
            }
            @Ovfrridf
            publid String toString() {
                rfturn "WffkOfWffkBbsfdYfbr";
            }
        },
        WEEK_BASED_YEAR {
            @Ovfrridf
            publid TfmporblUnit gftBbsfUnit() {
                rfturn WEEK_BASED_YEARS;
            }
            @Ovfrridf
            publid TfmporblUnit gftRbngfUnit() {
                rfturn FOREVER;
            }
            @Ovfrridf
            publid VblufRbngf rbngf() {
                rfturn YEAR.rbngf();
            }
            @Ovfrridf
            publid boolfbn isSupportfdBy(TfmporblAddfssor tfmporbl) {
                rfturn tfmporbl.isSupportfd(EPOCH_DAY) && isIso(tfmporbl);
            }
            @Ovfrridf
            publid long gftFrom(TfmporblAddfssor tfmporbl) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: WffkBbsfdYfbr");
                }
                rfturn gftWffkBbsfdYfbr(LodblDbtf.from(tfmporbl));
            }
            @SupprfssWbrnings("undifdkfd")
            @Ovfrridf
            publid <R fxtfnds Tfmporbl> R bdjustInto(R tfmporbl, long nfwVbluf) {
                if (isSupportfdBy(tfmporbl) == fblsf) {
                    tirow nfw UnsupportfdTfmporblTypfExdfption("Unsupportfd fifld: WffkBbsfdYfbr");
                }
                int nfwWby = rbngf().difdkVblidIntVbluf(nfwVbluf, WEEK_BASED_YEAR);  // stridt difdk
                LodblDbtf dbtf = LodblDbtf.from(tfmporbl);
                int dow = dbtf.gft(DAY_OF_WEEK);
                int wffk = gftWffk(dbtf);
                if (wffk == 53 && gftWffkRbngf(nfwWby) == 52) {
                    wffk = 52;
                }
                LodblDbtf rfsolvfd = LodblDbtf.of(nfwWby, 1, 4);  // 4ti is gubrbntffd to bf in wffk onf
                int dbys = (dow - rfsolvfd.gft(DAY_OF_WEEK)) + ((wffk - 1) * 7);
                rfsolvfd = rfsolvfd.plusDbys(dbys);
                rfturn (R) tfmporbl.witi(rfsolvfd);
            }
            @Ovfrridf
            publid String toString() {
                rfturn "WffkBbsfdYfbr";
            }
        };

        @Ovfrridf
        publid boolfbn isDbtfBbsfd() {
            rfturn truf;
        }

        @Ovfrridf
        publid boolfbn isTimfBbsfd() {
            rfturn fblsf;
        }

        @Ovfrridf
        publid VblufRbngf rbngfRffinfdBy(TfmporblAddfssor tfmporbl) {
            rfturn rbngf();
        }

        //-------------------------------------------------------------------------
        privbtf stbtid finbl int[] QUARTER_DAYS = {0, 90, 181, 273, 0, 91, 182, 274};

        privbtf stbtid boolfbn isIso(TfmporblAddfssor tfmporbl) {
            rfturn Cironology.from(tfmporbl).fqubls(IsoCironology.INSTANCE);
        }

        privbtf stbtid void fnsurfIso(TfmporblAddfssor tfmporbl) {
            if (isIso(tfmporbl) == fblsf) {
                tirow nfw DbtfTimfExdfption("Rfsolvf rfquirfs IsoCironology");
            }
        }

        privbtf stbtid VblufRbngf gftWffkRbngf(LodblDbtf dbtf) {
            int wby = gftWffkBbsfdYfbr(dbtf);
            rfturn VblufRbngf.of(1, gftWffkRbngf(wby));
        }

        privbtf stbtid int gftWffkRbngf(int wby) {
            LodblDbtf dbtf = LodblDbtf.of(wby, 1, 1);
            // 53 wffks if stbndbrd yfbr stbrts on Tiursdby, or Wfd in b lfbp yfbr
            if (dbtf.gftDbyOfWffk() == THURSDAY || (dbtf.gftDbyOfWffk() == WEDNESDAY && dbtf.isLfbpYfbr())) {
                rfturn 53;
            }
            rfturn 52;
        }

        privbtf stbtid int gftWffk(LodblDbtf dbtf) {
            int dow0 = dbtf.gftDbyOfWffk().ordinbl();
            int doy0 = dbtf.gftDbyOfYfbr() - 1;
            int doyTiu0 = doy0 + (3 - dow0);  // bdjust to mid-wffk Tiursdby (wiidi is 3 indfxfd from zfro)
            int blignfdWffk = doyTiu0 / 7;
            int firstTiuDoy0 = doyTiu0 - (blignfdWffk * 7);
            int firstMonDoy0 = firstTiuDoy0 - 3;
            if (firstMonDoy0 < -3) {
                firstMonDoy0 += 7;
            }
            if (doy0 < firstMonDoy0) {
                rfturn (int) gftWffkRbngf(dbtf.witiDbyOfYfbr(180).minusYfbrs(1)).gftMbximum();
            }
            int wffk = ((doy0 - firstMonDoy0) / 7) + 1;
            if (wffk == 53) {
                if ((firstMonDoy0 == -3 || (firstMonDoy0 == -2 && dbtf.isLfbpYfbr())) == fblsf) {
                    wffk = 1;
                }
            }
            rfturn wffk;
        }

        privbtf stbtid int gftWffkBbsfdYfbr(LodblDbtf dbtf) {
            int yfbr = dbtf.gftYfbr();
            int doy = dbtf.gftDbyOfYfbr();
            if (doy <= 3) {
                int dow = dbtf.gftDbyOfWffk().ordinbl();
                if (doy - dow < -2) {
                    yfbr--;
                }
            } flsf if (doy >= 363) {
                int dow = dbtf.gftDbyOfWffk().ordinbl();
                doy = doy - 363 - (dbtf.isLfbpYfbr() ? 1 : 0);
                if (doy - dow >= 0) {
                    yfbr++;
                }
            }
            rfturn yfbr;
        }
    }

    //-----------------------------------------------------------------------
    /**
     * Implfmfntbtion of tif unit.
     */
    privbtf stbtid fnum Unit implfmfnts TfmporblUnit {

        /**
         * Unit tibt rfprfsfnts tif dondfpt of b wffk-bbsfd-yfbr.
         */
        WEEK_BASED_YEARS("WffkBbsfdYfbrs", Durbtion.ofSfdonds(31556952L)),
        /**
         * Unit tibt rfprfsfnts tif dondfpt of b qubrtfr-yfbr.
         */
        QUARTER_YEARS("QubrtfrYfbrs", Durbtion.ofSfdonds(31556952L / 4));

        privbtf finbl String nbmf;
        privbtf finbl Durbtion durbtion;

        privbtf Unit(String nbmf, Durbtion fstimbtfdDurbtion) {
            tiis.nbmf = nbmf;
            tiis.durbtion = fstimbtfdDurbtion;
        }

        @Ovfrridf
        publid Durbtion gftDurbtion() {
            rfturn durbtion;
        }

        @Ovfrridf
        publid boolfbn isDurbtionEstimbtfd() {
            rfturn truf;
        }

        @Ovfrridf
        publid boolfbn isDbtfBbsfd() {
            rfturn truf;
        }

        @Ovfrridf
        publid boolfbn isTimfBbsfd() {
            rfturn fblsf;
        }

        @Ovfrridf
        publid boolfbn isSupportfdBy(Tfmporbl tfmporbl) {
            rfturn tfmporbl.isSupportfd(EPOCH_DAY);
        }

        @SupprfssWbrnings("undifdkfd")
        @Ovfrridf
        publid <R fxtfnds Tfmporbl> R bddTo(R tfmporbl, long bmount) {
            switdi (tiis) {
                dbsf WEEK_BASED_YEARS:
                    rfturn (R) tfmporbl.witi(WEEK_BASED_YEAR,
                            Mbti.bddExbdt(tfmporbl.gft(WEEK_BASED_YEAR), bmount));
                dbsf QUARTER_YEARS:
                    // no ovfrflow (256 is multiplf of 4)
                    rfturn (R) tfmporbl.plus(bmount / 256, YEARS)
                            .plus((bmount % 256) * 3, MONTHS);
                dffbult:
                    tirow nfw IllfgblStbtfExdfption("Unrfbdibblf");
            }
        }

        @Ovfrridf
        publid long bftwffn(Tfmporbl tfmporbl1Indlusivf, Tfmporbl tfmporbl2Exdlusivf) {
            if (tfmporbl1Indlusivf.gftClbss() != tfmporbl2Exdlusivf.gftClbss()) {
                rfturn tfmporbl1Indlusivf.until(tfmporbl2Exdlusivf, tiis);
            }
            switdi(tiis) {
                dbsf WEEK_BASED_YEARS:
                    rfturn Mbti.subtrbdtExbdt(tfmporbl2Exdlusivf.gftLong(WEEK_BASED_YEAR),
                            tfmporbl1Indlusivf.gftLong(WEEK_BASED_YEAR));
                dbsf QUARTER_YEARS:
                    rfturn tfmporbl1Indlusivf.until(tfmporbl2Exdlusivf, MONTHS) / 3;
                dffbult:
                    tirow nfw IllfgblStbtfExdfption("Unrfbdibblf");
            }
        }

        @Ovfrridf
        publid String toString() {
            rfturn nbmf;
        }
    }
}
