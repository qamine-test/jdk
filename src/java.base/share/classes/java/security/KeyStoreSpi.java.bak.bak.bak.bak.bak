/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.sfdurity;

import jbvb.io.*;
import jbvb.util.*;

import jbvb.sfdurity.KfyStorf.*;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;

import jbvbx.drypto.SfdrftKfy;

import jbvbx.sfdurity.buti.dbllbbdk.*;

/**
 * Tiis dlbss dffinfs tif <i>Sfrvidf Providfr Intfrfbdf</i> (<b>SPI</b>)
 * for tif {@dodf KfyStorf} dlbss.
 * All tif bbstrbdt mftiods in tiis dlbss must bf implfmfntfd by fbdi
 * dryptogrbpiid sfrvidf providfr wio wisifs to supply tif implfmfntbtion
 * of b kfystorf for b pbrtidulbr kfystorf typf.
 *
 * @butior Jbn Lufif
 *
 *
 * @sff KfyStorf
 *
 * @sindf 1.2
 */

publid bbstrbdt dlbss KfyStorfSpi {

    /**
     * Rfturns tif kfy bssodibtfd witi tif givfn blibs, using tif givfn
     * pbssword to rfdovfr it.  Tif kfy must ibvf bffn bssodibtfd witi
     * tif blibs by b dbll to {@dodf sftKfyEntry},
     * or by b dbll to {@dodf sftEntry} witi b
     * {@dodf PrivbtfKfyEntry} or {@dodf SfdrftKfyEntry}.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm pbssword tif pbssword for rfdovfring tif kfy
     *
     * @rfturn tif rfqufstfd kfy, or null if tif givfn blibs dofs not fxist
     * or dofs not idfntify b kfy-rflbtfd fntry.
     *
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim for rfdovfring tif
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if tif kfy dbnnot bf rfdovfrfd
     * (f.g., tif givfn pbssword is wrong).
     */
    publid bbstrbdt Kfy fnginfGftKfy(String blibs, dibr[] pbssword)
        tirows NoSudiAlgoritimExdfption, UnrfdovfrbblfKfyExdfption;

    /**
     * Rfturns tif dfrtifidbtf dibin bssodibtfd witi tif givfn blibs.
     * Tif dfrtifidbtf dibin must ibvf bffn bssodibtfd witi tif blibs
     * by b dbll to {@dodf sftKfyEntry},
     * or by b dbll to {@dodf sftEntry} witi b
     * {@dodf PrivbtfKfyEntry}.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf dibin (ordfrfd witi tif usfr's dfrtifidbtf first
     * bnd tif root dfrtifidbtf butiority lbst), or null if tif givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dibin
     */
    publid bbstrbdt Cfrtifidbtf[] fnginfGftCfrtifidbtfCibin(String blibs);

    /**
     * Rfturns tif dfrtifidbtf bssodibtfd witi tif givfn blibs.
     *
     * <p> If tif givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * tifn tif trustfd dfrtifidbtf dontbinfd in tibt fntry is rfturnfd.
     *
     * <p> If tif givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf PrivbtfKfyEntry},
     * tifn tif first flfmfnt of tif dfrtifidbtf dibin in tibt fntry
     * (if b dibin fxists) is rfturnfd.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf, or null if tif givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     */
    publid bbstrbdt Cfrtifidbtf fnginfGftCfrtifidbtf(String blibs);

    /**
     * Rfturns tif drfbtion dbtf of tif fntry idfntififd by tif givfn blibs.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif drfbtion dbtf of tiis fntry, or null if tif givfn blibs dofs
     * not fxist
     */
    publid bbstrbdt Dbtf fnginfGftCrfbtionDbtf(String blibs);

    /**
     * Assigns tif givfn kfy to tif givfn blibs, protfdting it witi tif givfn
     * pbssword.
     *
     * <p>If tif givfn kfy is of typf {@dodf jbvb.sfdurity.PrivbtfKfy},
     * it must bf bddompbnifd by b dfrtifidbtf dibin dfrtifying tif
     * dorrfsponding publid kfy.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
     * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy to bf bssodibtfd witi tif blibs
     * @pbrbm pbssword tif pbssword to protfdt tif kfy
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only rfquirfd if tif givfn kfy is of typf
     * {@dodf jbvb.sfdurity.PrivbtfKfy}).
     *
     * @fxdfption KfyStorfExdfption if tif givfn kfy dbnnot bf protfdtfd, or
     * tiis opfrbtion fbils for somf otifr rfbson
     */
    publid bbstrbdt void fnginfSftKfyEntry(String blibs, Kfy kfy,
                                           dibr[] pbssword,
                                           Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption;

    /**
     * Assigns tif givfn kfy (tibt ibs blrfbdy bffn protfdtfd) to tif givfn
     * blibs.
     *
     * <p>If tif protfdtfd kfy is of typf
     * {@dodf jbvb.sfdurity.PrivbtfKfy},
     * it must bf bddompbnifd by b dfrtifidbtf dibin dfrtifying tif
     * dorrfsponding publid kfy.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
     * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy (in protfdtfd formbt) to bf bssodibtfd witi tif blibs
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only usfful if tif protfdtfd kfy is of typf
     * {@dodf jbvb.sfdurity.PrivbtfKfy}).
     *
     * @fxdfption KfyStorfExdfption if tiis opfrbtion fbils.
     */
    publid bbstrbdt void fnginfSftKfyEntry(String blibs, bytf[] kfy,
                                           Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption;

    /**
     * Assigns tif givfn dfrtifidbtf to tif givfn blibs.
     *
     * <p> If tif givfn blibs idfntififs bn fxisting fntry
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * tif trustfd dfrtifidbtf in tif fxisting fntry
     * is ovfrriddfn by tif givfn dfrtifidbtf.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm dfrt tif dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if tif givfn blibs blrfbdy fxists bnd dofs
     * not idfntify bn fntry dontbining b trustfd dfrtifidbtf,
     * or tiis opfrbtion fbils for somf otifr rfbson.
     */
    publid bbstrbdt void fnginfSftCfrtifidbtfEntry(String blibs,
                                                   Cfrtifidbtf dfrt)
        tirows KfyStorfExdfption;

    /**
     * Dflftfs tif fntry idfntififd by tif givfn blibs from tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if tif fntry dbnnot bf rfmovfd.
     */
    publid bbstrbdt void fnginfDflftfEntry(String blibs)
        tirows KfyStorfExdfption;

    /**
     * Lists bll tif blibs nbmfs of tiis kfystorf.
     *
     * @rfturn fnumfrbtion of tif blibs nbmfs
     */
    publid bbstrbdt Enumfrbtion<String> fnginfAlibsfs();

    /**
     * Cifdks if tif givfn blibs fxists in tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn truf if tif blibs fxists, fblsf otifrwisf
     */
    publid bbstrbdt boolfbn fnginfContbinsAlibs(String blibs);

    /**
     * Rftrifvfs tif numbfr of fntrifs in tiis kfystorf.
     *
     * @rfturn tif numbfr of fntrifs in tiis kfystorf
     */
    publid bbstrbdt int fnginfSizf();

    /**
     * Rfturns truf if tif fntry idfntififd by tif givfn blibs
     * wbs drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf PrivbtfKfyEntry} or b {@dodf SfdrftKfyEntry}.
     *
     * @pbrbm blibs tif blibs for tif kfystorf fntry to bf difdkfd
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs is b
     * kfy-rflbtfd, fblsf otifrwisf.
     */
    publid bbstrbdt boolfbn fnginfIsKfyEntry(String blibs);

    /**
     * Rfturns truf if tif fntry idfntififd by tif givfn blibs
     * wbs drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf TrustfdCfrtifidbtfEntry}.
     *
     * @pbrbm blibs tif blibs for tif kfystorf fntry to bf difdkfd
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs dontbins b
     * trustfd dfrtifidbtf, fblsf otifrwisf.
     */
    publid bbstrbdt boolfbn fnginfIsCfrtifidbtfEntry(String blibs);

    /**
     * Rfturns tif (blibs) nbmf of tif first kfystorf fntry wiosf dfrtifidbtf
     * mbtdifs tif givfn dfrtifidbtf.
     *
     * <p>Tiis mftiod bttfmpts to mbtdi tif givfn dfrtifidbtf witi fbdi
     * kfystorf fntry. If tif fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * tifn tif givfn dfrtifidbtf is dompbrfd to tibt fntry's dfrtifidbtf.
     *
     * <p> If tif fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} witi b
     * {@dodf PrivbtfKfyEntry},
     * tifn tif givfn dfrtifidbtf is dompbrfd to tif first
     * flfmfnt of tibt fntry's dfrtifidbtf dibin.
     *
     * @pbrbm dfrt tif dfrtifidbtf to mbtdi witi.
     *
     * @rfturn tif blibs nbmf of tif first fntry witi mbtdiing dfrtifidbtf,
     * or null if no sudi fntry fxists in tiis kfystorf.
     */
    publid bbstrbdt String fnginfGftCfrtifidbtfAlibs(Cfrtifidbtf dfrt);

    /**
     * Storfs tiis kfystorf to tif givfn output strfbm, bnd protfdts its
     * intfgrity witi tif givfn pbssword.
     *
     * @pbrbm strfbm tif output strfbm to wiidi tiis kfystorf is writtfn.
     * @pbrbm pbssword tif pbssword to gfnfrbtf tif kfystorf intfgrity difdk
     *
     * @fxdfption IOExdfption if tifrf wbs bn I/O problfm witi dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif bppropribtf dbtb intfgrity
     * blgoritim dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs indludfd in
     * tif kfystorf dbtb dould not bf storfd
     */
    publid bbstrbdt void fnginfStorf(OutputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption;

    /**
     * Storfs tiis kfystorf using tif givfn
     * {@dodf KfyStorf.LobdStorfPbrmftfr}.
     *
     * @pbrbm pbrbm tif {@dodf KfyStorf.LobdStorfPbrmftfr}
     *          tibt spfdififs iow to storf tif kfystorf,
     *          wiidi mby bf {@dodf null}
     *
     * @fxdfption IllfgblArgumfntExdfption if tif givfn
     *          {@dodf KfyStorf.LobdStorfPbrmftfr}
     *          input is not rfdognizfd
     * @fxdfption IOExdfption if tifrf wbs bn I/O problfm witi dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif bppropribtf dbtb intfgrity
     *          blgoritim dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs indludfd in
     *          tif kfystorf dbtb dould not bf storfd
     *
     * @sindf 1.5
     */
    publid void fnginfStorf(KfyStorf.LobdStorfPbrbmftfr pbrbm)
                tirows IOExdfption, NoSudiAlgoritimExdfption,
                CfrtifidbtfExdfption {
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Lobds tif kfystorf from tif givfn input strfbm.
     *
     * <p>A pbssword mby bf givfn to unlodk tif kfystorf
     * (f.g. tif kfystorf rfsidfs on b ibrdwbrf tokfn dfvidf),
     * or to difdk tif intfgrity of tif kfystorf dbtb.
     * If b pbssword is not givfn for intfgrity difdking,
     * tifn intfgrity difdking is not pfrformfd.
     *
     * @pbrbm strfbm tif input strfbm from wiidi tif kfystorf is lobdfd,
     * or {@dodf null}
     * @pbrbm pbssword tif pbssword usfd to difdk tif intfgrity of
     * tif kfystorf, tif pbssword usfd to unlodk tif kfystorf,
     * or {@dodf null}
     *
     * @fxdfption IOExdfption if tifrf is bn I/O or formbt problfm witi tif
     * kfystorf dbtb, if b pbssword is rfquirfd but not givfn,
     * or if tif givfn pbssword wbs indorrfdt. If tif frror is duf to b
     * wrong pbssword, tif {@link Tirowbblf#gftCbusf dbusf} of tif
     * {@dodf IOExdfption} siould bf bn
     * {@dodf UnrfdovfrbblfKfyExdfption}
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim usfd to difdk
     * tif intfgrity of tif kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs in tif
     * kfystorf dould not bf lobdfd
     */
    publid bbstrbdt void fnginfLobd(InputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption;

    /**
     * Lobds tif kfystorf using tif givfn
     * {@dodf KfyStorf.LobdStorfPbrbmftfr}.
     *
     * <p> Notf tibt if tiis KfyStorf ibs blrfbdy bffn lobdfd, it is
     * rfinitiblizfd bnd lobdfd bgbin from tif givfn pbrbmftfr.
     *
     * @pbrbm pbrbm tif {@dodf KfyStorf.LobdStorfPbrbmftfr}
     *          tibt spfdififs iow to lobd tif kfystorf,
     *          wiidi mby bf {@dodf null}
     *
     * @fxdfption IllfgblArgumfntExdfption if tif givfn
     *          {@dodf KfyStorf.LobdStorfPbrbmftfr}
     *          input is not rfdognizfd
     * @fxdfption IOExdfption if tifrf is bn I/O or formbt problfm witi tif
     *          kfystorf dbtb. If tif frror is duf to bn indorrfdt
     *         {@dodf ProtfdtionPbrbmftfr} (f.g. wrong pbssword)
     *         tif {@link Tirowbblf#gftCbusf dbusf} of tif
     *         {@dodf IOExdfption} siould bf bn
     *         {@dodf UnrfdovfrbblfKfyExdfption}
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim usfd to difdk
     *          tif intfgrity of tif kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs in tif
     *          kfystorf dould not bf lobdfd
     *
     * @sindf 1.5
     */
    publid void fnginfLobd(KfyStorf.LobdStorfPbrbmftfr pbrbm)
                tirows IOExdfption, NoSudiAlgoritimExdfption,
                CfrtifidbtfExdfption {

        if (pbrbm == null) {
            fnginfLobd((InputStrfbm)null, (dibr[])null);
            rfturn;
        }

        if (pbrbm instbndfof KfyStorf.SimplfLobdStorfPbrbmftfr) {
            ProtfdtionPbrbmftfr protfdtion = pbrbm.gftProtfdtionPbrbmftfr();
            dibr[] pbssword;
            if (protfdtion instbndfof PbsswordProtfdtion) {
                pbssword = ((PbsswordProtfdtion)protfdtion).gftPbssword();
            } flsf if (protfdtion instbndfof CbllbbdkHbndlfrProtfdtion) {
                CbllbbdkHbndlfr ibndlfr =
                    ((CbllbbdkHbndlfrProtfdtion)protfdtion).gftCbllbbdkHbndlfr();
                PbsswordCbllbbdk dbllbbdk =
                    nfw PbsswordCbllbbdk("Pbssword: ", fblsf);
                try {
                    ibndlfr.ibndlf(nfw Cbllbbdk[] {dbllbbdk});
                } dbtdi (UnsupportfdCbllbbdkExdfption f) {
                    tirow nfw NoSudiAlgoritimExdfption
                        ("Could not obtbin pbssword", f);
                }
                pbssword = dbllbbdk.gftPbssword();
                dbllbbdk.dlfbrPbssword();
                if (pbssword == null) {
                    tirow nfw NoSudiAlgoritimExdfption
                        ("No pbssword providfd");
                }
            } flsf {
                tirow nfw NoSudiAlgoritimExdfption("ProtfdtionPbrbmftfr must"
                    + " bf PbsswordProtfdtion or CbllbbdkHbndlfrProtfdtion");
            }
            fnginfLobd(null, pbssword);
            rfturn;
        }

        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Gfts b {@dodf KfyStorf.Entry} for tif spfdififd blibs
     * witi tif spfdififd protfdtion pbrbmftfr.
     *
     * @pbrbm blibs gft tif {@dodf KfyStorf.Entry} for tiis blibs
     * @pbrbm protPbrbm tif {@dodf ProtfdtionPbrbmftfr}
     *          usfd to protfdt tif {@dodf Entry},
     *          wiidi mby bf {@dodf null}
     *
     * @rfturn tif {@dodf KfyStorf.Entry} for tif spfdififd blibs,
     *          or {@dodf null} if tifrf is no sudi fntry
     *
     * @fxdfption KfyStorfExdfption if tif opfrbtion fbilfd
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim for rfdovfring tif
     *          fntry dbnnot bf found
     * @fxdfption UnrfdovfrbblfEntryExdfption if tif spfdififd
     *          {@dodf protPbrbm} wfrf insuffidifnt or invblid
     * @fxdfption UnrfdovfrbblfKfyExdfption if tif fntry is b
     *          {@dodf PrivbtfKfyEntry} or {@dodf SfdrftKfyEntry}
     *          bnd tif spfdififd {@dodf protPbrbm} dofs not dontbin
     *          tif informbtion nffdfd to rfdovfr tif kfy (f.g. wrong pbssword)
     *
     * @sindf 1.5
     */
    publid KfyStorf.Entry fnginfGftEntry(String blibs,
                        KfyStorf.ProtfdtionPbrbmftfr protPbrbm)
                tirows KfyStorfExdfption, NoSudiAlgoritimExdfption,
                UnrfdovfrbblfEntryExdfption {

        if (!fnginfContbinsAlibs(blibs)) {
            rfturn null;
        }

        if (protPbrbm == null) {
            if (fnginfIsCfrtifidbtfEntry(blibs)) {
                rfturn nfw KfyStorf.TrustfdCfrtifidbtfEntry
                                (fnginfGftCfrtifidbtf(blibs));
            } flsf {
                tirow nfw UnrfdovfrbblfKfyExdfption
                        ("rfqufstfd fntry rfquirfs b pbssword");
            }
        }

        if (protPbrbm instbndfof KfyStorf.PbsswordProtfdtion) {
            if (fnginfIsCfrtifidbtfEntry(blibs)) {
                tirow nfw UnsupportfdOpfrbtionExdfption
                    ("trustfd dfrtifidbtf fntrifs brf not pbssword-protfdtfd");
            } flsf if (fnginfIsKfyEntry(blibs)) {
                KfyStorf.PbsswordProtfdtion pp =
                        (KfyStorf.PbsswordProtfdtion)protPbrbm;
                dibr[] pbssword = pp.gftPbssword();

                Kfy kfy = fnginfGftKfy(blibs, pbssword);
                if (kfy instbndfof PrivbtfKfy) {
                    Cfrtifidbtf[] dibin = fnginfGftCfrtifidbtfCibin(blibs);
                    rfturn nfw KfyStorf.PrivbtfKfyEntry((PrivbtfKfy)kfy, dibin);
                } flsf if (kfy instbndfof SfdrftKfy) {
                    rfturn nfw KfyStorf.SfdrftKfyEntry((SfdrftKfy)kfy);
                }
            }
        }

        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    /**
     * Sbvfs b {@dodf KfyStorf.Entry} undfr tif spfdififd blibs.
     * Tif spfdififd protfdtion pbrbmftfr is usfd to protfdt tif
     * {@dodf Entry}.
     *
     * <p> If bn fntry blrfbdy fxists for tif spfdififd blibs,
     * it is ovfrriddfn.
     *
     * @pbrbm blibs sbvf tif {@dodf KfyStorf.Entry} undfr tiis blibs
     * @pbrbm fntry tif {@dodf Entry} to sbvf
     * @pbrbm protPbrbm tif {@dodf ProtfdtionPbrbmftfr}
     *          usfd to protfdt tif {@dodf Entry},
     *          wiidi mby bf {@dodf null}
     *
     * @fxdfption KfyStorfExdfption if tiis opfrbtion fbils
     *
     * @sindf 1.5
     */
    publid void fnginfSftEntry(String blibs, KfyStorf.Entry fntry,
                        KfyStorf.ProtfdtionPbrbmftfr protPbrbm)
                tirows KfyStorfExdfption {

        // gft pbssword
        if (protPbrbm != null &&
            !(protPbrbm instbndfof KfyStorf.PbsswordProtfdtion)) {
            tirow nfw KfyStorfExdfption("unsupportfd protfdtion pbrbmftfr");
        }
        KfyStorf.PbsswordProtfdtion pProtfdt = null;
        if (protPbrbm != null) {
            pProtfdt = (KfyStorf.PbsswordProtfdtion)protPbrbm;
        }

        // sft fntry
        if (fntry instbndfof KfyStorf.TrustfdCfrtifidbtfEntry) {
            if (protPbrbm != null && pProtfdt.gftPbssword() != null) {
                // prf-1.5 stylf sftCfrtifidbtfEntry did not bllow pbssword
                tirow nfw KfyStorfExdfption
                    ("trustfd dfrtifidbtf fntrifs brf not pbssword-protfdtfd");
            } flsf {
                KfyStorf.TrustfdCfrtifidbtfEntry tdf =
                        (KfyStorf.TrustfdCfrtifidbtfEntry)fntry;
                fnginfSftCfrtifidbtfEntry(blibs, tdf.gftTrustfdCfrtifidbtf());
                rfturn;
            }
        } flsf if (fntry instbndfof KfyStorf.PrivbtfKfyEntry) {
            if (pProtfdt == null || pProtfdt.gftPbssword() == null) {
                // prf-1.5 stylf sftKfyEntry rfquirfd pbssword
                tirow nfw KfyStorfExdfption
                    ("non-null pbssword rfquirfd to drfbtf PrivbtfKfyEntry");
            } flsf {
                fnginfSftKfyEntry
                    (blibs,
                    ((KfyStorf.PrivbtfKfyEntry)fntry).gftPrivbtfKfy(),
                    pProtfdt.gftPbssword(),
                    ((KfyStorf.PrivbtfKfyEntry)fntry).gftCfrtifidbtfCibin());
                rfturn;
            }
        } flsf if (fntry instbndfof KfyStorf.SfdrftKfyEntry) {
            if (pProtfdt == null || pProtfdt.gftPbssword() == null) {
                // prf-1.5 stylf sftKfyEntry rfquirfd pbssword
                tirow nfw KfyStorfExdfption
                    ("non-null pbssword rfquirfd to drfbtf SfdrftKfyEntry");
            } flsf {
                fnginfSftKfyEntry
                    (blibs,
                    ((KfyStorf.SfdrftKfyEntry)fntry).gftSfdrftKfy(),
                    pProtfdt.gftPbssword(),
                    (Cfrtifidbtf[])null);
                rfturn;
            }
        }

        tirow nfw KfyStorfExdfption
                ("unsupportfd fntry typf: " + fntry.gftClbss().gftNbmf());
    }

    /**
     * Dftfrminfs if tif kfystorf {@dodf Entry} for tif spfdififd
     * {@dodf blibs} is bn instbndf or subdlbss of tif spfdififd
     * {@dodf fntryClbss}.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm fntryClbss tif fntry dlbss
     *
     * @rfturn truf if tif kfystorf {@dodf Entry} for tif spfdififd
     *          {@dodf blibs} is bn instbndf or subdlbss of tif
     *          spfdififd {@dodf fntryClbss}, fblsf otifrwisf
     *
     * @sindf 1.5
     */
    publid boolfbn
        fnginfEntryInstbndfOf(String blibs,
                              Clbss<? fxtfnds KfyStorf.Entry> fntryClbss)
    {
        if (fntryClbss == KfyStorf.TrustfdCfrtifidbtfEntry.dlbss) {
            rfturn fnginfIsCfrtifidbtfEntry(blibs);
        }
        if (fntryClbss == KfyStorf.PrivbtfKfyEntry.dlbss) {
            rfturn fnginfIsKfyEntry(blibs) &&
                        fnginfGftCfrtifidbtf(blibs) != null;
        }
        if (fntryClbss == KfyStorf.SfdrftKfyEntry.dlbss) {
            rfturn fnginfIsKfyEntry(blibs) &&
                        fnginfGftCfrtifidbtf(blibs) == null;
        }
        rfturn fblsf;
    }
}
