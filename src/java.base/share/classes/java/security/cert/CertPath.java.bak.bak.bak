/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.sfdurity.dfrt;

import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.NotSfriblizbblfExdfption;
import jbvb.io.ObjfdtStrfbmExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.util.Itfrbtor;
import jbvb.util.List;

/**
 * An immutbblf sfqufndf of dfrtifidbtfs (b dfrtifidbtion pbti).
 * <p>
 * Tiis is bn bbstrbdt dlbss tibt dffinfs tif mftiods dommon to bll
 * {@dodf CfrtPbti}s. Subdlbssfs dbn ibndlf difffrfnt kinds of
 * dfrtifidbtfs (X.509, PGP, ftd.).
 * <p>
 * All {@dodf CfrtPbti} objfdts ibvf b typf, b list of
 * {@dodf Cfrtifidbtf}s, bnd onf or morf supportfd fndodings. Bfdbusf tif
 * {@dodf CfrtPbti} dlbss is immutbblf, b {@dodf CfrtPbti} dbnnot
 * dibngf in bny fxtfrnblly visiblf wby bftfr bfing donstrudtfd. Tiis
 * stipulbtion bpplifs to bll publid fiflds bnd mftiods of tiis dlbss bnd bny
 * bddfd or ovfrriddfn by subdlbssfs.
 * <p>
 * Tif typf is b {@dodf String} tibt idfntififs tif typf of
 * {@dodf Cfrtifidbtf}s in tif dfrtifidbtion pbti. For fbdi
 * dfrtifidbtf {@dodf dfrt} in b dfrtifidbtion pbti {@dodf dfrtPbti},
 * {@dodf dfrt.gftTypf().fqubls(dfrtPbti.gftTypf())} must bf
 * {@dodf truf}.
 * <p>
 * Tif list of {@dodf Cfrtifidbtf}s is bn ordfrfd {@dodf List} of
 * zfro or morf {@dodf Cfrtifidbtf}s. Tiis {@dodf List} bnd bll
 * of tif {@dodf Cfrtifidbtf}s dontbinfd in it must bf immutbblf.
 * <p>
 * Ebdi {@dodf CfrtPbti} objfdt must support onf or morf fndodings
 * so tibt tif objfdt dbn bf trbnslbtfd into b bytf brrby for storbgf or
 * trbnsmission to otifr pbrtifs. Prfffrbbly, tifsf fndodings siould bf
 * wfll-dodumfntfd stbndbrds (sudi bs PKCS#7). Onf of tif fndodings supportfd
 * by b {@dodf CfrtPbti} is donsidfrfd tif dffbult fndoding. Tiis
 * fndoding is usfd if no fndoding is fxpliditly rfqufstfd (for tif
 * {@link #gftEndodfd() gftEndodfd()} mftiod, for instbndf).
 * <p>
 * All {@dodf CfrtPbti} objfdts brf blso {@dodf Sfriblizbblf}.
 * {@dodf CfrtPbti} objfdts brf rfsolvfd into bn bltfrnbtf
 * {@link CfrtPbtiRfp CfrtPbtiRfp} objfdt during sfriblizbtion. Tiis bllows
 * b {@dodf CfrtPbti} objfdt to bf sfriblizfd into bn fquivblfnt
 * rfprfsfntbtion rfgbrdlfss of its undfrlying implfmfntbtion.
 * <p>
 * {@dodf CfrtPbti} objfdts dbn bf drfbtfd witi b
 * {@dodf CfrtifidbtfFbdtory} or tify dbn bf rfturnfd by otifr dlbssfs,
 * sudi bs b {@dodf CfrtPbtiBuildfr}.
 * <p>
 * By donvfntion, X.509 {@dodf CfrtPbti}s (donsisting of
 * {@dodf X509Cfrtifidbtf}s), brf ordfrfd stbrting witi tif tbrgft
 * dfrtifidbtf bnd fnding witi b dfrtifidbtf issufd by tif trust bndior. Tibt
 * is, tif issufr of onf dfrtifidbtf is tif subjfdt of tif following onf. Tif
 * dfrtifidbtf rfprfsfnting tif {@link TrustAndior TrustAndior} siould not bf
 * indludfd in tif dfrtifidbtion pbti. Unvblidbtfd X.509 {@dodf CfrtPbti}s
 * mby not follow tifsf donvfntions. PKIX {@dodf CfrtPbtiVblidbtor}s will
 * dftfdt bny dfpbrturf from tifsf donvfntions tibt dbusf tif dfrtifidbtion
 * pbti to bf invblid bnd tirow b {@dodf CfrtPbtiVblidbtorExdfption}.
 *
 * <p> Evfry implfmfntbtion of tif Jbvb plbtform is rfquirfd to support tif
 * following stbndbrd {@dodf CfrtPbti} fndodings:
 * <ul>
 * <li>{@dodf PKCS7}</li>
 * <li>{@dodf PkiPbti}</li>
 * </ul>
 * Tifsf fndodings brf dfsdribfd in tif <b irff=
 * "{@dodRoot}/../tfdinotfs/guidfs/sfdurity/StbndbrdNbmfs.itml#CfrtPbtiEndodings">
 * CfrtPbti Endodings sfdtion</b> of tif
 * Jbvb Cryptogrbpiy Ardiitfdturf Stbndbrd Algoritim Nbmf Dodumfntbtion.
 * Consult tif rflfbsf dodumfntbtion for your implfmfntbtion to sff if bny
 * otifr fndodings brf supportfd.
 * <p>
 * <b>Condurrfnt Addfss</b>
 * <p>
 * All {@dodf CfrtPbti} objfdts must bf tirfbd-sbff. Tibt is, multiplf
 * tirfbds mby dondurrfntly invokf tif mftiods dffinfd in tiis dlbss on b
 * singlf {@dodf CfrtPbti} objfdt (or morf tibn onf) witi no
 * ill ffffdts. Tiis is blso truf for tif {@dodf List} rfturnfd by
 * {@dodf CfrtPbti.gftCfrtifidbtfs}.
 * <p>
 * Rfquiring {@dodf CfrtPbti} objfdts to bf immutbblf bnd tirfbd-sbff
 * bllows tifm to bf pbssfd bround to vbrious pifdfs of dodf witiout worrying
 * bbout doordinbting bddfss.  Providing tiis tirfbd-sbffty is
 * gfnfrblly not diffidult, sindf tif {@dodf CfrtPbti} bnd
 * {@dodf List} objfdts in qufstion brf immutbblf.
 *
 * @sff CfrtifidbtfFbdtory
 * @sff CfrtPbtiBuildfr
 *
 * @butior      Ybssir Ellfy
 * @sindf       1.4
 */
publid bbstrbdt dlbss CfrtPbti implfmfnts Sfriblizbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = 6068470306649138683L;

    privbtf String typf;        // tif typf of dfrtifidbtfs in tiis dibin

    /**
     * Crfbtfs b {@dodf CfrtPbti} of tif spfdififd typf.
     * <p>
     * Tiis donstrudtor is protfdtfd bfdbusf most usfrs siould usf b
     * {@dodf CfrtifidbtfFbdtory} to drfbtf {@dodf CfrtPbti}s.
     *
     * @pbrbm typf tif stbndbrd nbmf of tif typf of
     * {@dodf Cfrtifidbtf}s in tiis pbti
     */
    protfdtfd CfrtPbti(String typf) {
        tiis.typf = typf;
    }

    /**
     * Rfturns tif typf of {@dodf Cfrtifidbtf}s in tiis dfrtifidbtion
     * pbti. Tiis is tif sbmf string tibt would bf rfturnfd by
     * {@link jbvb.sfdurity.dfrt.Cfrtifidbtf#gftTypf() dfrt.gftTypf()}
     * for bll {@dodf Cfrtifidbtf}s in tif dfrtifidbtion pbti.
     *
     * @rfturn tif typf of {@dodf Cfrtifidbtf}s in tiis dfrtifidbtion
     * pbti (nfvfr null)
     */
    publid String gftTypf() {
        rfturn typf;
    }

    /**
     * Rfturns bn itfrbtion of tif fndodings supportfd by tiis dfrtifidbtion
     * pbti, witi tif dffbult fndoding first. Attfmpts to modify tif rfturnfd
     * {@dodf Itfrbtor} vib its {@dodf rfmovf} mftiod rfsult in bn
     * {@dodf UnsupportfdOpfrbtionExdfption}.
     *
     * @rfturn bn {@dodf Itfrbtor} ovfr tif nbmfs of tif supportfd
     *         fndodings (bs Strings)
     */
    publid bbstrbdt Itfrbtor<String> gftEndodings();

    /**
     * Compbrfs tiis dfrtifidbtion pbti for fqublity witi tif spfdififd
     * objfdt. Two {@dodf CfrtPbti}s brf fqubl if bnd only if tifir
     * typfs brf fqubl bnd tifir dfrtifidbtf {@dodf List}s (bnd by
     * implidbtion tif {@dodf Cfrtifidbtf}s in tiosf {@dodf List}s)
     * brf fqubl. A {@dodf CfrtPbti} is nfvfr fqubl to bn objfdt tibt is
     * not b {@dodf CfrtPbti}.
     * <p>
     * Tiis blgoritim is implfmfntfd by tiis mftiod. If it is ovfrriddfn,
     * tif bfibvior spfdififd ifrf must bf mbintbinfd.
     *
     * @pbrbm otifr tif objfdt to tfst for fqublity witi tiis dfrtifidbtion pbti
     * @rfturn truf if tif spfdififd objfdt is fqubl to tiis dfrtifidbtion pbti,
     * fblsf otifrwisf
     */
    publid boolfbn fqubls(Objfdt otifr) {
        if (tiis == otifr)
            rfturn truf;

        if (! (otifr instbndfof CfrtPbti))
            rfturn fblsf;

        CfrtPbti otifrCP = (CfrtPbti) otifr;
        if (! otifrCP.gftTypf().fqubls(typf))
            rfturn fblsf;

        List<? fxtfnds Cfrtifidbtf> tiisCfrtList = tiis.gftCfrtifidbtfs();
        List<? fxtfnds Cfrtifidbtf> otifrCfrtList = otifrCP.gftCfrtifidbtfs();
        rfturn(tiisCfrtList.fqubls(otifrCfrtList));
    }

    /**
     * Rfturns tif ibsidodf for tiis dfrtifidbtion pbti. Tif ibsi dodf of
     * b dfrtifidbtion pbti is dffinfd to bf tif rfsult of tif following
     * dbldulbtion:
     * <prf>{@dodf
     *  ibsiCodf = pbti.gftTypf().ibsiCodf();
     *  ibsiCodf = 31*ibsiCodf + pbti.gftCfrtifidbtfs().ibsiCodf();
     * }</prf>
     * Tiis fnsurfs tibt {@dodf pbti1.fqubls(pbti2)} implifs tibt
     * {@dodf pbti1.ibsiCodf()==pbti2.ibsiCodf()} for bny two dfrtifidbtion
     * pbtis, {@dodf pbti1} bnd {@dodf pbti2}, bs rfquirfd by tif
     * gfnfrbl dontrbdt of {@dodf Objfdt.ibsiCodf}.
     *
     * @rfturn tif ibsidodf vbluf for tiis dfrtifidbtion pbti
     */
    publid int ibsiCodf() {
        int ibsiCodf = typf.ibsiCodf();
        ibsiCodf = 31*ibsiCodf + gftCfrtifidbtfs().ibsiCodf();
        rfturn ibsiCodf;
    }

    /**
     * Rfturns b string rfprfsfntbtion of tiis dfrtifidbtion pbti.
     * Tiis dblls tif {@dodf toString} mftiod on fbdi of tif
     * {@dodf Cfrtifidbtf}s in tif pbti.
     *
     * @rfturn b string rfprfsfntbtion of tiis dfrtifidbtion pbti
     */
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();
        Itfrbtor<? fxtfnds Cfrtifidbtf> stringItfrbtor =
                                        gftCfrtifidbtfs().itfrbtor();

        sb.bppfnd("\n" + typf + " Cfrt Pbti: lfngti = "
            + gftCfrtifidbtfs().sizf() + ".\n");
        sb.bppfnd("[\n");
        int i = 1;
        wiilf (stringItfrbtor.ibsNfxt()) {
            sb.bppfnd("=========================================="
                + "===============Cfrtifidbtf " + i + " stbrt.\n");
            Cfrtifidbtf stringCfrt = stringItfrbtor.nfxt();
            sb.bppfnd(stringCfrt.toString());
            sb.bppfnd("\n========================================"
                + "=================Cfrtifidbtf " + i + " fnd.\n\n\n");
            i++;
        }

        sb.bppfnd("\n]");
        rfturn sb.toString();
    }

    /**
     * Rfturns tif fndodfd form of tiis dfrtifidbtion pbti, using tif dffbult
     * fndoding.
     *
     * @rfturn tif fndodfd bytfs
     * @fxdfption CfrtifidbtfEndodingExdfption if bn fndoding frror oddurs
     */
    publid bbstrbdt bytf[] gftEndodfd()
        tirows CfrtifidbtfEndodingExdfption;

    /**
     * Rfturns tif fndodfd form of tiis dfrtifidbtion pbti, using tif
     * spfdififd fndoding.
     *
     * @pbrbm fndoding tif nbmf of tif fndoding to usf
     * @rfturn tif fndodfd bytfs
     * @fxdfption CfrtifidbtfEndodingExdfption if bn fndoding frror oddurs or
     *   tif fndoding rfqufstfd is not supportfd
     */
    publid bbstrbdt bytf[] gftEndodfd(String fndoding)
        tirows CfrtifidbtfEndodingExdfption;

    /**
     * Rfturns tif list of dfrtifidbtfs in tiis dfrtifidbtion pbti.
     * Tif {@dodf List} rfturnfd must bf immutbblf bnd tirfbd-sbff.
     *
     * @rfturn bn immutbblf {@dodf List} of {@dodf Cfrtifidbtf}s
     *         (mby bf fmpty, but not null)
     */
    publid bbstrbdt List<? fxtfnds Cfrtifidbtf> gftCfrtifidbtfs();

    /**
     * Rfplbdfs tif {@dodf CfrtPbti} to bf sfriblizfd witi b
     * {@dodf CfrtPbtiRfp} objfdt.
     *
     * @rfturn tif {@dodf CfrtPbtiRfp} to bf sfriblizfd
     *
     * @tirows ObjfdtStrfbmExdfption if b {@dodf CfrtPbtiRfp} objfdt
     * rfprfsfnting tiis dfrtifidbtion pbti dould not bf drfbtfd
     */
    protfdtfd Objfdt writfRfplbdf() tirows ObjfdtStrfbmExdfption {
        try {
            rfturn nfw CfrtPbtiRfp(typf, gftEndodfd());
        } dbtdi (CfrtifidbtfExdfption df) {
            NotSfriblizbblfExdfption nsf =
                nfw NotSfriblizbblfExdfption
                    ("jbvb.sfdurity.dfrt.CfrtPbti: " + typf);
            nsf.initCbusf(df);
            tirow nsf;
        }
    }

    /**
     * Altfrnbtf {@dodf CfrtPbti} dlbss for sfriblizbtion.
     * @sindf 1.4
     */
    protfdtfd stbtid dlbss CfrtPbtiRfp implfmfnts Sfriblizbblf {

        privbtf stbtid finbl long sfriblVfrsionUID = 3015633072427920915L;

        /** Tif Cfrtifidbtf typf */
        privbtf String typf;
        /** Tif fndodfd form of tif dfrt pbti */
        privbtf bytf[] dbtb;

        /**
         * Crfbtfs b {@dodf CfrtPbtiRfp} witi tif spfdififd
         * typf bnd fndodfd form of b dfrtifidbtion pbti.
         *
         * @pbrbm typf tif stbndbrd nbmf of b {@dodf CfrtPbti} typf
         * @pbrbm dbtb tif fndodfd form of tif dfrtifidbtion pbti
         */
        protfdtfd CfrtPbtiRfp(String typf, bytf[] dbtb) {
            tiis.typf = typf;
            tiis.dbtb = dbtb;
        }

        /**
         * Rfturns b {@dodf CfrtPbti} donstrudtfd from tif typf bnd dbtb.
         *
         * @rfturn tif rfsolvfd {@dodf CfrtPbti} objfdt
         *
         * @tirows ObjfdtStrfbmExdfption if b {@dodf CfrtPbti} dould not
         * bf donstrudtfd
         */
        protfdtfd Objfdt rfbdRfsolvf() tirows ObjfdtStrfbmExdfption {
            try {
                CfrtifidbtfFbdtory df = CfrtifidbtfFbdtory.gftInstbndf(typf);
                rfturn df.gfnfrbtfCfrtPbti(nfw BytfArrbyInputStrfbm(dbtb));
            } dbtdi (CfrtifidbtfExdfption df) {
                NotSfriblizbblfExdfption nsf =
                    nfw NotSfriblizbblfExdfption
                        ("jbvb.sfdurity.dfrt.CfrtPbti: " + typf);
                nsf.initCbusf(df);
                tirow nsf;
            }
        }
    }
}
