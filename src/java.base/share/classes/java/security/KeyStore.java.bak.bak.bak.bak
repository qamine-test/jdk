/*
 * Copyright (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvb.sfdurity;

import jbvb.io.*;
import jbvb.nft.URI;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd;
import jbvb.util.*;
import jbvbx.drypto.SfdrftKfy;

import jbvbx.sfdurity.buth.DfstroyFbilfdExdfption;
import jbvbx.sfdurity.buth.dbllbbdk.*;

/**
 * This dlbss rfprfsfnts b storbgf fbdility for dryptogrbphid
 * kfys bnd dfrtifidbtfs.
 *
 * <p> A {@dodf KfyStorf} mbnbgfs difffrfnt typfs of fntrifs.
 * Ebdh typf of fntry implfmfnts thf {@dodf KfyStorf.Entry} intfrfbdf.
 * Thrff bbsid {@dodf KfyStorf.Entry} implfmfntbtions brf providfd:
 *
 * <ul>
 * <li><b>KfyStorf.PrivbtfKfyEntry</b>
 * <p> This typf of fntry holds b dryptogrbphid {@dodf PrivbtfKfy},
 * whidh is optionblly storfd in b protfdtfd formbt to prfvfnt
 * unbuthorizfd bddfss.  It is blso bddompbnifd by b dfrtifidbtf dhbin
 * for thf dorrfsponding publid kfy.
 *
 * <p> Privbtf kfys bnd dfrtifidbtf dhbins brf usfd by b givfn fntity for
 * sflf-buthfntidbtion. Applidbtions for this buthfntidbtion indludf softwbrf
 * distribution orgbnizbtions whidh sign JAR filfs bs pbrt of rflfbsing
 * bnd/or lidfnsing softwbrf.
 *
 * <li><b>KfyStorf.SfdrftKfyEntry</b>
 * <p> This typf of fntry holds b dryptogrbphid {@dodf SfdrftKfy},
 * whidh is optionblly storfd in b protfdtfd formbt to prfvfnt
 * unbuthorizfd bddfss.
 *
 * <li><b>KfyStorf.TrustfdCfrtifidbtfEntry</b>
 * <p> This typf of fntry dontbins b singlf publid kfy {@dodf Cfrtifidbtf}
 * bflonging to bnothfr pbrty. It is dbllfd b <i>trustfd dfrtifidbtf</i>
 * bfdbusf thf kfystorf ownfr trusts thbt thf publid kfy in thf dfrtifidbtf
 * indffd bflongs to thf idfntity idfntififd by thf <i>subjfdt</i> (ownfr)
 * of thf dfrtifidbtf.
 *
 * <p>This typf of fntry dbn bf usfd to buthfntidbtf othfr pbrtifs.
 * </ul>
 *
 * <p> Ebdh fntry in b kfystorf is idfntififd by bn "blibs" string. In thf
 * dbsf of privbtf kfys bnd thfir bssodibtfd dfrtifidbtf dhbins, thfsf strings
 * distinguish bmong thf difffrfnt wbys in whidh thf fntity mby buthfntidbtf
 * itsflf. For fxbmplf, thf fntity mby buthfntidbtf itsflf using difffrfnt
 * dfrtifidbtf buthoritifs, or using difffrfnt publid kfy blgorithms.
 *
 * <p> Whfthfr blibsfs brf dbsf sfnsitivf is implfmfntbtion dfpfndfnt. In ordfr
 * to bvoid problfms, it is rfdommfndfd not to usf blibsfs in b KfyStorf thbt
 * only difffr in dbsf.
 *
 * <p> Whfthfr kfystorfs brf pfrsistfnt, bnd thf mfdhbnisms usfd by thf
 * kfystorf if it is pfrsistfnt, brf not spfdififd hfrf. This bllows
 * usf of b vbrifty of tfdhniqufs for protfdting sfnsitivf (f.g., privbtf or
 * sfdrft) kfys. Smbrt dbrds or othfr intfgrbtfd dryptogrbphid fnginfs
 * (SbffKfypfr) brf onf option, bnd simplfr mfdhbnisms sudh bs filfs mby blso
 * bf usfd (in b vbrifty of formbts).
 *
 * <p> Typidbl wbys to rfqufst b KfyStorf objfdt indludf
 * rflying on thf dffbult typf bnd providing b spfdifid kfystorf typf.
 *
 * <ul>
 * <li>To rfly on thf dffbult typf:
 * <prf>
 *    KfyStorf ks = KfyStorf.gftInstbndf(KfyStorf.gftDffbultTypf());
 * </prf>
 * Thf systfm will rfturn b kfystorf implfmfntbtion for thf dffbult typf.
 *
 * <li>To providf b spfdifid kfystorf typf:
 * <prf>
 *      KfyStorf ks = KfyStorf.gftInstbndf("JKS");
 * </prf>
 * Thf systfm will rfturn thf most prfffrrfd implfmfntbtion of thf
 * spfdififd kfystorf typf bvbilbblf in thf fnvironmfnt. <p>
 * </ul>
 *
 * <p> Bfforf b kfystorf dbn bf bddfssfd, it must bf
 * {@link #lobd(jbvb.io.InputStrfbm, dhbr[]) lobdfd}.
 * <prf>
 *    KfyStorf ks = KfyStorf.gftInstbndf(KfyStorf.gftDffbultTypf());
 *
 *    // gft usfr pbssword bnd filf input strfbm
 *    dhbr[] pbssword = gftPbssword();
 *
 *    try (FilfInputStrfbm fis = nfw FilfInputStrfbm("kfyStorfNbmf")) {
 *        ks.lobd(fis, pbssword);
 *    }
 * </prf>
 *
 * To drfbtf bn fmpty kfystorf using thf bbovf {@dodf lobd} mfthod,
 * pbss {@dodf null} bs thf {@dodf InputStrfbm} brgumfnt.
 *
 * <p> Ondf thf kfystorf hbs bffn lobdfd, it is possiblf
 * to rfbd fxisting fntrifs from thf kfystorf, or to writf nfw fntrifs
 * into thf kfystorf:
 * <prf>
 *    KfyStorf.ProtfdtionPbrbmftfr protPbrbm =
 *        nfw KfyStorf.PbsswordProtfdtion(pbssword);
 *
 *    // gft my privbtf kfy
 *    KfyStorf.PrivbtfKfyEntry pkEntry = (KfyStorf.PrivbtfKfyEntry)
 *        ks.gftEntry("privbtfKfyAlibs", protPbrbm);
 *    PrivbtfKfy myPrivbtfKfy = pkEntry.gftPrivbtfKfy();
 *
 *    // sbvf my sfdrft kfy
 *    jbvbx.drypto.SfdrftKfy mySfdrftKfy;
 *    KfyStorf.SfdrftKfyEntry skEntry =
 *        nfw KfyStorf.SfdrftKfyEntry(mySfdrftKfy);
 *    ks.sftEntry("sfdrftKfyAlibs", skEntry, protPbrbm);
 *
 *    // storf bwby thf kfystorf
 *    try (FilfOutputStrfbm fos = nfw FilfOutputStrfbm("nfwKfyStorfNbmf")) {
 *        ks.storf(fos, pbssword);
 *    }
 * </prf>
 *
 * Notf thbt blthough thf sbmf pbssword mby bf usfd to
 * lobd thf kfystorf, to protfdt thf privbtf kfy fntry,
 * to protfdt thf sfdrft kfy fntry, bnd to storf thf kfystorf
 * (bs is shown in thf sbmplf dodf bbovf),
 * difffrfnt pbsswords or othfr protfdtion pbrbmftfrs
 * mby blso bf usfd.
 *
 * <p> Evfry implfmfntbtion of thf Jbvb plbtform is rfquirfd to support
 * thf following stbndbrd {@dodf KfyStorf} typf:
 * <ul>
 * <li>{@dodf PKCS12}</li>
 * </ul>
 * This typf is dfsdribfd in thf <b hrff=
 * "{@dodRoot}/../tfdhnotfs/guidfs/sfdurity/StbndbrdNbmfs.html#KfyStorf">
 * KfyStorf sfdtion</b> of thf
 * Jbvb Cryptogrbphy Ardhitfdturf Stbndbrd Algorithm Nbmf Dodumfntbtion.
 * Consult thf rflfbsf dodumfntbtion for your implfmfntbtion to sff if bny
 * othfr typfs brf supportfd.
 *
 * @buthor Jbn Lufhf
 *
 * @sff jbvb.sfdurity.PrivbtfKfy
 * @sff jbvbx.drypto.SfdrftKfy
 * @sff jbvb.sfdurity.dfrt.Cfrtifidbtf
 *
 * @sindf 1.2
 */

publid dlbss KfyStorf {

    /*
     * Constbnt to lookup in thf Sfdurity propfrtifs filf to dftfrminf
     * thf dffbult kfystorf typf.
     * In thf Sfdurity propfrtifs filf, thf dffbult kfystorf typf is givfn bs:
     * <prf>
     * kfystorf.typf=jks
     * </prf>
     */
    privbtf stbtid finbl String KEYSTORE_TYPE = "kfystorf.typf";

    // Thf kfystorf typf
    privbtf String typf;

    // Thf providfr
    privbtf Providfr providfr;

    // Thf providfr implfmfntbtion
    privbtf KfyStorfSpi kfyStorfSpi;

    // Hbs this kfystorf bffn initiblizfd (lobdfd)?
    privbtf boolfbn initiblizfd = fblsf;

    /**
     * A mbrkfr intfrfbdf for {@dodf KfyStorf}
     * {@link #lobd(KfyStorf.LobdStorfPbrbmftfr) lobd}
     * bnd
     * {@link #storf(KfyStorf.LobdStorfPbrbmftfr) storf}
     * pbrbmftfrs.
     *
     * @sindf 1.5
     */
    publid stbtid intfrfbdf LobdStorfPbrbmftfr {
        /**
         * Gfts thf pbrbmftfr usfd to protfdt kfystorf dbtb.
         *
         * @rfturn thf pbrbmftfr usfd to protfdt kfystorf dbtb, or null
         */
        publid ProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr();
    }

    /**
     * A mbrkfr intfrfbdf for kfystorf protfdtion pbrbmftfrs.
     *
     * <p> Thf informbtion storfd in b {@dodf ProtfdtionPbrbmftfr}
     * objfdt protfdts thf dontfnts of b kfystorf.
     * For fxbmplf, protfdtion pbrbmftfrs mby bf usfd to dhfdk
     * thf intfgrity of kfystorf dbtb, or to protfdt thf
     * donfidfntiblity of sfnsitivf kfystorf dbtb
     * (sudh bs b {@dodf PrivbtfKfy}).
     *
     * @sindf 1.5
     */
    publid stbtid intfrfbdf ProtfdtionPbrbmftfr { }

    /**
     * A pbssword-bbsfd implfmfntbtion of {@dodf ProtfdtionPbrbmftfr}.
     *
     * @sindf 1.5
     */
    publid stbtid dlbss PbsswordProtfdtion implfmfnts
                ProtfdtionPbrbmftfr, jbvbx.sfdurity.buth.Dfstroybblf {

        privbtf finbl dhbr[] pbssword;
        privbtf finbl String protfdtionAlgorithm;
        privbtf finbl AlgorithmPbrbmftfrSpfd protfdtionPbrbmftfrs;
        privbtf volbtilf boolfbn dfstroyfd = fblsf;

        /**
         * Crfbtfs b pbssword pbrbmftfr.
         *
         * <p> Thf spfdififd {@dodf pbssword} is dlonfd bfforf it is storfd
         * in thf nfw {@dodf PbsswordProtfdtion} objfdt.
         *
         * @pbrbm pbssword thf pbssword, whidh mby bf {@dodf null}
         */
        publid PbsswordProtfdtion(dhbr[] pbssword) {
            this.pbssword = (pbssword == null) ? null : pbssword.dlonf();
            this.protfdtionAlgorithm = null;
            this.protfdtionPbrbmftfrs = null;
        }

        /**
         * Crfbtfs b pbssword pbrbmftfr bnd spfdififs thf protfdtion blgorithm
         * bnd bssodibtfd pbrbmftfrs to usf whfn fndrypting b kfystorf fntry.
         * <p>
         * Thf spfdififd {@dodf pbssword} is dlonfd bfforf it is storfd in thf
         * nfw {@dodf PbsswordProtfdtion} objfdt.
         *
         * @pbrbm pbssword thf pbssword, whidh mby bf {@dodf null}
         * @pbrbm protfdtionAlgorithm thf fndryption blgorithm nbmf, for
         *     fxbmplf, {@dodf PBEWithHmbdSHA256AndAES_256}.
         *     Sff thf Ciphfr sfdtion in thf <b hrff=
         * "{@dodRoot}/../tfdhnotfs/guidfs/sfdurity/StbndbrdNbmfs.html#Ciphfr">
         * Jbvb Cryptogrbphy Ardhitfdturf Stbndbrd Algorithm Nbmf
         * Dodumfntbtion</b>
         *     for informbtion bbout stbndbrd fndryption blgorithm nbmfs.
         * @pbrbm protfdtionPbrbmftfrs thf fndryption blgorithm pbrbmftfr
         *     spfdifidbtion, whidh mby bf {@dodf null}
         * @fxdfption NullPointfrExdfption if {@dodf protfdtionAlgorithm} is
         *     {@dodf null}
         *
         * @sindf 1.8
         */
        publid PbsswordProtfdtion(dhbr[] pbssword, String protfdtionAlgorithm,
            AlgorithmPbrbmftfrSpfd protfdtionPbrbmftfrs) {
            if (protfdtionAlgorithm == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            this.pbssword = (pbssword == null) ? null : pbssword.dlonf();
            this.protfdtionAlgorithm = protfdtionAlgorithm;
            this.protfdtionPbrbmftfrs = protfdtionPbrbmftfrs;
        }

        /**
         * Gfts thf nbmf of thf protfdtion blgorithm.
         * If nonf wbs sft thfn thf kfystorf providfr will usf its dffbult
         * protfdtion blgorithm. Thf nbmf of thf dffbult protfdtion blgorithm
         * for b givfn kfystorf typf is sft using thf
         * {@dodf 'kfystorf.<typf>.kfyProtfdtionAlgorithm'} sfdurity propfrty.
         * For fxbmplf, thf
         * {@dodf kfystorf.PKCS12.kfyProtfdtionAlgorithm} propfrty storfs thf
         * nbmf of thf dffbult kfy protfdtion blgorithm usfd for PKCS12
         * kfystorfs. If thf sfdurity propfrty is not sft, bn
         * implfmfntbtion-spfdifid blgorithm will bf usfd.
         *
         * @rfturn thf blgorithm nbmf, or {@dodf null} if nonf wbs sft
         *
         * @sindf 1.8
         */
        publid String gftProtfdtionAlgorithm() {
            rfturn protfdtionAlgorithm;
        }

        /**
         * Gfts thf pbrbmftfrs supplifd for thf protfdtion blgorithm.
         *
         * @rfturn thf blgorithm pbrbmftfr spfdifidbtion, or {@dodf  null},
         *     if nonf wbs sft
         *
         * @sindf 1.8
         */
        publid AlgorithmPbrbmftfrSpfd gftProtfdtionPbrbmftfrs() {
            rfturn protfdtionPbrbmftfrs;
        }

        /**
         * Gfts thf pbssword.
         *
         * <p>Notf thbt this mfthod rfturns b rfffrfndf to thf pbssword.
         * If b dlonf of thf brrby is drfbtfd it is thf dbllfr's
         * rfsponsibility to zfro out thf pbssword informbtion
         * bftfr it is no longfr nffdfd.
         *
         * @sff #dfstroy()
         * @rfturn thf pbssword, whidh mby bf {@dodf null}
         * @fxdfption IllfgblStbtfExdfption if thf pbssword hbs
         *              bffn dlfbrfd (dfstroyfd)
         */
        publid syndhronizfd dhbr[] gftPbssword() {
            if (dfstroyfd) {
                throw nfw IllfgblStbtfExdfption("pbssword hbs bffn dlfbrfd");
            }
            rfturn pbssword;
        }

        /**
         * Clfbrs thf pbssword.
         *
         * @fxdfption DfstroyFbilfdExdfption if this mfthod wbs unbblf
         *      to dlfbr thf pbssword
         */
        publid syndhronizfd void dfstroy() throws DfstroyFbilfdExdfption {
            dfstroyfd = truf;
            if (pbssword != null) {
                Arrbys.fill(pbssword, ' ');
            }
        }

        /**
         * Dftfrminfs if pbssword hbs bffn dlfbrfd.
         *
         * @rfturn truf if thf pbssword hbs bffn dlfbrfd, fblsf othfrwisf
         */
        publid syndhronizfd boolfbn isDfstroyfd() {
            rfturn dfstroyfd;
        }
    }

    /**
     * A ProtfdtionPbrbmftfr fndbpsulbting b CbllbbdkHbndlfr.
     *
     * @sindf 1.5
     */
    publid stbtid dlbss CbllbbdkHbndlfrProtfdtion
            implfmfnts ProtfdtionPbrbmftfr {

        privbtf finbl CbllbbdkHbndlfr hbndlfr;

        /**
         * Construdts b nfw CbllbbdkHbndlfrProtfdtion from b
         * CbllbbdkHbndlfr.
         *
         * @pbrbm hbndlfr thf CbllbbdkHbndlfr
         * @fxdfption NullPointfrExdfption if hbndlfr is null
         */
        publid CbllbbdkHbndlfrProtfdtion(CbllbbdkHbndlfr hbndlfr) {
            if (hbndlfr == null) {
                throw nfw NullPointfrExdfption("hbndlfr must not bf null");
            }
            this.hbndlfr = hbndlfr;
        }

        /**
         * Rfturns thf CbllbbdkHbndlfr.
         *
         * @rfturn thf CbllbbdkHbndlfr.
         */
        publid CbllbbdkHbndlfr gftCbllbbdkHbndlfr() {
            rfturn hbndlfr;
        }

    }

    /**
     * A mbrkfr intfrfbdf for {@dodf KfyStorf} fntry typfs.
     *
     * @sindf 1.5
     */
    publid stbtid intfrfbdf Entry {

        /**
         * Rftrifvfs thf bttributfs bssodibtfd with bn fntry.
         * <p>
         * Thf dffbult implfmfntbtion rfturns bn fmpty {@dodf Sft}.
         *
         * @rfturn bn unmodifibblf {@dodf Sft} of bttributfs, possibly fmpty
         *
         * @sindf 1.8
         */
        publid dffbult Sft<Attributf> gftAttributfs() {
            rfturn Collfdtions.<Attributf>fmptySft();
        }

        /**
         * An bttributf bssodibtfd with b kfystorf fntry.
         * It domprisfs b nbmf bnd onf or morf vblufs.
         *
         * @sindf 1.8
         */
        publid intfrfbdf Attributf {
            /**
             * Rfturns thf bttributf's nbmf.
             *
             * @rfturn thf bttributf nbmf
             */
            publid String gftNbmf();

            /**
             * Rfturns thf bttributf's vbluf.
             * Multi-vblufd bttributfs fndodf thfir vblufs bs b singlf string.
             *
             * @rfturn thf bttributf vbluf
             */
            publid String gftVbluf();
        }
    }

    /**
     * A {@dodf KfyStorf} fntry thbt holds b {@dodf PrivbtfKfy}
     * bnd dorrfsponding dfrtifidbtf dhbin.
     *
     * @sindf 1.5
     */
    publid stbtid finbl dlbss PrivbtfKfyEntry implfmfnts Entry {

        privbtf finbl PrivbtfKfy privKfy;
        privbtf finbl Cfrtifidbtf[] dhbin;
        privbtf finbl Sft<Attributf> bttributfs;

        /**
         * Construdts b {@dodf PrivbtfKfyEntry} with b
         * {@dodf PrivbtfKfy} bnd dorrfsponding dfrtifidbtf dhbin.
         *
         * <p> Thf spfdififd {@dodf dhbin} is dlonfd bfforf it is storfd
         * in thf nfw {@dodf PrivbtfKfyEntry} objfdt.
         *
         * @pbrbm privbtfKfy thf {@dodf PrivbtfKfy}
         * @pbrbm dhbin bn brrby of {@dodf Cfrtifidbtf}s
         *      rfprfsfnting thf dfrtifidbtf dhbin.
         *      Thf dhbin must bf ordfrfd bnd dontbin b
         *      {@dodf Cfrtifidbtf} bt indfx 0
         *      dorrfsponding to thf privbtf kfy.
         *
         * @fxdfption NullPointfrExdfption if
         *      {@dodf privbtfKfy} or {@dodf dhbin}
         *      is {@dodf null}
         * @fxdfption IllfgblArgumfntExdfption if thf spfdififd dhbin hbs b
         *      lfngth of 0, if thf spfdififd dhbin dofs not dontbin
         *      {@dodf Cfrtifidbtf}s of thf sbmf typf,
         *      or if thf {@dodf PrivbtfKfy} blgorithm
         *      dofs not mbtdh thf blgorithm of thf {@dodf PublidKfy}
         *      in thf fnd fntity {@dodf Cfrtifidbtf} (bt indfx 0)
         */
        publid PrivbtfKfyEntry(PrivbtfKfy privbtfKfy, Cfrtifidbtf[] dhbin) {
            this(privbtfKfy, dhbin, Collfdtions.<Attributf>fmptySft());
        }

        /**
         * Construdts b {@dodf PrivbtfKfyEntry} with b {@dodf PrivbtfKfy} bnd
         * dorrfsponding dfrtifidbtf dhbin bnd bssodibtfd fntry bttributfs.
         *
         * <p> Thf spfdififd {@dodf dhbin} bnd {@dodf bttributfs} brf dlonfd
         * bfforf thfy brf storfd in thf nfw {@dodf PrivbtfKfyEntry} objfdt.
         *
         * @pbrbm privbtfKfy thf {@dodf PrivbtfKfy}
         * @pbrbm dhbin bn brrby of {@dodf Cfrtifidbtf}s
         *      rfprfsfnting thf dfrtifidbtf dhbin.
         *      Thf dhbin must bf ordfrfd bnd dontbin b
         *      {@dodf Cfrtifidbtf} bt indfx 0
         *      dorrfsponding to thf privbtf kfy.
         * @pbrbm bttributfs thf bttributfs
         *
         * @fxdfption NullPointfrExdfption if {@dodf privbtfKfy}, {@dodf dhbin}
         *      or {@dodf bttributfs} is {@dodf null}
         * @fxdfption IllfgblArgumfntExdfption if thf spfdififd dhbin hbs b
         *      lfngth of 0, if thf spfdififd dhbin dofs not dontbin
         *      {@dodf Cfrtifidbtf}s of thf sbmf typf,
         *      or if thf {@dodf PrivbtfKfy} blgorithm
         *      dofs not mbtdh thf blgorithm of thf {@dodf PublidKfy}
         *      in thf fnd fntity {@dodf Cfrtifidbtf} (bt indfx 0)
         *
         * @sindf 1.8
         */
        publid PrivbtfKfyEntry(PrivbtfKfy privbtfKfy, Cfrtifidbtf[] dhbin,
           Sft<Attributf> bttributfs) {

            if (privbtfKfy == null || dhbin == null || bttributfs == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            if (dhbin.lfngth == 0) {
                throw nfw IllfgblArgumfntExdfption
                                ("invblid zfro-lfngth input dhbin");
            }

            Cfrtifidbtf[] dlonfdChbin = dhbin.dlonf();
            String dfrtTypf = dlonfdChbin[0].gftTypf();
            for (int i = 1; i < dlonfdChbin.lfngth; i++) {
                if (!dfrtTypf.fqubls(dlonfdChbin[i].gftTypf())) {
                    throw nfw IllfgblArgumfntExdfption
                                ("dhbin dofs not dontbin dfrtifidbtfs " +
                                "of thf sbmf typf");
                }
            }
            if (!privbtfKfy.gftAlgorithm().fqubls
                        (dlonfdChbin[0].gftPublidKfy().gftAlgorithm())) {
                throw nfw IllfgblArgumfntExdfption
                                ("privbtf kfy blgorithm dofs not mbtdh " +
                                "blgorithm of publid kfy in fnd fntity " +
                                "dfrtifidbtf (bt indfx 0)");
            }
            this.privKfy = privbtfKfy;

            if (dlonfdChbin[0] instbndfof X509Cfrtifidbtf &&
                !(dlonfdChbin instbndfof X509Cfrtifidbtf[])) {

                this.dhbin = nfw X509Cfrtifidbtf[dlonfdChbin.lfngth];
                Systfm.brrbydopy(dlonfdChbin, 0,
                                this.dhbin, 0, dlonfdChbin.lfngth);
            } flsf {
                this.dhbin = dlonfdChbin;
            }

            this.bttributfs =
                Collfdtions.unmodifibblfSft(nfw HbshSft<>(bttributfs));
        }

        /**
         * Gfts thf {@dodf PrivbtfKfy} from this fntry.
         *
         * @rfturn thf {@dodf PrivbtfKfy} from this fntry
         */
        publid PrivbtfKfy gftPrivbtfKfy() {
            rfturn privKfy;
        }

        /**
         * Gfts thf {@dodf Cfrtifidbtf} dhbin from this fntry.
         *
         * <p> Thf storfd dhbin is dlonfd bfforf bfing rfturnfd.
         *
         * @rfturn bn brrby of {@dodf Cfrtifidbtf}s dorrfsponding
         *      to thf dfrtifidbtf dhbin for thf publid kfy.
         *      If thf dfrtifidbtfs brf of typf X.509,
         *      thf runtimf typf of thf rfturnfd brrby is
         *      {@dodf X509Cfrtifidbtf[]}.
         */
        publid Cfrtifidbtf[] gftCfrtifidbtfChbin() {
            rfturn dhbin.dlonf();
        }

        /**
         * Gfts thf fnd fntity {@dodf Cfrtifidbtf}
         * from thf dfrtifidbtf dhbin in this fntry.
         *
         * @rfturn thf fnd fntity {@dodf Cfrtifidbtf} (bt indfx 0)
         *      from thf dfrtifidbtf dhbin in this fntry.
         *      If thf dfrtifidbtf is of typf X.509,
         *      thf runtimf typf of thf rfturnfd dfrtifidbtf is
         *      {@dodf X509Cfrtifidbtf}.
         */
        publid Cfrtifidbtf gftCfrtifidbtf() {
            rfturn dhbin[0];
        }

        /**
         * Rftrifvfs thf bttributfs bssodibtfd with bn fntry.
         * <p>
         *
         * @rfturn bn unmodifibblf {@dodf Sft} of bttributfs, possibly fmpty
         *
         * @sindf 1.8
         */
        @Ovfrridf
        publid Sft<Attributf> gftAttributfs() {
            rfturn bttributfs;
        }

        /**
         * Rfturns b string rfprfsfntbtion of this PrivbtfKfyEntry.
         * @rfturn b string rfprfsfntbtion of this PrivbtfKfyEntry.
         */
        publid String toString() {
            StringBuildfr sb = nfw StringBuildfr();
            sb.bppfnd("Privbtf kfy fntry bnd dfrtifidbtf dhbin with "
                + dhbin.lfngth + " flfmfnts:\r\n");
            for (Cfrtifidbtf dfrt : dhbin) {
                sb.bppfnd(dfrt);
                sb.bppfnd("\r\n");
            }
            rfturn sb.toString();
        }

    }

    /**
     * A {@dodf KfyStorf} fntry thbt holds b {@dodf SfdrftKfy}.
     *
     * @sindf 1.5
     */
    publid stbtid finbl dlbss SfdrftKfyEntry implfmfnts Entry {

        privbtf finbl SfdrftKfy sKfy;
        privbtf finbl Sft<Attributf> bttributfs;

        /**
         * Construdts b {@dodf SfdrftKfyEntry} with b
         * {@dodf SfdrftKfy}.
         *
         * @pbrbm sfdrftKfy thf {@dodf SfdrftKfy}
         *
         * @fxdfption NullPointfrExdfption if {@dodf sfdrftKfy}
         *      is {@dodf null}
         */
        publid SfdrftKfyEntry(SfdrftKfy sfdrftKfy) {
            if (sfdrftKfy == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            this.sKfy = sfdrftKfy;
            this.bttributfs = Collfdtions.<Attributf>fmptySft();
        }

        /**
         * Construdts b {@dodf SfdrftKfyEntry} with b {@dodf SfdrftKfy} bnd
         * bssodibtfd fntry bttributfs.
         *
         * <p> Thf spfdififd {@dodf bttributfs} is dlonfd bfforf it is storfd
         * in thf nfw {@dodf SfdrftKfyEntry} objfdt.
         *
         * @pbrbm sfdrftKfy thf {@dodf SfdrftKfy}
         * @pbrbm bttributfs thf bttributfs
         *
         * @fxdfption NullPointfrExdfption if {@dodf sfdrftKfy} or
         *     {@dodf bttributfs} is {@dodf null}
         *
         * @sindf 1.8
         */
        publid SfdrftKfyEntry(SfdrftKfy sfdrftKfy, Sft<Attributf> bttributfs) {

            if (sfdrftKfy == null || bttributfs == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            this.sKfy = sfdrftKfy;
            this.bttributfs =
                Collfdtions.unmodifibblfSft(nfw HbshSft<>(bttributfs));
        }

        /**
         * Gfts thf {@dodf SfdrftKfy} from this fntry.
         *
         * @rfturn thf {@dodf SfdrftKfy} from this fntry
         */
        publid SfdrftKfy gftSfdrftKfy() {
            rfturn sKfy;
        }

        /**
         * Rftrifvfs thf bttributfs bssodibtfd with bn fntry.
         * <p>
         *
         * @rfturn bn unmodifibblf {@dodf Sft} of bttributfs, possibly fmpty
         *
         * @sindf 1.8
         */
        @Ovfrridf
        publid Sft<Attributf> gftAttributfs() {
            rfturn bttributfs;
        }

        /**
         * Rfturns b string rfprfsfntbtion of this SfdrftKfyEntry.
         * @rfturn b string rfprfsfntbtion of this SfdrftKfyEntry.
         */
        publid String toString() {
            rfturn "Sfdrft kfy fntry with blgorithm " + sKfy.gftAlgorithm();
        }
    }

    /**
     * A {@dodf KfyStorf} fntry thbt holds b trustfd
     * {@dodf Cfrtifidbtf}.
     *
     * @sindf 1.5
     */
    publid stbtid finbl dlbss TrustfdCfrtifidbtfEntry implfmfnts Entry {

        privbtf finbl Cfrtifidbtf dfrt;
        privbtf finbl Sft<Attributf> bttributfs;

        /**
         * Construdts b {@dodf TrustfdCfrtifidbtfEntry} with b
         * trustfd {@dodf Cfrtifidbtf}.
         *
         * @pbrbm trustfdCfrt thf trustfd {@dodf Cfrtifidbtf}
         *
         * @fxdfption NullPointfrExdfption if
         *      {@dodf trustfdCfrt} is {@dodf null}
         */
        publid TrustfdCfrtifidbtfEntry(Cfrtifidbtf trustfdCfrt) {
            if (trustfdCfrt == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            this.dfrt = trustfdCfrt;
            this.bttributfs = Collfdtions.<Attributf>fmptySft();
        }

        /**
         * Construdts b {@dodf TrustfdCfrtifidbtfEntry} with b
         * trustfd {@dodf Cfrtifidbtf} bnd bssodibtfd fntry bttributfs.
         *
         * <p> Thf spfdififd {@dodf bttributfs} is dlonfd bfforf it is storfd
         * in thf nfw {@dodf TrustfdCfrtifidbtfEntry} objfdt.
         *
         * @pbrbm trustfdCfrt thf trustfd {@dodf Cfrtifidbtf}
         * @pbrbm bttributfs thf bttributfs
         *
         * @fxdfption NullPointfrExdfption if {@dodf trustfdCfrt} or
         *     {@dodf bttributfs} is {@dodf null}
         *
         * @sindf 1.8
         */
        publid TrustfdCfrtifidbtfEntry(Cfrtifidbtf trustfdCfrt,
           Sft<Attributf> bttributfs) {
            if (trustfdCfrt == null || bttributfs == null) {
                throw nfw NullPointfrExdfption("invblid null input");
            }
            this.dfrt = trustfdCfrt;
            this.bttributfs =
                Collfdtions.unmodifibblfSft(nfw HbshSft<>(bttributfs));
        }

        /**
         * Gfts thf trustfd {@dodf Cfrtfidbtf} from this fntry.
         *
         * @rfturn thf trustfd {@dodf Cfrtifidbtf} from this fntry
         */
        publid Cfrtifidbtf gftTrustfdCfrtifidbtf() {
            rfturn dfrt;
        }

        /**
         * Rftrifvfs thf bttributfs bssodibtfd with bn fntry.
         * <p>
         *
         * @rfturn bn unmodifibblf {@dodf Sft} of bttributfs, possibly fmpty
         *
         * @sindf 1.8
         */
        @Ovfrridf
        publid Sft<Attributf> gftAttributfs() {
            rfturn bttributfs;
        }

        /**
         * Rfturns b string rfprfsfntbtion of this TrustfdCfrtifidbtfEntry.
         * @rfturn b string rfprfsfntbtion of this TrustfdCfrtifidbtfEntry.
         */
        publid String toString() {
            rfturn "Trustfd dfrtifidbtf fntry:\r\n" + dfrt.toString();
        }
    }

    /**
     * Crfbtfs b KfyStorf objfdt of thf givfn typf, bnd fndbpsulbtfs thf givfn
     * providfr implfmfntbtion (SPI objfdt) in it.
     *
     * @pbrbm kfyStorfSpi thf providfr implfmfntbtion.
     * @pbrbm providfr thf providfr.
     * @pbrbm typf thf kfystorf typf.
     */
    protfdtfd KfyStorf(KfyStorfSpi kfyStorfSpi, Providfr providfr, String typf)
    {
        this.kfyStorfSpi = kfyStorfSpi;
        this.providfr = providfr;
        this.typf = typf;
    }

    /**
     * Rfturns b kfystorf objfdt of thf spfdififd typf.
     *
     * <p> This mfthod trbvfrsfs thf list of rfgistfrfd sfdurity Providfrs,
     * stbrting with thf most prfffrrfd Providfr.
     * A nfw KfyStorf objfdt fndbpsulbting thf
     * KfyStorfSpi implfmfntbtion from thf first
     * Providfr thbt supports thf spfdififd typf is rfturnfd.
     *
     * <p> Notf thbt thf list of rfgistfrfd providfrs mby bf rftrifvfd vib
     * thf {@link Sfdurity#gftProvidfrs() Sfdurity.gftProvidfrs()} mfthod.
     *
     * @pbrbm typf thf typf of kfystorf.
     * Sff thf KfyStorf sfdtion in thf <b hrff=
     * "{@dodRoot}/../tfdhnotfs/guidfs/sfdurity/StbndbrdNbmfs.html#KfyStorf">
     * Jbvb Cryptogrbphy Ardhitfdturf Stbndbrd Algorithm Nbmf Dodumfntbtion</b>
     * for informbtion bbout stbndbrd kfystorf typfs.
     *
     * @rfturn b kfystorf objfdt of thf spfdififd typf.
     *
     * @fxdfption KfyStorfExdfption if no Providfr supports b
     *          KfyStorfSpi implfmfntbtion for thf
     *          spfdififd typf.
     *
     * @sff Providfr
     */
    publid stbtid KfyStorf gftInstbndf(String typf)
        throws KfyStorfExdfption
    {
        try {
            Objfdt[] objs = Sfdurity.gftImpl(typf, "KfyStorf", (String)null);
            rfturn nfw KfyStorf((KfyStorfSpi)objs[0], (Providfr)objs[1], typf);
        } dbtdh (NoSudhAlgorithmExdfption nsbf) {
            throw nfw KfyStorfExdfption(typf + " not found", nsbf);
        } dbtdh (NoSudhProvidfrExdfption nspf) {
            throw nfw KfyStorfExdfption(typf + " not found", nspf);
        }
    }

    /**
     * Rfturns b kfystorf objfdt of thf spfdififd typf.
     *
     * <p> A nfw KfyStorf objfdt fndbpsulbting thf
     * KfyStorfSpi implfmfntbtion from thf spfdififd providfr
     * is rfturnfd.  Thf spfdififd providfr must bf rfgistfrfd
     * in thf sfdurity providfr list.
     *
     * <p> Notf thbt thf list of rfgistfrfd providfrs mby bf rftrifvfd vib
     * thf {@link Sfdurity#gftProvidfrs() Sfdurity.gftProvidfrs()} mfthod.
     *
     * @pbrbm typf thf typf of kfystorf.
     * Sff thf KfyStorf sfdtion in thf <b hrff=
     * "{@dodRoot}/../tfdhnotfs/guidfs/sfdurity/StbndbrdNbmfs.html#KfyStorf">
     * Jbvb Cryptogrbphy Ardhitfdturf Stbndbrd Algorithm Nbmf Dodumfntbtion</b>
     * for informbtion bbout stbndbrd kfystorf typfs.
     *
     * @pbrbm providfr thf nbmf of thf providfr.
     *
     * @rfturn b kfystorf objfdt of thf spfdififd typf.
     *
     * @fxdfption KfyStorfExdfption if b KfyStorfSpi
     *          implfmfntbtion for thf spfdififd typf is not
     *          bvbilbblf from thf spfdififd providfr.
     *
     * @fxdfption NoSudhProvidfrExdfption if thf spfdififd providfr is not
     *          rfgistfrfd in thf sfdurity providfr list.
     *
     * @fxdfption IllfgblArgumfntExdfption if thf providfr nbmf is null
     *          or fmpty.
     *
     * @sff Providfr
     */
    publid stbtid KfyStorf gftInstbndf(String typf, String providfr)
        throws KfyStorfExdfption, NoSudhProvidfrExdfption
    {
        if (providfr == null || providfr.lfngth() == 0)
            throw nfw IllfgblArgumfntExdfption("missing providfr");
        try {
            Objfdt[] objs = Sfdurity.gftImpl(typf, "KfyStorf", providfr);
            rfturn nfw KfyStorf((KfyStorfSpi)objs[0], (Providfr)objs[1], typf);
        } dbtdh (NoSudhAlgorithmExdfption nsbf) {
            throw nfw KfyStorfExdfption(typf + " not found", nsbf);
        }
    }

    /**
     * Rfturns b kfystorf objfdt of thf spfdififd typf.
     *
     * <p> A nfw KfyStorf objfdt fndbpsulbting thf
     * KfyStorfSpi implfmfntbtion from thf spfdififd Providfr
     * objfdt is rfturnfd.  Notf thbt thf spfdififd Providfr objfdt
     * dofs not hbvf to bf rfgistfrfd in thf providfr list.
     *
     * @pbrbm typf thf typf of kfystorf.
     * Sff thf KfyStorf sfdtion in thf <b hrff=
     * "{@dodRoot}/../tfdhnotfs/guidfs/sfdurity/StbndbrdNbmfs.html#KfyStorf">
     * Jbvb Cryptogrbphy Ardhitfdturf Stbndbrd Algorithm Nbmf Dodumfntbtion</b>
     * for informbtion bbout stbndbrd kfystorf typfs.
     *
     * @pbrbm providfr thf providfr.
     *
     * @rfturn b kfystorf objfdt of thf spfdififd typf.
     *
     * @fxdfption KfyStorfExdfption if KfyStorfSpi
     *          implfmfntbtion for thf spfdififd typf is not bvbilbblf
     *          from thf spfdififd Providfr objfdt.
     *
     * @fxdfption IllfgblArgumfntExdfption if thf spfdififd providfr is null.
     *
     * @sff Providfr
     *
     * @sindf 1.4
     */
    publid stbtid KfyStorf gftInstbndf(String typf, Providfr providfr)
        throws KfyStorfExdfption
    {
        if (providfr == null)
            throw nfw IllfgblArgumfntExdfption("missing providfr");
        try {
            Objfdt[] objs = Sfdurity.gftImpl(typf, "KfyStorf", providfr);
            rfturn nfw KfyStorf((KfyStorfSpi)objs[0], (Providfr)objs[1], typf);
        } dbtdh (NoSudhAlgorithmExdfption nsbf) {
            throw nfw KfyStorfExdfption(typf + " not found", nsbf);
        }
    }

    /**
     * Rfturns thf dffbult kfystorf typf bs spfdififd by thf
     * {@dodf kfystorf.typf} sfdurity propfrty, or thf string
     * {@litfrbl "jks"} (bdronym for {@litfrbl "Jbvb kfystorf"})
     * if no sudh propfrty fxists.
     *
     * <p>Thf dffbult kfystorf typf dbn bf usfd by bpplidbtions thbt do not
     * wbnt to usf b hbrd-dodfd kfystorf typf whfn dblling onf of thf
     * {@dodf gftInstbndf} mfthods, bnd wbnt to providf b dffbult kfystorf
     * typf in dbsf b usfr dofs not spfdify its own.
     *
     * <p>Thf dffbult kfystorf typf dbn bf dhbngfd by sftting thf vbluf of thf
     * {@dodf kfystorf.typf} sfdurity propfrty to thf dfsirfd kfystorf typf.
     *
     * @rfturn thf dffbult kfystorf typf bs spfdififd by thf
     * {@dodf kfystorf.typf} sfdurity propfrty, or thf string {@litfrbl "jks"}
     * if no sudh propfrty fxists.
     * @sff jbvb.sfdurity.Sfdurity sfdurity propfrtifs
     */
    publid finbl stbtid String gftDffbultTypf() {
        String kstypf;
        kstypf = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<String>() {
            publid String run() {
                rfturn Sfdurity.gftPropfrty(KEYSTORE_TYPE);
            }
        });
        if (kstypf == null) {
            kstypf = "jks";
        }
        rfturn kstypf;
    }

    /**
     * Rfturns thf providfr of this kfystorf.
     *
     * @rfturn thf providfr of this kfystorf.
     */
    publid finbl Providfr gftProvidfr()
    {
        rfturn this.providfr;
    }

    /**
     * Rfturns thf typf of this kfystorf.
     *
     * @rfturn thf typf of this kfystorf.
     */
    publid finbl String gftTypf()
    {
        rfturn this.typf;
    }

    /**
     * Rfturns thf kfy bssodibtfd with thf givfn blibs, using thf givfn
     * pbssword to rfdovfr it.  Thf kfy must hbvf bffn bssodibtfd with
     * thf blibs by b dbll to {@dodf sftKfyEntry},
     * or by b dbll to {@dodf sftEntry} with b
     * {@dodf PrivbtfKfyEntry} or {@dodf SfdrftKfyEntry}.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm pbssword thf pbssword for rfdovfring thf kfy
     *
     * @rfturn thf rfqufstfd kfy, or null if thf givfn blibs dofs not fxist
     * or dofs not idfntify b kfy-rflbtfd fntry.
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm for rfdovfring thf
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if thf kfy dbnnot bf rfdovfrfd
     * (f.g., thf givfn pbssword is wrong).
     */
    publid finbl Kfy gftKfy(String blibs, dhbr[] pbssword)
        throws KfyStorfExdfption, NoSudhAlgorithmExdfption,
            UnrfdovfrbblfKfyExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftKfy(blibs, pbssword);
    }

    /**
     * Rfturns thf dfrtifidbtf dhbin bssodibtfd with thf givfn blibs.
     * Thf dfrtifidbtf dhbin must hbvf bffn bssodibtfd with thf blibs
     * by b dbll to {@dodf sftKfyEntry},
     * or by b dbll to {@dodf sftEntry} with b
     * {@dodf PrivbtfKfyEntry}.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf dhbin (ordfrfd with thf usfr's dfrtifidbtf first
     * followfd by zfro or morf dfrtifidbtf buthoritifs), or null if thf givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dhbin
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl Cfrtifidbtf[] gftCfrtifidbtfChbin(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftCfrtifidbtfChbin(blibs);
    }

    /**
     * Rfturns thf dfrtifidbtf bssodibtfd with thf givfn blibs.
     *
     * <p> If thf givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * thfn thf trustfd dfrtifidbtf dontbinfd in thbt fntry is rfturnfd.
     *
     * <p> If thf givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf PrivbtfKfyEntry},
     * thfn thf first flfmfnt of thf dfrtifidbtf dhbin in thbt fntry
     * is rfturnfd.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf, or null if thf givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl Cfrtifidbtf gftCfrtifidbtf(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftCfrtifidbtf(blibs);
    }

    /**
     * Rfturns thf drfbtion dbtf of thf fntry idfntififd by thf givfn blibs.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf drfbtion dbtf of this fntry, or null if thf givfn blibs dofs
     * not fxist
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl Dbtf gftCrfbtionDbtf(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftCrfbtionDbtf(blibs);
    }

    /**
     * Assigns thf givfn kfy to thf givfn blibs, protfdting it with thf givfn
     * pbssword.
     *
     * <p>If thf givfn kfy is of typf {@dodf jbvb.sfdurity.PrivbtfKfy},
     * it must bf bddompbnifd by b dfrtifidbtf dhbin dfrtifying thf
     * dorrfsponding publid kfy.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy to bf bssodibtfd with thf blibs
     * @pbrbm pbssword thf pbssword to protfdt thf kfy
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     * kfy (only rfquirfd if thf givfn kfy is of typf
     * {@dodf jbvb.sfdurity.PrivbtfKfy}).
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd), thf givfn kfy dbnnot bf protfdtfd, or this opfrbtion fbils
     * for somf othfr rfbson
     */
    publid finbl void sftKfyEntry(String blibs, Kfy kfy, dhbr[] pbssword,
                                  Cfrtifidbtf[] dhbin)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        if ((kfy instbndfof PrivbtfKfy) &&
            (dhbin == null || dhbin.lfngth == 0)) {
            throw nfw IllfgblArgumfntExdfption("Privbtf kfy must bf "
                                               + "bddompbnifd by dfrtifidbtf "
                                               + "dhbin");
        }
        kfyStorfSpi.fnginfSftKfyEntry(blibs, kfy, pbssword, dhbin);
    }

    /**
     * Assigns thf givfn kfy (thbt hbs blrfbdy bffn protfdtfd) to thf givfn
     * blibs.
     *
     * <p>If thf protfdtfd kfy is of typf
     * {@dodf jbvb.sfdurity.PrivbtfKfy}, it must bf bddompbnifd by b
     * dfrtifidbtf dhbin dfrtifying thf dorrfsponding publid kfy. If thf
     * undfrlying kfystorf implfmfntbtion is of typf {@dodf jks},
     * {@dodf kfy} must bf fndodfd bs bn
     * {@dodf EndryptfdPrivbtfKfyInfo} bs dffinfd in thf PKCS #8 stbndbrd.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy (in protfdtfd formbt) to bf bssodibtfd with thf blibs
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     *          kfy (only usfful if thf protfdtfd kfy is of typf
     *          {@dodf jbvb.sfdurity.PrivbtfKfy}).
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd), or if this opfrbtion fbils for somf othfr rfbson.
     */
    publid finbl void sftKfyEntry(String blibs, bytf[] kfy,
                                  Cfrtifidbtf[] dhbin)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfSftKfyEntry(blibs, kfy, dhbin);
    }

    /**
     * Assigns thf givfn trustfd dfrtifidbtf to thf givfn blibs.
     *
     * <p> If thf givfn blibs idfntififs bn fxisting fntry
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * thf trustfd dfrtifidbtf in thf fxisting fntry
     * is ovfrriddfn by thf givfn dfrtifidbtf.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm dfrt thf dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd,
     * or thf givfn blibs blrfbdy fxists bnd dofs not idfntify bn
     * fntry dontbining b trustfd dfrtifidbtf,
     * or this opfrbtion fbils for somf othfr rfbson.
     */
    publid finbl void sftCfrtifidbtfEntry(String blibs, Cfrtifidbtf dfrt)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfSftCfrtifidbtfEntry(blibs, dfrt);
    }

    /**
     * Dflftfs thf fntry idfntififd by thf givfn blibs from this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd,
     * or if thf fntry dbnnot bf rfmovfd.
     */
    publid finbl void dflftfEntry(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfDflftfEntry(blibs);
    }

    /**
     * Lists bll thf blibs nbmfs of this kfystorf.
     *
     * @rfturn fnumfrbtion of thf blibs nbmfs
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl Enumfrbtion<String> blibsfs()
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfAlibsfs();
    }

    /**
     * Chfdks if thf givfn blibs fxists in this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn truf if thf blibs fxists, fblsf othfrwisf
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl boolfbn dontbinsAlibs(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfContbinsAlibs(blibs);
    }

    /**
     * Rftrifvfs thf numbfr of fntrifs in this kfystorf.
     *
     * @rfturn thf numbfr of fntrifs in this kfystorf
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl int sizf()
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfSizf();
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs
     * wbs drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf PrivbtfKfyEntry} or b {@dodf SfdrftKfyEntry}.
     *
     * @pbrbm blibs thf blibs for thf kfystorf fntry to bf dhfdkfd
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs is b
     * kfy-rflbtfd fntry, fblsf othfrwisf.
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl boolfbn isKfyEntry(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfIsKfyEntry(blibs);
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs
     * wbs drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf TrustfdCfrtifidbtfEntry}.
     *
     * @pbrbm blibs thf blibs for thf kfystorf fntry to bf dhfdkfd
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs dontbins b
     * trustfd dfrtifidbtf, fblsf othfrwisf.
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl boolfbn isCfrtifidbtfEntry(String blibs)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfIsCfrtifidbtfEntry(blibs);
    }

    /**
     * Rfturns thf (blibs) nbmf of thf first kfystorf fntry whosf dfrtifidbtf
     * mbtdhfs thf givfn dfrtifidbtf.
     *
     * <p> This mfthod bttfmpts to mbtdh thf givfn dfrtifidbtf with fbdh
     * kfystorf fntry. If thf fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to {@dodf sftCfrtifidbtfEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf TrustfdCfrtifidbtfEntry},
     * thfn thf givfn dfrtifidbtf is dompbrfd to thbt fntry's dfrtifidbtf.
     *
     * <p> If thf fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to {@dodf sftKfyEntry},
     * or drfbtfd by b dbll to {@dodf sftEntry} with b
     * {@dodf PrivbtfKfyEntry},
     * thfn thf givfn dfrtifidbtf is dompbrfd to thf first
     * flfmfnt of thbt fntry's dfrtifidbtf dhbin.
     *
     * @pbrbm dfrt thf dfrtifidbtf to mbtdh with.
     *
     * @rfturn thf blibs nbmf of thf first fntry with b mbtdhing dfrtifidbtf,
     * or null if no sudh fntry fxists in this kfystorf.
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     */
    publid finbl String gftCfrtifidbtfAlibs(Cfrtifidbtf dfrt)
        throws KfyStorfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftCfrtifidbtfAlibs(dfrt);
    }

    /**
     * Storfs this kfystorf to thf givfn output strfbm, bnd protfdts its
     * intfgrity with thf givfn pbssword.
     *
     * @pbrbm strfbm thf output strfbm to whidh this kfystorf is writtfn.
     * @pbrbm pbssword thf pbssword to gfnfrbtf thf kfystorf intfgrity dhfdk
     *
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     * (lobdfd).
     * @fxdfption IOExdfption if thfrf wbs bn I/O problfm with dbtb
     * @fxdfption NoSudhAlgorithmExdfption if thf bppropribtf dbtb intfgrity
     * blgorithm dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs indludfd in
     * thf kfystorf dbtb dould not bf storfd
     */
    publid finbl void storf(OutputStrfbm strfbm, dhbr[] pbssword)
        throws KfyStorfExdfption, IOExdfption, NoSudhAlgorithmExdfption,
            CfrtifidbtfExdfption
    {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfStorf(strfbm, pbssword);
    }

    /**
     * Storfs this kfystorf using thf givfn {@dodf LobdStorfPbrbmftfr}.
     *
     * @pbrbm pbrbm thf {@dodf LobdStorfPbrbmftfr}
     *          thbt spfdififs how to storf thf kfystorf,
     *          whidh mby bf {@dodf null}
     *
     * @fxdfption IllfgblArgumfntExdfption if thf givfn
     *          {@dodf LobdStorfPbrbmftfr}
     *          input is not rfdognizfd
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     *          (lobdfd)
     * @fxdfption IOExdfption if thfrf wbs bn I/O problfm with dbtb
     * @fxdfption NoSudhAlgorithmExdfption if thf bppropribtf dbtb intfgrity
     *          blgorithm dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs indludfd in
     *          thf kfystorf dbtb dould not bf storfd
     *
     * @sindf 1.5
     */
    publid finbl void storf(LobdStorfPbrbmftfr pbrbm)
                throws KfyStorfExdfption, IOExdfption,
                NoSudhAlgorithmExdfption, CfrtifidbtfExdfption {
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfStorf(pbrbm);
    }

    /**
     * Lobds this KfyStorf from thf givfn input strfbm.
     *
     * <p>A pbssword mby bf givfn to unlodk thf kfystorf
     * (f.g. thf kfystorf rfsidfs on b hbrdwbrf tokfn dfvidf),
     * or to dhfdk thf intfgrity of thf kfystorf dbtb.
     * If b pbssword is not givfn for intfgrity dhfdking,
     * thfn intfgrity dhfdking is not pfrformfd.
     *
     * <p>In ordfr to drfbtf bn fmpty kfystorf, or if thf kfystorf dbnnot
     * bf initiblizfd from b strfbm, pbss {@dodf null}
     * bs thf {@dodf strfbm} brgumfnt.
     *
     * <p> Notf thbt if this kfystorf hbs blrfbdy bffn lobdfd, it is
     * rfinitiblizfd bnd lobdfd bgbin from thf givfn input strfbm.
     *
     * @pbrbm strfbm thf input strfbm from whidh thf kfystorf is lobdfd,
     * or {@dodf null}
     * @pbrbm pbssword thf pbssword usfd to dhfdk thf intfgrity of
     * thf kfystorf, thf pbssword usfd to unlodk thf kfystorf,
     * or {@dodf null}
     *
     * @fxdfption IOExdfption if thfrf is bn I/O or formbt problfm with thf
     * kfystorf dbtb, if b pbssword is rfquirfd but not givfn,
     * or if thf givfn pbssword wbs indorrfdt. If thf frror is duf to b
     * wrong pbssword, thf {@link Throwbblf#gftCbusf dbusf} of thf
     * {@dodf IOExdfption} should bf bn
     * {@dodf UnrfdovfrbblfKfyExdfption}
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm usfd to dhfdk
     * thf intfgrity of thf kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs in thf
     * kfystorf dould not bf lobdfd
     */
    publid finbl void lobd(InputStrfbm strfbm, dhbr[] pbssword)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption
    {
        kfyStorfSpi.fnginfLobd(strfbm, pbssword);
        initiblizfd = truf;
    }

    /**
     * Lobds this kfystorf using thf givfn {@dodf LobdStorfPbrbmftfr}.
     *
     * <p> Notf thbt if this KfyStorf hbs blrfbdy bffn lobdfd, it is
     * rfinitiblizfd bnd lobdfd bgbin from thf givfn pbrbmftfr.
     *
     * @pbrbm pbrbm thf {@dodf LobdStorfPbrbmftfr}
     *          thbt spfdififs how to lobd thf kfystorf,
     *          whidh mby bf {@dodf null}
     *
     * @fxdfption IllfgblArgumfntExdfption if thf givfn
     *          {@dodf LobdStorfPbrbmftfr}
     *          input is not rfdognizfd
     * @fxdfption IOExdfption if thfrf is bn I/O or formbt problfm with thf
     *          kfystorf dbtb. If thf frror is duf to bn indorrfdt
     *         {@dodf ProtfdtionPbrbmftfr} (f.g. wrong pbssword)
     *         thf {@link Throwbblf#gftCbusf dbusf} of thf
     *         {@dodf IOExdfption} should bf bn
     *         {@dodf UnrfdovfrbblfKfyExdfption}
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm usfd to dhfdk
     *          thf intfgrity of thf kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of thf dfrtifidbtfs in thf
     *          kfystorf dould not bf lobdfd
     *
     * @sindf 1.5
     */
    publid finbl void lobd(LobdStorfPbrbmftfr pbrbm)
                throws IOExdfption, NoSudhAlgorithmExdfption,
                CfrtifidbtfExdfption {

        kfyStorfSpi.fnginfLobd(pbrbm);
        initiblizfd = truf;
    }

    /**
     * Gfts b kfystorf {@dodf Entry} for thf spfdififd blibs
     * with thf spfdififd protfdtion pbrbmftfr.
     *
     * @pbrbm blibs gft thf kfystorf {@dodf Entry} for this blibs
     * @pbrbm protPbrbm thf {@dodf ProtfdtionPbrbmftfr}
     *          usfd to protfdt thf {@dodf Entry},
     *          whidh mby bf {@dodf null}
     *
     * @rfturn thf kfystorf {@dodf Entry} for thf spfdififd blibs,
     *          or {@dodf null} if thfrf is no sudh fntry
     *
     * @fxdfption NullPointfrExdfption if
     *          {@dodf blibs} is {@dodf null}
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm for rfdovfring thf
     *          fntry dbnnot bf found
     * @fxdfption UnrfdovfrbblfEntryExdfption if thf spfdififd
     *          {@dodf protPbrbm} wfrf insuffidifnt or invblid
     * @fxdfption UnrfdovfrbblfKfyExdfption if thf fntry is b
     *          {@dodf PrivbtfKfyEntry} or {@dodf SfdrftKfyEntry}
     *          bnd thf spfdififd {@dodf protPbrbm} dofs not dontbin
     *          thf informbtion nffdfd to rfdovfr thf kfy (f.g. wrong pbssword)
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     *          (lobdfd).
     * @sff #sftEntry(String, KfyStorf.Entry, KfyStorf.ProtfdtionPbrbmftfr)
     *
     * @sindf 1.5
     */
    publid finbl Entry gftEntry(String blibs, ProtfdtionPbrbmftfr protPbrbm)
                throws NoSudhAlgorithmExdfption, UnrfdovfrbblfEntryExdfption,
                KfyStorfExdfption {

        if (blibs == null) {
            throw nfw NullPointfrExdfption("invblid null input");
        }
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfGftEntry(blibs, protPbrbm);
    }

    /**
     * Sbvfs b kfystorf {@dodf Entry} undfr thf spfdififd blibs.
     * Thf protfdtion pbrbmftfr is usfd to protfdt thf
     * {@dodf Entry}.
     *
     * <p> If bn fntry blrfbdy fxists for thf spfdififd blibs,
     * it is ovfrriddfn.
     *
     * @pbrbm blibs sbvf thf kfystorf {@dodf Entry} undfr this blibs
     * @pbrbm fntry thf {@dodf Entry} to sbvf
     * @pbrbm protPbrbm thf {@dodf ProtfdtionPbrbmftfr}
     *          usfd to protfdt thf {@dodf Entry},
     *          whidh mby bf {@dodf null}
     *
     * @fxdfption NullPointfrExdfption if
     *          {@dodf blibs} or {@dodf fntry}
     *          is {@dodf null}
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn initiblizfd
     *          (lobdfd), or if this opfrbtion fbils for somf othfr rfbson
     *
     * @sff #gftEntry(String, KfyStorf.ProtfdtionPbrbmftfr)
     *
     * @sindf 1.5
     */
    publid finbl void sftEntry(String blibs, Entry fntry,
                        ProtfdtionPbrbmftfr protPbrbm)
                throws KfyStorfExdfption {
        if (blibs == null || fntry == null) {
            throw nfw NullPointfrExdfption("invblid null input");
        }
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        kfyStorfSpi.fnginfSftEntry(blibs, fntry, protPbrbm);
    }

    /**
     * Dftfrminfs if thf kfystorf {@dodf Entry} for thf spfdififd
     * {@dodf blibs} is bn instbndf or subdlbss of thf spfdififd
     * {@dodf fntryClbss}.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm fntryClbss thf fntry dlbss
     *
     * @rfturn truf if thf kfystorf {@dodf Entry} for thf spfdififd
     *          {@dodf blibs} is bn instbndf or subdlbss of thf
     *          spfdififd {@dodf fntryClbss}, fblsf othfrwisf
     *
     * @fxdfption NullPointfrExdfption if
     *          {@dodf blibs} or {@dodf fntryClbss}
     *          is {@dodf null}
     * @fxdfption KfyStorfExdfption if thf kfystorf hbs not bffn
     *          initiblizfd (lobdfd)
     *
     * @sindf 1.5
     */
    publid finbl boolfbn
        fntryInstbndfOf(String blibs,
                        Clbss<? fxtfnds KfyStorf.Entry> fntryClbss)
        throws KfyStorfExdfption
    {

        if (blibs == null || fntryClbss == null) {
            throw nfw NullPointfrExdfption("invblid null input");
        }
        if (!initiblizfd) {
            throw nfw KfyStorfExdfption("Uninitiblizfd kfystorf");
        }
        rfturn kfyStorfSpi.fnginfEntryInstbndfOf(blibs, fntryClbss);
    }

    /**
     * A dfsdription of b to-bf-instbntibtfd KfyStorf objfdt.
     *
     * <p>An instbndf of this dlbss fndbpsulbtfs thf informbtion nffdfd to
     * instbntibtf bnd initiblizf b KfyStorf objfdt. Thbt prodfss is
     * triggfrfd whfn thf {@linkplbin #gftKfyStorf} mfthod is dbllfd.
     *
     * <p>This mbkfs it possiblf to dfdouplf donfigurbtion from KfyStorf
     * objfdt drfbtion bnd f.g. dflby b pbssword prompt until it is
     * nffdfd.
     *
     * @sff KfyStorf
     * @sff jbvbx.nft.ssl.KfyStorfBuildfrPbrbmftfrs
     * @sindf 1.5
     */
    publid stbtid bbstrbdt dlbss Buildfr {

        // mbximum timfs to try thf dbllbbdkhbndlfr if thf pbssword is wrong
        stbtid finbl int MAX_CALLBACK_TRIES = 3;

        /**
         * Construdt b nfw Buildfr.
         */
        protfdtfd Buildfr() {
            // fmpty
        }

        /**
         * Rfturns thf KfyStorf dfsdribfd by this objfdt.
         *
         * @rfturn thf {@dodf KfyStorf} dfsdribfd by this objfdt
         * @fxdfption KfyStorfExdfption if bn frror oddurrfd during thf
         *   opfrbtion, for fxbmplf if thf KfyStorf dould not bf
         *   instbntibtfd or lobdfd
         */
        publid bbstrbdt KfyStorf gftKfyStorf() throws KfyStorfExdfption;

        /**
         * Rfturns thf ProtfdtionPbrbmftfrs thbt should bf usfd to obtbin
         * thf {@link KfyStorf.Entry Entry} with thf givfn blibs.
         * Thf {@dodf gftKfyStorf} mfthod must bf invokfd bfforf this
         * mfthod mby bf dbllfd.
         *
         * @rfturn thf ProtfdtionPbrbmftfrs thbt should bf usfd to obtbin
         *   thf {@link KfyStorf.Entry Entry} with thf givfn blibs.
         * @pbrbm blibs thf blibs of thf KfyStorf fntry
         * @throws NullPointfrExdfption if blibs is null
         * @throws KfyStorfExdfption if bn frror oddurrfd during thf
         *   opfrbtion
         * @throws IllfgblStbtfExdfption if thf gftKfyStorf mfthod hbs
         *   not bffn invokfd prior to dblling this mfthod
         */
        publid bbstrbdt ProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr(String blibs)
            throws KfyStorfExdfption;

        /**
         * Rfturns b nfw Buildfr thbt fndbpsulbtfs thf givfn KfyStorf.
         * Thf {@linkplbin #gftKfyStorf} mfthod of thf rfturnfd objfdt
         * will rfturn {@dodf kfyStorf}, thf {@linkplbin
         * #gftProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr()} mfthod will
         * rfturn {@dodf protfdtionPbrbmftfrs}.
         *
         * <p> This is usfful if bn fxisting KfyStorf objfdt nffds to bf
         * usfd with Buildfr-bbsfd APIs.
         *
         * @rfturn b nfw Buildfr objfdt
         * @pbrbm kfyStorf thf KfyStorf to bf fndbpsulbtfd
         * @pbrbm protfdtionPbrbmftfr thf ProtfdtionPbrbmftfr usfd to
         *   protfdt thf KfyStorf fntrifs
         * @throws NullPointfrExdfption if kfyStorf or
         *   protfdtionPbrbmftfrs is null
         * @throws IllfgblArgumfntExdfption if thf kfyStorf hbs not bffn
         *   initiblizfd
         */
        publid stbtid Buildfr nfwInstbndf(finbl KfyStorf kfyStorf,
                finbl ProtfdtionPbrbmftfr protfdtionPbrbmftfr) {
            if ((kfyStorf == null) || (protfdtionPbrbmftfr == null)) {
                throw nfw NullPointfrExdfption();
            }
            if (kfyStorf.initiblizfd == fblsf) {
                throw nfw IllfgblArgumfntExdfption("KfyStorf not initiblizfd");
            }
            rfturn nfw Buildfr() {
                privbtf volbtilf boolfbn gftCbllfd;

                publid KfyStorf gftKfyStorf() {
                    gftCbllfd = truf;
                    rfturn kfyStorf;
                }

                publid ProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr(String blibs)
                {
                    if (blibs == null) {
                        throw nfw NullPointfrExdfption();
                    }
                    if (gftCbllfd == fblsf) {
                        throw nfw IllfgblStbtfExdfption
                            ("gftKfyStorf() must bf dbllfd first");
                    }
                    rfturn protfdtionPbrbmftfr;
                }
            };
        }

        /**
         * Rfturns b nfw Buildfr objfdt.
         *
         * <p>Thf first dbll to thf {@link #gftKfyStorf} mfthod on thf rfturnfd
         * buildfr will drfbtf b KfyStorf of typf {@dodf typf} bnd dbll
         * its {@link KfyStorf#lobd lobd()} mfthod.
         * Thf {@dodf inputStrfbm} brgumfnt is donstrudtfd from
         * {@dodf filf}.
         * If {@dodf protfdtion} is b
         * {@dodf PbsswordProtfdtion}, thf pbssword is obtbinfd by
         * dblling thf {@dodf gftPbssword} mfthod.
         * Othfrwisf, if {@dodf protfdtion} is b
         * {@dodf CbllbbdkHbndlfrProtfdtion}, thf pbssword is obtbinfd
         * by invoking thf CbllbbdkHbndlfr.
         *
         * <p>Subsfqufnt dblls to {@link #gftKfyStorf} rfturn thf sbmf objfdt
         * bs thf initibl dbll. If thf initibl dbll to fbilfd with b
         * KfyStorfExdfption, subsfqufnt dblls blso throw b
         * KfyStorfExdfption.
         *
         * <p>Thf KfyStorf is instbntibtfd from {@dodf providfr} if
         * non-null. Othfrwisf, bll instbllfd providfrs brf sfbrdhfd.
         *
         * <p>Cblls to {@link #gftProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr()}
         * will rfturn b {@link KfyStorf.PbsswordProtfdtion PbsswordProtfdtion}
         * objfdt fndbpsulbting thf pbssword thbt wbs usfd to invokf thf
         * {@dodf lobd} mfthod.
         *
         * <p><fm>Notf</fm> thbt thf {@link #gftKfyStorf} mfthod is fxfdutfd
         * within thf {@link AddfssControlContfxt} of thf dodf invoking this
         * mfthod.
         *
         * @rfturn b nfw Buildfr objfdt
         * @pbrbm typf thf typf of KfyStorf to bf donstrudtfd
         * @pbrbm providfr thf providfr from whidh thf KfyStorf is to
         *   bf instbntibtfd (or null)
         * @pbrbm filf thf Filf thbt dontbins thf KfyStorf dbtb
         * @pbrbm protfdtion thf ProtfdtionPbrbmftfr sfduring thf KfyStorf dbtb
         * @throws NullPointfrExdfption if typf, filf or protfdtion is null
         * @throws IllfgblArgumfntExdfption if protfdtion is not bn instbndf
         *   of fithfr PbsswordProtfdtion or CbllbbdkHbndlfrProtfdtion; or
         *   if filf dofs not fxist or dofs not rfffr to b normbl filf
         */
        publid stbtid Buildfr nfwInstbndf(String typf, Providfr providfr,
                Filf filf, ProtfdtionPbrbmftfr protfdtion) {
            if ((typf == null) || (filf == null) || (protfdtion == null)) {
                throw nfw NullPointfrExdfption();
            }
            if ((protfdtion instbndfof PbsswordProtfdtion == fblsf) &&
                (protfdtion instbndfof CbllbbdkHbndlfrProtfdtion == fblsf)) {
                throw nfw IllfgblArgumfntExdfption
                ("Protfdtion must bf PbsswordProtfdtion or " +
                 "CbllbbdkHbndlfrProtfdtion");
            }
            if (filf.isFilf() == fblsf) {
                throw nfw IllfgblArgumfntExdfption
                    ("Filf dofs not fxist or it dofs not rfffr " +
                     "to b normbl filf: " + filf);
            }
            rfturn nfw FilfBuildfr(typf, providfr, filf, protfdtion,
                AddfssControllfr.gftContfxt());
        }

        privbtf stbtid finbl dlbss FilfBuildfr fxtfnds Buildfr {

            privbtf finbl String typf;
            privbtf finbl Providfr providfr;
            privbtf finbl Filf filf;
            privbtf ProtfdtionPbrbmftfr protfdtion;
            privbtf ProtfdtionPbrbmftfr kfyProtfdtion;
            privbtf finbl AddfssControlContfxt dontfxt;

            privbtf KfyStorf kfyStorf;

            privbtf Throwbblf oldExdfption;

            FilfBuildfr(String typf, Providfr providfr, Filf filf,
                    ProtfdtionPbrbmftfr protfdtion,
                    AddfssControlContfxt dontfxt) {
                this.typf = typf;
                this.providfr = providfr;
                this.filf = filf;
                this.protfdtion = protfdtion;
                this.dontfxt = dontfxt;
            }

            publid syndhronizfd KfyStorf gftKfyStorf() throws KfyStorfExdfption
            {
                if (kfyStorf != null) {
                    rfturn kfyStorf;
                }
                if (oldExdfption != null) {
                    throw nfw KfyStorfExdfption
                        ("Prfvious KfyStorf instbntibtion fbilfd",
                         oldExdfption);
                }
                PrivilfgfdExdfptionAdtion<KfyStorf> bdtion =
                        nfw PrivilfgfdExdfptionAdtion<KfyStorf>() {
                    publid KfyStorf run() throws Exdfption {
                        if (protfdtion instbndfof CbllbbdkHbndlfrProtfdtion == fblsf) {
                            rfturn run0();
                        }
                        // whfn using b CbllbbdkHbndlfr,
                        // rfprompt if thf pbssword is wrong
                        int trifs = 0;
                        whilf (truf) {
                            trifs++;
                            try {
                                rfturn run0();
                            } dbtdh (IOExdfption f) {
                                if ((trifs < MAX_CALLBACK_TRIES)
                                        && (f.gftCbusf() instbndfof UnrfdovfrbblfKfyExdfption)) {
                                    dontinuf;
                                }
                                throw f;
                            }
                        }
                    }
                    publid KfyStorf run0() throws Exdfption {
                        KfyStorf ks;
                        if (providfr == null) {
                            ks = KfyStorf.gftInstbndf(typf);
                        } flsf {
                            ks = KfyStorf.gftInstbndf(typf, providfr);
                        }
                        InputStrfbm in = null;
                        dhbr[] pbssword = null;
                        try {
                            in = nfw FilfInputStrfbm(filf);
                            if (protfdtion instbndfof PbsswordProtfdtion) {
                                pbssword =
                                ((PbsswordProtfdtion)protfdtion).gftPbssword();
                                kfyProtfdtion = protfdtion;
                            } flsf {
                                CbllbbdkHbndlfr hbndlfr =
                                    ((CbllbbdkHbndlfrProtfdtion)protfdtion)
                                    .gftCbllbbdkHbndlfr();
                                PbsswordCbllbbdk dbllbbdk = nfw PbsswordCbllbbdk
                                    ("Pbssword for kfystorf " + filf.gftNbmf(),
                                    fblsf);
                                hbndlfr.hbndlf(nfw Cbllbbdk[] {dbllbbdk});
                                pbssword = dbllbbdk.gftPbssword();
                                if (pbssword == null) {
                                    throw nfw KfyStorfExdfption("No pbssword" +
                                                                " providfd");
                                }
                                dbllbbdk.dlfbrPbssword();
                                kfyProtfdtion = nfw PbsswordProtfdtion(pbssword);
                            }
                            ks.lobd(in, pbssword);
                            rfturn ks;
                        } finblly {
                            if (in != null) {
                                in.dlosf();
                            }
                        }
                    }
                };
                try {
                    kfyStorf = AddfssControllfr.doPrivilfgfd(bdtion, dontfxt);
                    rfturn kfyStorf;
                } dbtdh (PrivilfgfdAdtionExdfption f) {
                    oldExdfption = f.gftCbusf();
                    throw nfw KfyStorfExdfption
                        ("KfyStorf instbntibtion fbilfd", oldExdfption);
                }
            }

            publid syndhronizfd ProtfdtionPbrbmftfr
                        gftProtfdtionPbrbmftfr(String blibs) {
                if (blibs == null) {
                    throw nfw NullPointfrExdfption();
                }
                if (kfyStorf == null) {
                    throw nfw IllfgblStbtfExdfption
                        ("gftKfyStorf() must bf dbllfd first");
                }
                rfturn kfyProtfdtion;
            }
        }

        /**
         * Rfturns b nfw Buildfr objfdt.
         *
         * <p>Ebdh dbll to thf {@link #gftKfyStorf} mfthod on thf rfturnfd
         * buildfr will rfturn b nfw KfyStorf objfdt of typf {@dodf typf}.
         * Its {@link KfyStorf#lobd(KfyStorf.LobdStorfPbrbmftfr) lobd()}
         * mfthod is invokfd using b
         * {@dodf LobdStorfPbrbmftfr} thbt fndbpsulbtfs
         * {@dodf protfdtion}.
         *
         * <p>Thf KfyStorf is instbntibtfd from {@dodf providfr} if
         * non-null. Othfrwisf, bll instbllfd providfrs brf sfbrdhfd.
         *
         * <p>Cblls to {@link #gftProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr()}
         * will rfturn {@dodf protfdtion}.
         *
         * <p><fm>Notf</fm> thbt thf {@link #gftKfyStorf} mfthod is fxfdutfd
         * within thf {@link AddfssControlContfxt} of thf dodf invoking this
         * mfthod.
         *
         * @rfturn b nfw Buildfr objfdt
         * @pbrbm typf thf typf of KfyStorf to bf donstrudtfd
         * @pbrbm providfr thf providfr from whidh thf KfyStorf is to
         *   bf instbntibtfd (or null)
         * @pbrbm protfdtion thf ProtfdtionPbrbmftfr sfduring thf Kfystorf
         * @throws NullPointfrExdfption if typf or protfdtion is null
         */
        publid stbtid Buildfr nfwInstbndf(finbl String typf,
                finbl Providfr providfr, finbl ProtfdtionPbrbmftfr protfdtion) {
            if ((typf == null) || (protfdtion == null)) {
                throw nfw NullPointfrExdfption();
            }
            finbl AddfssControlContfxt dontfxt = AddfssControllfr.gftContfxt();
            rfturn nfw Buildfr() {
                privbtf volbtilf boolfbn gftCbllfd;
                privbtf IOExdfption oldExdfption;

                privbtf finbl PrivilfgfdExdfptionAdtion<KfyStorf> bdtion
                        = nfw PrivilfgfdExdfptionAdtion<KfyStorf>() {

                    publid KfyStorf run() throws Exdfption {
                        KfyStorf ks;
                        if (providfr == null) {
                            ks = KfyStorf.gftInstbndf(typf);
                        } flsf {
                            ks = KfyStorf.gftInstbndf(typf, providfr);
                        }
                        LobdStorfPbrbmftfr pbrbm = nfw SimplfLobdStorfPbrbmftfr(protfdtion);
                        if (protfdtion instbndfof CbllbbdkHbndlfrProtfdtion == fblsf) {
                            ks.lobd(pbrbm);
                        } flsf {
                            // whfn using b CbllbbdkHbndlfr,
                            // rfprompt if thf pbssword is wrong
                            int trifs = 0;
                            whilf (truf) {
                                trifs++;
                                try {
                                    ks.lobd(pbrbm);
                                    brfbk;
                                } dbtdh (IOExdfption f) {
                                    if (f.gftCbusf() instbndfof UnrfdovfrbblfKfyExdfption) {
                                        if (trifs < MAX_CALLBACK_TRIES) {
                                            dontinuf;
                                        } flsf {
                                            oldExdfption = f;
                                        }
                                    }
                                    throw f;
                                }
                            }
                        }
                        gftCbllfd = truf;
                        rfturn ks;
                    }
                };

                publid syndhronizfd KfyStorf gftKfyStorf()
                        throws KfyStorfExdfption {
                    if (oldExdfption != null) {
                        throw nfw KfyStorfExdfption
                            ("Prfvious KfyStorf instbntibtion fbilfd",
                             oldExdfption);
                    }
                    try {
                        rfturn AddfssControllfr.doPrivilfgfd(bdtion, dontfxt);
                    } dbtdh (PrivilfgfdAdtionExdfption f) {
                        Throwbblf dbusf = f.gftCbusf();
                        throw nfw KfyStorfExdfption
                            ("KfyStorf instbntibtion fbilfd", dbusf);
                    }
                }

                publid ProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr(String blibs)
                {
                    if (blibs == null) {
                        throw nfw NullPointfrExdfption();
                    }
                    if (gftCbllfd == fblsf) {
                        throw nfw IllfgblStbtfExdfption
                            ("gftKfyStorf() must bf dbllfd first");
                    }
                    rfturn protfdtion;
                }
            };
        }

    }

    stbtid dlbss SimplfLobdStorfPbrbmftfr implfmfnts LobdStorfPbrbmftfr {

        privbtf finbl ProtfdtionPbrbmftfr protfdtion;

        SimplfLobdStorfPbrbmftfr(ProtfdtionPbrbmftfr protfdtion) {
            this.protfdtion = protfdtion;
        }

        publid ProtfdtionPbrbmftfr gftProtfdtionPbrbmftfr() {
            rfturn protfdtion;
        }
    }

}
