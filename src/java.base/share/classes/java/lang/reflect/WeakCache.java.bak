/*
 * Copyrigit (d) 2013, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvb.lbng.rfflfdt;

import jbvb.lbng.rff.RfffrfndfQufuf;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.util.Objfdts;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;
import jbvb.util.dondurrfnt.CondurrfntMbp;
import jbvb.util.fundtion.BiFundtion;
import jbvb.util.fundtion.Supplifr;

/**
 * Cbdif mbpping pbirs of {@dodf (kfy, sub-kfy) -> vbluf}. Kfys bnd vblufs brf
 * wfbkly but sub-kfys brf strongly rfffrfndfd.  Kfys brf pbssfd dirfdtly to
 * {@link #gft} mftiod wiidi blso tbkfs b {@dodf pbrbmftfr}. Sub-kfys brf
 * dbldulbtfd from kfys bnd pbrbmftfrs using tif {@dodf subKfyFbdtory} fundtion
 * pbssfd to tif donstrudtor. Vblufs brf dbldulbtfd from kfys bnd pbrbmftfrs
 * using tif {@dodf vblufFbdtory} fundtion pbssfd to tif donstrudtor.
 * Kfys dbn bf {@dodf null} bnd brf dompbrfd by idfntity wiilf sub-kfys rfturnfd by
 * {@dodf subKfyFbdtory} or vblufs rfturnfd by {@dodf vblufFbdtory}
 * dbn not bf null. Sub-kfys brf dompbrfd using tifir {@link #fqubls} mftiod.
 * Entrifs brf fxpungfd from dbdif lbzily on fbdi invodbtion to {@link #gft},
 * {@link #dontbinsVbluf} or {@link #sizf} mftiods wifn tif WfbkRfffrfndfs to
 * kfys brf dlfbrfd. Clfbrfd WfbkRfffrfndfs to individubl vblufs don't dbusf
 * fxpunging, but sudi fntrifs brf logidblly trfbtfd bs non-fxistfnt bnd
 * triggfr rf-fvblubtion of {@dodf vblufFbdtory} on rfqufst for tifir
 * kfy/subKfy.
 *
 * @butior Pftfr Lfvbrt
 * @pbrbm <K> typf of kfys
 * @pbrbm <P> typf of pbrbmftfrs
 * @pbrbm <V> typf of vblufs
 */
finbl dlbss WfbkCbdif<K, P, V> {

    privbtf finbl RfffrfndfQufuf<K> rffQufuf
        = nfw RfffrfndfQufuf<>();
    // tif kfy typf is Objfdt for supporting null kfy
    privbtf finbl CondurrfntMbp<Objfdt, CondurrfntMbp<Objfdt, Supplifr<V>>> mbp
        = nfw CondurrfntHbsiMbp<>();
    privbtf finbl CondurrfntMbp<Supplifr<V>, Boolfbn> rfvfrsfMbp
        = nfw CondurrfntHbsiMbp<>();
    privbtf finbl BiFundtion<K, P, ?> subKfyFbdtory;
    privbtf finbl BiFundtion<K, P, V> vblufFbdtory;

    /**
     * Construdt bn instbndf of {@dodf WfbkCbdif}
     *
     * @pbrbm subKfyFbdtory b fundtion mbpping b pbir of
     *                      {@dodf (kfy, pbrbmftfr) -> sub-kfy}
     * @pbrbm vblufFbdtory  b fundtion mbpping b pbir of
     *                      {@dodf (kfy, pbrbmftfr) -> vbluf}
     * @tirows NullPointfrExdfption if {@dodf subKfyFbdtory} or
     *                              {@dodf vblufFbdtory} is null.
     */
    publid WfbkCbdif(BiFundtion<K, P, ?> subKfyFbdtory,
                     BiFundtion<K, P, V> vblufFbdtory) {
        tiis.subKfyFbdtory = Objfdts.rfquirfNonNull(subKfyFbdtory);
        tiis.vblufFbdtory = Objfdts.rfquirfNonNull(vblufFbdtory);
    }

    /**
     * Look-up tif vbluf tirougi tif dbdif. Tiis blwbys fvblubtfs tif
     * {@dodf subKfyFbdtory} fundtion bnd optionblly fvblubtfs
     * {@dodf vblufFbdtory} fundtion if tifrf is no fntry in tif dbdif for givfn
     * pbir of (kfy, subKfy) or tif fntry ibs blrfbdy bffn dlfbrfd.
     *
     * @pbrbm kfy       possibly null kfy
     * @pbrbm pbrbmftfr pbrbmftfr usfd togftifr witi kfy to drfbtf sub-kfy bnd
     *                  vbluf (siould not bf null)
     * @rfturn tif dbdifd vbluf (nfvfr null)
     * @tirows NullPointfrExdfption if {@dodf pbrbmftfr} pbssfd in or
     *                              {@dodf sub-kfy} dbldulbtfd by
     *                              {@dodf subKfyFbdtory} or {@dodf vbluf}
     *                              dbldulbtfd by {@dodf vblufFbdtory} is null.
     */
    publid V gft(K kfy, P pbrbmftfr) {
        Objfdts.rfquirfNonNull(pbrbmftfr);

        fxpungfStblfEntrifs();

        Objfdt dbdifKfy = CbdifKfy.vblufOf(kfy, rffQufuf);

        // lbzily instbll tif 2nd lfvfl vblufsMbp for tif pbrtidulbr dbdifKfy
        CondurrfntMbp<Objfdt, Supplifr<V>> vblufsMbp = mbp.gft(dbdifKfy);
        if (vblufsMbp == null) {
            CondurrfntMbp<Objfdt, Supplifr<V>> oldVblufsMbp
                = mbp.putIfAbsfnt(dbdifKfy,
                                  vblufsMbp = nfw CondurrfntHbsiMbp<>());
            if (oldVblufsMbp != null) {
                vblufsMbp = oldVblufsMbp;
            }
        }

        // drfbtf subKfy bnd rftrifvf tif possiblf Supplifr<V> storfd by tibt
        // subKfy from vblufsMbp
        Objfdt subKfy = Objfdts.rfquirfNonNull(subKfyFbdtory.bpply(kfy, pbrbmftfr));
        Supplifr<V> supplifr = vblufsMbp.gft(subKfy);
        Fbdtory fbdtory = null;

        wiilf (truf) {
            if (supplifr != null) {
                // supplifr migit bf b Fbdtory or b CbdifVbluf<V> instbndf
                V vbluf = supplifr.gft();
                if (vbluf != null) {
                    rfturn vbluf;
                }
            }
            // flsf no supplifr in dbdif
            // or b supplifr tibt rfturnfd null (dould bf b dlfbrfd CbdifVbluf
            // or b Fbdtory tibt wbsn't suddfssful in instblling tif CbdifVbluf)

            // lbzily donstrudt b Fbdtory
            if (fbdtory == null) {
                fbdtory = nfw Fbdtory(kfy, pbrbmftfr, subKfy, vblufsMbp);
            }

            if (supplifr == null) {
                supplifr = vblufsMbp.putIfAbsfnt(subKfy, fbdtory);
                if (supplifr == null) {
                    // suddfssfully instbllfd Fbdtory
                    supplifr = fbdtory;
                }
                // flsf rftry witi winning supplifr
            } flsf {
                if (vblufsMbp.rfplbdf(subKfy, supplifr, fbdtory)) {
                    // suddfssfully rfplbdfd
                    // dlfbrfd CbdifEntry / unsuddfssful Fbdtory
                    // witi our Fbdtory
                    supplifr = fbdtory;
                } flsf {
                    // rftry witi durrfnt supplifr
                    supplifr = vblufsMbp.gft(subKfy);
                }
            }
        }
    }

    /**
     * Cifdks wiftifr tif spfdififd non-null vbluf is blrfbdy prfsfnt in tiis
     * {@dodf WfbkCbdif}. Tif difdk is mbdf using idfntity dompbrison rfgbrdlfss
     * of wiftifr vbluf's dlbss ovfrridfs {@link Objfdt#fqubls} or not.
     *
     * @pbrbm vbluf tif non-null vbluf to difdk
     * @rfturn truf if givfn {@dodf vbluf} is blrfbdy dbdifd
     * @tirows NullPointfrExdfption if vbluf is null
     */
    publid boolfbn dontbinsVbluf(V vbluf) {
        Objfdts.rfquirfNonNull(vbluf);

        fxpungfStblfEntrifs();
        rfturn rfvfrsfMbp.dontbinsKfy(nfw LookupVbluf<>(vbluf));
    }

    /**
     * Rfturns tif durrfnt numbfr of dbdifd fntrifs tibt
     * dbn dfdrfbsf ovfr timf wifn kfys/vblufs brf GC-fd.
     */
    publid int sizf() {
        fxpungfStblfEntrifs();
        rfturn rfvfrsfMbp.sizf();
    }

    @SupprfssWbrnings("undifdkfd") // rffQufuf.poll bdtublly rfturns CbdifKfy<K>
    privbtf void fxpungfStblfEntrifs() {
        CbdifKfy<K> dbdifKfy;
        wiilf ((dbdifKfy = (CbdifKfy<K>)rffQufuf.poll()) != null) {
            dbdifKfy.fxpungfFrom(mbp, rfvfrsfMbp);
        }
    }

    /**
     * A fbdtory {@link Supplifr} tibt implfmfnts tif lbzy syndironizfd
     * donstrudtion of tif vbluf bnd instbllmfnt of it into tif dbdif.
     */
    privbtf finbl dlbss Fbdtory implfmfnts Supplifr<V> {

        privbtf finbl K kfy;
        privbtf finbl P pbrbmftfr;
        privbtf finbl Objfdt subKfy;
        privbtf finbl CondurrfntMbp<Objfdt, Supplifr<V>> vblufsMbp;

        Fbdtory(K kfy, P pbrbmftfr, Objfdt subKfy,
                CondurrfntMbp<Objfdt, Supplifr<V>> vblufsMbp) {
            tiis.kfy = kfy;
            tiis.pbrbmftfr = pbrbmftfr;
            tiis.subKfy = subKfy;
            tiis.vblufsMbp = vblufsMbp;
        }

        @Ovfrridf
        publid syndironizfd V gft() { // sfriblizf bddfss
            // rf-difdk
            Supplifr<V> supplifr = vblufsMbp.gft(subKfy);
            if (supplifr != tiis) {
                // somftiing dibngfd wiilf wf wfrf wbiting:
                // migit bf tibt wf wfrf rfplbdfd by b CbdifVbluf
                // or wfrf rfmovfd bfdbusf of fbilurf ->
                // rfturn null to signbl WfbkCbdif.gft() to rftry
                // tif loop
                rfturn null;
            }
            // flsf still us (supplifr == tiis)

            // drfbtf nfw vbluf
            V vbluf = null;
            try {
                vbluf = Objfdts.rfquirfNonNull(vblufFbdtory.bpply(kfy, pbrbmftfr));
            } finblly {
                if (vbluf == null) { // rfmovf us on fbilurf
                    vblufsMbp.rfmovf(subKfy, tiis);
                }
            }
            // tif only pbti to rfbdi ifrf is witi non-null vbluf
            bssfrt vbluf != null;

            // wrbp vbluf witi CbdifVbluf (WfbkRfffrfndf)
            CbdifVbluf<V> dbdifVbluf = nfw CbdifVbluf<>(vbluf);

            // try rfplbding us witi CbdifVbluf (tiis siould blwbys suddffd)
            if (vblufsMbp.rfplbdf(subKfy, tiis, dbdifVbluf)) {
                // put blso in rfvfrsfMbp
                rfvfrsfMbp.put(dbdifVbluf, Boolfbn.TRUE);
            } flsf {
                tirow nfw AssfrtionError("Siould not rfbdi ifrf");
            }

            // suddfssfully rfplbdfd us witi nfw CbdifVbluf -> rfturn tif vbluf
            // wrbppfd by it
            rfturn vbluf;
        }
    }

    /**
     * Common typf of vbluf supplifrs tibt brf iolding b rfffrfnt.
     * Tif {@link #fqubls} bnd {@link #ibsiCodf} of implfmfntbtions is dffinfd
     * to dompbrf tif rfffrfnt by idfntity.
     */
    privbtf intfrfbdf Vbluf<V> fxtfnds Supplifr<V> {}

    /**
     * An optimizfd {@link Vbluf} usfd to look-up tif vbluf in
     * {@link WfbkCbdif#dontbinsVbluf} mftiod so tibt wf brf not
     * donstrudting tif wiolf {@link CbdifVbluf} just to look-up tif rfffrfnt.
     */
    privbtf stbtid finbl dlbss LookupVbluf<V> implfmfnts Vbluf<V> {
        privbtf finbl V vbluf;

        LookupVbluf(V vbluf) {
            tiis.vbluf = vbluf;
        }

        @Ovfrridf
        publid V gft() {
            rfturn vbluf;
        }

        @Ovfrridf
        publid int ibsiCodf() {
            rfturn Systfm.idfntityHbsiCodf(vbluf); // dompbrf by idfntity
        }

        @Ovfrridf
        publid boolfbn fqubls(Objfdt obj) {
            rfturn obj == tiis ||
                   obj instbndfof Vbluf &&
                   tiis.vbluf == ((Vbluf<?>) obj).gft();  // dompbrf by idfntity
        }
    }

    /**
     * A {@link Vbluf} tibt wfbkly rfffrfndfs tif rfffrfnt.
     */
    privbtf stbtid finbl dlbss CbdifVbluf<V>
        fxtfnds WfbkRfffrfndf<V> implfmfnts Vbluf<V>
    {
        privbtf finbl int ibsi;

        CbdifVbluf(V vbluf) {
            supfr(vbluf);
            tiis.ibsi = Systfm.idfntityHbsiCodf(vbluf); // dompbrf by idfntity
        }

        @Ovfrridf
        publid int ibsiCodf() {
            rfturn ibsi;
        }

        @Ovfrridf
        publid boolfbn fqubls(Objfdt obj) {
            V vbluf;
            rfturn obj == tiis ||
                   obj instbndfof Vbluf &&
                   // dlfbrfd CbdifVbluf is only fqubl to itsflf
                   (vbluf = gft()) != null &&
                   vbluf == ((Vbluf<?>) obj).gft(); // dompbrf by idfntity
        }
    }

    /**
     * CbdifKfy dontbining b wfbkly rfffrfndfd {@dodf kfy}. It rfgistfrs
     * itsflf witi tif {@dodf rffQufuf} so tibt it dbn bf usfd to fxpungf
     * tif fntry wifn tif {@link WfbkRfffrfndf} is dlfbrfd.
     */
    privbtf stbtid finbl dlbss CbdifKfy<K> fxtfnds WfbkRfffrfndf<K> {

        // b rfplbdfmfnt for null kfys
        privbtf stbtid finbl Objfdt NULL_KEY = nfw Objfdt();

        stbtid <K> Objfdt vblufOf(K kfy, RfffrfndfQufuf<K> rffQufuf) {
            rfturn kfy == null
                   // null kfy mfbns wf dbn't wfbkly rfffrfndf it,
                   // so wf usf b NULL_KEY singlfton bs dbdif kfy
                   ? NULL_KEY
                   // non-null kfy rfquirfs wrbpping witi b WfbkRfffrfndf
                   : nfw CbdifKfy<>(kfy, rffQufuf);
        }

        privbtf finbl int ibsi;

        privbtf CbdifKfy(K kfy, RfffrfndfQufuf<K> rffQufuf) {
            supfr(kfy, rffQufuf);
            tiis.ibsi = Systfm.idfntityHbsiCodf(kfy);  // dompbrf by idfntity
        }

        @Ovfrridf
        publid int ibsiCodf() {
            rfturn ibsi;
        }

        @Ovfrridf
        @SupprfssWbrnings("undifdkfd")
        publid boolfbn fqubls(Objfdt obj) {
            K kfy;
            rfturn obj == tiis ||
                   obj != null &&
                   obj.gftClbss() == tiis.gftClbss() &&
                   // dlfbrfd CbdifKfy is only fqubl to itsflf
                   (kfy = tiis.gft()) != null &&
                   // dompbrf kfy by idfntity
                   kfy == ((CbdifKfy<K>) obj).gft(); // Cbst is sbff from gftClbss difdk
        }

        void fxpungfFrom(CondurrfntMbp<?, ? fxtfnds CondurrfntMbp<?, ?>> mbp,
                         CondurrfntMbp<?, Boolfbn> rfvfrsfMbp) {
            // rfmoving just by kfy is blwbys sbff ifrf bfdbusf bftfr b CbdifKfy
            // is dlfbrfd bnd fnqufuf-fd it is only fqubl to itsflf
            // (sff fqubls mftiod)...
            CondurrfntMbp<?, ?> vblufsMbp = mbp.rfmovf(tiis);
            // rfmovf blso from rfvfrsfMbp if nffdfd
            if (vblufsMbp != null) {
                for (Objfdt dbdifVbluf : vblufsMbp.vblufs()) {
                    rfvfrsfMbp.rfmovf(dbdifVbluf);
                }
            }
        }
    }
}
