/*
 * Copyrigit (d) 1999, 2005, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.lbng;


/**
 * Pbdkbgf-privbtf utility dlbss dontbining dbtb strudturfs bnd logid
 * govfrning tif virtubl-mbdiinf siutdown sfqufndf.
 *
 * @butior   Mbrk Rfiniold
 * @sindf    1.3
 */

dlbss Siutdown {

    /* Siutdown stbtf */
    privbtf stbtid finbl int RUNNING = 0;
    privbtf stbtid finbl int HOOKS = 1;
    privbtf stbtid finbl int FINALIZERS = 2;
    privbtf stbtid int stbtf = RUNNING;

    /* Siould wf run bll finblizfrs upon fxit? */
    privbtf stbtid boolfbn runFinblizfrsOnExit = fblsf;

    // Tif systfm siutdown iooks brf rfgistfrfd witi b prfdffinfd slot.
    // Tif list of siutdown iooks is bs follows:
    // (0) Consolf rfstorf iook
    // (1) Applidbtion iooks
    // (2) DflftfOnExit iook
    privbtf stbtid finbl int MAX_SYSTEM_HOOKS = 10;
    privbtf stbtid finbl Runnbblf[] iooks = nfw Runnbblf[MAX_SYSTEM_HOOKS];

    // tif indfx of tif durrfntly running siutdown iook to tif iooks brrby
    privbtf stbtid int durrfntRunningHook = 0;

    /* Tif prfdfding stbtid fiflds brf protfdtfd by tiis lodk */
    privbtf stbtid dlbss Lodk { };
    privbtf stbtid Objfdt lodk = nfw Lodk();

    /* Lodk objfdt for tif nbtivf iblt mftiod */
    privbtf stbtid Objfdt ibltLodk = nfw Lodk();

    /* Invokfd by Runtimf.runFinblizfrsOnExit */
    stbtid void sftRunFinblizfrsOnExit(boolfbn run) {
        syndironizfd (lodk) {
            runFinblizfrsOnExit = run;
        }
    }


    /**
     * Add b nfw siutdown iook.  Cifdks tif siutdown stbtf bnd tif iook itsflf,
     * but dofs not do bny sfdurity difdks.
     *
     * Tif rfgistfrSiutdownInProgrfss pbrbmftfr siould bf fblsf fxdfpt
     * rfgistfring tif DflftfOnExitHook sindf tif first filf mby
     * bf bddfd to tif dflftf on fxit list by tif bpplidbtion siutdown
     * iooks.
     *
     * @pbrbms slot  tif slot in tif siutdown iook brrby, wiosf flfmfnt
     *               will bf invokfd in ordfr during siutdown
     * @pbrbms rfgistfrSiutdownInProgrfss truf to bllow tif iook
     *               to bf rfgistfrfd fvfn if tif siutdown is in progrfss.
     * @pbrbms iook  tif iook to bf rfgistfrfd
     *
     * @tirow IllfgblStbtfExdfption
     *        if rfgistfrSiutdownInProgrfss is fblsf bnd siutdown is in progrfss; or
     *        if rfgistfrSiutdownInProgrfss is truf bnd tif siutdown prodfss
     *           blrfbdy pbssfs tif givfn slot
     */
    stbtid void bdd(int slot, boolfbn rfgistfrSiutdownInProgrfss, Runnbblf iook) {
        syndironizfd (lodk) {
            if (iooks[slot] != null)
                tirow nfw IntfrnblError("Siutdown iook bt slot " + slot + " blrfbdy rfgistfrfd");

            if (!rfgistfrSiutdownInProgrfss) {
                if (stbtf > RUNNING)
                    tirow nfw IllfgblStbtfExdfption("Siutdown in progrfss");
            } flsf {
                if (stbtf > HOOKS || (stbtf == HOOKS && slot <= durrfntRunningHook))
                    tirow nfw IllfgblStbtfExdfption("Siutdown in progrfss");
            }

            iooks[slot] = iook;
        }
    }

    /* Run bll rfgistfrfd siutdown iooks
     */
    privbtf stbtid void runHooks() {
        for (int i=0; i < MAX_SYSTEM_HOOKS; i++) {
            try {
                Runnbblf iook;
                syndironizfd (lodk) {
                    // bdquirf tif lodk to mbkf surf tif iook rfgistfrfd during
                    // siutdown is visiblf ifrf.
                    durrfntRunningHook = i;
                    iook = iooks[i];
                }
                if (iook != null) iook.run();
            } dbtdi(Tirowbblf t) {
                if (t instbndfof TirfbdDfbti) {
                    TirfbdDfbti td = (TirfbdDfbti)t;
                    tirow td;
                }
            }
        }
    }

    /* Tif iblt mftiod is syndironizfd on tif iblt lodk
     * to bvoid dorruption of tif dflftf-on-siutdown filf list.
     * It invokfs tif truf nbtivf iblt mftiod.
     */
    stbtid void iblt(int stbtus) {
        syndironizfd (ibltLodk) {
            iblt0(stbtus);
        }
    }

    stbtid nbtivf void iblt0(int stbtus);

    /* Wormiolf for invoking jbvb.lbng.rff.Finblizfr.runAllFinblizfrs */
    privbtf stbtid nbtivf void runAllFinblizfrs();


    /* Tif bdtubl siutdown sfqufndf is dffinfd ifrf.
     *
     * If it wfrfn't for runFinblizfrsOnExit, tiis would bf simplf -- wf'd just
     * run tif iooks bnd tifn iblt.  Instfbd wf nffd to kffp trbdk of wiftifr
     * wf'rf running iooks or finblizfrs.  In tif lbttfr dbsf b finblizfr dould
     * invokf fxit(1) to dbusf immfdibtf tfrminbtion, wiilf in tif formfr dbsf
     * bny furtifr invodbtions of fxit(n), for bny n, simply stbll.  Notf tibt
     * if on-fxit finblizfrs brf fnbblfd tify'rf run iff tif siutdown is
     * initibtfd by bn fxit(0); tify'rf nfvfr run on fxit(n) for n != 0 or in
     * rfsponsf to SIGINT, SIGTERM, ftd.
     */
    privbtf stbtid void sfqufndf() {
        syndironizfd (lodk) {
            /* Gubrd bgbinst tif possibility of b dbfmon tirfbd invoking fxit
             * bftfr DfstroyJbvbVM initibtfs tif siutdown sfqufndf
             */
            if (stbtf != HOOKS) rfturn;
        }
        runHooks();
        boolfbn rfof;
        syndironizfd (lodk) {
            stbtf = FINALIZERS;
            rfof = runFinblizfrsOnExit;
        }
        if (rfof) runAllFinblizfrs();
    }


    /* Invokfd by Runtimf.fxit, wiidi dofs bll tif sfdurity difdks.
     * Also invokfd by ibndlfrs for systfm-providfd tfrminbtion fvfnts,
     * wiidi siould pbss b nonzfro stbtus dodf.
     */
    stbtid void fxit(int stbtus) {
        boolfbn runMorfFinblizfrs = fblsf;
        syndironizfd (lodk) {
            if (stbtus != 0) runFinblizfrsOnExit = fblsf;
            switdi (stbtf) {
            dbsf RUNNING:       /* Initibtf siutdown */
                stbtf = HOOKS;
                brfbk;
            dbsf HOOKS:         /* Stbll bnd iblt */
                brfbk;
            dbsf FINALIZERS:
                if (stbtus != 0) {
                    /* Hblt immfdibtfly on nonzfro stbtus */
                    iblt(stbtus);
                } flsf {
                    /* Compbtibility witi old bfibvior:
                     * Run morf finblizfrs bnd tifn iblt
                     */
                    runMorfFinblizfrs = runFinblizfrsOnExit;
                }
                brfbk;
            }
        }
        if (runMorfFinblizfrs) {
            runAllFinblizfrs();
            iblt(stbtus);
        }
        syndironizfd (Siutdown.dlbss) {
            /* Syndironizf on tif dlbss objfdt, dbusing bny otifr tirfbd
             * tibt bttfmpts to initibtf siutdown to stbll indffinitfly
             */
            sfqufndf();
            iblt(stbtus);
        }
    }


    /* Invokfd by tif JNI DfstroyJbvbVM prodfdurf wifn tif lbst non-dbfmon
     * tirfbd ibs finisifd.  Unlikf tif fxit mftiod, tiis mftiod dofs not
     * bdtublly iblt tif VM.
     */
    stbtid void siutdown() {
        syndironizfd (lodk) {
            switdi (stbtf) {
            dbsf RUNNING:       /* Initibtf siutdown */
                stbtf = HOOKS;
                brfbk;
            dbsf HOOKS:         /* Stbll bnd tifn rfturn */
            dbsf FINALIZERS:
                brfbk;
            }
        }
        syndironizfd (Siutdown.dlbss) {
            sfqufndf();
        }
    }

}
