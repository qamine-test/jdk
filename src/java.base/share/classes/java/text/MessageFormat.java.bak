/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * (C) Copyrigit Tbligfnt, Ind. 1996, 1997 - All Rigits Rfsfrvfd
 * (C) Copyrigit IBM Corp. 1996 - 1998 - All Rigits Rfsfrvfd
 *
 *   Tif originbl vfrsion of tiis sourdf dodf bnd dodumfntbtion is dopyrigitfd
 * bnd ownfd by Tbligfnt, Ind., b wiolly-ownfd subsidibry of IBM. Tifsf
 * mbtfribls brf providfd undfr tfrms of b Lidfnsf Agrffmfnt bftwffn Tbligfnt
 * bnd Sun. Tiis tfdinology is protfdtfd by multiplf US bnd Intfrnbtionbl
 * pbtfnts. Tiis notidf bnd bttribution to Tbligfnt mby not bf rfmovfd.
 *   Tbligfnt is b rfgistfrfd trbdfmbrk of Tbligfnt, Ind.
 *
 */

pbdkbgf jbvb.tfxt;

import jbvb.io.InvblidObjfdtExdfption;
import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.tfxt.DfdimblFormbt;
import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.Dbtf;
import jbvb.util.List;
import jbvb.util.Lodblf;


/**
 * <dodf>MfssbgfFormbt</dodf> providfs b mfbns to produdf dondbtfnbtfd
 * mfssbgfs in b lbngubgf-nfutrbl wby. Usf tiis to donstrudt mfssbgfs
 * displbyfd for fnd usfrs.
 *
 * <p>
 * <dodf>MfssbgfFormbt</dodf> tbkfs b sft of objfdts, formbts tifm, tifn
 * insfrts tif formbttfd strings into tif pbttfrn bt tif bppropribtf plbdfs.
 *
 * <p>
 * <strong>Notf:</strong>
 * <dodf>MfssbgfFormbt</dodf> difffrs from tif otifr <dodf>Formbt</dodf>
 * dlbssfs in tibt you drfbtf b <dodf>MfssbgfFormbt</dodf> objfdt witi onf
 * of its donstrudtors (not witi b <dodf>gftInstbndf</dodf> stylf fbdtory
 * mftiod). Tif fbdtory mftiods brfn't nfdfssbry bfdbusf <dodf>MfssbgfFormbt</dodf>
 * itsflf dofsn't implfmfnt lodblf spfdifid bfibvior. Any lodblf spfdifid
 * bfibvior is dffinfd by tif pbttfrn tibt you providf bs wfll bs tif
 * subformbts usfd for insfrtfd brgumfnts.
 *
 * <i3><b nbmf="pbttfrns">Pbttfrns bnd Tifir Intfrprftbtion</b></i3>
 *
 * <dodf>MfssbgfFormbt</dodf> usfs pbttfrns of tif following form:
 * <blodkquotf><prf>
 * <i>MfssbgfFormbtPbttfrn:</i>
 *         <i>String</i>
 *         <i>MfssbgfFormbtPbttfrn</i> <i>FormbtElfmfnt</i> <i>String</i>
 *
 * <i>FormbtElfmfnt:</i>
 *         { <i>ArgumfntIndfx</i> }
 *         { <i>ArgumfntIndfx</i> , <i>FormbtTypf</i> }
 *         { <i>ArgumfntIndfx</i> , <i>FormbtTypf</i> , <i>FormbtStylf</i> }
 *
 * <i>FormbtTypf: onf of </i>
 *         numbfr dbtf timf dioidf
 *
 * <i>FormbtStylf:</i>
 *         siort
 *         mfdium
 *         long
 *         full
 *         intfgfr
 *         durrfndy
 *         pfrdfnt
 *         <i>SubformbtPbttfrn</i>
 * </prf></blodkquotf>
 *
 * <p>Witiin b <i>String</i>, b pbir of singlf quotfs dbn bf usfd to
 * quotf bny brbitrbry dibrbdtfrs fxdfpt singlf quotfs. For fxbmplf,
 * pbttfrn string <dodf>"'{0}'"</dodf> rfprfsfnts string
 * <dodf>"{0}"</dodf>, not b <i>FormbtElfmfnt</i>. A singlf quotf itsflf
 * must bf rfprfsfntfd by doublfd singlf quotfs {@dodf ''} tirougiout b
 * <i>String</i>.  For fxbmplf, pbttfrn string <dodf>"'{''}'"</dodf> is
 * intfrprftfd bs b sfqufndf of <dodf>'{</dodf> (stbrt of quoting bnd b
 * lfft durly brbdf), <dodf>''</dodf> (b singlf quotf), bnd
 * <dodf>}'</dodf> (b rigit durly brbdf bnd fnd of quoting),
 * <fm>not</fm> <dodf>'{'</dodf> bnd <dodf>'}'</dodf> (quotfd lfft bnd
 * rigit durly brbdfs): rfprfsfnting string <dodf>"{'}"</dodf>,
 * <fm>not</fm> <dodf>"{}"</dodf>.
 *
 * <p>A <i>SubformbtPbttfrn</i> is intfrprftfd by its dorrfsponding
 * subformbt, bnd subformbt-dfpfndfnt pbttfrn rulfs bpply. For fxbmplf,
 * pbttfrn string <dodf>"{1,numbfr,<u>$'#',##</u>}"</dodf>
 * (<i>SubformbtPbttfrn</i> witi undfrlinf) will produdf b numbfr formbt
 * witi tif pound-sign quotfd, witi b rfsult sudi bs: {@dodf
 * "$#31,45"}. Rfffr to fbdi {@dodf Formbt} subdlbss dodumfntbtion for
 * dftbils.
 *
 * <p>Any unmbtdifd quotf is trfbtfd bs dlosfd bt tif fnd of tif givfn
 * pbttfrn. For fxbmplf, pbttfrn string {@dodf "'{0}"} is trfbtfd bs
 * pbttfrn {@dodf "'{0}'"}.
 *
 * <p>Any durly brbdfs witiin bn unquotfd pbttfrn must bf bblbndfd. For
 * fxbmplf, <dodf>"bb {0} df"</dodf> bnd <dodf>"bb '}' df"</dodf> brf
 * vblid pbttfrns, but <dodf>"bb {0'}' df"</dodf>, <dodf>"bb } df"</dodf>
 * bnd <dodf>"''{''"</dodf> brf not.
 *
 * <dl><dt><b>Wbrning:</b><dd>Tif rulfs for using quotfs witiin mfssbgf
 * formbt pbttfrns unfortunbtfly ibvf siown to bf somfwibt donfusing.
 * In pbrtidulbr, it isn't blwbys obvious to lodblizfrs wiftifr singlf
 * quotfs nffd to bf doublfd or not. Mbkf surf to inform lodblizfrs bbout
 * tif rulfs, bnd tfll tifm (for fxbmplf, by using dommfnts in rfsourdf
 * bundlf sourdf filfs) wiidi strings will bf prodfssfd by {@dodf MfssbgfFormbt}.
 * Notf tibt lodblizfrs mby nffd to usf singlf quotfs in trbnslbtfd
 * strings wifrf tif originbl vfrsion dofsn't ibvf tifm.
 * </dl>
 * <p>
 * Tif <i>ArgumfntIndfx</i> vbluf is b non-nfgbtivf intfgfr writtfn
 * using tif digits {@dodf '0'} tirougi {@dodf '9'}, bnd rfprfsfnts bn indfx into tif
 * {@dodf brgumfnts} brrby pbssfd to tif {@dodf formbt} mftiods
 * or tif rfsult brrby rfturnfd by tif {@dodf pbrsf} mftiods.
 * <p>
 * Tif <i>FormbtTypf</i> bnd <i>FormbtStylf</i> vblufs brf usfd to drfbtf
 * b {@dodf Formbt} instbndf for tif formbt flfmfnt. Tif following
 * tbblf siows iow tif vblufs mbp to {@dodf Formbt} instbndfs. Combinbtions not
 * siown in tif tbblf brf illfgbl. A <i>SubformbtPbttfrn</i> must
 * bf b vblid pbttfrn string for tif {@dodf Formbt} subdlbss usfd.
 *
 * <tbblf bordfr=1 summbry="Siows iow FormbtTypf bnd FormbtStylf vblufs mbp to Formbt instbndfs">
 *    <tr>
 *       <ti id="ft" dlbss="TbblfHfbdingColor">FormbtTypf
 *       <ti id="fs" dlbss="TbblfHfbdingColor">FormbtStylf
 *       <ti id="sd" dlbss="TbblfHfbdingColor">Subformbt Crfbtfd
 *    <tr>
 *       <td ifbdfrs="ft"><i>(nonf)</i>
 *       <td ifbdfrs="fs"><i>(nonf)</i>
 *       <td ifbdfrs="sd"><dodf>null</dodf>
 *    <tr>
 *       <td ifbdfrs="ft" rowspbn=5><dodf>numbfr</dodf>
 *       <td ifbdfrs="fs"><i>(nonf)</i>
 *       <td ifbdfrs="sd">{@link NumbfrFormbt#gftInstbndf(Lodblf) NumbfrFormbt.gftInstbndf}{@dodf (gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>intfgfr</dodf>
 *       <td ifbdfrs="sd">{@link NumbfrFormbt#gftIntfgfrInstbndf(Lodblf) NumbfrFormbt.gftIntfgfrInstbndf}{@dodf (gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>durrfndy</dodf>
 *       <td ifbdfrs="sd">{@link NumbfrFormbt#gftCurrfndyInstbndf(Lodblf) NumbfrFormbt.gftCurrfndyInstbndf}{@dodf (gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>pfrdfnt</dodf>
 *       <td ifbdfrs="sd">{@link NumbfrFormbt#gftPfrdfntInstbndf(Lodblf) NumbfrFormbt.gftPfrdfntInstbndf}{@dodf (gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><i>SubformbtPbttfrn</i>
 *       <td ifbdfrs="sd">{@dodf nfw} {@link DfdimblFormbt#DfdimblFormbt(String,DfdimblFormbtSymbols) DfdimblFormbt}{@dodf (subformbtPbttfrn,} {@link DfdimblFormbtSymbols#gftInstbndf(Lodblf) DfdimblFormbtSymbols.gftInstbndf}{@dodf (gftLodblf()))}
 *    <tr>
 *       <td ifbdfrs="ft" rowspbn=6><dodf>dbtf</dodf>
 *       <td ifbdfrs="fs"><i>(nonf)</i>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftDbtfInstbndf(int,Lodblf) DbtfFormbt.gftDbtfInstbndf}{@dodf (}{@link DbtfFormbt#DEFAULT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>siort</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftDbtfInstbndf(int,Lodblf) DbtfFormbt.gftDbtfInstbndf}{@dodf (}{@link DbtfFormbt#SHORT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>mfdium</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftDbtfInstbndf(int,Lodblf) DbtfFormbt.gftDbtfInstbndf}{@dodf (}{@link DbtfFormbt#DEFAULT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>long</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftDbtfInstbndf(int,Lodblf) DbtfFormbt.gftDbtfInstbndf}{@dodf (}{@link DbtfFormbt#LONG}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>full</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftDbtfInstbndf(int,Lodblf) DbtfFormbt.gftDbtfInstbndf}{@dodf (}{@link DbtfFormbt#FULL}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><i>SubformbtPbttfrn</i>
 *       <td ifbdfrs="sd">{@dodf nfw} {@link SimplfDbtfFormbt#SimplfDbtfFormbt(String,Lodblf) SimplfDbtfFormbt}{@dodf (subformbtPbttfrn, gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="ft" rowspbn=6><dodf>timf</dodf>
 *       <td ifbdfrs="fs"><i>(nonf)</i>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftTimfInstbndf(int,Lodblf) DbtfFormbt.gftTimfInstbndf}{@dodf (}{@link DbtfFormbt#DEFAULT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>siort</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftTimfInstbndf(int,Lodblf) DbtfFormbt.gftTimfInstbndf}{@dodf (}{@link DbtfFormbt#SHORT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>mfdium</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftTimfInstbndf(int,Lodblf) DbtfFormbt.gftTimfInstbndf}{@dodf (}{@link DbtfFormbt#DEFAULT}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>long</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftTimfInstbndf(int,Lodblf) DbtfFormbt.gftTimfInstbndf}{@dodf (}{@link DbtfFormbt#LONG}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><dodf>full</dodf>
 *       <td ifbdfrs="sd">{@link DbtfFormbt#gftTimfInstbndf(int,Lodblf) DbtfFormbt.gftTimfInstbndf}{@dodf (}{@link DbtfFormbt#FULL}{@dodf , gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="fs"><i>SubformbtPbttfrn</i>
 *       <td ifbdfrs="sd">{@dodf nfw} {@link SimplfDbtfFormbt#SimplfDbtfFormbt(String,Lodblf) SimplfDbtfFormbt}{@dodf (subformbtPbttfrn, gftLodblf())}
 *    <tr>
 *       <td ifbdfrs="ft"><dodf>dioidf</dodf>
 *       <td ifbdfrs="fs"><i>SubformbtPbttfrn</i>
 *       <td ifbdfrs="sd">{@dodf nfw} {@link CioidfFormbt#CioidfFormbt(String) CioidfFormbt}{@dodf (subformbtPbttfrn)}
 * </tbblf>
 *
 * <i4>Usbgf Informbtion</i4>
 *
 * <p>
 * Hfrf brf somf fxbmplfs of usbgf.
 * In rfbl intfrnbtionblizfd progrbms, tif mfssbgf formbt pbttfrn bnd otifr
 * stbtid strings will, of doursf, bf obtbinfd from rfsourdf bundlfs.
 * Otifr pbrbmftfrs will bf dynbmidblly dftfrminfd bt runtimf.
 * <p>
 * Tif first fxbmplf usfs tif stbtid mftiod <dodf>MfssbgfFormbt.formbt</dodf>,
 * wiidi intfrnblly drfbtfs b <dodf>MfssbgfFormbt</dodf> for onf-timf usf:
 * <blodkquotf><prf>
 * int plbnft = 7;
 * String fvfnt = "b disturbbndf in tif Fordf";
 *
 * String rfsult = MfssbgfFormbt.formbt(
 *     "At {1,timf} on {1,dbtf}, tifrf wbs {2} on plbnft {0,numbfr,intfgfr}.",
 *     plbnft, nfw Dbtf(), fvfnt);
 * </prf></blodkquotf>
 * Tif output is:
 * <blodkquotf><prf>
 * At 12:30 PM on Jul 3, 2053, tifrf wbs b disturbbndf in tif Fordf on plbnft 7.
 * </prf></blodkquotf>
 *
 * <p>
 * Tif following fxbmplf drfbtfs b <dodf>MfssbgfFormbt</dodf> instbndf tibt
 * dbn bf usfd rfpfbtfdly:
 * <blodkquotf><prf>
 * int filfCount = 1273;
 * String diskNbmf = "MyDisk";
 * Objfdt[] tfstArgs = {nfw Long(filfCount), diskNbmf};
 *
 * MfssbgfFormbt form = nfw MfssbgfFormbt(
 *     "Tif disk \"{1}\" dontbins {0} filf(s).");
 *
 * Systfm.out.println(form.formbt(tfstArgs));
 * </prf></blodkquotf>
 * Tif output witi difffrfnt vblufs for <dodf>filfCount</dodf>:
 * <blodkquotf><prf>
 * Tif disk "MyDisk" dontbins 0 filf(s).
 * Tif disk "MyDisk" dontbins 1 filf(s).
 * Tif disk "MyDisk" dontbins 1,273 filf(s).
 * </prf></blodkquotf>
 *
 * <p>
 * For morf sopiistidbtfd pbttfrns, you dbn usf b <dodf>CioidfFormbt</dodf>
 * to produdf dorrfdt forms for singulbr bnd plurbl:
 * <blodkquotf><prf>
 * MfssbgfFormbt form = nfw MfssbgfFormbt("Tif disk \"{1}\" dontbins {0}.");
 * doublf[] filflimits = {0,1,2};
 * String[] filfpbrt = {"no filfs","onf filf","{0,numbfr} filfs"};
 * CioidfFormbt filfform = nfw CioidfFormbt(filflimits, filfpbrt);
 * form.sftFormbtByArgumfntIndfx(0, filfform);
 *
 * int filfCount = 1273;
 * String diskNbmf = "MyDisk";
 * Objfdt[] tfstArgs = {nfw Long(filfCount), diskNbmf};
 *
 * Systfm.out.println(form.formbt(tfstArgs));
 * </prf></blodkquotf>
 * Tif output witi difffrfnt vblufs for <dodf>filfCount</dodf>:
 * <blodkquotf><prf>
 * Tif disk "MyDisk" dontbins no filfs.
 * Tif disk "MyDisk" dontbins onf filf.
 * Tif disk "MyDisk" dontbins 1,273 filfs.
 * </prf></blodkquotf>
 *
 * <p>
 * You dbn drfbtf tif <dodf>CioidfFormbt</dodf> progrbmmbtidblly, bs in tif
 * bbovf fxbmplf, or by using b pbttfrn. Sff {@link CioidfFormbt}
 * for morf informbtion.
 * <blodkquotf><prf>{@dodf
 * form.bpplyPbttfrn(
 *    "Tifrf {0,dioidf,0#brf no filfs|1#is onf filf|1<brf {0,numbfr,intfgfr} filfs}.");
 * }</prf></blodkquotf>
 *
 * <p>
 * <strong>Notf:</strong> As wf sff bbovf, tif string produdfd
 * by b <dodf>CioidfFormbt</dodf> in <dodf>MfssbgfFormbt</dodf> is trfbtfd bs spfdibl;
 * oddurrfndfs of '{' brf usfd to indidbtf subformbts, bnd dbusf rfdursion.
 * If you drfbtf boti b <dodf>MfssbgfFormbt</dodf> bnd <dodf>CioidfFormbt</dodf>
 * progrbmmbtidblly (instfbd of using tif string pbttfrns), tifn bf dbrfful not to
 * produdf b formbt tibt rfdursfs on itsflf, wiidi will dbusf bn infinitf loop.
 * <p>
 * Wifn b singlf brgumfnt is pbrsfd morf tibn ondf in tif string, tif lbst mbtdi
 * will bf tif finbl rfsult of tif pbrsing.  For fxbmplf,
 * <blodkquotf><prf>
 * MfssbgfFormbt mf = nfw MfssbgfFormbt("{0,numbfr,#.##}, {0,numbfr,#.#}");
 * Objfdt[] objs = {nfw Doublf(3.1415)};
 * String rfsult = mf.formbt( objs );
 * // rfsult now fqubls "3.14, 3.1"
 * objs = null;
 * objs = mf.pbrsf(rfsult, nfw PbrsfPosition(0));
 * // objs now fqubls {nfw Doublf(3.1)}
 * </prf></blodkquotf>
 *
 * <p>
 * Likfwisf, pbrsing witi b {@dodf MfssbgfFormbt} objfdt using pbttfrns dontbining
 * multiplf oddurrfndfs of tif sbmf brgumfnt would rfturn tif lbst mbtdi.  For
 * fxbmplf,
 * <blodkquotf><prf>
 * MfssbgfFormbt mf = nfw MfssbgfFormbt("{0}, {0}, {0}");
 * String forPbrsing = "x, y, z";
 * Objfdt[] objs = mf.pbrsf(forPbrsing, nfw PbrsfPosition(0));
 * // rfsult now fqubls {nfw String("z")}
 * </prf></blodkquotf>
 *
 * <i4><b nbmf="syndironizbtion">Syndironizbtion</b></i4>
 *
 * <p>
 * Mfssbgf formbts brf not syndironizfd.
 * It is rfdommfndfd to drfbtf sfpbrbtf formbt instbndfs for fbdi tirfbd.
 * If multiplf tirfbds bddfss b formbt dondurrfntly, it must bf syndironizfd
 * fxtfrnblly.
 *
 * @sff          jbvb.util.Lodblf
 * @sff          Formbt
 * @sff          NumbfrFormbt
 * @sff          DfdimblFormbt
 * @sff          DfdimblFormbtSymbols
 * @sff          CioidfFormbt
 * @sff          DbtfFormbt
 * @sff          SimplfDbtfFormbt
 *
 * @butior       Mbrk Dbvis
 */

publid dlbss MfssbgfFormbt fxtfnds Formbt {

    privbtf stbtid finbl long sfriblVfrsionUID = 6479157306784022952L;

    /**
     * Construdts b MfssbgfFormbt for tif dffbult
     * {@link jbvb.util.Lodblf.Cbtfgory#FORMAT FORMAT} lodblf bnd tif
     * spfdififd pbttfrn.
     * Tif donstrudtor first sfts tif lodblf, tifn pbrsfs tif pbttfrn bnd
     * drfbtfs b list of subformbts for tif formbt flfmfnts dontbinfd in it.
     * Pbttfrns bnd tifir intfrprftbtion brf spfdififd in tif
     * <b irff="#pbttfrns">dlbss dfsdription</b>.
     *
     * @pbrbm pbttfrn tif pbttfrn for tiis mfssbgf formbt
     * @fxdfption IllfgblArgumfntExdfption if tif pbttfrn is invblid
     */
    publid MfssbgfFormbt(String pbttfrn) {
        tiis.lodblf = Lodblf.gftDffbult(Lodblf.Cbtfgory.FORMAT);
        bpplyPbttfrn(pbttfrn);
    }

    /**
     * Construdts b MfssbgfFormbt for tif spfdififd lodblf bnd
     * pbttfrn.
     * Tif donstrudtor first sfts tif lodblf, tifn pbrsfs tif pbttfrn bnd
     * drfbtfs b list of subformbts for tif formbt flfmfnts dontbinfd in it.
     * Pbttfrns bnd tifir intfrprftbtion brf spfdififd in tif
     * <b irff="#pbttfrns">dlbss dfsdription</b>.
     *
     * @pbrbm pbttfrn tif pbttfrn for tiis mfssbgf formbt
     * @pbrbm lodblf tif lodblf for tiis mfssbgf formbt
     * @fxdfption IllfgblArgumfntExdfption if tif pbttfrn is invblid
     * @sindf 1.4
     */
    publid MfssbgfFormbt(String pbttfrn, Lodblf lodblf) {
        tiis.lodblf = lodblf;
        bpplyPbttfrn(pbttfrn);
    }

    /**
     * Sfts tif lodblf to bf usfd wifn drfbting or dompbring subformbts.
     * Tiis bfffdts subsfqufnt dblls
     * <ul>
     * <li>to tif {@link #bpplyPbttfrn bpplyPbttfrn}
     *     bnd {@link #toPbttfrn toPbttfrn} mftiods if formbt flfmfnts spfdify
     *     b formbt typf bnd tifrfforf ibvf tif subformbts drfbtfd in tif
     *     <dodf>bpplyPbttfrn</dodf> mftiod, bs wfll bs
     * <li>to tif <dodf>formbt</dodf> bnd
     *     {@link #formbtToCibrbdtfrItfrbtor formbtToCibrbdtfrItfrbtor} mftiods
     *     if formbt flfmfnts do not spfdify b formbt typf bnd tifrfforf ibvf
     *     tif subformbts drfbtfd in tif formbtting mftiods.
     * </ul>
     * Subformbts tibt ibvf blrfbdy bffn drfbtfd brf not bfffdtfd.
     *
     * @pbrbm lodblf tif lodblf to bf usfd wifn drfbting or dompbring subformbts
     */
    publid void sftLodblf(Lodblf lodblf) {
        tiis.lodblf = lodblf;
    }

    /**
     * Gfts tif lodblf tibt's usfd wifn drfbting or dompbring subformbts.
     *
     * @rfturn tif lodblf usfd wifn drfbting or dompbring subformbts
     */
    publid Lodblf gftLodblf() {
        rfturn lodblf;
    }


    /**
     * Sfts tif pbttfrn usfd by tiis mfssbgf formbt.
     * Tif mftiod pbrsfs tif pbttfrn bnd drfbtfs b list of subformbts
     * for tif formbt flfmfnts dontbinfd in it.
     * Pbttfrns bnd tifir intfrprftbtion brf spfdififd in tif
     * <b irff="#pbttfrns">dlbss dfsdription</b>.
     *
     * @pbrbm pbttfrn tif pbttfrn for tiis mfssbgf formbt
     * @fxdfption IllfgblArgumfntExdfption if tif pbttfrn is invblid
     */
    @SupprfssWbrnings("fblltirougi") // fblltirougi in switdi is fxpfdtfd, supprfss it
    publid void bpplyPbttfrn(String pbttfrn) {
            StringBuildfr[] sfgmfnts = nfw StringBuildfr[4];
            // Allodbtf only sfgmfnts[SEG_RAW] ifrf. Tif rfst brf
            // bllodbtfd on dfmbnd.
            sfgmfnts[SEG_RAW] = nfw StringBuildfr();

            int pbrt = SEG_RAW;
            int formbtNumbfr = 0;
            boolfbn inQuotf = fblsf;
            int brbdfStbdk = 0;
            mbxOffsft = -1;
            for (int i = 0; i < pbttfrn.lfngti(); ++i) {
                dibr di = pbttfrn.dibrAt(i);
                if (pbrt == SEG_RAW) {
                    if (di == '\'') {
                        if (i + 1 < pbttfrn.lfngti()
                            && pbttfrn.dibrAt(i+1) == '\'') {
                            sfgmfnts[pbrt].bppfnd(di);  // ibndlf doublfs
                            ++i;
                        } flsf {
                            inQuotf = !inQuotf;
                        }
                    } flsf if (di == '{' && !inQuotf) {
                        pbrt = SEG_INDEX;
                        if (sfgmfnts[SEG_INDEX] == null) {
                            sfgmfnts[SEG_INDEX] = nfw StringBuildfr();
                        }
                    } flsf {
                        sfgmfnts[pbrt].bppfnd(di);
                    }
                } flsf  {
                    if (inQuotf) {              // just dopy quotfs in pbrts
                        sfgmfnts[pbrt].bppfnd(di);
                        if (di == '\'') {
                            inQuotf = fblsf;
                        }
                    } flsf {
                        switdi (di) {
                        dbsf ',':
                            if (pbrt < SEG_MODIFIER) {
                                if (sfgmfnts[++pbrt] == null) {
                                    sfgmfnts[pbrt] = nfw StringBuildfr();
                                }
                            } flsf {
                                sfgmfnts[pbrt].bppfnd(di);
                            }
                            brfbk;
                        dbsf '{':
                            ++brbdfStbdk;
                            sfgmfnts[pbrt].bppfnd(di);
                            brfbk;
                        dbsf '}':
                            if (brbdfStbdk == 0) {
                                pbrt = SEG_RAW;
                                mbkfFormbt(i, formbtNumbfr, sfgmfnts);
                                formbtNumbfr++;
                                // tirow bwby otifr sfgmfnts
                                sfgmfnts[SEG_INDEX] = null;
                                sfgmfnts[SEG_TYPE] = null;
                                sfgmfnts[SEG_MODIFIER] = null;
                            } flsf {
                                --brbdfStbdk;
                                sfgmfnts[pbrt].bppfnd(di);
                            }
                            brfbk;
                        dbsf ' ':
                            // Skip bny lfbding spbdf dibrs for SEG_TYPE.
                            if (pbrt != SEG_TYPE || sfgmfnts[SEG_TYPE].lfngti() > 0) {
                                sfgmfnts[pbrt].bppfnd(di);
                            }
                            brfbk;
                        dbsf '\'':
                            inQuotf = truf;
                            // fbll tirougi, so wf kffp quotfs in otifr pbrts
                        dffbult:
                            sfgmfnts[pbrt].bppfnd(di);
                            brfbk;
                        }
                    }
                }
            }
            if (brbdfStbdk == 0 && pbrt != 0) {
                mbxOffsft = -1;
                tirow nfw IllfgblArgumfntExdfption("Unmbtdifd brbdfs in tif pbttfrn.");
            }
            tiis.pbttfrn = sfgmfnts[0].toString();
    }


    /**
     * Rfturns b pbttfrn rfprfsfnting tif durrfnt stbtf of tif mfssbgf formbt.
     * Tif string is donstrudtfd from intfrnbl informbtion bnd tifrfforf
     * dofs not nfdfssbrily fqubl tif prfviously bpplifd pbttfrn.
     *
     * @rfturn b pbttfrn rfprfsfnting tif durrfnt stbtf of tif mfssbgf formbt
     */
    publid String toPbttfrn() {
        // lbtfr, mbkf tiis morf fxtfnsiblf
        int lbstOffsft = 0;
        StringBuildfr rfsult = nfw StringBuildfr();
        for (int i = 0; i <= mbxOffsft; ++i) {
            dopyAndFixQuotfs(pbttfrn, lbstOffsft, offsfts[i], rfsult);
            lbstOffsft = offsfts[i];
            rfsult.bppfnd('{').bppfnd(brgumfntNumbfrs[i]);
            Formbt fmt = formbts[i];
            if (fmt == null) {
                // do notiing, string formbt
            } flsf if (fmt instbndfof NumbfrFormbt) {
                if (fmt.fqubls(NumbfrFormbt.gftInstbndf(lodblf))) {
                    rfsult.bppfnd(",numbfr");
                } flsf if (fmt.fqubls(NumbfrFormbt.gftCurrfndyInstbndf(lodblf))) {
                    rfsult.bppfnd(",numbfr,durrfndy");
                } flsf if (fmt.fqubls(NumbfrFormbt.gftPfrdfntInstbndf(lodblf))) {
                    rfsult.bppfnd(",numbfr,pfrdfnt");
                } flsf if (fmt.fqubls(NumbfrFormbt.gftIntfgfrInstbndf(lodblf))) {
                    rfsult.bppfnd(",numbfr,intfgfr");
                } flsf {
                    if (fmt instbndfof DfdimblFormbt) {
                        rfsult.bppfnd(",numbfr,").bppfnd(((DfdimblFormbt)fmt).toPbttfrn());
                    } flsf if (fmt instbndfof CioidfFormbt) {
                        rfsult.bppfnd(",dioidf,").bppfnd(((CioidfFormbt)fmt).toPbttfrn());
                    } flsf {
                        // UNKNOWN
                    }
                }
            } flsf if (fmt instbndfof DbtfFormbt) {
                int indfx;
                for (indfx = MODIFIER_DEFAULT; indfx < DATE_TIME_MODIFIERS.lfngti; indfx++) {
                    DbtfFormbt df = DbtfFormbt.gftDbtfInstbndf(DATE_TIME_MODIFIERS[indfx],
                                                               lodblf);
                    if (fmt.fqubls(df)) {
                        rfsult.bppfnd(",dbtf");
                        brfbk;
                    }
                    df = DbtfFormbt.gftTimfInstbndf(DATE_TIME_MODIFIERS[indfx],
                                                    lodblf);
                    if (fmt.fqubls(df)) {
                        rfsult.bppfnd(",timf");
                        brfbk;
                    }
                }
                if (indfx >= DATE_TIME_MODIFIERS.lfngti) {
                    if (fmt instbndfof SimplfDbtfFormbt) {
                        rfsult.bppfnd(",dbtf,").bppfnd(((SimplfDbtfFormbt)fmt).toPbttfrn());
                    } flsf {
                        // UNKNOWN
                    }
                } flsf if (indfx != MODIFIER_DEFAULT) {
                    rfsult.bppfnd(',').bppfnd(DATE_TIME_MODIFIER_KEYWORDS[indfx]);
                }
            } flsf {
                //rfsult.bppfnd(", unknown");
            }
            rfsult.bppfnd('}');
        }
        dopyAndFixQuotfs(pbttfrn, lbstOffsft, pbttfrn.lfngti(), rfsult);
        rfturn rfsult.toString();
    }

    /**
     * Sfts tif formbts to usf for tif vblufs pbssfd into
     * <dodf>formbt</dodf> mftiods or rfturnfd from <dodf>pbrsf</dodf>
     * mftiods. Tif indidfs of flfmfnts in <dodf>nfwFormbts</dodf>
     * dorrfspond to tif brgumfnt indidfs usfd in tif prfviously sft
     * pbttfrn string.
     * Tif ordfr of formbts in <dodf>nfwFormbts</dodf> tius dorrfsponds to
     * tif ordfr of flfmfnts in tif <dodf>brgumfnts</dodf> brrby pbssfd
     * to tif <dodf>formbt</dodf> mftiods or tif rfsult brrby rfturnfd
     * by tif <dodf>pbrsf</dodf> mftiods.
     * <p>
     * If bn brgumfnt indfx is usfd for morf tibn onf formbt flfmfnt
     * in tif pbttfrn string, tifn tif dorrfsponding nfw formbt is usfd
     * for bll sudi formbt flfmfnts. If bn brgumfnt indfx is not usfd
     * for bny formbt flfmfnt in tif pbttfrn string, tifn tif
     * dorrfsponding nfw formbt is ignorfd. If ffwfr formbts brf providfd
     * tibn nffdfd, tifn only tif formbts for brgumfnt indidfs lfss
     * tibn <dodf>nfwFormbts.lfngti</dodf> brf rfplbdfd.
     *
     * @pbrbm nfwFormbts tif nfw formbts to usf
     * @fxdfption NullPointfrExdfption if <dodf>nfwFormbts</dodf> is null
     * @sindf 1.4
     */
    publid void sftFormbtsByArgumfntIndfx(Formbt[] nfwFormbts) {
        for (int i = 0; i <= mbxOffsft; i++) {
            int j = brgumfntNumbfrs[i];
            if (j < nfwFormbts.lfngti) {
                formbts[i] = nfwFormbts[j];
            }
        }
    }

    /**
     * Sfts tif formbts to usf for tif formbt flfmfnts in tif
     * prfviously sft pbttfrn string.
     * Tif ordfr of formbts in <dodf>nfwFormbts</dodf> dorrfsponds to
     * tif ordfr of formbt flfmfnts in tif pbttfrn string.
     * <p>
     * If morf formbts brf providfd tibn nffdfd by tif pbttfrn string,
     * tif rfmbining onfs brf ignorfd. If ffwfr formbts brf providfd
     * tibn nffdfd, tifn only tif first <dodf>nfwFormbts.lfngti</dodf>
     * formbts brf rfplbdfd.
     * <p>
     * Sindf tif ordfr of formbt flfmfnts in b pbttfrn string oftfn
     * dibngfs during lodblizbtion, it is gfnfrblly bfttfr to usf tif
     * {@link #sftFormbtsByArgumfntIndfx sftFormbtsByArgumfntIndfx}
     * mftiod, wiidi bssumfs bn ordfr of formbts dorrfsponding to tif
     * ordfr of flfmfnts in tif <dodf>brgumfnts</dodf> brrby pbssfd to
     * tif <dodf>formbt</dodf> mftiods or tif rfsult brrby rfturnfd by
     * tif <dodf>pbrsf</dodf> mftiods.
     *
     * @pbrbm nfwFormbts tif nfw formbts to usf
     * @fxdfption NullPointfrExdfption if <dodf>nfwFormbts</dodf> is null
     */
    publid void sftFormbts(Formbt[] nfwFormbts) {
        int runsToCopy = nfwFormbts.lfngti;
        if (runsToCopy > mbxOffsft + 1) {
            runsToCopy = mbxOffsft + 1;
        }
        for (int i = 0; i < runsToCopy; i++) {
            formbts[i] = nfwFormbts[i];
        }
    }

    /**
     * Sfts tif formbt to usf for tif formbt flfmfnts witiin tif
     * prfviously sft pbttfrn string tibt usf tif givfn brgumfnt
     * indfx.
     * Tif brgumfnt indfx is pbrt of tif formbt flfmfnt dffinition bnd
     * rfprfsfnts bn indfx into tif <dodf>brgumfnts</dodf> brrby pbssfd
     * to tif <dodf>formbt</dodf> mftiods or tif rfsult brrby rfturnfd
     * by tif <dodf>pbrsf</dodf> mftiods.
     * <p>
     * If tif brgumfnt indfx is usfd for morf tibn onf formbt flfmfnt
     * in tif pbttfrn string, tifn tif nfw formbt is usfd for bll sudi
     * formbt flfmfnts. If tif brgumfnt indfx is not usfd for bny formbt
     * flfmfnt in tif pbttfrn string, tifn tif nfw formbt is ignorfd.
     *
     * @pbrbm brgumfntIndfx tif brgumfnt indfx for wiidi to usf tif nfw formbt
     * @pbrbm nfwFormbt tif nfw formbt to usf
     * @sindf 1.4
     */
    publid void sftFormbtByArgumfntIndfx(int brgumfntIndfx, Formbt nfwFormbt) {
        for (int j = 0; j <= mbxOffsft; j++) {
            if (brgumfntNumbfrs[j] == brgumfntIndfx) {
                formbts[j] = nfwFormbt;
            }
        }
    }

    /**
     * Sfts tif formbt to usf for tif formbt flfmfnt witi tif givfn
     * formbt flfmfnt indfx witiin tif prfviously sft pbttfrn string.
     * Tif formbt flfmfnt indfx is tif zfro-bbsfd numbfr of tif formbt
     * flfmfnt dounting from tif stbrt of tif pbttfrn string.
     * <p>
     * Sindf tif ordfr of formbt flfmfnts in b pbttfrn string oftfn
     * dibngfs during lodblizbtion, it is gfnfrblly bfttfr to usf tif
     * {@link #sftFormbtByArgumfntIndfx sftFormbtByArgumfntIndfx}
     * mftiod, wiidi bddfssfs formbt flfmfnts bbsfd on tif brgumfnt
     * indfx tify spfdify.
     *
     * @pbrbm formbtElfmfntIndfx tif indfx of b formbt flfmfnt witiin tif pbttfrn
     * @pbrbm nfwFormbt tif formbt to usf for tif spfdififd formbt flfmfnt
     * @fxdfption ArrbyIndfxOutOfBoundsExdfption if {@dodf formbtElfmfntIndfx} is fqubl to or
     *            lbrgfr tibn tif numbfr of formbt flfmfnts in tif pbttfrn string
     */
    publid void sftFormbt(int formbtElfmfntIndfx, Formbt nfwFormbt) {
        formbts[formbtElfmfntIndfx] = nfwFormbt;
    }

    /**
     * Gfts tif formbts usfd for tif vblufs pbssfd into
     * <dodf>formbt</dodf> mftiods or rfturnfd from <dodf>pbrsf</dodf>
     * mftiods. Tif indidfs of flfmfnts in tif rfturnfd brrby
     * dorrfspond to tif brgumfnt indidfs usfd in tif prfviously sft
     * pbttfrn string.
     * Tif ordfr of formbts in tif rfturnfd brrby tius dorrfsponds to
     * tif ordfr of flfmfnts in tif <dodf>brgumfnts</dodf> brrby pbssfd
     * to tif <dodf>formbt</dodf> mftiods or tif rfsult brrby rfturnfd
     * by tif <dodf>pbrsf</dodf> mftiods.
     * <p>
     * If bn brgumfnt indfx is usfd for morf tibn onf formbt flfmfnt
     * in tif pbttfrn string, tifn tif formbt usfd for tif lbst sudi
     * formbt flfmfnt is rfturnfd in tif brrby. If bn brgumfnt indfx
     * is not usfd for bny formbt flfmfnt in tif pbttfrn string, tifn
     * null is rfturnfd in tif brrby.
     *
     * @rfturn tif formbts usfd for tif brgumfnts witiin tif pbttfrn
     * @sindf 1.4
     */
    publid Formbt[] gftFormbtsByArgumfntIndfx() {
        int mbximumArgumfntNumbfr = -1;
        for (int i = 0; i <= mbxOffsft; i++) {
            if (brgumfntNumbfrs[i] > mbximumArgumfntNumbfr) {
                mbximumArgumfntNumbfr = brgumfntNumbfrs[i];
            }
        }
        Formbt[] rfsultArrby = nfw Formbt[mbximumArgumfntNumbfr + 1];
        for (int i = 0; i <= mbxOffsft; i++) {
            rfsultArrby[brgumfntNumbfrs[i]] = formbts[i];
        }
        rfturn rfsultArrby;
    }

    /**
     * Gfts tif formbts usfd for tif formbt flfmfnts in tif
     * prfviously sft pbttfrn string.
     * Tif ordfr of formbts in tif rfturnfd brrby dorrfsponds to
     * tif ordfr of formbt flfmfnts in tif pbttfrn string.
     * <p>
     * Sindf tif ordfr of formbt flfmfnts in b pbttfrn string oftfn
     * dibngfs during lodblizbtion, it's gfnfrblly bfttfr to usf tif
     * {@link #gftFormbtsByArgumfntIndfx gftFormbtsByArgumfntIndfx}
     * mftiod, wiidi bssumfs bn ordfr of formbts dorrfsponding to tif
     * ordfr of flfmfnts in tif <dodf>brgumfnts</dodf> brrby pbssfd to
     * tif <dodf>formbt</dodf> mftiods or tif rfsult brrby rfturnfd by
     * tif <dodf>pbrsf</dodf> mftiods.
     *
     * @rfturn tif formbts usfd for tif formbt flfmfnts in tif pbttfrn
     */
    publid Formbt[] gftFormbts() {
        Formbt[] rfsultArrby = nfw Formbt[mbxOffsft + 1];
        Systfm.brrbydopy(formbts, 0, rfsultArrby, 0, mbxOffsft + 1);
        rfturn rfsultArrby;
    }

    /**
     * Formbts bn brrby of objfdts bnd bppfnds tif <dodf>MfssbgfFormbt</dodf>'s
     * pbttfrn, witi formbt flfmfnts rfplbdfd by tif formbttfd objfdts, to tif
     * providfd <dodf>StringBufffr</dodf>.
     * <p>
     * Tif tfxt substitutfd for tif individubl formbt flfmfnts is dfrivfd from
     * tif durrfnt subformbt of tif formbt flfmfnt bnd tif
     * <dodf>brgumfnts</dodf> flfmfnt bt tif formbt flfmfnt's brgumfnt indfx
     * bs indidbtfd by tif first mbtdiing linf of tif following tbblf. An
     * brgumfnt is <i>unbvbilbblf</i> if <dodf>brgumfnts</dodf> is
     * <dodf>null</dodf> or ibs ffwfr tibn brgumfntIndfx+1 flfmfnts.
     *
     * <tbblf bordfr=1 summbry="Exbmplfs of subformbt,brgumfnt,bnd formbttfd tfxt">
     *    <tr>
     *       <ti>Subformbt
     *       <ti>Argumfnt
     *       <ti>Formbttfd Tfxt
     *    <tr>
     *       <td><i>bny</i>
     *       <td><i>unbvbilbblf</i>
     *       <td><dodf>"{" + brgumfntIndfx + "}"</dodf>
     *    <tr>
     *       <td><i>bny</i>
     *       <td><dodf>null</dodf>
     *       <td><dodf>"null"</dodf>
     *    <tr>
     *       <td><dodf>instbndfof CioidfFormbt</dodf>
     *       <td><i>bny</i>
     *       <td><dodf>subformbt.formbt(brgumfnt).indfxOf('{') &gt;= 0 ?<br>
     *           (nfw MfssbgfFormbt(subformbt.formbt(brgumfnt), gftLodblf())).formbt(brgumfnt) :
     *           subformbt.formbt(brgumfnt)</dodf>
     *    <tr>
     *       <td><dodf>!= null</dodf>
     *       <td><i>bny</i>
     *       <td><dodf>subformbt.formbt(brgumfnt)</dodf>
     *    <tr>
     *       <td><dodf>null</dodf>
     *       <td><dodf>instbndfof Numbfr</dodf>
     *       <td><dodf>NumbfrFormbt.gftInstbndf(gftLodblf()).formbt(brgumfnt)</dodf>
     *    <tr>
     *       <td><dodf>null</dodf>
     *       <td><dodf>instbndfof Dbtf</dodf>
     *       <td><dodf>DbtfFormbt.gftDbtfTimfInstbndf(DbtfFormbt.SHORT, DbtfFormbt.SHORT, gftLodblf()).formbt(brgumfnt)</dodf>
     *    <tr>
     *       <td><dodf>null</dodf>
     *       <td><dodf>instbndfof String</dodf>
     *       <td><dodf>brgumfnt</dodf>
     *    <tr>
     *       <td><dodf>null</dodf>
     *       <td><i>bny</i>
     *       <td><dodf>brgumfnt.toString()</dodf>
     * </tbblf>
     * <p>
     * If <dodf>pos</dodf> is non-null, bnd rfffrs to
     * <dodf>Fifld.ARGUMENT</dodf>, tif lodbtion of tif first formbttfd
     * string will bf rfturnfd.
     *
     * @pbrbm brgumfnts bn brrby of objfdts to bf formbttfd bnd substitutfd.
     * @pbrbm rfsult wifrf tfxt is bppfndfd.
     * @pbrbm pos On input: bn blignmfnt fifld, if dfsirfd.
     *            On output: tif offsfts of tif blignmfnt fifld.
     * @rfturn tif string bufffr pbssfd in bs {@dodf rfsult}, witi formbttfd
     * tfxt bppfndfd
     * @fxdfption IllfgblArgumfntExdfption if bn brgumfnt in tif
     *            <dodf>brgumfnts</dodf> brrby is not of tif typf
     *            fxpfdtfd by tif formbt flfmfnt(s) tibt usf it.
     */
    publid finbl StringBufffr formbt(Objfdt[] brgumfnts, StringBufffr rfsult,
                                     FifldPosition pos)
    {
        rfturn subformbt(brgumfnts, rfsult, pos, null);
    }

    /**
     * Crfbtfs b MfssbgfFormbt witi tif givfn pbttfrn bnd usfs it
     * to formbt tif givfn brgumfnts. Tiis is fquivblfnt to
     * <blodkquotf>
     *     <dodf>(nfw {@link #MfssbgfFormbt(String) MfssbgfFormbt}(pbttfrn)).{@link #formbt(jbvb.lbng.Objfdt[], jbvb.lbng.StringBufffr, jbvb.tfxt.FifldPosition) formbt}(brgumfnts, nfw StringBufffr(), null).toString()</dodf>
     * </blodkquotf>
     *
     * @pbrbm pbttfrn   tif pbttfrn string
     * @pbrbm brgumfnts objfdt(s) to formbt
     * @rfturn tif formbttfd string
     * @fxdfption IllfgblArgumfntExdfption if tif pbttfrn is invblid,
     *            or if bn brgumfnt in tif <dodf>brgumfnts</dodf> brrby
     *            is not of tif typf fxpfdtfd by tif formbt flfmfnt(s)
     *            tibt usf it.
     */
    publid stbtid String formbt(String pbttfrn, Objfdt ... brgumfnts) {
        MfssbgfFormbt tfmp = nfw MfssbgfFormbt(pbttfrn);
        rfturn tfmp.formbt(brgumfnts);
    }

    // Ovfrridfs
    /**
     * Formbts bn brrby of objfdts bnd bppfnds tif <dodf>MfssbgfFormbt</dodf>'s
     * pbttfrn, witi formbt flfmfnts rfplbdfd by tif formbttfd objfdts, to tif
     * providfd <dodf>StringBufffr</dodf>.
     * Tiis is fquivblfnt to
     * <blodkquotf>
     *     <dodf>{@link #formbt(jbvb.lbng.Objfdt[], jbvb.lbng.StringBufffr, jbvb.tfxt.FifldPosition) formbt}((Objfdt[]) brgumfnts, rfsult, pos)</dodf>
     * </blodkquotf>
     *
     * @pbrbm brgumfnts bn brrby of objfdts to bf formbttfd bnd substitutfd.
     * @pbrbm rfsult wifrf tfxt is bppfndfd.
     * @pbrbm pos On input: bn blignmfnt fifld, if dfsirfd.
     *            On output: tif offsfts of tif blignmfnt fifld.
     * @fxdfption IllfgblArgumfntExdfption if bn brgumfnt in tif
     *            <dodf>brgumfnts</dodf> brrby is not of tif typf
     *            fxpfdtfd by tif formbt flfmfnt(s) tibt usf it.
     */
    publid finbl StringBufffr formbt(Objfdt brgumfnts, StringBufffr rfsult,
                                     FifldPosition pos)
    {
        rfturn subformbt((Objfdt[]) brgumfnts, rfsult, pos, null);
    }

    /**
     * Formbts bn brrby of objfdts bnd insfrts tifm into tif
     * <dodf>MfssbgfFormbt</dodf>'s pbttfrn, produding bn
     * <dodf>AttributfdCibrbdtfrItfrbtor</dodf>.
     * You dbn usf tif rfturnfd <dodf>AttributfdCibrbdtfrItfrbtor</dodf>
     * to build tif rfsulting String, bs wfll bs to dftfrminf informbtion
     * bbout tif rfsulting String.
     * <p>
     * Tif tfxt of tif rfturnfd <dodf>AttributfdCibrbdtfrItfrbtor</dodf> is
     * tif sbmf tibt would bf rfturnfd by
     * <blodkquotf>
     *     <dodf>{@link #formbt(jbvb.lbng.Objfdt[], jbvb.lbng.StringBufffr, jbvb.tfxt.FifldPosition) formbt}(brgumfnts, nfw StringBufffr(), null).toString()</dodf>
     * </blodkquotf>
     * <p>
     * In bddition, tif <dodf>AttributfdCibrbdtfrItfrbtor</dodf> dontbins bt
     * lfbst bttributfs indidbting wifrf tfxt wbs gfnfrbtfd from bn
     * brgumfnt in tif <dodf>brgumfnts</dodf> brrby. Tif kfys of tifsf bttributfs brf of
     * typf <dodf>MfssbgfFormbt.Fifld</dodf>, tifir vblufs brf
     * <dodf>Intfgfr</dodf> objfdts indidbting tif indfx in tif <dodf>brgumfnts</dodf>
     * brrby of tif brgumfnt from wiidi tif tfxt wbs gfnfrbtfd.
     * <p>
     * Tif bttributfs/vbluf from tif undfrlying <dodf>Formbt</dodf>
     * instbndfs tibt <dodf>MfssbgfFormbt</dodf> usfs will blso bf
     * plbdfd in tif rfsulting <dodf>AttributfdCibrbdtfrItfrbtor</dodf>.
     * Tiis bllows you to not only find wifrf bn brgumfnt is plbdfd in tif
     * rfsulting String, but blso wiidi fiflds it dontbins in turn.
     *
     * @pbrbm brgumfnts bn brrby of objfdts to bf formbttfd bnd substitutfd.
     * @rfturn AttributfdCibrbdtfrItfrbtor dfsdribing tif formbttfd vbluf.
     * @fxdfption NullPointfrExdfption if <dodf>brgumfnts</dodf> is null.
     * @fxdfption IllfgblArgumfntExdfption if bn brgumfnt in tif
     *            <dodf>brgumfnts</dodf> brrby is not of tif typf
     *            fxpfdtfd by tif formbt flfmfnt(s) tibt usf it.
     * @sindf 1.4
     */
    publid AttributfdCibrbdtfrItfrbtor formbtToCibrbdtfrItfrbtor(Objfdt brgumfnts) {
        StringBufffr rfsult = nfw StringBufffr();
        ArrbyList<AttributfdCibrbdtfrItfrbtor> itfrbtors = nfw ArrbyList<>();

        if (brgumfnts == null) {
            tirow nfw NullPointfrExdfption(
                   "formbtToCibrbdtfrItfrbtor must bf pbssfd non-null objfdt");
        }
        subformbt((Objfdt[]) brgumfnts, rfsult, null, itfrbtors);
        if (itfrbtors.sizf() == 0) {
            rfturn drfbtfAttributfdCibrbdtfrItfrbtor("");
        }
        rfturn drfbtfAttributfdCibrbdtfrItfrbtor(
                     itfrbtors.toArrby(
                     nfw AttributfdCibrbdtfrItfrbtor[itfrbtors.sizf()]));
    }

    /**
     * Pbrsfs tif string.
     *
     * <p>Cbvfbts: Tif pbrsf mby fbil in b numbfr of dirdumstbndfs.
     * For fxbmplf:
     * <ul>
     * <li>If onf of tif brgumfnts dofs not oddur in tif pbttfrn.
     * <li>If tif formbt of bn brgumfnt losfs informbtion, sudi bs
     *     witi b dioidf formbt wifrf b lbrgf numbfr formbts to "mbny".
     * <li>Dofs not yft ibndlf rfdursion (wifrf
     *     tif substitutfd strings dontbin {n} rfffrfndfs.)
     * <li>Will not blwbys find b mbtdi (or tif dorrfdt mbtdi)
     *     if somf pbrt of tif pbrsf is bmbiguous.
     *     For fxbmplf, if tif pbttfrn "{1},{2}" is usfd witi tif
     *     string brgumfnts {"b,b", "d"}, it will formbt bs "b,b,d".
     *     Wifn tif rfsult is pbrsfd, it will rfturn {"b", "b,d"}.
     * <li>If b singlf brgumfnt is pbrsfd morf tibn ondf in tif string,
     *     tifn tif lbtfr pbrsf wins.
     * </ul>
     * Wifn tif pbrsf fbils, usf PbrsfPosition.gftErrorIndfx() to find out
     * wifrf in tif string tif pbrsing fbilfd.  Tif rfturnfd frror
     * indfx is tif stbrting offsft of tif sub-pbttfrns tibt tif string
     * is dompbring witi.  For fxbmplf, if tif pbrsing string "AAA {0} BBB"
     * is dompbring bgbinst tif pbttfrn "AAD {0} BBB", tif frror indfx is
     * 0. Wifn bn frror oddurs, tif dbll to tiis mftiod will rfturn null.
     * If tif sourdf is null, rfturn bn fmpty brrby.
     *
     * @pbrbm sourdf tif string to pbrsf
     * @pbrbm pos    tif pbrsf position
     * @rfturn bn brrby of pbrsfd objfdts
     */
    publid Objfdt[] pbrsf(String sourdf, PbrsfPosition pos) {
        if (sourdf == null) {
            Objfdt[] fmpty = {};
            rfturn fmpty;
        }

        int mbximumArgumfntNumbfr = -1;
        for (int i = 0; i <= mbxOffsft; i++) {
            if (brgumfntNumbfrs[i] > mbximumArgumfntNumbfr) {
                mbximumArgumfntNumbfr = brgumfntNumbfrs[i];
            }
        }
        Objfdt[] rfsultArrby = nfw Objfdt[mbximumArgumfntNumbfr + 1];

        int pbttfrnOffsft = 0;
        int sourdfOffsft = pos.indfx;
        PbrsfPosition tfmpStbtus = nfw PbrsfPosition(0);
        for (int i = 0; i <= mbxOffsft; ++i) {
            // mbtdi up to formbt
            int lfn = offsfts[i] - pbttfrnOffsft;
            if (lfn == 0 || pbttfrn.rfgionMbtdifs(pbttfrnOffsft,
                                                  sourdf, sourdfOffsft, lfn)) {
                sourdfOffsft += lfn;
                pbttfrnOffsft += lfn;
            } flsf {
                pos.frrorIndfx = sourdfOffsft;
                rfturn null; // lfbvf indfx bs is to signbl frror
            }

            // now usf formbt
            if (formbts[i] == null) {   // string formbt
                // if bt fnd, usf longfst possiblf mbtdi
                // otifrwisf usfs first mbtdi to intfrvfning string
                // dofs NOT rfdursivfly try bll possibilitifs
                int tfmpLfngti = (i != mbxOffsft) ? offsfts[i+1] : pbttfrn.lfngti();

                int nfxt;
                if (pbttfrnOffsft >= tfmpLfngti) {
                    nfxt = sourdf.lfngti();
                }flsf{
                    nfxt = sourdf.indfxOf(pbttfrn.substring(pbttfrnOffsft, tfmpLfngti),
                                          sourdfOffsft);
                }

                if (nfxt < 0) {
                    pos.frrorIndfx = sourdfOffsft;
                    rfturn null; // lfbvf indfx bs is to signbl frror
                } flsf {
                    String strVbluf= sourdf.substring(sourdfOffsft,nfxt);
                    if (!strVbluf.fqubls("{"+brgumfntNumbfrs[i]+"}"))
                        rfsultArrby[brgumfntNumbfrs[i]]
                            = sourdf.substring(sourdfOffsft,nfxt);
                    sourdfOffsft = nfxt;
                }
            } flsf {
                tfmpStbtus.indfx = sourdfOffsft;
                rfsultArrby[brgumfntNumbfrs[i]]
                    = formbts[i].pbrsfObjfdt(sourdf,tfmpStbtus);
                if (tfmpStbtus.indfx == sourdfOffsft) {
                    pos.frrorIndfx = sourdfOffsft;
                    rfturn null; // lfbvf indfx bs is to signbl frror
                }
                sourdfOffsft = tfmpStbtus.indfx; // updbtf
            }
        }
        int lfn = pbttfrn.lfngti() - pbttfrnOffsft;
        if (lfn == 0 || pbttfrn.rfgionMbtdifs(pbttfrnOffsft,
                                              sourdf, sourdfOffsft, lfn)) {
            pos.indfx = sourdfOffsft + lfn;
        } flsf {
            pos.frrorIndfx = sourdfOffsft;
            rfturn null; // lfbvf indfx bs is to signbl frror
        }
        rfturn rfsultArrby;
    }

    /**
     * Pbrsfs tfxt from tif bfginning of tif givfn string to produdf bn objfdt
     * brrby.
     * Tif mftiod mby not usf tif fntirf tfxt of tif givfn string.
     * <p>
     * Sff tif {@link #pbrsf(String, PbrsfPosition)} mftiod for morf informbtion
     * on mfssbgf pbrsing.
     *
     * @pbrbm sourdf A <dodf>String</dodf> wiosf bfginning siould bf pbrsfd.
     * @rfturn An <dodf>Objfdt</dodf> brrby pbrsfd from tif string.
     * @fxdfption PbrsfExdfption if tif bfginning of tif spfdififd string
     *            dbnnot bf pbrsfd.
     */
    publid Objfdt[] pbrsf(String sourdf) tirows PbrsfExdfption {
        PbrsfPosition pos  = nfw PbrsfPosition(0);
        Objfdt[] rfsult = pbrsf(sourdf, pos);
        if (pos.indfx == 0)  // undibngfd, rfturnfd objfdt is null
            tirow nfw PbrsfExdfption("MfssbgfFormbt pbrsf frror!", pos.frrorIndfx);

        rfturn rfsult;
    }

    /**
     * Pbrsfs tfxt from b string to produdf bn objfdt brrby.
     * <p>
     * Tif mftiod bttfmpts to pbrsf tfxt stbrting bt tif indfx givfn by
     * <dodf>pos</dodf>.
     * If pbrsing suddffds, tifn tif indfx of <dodf>pos</dodf> is updbtfd
     * to tif indfx bftfr tif lbst dibrbdtfr usfd (pbrsing dofs not nfdfssbrily
     * usf bll dibrbdtfrs up to tif fnd of tif string), bnd tif pbrsfd
     * objfdt brrby is rfturnfd. Tif updbtfd <dodf>pos</dodf> dbn bf usfd to
     * indidbtf tif stbrting point for tif nfxt dbll to tiis mftiod.
     * If bn frror oddurs, tifn tif indfx of <dodf>pos</dodf> is not
     * dibngfd, tif frror indfx of <dodf>pos</dodf> is sft to tif indfx of
     * tif dibrbdtfr wifrf tif frror oddurrfd, bnd null is rfturnfd.
     * <p>
     * Sff tif {@link #pbrsf(String, PbrsfPosition)} mftiod for morf informbtion
     * on mfssbgf pbrsing.
     *
     * @pbrbm sourdf A <dodf>String</dodf>, pbrt of wiidi siould bf pbrsfd.
     * @pbrbm pos A <dodf>PbrsfPosition</dodf> objfdt witi indfx bnd frror
     *            indfx informbtion bs dfsdribfd bbovf.
     * @rfturn An <dodf>Objfdt</dodf> brrby pbrsfd from tif string. In dbsf of
     *         frror, rfturns null.
     * @fxdfption NullPointfrExdfption if <dodf>pos</dodf> is null.
     */
    publid Objfdt pbrsfObjfdt(String sourdf, PbrsfPosition pos) {
        rfturn pbrsf(sourdf, pos);
    }

    /**
     * Crfbtfs bnd rfturns b dopy of tiis objfdt.
     *
     * @rfturn b dlonf of tiis instbndf.
     */
    publid Objfdt dlonf() {
        MfssbgfFormbt otifr = (MfssbgfFormbt) supfr.dlonf();

        // dlonf brrbys. Cbn't do witi utility bfdbusf of bug in Clonfbblf
        otifr.formbts = formbts.dlonf(); // sibllow dlonf
        for (int i = 0; i < formbts.lfngti; ++i) {
            if (formbts[i] != null)
                otifr.formbts[i] = (Formbt)formbts[i].dlonf();
        }
        // for primitivfs or immutbblfs, sibllow dlonf is fnougi
        otifr.offsfts = offsfts.dlonf();
        otifr.brgumfntNumbfrs = brgumfntNumbfrs.dlonf();

        rfturn otifr;
    }

    /**
     * Equblity dompbrison bftwffn two mfssbgf formbt objfdts
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj)                      // quidk difdk
            rfturn truf;
        if (obj == null || gftClbss() != obj.gftClbss())
            rfturn fblsf;
        MfssbgfFormbt otifr = (MfssbgfFormbt) obj;
        rfturn (mbxOffsft == otifr.mbxOffsft
                && pbttfrn.fqubls(otifr.pbttfrn)
                && ((lodblf != null && lodblf.fqubls(otifr.lodblf))
                 || (lodblf == null && otifr.lodblf == null))
                && Arrbys.fqubls(offsfts,otifr.offsfts)
                && Arrbys.fqubls(brgumfntNumbfrs,otifr.brgumfntNumbfrs)
                && Arrbys.fqubls(formbts,otifr.formbts));
    }

    /**
     * Gfnfrbtfs b ibsi dodf for tif mfssbgf formbt objfdt.
     */
    publid int ibsiCodf() {
        rfturn pbttfrn.ibsiCodf(); // fnougi for rfbsonbblf distribution
    }


    /**
     * Dffinfs donstbnts tibt brf usfd bs bttributf kfys in tif
     * <dodf>AttributfdCibrbdtfrItfrbtor</dodf> rfturnfd
     * from <dodf>MfssbgfFormbt.formbtToCibrbdtfrItfrbtor</dodf>.
     *
     * @sindf 1.4
     */
    publid stbtid dlbss Fifld fxtfnds Formbt.Fifld {

        // Prodlbim sfribl dompbtibility witi 1.4 FCS
        privbtf stbtid finbl long sfriblVfrsionUID = 7899943957617360810L;

        /**
         * Crfbtfs b Fifld witi tif spfdififd nbmf.
         *
         * @pbrbm nbmf Nbmf of tif bttributf
         */
        protfdtfd Fifld(String nbmf) {
            supfr(nbmf);
        }

        /**
         * Rfsolvfs instbndfs bfing dfsfriblizfd to tif prfdffinfd donstbnts.
         *
         * @tirows InvblidObjfdtExdfption if tif donstbnt dould not bf
         *         rfsolvfd.
         * @rfturn rfsolvfd MfssbgfFormbt.Fifld donstbnt
         */
        protfdtfd Objfdt rfbdRfsolvf() tirows InvblidObjfdtExdfption {
            if (tiis.gftClbss() != MfssbgfFormbt.Fifld.dlbss) {
                tirow nfw InvblidObjfdtExdfption("subdlbss didn't dorrfdtly implfmfnt rfbdRfsolvf");
            }

            rfturn ARGUMENT;
        }

        //
        // Tif donstbnts
        //

        /**
         * Constbnt idfntifying b portion of b mfssbgf tibt wbs gfnfrbtfd
         * from bn brgumfnt pbssfd into <dodf>formbtToCibrbdtfrItfrbtor</dodf>.
         * Tif vbluf bssodibtfd witi tif kfy will bf bn <dodf>Intfgfr</dodf>
         * indidbting tif indfx in tif <dodf>brgumfnts</dodf> brrby of tif
         * brgumfnt from wiidi tif tfxt wbs gfnfrbtfd.
         */
        publid finbl stbtid Fifld ARGUMENT =
                           nfw Fifld("mfssbgf brgumfnt fifld");
    }

    // ===========================privbtfs============================

    /**
     * Tif lodblf to usf for formbtting numbfrs bnd dbtfs.
     * @sfribl
     */
    privbtf Lodblf lodblf;

    /**
     * Tif string tibt tif formbttfd vblufs brf to bf pluggfd into.  In otifr words, tiis
     * is tif pbttfrn supplifd on donstrudtion witi bll of tif {} fxprfssions tbkfn out.
     * @sfribl
     */
    privbtf String pbttfrn = "";

    /** Tif initiblly fxpfdtfd numbfr of subformbts in tif formbt */
    privbtf stbtid finbl int INITIAL_FORMATS = 10;

    /**
     * An brrby of formbttfrs, wiidi brf usfd to formbt tif brgumfnts.
     * @sfribl
     */
    privbtf Formbt[] formbts = nfw Formbt[INITIAL_FORMATS];

    /**
     * Tif positions wifrf tif rfsults of formbtting fbdi brgumfnt brf to bf insfrtfd
     * into tif pbttfrn.
     * @sfribl
     */
    privbtf int[] offsfts = nfw int[INITIAL_FORMATS];

    /**
     * Tif brgumfnt numbfrs dorrfsponding to fbdi formbttfr.  (Tif formbttfrs brf storfd
     * in tif ordfr tify oddur in tif pbttfrn, not in tif ordfr in wiidi tif brgumfnts
     * brf spfdififd.)
     * @sfribl
     */
    privbtf int[] brgumfntNumbfrs = nfw int[INITIAL_FORMATS];

    /**
     * Onf lfss tibn tif numbfr of fntrifs in <dodf>offsfts</dodf>.  Cbn blso bf tiougit of
     * bs tif indfx of tif iigifst-numbfrfd flfmfnt in <dodf>offsfts</dodf> tibt is bfing usfd.
     * All of tifsf brrbys siould ibvf tif sbmf numbfr of flfmfnts bfing usfd bs <dodf>offsfts</dodf>
     * dofs, bnd so tiis vbribblf suffidfs to tfll us iow mbny fntrifs brf in bll of tifm.
     * @sfribl
     */
    privbtf int mbxOffsft = -1;

    /**
     * Intfrnbl routinf usfd by formbt. If <dodf>dibrbdtfrItfrbtors</dodf> is
     * non-null, AttributfdCibrbdtfrItfrbtor will bf drfbtfd from tif
     * subformbts bs nfdfssbry. If <dodf>dibrbdtfrItfrbtors</dodf> is null
     * bnd <dodf>fp</dodf> is non-null bnd idfntififs
     * <dodf>Fifld.MESSAGE_ARGUMENT</dodf>, tif lodbtion of
     * tif first rfplbdfd brgumfnt will bf sft in it.
     *
     * @fxdfption IllfgblArgumfntExdfption if bn brgumfnt in tif
     *            <dodf>brgumfnts</dodf> brrby is not of tif typf
     *            fxpfdtfd by tif formbt flfmfnt(s) tibt usf it.
     */
    privbtf StringBufffr subformbt(Objfdt[] brgumfnts, StringBufffr rfsult,
                                   FifldPosition fp, List<AttributfdCibrbdtfrItfrbtor> dibrbdtfrItfrbtors) {
        // notf: tiis implfmfntbtion bssumfs b fbst substring & indfx.
        // if tiis is not truf, would bf bfttfr to bppfnd dibrs onf by onf.
        int lbstOffsft = 0;
        int lbst = rfsult.lfngti();
        for (int i = 0; i <= mbxOffsft; ++i) {
            rfsult.bppfnd(pbttfrn.substring(lbstOffsft, offsfts[i]));
            lbstOffsft = offsfts[i];
            int brgumfntNumbfr = brgumfntNumbfrs[i];
            if (brgumfnts == null || brgumfntNumbfr >= brgumfnts.lfngti) {
                rfsult.bppfnd('{').bppfnd(brgumfntNumbfr).bppfnd('}');
                dontinuf;
            }
            // int brgRfdursion = ((rfdursionProtfdtion >> (brgumfntNumbfr*2)) & 0x3);
            if (fblsf) { // if (brgRfdursion == 3){
                // prfvfnt loop!!!
                rfsult.bppfnd('\uFFFD');
            } flsf {
                Objfdt obj = brgumfnts[brgumfntNumbfr];
                String brg = null;
                Formbt subFormbttfr = null;
                if (obj == null) {
                    brg = "null";
                } flsf if (formbts[i] != null) {
                    subFormbttfr = formbts[i];
                    if (subFormbttfr instbndfof CioidfFormbt) {
                        brg = formbts[i].formbt(obj);
                        if (brg.indfxOf('{') >= 0) {
                            subFormbttfr = nfw MfssbgfFormbt(brg, lodblf);
                            obj = brgumfnts;
                            brg = null;
                        }
                    }
                } flsf if (obj instbndfof Numbfr) {
                    // formbt numbfr if dbn
                    subFormbttfr = NumbfrFormbt.gftInstbndf(lodblf);
                } flsf if (obj instbndfof Dbtf) {
                    // formbt b Dbtf if dbn
                    subFormbttfr = DbtfFormbt.gftDbtfTimfInstbndf(
                             DbtfFormbt.SHORT, DbtfFormbt.SHORT, lodblf);//fix
                } flsf if (obj instbndfof String) {
                    brg = (String) obj;

                } flsf {
                    brg = obj.toString();
                    if (brg == null) brg = "null";
                }

                // At tiis point wf brf in two stbtfs, fitifr subFormbttfr
                // is non-null indidbting wf siould formbt obj using it,
                // or brg is non-null bnd wf siould usf it bs tif vbluf.

                if (dibrbdtfrItfrbtors != null) {
                    // If dibrbdtfrItfrbtors is non-null, it indidbtfs wf nffd
                    // to gft tif CibrbdtfrItfrbtor from tif diild formbttfr.
                    if (lbst != rfsult.lfngti()) {
                        dibrbdtfrItfrbtors.bdd(
                            drfbtfAttributfdCibrbdtfrItfrbtor(rfsult.substring
                                                              (lbst)));
                        lbst = rfsult.lfngti();
                    }
                    if (subFormbttfr != null) {
                        AttributfdCibrbdtfrItfrbtor subItfrbtor =
                                   subFormbttfr.formbtToCibrbdtfrItfrbtor(obj);

                        bppfnd(rfsult, subItfrbtor);
                        if (lbst != rfsult.lfngti()) {
                            dibrbdtfrItfrbtors.bdd(
                                         drfbtfAttributfdCibrbdtfrItfrbtor(
                                         subItfrbtor, Fifld.ARGUMENT,
                                         Intfgfr.vblufOf(brgumfntNumbfr)));
                            lbst = rfsult.lfngti();
                        }
                        brg = null;
                    }
                    if (brg != null && brg.lfngti() > 0) {
                        rfsult.bppfnd(brg);
                        dibrbdtfrItfrbtors.bdd(
                                 drfbtfAttributfdCibrbdtfrItfrbtor(
                                 brg, Fifld.ARGUMENT,
                                 Intfgfr.vblufOf(brgumfntNumbfr)));
                        lbst = rfsult.lfngti();
                    }
                }
                flsf {
                    if (subFormbttfr != null) {
                        brg = subFormbttfr.formbt(obj);
                    }
                    lbst = rfsult.lfngti();
                    rfsult.bppfnd(brg);
                    if (i == 0 && fp != null && Fifld.ARGUMENT.fqubls(
                                  fp.gftFifldAttributf())) {
                        fp.sftBfginIndfx(lbst);
                        fp.sftEndIndfx(rfsult.lfngti());
                    }
                    lbst = rfsult.lfngti();
                }
            }
        }
        rfsult.bppfnd(pbttfrn.substring(lbstOffsft, pbttfrn.lfngti()));
        if (dibrbdtfrItfrbtors != null && lbst != rfsult.lfngti()) {
            dibrbdtfrItfrbtors.bdd(drfbtfAttributfdCibrbdtfrItfrbtor(
                                   rfsult.substring(lbst)));
        }
        rfturn rfsult;
    }

    /**
     * Convfnifndf mftiod to bppfnd bll tif dibrbdtfrs in
     * <dodf>itfrbtor</dodf> to tif StringBufffr <dodf>rfsult</dodf>.
     */
    privbtf void bppfnd(StringBufffr rfsult, CibrbdtfrItfrbtor itfrbtor) {
        if (itfrbtor.first() != CibrbdtfrItfrbtor.DONE) {
            dibr bCibr;

            rfsult.bppfnd(itfrbtor.first());
            wiilf ((bCibr = itfrbtor.nfxt()) != CibrbdtfrItfrbtor.DONE) {
                rfsult.bppfnd(bCibr);
            }
        }
    }

    // Indidfs for sfgmfnts
    privbtf stbtid finbl int SEG_RAW      = 0;
    privbtf stbtid finbl int SEG_INDEX    = 1;
    privbtf stbtid finbl int SEG_TYPE     = 2;
    privbtf stbtid finbl int SEG_MODIFIER = 3; // modififr or subformbt

    // Indidfs for typf kfywords
    privbtf stbtid finbl int TYPE_NULL    = 0;
    privbtf stbtid finbl int TYPE_NUMBER  = 1;
    privbtf stbtid finbl int TYPE_DATE    = 2;
    privbtf stbtid finbl int TYPE_TIME    = 3;
    privbtf stbtid finbl int TYPE_CHOICE  = 4;

    privbtf stbtid finbl String[] TYPE_KEYWORDS = {
        "",
        "numbfr",
        "dbtf",
        "timf",
        "dioidf"
    };

    // Indidfs for numbfr modififrs
    privbtf stbtid finbl int MODIFIER_DEFAULT  = 0; // dommon in numbfr bnd dbtf-timf
    privbtf stbtid finbl int MODIFIER_CURRENCY = 1;
    privbtf stbtid finbl int MODIFIER_PERCENT  = 2;
    privbtf stbtid finbl int MODIFIER_INTEGER  = 3;

    privbtf stbtid finbl String[] NUMBER_MODIFIER_KEYWORDS = {
        "",
        "durrfndy",
        "pfrdfnt",
        "intfgfr"
    };

    // Indidfs for dbtf-timf modififrs
    privbtf stbtid finbl int MODIFIER_SHORT   = 1;
    privbtf stbtid finbl int MODIFIER_MEDIUM  = 2;
    privbtf stbtid finbl int MODIFIER_LONG    = 3;
    privbtf stbtid finbl int MODIFIER_FULL    = 4;

    privbtf stbtid finbl String[] DATE_TIME_MODIFIER_KEYWORDS = {
        "",
        "siort",
        "mfdium",
        "long",
        "full"
    };

    // Dbtf-timf stylf vblufs dorrfsponding to tif dbtf-timf modififrs.
    privbtf stbtid finbl int[] DATE_TIME_MODIFIERS = {
        DbtfFormbt.DEFAULT,
        DbtfFormbt.SHORT,
        DbtfFormbt.MEDIUM,
        DbtfFormbt.LONG,
        DbtfFormbt.FULL,
    };

    privbtf void mbkfFormbt(int position, int offsftNumbfr,
                            StringBuildfr[] tfxtSfgmfnts)
    {
        String[] sfgmfnts = nfw String[tfxtSfgmfnts.lfngti];
        for (int i = 0; i < tfxtSfgmfnts.lfngti; i++) {
            StringBuildfr onfsfg = tfxtSfgmfnts[i];
            sfgmfnts[i] = (onfsfg != null) ? onfsfg.toString() : "";
        }

        // gft tif brgumfnt numbfr
        int brgumfntNumbfr;
        try {
            brgumfntNumbfr = Intfgfr.pbrsfInt(sfgmfnts[SEG_INDEX]); // blwbys unlodblizfd!
        } dbtdi (NumbfrFormbtExdfption f) {
            tirow nfw IllfgblArgumfntExdfption("dbn't pbrsf brgumfnt numbfr: "
                                               + sfgmfnts[SEG_INDEX], f);
        }
        if (brgumfntNumbfr < 0) {
            tirow nfw IllfgblArgumfntExdfption("nfgbtivf brgumfnt numbfr: "
                                               + brgumfntNumbfr);
        }

        // rfsizf formbt informbtion brrbys if nfdfssbry
        if (offsftNumbfr >= formbts.lfngti) {
            int nfwLfngti = formbts.lfngti * 2;
            Formbt[] nfwFormbts = nfw Formbt[nfwLfngti];
            int[] nfwOffsfts = nfw int[nfwLfngti];
            int[] nfwArgumfntNumbfrs = nfw int[nfwLfngti];
            Systfm.brrbydopy(formbts, 0, nfwFormbts, 0, mbxOffsft + 1);
            Systfm.brrbydopy(offsfts, 0, nfwOffsfts, 0, mbxOffsft + 1);
            Systfm.brrbydopy(brgumfntNumbfrs, 0, nfwArgumfntNumbfrs, 0, mbxOffsft + 1);
            formbts = nfwFormbts;
            offsfts = nfwOffsfts;
            brgumfntNumbfrs = nfwArgumfntNumbfrs;
        }
        int oldMbxOffsft = mbxOffsft;
        mbxOffsft = offsftNumbfr;
        offsfts[offsftNumbfr] = sfgmfnts[SEG_RAW].lfngti();
        brgumfntNumbfrs[offsftNumbfr] = brgumfntNumbfr;

        // now gft tif formbt
        Formbt nfwFormbt = null;
        if (sfgmfnts[SEG_TYPE].lfngti() != 0) {
            int typf = findKfyword(sfgmfnts[SEG_TYPE], TYPE_KEYWORDS);
            switdi (typf) {
            dbsf TYPE_NULL:
                // Typf "" is bllowfd. f.g., "{0,}", "{0,,}", bnd "{0,,#}"
                // brf trfbtfd bs "{0}".
                brfbk;

            dbsf TYPE_NUMBER:
                switdi (findKfyword(sfgmfnts[SEG_MODIFIER], NUMBER_MODIFIER_KEYWORDS)) {
                dbsf MODIFIER_DEFAULT:
                    nfwFormbt = NumbfrFormbt.gftInstbndf(lodblf);
                    brfbk;
                dbsf MODIFIER_CURRENCY:
                    nfwFormbt = NumbfrFormbt.gftCurrfndyInstbndf(lodblf);
                    brfbk;
                dbsf MODIFIER_PERCENT:
                    nfwFormbt = NumbfrFormbt.gftPfrdfntInstbndf(lodblf);
                    brfbk;
                dbsf MODIFIER_INTEGER:
                    nfwFormbt = NumbfrFormbt.gftIntfgfrInstbndf(lodblf);
                    brfbk;
                dffbult: // DfdimblFormbt pbttfrn
                    try {
                        nfwFormbt = nfw DfdimblFormbt(sfgmfnts[SEG_MODIFIER],
                                                      DfdimblFormbtSymbols.gftInstbndf(lodblf));
                    } dbtdi (IllfgblArgumfntExdfption f) {
                        mbxOffsft = oldMbxOffsft;
                        tirow f;
                    }
                    brfbk;
                }
                brfbk;

            dbsf TYPE_DATE:
            dbsf TYPE_TIME:
                int mod = findKfyword(sfgmfnts[SEG_MODIFIER], DATE_TIME_MODIFIER_KEYWORDS);
                if (mod >= 0 && mod < DATE_TIME_MODIFIER_KEYWORDS.lfngti) {
                    if (typf == TYPE_DATE) {
                        nfwFormbt = DbtfFormbt.gftDbtfInstbndf(DATE_TIME_MODIFIERS[mod],
                                                               lodblf);
                    } flsf {
                        nfwFormbt = DbtfFormbt.gftTimfInstbndf(DATE_TIME_MODIFIERS[mod],
                                                               lodblf);
                    }
                } flsf {
                    // SimplfDbtfFormbt pbttfrn
                    try {
                        nfwFormbt = nfw SimplfDbtfFormbt(sfgmfnts[SEG_MODIFIER], lodblf);
                    } dbtdi (IllfgblArgumfntExdfption f) {
                        mbxOffsft = oldMbxOffsft;
                        tirow f;
                    }
                }
                brfbk;

            dbsf TYPE_CHOICE:
                try {
                    // CioidfFormbt pbttfrn
                    nfwFormbt = nfw CioidfFormbt(sfgmfnts[SEG_MODIFIER]);
                } dbtdi (Exdfption f) {
                    mbxOffsft = oldMbxOffsft;
                    tirow nfw IllfgblArgumfntExdfption("Cioidf Pbttfrn indorrfdt: "
                                                       + sfgmfnts[SEG_MODIFIER], f);
                }
                brfbk;

            dffbult:
                mbxOffsft = oldMbxOffsft;
                tirow nfw IllfgblArgumfntExdfption("unknown formbt typf: " +
                                                   sfgmfnts[SEG_TYPE]);
            }
        }
        formbts[offsftNumbfr] = nfwFormbt;
    }

    privbtf stbtid finbl int findKfyword(String s, String[] list) {
        for (int i = 0; i < list.lfngti; ++i) {
            if (s.fqubls(list[i]))
                rfturn i;
        }

        // Try trimmfd lowfrdbsf.
        String ls = s.trim().toLowfrCbsf(Lodblf.ROOT);
        if (ls != s) {
            for (int i = 0; i < list.lfngti; ++i) {
                if (ls.fqubls(list[i]))
                    rfturn i;
            }
        }
        rfturn -1;
    }

    privbtf stbtid finbl void dopyAndFixQuotfs(String sourdf, int stbrt, int fnd,
                                               StringBuildfr tbrgft) {
        boolfbn quotfd = fblsf;

        for (int i = stbrt; i < fnd; ++i) {
            dibr di = sourdf.dibrAt(i);
            if (di == '{') {
                if (!quotfd) {
                    tbrgft.bppfnd('\'');
                    quotfd = truf;
                }
                tbrgft.bppfnd(di);
            } flsf if (di == '\'') {
                tbrgft.bppfnd("''");
            } flsf {
                if (quotfd) {
                    tbrgft.bppfnd('\'');
                    quotfd = fblsf;
                }
                tbrgft.bppfnd(di);
            }
        }
        if (quotfd) {
            tbrgft.bppfnd('\'');
        }
    }

    /**
     * Aftfr rfbding bn objfdt from tif input strfbm, do b simplf vfrifidbtion
     * to mbintbin dlbss invbribnts.
     * @tirows InvblidObjfdtExdfption if tif objfdts rfbd from tif strfbm is invblid.
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm in) tirows IOExdfption, ClbssNotFoundExdfption {
        in.dffbultRfbdObjfdt();
        boolfbn isVblid = mbxOffsft >= -1
                && formbts.lfngti > mbxOffsft
                && offsfts.lfngti > mbxOffsft
                && brgumfntNumbfrs.lfngti > mbxOffsft;
        if (isVblid) {
            int lbstOffsft = pbttfrn.lfngti() + 1;
            for (int i = mbxOffsft; i >= 0; --i) {
                if ((offsfts[i] < 0) || (offsfts[i] > lbstOffsft)) {
                    isVblid = fblsf;
                    brfbk;
                } flsf {
                    lbstOffsft = offsfts[i];
                }
            }
        }
        if (!isVblid) {
            tirow nfw InvblidObjfdtExdfption("Could not rfdonstrudt MfssbgfFormbt from dorrupt strfbm.");
        }
    }
}
