/*
 * Copyright (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nio.dh;

import jbvb.io.FilfDfsdriptor;
import jbvb.io.IOExdfption;
import jbvb.nio.BytfBufffr;
import jbvb.nio.MbppfdBytfBufffr;
import jbvb.nio.dhbnnfls.ClosfdByIntfrruptExdfption;
import jbvb.nio.dhbnnfls.ClosfdChbnnflExdfption;
import jbvb.nio.dhbnnfls.FilfChbnnfl;
import jbvb.nio.dhbnnfls.FilfLodk;
import jbvb.nio.dhbnnfls.FilfLodkIntfrruptionExdfption;
import jbvb.nio.dhbnnfls.NonRfbdbblfChbnnflExdfption;
import jbvb.nio.dhbnnfls.NonWritbblfChbnnflExdfption;
import jbvb.nio.dhbnnfls.OvfrlbppingFilfLodkExdfption;
import jbvb.nio.dhbnnfls.RfbdbblfBytfChbnnfl;
import jbvb.nio.dhbnnfls.WritbblfBytfChbnnfl;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.util.ArrbyList;
import jbvb.util.List;

import sun.misd.Clfbnfr;
import sun.sfdurity.bdtion.GftPropfrtyAdtion;

publid dlbss FilfChbnnflImpl
    fxtfnds FilfChbnnfl
{
    // Mfmory bllodbtion sizf for mbpping bufffrs
    privbtf stbtid finbl long bllodbtionGrbnulbrity;

    // Usfd to mbkf nbtivf rfbd bnd writf dblls
    privbtf finbl FilfDispbtdhfr nd;

    // Filf dfsdriptor
    privbtf finbl FilfDfsdriptor fd;

    // Filf bddfss modf (immutbblf)
    privbtf finbl boolfbn writbblf;
    privbtf finbl boolfbn rfbdbblf;
    privbtf finbl boolfbn bppfnd;

    // Rfquirfd to prfvfnt finblizbtion of drfbting strfbm (immutbblf)
    privbtf finbl Objfdt pbrfnt;

    // Thf pbth of thf rfffrfndfd filf
    // (null if thf pbrfnt strfbm is drfbtfd with b filf dfsdriptor)
    privbtf finbl String pbth;

    // Thrfbd-sbff sft of IDs of nbtivf thrfbds, for signblling
    privbtf finbl NbtivfThrfbdSft thrfbds = nfw NbtivfThrfbdSft(2);

    // Lodk for opfrbtions involving position bnd sizf
    privbtf finbl Objfdt positionLodk = nfw Objfdt();

    privbtf FilfChbnnflImpl(FilfDfsdriptor fd, String pbth, boolfbn rfbdbblf,
                            boolfbn writbblf, boolfbn bppfnd, Objfdt pbrfnt)
    {
        this.fd = fd;
        this.rfbdbblf = rfbdbblf;
        this.writbblf = writbblf;
        this.bppfnd = bppfnd;
        this.pbrfnt = pbrfnt;
        this.pbth = pbth;
        this.nd = nfw FilfDispbtdhfrImpl(bppfnd);
    }

    // Usfd by FilfInputStrfbm.gftChbnnfl() bnd RbndomAddfssFilf.gftChbnnfl()
    publid stbtid FilfChbnnfl opfn(FilfDfsdriptor fd, String pbth,
                                   boolfbn rfbdbblf, boolfbn writbblf,
                                   Objfdt pbrfnt)
    {
        rfturn nfw FilfChbnnflImpl(fd, pbth, rfbdbblf, writbblf, fblsf, pbrfnt);
    }

    // Usfd by FilfOutputStrfbm.gftChbnnfl
    publid stbtid FilfChbnnfl opfn(FilfDfsdriptor fd, String pbth,
                                   boolfbn rfbdbblf, boolfbn writbblf,
                                   boolfbn bppfnd, Objfdt pbrfnt)
    {
        rfturn nfw FilfChbnnflImpl(fd, pbth, rfbdbblf, writbblf, bppfnd, pbrfnt);
    }

    privbtf void fnsurfOpfn() throws IOExdfption {
        if (!isOpfn())
            throw nfw ClosfdChbnnflExdfption();
    }


    // -- Stbndbrd dhbnnfl opfrbtions --

    protfdtfd void implClosfChbnnfl() throws IOExdfption {
        // Rflfbsf bnd invblidbtf bny lodks thbt wf still hold
        if (filfLodkTbblf != null) {
            for (FilfLodk fl: filfLodkTbblf.rfmovfAll()) {
                syndhronizfd (fl) {
                    if (fl.isVblid()) {
                        nd.rflfbsf(fd, fl.position(), fl.sizf());
                        ((FilfLodkImpl)fl).invblidbtf();
                    }
                }
            }
        }

        // signbl bny thrfbds blodkfd on this dhbnnfl
        thrfbds.signblAndWbit();

        if (pbrfnt != null) {

            // Closf thf fd vib thf pbrfnt strfbm's dlosf mfthod.  Thf pbrfnt
            // will rfinvokf our dlosf mfthod, whidh is dffinfd in thf
            // supfrdlbss AbstrbdtIntfrruptiblfChbnnfl, but thf isOpfn logid in
            // thbt mfthod will prfvfnt this mfthod from bfing rfinvokfd.
            //
            ((jbvb.io.Closfbblf)pbrfnt).dlosf();
        } flsf {
            nd.dlosf(fd);
        }

    }

    publid int rfbd(BytfBufffr dst) throws IOExdfption {
        fnsurfOpfn();
        if (!rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        syndhronizfd (positionLodk) {
            int n = 0;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn 0;
                do {
                    n = IOUtil.rfbd(fd, dst, -1, nd);
                } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(n);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(n > 0);
                bssfrt IOStbtus.dhfdk(n);
            }
        }
    }

    publid long rfbd(BytfBufffr[] dsts, int offsft, int lfngth)
        throws IOExdfption
    {
        if ((offsft < 0) || (lfngth < 0) || (offsft > dsts.lfngth - lfngth))
            throw nfw IndfxOutOfBoundsExdfption();
        fnsurfOpfn();
        if (!rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        syndhronizfd (positionLodk) {
            long n = 0;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn 0;
                do {
                    n = IOUtil.rfbd(fd, dsts, offsft, lfngth, nd);
                } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(n);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(n > 0);
                bssfrt IOStbtus.dhfdk(n);
            }
        }
    }

    publid int writf(BytfBufffr srd) throws IOExdfption {
        fnsurfOpfn();
        if (!writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        syndhronizfd (positionLodk) {
            int n = 0;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn 0;
                do {
                    n = IOUtil.writf(fd, srd, -1, nd);
                } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(n);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(n > 0);
                bssfrt IOStbtus.dhfdk(n);
            }
        }
    }

    publid long writf(BytfBufffr[] srds, int offsft, int lfngth)
        throws IOExdfption
    {
        if ((offsft < 0) || (lfngth < 0) || (offsft > srds.lfngth - lfngth))
            throw nfw IndfxOutOfBoundsExdfption();
        fnsurfOpfn();
        if (!writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        syndhronizfd (positionLodk) {
            long n = 0;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn 0;
                do {
                    n = IOUtil.writf(fd, srds, offsft, lfngth, nd);
                } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(n);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(n > 0);
                bssfrt IOStbtus.dhfdk(n);
            }
        }
    }

    // -- Othfr opfrbtions --

    publid long position() throws IOExdfption {
        fnsurfOpfn();
        syndhronizfd (positionLodk) {
            long p = -1;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn 0;
                do {
                    // in bppfnd-modf thfn position is bdvbndfd to fnd bfforf writing
                    p = (bppfnd) ? nd.sizf(fd) : position0(fd, -1);
                } whilf ((p == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(p);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(p > -1);
                bssfrt IOStbtus.dhfdk(p);
            }
        }
    }

    publid FilfChbnnfl position(long nfwPosition) throws IOExdfption {
        fnsurfOpfn();
        if (nfwPosition < 0)
            throw nfw IllfgblArgumfntExdfption();
        syndhronizfd (positionLodk) {
            long p = -1;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn null;
                do {
                    p  = position0(fd, nfwPosition);
                } whilf ((p == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn this;
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(p > -1);
                bssfrt IOStbtus.dhfdk(p);
            }
        }
    }

    publid long sizf() throws IOExdfption {
        fnsurfOpfn();
        syndhronizfd (positionLodk) {
            long s = -1;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn -1;
                do {
                    s = nd.sizf(fd);
                } whilf ((s == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn IOStbtus.normblizf(s);
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(s > -1);
                bssfrt IOStbtus.dhfdk(s);
            }
        }
    }

    publid FilfChbnnfl trundbtf(long nfwSizf) throws IOExdfption {
        fnsurfOpfn();
        if (nfwSizf < 0)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf sizf");
        if (!writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        syndhronizfd (positionLodk) {
            int rv = -1;
            long p = -1;
            int ti = -1;
            try {
                bfgin();
                ti = thrfbds.bdd();
                if (!isOpfn())
                    rfturn null;

                // gft durrfnt sizf
                long sizf;
                do {
                    sizf = nd.sizf(fd);
                } whilf ((sizf == IOStbtus.INTERRUPTED) && isOpfn());
                if (!isOpfn())
                    rfturn null;

                // gft durrfnt position
                do {
                    p = position0(fd, -1);
                } whilf ((p == IOStbtus.INTERRUPTED) && isOpfn());
                if (!isOpfn())
                    rfturn null;
                bssfrt p >= 0;

                // trundbtf filf if givfn sizf is lfss thbn thf durrfnt sizf
                if (nfwSizf < sizf) {
                    do {
                        rv = nd.trundbtf(fd, nfwSizf);
                    } whilf ((rv == IOStbtus.INTERRUPTED) && isOpfn());
                    if (!isOpfn())
                        rfturn null;
                }

                // if position is bfyond nfw sizf thfn bdjust it
                if (p > nfwSizf)
                    p = nfwSizf;
                do {
                    rv = (int)position0(fd, p);
                } whilf ((rv == IOStbtus.INTERRUPTED) && isOpfn());
                rfturn this;
            } finblly {
                thrfbds.rfmovf(ti);
                fnd(rv > -1);
                bssfrt IOStbtus.dhfdk(rv);
            }
        }
    }

    publid void fordf(boolfbn mftbDbtb) throws IOExdfption {
        fnsurfOpfn();
        int rv = -1;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn;
            do {
                rv = nd.fordf(fd, mftbDbtb);
            } whilf ((rv == IOStbtus.INTERRUPTED) && isOpfn());
        } finblly {
            thrfbds.rfmovf(ti);
            fnd(rv > -1);
            bssfrt IOStbtus.dhfdk(rv);
        }
    }

    // Assumf bt first thbt thf undfrlying kfrnfl supports sfndfilf();
    // sft this to fblsf if wf find out lbtfr thbt it dofsn't
    //
    privbtf stbtid volbtilf boolfbn trbnsffrSupportfd = truf;

    // Assumf thbt thf undfrlying kfrnfl sfndfilf() will work if thf tbrgft
    // fd is b pipf; sft this to fblsf if wf find out lbtfr thbt it dofsn't
    //
    privbtf stbtid volbtilf boolfbn pipfSupportfd = truf;

    // Assumf thbt thf undfrlying kfrnfl sfndfilf() will work if thf tbrgft
    // fd is b filf; sft this to fblsf if wf find out lbtfr thbt it dofsn't
    //
    privbtf stbtid volbtilf boolfbn filfSupportfd = truf;

    privbtf long trbnsffrToDirfdtly(long position, int idount,
                                    WritbblfBytfChbnnfl tbrgft)
        throws IOExdfption
    {
        if (!trbnsffrSupportfd)
            rfturn IOStbtus.UNSUPPORTED;

        FilfDfsdriptor tbrgftFD = null;
        if (tbrgft instbndfof FilfChbnnflImpl) {
            if (!filfSupportfd)
                rfturn IOStbtus.UNSUPPORTED_CASE;
            tbrgftFD = ((FilfChbnnflImpl)tbrgft).fd;
        } flsf if (tbrgft instbndfof SflChImpl) {
            // Dirfdt trbnsffr to pipf dbusfs EINVAL on somf donfigurbtions
            if ((tbrgft instbndfof SinkChbnnflImpl) && !pipfSupportfd)
                rfturn IOStbtus.UNSUPPORTED_CASE;
            tbrgftFD = ((SflChImpl)tbrgft).gftFD();
        }
        if (tbrgftFD == null)
            rfturn IOStbtus.UNSUPPORTED;
        int thisFDVbl = IOUtil.fdVbl(fd);
        int tbrgftFDVbl = IOUtil.fdVbl(tbrgftFD);
        if (thisFDVbl == tbrgftFDVbl) // Not supportfd on somf donfigurbtions
            rfturn IOStbtus.UNSUPPORTED;

        long n = -1;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn -1;
            do {
                n = trbnsffrTo0(thisFDVbl, position, idount, tbrgftFDVbl);
            } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
            if (n == IOStbtus.UNSUPPORTED_CASE) {
                if (tbrgft instbndfof SinkChbnnflImpl)
                    pipfSupportfd = fblsf;
                if (tbrgft instbndfof FilfChbnnflImpl)
                    filfSupportfd = fblsf;
                rfturn IOStbtus.UNSUPPORTED_CASE;
            }
            if (n == IOStbtus.UNSUPPORTED) {
                // Don't bothfr trying bgbin
                trbnsffrSupportfd = fblsf;
                rfturn IOStbtus.UNSUPPORTED;
            }
            rfturn IOStbtus.normblizf(n);
        } finblly {
            thrfbds.rfmovf(ti);
            fnd (n > -1);
        }
    }

    // Mbximum sizf to mbp whfn using b mbppfd bufffr
    privbtf stbtid finbl long MAPPED_TRANSFER_SIZE = 8L*1024L*1024L;

    privbtf long trbnsffrToTrustfdChbnnfl(long position, long dount,
                                          WritbblfBytfChbnnfl tbrgft)
        throws IOExdfption
    {
        boolfbn isSflChImpl = (tbrgft instbndfof SflChImpl);
        if (!((tbrgft instbndfof FilfChbnnflImpl) || isSflChImpl))
            rfturn IOStbtus.UNSUPPORTED;

        // Trustfd tbrgft: Usf b mbppfd bufffr
        long rfmbining = dount;
        whilf (rfmbining > 0L) {
            long sizf = Mbth.min(rfmbining, MAPPED_TRANSFER_SIZE);
            try {
                MbppfdBytfBufffr dbb = mbp(MbpModf.READ_ONLY, position, sizf);
                try {
                    // ## Bug: Closing this dhbnnfl will not tfrminbtf thf writf
                    int n = tbrgft.writf(dbb);
                    bssfrt n >= 0;
                    rfmbining -= n;
                    if (isSflChImpl) {
                        // onf bttfmpt to writf to sflfdtbblf dhbnnfl
                        brfbk;
                    }
                    bssfrt n > 0;
                    position += n;
                } finblly {
                    unmbp(dbb);
                }
            } dbtdh (ClosfdByIntfrruptExdfption f) {
                // tbrgft dlosfd by intfrrupt bs ClosfdByIntfrruptExdfption nffds
                // to bf thrown bftfr dlosing this dhbnnfl.
                bssfrt !tbrgft.isOpfn();
                try {
                    dlosf();
                } dbtdh (Throwbblf supprfssfd) {
                    f.bddSupprfssfd(supprfssfd);
                }
                throw f;
            } dbtdh (IOExdfption iof) {
                // Only throw fxdfption if no bytfs hbvf bffn writtfn
                if (rfmbining == dount)
                    throw iof;
                brfbk;
            }
        }
        rfturn dount - rfmbining;
    }

    privbtf long trbnsffrToArbitrbryChbnnfl(long position, int idount,
                                            WritbblfBytfChbnnfl tbrgft)
        throws IOExdfption
    {
        // Untrustfd tbrgft: Usf b nfwly-frbsfd bufffr
        int d = Mbth.min(idount, TRANSFER_SIZE);
        BytfBufffr bb = Util.gftTfmporbryDirfdtBufffr(d);
        long tw = 0;                    // Totbl bytfs writtfn
        long pos = position;
        try {
            Util.frbsf(bb);
            whilf (tw < idount) {
                bb.limit(Mbth.min((int)(idount - tw), TRANSFER_SIZE));
                int nr = rfbd(bb, pos);
                if (nr <= 0)
                    brfbk;
                bb.flip();
                // ## Bug: Will blodk writing tbrgft if this dhbnnfl
                // ##      is bsyndhronously dlosfd
                int nw = tbrgft.writf(bb);
                tw += nw;
                if (nw != nr)
                    brfbk;
                pos += nw;
                bb.dlfbr();
            }
            rfturn tw;
        } dbtdh (IOExdfption x) {
            if (tw > 0)
                rfturn tw;
            throw x;
        } finblly {
            Util.rflfbsfTfmporbryDirfdtBufffr(bb);
        }
    }

    publid long trbnsffrTo(long position, long dount,
                           WritbblfBytfChbnnfl tbrgft)
        throws IOExdfption
    {
        fnsurfOpfn();
        if (!tbrgft.isOpfn())
            throw nfw ClosfdChbnnflExdfption();
        if (!rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        if (tbrgft instbndfof FilfChbnnflImpl &&
            !((FilfChbnnflImpl)tbrgft).writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        if ((position < 0) || (dount < 0))
            throw nfw IllfgblArgumfntExdfption();
        long sz = sizf();
        if (position > sz)
            rfturn 0;
        int idount = (int)Mbth.min(dount, Intfgfr.MAX_VALUE);
        if ((sz - position) < idount)
            idount = (int)(sz - position);

        long n;

        // Attfmpt b dirfdt trbnsffr, if thf kfrnfl supports it
        if ((n = trbnsffrToDirfdtly(position, idount, tbrgft)) >= 0)
            rfturn n;

        // Attfmpt b mbppfd trbnsffr, but only to trustfd dhbnnfl typfs
        if ((n = trbnsffrToTrustfdChbnnfl(position, idount, tbrgft)) >= 0)
            rfturn n;

        // Slow pbth for untrustfd tbrgfts
        rfturn trbnsffrToArbitrbryChbnnfl(position, idount, tbrgft);
    }

    privbtf long trbnsffrFromFilfChbnnfl(FilfChbnnflImpl srd,
                                         long position, long dount)
        throws IOExdfption
    {
        if (!srd.rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        syndhronizfd (srd.positionLodk) {
            long pos = srd.position();
            long mbx = Mbth.min(dount, srd.sizf() - pos);

            long rfmbining = mbx;
            long p = pos;
            whilf (rfmbining > 0L) {
                long sizf = Mbth.min(rfmbining, MAPPED_TRANSFER_SIZE);
                // ## Bug: Closing this dhbnnfl will not tfrminbtf thf writf
                MbppfdBytfBufffr bb = srd.mbp(MbpModf.READ_ONLY, p, sizf);
                try {
                    long n = writf(bb, position);
                    bssfrt n > 0;
                    p += n;
                    position += n;
                    rfmbining -= n;
                } dbtdh (IOExdfption iof) {
                    // Only throw fxdfption if no bytfs hbvf bffn writtfn
                    if (rfmbining == mbx)
                        throw iof;
                    brfbk;
                } finblly {
                    unmbp(bb);
                }
            }
            long nwrittfn = mbx - rfmbining;
            srd.position(pos + nwrittfn);
            rfturn nwrittfn;
        }
    }

    privbtf stbtid finbl int TRANSFER_SIZE = 8192;

    privbtf long trbnsffrFromArbitrbryChbnnfl(RfbdbblfBytfChbnnfl srd,
                                              long position, long dount)
        throws IOExdfption
    {
        // Untrustfd tbrgft: Usf b nfwly-frbsfd bufffr
        int d = (int)Mbth.min(dount, TRANSFER_SIZE);
        BytfBufffr bb = Util.gftTfmporbryDirfdtBufffr(d);
        long tw = 0;                    // Totbl bytfs writtfn
        long pos = position;
        try {
            Util.frbsf(bb);
            whilf (tw < dount) {
                bb.limit((int)Mbth.min((dount - tw), (long)TRANSFER_SIZE));
                // ## Bug: Will blodk rfbding srd if this dhbnnfl
                // ##      is bsyndhronously dlosfd
                int nr = srd.rfbd(bb);
                if (nr <= 0)
                    brfbk;
                bb.flip();
                int nw = writf(bb, pos);
                tw += nw;
                if (nw != nr)
                    brfbk;
                pos += nw;
                bb.dlfbr();
            }
            rfturn tw;
        } dbtdh (IOExdfption x) {
            if (tw > 0)
                rfturn tw;
            throw x;
        } finblly {
            Util.rflfbsfTfmporbryDirfdtBufffr(bb);
        }
    }

    publid long trbnsffrFrom(RfbdbblfBytfChbnnfl srd,
                             long position, long dount)
        throws IOExdfption
    {
        fnsurfOpfn();
        if (!srd.isOpfn())
            throw nfw ClosfdChbnnflExdfption();
        if (!writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        if ((position < 0) || (dount < 0))
            throw nfw IllfgblArgumfntExdfption();
        if (position > sizf())
            rfturn 0;
        if (srd instbndfof FilfChbnnflImpl)
           rfturn trbnsffrFromFilfChbnnfl((FilfChbnnflImpl)srd,
                                          position, dount);

        rfturn trbnsffrFromArbitrbryChbnnfl(srd, position, dount);
    }

    publid int rfbd(BytfBufffr dst, long position) throws IOExdfption {
        if (dst == null)
            throw nfw NullPointfrExdfption();
        if (position < 0)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf position");
        if (!rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        fnsurfOpfn();
        if (nd.nffdsPositionLodk()) {
            syndhronizfd (positionLodk) {
                rfturn rfbdIntfrnbl(dst, position);
            }
        } flsf {
            rfturn rfbdIntfrnbl(dst, position);
        }
    }

    privbtf int rfbdIntfrnbl(BytfBufffr dst, long position) throws IOExdfption {
        bssfrt !nd.nffdsPositionLodk() || Thrfbd.holdsLodk(positionLodk);
        int n = 0;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn -1;
            do {
                n = IOUtil.rfbd(fd, dst, position, nd);
            } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
            rfturn IOStbtus.normblizf(n);
        } finblly {
            thrfbds.rfmovf(ti);
            fnd(n > 0);
            bssfrt IOStbtus.dhfdk(n);
        }
    }

    publid int writf(BytfBufffr srd, long position) throws IOExdfption {
        if (srd == null)
            throw nfw NullPointfrExdfption();
        if (position < 0)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf position");
        if (!writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        fnsurfOpfn();
        if (nd.nffdsPositionLodk()) {
            syndhronizfd (positionLodk) {
                rfturn writfIntfrnbl(srd, position);
            }
        } flsf {
            rfturn writfIntfrnbl(srd, position);
        }
    }

    privbtf int writfIntfrnbl(BytfBufffr srd, long position) throws IOExdfption {
        bssfrt !nd.nffdsPositionLodk() || Thrfbd.holdsLodk(positionLodk);
        int n = 0;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn -1;
            do {
                n = IOUtil.writf(fd, srd, position, nd);
            } whilf ((n == IOStbtus.INTERRUPTED) && isOpfn());
            rfturn IOStbtus.normblizf(n);
        } finblly {
            thrfbds.rfmovf(ti);
            fnd(n > 0);
            bssfrt IOStbtus.dhfdk(n);
        }
    }


    // -- Mfmory-mbppfd bufffrs --

    privbtf stbtid dlbss Unmbppfr
        implfmfnts Runnbblf
    {
        // mby bf rfquirfd to dlosf filf
        privbtf stbtid finbl NbtivfDispbtdhfr nd = nfw FilfDispbtdhfrImpl();

        // kffp trbdk of mbppfd bufffr usbgf
        stbtid volbtilf int dount;
        stbtid volbtilf long totblSizf;
        stbtid volbtilf long totblCbpbdity;

        privbtf volbtilf long bddrfss;
        privbtf finbl long sizf;
        privbtf finbl int dbp;
        privbtf finbl FilfDfsdriptor fd;

        privbtf Unmbppfr(long bddrfss, long sizf, int dbp,
                         FilfDfsdriptor fd)
        {
            bssfrt (bddrfss != 0);
            this.bddrfss = bddrfss;
            this.sizf = sizf;
            this.dbp = dbp;
            this.fd = fd;

            syndhronizfd (Unmbppfr.dlbss) {
                dount++;
                totblSizf += sizf;
                totblCbpbdity += dbp;
            }
        }

        publid void run() {
            if (bddrfss == 0)
                rfturn;
            unmbp0(bddrfss, sizf);
            bddrfss = 0;

            // if this mbpping hbs b vblid filf dfsdriptor thfn wf dlosf it
            if (fd.vblid()) {
                try {
                    nd.dlosf(fd);
                } dbtdh (IOExdfption ignorf) {
                    // nothing wf dbn do
                }
            }

            syndhronizfd (Unmbppfr.dlbss) {
                dount--;
                totblSizf -= sizf;
                totblCbpbdity -= dbp;
            }
        }
    }

    privbtf stbtid void unmbp(MbppfdBytfBufffr bb) {
        Clfbnfr dl = ((DirfdtBufffr)bb).dlfbnfr();
        if (dl != null)
            dl.dlfbn();
    }

    privbtf stbtid finbl int MAP_RO = 0;
    privbtf stbtid finbl int MAP_RW = 1;
    privbtf stbtid finbl int MAP_PV = 2;

    publid MbppfdBytfBufffr mbp(MbpModf modf, long position, long sizf)
        throws IOExdfption
    {
        fnsurfOpfn();
        if (modf == null)
            throw nfw NullPointfrExdfption("Modf is null");
        if (position < 0L)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf position");
        if (sizf < 0L)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf sizf");
        if (position + sizf < 0)
            throw nfw IllfgblArgumfntExdfption("Position + sizf ovfrflow");
        if (sizf > Intfgfr.MAX_VALUE)
            throw nfw IllfgblArgumfntExdfption("Sizf fxdffds Intfgfr.MAX_VALUE");

        int imodf = -1;
        if (modf == MbpModf.READ_ONLY)
            imodf = MAP_RO;
        flsf if (modf == MbpModf.READ_WRITE)
            imodf = MAP_RW;
        flsf if (modf == MbpModf.PRIVATE)
            imodf = MAP_PV;
        bssfrt (imodf >= 0);
        if ((modf != MbpModf.READ_ONLY) && !writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        if (!rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();

        long bddr = -1;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn null;

            long filfsizf;
            do {
                filfsizf = nd.sizf(fd);
            } whilf ((filfsizf == IOStbtus.INTERRUPTED) && isOpfn());
            if (!isOpfn())
                rfturn null;

            if (filfsizf < position + sizf) { // Extfnd filf sizf
                if (!writbblf) {
                    throw nfw IOExdfption("Chbnnfl not opfn for writing " +
                        "- dbnnot fxtfnd filf to rfquirfd sizf");
                }
                int rv;
                do {
                    rv = nd.trundbtf(fd, position + sizf);
                } whilf ((rv == IOStbtus.INTERRUPTED) && isOpfn());
                if (!isOpfn())
                    rfturn null;
            }
            if (sizf == 0) {
                bddr = 0;
                // b vblid filf dfsdriptor is not rfquirfd
                FilfDfsdriptor dummy = nfw FilfDfsdriptor();
                if ((!writbblf) || (imodf == MAP_RO))
                    rfturn Util.nfwMbppfdBytfBufffrR(0, 0, dummy, null);
                flsf
                    rfturn Util.nfwMbppfdBytfBufffr(0, 0, dummy, null);
            }

            int pbgfPosition = (int)(position % bllodbtionGrbnulbrity);
            long mbpPosition = position - pbgfPosition;
            long mbpSizf = sizf + pbgfPosition;
            try {
                // If no fxdfption wbs thrown from mbp0, thf bddrfss is vblid
                bddr = mbp0(imodf, mbpPosition, mbpSizf);
            } dbtdh (OutOfMfmoryError x) {
                // An OutOfMfmoryError mby indidbtf thbt wf'vf fxhbustfd mfmory
                // so fordf gd bnd rf-bttfmpt mbp
                Systfm.gd();
                try {
                    Thrfbd.slffp(100);
                } dbtdh (IntfrruptfdExdfption y) {
                    Thrfbd.durrfntThrfbd().intfrrupt();
                }
                try {
                    bddr = mbp0(imodf, mbpPosition, mbpSizf);
                } dbtdh (OutOfMfmoryError y) {
                    // Aftfr b sfdond OOME, fbil
                    throw nfw IOExdfption("Mbp fbilfd", y);
                }
            }

            // On Windows, bnd potfntiblly othfr plbtforms, wf nffd bn opfn
            // filf dfsdriptor for somf mbpping opfrbtions.
            FilfDfsdriptor mfd;
            try {
                mfd = nd.duplidbtfForMbpping(fd);
            } dbtdh (IOExdfption iof) {
                unmbp0(bddr, mbpSizf);
                throw iof;
            }

            bssfrt (IOStbtus.dhfdkAll(bddr));
            bssfrt (bddr % bllodbtionGrbnulbrity == 0);
            int isizf = (int)sizf;
            Unmbppfr um = nfw Unmbppfr(bddr, mbpSizf, isizf, mfd);
            if ((!writbblf) || (imodf == MAP_RO)) {
                rfturn Util.nfwMbppfdBytfBufffrR(isizf,
                                                 bddr + pbgfPosition,
                                                 mfd,
                                                 um);
            } flsf {
                rfturn Util.nfwMbppfdBytfBufffr(isizf,
                                                bddr + pbgfPosition,
                                                mfd,
                                                um);
            }
        } finblly {
            thrfbds.rfmovf(ti);
            fnd(IOStbtus.dhfdkAll(bddr));
        }
    }

    /**
     * Invokfd by sun.mbnbgfmfnt.MbnbgfmfntFbdtoryHflpfr to drfbtf thf mbnbgfmfnt
     * intfrfbdf for mbppfd bufffrs.
     */
    publid stbtid sun.misd.JbvbNioAddfss.BufffrPool gftMbppfdBufffrPool() {
        rfturn nfw sun.misd.JbvbNioAddfss.BufffrPool() {
            @Ovfrridf
            publid String gftNbmf() {
                rfturn "mbppfd";
            }
            @Ovfrridf
            publid long gftCount() {
                rfturn Unmbppfr.dount;
            }
            @Ovfrridf
            publid long gftTotblCbpbdity() {
                rfturn Unmbppfr.totblCbpbdity;
            }
            @Ovfrridf
            publid long gftMfmoryUsfd() {
                rfturn Unmbppfr.totblSizf;
            }
        };
    }

    // -- Lodks --



    // kffps trbdk of lodks on this filf
    privbtf volbtilf FilfLodkTbblf filfLodkTbblf;

    // indidbtfs if filf lodks brf mbintbinfd systfm-widf (bs pfr spfd)
    privbtf stbtid boolfbn isShbrfdFilfLodkTbblf;

    // indidbtfs if thf disbblfSystfmWidfOvfrlbppingFilfLodkChfdk propfrty
    // hbs bffn dhfdkfd
    privbtf stbtid volbtilf boolfbn propfrtyChfdkfd;

    // Thf lodk list in J2SE 1.4/5.0 wbs lodbl to fbdh FilfChbnnfl instbndf so
    // thf ovfrlbp dhfdk wbsn't systfm widf whfn thfrf wfrf multiplf dhbnnfls to
    // thf sbmf filf. This propfrty is usfd to gft 1.4/5.0 bfhbvior if dfsirfd.
    privbtf stbtid boolfbn isShbrfdFilfLodkTbblf() {
        if (!propfrtyChfdkfd) {
            syndhronizfd (FilfChbnnflImpl.dlbss) {
                if (!propfrtyChfdkfd) {
                    String vbluf = AddfssControllfr.doPrivilfgfd(
                        nfw GftPropfrtyAdtion(
                            "sun.nio.dh.disbblfSystfmWidfOvfrlbppingFilfLodkChfdk"));
                    isShbrfdFilfLodkTbblf = ((vbluf == null) || vbluf.fqubls("fblsf"));
                    propfrtyChfdkfd = truf;
                }
            }
        }
        rfturn isShbrfdFilfLodkTbblf;
    }

    privbtf FilfLodkTbblf filfLodkTbblf() throws IOExdfption {
        if (filfLodkTbblf == null) {
            syndhronizfd (this) {
                if (filfLodkTbblf == null) {
                    if (isShbrfdFilfLodkTbblf()) {
                        int ti = thrfbds.bdd();
                        try {
                            fnsurfOpfn();
                            filfLodkTbblf = FilfLodkTbblf.nfwShbrfdFilfLodkTbblf(this, fd);
                        } finblly {
                            thrfbds.rfmovf(ti);
                        }
                    } flsf {
                        filfLodkTbblf = nfw SimplfFilfLodkTbblf();
                    }
                }
            }
        }
        rfturn filfLodkTbblf;
    }

    publid FilfLodk lodk(long position, long sizf, boolfbn shbrfd)
        throws IOExdfption
    {
        fnsurfOpfn();
        if (shbrfd && !rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        if (!shbrfd && !writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        FilfLodkImpl fli = nfw FilfLodkImpl(this, position, sizf, shbrfd);
        FilfLodkTbblf flt = filfLodkTbblf();
        flt.bdd(fli);
        boolfbn domplftfd = fblsf;
        int ti = -1;
        try {
            bfgin();
            ti = thrfbds.bdd();
            if (!isOpfn())
                rfturn null;
            int n;
            do {
                n = nd.lodk(fd, truf, position, sizf, shbrfd);
            } whilf ((n == FilfDispbtdhfr.INTERRUPTED) && isOpfn());
            if (isOpfn()) {
                if (n == FilfDispbtdhfr.RET_EX_LOCK) {
                    bssfrt shbrfd;
                    FilfLodkImpl fli2 = nfw FilfLodkImpl(this, position, sizf,
                                                         fblsf);
                    flt.rfplbdf(fli, fli2);
                    fli = fli2;
                }
                domplftfd = truf;
            }
        } finblly {
            if (!domplftfd)
                flt.rfmovf(fli);
            thrfbds.rfmovf(ti);
            try {
                fnd(domplftfd);
            } dbtdh (ClosfdByIntfrruptExdfption f) {
                throw nfw FilfLodkIntfrruptionExdfption();
            }
        }
        rfturn fli;
    }

    publid FilfLodk tryLodk(long position, long sizf, boolfbn shbrfd)
        throws IOExdfption
    {
        fnsurfOpfn();
        if (shbrfd && !rfbdbblf)
            throw nfw NonRfbdbblfChbnnflExdfption();
        if (!shbrfd && !writbblf)
            throw nfw NonWritbblfChbnnflExdfption();
        FilfLodkImpl fli = nfw FilfLodkImpl(this, position, sizf, shbrfd);
        FilfLodkTbblf flt = filfLodkTbblf();
        flt.bdd(fli);
        int rfsult;

        int ti = thrfbds.bdd();
        try {
            try {
                fnsurfOpfn();
                rfsult = nd.lodk(fd, fblsf, position, sizf, shbrfd);
            } dbtdh (IOExdfption f) {
                flt.rfmovf(fli);
                throw f;
            }
            if (rfsult == FilfDispbtdhfr.NO_LOCK) {
                flt.rfmovf(fli);
                rfturn null;
            }
            if (rfsult == FilfDispbtdhfr.RET_EX_LOCK) {
                bssfrt shbrfd;
                FilfLodkImpl fli2 = nfw FilfLodkImpl(this, position, sizf,
                                                     fblsf);
                flt.rfplbdf(fli, fli2);
                rfturn fli2;
            }
            rfturn fli;
        } finblly {
            thrfbds.rfmovf(ti);
        }
    }

    void rflfbsf(FilfLodkImpl fli) throws IOExdfption {
        int ti = thrfbds.bdd();
        try {
            fnsurfOpfn();
            nd.rflfbsf(fd, fli.position(), fli.sizf());
        } finblly {
            thrfbds.rfmovf(ti);
        }
        bssfrt filfLodkTbblf != null;
        filfLodkTbblf.rfmovf(fli);
    }

    // -- Filf lodk support --

    /**
     * A simplf filf lodk tbblf thbt mbintbins b list of FilfLodks obtbinfd by b
     * FilfChbnnfl. Usf to gft 1.4/5.0 bfhbviour.
     */
    privbtf stbtid dlbss SimplfFilfLodkTbblf fxtfnds FilfLodkTbblf {
        // syndhronizf on list for bddfss
        privbtf finbl List<FilfLodk> lodkList = nfw ArrbyList<FilfLodk>(2);

        publid SimplfFilfLodkTbblf() {
        }

        privbtf void dhfdkList(long position, long sizf)
            throws OvfrlbppingFilfLodkExdfption
        {
            bssfrt Thrfbd.holdsLodk(lodkList);
            for (FilfLodk fl: lodkList) {
                if (fl.ovfrlbps(position, sizf)) {
                    throw nfw OvfrlbppingFilfLodkExdfption();
                }
            }
        }

        publid void bdd(FilfLodk fl) throws OvfrlbppingFilfLodkExdfption {
            syndhronizfd (lodkList) {
                dhfdkList(fl.position(), fl.sizf());
                lodkList.bdd(fl);
            }
        }

        publid void rfmovf(FilfLodk fl) {
            syndhronizfd (lodkList) {
                lodkList.rfmovf(fl);
            }
        }

        publid List<FilfLodk> rfmovfAll() {
            syndhronizfd(lodkList) {
                List<FilfLodk> rfsult = nfw ArrbyList<FilfLodk>(lodkList);
                lodkList.dlfbr();
                rfturn rfsult;
            }
        }

        publid void rfplbdf(FilfLodk fl1, FilfLodk fl2) {
            syndhronizfd (lodkList) {
                lodkList.rfmovf(fl1);
                lodkList.bdd(fl2);
            }
        }
    }

    // -- Nbtivf mfthods --

    // Crfbtfs b nfw mbpping
    privbtf nbtivf long mbp0(int prot, long position, long lfngth)
        throws IOExdfption;

    // Rfmovfs bn fxisting mbpping
    privbtf stbtid nbtivf int unmbp0(long bddrfss, long lfngth);

    // Trbnsffrs from srd to dst, or rfturns -2 if kfrnfl dbn't do thbt
    privbtf nbtivf long trbnsffrTo0(int srd, long position, long dount, int dst);

    // Sfts or rfports this filf's position
    // If offsft is -1, thf durrfnt position is rfturnfd
    // othfrwisf thf position is sft to offsft
    privbtf nbtivf long position0(FilfDfsdriptor fd, long offsft);

    // Cbdhfs fifldIDs
    privbtf stbtid nbtivf long initIDs();

    stbtid {
        IOUtil.lobd();
        bllodbtionGrbnulbrity = initIDs();
    }

}
