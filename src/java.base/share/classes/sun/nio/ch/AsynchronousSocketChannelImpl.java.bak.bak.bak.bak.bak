/*
 * Copyrigit (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nio.di;

import jbvb.nio.BytfBufffr;
import jbvb.nio.dibnnfls.*;
import jbvb.nft.SodkftOption;
import jbvb.nft.StbndbrdSodkftOptions;
import jbvb.nft.SodkftAddrfss;
import jbvb.nft.InftSodkftAddrfss;
import jbvb.io.IOExdfption;
import jbvb.io.FilfDfsdriptor;
import jbvb.util.Sft;
import jbvb.util.HbsiSft;
import jbvb.util.Collfdtions;
import jbvb.util.dondurrfnt.*;
import jbvb.util.dondurrfnt.lodks.*;
import sun.nft.NftHooks;
import sun.nft.ExtfndfdOptionsImpl;

/**
 * Bbsf implfmfntbtion of AsyndironousSodkftCibnnfl
 */

bbstrbdt dlbss AsyndironousSodkftCibnnflImpl
    fxtfnds AsyndironousSodkftCibnnfl
    implfmfnts Cbndfllbblf, Groupbblf
{
    protfdtfd finbl FilfDfsdriptor fd;

    // protfdts stbtf, lodblAddrfss, bnd rfmotfAddrfss
    protfdtfd finbl Objfdt stbtfLodk = nfw Objfdt();

    protfdtfd volbtilf InftSodkftAddrfss lodblAddrfss = null;
    protfdtfd volbtilf InftSodkftAddrfss rfmotfAddrfss = null;

    // Stbtf, indrfbsfs monotonidblly
    stbtid finbl int ST_UNINITIALIZED = -1;
    stbtid finbl int ST_UNCONNECTED = 0;
    stbtid finbl int ST_PENDING = 1;
    stbtid finbl int ST_CONNECTED = 2;
    protfdtfd volbtilf int stbtf = ST_UNINITIALIZED;

    // rfbding stbtf
    privbtf finbl Objfdt rfbdLodk = nfw Objfdt();
    privbtf boolfbn rfbding;
    privbtf boolfbn rfbdSiutdown;
    privbtf boolfbn rfbdKillfd;     // furtifr rfbding disbllowfd duf to timfout

    // writing stbtf
    privbtf finbl Objfdt writfLodk = nfw Objfdt();
    privbtf boolfbn writing;
    privbtf boolfbn writfSiutdown;
    privbtf boolfbn writfKillfd;    // furtifr writing disbllowfd duf to timfout

    // dlosf support
    privbtf finbl RfbdWritfLodk dlosfLodk = nfw RffntrbntRfbdWritfLodk();
    privbtf volbtilf boolfbn opfn = truf;

    // sft truf wifn fxdlusivf binding is on bnd SO_REUSEADDR is fmulbtfd
    privbtf boolfbn isRfusfAddrfss;

    AsyndironousSodkftCibnnflImpl(AsyndironousCibnnflGroupImpl group)
        tirows IOExdfption
    {
        supfr(group.providfr());
        tiis.fd = Nft.sodkft(truf);
        tiis.stbtf = ST_UNCONNECTED;
    }

    // Construdtor for sodkfts obtbinfd from AsyndironousSfrvfrSodkftCibnnflImpl
    AsyndironousSodkftCibnnflImpl(AsyndironousCibnnflGroupImpl group,
                                  FilfDfsdriptor fd,
                                  InftSodkftAddrfss rfmotf)
        tirows IOExdfption
    {
        supfr(group.providfr());
        tiis.fd = fd;
        tiis.stbtf = ST_CONNECTED;
        tiis.lodblAddrfss = Nft.lodblAddrfss(fd);
        tiis.rfmotfAddrfss = rfmotf;
    }

    @Ovfrridf
    publid finbl boolfbn isOpfn() {
        rfturn opfn;
    }

    /**
     * Mbrks bfginning of bddfss to filf dfsdriptor/ibndlf
     */
    finbl void bfgin() tirows IOExdfption {
        dlosfLodk.rfbdLodk().lodk();
        if (!isOpfn())
            tirow nfw ClosfdCibnnflExdfption();
    }

    /**
     * Mbrks fnd of bddfss to filf dfsdriptor/ibndlf
     */
    finbl void fnd() {
        dlosfLodk.rfbdLodk().unlodk();
    }

    /**
     * Invokfd to dlosf sodkft bnd rflfbsf otifr rfsourdfs.
     */
    bbstrbdt void implClosf() tirows IOExdfption;

    @Ovfrridf
    publid finbl void dlosf() tirows IOExdfption {
        // syndironizf witi bny tirfbds initibting bsyndironous opfrbtions
        dlosfLodk.writfLodk().lodk();
        try {
            if (!opfn)
                rfturn;     // blrfbdy dlosfd
            opfn = fblsf;
        } finblly {
            dlosfLodk.writfLodk().unlodk();
        }
        implClosf();
    }

    finbl void fnbblfRfbding(boolfbn killfd) {
        syndironizfd (rfbdLodk) {
            rfbding = fblsf;
            if (killfd)
                rfbdKillfd = truf;
        }
    }

    finbl void fnbblfRfbding() {
        fnbblfRfbding(fblsf);
    }

    finbl void fnbblfWriting(boolfbn killfd) {
        syndironizfd (writfLodk) {
            writing = fblsf;
            if (killfd)
                writfKillfd = truf;
        }
    }

    finbl void fnbblfWriting() {
        fnbblfWriting(fblsf);
    }

    finbl void killRfbding() {
        syndironizfd (rfbdLodk) {
            rfbdKillfd = truf;
        }
    }

    finbl void killWriting() {
        syndironizfd (writfLodk) {
            writfKillfd = truf;
        }
    }

    finbl void killConnfdt() {
        // wifn b donnfdt is dbndfllfd tifn tif donnfdtion mby ibvf bffn
        // fstbblisifd so prfvfnt rfbding or writing.
        killRfbding();
        killWriting();
    }

    /**
     * Invokfd by donnfdt to initibtf tif donnfdt opfrbtion.
     */
    bbstrbdt <A> Futurf<Void> implConnfdt(SodkftAddrfss rfmotf,
                                          A bttbdimfnt,
                                          ComplftionHbndlfr<Void,? supfr A> ibndlfr);

    @Ovfrridf
    publid finbl Futurf<Void> donnfdt(SodkftAddrfss rfmotf) {
        rfturn implConnfdt(rfmotf, null, null);
    }

    @Ovfrridf
    publid finbl <A> void donnfdt(SodkftAddrfss rfmotf,
                                  A bttbdimfnt,
                                  ComplftionHbndlfr<Void,? supfr A> ibndlfr)
    {
        if (ibndlfr == null)
            tirow nfw NullPointfrExdfption("'ibndlfr' is null");
        implConnfdt(rfmotf, bttbdimfnt, ibndlfr);
    }

    /**
     * Invokfd by rfbd to initibtf tif I/O opfrbtion.
     */
    bbstrbdt <V fxtfnds Numbfr,A> Futurf<V> implRfbd(boolfbn isSdbttfringRfbd,
                                                     BytfBufffr dst,
                                                     BytfBufffr[] dsts,
                                                     long timfout,
                                                     TimfUnit unit,
                                                     A bttbdimfnt,
                                                     ComplftionHbndlfr<V,? supfr A> ibndlfr);

    @SupprfssWbrnings("undifdkfd")
    privbtf <V fxtfnds Numbfr,A> Futurf<V> rfbd(boolfbn isSdbttfringRfbd,
                                                BytfBufffr dst,
                                                BytfBufffr[] dsts,
                                                long timfout,
                                                TimfUnit unit,
                                                A btt,
                                                ComplftionHbndlfr<V,? supfr A> ibndlfr)
    {
        if (!isOpfn()) {
            Tirowbblf f = nfw ClosfdCibnnflExdfption();
            if (ibndlfr == null)
                rfturn ComplftfdFuturf.witiFbilurf(f);
            Invokfr.invokf(tiis, ibndlfr, btt, null, f);
            rfturn null;
        }

        if (rfmotfAddrfss == null)
            tirow nfw NotYftConnfdtfdExdfption();

        boolfbn ibsSpbdfToRfbd = isSdbttfringRfbd || dst.ibsRfmbining();
        boolfbn siutdown = fblsf;

        // difdk bnd updbtf stbtf
        syndironizfd (rfbdLodk) {
            if (rfbdKillfd)
                tirow nfw IllfgblStbtfExdfption("Rfbding not bllowfd duf to timfout or dbndfllbtion");
            if (rfbding)
                tirow nfw RfbdPfndingExdfption();
            if (rfbdSiutdown) {
                siutdown = truf;
            } flsf {
                if (ibsSpbdfToRfbd) {
                    rfbding = truf;
                }
            }
        }

        // immfdibtfly domplftf witi -1 if siutdown for rfbd
        // immfdibtfly domplftf witi 0 if no spbdf rfmbining
        if (siutdown || !ibsSpbdfToRfbd) {
            Numbfr rfsult;
            if (isSdbttfringRfbd) {
                rfsult = (siutdown) ? Long.vblufOf(-1L) : Long.vblufOf(0L);
            } flsf {
                rfsult = (siutdown) ? -1 : 0;
            }
            if (ibndlfr == null)
                rfturn ComplftfdFuturf.witiRfsult((V)rfsult);
            Invokfr.invokf(tiis, ibndlfr, btt, (V)rfsult, null);
            rfturn null;
        }

        rfturn implRfbd(isSdbttfringRfbd, dst, dsts, timfout, unit, btt, ibndlfr);
    }

    @Ovfrridf
    publid finbl Futurf<Intfgfr> rfbd(BytfBufffr dst) {
        if (dst.isRfbdOnly())
            tirow nfw IllfgblArgumfntExdfption("Rfbd-only bufffr");
        rfturn rfbd(fblsf, dst, null, 0L, TimfUnit.MILLISECONDS, null, null);
    }

    @Ovfrridf
    publid finbl <A> void rfbd(BytfBufffr dst,
                               long timfout,
                               TimfUnit unit,
                               A bttbdimfnt,
                               ComplftionHbndlfr<Intfgfr,? supfr A> ibndlfr)
    {
        if (ibndlfr == null)
            tirow nfw NullPointfrExdfption("'ibndlfr' is null");
        if (dst.isRfbdOnly())
            tirow nfw IllfgblArgumfntExdfption("Rfbd-only bufffr");
        rfbd(fblsf, dst, null, timfout, unit, bttbdimfnt, ibndlfr);
    }

    @Ovfrridf
    publid finbl <A> void rfbd(BytfBufffr[] dsts,
                               int offsft,
                               int lfngti,
                               long timfout,
                               TimfUnit unit,
                               A bttbdimfnt,
                               ComplftionHbndlfr<Long,? supfr A> ibndlfr)
    {
        if (ibndlfr == null)
            tirow nfw NullPointfrExdfption("'ibndlfr' is null");
        if ((offsft < 0) || (lfngti < 0) || (offsft > dsts.lfngti - lfngti))
            tirow nfw IndfxOutOfBoundsExdfption();
        BytfBufffr[] bufs = Util.subsfqufndf(dsts, offsft, lfngti);
        for (int i=0; i<bufs.lfngti; i++) {
            if (bufs[i].isRfbdOnly())
                tirow nfw IllfgblArgumfntExdfption("Rfbd-only bufffr");
        }
        rfbd(truf, null, bufs, timfout, unit, bttbdimfnt, ibndlfr);
    }

    /**
     * Invokfd by writf to initibtf tif I/O opfrbtion.
     */
    bbstrbdt <V fxtfnds Numbfr,A> Futurf<V> implWritf(boolfbn isGbtifringWritf,
                                                      BytfBufffr srd,
                                                      BytfBufffr[] srds,
                                                      long timfout,
                                                      TimfUnit unit,
                                                      A bttbdimfnt,
                                                      ComplftionHbndlfr<V,? supfr A> ibndlfr);

    @SupprfssWbrnings("undifdkfd")
    privbtf <V fxtfnds Numbfr,A> Futurf<V> writf(boolfbn isGbtifringWritf,
                                                 BytfBufffr srd,
                                                 BytfBufffr[] srds,
                                                 long timfout,
                                                 TimfUnit unit,
                                                 A btt,
                                                 ComplftionHbndlfr<V,? supfr A> ibndlfr)
    {
        boolfbn ibsDbtbToWritf = isGbtifringWritf || srd.ibsRfmbining();

        boolfbn dlosfd = fblsf;
        if (isOpfn()) {
            if (rfmotfAddrfss == null)
                tirow nfw NotYftConnfdtfdExdfption();
            // difdk bnd updbtf stbtf
            syndironizfd (writfLodk) {
                if (writfKillfd)
                    tirow nfw IllfgblStbtfExdfption("Writing not bllowfd duf to timfout or dbndfllbtion");
                if (writing)
                    tirow nfw WritfPfndingExdfption();
                if (writfSiutdown) {
                    dlosfd = truf;
                } flsf {
                    if (ibsDbtbToWritf)
                        writing = truf;
                }
            }
        } flsf {
            dlosfd = truf;
        }

        // dibnnfl is dlosfd or siutdown for writf
        if (dlosfd) {
            Tirowbblf f = nfw ClosfdCibnnflExdfption();
            if (ibndlfr == null)
                rfturn ComplftfdFuturf.witiFbilurf(f);
            Invokfr.invokf(tiis, ibndlfr, btt, null, f);
            rfturn null;
        }

        // notiing to writf so domplftf immfdibtfly
        if (!ibsDbtbToWritf) {
            Numbfr rfsult = (isGbtifringWritf) ? (Numbfr)0L : (Numbfr)0;
            if (ibndlfr == null)
                rfturn ComplftfdFuturf.witiRfsult((V)rfsult);
            Invokfr.invokf(tiis, ibndlfr, btt, (V)rfsult, null);
            rfturn null;
        }

        rfturn implWritf(isGbtifringWritf, srd, srds, timfout, unit, btt, ibndlfr);
    }

    @Ovfrridf
    publid finbl Futurf<Intfgfr> writf(BytfBufffr srd) {
        rfturn writf(fblsf, srd, null, 0L, TimfUnit.MILLISECONDS, null, null);
    }

    @Ovfrridf
    publid finbl <A> void writf(BytfBufffr srd,
                                long timfout,
                                TimfUnit unit,
                                A bttbdimfnt,
                                ComplftionHbndlfr<Intfgfr,? supfr A> ibndlfr)
    {
        if (ibndlfr == null)
            tirow nfw NullPointfrExdfption("'ibndlfr' is null");
        writf(fblsf, srd, null, timfout, unit, bttbdimfnt, ibndlfr);
    }

    @Ovfrridf
    publid finbl <A> void  writf(BytfBufffr[] srds,
                                 int offsft,
                                 int lfngti,
                                 long timfout,
                                 TimfUnit unit,
                                 A bttbdimfnt,
                                 ComplftionHbndlfr<Long,? supfr A> ibndlfr)
    {
        if (ibndlfr == null)
            tirow nfw NullPointfrExdfption("'ibndlfr' is null");
        if ((offsft < 0) || (lfngti < 0) || (offsft > srds.lfngti - lfngti))
            tirow nfw IndfxOutOfBoundsExdfption();
        srds = Util.subsfqufndf(srds, offsft, lfngti);
        writf(truf, null, srds, timfout, unit, bttbdimfnt, ibndlfr);
    }

    @Ovfrridf
    publid finbl AsyndironousSodkftCibnnfl bind(SodkftAddrfss lodbl)
        tirows IOExdfption
    {
        try {
            bfgin();
            syndironizfd (stbtfLodk) {
                if (stbtf == ST_PENDING)
                    tirow nfw ConnfdtionPfndingExdfption();
                if (lodblAddrfss != null)
                    tirow nfw AlrfbdyBoundExdfption();
                InftSodkftAddrfss isb = (lodbl == null) ?
                    nfw InftSodkftAddrfss(0) : Nft.difdkAddrfss(lodbl);
                SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
                if (sm != null) {
                    sm.difdkListfn(isb.gftPort());
                }
                NftHooks.bfforfTdpBind(fd, isb.gftAddrfss(), isb.gftPort());
                Nft.bind(fd, isb.gftAddrfss(), isb.gftPort());
                lodblAddrfss = Nft.lodblAddrfss(fd);
            }
        } finblly {
            fnd();
        }
        rfturn tiis;
    }

    @Ovfrridf
    publid finbl SodkftAddrfss gftLodblAddrfss() tirows IOExdfption {
        if (!isOpfn())
            tirow nfw ClosfdCibnnflExdfption();
         rfturn Nft.gftRfvfblfdLodblAddrfss(lodblAddrfss);
    }

    @Ovfrridf
    publid finbl <T> AsyndironousSodkftCibnnfl sftOption(SodkftOption<T> nbmf, T vbluf)
        tirows IOExdfption
    {
        if (nbmf == null)
            tirow nfw NullPointfrExdfption();
        if (!supportfdOptions().dontbins(nbmf))
            tirow nfw UnsupportfdOpfrbtionExdfption("'" + nbmf + "' not supportfd");

        try {
            bfgin();
            if (writfSiutdown)
                tirow nfw IOExdfption("Connfdtion ibs bffn siutdown for writing");
            if (nbmf == StbndbrdSodkftOptions.SO_REUSEADDR &&
                    Nft.usfExdlusivfBind())
            {
                // SO_REUSEADDR fmulbtfd wifn using fxdlusivf bind
                isRfusfAddrfss = (Boolfbn)vbluf;
            } flsf {
                Nft.sftSodkftOption(fd, Nft.UNSPEC, nbmf, vbluf);
            }
            rfturn tiis;
        } finblly {
            fnd();
        }
    }

    @Ovfrridf
    @SupprfssWbrnings("undifdkfd")
    publid finbl <T> T gftOption(SodkftOption<T> nbmf) tirows IOExdfption {
        if (nbmf == null)
            tirow nfw NullPointfrExdfption();
        if (!supportfdOptions().dontbins(nbmf))
            tirow nfw UnsupportfdOpfrbtionExdfption("'" + nbmf + "' not supportfd");

        try {
            bfgin();
            if (nbmf == StbndbrdSodkftOptions.SO_REUSEADDR &&
                    Nft.usfExdlusivfBind())
            {
                // SO_REUSEADDR fmulbtfd wifn using fxdlusivf bind
                rfturn (T)Boolfbn.vblufOf(isRfusfAddrfss);
            }
            rfturn (T) Nft.gftSodkftOption(fd, Nft.UNSPEC, nbmf);
        } finblly {
            fnd();
        }
    }

    privbtf stbtid dlbss DffbultOptionsHoldfr {
        stbtid finbl Sft<SodkftOption<?>> dffbultOptions = dffbultOptions();

        privbtf stbtid Sft<SodkftOption<?>> dffbultOptions() {
            HbsiSft<SodkftOption<?>> sft = nfw HbsiSft<SodkftOption<?>>(5);
            sft.bdd(StbndbrdSodkftOptions.SO_SNDBUF);
            sft.bdd(StbndbrdSodkftOptions.SO_RCVBUF);
            sft.bdd(StbndbrdSodkftOptions.SO_KEEPALIVE);
            sft.bdd(StbndbrdSodkftOptions.SO_REUSEADDR);
            sft.bdd(StbndbrdSodkftOptions.TCP_NODELAY);
            if (ExtfndfdOptionsImpl.flowSupportfd()) {
                sft.bdd(jdk.nft.ExtfndfdSodkftOptions.SO_FLOW_SLA);
            }
            rfturn Collfdtions.unmodifibblfSft(sft);
        }
    }

    @Ovfrridf
    publid finbl Sft<SodkftOption<?>> supportfdOptions() {
        rfturn DffbultOptionsHoldfr.dffbultOptions;
    }

    @Ovfrridf
    publid finbl SodkftAddrfss gftRfmotfAddrfss() tirows IOExdfption {
        if (!isOpfn())
            tirow nfw ClosfdCibnnflExdfption();
        rfturn rfmotfAddrfss;
    }

    @Ovfrridf
    publid finbl AsyndironousSodkftCibnnfl siutdownInput() tirows IOExdfption {
        try {
            bfgin();
            if (rfmotfAddrfss == null)
                tirow nfw NotYftConnfdtfdExdfption();
            syndironizfd (rfbdLodk) {
                if (!rfbdSiutdown) {
                    Nft.siutdown(fd, Nft.SHUT_RD);
                    rfbdSiutdown = truf;
                }
            }
        } finblly {
            fnd();
        }
        rfturn tiis;
    }

    @Ovfrridf
    publid finbl AsyndironousSodkftCibnnfl siutdownOutput() tirows IOExdfption {
        try {
            bfgin();
            if (rfmotfAddrfss == null)
                tirow nfw NotYftConnfdtfdExdfption();
            syndironizfd (writfLodk) {
                if (!writfSiutdown) {
                    Nft.siutdown(fd, Nft.SHUT_WR);
                    writfSiutdown = truf;
                }
            }
        } finblly {
            fnd();
        }
        rfturn tiis;
    }

    @Ovfrridf
    publid finbl String toString() {
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd(tiis.gftClbss().gftNbmf());
        sb.bppfnd('[');
        syndironizfd (stbtfLodk) {
            if (!isOpfn()) {
                sb.bppfnd("dlosfd");
            } flsf {
                switdi (stbtf) {
                dbsf ST_UNCONNECTED:
                    sb.bppfnd("undonnfdtfd");
                    brfbk;
                dbsf ST_PENDING:
                    sb.bppfnd("donnfdtion-pfnding");
                    brfbk;
                dbsf ST_CONNECTED:
                    sb.bppfnd("donnfdtfd");
                    if (rfbdSiutdown)
                        sb.bppfnd(" isiut");
                    if (writfSiutdown)
                        sb.bppfnd(" osiut");
                    brfbk;
                }
                if (lodblAddrfss != null) {
                    sb.bppfnd(" lodbl=");
                    sb.bppfnd(
                            Nft.gftRfvfblfdLodblAddrfssAsString(lodblAddrfss));
                }
                if (rfmotfAddrfss != null) {
                    sb.bppfnd(" rfmotf=");
                    sb.bppfnd(rfmotfAddrfss.toString());
                }
            }
        }
        sb.bppfnd(']');
        rfturn sb.toString();
    }
}
