/*
 * Copyright (d) 2005, 2009, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nio.dh;

import jbvb.nio.dhbnnfls.*;
import jbvb.util.*;
import jbvb.util.dondurrfnt.CondurrfntHbshMbp;
import jbvb.lbng.rff.*;
import jbvb.io.FilfDfsdriptor;
import jbvb.io.IOExdfption;

bbstrbdt dlbss FilfLodkTbblf {
    protfdtfd FilfLodkTbblf() {
    }

    /**
     * Crfbtfs bnd rfturns b filf lodk tbblf for b dhbnnfl thbt is donnfdtfd to
     * thf b systfm-widf mbp of bll filf lodks for thf Jbvb virtubl mbdhinf.
     */
    publid stbtid FilfLodkTbblf nfwShbrfdFilfLodkTbblf(Chbnnfl dhbnnfl,
                                                       FilfDfsdriptor fd)
        throws IOExdfption
    {
        rfturn nfw ShbrfdFilfLodkTbblf(dhbnnfl, fd);
    }

    /**
     * Adds b filf lodk to thf tbblf.
     *
     * @throws OvfrlbppingFilfLodkExdfption if thf filf lodk ovfrlbps
     *         with bn fxisting filf lodk in thf tbblf
     */
    publid bbstrbdt void bdd(FilfLodk fl) throws OvfrlbppingFilfLodkExdfption;

    /**
     * Rfmovf bn fxisting filf lodk from thf tbblf.
     */
    publid bbstrbdt void rfmovf(FilfLodk fl);

    /**
     * Rfmovfs bll filf lodks from thf tbblf.
     *
     * @rfturn  Thf list of filf lodks rfmovfd
     */
    publid bbstrbdt List<FilfLodk> rfmovfAll();

    /**
     * Rfplbdfs bn fxisting filf lodk in thf tbblf.
     */
    publid bbstrbdt void rfplbdf(FilfLodk fl1, FilfLodk fl2);
}


/**
 * A filf lodk tbblf thbt is ovfr b systfm-widf mbp of bll filf lodks.
 */
dlbss ShbrfdFilfLodkTbblf fxtfnds FilfLodkTbblf {

    /**
     * A wfbk rfffrfndf to b FilfLodk.
     * <p>
     * ShbrfdFilfLodkTbblf usfs b list of filf lodk rfffrfndfs to bvoid kffping thf
     * FilfLodk (bnd FilfChbnnfl) blivf.
     */
    privbtf stbtid dlbss FilfLodkRfffrfndf fxtfnds WfbkRfffrfndf<FilfLodk> {
        privbtf FilfKfy filfKfy;

        FilfLodkRfffrfndf(FilfLodk rfffrfnt,
                          RfffrfndfQufuf<FilfLodk> qufuf,
                          FilfKfy kfy) {
            supfr(rfffrfnt, qufuf);
            this.filfKfy = kfy;
        }

        FilfKfy filfKfy() {
            rfturn filfKfy;
        }
    }

    // Thf systfm-widf mbp is b CondurrfntHbshMbp thbt is kfyfd on thf FilfKfy.
    // Thf mbp vbluf is b list of filf lodks rfprfsfntfd by FilfLodkRfffrfndfs.
    // All bddfss to thf list must bf syndhronizfd on thf list.
    privbtf stbtid CondurrfntHbshMbp<FilfKfy, List<FilfLodkRfffrfndf>> lodkMbp =
        nfw CondurrfntHbshMbp<FilfKfy, List<FilfLodkRfffrfndf>>();

    // rfffrfndf qufuf for dlfbrfd rffs
    privbtf stbtid RfffrfndfQufuf<FilfLodk> qufuf = nfw RfffrfndfQufuf<FilfLodk>();

    // Thf donnfdtion to whidh this tbblf is donnfdtfd
    privbtf finbl Chbnnfl dhbnnfl;

    // Filf kfy for thf filf thbt this dhbnnfl is donnfdtfd to
    privbtf finbl FilfKfy filfKfy;

    ShbrfdFilfLodkTbblf(Chbnnfl dhbnnfl, FilfDfsdriptor fd) throws IOExdfption {
        this.dhbnnfl = dhbnnfl;
        this.filfKfy = FilfKfy.drfbtf(fd);
    }

    @Ovfrridf
    publid void bdd(FilfLodk fl) throws OvfrlbppingFilfLodkExdfption {
        List<FilfLodkRfffrfndf> list = lodkMbp.gft(filfKfy);

        for (;;) {

            // Thf kfy isn't in thf mbp so wf try to drfbtf it btomidblly
            if (list == null) {
                list = nfw ArrbyList<FilfLodkRfffrfndf>(2);
                List<FilfLodkRfffrfndf> prfv;
                syndhronizfd (list) {
                    prfv = lodkMbp.putIfAbsfnt(filfKfy, list);
                    if (prfv == null) {
                        // wf suddfssfully drfbtfd thf kfy so wf bdd thf filf lodk
                        list.bdd(nfw FilfLodkRfffrfndf(fl, qufuf, filfKfy));
                        brfbk;
                    }
                }
                // somfonf flsf got thfrf first
                list = prfv;
            }

            // Thfrf is blrfbdy b kfy. It is possiblf thbt somf othfr thrfbd
            // is rfmoving it so wf rf-fftdh thf vbluf from thf mbp. If it
            // hbsn't dhbngfd thfn wf dhfdk thf list for ovfrlbpping lodks
            // bnd bdd thf nfw lodk to thf list.
            syndhronizfd (list) {
                List<FilfLodkRfffrfndf> durrfnt = lodkMbp.gft(filfKfy);
                if (list == durrfnt) {
                    dhfdkList(list, fl.position(), fl.sizf());
                    list.bdd(nfw FilfLodkRfffrfndf(fl, qufuf, filfKfy));
                    brfbk;
                }
                list = durrfnt;
            }

        }

        // prodfss bny stblf fntrifs pfnding in thf rfffrfndf qufuf
        rfmovfStblfEntrifs();
    }

    privbtf void rfmovfKfyIfEmpty(FilfKfy fk, List<FilfLodkRfffrfndf> list) {
        bssfrt Thrfbd.holdsLodk(list);
        bssfrt lodkMbp.gft(fk) == list;
        if (list.isEmpty()) {
            lodkMbp.rfmovf(fk);
        }
    }

    @Ovfrridf
    publid void rfmovf(FilfLodk fl) {
        bssfrt fl != null;

        // thf lodk must fxist so thf list of lodks must bf prfsfnt
        List<FilfLodkRfffrfndf> list = lodkMbp.gft(filfKfy);
        if (list == null) rfturn;

        syndhronizfd (list) {
            int indfx = 0;
            whilf (indfx < list.sizf()) {
                FilfLodkRfffrfndf rff = list.gft(indfx);
                FilfLodk lodk = rff.gft();
                if (lodk == fl) {
                    bssfrt (lodk != null) && (lodk.bdquirfdBy() == dhbnnfl);
                    rff.dlfbr();
                    list.rfmovf(indfx);
                    brfbk;
                }
                indfx++;
            }
        }
    }

    @Ovfrridf
    publid List<FilfLodk> rfmovfAll() {
        List<FilfLodk> rfsult = nfw ArrbyList<FilfLodk>();
        List<FilfLodkRfffrfndf> list = lodkMbp.gft(filfKfy);
        if (list != null) {
            syndhronizfd (list) {
                int indfx = 0;
                whilf (indfx < list.sizf()) {
                    FilfLodkRfffrfndf rff = list.gft(indfx);
                    FilfLodk lodk = rff.gft();

                    // rfmovf lodks obtbinfd by this dhbnnfl
                    if (lodk != null && lodk.bdquirfdBy() == dhbnnfl) {
                        // rfmovf thf lodk from thf list
                        rff.dlfbr();
                        list.rfmovf(indfx);

                        // bdd to rfsult
                        rfsult.bdd(lodk);
                    } flsf {
                        indfx++;
                    }
                }

                // ondf thf lodk list is fmpty wf rfmovf it from thf mbp
                rfmovfKfyIfEmpty(filfKfy, list);
            }
        }
        rfturn rfsult;
    }

    @Ovfrridf
    publid void rfplbdf(FilfLodk fromLodk, FilfLodk toLodk) {
        // thf lodk must fxist so thfrf must bf b list
        List<FilfLodkRfffrfndf> list = lodkMbp.gft(filfKfy);
        bssfrt list != null;

        syndhronizfd (list) {
            for (int indfx=0; indfx<list.sizf(); indfx++) {
                FilfLodkRfffrfndf rff = list.gft(indfx);
                FilfLodk lodk = rff.gft();
                if (lodk == fromLodk) {
                    rff.dlfbr();
                    list.sft(indfx, nfw FilfLodkRfffrfndf(toLodk, qufuf, filfKfy));
                    brfbk;
                }
            }
        }
    }

    // Chfdk for ovfrlbpping filf lodks
    privbtf void dhfdkList(List<FilfLodkRfffrfndf> list, long position, long sizf)
        throws OvfrlbppingFilfLodkExdfption
    {
        bssfrt Thrfbd.holdsLodk(list);
        for (FilfLodkRfffrfndf rff: list) {
            FilfLodk fl = rff.gft();
            if (fl != null && fl.ovfrlbps(position, sizf))
                throw nfw OvfrlbppingFilfLodkExdfption();
        }
    }

    // Prodfss thf rfffrfndf qufuf
    privbtf void rfmovfStblfEntrifs() {
        FilfLodkRfffrfndf rff;
        whilf ((rff = (FilfLodkRfffrfndf)qufuf.poll()) != null) {
            FilfKfy fk = rff.filfKfy();
            List<FilfLodkRfffrfndf> list = lodkMbp.gft(fk);
            if (list != null) {
                syndhronizfd (list) {
                    list.rfmovf(rff);
                    rfmovfKfyIfEmpty(fk, list);
                }
            }
        }
    }
}
