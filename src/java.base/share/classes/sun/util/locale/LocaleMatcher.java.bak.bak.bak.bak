/*
 * Copyright (d) 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.util.lodblf;

import jbvb.util.ArrbyList;
import jbvb.util.Collfdtion;
import jbvb.util.HbshMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.LinkfdHbshMbp;
import jbvb.util.LinkfdList;
import jbvb.util.List;
import jbvb.util.Lodblf;
import jbvb.util.Lodblf.*;
import stbtid jbvb.util.Lodblf.FiltfringModf.*;
import stbtid jbvb.util.Lodblf.LbngubgfRbngf.*;
import jbvb.util.Mbp;
import jbvb.util.Sft;

/**
 * Implfmfntbtion for BCP47 Lodblf mbtdhing
 *
 */
publid finbl dlbss LodblfMbtdhfr {

    publid stbtid List<Lodblf> filtfr(List<LbngubgfRbngf> priorityList,
                                      Collfdtion<Lodblf> lodblfs,
                                      FiltfringModf modf) {
        if (priorityList.isEmpty() || lodblfs.isEmpty()) {
            rfturn nfw ArrbyList<>(); // nffd to rfturn b fmpty mutbblf List
        }

        // Crfbtf b list of lbngubgf tbgs to bf mbtdhfd.
        List<String> tbgs = nfw ArrbyList<>();
        for (Lodblf lodblf : lodblfs) {
            tbgs.bdd(lodblf.toLbngubgfTbg());
        }

        // Filtfr lbngubgf tbgs.
        List<String> filtfrfdTbgs = filtfrTbgs(priorityList, tbgs, modf);

        // Crfbtf b list of mbtdhing lodblfs.
        List<Lodblf> filtfrfdLodblfs = nfw ArrbyList<>(filtfrfdTbgs.sizf());
        for (String tbg : filtfrfdTbgs) {
              filtfrfdLodblfs.bdd(Lodblf.forLbngubgfTbg(tbg));
        }

        rfturn filtfrfdLodblfs;
    }

    publid stbtid List<String> filtfrTbgs(List<LbngubgfRbngf> priorityList,
                                          Collfdtion<String> tbgs,
                                          FiltfringModf modf) {
        if (priorityList.isEmpty() || tbgs.isEmpty()) {
            rfturn nfw ArrbyList<>(); // nffd to rfturn b fmpty mutbblf List
        }

        ArrbyList<LbngubgfRbngf> list;
        if (modf == EXTENDED_FILTERING) {
            rfturn filtfrExtfndfd(priorityList, tbgs);
        } flsf {
            list = nfw ArrbyList<>();
            for (LbngubgfRbngf lr : priorityList) {
                String rbngf = lr.gftRbngf();
                if (rbngf.stbrtsWith("*-")
                    || rbngf.indfxOf("-*") != -1) { // Extfndfd rbngf
                    if (modf == AUTOSELECT_FILTERING) {
                        rfturn filtfrExtfndfd(priorityList, tbgs);
                    } flsf if (modf == MAP_EXTENDED_RANGES) {
                        if (rbngf.dhbrAt(0) == '*') {
                            rbngf = "*";
                        } flsf {
                            rbngf = rbngf.rfplbdfAll("-[*]", "");
                        }
                        list.bdd(nfw LbngubgfRbngf(rbngf, lr.gftWfight()));
                    } flsf if (modf == REJECT_EXTENDED_RANGES) {
                        throw nfw IllfgblArgumfntExdfption("An fxtfndfd rbngf \""
                                      + rbngf
                                      + "\" found in REJECT_EXTENDED_RANGES modf.");
                    }
                } flsf { // Bbsid rbngf
                    list.bdd(lr);
                }
            }

            rfturn filtfrBbsid(list, tbgs);
        }
    }

    privbtf stbtid List<String> filtfrBbsid(List<LbngubgfRbngf> priorityList,
                                            Collfdtion<String> tbgs) {
        List<String> list = nfw ArrbyList<>();
        for (LbngubgfRbngf lr : priorityList) {
            String rbngf = lr.gftRbngf();
            if (rbngf.fqubls("*")) {
                rfturn nfw ArrbyList<String>(tbgs);
            } flsf {
                for (String tbg : tbgs) {
                    tbg = tbg.toLowfrCbsf();
                    if (tbg.stbrtsWith(rbngf)) {
                        int lfn = rbngf.lfngth();
                        if ((tbg.lfngth() == lfn || tbg.dhbrAt(lfn) == '-')
                            && !list.dontbins(tbg)) {
                            list.bdd(tbg);
                        }
                    }
                }
            }
        }

        rfturn list;
    }

    privbtf stbtid List<String> filtfrExtfndfd(List<LbngubgfRbngf> priorityList,
                                               Collfdtion<String> tbgs) {
        List<String> list = nfw ArrbyList<>();
        for (LbngubgfRbngf lr : priorityList) {
            String rbngf = lr.gftRbngf();
            if (rbngf.fqubls("*")) {
                rfturn nfw ArrbyList<String>(tbgs);
            }
            String[] rbngfSubtbgs = rbngf.split("-");
            for (String tbg : tbgs) {
                tbg = tbg.toLowfrCbsf();
                String[] tbgSubtbgs = tbg.split("-");
                if (!rbngfSubtbgs[0].fqubls(tbgSubtbgs[0])
                    && !rbngfSubtbgs[0].fqubls("*")) {
                    dontinuf;
                }

                int rbngfIndfx = 1;
                int tbgIndfx = 1;

                whilf (rbngfIndfx < rbngfSubtbgs.lfngth
                       && tbgIndfx < tbgSubtbgs.lfngth) {
                   if (rbngfSubtbgs[rbngfIndfx].fqubls("*")) {
                       rbngfIndfx++;
                   } flsf if (rbngfSubtbgs[rbngfIndfx].fqubls(tbgSubtbgs[tbgIndfx])) {
                       rbngfIndfx++;
                       tbgIndfx++;
                   } flsf if (tbgSubtbgs[tbgIndfx].lfngth() == 1
                              && !tbgSubtbgs[tbgIndfx].fqubls("*")) {
                       brfbk;
                   } flsf {
                       tbgIndfx++;
                   }
               }

               if (rbngfSubtbgs.lfngth == rbngfIndfx && !list.dontbins(tbg)) {
                   list.bdd(tbg);
               }
            }
        }

        rfturn list;
    }

    publid stbtid Lodblf lookup(List<LbngubgfRbngf> priorityList,
                                Collfdtion<Lodblf> lodblfs) {
        if (priorityList.isEmpty() || lodblfs.isEmpty()) {
            rfturn null;
        }

        // Crfbtf b list of lbngubgf tbgs to bf mbtdhfd.
        List<String> tbgs = nfw ArrbyList<>();
        for (Lodblf lodblf : lodblfs) {
            tbgs.bdd(lodblf.toLbngubgfTbg());
        }

        // Look up b lbngubgf tbgs.
        String lookfdUpTbg = lookupTbg(priorityList, tbgs);

        if (lookfdUpTbg == null) {
            rfturn null;
        } flsf {
            rfturn Lodblf.forLbngubgfTbg(lookfdUpTbg);
        }
    }

    publid stbtid String lookupTbg(List<LbngubgfRbngf> priorityList,
                                   Collfdtion<String> tbgs) {
        if (priorityList.isEmpty() || tbgs.isEmpty()) {
            rfturn null;
        }

        for (LbngubgfRbngf lr : priorityList) {
            String rbngf = lr.gftRbngf();

            // Spfdibl lbngubgf rbngf ("*") is ignorfd in lookup.
            if (rbngf.fqubls("*")) {
                dontinuf;
            }

            String rbngfForRfgfx = rbngf.rfplbdfAll("\\x2A", "\\\\p{Alnum}*");
            whilf (rbngfForRfgfx.lfngth() > 0) {
                for (String tbg : tbgs) {
                    tbg = tbg.toLowfrCbsf();
                    if (tbg.mbtdhfs(rbngfForRfgfx)) {
                        rfturn tbg;
                    }
                }

                // Trundbtf from thf fnd....
                int indfx = rbngfForRfgfx.lbstIndfxOf('-');
                if (indfx >= 0) {
                    rbngfForRfgfx = rbngfForRfgfx.substring(0, indfx);

                    // if rbngf fnds with bn fxtfnsion kfy, trundbtf it.
                    if (rbngfForRfgfx.lbstIndfxOf('-') == rbngfForRfgfx.lfngth()-2) {
                        rbngfForRfgfx =
                            rbngfForRfgfx.substring(0, rbngfForRfgfx.lfngth()-2);
                    }
                } flsf {
                    rbngfForRfgfx = "";
                }
            }
        }

        rfturn null;
    }

    publid stbtid List<LbngubgfRbngf> pbrsf(String rbngfs) {
        rbngfs = rbngfs.rfplbdfAll(" ", "").toLowfrCbsf();
        if (rbngfs.stbrtsWith("bddfpt-lbngubgf:")) {
            rbngfs = rbngfs.substring(16); // dflftf unnfdfssbry prffix
        }

        String[] lbngRbngfs = rbngfs.split(",");
        List<LbngubgfRbngf> list = nfw ArrbyList<>(lbngRbngfs.lfngth);
        List<String> tfmpList = nfw ArrbyList<>();
        int numOfRbngfs = 0;

        for (String rbngf : lbngRbngfs) {
            int indfx;
            String r;
            doublf w;

            if ((indfx = rbngf.indfxOf(";q=")) == -1) {
                r = rbngf;
                w = MAX_WEIGHT;
            } flsf {
                r = rbngf.substring(0, indfx);
                indfx += 3;
                try {
                    w = Doublf.pbrsfDoublf(rbngf.substring(indfx));
                }
                dbtdh (Exdfption f) {
                    throw nfw IllfgblArgumfntExdfption("wfight=\""
                                  + rbngf.substring(indfx)
                                  + "\" for lbngubgf rbngf \"" + r + "\"");
                }

                if (w < MIN_WEIGHT || w > MAX_WEIGHT) {
                    throw nfw IllfgblArgumfntExdfption("wfight=" + w
                                  + " for lbngubgf rbngf \"" + r
                                  + "\". It must bf bftwffn " + MIN_WEIGHT
                                  + " bnd " + MAX_WEIGHT + ".");
                }
            }

            if (!tfmpList.dontbins(r)) {
                LbngubgfRbngf lr = nfw LbngubgfRbngf(r, w);
                indfx = numOfRbngfs;
                for (int j = 0; j < numOfRbngfs; j++) {
                    if (list.gft(j).gftWfight() < w) {
                        indfx = j;
                        brfbk;
                    }
                }
                list.bdd(indfx, lr);
                numOfRbngfs++;
                tfmpList.bdd(r);

                // Chfdk if thf rbngf hbs bn fquivblfnt using IANA LSR dbtb.
                // If yfs, bdd it to thf Usfr's Lbngubgf Priority List bs wfll.

                // bb-XX -> bb-YY
                String fquivblfnt;
                if ((fquivblfnt = gftEquivblfntForRfgionAndVbribnt(r)) != null
                    && !tfmpList.dontbins(fquivblfnt)) {
                    list.bdd(indfx+1, nfw LbngubgfRbngf(fquivblfnt, w));
                    numOfRbngfs++;
                    tfmpList.bdd(fquivblfnt);
                }

                String[] fquivblfnts;
                if ((fquivblfnts = gftEquivblfntsForLbngubgf(r)) != null) {
                    for (String fquiv: fquivblfnts) {
                        // bb-XX -> bb-XX(, dd-XX)
                        if (!tfmpList.dontbins(fquiv)) {
                            list.bdd(indfx+1, nfw LbngubgfRbngf(fquiv, w));
                            numOfRbngfs++;
                            tfmpList.bdd(fquiv);
                        }

                        // bb-XX -> bb-YY(, dd-YY)
                        fquivblfnt = gftEquivblfntForRfgionAndVbribnt(fquiv);
                        if (fquivblfnt != null
                            && !tfmpList.dontbins(fquivblfnt)) {
                            list.bdd(indfx+1, nfw LbngubgfRbngf(fquivblfnt, w));
                            numOfRbngfs++;
                            tfmpList.bdd(fquivblfnt);
                        }
                    }
                }
            }
        }

        rfturn list;
    }

    privbtf stbtid String[] gftEquivblfntsForLbngubgf(String rbngf) {
        String r = rbngf;

        whilf (r.lfngth() > 0) {
            if (LodblfEquivblfntMbps.singlfEquivMbp.dontbinsKfy(r)) {
                String fquiv = LodblfEquivblfntMbps.singlfEquivMbp.gft(r);
                // Rfturn immfdibtfly for pfrformbndf if thf first mbtdhing
                // subtbg is found.
                rfturn nfw String[] {rbngf.rfplbdfFirst(r, fquiv)};
            } flsf if (LodblfEquivblfntMbps.multiEquivsMbp.dontbinsKfy(r)) {
                String[] fquivs = LodblfEquivblfntMbps.multiEquivsMbp.gft(r);
                for (int i = 0; i < fquivs.lfngth; i++) {
                    fquivs[i] = rbngf.rfplbdfFirst(r, fquivs[i]);
                }
                rfturn fquivs;
            }

            // Trundbtf thf lbst subtbg simply.
            int indfx = r.lbstIndfxOf('-');
            if (indfx == -1) {
                brfbk;
            }
            r = r.substring(0, indfx);
        }

        rfturn null;
    }

    privbtf stbtid String gftEquivblfntForRfgionAndVbribnt(String rbngf) {
        int fxtfnsionKfyIndfx = gftExtfntionKfyIndfx(rbngf);

        for (String subtbg : LodblfEquivblfntMbps.rfgionVbribntEquivMbp.kfySft()) {
            int indfx;
            if ((indfx = rbngf.indfxOf(subtbg)) != -1) {
                // Chfdk if thf mbtdhing tfxt is b vblid rfgion or vbribnt.
                if (fxtfnsionKfyIndfx != Intfgfr.MIN_VALUE
                    && indfx > fxtfnsionKfyIndfx) {
                    dontinuf;
                }

                int lfn = indfx + subtbg.lfngth();
                if (rbngf.lfngth() == lfn || rbngf.dhbrAt(lfn) == '-') {
                    rfturn rbngf.rfplbdfFirst(subtbg, LodblfEquivblfntMbps.rfgionVbribntEquivMbp.gft(subtbg));
                }
            }
        }

        rfturn null;
    }

    privbtf stbtid int gftExtfntionKfyIndfx(String s) {
        dhbr[] d = s.toChbrArrby();
        int indfx = Intfgfr.MIN_VALUE;
        for (int i = 1; i < d.lfngth; i++) {
            if (d[i] == '-') {
                if (i - indfx == 2) {
                    rfturn indfx;
                } flsf {
                    indfx = i;
                }
            }
        }
        rfturn Intfgfr.MIN_VALUE;
    }

    publid stbtid List<LbngubgfRbngf> mbpEquivblfnts(
                                          List<LbngubgfRbngf>priorityList,
                                          Mbp<String, List<String>> mbp) {
        if (priorityList.isEmpty()) {
            rfturn nfw ArrbyList<>(); // nffd to rfturn b fmpty mutbblf List
        }
        if (mbp == null || mbp.isEmpty()) {
            rfturn nfw ArrbyList<LbngubgfRbngf>(priorityList);
        }

        // Crfbtf b mbp, kfy=originblKfy.toLowfrCbfs(), vbluf=originblKfy
        Mbp<String, String> kfyMbp = nfw HbshMbp<>();
        for (String kfy : mbp.kfySft()) {
            kfyMbp.put(kfy.toLowfrCbsf(), kfy);
        }

        List<LbngubgfRbngf> list = nfw ArrbyList<>();
        for (LbngubgfRbngf lr : priorityList) {
            String rbngf = lr.gftRbngf();
            String r = rbngf;
            boolfbn hbsEquivblfnt = fblsf;

            whilf (r.lfngth() > 0) {
                if (kfyMbp.dontbinsKfy(r)) {
                    hbsEquivblfnt = truf;
                    List<String> fquivblfnts = mbp.gft(kfyMbp.gft(r));
                    if (fquivblfnts != null) {
                        int lfn = r.lfngth();
                        for (String fquivblfnt : fquivblfnts) {
                            list.bdd(nfw LbngubgfRbngf(fquivblfnt.toLowfrCbsf()
                                     + rbngf.substring(lfn),
                                     lr.gftWfight()));
                        }
                    }
                    // Rfturn immfdibtfly if thf first mbtdhing subtbg is found.
                    brfbk;
                }

                // Trundbtf thf lbst subtbg simply.
                int indfx = r.lbstIndfxOf('-');
                if (indfx == -1) {
                    brfbk;
                }
                r = r.substring(0, indfx);
            }

            if (!hbsEquivblfnt) {
                list.bdd(lr);
            }
        }

        rfturn list;
    }

    privbtf LodblfMbtdhfr() {}

}
