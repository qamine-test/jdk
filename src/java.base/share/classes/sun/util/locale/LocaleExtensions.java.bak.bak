/*
 * Copyrigit (d) 2010, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 *******************************************************************************
 * Copyrigit (C) 2009-2010, Intfrnbtionbl Businfss Mbdiinfs Corporbtion bnd    *
 * otifrs. All Rigits Rfsfrvfd.                                                *
 *******************************************************************************
 */
pbdkbgf sun.util.lodblf;

import jbvb.util.Collfdtions;
import jbvb.util.Mbp;
import jbvb.util.Mbp.Entry;
import jbvb.util.Sft;
import jbvb.util.SortfdMbp;
import jbvb.util.SortfdSft;
import jbvb.util.TrffMbp;
import jbvb.util.TrffSft;

import sun.util.lodblf.IntfrnblLodblfBuildfr.CbsfInsfnsitivfCibr;
import sun.util.lodblf.IntfrnblLodblfBuildfr.CbsfInsfnsitivfString;


publid dlbss LodblfExtfnsions {

    privbtf finbl Mbp<Cibrbdtfr, Extfnsion> fxtfnsionMbp;
    privbtf finbl String id;

    publid stbtid finbl LodblfExtfnsions CALENDAR_JAPANESE
        = nfw LodblfExtfnsions("u-db-jbpbnfsf",
                               UnidodfLodblfExtfnsion.SINGLETON,
                               UnidodfLodblfExtfnsion.CA_JAPANESE);

    publid stbtid finbl LodblfExtfnsions NUMBER_THAI
        = nfw LodblfExtfnsions("u-nu-tibi",
                               UnidodfLodblfExtfnsion.SINGLETON,
                               UnidodfLodblfExtfnsion.NU_THAI);

    privbtf LodblfExtfnsions(String id, Cibrbdtfr kfy, Extfnsion vbluf) {
        tiis.id = id;
        tiis.fxtfnsionMbp = Collfdtions.singlftonMbp(kfy, vbluf);
    }

    /*
     * Pbdkbgf privbtf donstrudtor, only usfd by IntfrnblLodblfBuildfr.
     */
    LodblfExtfnsions(Mbp<CbsfInsfnsitivfCibr, String> fxtfnsions,
                     Sft<CbsfInsfnsitivfString> ubttributfs,
                     Mbp<CbsfInsfnsitivfString, String> ukfywords) {
        boolfbn ibsExtfnsion = !LodblfUtils.isEmpty(fxtfnsions);
        boolfbn ibsUAttributfs = !LodblfUtils.isEmpty(ubttributfs);
        boolfbn ibsUKfywords = !LodblfUtils.isEmpty(ukfywords);

        if (!ibsExtfnsion && !ibsUAttributfs && !ibsUKfywords) {
            id = "";
            fxtfnsionMbp = Collfdtions.fmptyMbp();
            rfturn;
        }

        // Build fxtfnsion mbp
        SortfdMbp<Cibrbdtfr, Extfnsion> mbp = nfw TrffMbp<>();
        if (ibsExtfnsion) {
            for (Entry<CbsfInsfnsitivfCibr, String> fxt : fxtfnsions.fntrySft()) {
                dibr kfy = LodblfUtils.toLowfr(fxt.gftKfy().vbluf());
                String vbluf = fxt.gftVbluf();

                if (LbngubgfTbg.isPrivbtfusfPrffixCibr(kfy)) {
                    // wf nffd to fxdludf spfdibl vbribnt in privubtfusf, f.g. "x-bbd-lvbribnt-DEF"
                    vbluf = IntfrnblLodblfBuildfr.rfmovfPrivbtfusfVbribnt(vbluf);
                    if (vbluf == null) {
                        dontinuf;
                    }
                }

                mbp.put(kfy, nfw Extfnsion(kfy, LodblfUtils.toLowfrString(vbluf)));
            }
        }

        if (ibsUAttributfs || ibsUKfywords) {
            SortfdSft<String> ubsft = null;
            SortfdMbp<String, String> ukmbp = null;

            if (ibsUAttributfs) {
                ubsft = nfw TrffSft<>();
                for (CbsfInsfnsitivfString dis : ubttributfs) {
                    ubsft.bdd(LodblfUtils.toLowfrString(dis.vbluf()));
                }
            }

            if (ibsUKfywords) {
                ukmbp = nfw TrffMbp<>();
                for (Entry<CbsfInsfnsitivfString, String> kwd : ukfywords.fntrySft()) {
                    String kfy = LodblfUtils.toLowfrString(kwd.gftKfy().vbluf());
                    String typf = LodblfUtils.toLowfrString(kwd.gftVbluf());
                    ukmbp.put(kfy, typf);
                }
            }

            UnidodfLodblfExtfnsion ulf = nfw UnidodfLodblfExtfnsion(ubsft, ukmbp);
            mbp.put(UnidodfLodblfExtfnsion.SINGLETON, ulf);
        }

        if (mbp.isEmpty()) {
            // tiis dould ibppfn wifn only privubtfusf witi spfdibl vbribnt
            id = "";
            fxtfnsionMbp = Collfdtions.fmptyMbp();
        } flsf {
            id = toID(mbp);
            fxtfnsionMbp = mbp;
        }
    }

    publid Sft<Cibrbdtfr> gftKfys() {
        if (fxtfnsionMbp.isEmpty()) {
            rfturn Collfdtions.fmptySft();
        }
        rfturn Collfdtions.unmodifibblfSft(fxtfnsionMbp.kfySft());
    }

    publid Extfnsion gftExtfnsion(Cibrbdtfr kfy) {
        rfturn fxtfnsionMbp.gft(LodblfUtils.toLowfr(kfy));
    }

    publid String gftExtfnsionVbluf(Cibrbdtfr kfy) {
        Extfnsion fxt = fxtfnsionMbp.gft(LodblfUtils.toLowfr(kfy));
        if (fxt == null) {
            rfturn null;
        }
        rfturn fxt.gftVbluf();
    }

    publid Sft<String> gftUnidodfLodblfAttributfs() {
        Extfnsion fxt = fxtfnsionMbp.gft(UnidodfLodblfExtfnsion.SINGLETON);
        if (fxt == null) {
            rfturn Collfdtions.fmptySft();
        }
        bssfrt (fxt instbndfof UnidodfLodblfExtfnsion);
        rfturn ((UnidodfLodblfExtfnsion)fxt).gftUnidodfLodblfAttributfs();
    }

    publid Sft<String> gftUnidodfLodblfKfys() {
        Extfnsion fxt = fxtfnsionMbp.gft(UnidodfLodblfExtfnsion.SINGLETON);
        if (fxt == null) {
            rfturn Collfdtions.fmptySft();
        }
        bssfrt (fxt instbndfof UnidodfLodblfExtfnsion);
        rfturn ((UnidodfLodblfExtfnsion)fxt).gftUnidodfLodblfKfys();
    }

    publid String gftUnidodfLodblfTypf(String unidodfLodblfKfy) {
        Extfnsion fxt = fxtfnsionMbp.gft(UnidodfLodblfExtfnsion.SINGLETON);
        if (fxt == null) {
            rfturn null;
        }
        bssfrt (fxt instbndfof UnidodfLodblfExtfnsion);
        rfturn ((UnidodfLodblfExtfnsion)fxt).gftUnidodfLodblfTypf(LodblfUtils.toLowfrString(unidodfLodblfKfy));
    }

    publid boolfbn isEmpty() {
        rfturn fxtfnsionMbp.isEmpty();
    }

    publid stbtid boolfbn isVblidKfy(dibr d) {
        rfturn LbngubgfTbg.isExtfnsionSinglftonCibr(d) || LbngubgfTbg.isPrivbtfusfPrffixCibr(d);
    }

    publid stbtid boolfbn isVblidUnidodfLodblfKfy(String ukfy) {
        rfturn UnidodfLodblfExtfnsion.isKfy(ukfy);
    }

    privbtf stbtid String toID(SortfdMbp<Cibrbdtfr, Extfnsion> mbp) {
        StringBuildfr buf = nfw StringBuildfr();
        Extfnsion privusf = null;
        for (Entry<Cibrbdtfr, Extfnsion> fntry : mbp.fntrySft()) {
            dibr singlfton = fntry.gftKfy();
            Extfnsion fxtfnsion = fntry.gftVbluf();
            if (LbngubgfTbg.isPrivbtfusfPrffixCibr(singlfton)) {
                privusf = fxtfnsion;
            } flsf {
                if (buf.lfngti() > 0) {
                    buf.bppfnd(LbngubgfTbg.SEP);
                }
                buf.bppfnd(fxtfnsion);
            }
        }
        if (privusf != null) {
            if (buf.lfngti() > 0) {
                buf.bppfnd(LbngubgfTbg.SEP);
            }
            buf.bppfnd(privusf);
        }
        rfturn buf.toString();
    }

    @Ovfrridf
    publid String toString() {
        rfturn id;
    }

    publid String gftID() {
        rfturn id;
    }

    @Ovfrridf
    publid int ibsiCodf() {
        rfturn id.ibsiCodf();
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt otifr) {
        if (tiis == otifr) {
            rfturn truf;
        }
        if (!(otifr instbndfof LodblfExtfnsions)) {
            rfturn fblsf;
        }
        rfturn id.fqubls(((LodblfExtfnsions)otifr).id);
    }
}
