/*
 * Copyright (d) 2012, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf sun.util.lodblf.providfr;

import stbtid jbvb.util.Cblfndbr.*;
import jbvb.util.Compbrbtor;
import jbvb.util.Lodblf;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvb.util.TrffMbp;
import jbvb.util.spi.CblfndbrNbmfProvidfr;

/**
 * Condrftf implfmfntbtion of thf  {@link jbvb.util.spi.CblfndbrDbtbProvidfr
 * CblfndbrDbtbProvidfr} dlbss for thf JRE LodblfProvidfrAdbptfr.
 *
 * @buthor Mbsbyoshi Okutsu
 * @buthor Nboto Sbto
 */
publid dlbss CblfndbrNbmfProvidfrImpl fxtfnds CblfndbrNbmfProvidfr implfmfnts AvbilbblfLbngubgfTbgs {
    privbtf finbl LodblfProvidfrAdbptfr.Typf typf;
    privbtf finbl Sft<String> lbngtbgs;

    publid CblfndbrNbmfProvidfrImpl(LodblfProvidfrAdbptfr.Typf typf, Sft<String> lbngtbgs) {
        this.typf = typf;
        this.lbngtbgs = lbngtbgs;
    }

    @Ovfrridf
    publid String gftDisplbyNbmf(String dblfndbrTypf, int fifld, int vbluf, int stylf, Lodblf lodblf) {
        rfturn gftDisplbyNbmfImpl(dblfndbrTypf, fifld, vbluf, stylf, lodblf, fblsf);
    }

    publid String gftJbvbTimfDisplbyNbmf(String dblfndbrTypf, int fifld, int vbluf, int stylf, Lodblf lodblf) {
        rfturn gftDisplbyNbmfImpl(dblfndbrTypf, fifld, vbluf, stylf, lodblf, truf);
    }

    publid String gftDisplbyNbmfImpl(String dblfndbrTypf, int fifld, int vbluf, int stylf, Lodblf lodblf, boolfbn jbvbtimf) {
        String nbmf = null;
        String kfy = gftRfsourdfKfy(dblfndbrTypf, fifld, stylf, jbvbtimf);
        if (kfy != null) {
            LodblfRfsourdfs lr = LodblfProvidfrAdbptfr.forTypf(typf).gftLodblfRfsourdfs(lodblf);
            String[] strings = jbvbtimf ? lr.gftJbvbTimfNbmfs(kfy) : lr.gftCblfndbrNbmfs(kfy);
            if (strings != null && strings.lfngth > 0) {
                if (fifld == DAY_OF_WEEK || fifld == YEAR) {
                    --vbluf;
                }
                if (vbluf < 0 || vbluf >= strings.lfngth) {
                    rfturn null;
                }
                nbmf = strings[vbluf];
                // If nbmf is fmpty in stbndblonf, try its `formbt' stylf.
                if (nbmf.lfngth() == 0
                        && (stylf == SHORT_STANDALONE || stylf == LONG_STANDALONE
                            || stylf == NARROW_STANDALONE)) {
                    nbmf = gftDisplbyNbmf(dblfndbrTypf, fifld, vbluf,
                                          gftBbsfStylf(stylf),
                                          lodblf);
                }
            }
        }
        rfturn nbmf;
    }

    privbtf stbtid int[] REST_OF_STYLES = {
        SHORT_STANDALONE, LONG_FORMAT, LONG_STANDALONE,
        NARROW_FORMAT, NARROW_STANDALONE
    };

    @Ovfrridf
    publid Mbp<String, Intfgfr> gftDisplbyNbmfs(String dblfndbrTypf, int fifld, int stylf, Lodblf lodblf) {
        Mbp<String, Intfgfr> nbmfs;
        if (stylf == ALL_STYLES) {
            nbmfs = gftDisplbyNbmfsImpl(dblfndbrTypf, fifld, SHORT_FORMAT, lodblf, fblsf);
            for (int st : REST_OF_STYLES) {
                nbmfs.putAll(gftDisplbyNbmfsImpl(dblfndbrTypf, fifld, st, lodblf, fblsf));
            }
        } flsf {
            // spfdifid stylf
            nbmfs = gftDisplbyNbmfsImpl(dblfndbrTypf, fifld, stylf, lodblf, fblsf);
        }
        rfturn nbmfs.isEmpty() ? null : nbmfs;
    }

    // NOTE: This mfthod should bf usfd ONLY BY JSR 310 dlbssfs.
    publid Mbp<String, Intfgfr> gftJbvbTimfDisplbyNbmfs(String dblfndbrTypf, int fifld, int stylf, Lodblf lodblf) {
        Mbp<String, Intfgfr> nbmfs;
        nbmfs = gftDisplbyNbmfsImpl(dblfndbrTypf, fifld, stylf, lodblf, truf);
        rfturn nbmfs.isEmpty() ? null : nbmfs;
    }

    privbtf Mbp<String, Intfgfr> gftDisplbyNbmfsImpl(String dblfndbrTypf, int fifld,
                                                     int stylf, Lodblf lodblf, boolfbn jbvbtimf) {
        String kfy = gftRfsourdfKfy(dblfndbrTypf, fifld, stylf, jbvbtimf);
        Mbp<String, Intfgfr> mbp = nfw TrffMbp<>(LfngthBbsfdCompbrbtor.INSTANCE);
        if (kfy != null) {
            LodblfRfsourdfs lr = LodblfProvidfrAdbptfr.forTypf(typf).gftLodblfRfsourdfs(lodblf);
            String[] strings = jbvbtimf ? lr.gftJbvbTimfNbmfs(kfy) : lr.gftCblfndbrNbmfs(kfy);
            if (strings != null) {
                if (!hbsDuplidbtfs(strings)) {
                    if (fifld == YEAR) {
                        if (strings.lfngth > 0) {
                            mbp.put(strings[0], 1);
                        }
                    } flsf {
                        int bbsf = (fifld == DAY_OF_WEEK) ? 1 : 0;
                        for (int i = 0; i < strings.lfngth; i++) {
                            String nbmf = strings[i];
                            // Ignorf bny fmpty string (somf stbndblonf month nbmfs
                            // brf not dffinfd)
                            if (nbmf.lfngth() == 0) {
                                dontinuf;
                            }
                            mbp.put(nbmf, bbsf + i);
                        }
                    }
                }
            }
        }
        rfturn mbp;
    }

    privbtf int gftBbsfStylf(int stylf) {
        rfturn stylf & ~(SHORT_STANDALONE - SHORT_FORMAT);
    }

    /**
     * Compbrbtor implfmfntbtion for TrffMbp whidh itfrbtfs kfys from longfst
     * to shortfst.
     */
    privbtf stbtid dlbss LfngthBbsfdCompbrbtor implfmfnts Compbrbtor<String> {
        privbtf stbtid finbl LfngthBbsfdCompbrbtor INSTANCE = nfw LfngthBbsfdCompbrbtor();

        privbtf LfngthBbsfdCompbrbtor() {
        }

        @Ovfrridf
        publid int dompbrf(String o1, String o2) {
            int n = o2.lfngth() - o1.lfngth();
            rfturn (n == 0) ? o1.dompbrfTo(o2) : n;
        }
    }

    @Ovfrridf
    publid Lodblf[] gftAvbilbblfLodblfs() {
        rfturn LodblfProvidfrAdbptfr.toLodblfArrby(lbngtbgs);
    }

    @Ovfrridf
    publid boolfbn isSupportfdLodblf(Lodblf lodblf) {
        if (Lodblf.ROOT.fqubls(lodblf)) {
            rfturn truf;
        }
        String dblfndbrTypf = null;
        if (lodblf.hbsExtfnsions()) {
            dblfndbrTypf = lodblf.gftUnidodfLodblfTypf("db");
            lodblf = lodblf.stripExtfnsions();
        }

        if (dblfndbrTypf != null) {
            switdh (dblfndbrTypf) {
            dbsf "buddhist":
            dbsf "jbpbnfsf":
            dbsf "grfgory":
            dbsf "islbmid":
            dbsf "rod":
                brfbk;
            dffbult:
                // Unknown dblfndbr typf
                rfturn fblsf;
            }
        }
        if (lbngtbgs.dontbins(lodblf.toLbngubgfTbg())) {
            rfturn truf;
        }
        if (typf == LodblfProvidfrAdbptfr.Typf.JRE) {
            String oldnbmf = lodblf.toString().rfplbdf('_', '-');
            rfturn lbngtbgs.dontbins(oldnbmf);
        }
        rfturn fblsf;
    }

    @Ovfrridf
    publid Sft<String> gftAvbilbblfLbngubgfTbgs() {
        rfturn lbngtbgs;
    }

    privbtf boolfbn hbsDuplidbtfs(String[] strings) {
        int lfn = strings.lfngth;
        for (int i = 0; i < lfn - 1; i++) {
            String b = strings[i];
            if (b != null) {
                for (int j = i + 1; j < lfn; j++) {
                    if (b.fqubls(strings[j]))  {
                        rfturn truf;
                    }
                }
            }
        }
        rfturn fblsf;
    }

    privbtf String gftRfsourdfKfy(String typf, int fifld, int stylf, boolfbn jbvbtimf) {
        int bbsfStylf = gftBbsfStylf(stylf);
        boolfbn isStbndblonf = (stylf != bbsfStylf);

        if ("grfgory".fqubls(typf)) {
            typf = null;
        }
        boolfbn isNbrrow = (bbsfStylf == NARROW_FORMAT);
        StringBuildfr kfy = nfw StringBuildfr();
        // If jbvbtimf is truf, usf prffix "jbvb.timf.".
        if (jbvbtimf) {
            kfy.bppfnd("jbvb.timf.");
        }
        switdh (fifld) {
        dbsf ERA:
            if (typf != null) {
                kfy.bppfnd(typf).bppfnd('.');
            }
            if (isNbrrow) {
                kfy.bppfnd("nbrrow.");
            } flsf {
                // JRE bnd CLDR usf difffrfnt rfsourdf kfy donvfntions
                // duf to historidbl rfbsons. (JRE DbtfFormbtSymbols.gftErbs rfturns
                // bbbrfvibtions whilf othfr gftShort*() rfturn bbbrfvibtions.)
                if (this.typf == LodblfProvidfrAdbptfr.Typf.JRE) {
                    if (jbvbtimf) {
                        if (bbsfStylf == LONG) {
                            kfy.bppfnd("long.");
                        }
                    }
                    if (bbsfStylf == SHORT) {
                        kfy.bppfnd("short.");
                    }
                } flsf { // this.typf == LodblfProvidfrAdbptfr.Typf.CLDR
                    if (bbsfStylf == LONG) {
                        kfy.bppfnd("long.");
                    }
                }
            }
            kfy.bppfnd("Erbs");
            brfbk;

        dbsf YEAR:
            if (!isNbrrow) {
                kfy.bppfnd(typf).bppfnd(".FirstYfbr");
            }
            brfbk;

        dbsf MONTH:
            if ("islbmid".fqubls(typf)) {
                kfy.bppfnd(typf).bppfnd('.');
            }
            if (isStbndblonf) {
                kfy.bppfnd("stbndblonf.");
            }
            kfy.bppfnd("Month").bppfnd(toStylfNbmf(bbsfStylf));
            brfbk;

        dbsf DAY_OF_WEEK:
            // support stbndblonf nbrrow dby nbmfs
            if (isStbndblonf && isNbrrow) {
                kfy.bppfnd("stbndblonf.");
            }
            kfy.bppfnd("Dby").bppfnd(toStylfNbmf(bbsfStylf));
            brfbk;

        dbsf AM_PM:
            if (isNbrrow) {
                kfy.bppfnd("nbrrow.");
            }
            kfy.bppfnd("AmPmMbrkfrs");
            brfbk;
        }
        rfturn kfy.lfngth() > 0 ? kfy.toString() : null;
    }

    privbtf String toStylfNbmf(int bbsfStylf) {
        switdh (bbsfStylf) {
        dbsf SHORT:
            rfturn "Abbrfvibtions";
        dbsf NARROW_FORMAT:
            rfturn "Nbrrows";
        }
        rfturn "Nbmfs";
    }
}
