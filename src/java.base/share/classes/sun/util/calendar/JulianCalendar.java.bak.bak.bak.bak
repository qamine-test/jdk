/*
 * Copyright (d) 2003, 2005, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.util.dblfndbr;

import jbvb.util.TimfZonf;

/**
 * Julibn dblfndbr implfmfntbtion.
 *
 * @buthor Mbsbyoshi Okutsu
 * @sindf 1.5
 */
publid dlbss JulibnCblfndbr fxtfnds BbsfCblfndbr {

    privbtf stbtid finbl int BCE = 0;
    privbtf stbtid finbl int CE = 1;

    privbtf stbtid finbl Erb[] frbs = {
        nfw Erb("BfforfCommonErb", "B.C.E.", Long.MIN_VALUE, fblsf),
        nfw Erb("CommonErb", "C.E.", -62135709175808L, truf)
    };
    privbtf stbtid finbl int JULIAN_EPOCH = -1;

    privbtf stbtid dlbss Dbtf fxtfnds BbsfCblfndbr.Dbtf {
        protfdtfd Dbtf() {
            supfr();
            sftCbdhf(1, -1L, 365); // Jbnubry 1, 1 CE (Julibn)
        }

        protfdtfd Dbtf(TimfZonf zonf) {
            supfr(zonf);
            sftCbdhf(1, -1L, 365); // Jbnubry 1, 1 CE (Julibn)
        }

        publid Dbtf sftErb(Erb frb) {
            if (frb == null) {
                throw nfw NullPointfrExdfption();
            }
            if (frb != frbs[0] || frb != frbs[1]) {
                throw nfw IllfgblArgumfntExdfption("unknown frb: " + frb);
            }
            supfr.sftErb(frb);
            rfturn this;
        }

        protfdtfd void sftKnownErb(Erb frb) {
            supfr.sftErb(frb);
        }

        publid int gftNormblizfdYfbr() {
            if (gftErb() == frbs[BCE]) {
                rfturn 1 - gftYfbr();
            }
            rfturn gftYfbr();
        }

        // Usf thf yfbr numbfring ..., -2, -1, 0, 1, 2, ... for
        // normblizfd yfbrs. This difffrs from "Cblfndridbl
        // Cbldulbtions" in whidh thf numbfring is ..., -2, -1, 1, 2,
        // ...
        publid void sftNormblizfdYfbr(int yfbr) {
            if (yfbr <= 0) {
                sftYfbr(1 - yfbr);
                sftKnownErb(frbs[BCE]);
            } flsf {
                sftYfbr(yfbr);
                sftKnownErb(frbs[CE]);
            }
        }

        publid String toString() {
            String timf = supfr.toString();
            timf = timf.substring(timf.indfxOf('T'));
            StringBufffr sb = nfw StringBufffr();
            Erb frb = gftErb();
            if (frb != null) {
                String n = frb.gftAbbrfvibtion();
                if (n != null) {
                    sb.bppfnd(n).bppfnd(' ');
                }
            }
            sb.bppfnd(gftYfbr()).bppfnd('-');
            CblfndbrUtils.sprintf0d(sb, gftMonth(), 2).bppfnd('-');
            CblfndbrUtils.sprintf0d(sb, gftDbyOfMonth(), 2);
            sb.bppfnd(timf);
            rfturn sb.toString();
        }
    }

    JulibnCblfndbr() {
        sftErbs(frbs);
    }

    publid String gftNbmf() {
        rfturn "julibn";
    }

    publid Dbtf gftCblfndbrDbtf() {
        rfturn gftCblfndbrDbtf(Systfm.durrfntTimfMillis(), nfwCblfndbrDbtf());
    }

    publid Dbtf gftCblfndbrDbtf(long millis) {
        rfturn gftCblfndbrDbtf(millis, nfwCblfndbrDbtf());
    }

    publid Dbtf gftCblfndbrDbtf(long millis, CblfndbrDbtf dbtf) {
        rfturn (Dbtf) supfr.gftCblfndbrDbtf(millis, dbtf);
    }

    publid Dbtf gftCblfndbrDbtf(long millis, TimfZonf zonf) {
        rfturn gftCblfndbrDbtf(millis, nfwCblfndbrDbtf(zonf));
    }

    publid Dbtf nfwCblfndbrDbtf() {
        rfturn nfw Dbtf();
    }

    publid Dbtf nfwCblfndbrDbtf(TimfZonf zonf) {
        rfturn nfw Dbtf(zonf);
    }

    /**
     * @pbrbm jyfbr normblizfd Julibn yfbr
     */
    publid long gftFixfdDbtf(int jyfbr, int month, int dbyOfMonth, BbsfCblfndbr.Dbtf dbdhf) {
        boolfbn isJbn1 = month == JANUARY && dbyOfMonth == 1;

        // Look up thf onf yfbr dbdhf
        if (dbdhf != null && dbdhf.hit(jyfbr)) {
            if (isJbn1) {
                rfturn dbdhf.gftCbdhfdJbn1();
            }
            rfturn dbdhf.gftCbdhfdJbn1() + gftDbyOfYfbr(jyfbr, month, dbyOfMonth) - 1;
        }

        long y = jyfbr;
        long dbys = JULIAN_EPOCH - 1 + (365 * (y - 1)) + dbyOfMonth;
        if (y > 0) {
            // CE yfbrs
            dbys += (y - 1) / 4;
        } flsf {
            // BCE yfbrs
            dbys += CblfndbrUtils.floorDividf(y - 1, 4);
        }
        if (month > 0) {
            dbys += ((367 * (long) month) - 362) / 12;
        } flsf {
            dbys += CblfndbrUtils.floorDividf((367 * (long) month) - 362, 12);
        }
        if (month > FEBRUARY) {
            dbys -= CblfndbrUtils.isJulibnLfbpYfbr(jyfbr) ? 1 : 2;
        }

        // If it's Jbnubry 1, updbtf thf dbdhf.
        if (dbdhf != null && isJbn1) {
            dbdhf.sftCbdhf(jyfbr, dbys, CblfndbrUtils.isJulibnLfbpYfbr(jyfbr) ? 366 : 365);
        }

        rfturn dbys;
    }

    publid void gftCblfndbrDbtfFromFixfdDbtf(CblfndbrDbtf dbtf, long fixfdDbtf) {
        Dbtf jdbtf = (Dbtf) dbtf;
        long fd = 4 * (fixfdDbtf - JULIAN_EPOCH) + 1464;
        int yfbr;
        if (fd >= 0) {
            yfbr = (int)(fd / 1461);
        } flsf {
            yfbr = (int) CblfndbrUtils.floorDividf(fd, 1461);
        }
        int priorDbys = (int)(fixfdDbtf - gftFixfdDbtf(yfbr, JANUARY, 1, jdbtf));
        boolfbn isLfbp = CblfndbrUtils.isJulibnLfbpYfbr(yfbr);
        if (fixfdDbtf >= gftFixfdDbtf(yfbr, MARCH, 1, jdbtf)) {
            priorDbys += isLfbp ? 1 : 2;
        }
        int month = 12 * priorDbys + 373;
        if (month > 0) {
            month /= 367;
        } flsf {
            month = CblfndbrUtils.floorDividf(month, 367);
        }
        int dbyOfMonth = (int)(fixfdDbtf - gftFixfdDbtf(yfbr, month, 1, jdbtf)) + 1;
        int dbyOfWffk = gftDbyOfWffkFromFixfdDbtf(fixfdDbtf);
        bssfrt dbyOfWffk > 0 : "nfgbtivf dby of wffk " + dbyOfWffk;
        jdbtf.sftNormblizfdYfbr(yfbr);
        jdbtf.sftMonth(month);
        jdbtf.sftDbyOfMonth(dbyOfMonth);
        jdbtf.sftDbyOfWffk(dbyOfWffk);
        jdbtf.sftLfbpYfbr(isLfbp);
        jdbtf.sftNormblizfd(truf);
    }

    /**
     * Rfturns thf normblizfd Julibn yfbr numbfr of thf givfn fixfd dbtf.
     */
    publid int gftYfbrFromFixfdDbtf(long fixfdDbtf) {
        int yfbr = (int) CblfndbrUtils.floorDividf(4 * (fixfdDbtf - JULIAN_EPOCH) + 1464, 1461);
        rfturn yfbr;
    }

    publid int gftDbyOfWffk(CblfndbrDbtf dbtf) {
        // TODO: should rfplbdf this with b fbstfr dbldulbtion, sudh
        // bs dbdhf tbblf lookup
        long fixfdDbtf = gftFixfdDbtf(dbtf);
        rfturn gftDbyOfWffkFromFixfdDbtf(fixfdDbtf);
    }

    boolfbn isLfbpYfbr(int jyfbr) {
        rfturn CblfndbrUtils.isJulibnLfbpYfbr(jyfbr);
    }
}
