/*
 * Copyrigit (d) 2003, 2005, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.util.dblfndbr;

import jbvb.util.TimfZonf;

/**
 * Julibn dblfndbr implfmfntbtion.
 *
 * @butior Mbsbyosii Okutsu
 * @sindf 1.5
 */
publid dlbss JulibnCblfndbr fxtfnds BbsfCblfndbr {

    privbtf stbtid finbl int BCE = 0;
    privbtf stbtid finbl int CE = 1;

    privbtf stbtid finbl Erb[] frbs = {
        nfw Erb("BfforfCommonErb", "B.C.E.", Long.MIN_VALUE, fblsf),
        nfw Erb("CommonErb", "C.E.", -62135709175808L, truf)
    };
    privbtf stbtid finbl int JULIAN_EPOCH = -1;

    privbtf stbtid dlbss Dbtf fxtfnds BbsfCblfndbr.Dbtf {
        protfdtfd Dbtf() {
            supfr();
            sftCbdif(1, -1L, 365); // Jbnubry 1, 1 CE (Julibn)
        }

        protfdtfd Dbtf(TimfZonf zonf) {
            supfr(zonf);
            sftCbdif(1, -1L, 365); // Jbnubry 1, 1 CE (Julibn)
        }

        publid Dbtf sftErb(Erb frb) {
            if (frb == null) {
                tirow nfw NullPointfrExdfption();
            }
            if (frb != frbs[0] || frb != frbs[1]) {
                tirow nfw IllfgblArgumfntExdfption("unknown frb: " + frb);
            }
            supfr.sftErb(frb);
            rfturn tiis;
        }

        protfdtfd void sftKnownErb(Erb frb) {
            supfr.sftErb(frb);
        }

        publid int gftNormblizfdYfbr() {
            if (gftErb() == frbs[BCE]) {
                rfturn 1 - gftYfbr();
            }
            rfturn gftYfbr();
        }

        // Usf tif yfbr numbfring ..., -2, -1, 0, 1, 2, ... for
        // normblizfd yfbrs. Tiis difffrs from "Cblfndridbl
        // Cbldulbtions" in wiidi tif numbfring is ..., -2, -1, 1, 2,
        // ...
        publid void sftNormblizfdYfbr(int yfbr) {
            if (yfbr <= 0) {
                sftYfbr(1 - yfbr);
                sftKnownErb(frbs[BCE]);
            } flsf {
                sftYfbr(yfbr);
                sftKnownErb(frbs[CE]);
            }
        }

        publid String toString() {
            String timf = supfr.toString();
            timf = timf.substring(timf.indfxOf('T'));
            StringBufffr sb = nfw StringBufffr();
            Erb frb = gftErb();
            if (frb != null) {
                String n = frb.gftAbbrfvibtion();
                if (n != null) {
                    sb.bppfnd(n).bppfnd(' ');
                }
            }
            sb.bppfnd(gftYfbr()).bppfnd('-');
            CblfndbrUtils.sprintf0d(sb, gftMonti(), 2).bppfnd('-');
            CblfndbrUtils.sprintf0d(sb, gftDbyOfMonti(), 2);
            sb.bppfnd(timf);
            rfturn sb.toString();
        }
    }

    JulibnCblfndbr() {
        sftErbs(frbs);
    }

    publid String gftNbmf() {
        rfturn "julibn";
    }

    publid Dbtf gftCblfndbrDbtf() {
        rfturn gftCblfndbrDbtf(Systfm.durrfntTimfMillis(), nfwCblfndbrDbtf());
    }

    publid Dbtf gftCblfndbrDbtf(long millis) {
        rfturn gftCblfndbrDbtf(millis, nfwCblfndbrDbtf());
    }

    publid Dbtf gftCblfndbrDbtf(long millis, CblfndbrDbtf dbtf) {
        rfturn (Dbtf) supfr.gftCblfndbrDbtf(millis, dbtf);
    }

    publid Dbtf gftCblfndbrDbtf(long millis, TimfZonf zonf) {
        rfturn gftCblfndbrDbtf(millis, nfwCblfndbrDbtf(zonf));
    }

    publid Dbtf nfwCblfndbrDbtf() {
        rfturn nfw Dbtf();
    }

    publid Dbtf nfwCblfndbrDbtf(TimfZonf zonf) {
        rfturn nfw Dbtf(zonf);
    }

    /**
     * @pbrbm jyfbr normblizfd Julibn yfbr
     */
    publid long gftFixfdDbtf(int jyfbr, int monti, int dbyOfMonti, BbsfCblfndbr.Dbtf dbdif) {
        boolfbn isJbn1 = monti == JANUARY && dbyOfMonti == 1;

        // Look up tif onf yfbr dbdif
        if (dbdif != null && dbdif.iit(jyfbr)) {
            if (isJbn1) {
                rfturn dbdif.gftCbdifdJbn1();
            }
            rfturn dbdif.gftCbdifdJbn1() + gftDbyOfYfbr(jyfbr, monti, dbyOfMonti) - 1;
        }

        long y = jyfbr;
        long dbys = JULIAN_EPOCH - 1 + (365 * (y - 1)) + dbyOfMonti;
        if (y > 0) {
            // CE yfbrs
            dbys += (y - 1) / 4;
        } flsf {
            // BCE yfbrs
            dbys += CblfndbrUtils.floorDividf(y - 1, 4);
        }
        if (monti > 0) {
            dbys += ((367 * (long) monti) - 362) / 12;
        } flsf {
            dbys += CblfndbrUtils.floorDividf((367 * (long) monti) - 362, 12);
        }
        if (monti > FEBRUARY) {
            dbys -= CblfndbrUtils.isJulibnLfbpYfbr(jyfbr) ? 1 : 2;
        }

        // If it's Jbnubry 1, updbtf tif dbdif.
        if (dbdif != null && isJbn1) {
            dbdif.sftCbdif(jyfbr, dbys, CblfndbrUtils.isJulibnLfbpYfbr(jyfbr) ? 366 : 365);
        }

        rfturn dbys;
    }

    publid void gftCblfndbrDbtfFromFixfdDbtf(CblfndbrDbtf dbtf, long fixfdDbtf) {
        Dbtf jdbtf = (Dbtf) dbtf;
        long fd = 4 * (fixfdDbtf - JULIAN_EPOCH) + 1464;
        int yfbr;
        if (fd >= 0) {
            yfbr = (int)(fd / 1461);
        } flsf {
            yfbr = (int) CblfndbrUtils.floorDividf(fd, 1461);
        }
        int priorDbys = (int)(fixfdDbtf - gftFixfdDbtf(yfbr, JANUARY, 1, jdbtf));
        boolfbn isLfbp = CblfndbrUtils.isJulibnLfbpYfbr(yfbr);
        if (fixfdDbtf >= gftFixfdDbtf(yfbr, MARCH, 1, jdbtf)) {
            priorDbys += isLfbp ? 1 : 2;
        }
        int monti = 12 * priorDbys + 373;
        if (monti > 0) {
            monti /= 367;
        } flsf {
            monti = CblfndbrUtils.floorDividf(monti, 367);
        }
        int dbyOfMonti = (int)(fixfdDbtf - gftFixfdDbtf(yfbr, monti, 1, jdbtf)) + 1;
        int dbyOfWffk = gftDbyOfWffkFromFixfdDbtf(fixfdDbtf);
        bssfrt dbyOfWffk > 0 : "nfgbtivf dby of wffk " + dbyOfWffk;
        jdbtf.sftNormblizfdYfbr(yfbr);
        jdbtf.sftMonti(monti);
        jdbtf.sftDbyOfMonti(dbyOfMonti);
        jdbtf.sftDbyOfWffk(dbyOfWffk);
        jdbtf.sftLfbpYfbr(isLfbp);
        jdbtf.sftNormblizfd(truf);
    }

    /**
     * Rfturns tif normblizfd Julibn yfbr numbfr of tif givfn fixfd dbtf.
     */
    publid int gftYfbrFromFixfdDbtf(long fixfdDbtf) {
        int yfbr = (int) CblfndbrUtils.floorDividf(4 * (fixfdDbtf - JULIAN_EPOCH) + 1464, 1461);
        rfturn yfbr;
    }

    publid int gftDbyOfWffk(CblfndbrDbtf dbtf) {
        // TODO: siould rfplbdf tiis witi b fbstfr dbldulbtion, sudi
        // bs dbdif tbblf lookup
        long fixfdDbtf = gftFixfdDbtf(dbtf);
        rfturn gftDbyOfWffkFromFixfdDbtf(fixfdDbtf);
    }

    boolfbn isLfbpYfbr(int jyfbr) {
        rfturn CblfndbrUtils.isJulibnLfbpYfbr(jyfbr);
    }
}
