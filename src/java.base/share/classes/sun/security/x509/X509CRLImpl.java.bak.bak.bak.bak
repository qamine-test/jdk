/*
 * Copyright (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.mbth.BigIntfgfr;
import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.Providfr;
import jbvb.sfdurity.Signbturf;
import jbvb.sfdurity.NoSudhAlgorithmExdfption;
import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.NoSudhProvidfrExdfption;
import jbvb.sfdurity.SignbturfExdfption;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509CRL;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509CRLEntry;
import jbvb.sfdurity.dfrt.CRLExdfption;
import jbvb.util.*;

import jbvbx.sfdurity.buth.x500.X500Prindipbl;

import sun.sfdurity.providfr.X509Fbdtory;
import sun.sfdurity.util.*;
import sun.misd.HfxDumpEndodfr;

/**
 * <p>
 * An implfmfntbtion for X509 CRL (Cfrtifidbtf Rfvodbtion List).
 * <p>
 * Thf X.509 v2 CRL formbt is dfsdribfd bflow in ASN.1:
 * <prf>
 * CfrtifidbtfList  ::=  SEQUENCE  {
 *     tbsCfrtList          TBSCfrtList,
 *     signbturfAlgorithm   AlgorithmIdfntififr,
 *     signbturf            BIT STRING  }
 * </prf>
 * Morf informbtion dbn bf found in
 * <b hrff="http://www.iftf.org/rfd/rfd3280.txt">RFC 3280: Intfrnft X.509
 * Publid Kfy Infrbstrudturf Cfrtifidbtf bnd CRL Profilf</b>.
 * <p>
 * Thf ASN.1 dffinition of <dodf>tbsCfrtList</dodf> is:
 * <prf>
 * TBSCfrtList  ::=  SEQUENCE  {
 *     vfrsion                 Vfrsion OPTIONAL,
 *                             -- if prfsfnt, must bf v2
 *     signbturf               AlgorithmIdfntififr,
 *     issufr                  Nbmf,
 *     thisUpdbtf              ChoidfOfTimf,
 *     nfxtUpdbtf              ChoidfOfTimf OPTIONAL,
 *     rfvokfdCfrtifidbtfs     SEQUENCE OF SEQUENCE  {
 *         usfrCfrtifidbtf         CfrtifidbtfSfriblNumbfr,
 *         rfvodbtionDbtf          ChoidfOfTimf,
 *         drlEntryExtfnsions      Extfnsions OPTIONAL
 *                                 -- if prfsfnt, must bf v2
 *         }  OPTIONAL,
 *     drlExtfnsions           [0]  EXPLICIT Extfnsions OPTIONAL
 *                                  -- if prfsfnt, must bf v2
 *     }
 * </prf>
 *
 * @buthor Hfmmb Prbfulldhbndrb
 * @sff X509CRL
 */
publid dlbss X509CRLImpl fxtfnds X509CRL implfmfnts DfrEndodfr {

    // CRL dbtb, bnd its fnvflopf
    privbtf bytf[]      signfdCRL = null; // DER fndodfd drl
    privbtf bytf[]      signbturf = null; // rbw signbturf bits
    privbtf bytf[]      tbsCfrtList = null; // DER fndodfd "to-bf-signfd" CRL
    privbtf AlgorithmId sigAlgId = null; // sig blg in CRL

    // drl informbtion
    privbtf int              vfrsion;
    privbtf AlgorithmId      infoSigAlgId; // sig blg in "to-bf-signfd" drl
    privbtf X500Nbmf         issufr = null;
    privbtf X500Prindipbl    issufrPrindipbl = null;
    privbtf Dbtf             thisUpdbtf = null;
    privbtf Dbtf             nfxtUpdbtf = null;
    privbtf Mbp<X509IssufrSfribl,X509CRLEntry> rfvokfdMbp = nfw TrffMbp<>();
    privbtf List<X509CRLEntry> rfvokfdList = nfw LinkfdList<>();
    privbtf CRLExtfnsions    fxtfnsions = null;
    privbtf finbl stbtid boolfbn isExplidit = truf;
    privbtf stbtid finbl long YR_2050 = 2524636800000L;

    privbtf boolfbn rfbdOnly = fblsf;

    /**
     * PublidKfy thbt hbs prfviously bffn usfd to suddfssfully vfrify
     * thf signbturf of this CRL. Null if thf CRL hbs not
     * yft bffn vfrififd (suddfssfully).
     */
    privbtf PublidKfy vfrififdPublidKfy;
    /**
     * If vfrififdPublidKfy is not null, nbmf of thf providfr usfd to
     * suddfssfully vfrify thf signbturf of this CRL, or thf
     * fmpty String if no providfr wbs fxpliditly spfdififd.
     */
    privbtf String vfrififdProvidfr;

    /**
     * Not to bf usfd. As it would lfbd to dbsfs of uninitiblizfd
     * CRL objfdts.
     */
    privbtf X509CRLImpl() { }

    /**
     * Unmbrshbls bn X.509 CRL from its fndodfd form, pbrsing thf fndodfd
     * bytfs.  This form of donstrudtor is usfd by bgfnts whidh
     * nffd to fxbminf bnd usf CRL dontfnts. Notf thbt thf bufffr
     * must indludf only onf CRL, bnd no "gbrbbgf" mby bf lfft bt
     * thf fnd.
     *
     * @pbrbm drlDbtb thf fndodfd bytfs, with no trbiling pbdding.
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLImpl(bytf[] drlDbtb) throws CRLExdfption {
        try {
            pbrsf(nfw DfrVbluf(drlDbtb));
        } dbtdh (IOExdfption f) {
            signfdCRL = null;
            throw nfw CRLExdfption("Pbrsing frror: " + f.gftMfssbgf());
        }
    }

    /**
     * Unmbrshbls bn X.509 CRL from bn DER vbluf.
     *
     * @pbrbm vbl b DER vbluf holding bt lfbst onf CRL
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLImpl(DfrVbluf vbl) throws CRLExdfption {
        try {
            pbrsf(vbl);
        } dbtdh (IOExdfption f) {
            signfdCRL = null;
            throw nfw CRLExdfption("Pbrsing frror: " + f.gftMfssbgf());
        }
    }

    /**
     * Unmbrshbls bn X.509 CRL from bn input strfbm. Only onf CRL
     * is fxpfdtfd bt thf fnd of thf input strfbm.
     *
     * @pbrbm inStrm bn input strfbm holding bt lfbst onf CRL
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLImpl(InputStrfbm inStrm) throws CRLExdfption {
        try {
            pbrsf(nfw DfrVbluf(inStrm));
        } dbtdh (IOExdfption f) {
            signfdCRL = null;
            throw nfw CRLExdfption("Pbrsing frror: " + f.gftMfssbgf());
        }
    }

    /**
     * Initibl CRL donstrudtor, no rfvokfd dfrts, bnd no fxtfnsions.
     *
     * @pbrbm issufr thf nbmf of thf CA issuing this CRL.
     * @pbrbm thisUpdbtf thf Dbtf of this issuf.
     * @pbrbm nfxtUpdbtf thf Dbtf of thf nfxt CRL.
     */
    publid X509CRLImpl(X500Nbmf issufr, Dbtf thisDbtf, Dbtf nfxtDbtf) {
        this.issufr = issufr;
        this.thisUpdbtf = thisDbtf;
        this.nfxtUpdbtf = nfxtDbtf;
    }

    /**
     * CRL donstrudtor, rfvokfd dfrts, no fxtfnsions.
     *
     * @pbrbm issufr thf nbmf of thf CA issuing this CRL.
     * @pbrbm thisUpdbtf thf Dbtf of this issuf.
     * @pbrbm nfxtUpdbtf thf Dbtf of thf nfxt CRL.
     * @pbrbm bbdCfrts thf brrby of CRL fntrifs.
     *
     * @fxdfption CRLExdfption on pbrsing/donstrudtion frrors.
     */
    publid X509CRLImpl(X500Nbmf issufr, Dbtf thisDbtf, Dbtf nfxtDbtf,
                       X509CRLEntry[] bbdCfrts)
        throws CRLExdfption
    {
        this.issufr = issufr;
        this.thisUpdbtf = thisDbtf;
        this.nfxtUpdbtf = nfxtDbtf;
        if (bbdCfrts != null) {
            X500Prindipbl drlIssufr = gftIssufrX500Prindipbl();
            X500Prindipbl bbdCfrtIssufr = drlIssufr;
            for (int i = 0; i < bbdCfrts.lfngth; i++) {
                X509CRLEntryImpl bbdCfrt = (X509CRLEntryImpl)bbdCfrts[i];
                try {
                    bbdCfrtIssufr = gftCfrtIssufr(bbdCfrt, bbdCfrtIssufr);
                } dbtdh (IOExdfption iof) {
                    throw nfw CRLExdfption(iof);
                }
                bbdCfrt.sftCfrtifidbtfIssufr(drlIssufr, bbdCfrtIssufr);
                X509IssufrSfribl issufrSfribl = nfw X509IssufrSfribl
                    (bbdCfrtIssufr, bbdCfrt.gftSfriblNumbfr());
                this.rfvokfdMbp.put(issufrSfribl, bbdCfrt);
                this.rfvokfdList.bdd(bbdCfrt);
                if (bbdCfrt.hbsExtfnsions()) {
                    this.vfrsion = 1;
                }
            }
        }
    }

    /**
     * CRL donstrudtor, rfvokfd dfrts bnd fxtfnsions.
     *
     * @pbrbm issufr thf nbmf of thf CA issuing this CRL.
     * @pbrbm thisUpdbtf thf Dbtf of this issuf.
     * @pbrbm nfxtUpdbtf thf Dbtf of thf nfxt CRL.
     * @pbrbm bbdCfrts thf brrby of CRL fntrifs.
     * @pbrbm drlExts thf CRL fxtfnsions.
     *
     * @fxdfption CRLExdfption on pbrsing/donstrudtion frrors.
     */
    publid X509CRLImpl(X500Nbmf issufr, Dbtf thisDbtf, Dbtf nfxtDbtf,
               X509CRLEntry[] bbdCfrts, CRLExtfnsions drlExts)
        throws CRLExdfption
    {
        this(issufr, thisDbtf, nfxtDbtf, bbdCfrts);
        if (drlExts != null) {
            this.fxtfnsions = drlExts;
            this.vfrsion = 1;
        }
    }

    /**
     * Rfturnfd thf fndoding bs bn undlonfd bytf brrby. Cbllfrs must
     * gubrbntff thbt thfy nfithfr modify it nor fxposf it to untrustfd
     * dodf.
     */
    publid bytf[] gftEndodfdIntfrnbl() throws CRLExdfption {
        if (signfdCRL == null) {
            throw nfw CRLExdfption("Null CRL to fndodf");
        }
        rfturn signfdCRL;
    }

    /**
     * Rfturns thf ASN.1 DER fndodfd form of this CRL.
     *
     * @fxdfption CRLExdfption if bn fndoding frror oddurs.
     */
    publid bytf[] gftEndodfd() throws CRLExdfption {
        rfturn gftEndodfdIntfrnbl().dlonf();
    }

    /**
     * Endodfs thf "to-bf-signfd" CRL to thf OutputStrfbm.
     *
     * @pbrbm out thf OutputStrfbm to writf to.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid void fndodfInfo(OutputStrfbm out) throws CRLExdfption {
        try {
            DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
            DfrOutputStrfbm rCfrts = nfw DfrOutputStrfbm();
            DfrOutputStrfbm sfq = nfw DfrOutputStrfbm();

            if (vfrsion != 0) // v2 drl fndodf vfrsion
                tmp.putIntfgfr(vfrsion);
            infoSigAlgId.fndodf(tmp);
            if ((vfrsion == 0) && (issufr.toString() == null))
                throw nfw CRLExdfption("Null Issufr DN not bllowfd in v1 CRL");
            issufr.fndodf(tmp);

            if (thisUpdbtf.gftTimf() < YR_2050)
                tmp.putUTCTimf(thisUpdbtf);
            flsf
                tmp.putGfnfrblizfdTimf(thisUpdbtf);

            if (nfxtUpdbtf != null) {
                if (nfxtUpdbtf.gftTimf() < YR_2050)
                    tmp.putUTCTimf(nfxtUpdbtf);
                flsf
                    tmp.putGfnfrblizfdTimf(nfxtUpdbtf);
            }

            if (!rfvokfdList.isEmpty()) {
                for (X509CRLEntry fntry : rfvokfdList) {
                    ((X509CRLEntryImpl)fntry).fndodf(rCfrts);
                }
                tmp.writf(DfrVbluf.tbg_Sfqufndf, rCfrts);
            }

            if (fxtfnsions != null)
                fxtfnsions.fndodf(tmp, isExplidit);

            sfq.writf(DfrVbluf.tbg_Sfqufndf, tmp);

            tbsCfrtList = sfq.toBytfArrby();
            out.writf(tbsCfrtList);
        } dbtdh (IOExdfption f) {
             throw nfw CRLExdfption("Endoding frror: " + f.gftMfssbgf());
        }
    }

    /**
     * Vfrififs thbt this CRL wbs signfd using thf
     * privbtf kfy thbt dorrfsponds to thf givfn publid kfy.
     *
     * @pbrbm kfy thf PublidKfy usfd to dbrry out thf vfrifidbtion.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption if thfrf's no dffbult providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid void vfrify(PublidKfy kfy)
    throws CRLExdfption, NoSudhAlgorithmExdfption, InvblidKfyExdfption,
           NoSudhProvidfrExdfption, SignbturfExdfption {
        vfrify(kfy, "");
    }

    /**
     * Vfrififs thbt this CRL wbs signfd using thf
     * privbtf kfy thbt dorrfsponds to thf givfn publid kfy,
     * bnd thbt thf signbturf vfrifidbtion wbs domputfd by
     * thf givfn providfr.
     *
     * @pbrbm kfy thf PublidKfy usfd to dbrry out thf vfrifidbtion.
     * @pbrbm sigProvidfr thf nbmf of thf signbturf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption on indorrfdt providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid syndhronizfd void vfrify(PublidKfy kfy, String sigProvidfr)
            throws CRLExdfption, NoSudhAlgorithmExdfption, InvblidKfyExdfption,
            NoSudhProvidfrExdfption, SignbturfExdfption {

        if (sigProvidfr == null) {
            sigProvidfr = "";
        }
        if ((vfrififdPublidKfy != null) && vfrififdPublidKfy.fqubls(kfy)) {
            // this CRL hbs blrfbdy bffn suddfssfully vfrififd using
            // this publid kfy. Mbkf surf providfrs mbtdh, too.
            if (sigProvidfr.fqubls(vfrififdProvidfr)) {
                rfturn;
            }
        }
        if (signfdCRL == null) {
            throw nfw CRLExdfption("Uninitiblizfd CRL");
        }
        Signbturf   sigVfrf = null;
        if (sigProvidfr.lfngth() == 0) {
            sigVfrf = Signbturf.gftInstbndf(sigAlgId.gftNbmf());
        } flsf {
            sigVfrf = Signbturf.gftInstbndf(sigAlgId.gftNbmf(), sigProvidfr);
        }
        sigVfrf.initVfrify(kfy);

        if (tbsCfrtList == null) {
            throw nfw CRLExdfption("Uninitiblizfd CRL");
        }

        sigVfrf.updbtf(tbsCfrtList, 0, tbsCfrtList.lfngth);

        if (!sigVfrf.vfrify(signbturf)) {
            throw nfw SignbturfExdfption("Signbturf dofs not mbtdh.");
        }
        vfrififdPublidKfy = kfy;
        vfrififdProvidfr = sigProvidfr;
    }

    /**
     * Vfrififs thbt this CRL wbs signfd using thf
     * privbtf kfy thbt dorrfsponds to thf givfn publid kfy,
     * bnd thbt thf signbturf vfrifidbtion wbs domputfd by
     * thf givfn providfr. Notf thbt thf spfdififd Providfr objfdt
     * dofs not hbvf to bf rfgistfrfd in thf providfr list.
     *
     * @pbrbm kfy thf PublidKfy usfd to dbrry out thf vfrifidbtion.
     * @pbrbm sigProvidfr thf signbturf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid syndhronizfd void vfrify(PublidKfy kfy, Providfr sigProvidfr)
            throws CRLExdfption, NoSudhAlgorithmExdfption, InvblidKfyExdfption,
            SignbturfExdfption {

        if (signfdCRL == null) {
            throw nfw CRLExdfption("Uninitiblizfd CRL");
        }
        Signbturf sigVfrf = null;
        if (sigProvidfr == null) {
            sigVfrf = Signbturf.gftInstbndf(sigAlgId.gftNbmf());
        } flsf {
            sigVfrf = Signbturf.gftInstbndf(sigAlgId.gftNbmf(), sigProvidfr);
        }
        sigVfrf.initVfrify(kfy);

        if (tbsCfrtList == null) {
            throw nfw CRLExdfption("Uninitiblizfd CRL");
        }

        sigVfrf.updbtf(tbsCfrtList, 0, tbsCfrtList.lfngth);

        if (!sigVfrf.vfrify(signbturf)) {
            throw nfw SignbturfExdfption("Signbturf dofs not mbtdh.");
        }
        vfrififdPublidKfy = kfy;
    }

    /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * vfrify(PublidKfy kfy, Providfr sigProvidfr) mfthod in X509CRL.
     * Cbllfd from jbvb.sfdurity.dfrt.X509CRL.vfrify(PublidKfy kfy,
     * Providfr sigProvidfr)
     */
    publid stbtid void vfrify(X509CRL drl, PublidKfy kfy,
            Providfr sigProvidfr) throws CRLExdfption,
            NoSudhAlgorithmExdfption, InvblidKfyExdfption, SignbturfExdfption {
        drl.vfrify(kfy, sigProvidfr);
    }

    /**
     * Endodfs bn X.509 CRL, bnd signs it using thf givfn kfy.
     *
     * @pbrbm kfy thf privbtf kfy usfd for signing.
     * @pbrbm blgorithm thf nbmf of thf signbturf blgorithm usfd.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption on indorrfdt providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CRLExdfption if bny mbndbtory dbtb wbs omittfd.
     */
    publid void sign(PrivbtfKfy kfy, String blgorithm)
    throws CRLExdfption, NoSudhAlgorithmExdfption, InvblidKfyExdfption,
        NoSudhProvidfrExdfption, SignbturfExdfption {
        sign(kfy, blgorithm, null);
    }

    /**
     * Endodfs bn X.509 CRL, bnd signs it using thf givfn kfy.
     *
     * @pbrbm kfy thf privbtf kfy usfd for signing.
     * @pbrbm blgorithm thf nbmf of thf signbturf blgorithm usfd.
     * @pbrbm providfr thf nbmf of thf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption on indorrfdt providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CRLExdfption if bny mbndbtory dbtb wbs omittfd.
     */
    publid void sign(PrivbtfKfy kfy, String blgorithm, String providfr)
    throws CRLExdfption, NoSudhAlgorithmExdfption, InvblidKfyExdfption,
        NoSudhProvidfrExdfption, SignbturfExdfption {
        try {
            if (rfbdOnly)
                throw nfw CRLExdfption("dbnnot ovfr-writf fxisting CRL");
            Signbturf sigEnginf = null;
            if ((providfr == null) || (providfr.lfngth() == 0))
                sigEnginf = Signbturf.gftInstbndf(blgorithm);
            flsf
                sigEnginf = Signbturf.gftInstbndf(blgorithm, providfr);

            sigEnginf.initSign(kfy);

                                // in dbsf thf nbmf is rfsft
            sigAlgId = AlgorithmId.gft(sigEnginf.gftAlgorithm());
            infoSigAlgId = sigAlgId;

            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();

            // fndodf drl info
            fndodfInfo(tmp);

            // fndodf blgorithm idfntififr
            sigAlgId.fndodf(tmp);

            // Crfbtf bnd fndodf thf signbturf itsflf.
            sigEnginf.updbtf(tbsCfrtList, 0, tbsCfrtList.lfngth);
            signbturf = sigEnginf.sign();
            tmp.putBitString(signbturf);

            // Wrbp thf signfd dbtb in b SEQUENCE { dbtb, blgorithm, sig }
            out.writf(DfrVbluf.tbg_Sfqufndf, tmp);
            signfdCRL = out.toBytfArrby();
            rfbdOnly = truf;

        } dbtdh (IOExdfption f) {
            throw nfw CRLExdfption("Error whilf fndoding dbtb: " +
                                   f.gftMfssbgf());
        }
    }

    /**
     * Rfturns b printbblf string of this CRL.
     *
     * @rfturn vbluf of this CRL in b printbblf form.
     */
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd("X.509 CRL v" + (vfrsion+1) + "\n");
        if (sigAlgId != null)
            sb.bppfnd("Signbturf Algorithm: " + sigAlgId.toString() +
                  ", OID=" + (sigAlgId.gftOID()).toString() + "\n");
        if (issufr != null)
            sb.bppfnd("Issufr: " + issufr.toString() + "\n");
        if (thisUpdbtf != null)
            sb.bppfnd("\nThis Updbtf: " + thisUpdbtf.toString() + "\n");
        if (nfxtUpdbtf != null)
            sb.bppfnd("Nfxt Updbtf: " + nfxtUpdbtf.toString() + "\n");
        if (rfvokfdList.isEmpty())
            sb.bppfnd("\nNO dfrtifidbtfs hbvf bffn rfvokfd\n");
        flsf {
            sb.bppfnd("\nRfvokfd Cfrtifidbtfs: " + rfvokfdList.sizf());
            int i = 1;
            for (X509CRLEntry fntry: rfvokfdList) {
                sb.bppfnd("\n[" + i++ + "] " + fntry.toString());
            }
        }
        if (fxtfnsions != null) {
            Collfdtion<Extfnsion> bllExts = fxtfnsions.gftAllExtfnsions();
            Objfdt[] objs = bllExts.toArrby();
            sb.bppfnd("\nCRL Extfnsions: " + objs.lfngth);
            for (int i = 0; i < objs.lfngth; i++) {
                sb.bppfnd("\n[" + (i+1) + "]: ");
                Extfnsion fxt = (Extfnsion)objs[i];
                try {
                   if (OIDMbp.gftClbss(fxt.gftExtfnsionId()) == null) {
                       sb.bppfnd(fxt.toString());
                       bytf[] fxtVbluf = fxt.gftExtfnsionVbluf();
                       if (fxtVbluf != null) {
                           DfrOutputStrfbm out = nfw DfrOutputStrfbm();
                           out.putOdtftString(fxtVbluf);
                           fxtVbluf = out.toBytfArrby();
                           HfxDumpEndodfr fnd = nfw HfxDumpEndodfr();
                           sb.bppfnd("Extfnsion unknown: "
                                     + "DER fndodfd OCTET string =\n"
                                     + fnd.fndodfBufffr(fxtVbluf) + "\n");
                      }
                   } flsf
                       sb.bppfnd(fxt.toString()); // sub-dlbss fxists
                } dbtdh (Exdfption f) {
                    sb.bppfnd(", Error pbrsing this fxtfnsion");
                }
            }
        }
        if (signbturf != null) {
            HfxDumpEndodfr fndodfr = nfw HfxDumpEndodfr();
            sb.bppfnd("\nSignbturf:\n" + fndodfr.fndodfBufffr(signbturf)
                      + "\n");
        } flsf
            sb.bppfnd("NOT signfd yft\n");
        rfturn sb.toString();
    }

    /**
     * Chfdks whfthfr thf givfn dfrtifidbtf is on this CRL.
     *
     * @pbrbm dfrt thf dfrtifidbtf to dhfdk for.
     * @rfturn truf if thf givfn dfrtifidbtf is on this CRL,
     * fblsf othfrwisf.
     */
    publid boolfbn isRfvokfd(Cfrtifidbtf dfrt) {
        if (rfvokfdMbp.isEmpty() || (!(dfrt instbndfof X509Cfrtifidbtf))) {
            rfturn fblsf;
        }
        X509Cfrtifidbtf xdfrt = (X509Cfrtifidbtf) dfrt;
        X509IssufrSfribl issufrSfribl = nfw X509IssufrSfribl(xdfrt);
        rfturn rfvokfdMbp.dontbinsKfy(issufrSfribl);
    }

    /**
     * Gfts thf vfrsion numbfr from this CRL.
     * Thf ASN.1 dffinition for this is:
     * <prf>
     * Vfrsion  ::=  INTEGER  {  v1(0), v2(1), v3(2)  }
     *             -- v3 dofs not bpply to CRLs but bppfbrs for donsistfndy
     *             -- with dffinition of Vfrsion for dfrts
     * </prf>
     * @rfturn thf vfrsion numbfr, i.f. 1 or 2.
     */
    publid int gftVfrsion() {
        rfturn vfrsion+1;
    }

    /**
     * Gfts thf issufr distinguishfd nbmf from this CRL.
     * Thf issufr nbmf idfntififs thf fntity who hbs signfd (bnd
     * issufd thf CRL). Thf issufr nbmf fifld dontbins bn
     * X.500 distinguishfd nbmf (DN).
     * Thf ASN.1 dffinition for this is:
     * <prf>
     * issufr    Nbmf
     *
     * Nbmf ::= CHOICE { RDNSfqufndf }
     * RDNSfqufndf ::= SEQUENCE OF RflbtivfDistinguishfdNbmf
     * RflbtivfDistinguishfdNbmf ::=
     *     SET OF AttributfVblufAssfrtion
     *
     * AttributfVblufAssfrtion ::= SEQUENCE {
     *                               AttributfTypf,
     *                               AttributfVbluf }
     * AttributfTypf ::= OBJECT IDENTIFIER
     * AttributfVbluf ::= ANY
     * </prf>
     * Thf Nbmf dfsdribfs b hifrbrdhidbl nbmf domposfd of bttributfs,
     * sudh bs dountry nbmf, bnd dorrfsponding vblufs, sudh bs US.
     * Thf typf of thf domponfnt AttributfVbluf is dftfrminfd by thf
     * AttributfTypf; in gfnfrbl it will bf b dirfdtoryString.
     * A dirfdtoryString is usublly onf of PrintbblfString,
     * TflftfxString or UnivfrsblString.
     * @rfturn thf issufr nbmf.
     */
    publid Prindipbl gftIssufrDN() {
        rfturn (Prindipbl)issufr;
    }

    /**
     * Rfturn thf issufr bs X500Prindipbl. Ovfrridfs mfthod in X509CRL
     * to providf b slightly morf fffidifnt vfrsion.
     */
    publid X500Prindipbl gftIssufrX500Prindipbl() {
        if (issufrPrindipbl == null) {
            issufrPrindipbl = issufr.bsX500Prindipbl();
        }
        rfturn issufrPrindipbl;
    }

    /**
     * Gfts thf thisUpdbtf dbtf from thf CRL.
     * Thf ASN.1 dffinition for this is:
     *
     * @rfturn thf thisUpdbtf dbtf from thf CRL.
     */
    publid Dbtf gftThisUpdbtf() {
        rfturn (nfw Dbtf(thisUpdbtf.gftTimf()));
    }

    /**
     * Gfts thf nfxtUpdbtf dbtf from thf CRL.
     *
     * @rfturn thf nfxtUpdbtf dbtf from thf CRL, or null if
     * not prfsfnt.
     */
    publid Dbtf gftNfxtUpdbtf() {
        if (nfxtUpdbtf == null)
            rfturn null;
        rfturn (nfw Dbtf(nfxtUpdbtf.gftTimf()));
    }

    /**
     * Gfts thf CRL fntry with thf givfn sfribl numbfr from this CRL.
     *
     * @rfturn thf fntry with thf givfn sfribl numbfr, or <dodf>null</dodf> if
     * no sudh fntry fxists in thf CRL.
     * @sff X509CRLEntry
     */
    publid X509CRLEntry gftRfvokfdCfrtifidbtf(BigIntfgfr sfriblNumbfr) {
        if (rfvokfdMbp.isEmpty()) {
            rfturn null;
        }
        // bssumf this is b dirfdt CRL fntry (dfrt bnd CRL issufr brf thf sbmf)
        X509IssufrSfribl issufrSfribl = nfw X509IssufrSfribl
            (gftIssufrX500Prindipbl(), sfriblNumbfr);
        rfturn rfvokfdMbp.gft(issufrSfribl);
    }

    /**
     * Gfts thf CRL fntry for thf givfn dfrtifidbtf.
     */
    publid X509CRLEntry gftRfvokfdCfrtifidbtf(X509Cfrtifidbtf dfrt) {
        if (rfvokfdMbp.isEmpty()) {
            rfturn null;
        }
        X509IssufrSfribl issufrSfribl = nfw X509IssufrSfribl(dfrt);
        rfturn rfvokfdMbp.gft(issufrSfribl);
    }

    /**
     * Gfts bll thf rfvokfd dfrtifidbtfs from thf CRL.
     * A Sft of X509CRLEntry.
     *
     * @rfturn bll thf rfvokfd dfrtifidbtfs or <dodf>null</dodf> if thfrf brf
     * nonf.
     * @sff X509CRLEntry
     */
    publid Sft<X509CRLEntry> gftRfvokfdCfrtifidbtfs() {
        if (rfvokfdList.isEmpty()) {
            rfturn null;
        } flsf {
            rfturn nfw TrffSft<X509CRLEntry>(rfvokfdList);
        }
    }

    /**
     * Gfts thf DER fndodfd CRL informbtion, thf
     * <dodf>tbsCfrtList</dodf> from this CRL.
     * This dbn bf usfd to vfrify thf signbturf indfpfndfntly.
     *
     * @rfturn thf DER fndodfd CRL informbtion.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid bytf[] gftTBSCfrtList() throws CRLExdfption {
        if (tbsCfrtList == null)
            throw nfw CRLExdfption("Uninitiblizfd CRL");
        bytf[] dup = nfw bytf[tbsCfrtList.lfngth];
        Systfm.brrbydopy(tbsCfrtList, 0, dup, 0, dup.lfngth);
        rfturn dup;
    }

    /**
     * Gfts thf rbw Signbturf bits from thf CRL.
     *
     * @rfturn thf signbturf.
     */
    publid bytf[] gftSignbturf() {
        if (signbturf == null)
            rfturn null;
        bytf[] dup = nfw bytf[signbturf.lfngth];
        Systfm.brrbydopy(signbturf, 0, dup, 0, dup.lfngth);
        rfturn dup;
    }

    /**
     * Gfts thf signbturf blgorithm nbmf for thf CRL
     * signbturf blgorithm. For fxbmplf, thf string "SHA1withDSA".
     * Thf ASN.1 dffinition for this is:
     * <prf>
     * AlgorithmIdfntififr  ::=  SEQUENCE  {
     *     blgorithm               OBJECT IDENTIFIER,
     *     pbrbmftfrs              ANY DEFINED BY blgorithm OPTIONAL  }
     *                             -- dontbins b vbluf of thf typf
     *                             -- rfgistfrfd for usf with thf
     *                             -- blgorithm objfdt idfntififr vbluf
     * </prf>
     *
     * @rfturn thf signbturf blgorithm nbmf.
     */
    publid String gftSigAlgNbmf() {
        if (sigAlgId == null)
            rfturn null;
        rfturn sigAlgId.gftNbmf();
    }

    /**
     * Gfts thf signbturf blgorithm OID string from thf CRL.
     * An OID is rfprfsfntfd by b sft of positivf wholf numbfr sfpbrbtfd
     * by ".", thbt mfbns,<br>
     * &lt;positivf wholf numbfr&gt;.&lt;positivf wholf numbfr&gt;.&lt;...&gt;
     * For fxbmplf, thf string "1.2.840.10040.4.3" idfntififs thf SHA-1
     * with DSA signbturf blgorithm dffinfd in
     * <b hrff="http://www.iftf.org/rfd/rfd3279.txt">RFC 3279: Algorithms bnd
     * Idfntififrs for thf Intfrnft X.509 Publid Kfy Infrbstrudturf Cfrtifidbtf
     * bnd CRL Profilf</b>.
     *
     * @rfturn thf signbturf blgorithm oid string.
     */
    publid String gftSigAlgOID() {
        if (sigAlgId == null)
            rfturn null;
        ObjfdtIdfntififr oid = sigAlgId.gftOID();
        rfturn oid.toString();
    }

    /**
     * Gfts thf DER fndodfd signbturf blgorithm pbrbmftfrs from this
     * CRL's signbturf blgorithm. In most dbsfs, thf signbturf
     * blgorithm pbrbmftfrs brf null, thf pbrbmftfrs brf usublly
     * supplifd with thf Publid Kfy.
     *
     * @rfturn thf DER fndodfd signbturf blgorithm pbrbmftfrs, or
     *         null if no pbrbmftfrs brf prfsfnt.
     */
    publid bytf[] gftSigAlgPbrbms() {
        if (sigAlgId == null)
            rfturn null;
        try {
            rfturn sigAlgId.gftEndodfdPbrbms();
        } dbtdh (IOExdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf signbturf AlgorithmId from thf CRL.
     *
     * @rfturn thf signbturf AlgorithmId
     */
    publid AlgorithmId gftSigAlgId() {
        rfturn sigAlgId;
    }

    /**
     * rfturn thf AuthorityKfyIdfntififr, if bny.
     *
     * @rfturns AuthorityKfyIdfntififr or null
     *          (if no AuthorityKfyIdfntififrExtfnsion)
     * @throws IOExdfption on frror
     */
    publid KfyIdfntififr gftAuthKfyId() throws IOExdfption {
        AuthorityKfyIdfntififrExtfnsion bki = gftAuthKfyIdExtfnsion();
        if (bki != null) {
            KfyIdfntififr kfyId = (KfyIdfntififr)bki.gft(
                    AuthorityKfyIdfntififrExtfnsion.KEY_ID);
            rfturn kfyId;
        } flsf {
            rfturn null;
        }
    }

    /**
     * rfturn thf AuthorityKfyIdfntififrExtfnsion, if bny.
     *
     * @rfturns AuthorityKfyIdfntififrExtfnsion or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid AuthorityKfyIdfntififrExtfnsion gftAuthKfyIdExtfnsion()
        throws IOExdfption {
        Objfdt obj = gftExtfnsion(PKIXExtfnsions.AuthorityKfy_Id);
        rfturn (AuthorityKfyIdfntififrExtfnsion)obj;
    }

    /**
     * rfturn thf CRLNumbfrExtfnsion, if bny.
     *
     * @rfturns CRLNumbfrExtfnsion or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid CRLNumbfrExtfnsion gftCRLNumbfrExtfnsion() throws IOExdfption {
        Objfdt obj = gftExtfnsion(PKIXExtfnsions.CRLNumbfr_Id);
        rfturn (CRLNumbfrExtfnsion)obj;
    }

    /**
     * rfturn thf CRL numbfr from thf CRLNumbfrExtfnsion, if bny.
     *
     * @rfturns numbfr or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid BigIntfgfr gftCRLNumbfr() throws IOExdfption {
        CRLNumbfrExtfnsion numExt = gftCRLNumbfrExtfnsion();
        if (numExt != null) {
            BigIntfgfr num = numExt.gft(CRLNumbfrExtfnsion.NUMBER);
            rfturn num;
        } flsf {
            rfturn null;
        }
    }

    /**
     * rfturn thf DfltbCRLIndidbtorExtfnsion, if bny.
     *
     * @rfturns DfltbCRLIndidbtorExtfnsion or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid DfltbCRLIndidbtorExtfnsion gftDfltbCRLIndidbtorExtfnsion()
        throws IOExdfption {

        Objfdt obj = gftExtfnsion(PKIXExtfnsions.DfltbCRLIndidbtor_Id);
        rfturn (DfltbCRLIndidbtorExtfnsion)obj;
    }

    /**
     * rfturn thf bbsf CRL numbfr from thf DfltbCRLIndidbtorExtfnsion, if bny.
     *
     * @rfturns numbfr or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid BigIntfgfr gftBbsfCRLNumbfr() throws IOExdfption {
        DfltbCRLIndidbtorExtfnsion ddiExt = gftDfltbCRLIndidbtorExtfnsion();
        if (ddiExt != null) {
            BigIntfgfr num = ddiExt.gft(DfltbCRLIndidbtorExtfnsion.NUMBER);
            rfturn num;
        } flsf {
            rfturn null;
        }
    }

    /**
     * rfturn thf IssufrAltfrnbtivfNbmfExtfnsion, if bny.
     *
     * @rfturns IssufrAltfrnbtivfNbmfExtfnsion or null (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid IssufrAltfrnbtivfNbmfExtfnsion gftIssufrAltNbmfExtfnsion()
        throws IOExdfption {
        Objfdt obj = gftExtfnsion(PKIXExtfnsions.IssufrAltfrnbtivfNbmf_Id);
        rfturn (IssufrAltfrnbtivfNbmfExtfnsion)obj;
    }

    /**
     * rfturn thf IssuingDistributionPointExtfnsion, if bny.
     *
     * @rfturns IssuingDistributionPointExtfnsion or null
     *          (if no sudh fxtfnsion)
     * @throws IOExdfption on frror
     */
    publid IssuingDistributionPointExtfnsion
        gftIssuingDistributionPointExtfnsion() throws IOExdfption {

        Objfdt obj = gftExtfnsion(PKIXExtfnsions.IssuingDistributionPoint_Id);
        rfturn (IssuingDistributionPointExtfnsion) obj;
    }

    /**
     * Rfturn truf if b dritidbl fxtfnsion is found thbt is
     * not supportfd, othfrwisf rfturn fblsf.
     */
    publid boolfbn hbsUnsupportfdCritidblExtfnsion() {
        if (fxtfnsions == null)
            rfturn fblsf;
        rfturn fxtfnsions.hbsUnsupportfdCritidblExtfnsion();
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd CRITICAL in thf
     * CRL. In thf rfturnfd sft, fbdh fxtfnsion is rfprfsfntfd by
     * its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * CRL thbt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd NON-CRITICAL in thf
     * CRL. In thf rfturnfd sft, fbdh fxtfnsion is rfprfsfntfd by
     * its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * CRL thbt brf NOT mbrkfd dritidbl.
     */
    publid Sft<String> gftNonCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (!fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts thf DER fndodfd OCTET string for thf fxtfnsion vbluf
     * (<dodf>fxtnVbluf</dodf>) idfntififd by thf pbssfd in oid String.
     * Thf <dodf>oid</dodf> string is
     * rfprfsfntfd by b sft of positivf wholf numbfr sfpbrbtfd
     * by ".", thbt mfbns,<br>
     * &lt;positivf wholf numbfr&gt;.&lt;positivf wholf numbfr&gt;.&lt;...&gt;
     *
     * @pbrbm oid thf Objfdt Idfntififr vbluf for thf fxtfnsion.
     * @rfturn thf dfr fndodfd odtft string of thf fxtfnsion vbluf.
     */
    publid bytf[] gftExtfnsionVbluf(String oid) {
        if (fxtfnsions == null)
            rfturn null;
        try {
            String fxtAlibs = OIDMbp.gftNbmf(nfw ObjfdtIdfntififr(oid));
            Extfnsion drlExt = null;

            if (fxtAlibs == null) { // mby bf unknown
                ObjfdtIdfntififr findOID = nfw ObjfdtIdfntififr(oid);
                Extfnsion fx = null;
                ObjfdtIdfntififr inCfrtOID;
                for (Enumfrbtion<Extfnsion> f = fxtfnsions.gftElfmfnts();
                                                 f.hbsMorfElfmfnts();) {
                    fx = f.nfxtElfmfnt();
                    inCfrtOID = fx.gftExtfnsionId();
                    if (inCfrtOID.fqubls((Objfdt)findOID)) {
                        drlExt = fx;
                        brfbk;
                    }
                }
            } flsf
                drlExt = fxtfnsions.gft(fxtAlibs);
            if (drlExt == null)
                rfturn null;
            bytf[] fxtDbtb = drlExt.gftExtfnsionVbluf();
            if (fxtDbtb == null)
                rfturn null;
            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            out.putOdtftString(fxtDbtb);
            rfturn out.toBytfArrby();
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * gft bn fxtfnsion
     *
     * @pbrbm oid ObjfdtIdfntififr of fxtfnsion dfsirfd
     * @rfturns Objfdt of typf <fxtfnsion> or null, if not found
     * @throws IOExdfption on frror
     */
    publid Objfdt gftExtfnsion(ObjfdtIdfntififr oid) {
        if (fxtfnsions == null)
            rfturn null;

        // XXX Considfr dloning this
        rfturn fxtfnsions.gft(OIDMbp.gftNbmf(oid));
    }

    /*
     * Pbrsfs bn X.509 CRL, should bf usfd only by donstrudtors.
     */
    privbtf void pbrsf(DfrVbluf vbl) throws CRLExdfption, IOExdfption {
        // dhfdk if dbn ovfr writf thf dfrtifidbtf
        if (rfbdOnly)
            throw nfw CRLExdfption("dbnnot ovfr-writf fxisting CRL");

        if ( vbl.gftDbtb() == null || vbl.tbg != DfrVbluf.tbg_Sfqufndf)
            throw nfw CRLExdfption("Invblid DER-fndodfd CRL dbtb");

        signfdCRL = vbl.toBytfArrby();
        DfrVbluf sfq[] = nfw DfrVbluf[3];

        sfq[0] = vbl.dbtb.gftDfrVbluf();
        sfq[1] = vbl.dbtb.gftDfrVbluf();
        sfq[2] = vbl.dbtb.gftDfrVbluf();

        if (vbl.dbtb.bvbilbblf() != 0)
            throw nfw CRLExdfption("signfd ovfrrun, bytfs = "
                                     + vbl.dbtb.bvbilbblf());

        if (sfq[0].tbg != DfrVbluf.tbg_Sfqufndf)
            throw nfw CRLExdfption("signfd CRL fiflds invblid");

        sigAlgId = AlgorithmId.pbrsf(sfq[1]);
        signbturf = sfq[2].gftBitString();

        if (sfq[1].dbtb.bvbilbblf() != 0)
            throw nfw CRLExdfption("AlgorithmId fifld ovfrrun");

        if (sfq[2].dbtb.bvbilbblf() != 0)
            throw nfw CRLExdfption("Signbturf fifld ovfrrun");

        // thf tbsCfrtsList
        tbsCfrtList = sfq[0].toBytfArrby();

        // pbrsf thf informbtion
        DfrInputStrfbm dfrStrm = sfq[0].dbtb;
        DfrVbluf       tmp;
        bytf           nfxtBytf;

        // vfrsion (optionbl if v1)
        vfrsion = 0;   // by dffbult, vfrsion = v1 == 0
        nfxtBytf = (bytf)dfrStrm.pffkBytf();
        if (nfxtBytf == DfrVbluf.tbg_Intfgfr) {
            vfrsion = dfrStrm.gftIntfgfr();
            if (vfrsion != 1)  // i.f. v2
                throw nfw CRLExdfption("Invblid vfrsion");
        }
        tmp = dfrStrm.gftDfrVbluf();

        // signbturf
        AlgorithmId tmpId = AlgorithmId.pbrsf(tmp);

        // thf "innfr" bnd "outfr" signbturf blgorithms must mbtdh
        if (! tmpId.fqubls(sigAlgId))
            throw nfw CRLExdfption("Signbturf blgorithm mismbtdh");
        infoSigAlgId = tmpId;

        // issufr
        issufr = nfw X500Nbmf(dfrStrm);
        if (issufr.isEmpty()) {
            throw nfw CRLExdfption("Empty issufr DN not bllowfd in X509CRLs");
        }

        // thisUpdbtf
        // dhfdk if UTCTimf fndodfd or GfnfrblizfdTimf

        nfxtBytf = (bytf)dfrStrm.pffkBytf();
        if (nfxtBytf == DfrVbluf.tbg_UtdTimf) {
            thisUpdbtf = dfrStrm.gftUTCTimf();
        } flsf if (nfxtBytf == DfrVbluf.tbg_GfnfrblizfdTimf) {
            thisUpdbtf = dfrStrm.gftGfnfrblizfdTimf();
        } flsf {
            throw nfw CRLExdfption("Invblid fndoding for thisUpdbtf"
                                   + " (tbg=" + nfxtBytf + ")");
        }

        if (dfrStrm.bvbilbblf() == 0)
           rfturn;     // donf pbrsing no morf optionbl fiflds prfsfnt

        // nfxtUpdbtf (optionbl)
        nfxtBytf = (bytf)dfrStrm.pffkBytf();
        if (nfxtBytf == DfrVbluf.tbg_UtdTimf) {
            nfxtUpdbtf = dfrStrm.gftUTCTimf();
        } flsf if (nfxtBytf == DfrVbluf.tbg_GfnfrblizfdTimf) {
            nfxtUpdbtf = dfrStrm.gftGfnfrblizfdTimf();
        } // flsf it is not prfsfnt

        if (dfrStrm.bvbilbblf() == 0)
            rfturn;     // donf pbrsing no morf optionbl fiflds prfsfnt

        // rfvokfdCfrtifidbtfs (optionbl)
        nfxtBytf = (bytf)dfrStrm.pffkBytf();
        if ((nfxtBytf == DfrVbluf.tbg_SfqufndfOf)
            && (! ((nfxtBytf & 0x0d0) == 0x080))) {
            DfrVbluf[] bbdCfrts = dfrStrm.gftSfqufndf(4);

            X500Prindipbl drlIssufr = gftIssufrX500Prindipbl();
            X500Prindipbl bbdCfrtIssufr = drlIssufr;
            for (int i = 0; i < bbdCfrts.lfngth; i++) {
                X509CRLEntryImpl fntry = nfw X509CRLEntryImpl(bbdCfrts[i]);
                bbdCfrtIssufr = gftCfrtIssufr(fntry, bbdCfrtIssufr);
                fntry.sftCfrtifidbtfIssufr(drlIssufr, bbdCfrtIssufr);
                X509IssufrSfribl issufrSfribl = nfw X509IssufrSfribl
                    (bbdCfrtIssufr, fntry.gftSfriblNumbfr());
                rfvokfdMbp.put(issufrSfribl, fntry);
                rfvokfdList.bdd(fntry);
            }
        }

        if (dfrStrm.bvbilbblf() == 0)
            rfturn;     // donf pbrsing no fxtfnsions

        // drlExtfnsions (optionbl)
        tmp = dfrStrm.gftDfrVbluf();
        if (tmp.isConstrudtfd() && tmp.isContfxtSpfdifid((bytf)0)) {
            fxtfnsions = nfw CRLExtfnsions(tmp.dbtb);
        }
        rfbdOnly = truf;
    }

    /**
     * Extrbdt thf issufr X500Prindipbl from bn X509CRL. Pbrsfs thf fndodfd
     * form of thf CRL to prfsfrvf thf prindipbl's ASN.1 fndoding.
     *
     * Cbllfd by jbvb.sfdurity.dfrt.X509CRL.gftIssufrX500Prindipbl().
     */
    publid stbtid X500Prindipbl gftIssufrX500Prindipbl(X509CRL drl) {
        try {
            bytf[] fndodfd = drl.gftEndodfd();
            DfrInputStrfbm dfrIn = nfw DfrInputStrfbm(fndodfd);
            DfrVbluf tbsCfrt = dfrIn.gftSfqufndf(3)[0];
            DfrInputStrfbm tbsIn = tbsCfrt.dbtb;

            DfrVbluf tmp;
            // skip vfrsion numbfr if prfsfnt
            bytf nfxtBytf = (bytf)tbsIn.pffkBytf();
            if (nfxtBytf == DfrVbluf.tbg_Intfgfr) {
                tmp = tbsIn.gftDfrVbluf();
            }

            tmp = tbsIn.gftDfrVbluf();  // skip signbturf
            tmp = tbsIn.gftDfrVbluf();  // issufr
            bytf[] prindipblBytfs = tmp.toBytfArrby();
            rfturn nfw X500Prindipbl(prindipblBytfs);
        } dbtdh (Exdfption f) {
            throw nfw RuntimfExdfption("Could not pbrsf issufr", f);
        }
    }

    /**
     * Rfturnfd thf fndoding of thf givfn dfrtifidbtf for intfrnbl usf.
     * Cbllfrs must gubrbntff thbt thfy nfithfr modify it nor fxposf it
     * to untrustfd dodf. Usfs gftEndodfdIntfrnbl() if thf dfrtifidbtf
     * is instbndf of X509CfrtImpl, gftEndodfd() othfrwisf.
     */
    publid stbtid bytf[] gftEndodfdIntfrnbl(X509CRL drl) throws CRLExdfption {
        if (drl instbndfof X509CRLImpl) {
            rfturn ((X509CRLImpl)drl).gftEndodfdIntfrnbl();
        } flsf {
            rfturn drl.gftEndodfd();
        }
    }

    /**
     * Utility mfthod to donvfrt bn brbitrbry instbndf of X509CRL
     * to b X509CRLImpl. Dofs b dbst if possiblf, othfrwisf rfpbrsfs
     * thf fndoding.
     */
    publid stbtid X509CRLImpl toImpl(X509CRL drl)
            throws CRLExdfption {
        if (drl instbndfof X509CRLImpl) {
            rfturn (X509CRLImpl)drl;
        } flsf {
            rfturn X509Fbdtory.intfrn(drl);
        }
    }

    /**
     * Rfturns thf X500 dfrtifidbtf issufr DN of b CRL fntry.
     *
     * @pbrbm fntry thf fntry to dhfdk
     * @pbrbm prfvCfrtIssufr thf prfvious fntry's dfrtifidbtf issufr
     * @rfturn thf X500Prindipbl in b CfrtifidbtfIssufrExtfnsion, or
     *   prfvCfrtIssufr if it dofs not fxist
     */
    privbtf X500Prindipbl gftCfrtIssufr(X509CRLEntryImpl fntry,
        X500Prindipbl prfvCfrtIssufr) throws IOExdfption {

        CfrtifidbtfIssufrExtfnsion diExt =
            fntry.gftCfrtifidbtfIssufrExtfnsion();
        if (diExt != null) {
            GfnfrblNbmfs nbmfs = diExt.gft(CfrtifidbtfIssufrExtfnsion.ISSUER);
            X500Nbmf issufrDN = (X500Nbmf) nbmfs.gft(0).gftNbmf();
            rfturn issufrDN.bsX500Prindipbl();
        } flsf {
            rfturn prfvCfrtIssufr;
        }
    }

    @Ovfrridf
    publid void dfrEndodf(OutputStrfbm out) throws IOExdfption {
        if (signfdCRL == null)
            throw nfw IOExdfption("Null CRL to fndodf");
        out.writf(signfdCRL.dlonf());
    }

    /**
     * Immutbblf X.509 Cfrtifidbtf Issufr DN bnd sfribl numbfr pbir
     */
    privbtf finbl stbtid dlbss X509IssufrSfribl
            implfmfnts Compbrbblf<X509IssufrSfribl> {
        finbl X500Prindipbl issufr;
        finbl BigIntfgfr sfribl;
        volbtilf int hbshdodf = 0;

        /**
         * Crfbtf bn X509IssufrSfribl.
         *
         * @pbrbm issufr thf issufr DN
         * @pbrbm sfribl thf sfribl numbfr
         */
        X509IssufrSfribl(X500Prindipbl issufr, BigIntfgfr sfribl) {
            this.issufr = issufr;
            this.sfribl = sfribl;
        }

        /**
         * Construdt bn X509IssufrSfribl from bn X509Cfrtifidbtf.
         */
        X509IssufrSfribl(X509Cfrtifidbtf dfrt) {
            this(dfrt.gftIssufrX500Prindipbl(), dfrt.gftSfriblNumbfr());
        }

        /**
         * Rfturns thf issufr.
         *
         * @rfturn thf issufr
         */
        X500Prindipbl gftIssufr() {
            rfturn issufr;
        }

        /**
         * Rfturns thf sfribl numbfr.
         *
         * @rfturn thf sfribl numbfr
         */
        BigIntfgfr gftSfribl() {
            rfturn sfribl;
        }

        /**
         * Compbrfs this X509Sfribl with bnothfr bnd rfturns truf if thfy
         * brf fquivblfnt.
         *
         * @pbrbm o thf othfr objfdt to dompbrf with
         * @rfturn truf if fqubl, fblsf othfrwisf
         */
        publid boolfbn fqubls(Objfdt o) {
            if (o == this) {
                rfturn truf;
            }

            if (!(o instbndfof X509IssufrSfribl)) {
                rfturn fblsf;
            }

            X509IssufrSfribl othfr = (X509IssufrSfribl) o;
            if (sfribl.fqubls(othfr.gftSfribl()) &&
                issufr.fqubls(othfr.gftIssufr())) {
                rfturn truf;
            }
            rfturn fblsf;
        }

        /**
         * Rfturns b hbsh dodf vbluf for this X509IssufrSfribl.
         *
         * @rfturn thf hbsh dodf vbluf
         */
        publid int hbshCodf() {
            if (hbshdodf == 0) {
                int rfsult = 17;
                rfsult = 37*rfsult + issufr.hbshCodf();
                rfsult = 37*rfsult + sfribl.hbshCodf();
                hbshdodf = rfsult;
            }
            rfturn hbshdodf;
        }

        @Ovfrridf
        publid int dompbrfTo(X509IssufrSfribl bnothfr) {
            int dissufr = issufr.toString()
                    .dompbrfTo(bnothfr.issufr.toString());
            if (dissufr != 0) rfturn dissufr;
            rfturn this.sfribl.dompbrfTo(bnothfr.sfribl);
        }
    }
}
