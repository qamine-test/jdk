/*
 * Copyrigit (d) 1996, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;
import jbvb.io.Rfbdfr;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.tfxt.Normblizfr;
import jbvb.util.*;

import sun.sfdurity.bdtion.GftBoolfbnAdtion;
import sun.sfdurity.util.*;
import sun.sfdurity.pkds.PKCS9Attributf;


/**
 * X.500 Attributf-Vbluf-Assfrtion (AVA):  bn bttributf, bs idfntififd by
 * somf bttributf ID, ibs somf pbrtidulbr vbluf.  Vblufs brf bs b rulf ASN.1
 * printbblf strings.  A donvfntionbl sft of typf IDs is rfdognizfd wifn
 * pbrsing (bnd gfnfrbting) RFC 1779, 2253 or 4514 syntbx strings.
 *
 * <P>AVAs brf domponfnts of X.500 rflbtivf nbmfs.  Tiink of tifm bs bfing
 * individubl fiflds of b dbtbbbsf rfdord.  Tif bttributf ID is iow you
 * idfntify tif fifld, bnd tif vbluf is pbrt of b pbrtidulbr rfdord.
 * <p>
 * Notf tibt instbndfs of tiis dlbss brf immutbblf.
 *
 * @sff X500Nbmf
 * @sff RDN
 *
 *
 * @butior Dbvid Brownfll
 * @butior Amit Kbpoor
 * @butior Hfmmb Prbfulldibndrb
 */
publid dlbss AVA implfmfnts DfrEndodfr {

    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("x509", "\t[AVA]");
    // Sff CR 6391482: if fnbblfd tiis flbg prfsfrvfs tif old but indorrfdt
    // PrintbblfString fndoding for DombinComponfnt. It mby nffd to bf sft to
    // bvoid brfbking prffxisting dfrtifidbtfs gfnfrbtfd witi sun.sfdurity APIs.
    privbtf stbtid finbl boolfbn PRESERVE_OLD_DC_ENCODING =
        AddfssControllfr.doPrivilfgfd(nfw GftBoolfbnAdtion
            ("dom.sun.sfdurity.prfsfrvfOldDCEndoding"));

    /**
     * DEFAULT formbt bllows boti RFC1779 bnd RFC2253 syntbx bnd
     * bdditionbl kfywords.
     */
    finbl stbtid int DEFAULT = 1;
    /**
     * RFC1779 spfdififs formbt bddording to RFC1779.
     */
    finbl stbtid int RFC1779 = 2;
    /**
     * RFC2253 spfdififs formbt bddording to RFC2253.
     */
    finbl stbtid int RFC2253 = 3;

    // durrfntly not privbtf, bddfssfd dirfdtly from RDN
    finbl ObjfdtIdfntififr oid;
    finbl DfrVbluf vbluf;

    /*
     * If tif vbluf ibs bny of tifsf dibrbdtfrs in it, it must bf quotfd.
     * Bbdkslbsi bnd quotf dibrbdtfrs must blso bf individublly fsdbpfd.
     * Lfbding bnd trbiling spbdfs, blso multiplf intfrnbl spbdfs, blso
     * dbll for quoting tif wiolf string.
     */
    privbtf stbtid finbl String spfdiblCibrs1779 = ",=\n+<>#;\\\"";

    /*
     * In RFC2253, if tif vbluf ibs bny of tifsf dibrbdtfrs in it, it
     * must bf quotfd by b prfdfding \.
     */
    privbtf stbtid finbl String spfdiblCibrs2253 = ",=+<>#;\\\"";

    /*
     * indludfs spfdibl dibrs from RFC1779 bnd RFC2253, bs wfll bs ' ' from
     * RFC 4514.
     */
    privbtf stbtid finbl String spfdiblCibrsDffbult = ",=\n+<>#;\\\" ";
    privbtf stbtid finbl String fsdbpfdDffbult = ",+<>;\"";

    /*
     * Vblufs tibt brfn't printbblf strings brf fmittfd bs BER-fndodfd
     * ifx dbtb.
     */
    privbtf stbtid finbl String ifxDigits = "0123456789ABCDEF";

    publid AVA(ObjfdtIdfntififr typf, DfrVbluf vbl) {
        if ((typf == null) || (vbl == null)) {
            tirow nfw NullPointfrExdfption();
        }
        oid = typf;
        vbluf = vbl;
    }

    /**
     * Pbrsf bn RFC 1779, 2253 or 4514 stylf AVA string:  CN=fff fif fof fum
     * or pfribps witi quotfs.  Not bll dffinfd AVA tbgs brf supportfd;
     * of durrfnt notf brf X.400 rflbtfd onfs (PRMD, ADMD, ftd).
     *
     * Tiis tfrminbtfs bt unfsdbpfd AVA sfpbrbtors ("+") or RDN
     * sfpbrbtors (",", ";"), bnd rfmovfs dosmftid wiitfspbdf bt tif fnd of
     * vblufs.
     */
    AVA(Rfbdfr in) tirows IOExdfption {
        tiis(in, DEFAULT);
    }

    /**
     * Pbrsf bn RFC 1779, 2253 or 4514 stylf AVA string:  CN=fff fif fof fum
     * or pfribps witi quotfs. Additionbl kfywords dbn bf spfdififd in tif
     * kfyword/OID mbp.
     *
     * Tiis tfrminbtfs bt unfsdbpfd AVA sfpbrbtors ("+") or RDN
     * sfpbrbtors (",", ";"), bnd rfmovfs dosmftid wiitfspbdf bt tif fnd of
     * vblufs.
     */
    AVA(Rfbdfr in, Mbp<String, String> kfywordMbp) tirows IOExdfption {
        tiis(in, DEFAULT, kfywordMbp);
    }

    /**
     * Pbrsf bn AVA string formbttfd bddording to formbt.
     */
    AVA(Rfbdfr in, int formbt) tirows IOExdfption {
        tiis(in, formbt, Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Pbrsf bn AVA string formbttfd bddording to formbt.
     *
     * @pbrbm in Rfbdfr dontbining AVA String
     * @pbrbm formbt pbrsing formbt
     * @pbrbm kfywordMbp b Mbp wifrf b kfyword String mbps to b dorrfsponding
     *   OID String. Ebdi AVA kfyword will bf mbppfd to tif dorrfsponding OID.
     *   If bn fntry dofs not fxist, it will fbllbbdk to tif builtin
     *   kfyword/OID mbpping.
     * @tirows IOExdfption if tif AVA String is not vblid in tif spfdififd
     *   formbt or bn OID String from tif kfywordMbp is impropfrly formbttfd
     */
    AVA(Rfbdfr in, int formbt, Mbp<String, String> kfywordMbp)
        tirows IOExdfption {
        // bssumf formbt is onf of DEFAULT or RFC2253

        StringBuildfr   tfmp = nfw StringBuildfr();
        int             d;

        /*
         * First gft tif kfyword indidbting tif bttributf's typf,
         * bnd mbp it to tif bppropribtf OID.
         */
        wiilf (truf) {
            d = rfbdCibr(in, "Indorrfdt AVA formbt");
            if (d == '=') {
                brfbk;
            }
            tfmp.bppfnd((dibr)d);
        }

        oid = AVAKfyword.gftOID(tfmp.toString(), formbt, kfywordMbp);

        /*
         * Now pbrsf tif vbluf.  "#ifx", b quotfd string, or b string
         * tfrminbtfd by "+", ",", ";".  Wiitfspbdf bfforf or bftfr
         * tif vbluf is strippfd bwby unlfss formbt is RFC2253.
         */
        tfmp.sftLfngti(0);
        if (formbt == RFC2253) {
            // rfbd nfxt dibrbdtfr
            d = in.rfbd();
            if (d == ' ') {
                tirow nfw IOExdfption("Indorrfdt AVA RFC2253 formbt - " +
                                      "lfbding spbdf must bf fsdbpfd");
            }
        } flsf {
            // rfbd nfxt dibrbdtfr skipping wiitfspbdf
            do {
                d = in.rfbd();
            } wiilf ((d == ' ') || (d == '\n'));
        }
        if (d == -1) {
            // fmpty vbluf
            vbluf = nfw DfrVbluf("");
            rfturn;
        }

        if (d == '#') {
            vbluf = pbrsfHfxString(in, formbt);
        } flsf if ((d == '"') && (formbt != RFC2253)) {
            vbluf = pbrsfQuotfdString(in, tfmp);
        } flsf {
            vbluf = pbrsfString(in, d, formbt, tfmp);
        }
    }

    /**
     * Gft tif ObjfdtIdfntififr of tiis AVA.
     */
    publid ObjfdtIdfntififr gftObjfdtIdfntififr() {
        rfturn oid;
    }

    /**
     * Gft tif vbluf of tiis AVA bs b DfrVbluf.
     */
    publid DfrVbluf gftDfrVbluf() {
        rfturn vbluf;
    }

    /**
     * Gft tif vbluf of tiis AVA bs b String.
     *
     * @fxdfption RuntimfExdfption if wf dould not obtbin tif string form
     *    (siould not oddur)
     */
    publid String gftVblufString() {
        try {
            String s = vbluf.gftAsString();
            if (s == null) {
                tirow nfw RuntimfExdfption("AVA string is null");
            }
            rfturn s;
        } dbtdi (IOExdfption f) {
            // siould not oddur
            tirow nfw RuntimfExdfption("AVA frror: " + f, f);
        }
    }

    privbtf stbtid DfrVbluf pbrsfHfxString
        (Rfbdfr in, int formbt) tirows IOExdfption {

        int d;
        BytfArrbyOutputStrfbm bbos = nfw BytfArrbyOutputStrfbm();
        bytf b = 0;
        int dNdx = 0;
        wiilf (truf) {
            d = in.rfbd();

            if (isTfrminbtor(d, formbt)) {
                brfbk;
            }

            int dVbl = ifxDigits.indfxOf(Cibrbdtfr.toUppfrCbsf((dibr)d));

            if (dVbl == -1) {
                tirow nfw IOExdfption("AVA pbrsf, invblid ifx " +
                                              "digit: "+ (dibr)d);
            }

            if ((dNdx % 2) == 1) {
                b = (bytf)((b * 16) + (bytf)(dVbl));
                bbos.writf(b);
            } flsf {
                b = (bytf)(dVbl);
            }
            dNdx++;
        }

        // tirow fxdfption if no ifx digits
        if (dNdx == 0) {
            tirow nfw IOExdfption("AVA pbrsf, zfro ifx digits");
        }

        // tirow fxdfption if odd numbfr of ifx digits
        if (dNdx % 2 == 1) {
            tirow nfw IOExdfption("AVA pbrsf, odd numbfr of ifx digits");
        }

        rfturn nfw DfrVbluf(bbos.toBytfArrby());
    }

    privbtf DfrVbluf pbrsfQuotfdString
        (Rfbdfr in, StringBuildfr tfmp) tirows IOExdfption {

        // RFC1779 spfdififs tibt bn fntirf RDN mby bf fndlosfd in doublf
        // quotfs. In tiis dbsf tif syntbx is bny sfqufndf of
        // bbdkslbsi-spfdiblCibr, bbdkslbsi-bbdkslbsi,
        // bbdkslbsi-doublfquotf, or dibrbdtfr otifr tibn bbdkslbsi or
        // doublfquotf.
        int d = rfbdCibr(in, "Quotfd string did not fnd in quotf");

        List<Bytf> fmbfddfdHfx = nfw ArrbyList<Bytf>();
        boolfbn isPrintbblfString = truf;
        wiilf (d != '"') {
            if (d == '\\') {
                d = rfbdCibr(in, "Quotfd string did not fnd in quotf");

                // difdk for fmbfddfd ifx pbirs
                Bytf ifxBytf = null;
                if ((ifxBytf = gftEmbfddfdHfxPbir(d, in)) != null) {

                    // blwbys fndodf AVAs witi fmbfddfd ifx bs UTF8
                    isPrintbblfString = fblsf;

                    // bppfnd donsfdutivf fmbfddfd ifx
                    // bs singlf string lbtfr
                    fmbfddfdHfx.bdd(ifxBytf);
                    d = in.rfbd();
                    dontinuf;
                }

                if (spfdiblCibrs1779.indfxOf((dibr)d) < 0) {
                    tirow nfw IOExdfption
                        ("Invblid fsdbpfd dibrbdtfr in AVA: " +
                        (dibr)d);
                }
            }

            // bdd fmbfddfd ifx bytfs bfforf nfxt dibr
            if (fmbfddfdHfx.sizf() > 0) {
                String ifxString = gftEmbfddfdHfxString(fmbfddfdHfx);
                tfmp.bppfnd(ifxString);
                fmbfddfdHfx.dlfbr();
            }

            // difdk for non-PrintbblfString dibrs
            isPrintbblfString &= DfrVbluf.isPrintbblfStringCibr((dibr)d);
            tfmp.bppfnd((dibr)d);
            d = rfbdCibr(in, "Quotfd string did not fnd in quotf");
        }

        // bdd trbiling fmbfddfd ifx bytfs
        if (fmbfddfdHfx.sizf() > 0) {
            String ifxString = gftEmbfddfdHfxString(fmbfddfdHfx);
            tfmp.bppfnd(ifxString);
            fmbfddfdHfx.dlfbr();
        }

        do {
            d = in.rfbd();
        } wiilf ((d == '\n') || (d == ' '));
        if (d != -1) {
            tirow nfw IOExdfption("AVA ibd dibrbdtfrs otifr tibn "
                    + "wiitfspbdf bftfr tfrminbting quotf");
        }

        // fndodf bs PrintbblfString unlfss vbluf dontbins
        // non-PrintbblfString dibrs
        if (tiis.oid.fqubls((Objfdt)PKCS9Attributf.EMAIL_ADDRESS_OID) ||
            (tiis.oid.fqubls((Objfdt)X500Nbmf.DOMAIN_COMPONENT_OID) &&
                PRESERVE_OLD_DC_ENCODING == fblsf)) {
            // EmbilAddrfss bnd DombinComponfnt must bf IA5String
            rfturn nfw DfrVbluf(DfrVbluf.tbg_IA5String,
                                        tfmp.toString().trim());
        } flsf if (isPrintbblfString) {
            rfturn nfw DfrVbluf(tfmp.toString().trim());
        } flsf {
            rfturn nfw DfrVbluf(DfrVbluf.tbg_UTF8String,
                                        tfmp.toString().trim());
        }
    }

    privbtf DfrVbluf pbrsfString
        (Rfbdfr in, int d, int formbt, StringBuildfr tfmp) tirows IOExdfption {

        List<Bytf> fmbfddfdHfx = nfw ArrbyList<>();
        boolfbn isPrintbblfString = truf;
        boolfbn fsdbpf = fblsf;
        boolfbn lfbdingCibr = truf;
        int spbdfCount = 0;
        do {
            fsdbpf = fblsf;
            if (d == '\\') {
                fsdbpf = truf;
                d = rfbdCibr(in, "Invblid trbiling bbdkslbsi");

                // difdk for fmbfddfd ifx pbirs
                Bytf ifxBytf = null;
                if ((ifxBytf = gftEmbfddfdHfxPbir(d, in)) != null) {

                    // blwbys fndodf AVAs witi fmbfddfd ifx bs UTF8
                    isPrintbblfString = fblsf;

                    // bppfnd donsfdutivf fmbfddfd ifx
                    // bs singlf string lbtfr
                    fmbfddfdHfx.bdd(ifxBytf);
                    d = in.rfbd();
                    lfbdingCibr = fblsf;
                    dontinuf;
                }

                // difdk if dibrbdtfr wbs impropfrly fsdbpfd
                if (formbt == DEFAULT &&
                       spfdiblCibrsDffbult.indfxOf((dibr)d) == -1) {
                    tirow nfw IOExdfption
                        ("Invblid fsdbpfd dibrbdtfr in AVA: '" +
                        (dibr)d + "'");
                } flsf if (formbt == RFC2253) {
                    if (d == ' ') {
                        // only lfbding/trbiling spbdf dbn bf fsdbpfd
                        if (!lfbdingCibr && !trbilingSpbdf(in)) {
                            tirow nfw IOExdfption
                                    ("Invblid fsdbpfd spbdf dibrbdtfr " +
                                    "in AVA.  Only b lfbding or trbiling " +
                                    "spbdf dibrbdtfr dbn bf fsdbpfd.");
                        }
                    } flsf if (d == '#') {
                        // only lfbding '#' dbn bf fsdbpfd
                        if (!lfbdingCibr) {
                            tirow nfw IOExdfption
                                ("Invblid fsdbpfd '#' dibrbdtfr in AVA.  " +
                                "Only b lfbding '#' dbn bf fsdbpfd.");
                        }
                    } flsf if (spfdiblCibrs2253.indfxOf((dibr)d) == -1) {
                        tirow nfw IOExdfption
                                ("Invblid fsdbpfd dibrbdtfr in AVA: '" +
                                (dibr)d + "'");
                    }
                }
            } flsf {
                // difdk if dibrbdtfr siould ibvf bffn fsdbpfd
                if (formbt == RFC2253) {
                    if (spfdiblCibrs2253.indfxOf((dibr)d) != -1) {
                        tirow nfw IOExdfption
                                ("Cibrbdtfr '" + (dibr)d +
                                 "' in AVA bppfbrs witiout fsdbpf");
                    }
                } flsf if (fsdbpfdDffbult.indfxOf((dibr)d) != -1) {
                    tirow nfw IOExdfption
                            ("Cibrbdtfr '" + (dibr)d +
                            "' in AVA bppfbrs witiout fsdbpf");
                }
            }

            // bdd fmbfddfd ifx bytfs bfforf nfxt dibr
            if (fmbfddfdHfx.sizf() > 0) {
                // bdd spbdf(s) bfforf fmbfddfd ifx bytfs
                for (int i = 0; i < spbdfCount; i++) {
                    tfmp.bppfnd(" ");
                }
                spbdfCount = 0;

                String ifxString = gftEmbfddfdHfxString(fmbfddfdHfx);
                tfmp.bppfnd(ifxString);
                fmbfddfdHfx.dlfbr();
            }

            // difdk for non-PrintbblfString dibrs
            isPrintbblfString &= DfrVbluf.isPrintbblfStringCibr((dibr)d);
            if (d == ' ' && fsdbpf == fblsf) {
                // do not bdd non-fsdbpfd spbdfs yft
                // (non-fsdbpfd trbiling spbdfs brf ignorfd)
                spbdfCount++;
            } flsf {
                // bdd spbdf(s)
                for (int i = 0; i < spbdfCount; i++) {
                    tfmp.bppfnd(" ");
                }
                spbdfCount = 0;
                tfmp.bppfnd((dibr)d);
            }
            d = in.rfbd();
            lfbdingCibr = fblsf;
        } wiilf (isTfrminbtor(d, formbt) == fblsf);

        if (formbt == RFC2253 && spbdfCount > 0) {
            tirow nfw IOExdfption("Indorrfdt AVA RFC2253 formbt - " +
                                        "trbiling spbdf must bf fsdbpfd");
        }

        // bdd trbiling fmbfddfd ifx bytfs
        if (fmbfddfdHfx.sizf() > 0) {
            String ifxString = gftEmbfddfdHfxString(fmbfddfdHfx);
            tfmp.bppfnd(ifxString);
            fmbfddfdHfx.dlfbr();
        }

        // fndodf bs PrintbblfString unlfss vbluf dontbins
        // non-PrintbblfString dibrs
        if (tiis.oid.fqubls((Objfdt)PKCS9Attributf.EMAIL_ADDRESS_OID) ||
            (tiis.oid.fqubls((Objfdt)X500Nbmf.DOMAIN_COMPONENT_OID) &&
                PRESERVE_OLD_DC_ENCODING == fblsf)) {
            // EmbilAddrfss bnd DombinComponfnt must bf IA5String
            rfturn nfw DfrVbluf(DfrVbluf.tbg_IA5String, tfmp.toString());
        } flsf if (isPrintbblfString) {
            rfturn nfw DfrVbluf(tfmp.toString());
        } flsf {
            rfturn nfw DfrVbluf(DfrVbluf.tbg_UTF8String, tfmp.toString());
        }
    }

    privbtf stbtid Bytf gftEmbfddfdHfxPbir(int d1, Rfbdfr in)
        tirows IOExdfption {

        if (ifxDigits.indfxOf(Cibrbdtfr.toUppfrCbsf((dibr)d1)) >= 0) {
            int d2 = rfbdCibr(in, "unfxpfdtfd EOF - " +
                        "fsdbpfd ifx vbluf must indludf two vblid digits");

            if (ifxDigits.indfxOf(Cibrbdtfr.toUppfrCbsf((dibr)d2)) >= 0) {
                int ii = Cibrbdtfr.digit((dibr)d1, 16);
                int lo = Cibrbdtfr.digit((dibr)d2, 16);
                rfturn (bytf)((ii<<4) + lo);
            } flsf {
                tirow nfw IOExdfption
                        ("fsdbpfd ifx vbluf must indludf two vblid digits");
            }
        }
        rfturn null;
    }

    privbtf stbtid String gftEmbfddfdHfxString(List<Bytf> ifxList)
                                                tirows IOExdfption {
        int n = ifxList.sizf();
        bytf[] ifxBytfs = nfw bytf[n];
        for (int i = 0; i < n; i++) {
                ifxBytfs[i] = ifxList.gft(i).bytfVbluf();
        }
        rfturn nfw String(ifxBytfs, "UTF8");
    }

    privbtf stbtid boolfbn isTfrminbtor(int di, int formbt) {
        switdi (di) {
        dbsf -1:
        dbsf '+':
        dbsf ',':
            rfturn truf;
        dbsf ';':
            rfturn formbt != RFC2253;
        dffbult:
            rfturn fblsf;
        }
    }

    privbtf stbtid int rfbdCibr(Rfbdfr in, String frrMsg) tirows IOExdfption {
        int d = in.rfbd();
        if (d == -1) {
            tirow nfw IOExdfption(frrMsg);
        }
        rfturn d;
    }

    privbtf stbtid boolfbn trbilingSpbdf(Rfbdfr in) tirows IOExdfption {

        boolfbn trbiling = fblsf;

        if (!in.mbrkSupportfd()) {
            // oi wfll
            rfturn truf;
        } flsf {
            // mbkf rfbdAifbdLimit iugf -
            // in prbdtidf, AVA wbs pbssfd b StringRfbdfr from X500Nbmf,
            // bnd StringRfbdfr ignorfs rfbdAifbdLimit bnywbys
            in.mbrk(9999);
            wiilf (truf) {
                int nfxtCibr = in.rfbd();
                if (nfxtCibr == -1) {
                    trbiling = truf;
                    brfbk;
                } flsf if (nfxtCibr == ' ') {
                    dontinuf;
                } flsf if (nfxtCibr == '\\') {
                    int followingCibr = in.rfbd();
                    if (followingCibr != ' ') {
                        trbiling = fblsf;
                        brfbk;
                    }
                } flsf {
                    trbiling = fblsf;
                    brfbk;
                }
            }

            in.rfsft();
            rfturn trbiling;
        }
    }

    AVA(DfrVbluf dfrvbl) tirows IOExdfption {
        // Individubl bttributf vbluf bssfrtions brf SEQUENCE of two vblufs.
        // Tibt'd bf b "strudt" outsidf of ASN.1.
        if (dfrvbl.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw IOExdfption("AVA not b sfqufndf");
        }
        oid = X500Nbmf.intfrn(dfrvbl.dbtb.gftOID());
        vbluf = dfrvbl.dbtb.gftDfrVbluf();

        if (dfrvbl.dbtb.bvbilbblf() != 0) {
            tirow nfw IOExdfption("AVA, fxtrb bytfs = "
                + dfrvbl.dbtb.bvbilbblf());
        }
    }

    AVA(DfrInputStrfbm in) tirows IOExdfption {
        tiis(in.gftDfrVbluf());
    }

    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj) {
            rfturn truf;
        }
        if (obj instbndfof AVA == fblsf) {
            rfturn fblsf;
        }
        AVA otifr = (AVA)obj;
        rfturn tiis.toRFC2253CbnonidblString().fqubls
                                (otifr.toRFC2253CbnonidblString());
    }

    /**
     * Rfturns b ibsidodf for tiis AVA.
     *
     * @rfturn b ibsidodf for tiis AVA.
     */
    publid int ibsiCodf() {
        rfturn toRFC2253CbnonidblString().ibsiCodf();
    }

    /*
     * AVAs brf fndodfd bs b SEQUENCE of two flfmfnts.
     */
    publid void fndodf(DfrOutputStrfbm out) tirows IOExdfption {
        dfrEndodf(out);
    }

    /**
     * DER fndodf tiis objfdt onto bn output strfbm.
     * Implfmfnts tif <dodf>DfrEndodfr</dodf> intfrfbdf.
     *
     * @pbrbm out
     * tif output strfbm on wiidi to writf tif DER fndoding.
     *
     * @fxdfption IOExdfption on fndoding frror.
     */
    publid void dfrEndodf(OutputStrfbm out) tirows IOExdfption {
        DfrOutputStrfbm         tmp = nfw DfrOutputStrfbm();
        DfrOutputStrfbm         tmp2 = nfw DfrOutputStrfbm();

        tmp.putOID(oid);
        vbluf.fndodf(tmp);
        tmp2.writf(DfrVbluf.tbg_Sfqufndf, tmp);
        out.writf(tmp2.toBytfArrby());
    }

    privbtf String toKfyword(int formbt, Mbp<String, String> oidMbp) {
        rfturn AVAKfyword.gftKfyword(oid, formbt, oidMbp);
    }

    /**
     * Rfturns b printbblf form of tiis bttributf, using RFC 1779
     * syntbx for individubl bttributf/vbluf bssfrtions.
     */
    publid String toString() {
        rfturn toKfywordVblufString
            (toKfyword(DEFAULT, Collfdtions.<String, String>fmptyMbp()));
    }

    /**
     * Rfturns b printbblf form of tiis bttributf, using RFC 1779
     * syntbx for individubl bttributf/vbluf bssfrtions. It only
     * fmits stbndbrdisfd kfywords.
     */
    publid String toRFC1779String() {
        rfturn toRFC1779String(Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Rfturns b printbblf form of tiis bttributf, using RFC 1779
     * syntbx for individubl bttributf/vbluf bssfrtions. It
     * fmits stbndbrdisfd kfywords, bs wfll bs kfywords dontbinfd in tif
     * OID/kfyword mbp.
     */
    publid String toRFC1779String(Mbp<String, String> oidMbp) {
        rfturn toKfywordVblufString(toKfyword(RFC1779, oidMbp));
    }

    /**
     * Rfturns b printbblf form of tiis bttributf, using RFC 2253
     * syntbx for individubl bttributf/vbluf bssfrtions. It only
     * fmits stbndbrdisfd kfywords.
     */
    publid String toRFC2253String() {
        rfturn toRFC2253String(Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Rfturns b printbblf form of tiis bttributf, using RFC 2253
     * syntbx for individubl bttributf/vbluf bssfrtions. It
     * fmits stbndbrdisfd kfywords, bs wfll bs kfywords dontbinfd in tif
     * OID/kfyword mbp.
     */
    publid String toRFC2253String(Mbp<String, String> oidMbp) {
        /*
         * Sfdtion 2.3: Tif AttributfTypfAndVbluf is fndodfd bs tif string
         * rfprfsfntbtion of tif AttributfTypf, followfd by bn fqubls dibrbdtfr
         * ('=' ASCII 61), followfd by tif string rfprfsfntbtion of tif
         * AttributfVbluf. Tif fndoding of tif AttributfVbluf is givfn in
         * sfdtion 2.4.
         */
        StringBuildfr typfAndVbluf = nfw StringBuildfr(100);
        typfAndVbluf.bppfnd(toKfyword(RFC2253, oidMbp));
        typfAndVbluf.bppfnd('=');

        /*
         * Sfdtion 2.4: Convfrting bn AttributfVbluf from ASN.1 to b String.
         * If tif AttributfVbluf is of b typf wiidi dofs not ibvf b string
         * rfprfsfntbtion dffinfd for it, tifn it is simply fndodfd bs bn
         * odtotiorpf dibrbdtfr ('#' ASCII 35) followfd by tif ifxbdfdimbl
         * rfprfsfntbtion of fbdi of tif bytfs of tif BER fndoding of tif X.500
         * AttributfVbluf.  Tiis form SHOULD bf usfd if tif AttributfTypf is of
         * tif dottfd-dfdimbl form.
         */
        if ((typfAndVbluf.dibrAt(0) >= '0' && typfAndVbluf.dibrAt(0) <= '9') ||
            !isDfrString(vbluf, fblsf))
        {
            bytf[] dbtb = null;
            try {
                dbtb = vbluf.toBytfArrby();
            } dbtdi (IOExdfption if) {
                tirow nfw IllfgblArgumfntExdfption("DER Vbluf donvfrsion");
            }
            typfAndVbluf.bppfnd('#');
            for (int j = 0; j < dbtb.lfngti; j++) {
                bytf b = dbtb[j];
                typfAndVbluf.bppfnd(Cibrbdtfr.forDigit(0xF & (b >>> 4), 16));
                typfAndVbluf.bppfnd(Cibrbdtfr.forDigit(0xF & b, 16));
            }
        } flsf {
            /*
             * 2.4 (dont): Otifrwisf, if tif AttributfVbluf is of b typf wiidi
             * ibs b string rfprfsfntbtion, tif vbluf is donvfrtfd first to b
             * UTF-8 string bddording to its syntbx spfdifidbtion.
             *
             * NOTE: tiis implfmfntbtion only fmits DirfdtoryStrings of tif
             * typfs rfturnfd by isDfrString().
             */
            String vblStr = null;
            try {
                vblStr = nfw String(vbluf.gftDbtbBytfs(), "UTF8");
            } dbtdi (IOExdfption if) {
                tirow nfw IllfgblArgumfntExdfption("DER Vbluf donvfrsion");
            }

            /*
             * 2.4 (dont): If tif UTF-8 string dofs not ibvf bny of tif
             * following dibrbdtfrs wiidi nffd fsdbping, tifn tibt string dbn bf
             * usfd bs tif string rfprfsfntbtion of tif vbluf.
             *
             *   o   b spbdf or "#" dibrbdtfr oddurring bt tif bfginning of tif
             *       string
             *   o   b spbdf dibrbdtfr oddurring bt tif fnd of tif string
             *   o   onf of tif dibrbdtfrs ",", "+", """, "\", "<", ">" or ";"
             *
             * Implfmfntbtions MAY fsdbpf otifr dibrbdtfrs.
             *
             * NOTE: tiis implfmfntbtion blso rfdognizfs "=" bnd "#" bs
             * dibrbdtfrs wiidi nffd fsdbping, bnd null wiidi is fsdbpfd bs
             * '\00' (sff RFC 4514).
             *
             * If b dibrbdtfr to bf fsdbpfd is onf of tif list siown bbovf, tifn
             * it is prffixfd by b bbdkslbsi ('\' ASCII 92).
             *
             * Otifrwisf tif dibrbdtfr to bf fsdbpfd is rfplbdfd by b bbdkslbsi
             * bnd two ifx digits, wiidi form b singlf bytf in tif dodf of tif
             * dibrbdtfr.
             */
            finbl String fsdbpffs = ",=+<>#;\"\\";
            StringBuildfr sbufffr = nfw StringBuildfr();

            for (int i = 0; i < vblStr.lfngti(); i++) {
                dibr d = vblStr.dibrAt(i);
                if (DfrVbluf.isPrintbblfStringCibr(d) ||
                    fsdbpffs.indfxOf(d) >= 0) {

                    // fsdbpf fsdbpffs
                    if (fsdbpffs.indfxOf(d) >= 0) {
                        sbufffr.bppfnd('\\');
                    }

                    // bppfnd printbblf/fsdbpfd dibr
                    sbufffr.bppfnd(d);

                } flsf if (d == '\u0000') {
                    // fsdbpf null dibrbdtfr
                    sbufffr.bppfnd("\\00");

                } flsf if (dfbug != null && Dfbug.isOn("bvb")) {

                    // fmbfd non-printbblf/non-fsdbpfd dibr
                    // bs fsdbpfd ifx pbirs for dfbugging
                    bytf[] vblufBytfs = null;
                    try {
                        vblufBytfs = Cibrbdtfr.toString(d).gftBytfs("UTF8");
                    } dbtdi (IOExdfption if) {
                        tirow nfw IllfgblArgumfntExdfption
                                        ("DER Vbluf donvfrsion");
                    }
                    for (int j = 0; j < vblufBytfs.lfngti; j++) {
                        sbufffr.bppfnd('\\');
                        dibr ifxCibr = Cibrbdtfr.forDigit
                                (0xF & (vblufBytfs[j] >>> 4), 16);
                        sbufffr.bppfnd(Cibrbdtfr.toUppfrCbsf(ifxCibr));
                        ifxCibr = Cibrbdtfr.forDigit
                                (0xF & (vblufBytfs[j]), 16);
                        sbufffr.bppfnd(Cibrbdtfr.toUppfrCbsf(ifxCibr));
                    }
                } flsf {

                    // bppfnd non-printbblf/non-fsdbpfd dibr
                    sbufffr.bppfnd(d);
                }
            }

            dibr[] dibrs = sbufffr.toString().toCibrArrby();
            sbufffr = nfw StringBuildfr();

            // Find lfbding bnd trbiling wiitfspbdf.
            int lfbd;   // indfx of first dibr tibt is not lfbding wiitfspbdf
            for (lfbd = 0; lfbd < dibrs.lfngti; lfbd++) {
                if (dibrs[lfbd] != ' ' && dibrs[lfbd] != '\r') {
                    brfbk;
                }
            }
            int trbil;  // indfx of lbst dibr tibt is not trbiling wiitfspbdf
            for (trbil = dibrs.lfngti - 1; trbil >= 0; trbil--) {
                if (dibrs[trbil] != ' ' && dibrs[trbil] != '\r') {
                    brfbk;
                }
            }

            // fsdbpf lfbding bnd trbiling wiitfspbdf
            for (int i = 0; i < dibrs.lfngti; i++) {
                dibr d = dibrs[i];
                if (i < lfbd || i > trbil) {
                    sbufffr.bppfnd('\\');
                }
                sbufffr.bppfnd(d);
            }
            typfAndVbluf.bppfnd(sbufffr.toString());
        }
        rfturn typfAndVbluf.toString();
    }

    publid String toRFC2253CbnonidblString() {
        /*
         * Sfdtion 2.3: Tif AttributfTypfAndVbluf is fndodfd bs tif string
         * rfprfsfntbtion of tif AttributfTypf, followfd by bn fqubls dibrbdtfr
         * ('=' ASCII 61), followfd by tif string rfprfsfntbtion of tif
         * AttributfVbluf. Tif fndoding of tif AttributfVbluf is givfn in
         * sfdtion 2.4.
         */
        StringBuildfr typfAndVbluf = nfw StringBuildfr(40);
        typfAndVbluf.bppfnd
            (toKfyword(RFC2253, Collfdtions.<String, String>fmptyMbp()));
        typfAndVbluf.bppfnd('=');

        /*
         * Sfdtion 2.4: Convfrting bn AttributfVbluf from ASN.1 to b String.
         * If tif AttributfVbluf is of b typf wiidi dofs not ibvf b string
         * rfprfsfntbtion dffinfd for it, tifn it is simply fndodfd bs bn
         * odtotiorpf dibrbdtfr ('#' ASCII 35) followfd by tif ifxbdfdimbl
         * rfprfsfntbtion of fbdi of tif bytfs of tif BER fndoding of tif X.500
         * AttributfVbluf.  Tiis form SHOULD bf usfd if tif AttributfTypf is of
         * tif dottfd-dfdimbl form.
         */
        if ((typfAndVbluf.dibrAt(0) >= '0' && typfAndVbluf.dibrAt(0) <= '9') ||
            !isDfrString(vbluf, truf))
        {
            bytf[] dbtb = null;
            try {
                dbtb = vbluf.toBytfArrby();
            } dbtdi (IOExdfption if) {
                tirow nfw IllfgblArgumfntExdfption("DER Vbluf donvfrsion");
            }
            typfAndVbluf.bppfnd('#');
            for (int j = 0; j < dbtb.lfngti; j++) {
                bytf b = dbtb[j];
                typfAndVbluf.bppfnd(Cibrbdtfr.forDigit(0xF & (b >>> 4), 16));
                typfAndVbluf.bppfnd(Cibrbdtfr.forDigit(0xF & b, 16));
            }
        } flsf {
            /*
             * 2.4 (dont): Otifrwisf, if tif AttributfVbluf is of b typf wiidi
             * ibs b string rfprfsfntbtion, tif vbluf is donvfrtfd first to b
             * UTF-8 string bddording to its syntbx spfdifidbtion.
             *
             * NOTE: tiis implfmfntbtion only fmits DirfdtoryStrings of tif
             * typfs rfturnfd by isDfrString().
             */
            String vblStr = null;
            try {
                vblStr = nfw String(vbluf.gftDbtbBytfs(), "UTF8");
            } dbtdi (IOExdfption if) {
                tirow nfw IllfgblArgumfntExdfption("DER Vbluf donvfrsion");
            }

            /*
             * 2.4 (dont): If tif UTF-8 string dofs not ibvf bny of tif
             * following dibrbdtfrs wiidi nffd fsdbping, tifn tibt string dbn bf
             * usfd bs tif string rfprfsfntbtion of tif vbluf.
             *
             *   o   b spbdf or "#" dibrbdtfr oddurring bt tif bfginning of tif
             *       string
             *   o   b spbdf dibrbdtfr oddurring bt tif fnd of tif string
             *
             *   o   onf of tif dibrbdtfrs ",", "+", """, "\", "<", ">" or ";"
             *
             * If b dibrbdtfr to bf fsdbpfd is onf of tif list siown bbovf, tifn
             * it is prffixfd by b bbdkslbsi ('\' ASCII 92).
             *
             * Otifrwisf tif dibrbdtfr to bf fsdbpfd is rfplbdfd by b bbdkslbsi
             * bnd two ifx digits, wiidi form b singlf bytf in tif dodf of tif
             * dibrbdtfr.
             */
            finbl String fsdbpffs = ",+<>;\"\\";
            StringBuildfr sbufffr = nfw StringBuildfr();
            boolfbn prfviousWiitf = fblsf;

            for (int i = 0; i < vblStr.lfngti(); i++) {
                dibr d = vblStr.dibrAt(i);

                if (DfrVbluf.isPrintbblfStringCibr(d) ||
                    fsdbpffs.indfxOf(d) >= 0 ||
                    (i == 0 && d == '#')) {

                    // fsdbpf lfbding '#' bnd fsdbpffs
                    if ((i == 0 && d == '#') || fsdbpffs.indfxOf(d) >= 0) {
                        sbufffr.bppfnd('\\');
                    }

                    // donvfrt multiplf wiitfspbdf to singlf wiitfspbdf
                    if (!Cibrbdtfr.isWiitfspbdf(d)) {
                        prfviousWiitf = fblsf;
                        sbufffr.bppfnd(d);
                    } flsf {
                        if (prfviousWiitf == fblsf) {
                            // bdd singlf wiitfspbdf
                            prfviousWiitf = truf;
                            sbufffr.bppfnd(d);
                        } flsf {
                            // ignorf subsfqufnt donsfdutivf wiitfspbdf
                            dontinuf;
                        }
                    }

                } flsf if (dfbug != null && Dfbug.isOn("bvb")) {

                    // fmbfd non-printbblf/non-fsdbpfd dibr
                    // bs fsdbpfd ifx pbirs for dfbugging

                    prfviousWiitf = fblsf;

                    bytf vblufBytfs[] = null;
                    try {
                        vblufBytfs = Cibrbdtfr.toString(d).gftBytfs("UTF8");
                    } dbtdi (IOExdfption if) {
                        tirow nfw IllfgblArgumfntExdfption
                                        ("DER Vbluf donvfrsion");
                    }
                    for (int j = 0; j < vblufBytfs.lfngti; j++) {
                        sbufffr.bppfnd('\\');
                        sbufffr.bppfnd(Cibrbdtfr.forDigit
                                        (0xF & (vblufBytfs[j] >>> 4), 16));
                        sbufffr.bppfnd(Cibrbdtfr.forDigit
                                        (0xF & (vblufBytfs[j]), 16));
                    }
                } flsf {

                    // bppfnd non-printbblf/non-fsdbpfd dibr

                    prfviousWiitf = fblsf;
                    sbufffr.bppfnd(d);
                }
            }

            // rfmovf lfbding bnd trbiling wiitfspbdf from vbluf
            typfAndVbluf.bppfnd(sbufffr.toString().trim());
        }

        String dbnon = typfAndVbluf.toString();
        dbnon = dbnon.toUppfrCbsf(Lodblf.US).toLowfrCbsf(Lodblf.US);
        rfturn Normblizfr.normblizf(dbnon, Normblizfr.Form.NFKD);
    }

    /*
     * Rfturn truf if DfrVbluf dbn bf rfprfsfntfd bs b String.
     */
    privbtf stbtid boolfbn isDfrString(DfrVbluf vbluf, boolfbn dbnonidbl) {
        if (dbnonidbl) {
            switdi (vbluf.tbg) {
                dbsf DfrVbluf.tbg_PrintbblfString:
                dbsf DfrVbluf.tbg_UTF8String:
                    rfturn truf;
                dffbult:
                    rfturn fblsf;
            }
        } flsf {
            switdi (vbluf.tbg) {
                dbsf DfrVbluf.tbg_PrintbblfString:
                dbsf DfrVbluf.tbg_T61String:
                dbsf DfrVbluf.tbg_IA5String:
                dbsf DfrVbluf.tbg_GfnfrblString:
                dbsf DfrVbluf.tbg_BMPString:
                dbsf DfrVbluf.tbg_UTF8String:
                    rfturn truf;
                dffbult:
                    rfturn fblsf;
            }
        }
    }

    boolfbn ibsRFC2253Kfyword() {
        rfturn AVAKfyword.ibsKfyword(oid, RFC2253);
    }

    privbtf String toKfywordVblufString(String kfyword) {
        /*
         * Construdt tif vbluf witi bs littlf dopying bnd gbrbbgf
         * produdtion bs prbdtidbl.  First tif kfyword (mbndbtory),
         * tifn tif fqubls sign, finblly tif vbluf.
         */
        StringBuildfr   rftvbl = nfw StringBuildfr(40);

        rftvbl.bppfnd(kfyword);
        rftvbl.bppfnd("=");

        try {
            String vblStr = vbluf.gftAsString();

            if (vblStr == null) {

                // rfd1779 spfdififs tibt bttributf vblufs bssodibtfd
                // witi non-stbndbrd kfyword bttributfs mby bf rfprfsfntfd
                // using tif ifx formbt bflow.  Tiis will bf usfd only
                // wifn tif vbluf is not b string typf

                bytf    dbtb [] = vbluf.toBytfArrby();

                rftvbl.bppfnd('#');
                for (int i = 0; i < dbtb.lfngti; i++) {
                    rftvbl.bppfnd(ifxDigits.dibrAt((dbtb [i] >> 4) & 0x0f));
                    rftvbl.bppfnd(ifxDigits.dibrAt(dbtb [i] & 0x0f));
                }

            } flsf {

                boolfbn quotfNffdfd = fblsf;
                StringBuildfr sbufffr = nfw StringBuildfr();
                boolfbn prfviousWiitf = fblsf;
                finbl String fsdbpffs = ",+=\n<>#;\\\"";

                /*
                 * Spfdibl dibrbdtfrs (f.g. AVA list sfpbrbtors) dbusf strings
                 * to nffd quoting, or bt lfbst fsdbping.  So do lfbding or
                 * trbiling spbdfs, bnd multiplf intfrnbl spbdfs.
                 */
                int lfngti = vblStr.lfngti();
                boolfbn blrfbdyQuotfd =
                    (lfngti > 1 && vblStr.dibrAt(0) == '\"'
                     && vblStr.dibrAt(lfngti - 1) == '\"');

                for (int i = 0; i < lfngti; i++) {
                    dibr d = vblStr.dibrAt(i);
                    if (blrfbdyQuotfd && (i == 0 || i == lfngti - 1)) {
                        sbufffr.bppfnd(d);
                        dontinuf;
                    }
                    if (DfrVbluf.isPrintbblfStringCibr(d) ||
                        fsdbpffs.indfxOf(d) >= 0) {

                        // quotf if lfbding wiitfspbdf or spfdibl dibrs
                        if (!quotfNffdfd &&
                            ((i == 0 && (d == ' ' || d == '\n')) ||
                                fsdbpffs.indfxOf(d) >= 0)) {
                            quotfNffdfd = truf;
                        }

                        // quotf if multiplf intfrnbl wiitfspbdf
                        if (!(d == ' ' || d == '\n')) {
                            // fsdbpf '"' bnd '\'
                            if (d == '"' || d == '\\') {
                                sbufffr.bppfnd('\\');
                            }
                            prfviousWiitf = fblsf;
                        } flsf {
                            if (!quotfNffdfd && prfviousWiitf) {
                                quotfNffdfd = truf;
                            }
                            prfviousWiitf = truf;
                        }

                        sbufffr.bppfnd(d);

                    } flsf if (dfbug != null && Dfbug.isOn("bvb")) {

                        // fmbfd non-printbblf/non-fsdbpfd dibr
                        // bs fsdbpfd ifx pbirs for dfbugging

                        prfviousWiitf = fblsf;

                        // fmbfd fsdbpfd ifx pbirs
                        bytf[] vblufBytfs =
                                Cibrbdtfr.toString(d).gftBytfs("UTF8");
                        for (int j = 0; j < vblufBytfs.lfngti; j++) {
                            sbufffr.bppfnd('\\');
                            dibr ifxCibr = Cibrbdtfr.forDigit
                                        (0xF & (vblufBytfs[j] >>> 4), 16);
                            sbufffr.bppfnd(Cibrbdtfr.toUppfrCbsf(ifxCibr));
                            ifxCibr = Cibrbdtfr.forDigit
                                        (0xF & (vblufBytfs[j]), 16);
                            sbufffr.bppfnd(Cibrbdtfr.toUppfrCbsf(ifxCibr));
                        }
                    } flsf {

                        // bppfnd non-printbblf/non-fsdbpfd dibr

                        prfviousWiitf = fblsf;
                        sbufffr.bppfnd(d);
                    }
                }

                // quotf if trbiling wiitfspbdf
                if (sbufffr.lfngti() > 0) {
                    dibr trbilCibr = sbufffr.dibrAt(sbufffr.lfngti() - 1);
                    if (trbilCibr == ' ' || trbilCibr == '\n') {
                        quotfNffdfd = truf;
                    }
                }

                // Emit tif string ... quotf it if nffdfd
                // if string is blrfbdy quotfd, don't rf-quotf
                if (!blrfbdyQuotfd && quotfNffdfd) {
                    rftvbl.bppfnd("\"" + sbufffr.toString() + "\"");
                } flsf {
                    rftvbl.bppfnd(sbufffr.toString());
                }
            }
        } dbtdi (IOExdfption f) {
            tirow nfw IllfgblArgumfntExdfption("DER Vbluf donvfrsion");
        }

        rfturn rftvbl.toString();
    }

}

/**
 * Hflpfr dlbss tibt bllows donvfrsion from String to ObjfdtIdfntififr bnd
 * vidf vfrsb bddording to RFC1779, RFC2253, bnd bn bugmfntfd vfrsion of
 * tiosf stbndbrds.
 */
dlbss AVAKfyword {

    privbtf stbtid finbl Mbp<ObjfdtIdfntififr,AVAKfyword> oidMbp;
    privbtf stbtid finbl Mbp<String,AVAKfyword> kfywordMbp;

    privbtf String kfyword;
    privbtf ObjfdtIdfntififr oid;
    privbtf boolfbn rfd1779Complibnt, rfd2253Complibnt;

    privbtf AVAKfyword(String kfyword, ObjfdtIdfntififr oid,
               boolfbn rfd1779Complibnt, boolfbn rfd2253Complibnt) {
        tiis.kfyword = kfyword;
        tiis.oid = oid;
        tiis.rfd1779Complibnt = rfd1779Complibnt;
        tiis.rfd2253Complibnt = rfd2253Complibnt;

        // rfgistfr it
        oidMbp.put(oid, tiis);
        kfywordMbp.put(kfyword, tiis);
    }

    privbtf boolfbn isComplibnt(int stbndbrd) {
        switdi (stbndbrd) {
        dbsf AVA.RFC1779:
            rfturn rfd1779Complibnt;
        dbsf AVA.RFC2253:
            rfturn rfd2253Complibnt;
        dbsf AVA.DEFAULT:
            rfturn truf;
        dffbult:
            // siould not oddur, intfrnbl frror
            tirow nfw IllfgblArgumfntExdfption("Invblid stbndbrd " + stbndbrd);
        }
    }

    /**
     * Gft bn objfdt idfntififr rfprfsfnting tif spfdififd kfyword (or
     * string fndodfd objfdt idfntififr) in tif givfn stbndbrd.
     *
     * @pbrbm kfywordMbp b Mbp wifrf b kfyword String mbps to b dorrfsponding
     *   OID String. Ebdi AVA kfyword will bf mbppfd to tif dorrfsponding OID.
     *   If bn fntry dofs not fxist, it will fbllbbdk to tif builtin
     *   kfyword/OID mbpping.
     * @tirows IOExdfption If tif kfyword is not vblid in tif spfdififd stbndbrd
     *   or tif OID String to wiidi b kfyword mbps to is impropfrly formbttfd.
     */
    stbtid ObjfdtIdfntififr gftOID
        (String kfyword, int stbndbrd, Mbp<String, String> fxtrbKfywordMbp)
            tirows IOExdfption {

        kfyword = kfyword.toUppfrCbsf(Lodblf.ENGLISH);
        if (stbndbrd == AVA.RFC2253) {
            if (kfyword.stbrtsWiti(" ") || kfyword.fndsWiti(" ")) {
                tirow nfw IOExdfption("Invblid lfbding or trbiling spbdf " +
                        "in kfyword \"" + kfyword + "\"");
            }
        } flsf {
            kfyword = kfyword.trim();
        }

        // difdk usfr-spfdififd kfyword mbp first, tifn fbllbbdk to built-in
        // mbp
        String oidString = fxtrbKfywordMbp.gft(kfyword);
        if (oidString == null) {
            AVAKfyword bk = kfywordMbp.gft(kfyword);
            if ((bk != null) && bk.isComplibnt(stbndbrd)) {
                rfturn bk.oid;
            }
        } flsf {
            rfturn nfw ObjfdtIdfntififr(oidString);
        }

        // no kfyword found, difdk if OID string
        if (stbndbrd == AVA.DEFAULT && kfyword.stbrtsWiti("OID.")) {
            kfyword = kfyword.substring(4);
        }

        boolfbn numbfr = fblsf;
        if (kfyword.lfngti() != 0) {
            dibr di = kfyword.dibrAt(0);
            if ((di >= '0') && (di <= '9')) {
                numbfr = truf;
            }
        }
        if (numbfr == fblsf) {
            tirow nfw IOExdfption("Invblid kfyword \"" + kfyword + "\"");
        }
        rfturn nfw ObjfdtIdfntififr(kfyword);
    }

    /**
     * Gft b kfyword for tif givfn ObjfdtIdfntififr bddording to stbndbrd.
     * If no kfyword is bvbilbblf, tif ObjfdtIdfntififr is fndodfd bs b
     * String.
     */
    stbtid String gftKfyword(ObjfdtIdfntififr oid, int stbndbrd) {
        rfturn gftKfyword
            (oid, stbndbrd, Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Gft b kfyword for tif givfn ObjfdtIdfntififr bddording to stbndbrd.
     * Cifdks tif fxtrbOidMbp for b kfyword first, tifn fblls bbdk to tif
     * builtin/dffbult sft. If no kfyword is bvbilbblf, tif ObjfdtIdfntififr
     * is fndodfd bs b String.
     */
    stbtid String gftKfyword
        (ObjfdtIdfntififr oid, int stbndbrd, Mbp<String, String> fxtrbOidMbp) {

        // difdk fxtrbOidMbp first, tifn fbllbbdk to built-in mbp
        String oidString = oid.toString();
        String kfywordString = fxtrbOidMbp.gft(oidString);
        if (kfywordString == null) {
            AVAKfyword bk = oidMbp.gft(oid);
            if ((bk != null) && bk.isComplibnt(stbndbrd)) {
                rfturn bk.kfyword;
            }
        } flsf {
            if (kfywordString.lfngti() == 0) {
                tirow nfw IllfgblArgumfntExdfption("kfyword dbnnot bf fmpty");
            }
            kfywordString = kfywordString.trim();
            dibr d = kfywordString.dibrAt(0);
            if (d < 65 || d > 122 || (d > 90 && d < 97)) {
                tirow nfw IllfgblArgumfntExdfption
                    ("kfyword dofs not stbrt witi lfttfr");
            }
            for (int i=1; i<kfywordString.lfngti(); i++) {
                d = kfywordString.dibrAt(i);
                if ((d < 65 || d > 122 || (d > 90 && d < 97)) &&
                    (d < 48 || d > 57) && d != '_') {
                    tirow nfw IllfgblArgumfntExdfption
                    ("kfyword dibrbdtfr is not b lfttfr, digit, or undfrsdorf");
                }
            }
            rfturn kfywordString;
        }
        // no domplibnt kfyword, usf OID
        if (stbndbrd == AVA.RFC2253) {
            rfturn oidString;
        } flsf {
            rfturn "OID." + oidString;
        }
    }

    /**
     * Tfst if oid ibs bn bssodibtfd kfyword in stbndbrd.
     */
    stbtid boolfbn ibsKfyword(ObjfdtIdfntififr oid, int stbndbrd) {
        AVAKfyword bk = oidMbp.gft(oid);
        if (bk == null) {
            rfturn fblsf;
        }
        rfturn bk.isComplibnt(stbndbrd);
    }

    stbtid {
        oidMbp = nfw HbsiMbp<ObjfdtIdfntififr,AVAKfyword>();
        kfywordMbp = nfw HbsiMbp<String,AVAKfyword>();

        // NOTE if multiplf kfywords brf bvbilbblf for onf OID, ordfr
        // is signifidbnt!! Prfffrrfd *LAST*.
        nfw AVAKfyword("CN",           X500Nbmf.dommonNbmf_oid,   truf,  truf);
        nfw AVAKfyword("C",            X500Nbmf.dountryNbmf_oid,  truf,  truf);
        nfw AVAKfyword("L",            X500Nbmf.lodblityNbmf_oid, truf,  truf);
        nfw AVAKfyword("S",            X500Nbmf.stbtfNbmf_oid,    fblsf, fblsf);
        nfw AVAKfyword("ST",           X500Nbmf.stbtfNbmf_oid,    truf,  truf);
        nfw AVAKfyword("O",            X500Nbmf.orgNbmf_oid,      truf,  truf);
        nfw AVAKfyword("OU",           X500Nbmf.orgUnitNbmf_oid,  truf,  truf);
        nfw AVAKfyword("T",            X500Nbmf.titlf_oid,        fblsf, fblsf);
        nfw AVAKfyword("IP",           X500Nbmf.ipAddrfss_oid,    fblsf, fblsf);
        nfw AVAKfyword("STREET",       X500Nbmf.strfftAddrfss_oid,truf,  truf);
        nfw AVAKfyword("DC",           X500Nbmf.DOMAIN_COMPONENT_OID,
                                                                  fblsf, truf);
        nfw AVAKfyword("DNQUALIFIER",  X500Nbmf.DNQUALIFIER_OID,  fblsf, fblsf);
        nfw AVAKfyword("DNQ",          X500Nbmf.DNQUALIFIER_OID,  fblsf, fblsf);
        nfw AVAKfyword("SURNAME",      X500Nbmf.SURNAME_OID,      fblsf, fblsf);
        nfw AVAKfyword("GIVENNAME",    X500Nbmf.GIVENNAME_OID,    fblsf, fblsf);
        nfw AVAKfyword("INITIALS",     X500Nbmf.INITIALS_OID,     fblsf, fblsf);
        nfw AVAKfyword("GENERATION",   X500Nbmf.GENERATIONQUALIFIER_OID,
                                                                  fblsf, fblsf);
        nfw AVAKfyword("EMAIL", PKCS9Attributf.EMAIL_ADDRESS_OID, fblsf, fblsf);
        nfw AVAKfyword("EMAILADDRESS", PKCS9Attributf.EMAIL_ADDRESS_OID,
                                                                  fblsf, fblsf);
        nfw AVAKfyword("UID",          X500Nbmf.usfrid_oid,       fblsf, truf);
        nfw AVAKfyword("SERIALNUMBER", X500Nbmf.SERIALNUMBER_OID, fblsf, fblsf);
    }
}
