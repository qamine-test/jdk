/*
 * Copyright (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;

import jbvb.sfdurity.dfrt.*;
import jbvb.util.*;

import sun.sfdurity.util.*;
import sun.misd.HfxDumpEndodfr;


/**
 * Thf X509CfrtInfo dlbss rfprfsfnts X.509 dfrtifidbtf informbtion.
 *
 * <P>X.509 dfrtifidbtfs hbvf sfvfrbl bbsf dbtb flfmfnts, indluding:<UL>
 *
 * <LI>Thf <fm>Subjfdt Nbmf</fm>, bn X.500 Distinguishfd Nbmf for
 *      thf fntity (subjfdt) for whidh thf dfrtifidbtf wbs issufd.
 *
 * <LI>Thf <fm>Subjfdt Publid Kfy</fm>, thf publid kfy of thf subjfdt.
 *      This is onf of thf most importbnt pbrts of thf dfrtifidbtf.
 *
 * <LI>Thf <fm>Vblidity Pfriod</fm>, b timf pfriod (f.g. six months)
 *      within whidh thf dfrtifidbtf is vblid (unlfss rfvokfd).
 *
 * <LI>Thf <fm>Issufr Nbmf</fm>, bn X.500 Distinguishfd Nbmf for thf
 *      Cfrtifidbtf Authority (CA) whidh issufd thf dfrtifidbtf.
 *
 * <LI>A <fm>Sfribl Numbfr</fm> bssignfd by thf CA, for usf in
 *      dfrtifidbtf rfvodbtion bnd othfr bpplidbtions.
 *
 * @buthor Amit Kbpoor
 * @buthor Hfmmb Prbfulldhbndrb
 * @sff CfrtAttrSft
 * @sff X509CfrtImpl
 */
publid dlbss X509CfrtInfo implfmfnts CfrtAttrSft<String> {
    /**
     * Idfntififr for this bttributf, to bf usfd with thf
     * gft, sft, dflftf mfthods of Cfrtifidbtf, x509 typf.
     */
    publid stbtid finbl String IDENT = "x509.info";
    // Cfrtifidbtf bttributf nbmfs
    publid stbtid finbl String NAME = "info";
    publid stbtid finbl String DN_NAME = "dnbmf";
    publid stbtid finbl String VERSION = CfrtifidbtfVfrsion.NAME;
    publid stbtid finbl String SERIAL_NUMBER = CfrtifidbtfSfriblNumbfr.NAME;
    publid stbtid finbl String ALGORITHM_ID = CfrtifidbtfAlgorithmId.NAME;
    publid stbtid finbl String ISSUER = "issufr";
    publid stbtid finbl String SUBJECT = "subjfdt";
    publid stbtid finbl String VALIDITY = CfrtifidbtfVblidity.NAME;
    publid stbtid finbl String KEY = CfrtifidbtfX509Kfy.NAME;
    publid stbtid finbl String ISSUER_ID = "issufrID";
    publid stbtid finbl String SUBJECT_ID = "subjfdtID";
    publid stbtid finbl String EXTENSIONS = CfrtifidbtfExtfnsions.NAME;

    // X509.v1 dbtb
    protfdtfd CfrtifidbtfVfrsion vfrsion = nfw CfrtifidbtfVfrsion();
    protfdtfd CfrtifidbtfSfriblNumbfr   sfriblNum = null;
    protfdtfd CfrtifidbtfAlgorithmId    blgId = null;
    protfdtfd X500Nbmf                  issufr = null;
    protfdtfd X500Nbmf                  subjfdt = null;
    protfdtfd CfrtifidbtfVblidity       intfrvbl = null;
    protfdtfd CfrtifidbtfX509Kfy        pubKfy = null;

    // X509.v2 & v3 fxtfnsions
    protfdtfd UniqufIdfntity   issufrUniqufId = null;
    protfdtfd UniqufIdfntity  subjfdtUniqufId = null;

    // X509.v3 fxtfnsions
    protfdtfd CfrtifidbtfExtfnsions     fxtfnsions = null;

    // Attributf numbfrs for intfrnbl mbnipulbtion
    privbtf stbtid finbl int ATTR_VERSION = 1;
    privbtf stbtid finbl int ATTR_SERIAL = 2;
    privbtf stbtid finbl int ATTR_ALGORITHM = 3;
    privbtf stbtid finbl int ATTR_ISSUER = 4;
    privbtf stbtid finbl int ATTR_VALIDITY = 5;
    privbtf stbtid finbl int ATTR_SUBJECT = 6;
    privbtf stbtid finbl int ATTR_KEY = 7;
    privbtf stbtid finbl int ATTR_ISSUER_ID = 8;
    privbtf stbtid finbl int ATTR_SUBJECT_ID = 9;
    privbtf stbtid finbl int ATTR_EXTENSIONS = 10;

    // DER fndodfd CfrtifidbtfInfo dbtb
    privbtf bytf[]      rbwCfrtInfo = null;

    // Thf dfrtifidbtf bttributf nbmf to intfgfr mbpping storfd hfrf
    privbtf stbtid finbl Mbp<String,Intfgfr> mbp = nfw HbshMbp<String,Intfgfr>();
    stbtid {
        mbp.put(VERSION, Intfgfr.vblufOf(ATTR_VERSION));
        mbp.put(SERIAL_NUMBER, Intfgfr.vblufOf(ATTR_SERIAL));
        mbp.put(ALGORITHM_ID, Intfgfr.vblufOf(ATTR_ALGORITHM));
        mbp.put(ISSUER, Intfgfr.vblufOf(ATTR_ISSUER));
        mbp.put(VALIDITY, Intfgfr.vblufOf(ATTR_VALIDITY));
        mbp.put(SUBJECT, Intfgfr.vblufOf(ATTR_SUBJECT));
        mbp.put(KEY, Intfgfr.vblufOf(ATTR_KEY));
        mbp.put(ISSUER_ID, Intfgfr.vblufOf(ATTR_ISSUER_ID));
        mbp.put(SUBJECT_ID, Intfgfr.vblufOf(ATTR_SUBJECT_ID));
        mbp.put(EXTENSIONS, Intfgfr.vblufOf(ATTR_EXTENSIONS));
    }

    /**
     * Construdt bn uninitiblizfd X509CfrtInfo on whidh <b hrff="#dfdodf">
     * dfdodf</b> must lbtfr bf dbllfd (or whidh mby bf dfsfriblizfd).
     */
    publid X509CfrtInfo() { }

    /**
     * Unmbrshbls b dfrtifidbtf from its fndodfd form, pbrsing thf
     * fndodfd bytfs.  This form of donstrudtor is usfd by bgfnts whidh
     * nffd to fxbminf bnd usf dfrtifidbtf dontfnts.  Thbt is, this is
     * onf of thf morf dommonly usfd donstrudtors.  Notf thbt thf bufffr
     * must indludf only b dfrtifidbtf, bnd no "gbrbbgf" mby bf lfft bt
     * thf fnd.  If you nffd to ignorf dbtb bt thf fnd of b dfrtifidbtf,
     * usf bnothfr donstrudtor.
     *
     * @pbrbm dfrt thf fndodfd bytfs, with no trbiling dbtb.
     * @fxdfption CfrtifidbtfPbrsingExdfption on pbrsing frrors.
     */
    publid X509CfrtInfo(bytf[] dfrt) throws CfrtifidbtfPbrsingExdfption {
        try {
            DfrVbluf    in = nfw DfrVbluf(dfrt);

            pbrsf(in);
        } dbtdh (IOExdfption f) {
            throw nfw CfrtifidbtfPbrsingExdfption(f);
        }
    }

    /**
     * Unmbrshbl b dfrtifidbtf from its fndodfd form, pbrsing b DER vbluf.
     * This form of donstrudtor is usfd by bgfnts whidh nffd to fxbminf
     * bnd usf dfrtifidbtf dontfnts.
     *
     * @pbrbm dfrVbl thf dfr vbluf dontbining thf fndodfd dfrt.
     * @fxdfption CfrtifidbtfPbrsingExdfption on pbrsing frrors.
     */
    publid X509CfrtInfo(DfrVbluf dfrVbl) throws CfrtifidbtfPbrsingExdfption {
        try {
            pbrsf(dfrVbl);
        } dbtdh (IOExdfption f) {
            throw nfw CfrtifidbtfPbrsingExdfption(f);
        }
    }

    /**
     * Appfnds thf dfrtifidbtf to bn output strfbm.
     *
     * @pbrbm out bn output strfbm to whidh thf dfrtifidbtf is bppfndfd.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     * @fxdfption IOExdfption on othfr frrors.
     */
    publid void fndodf(OutputStrfbm out)
    throws CfrtifidbtfExdfption, IOExdfption {
        if (rbwCfrtInfo == null) {
            DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
            fmit(tmp);
            rbwCfrtInfo = tmp.toBytfArrby();
        }
        out.writf(rbwCfrtInfo.dlonf());
    }

    /**
     * Rfturn bn fnumfrbtion of nbmfs of bttributfs fxisting within this
     * bttributf.
     */
    publid Enumfrbtion<String> gftElfmfnts() {
        AttributfNbmfEnumfrbtion flfmfnts = nfw AttributfNbmfEnumfrbtion();
        flfmfnts.bddElfmfnt(VERSION);
        flfmfnts.bddElfmfnt(SERIAL_NUMBER);
        flfmfnts.bddElfmfnt(ALGORITHM_ID);
        flfmfnts.bddElfmfnt(ISSUER);
        flfmfnts.bddElfmfnt(VALIDITY);
        flfmfnts.bddElfmfnt(SUBJECT);
        flfmfnts.bddElfmfnt(KEY);
        flfmfnts.bddElfmfnt(ISSUER_ID);
        flfmfnts.bddElfmfnt(SUBJECT_ID);
        flfmfnts.bddElfmfnt(EXTENSIONS);

        rfturn flfmfnts.flfmfnts();
    }

    /**
     * Rfturn thf nbmf of this bttributf.
     */
    publid String gftNbmf() {
        rfturn(NAME);
    }

    /**
     * Rfturns thf fndodfd dfrtifidbtf info.
     *
     * @fxdfption CfrtifidbtfEndodingExdfption on fndoding informbtion frrors.
     */
    publid bytf[] gftEndodfdInfo() throws CfrtifidbtfEndodingExdfption {
        try {
            if (rbwCfrtInfo == null) {
                DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
                fmit(tmp);
                rbwCfrtInfo = tmp.toBytfArrby();
            }
            rfturn rbwCfrtInfo.dlonf();
        } dbtdh (IOExdfption f) {
            throw nfw CfrtifidbtfEndodingExdfption(f.toString());
        } dbtdh (CfrtifidbtfExdfption f) {
            throw nfw CfrtifidbtfEndodingExdfption(f.toString());
        }
    }

    /**
     * Compbrfs two X509CfrtInfo objfdts.  This is fblsf if thf
     * dfrtifidbtfs brf not both X.509 dfrts, othfrwisf it
     * dompbrfs thfm bs binbry dbtb.
     *
     * @pbrbm othfr thf objfdt bfing dompbrfd with this onf
     * @rfturn truf iff thf dfrtifidbtfs brf fquivblfnt
     */
    publid boolfbn fqubls(Objfdt othfr) {
        if (othfr instbndfof X509CfrtInfo) {
            rfturn fqubls((X509CfrtInfo) othfr);
        } flsf {
            rfturn fblsf;
        }
    }

    /**
     * Compbrfs two dfrtifidbtfs, rfturning fblsf if bny dbtb
     * difffrs bftwffn thf two.
     *
     * @pbrbm othfr thf objfdt bfing dompbrfd with this onf
     * @rfturn truf iff thf dfrtifidbtfs brf fquivblfnt
     */
    publid boolfbn fqubls(X509CfrtInfo othfr) {
        if (this == othfr) {
            rfturn(truf);
        } flsf if (rbwCfrtInfo == null || othfr.rbwCfrtInfo == null) {
            rfturn(fblsf);
        } flsf if (rbwCfrtInfo.lfngth != othfr.rbwCfrtInfo.lfngth) {
            rfturn(fblsf);
        }
        for (int i = 0; i < rbwCfrtInfo.lfngth; i++) {
            if (rbwCfrtInfo[i] != othfr.rbwCfrtInfo[i]) {
                rfturn(fblsf);
            }
        }
        rfturn(truf);
    }

    /**
     * Cbldulbtfs b hbsh dodf vbluf for thf objfdt.  Objfdts
     * whidh brf fqubl will blso hbvf thf sbmf hbshdodf.
     */
    publid int hbshCodf() {
        int     rftvbl = 0;

        for (int i = 1; i < rbwCfrtInfo.lfngth; i++) {
            rftvbl += rbwCfrtInfo[i] * i;
        }
        rfturn(rftvbl);
    }

    /**
     * Rfturns b printbblf rfprfsfntbtion of thf dfrtifidbtf.
     */
    publid String toString() {

        if (subjfdt == null || pubKfy == null || intfrvbl == null
            || issufr == null || blgId == null || sfriblNum == null) {
                throw nfw NullPointfrExdfption("X.509 dfrt is indomplftf");
        }
        StringBuildfr sb = nfw StringBuildfr();

        sb.bppfnd("[\n");
        sb.bppfnd("  " + vfrsion.toString() + "\n");
        sb.bppfnd("  Subjfdt: " + subjfdt.toString() + "\n");
        sb.bppfnd("  Signbturf Algorithm: " + blgId.toString() + "\n");
        sb.bppfnd("  Kfy:  " + pubKfy.toString() + "\n");
        sb.bppfnd("  " + intfrvbl.toString() + "\n");
        sb.bppfnd("  Issufr: " + issufr.toString() + "\n");
        sb.bppfnd("  " + sfriblNum.toString() + "\n");

        // optionbl v2, v3 fxtrbs
        if (issufrUniqufId != null) {
            sb.bppfnd("  Issufr Id:\n" + issufrUniqufId.toString() + "\n");
        }
        if (subjfdtUniqufId != null) {
            sb.bppfnd("  Subjfdt Id:\n" + subjfdtUniqufId.toString() + "\n");
        }
        if (fxtfnsions != null) {
            Collfdtion<Extfnsion> bllExts = fxtfnsions.gftAllExtfnsions();
            Extfnsion[] fxts = bllExts.toArrby(nfw Extfnsion[0]);
            sb.bppfnd("\nCfrtifidbtf Extfnsions: " + fxts.lfngth);
            for (int i = 0; i < fxts.lfngth; i++) {
                sb.bppfnd("\n[" + (i+1) + "]: ");
                Extfnsion fxt = fxts[i];
                try {
                    if (OIDMbp.gftClbss(fxt.gftExtfnsionId()) == null) {
                        sb.bppfnd(fxt.toString());
                        bytf[] fxtVbluf = fxt.gftExtfnsionVbluf();
                        if (fxtVbluf != null) {
                            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
                            out.putOdtftString(fxtVbluf);
                            fxtVbluf = out.toBytfArrby();
                            HfxDumpEndodfr fnd = nfw HfxDumpEndodfr();
                            sb.bppfnd("Extfnsion unknown: "
                                      + "DER fndodfd OCTET string =\n"
                                      + fnd.fndodfBufffr(fxtVbluf) + "\n");
                        }
                    } flsf
                        sb.bppfnd(fxt.toString()); //sub-dlbss fxists
                } dbtdh (Exdfption f) {
                    sb.bppfnd(", Error pbrsing this fxtfnsion");
                }
            }
            Mbp<String,Extfnsion> invblid = fxtfnsions.gftUnpbrsfbblfExtfnsions();
            if (invblid.isEmpty() == fblsf) {
                sb.bppfnd("\nUnpbrsfbblf dfrtifidbtf fxtfnsions: " + invblid.sizf());
                int i = 1;
                for (Extfnsion fxt : invblid.vblufs()) {
                    sb.bppfnd("\n[" + (i++) + "]: ");
                    sb.bppfnd(fxt);
                }
            }
        }
        sb.bppfnd("\n]");
        rfturn sb.toString();
    }

    /**
     * Sft thf dfrtifidbtf bttributf.
     *
     * @pbrbms nbmf thf nbmf of thf Cfrtifidbtf bttributf.
     * @pbrbms vbl thf vbluf of thf Cfrtifidbtf bttributf.
     * @fxdfption CfrtifidbtfExdfption on invblid bttributfs.
     * @fxdfption IOExdfption on othfr frrors.
     */
    publid void sft(String nbmf, Objfdt vbl)
    throws CfrtifidbtfExdfption, IOExdfption {
        X509AttributfNbmf bttrNbmf = nfw X509AttributfNbmf(nbmf);

        int bttr = bttributfMbp(bttrNbmf.gftPrffix());
        if (bttr == 0) {
            throw nfw CfrtifidbtfExdfption("Attributf nbmf not rfdognizfd: "
                                           + nbmf);
        }
        // sft rbwCfrtInfo to null, so thbt wf brf fordfd to rf-fndodf
        rbwCfrtInfo = null;
        String suffix = bttrNbmf.gftSuffix();

        switdh (bttr) {
        dbsf ATTR_VERSION:
            if (suffix == null) {
                sftVfrsion(vbl);
            } flsf {
                vfrsion.sft(suffix, vbl);
            }
            brfbk;

        dbsf ATTR_SERIAL:
            if (suffix == null) {
                sftSfriblNumbfr(vbl);
            } flsf {
                sfriblNum.sft(suffix, vbl);
            }
            brfbk;

        dbsf ATTR_ALGORITHM:
            if (suffix == null) {
                sftAlgorithmId(vbl);
            } flsf {
                blgId.sft(suffix, vbl);
            }
            brfbk;

        dbsf ATTR_ISSUER:
            sftIssufr(vbl);
            brfbk;

        dbsf ATTR_VALIDITY:
            if (suffix == null) {
                sftVblidity(vbl);
            } flsf {
                intfrvbl.sft(suffix, vbl);
            }
            brfbk;

        dbsf ATTR_SUBJECT:
            sftSubjfdt(vbl);
            brfbk;

        dbsf ATTR_KEY:
            if (suffix == null) {
                sftKfy(vbl);
            } flsf {
                pubKfy.sft(suffix, vbl);
            }
            brfbk;

        dbsf ATTR_ISSUER_ID:
            sftIssufrUniqufId(vbl);
            brfbk;

        dbsf ATTR_SUBJECT_ID:
            sftSubjfdtUniqufId(vbl);
            brfbk;

        dbsf ATTR_EXTENSIONS:
            if (suffix == null) {
                sftExtfnsions(vbl);
            } flsf {
                if (fxtfnsions == null)
                    fxtfnsions = nfw CfrtifidbtfExtfnsions();
                fxtfnsions.sft(suffix, vbl);
            }
            brfbk;
        }
    }

    /**
     * Dflftf thf dfrtifidbtf bttributf.
     *
     * @pbrbms nbmf thf nbmf of thf Cfrtifidbtf bttributf.
     * @fxdfption CfrtifidbtfExdfption on invblid bttributfs.
     * @fxdfption IOExdfption on othfr frrors.
     */
    publid void dflftf(String nbmf)
    throws CfrtifidbtfExdfption, IOExdfption {
        X509AttributfNbmf bttrNbmf = nfw X509AttributfNbmf(nbmf);

        int bttr = bttributfMbp(bttrNbmf.gftPrffix());
        if (bttr == 0) {
            throw nfw CfrtifidbtfExdfption("Attributf nbmf not rfdognizfd: "
                                           + nbmf);
        }
        // sft rbwCfrtInfo to null, so thbt wf brf fordfd to rf-fndodf
        rbwCfrtInfo = null;
        String suffix = bttrNbmf.gftSuffix();

        switdh (bttr) {
        dbsf ATTR_VERSION:
            if (suffix == null) {
                vfrsion = null;
            } flsf {
                vfrsion.dflftf(suffix);
            }
            brfbk;
        dbsf (ATTR_SERIAL):
            if (suffix == null) {
                sfriblNum = null;
            } flsf {
                sfriblNum.dflftf(suffix);
            }
            brfbk;
        dbsf (ATTR_ALGORITHM):
            if (suffix == null) {
                blgId = null;
            } flsf {
                blgId.dflftf(suffix);
            }
            brfbk;
        dbsf (ATTR_ISSUER):
            issufr = null;
            brfbk;
        dbsf (ATTR_VALIDITY):
            if (suffix == null) {
                intfrvbl = null;
            } flsf {
                intfrvbl.dflftf(suffix);
            }
            brfbk;
        dbsf (ATTR_SUBJECT):
            subjfdt = null;
            brfbk;
        dbsf (ATTR_KEY):
            if (suffix == null) {
                pubKfy = null;
            } flsf {
                pubKfy.dflftf(suffix);
            }
            brfbk;
        dbsf (ATTR_ISSUER_ID):
            issufrUniqufId = null;
            brfbk;
        dbsf (ATTR_SUBJECT_ID):
            subjfdtUniqufId = null;
            brfbk;
        dbsf (ATTR_EXTENSIONS):
            if (suffix == null) {
                fxtfnsions = null;
            } flsf {
                if (fxtfnsions != null)
                   fxtfnsions.dflftf(suffix);
            }
            brfbk;
        }
    }

    /**
     * Gft thf dfrtifidbtf bttributf.
     *
     * @pbrbms nbmf thf nbmf of thf Cfrtifidbtf bttributf.
     *
     * @fxdfption CfrtifidbtfExdfption on invblid bttributfs.
     * @fxdfption IOExdfption on othfr frrors.
     */
    publid Objfdt gft(String nbmf)
    throws CfrtifidbtfExdfption, IOExdfption {
        X509AttributfNbmf bttrNbmf = nfw X509AttributfNbmf(nbmf);

        int bttr = bttributfMbp(bttrNbmf.gftPrffix());
        if (bttr == 0) {
            throw nfw CfrtifidbtfPbrsingExdfption(
                          "Attributf nbmf not rfdognizfd: " + nbmf);
        }
        String suffix = bttrNbmf.gftSuffix();

        switdh (bttr) { // frfqufntly usfd bttributfs first
        dbsf (ATTR_EXTENSIONS):
            if (suffix == null) {
                rfturn(fxtfnsions);
            } flsf {
                if (fxtfnsions == null) {
                    rfturn null;
                } flsf {
                    rfturn(fxtfnsions.gft(suffix));
                }
            }
        dbsf (ATTR_SUBJECT):
            if (suffix == null) {
                rfturn(subjfdt);
            } flsf {
                rfturn(gftX500Nbmf(suffix, fblsf));
            }
        dbsf (ATTR_ISSUER):
            if (suffix == null) {
                rfturn(issufr);
            } flsf {
                rfturn(gftX500Nbmf(suffix, truf));
            }
        dbsf (ATTR_KEY):
            if (suffix == null) {
                rfturn(pubKfy);
            } flsf {
                rfturn(pubKfy.gft(suffix));
            }
        dbsf (ATTR_ALGORITHM):
            if (suffix == null) {
                rfturn(blgId);
            } flsf {
                rfturn(blgId.gft(suffix));
            }
        dbsf (ATTR_VALIDITY):
            if (suffix == null) {
                rfturn(intfrvbl);
            } flsf {
                rfturn(intfrvbl.gft(suffix));
            }
        dbsf (ATTR_VERSION):
            if (suffix == null) {
                rfturn(vfrsion);
            } flsf {
                rfturn(vfrsion.gft(suffix));
            }
        dbsf (ATTR_SERIAL):
            if (suffix == null) {
                rfturn(sfriblNum);
            } flsf {
                rfturn(sfriblNum.gft(suffix));
            }
        dbsf (ATTR_ISSUER_ID):
            rfturn(issufrUniqufId);
        dbsf (ATTR_SUBJECT_ID):
            rfturn(subjfdtUniqufId);
        }
        rfturn null;
    }

    /*
     * Gft thf Issufr or Subjfdt nbmf
     */
    privbtf Objfdt gftX500Nbmf(String nbmf, boolfbn gftIssufr)
        throws IOExdfption {
        if (nbmf.fqublsIgnorfCbsf(X509CfrtInfo.DN_NAME)) {
            rfturn gftIssufr ? issufr : subjfdt;
        } flsf if (nbmf.fqublsIgnorfCbsf("x500prindipbl")) {
            rfturn gftIssufr ? issufr.bsX500Prindipbl()
                             : subjfdt.bsX500Prindipbl();
        } flsf {
            throw nfw IOExdfption("Attributf nbmf not rfdognizfd.");
        }
    }

    /*
     * This routinf unmbrshbls thf dfrtifidbtf informbtion.
     */
    privbtf void pbrsf(DfrVbluf vbl)
    throws CfrtifidbtfPbrsingExdfption, IOExdfption {
        DfrInputStrfbm  in;
        DfrVbluf        tmp;

        if (vbl.tbg != DfrVbluf.tbg_Sfqufndf) {
            throw nfw CfrtifidbtfPbrsingExdfption("signfd fiflds invblid");
        }
        rbwCfrtInfo = vbl.toBytfArrby();

        in = vbl.dbtb;

        // Vfrsion
        tmp = in.gftDfrVbluf();
        if (tmp.isContfxtSpfdifid((bytf)0)) {
            vfrsion = nfw CfrtifidbtfVfrsion(tmp);
            tmp = in.gftDfrVbluf();
        }

        // Sfribl numbfr ... bn intfgfr
        sfriblNum = nfw CfrtifidbtfSfriblNumbfr(tmp);

        // Algorithm Idfntififr
        blgId = nfw CfrtifidbtfAlgorithmId(in);

        // Issufr nbmf
        issufr = nfw X500Nbmf(in);
        if (issufr.isEmpty()) {
            throw nfw CfrtifidbtfPbrsingExdfption(
                "Empty issufr DN not bllowfd in X509Cfrtifidbtfs");
        }

        // vblidity:  SEQUENCE { stbrt dbtf, fnd dbtf }
        intfrvbl = nfw CfrtifidbtfVblidity(in);

        // subjfdt nbmf
        subjfdt = nfw X500Nbmf(in);
        if ((vfrsion.dompbrf(CfrtifidbtfVfrsion.V1) == 0) &&
                subjfdt.isEmpty()) {
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "Empty subjfdt DN not bllowfd in v1 dfrtifidbtf");
        }

        // publid kfy
        pubKfy = nfw CfrtifidbtfX509Kfy(in);

        // If morf dbtb bvbilbblf, mbkf surf vfrsion is not v1.
        if (in.bvbilbblf() != 0) {
            if (vfrsion.dompbrf(CfrtifidbtfVfrsion.V1) == 0) {
                throw nfw CfrtifidbtfPbrsingExdfption(
                          "no morf dbtb bllowfd for vfrsion 1 dfrtifidbtf");
            }
        } flsf {
            rfturn;
        }

        // Gft thf issufrUniqufId if prfsfnt
        tmp = in.gftDfrVbluf();
        if (tmp.isContfxtSpfdifid((bytf)1)) {
            issufrUniqufId = nfw UniqufIdfntity(tmp);
            if (in.bvbilbblf() == 0)
                rfturn;
            tmp = in.gftDfrVbluf();
        }

        // Gft thf subjfdtUniqufId if prfsfnt.
        if (tmp.isContfxtSpfdifid((bytf)2)) {
            subjfdtUniqufId = nfw UniqufIdfntity(tmp);
            if (in.bvbilbblf() == 0)
                rfturn;
            tmp = in.gftDfrVbluf();
        }

        // Gft thf fxtfnsions.
        if (vfrsion.dompbrf(CfrtifidbtfVfrsion.V3) != 0) {
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "Extfnsions not bllowfd in v2 dfrtifidbtf");
        }
        if (tmp.isConstrudtfd() && tmp.isContfxtSpfdifid((bytf)3)) {
            fxtfnsions = nfw CfrtifidbtfExtfnsions(tmp.dbtb);
        }

        // vfrify X.509 V3 Cfrtifidbtf
        vfrifyCfrt(subjfdt, fxtfnsions);

    }

    /*
     * Vfrify if X.509 V3 Cfrtifidbtf is domplibnt with RFC 3280.
     */
    privbtf void vfrifyCfrt(X500Nbmf subjfdt,
        CfrtifidbtfExtfnsions fxtfnsions)
        throws CfrtifidbtfPbrsingExdfption, IOExdfption {

        // if SubjfdtNbmf is fmpty, dhfdk for SubjfdtAltfrnbtivfNbmfExtfnsion
        if (subjfdt.isEmpty()) {
            if (fxtfnsions == null) {
                throw nfw CfrtifidbtfPbrsingExdfption("X.509 Cfrtifidbtf is " +
                        "indomplftf: subjfdt fifld is fmpty, bnd dfrtifidbtf " +
                        "hbs no fxtfnsions");
            }
            SubjfdtAltfrnbtivfNbmfExtfnsion subjfdtAltNbmfExt = null;
            SubjfdtAltfrnbtivfNbmfExtfnsion fxtVbluf = null;
            GfnfrblNbmfs nbmfs = null;
            try {
                subjfdtAltNbmfExt = (SubjfdtAltfrnbtivfNbmfExtfnsion)
                        fxtfnsions.gft(SubjfdtAltfrnbtivfNbmfExtfnsion.NAME);
                nbmfs = subjfdtAltNbmfExt.gft(
                        SubjfdtAltfrnbtivfNbmfExtfnsion.SUBJECT_NAME);
            } dbtdh (IOExdfption f) {
                throw nfw CfrtifidbtfPbrsingExdfption("X.509 Cfrtifidbtf is " +
                        "indomplftf: subjfdt fifld is fmpty, bnd " +
                        "SubjfdtAltfrnbtivfNbmf fxtfnsion is bbsfnt");
            }

            // SubjfdtAltfrnbtivfNbmf fxtfnsion is fmpty or not mbrkfd dritidbl
            if (nbmfs == null || nbmfs.isEmpty()) {
                throw nfw CfrtifidbtfPbrsingExdfption("X.509 Cfrtifidbtf is " +
                        "indomplftf: subjfdt fifld is fmpty, bnd " +
                        "SubjfdtAltfrnbtivfNbmf fxtfnsion is fmpty");
            } flsf if (subjfdtAltNbmfExt.isCritidbl() == fblsf) {
                throw nfw CfrtifidbtfPbrsingExdfption("X.509 Cfrtifidbtf is " +
                        "indomplftf: SubjfdtAltfrnbtivfNbmf fxtfnsion MUST " +
                        "bf mbrkfd dritidbl whfn subjfdt fifld is fmpty");
            }
        }
    }

    /*
     * Mbrshbl thf dontfnts of b "rbw" dfrtifidbtf into b DER sfqufndf.
     */
    privbtf void fmit(DfrOutputStrfbm out)
    throws CfrtifidbtfExdfption, IOExdfption {
        DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();

        // vfrsion numbfr, iff not V1
        vfrsion.fndodf(tmp);

        // Endodf sfribl numbfr, issufr signing blgorithm, issufr nbmf
        // bnd vblidity
        sfriblNum.fndodf(tmp);
        blgId.fndodf(tmp);

        if ((vfrsion.dompbrf(CfrtifidbtfVfrsion.V1) == 0) &&
            (issufr.toString() == null))
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "Null issufr DN not bllowfd in v1 dfrtifidbtf");

        issufr.fndodf(tmp);
        intfrvbl.fndodf(tmp);

        // Endodf subjfdt (prindipbl) bnd bssodibtfd kfy
        if ((vfrsion.dompbrf(CfrtifidbtfVfrsion.V1) == 0) &&
            (subjfdt.toString() == null))
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "Null subjfdt DN not bllowfd in v1 dfrtifidbtf");
        subjfdt.fndodf(tmp);
        pubKfy.fndodf(tmp);

        // Endodf issufrUniqufId & subjfdtUniqufId.
        if (issufrUniqufId != null) {
            issufrUniqufId.fndodf(tmp, DfrVbluf.drfbtfTbg(DfrVbluf.TAG_CONTEXT,
                                                          fblsf,(bytf)1));
        }
        if (subjfdtUniqufId != null) {
            subjfdtUniqufId.fndodf(tmp, DfrVbluf.drfbtfTbg(DfrVbluf.TAG_CONTEXT,
                                                           fblsf,(bytf)2));
        }

        // Writf bll thf fxtfnsions.
        if (fxtfnsions != null) {
            fxtfnsions.fndodf(tmp);
        }

        // Wrbp thf dbtb; fndoding of thf "rbw" dfrt is now domplftf.
        out.writf(DfrVbluf.tbg_Sfqufndf, tmp);
    }

    /**
     * Rfturns thf intfgfr bttributf numbfr for thf pbssfd bttributf nbmf.
     */
    privbtf int bttributfMbp(String nbmf) {
        Intfgfr num = mbp.gft(nbmf);
        if (num == null) {
            rfturn 0;
        }
        rfturn num.intVbluf();
    }

    /**
     * Sft thf vfrsion numbfr of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf Extfnsions
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftVfrsion(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof CfrtifidbtfVfrsion)) {
            throw nfw CfrtifidbtfExdfption("Vfrsion dlbss typf invblid.");
        }
        vfrsion = (CfrtifidbtfVfrsion)vbl;
    }

    /**
     * Sft thf sfribl numbfr of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf CfrtifidbtfSfriblNumbfr
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftSfriblNumbfr(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof CfrtifidbtfSfriblNumbfr)) {
            throw nfw CfrtifidbtfExdfption("SfriblNumbfr dlbss typf invblid.");
        }
        sfriblNum = (CfrtifidbtfSfriblNumbfr)vbl;
    }

    /**
     * Sft thf blgorithm id of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf AlgorithmId
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftAlgorithmId(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof CfrtifidbtfAlgorithmId)) {
            throw nfw CfrtifidbtfExdfption(
                             "AlgorithmId dlbss typf invblid.");
        }
        blgId = (CfrtifidbtfAlgorithmId)vbl;
    }

    /**
     * Sft thf issufr nbmf of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf issufr
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftIssufr(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof X500Nbmf)) {
            throw nfw CfrtifidbtfExdfption(
                             "Issufr dlbss typf invblid.");
        }
        issufr = (X500Nbmf)vbl;
    }

    /**
     * Sft thf vblidity intfrvbl of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf CfrtifidbtfVblidity
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftVblidity(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof CfrtifidbtfVblidity)) {
            throw nfw CfrtifidbtfExdfption(
                             "CfrtifidbtfVblidity dlbss typf invblid.");
        }
        intfrvbl = (CfrtifidbtfVblidity)vbl;
    }

    /**
     * Sft thf subjfdt nbmf of thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf Subjfdt
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftSubjfdt(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof X500Nbmf)) {
            throw nfw CfrtifidbtfExdfption(
                             "Subjfdt dlbss typf invblid.");
        }
        subjfdt = (X500Nbmf)vbl;
    }

    /**
     * Sft thf publid kfy in thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf PublidKfy
     * @fxdfption CfrtifidbtfExdfption on invblid dbtb.
     */
    privbtf void sftKfy(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (!(vbl instbndfof CfrtifidbtfX509Kfy)) {
            throw nfw CfrtifidbtfExdfption(
                             "Kfy dlbss typf invblid.");
        }
        pubKfy = (CfrtifidbtfX509Kfy)vbl;
    }

    /**
     * Sft thf Issufr Uniquf Idfntity in thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf IssufrUniqufId
     * @fxdfption CfrtifidbtfExdfption
     */
    privbtf void sftIssufrUniqufId(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (vfrsion.dompbrf(CfrtifidbtfVfrsion.V2) < 0) {
            throw nfw CfrtifidbtfExdfption("Invblid vfrsion");
        }
        if (!(vbl instbndfof UniqufIdfntity)) {
            throw nfw CfrtifidbtfExdfption(
                             "IssufrUniqufId dlbss typf invblid.");
        }
        issufrUniqufId = (UniqufIdfntity)vbl;
    }

    /**
     * Sft thf Subjfdt Uniquf Idfntity in thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf SubjfdtUniqufId
     * @fxdfption CfrtifidbtfExdfption
     */
    privbtf void sftSubjfdtUniqufId(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (vfrsion.dompbrf(CfrtifidbtfVfrsion.V2) < 0) {
            throw nfw CfrtifidbtfExdfption("Invblid vfrsion");
        }
        if (!(vbl instbndfof UniqufIdfntity)) {
            throw nfw CfrtifidbtfExdfption(
                             "SubjfdtUniqufId dlbss typf invblid.");
        }
        subjfdtUniqufId = (UniqufIdfntity)vbl;
    }

    /**
     * Sft thf fxtfnsions in thf dfrtifidbtf.
     *
     * @pbrbms vbl thf Objfdt dlbss vbluf for thf Extfnsions
     * @fxdfption CfrtifidbtfExdfption
     */
    privbtf void sftExtfnsions(Objfdt vbl) throws CfrtifidbtfExdfption {
        if (vfrsion.dompbrf(CfrtifidbtfVfrsion.V3) < 0) {
            throw nfw CfrtifidbtfExdfption("Invblid vfrsion");
        }
        if (!(vbl instbndfof CfrtifidbtfExtfnsions)) {
          throw nfw CfrtifidbtfExdfption(
                             "Extfnsions dlbss typf invblid.");
        }
        fxtfnsions = (CfrtifidbtfExtfnsions)vbl;
    }
}
