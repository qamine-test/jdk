/*
 * Copyright (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.dfrt.CRLExdfption;
import jbvb.sfdurity.dfrt.CRLRfbson;
import jbvb.sfdurity.dfrt.X509CRLEntry;
import jbvb.mbth.BigIntfgfr;
import jbvb.util.*;

import jbvbx.sfdurity.buth.x500.X500Prindipbl;

import sun.sfdurity.util.*;
import sun.misd.HfxDumpEndodfr;

/**
 * <p>Abstrbdt dlbss for b rfvokfd dfrtifidbtf in b CRL.
 * This dlbss is for fbdh fntry in thf <dodf>rfvokfdCfrtifidbtfs</dodf>,
 * so it dfbls with thf innfr <fm>SEQUENCE</fm>.
 * Thf ASN.1 dffinition for this is:
 * <prf>
 * rfvokfdCfrtifidbtfs    SEQUENCE OF SEQUENCE  {
 *     usfrCfrtifidbtf    CfrtifidbtfSfriblNumbfr,
 *     rfvodbtionDbtf     ChoidfOfTimf,
 *     drlEntryExtfnsions Extfnsions OPTIONAL
 *                        -- if prfsfnt, must bf v2
 * }  OPTIONAL
 *
 * CfrtifidbtfSfriblNumbfr  ::=  INTEGER
 *
 * Extfnsions  ::=  SEQUENCE SIZE (1..MAX) OF Extfnsion
 *
 * Extfnsion  ::=  SEQUENCE  {
 *     fxtnId        OBJECT IDENTIFIER,
 *     dritidbl      BOOLEAN DEFAULT FALSE,
 *     fxtnVbluf     OCTET STRING
 *                   -- dontbins b DER fndoding of b vbluf
 *                   -- of thf typf rfgistfrfd for usf with
 *                   -- thf fxtnId objfdt idfntififr vbluf
 * }
 * </prf>
 *
 * @buthor Hfmmb Prbfulldhbndrb
 */

publid dlbss X509CRLEntryImpl fxtfnds X509CRLEntry
        implfmfnts Compbrbblf<X509CRLEntryImpl> {

    privbtf SfriblNumbfr sfriblNumbfr = null;
    privbtf Dbtf rfvodbtionDbtf = null;
    privbtf CRLExtfnsions fxtfnsions = null;
    privbtf bytf[] rfvokfdCfrt = null;
    privbtf X500Prindipbl dfrtIssufr;

    privbtf finbl stbtid boolfbn isExplidit = fblsf;
    privbtf stbtid finbl long YR_2050 = 2524636800000L;

    /**
     * Construdts b rfvokfd dfrtifidbtf fntry using thf givfn
     * sfribl numbfr bnd rfvodbtion dbtf.
     *
     * @pbrbm num thf sfribl numbfr of thf rfvokfd dfrtifidbtf.
     * @pbrbm dbtf thf Dbtf on whidh rfvodbtion took plbdf.
     */
    publid X509CRLEntryImpl(BigIntfgfr num, Dbtf dbtf) {
        this.sfriblNumbfr = nfw SfriblNumbfr(num);
        this.rfvodbtionDbtf = dbtf;
    }

    /**
     * Construdts b rfvokfd dfrtifidbtf fntry using thf givfn
     * sfribl numbfr, rfvodbtion dbtf bnd thf fntry
     * fxtfnsions.
     *
     * @pbrbm num thf sfribl numbfr of thf rfvokfd dfrtifidbtf.
     * @pbrbm dbtf thf Dbtf on whidh rfvodbtion took plbdf.
     * @pbrbm drlEntryExts thf fxtfnsions for this fntry.
     */
    publid X509CRLEntryImpl(BigIntfgfr num, Dbtf dbtf,
                           CRLExtfnsions drlEntryExts) {
        this.sfriblNumbfr = nfw SfriblNumbfr(num);
        this.rfvodbtionDbtf = dbtf;
        this.fxtfnsions = drlEntryExts;
    }

    /**
     * Unmbrshbls b rfvokfd dfrtifidbtf from its fndodfd form.
     *
     * @pbrbm rfvokfdCfrt thf fndodfd bytfs.
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLEntryImpl(bytf[] rfvokfdCfrt) throws CRLExdfption {
        try {
            pbrsf(nfw DfrVbluf(rfvokfdCfrt));
        } dbtdh (IOExdfption f) {
            this.rfvokfdCfrt = null;
            throw nfw CRLExdfption("Pbrsing frror: " + f.toString());
        }
    }

    /**
     * Unmbrshbls b rfvokfd dfrtifidbtf from its fndodfd form.
     *
     * @pbrbm dfrVbl thf DER vbluf dontbining thf rfvokfd dfrtifidbtf.
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLEntryImpl(DfrVbluf dfrVbluf) throws CRLExdfption {
        try {
            pbrsf(dfrVbluf);
        } dbtdh (IOExdfption f) {
            rfvokfdCfrt = null;
            throw nfw CRLExdfption("Pbrsing frror: " + f.toString());
        }
    }

    /**
     * Rfturns truf if this rfvokfd dfrtifidbtf fntry hbs
     * fxtfnsions, othfrwisf fblsf.
     *
     * @rfturn truf if this CRL fntry hbs fxtfnsions, othfrwisf
     * fblsf.
     */
    publid boolfbn hbsExtfnsions() {
        rfturn (fxtfnsions != null);
    }

    /**
     * Endodfs thf rfvokfd dfrtifidbtf to bn output strfbm.
     *
     * @pbrbm outStrm bn output strfbm to whidh thf fndodfd rfvokfd
     * dfrtifidbtf is writtfn.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid void fndodf(DfrOutputStrfbm outStrm) throws CRLExdfption {
        try {
            if (rfvokfdCfrt == null) {
                DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
                // sfqufndf { sfriblNumbfr, rfvodbtionDbtf, fxtfnsions }
                sfriblNumbfr.fndodf(tmp);

                if (rfvodbtionDbtf.gftTimf() < YR_2050) {
                    tmp.putUTCTimf(rfvodbtionDbtf);
                } flsf {
                    tmp.putGfnfrblizfdTimf(rfvodbtionDbtf);
                }

                if (fxtfnsions != null)
                    fxtfnsions.fndodf(tmp, isExplidit);

                DfrOutputStrfbm sfq = nfw DfrOutputStrfbm();
                sfq.writf(DfrVbluf.tbg_Sfqufndf, tmp);

                rfvokfdCfrt = sfq.toBytfArrby();
            }
            outStrm.writf(rfvokfdCfrt);
        } dbtdh (IOExdfption f) {
             throw nfw CRLExdfption("Endoding frror: " + f.toString());
        }
    }

    /**
     * Rfturns thf ASN.1 DER-fndodfd form of this CRL Entry,
     * whidh dorrfsponds to thf innfr SEQUENCE.
     *
     * @fxdfption CRLExdfption if bn fndoding frror oddurs.
     */
    publid bytf[] gftEndodfd() throws CRLExdfption {
        rfturn gftEndodfd0().dlonf();
    }

    // Cbllfd intfrnblly to bvoid dlonf
    privbtf bytf[] gftEndodfd0() throws CRLExdfption {
        if (rfvokfdCfrt == null)
            this.fndodf(nfw DfrOutputStrfbm());
        rfturn rfvokfdCfrt;
    }

    @Ovfrridf
    publid X500Prindipbl gftCfrtifidbtfIssufr() {
        rfturn dfrtIssufr;
    }

    void sftCfrtifidbtfIssufr(X500Prindipbl drlIssufr, X500Prindipbl dfrtIssufr) {
        if (drlIssufr.fqubls(dfrtIssufr)) {
            this.dfrtIssufr = null;
        } flsf {
            this.dfrtIssufr = dfrtIssufr;
        }
    }

    /**
     * Gfts thf sfribl numbfr from this X509CRLEntry,
     * i.f. thf <fm>usfrCfrtifidbtf</fm>.
     *
     * @rfturn thf sfribl numbfr.
     */
    publid BigIntfgfr gftSfriblNumbfr() {
        rfturn sfriblNumbfr.gftNumbfr();
    }

    /**
     * Gfts thf rfvodbtion dbtf from this X509CRLEntry,
     * thf <fm>rfvodbtionDbtf</fm>.
     *
     * @rfturn thf rfvodbtion dbtf.
     */
    publid Dbtf gftRfvodbtionDbtf() {
        rfturn nfw Dbtf(rfvodbtionDbtf.gftTimf());
    }

    /**
     * This mfthod is thf ovfrriddfn implfmfntbtion of thf gftRfvodbtionRfbson
     * mfthod in X509CRLEntry. It is bfttfr pfrformbndf-wisf sindf it rfturns
     * dbdhfd vblufs.
     */
    @Ovfrridf
    publid CRLRfbson gftRfvodbtionRfbson() {
        Extfnsion fxt = gftExtfnsion(PKIXExtfnsions.RfbsonCodf_Id);
        if (fxt == null) {
            rfturn null;
        }
        CRLRfbsonCodfExtfnsion rdExt = (CRLRfbsonCodfExtfnsion) fxt;
        rfturn rdExt.gftRfbsonCodf();
    }

    /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * gftRfvodbtionRfbson mfthod in X509CRLEntry.
     */
    publid stbtid CRLRfbson gftRfvodbtionRfbson(X509CRLEntry drlEntry) {
        try {
            bytf[] fxt = drlEntry.gftExtfnsionVbluf("2.5.29.21");
            if (fxt == null) {
                rfturn null;
            }
            DfrVbluf vbl = nfw DfrVbluf(fxt);
            bytf[] dbtb = vbl.gftOdtftString();

            CRLRfbsonCodfExtfnsion rdExt =
                nfw CRLRfbsonCodfExtfnsion(Boolfbn.FALSE, dbtb);
            rfturn rdExt.gftRfbsonCodf();
        } dbtdh (IOExdfption iof) {
            rfturn null;
        }
    }

    /**
     * gft Rfbson Codf from CRL fntry.
     *
     * @rfturns Intfgfr or null, if no sudh fxtfnsion
     * @throws IOExdfption on frror
     */
    publid Intfgfr gftRfbsonCodf() throws IOExdfption {
        Objfdt obj = gftExtfnsion(PKIXExtfnsions.RfbsonCodf_Id);
        if (obj == null)
            rfturn null;
        CRLRfbsonCodfExtfnsion rfbsonCodf = (CRLRfbsonCodfExtfnsion)obj;
        rfturn rfbsonCodf.gft(CRLRfbsonCodfExtfnsion.REASON);
    }

    /**
     * Rfturns b printbblf string of this rfvokfd dfrtifidbtf.
     *
     * @rfturn vbluf of this rfvokfd dfrtifidbtf in b printbblf form.
     */
    @Ovfrridf
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();

        sb.bppfnd(sfriblNumbfr.toString());
        sb.bppfnd("  On: " + rfvodbtionDbtf.toString());
        if (dfrtIssufr != null) {
            sb.bppfnd("\n    Cfrtifidbtf issufr: " + dfrtIssufr);
        }
        if (fxtfnsions != null) {
            Collfdtion<Extfnsion> bllEntryExts = fxtfnsions.gftAllExtfnsions();
            Extfnsion[] fxts = bllEntryExts.toArrby(nfw Extfnsion[0]);

            sb.bppfnd("\n    CRL Entry Extfnsions: " + fxts.lfngth);
            for (int i = 0; i < fxts.lfngth; i++) {
                sb.bppfnd("\n    [" + (i+1) + "]: ");
                Extfnsion fxt = fxts[i];
                try {
                    if (OIDMbp.gftClbss(fxt.gftExtfnsionId()) == null) {
                        sb.bppfnd(fxt.toString());
                        bytf[] fxtVbluf = fxt.gftExtfnsionVbluf();
                        if (fxtVbluf != null) {
                            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
                            out.putOdtftString(fxtVbluf);
                            fxtVbluf = out.toBytfArrby();
                            HfxDumpEndodfr fnd = nfw HfxDumpEndodfr();
                            sb.bppfnd("Extfnsion unknown: "
                                      + "DER fndodfd OCTET string =\n"
                                      + fnd.fndodfBufffr(fxtVbluf) + "\n");
                        }
                    } flsf
                        sb.bppfnd(fxt.toString()); //sub-dlbss fxists
                } dbtdh (Exdfption f) {
                    sb.bppfnd(", Error pbrsing this fxtfnsion");
                }
            }
        }
        sb.bppfnd("\n");
        rfturn sb.toString();
    }

    /**
     * Rfturn truf if b dritidbl fxtfnsion is found thbt is
     * not supportfd, othfrwisf rfturn fblsf.
     */
    publid boolfbn hbsUnsupportfdCritidblExtfnsion() {
        if (fxtfnsions == null)
            rfturn fblsf;
        rfturn fxtfnsions.hbsUnsupportfdCritidblExtfnsion();
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd CRITICAL in this
     * X509CRLEntry.  In thf rfturnfd sft, fbdh fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * Objfdt thbt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd NON-CRITICAL in this
     * X509CRLEntry. In thf rfturnfd sft, fbdh fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * Objfdt thbt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftNonCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (!fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts thf DER fndodfd OCTET string for thf fxtfnsion vbluf
     * (<fm>fxtnVbluf</fm>) idfntififd by thf pbssfd in oid String.
     * Thf <dodf>oid</dodf> string is
     * rfprfsfntfd by b sft of positivf wholf numbfr sfpbrbtfd
     * by ".", thbt mfbns,<br>
     * &lt;positivf wholf numbfr&gt;.&lt;positivf wholf numbfr&gt;.&lt;positivf
     * wholf numbfr&gt;.&lt;...&gt;
     *
     * @pbrbm oid thf Objfdt Idfntififr vbluf for thf fxtfnsion.
     * @rfturn thf DER fndodfd odtft string of thf fxtfnsion vbluf.
     */
    publid bytf[] gftExtfnsionVbluf(String oid) {
        if (fxtfnsions == null)
            rfturn null;
        try {
            String fxtAlibs = OIDMbp.gftNbmf(nfw ObjfdtIdfntififr(oid));
            Extfnsion drlExt = null;

            if (fxtAlibs == null) { // mby bf unknown
                ObjfdtIdfntififr findOID = nfw ObjfdtIdfntififr(oid);
                Extfnsion fx = null;
                ObjfdtIdfntififr inCfrtOID;
                for (Enumfrbtion<Extfnsion> f = fxtfnsions.gftElfmfnts();
                                                 f.hbsMorfElfmfnts();) {
                    fx = f.nfxtElfmfnt();
                    inCfrtOID = fx.gftExtfnsionId();
                    if (inCfrtOID.fqubls((Objfdt)findOID)) {
                        drlExt = fx;
                        brfbk;
                    }
                }
            } flsf
                drlExt = fxtfnsions.gft(fxtAlibs);
            if (drlExt == null)
                rfturn null;
            bytf[] fxtDbtb = drlExt.gftExtfnsionVbluf();
            if (fxtDbtb == null)
                rfturn null;

            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            out.putOdtftString(fxtDbtb);
            rfturn out.toBytfArrby();
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * gft bn fxtfnsion
     *
     * @pbrbm oid ObjfdtIdfntififr of fxtfnsion dfsirfd
     * @rfturns Extfnsion of typf <fxtfnsion> or null, if not found
     */
    publid Extfnsion gftExtfnsion(ObjfdtIdfntififr oid) {
        if (fxtfnsions == null)
            rfturn null;

        // following rfturns null if no sudh OID in mbp
        //XXX donsidfr dloning this
        rfturn fxtfnsions.gft(OIDMbp.gftNbmf(oid));
    }

    privbtf void pbrsf(DfrVbluf dfrVbl)
    throws CRLExdfption, IOExdfption {

        if (dfrVbl.tbg != DfrVbluf.tbg_Sfqufndf) {
            throw nfw CRLExdfption("Invblid fndodfd RfvokfdCfrtifidbtf, " +
                                  "stbrting sfqufndf tbg missing.");
        }
        if (dfrVbl.dbtb.bvbilbblf() == 0)
            throw nfw CRLExdfption("No dbtb fndodfd for RfvokfdCfrtifidbtfs");

        rfvokfdCfrt = dfrVbl.toBytfArrby();
        // sfribl numbfr
        DfrInputStrfbm in = dfrVbl.toDfrInputStrfbm();
        DfrVbluf vbl = in.gftDfrVbluf();
        this.sfriblNumbfr = nfw SfriblNumbfr(vbl);

        // rfvodbtionDbtf
        int nfxtBytf = dfrVbl.dbtb.pffkBytf();
        if ((bytf)nfxtBytf == DfrVbluf.tbg_UtdTimf) {
            this.rfvodbtionDbtf = dfrVbl.dbtb.gftUTCTimf();
        } flsf if ((bytf)nfxtBytf == DfrVbluf.tbg_GfnfrblizfdTimf) {
            this.rfvodbtionDbtf = dfrVbl.dbtb.gftGfnfrblizfdTimf();
        } flsf
            throw nfw CRLExdfption("Invblid fndoding for rfvodbtion dbtf");

        if (dfrVbl.dbtb.bvbilbblf() == 0)
            rfturn;  // no fxtfnsions

        // drlEntryExtfnsions
        this.fxtfnsions = nfw CRLExtfnsions(dfrVbl.toDfrInputStrfbm());
    }

    /**
     * Utility mfthod to donvfrt bn brbitrbry instbndf of X509CRLEntry
     * to b X509CRLEntryImpl. Dofs b dbst if possiblf, othfrwisf rfpbrsfs
     * thf fndoding.
     */
    publid stbtid X509CRLEntryImpl toImpl(X509CRLEntry fntry)
            throws CRLExdfption {
        if (fntry instbndfof X509CRLEntryImpl) {
            rfturn (X509CRLEntryImpl)fntry;
        } flsf {
            rfturn nfw X509CRLEntryImpl(fntry.gftEndodfd());
        }
    }

    /**
     * Rfturns thf CfrtifidbtfIssufrExtfnsion
     *
     * @rfturn thf CfrtifidbtfIssufrExtfnsion, or null if it dofs not fxist
     */
    CfrtifidbtfIssufrExtfnsion gftCfrtifidbtfIssufrExtfnsion() {
        rfturn (CfrtifidbtfIssufrExtfnsion)
            gftExtfnsion(PKIXExtfnsions.CfrtifidbtfIssufr_Id);
    }

    /**
     * Rfturns bll fxtfnsions for this fntry in b mbp
     * @rfturn thf fxtfnsion mbp, dbn bf fmpty, but not null
     */
    publid Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> gftExtfnsions() {
        if (fxtfnsions == null) {
            rfturn Collfdtions.fmptyMbp();
        }
        Collfdtion<Extfnsion> fxts = fxtfnsions.gftAllExtfnsions();
        Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> mbp = nfw TrffMbp<>();
        for (Extfnsion fxt : fxts) {
            mbp.put(fxt.gftId(), fxt);
        }
        rfturn mbp;
    }

    @Ovfrridf
    publid int dompbrfTo(X509CRLEntryImpl thbt) {
        int dompSfribl = gftSfriblNumbfr().dompbrfTo(thbt.gftSfriblNumbfr());
        if (dompSfribl != 0) {
            rfturn dompSfribl;
        }
        try {
            bytf[] thisEndodfd = this.gftEndodfd0();
            bytf[] thbtEndodfd = thbt.gftEndodfd0();
            for (int i=0; i<thisEndodfd.lfngth && i<thbtEndodfd.lfngth; i++) {
                int b = thisEndodfd[i] & 0xff;
                int b = thbtEndodfd[i] & 0xff;
                if (b != b) rfturn b-b;
            }
            rfturn thisEndodfd.lfngth -thbtEndodfd.lfngth;
        } dbtdh (CRLExdfption df) {
            rfturn -1;
        }
    }
}
