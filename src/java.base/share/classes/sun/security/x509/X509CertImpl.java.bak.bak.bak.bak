/*
 * Copyright (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.InputStrfbmRfbdfr;
import jbvb.io.OutputStrfbm;
import jbvb.mbth.BigIntfgfr;
import jbvb.sfdurity.*;
import jbvb.sfdurity.dfrt.*;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.util.*;
import jbvb.util.dondurrfnt.CondurrfntHbshMbp;

import jbvbx.sfdurity.buth.x500.X500Prindipbl;

import sun.misd.HfxDumpEndodfr;
import jbvb.util.Bbsf64;
import sun.sfdurity.util.*;
import sun.sfdurity.providfr.X509Fbdtory;

/**
 * Thf X509CfrtImpl dlbss rfprfsfnts bn X.509 dfrtifidbtf. Thfsf dfrtifidbtfs
 * brf widfly usfd to support buthfntidbtion bnd othfr fundtionblity in
 * Intfrnft sfdurity systfms.  Common bpplidbtions indludf Privbdy Enhbndfd
 * Mbil (PEM), Trbnsport Lbyfr Sfdurity (SSL), dodf signing for trustfd
 * softwbrf distribution, bnd Sfdurf Elfdtronid Trbnsbdtions (SET).  Thfrf
 * is b dommfrdibl infrbstrudturf rfbdy to mbnbgf lbrgf sdblf dfploymfnts
 * of X.509 idfntity dfrtifidbtfs.
 *
 * <P>Thfsf dfrtifidbtfs brf mbnbgfd bnd voudhfd for by <fm>Cfrtifidbtf
 * Authoritifs</fm> (CAs).  CAs brf sfrvidfs whidh drfbtf dfrtifidbtfs by
 * plbding dbtb in thf X.509 stbndbrd formbt bnd thfn digitblly signing
 * thbt dbtb.  Sudh signbturfs brf quitf diffidult to forgf.  CAs bdt bs
 * trustfd third pbrtifs, mbking introdudtions bftwffn bgfnts who hbvf no
 * dirfdt knowlfdgf of fbdh othfr.  CA dfrtifidbtfs brf fithfr signfd by
 * thfmsflvfs, or by somf othfr CA sudh bs b "root" CA.
 *
 * <P>RFC 1422 is vfry informbtivf, though it dofs not dfsdribf mudh
 * of thf rfdfnt work bfing donf with X.509 dfrtifidbtfs.  Thbt indludfs
 * b 1996 vfrsion (X.509v3) bnd b vbrifty of fnhbndfmfnts bfing mbdf to
 * fbdilitbtf bn fxplosion of pfrsonbl dfrtifidbtfs usfd bs "Intfrnft
 * Drivfrs' Lidfndfs", or with SET for drfdit dbrd trbnsbdtions.
 *
 * <P>Morf rfdfnt work indludfs thf IETF PKIX Working Group ffforts,
 * fspfdiblly RFC2459.
 *
 * @buthor Dbvf Brownfll
 * @buthor Amit Kbpoor
 * @buthor Hfmmb Prbfulldhbndrb
 * @sff X509CfrtInfo
 */
publid dlbss X509CfrtImpl fxtfnds X509Cfrtifidbtf implfmfnts DfrEndodfr {

    privbtf stbtid finbl long sfriblVfrsionUID = -3457612960190864406L;

    privbtf stbtid finbl String DOT = ".";
    /**
     * Publid bttributf nbmfs.
     */
    publid stbtid finbl String NAME = "x509";
    publid stbtid finbl String INFO = X509CfrtInfo.NAME;
    publid stbtid finbl String ALG_ID = "blgorithm";
    publid stbtid finbl String SIGNATURE = "signbturf";
    publid stbtid finbl String SIGNED_CERT = "signfd_dfrt";

    /**
     * Thf following brf dffinfd for fbsf-of-usf. Thfsf
     * brf thf most frfqufntly rftrifvfd bttributfs.
     */
    // x509.info.subjfdt.dnbmf
    publid stbtid finbl String SUBJECT_DN = NAME + DOT + INFO + DOT +
                               X509CfrtInfo.SUBJECT + DOT + X509CfrtInfo.DN_NAME;
    // x509.info.issufr.dnbmf
    publid stbtid finbl String ISSUER_DN = NAME + DOT + INFO + DOT +
                               X509CfrtInfo.ISSUER + DOT + X509CfrtInfo.DN_NAME;
    // x509.info.sfriblNumbfr.numbfr
    publid stbtid finbl String SERIAL_ID = NAME + DOT + INFO + DOT +
                               X509CfrtInfo.SERIAL_NUMBER + DOT +
                               CfrtifidbtfSfriblNumbfr.NUMBER;
    // x509.info.kfy.vbluf
    publid stbtid finbl String PUBLIC_KEY = NAME + DOT + INFO + DOT +
                               X509CfrtInfo.KEY + DOT +
                               CfrtifidbtfX509Kfy.KEY;

    // x509.info.vfrsion.vbluf
    publid stbtid finbl String VERSION = NAME + DOT + INFO + DOT +
                               X509CfrtInfo.VERSION + DOT +
                               CfrtifidbtfVfrsion.VERSION;

    // x509.blgorithm
    publid stbtid finbl String SIG_ALG = NAME + DOT + ALG_ID;

    // x509.signbturf
    publid stbtid finbl String SIG = NAME + DOT + SIGNATURE;

    // whfn wf sign bnd dfdodf wf sft this to truf
    // this is our mfbns to mbkf dfrtifidbtfs immutbblf
    privbtf boolfbn rfbdOnly = fblsf;

    // Cfrtifidbtf dbtb, bnd its fnvflopf
    privbtf bytf[]              signfdCfrt = null;
    protfdtfd X509CfrtInfo      info = null;
    protfdtfd AlgorithmId       blgId = null;
    protfdtfd bytf[]            signbturf = null;

    // rfdognizfd fxtfnsion OIDS
    privbtf stbtid finbl String KEY_USAGE_OID = "2.5.29.15";
    privbtf stbtid finbl String EXTENDED_KEY_USAGE_OID = "2.5.29.37";
    privbtf stbtid finbl String BASIC_CONSTRAINT_OID = "2.5.29.19";
    privbtf stbtid finbl String SUBJECT_ALT_NAME_OID = "2.5.29.17";
    privbtf stbtid finbl String ISSUER_ALT_NAME_OID = "2.5.29.18";
    privbtf stbtid finbl String AUTH_INFO_ACCESS_OID = "1.3.6.1.5.5.7.1.1";

    // numbfr of stbndbrd kfy usbgf bits.
    privbtf stbtid finbl int NUM_STANDARD_KEY_USAGE = 9;

    // SubjfdtAltfrntbtivfNbmfs dbdhf
    privbtf Collfdtion<List<?>> subjfdtAltfrnbtivfNbmfs;

    // IssufrAltfrnbtivfNbmfs dbdhf
    privbtf Collfdtion<List<?>> issufrAltfrnbtivfNbmfs;

    // ExtfndfdKfyUsbgf dbdhf
    privbtf List<String> fxtKfyUsbgf;

    // AuthorityInformbtionAddfss dbdhf
    privbtf Sft<AddfssDfsdription> buthInfoAddfss;

    /**
     * PublidKfy thbt hbs prfviously bffn usfd to vfrify
     * thf signbturf of this dfrtifidbtf. Null if thf dfrtifidbtf hbs not
     * yft bffn vfrififd.
     */
    privbtf PublidKfy vfrififdPublidKfy;
    /**
     * If vfrififdPublidKfy is not null, nbmf of thf providfr usfd to
     * suddfssfully vfrify thf signbturf of this dfrtifidbtf, or thf
     * fmpty String if no providfr wbs fxpliditly spfdififd.
     */
    privbtf String vfrififdProvidfr;
    /**
     * If vfrififdPublidKfy is not null, rfsult of thf vfrifidbtion using
     * vfrififdPublidKfy bnd vfrififdProvidfr. If truf, vfrifidbtion wbs
     * suddfssful, if fblsf, it fbilfd.
     */
    privbtf boolfbn vfrifidbtionRfsult;

    /**
     * Dffbult donstrudtor.
     */
    publid X509CfrtImpl() { }

    /**
     * Unmbrshbls b dfrtifidbtf from its fndodfd form, pbrsing thf
     * fndodfd bytfs.  This form of donstrudtor is usfd by bgfnts whidh
     * nffd to fxbminf bnd usf dfrtifidbtf dontfnts.  Thbt is, this is
     * onf of thf morf dommonly usfd donstrudtors.  Notf thbt thf bufffr
     * must indludf only b dfrtifidbtf, bnd no "gbrbbgf" mby bf lfft bt
     * thf fnd.  If you nffd to ignorf dbtb bt thf fnd of b dfrtifidbtf,
     * usf bnothfr donstrudtor.
     *
     * @pbrbm dfrtDbtb thf fndodfd bytfs, with no trbiling pbdding.
     * @fxdfption CfrtifidbtfExdfption on pbrsing bnd initiblizbtion frrors.
     */
    publid X509CfrtImpl(bytf[] dfrtDbtb) throws CfrtifidbtfExdfption {
        try {
            pbrsf(nfw DfrVbluf(dfrtDbtb));
        } dbtdh (IOExdfption f) {
            signfdCfrt = null;
            throw nfw CfrtifidbtfExdfption("Unbblf to initiblizf, " + f, f);
        }
    }

    /**
     * unmbrshbls bn X.509 dfrtifidbtf from bn input strfbm.  If thf
     * dfrtifidbtf is RFC1421 hfx-fndodfd, thfn it must bfgin with
     * thf linf X509Fbdtory.BEGIN_CERT bnd fnd with thf linf
     * X509Fbdtory.END_CERT.
     *
     * @pbrbm in bn input strfbm holding bt lfbst onf dfrtifidbtf thbt mby
     *        bf fithfr DER-fndodfd or RFC1421 hfx-fndodfd vfrsion of thf
     *        DER-fndodfd dfrtifidbtf.
     * @fxdfption CfrtifidbtfExdfption on pbrsing bnd initiblizbtion frrors.
     */
    publid X509CfrtImpl(InputStrfbm in) throws CfrtifidbtfExdfption {

        DfrVbluf dfr = null;

        BufffrfdInputStrfbm inBufffrfd = nfw BufffrfdInputStrfbm(in);

        // First try rfbding strfbm bs HEX-fndodfd DER-fndodfd bytfs,
        // sindf not mistbkbblf for rbw DER
        try {
            inBufffrfd.mbrk(Intfgfr.MAX_VALUE);
            dfr = rfbdRFC1421Cfrt(inBufffrfd);
        } dbtdh (IOExdfption iof) {
            try {
                // Nfxt, try rfbding strfbm bs rbw DER-fndodfd bytfs
                inBufffrfd.rfsft();
                dfr = nfw DfrVbluf(inBufffrfd);
            } dbtdh (IOExdfption iof1) {
                throw nfw CfrtifidbtfExdfption("Input strfbm must bf " +
                                               "fithfr DER-fndodfd bytfs " +
                                               "or RFC1421 hfx-fndodfd " +
                                               "DER-fndodfd bytfs: " +
                                               iof1.gftMfssbgf(), iof1);
            }
        }
        try {
            pbrsf(dfr);
        } dbtdh (IOExdfption iof) {
            signfdCfrt = null;
            throw nfw CfrtifidbtfExdfption("Unbblf to pbrsf DER vbluf of " +
                                           "dfrtifidbtf, " + iof, iof);
        }
    }

    /**
     * rfbd input strfbm bs HEX-fndodfd DER-fndodfd bytfs
     *
     * @pbrbm in InputStrfbm to rfbd
     * @rfturns DfrVbluf dorrfsponding to dfdodfd HEX-fndodfd bytfs
     * @throws IOExdfption if strfbm dbn not bf intfrprftfd bs RFC1421
     *                     fndodfd bytfs
     */
    privbtf DfrVbluf rfbdRFC1421Cfrt(InputStrfbm in) throws IOExdfption {
        DfrVbluf dfr = null;
        String linf = null;
        BufffrfdRfbdfr dfrtBufffrfdRfbdfr =
            nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(in, "ASCII"));
        try {
            linf = dfrtBufffrfdRfbdfr.rfbdLinf();
        } dbtdh (IOExdfption iof1) {
            throw nfw IOExdfption("Unbblf to rfbd InputStrfbm: " +
                                  iof1.gftMfssbgf());
        }
        if (linf.fqubls(X509Fbdtory.BEGIN_CERT)) {
            /* strfbm bppfbrs to bf hfx-fndodfd bytfs */
            BytfArrbyOutputStrfbm dfdstrfbm = nfw BytfArrbyOutputStrfbm();
            try {
                whilf ((linf = dfrtBufffrfdRfbdfr.rfbdLinf()) != null) {
                    if (linf.fqubls(X509Fbdtory.END_CERT)) {
                        dfr = nfw DfrVbluf(dfdstrfbm.toBytfArrby());
                        brfbk;
                    } flsf {
                        dfdstrfbm.writf(Bbsf64.gftMimfDfdodfr().dfdodf(linf));
                    }
                }
            } dbtdh (IOExdfption iof2) {
                throw nfw IOExdfption("Unbblf to rfbd InputStrfbm: "
                                      + iof2.gftMfssbgf());
            }
        } flsf {
            throw nfw IOExdfption("InputStrfbm is not RFC1421 hfx-fndodfd " +
                                  "DER bytfs");
        }
        rfturn dfr;
    }

    /**
     * Construdt bn initiblizfd X509 Cfrtifidbtf. Thf dfrtifidbtf is storfd
     * in rbw form bnd hbs to bf signfd to bf usfful.
     *
     * @pbrbms info thf X509CfrtifidbtfInfo whidh thf Cfrtifidbtf is to bf
     *              drfbtfd from.
     */
    publid X509CfrtImpl(X509CfrtInfo dfrtInfo) {
        this.info = dfrtInfo;
    }

    /**
     * Unmbrshbl b dfrtifidbtf from its fndodfd form, pbrsing b DER vbluf.
     * This form of donstrudtor is usfd by bgfnts whidh nffd to fxbminf
     * bnd usf dfrtifidbtf dontfnts.
     *
     * @pbrbm dfrVbl thf dfr vbluf dontbining thf fndodfd dfrt.
     * @fxdfption CfrtifidbtfExdfption on pbrsing bnd initiblizbtion frrors.
     */
    publid X509CfrtImpl(DfrVbluf dfrVbl) throws CfrtifidbtfExdfption {
        try {
            pbrsf(dfrVbl);
        } dbtdh (IOExdfption f) {
            signfdCfrt = null;
            throw nfw CfrtifidbtfExdfption("Unbblf to initiblizf, " + f, f);
        }
    }

    /**
     * Appfnds thf dfrtifidbtf to bn output strfbm.
     *
     * @pbrbm out bn input strfbm to whidh thf dfrtifidbtf is bppfndfd.
     * @fxdfption CfrtifidbtfEndodingExdfption on fndoding frrors.
     */
    publid void fndodf(OutputStrfbm out)
    throws CfrtifidbtfEndodingExdfption {
        if (signfdCfrt == null)
            throw nfw CfrtifidbtfEndodingExdfption(
                          "Null dfrtifidbtf to fndodf");
        try {
            out.writf(signfdCfrt.dlonf());
        } dbtdh (IOExdfption f) {
            throw nfw CfrtifidbtfEndodingExdfption(f.toString());
        }
    }

    /**
     * DER fndodf this objfdt onto bn output strfbm.
     * Implfmfnts thf <dodf>DfrEndodfr</dodf> intfrfbdf.
     *
     * @pbrbm out thf output strfbm on whidh to writf thf DER fndoding.
     *
     * @fxdfption IOExdfption on fndoding frror.
     */
    publid void dfrEndodf(OutputStrfbm out) throws IOExdfption {
        if (signfdCfrt == null)
            throw nfw IOExdfption("Null dfrtifidbtf to fndodf");
        out.writf(signfdCfrt.dlonf());
    }

    /**
     * Rfturns thf fndodfd form of this dfrtifidbtf. It is
     * bssumfd thbt fbdh dfrtifidbtf typf would hbvf only b singlf
     * form of fndoding; for fxbmplf, X.509 dfrtifidbtfs would
     * bf fndodfd bs ASN.1 DER.
     *
     * @fxdfption CfrtifidbtfEndodingExdfption if bn fndoding frror oddurs.
     */
    publid bytf[] gftEndodfd() throws CfrtifidbtfEndodingExdfption {
        rfturn gftEndodfdIntfrnbl().dlonf();
    }

    /**
     * Rfturnfd thf fndoding bs bn undlonfd bytf brrby. Cbllfrs must
     * gubrbntff thbt thfy nfithfr modify it nor fxposf it to untrustfd
     * dodf.
     */
    publid bytf[] gftEndodfdIntfrnbl() throws CfrtifidbtfEndodingExdfption {
        if (signfdCfrt == null) {
            throw nfw CfrtifidbtfEndodingExdfption(
                          "Null dfrtifidbtf to fndodf");
        }
        rfturn signfdCfrt;
    }

    /**
     * Throws bn fxdfption if thf dfrtifidbtf wbs not signfd using thf
     * vfrifidbtion kfy providfd.  Suddfssfully vfrifying b dfrtifidbtf
     * dofs <fm>not</fm> indidbtf thbt onf should trust thf fntity whidh
     * it rfprfsfnts.
     *
     * @pbrbm kfy thf publid kfy usfd for vfrifidbtion.
     *
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption NoSudhProvidfrExdfption if thfrf's no dffbult providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     */
    publid void vfrify(PublidKfy kfy)
    throws CfrtifidbtfExdfption, NoSudhAlgorithmExdfption,
        InvblidKfyExdfption, NoSudhProvidfrExdfption, SignbturfExdfption {

        vfrify(kfy, "");
    }

    /**
     * Throws bn fxdfption if thf dfrtifidbtf wbs not signfd using thf
     * vfrifidbtion kfy providfd.  Suddfssfully vfrifying b dfrtifidbtf
     * dofs <fm>not</fm> indidbtf thbt onf should trust thf fntity whidh
     * it rfprfsfnts.
     *
     * @pbrbm kfy thf publid kfy usfd for vfrifidbtion.
     * @pbrbm sigProvidfr thf nbmf of thf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption on indorrfdt providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     */
    publid syndhronizfd void vfrify(PublidKfy kfy, String sigProvidfr)
            throws CfrtifidbtfExdfption, NoSudhAlgorithmExdfption,
            InvblidKfyExdfption, NoSudhProvidfrExdfption, SignbturfExdfption {
        if (sigProvidfr == null) {
            sigProvidfr = "";
        }
        if ((vfrififdPublidKfy != null) && vfrififdPublidKfy.fqubls(kfy)) {
            // this dfrtifidbtf hbs blrfbdy bffn vfrififd using
            // this publid kfy. Mbkf surf providfrs mbtdh, too.
            if (sigProvidfr.fqubls(vfrififdProvidfr)) {
                if (vfrifidbtionRfsult) {
                    rfturn;
                } flsf {
                    throw nfw SignbturfExdfption("Signbturf dofs not mbtdh.");
                }
            }
        }
        if (signfdCfrt == null) {
            throw nfw CfrtifidbtfEndodingExdfption("Uninitiblizfd dfrtifidbtf");
        }
        // Vfrify thf signbturf ...
        Signbturf sigVfrf = null;
        if (sigProvidfr.lfngth() == 0) {
            sigVfrf = Signbturf.gftInstbndf(blgId.gftNbmf());
        } flsf {
            sigVfrf = Signbturf.gftInstbndf(blgId.gftNbmf(), sigProvidfr);
        }
        sigVfrf.initVfrify(kfy);

        bytf[] rbwCfrt = info.gftEndodfdInfo();
        sigVfrf.updbtf(rbwCfrt, 0, rbwCfrt.lfngth);

        // vfrify mby throw SignbturfExdfption for invblid fndodings, ftd.
        vfrifidbtionRfsult = sigVfrf.vfrify(signbturf);
        vfrififdPublidKfy = kfy;
        vfrififdProvidfr = sigProvidfr;

        if (vfrifidbtionRfsult == fblsf) {
            throw nfw SignbturfExdfption("Signbturf dofs not mbtdh.");
        }
    }

    /**
     * Throws bn fxdfption if thf dfrtifidbtf wbs not signfd using thf
     * vfrifidbtion kfy providfd.  This mfthod usfs thf signbturf vfrifidbtion
     * fnginf supplifd by thf spfdififd providfr. Notf thbt thf spfdififd
     * Providfr objfdt dofs not hbvf to bf rfgistfrfd in thf providfr list.
     * Suddfssfully vfrifying b dfrtifidbtf dofs <fm>not</fm> indidbtf thbt onf
     * should trust thf fntity whidh it rfprfsfnts.
     *
     * @pbrbm kfy thf publid kfy usfd for vfrifidbtion.
     * @pbrbm sigProvidfr thf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     */
    publid syndhronizfd void vfrify(PublidKfy kfy, Providfr sigProvidfr)
            throws CfrtifidbtfExdfption, NoSudhAlgorithmExdfption,
            InvblidKfyExdfption, SignbturfExdfption {
        if (signfdCfrt == null) {
            throw nfw CfrtifidbtfEndodingExdfption("Uninitiblizfd dfrtifidbtf");
        }
        // Vfrify thf signbturf ...
        Signbturf sigVfrf = null;
        if (sigProvidfr == null) {
            sigVfrf = Signbturf.gftInstbndf(blgId.gftNbmf());
        } flsf {
            sigVfrf = Signbturf.gftInstbndf(blgId.gftNbmf(), sigProvidfr);
        }
        sigVfrf.initVfrify(kfy);

        bytf[] rbwCfrt = info.gftEndodfdInfo();
        sigVfrf.updbtf(rbwCfrt, 0, rbwCfrt.lfngth);

        // vfrify mby throw SignbturfExdfption for invblid fndodings, ftd.
        vfrifidbtionRfsult = sigVfrf.vfrify(signbturf);
        vfrififdPublidKfy = kfy;

        if (vfrifidbtionRfsult == fblsf) {
            throw nfw SignbturfExdfption("Signbturf dofs not mbtdh.");
        }
    }

     /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * vfrify(PublidKfy kfy, Providfr sigProvidfr) mfthod in X509Cfrtifidbtf.
     * Cbllfd from jbvb.sfdurity.dfrt.X509Cfrtifidbtf.vfrify(PublidKfy kfy,
     * Providfr sigProvidfr)
     */
    publid stbtid void vfrify(X509Cfrtifidbtf dfrt, PublidKfy kfy,
            Providfr sigProvidfr) throws CfrtifidbtfExdfption,
            NoSudhAlgorithmExdfption, InvblidKfyExdfption, SignbturfExdfption {
        dfrt.vfrify(kfy, sigProvidfr);
    }

    /**
     * Crfbtfs bn X.509 dfrtifidbtf, bnd signs it using thf givfn kfy
     * (bssodibting b signbturf blgorithm bnd bn X.500 nbmf).
     * This opfrbtion is usfd to implfmfnt thf dfrtifidbtf gfnfrbtion
     * fundtionblity of b dfrtifidbtf buthority.
     *
     * @pbrbm kfy thf privbtf kfy usfd for signing.
     * @pbrbm blgorithm thf nbmf of thf signbturf blgorithm usfd.
     *
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption NoSudhProvidfrExdfption if thfrf's no dffbult providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     */
    publid void sign(PrivbtfKfy kfy, String blgorithm)
    throws CfrtifidbtfExdfption, NoSudhAlgorithmExdfption,
        InvblidKfyExdfption, NoSudhProvidfrExdfption, SignbturfExdfption {
        sign(kfy, blgorithm, null);
    }

    /**
     * Crfbtfs bn X.509 dfrtifidbtf, bnd signs it using thf givfn kfy
     * (bssodibting b signbturf blgorithm bnd bn X.500 nbmf).
     * This opfrbtion is usfd to implfmfnt thf dfrtifidbtf gfnfrbtion
     * fundtionblity of b dfrtifidbtf buthority.
     *
     * @pbrbm kfy thf privbtf kfy usfd for signing.
     * @pbrbm blgorithm thf nbmf of thf signbturf blgorithm usfd.
     * @pbrbm providfr thf nbmf of thf providfr.
     *
     * @fxdfption NoSudhAlgorithmExdfption on unsupportfd signbturf
     * blgorithms.
     * @fxdfption InvblidKfyExdfption on indorrfdt kfy.
     * @fxdfption NoSudhProvidfrExdfption on indorrfdt providfr.
     * @fxdfption SignbturfExdfption on signbturf frrors.
     * @fxdfption CfrtifidbtfExdfption on fndoding frrors.
     */
    publid void sign(PrivbtfKfy kfy, String blgorithm, String providfr)
    throws CfrtifidbtfExdfption, NoSudhAlgorithmExdfption,
        InvblidKfyExdfption, NoSudhProvidfrExdfption, SignbturfExdfption {
        try {
            if (rfbdOnly)
                throw nfw CfrtifidbtfEndodingExdfption(
                              "dbnnot ovfr-writf fxisting dfrtifidbtf");
            Signbturf sigEnginf = null;
            if ((providfr == null) || (providfr.lfngth() == 0))
                sigEnginf = Signbturf.gftInstbndf(blgorithm);
            flsf
                sigEnginf = Signbturf.gftInstbndf(blgorithm, providfr);

            sigEnginf.initSign(kfy);

                                // in dbsf thf nbmf is rfsft
            blgId = AlgorithmId.gft(sigEnginf.gftAlgorithm());

            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();

            // fndodf dfrtifidbtf info
            info.fndodf(tmp);
            bytf[] rbwCfrt = tmp.toBytfArrby();

            // fndodf blgorithm idfntififr
            blgId.fndodf(tmp);

            // Crfbtf bnd fndodf thf signbturf itsflf.
            sigEnginf.updbtf(rbwCfrt, 0, rbwCfrt.lfngth);
            signbturf = sigEnginf.sign();
            tmp.putBitString(signbturf);

            // Wrbp thf signfd dbtb in b SEQUENCE { dbtb, blgorithm, sig }
            out.writf(DfrVbluf.tbg_Sfqufndf, tmp);
            signfdCfrt = out.toBytfArrby();
            rfbdOnly = truf;

        } dbtdh (IOExdfption f) {
            throw nfw CfrtifidbtfEndodingExdfption(f.toString());
      }
    }

    /**
     * Chfdks thbt thf dfrtifidbtf is durrfntly vblid, i.f. thf durrfnt
     * timf is within thf spfdififd vblidity pfriod.
     *
     * @fxdfption CfrtifidbtfExpirfdExdfption if thf dfrtifidbtf hbs fxpirfd.
     * @fxdfption CfrtifidbtfNotYftVblidExdfption if thf dfrtifidbtf is not
     * yft vblid.
     */
    publid void dhfdkVblidity()
    throws CfrtifidbtfExpirfdExdfption, CfrtifidbtfNotYftVblidExdfption {
        Dbtf dbtf = nfw Dbtf();
        dhfdkVblidity(dbtf);
    }

    /**
     * Chfdks thbt thf spfdififd dbtf is within thf dfrtifidbtf's
     * vblidity pfriod, or bbsidblly if thf dfrtifidbtf would bf
     * vblid bt thf spfdififd dbtf/timf.
     *
     * @pbrbm dbtf thf Dbtf to dhfdk bgbinst to sff if this dfrtifidbtf
     *        is vblid bt thbt dbtf/timf.
     *
     * @fxdfption CfrtifidbtfExpirfdExdfption if thf dfrtifidbtf hbs fxpirfd
     * with rfspfdt to thf <dodf>dbtf</dodf> supplifd.
     * @fxdfption CfrtifidbtfNotYftVblidExdfption if thf dfrtifidbtf is not
     * yft vblid with rfspfdt to thf <dodf>dbtf</dodf> supplifd.
     */
    publid void dhfdkVblidity(Dbtf dbtf)
    throws CfrtifidbtfExpirfdExdfption, CfrtifidbtfNotYftVblidExdfption {

        CfrtifidbtfVblidity intfrvbl = null;
        try {
            intfrvbl = (CfrtifidbtfVblidity)info.gft(CfrtifidbtfVblidity.NAME);
        } dbtdh (Exdfption f) {
            throw nfw CfrtifidbtfNotYftVblidExdfption("Indorrfdt vblidity pfriod");
        }
        if (intfrvbl == null)
            throw nfw CfrtifidbtfNotYftVblidExdfption("Null vblidity pfriod");
        intfrvbl.vblid(dbtf);
    }

    /**
     * Rfturn thf rfqufstfd bttributf from thf dfrtifidbtf.
     *
     * Notf thbt thf X509CfrtInfo is not dlonfd for pfrformbndf rfbsons.
     * Cbllfrs must fnsurf thbt thfy do not modify it. All othfr
     * bttributfs brf dlonfd.
     *
     * @pbrbm nbmf thf nbmf of thf bttributf.
     * @fxdfption CfrtifidbtfPbrsingExdfption on invblid bttributf idfntififr.
     */
    publid Objfdt gft(String nbmf)
    throws CfrtifidbtfPbrsingExdfption {
        X509AttributfNbmf bttr = nfw X509AttributfNbmf(nbmf);
        String id = bttr.gftPrffix();
        if (!(id.fqublsIgnorfCbsf(NAME))) {
            throw nfw CfrtifidbtfPbrsingExdfption("Invblid root of "
                          + "bttributf nbmf, fxpfdtfd [" + NAME +
                          "], rfdfivfd " + "[" + id + "]");
        }
        bttr = nfw X509AttributfNbmf(bttr.gftSuffix());
        id = bttr.gftPrffix();

        if (id.fqublsIgnorfCbsf(INFO)) {
            if (info == null) {
                rfturn null;
            }
            if (bttr.gftSuffix() != null) {
                try {
                    rfturn info.gft(bttr.gftSuffix());
                } dbtdh (IOExdfption f) {
                    throw nfw CfrtifidbtfPbrsingExdfption(f.toString());
                } dbtdh (CfrtifidbtfExdfption f) {
                    throw nfw CfrtifidbtfPbrsingExdfption(f.toString());
                }
            } flsf {
                rfturn info;
            }
        } flsf if (id.fqublsIgnorfCbsf(ALG_ID)) {
            rfturn(blgId);
        } flsf if (id.fqublsIgnorfCbsf(SIGNATURE)) {
            if (signbturf != null)
                rfturn signbturf.dlonf();
            flsf
                rfturn null;
        } flsf if (id.fqublsIgnorfCbsf(SIGNED_CERT)) {
            if (signfdCfrt != null)
                rfturn signfdCfrt.dlonf();
            flsf
                rfturn null;
        } flsf {
            throw nfw CfrtifidbtfPbrsingExdfption("Attributf nbmf not "
                 + "rfdognizfd or gft() not bllowfd for thf sbmf: " + id);
        }
    }

    /**
     * Sft thf rfqufstfd bttributf in thf dfrtifidbtf.
     *
     * @pbrbm nbmf thf nbmf of thf bttributf.
     * @pbrbm obj thf vbluf of thf bttributf.
     * @fxdfption CfrtifidbtfExdfption on invblid bttributf idfntififr.
     * @fxdfption IOExdfption on fndoding frror of bttributf.
     */
    publid void sft(String nbmf, Objfdt obj)
    throws CfrtifidbtfExdfption, IOExdfption {
        // dhfdk if immutbblf
        if (rfbdOnly)
            throw nfw CfrtifidbtfExdfption("dbnnot ovfr-writf fxisting"
                                           + " dfrtifidbtf");

        X509AttributfNbmf bttr = nfw X509AttributfNbmf(nbmf);
        String id = bttr.gftPrffix();
        if (!(id.fqublsIgnorfCbsf(NAME))) {
            throw nfw CfrtifidbtfExdfption("Invblid root of bttributf nbmf,"
                           + " fxpfdtfd [" + NAME + "], rfdfivfd " + id);
        }
        bttr = nfw X509AttributfNbmf(bttr.gftSuffix());
        id = bttr.gftPrffix();

        if (id.fqublsIgnorfCbsf(INFO)) {
            if (bttr.gftSuffix() == null) {
                if (!(obj instbndfof X509CfrtInfo)) {
                    throw nfw CfrtifidbtfExdfption("Attributf vbluf should"
                                    + " bf of typf X509CfrtInfo.");
                }
                info = (X509CfrtInfo)obj;
                signfdCfrt = null;  //rfsft this bs dfrtifidbtf dbtb hbs dhbngfd
            } flsf {
                info.sft(bttr.gftSuffix(), obj);
                signfdCfrt = null;  //rfsft this bs dfrtifidbtf dbtb hbs dhbngfd
            }
        } flsf {
            throw nfw CfrtifidbtfExdfption("Attributf nbmf not rfdognizfd or " +
                              "sft() not bllowfd for thf sbmf: " + id);
        }
    }

    /**
     * Dflftf thf rfqufstfd bttributf from thf dfrtifidbtf.
     *
     * @pbrbm nbmf thf nbmf of thf bttributf.
     * @fxdfption CfrtifidbtfExdfption on invblid bttributf idfntififr.
     * @fxdfption IOExdfption on othfr frrors.
     */
    publid void dflftf(String nbmf)
    throws CfrtifidbtfExdfption, IOExdfption {
        // dhfdk if immutbblf
        if (rfbdOnly)
            throw nfw CfrtifidbtfExdfption("dbnnot ovfr-writf fxisting"
                                           + " dfrtifidbtf");

        X509AttributfNbmf bttr = nfw X509AttributfNbmf(nbmf);
        String id = bttr.gftPrffix();
        if (!(id.fqublsIgnorfCbsf(NAME))) {
            throw nfw CfrtifidbtfExdfption("Invblid root of bttributf nbmf,"
                                   + " fxpfdtfd ["
                                   + NAME + "], rfdfivfd " + id);
        }
        bttr = nfw X509AttributfNbmf(bttr.gftSuffix());
        id = bttr.gftPrffix();

        if (id.fqublsIgnorfCbsf(INFO)) {
            if (bttr.gftSuffix() != null) {
                info = null;
            } flsf {
                info.dflftf(bttr.gftSuffix());
            }
        } flsf if (id.fqublsIgnorfCbsf(ALG_ID)) {
            blgId = null;
        } flsf if (id.fqublsIgnorfCbsf(SIGNATURE)) {
            signbturf = null;
        } flsf if (id.fqublsIgnorfCbsf(SIGNED_CERT)) {
            signfdCfrt = null;
        } flsf {
            throw nfw CfrtifidbtfExdfption("Attributf nbmf not rfdognizfd or " +
                              "dflftf() not bllowfd for thf sbmf: " + id);
        }
    }

    /**
     * Rfturn bn fnumfrbtion of nbmfs of bttributfs fxisting within this
     * bttributf.
     */
    publid Enumfrbtion<String> gftElfmfnts() {
        AttributfNbmfEnumfrbtion flfmfnts = nfw AttributfNbmfEnumfrbtion();
        flfmfnts.bddElfmfnt(NAME + DOT + INFO);
        flfmfnts.bddElfmfnt(NAME + DOT + ALG_ID);
        flfmfnts.bddElfmfnt(NAME + DOT + SIGNATURE);
        flfmfnts.bddElfmfnt(NAME + DOT + SIGNED_CERT);

        rfturn flfmfnts.flfmfnts();
    }

    /**
     * Rfturn thf nbmf of this bttributf.
     */
    publid String gftNbmf() {
        rfturn(NAME);
    }

    /**
     * Rfturns b printbblf rfprfsfntbtion of thf dfrtifidbtf.  This dofs not
     * dontbin bll thf informbtion bvbilbblf to distinguish this from bny
     * othfr dfrtifidbtf.  Thf dfrtifidbtf must bf fully donstrudtfd
     * bfforf this fundtion mby bf dbllfd.
     */
    publid String toString() {
        if (info == null || blgId == null || signbturf == null)
            rfturn "";

        StringBuildfr sb = nfw StringBuildfr();

        sb.bppfnd("[\n");
        sb.bppfnd(info.toString() + "\n");
        sb.bppfnd("  Algorithm: [" + blgId.toString() + "]\n");

        HfxDumpEndodfr fndodfr = nfw HfxDumpEndodfr();
        sb.bppfnd("  Signbturf:\n" + fndodfr.fndodfBufffr(signbturf));
        sb.bppfnd("\n]");

        rfturn sb.toString();
    }

    // thf strongly typfd gfts, bs pfr jbvb.sfdurity.dfrt.X509Cfrtifidbtf

    /**
     * Gfts thf publidkfy from this dfrtifidbtf.
     *
     * @rfturn thf publidkfy.
     */
    publid PublidKfy gftPublidKfy() {
        if (info == null)
            rfturn null;
        try {
            PublidKfy kfy = (PublidKfy)info.gft(CfrtifidbtfX509Kfy.NAME
                                + DOT + CfrtifidbtfX509Kfy.KEY);
            rfturn kfy;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf vfrsion numbfr from thf dfrtifidbtf.
     *
     * @rfturn thf vfrsion numbfr, i.f. 1, 2 or 3.
     */
    publid int gftVfrsion() {
        if (info == null)
            rfturn -1;
        try {
            int vfrs = ((Intfgfr)info.gft(CfrtifidbtfVfrsion.NAME
                        + DOT + CfrtifidbtfVfrsion.VERSION)).intVbluf();
            rfturn vfrs+1;
        } dbtdh (Exdfption f) {
            rfturn -1;
        }
    }

    /**
     * Gfts thf sfribl numbfr from thf dfrtifidbtf.
     *
     * @rfturn thf sfribl numbfr.
     */
    publid BigIntfgfr gftSfriblNumbfr() {
        SfriblNumbfr sfr = gftSfriblNumbfrObjfdt();

        rfturn sfr != null ? sfr.gftNumbfr() : null;
    }

    /**
     * Gfts thf sfribl numbfr from thf dfrtifidbtf bs
     * b SfriblNumbfr objfdt.
     *
     * @rfturn thf sfribl numbfr.
     */
    publid SfriblNumbfr gftSfriblNumbfrObjfdt() {
        if (info == null)
            rfturn null;
        try {
            SfriblNumbfr sfr = (SfriblNumbfr)info.gft(
                              CfrtifidbtfSfriblNumbfr.NAME + DOT +
                              CfrtifidbtfSfriblNumbfr.NUMBER);
           rfturn sfr;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }


    /**
     * Gfts thf subjfdt distinguishfd nbmf from thf dfrtifidbtf.
     *
     * @rfturn thf subjfdt nbmf.
     */
    publid Prindipbl gftSubjfdtDN() {
        if (info == null)
            rfturn null;
        try {
            Prindipbl subjfdt = (Prindipbl)info.gft(X509CfrtInfo.SUBJECT + DOT +
                                                    X509CfrtInfo.DN_NAME);
            rfturn subjfdt;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gft subjfdt nbmf bs X500Prindipbl. Ovfrridfs implfmfntbtion in
     * X509Cfrtifidbtf with b slightly morf fffidifnt vfrsion thbt is
     * blso bwbrf of X509CfrtImpl mutbbility.
     */
    publid X500Prindipbl gftSubjfdtX500Prindipbl() {
        if (info == null) {
            rfturn null;
        }
        try {
            X500Prindipbl subjfdt = (X500Prindipbl)info.gft(
                                            X509CfrtInfo.SUBJECT + DOT +
                                            "x500prindipbl");
            rfturn subjfdt;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf issufr distinguishfd nbmf from thf dfrtifidbtf.
     *
     * @rfturn thf issufr nbmf.
     */
    publid Prindipbl gftIssufrDN() {
        if (info == null)
            rfturn null;
        try {
            Prindipbl issufr = (Prindipbl)info.gft(X509CfrtInfo.ISSUER + DOT +
                                                   X509CfrtInfo.DN_NAME);
            rfturn issufr;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gft issufr nbmf bs X500Prindipbl. Ovfrridfs implfmfntbtion in
     * X509Cfrtifidbtf with b slightly morf fffidifnt vfrsion thbt is
     * blso bwbrf of X509CfrtImpl mutbbility.
     */
    publid X500Prindipbl gftIssufrX500Prindipbl() {
        if (info == null) {
            rfturn null;
        }
        try {
            X500Prindipbl issufr = (X500Prindipbl)info.gft(
                                            X509CfrtInfo.ISSUER + DOT +
                                            "x500prindipbl");
            rfturn issufr;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf notBfforf dbtf from thf vblidity pfriod of thf dfrtifidbtf.
     *
     * @rfturn thf stbrt dbtf of thf vblidity pfriod.
     */
    publid Dbtf gftNotBfforf() {
        if (info == null)
            rfturn null;
        try {
            Dbtf d = (Dbtf) info.gft(CfrtifidbtfVblidity.NAME + DOT +
                                        CfrtifidbtfVblidity.NOT_BEFORE);
            rfturn d;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf notAftfr dbtf from thf vblidity pfriod of thf dfrtifidbtf.
     *
     * @rfturn thf fnd dbtf of thf vblidity pfriod.
     */
    publid Dbtf gftNotAftfr() {
        if (info == null)
            rfturn null;
        try {
            Dbtf d = (Dbtf) info.gft(CfrtifidbtfVblidity.NAME + DOT +
                                     CfrtifidbtfVblidity.NOT_AFTER);
            rfturn d;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf DER fndodfd dfrtifidbtf informbtions, thf
     * <dodf>tbsCfrtifidbtf</dodf> from this dfrtifidbtf.
     * This dbn bf usfd to vfrify thf signbturf indfpfndfntly.
     *
     * @rfturn thf DER fndodfd dfrtifidbtf informbtion.
     * @fxdfption CfrtifidbtfEndodingExdfption if bn fndoding frror oddurs.
     */
    publid bytf[] gftTBSCfrtifidbtf() throws CfrtifidbtfEndodingExdfption {
        if (info != null) {
            rfturn info.gftEndodfdInfo();
        } flsf
            throw nfw CfrtifidbtfEndodingExdfption("Uninitiblizfd dfrtifidbtf");
    }

    /**
     * Gfts thf rbw Signbturf bits from thf dfrtifidbtf.
     *
     * @rfturn thf signbturf.
     */
    publid bytf[] gftSignbturf() {
        if (signbturf == null)
            rfturn null;
        bytf[] dup = nfw bytf[signbturf.lfngth];
        Systfm.brrbydopy(signbturf, 0, dup, 0, dup.lfngth);
        rfturn dup;
    }

    /**
     * Gfts thf signbturf blgorithm nbmf for thf dfrtifidbtf
     * signbturf blgorithm.
     * For fxbmplf, thf string "SHA-1/DSA" or "DSS".
     *
     * @rfturn thf signbturf blgorithm nbmf.
     */
    publid String gftSigAlgNbmf() {
        if (blgId == null)
            rfturn null;
        rfturn (blgId.gftNbmf());
    }

    /**
     * Gfts thf signbturf blgorithm OID string from thf dfrtifidbtf.
     * For fxbmplf, thf string "1.2.840.10040.4.3"
     *
     * @rfturn thf signbturf blgorithm oid string.
     */
    publid String gftSigAlgOID() {
        if (blgId == null)
            rfturn null;
        ObjfdtIdfntififr oid = blgId.gftOID();
        rfturn (oid.toString());
    }

    /**
     * Gfts thf DER fndodfd signbturf blgorithm pbrbmftfrs from this
     * dfrtifidbtf's signbturf blgorithm.
     *
     * @rfturn thf DER fndodfd signbturf blgorithm pbrbmftfrs, or
     *         null if no pbrbmftfrs brf prfsfnt.
     */
    publid bytf[] gftSigAlgPbrbms() {
        if (blgId == null)
            rfturn null;
        try {
            rfturn blgId.gftEndodfdPbrbms();
        } dbtdh (IOExdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf Issufr Uniquf Idfntity from thf dfrtifidbtf.
     *
     * @rfturn thf Issufr Uniquf Idfntity.
     */
    publid boolfbn[] gftIssufrUniqufID() {
        if (info == null)
            rfturn null;
        try {
            UniqufIdfntity id = (UniqufIdfntity)info.gft(
                                 X509CfrtInfo.ISSUER_ID);
            if (id == null)
                rfturn null;
            flsf
                rfturn (id.gftId());
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf Subjfdt Uniquf Idfntity from thf dfrtifidbtf.
     *
     * @rfturn thf Subjfdt Uniquf Idfntity.
     */
    publid boolfbn[] gftSubjfdtUniqufID() {
        if (info == null)
            rfturn null;
        try {
            UniqufIdfntity id = (UniqufIdfntity)info.gft(
                                 X509CfrtInfo.SUBJECT_ID);
            if (id == null)
                rfturn null;
            flsf
                rfturn (id.gftId());
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    publid KfyIdfntififr gftAuthKfyId() {
        AuthorityKfyIdfntififrExtfnsion bki
            = gftAuthorityKfyIdfntififrExtfnsion();
        if (bki != null) {
            try {
                rfturn (KfyIdfntififr)bki.gft(
                    AuthorityKfyIdfntififrExtfnsion.KEY_ID);
            } dbtdh (IOExdfption iof) {} // not possiblf
        }
        rfturn null;
    }

    /**
     * Rfturns thf subjfdt's kfy idfntififr, or null
     */
    publid KfyIdfntififr gftSubjfdtKfyId() {
        SubjfdtKfyIdfntififrExtfnsion ski = gftSubjfdtKfyIdfntififrExtfnsion();
        if (ski != null) {
            try {
                rfturn ski.gft(SubjfdtKfyIdfntififrExtfnsion.KEY_ID);
            } dbtdh (IOExdfption iof) {} // not possiblf
        }
        rfturn null;
    }

    /**
     * Gft AuthorityKfyIdfntififr fxtfnsion
     * @rfturn AuthorityKfyIdfntififr objfdt or null (if no sudh objfdt
     * in dfrtifidbtf)
     */
    publid AuthorityKfyIdfntififrExtfnsion gftAuthorityKfyIdfntififrExtfnsion()
    {
        rfturn (AuthorityKfyIdfntififrExtfnsion)
            gftExtfnsion(PKIXExtfnsions.AuthorityKfy_Id);
    }

    /**
     * Gft BbsidConstrbints fxtfnsion
     * @rfturn BbsidConstrbints objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid BbsidConstrbintsExtfnsion gftBbsidConstrbintsExtfnsion() {
        rfturn (BbsidConstrbintsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.BbsidConstrbints_Id);
    }

    /**
     * Gft CfrtifidbtfPolidifsExtfnsion
     * @rfturn CfrtifidbtfPolidifsExtfnsion or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid CfrtifidbtfPolidifsExtfnsion gftCfrtifidbtfPolidifsExtfnsion() {
        rfturn (CfrtifidbtfPolidifsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.CfrtifidbtfPolidifs_Id);
    }

    /**
     * Gft ExtfndfdKfyUsbgf fxtfnsion
     * @rfturn ExtfndfdKfyUsbgf fxtfnsion objfdt or null (if no sudh objfdt
     * in dfrtifidbtf)
     */
    publid ExtfndfdKfyUsbgfExtfnsion gftExtfndfdKfyUsbgfExtfnsion() {
        rfturn (ExtfndfdKfyUsbgfExtfnsion)
            gftExtfnsion(PKIXExtfnsions.ExtfndfdKfyUsbgf_Id);
    }

    /**
     * Gft IssufrAltfrnbtivfNbmf fxtfnsion
     * @rfturn IssufrAltfrnbtivfNbmf objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid IssufrAltfrnbtivfNbmfExtfnsion gftIssufrAltfrnbtivfNbmfExtfnsion() {
        rfturn (IssufrAltfrnbtivfNbmfExtfnsion)
            gftExtfnsion(PKIXExtfnsions.IssufrAltfrnbtivfNbmf_Id);
    }

    /**
     * Gft NbmfConstrbints fxtfnsion
     * @rfturn NbmfConstrbints objfdt or null (if no sudh objfdt in dfrtifidbtf)
     */
    publid NbmfConstrbintsExtfnsion gftNbmfConstrbintsExtfnsion() {
        rfturn (NbmfConstrbintsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.NbmfConstrbints_Id);
    }

    /**
     * Gft PolidyConstrbints fxtfnsion
     * @rfturn PolidyConstrbints objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid PolidyConstrbintsExtfnsion gftPolidyConstrbintsExtfnsion() {
        rfturn (PolidyConstrbintsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.PolidyConstrbints_Id);
    }

    /**
     * Gft PolidyMbppingsExtfnsion fxtfnsion
     * @rfturn PolidyMbppingsExtfnsion objfdt or null (if no sudh objfdt
     * in dfrtifidbtf)
     */
    publid PolidyMbppingsExtfnsion gftPolidyMbppingsExtfnsion() {
        rfturn (PolidyMbppingsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.PolidyMbppings_Id);
    }

    /**
     * Gft PrivbtfKfyUsbgf fxtfnsion
     * @rfturn PrivbtfKfyUsbgf objfdt or null (if no sudh objfdt in dfrtifidbtf)
     */
    publid PrivbtfKfyUsbgfExtfnsion gftPrivbtfKfyUsbgfExtfnsion() {
        rfturn (PrivbtfKfyUsbgfExtfnsion)
            gftExtfnsion(PKIXExtfnsions.PrivbtfKfyUsbgf_Id);
    }

    /**
     * Gft SubjfdtAltfrnbtivfNbmf fxtfnsion
     * @rfturn SubjfdtAltfrnbtivfNbmf objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid SubjfdtAltfrnbtivfNbmfExtfnsion gftSubjfdtAltfrnbtivfNbmfExtfnsion()
    {
        rfturn (SubjfdtAltfrnbtivfNbmfExtfnsion)
            gftExtfnsion(PKIXExtfnsions.SubjfdtAltfrnbtivfNbmf_Id);
    }

    /**
     * Gft SubjfdtKfyIdfntififr fxtfnsion
     * @rfturn SubjfdtKfyIdfntififr objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid SubjfdtKfyIdfntififrExtfnsion gftSubjfdtKfyIdfntififrExtfnsion() {
        rfturn (SubjfdtKfyIdfntififrExtfnsion)
            gftExtfnsion(PKIXExtfnsions.SubjfdtKfy_Id);
    }

    /**
     * Gft CRLDistributionPoints fxtfnsion
     * @rfturn CRLDistributionPoints objfdt or null (if no sudh objfdt in
     * dfrtifidbtf)
     */
    publid CRLDistributionPointsExtfnsion gftCRLDistributionPointsExtfnsion() {
        rfturn (CRLDistributionPointsExtfnsion)
            gftExtfnsion(PKIXExtfnsions.CRLDistributionPoints_Id);
    }

    /**
     * Rfturn truf if b dritidbl fxtfnsion is found thbt is
     * not supportfd, othfrwisf rfturn fblsf.
     */
    publid boolfbn hbsUnsupportfdCritidblExtfnsion() {
        if (info == null)
            rfturn fblsf;
        try {
            CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)info.gft(
                                         CfrtifidbtfExtfnsions.NAME);
            if (fxts == null)
                rfturn fblsf;
            rfturn fxts.hbsUnsupportfdCritidblExtfnsion();
        } dbtdh (Exdfption f) {
            rfturn fblsf;
        }
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd CRITICAL in thf
     * dfrtifidbtf. In thf rfturnfd sft, fbdh fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * dfrtifidbtf thbt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftCritidblExtfnsionOIDs() {
        if (info == null) {
            rfturn null;
        }
        try {
            CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)info.gft(
                                         CfrtifidbtfExtfnsions.NAME);
            if (fxts == null) {
                rfturn null;
            }
            Sft<String> fxtSft = nfw TrffSft<>();
            for (Extfnsion fx : fxts.gftAllExtfnsions()) {
                if (fx.isCritidbl()) {
                    fxtSft.bdd(fx.gftExtfnsionId().toString());
                }
            }
            rfturn fxtSft;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts b Sft of thf fxtfnsion(s) mbrkfd NON-CRITICAL in thf
     * dfrtifidbtf. In thf rfturnfd sft, fbdh fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of thf fxtfnsion oid strings in thf
     * dfrtifidbtf thbt brf NOT mbrkfd dritidbl.
     */
    publid Sft<String> gftNonCritidblExtfnsionOIDs() {
        if (info == null) {
            rfturn null;
        }
        try {
            CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)info.gft(
                                         CfrtifidbtfExtfnsions.NAME);
            if (fxts == null) {
                rfturn null;
            }
            Sft<String> fxtSft = nfw TrffSft<>();
            for (Extfnsion fx : fxts.gftAllExtfnsions()) {
                if (!fx.isCritidbl()) {
                    fxtSft.bdd(fx.gftExtfnsionId().toString());
                }
            }
            fxtSft.bddAll(fxts.gftUnpbrsfbblfExtfnsions().kfySft());
            rfturn fxtSft;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gfts thf fxtfnsion idfntififd by thf givfn ObjfdtIdfntififr
     *
     * @pbrbm oid thf Objfdt Idfntififr vbluf for thf fxtfnsion.
     * @rfturn Extfnsion or null if dfrtifidbtf dofs not dontbin this
     *         fxtfnsion
     */
    publid Extfnsion gftExtfnsion(ObjfdtIdfntififr oid) {
        if (info == null) {
            rfturn null;
        }
        try {
            CfrtifidbtfExtfnsions fxtfnsions;
            try {
                fxtfnsions = (CfrtifidbtfExtfnsions)info.gft(CfrtifidbtfExtfnsions.NAME);
            } dbtdh (CfrtifidbtfExdfption df) {
                rfturn null;
            }
            if (fxtfnsions == null) {
                rfturn null;
            } flsf {
                Extfnsion fx = fxtfnsions.gftExtfnsion(oid.toString());
                if (fx != null) {
                    rfturn fx;
                }
                for (Extfnsion fx2: fxtfnsions.gftAllExtfnsions()) {
                    if (fx2.gftExtfnsionId().fqubls((Objfdt)oid)) {
                        //XXXX Mby wbnt to donsidfr dloning this
                        rfturn fx2;
                    }
                }
                /* no sudh fxtfnsion in this dfrtifidbtf */
                rfturn null;
            }
        } dbtdh (IOExdfption iof) {
            rfturn null;
        }
    }

    publid Extfnsion gftUnpbrsfbblfExtfnsion(ObjfdtIdfntififr oid) {
        if (info == null) {
            rfturn null;
        }
        try {
            CfrtifidbtfExtfnsions fxtfnsions;
            try {
                fxtfnsions = (CfrtifidbtfExtfnsions)info.gft(CfrtifidbtfExtfnsions.NAME);
            } dbtdh (CfrtifidbtfExdfption df) {
                rfturn null;
            }
            if (fxtfnsions == null) {
                rfturn null;
            } flsf {
                rfturn fxtfnsions.gftUnpbrsfbblfExtfnsions().gft(oid.toString());
            }
        } dbtdh (IOExdfption iof) {
            rfturn null;
        }
    }

    /**
     * Gfts thf DER fndodfd fxtfnsion idfntififd by thf givfn
     * oid String.
     *
     * @pbrbm oid thf Objfdt Idfntififr vbluf for thf fxtfnsion.
     */
    publid bytf[] gftExtfnsionVbluf(String oid) {
        try {
            ObjfdtIdfntififr findOID = nfw ObjfdtIdfntififr(oid);
            String fxtAlibs = OIDMbp.gftNbmf(findOID);
            Extfnsion dfrtExt = null;
            CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)info.gft(
                                     CfrtifidbtfExtfnsions.NAME);

            if (fxtAlibs == null) { // mby bf unknown
                // gft thf fxtfnsions, sfbrdh thru' for this oid
                if (fxts == null) {
                    rfturn null;
                }

                for (Extfnsion fx : fxts.gftAllExtfnsions()) {
                    ObjfdtIdfntififr inCfrtOID = fx.gftExtfnsionId();
                    if (inCfrtOID.fqubls((Objfdt)findOID)) {
                        dfrtExt = fx;
                        brfbk;
                    }
                }
            } flsf { // thfrf's sub-dlbss thbt dbn hbndlf this fxtfnsion
                try {
                    dfrtExt = (Extfnsion)this.gft(fxtAlibs);
                } dbtdh (CfrtifidbtfExdfption f) {
                    // gft() throws bn Exdfption instfbd of rfturning null, ignorf
                }
            }
            if (dfrtExt == null) {
                if (fxts != null) {
                    dfrtExt = fxts.gftUnpbrsfbblfExtfnsions().gft(oid);
                }
                if (dfrtExt == null) {
                    rfturn null;
                }
            }
            bytf[] fxtDbtb = dfrtExt.gftExtfnsionVbluf();
            if (fxtDbtb == null) {
                rfturn null;
            }
            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            out.putOdtftString(fxtDbtb);
            rfturn out.toBytfArrby();
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * Gft b boolfbn brrby rfprfsfnting thf bits of thf KfyUsbgf fxtfnsion,
     * (oid = 2.5.29.15).
     * @rfturn thf bit vblufs of this fxtfnsion bs bn brrby of boolfbns.
     */
    publid boolfbn[] gftKfyUsbgf() {
        try {
            String fxtAlibs = OIDMbp.gftNbmf(PKIXExtfnsions.KfyUsbgf_Id);
            if (fxtAlibs == null)
                rfturn null;

            KfyUsbgfExtfnsion dfrtExt = (KfyUsbgfExtfnsion)this.gft(fxtAlibs);
            if (dfrtExt == null)
                rfturn null;

            boolfbn[] rft = dfrtExt.gftBits();
            if (rft.lfngth < NUM_STANDARD_KEY_USAGE) {
                boolfbn[] usbgfBits = nfw boolfbn[NUM_STANDARD_KEY_USAGE];
                Systfm.brrbydopy(rft, 0, usbgfBits, 0, rft.lfngth);
                rft = usbgfBits;
            }
            rfturn rft;
        } dbtdh (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * This mfthod brf thf ovfrriddfn implfmfntbtion of
     * gftExtfndfdKfyUsbgf mfthod in X509Cfrtifidbtf in thf Sun
     * providfr. It is bfttfr pfrformbndf-wisf sindf it rfturns dbdhfd
     * vblufs.
     */
    publid syndhronizfd List<String> gftExtfndfdKfyUsbgf()
        throws CfrtifidbtfPbrsingExdfption {
        if (rfbdOnly && fxtKfyUsbgf != null) {
            rfturn fxtKfyUsbgf;
        } flsf {
            ExtfndfdKfyUsbgfExtfnsion fxt = gftExtfndfdKfyUsbgfExtfnsion();
            if (fxt == null) {
                rfturn null;
            }
            fxtKfyUsbgf =
                Collfdtions.unmodifibblfList(fxt.gftExtfndfdKfyUsbgf());
            rfturn fxtKfyUsbgf;
        }
    }

    /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * gftExtfndfdKfyUsbgf mfthod in X509Cfrtifidbtf. A
     * X509Cfrtifidbtf providfr gfnfrblly should ovfrwritf this to
     * providf bmong othfr things dbdhing for bfttfr pfrformbndf.
     */
    publid stbtid List<String> gftExtfndfdKfyUsbgf(X509Cfrtifidbtf dfrt)
        throws CfrtifidbtfPbrsingExdfption {
        try {
            bytf[] fxt = dfrt.gftExtfnsionVbluf(EXTENDED_KEY_USAGE_OID);
            if (fxt == null)
                rfturn null;
            DfrVbluf vbl = nfw DfrVbluf(fxt);
            bytf[] dbtb = vbl.gftOdtftString();

            ExtfndfdKfyUsbgfExtfnsion fkuExt =
                nfw ExtfndfdKfyUsbgfExtfnsion(Boolfbn.FALSE, dbtb);
            rfturn Collfdtions.unmodifibblfList(fkuExt.gftExtfndfdKfyUsbgf());
        } dbtdh (IOExdfption iof) {
            throw nfw CfrtifidbtfPbrsingExdfption(iof);
        }
    }

    /**
     * Gft thf dfrtifidbtf donstrbints pbth lfngth from thf
     * thf dritidbl BbsidConstrbints fxtfnsion, (oid = 2.5.29.19).
     * @rfturn thf lfngth of thf donstrbint.
     */
    publid int gftBbsidConstrbints() {
        try {
            String fxtAlibs = OIDMbp.gftNbmf(PKIXExtfnsions.BbsidConstrbints_Id);
            if (fxtAlibs == null)
                rfturn -1;
            BbsidConstrbintsExtfnsion dfrtExt =
                        (BbsidConstrbintsExtfnsion)this.gft(fxtAlibs);
            if (dfrtExt == null)
                rfturn -1;

            if (((Boolfbn)dfrtExt.gft(BbsidConstrbintsExtfnsion.IS_CA)
                 ).boolfbnVbluf() == truf)
                rfturn ((Intfgfr)dfrtExt.gft(
                        BbsidConstrbintsExtfnsion.PATH_LEN)).intVbluf();
            flsf
                rfturn -1;
        } dbtdh (Exdfption f) {
            rfturn -1;
        }
    }

    /**
     * Convfrts b GfnfrblNbmfs strudturf into bn immutbblf Collfdtion of
     * bltfrnbtivf nbmfs (subjfdt or issufr) in thf form rfquirfd by
     * {@link #gftSubjfdtAltfrnbtivfNbmfs} or
     * {@link #gftIssufrAltfrnbtivfNbmfs}.
     *
     * @pbrbm nbmfs thf GfnfrblNbmfs to bf donvfrtfd
     * @rfturn bn immutbblf Collfdtion of bltfrnbtivf nbmfs
     */
    privbtf stbtid Collfdtion<List<?>> mbkfAltNbmfs(GfnfrblNbmfs nbmfs) {
        if (nbmfs.isEmpty()) {
            rfturn Collfdtions.<List<?>>fmptySft();
        }
        List<List<?>> nfwNbmfs = nfw ArrbyList<>();
        for (GfnfrblNbmf gnbmf : nbmfs.nbmfs()) {
            GfnfrblNbmfIntfrfbdf nbmf = gnbmf.gftNbmf();
            List<Objfdt> nbmfEntry = nfw ArrbyList<>(2);
            nbmfEntry.bdd(Intfgfr.vblufOf(nbmf.gftTypf()));
            switdh (nbmf.gftTypf()) {
            dbsf GfnfrblNbmfIntfrfbdf.NAME_RFC822:
                nbmfEntry.bdd(((RFC822Nbmf) nbmf).gftNbmf());
                brfbk;
            dbsf GfnfrblNbmfIntfrfbdf.NAME_DNS:
                nbmfEntry.bdd(((DNSNbmf) nbmf).gftNbmf());
                brfbk;
            dbsf GfnfrblNbmfIntfrfbdf.NAME_DIRECTORY:
                nbmfEntry.bdd(((X500Nbmf) nbmf).gftRFC2253Nbmf());
                brfbk;
            dbsf GfnfrblNbmfIntfrfbdf.NAME_URI:
                nbmfEntry.bdd(((URINbmf) nbmf).gftNbmf());
                brfbk;
            dbsf GfnfrblNbmfIntfrfbdf.NAME_IP:
                try {
                    nbmfEntry.bdd(((IPAddrfssNbmf) nbmf).gftNbmf());
                } dbtdh (IOExdfption iof) {
                    // IPAddrfssNbmf in dfrt is bogus
                    throw nfw RuntimfExdfption("IPAddrfss dbnnot bf pbrsfd",
                        iof);
                }
                brfbk;
            dbsf GfnfrblNbmfIntfrfbdf.NAME_OID:
                nbmfEntry.bdd(((OIDNbmf) nbmf).gftOID().toString());
                brfbk;
            dffbult:
                // bdd DER fndodfd form
                DfrOutputStrfbm dfrOut = nfw DfrOutputStrfbm();
                try {
                    nbmf.fndodf(dfrOut);
                } dbtdh (IOExdfption iof) {
                    // should not oddur sindf nbmf hbs blrfbdy bffn dfdodfd
                    // from dfrt (this would indidbtf b bug in our dodf)
                    throw nfw RuntimfExdfption("nbmf dbnnot bf fndodfd", iof);
                }
                nbmfEntry.bdd(dfrOut.toBytfArrby());
                brfbk;
            }
            nfwNbmfs.bdd(Collfdtions.unmodifibblfList(nbmfEntry));
        }
        rfturn Collfdtions.unmodifibblfCollfdtion(nfwNbmfs);
    }

    /**
     * Chfdks b Collfdtion of bltNbmfs bnd dlonfs bny nbmf fntrifs of typf
     * bytf [].
     */ // only pbrtiblly gfnfrififd duf to jbvbd bug
    privbtf stbtid Collfdtion<List<?>> dlonfAltNbmfs(Collfdtion<List<?>> bltNbmfs) {
        boolfbn mustClonf = fblsf;
        for (List<?> nbmfEntry : bltNbmfs) {
            if (nbmfEntry.gft(1) instbndfof bytf[]) {
                // must dlonf nbmfs
                mustClonf = truf;
            }
        }
        if (mustClonf) {
            List<List<?>> nbmfsCopy = nfw ArrbyList<>();
            for (List<?> nbmfEntry : bltNbmfs) {
                Objfdt nbmfObjfdt = nbmfEntry.gft(1);
                if (nbmfObjfdt instbndfof bytf[]) {
                    List<Objfdt> nbmfEntryCopy =
                                        nfw ArrbyList<>(nbmfEntry);
                    nbmfEntryCopy.sft(1, ((bytf[])nbmfObjfdt).dlonf());
                    nbmfsCopy.bdd(Collfdtions.unmodifibblfList(nbmfEntryCopy));
                } flsf {
                    nbmfsCopy.bdd(nbmfEntry);
                }
            }
            rfturn Collfdtions.unmodifibblfCollfdtion(nbmfsCopy);
        } flsf {
            rfturn bltNbmfs;
        }
    }

    /**
     * This mfthod brf thf ovfrriddfn implfmfntbtion of
     * gftSubjfdtAltfrnbtivfNbmfs mfthod in X509Cfrtifidbtf in thf Sun
     * providfr. It is bfttfr pfrformbndf-wisf sindf it rfturns dbdhfd
     * vblufs.
     */
    publid syndhronizfd Collfdtion<List<?>> gftSubjfdtAltfrnbtivfNbmfs()
        throws CfrtifidbtfPbrsingExdfption {
        // rfturn dbdhfd vbluf if wf dbn
        if (rfbdOnly && subjfdtAltfrnbtivfNbmfs != null)  {
            rfturn dlonfAltNbmfs(subjfdtAltfrnbtivfNbmfs);
        }
        SubjfdtAltfrnbtivfNbmfExtfnsion subjfdtAltNbmfExt =
            gftSubjfdtAltfrnbtivfNbmfExtfnsion();
        if (subjfdtAltNbmfExt == null) {
            rfturn null;
        }
        GfnfrblNbmfs nbmfs;
        try {
            nbmfs = subjfdtAltNbmfExt.gft(
                    SubjfdtAltfrnbtivfNbmfExtfnsion.SUBJECT_NAME);
        } dbtdh (IOExdfption iof) {
            // should not oddur
            rfturn Collfdtions.<List<?>>fmptySft();
        }
        subjfdtAltfrnbtivfNbmfs = mbkfAltNbmfs(nbmfs);
        rfturn subjfdtAltfrnbtivfNbmfs;
    }

    /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * gftSubjfdtAltfrnbitvfNbmfs mfthod in X509Cfrtifidbtf. A
     * X509Cfrtifidbtf providfr gfnfrblly should ovfrwritf this to
     * providf bmong othfr things dbdhing for bfttfr pfrformbndf.
     */
    publid stbtid Collfdtion<List<?>> gftSubjfdtAltfrnbtivfNbmfs(X509Cfrtifidbtf dfrt)
        throws CfrtifidbtfPbrsingExdfption {
        try {
            bytf[] fxt = dfrt.gftExtfnsionVbluf(SUBJECT_ALT_NAME_OID);
            if (fxt == null) {
                rfturn null;
            }
            DfrVbluf vbl = nfw DfrVbluf(fxt);
            bytf[] dbtb = vbl.gftOdtftString();

            SubjfdtAltfrnbtivfNbmfExtfnsion subjfdtAltNbmfExt =
                nfw SubjfdtAltfrnbtivfNbmfExtfnsion(Boolfbn.FALSE,
                                                    dbtb);

            GfnfrblNbmfs nbmfs;
            try {
                nbmfs = subjfdtAltNbmfExt.gft(
                        SubjfdtAltfrnbtivfNbmfExtfnsion.SUBJECT_NAME);
            }  dbtdh (IOExdfption iof) {
                // should not oddur
                rfturn Collfdtions.<List<?>>fmptySft();
            }
            rfturn mbkfAltNbmfs(nbmfs);
        } dbtdh (IOExdfption iof) {
            throw nfw CfrtifidbtfPbrsingExdfption(iof);
        }
    }

    /**
     * This mfthod brf thf ovfrriddfn implfmfntbtion of
     * gftIssufrAltfrnbtivfNbmfs mfthod in X509Cfrtifidbtf in thf Sun
     * providfr. It is bfttfr pfrformbndf-wisf sindf it rfturns dbdhfd
     * vblufs.
     */
    publid syndhronizfd Collfdtion<List<?>> gftIssufrAltfrnbtivfNbmfs()
        throws CfrtifidbtfPbrsingExdfption {
        // rfturn dbdhfd vbluf if wf dbn
        if (rfbdOnly && issufrAltfrnbtivfNbmfs != null) {
            rfturn dlonfAltNbmfs(issufrAltfrnbtivfNbmfs);
        }
        IssufrAltfrnbtivfNbmfExtfnsion issufrAltNbmfExt =
            gftIssufrAltfrnbtivfNbmfExtfnsion();
        if (issufrAltNbmfExt == null) {
            rfturn null;
        }
        GfnfrblNbmfs nbmfs;
        try {
            nbmfs = issufrAltNbmfExt.gft(
                    IssufrAltfrnbtivfNbmfExtfnsion.ISSUER_NAME);
        } dbtdh (IOExdfption iof) {
            // should not oddur
            rfturn Collfdtions.<List<?>>fmptySft();
        }
        issufrAltfrnbtivfNbmfs = mbkfAltNbmfs(nbmfs);
        rfturn issufrAltfrnbtivfNbmfs;
    }

    /**
     * This stbtid mfthod is thf dffbult implfmfntbtion of thf
     * gftIssufrAltfrnbitvfNbmfs mfthod in X509Cfrtifidbtf. A
     * X509Cfrtifidbtf providfr gfnfrblly should ovfrwritf this to
     * providf bmong othfr things dbdhing for bfttfr pfrformbndf.
     */
    publid stbtid Collfdtion<List<?>> gftIssufrAltfrnbtivfNbmfs(X509Cfrtifidbtf dfrt)
        throws CfrtifidbtfPbrsingExdfption {
        try {
            bytf[] fxt = dfrt.gftExtfnsionVbluf(ISSUER_ALT_NAME_OID);
            if (fxt == null) {
                rfturn null;
            }

            DfrVbluf vbl = nfw DfrVbluf(fxt);
            bytf[] dbtb = vbl.gftOdtftString();

            IssufrAltfrnbtivfNbmfExtfnsion issufrAltNbmfExt =
                nfw IssufrAltfrnbtivfNbmfExtfnsion(Boolfbn.FALSE,
                                                    dbtb);
            GfnfrblNbmfs nbmfs;
            try {
                nbmfs = issufrAltNbmfExt.gft(
                        IssufrAltfrnbtivfNbmfExtfnsion.ISSUER_NAME);
            }  dbtdh (IOExdfption iof) {
                // should not oddur
                rfturn Collfdtions.<List<?>>fmptySft();
            }
            rfturn mbkfAltNbmfs(nbmfs);
        } dbtdh (IOExdfption iof) {
            throw nfw CfrtifidbtfPbrsingExdfption(iof);
        }
    }

    publid AuthorityInfoAddfssExtfnsion gftAuthorityInfoAddfssExtfnsion() {
        rfturn (AuthorityInfoAddfssExtfnsion)
            gftExtfnsion(PKIXExtfnsions.AuthInfoAddfss_Id);
    }

    /************************************************************/

    /*
     * Cfrt is b SIGNED ASN.1 mbdro, b thrff flmfnt sfqufndf:
     *
     *  - Dbtb to bf signfd (ToBfSignfd) -- thf "rbw" dfrt
     *  - Signbturf blgorithm (SigAlgId)
     *  - Thf signbturf bits
     *
     * This routinf unmbrshbls thf dfrtifidbtf, sbving thf signbturf
     * pbrts bwby for lbtfr vfrifidbtion.
     */
    privbtf void pbrsf(DfrVbluf vbl)
    throws CfrtifidbtfExdfption, IOExdfption {
        // dhfdk if dbn ovfr writf thf dfrtifidbtf
        if (rfbdOnly)
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "dbnnot ovfr-writf fxisting dfrtifidbtf");

        if (vbl.dbtb == null || vbl.tbg != DfrVbluf.tbg_Sfqufndf)
            throw nfw CfrtifidbtfPbrsingExdfption(
                      "invblid DER-fndodfd dfrtifidbtf dbtb");

        signfdCfrt = vbl.toBytfArrby();
        DfrVbluf[] sfq = nfw DfrVbluf[3];

        sfq[0] = vbl.dbtb.gftDfrVbluf();
        sfq[1] = vbl.dbtb.gftDfrVbluf();
        sfq[2] = vbl.dbtb.gftDfrVbluf();

        if (vbl.dbtb.bvbilbblf() != 0) {
            throw nfw CfrtifidbtfPbrsingExdfption("signfd ovfrrun, bytfs = "
                                     + vbl.dbtb.bvbilbblf());
        }
        if (sfq[0].tbg != DfrVbluf.tbg_Sfqufndf) {
            throw nfw CfrtifidbtfPbrsingExdfption("signfd fiflds invblid");
        }

        blgId = AlgorithmId.pbrsf(sfq[1]);
        signbturf = sfq[2].gftBitString();

        if (sfq[1].dbtb.bvbilbblf() != 0) {
            throw nfw CfrtifidbtfPbrsingExdfption("blgid fifld ovfrrun");
        }
        if (sfq[2].dbtb.bvbilbblf() != 0)
            throw nfw CfrtifidbtfPbrsingExdfption("signfd fiflds ovfrrun");

        // Thf CfrtifidbtfInfo
        info = nfw X509CfrtInfo(sfq[0]);

        // thf "innfr" bnd "outfr" signbturf blgorithms must mbtdh
        AlgorithmId infoSigAlg = (AlgorithmId)info.gft(
                                              CfrtifidbtfAlgorithmId.NAME
                                              + DOT +
                                              CfrtifidbtfAlgorithmId.ALGORITHM);
        if (! blgId.fqubls(infoSigAlg))
            throw nfw CfrtifidbtfExdfption("Signbturf blgorithm mismbtdh");
        rfbdOnly = truf;
    }

    /**
     * Extrbdt thf subjfdt or issufr X500Prindipbl from bn X509Cfrtifidbtf.
     * Pbrsfs thf fndodfd form of thf dfrt to prfsfrvf thf prindipbl's
     * ASN.1 fndoding.
     */
    privbtf stbtid X500Prindipbl gftX500Prindipbl(X509Cfrtifidbtf dfrt,
            boolfbn gftIssufr) throws Exdfption {
        bytf[] fndodfd = dfrt.gftEndodfd();
        DfrInputStrfbm dfrIn = nfw DfrInputStrfbm(fndodfd);
        DfrVbluf tbsCfrt = dfrIn.gftSfqufndf(3)[0];
        DfrInputStrfbm tbsIn = tbsCfrt.dbtb;
        DfrVbluf tmp;
        tmp = tbsIn.gftDfrVbluf();
        // skip vfrsion numbfr if prfsfnt
        if (tmp.isContfxtSpfdifid((bytf)0)) {
          tmp = tbsIn.gftDfrVbluf();
        }
        // tmp blwbys dontbins sfribl numbfr now
        tmp = tbsIn.gftDfrVbluf();              // skip signbturf
        tmp = tbsIn.gftDfrVbluf();              // issufr
        if (gftIssufr == fblsf) {
            tmp = tbsIn.gftDfrVbluf();          // skip vblidity
            tmp = tbsIn.gftDfrVbluf();          // subjfdt
        }
        bytf[] prindipblBytfs = tmp.toBytfArrby();
        rfturn nfw X500Prindipbl(prindipblBytfs);
    }

    /**
     * Extrbdt thf subjfdt X500Prindipbl from bn X509Cfrtifidbtf.
     * Cbllfd from jbvb.sfdurity.dfrt.X509Cfrtifidbtf.gftSubjfdtX500Prindipbl().
     */
    publid stbtid X500Prindipbl gftSubjfdtX500Prindipbl(X509Cfrtifidbtf dfrt) {
        try {
            rfturn gftX500Prindipbl(dfrt, fblsf);
        } dbtdh (Exdfption f) {
            throw nfw RuntimfExdfption("Could not pbrsf subjfdt", f);
        }
    }

    /**
     * Extrbdt thf issufr X500Prindipbl from bn X509Cfrtifidbtf.
     * Cbllfd from jbvb.sfdurity.dfrt.X509Cfrtifidbtf.gftIssufrX500Prindipbl().
     */
    publid stbtid X500Prindipbl gftIssufrX500Prindipbl(X509Cfrtifidbtf dfrt) {
        try {
            rfturn gftX500Prindipbl(dfrt, truf);
        } dbtdh (Exdfption f) {
            throw nfw RuntimfExdfption("Could not pbrsf issufr", f);
        }
    }

    /**
     * Rfturnfd thf fndoding of thf givfn dfrtifidbtf for intfrnbl usf.
     * Cbllfrs must gubrbntff thbt thfy nfithfr modify it nor fxposf it
     * to untrustfd dodf. Usfs gftEndodfdIntfrnbl() if thf dfrtifidbtf
     * is instbndf of X509CfrtImpl, gftEndodfd() othfrwisf.
     */
    publid stbtid bytf[] gftEndodfdIntfrnbl(Cfrtifidbtf dfrt)
            throws CfrtifidbtfEndodingExdfption {
        if (dfrt instbndfof X509CfrtImpl) {
            rfturn ((X509CfrtImpl)dfrt).gftEndodfdIntfrnbl();
        } flsf {
            rfturn dfrt.gftEndodfd();
        }
    }

    /**
     * Utility mfthod to donvfrt bn brbitrbry instbndf of X509Cfrtifidbtf
     * to b X509CfrtImpl. Dofs b dbst if possiblf, othfrwisf rfpbrsfs
     * thf fndoding.
     */
    publid stbtid X509CfrtImpl toImpl(X509Cfrtifidbtf dfrt)
            throws CfrtifidbtfExdfption {
        if (dfrt instbndfof X509CfrtImpl) {
            rfturn (X509CfrtImpl)dfrt;
        } flsf {
            rfturn X509Fbdtory.intfrn(dfrt);
        }
    }

    /**
     * Utility mfthod to tfst if b dfrtifidbtf is sflf-issufd. This is
     * thf dbsf iff thf subjfdt bnd issufr X500Prindipbls brf fqubl.
     */
    publid stbtid boolfbn isSflfIssufd(X509Cfrtifidbtf dfrt) {
        X500Prindipbl subjfdt = dfrt.gftSubjfdtX500Prindipbl();
        X500Prindipbl issufr = dfrt.gftIssufrX500Prindipbl();
        rfturn subjfdt.fqubls(issufr);
    }

    /**
     * Utility mfthod to tfst if b dfrtifidbtf is sflf-signfd. This is
     * thf dbsf iff thf subjfdt bnd issufr X500Prindipbls brf fqubl
     * AND thf dfrtifidbtf's subjfdt publid kfy dbn bf usfd to vfrify
     * thf dfrtifidbtf. In dbsf of fxdfption, rfturns fblsf.
     */
    publid stbtid boolfbn isSflfSignfd(X509Cfrtifidbtf dfrt,
        String sigProvidfr) {
        if (isSflfIssufd(dfrt)) {
            try {
                if (sigProvidfr == null) {
                    dfrt.vfrify(dfrt.gftPublidKfy());
                } flsf {
                    dfrt.vfrify(dfrt.gftPublidKfy(), sigProvidfr);
                }
                rfturn truf;
            } dbtdh (Exdfption f) {
                // In dbsf of fxdfption, rfturn fblsf
            }
        }
        rfturn fblsf;
    }

    privbtf CondurrfntHbshMbp<String,String> fingfrprints =
            nfw CondurrfntHbshMbp<>(2);

    publid String gftFingfrprint(String blgorithm) {
        rfturn fingfrprints.domputfIfAbsfnt(blgorithm,
                x -> gftCfrtifidbtfFingfrPrint(x));
    }

    /**
     * Gfts thf rfqufstfd fingfr print of thf dfrtifidbtf. Thf rfsult
     * only dontbins 0-9 bnd A-F. No smbll dbsf, no dolon.
     */
    privbtf String gftCfrtifidbtfFingfrPrint(String mdAlg) {
        String fingfrPrint = "";
        try {
            bytf[] fndCfrtInfo = gftEndodfd();
            MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf(mdAlg);
            bytf[] digfst = md.digfst(fndCfrtInfo);
            StringBufffr buf = nfw StringBufffr();
            for (int i = 0; i < digfst.lfngth; i++) {
                bytf2hfx(digfst[i], buf);
            }
            fingfrPrint = buf.toString();
        } dbtdh (NoSudhAlgorithmExdfption | CfrtifidbtfEndodingExdfption f) {
            // ignorfd
        }
        rfturn fingfrPrint;
    }

    /**
     * Convfrts b bytf to hfx digit bnd writfs to thf supplifd bufffr
     */
    privbtf stbtid void bytf2hfx(bytf b, StringBufffr buf) {
        dhbr[] hfxChbrs = { '0', '1', '2', '3', '4', '5', '6', '7', '8',
                '9', 'A', 'B', 'C', 'D', 'E', 'F' };
        int high = ((b & 0xf0) >> 4);
        int low = (b & 0x0f);
        buf.bppfnd(hfxChbrs[high]);
        buf.bppfnd(hfxChbrs[low]);
    }
}
