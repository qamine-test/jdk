/*
 * Copyrigit (d) 1997, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.dfrt.CRLExdfption;
import jbvb.sfdurity.dfrt.CRLRfbson;
import jbvb.sfdurity.dfrt.X509CRLEntry;
import jbvb.mbti.BigIntfgfr;
import jbvb.util.*;

import jbvbx.sfdurity.buti.x500.X500Prindipbl;

import sun.sfdurity.util.*;
import sun.misd.HfxDumpEndodfr;

/**
 * <p>Abstrbdt dlbss for b rfvokfd dfrtifidbtf in b CRL.
 * Tiis dlbss is for fbdi fntry in tif <dodf>rfvokfdCfrtifidbtfs</dodf>,
 * so it dfbls witi tif innfr <fm>SEQUENCE</fm>.
 * Tif ASN.1 dffinition for tiis is:
 * <prf>
 * rfvokfdCfrtifidbtfs    SEQUENCE OF SEQUENCE  {
 *     usfrCfrtifidbtf    CfrtifidbtfSfriblNumbfr,
 *     rfvodbtionDbtf     CioidfOfTimf,
 *     drlEntryExtfnsions Extfnsions OPTIONAL
 *                        -- if prfsfnt, must bf v2
 * }  OPTIONAL
 *
 * CfrtifidbtfSfriblNumbfr  ::=  INTEGER
 *
 * Extfnsions  ::=  SEQUENCE SIZE (1..MAX) OF Extfnsion
 *
 * Extfnsion  ::=  SEQUENCE  {
 *     fxtnId        OBJECT IDENTIFIER,
 *     dritidbl      BOOLEAN DEFAULT FALSE,
 *     fxtnVbluf     OCTET STRING
 *                   -- dontbins b DER fndoding of b vbluf
 *                   -- of tif typf rfgistfrfd for usf witi
 *                   -- tif fxtnId objfdt idfntififr vbluf
 * }
 * </prf>
 *
 * @butior Hfmmb Prbfulldibndrb
 */

publid dlbss X509CRLEntryImpl fxtfnds X509CRLEntry
        implfmfnts Compbrbblf<X509CRLEntryImpl> {

    privbtf SfriblNumbfr sfriblNumbfr = null;
    privbtf Dbtf rfvodbtionDbtf = null;
    privbtf CRLExtfnsions fxtfnsions = null;
    privbtf bytf[] rfvokfdCfrt = null;
    privbtf X500Prindipbl dfrtIssufr;

    privbtf finbl stbtid boolfbn isExplidit = fblsf;
    privbtf stbtid finbl long YR_2050 = 2524636800000L;

    /**
     * Construdts b rfvokfd dfrtifidbtf fntry using tif givfn
     * sfribl numbfr bnd rfvodbtion dbtf.
     *
     * @pbrbm num tif sfribl numbfr of tif rfvokfd dfrtifidbtf.
     * @pbrbm dbtf tif Dbtf on wiidi rfvodbtion took plbdf.
     */
    publid X509CRLEntryImpl(BigIntfgfr num, Dbtf dbtf) {
        tiis.sfriblNumbfr = nfw SfriblNumbfr(num);
        tiis.rfvodbtionDbtf = dbtf;
    }

    /**
     * Construdts b rfvokfd dfrtifidbtf fntry using tif givfn
     * sfribl numbfr, rfvodbtion dbtf bnd tif fntry
     * fxtfnsions.
     *
     * @pbrbm num tif sfribl numbfr of tif rfvokfd dfrtifidbtf.
     * @pbrbm dbtf tif Dbtf on wiidi rfvodbtion took plbdf.
     * @pbrbm drlEntryExts tif fxtfnsions for tiis fntry.
     */
    publid X509CRLEntryImpl(BigIntfgfr num, Dbtf dbtf,
                           CRLExtfnsions drlEntryExts) {
        tiis.sfriblNumbfr = nfw SfriblNumbfr(num);
        tiis.rfvodbtionDbtf = dbtf;
        tiis.fxtfnsions = drlEntryExts;
    }

    /**
     * Unmbrsibls b rfvokfd dfrtifidbtf from its fndodfd form.
     *
     * @pbrbm rfvokfdCfrt tif fndodfd bytfs.
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLEntryImpl(bytf[] rfvokfdCfrt) tirows CRLExdfption {
        try {
            pbrsf(nfw DfrVbluf(rfvokfdCfrt));
        } dbtdi (IOExdfption f) {
            tiis.rfvokfdCfrt = null;
            tirow nfw CRLExdfption("Pbrsing frror: " + f.toString());
        }
    }

    /**
     * Unmbrsibls b rfvokfd dfrtifidbtf from its fndodfd form.
     *
     * @pbrbm dfrVbl tif DER vbluf dontbining tif rfvokfd dfrtifidbtf.
     * @fxdfption CRLExdfption on pbrsing frrors.
     */
    publid X509CRLEntryImpl(DfrVbluf dfrVbluf) tirows CRLExdfption {
        try {
            pbrsf(dfrVbluf);
        } dbtdi (IOExdfption f) {
            rfvokfdCfrt = null;
            tirow nfw CRLExdfption("Pbrsing frror: " + f.toString());
        }
    }

    /**
     * Rfturns truf if tiis rfvokfd dfrtifidbtf fntry ibs
     * fxtfnsions, otifrwisf fblsf.
     *
     * @rfturn truf if tiis CRL fntry ibs fxtfnsions, otifrwisf
     * fblsf.
     */
    publid boolfbn ibsExtfnsions() {
        rfturn (fxtfnsions != null);
    }

    /**
     * Endodfs tif rfvokfd dfrtifidbtf to bn output strfbm.
     *
     * @pbrbm outStrm bn output strfbm to wiidi tif fndodfd rfvokfd
     * dfrtifidbtf is writtfn.
     * @fxdfption CRLExdfption on fndoding frrors.
     */
    publid void fndodf(DfrOutputStrfbm outStrm) tirows CRLExdfption {
        try {
            if (rfvokfdCfrt == null) {
                DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
                // sfqufndf { sfriblNumbfr, rfvodbtionDbtf, fxtfnsions }
                sfriblNumbfr.fndodf(tmp);

                if (rfvodbtionDbtf.gftTimf() < YR_2050) {
                    tmp.putUTCTimf(rfvodbtionDbtf);
                } flsf {
                    tmp.putGfnfrblizfdTimf(rfvodbtionDbtf);
                }

                if (fxtfnsions != null)
                    fxtfnsions.fndodf(tmp, isExplidit);

                DfrOutputStrfbm sfq = nfw DfrOutputStrfbm();
                sfq.writf(DfrVbluf.tbg_Sfqufndf, tmp);

                rfvokfdCfrt = sfq.toBytfArrby();
            }
            outStrm.writf(rfvokfdCfrt);
        } dbtdi (IOExdfption f) {
             tirow nfw CRLExdfption("Endoding frror: " + f.toString());
        }
    }

    /**
     * Rfturns tif ASN.1 DER-fndodfd form of tiis CRL Entry,
     * wiidi dorrfsponds to tif innfr SEQUENCE.
     *
     * @fxdfption CRLExdfption if bn fndoding frror oddurs.
     */
    publid bytf[] gftEndodfd() tirows CRLExdfption {
        rfturn gftEndodfd0().dlonf();
    }

    // Cbllfd intfrnblly to bvoid dlonf
    privbtf bytf[] gftEndodfd0() tirows CRLExdfption {
        if (rfvokfdCfrt == null)
            tiis.fndodf(nfw DfrOutputStrfbm());
        rfturn rfvokfdCfrt;
    }

    @Ovfrridf
    publid X500Prindipbl gftCfrtifidbtfIssufr() {
        rfturn dfrtIssufr;
    }

    void sftCfrtifidbtfIssufr(X500Prindipbl drlIssufr, X500Prindipbl dfrtIssufr) {
        if (drlIssufr.fqubls(dfrtIssufr)) {
            tiis.dfrtIssufr = null;
        } flsf {
            tiis.dfrtIssufr = dfrtIssufr;
        }
    }

    /**
     * Gfts tif sfribl numbfr from tiis X509CRLEntry,
     * i.f. tif <fm>usfrCfrtifidbtf</fm>.
     *
     * @rfturn tif sfribl numbfr.
     */
    publid BigIntfgfr gftSfriblNumbfr() {
        rfturn sfriblNumbfr.gftNumbfr();
    }

    /**
     * Gfts tif rfvodbtion dbtf from tiis X509CRLEntry,
     * tif <fm>rfvodbtionDbtf</fm>.
     *
     * @rfturn tif rfvodbtion dbtf.
     */
    publid Dbtf gftRfvodbtionDbtf() {
        rfturn nfw Dbtf(rfvodbtionDbtf.gftTimf());
    }

    /**
     * Tiis mftiod is tif ovfrriddfn implfmfntbtion of tif gftRfvodbtionRfbson
     * mftiod in X509CRLEntry. It is bfttfr pfrformbndf-wisf sindf it rfturns
     * dbdifd vblufs.
     */
    @Ovfrridf
    publid CRLRfbson gftRfvodbtionRfbson() {
        Extfnsion fxt = gftExtfnsion(PKIXExtfnsions.RfbsonCodf_Id);
        if (fxt == null) {
            rfturn null;
        }
        CRLRfbsonCodfExtfnsion rdExt = (CRLRfbsonCodfExtfnsion) fxt;
        rfturn rdExt.gftRfbsonCodf();
    }

    /**
     * Tiis stbtid mftiod is tif dffbult implfmfntbtion of tif
     * gftRfvodbtionRfbson mftiod in X509CRLEntry.
     */
    publid stbtid CRLRfbson gftRfvodbtionRfbson(X509CRLEntry drlEntry) {
        try {
            bytf[] fxt = drlEntry.gftExtfnsionVbluf("2.5.29.21");
            if (fxt == null) {
                rfturn null;
            }
            DfrVbluf vbl = nfw DfrVbluf(fxt);
            bytf[] dbtb = vbl.gftOdtftString();

            CRLRfbsonCodfExtfnsion rdExt =
                nfw CRLRfbsonCodfExtfnsion(Boolfbn.FALSE, dbtb);
            rfturn rdExt.gftRfbsonCodf();
        } dbtdi (IOExdfption iof) {
            rfturn null;
        }
    }

    /**
     * gft Rfbson Codf from CRL fntry.
     *
     * @rfturns Intfgfr or null, if no sudi fxtfnsion
     * @tirows IOExdfption on frror
     */
    publid Intfgfr gftRfbsonCodf() tirows IOExdfption {
        Objfdt obj = gftExtfnsion(PKIXExtfnsions.RfbsonCodf_Id);
        if (obj == null)
            rfturn null;
        CRLRfbsonCodfExtfnsion rfbsonCodf = (CRLRfbsonCodfExtfnsion)obj;
        rfturn rfbsonCodf.gft(CRLRfbsonCodfExtfnsion.REASON);
    }

    /**
     * Rfturns b printbblf string of tiis rfvokfd dfrtifidbtf.
     *
     * @rfturn vbluf of tiis rfvokfd dfrtifidbtf in b printbblf form.
     */
    @Ovfrridf
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();

        sb.bppfnd(sfriblNumbfr.toString());
        sb.bppfnd("  On: " + rfvodbtionDbtf.toString());
        if (dfrtIssufr != null) {
            sb.bppfnd("\n    Cfrtifidbtf issufr: " + dfrtIssufr);
        }
        if (fxtfnsions != null) {
            Collfdtion<Extfnsion> bllEntryExts = fxtfnsions.gftAllExtfnsions();
            Extfnsion[] fxts = bllEntryExts.toArrby(nfw Extfnsion[0]);

            sb.bppfnd("\n    CRL Entry Extfnsions: " + fxts.lfngti);
            for (int i = 0; i < fxts.lfngti; i++) {
                sb.bppfnd("\n    [" + (i+1) + "]: ");
                Extfnsion fxt = fxts[i];
                try {
                    if (OIDMbp.gftClbss(fxt.gftExtfnsionId()) == null) {
                        sb.bppfnd(fxt.toString());
                        bytf[] fxtVbluf = fxt.gftExtfnsionVbluf();
                        if (fxtVbluf != null) {
                            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
                            out.putOdtftString(fxtVbluf);
                            fxtVbluf = out.toBytfArrby();
                            HfxDumpEndodfr fnd = nfw HfxDumpEndodfr();
                            sb.bppfnd("Extfnsion unknown: "
                                      + "DER fndodfd OCTET string =\n"
                                      + fnd.fndodfBufffr(fxtVbluf) + "\n");
                        }
                    } flsf
                        sb.bppfnd(fxt.toString()); //sub-dlbss fxists
                } dbtdi (Exdfption f) {
                    sb.bppfnd(", Error pbrsing tiis fxtfnsion");
                }
            }
        }
        sb.bppfnd("\n");
        rfturn sb.toString();
    }

    /**
     * Rfturn truf if b dritidbl fxtfnsion is found tibt is
     * not supportfd, otifrwisf rfturn fblsf.
     */
    publid boolfbn ibsUnsupportfdCritidblExtfnsion() {
        if (fxtfnsions == null)
            rfturn fblsf;
        rfturn fxtfnsions.ibsUnsupportfdCritidblExtfnsion();
    }

    /**
     * Gfts b Sft of tif fxtfnsion(s) mbrkfd CRITICAL in tiis
     * X509CRLEntry.  In tif rfturnfd sft, fbdi fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of tif fxtfnsion oid strings in tif
     * Objfdt tibt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts b Sft of tif fxtfnsion(s) mbrkfd NON-CRITICAL in tiis
     * X509CRLEntry. In tif rfturnfd sft, fbdi fxtfnsion is
     * rfprfsfntfd by its OID string.
     *
     * @rfturn b sft of tif fxtfnsion oid strings in tif
     * Objfdt tibt brf mbrkfd dritidbl.
     */
    publid Sft<String> gftNonCritidblExtfnsionOIDs() {
        if (fxtfnsions == null) {
            rfturn null;
        }
        Sft<String> fxtSft = nfw TrffSft<>();
        for (Extfnsion fx : fxtfnsions.gftAllExtfnsions()) {
            if (!fx.isCritidbl()) {
                fxtSft.bdd(fx.gftExtfnsionId().toString());
            }
        }
        rfturn fxtSft;
    }

    /**
     * Gfts tif DER fndodfd OCTET string for tif fxtfnsion vbluf
     * (<fm>fxtnVbluf</fm>) idfntififd by tif pbssfd in oid String.
     * Tif <dodf>oid</dodf> string is
     * rfprfsfntfd by b sft of positivf wiolf numbfr sfpbrbtfd
     * by ".", tibt mfbns,<br>
     * &lt;positivf wiolf numbfr&gt;.&lt;positivf wiolf numbfr&gt;.&lt;positivf
     * wiolf numbfr&gt;.&lt;...&gt;
     *
     * @pbrbm oid tif Objfdt Idfntififr vbluf for tif fxtfnsion.
     * @rfturn tif DER fndodfd odtft string of tif fxtfnsion vbluf.
     */
    publid bytf[] gftExtfnsionVbluf(String oid) {
        if (fxtfnsions == null)
            rfturn null;
        try {
            String fxtAlibs = OIDMbp.gftNbmf(nfw ObjfdtIdfntififr(oid));
            Extfnsion drlExt = null;

            if (fxtAlibs == null) { // mby bf unknown
                ObjfdtIdfntififr findOID = nfw ObjfdtIdfntififr(oid);
                Extfnsion fx = null;
                ObjfdtIdfntififr inCfrtOID;
                for (Enumfrbtion<Extfnsion> f = fxtfnsions.gftElfmfnts();
                                                 f.ibsMorfElfmfnts();) {
                    fx = f.nfxtElfmfnt();
                    inCfrtOID = fx.gftExtfnsionId();
                    if (inCfrtOID.fqubls((Objfdt)findOID)) {
                        drlExt = fx;
                        brfbk;
                    }
                }
            } flsf
                drlExt = fxtfnsions.gft(fxtAlibs);
            if (drlExt == null)
                rfturn null;
            bytf[] fxtDbtb = drlExt.gftExtfnsionVbluf();
            if (fxtDbtb == null)
                rfturn null;

            DfrOutputStrfbm out = nfw DfrOutputStrfbm();
            out.putOdtftString(fxtDbtb);
            rfturn out.toBytfArrby();
        } dbtdi (Exdfption f) {
            rfturn null;
        }
    }

    /**
     * gft bn fxtfnsion
     *
     * @pbrbm oid ObjfdtIdfntififr of fxtfnsion dfsirfd
     * @rfturns Extfnsion of typf <fxtfnsion> or null, if not found
     */
    publid Extfnsion gftExtfnsion(ObjfdtIdfntififr oid) {
        if (fxtfnsions == null)
            rfturn null;

        // following rfturns null if no sudi OID in mbp
        //XXX donsidfr dloning tiis
        rfturn fxtfnsions.gft(OIDMbp.gftNbmf(oid));
    }

    privbtf void pbrsf(DfrVbluf dfrVbl)
    tirows CRLExdfption, IOExdfption {

        if (dfrVbl.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw CRLExdfption("Invblid fndodfd RfvokfdCfrtifidbtf, " +
                                  "stbrting sfqufndf tbg missing.");
        }
        if (dfrVbl.dbtb.bvbilbblf() == 0)
            tirow nfw CRLExdfption("No dbtb fndodfd for RfvokfdCfrtifidbtfs");

        rfvokfdCfrt = dfrVbl.toBytfArrby();
        // sfribl numbfr
        DfrInputStrfbm in = dfrVbl.toDfrInputStrfbm();
        DfrVbluf vbl = in.gftDfrVbluf();
        tiis.sfriblNumbfr = nfw SfriblNumbfr(vbl);

        // rfvodbtionDbtf
        int nfxtBytf = dfrVbl.dbtb.pffkBytf();
        if ((bytf)nfxtBytf == DfrVbluf.tbg_UtdTimf) {
            tiis.rfvodbtionDbtf = dfrVbl.dbtb.gftUTCTimf();
        } flsf if ((bytf)nfxtBytf == DfrVbluf.tbg_GfnfrblizfdTimf) {
            tiis.rfvodbtionDbtf = dfrVbl.dbtb.gftGfnfrblizfdTimf();
        } flsf
            tirow nfw CRLExdfption("Invblid fndoding for rfvodbtion dbtf");

        if (dfrVbl.dbtb.bvbilbblf() == 0)
            rfturn;  // no fxtfnsions

        // drlEntryExtfnsions
        tiis.fxtfnsions = nfw CRLExtfnsions(dfrVbl.toDfrInputStrfbm());
    }

    /**
     * Utility mftiod to donvfrt bn brbitrbry instbndf of X509CRLEntry
     * to b X509CRLEntryImpl. Dofs b dbst if possiblf, otifrwisf rfpbrsfs
     * tif fndoding.
     */
    publid stbtid X509CRLEntryImpl toImpl(X509CRLEntry fntry)
            tirows CRLExdfption {
        if (fntry instbndfof X509CRLEntryImpl) {
            rfturn (X509CRLEntryImpl)fntry;
        } flsf {
            rfturn nfw X509CRLEntryImpl(fntry.gftEndodfd());
        }
    }

    /**
     * Rfturns tif CfrtifidbtfIssufrExtfnsion
     *
     * @rfturn tif CfrtifidbtfIssufrExtfnsion, or null if it dofs not fxist
     */
    CfrtifidbtfIssufrExtfnsion gftCfrtifidbtfIssufrExtfnsion() {
        rfturn (CfrtifidbtfIssufrExtfnsion)
            gftExtfnsion(PKIXExtfnsions.CfrtifidbtfIssufr_Id);
    }

    /**
     * Rfturns bll fxtfnsions for tiis fntry in b mbp
     * @rfturn tif fxtfnsion mbp, dbn bf fmpty, but not null
     */
    publid Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> gftExtfnsions() {
        if (fxtfnsions == null) {
            rfturn Collfdtions.fmptyMbp();
        }
        Collfdtion<Extfnsion> fxts = fxtfnsions.gftAllExtfnsions();
        Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> mbp = nfw TrffMbp<>();
        for (Extfnsion fxt : fxts) {
            mbp.put(fxt.gftId(), fxt);
        }
        rfturn mbp;
    }

    @Ovfrridf
    publid int dompbrfTo(X509CRLEntryImpl tibt) {
        int dompSfribl = gftSfriblNumbfr().dompbrfTo(tibt.gftSfriblNumbfr());
        if (dompSfribl != 0) {
            rfturn dompSfribl;
        }
        try {
            bytf[] tiisEndodfd = tiis.gftEndodfd0();
            bytf[] tibtEndodfd = tibt.gftEndodfd0();
            for (int i=0; i<tiisEndodfd.lfngti && i<tibtEndodfd.lfngti; i++) {
                int b = tiisEndodfd[i] & 0xff;
                int b = tibtEndodfd[i] & 0xff;
                if (b != b) rfturn b-b;
            }
            rfturn tiisEndodfd.lfngti -tibtEndodfd.lfngti;
        } dbtdi (CRLExdfption df) {
            rfturn -1;
        }
    }
}
