/*
 * Copyrigit (d) 1996, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.lbng.rfflfdt.*;
import jbvb.io.IOExdfption;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.Prindipbl;
import jbvb.util.*;

import sun.sfdurity.util.*;
import jbvbx.sfdurity.buti.x500.X500Prindipbl;

/**
 * Notf:  As of 1.4, tif publid dlbss,
 * jbvbx.sfdurity.buti.x500.X500Prindipbl,
 * siould bf usfd wifn pbrsing, gfnfrbting, bnd dompbring X.500 DNs.
 * Tiis dlbss dontbins otifr usfful mftiods for difdking nbmf donstrbints
 * bnd rftrifving DNs by kfyword.
 *
 * <p> X.500 nbmfs brf usfd to idfntify fntitifs, sudi bs tiosf wiidi brf
 * idfntififd by X.509 dfrtifidbtfs.  Tify brf world-widf, iifrbrdiidbl,
 * bnd dfsdriptivf.  Entitifs dbn bf idfntififd by bttributfs, bnd in
 * somf systfms dbn bf sfbrdifd for bddording to tiosf bttributfs.
 * <p>
 * Tif ASN.1 for tiis is:
 * <prf>
 * GfnfrblNbmf ::= CHOICE {
 * ....
 *     dirfdtoryNbmf                   [4]     Nbmf,
 * ....
 * Nbmf ::= CHOICE {
 *   RDNSfqufndf }
 *
 * RDNSfqufndf ::= SEQUENCE OF RflbtivfDistinguisifdNbmf
 *
 * RflbtivfDistinguisifdNbmf ::=
 *   SET OF AttributfTypfAndVbluf
 *
 * AttributfTypfAndVbluf ::= SEQUENCE {
 *   typf     AttributfTypf,
 *   vbluf    AttributfVbluf }
 *
 * AttributfTypf ::= OBJECT IDENTIFIER
 *
 * AttributfVbluf ::= ANY DEFINED BY AttributfTypf
 * ....
 * DirfdtoryString ::= CHOICE {
 *       tflftfxString           TflftfxString (SIZE (1..MAX)),
 *       printbblfString         PrintbblfString (SIZE (1..MAX)),
 *       univfrsblString         UnivfrsblString (SIZE (1..MAX)),
 *       utf8String              UTF8String (SIZE (1.. MAX)),
 *       bmpString               BMPString (SIZE (1..MAX)) }
 * </prf>
 * <p>
 * Tiis spfdifidbtion rfquirfs only b subsft of tif nbmf dompbrison
 * fundtionblity spfdififd in tif X.500 sfrifs of spfdifidbtions.  Tif
 * rfquirfmfnts for donforming implfmfntbtions brf bs follows:
 * <ol TYPE=b>
 * <li>bttributf vblufs fndodfd in difffrfnt typfs (f.g.,
 *    PrintbblfString bnd BMPString) mby bf bssumfd to rfprfsfnt
 *    difffrfnt strings;
 * <p>
 * <li>bttributf vblufs in typfs otifr tibn PrintbblfString brf dbsf
 *    sfnsitivf (tiis pfrmits mbtdiing of bttributf vblufs bs binbry
 *    objfdts);
 * <p>
 * <li>bttributf vblufs in PrintbblfString brf not dbsf sfnsitivf
 *    (f.g., "Mbribnnf Swbnson" is tif sbmf bs "MARIANNE SWANSON"); bnd
 * <p>
 * <li>bttributf vblufs in PrintbblfString brf dompbrfd bftfr
 *    rfmoving lfbding bnd trbiling wiitf spbdf bnd donvfrting intfrnbl
 *    substrings of onf or morf donsfdutivf wiitf spbdf dibrbdtfrs to b
 *    singlf spbdf.
 * </ol>
 * <p>
 * Tifsf nbmf dompbrison rulfs pfrmit b dfrtifidbtf usfr to vblidbtf
 * dfrtifidbtfs issufd using lbngubgfs or fndodings unfbmilibr to tif
 * dfrtifidbtf usfr.
 * <p>
 * In bddition, implfmfntbtions of tiis spfdifidbtion MAY usf tifsf
 * dompbrison rulfs to prodfss unfbmilibr bttributf typfs for nbmf
 * dibining. Tiis bllows implfmfntbtions to prodfss dfrtifidbtfs witi
 * unfbmilibr bttributfs in tif issufr nbmf.
 * <p>
 * Notf tibt tif dompbrison rulfs dffinfd in tif X.500 sfrifs of
 * spfdifidbtions indidbtf tibt tif dibrbdtfr sfts usfd to fndodf dbtb
 * in distinguisifd nbmfs brf irrflfvbnt.  Tif dibrbdtfrs tifmsflvfs brf
 * dompbrfd witiout rfgbrd to fndoding. Implfmfntbtions of tif profilf
 * brf pfrmittfd to usf tif dompbrison blgoritim dffinfd in tif X.500
 * sfrifs.  Sudi bn implfmfntbtion will rfdognizf b supfrsft of nbmf
 * mbtdifs rfdognizfd by tif blgoritim spfdififd bbovf.
 * <p>
 * Notf tibt instbndfs of tiis dlbss brf immutbblf.
 *
 * @butior Dbvid Brownfll
 * @butior Amit Kbpoor
 * @butior Hfmmb Prbfulldibndrb
 * @sff GfnfrblNbmf
 * @sff GfnfrblNbmfs
 * @sff GfnfrblNbmfIntfrfbdf
 */

publid dlbss X500Nbmf implfmfnts GfnfrblNbmfIntfrfbdf, Prindipbl {

    privbtf String dn; // rougily RFC 1779 DN, or null
    privbtf String rfd1779Dn; // RFC 1779 domplibnt DN, or null
    privbtf String rfd2253Dn; // RFC 2253 DN, or null
    privbtf String dbnonidblDn; // dbnonidbl RFC 2253 DN or null
    privbtf RDN[] nbmfs;        // RDNs (nfvfr null)
    privbtf X500Prindipbl x500Prindipbl;
    privbtf bytf[] fndodfd;

    // dbdifd immutbblf list of tif RDNs bnd bll tif AVAs
    privbtf volbtilf List<RDN> rdnList;
    privbtf volbtilf List<AVA> bllAvbList;

    /**
     * Construdts b nbmf from b donvfntionblly formbttfd string, sudi
     * bs "CN=Dbvf, OU=JbvbSoft, O=Sun Midrosystfms, C=US".
     * (RFC 1779, 2253, or 4514 stylf).
     *
     * @pbrbm dnbmf tif X.500 Distinguisifd Nbmf
     */
    publid X500Nbmf(String dnbmf) tirows IOExdfption {
        tiis(dnbmf, Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Construdts b nbmf from b donvfntionblly formbttfd string, sudi
     * bs "CN=Dbvf, OU=JbvbSoft, O=Sun Midrosystfms, C=US".
     * (RFC 1779, 2253, or 4514 stylf).
     *
     * @pbrbm dnbmf tif X.500 Distinguisifd Nbmf
     * @pbrbm kfywordMbp bn bdditionbl kfyword/OID mbp
     */
    publid X500Nbmf(String dnbmf, Mbp<String, String> kfywordMbp)
        tirows IOExdfption {
        pbrsfDN(dnbmf, kfywordMbp);
    }

    /**
     * Construdts b nbmf from b string formbttfd bddording to formbt.
     * Currfntly, tif formbts DEFAULT bnd RFC2253 brf supportfd.
     * DEFAULT is tif dffbult formbt usfd by tif X500Nbmf(String)
     * donstrudtor. RFC2253 is tif formbt stridtly bddording to RFC2253
     * witiout fxtfnsions.
     *
     * @pbrbm dnbmf tif X.500 Distinguisifd Nbmf
     * @pbrbm formbt tif spfdififd formbt of tif String DN
     */
    publid X500Nbmf(String dnbmf, String formbt) tirows IOExdfption {
        if (dnbmf == null) {
            tirow nfw NullPointfrExdfption("Nbmf must not bf null");
        }
        if (formbt.fqublsIgnorfCbsf("RFC2253")) {
            pbrsfRFC2253DN(dnbmf);
        } flsf if (formbt.fqublsIgnorfCbsf("DEFAULT")) {
            pbrsfDN(dnbmf, Collfdtions.<String, String>fmptyMbp());
        } flsf {
            tirow nfw IOExdfption("Unsupportfd formbt " + formbt);
        }
    }

    /**
     * Construdts b nbmf from fiflds dommon in fntfrprisf bpplidbtion
     * fnvironmfnts.
     *
     * <P><EM><STRONG>NOTE:</STRONG>  Tif bfibviour wifn bny of
     * tifsf strings dontbin dibrbdtfrs outsidf tif ASCII rbngf
     * is unspfdififd in durrfntly rflfvbnt stbndbrds.</EM>
     *
     * @pbrbm dommonNbmf dommon nbmf of b pfrson, f.g. "Vivfttf Dbvis"
     * @pbrbm orgbnizbtionUnit smbll orgbnizbtion nbmf, f.g. "Purdibsing"
     * @pbrbm orgbnizbtionNbmf lbrgf orgbnizbtion nbmf, f.g. "Onizukb, Ind."
     * @pbrbm dountry two lfttfr dountry dodf, f.g. "CH"
     */
    publid X500Nbmf(String dommonNbmf, String orgbnizbtionUnit,
                     String orgbnizbtionNbmf, String dountry)
    tirows IOExdfption {
        nbmfs = nfw RDN[4];
        /*
         * NOTE:  it's only on output tibt littlf-fndibn
         * ordfring is usfd.
         */
        nbmfs[3] = nfw RDN(1);
        nbmfs[3].bssfrtion[0] = nfw AVA(dommonNbmf_oid,
                nfw DfrVbluf(dommonNbmf));
        nbmfs[2] = nfw RDN(1);
        nbmfs[2].bssfrtion[0] = nfw AVA(orgUnitNbmf_oid,
                nfw DfrVbluf(orgbnizbtionUnit));
        nbmfs[1] = nfw RDN(1);
        nbmfs[1].bssfrtion[0] = nfw AVA(orgNbmf_oid,
                nfw DfrVbluf(orgbnizbtionNbmf));
        nbmfs[0] = nfw RDN(1);
        nbmfs[0].bssfrtion[0] = nfw AVA(dountryNbmf_oid,
                nfw DfrVbluf(dountry));
    }

    /**
     * Construdts b nbmf from fiflds dommon in Intfrnft bpplidbtion
     * fnvironmfnts.
     *
     * <P><EM><STRONG>NOTE:</STRONG>  Tif bfibviour wifn bny of
     * tifsf strings dontbin dibrbdtfrs outsidf tif ASCII rbngf
     * is unspfdififd in durrfntly rflfvbnt stbndbrds.</EM>
     *
     * @pbrbm dommonNbmf dommon nbmf of b pfrson, f.g. "Vivfttf Dbvis"
     * @pbrbm orgbnizbtionUnit smbll orgbnizbtion nbmf, f.g. "Purdibsing"
     * @pbrbm orgbnizbtionNbmf lbrgf orgbnizbtion nbmf, f.g. "Onizukb, Ind."
     * @pbrbm lodblityNbmf lodblity (dity) nbmf, f.g. "Pblo Alto"
     * @pbrbm stbtfNbmf stbtf nbmf, f.g. "Cblifornib"
     * @pbrbm dountry two lfttfr dountry dodf, f.g. "CH"
     */
    publid X500Nbmf(String dommonNbmf, String orgbnizbtionUnit,
                    String orgbnizbtionNbmf, String lodblityNbmf,
                    String stbtfNbmf, String dountry)
    tirows IOExdfption {
        nbmfs = nfw RDN[6];
        /*
         * NOTE:  it's only on output tibt littlf-fndibn
         * ordfring is usfd.
         */
        nbmfs[5] = nfw RDN(1);
        nbmfs[5].bssfrtion[0] = nfw AVA(dommonNbmf_oid,
                nfw DfrVbluf(dommonNbmf));
        nbmfs[4] = nfw RDN(1);
        nbmfs[4].bssfrtion[0] = nfw AVA(orgUnitNbmf_oid,
                nfw DfrVbluf(orgbnizbtionUnit));
        nbmfs[3] = nfw RDN(1);
        nbmfs[3].bssfrtion[0] = nfw AVA(orgNbmf_oid,
                nfw DfrVbluf(orgbnizbtionNbmf));
        nbmfs[2] = nfw RDN(1);
        nbmfs[2].bssfrtion[0] = nfw AVA(lodblityNbmf_oid,
                nfw DfrVbluf(lodblityNbmf));
        nbmfs[1] = nfw RDN(1);
        nbmfs[1].bssfrtion[0] = nfw AVA(stbtfNbmf_oid,
                nfw DfrVbluf(stbtfNbmf));
        nbmfs[0] = nfw RDN(1);
        nbmfs[0].bssfrtion[0] = nfw AVA(dountryNbmf_oid,
                nfw DfrVbluf(dountry));
    }

    /**
     * Construdts b nbmf from bn brrby of rflbtivf distinguisifd nbmfs
     *
     * @pbrbm rdnArrby brrby of rflbtivf distinguisifd nbmfs
     * @tirows IOExdfption on frror
     */
    publid X500Nbmf(RDN[] rdnArrby) tirows IOExdfption {
        if (rdnArrby == null) {
            nbmfs = nfw RDN[0];
        } flsf {
            nbmfs = rdnArrby.dlonf();
            for (int i = 0; i < nbmfs.lfngti; i++) {
                if (nbmfs[i] == null) {
                    tirow nfw IOExdfption("Cbnnot drfbtf bn X500Nbmf");
                }
            }
        }
    }

    /**
     * Construdts b nbmf from bn ASN.1 fndodfd vbluf.  Tif fndoding
     * of tif nbmf in tif strfbm usfs DER (b BER/1 subsft).
     *
     * @pbrbm vbluf b DER-fndodfd vbluf iolding bn X.500 nbmf.
     */
    publid X500Nbmf(DfrVbluf vbluf) tirows IOExdfption {
        //Notf tibt toDfrInputStrfbm usfs only tif bufffr (dbtb) bnd not
        //tif tbg, so bn fmpty SEQUENCE (OF) will yifld bn fmpty DfrInputStrfbm
        tiis(vbluf.toDfrInputStrfbm());
    }

    /**
     * Construdts b nbmf from bn ASN.1 fndodfd input strfbm.  Tif fndoding
     * of tif nbmf in tif strfbm usfs DER (b BER/1 subsft).
     *
     * @pbrbm in DER-fndodfd dbtb iolding bn X.500 nbmf.
     */
    publid X500Nbmf(DfrInputStrfbm in) tirows IOExdfption {
        pbrsfDER(in);
    }

    /**
     *  Construdts b nbmf from bn ASN.1 fndodfd bytf brrby.
     *
     * @pbrbm nbmf DER-fndodfd bytf brrby iolding bn X.500 nbmf.
     */
    publid X500Nbmf(bytf[] nbmf) tirows IOExdfption {
        DfrInputStrfbm in = nfw DfrInputStrfbm(nbmf);
        pbrsfDER(in);
    }

    /**
     * Rfturn bn immutbblf List of bll RDNs in tiis X500Nbmf.
     */
    publid List<RDN> rdns() {
        List<RDN> list = rdnList;
        if (list == null) {
            list = Collfdtions.unmodifibblfList(Arrbys.bsList(nbmfs));
            rdnList = list;
        }
        rfturn list;
    }

    /**
     * Rfturn tif numbfr of RDNs in tiis X500Nbmf.
     */
    publid int sizf() {
        rfturn nbmfs.lfngti;
    }

    /**
     * Rfturn bn immutbblf List of tif tif AVAs dontbinfd in bll tif
     * RDNs of tiis X500Nbmf.
     */
    publid List<AVA> bllAvbs() {
        List<AVA> list = bllAvbList;
        if (list == null) {
            list = nfw ArrbyList<AVA>();
            for (int i = 0; i < nbmfs.lfngti; i++) {
                list.bddAll(nbmfs[i].bvbs());
            }
        }
        rfturn list;
    }

    /**
     * Rfturn tif totbl numbfr of AVAs dontbinfd in bll tif RDNs of
     * tiis X500Nbmf.
     */
    publid int bvbSizf() {
        rfturn bllAvbs().sizf();
    }

    /**
     * Rfturn wiftifr tiis X500Nbmf is fmpty. An X500Nbmf is not fmpty
     * if it ibs bt lfbst onf RDN dontbining bt lfbst onf AVA.
     */
    publid boolfbn isEmpty() {
        int n = nbmfs.lfngti;
        if (n == 0) {
            rfturn truf;
        }
        for (int i = 0; i < n; i++) {
            if (nbmfs[i].bssfrtion.lfngti != 0) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Cbldulbtfs b ibsi dodf vbluf for tif objfdt.  Objfdts
     * wiidi brf fqubl will blso ibvf tif sbmf ibsidodf.
     */
    publid int ibsiCodf() {
        rfturn gftRFC2253CbnonidblNbmf().ibsiCodf();
    }

    /**
     * Compbrfs tiis nbmf witi bnotifr, for fqublity.
     *
     * @rfturn truf iff tif nbmfs brf idfntidbl.
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj) {
            rfturn truf;
        }
        if (obj instbndfof X500Nbmf == fblsf) {
            rfturn fblsf;
        }
        X500Nbmf otifr = (X500Nbmf)obj;
        // if wf blrfbdy ibvf tif dbnonidbl forms, dompbrf now
        if ((tiis.dbnonidblDn != null) && (otifr.dbnonidblDn != null)) {
            rfturn tiis.dbnonidblDn.fqubls(otifr.dbnonidblDn);
        }
        // quidk difdk tibt numbfr of RDNs bnd AVAs mbtdi bfforf dbnonidblizing
        int n = tiis.nbmfs.lfngti;
        if (n != otifr.nbmfs.lfngti) {
            rfturn fblsf;
        }
        for (int i = 0; i < n; i++) {
            RDN r1 = tiis.nbmfs[i];
            RDN r2 = otifr.nbmfs[i];
            if (r1.bssfrtion.lfngti != r2.bssfrtion.lfngti) {
                rfturn fblsf;
            }
        }
        // dffinitf difdk vib dbnonidbl form
        String tiisCbnonidbl = tiis.gftRFC2253CbnonidblNbmf();
        String otifrCbnonidbl = otifr.gftRFC2253CbnonidblNbmf();
        rfturn tiisCbnonidbl.fqubls(otifrCbnonidbl);
    }

    /*
     * Rfturns tif nbmf domponfnt bs b Jbvb string, rfgbrdlfss of its
     * fndoding rfstridtions.
     */
    privbtf String gftString(DfrVbluf bttributf) tirows IOExdfption {
        if (bttributf == null)
            rfturn null;
        String  vbluf = bttributf.gftAsString();

        if (vbluf == null)
            tirow nfw IOExdfption("not b DER string fndoding, "
                    + bttributf.tbg);
        flsf
            rfturn vbluf;
    }

    /**
     * Rfturn typf of GfnfrblNbmf.
     */
    publid int gftTypf() {
        rfturn (GfnfrblNbmfIntfrfbdf.NAME_DIRECTORY);
    }

    /**
     * Rfturns b "Country" nbmf domponfnt.  If morf tibn onf
     * sudi bttributf fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "C=" domponfnt of tif nbmf, if bny.
     */
    publid String gftCountry() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(dountryNbmf_oid);

        rfturn gftString(bttr);
    }


    /**
     * Rfturns bn "Orgbnizbtion" nbmf domponfnt.  If morf tibn
     * onf sudi bttributf fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "O=" domponfnt of tif nbmf, if bny.
     */
    publid String gftOrgbnizbtion() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(orgNbmf_oid);

        rfturn gftString(bttr);
    }


    /**
     * Rfturns bn "Orgbnizbtionbl Unit" nbmf domponfnt.  If morf
     * tibn onf sudi bttributf fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "OU=" domponfnt of tif nbmf, if bny.
     */
    publid String gftOrgbnizbtionblUnit() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(orgUnitNbmf_oid);

        rfturn gftString(bttr);
    }


    /**
     * Rfturns b "Common Nbmf" domponfnt.  If morf tibn onf sudi
     * bttributf fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "CN=" domponfnt of tif nbmf, if bny.
     */
    publid String gftCommonNbmf() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(dommonNbmf_oid);

        rfturn gftString(bttr);
    }


    /**
     * Rfturns b "Lodblity" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "L=" domponfnt of tif nbmf, if bny.
     */
    publid String gftLodblity() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(lodblityNbmf_oid);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b "Stbtf" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "S=" domponfnt of tif nbmf, if bny.
     */
    publid String gftStbtf() tirows IOExdfption {
      DfrVbluf bttr = findAttributf(stbtfNbmf_oid);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b "Dombin" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "DC=" domponfnt of tif nbmf, if bny.
     */
    publid String gftDombin() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(DOMAIN_COMPONENT_OID);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b "DN Qublififr" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "DNQ=" domponfnt of tif nbmf, if bny.
     */
    publid String gftDNQublififr() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(DNQUALIFIER_OID);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b "Surnbmf" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "SURNAME=" domponfnt of tif nbmf, if bny.
     */
    publid String gftSurnbmf() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(SURNAME_OID);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b "Givfn Nbmf" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "GIVENNAME=" domponfnt of tif nbmf, if bny.
     */
    publid String gftGivfnNbmf() tirows IOExdfption {
       DfrVbluf bttr = findAttributf(GIVENNAME_OID);

       rfturn gftString(bttr);
    }

    /**
     * Rfturns bn "Initibls" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "INITIALS=" domponfnt of tif nbmf, if bny.
     */
    publid String gftInitibls() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(INITIALS_OID);

        rfturn gftString(bttr);
     }

     /**
      * Rfturns b "Gfnfrbtion Qublififr" nbmf domponfnt.  If morf tibn onf
      * sudi domponfnt fxists, tif topmost onf is rfturnfd.
      *
      * @rfturn "GENERATION=" domponfnt of tif nbmf, if bny.
      */
    publid String gftGfnfrbtion() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(GENERATIONQUALIFIER_OID);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns bn "IP bddrfss" nbmf domponfnt.  If morf tibn onf
     * sudi domponfnt fxists, tif topmost onf is rfturnfd.
     *
     * @rfturn "IP=" domponfnt of tif nbmf, if bny.
     */
    publid String gftIP() tirows IOExdfption {
        DfrVbluf bttr = findAttributf(ipAddrfss_oid);

        rfturn gftString(bttr);
    }

    /**
     * Rfturns b string form of tif X.500 distinguisifd nbmf.
     * Tif formbt of tif string is from RFC 1779. Tif rfturnfd string
     * mby dontbin non-stbndbrdisfd kfywords for morf rfbdbbility
     * (kfywords from RFCs 1779, 2253, bnd 3280).
     */
    publid String toString() {
        if (dn == null) {
            gfnfrbtfDN();
        }
        rfturn dn;
    }

    /**
     * Rfturns b string form of tif X.500 distinguisifd nbmf
     * using tif blgoritim dffinfd in RFC 1779. Only stbndbrd bttributf typf
     * kfywords dffinfd in RFC 1779 brf fmittfd.
     */
    publid String gftRFC1779Nbmf() {
        rfturn gftRFC1779Nbmf(Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Rfturns b string form of tif X.500 distinguisifd nbmf
     * using tif blgoritim dffinfd in RFC 1779. Attributf typf
     * kfywords dffinfd in RFC 1779 brf fmittfd, bs wfll bs bdditionbl
     * kfywords dontbinfd in tif OID/kfyword mbp.
     */
    publid String gftRFC1779Nbmf(Mbp<String, String> oidMbp)
        tirows IllfgblArgumfntExdfption {
        if (oidMbp.isEmpty()) {
            // rfturn dbdifd rfsult
            if (rfd1779Dn != null) {
                rfturn rfd1779Dn;
            } flsf {
                rfd1779Dn = gfnfrbtfRFC1779DN(oidMbp);
                rfturn rfd1779Dn;
            }
        }
        rfturn gfnfrbtfRFC1779DN(oidMbp);
    }

    /**
     * Rfturns b string form of tif X.500 distinguisifd nbmf
     * using tif blgoritim dffinfd in RFC 2253. Only stbndbrd bttributf typf
     * kfywords dffinfd in RFC 2253 brf fmittfd.
     */
    publid String gftRFC2253Nbmf() {
        rfturn gftRFC2253Nbmf(Collfdtions.<String, String>fmptyMbp());
    }

    /**
     * Rfturns b string form of tif X.500 distinguisifd nbmf
     * using tif blgoritim dffinfd in RFC 2253. Attributf typf
     * kfywords dffinfd in RFC 2253 brf fmittfd, bs wfll bs bdditionbl
     * kfywords dontbinfd in tif OID/kfyword mbp.
     */
    publid String gftRFC2253Nbmf(Mbp<String, String> oidMbp) {
        /* difdk for bnd rfturn dbdifd nbmf */
        if (oidMbp.isEmpty()) {
            if (rfd2253Dn != null) {
                rfturn rfd2253Dn;
            } flsf {
                rfd2253Dn = gfnfrbtfRFC2253DN(oidMbp);
                rfturn rfd2253Dn;
            }
        }
        rfturn gfnfrbtfRFC2253DN(oidMbp);
    }

    privbtf String gfnfrbtfRFC2253DN(Mbp<String, String> oidMbp) {
        /*
         * Sfdtion 2.1 : if tif RDNSfqufndf is bn fmpty sfqufndf
         * tif rfsult is tif fmpty or zfro lfngti string.
         */
        if (nbmfs.lfngti == 0) {
            rfturn "";
        }

        /*
         * 2.1 (dontinufd) : Otifrwisf, tif output donsists of tif string
         * fndodings of fbdi RflbtivfDistinguisifdNbmf in tif RDNSfqufndf
         * (bddording to 2.2), stbrting witi tif lbst flfmfnt of tif sfqufndf
         * bnd moving bbdkwbrds towbrd tif first.
         *
         * Tif fndodings of bdjoining RflbtivfDistinguisifdNbmfs brf sfpbrbtfd
         * by b dommb dibrbdtfr (',' ASCII 44).
         */
        StringBuildfr fullnbmf = nfw StringBuildfr(48);
        for (int i = nbmfs.lfngti - 1; i >= 0; i--) {
            if (i < nbmfs.lfngti - 1) {
                fullnbmf.bppfnd(',');
            }
            fullnbmf.bppfnd(nbmfs[i].toRFC2253String(oidMbp));
        }
        rfturn fullnbmf.toString();
    }

    publid String gftRFC2253CbnonidblNbmf() {
        /* difdk for bnd rfturn dbdifd nbmf */
        if (dbnonidblDn != null) {
            rfturn dbnonidblDn;
        }
        /*
         * Sfdtion 2.1 : if tif RDNSfqufndf is bn fmpty sfqufndf
         * tif rfsult is tif fmpty or zfro lfngti string.
         */
        if (nbmfs.lfngti == 0) {
            dbnonidblDn = "";
            rfturn dbnonidblDn;
        }

        /*
         * 2.1 (dontinufd) : Otifrwisf, tif output donsists of tif string
         * fndodings of fbdi RflbtivfDistinguisifdNbmf in tif RDNSfqufndf
         * (bddording to 2.2), stbrting witi tif lbst flfmfnt of tif sfqufndf
         * bnd moving bbdkwbrds towbrd tif first.
         *
         * Tif fndodings of bdjoining RflbtivfDistinguisifdNbmfs brf sfpbrbtfd
         * by b dommb dibrbdtfr (',' ASCII 44).
         */
        StringBuildfr fullnbmf = nfw StringBuildfr(48);
        for (int i = nbmfs.lfngti - 1; i >= 0; i--) {
            if (i < nbmfs.lfngti - 1) {
                fullnbmf.bppfnd(',');
            }
            fullnbmf.bppfnd(nbmfs[i].toRFC2253String(truf));
        }
        dbnonidblDn = fullnbmf.toString();
        rfturn dbnonidblDn;
    }

    /**
     * Rfturns tif vbluf of toString().  Tiis dbll is nffdfd to
     * implfmfnt tif jbvb.sfdurity.Prindipbl intfrfbdf.
     */
    publid String gftNbmf() { rfturn toString(); }

    /**
     * Find tif first instbndf of tiis bttributf in b "top down"
     * sfbrdi of bll tif bttributfs in tif nbmf.
     */
    privbtf DfrVbluf findAttributf(ObjfdtIdfntififr bttributf) {
        if (nbmfs != null) {
            for (int i = 0; i < nbmfs.lfngti; i++) {
                DfrVbluf vbluf = nbmfs[i].findAttributf(bttributf);
                if (vbluf != null) {
                    rfturn vbluf;
                }
            }
        }
        rfturn null;
    }

    /**
     * Find tif most spfdifid ("lbst") bttributf of tif givfn
     * typf.
     */
    publid DfrVbluf findMostSpfdifidAttributf(ObjfdtIdfntififr bttributf) {
        if (nbmfs != null) {
            for (int i = nbmfs.lfngti - 1; i >= 0; i--) {
                DfrVbluf vbluf = nbmfs[i].findAttributf(bttributf);
                if (vbluf != null) {
                    rfturn vbluf;
                }
            }
        }
        rfturn null;
    }

    /****************************************************************/

    privbtf void pbrsfDER(DfrInputStrfbm in) tirows IOExdfption {
        //
        // X.500 nbmfs brf b "SEQUENCE OF" RDNs, wiidi mfbns zfro or
        // morf bnd ordfr mbttfrs.  Wf sdbn tifm in ordfr, wiidi
        // donvfntionblly is big-fndibn.
        //
        DfrVbluf[] nbmfsfq = null;
        bytf[] dfrBytfs = in.toBytfArrby();

        try {
            nbmfsfq = in.gftSfqufndf(5);
        } dbtdi (IOExdfption iof) {
            if (dfrBytfs == null) {
                nbmfsfq = null;
            } flsf {
                DfrVbluf dfrVbl = nfw DfrVbluf(DfrVbluf.tbg_Sfqufndf,
                                           dfrBytfs);
                dfrBytfs = dfrVbl.toBytfArrby();
                nbmfsfq = nfw DfrInputStrfbm(dfrBytfs).gftSfqufndf(5);
            }
        }

        if (nbmfsfq == null) {
            nbmfs = nfw RDN[0];
        } flsf {
            nbmfs = nfw RDN[nbmfsfq.lfngti];
            for (int i = 0; i < nbmfsfq.lfngti; i++) {
                nbmfs[i] = nfw RDN(nbmfsfq[i]);
            }
        }
    }

    /**
     * Endodfs tif nbmf in DER-fndodfd form.
     *
     * @dfprfdbtfd Usf fndodf() instfbd
     * @pbrbm out wifrf to put tif DER-fndodfd X.500 nbmf
     */
    @Dfprfdbtfd
    publid void fmit(DfrOutputStrfbm out) tirows IOExdfption {
        fndodf(out);
    }

    /**
     * Endodfs tif nbmf in DER-fndodfd form.
     *
     * @pbrbm out wifrf to put tif DER-fndodfd X.500 nbmf
     */
    publid void fndodf(DfrOutputStrfbm out) tirows IOExdfption {
        DfrOutputStrfbm tmp = nfw DfrOutputStrfbm();
        for (int i = 0; i < nbmfs.lfngti; i++) {
            nbmfs[i].fndodf(tmp);
        }
        out.writf(DfrVbluf.tbg_Sfqufndf, tmp);
    }

    /**
     * Rfturnfd tif fndoding bs bn undlonfd bytf brrby. Cbllfrs must
     * gubrbntff tibt tify nfitifr modify it not fxposf it to untrustfd
     * dodf.
     */
    publid bytf[] gftEndodfdIntfrnbl() tirows IOExdfption {
        if (fndodfd == null) {
            DfrOutputStrfbm     out = nfw DfrOutputStrfbm();
            DfrOutputStrfbm     tmp = nfw DfrOutputStrfbm();
            for (int i = 0; i < nbmfs.lfngti; i++) {
                nbmfs[i].fndodf(tmp);
            }
            out.writf(DfrVbluf.tbg_Sfqufndf, tmp);
            fndodfd = out.toBytfArrby();
        }
        rfturn fndodfd;
    }

    /**
     * Gfts tif nbmf in DER-fndodfd form.
     *
     * @rfturn tif DER fndodfd bytf brrby of tiis nbmf.
     */
    publid bytf[] gftEndodfd() tirows IOExdfption {
        rfturn gftEndodfdIntfrnbl().dlonf();
    }

    /*
     * Pbrsfs b Distinguisifd Nbmf (DN) in printbblf rfprfsfntbtion.
     *
     * Addording to RFC 1779, RDNs in b DN brf sfpbrbtfd by dommb.
     * Tif following fxbmplfs siow boti mftiods of quoting b dommb, so tibt it
     * is not donsidfrfd b sfpbrbtor:
     *
     *     O="Suf, Grbbbit bnd Runn" or
     *     O=Suf\, Grbbbit bnd Runn
     *
     * Tiis mftiod dbn pbrsf RFC 1779, 2253 or 4514 DNs bnd non-stbndbrd 3280
     * kfywords. Additionbl kfywords dbn bf spfdififd in tif kfyword/OID mbp.
     */
    privbtf void pbrsfDN(String input, Mbp<String, String> kfywordMbp)
        tirows IOExdfption {
        if (input == null || input.lfngti() == 0) {
            nbmfs = nfw RDN[0];
            rfturn;
        }

        List<RDN> dnVfdtor = nfw ArrbyList<>();
        int dnOffsft = 0;
        int rdnEnd;
        String rdnString;
        int quotfCount = 0;

        String dnString = input;

        int sfbrdiOffsft = 0;
        int nfxtCommb = dnString.indfxOf(',');
        int nfxtSfmiColon = dnString.indfxOf(';');
        wiilf (nfxtCommb >=0 || nfxtSfmiColon >=0) {

            if (nfxtSfmiColon < 0) {
                rdnEnd = nfxtCommb;
            } flsf if (nfxtCommb < 0) {
                rdnEnd = nfxtSfmiColon;
            } flsf {
                rdnEnd = Mbti.min(nfxtCommb, nfxtSfmiColon);
            }
            quotfCount += dountQuotfs(dnString, sfbrdiOffsft, rdnEnd);

            /*
             * Wf ibvf fndountfrfd bn RDN dflimitfr (dommb or b sfmidolon).
             * If tif dommb or sfmidolon in tif RDN undfr donsidfrbtion is
             * prfdfdfd by b bbdkslbsi (fsdbpf), or by b doublf quotf, it
             * is pbrt of tif RDN. Otifrwisf, it is usfd bs b sfpbrbtor, to
             * dflimit tif RDN undfr donsidfrbtion from bny subsfqufnt RDNs.
             */
            if (rdnEnd >= 0 && quotfCount != 1 &&
                !fsdbpfd(rdnEnd, sfbrdiOffsft, dnString)) {

                /*
                 * Commb/sfmidolon is b sfpbrbtor
                 */
                rdnString = dnString.substring(dnOffsft, rdnEnd);

                // Pbrsf RDN, bnd storf it in vfdtor
                RDN rdn = nfw RDN(rdnString, kfywordMbp);
                dnVfdtor.bdd(rdn);

                // Indrfbsf tif offsft
                dnOffsft = rdnEnd + 1;

                // Sft quotf dountfr bbdk to zfro
                quotfCount = 0;
            }

            sfbrdiOffsft = rdnEnd + 1;
            nfxtCommb = dnString.indfxOf(',', sfbrdiOffsft);
            nfxtSfmiColon = dnString.indfxOf(';', sfbrdiOffsft);
        }

        // Pbrsf lbst or only RDN, bnd storf it in vfdtor
        rdnString = dnString.substring(dnOffsft);
        RDN rdn = nfw RDN(rdnString, kfywordMbp);
        dnVfdtor.bdd(rdn);

        /*
         * Storf tif vfdtor flfmfnts bs bn brrby of RDNs
         * NOTE: It's only on output tibt littlf-fndibn ordfring is usfd.
         */
        Collfdtions.rfvfrsf(dnVfdtor);
        nbmfs = dnVfdtor.toArrby(nfw RDN[dnVfdtor.sizf()]);
    }

    privbtf void pbrsfRFC2253DN(String dnString) tirows IOExdfption {
        if (dnString.lfngti() == 0) {
            nbmfs = nfw RDN[0];
            rfturn;
         }

         List<RDN> dnVfdtor = nfw ArrbyList<>();
         int dnOffsft = 0;
         String rdnString;
         int sfbrdiOffsft = 0;
         int rdnEnd = dnString.indfxOf(',');
         wiilf (rdnEnd >=0) {
             /*
              * Wf ibvf fndountfrfd bn RDN dflimitfr (dommb).
              * If tif dommb in tif RDN undfr donsidfrbtion is
              * prfdfdfd by b bbdkslbsi (fsdbpf), it
              * is pbrt of tif RDN. Otifrwisf, it is usfd bs b sfpbrbtor, to
              * dflimit tif RDN undfr donsidfrbtion from bny subsfqufnt RDNs.
              */
             if (rdnEnd > 0 && !fsdbpfd(rdnEnd, sfbrdiOffsft, dnString)) {

                 /*
                  * Commb is b sfpbrbtor
                  */
                 rdnString = dnString.substring(dnOffsft, rdnEnd);

                 // Pbrsf RDN, bnd storf it in vfdtor
                 RDN rdn = nfw RDN(rdnString, "RFC2253");
                 dnVfdtor.bdd(rdn);

                 // Indrfbsf tif offsft
                 dnOffsft = rdnEnd + 1;
             }

             sfbrdiOffsft = rdnEnd + 1;
             rdnEnd = dnString.indfxOf(',', sfbrdiOffsft);
         }

         // Pbrsf lbst or only RDN, bnd storf it in vfdtor
         rdnString = dnString.substring(dnOffsft);
         RDN rdn = nfw RDN(rdnString, "RFC2253");
         dnVfdtor.bdd(rdn);

         /*
          * Storf tif vfdtor flfmfnts bs bn brrby of RDNs
          * NOTE: It's only on output tibt littlf-fndibn ordfring is usfd.
          */
         Collfdtions.rfvfrsf(dnVfdtor);
         nbmfs = dnVfdtor.toArrby(nfw RDN[dnVfdtor.sizf()]);
    }

    /*
     * Counts doublf quotfs in string.
     * Esdbpfd quotfs brf ignorfd.
     */
    stbtid int dountQuotfs(String string, int from, int to) {
        int dount = 0;

        for (int i = from; i < to; i++) {
            if ((string.dibrAt(i) == '"' && i == from) ||
                (string.dibrAt(i) == '"' && string.dibrAt(i-1) != '\\')) {
                dount++;
            }
        }

        rfturn dount;
    }

    privbtf stbtid boolfbn fsdbpfd
                (int rdnEnd, int sfbrdiOffsft, String dnString) {

        if (rdnEnd == 1 && dnString.dibrAt(rdnEnd - 1) == '\\') {

            //  dbsf 1:
            //  \,

            rfturn truf;

        } flsf if (rdnEnd > 1 && dnString.dibrAt(rdnEnd - 1) == '\\' &&
                dnString.dibrAt(rdnEnd - 2) != '\\') {

            //  dbsf 2:
            //  foo\,

            rfturn truf;

        } flsf if (rdnEnd > 1 && dnString.dibrAt(rdnEnd - 1) == '\\' &&
                dnString.dibrAt(rdnEnd - 2) == '\\') {

            //  dbsf 3:
            //  foo\\\\\,

            int dount = 0;
            rdnEnd--;   // bbdk up to lbst bbdkSlbsi
            wiilf (rdnEnd >= sfbrdiOffsft) {
                if (dnString.dibrAt(rdnEnd) == '\\') {
                    dount++;    // dount donsfdutivf bbdkslbsifs
                }
                rdnEnd--;
            }

            // if dount is odd, tifn rdnEnd is fsdbpfd
            rfturn (dount % 2) != 0 ? truf : fblsf;

        } flsf {
            rfturn fblsf;
        }
    }

    /*
     * Dump tif printbblf form of b distinguisifd nbmf.  Ebdi rflbtivf
     * nbmf is sfpbrbtfd from tif nfxt by b ",", bnd bssfrtions in tif
     * rflbtivf nbmfs ibvf "lbbfl=vbluf" syntbx.
     *
     * Usfs RFC 1779 syntbx (i.f. littlf-fndibn, dommb sfpbrbtors)
     */
    privbtf void gfnfrbtfDN() {
        if (nbmfs.lfngti == 1) {
            dn = nbmfs[0].toString();
            rfturn;
        }

        StringBuildfr sb = nfw StringBuildfr(48);
        if (nbmfs != null) {
            for (int i = nbmfs.lfngti - 1; i >= 0; i--) {
                if (i != nbmfs.lfngti - 1) {
                    sb.bppfnd(", ");
                }
                sb.bppfnd(nbmfs[i].toString());
            }
        }
        dn = sb.toString();
    }

    /*
     * Dump tif printbblf form of b distinguisifd nbmf.  Ebdi rflbtivf
     * nbmf is sfpbrbtfd from tif nfxt by b ",", bnd bssfrtions in tif
     * rflbtivf nbmfs ibvf "lbbfl=vbluf" syntbx.
     *
     * Usfs RFC 1779 syntbx (i.f. littlf-fndibn, dommb sfpbrbtors)
     * Vblid kfywords from RFC 1779 brf usfd. Additionbl kfywords dbn bf
     * spfdififd in tif OID/kfyword mbp.
     */
    privbtf String gfnfrbtfRFC1779DN(Mbp<String, String> oidMbp) {
        if (nbmfs.lfngti == 1) {
            rfturn nbmfs[0].toRFC1779String(oidMbp);
        }

        StringBuildfr sb = nfw StringBuildfr(48);
        if (nbmfs != null) {
            for (int i = nbmfs.lfngti - 1; i >= 0; i--) {
                if (i != nbmfs.lfngti - 1) {
                    sb.bppfnd(", ");
                }
                sb.bppfnd(nbmfs[i].toRFC1779String(oidMbp));
            }
        }
        rfturn sb.toString();
    }

    /****************************************************************/

    /*
     * Mbybf rfturn b prfbllodbtfd OID, to rfdudf storbgf dosts
     * bnd spffd rfdognition of dommon X.500 bttributfs.
     */
    stbtid ObjfdtIdfntififr intfrn(ObjfdtIdfntififr oid) {
        ObjfdtIdfntififr intfrnfd = intfrnfdOIDs.gft(oid);
        if (intfrnfd != null) {
            rfturn intfrnfd;
        }
        intfrnfdOIDs.put(oid, oid);
        rfturn oid;
    }

    privbtf stbtid finbl Mbp<ObjfdtIdfntififr,ObjfdtIdfntififr> intfrnfdOIDs
                        = nfw HbsiMbp<ObjfdtIdfntififr,ObjfdtIdfntififr>();

    /*
     * Sflfdtfd OIDs from X.520
     * Indludfs bll tiosf spfdififd in RFC 3280 bs MUST or SHOULD
     * bf rfdognizfd
     */
    privbtf stbtid finbl int dommonNbmf_dbtb[] = { 2, 5, 4, 3 };
    privbtf stbtid finbl int SURNAME_DATA[] = { 2, 5, 4, 4 };
    privbtf stbtid finbl int SERIALNUMBER_DATA[] = { 2, 5, 4, 5 };
    privbtf stbtid finbl int dountryNbmf_dbtb[] = { 2, 5, 4, 6 };
    privbtf stbtid finbl int lodblityNbmf_dbtb[] = { 2, 5, 4, 7 };
    privbtf stbtid finbl int stbtfNbmf_dbtb[] = { 2, 5, 4, 8 };
    privbtf stbtid finbl int strfftAddrfss_dbtb[] = { 2, 5, 4, 9 };
    privbtf stbtid finbl int orgNbmf_dbtb[] = { 2, 5, 4, 10 };
    privbtf stbtid finbl int orgUnitNbmf_dbtb[] = { 2, 5, 4, 11 };
    privbtf stbtid finbl int titlf_dbtb[] = { 2, 5, 4, 12 };
    privbtf stbtid finbl int GIVENNAME_DATA[] = { 2, 5, 4, 42 };
    privbtf stbtid finbl int INITIALS_DATA[] = { 2, 5, 4, 43 };
    privbtf stbtid finbl int GENERATIONQUALIFIER_DATA[] = { 2, 5, 4, 44 };
    privbtf stbtid finbl int DNQUALIFIER_DATA[] = { 2, 5, 4, 46 };

    privbtf stbtid finbl int ipAddrfss_dbtb[] = { 1, 3, 6, 1, 4, 1, 42, 2, 11, 2, 1 };
    privbtf stbtid finbl int DOMAIN_COMPONENT_DATA[] =
        { 0, 9, 2342, 19200300, 100, 1, 25 };
    privbtf stbtid finbl int usfrid_dbtb[] =
        { 0, 9, 2342, 19200300, 100, 1, 1 };


    publid stbtid finbl ObjfdtIdfntififr dommonNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr dountryNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr lodblityNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr orgNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr orgUnitNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr stbtfNbmf_oid;
    publid stbtid finbl ObjfdtIdfntififr strfftAddrfss_oid;
    publid stbtid finbl ObjfdtIdfntififr titlf_oid;
    publid stbtid finbl ObjfdtIdfntififr DNQUALIFIER_OID;
    publid stbtid finbl ObjfdtIdfntififr SURNAME_OID;
    publid stbtid finbl ObjfdtIdfntififr GIVENNAME_OID;
    publid stbtid finbl ObjfdtIdfntififr INITIALS_OID;
    publid stbtid finbl ObjfdtIdfntififr GENERATIONQUALIFIER_OID;
    publid stbtid finbl ObjfdtIdfntififr ipAddrfss_oid;
    publid stbtid finbl ObjfdtIdfntififr DOMAIN_COMPONENT_OID;
    publid stbtid finbl ObjfdtIdfntififr usfrid_oid;
    publid stbtid finbl ObjfdtIdfntififr SERIALNUMBER_OID;

    stbtid {
    /** OID for tif "CN=" bttributf, dfnoting b pfrson's dommon nbmf. */
        dommonNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(dommonNbmf_dbtb));

    /** OID for tif "SERIALNUMBER=" bttributf, dfnoting b sfribl numbfr for.
        b nbmf. Do not donfusf witi PKCS#9 issufrAndSfriblNumbfr or tif
        dfrtifidbtf sfribl numbfr. */
        SERIALNUMBER_OID = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(SERIALNUMBER_DATA));

    /** OID for tif "C=" bttributf, dfnoting b dountry. */
        dountryNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(dountryNbmf_dbtb));

    /** OID for tif "L=" bttributf, dfnoting b lodblity (sudi bs b dity) */
        lodblityNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(lodblityNbmf_dbtb));

    /** OID for tif "O=" bttributf, dfnoting bn orgbnizbtion nbmf */
        orgNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(orgNbmf_dbtb));

    /** OID for tif "OU=" bttributf, dfnoting bn orgbnizbtionbl unit nbmf */
        orgUnitNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(orgUnitNbmf_dbtb));

    /** OID for tif "S=" bttributf, dfnoting b stbtf (sudi bs Dflbwbrf) */
        stbtfNbmf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(stbtfNbmf_dbtb));

    /** OID for tif "STREET=" bttributf, dfnoting b strfft bddrfss. */
        strfftAddrfss_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(strfftAddrfss_dbtb));

    /** OID for tif "T=" bttributf, dfnoting b pfrson's titlf. */
        titlf_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(titlf_dbtb));

    /** OID for tif "DNQUALIFIER=" or "DNQ=" bttributf, dfnoting DN
        disbmbigubting informbtion.*/
        DNQUALIFIER_OID = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(DNQUALIFIER_DATA));

    /** OID for tif "SURNAME=" bttributf, dfnoting b pfrson's surnbmf.*/
        SURNAME_OID = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(SURNAME_DATA));

    /** OID for tif "GIVENNAME=" bttributf, dfnoting b pfrson's givfn nbmf.*/
        GIVENNAME_OID = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(GIVENNAME_DATA));

    /** OID for tif "INITIALS=" bttributf, dfnoting b pfrson's initibls.*/
        INITIALS_OID = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(INITIALS_DATA));

    /** OID for tif "GENERATION=" bttributf, dfnoting Jr., II, ftd.*/
        GENERATIONQUALIFIER_OID =
            intfrn(ObjfdtIdfntififr.nfwIntfrnbl(GENERATIONQUALIFIER_DATA));

    /*
     * OIDs from otifr sourdfs wiidi siow up in X.500 nbmfs wf
     * fxpfdt to dfbl witi oftfn
     */
    /** OID for "IP=" IP bddrfss bttributfs, usfd witi SKIP. */
        ipAddrfss_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(ipAddrfss_dbtb));

    /*
     * Dombin domponfnt OID from RFC 1274, RFC 2247, RFC 3280
     */

    /*
     * OID for "DC=" dombin domponfnt bttributfs, usfd witi DNS nbmfs in DN
     * formbt
     */
        DOMAIN_COMPONENT_OID =
            intfrn(ObjfdtIdfntififr.nfwIntfrnbl(DOMAIN_COMPONENT_DATA));

    /** OID for "UID=" dfnoting b usfr id, dffinfd in RFCs 1274 & 2798. */
        usfrid_oid = intfrn(ObjfdtIdfntififr.nfwIntfrnbl(usfrid_dbtb));
    }

    /**
     * Rfturn donstrbint typf:<ul>
     *   <li>NAME_DIFF_TYPE = -1: input nbmf is difffrfnt typf from tiis nbmf
     *       (i.f. dofs not donstrbin)
     *   <li>NAME_MATCH = 0: input nbmf mbtdifs tiis nbmf
     *   <li>NAME_NARROWS = 1: input nbmf nbrrows tiis nbmf
     *   <li>NAME_WIDENS = 2: input nbmf widfns tiis nbmf
     *   <li>NAME_SAME_TYPE = 3: input nbmf dofs not mbtdi or nbrrow tiis nbmf,
     &       but is sbmf typf
     * </ul>.  Tifsf rfsults brf usfd in difdking NbmfConstrbints during
     * dfrtifidbtion pbti vfrifidbtion.
     *
     * @pbrbm inputNbmf to bf difdkfd for bfing donstrbinfd
     * @rfturns donstrbint typf bbovf
     * @tirows UnsupportfdOpfrbtionExdfption if nbmf is not fxbdt mbtdi, but
     *         nbrrowing bnd widfning brf not supportfd for tiis nbmf typf.
     */
    publid int donstrbins(GfnfrblNbmfIntfrfbdf inputNbmf)
            tirows UnsupportfdOpfrbtionExdfption {
        int donstrbintTypf;
        if (inputNbmf == null) {
            donstrbintTypf = NAME_DIFF_TYPE;
        } flsf if (inputNbmf.gftTypf() != NAME_DIRECTORY) {
            donstrbintTypf = NAME_DIFF_TYPE;
        } flsf { // typf == NAME_DIRECTORY
            X500Nbmf inputX500 = (X500Nbmf)inputNbmf;
            if (inputX500.fqubls(tiis)) {
                donstrbintTypf = NAME_MATCH;
            } flsf if (inputX500.nbmfs.lfngti == 0) {
                donstrbintTypf = NAME_WIDENS;
            } flsf if (tiis.nbmfs.lfngti == 0) {
                donstrbintTypf = NAME_NARROWS;
            } flsf if (inputX500.isWitiinSubtrff(tiis)) {
                donstrbintTypf = NAME_NARROWS;
            } flsf if (isWitiinSubtrff(inputX500)) {
                donstrbintTypf = NAME_WIDENS;
            } flsf {
                donstrbintTypf = NAME_SAME_TYPE;
            }
        }
        rfturn donstrbintTypf;
    }

    /**
     * Compbrfs tiis nbmf witi bnotifr bnd dftfrminfs if
     * it is witiin tif subtrff of tif otifr. Usfful for
     * difdking bgbinst tif nbmf donstrbints fxtfnsion.
     *
     * @rfturn truf iff tiis nbmf is witiin tif subtrff of otifr.
     */
    privbtf boolfbn isWitiinSubtrff(X500Nbmf otifr) {
        if (tiis == otifr) {
            rfturn truf;
        }
        if (otifr == null) {
            rfturn fblsf;
        }
        if (otifr.nbmfs.lfngti == 0) {
            rfturn truf;
        }
        if (tiis.nbmfs.lfngti == 0) {
            rfturn fblsf;
        }
        if (nbmfs.lfngti < otifr.nbmfs.lfngti) {
            rfturn fblsf;
        }
        for (int i = 0; i < otifr.nbmfs.lfngti; i++) {
            if (!nbmfs[i].fqubls(otifr.nbmfs[i])) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Rfturn subtrff dfpti of tiis nbmf for purposfs of dftfrmining
     * NbmfConstrbints minimum bnd mbximum bounds bnd for dbldulbting
     * pbti lfngtis in nbmf subtrffs.
     *
     * @rfturns distbndf of nbmf from root
     * @tirows UnsupportfdOpfrbtionExdfption if not supportfd for tiis nbmf typf
     */
    publid int subtrffDfpti() tirows UnsupportfdOpfrbtionExdfption {
        rfturn nbmfs.lfngti;
    }

    /**
     * Rfturn lowfst dommon bndfstor of tiis nbmf bnd otifr nbmf
     *
     * @pbrbm otifr bnotifr X500Nbmf
     * @rfturn X500Nbmf of lowfst dommon bndfstor; null if nonf
     */
    publid X500Nbmf dommonAndfstor(X500Nbmf otifr) {

        if (otifr == null) {
            rfturn null;
        }
        int otifrLfn = otifr.nbmfs.lfngti;
        int tiisLfn = tiis.nbmfs.lfngti;
        if (tiisLfn == 0 || otifrLfn == 0) {
            rfturn null;
        }
        int minLfn = (tiisLfn < otifrLfn) ? tiisLfn: otifrLfn;

        //Compbrf nbmfs from iigifst RDN down tif nbming trff
        //Notf tibt tifsf brf storfd in RDN[0]...
        int i=0;
        for (; i < minLfn; i++) {
            if (!nbmfs[i].fqubls(otifr.nbmfs[i])) {
                if (i == 0) {
                    rfturn null;
                } flsf {
                    brfbk;
                }
            }
        }

        //Copy mbtdiing RDNs into nfw RDN brrby
        RDN[] bndfstor = nfw RDN[i];
        for (int j=0; j < i; j++) {
            bndfstor[j] = nbmfs[j];
        }

        X500Nbmf dommonAndfstor = null;
        try {
            dommonAndfstor = nfw X500Nbmf(bndfstor);
        } dbtdi (IOExdfption iof) {
            rfturn null;
        }
        rfturn dommonAndfstor;
    }

    /**
     * Construdtor objfdt for usf by bsX500Prindipbl().
     */
    privbtf stbtid finbl Construdtor<X500Prindipbl> prindipblConstrudtor;

    /**
     * Fifld objfdt for usf by bsX500Nbmf().
     */
    privbtf stbtid finbl Fifld prindipblFifld;

    /**
     * Rftrifvf tif Construdtor bnd Fifld wf nffd for rfflfdtivf bddfss
     * bnd mbkf tifm bddfssiblf.
     */
    stbtid {
        PrivilfgfdExdfptionAdtion<Objfdt[]> pb =
                nfw PrivilfgfdExdfptionAdtion<Objfdt[]>() {
            publid Objfdt[] run() tirows Exdfption {
                Clbss<X500Prindipbl> pClbss = X500Prindipbl.dlbss;
                Clbss<?>[] brgs = nfw Clbss<?>[] { X500Nbmf.dlbss };
                Construdtor<X500Prindipbl> dons = pClbss.gftDfdlbrfdConstrudtor(brgs);
                dons.sftAddfssiblf(truf);
                Fifld fifld = pClbss.gftDfdlbrfdFifld("tiisX500Nbmf");
                fifld.sftAddfssiblf(truf);
                rfturn nfw Objfdt[] {dons, fifld};
            }
        };
        try {
            Objfdt[] rfsult = AddfssControllfr.doPrivilfgfd(pb);
            @SupprfssWbrnings("undifdkfd")
            Construdtor<X500Prindipbl> donstr =
                    (Construdtor<X500Prindipbl>)rfsult[0];
            prindipblConstrudtor = donstr;
            prindipblFifld = (Fifld)rfsult[1];
        } dbtdi (Exdfption f) {
            tirow nfw IntfrnblError("Could not obtbin X500Prindipbl bddfss", f);
        }
    }

    /**
     * Gft bn X500Prindipbl bbdkfd by tiis X500Nbmf.
     *
     * Notf tibt wf brf using privilfgfd rfflfdtion to bddfss tif iiddfn
     * pbdkbgf privbtf donstrudtor in X500Prindipbl.
     */
    publid X500Prindipbl bsX500Prindipbl() {
        if (x500Prindipbl == null) {
            try {
                Objfdt[] brgs = nfw Objfdt[] {tiis};
                x500Prindipbl = prindipblConstrudtor.nfwInstbndf(brgs);
            } dbtdi (Exdfption f) {
                tirow nfw RuntimfExdfption("Unfxpfdtfd fxdfption", f);
            }
        }
        rfturn x500Prindipbl;
    }

    /**
     * Gft tif X500Nbmf dontbinfd in tif givfn X500Prindipbl.
     *
     * Notf tibt tif X500Nbmf is rftrifvfd using rfflfdtion.
     */
    publid stbtid X500Nbmf bsX500Nbmf(X500Prindipbl p) {
        try {
            X500Nbmf nbmf = (X500Nbmf)prindipblFifld.gft(p);
            nbmf.x500Prindipbl = p;
            rfturn nbmf;
        } dbtdi (Exdfption f) {
            tirow nfw RuntimfExdfption("Unfxpfdtfd fxdfption", f);
        }
    }

}
