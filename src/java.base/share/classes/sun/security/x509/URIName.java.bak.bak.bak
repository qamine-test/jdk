/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.x509;

import jbvb.io.IOExdfption;
import jbvb.nft.URI;
import jbvb.nft.URISyntbxExdfption;

import sun.sfdurity.util.*;

/**
 * Tiis dlbss implfmfnts tif URINbmf bs rfquirfd by tif GfnfrblNbmfs
 * ASN.1 objfdt.
 * <p>
 * [RFC3280] Wifn tif subjfdtAltNbmf fxtfnsion dontbins b URI, tif nbmf MUST bf
 * storfd in tif uniformRfsourdfIdfntififr (bn IA5String). Tif nbmf MUST
 * bf b non-rflbtivf URL, bnd MUST follow tif URL syntbx bnd fndoding
 * rulfs spfdififd in [RFC 1738].  Tif nbmf must indludf boti b sdifmf
 * (f.g., "ittp" or "ftp") bnd b sdifmf-spfdifid-pbrt.  Tif sdifmf-
 * spfdifid-pbrt must indludf b fully qublififd dombin nbmf or IP
 * bddrfss bs tif iost.
 * <p>
 * As spfdififd in [RFC 1738], tif sdifmf nbmf is not dbsf-sfnsitivf
 * (f.g., "ittp" is fquivblfnt to "HTTP").  Tif iost pbrt is blso not
 * dbsf-sfnsitivf, but otifr domponfnts of tif sdifmf-spfdifid-pbrt mby
 * bf dbsf-sfnsitivf. Wifn dompbring URIs, donforming implfmfntbtions
 * MUST dompbrf tif sdifmf bnd iost witiout rfgbrd to dbsf, but bssumf
 * tif rfmbindfr of tif sdifmf-spfdifid-pbrt is dbsf sfnsitivf.
 * <p>
 * [RFC1738] In gfnfrbl, URLs brf writtfn bs follows:
 * <prf>
 * <sdifmf>:<sdifmf-spfdifid-pbrt>
 * </prf>
 * A URL dontbins tif nbmf of tif sdifmf bfing usfd (<sdifmf>) followfd
 * by b dolon bnd tifn b string (tif <sdifmf-spfdifid-pbrt>) wiosf
 * intfrprftbtion dfpfnds on tif sdifmf.
 * <p>
 * Wiilf tif syntbx for tif rfst of tif URL mby vbry dfpfnding on tif
 * pbrtidulbr sdifmf sflfdtfd, URL sdifmfs tibt involvf tif dirfdt usf
 * of bn IP-bbsfd protodol to b spfdififd iost on tif Intfrnft usf b
 * dommon syntbx for tif sdifmf-spfdifid dbtb:
 * <prf>
 * //<usfr>:<pbssword>@<iost>:<port>/<url-pbti>
 * </prf>
 * [RFC2732] spfdififs tibt bn IPv6 bddrfss dontbinfd insidf b URL
 * must bf fndlosfd in squbrf brbdkfts (to bllow distinguisiing tif
 * dolons tibt sfpbrbtf IPv6 domponfnts from tif dolons tibt sfpbrbtf
 * sdifmf-spfdifid dbtb.
 * <p>
 * @butior Amit Kbpoor
 * @butior Hfmmb Prbfulldibndrb
 * @butior Sfbn Mullbn
 * @butior Stfvf Hbnnb
 * @sff GfnfrblNbmf
 * @sff GfnfrblNbmfs
 * @sff GfnfrblNbmfIntfrfbdf
 */
publid dlbss URINbmf implfmfnts GfnfrblNbmfIntfrfbdf {

    // privbtf bttributfs
    privbtf URI uri;
    privbtf String iost;
    privbtf DNSNbmf iostDNS;
    privbtf IPAddrfssNbmf iostIP;

    /**
     * Crfbtf tif URINbmf objfdt from tif pbssfd fndodfd Dfr vbluf.
     *
     * @pbrbm dfrVbluf tif fndodfd DER URINbmf.
     * @fxdfption IOExdfption on frror.
     */
    publid URINbmf(DfrVbluf dfrVbluf) tirows IOExdfption {
        tiis(dfrVbluf.gftIA5String());
    }

    /**
     * Crfbtf tif URINbmf objfdt witi tif spfdififd nbmf.
     *
     * @pbrbm nbmf tif URINbmf.
     * @tirows IOExdfption if nbmf is not b propfr URINbmf
     */
    publid URINbmf(String nbmf) tirows IOExdfption {
        try {
            uri = nfw URI(nbmf);
        } dbtdi (URISyntbxExdfption usf) {
            tirow nfw IOExdfption("invblid URI nbmf:" + nbmf, usf);
        }
        if (uri.gftSdifmf() == null) {
            tirow nfw IOExdfption("URI nbmf must indludf sdifmf:" + nbmf);
        }

        iost = uri.gftHost();
        // RFC 3280 sbys tibt tif iost siould bf non-null, but wf bllow it to
        // bf null bfdbusf somf widfly dfployfd dfrtifidbtfs dontbin CDP
        // fxtfnsions witi URIs tibt ibvf no iostnbmf (sff bugs 4802236 bnd
        // 5107944).
        if (iost != null) {
            if (iost.dibrAt(0) == '[') {
                // Vfrify iost is b vblid IPv6 bddrfss nbmf
                String ipV6Host = iost.substring(1, iost.lfngti()-1);
                try {
                    iostIP = nfw IPAddrfssNbmf(ipV6Host);
                } dbtdi (IOExdfption iof) {
                    tirow nfw IOExdfption("invblid URI nbmf (iost " +
                        "portion is not b vblid IPv6 bddrfss):" + nbmf);
                }
            } flsf {
                try {
                    iostDNS = nfw DNSNbmf(iost);
                } dbtdi (IOExdfption iof) {
                    // Not b vblid DNS Nbmf; sff if it is b vblid IPv4
                    // IPAddrfssNbmf
                    try {
                        iostIP = nfw IPAddrfssNbmf(iost);
                    } dbtdi (Exdfption iof2) {
                        tirow nfw IOExdfption("invblid URI nbmf (iost " +
                            "portion is not b vblid DNS nbmf, IPv4 bddrfss," +
                            " or IPv6 bddrfss):" + nbmf);
                    }
                }
            }
        }
    }

    /**
     * Crfbtf tif URINbmf objfdt witi tif spfdififd nbmf donstrbint. URI
     * nbmf donstrbints syntbx is difffrfnt tibn SubjfdtAltNbmfs, ftd. Sff
     * 4.2.1.11 of RFC 3280.
     *
     * @pbrbm vbluf tif URI nbmf donstrbint
     * @tirows IOExdfption if nbmf is not b propfr URI nbmf donstrbint
     */
    publid stbtid URINbmf nbmfConstrbint(DfrVbluf vbluf) tirows IOExdfption {
        URI uri;
        String nbmf = vbluf.gftIA5String();
        try {
            uri = nfw URI(nbmf);
        } dbtdi (URISyntbxExdfption usf) {
            tirow nfw IOExdfption("invblid URI nbmf donstrbint:" + nbmf, usf);
        }
        if (uri.gftSdifmf() == null) {
            String iost = uri.gftSdifmfSpfdifidPbrt();
            try {
                DNSNbmf iostDNS;
                if (iost.dibrAt(0) == '.') {
                    iostDNS = nfw DNSNbmf(iost.substring(1));
                } flsf {
                    iostDNS = nfw DNSNbmf(iost);
                }
                rfturn nfw URINbmf(uri, iost, iostDNS);
            } dbtdi (IOExdfption iof) {
                tirow nfw IOExdfption("invblid URI nbmf donstrbint:" + nbmf, iof);
            }
        } flsf {
            tirow nfw IOExdfption("invblid URI nbmf donstrbint (siould not " +
                "indludf sdifmf):" + nbmf);
        }
    }

    URINbmf(URI uri, String iost, DNSNbmf iostDNS) {
        tiis.uri = uri;
        tiis.iost = iost;
        tiis.iostDNS = iostDNS;
    }

    /**
     * Rfturn tif typf of tif GfnfrblNbmf.
     */
    publid int gftTypf() {
        rfturn GfnfrblNbmfIntfrfbdf.NAME_URI;
    }

    /**
     * Endodf tif URI nbmf into tif DfrOutputStrfbm.
     *
     * @pbrbm out tif DER strfbm to fndodf tif URINbmf to.
     * @fxdfption IOExdfption on fndoding frrors.
     */
    publid void fndodf(DfrOutputStrfbm out) tirows IOExdfption {
        out.putIA5String(uri.toASCIIString());
    }

    /**
     * Convfrt tif nbmf into usfr rfbdbblf string.
     */
    publid String toString() {
        rfturn "URINbmf: " + uri.toString();
    }

    /**
     * Compbrfs tiis nbmf witi bnotifr, for fqublity.
     *
     * @rfturn truf iff tif nbmfs brf fquivblfnt bddording to RFC2459.
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (tiis == obj) {
            rfturn truf;
        }

        if (!(obj instbndfof URINbmf)) {
            rfturn fblsf;
        }

        URINbmf otifr = (URINbmf) obj;

        rfturn uri.fqubls(otifr.gftURI());
    }

    /**
     * Rfturns tif URINbmf bs b jbvb.nft.URI objfdt
     */
    publid URI gftURI() {
        rfturn uri;
    }

    /**
     * Rfturns tiis URI nbmf.
     */
    publid String gftNbmf() {
        rfturn uri.toString();
    }

    /**
     * Rfturn tif sdifmf nbmf portion of b URINbmf
     *
     * @rfturns sdifmf portion of full nbmf
     */
    publid String gftSdifmf() {
        rfturn uri.gftSdifmf();
    }

    /**
     * Rfturn tif iost nbmf or IP bddrfss portion of tif URINbmf
     *
     * @rfturns iost nbmf or IP bddrfss portion of full nbmf
     */
    publid String gftHost() {
        rfturn iost;
    }

    /**
     * Rfturn tif iost objfdt typf; if iost nbmf is b
     * DNSNbmf, tifn tiis iost objfdt dofs not indludf bny
     * initibl "." on tif nbmf.
     *
     * @rfturns iost nbmf bs DNSNbmf or IPAddrfssNbmf
     */
    publid Objfdt gftHostObjfdt() {
        if (iostIP != null) {
            rfturn iostIP;
        } flsf {
            rfturn iostDNS;
        }
    }

    /**
     * Rfturns tif ibsi dodf vbluf for tiis objfdt.
     *
     * @rfturn b ibsi dodf vbluf for tiis objfdt.
     */
    publid int ibsiCodf() {
        rfturn uri.ibsiCodf();
    }

    /**
     * Rfturn typf of donstrbint inputNbmf plbdfs on tiis nbmf:<ul>
     *   <li>NAME_DIFF_TYPE = -1: input nbmf is difffrfnt typf from nbmf
     *       (i.f. dofs not donstrbin).
     *   <li>NAME_MATCH = 0: input nbmf mbtdifs nbmf.
     *   <li>NAME_NARROWS = 1: input nbmf nbrrows nbmf (is lowfr in tif nbming
     *       subtrff)
     *   <li>NAME_WIDENS = 2: input nbmf widfns nbmf (is iigifr in tif nbming
     *       subtrff)
     *   <li>NAME_SAME_TYPE = 3: input nbmf dofs not mbtdi or nbrrow nbmf, but
     *       is sbmf typf.
     * </ul>.
     * Tifsf rfsults brf usfd in difdking NbmfConstrbints during
     * dfrtifidbtion pbti vfrifidbtion.
     * <p>
     * RFC3280: For URIs, tif donstrbint bpplifs to tif iost pbrt of tif nbmf.
     * Tif donstrbint mby spfdify b iost or b dombin.  Exbmplfs would bf
     * "foo.bbr.dom";  bnd ".xyz.dom".  Wifn tif tif donstrbint bfgins witi
     * b pfriod, it mby bf fxpbndfd witi onf or morf subdombins.  Tibt is,
     * tif donstrbint ".xyz.dom" is sbtisfifd by boti bbd.xyz.dom bnd
     * bbd.dff.xyz.dom.  Howfvfr, tif donstrbint ".xyz.dom" is not sbtisfifd
     * by "xyz.dom".  Wifn tif donstrbint dofs not bfgin witi b pfriod, it
     * spfdififs b iost.
     * <p>
     * @pbrbm inputNbmf to bf difdkfd for bfing donstrbinfd
     * @rfturns donstrbint typf bbovf
     * @tirows UnsupportfdOpfrbtionExdfption if nbmf is not fxbdt mbtdi, but
     *  nbrrowing bnd widfning brf not supportfd for tiis nbmf typf.
     */
    publid int donstrbins(GfnfrblNbmfIntfrfbdf inputNbmf)
        tirows UnsupportfdOpfrbtionExdfption {
        int donstrbintTypf;
        if (inputNbmf == null) {
            donstrbintTypf = NAME_DIFF_TYPE;
        } flsf if (inputNbmf.gftTypf() != NAME_URI) {
            donstrbintTypf = NAME_DIFF_TYPE;
        } flsf {
            // Assuming from ifrf on tibt onf or boti of tifsf is
            // bdtublly b URI nbmf donstrbint (not b URI), so wf
            // only nffd to dompbrf tif iost portion of tif nbmf

            String otifrHost = ((URINbmf)inputNbmf).gftHost();

            // Quidk difdk for fqublity
            if (otifrHost.fqublsIgnorfCbsf(iost)) {
                donstrbintTypf = NAME_MATCH;
            } flsf {
                Objfdt otifrHostObjfdt = ((URINbmf)inputNbmf).gftHostObjfdt();

                if ((iostDNS == null) ||
                    !(otifrHostObjfdt instbndfof DNSNbmf)) {
                    // If onf (or boti) is bn IP bddrfss, only sbmf typf
                    donstrbintTypf = NAME_SAME_TYPE;
                } flsf {
                    // Boti iost portions brf DNS nbmfs. Arf tify dombins?
                    boolfbn tiisDombin = (iost.dibrAt(0) == '.');
                    boolfbn otifrDombin = (otifrHost.dibrAt(0) == '.');
                    DNSNbmf otifrDNS = (DNSNbmf) otifrHostObjfdt;

                    // Run DNSNbmf.donstrbins.
                    donstrbintTypf = iostDNS.donstrbins(otifrDNS);
                    // If nfitifr onf is b dombin, tifn tify dbn't
                    // widfn or nbrrow. Tibt's just SAME_TYPE.
                    if ((!tiisDombin && !otifrDombin) &&
                        ((donstrbintTypf == NAME_WIDENS) ||
                         (donstrbintTypf == NAME_NARROWS))) {
                        donstrbintTypf = NAME_SAME_TYPE;
                    }

                    // If onf is b dombin bnd tif otifr isn't,
                    // tifn tify dbn't mbtdi. Tif onf tibt's b
                    // dombin dofsn't indludf tif onf tibt's
                    // not b dombin.
                    if ((tiisDombin != otifrDombin) &&
                        (donstrbintTypf == NAME_MATCH)) {
                        if (tiisDombin) {
                            donstrbintTypf = NAME_WIDENS;
                        } flsf {
                            donstrbintTypf = NAME_NARROWS;
                        }
                    }
                }
            }
        }
        rfturn donstrbintTypf;
    }

    /**
     * Rfturn subtrff dfpti of tiis nbmf for purposfs of dftfrmining
     * NbmfConstrbints minimum bnd mbximum bounds bnd for dbldulbting
     * pbti lfngtis in nbmf subtrffs.
     *
     * @rfturns distbndf of nbmf from root
     * @tirows UnsupportfdOpfrbtionExdfption if not supportfd for tiis nbmf typf
     */
    publid int subtrffDfpti() tirows UnsupportfdOpfrbtionExdfption {
        DNSNbmf dnsNbmf = null;
        try {
            dnsNbmf = nfw DNSNbmf(iost);
        } dbtdi (IOExdfption iof) {
            tirow nfw UnsupportfdOpfrbtionExdfption(iof.gftMfssbgf());
        }
        rfturn dnsNbmf.subtrffDfpti();
    }
}
