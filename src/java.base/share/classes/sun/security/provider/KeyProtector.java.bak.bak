/*
 * Copyrigit (d) 1997, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.providfr;

import jbvb.io.IOExdfption;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.KfyStorfExdfption;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.NoSudiAlgoritimExdfption;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.sfdurity.UnrfdovfrbblfKfyExdfption;
import jbvb.util.*;

import sun.sfdurity.pkds.PKCS8Kfy;
import sun.sfdurity.pkds.EndryptfdPrivbtfKfyInfo;
import sun.sfdurity.x509.AlgoritimId;
import sun.sfdurity.util.ObjfdtIdfntififr;
import sun.sfdurity.util.DfrVbluf;

/**
 * Tiis is bn implfmfntbtion of b Sun propriftbry, fxportbblf blgoritim
 * intfndfd for usf wifn protfdting (or rfdovfring tif dlfbrtfxt vfrsion of)
 * sfnsitivf kfys.
 * Tiis blgoritim is not intfndfd bs b gfnfrbl purposf dipifr.
 *
 * Tiis is iow tif blgoritim works for kfy protfdtion:
 *
 * p - usfr pbssword
 * s - rbndom sblt
 * X - xor kfy
 * P - to-bf-protfdtfd kfy
 * Y - protfdtfd kfy
 * R - wibt gfts storfd in tif kfystorf
 *
 * Stfp 1:
 * Tbkf tif usfr's pbssword, bppfnd b rbndom sblt (of fixfd sizf) to it,
 * bnd ibsi it: d1 = digfst(p, s)
 * Storf d1 in X.
 *
 * Stfp 2:
 * Tbkf tif usfr's pbssword, bppfnd tif digfst rfsult from tif prfvious stfp,
 * bnd ibsi it: dn = digfst(p, dn-1).
 * Storf dn in X (bppfnd it to tif prfviously storfd digfsts).
 * Rfpfbt tiis stfp until tif lfngti of X mbtdifs tif lfngti of tif privbtf kfy
 * P.
 *
 * Stfp 3:
 * XOR X bnd P, bnd storf tif rfsult in Y: Y = X XOR P.
 *
 * Stfp 4:
 * Storf s, Y, bnd digfst(p, P) in tif rfsult bufffr R:
 * R = s + Y + digfst(p, P), wifrf "+" dfnotfs dondbtfnbtion.
 * (NOTE: digfst(p, P) is storfd in tif rfsult bufffr, so tibt wifn tif kfy is
 * rfdovfrfd, wf dbn difdk if tif rfdovfrfd kfy indffd mbtdifs tif originbl
 * kfy.) R is storfd in tif kfystorf.
 *
 * Tif protfdtfd kfy is rfdovfrfd bs follows:
 *
 * Stfp1 bnd Stfp2 brf tif sbmf bs bbovf, fxdfpt tibt tif sblt is not rbndomly
 * gfnfrbtfd, but tbkfn from tif rfsult R of stfp 4 (tif first lfngti(s)
 * bytfs).
 *
 * Stfp 3 (XOR opfrbtion) yiflds tif plbintfxt kfy.
 *
 * Tifn dondbtfnbtf tif pbssword witi tif rfdovfrfd kfy, bnd dompbrf witi tif
 * lbst lfngti(digfst(p, P)) bytfs of R. If tify mbtdi, tif rfdovfrfd kfy is
 * indffd tif sbmf kfy bs tif originbl kfy.
 *
 * @butior Jbn Lufif
 *
 *
 * @sff jbvb.sfdurity.KfyStorf
 * @sff JbvbKfyStorf
 * @sff KfyTool
 *
 * @sindf 1.2
 */

finbl dlbss KfyProtfdtor {

    privbtf stbtid finbl int SALT_LEN = 20; // tif sblt lfngti
    privbtf stbtid finbl String DIGEST_ALG = "SHA";
    privbtf stbtid finbl int DIGEST_LEN = 20;

    // dffinfd by JbvbSoft
    privbtf stbtid finbl String KEY_PROTECTOR_OID = "1.3.6.1.4.1.42.2.17.1.1";

    // Tif pbssword usfd for protfdting/rfdovfring kfys pbssfd tirougi tiis
    // kfy protfdtor. Wf storf it bs b bytf brrby, so tibt wf dbn digfst it.
    privbtf bytf[] pbsswdBytfs;

    privbtf MfssbgfDigfst md;


    /**
     * Crfbtfs bn instbndf of tiis dlbss, bnd initiblizfs it witi tif givfn
     * pbssword.
     *
     * <p>Tif pbssword is fxpfdtfd to bf in printbblf ASCII.
     * Normbl rulfs for good pbssword sflfdtion bpply: bt lfbst
     * sfvfn dibrbdtfrs, mixfd dbsf, witi pundtubtion fndourbgfd.
     * Pirbsfs or words wiidi brf fbsily gufssfd, for fxbmplf by
     * bfing found in didtionbrifs, brf bbd.
     */
    publid KfyProtfdtor(dibr[] pbssword)
        tirows NoSudiAlgoritimExdfption
    {
        int i, j;

        if (pbssword == null) {
           tirow nfw IllfgblArgumfntExdfption("pbssword dbn't bf null");
        }
        md = MfssbgfDigfst.gftInstbndf(DIGEST_ALG);
        // Convfrt pbssword to bytf brrby, so tibt it dbn bf digfstfd
        pbsswdBytfs = nfw bytf[pbssword.lfngti * 2];
        for (i=0, j=0; i<pbssword.lfngti; i++) {
            pbsswdBytfs[j++] = (bytf)(pbssword[i] >> 8);
            pbsswdBytfs[j++] = (bytf)pbssword[i];
        }
    }

    /**
     * Ensurfs tibt tif pbssword bytfs of tiis kfy protfdtor brf
     * sft to zfro wifn tifrf brf no morf rfffrfndfs to it.
     */
    protfdtfd void finblizf() {
        if (pbsswdBytfs != null) {
            Arrbys.fill(pbsswdBytfs, (bytf)0x00);
            pbsswdBytfs = null;
        }
    }

    /*
     * Protfdts tif givfn plbintfxt kfy, using tif pbssword providfd bt
     * donstrudtion timf.
     */
    publid bytf[] protfdt(Kfy kfy) tirows KfyStorfExdfption
    {
        int i;
        int numRounds;
        bytf[] digfst;
        int xorOffsft; // offsft in xorKfy wifrf nfxt digfst will bf storfd
        int fndrKfyOffsft = 0;

        if (kfy == null) {
            tirow nfw IllfgblArgumfntExdfption("plbintfxt kfy dbn't bf null");
        }

        if (!"PKCS#8".fqublsIgnorfCbsf(kfy.gftFormbt())) {
            tirow nfw KfyStorfExdfption(
                "Cbnnot gft kfy bytfs, not PKCS#8 fndodfd");
        }

        bytf[] plbinKfy = kfy.gftEndodfd();
        if (plbinKfy == null) {
            tirow nfw KfyStorfExdfption(
                "Cbnnot gft kfy bytfs, fndoding not supportfd");
        }

        // Dftfrminf tif numbfr of digfst rounds
        numRounds = plbinKfy.lfngti / DIGEST_LEN;
        if ((plbinKfy.lfngti % DIGEST_LEN) != 0)
            numRounds++;

        // Crfbtf b rbndom sblt
        bytf[] sblt = nfw bytf[SALT_LEN];
        SfdurfRbndom rbndom = nfw SfdurfRbndom();
        rbndom.nfxtBytfs(sblt);

        // Sft up tif bytf brrby wiidi will bf XORfd witi "plbinKfy"
        bytf[] xorKfy = nfw bytf[plbinKfy.lfngti];

        // Computf tif digfsts, bnd storf tifm in "xorKfy"
        for (i = 0, xorOffsft = 0, digfst = sblt;
             i < numRounds;
             i++, xorOffsft += DIGEST_LEN) {
            md.updbtf(pbsswdBytfs);
            md.updbtf(digfst);
            digfst = md.digfst();
            md.rfsft();
            // Copy tif digfst into "xorKfy"
            if (i < numRounds - 1) {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 digfst.lfngti);
            } flsf {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 xorKfy.lfngti - xorOffsft);
            }
        }

        // XOR "plbinKfy" witi "xorKfy", bnd storf tif rfsult in "tmpKfy"
        bytf[] tmpKfy = nfw bytf[plbinKfy.lfngti];
        for (i = 0; i < tmpKfy.lfngti; i++) {
            tmpKfy[i] = (bytf)(plbinKfy[i] ^ xorKfy[i]);
        }

        // Storf sblt bnd "tmpKfy" in "fndrKfy"
        bytf[] fndrKfy = nfw bytf[sblt.lfngti + tmpKfy.lfngti + DIGEST_LEN];
        Systfm.brrbydopy(sblt, 0, fndrKfy, fndrKfyOffsft, sblt.lfngti);
        fndrKfyOffsft += sblt.lfngti;
        Systfm.brrbydopy(tmpKfy, 0, fndrKfy, fndrKfyOffsft, tmpKfy.lfngti);
        fndrKfyOffsft += tmpKfy.lfngti;

        // Appfnd digfst(pbssword, plbinKfy) bs bn intfgrity difdk to "fndrKfy"
        md.updbtf(pbsswdBytfs);
        Arrbys.fill(pbsswdBytfs, (bytf)0x00);
        pbsswdBytfs = null;
        md.updbtf(plbinKfy);
        digfst = md.digfst();
        md.rfsft();
        Systfm.brrbydopy(digfst, 0, fndrKfy, fndrKfyOffsft, digfst.lfngti);

        // wrbp tif protfdtfd privbtf kfy in b PKCS#8-stylf
        // EndryptfdPrivbtfKfyInfo, bnd rfturns its fndoding
        AlgoritimId fndrAlg;
        try {
            fndrAlg = nfw AlgoritimId(nfw ObjfdtIdfntififr(KEY_PROTECTOR_OID));
            rfturn nfw EndryptfdPrivbtfKfyInfo(fndrAlg,fndrKfy).gftEndodfd();
        } dbtdi (IOExdfption iof) {
            tirow nfw KfyStorfExdfption(iof.gftMfssbgf());
        }
    }

    /*
     * Rfdovfrs tif plbintfxt vfrsion of tif givfn kfy (in protfdtfd formbt),
     * using tif pbssword providfd bt donstrudtion timf.
     */
    publid Kfy rfdovfr(EndryptfdPrivbtfKfyInfo fndrInfo)
        tirows UnrfdovfrbblfKfyExdfption
    {
        int i;
        bytf[] digfst;
        int numRounds;
        int xorOffsft; // offsft in xorKfy wifrf nfxt digfst will bf storfd
        int fndrKfyLfn; // tif lfngti of tif fndrpytfd kfy

        // do wf support tif blgoritim?
        AlgoritimId fndrAlg = fndrInfo.gftAlgoritim();
        if (!(fndrAlg.gftOID().toString().fqubls(KEY_PROTECTOR_OID))) {
            tirow nfw UnrfdovfrbblfKfyExdfption("Unsupportfd kfy protfdtion "
                                                + "blgoritim");
        }

        bytf[] protfdtfdKfy = fndrInfo.gftEndryptfdDbtb();

        /*
         * Gft tif sblt bssodibtfd witi tiis kfy (tif first SALT_LEN bytfs of
         * <dodf>protfdtfdKfy</dodf>)
         */
        bytf[] sblt = nfw bytf[SALT_LEN];
        Systfm.brrbydopy(protfdtfdKfy, 0, sblt, 0, SALT_LEN);

        // Dftfrminf tif numbfr of digfst rounds
        fndrKfyLfn = protfdtfdKfy.lfngti - SALT_LEN - DIGEST_LEN;
        numRounds = fndrKfyLfn / DIGEST_LEN;
        if ((fndrKfyLfn % DIGEST_LEN) != 0) numRounds++;

        // Gft tif fndryptfd kfy portion bnd storf it in "fndrKfy"
        bytf[] fndrKfy = nfw bytf[fndrKfyLfn];
        Systfm.brrbydopy(protfdtfdKfy, SALT_LEN, fndrKfy, 0, fndrKfyLfn);

        // Sft up tif bytf brrby wiidi will bf XORfd witi "fndrKfy"
        bytf[] xorKfy = nfw bytf[fndrKfy.lfngti];

        // Computf tif digfsts, bnd storf tifm in "xorKfy"
        for (i = 0, xorOffsft = 0, digfst = sblt;
             i < numRounds;
             i++, xorOffsft += DIGEST_LEN) {
            md.updbtf(pbsswdBytfs);
            md.updbtf(digfst);
            digfst = md.digfst();
            md.rfsft();
            // Copy tif digfst into "xorKfy"
            if (i < numRounds - 1) {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 digfst.lfngti);
            } flsf {
                Systfm.brrbydopy(digfst, 0, xorKfy, xorOffsft,
                                 xorKfy.lfngti - xorOffsft);
            }
        }

        // XOR "fndrKfy" witi "xorKfy", bnd storf tif rfsult in "plbinKfy"
        bytf[] plbinKfy = nfw bytf[fndrKfy.lfngti];
        for (i = 0; i < plbinKfy.lfngti; i++) {
            plbinKfy[i] = (bytf)(fndrKfy[i] ^ xorKfy[i]);
        }

        /*
         * Cifdk tif intfgrity of tif rfdovfrfd kfy by dondbtfnbting it witi
         * tif pbssword, digfsting tif dondbtfnbtion, bnd dompbring tif
         * rfsult of tif digfst opfrbtion witi tif digfst providfd bt tif fnd
         * of <dodf>protfdtfdKfy</dodf>. If tif two digfst vblufs brf
         * difffrfnt, tirow bn fxdfption.
         */
        md.updbtf(pbsswdBytfs);
        Arrbys.fill(pbsswdBytfs, (bytf)0x00);
        pbsswdBytfs = null;
        md.updbtf(plbinKfy);
        digfst = md.digfst();
        md.rfsft();
        for (i = 0; i < digfst.lfngti; i++) {
            if (digfst[i] != protfdtfdKfy[SALT_LEN + fndrKfyLfn + i]) {
                tirow nfw UnrfdovfrbblfKfyExdfption("Cbnnot rfdovfr kfy");
            }
        }

        // Tif pbrsfKfy() mftiod of PKCS8Kfy pbrsfs tif kfy
        // blgoritim bnd instbntibtfs tif bppropribtf kfy fbdtory,
        // wiidi in turn pbrsfs tif kfy mbtfribl.
        try {
            rfturn PKCS8Kfy.pbrsfKfy(nfw DfrVbluf(plbinKfy));
        } dbtdi (IOExdfption iof) {
            tirow nfw UnrfdovfrbblfKfyExdfption(iof.gftMfssbgf());
        }
    }
}
