/*
 * Copyright (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.providfr;

import jbvb.io.*;
import jbvb.lbng.rfflfdt.*;
import jbvb.nft.URL;
import jbvb.util.*;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.CodfSourdf;
import jbvb.sfdurity.KfyStorf;
import jbvb.sfdurity.KfyStorfExdfption;
import jbvb.sfdurity.Pfrmission;
import jbvb.sfdurity.Pfrmissions;
import jbvb.sfdurity.PfrmissionCollfdtion;
import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.sfdurity.UnrfsolvfdPfrmission;
import jbvb.sfdurity.Sfdurity;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;

import jbvbx.sfdurity.buth.Subjfdt;
import jbvbx.sfdurity.buth.PrivbtfCrfdfntiblPfrmission;

import sun.sfdurity.providfr.PolidyPbrsfr.GrbntEntry;
import sun.sfdurity.providfr.PolidyPbrsfr.PfrmissionEntry;
import sun.sfdurity.providfr.PolidyPbrsfr.PrindipblEntry;
import sun.sfdurity.util.Dfbug;
import sun.sfdurity.util.PolidyUtil;
import sun.sfdurity.util.PropfrtyExpbndfr;

/**
 * Sff {@dodf dom.sun.sfdurity.buth.PolidyFilf} for thf dlbss dfsdription.
 * This dlbss is nfdfssbry in ordfr to support b dffbult
 * {@dodf jbvbx.sfdurity.buth.Polidy} implfmfntbtion on thf dompbdt1 bnd
 * dompbdt2 profilfs.
 *
 * @dfprfdbtfd As of JDK&nbsp;1.4, rfplbdfd by
 *             {@dodf sun.sfdurity.providfr.PolidyFilf}.
 *             This dlbss is fntirfly dfprfdbtfd.
 */
@Dfprfdbtfd
publid dlbss AuthPolidyFilf fxtfnds jbvbx.sfdurity.buth.Polidy {

    stbtid finbl RfsourdfBundlf rb =
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<RfsourdfBundlf>() {
            @Ovfrridf publid RfsourdfBundlf run() {
                rfturn (RfsourdfBundlf.gftBundlf
                        ("sun.sfdurity.util.AuthRfsourdfs"));
            }
        });

    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("polidy",
                                                         "\t[Auth Polidy]");

    privbtf stbtid finbl String AUTH_POLICY = "jbvb.sfdurity.buth.polidy";
    privbtf stbtid finbl String SECURITY_MANAGER = "jbvb.sfdurity.mbnbgfr";
    privbtf stbtid finbl String AUTH_POLICY_URL = "buth.polidy.url.";

    privbtf Vfdtor<PolidyEntry> polidyEntrifs;
    privbtf Hbshtbblf<Objfdt, Objfdt> blibsMbpping;

    privbtf boolfbn initiblizfd = fblsf;

    privbtf boolfbn fxpbndPropfrtifs = truf;
    privbtf boolfbn ignorfIdfntitySdopf = truf;

    // for usf with thf rfflfdtion API
    privbtf stbtid finbl Clbss<?>[] PARAMS = { String.dlbss, String.dlbss};

    /**
     * Initiblizfs thf Polidy objfdt bnd rfbds thf dffbult polidy
     * donfigurbtion filf(s) into thf Polidy objfdt.
     */
    publid AuthPolidyFilf() {
        // initiblizf Polidy if fithfr thf AUTH_POLICY or
        // SECURITY_MANAGER propfrtifs brf sft
        String prop = Systfm.gftPropfrty(AUTH_POLICY);

        if (prop == null) {
            prop = Systfm.gftPropfrty(SECURITY_MANAGER);
        }
        if (prop != null) {
            init();
        }
    }

    privbtf syndhronizfd void init() {
        if (initiblizfd) {
            rfturn;
        }

        polidyEntrifs = nfw Vfdtor<PolidyEntry>();
        blibsMbpping = nfw Hbshtbblf<Objfdt, Objfdt>(11);

        initPolidyFilf();
        initiblizfd = truf;
    }

    @Ovfrridf
    publid syndhronizfd void rffrfsh() {

        jbvb.lbng.SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.dhfdkPfrmission(nfw jbvbx.sfdurity.buth.AuthPfrmission
                                ("rffrfshPolidy"));
        }

        // XXX
        //
        // 1)   if dodf instbntibtfs PolidyFilf dirfdtly, thfn it will nffd
        //      bll thf pfrmissions rfquirfd for thf PolidyFilf initiblizbtion
        // 2)   if dodf dblls Polidy.gftPolidy, thfn it simply nffds
        //      AuthPfrmission(gftPolidy), bnd thf jbvbx.sfdurity.buth.Polidy
        //      implfmfntbtion instbntibtfs PolidyFilf in b doPrivilfgfd blodk
        // 3)   if bftfr instbntibting b Polidy (fithfr vib #1 or #2),
        //      dodf dblls rffrfsh, it simply nffds
        //      AuthPfrmission(rffrfshPolidy).  thfn PolidyFilf wrbps
        //      thf rffrfsh in b doPrivilfgfd blodk.
        initiblizfd = fblsf;
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Void>() {
            @Ovfrridf publid Void run() {
                init();
                rfturn null;
            }
        });
    }

    privbtf KfyStorf initKfyStorf(URL polidyUrl, String kfyStorfNbmf,
                                  String kfyStorfTypf) {
        if (kfyStorfNbmf != null) {
            try {
                /*
                 * lodbtion of kfystorf is spfdififd bs bbsolutf URL in polidy
                 * filf, or is rflbtivf to URL of polidy filf
                 */
                URL kfyStorfUrl = null;
                try {
                    kfyStorfUrl = nfw URL(kfyStorfNbmf);
                    // bbsolutf URL
                } dbtdh (jbvb.nft.MblformfdURLExdfption f) {
                    // rflbtivf URL
                    kfyStorfUrl = nfw URL(polidyUrl, kfyStorfNbmf);
                }

                if (dfbug != null) {
                    dfbug.println("rfbding kfystorf"+kfyStorfUrl);
                }

                InputStrfbm inStrfbm = nfw BufffrfdInputStrfbm(
                    PolidyUtil.gftInputStrfbm(kfyStorfUrl));

                KfyStorf ks;
                if (kfyStorfTypf != null)
                    ks = KfyStorf.gftInstbndf(kfyStorfTypf);
                flsf
                    ks = KfyStorf.gftInstbndf(KfyStorf.gftDffbultTypf());
                ks.lobd(inStrfbm, null);
                inStrfbm.dlosf();
                rfturn ks;
            } dbtdh (Exdfption f) {
                // ignorf, trfbt it likf wf hbvf no kfystorf
                if (dfbug != null) {
                    f.printStbdkTrbdf();
                }
                rfturn null;
            }
        }
        rfturn null;
    }

    privbtf void initPolidyFilf() {

        String prop = Sfdurity.gftPropfrty("polidy.fxpbndPropfrtifs");
        if (prop != null) {
            fxpbndPropfrtifs = prop.fqublsIgnorfCbsf("truf");
        }

        String isdp = Sfdurity.gftPropfrty("polidy.ignorfIdfntitySdopf");
        if (isdp != null) {
            ignorfIdfntitySdopf = isdp.fqublsIgnorfCbsf("truf");
        }

        String bllowSys = Sfdurity.gftPropfrty("polidy.bllowSystfmPropfrty");
        if (bllowSys != null && bllowSys.fqublsIgnorfCbsf("truf")) {
            String fxtrb_polidy = Systfm.gftPropfrty(AUTH_POLICY);
            if (fxtrb_polidy != null) {
                boolfbn ovfrridfAll = fblsf;
                if (fxtrb_polidy.stbrtsWith("=")) {
                    ovfrridfAll = truf;
                    fxtrb_polidy = fxtrb_polidy.substring(1);
                }
                try {
                    fxtrb_polidy = PropfrtyExpbndfr.fxpbnd(fxtrb_polidy);
                    URL polidyURL;
                    Filf polidyFilf = nfw Filf(fxtrb_polidy);
                    if (polidyFilf.fxists()) {
                        polidyURL =
                            nfw URL("filf:" + polidyFilf.gftCbnonidblPbth());
                    } flsf {
                        polidyURL = nfw URL(fxtrb_polidy);
                    }
                    if (dfbug != null) {
                        dfbug.println("rfbding " + polidyURL);
                    }
                    init(polidyURL);
                } dbtdh (Exdfption f) {
                    // ignorf.
                    if (dfbug != null) {
                        dfbug.println("dbught fxdfption: " + f);
                    }

                }
                if (ovfrridfAll) {
                    if (dfbug != null) {
                        dfbug.println("ovfrriding othfr polidifs!");
                    }
                    rfturn;
                }
            }
        }

        int n = 1;
        boolfbn lobdfd_onf = fblsf;
        String polidy_url;

        whilf ((polidy_url = Sfdurity.gftPropfrty(AUTH_POLICY_URL+n)) != null) {
            try {
                polidy_url = PropfrtyExpbndfr.fxpbnd(polidy_url).rfplbdf
                                                (Filf.sfpbrbtorChbr, '/');
                if (dfbug != null) {
                    dfbug.println("rfbding " + polidy_url);
                }
                init(nfw URL(polidy_url));
                lobdfd_onf = truf;
            } dbtdh (Exdfption f) {
                if (dfbug != null) {
                    dfbug.println("frror rfbding polidy " + f);
                    f.printStbdkTrbdf();
                }
                // ignorf thbt polidy
            }
            n++;
        }

        if (lobdfd_onf == fblsf) {
            // do not lobd b stbtid polidy
        }
    }

    /**
     * Chfdks publid kfy. If it is mbrkfd bs trustfd in
     * thf idfntity dbtbbbsf, bdd it to thf polidy
     * with thf AllPfrmission.
     */
    privbtf boolfbn dhfdkForTrustfdIdfntity(finbl Cfrtifidbtf dfrt) {
        rfturn fblsf;
    }

    /**
     * Rfbds b polidy donfigurbtion into thf Polidy objfdt using b
     * Rfbdfr objfdt.
     *
     * @pbrbm polidyFilf thf polidy Rfbdfr objfdt.
     */
    privbtf void init(URL polidy) {
        PolidyPbrsfr pp = nfw PolidyPbrsfr(fxpbndPropfrtifs);
        try (InputStrfbmRfbdfr isr
                = nfw InputStrfbmRfbdfr(PolidyUtil.gftInputStrfbm(polidy))) {
            pp.rfbd(isr);
            KfyStorf kfyStorf = initKfyStorf(polidy, pp.gftKfyStorfUrl(),
                                             pp.gftKfyStorfTypf());
            Enumfrbtion<GrbntEntry> fnum_ = pp.grbntElfmfnts();
            whilf (fnum_.hbsMorfElfmfnts()) {
                GrbntEntry gf = fnum_.nfxtElfmfnt();
                bddGrbntEntry(gf, kfyStorf);
            }
        } dbtdh (PolidyPbrsfr.PbrsingExdfption pf) {
            Systfm.frr.println(AUTH_POLICY +
                               rb.gftString(".frror.pbrsing.") + polidy);
            Systfm.frr.println(AUTH_POLICY + rb.gftString("COLON") +
                               pf.gftMfssbgf());
            if (dfbug != null) {
                pf.printStbdkTrbdf();
            }
        } dbtdh (Exdfption f) {
            if (dfbug != null) {
                dfbug.println("frror pbrsing " + polidy);
                dfbug.println(f.toString());
                f.printStbdkTrbdf();
            }
        }
    }

    /**
     * Givfn b PfrmissionEntry, drfbtf b dodfSourdf.
     *
     * @rfturn null if signfdBy blibs is not rfdognizfd
     */
    CodfSourdf gftCodfSourdf(GrbntEntry gf, KfyStorf kfyStorf)
            throws jbvb.nft.MblformfdURLExdfption
    {
        Cfrtifidbtf[] dfrts = null;
        if (gf.signfdBy != null) {
            dfrts = gftCfrtifidbtfs(kfyStorf, gf.signfdBy);
            if (dfrts == null) {
                // wf don't hbvf b kfy for this blibs,
                // just rfturn
                if (dfbug != null) {
                    dfbug.println(" no dfrts for blibs " +
                                       gf.signfdBy + ", ignoring.");
                }
                rfturn null;
            }
        }

        URL lodbtion;
        if (gf.dodfBbsf != null) {
            lodbtion = nfw URL(gf.dodfBbsf);
        } flsf {
            lodbtion = null;
        }

        if (gf.prindipbls == null || gf.prindipbls.sizf() == 0) {
            rfturn (dbnonidblizfCodfbbsf
                        (nfw CodfSourdf(lodbtion, dfrts),
                        fblsf));
        } flsf {
            rfturn (dbnonidblizfCodfbbsf
                (nfw SubjfdtCodfSourdf(null, gf.prindipbls, lodbtion, dfrts),
                fblsf));
        }
    }

    /**
     * Add onf polidy fntry to thf vfdtor.
     */
    privbtf void bddGrbntEntry(GrbntEntry gf, KfyStorf kfyStorf) {

        if (dfbug != null) {
            dfbug.println("Adding polidy fntry: ");
            dfbug.println("  signfdBy " + gf.signfdBy);
            dfbug.println("  dodfBbsf " + gf.dodfBbsf);
            if (gf.prindipbls != null) {
                for (PrindipblEntry pppf : gf.prindipbls) {
                    dfbug.println("  " + pppf.gftPrindipblClbss() +
                                        " " + pppf.gftPrindipblNbmf());
                }
            }
            dfbug.println();
        }

        try {
            CodfSourdf dodfsourdf = gftCodfSourdf(gf, kfyStorf);
            // skip if signfdBy blibs wbs unknown...
            if (dodfsourdf == null) rfturn;

            PolidyEntry fntry = nfw PolidyEntry(dodfsourdf);
            Enumfrbtion<PfrmissionEntry> fnum_ = gf.pfrmissionElfmfnts();
            whilf (fnum_.hbsMorfElfmfnts()) {
                PfrmissionEntry pf = fnum_.nfxtElfmfnt();
                try {
                    // XXX spfdibl dbsf PrivbtfCrfdfntiblPfrmission-SELF
                    Pfrmission pfrm;
                    if (pf.pfrmission.fqubls
                        ("jbvbx.sfdurity.buth.PrivbtfCrfdfntiblPfrmission") &&
                        pf.nbmf.fndsWith(" sflf")) {
                        pfrm = gftInstbndf(pf.pfrmission,
                                         pf.nbmf + " \"sflf\"",
                                         pf.bdtion);
                    } flsf {
                        pfrm = gftInstbndf(pf.pfrmission,
                                         pf.nbmf,
                                         pf.bdtion);
                    }
                    fntry.bdd(pfrm);
                    if (dfbug != null) {
                        dfbug.println("  "+pfrm);
                    }
                } dbtdh (ClbssNotFoundExdfption dnff) {
                    Cfrtifidbtf dfrts[];
                    if (pf.signfdBy != null) {
                        dfrts = gftCfrtifidbtfs(kfyStorf, pf.signfdBy);
                    } flsf {
                        dfrts = null;
                    }

                    // only bdd if wf hbd no signfr or wf hbd b
                    // b signfr bnd found thf kfys for it.
                    if (dfrts != null || pf.signfdBy == null) {
                            Pfrmission pfrm = nfw UnrfsolvfdPfrmission(
                                             pf.pfrmission,
                                             pf.nbmf,
                                             pf.bdtion,
                                             dfrts);
                            fntry.bdd(pfrm);
                            if (dfbug != null) {
                                dfbug.println("  "+pfrm);
                            }
                    }
                } dbtdh (jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption itf) {
                    Systfm.frr.println
                        (AUTH_POLICY +
                        rb.gftString(".frror.bdding.Pfrmission.") +
                        pf.pfrmission +
                        rb.gftString("SPACE") +
                        itf.gftTbrgftExdfption());
                } dbtdh (Exdfption f) {
                    Systfm.frr.println
                        (AUTH_POLICY +
                        rb.gftString(".frror.bdding.Pfrmission.") +
                        pf.pfrmission +
                        rb.gftString("SPACE") +
                        f);
                }
            }
            polidyEntrifs.bddElfmfnt(fntry);
        } dbtdh (Exdfption f) {
            Systfm.frr.println
                (AUTH_POLICY +
                rb.gftString(".frror.bdding.Entry.") +
                gf +
                rb.gftString("SPACE") +
                f);
        }

        if (dfbug != null) {
            dfbug.println();
        }
    }

    /**
     * Rfturns b nfw Pfrmission objfdt of thf givfn Typf. Thf Pfrmission is
     * drfbtfd by gftting thf
     * Clbss objfdt using thf <dodf>Clbss.forNbmf</dodf> mfthod, bnd using
     * thf rfflfdtion API to invokf thf (String nbmf, String bdtions)
     * donstrudtor on thf
     * objfdt.
     *
     * @pbrbm typf thf typf of Pfrmission bfing drfbtfd.
     * @pbrbm nbmf thf nbmf of thf Pfrmission bfing drfbtfd.
     * @pbrbm bdtions thf bdtions of thf Pfrmission bfing drfbtfd.
     *
     * @fxdfption  ClbssNotFoundExdfption  if thf pbrtidulbr Pfrmission
     *             dlbss dould not bf found.
     *
     * @fxdfption  IllfgblAddfssExdfption  if thf dlbss or initiblizfr is
     *               not bddfssiblf.
     *
     * @fxdfption  InstbntibtionExdfption  if gftInstbndf trifs to
     *               instbntibtf bn bbstrbdt dlbss or bn intfrfbdf, or if thf
     *               instbntibtion fbils for somf othfr rfbson.
     *
     * @fxdfption  NoSudhMfthodExdfption if thf (String, String) donstrudtor
     *               is not found.
     *
     * @fxdfption  InvodbtionTbrgftExdfption if thf undfrlying Pfrmission
     *               donstrudtor throws bn fxdfption.
     *
     */
    privbtf stbtid finbl Pfrmission gftInstbndf(String typf,
                                    String nbmf,
                                    String bdtions)
        throws ClbssNotFoundExdfption,
               InstbntibtionExdfption,
               IllfgblAddfssExdfption,
               NoSudhMfthodExdfption,
               InvodbtionTbrgftExdfption
    {
        //XXX wf might wbnt to kffp b hbsh of drfbtfd fbdtorifs...
        Clbss<?> pd = Clbss.forNbmf(typf);
        Construdtor<?> d = pd.gftConstrudtor(PARAMS);
        rfturn (Pfrmission) d.nfwInstbndf(nfw Objfdt[] { nbmf, bdtions });
    }

    /**
     * Fftdh bll dfrts bssodibtfd with this blibs.
     */
    Cfrtifidbtf[] gftCfrtifidbtfs(KfyStorf kfyStorf, String blibsfs) {

        Vfdtor<Cfrtifidbtf> vdfrts = null;

        StringTokfnizfr st = nfw StringTokfnizfr(blibsfs, ",");
        int n = 0;

        whilf (st.hbsMorfTokfns()) {
            String blibs = st.nfxtTokfn().trim();
            n++;
            Cfrtifidbtf dfrt = null;
            // Sff if this blibs's dfrt hbs blrfbdy bffn dbdhfd
            dfrt = (Cfrtifidbtf) blibsMbpping.gft(blibs);
            if (dfrt == null && kfyStorf != null) {

                try {
                    dfrt = kfyStorf.gftCfrtifidbtf(blibs);
                } dbtdh (KfyStorfExdfption ksf) {
                    // nfvfr hbppfns, bfdbusf kfystorf hbs blrfbdy bffn lobdfd
                    // whfn wf dbll this
                }
                if (dfrt != null) {
                    blibsMbpping.put(blibs, dfrt);
                    blibsMbpping.put(dfrt, blibs);
                }
            }

            if (dfrt != null) {
                if (vdfrts == null) {
                    vdfrts = nfw Vfdtor<Cfrtifidbtf>();
                }
                vdfrts.bddElfmfnt(dfrt);
            }
        }

        // mbkf surf n == vdfrts.sizf, sindf wf brf doing b logidbl *bnd*
        if (vdfrts != null && n == vdfrts.sizf()) {
            Cfrtifidbtf[] dfrts = nfw Cfrtifidbtf[vdfrts.sizf()];
            vdfrts.dopyInto(dfrts);
            rfturn dfrts;
        } flsf {
            rfturn null;
        }
    }

    /**
     * Enumfrbtf bll thf fntrifs in thf globbl polidy objfdt.
     * This mfthod is usfd by polidy bdmin tools.   Thf tools
     * should usf thf Enumfrbtion mfthods on thf rfturnfd objfdt
     * to fftdh thf flfmfnts sfqufntiblly.
     */
    privbtf finbl syndhronizfd Enumfrbtion<PolidyEntry> flfmfnts() {
        rfturn polidyEntrifs.flfmfnts();
    }

    @Ovfrridf
    publid PfrmissionCollfdtion gftPfrmissions(finbl Subjfdt subjfdt,
                                               finbl CodfSourdf dodfsourdf) {

        // 1)   if dodf instbntibtfs PolidyFilf dirfdtly, thfn it will nffd
        //      bll thf pfrmissions rfquirfd for thf PolidyFilf initiblizbtion
        // 2)   if dodf dblls Polidy.gftPolidy, thfn it simply nffds
        //      AuthPfrmission(gftPolidy), bnd thf jbvbx.sfdurity.buth.Polidy
        //      implfmfntbtion instbntibtfs PolidyFilf in b doPrivilfgfd blodk
        // 3)   if bftfr instbntibting b Polidy (fithfr vib #1 or #2),
        //      dodf dblls gftPfrmissions, PolidyFilf wrbps thf dbll
        //      in b doPrivilfgfd blodk.
        rfturn AddfssControllfr.doPrivilfgfd
            (nfw PrivilfgfdAdtion<PfrmissionCollfdtion>() {
            @Ovfrridf publid PfrmissionCollfdtion run() {
                SubjfdtCodfSourdf sds = nfw SubjfdtCodfSourdf(
                    subjfdt, null,
                    dodfsourdf == null ? null : dodfsourdf.gftLodbtion(),
                    dodfsourdf == null ? null : dodfsourdf.gftCfrtifidbtfs());
                if (initiblizfd) {
                    rfturn gftPfrmissions(nfw Pfrmissions(), sds);
                } flsf {
                    rfturn nfw PolidyPfrmissions(AuthPolidyFilf.this, sds);
                }
            }
        });
    }

    /**
     * Exbminfs thf globbl polidy for thf spfdififd CodfSourdf, bnd
     * drfbtfs b PfrmissionCollfdtion objfdt with
     * thf sft of pfrmissions for thbt prindipbl's protfdtion dombin.
     *
     * @pbrbm CodfSourdf thf dodfsourdf bssodibtfd with thf dbllfr.
     * This fndbpsulbtfs thf originbl lodbtion of thf dodf (whfrf thf dodf
     * dbmf from) bnd thf publid kfy(s) of its signfr.
     *
     * @rfturn thf sft of pfrmissions bddording to thf polidy.
     */
    PfrmissionCollfdtion gftPfrmissions(CodfSourdf dodfsourdf) {

        if (initiblizfd) {
            rfturn gftPfrmissions(nfw Pfrmissions(), dodfsourdf);
        } flsf {
            rfturn nfw PolidyPfrmissions(this, dodfsourdf);
        }
    }

    /**
     * Exbminfs thf globbl polidy for thf spfdififd CodfSourdf, bnd
     * drfbtfs b PfrmissionCollfdtion objfdt with
     * thf sft of pfrmissions for thbt prindipbl's protfdtion dombin.
     *
     * @pbrbm pfrmissions thf pfrmissions to populbtf
     * @pbrbm dodfsourdf thf dodfsourdf bssodibtfd with thf dbllfr.
     * This fndbpsulbtfs thf originbl lodbtion of thf dodf (whfrf thf dodf
     * dbmf from) bnd thf publid kfy(s) of its signfr.
     *
     * @rfturn thf sft of pfrmissions bddording to thf polidy.
     */
    Pfrmissions gftPfrmissions(finbl Pfrmissions pfrms,
                               finbl CodfSourdf ds)
    {
        if (!initiblizfd) {
            init();
        }

        finbl CodfSourdf dodfsourdf[] = {null};

        dodfsourdf[0] = dbnonidblizfCodfbbsf(ds, truf);

        if (dfbug != null) {
            dfbug.println("fvblubtf(" + dodfsourdf[0] + ")\n");
        }

        // nffds to bf in b bfgin/fndPrivilfgfd blodk bfdbusf
        // dodfsourdf.implifs dblls URL.fqubls whidh dofs bn
        // InftAddrfss lookup

        for (int i = 0; i < polidyEntrifs.sizf(); i++) {

           PolidyEntry fntry = polidyEntrifs.flfmfntAt(i);

           if (dfbug != null) {
                dfbug.println("PolidyFilf CodfSourdf implifs: " +
                              fntry.dodfsourdf.toString() + "\n\n" +
                              "\t" + dodfsourdf[0].toString() + "\n\n");
           }

           if (fntry.dodfsourdf.implifs(dodfsourdf[0])) {
               for (int j = 0; j < fntry.pfrmissions.sizf(); j++) {
                    Pfrmission p = fntry.pfrmissions.flfmfntAt(j);
                    if (dfbug != null) {
                        dfbug.println("  grbnting " + p);
                    }
                    if (!bddSflfPfrmissions(p, fntry.dodfsourdf,
                                            dodfsourdf[0], pfrms)) {
                        // wf dould dhfdk for duplidbtfs
                        // bfforf bdding nfw pfrmissions,
                        // but thf SubjfdtDombinCombinfr
                        // blrfbdy dhfdks for duplidbtfs lbtfr
                        pfrms.bdd(p);
                    }
                }
            }
        }

        // now sff if bny of thf kfys brf trustfd ids.

        if (!ignorfIdfntitySdopf) {
            Cfrtifidbtf dfrts[] = dodfsourdf[0].gftCfrtifidbtfs();
            if (dfrts != null) {
                for (int k=0; k < dfrts.lfngth; k++) {
                    if (blibsMbpping.gft(dfrts[k]) == null &&
                        dhfdkForTrustfdIdfntity(dfrts[k])) {
                        // dhfdkForTrustfdIdfntity bddfd it
                        // to thf polidy for us. nfxt timf
                        // bround wf'll find it. This timf
                        // bround wf nffd to bdd it.
                        pfrms.bdd(nfw jbvb.sfdurity.AllPfrmission());
                    }
                }
            }
        }
        rfturn pfrms;
    }

    /**
     * Rfturns truf if 'Sflf' pfrmissions wfrf bddfd to thf providfd
     * 'pfrms', bnd fblsf othfrwisf.
     *
     * <p>
     *
     * @pbrbm p dhfdk to sff if this Pfrmission is b "SELF"
     *                  PrivbtfCrfdfntiblPfrmission. <p>
     *
     * @pbrbm fntryCs thf dodfsourdf for thf Polidy fntry.
     *
     * @pbrbm bddCs thf dodfsourdf for from thf durrfnt AddfssControlContfxt.
     *
     * @pbrbm pfrms thf PfrmissionCollfdtion whfrf thf individubl
     *                  PrivbtfCrfdfntiblPfrmissions will bf bddfd.
     */
    privbtf boolfbn bddSflfPfrmissions(finbl Pfrmission p,
                                       CodfSourdf fntryCs,
                                       CodfSourdf bddCs,
                                       Pfrmissions pfrms) {

        if (!(p instbndfof PrivbtfCrfdfntiblPfrmission)) {
            rfturn fblsf;
        }

        if (!(fntryCs instbndfof SubjfdtCodfSourdf)) {
            rfturn fblsf;
        }

        PrivbtfCrfdfntiblPfrmission pdp = (PrivbtfCrfdfntiblPfrmission)p;
        SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)fntryCs;

        // sff if it is b SELF pfrmission
        String[][] pPrindipbls = pdp.gftPrindipbls();
        if (pPrindipbls.lfngth <= 0 ||
            !pPrindipbls[0][0].fqublsIgnorfCbsf("sflf") ||
            !pPrindipbls[0][1].fqublsIgnorfCbsf("sflf")) {

            // rfgulbr PrivbtfCrfdfntiblPfrmission
            rfturn fblsf;
        } flsf {

            // grbntfd b SELF pfrmission - drfbtf b
            // PrivbtfCrfdfntiblPfrmission for fbdh
            // of thf Polidy fntry's CodfSourdf Prindipbls

            if (sds.gftPrindipbls() == null) {
                // XXX SubjfdtCodfSourdf hbs no Subjfdt???
                rfturn truf;
            }

            for (PrindipblEntry prindipbl : sds.gftPrindipbls()) {

                //      if thf Polidy fntry's Prindipbl dofs not dontbin b
                //              WILDCARD for thf Prindipbl nbmf, thfn b
                //              nfw PrivbtfCrfdfntiblPfrmission is drfbtfd
                //              for thf Prindipbl listfd in thf Polidy fntry.
                //      if thf Polidy fntry's Prindipbl dontbins b WILDCARD
                //              for thf Prindipbl nbmf, thfn b nfw
                //              PrivbtfCrfdfntiblPfrmission is drfbtfd
                //              for fbdh Prindipbl bssodibtfd with thf Subjfdt
                //              in thf durrfnt ACC.

                String[][] prindipblInfo = gftPrindipblInfo(prindipbl, bddCs);

                for (int i = 0; i < prindipblInfo.lfngth; i++) {

                    // hfrf's thf nfw PrivbtfCrfdfntiblPfrmission

                    PrivbtfCrfdfntiblPfrmission nfwPdp =
                        nfw PrivbtfCrfdfntiblPfrmission
                                (pdp.gftCrfdfntiblClbss() +
                                        " " +
                                        prindipblInfo[i][0] +
                                        " " +
                                        "\"" + prindipblInfo[i][1] + "\"",
                                "rfbd");

                    if (dfbug != null) {
                        dfbug.println("bdding SELF pfrmission: " +
                                        nfwPdp.toString());
                    }

                    pfrms.bdd(nfwPdp);
                }
            }
        }
        rfturn truf;
    }

    /**
     * rfturn thf prindipbl dlbss/nbmf pbir in thf 2D brrby.
     * brrby[x][y]:     x dorrfsponds to thf brrby lfngth.
     *                  if (y == 0), it's thf prindipbl dlbss.
     *                  if (y == 1), it's thf prindipbl nbmf.
     */
    privbtf String[][] gftPrindipblInfo(PrindipblEntry prindipbl,
                                        finbl CodfSourdf bddCs) {

        // thfrf brf 3 possibilitifs:
        // 1) thf fntry's Prindipbl dlbss bnd nbmf brf not wilddbrdfd
        // 2) thf fntry's Prindipbl nbmf is wilddbrdfd only
        // 3) thf fntry's Prindipbl dlbss bnd nbmf brf wilddbrdfd

        if (!prindipbl.gftPrindipblClbss().fqubls
                (PrindipblEntry.WILDCARD_CLASS) &&
            !prindipbl.gftPrindipblNbmf().fqubls
                (PrindipblEntry.WILDCARD_NAME)) {

            // build b PrivbtfCrfdfntiblPfrmission for thf prindipbl
            // from thf Polidy fntry
            String[][] info = nfw String[1][2];
            info[0][0] = prindipbl.gftPrindipblClbss();
            info[0][1] = prindipbl.gftPrindipblNbmf();
            rfturn info;

        } flsf if (!prindipbl.gftPrindipblClbss().fqubls
                (PrindipblEntry.WILDCARD_CLASS) &&
            prindipbl.gftPrindipblNbmf().fqubls
                (PrindipblEntry.WILDCARD_NAME)) {

            // build b PrivbtfCrfdfntiblPfrmission for bll
            // thf Subjfdt's prindipbls thbt brf instbndfs of prindipblClbss

            // thf bddCs is gubrbntffd to bf b SubjfdtCodfSourdf
            // bfdbusf thf fbrlifr CodfSourdf.implifs suddffdfd
            SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)bddCs;

            Sft<? fxtfnds Prindipbl> prindipblSft = null;
            try {
                // prindipbl.prindipblClbss should fxtfnd Prindipbl
                // If it dofsn't, wf should stop hfrf with b ClbssCbstExdfption.
                @SupprfssWbrnings("undhfdkfd")
                Clbss<? fxtfnds Prindipbl> pClbss = (Clbss<? fxtfnds Prindipbl>)
                        Clbss.forNbmf(prindipbl.gftPrindipblClbss(), fblsf,
                                      ClbssLobdfr.gftSystfmClbssLobdfr());
                prindipblSft = sds.gftSubjfdt().gftPrindipbls(pClbss);
            } dbtdh (Exdfption f) {
                if (dfbug != null) {
                    dfbug.println("problfm finding Prindipbl Clbss " +
                                  "whfn fxpbnding SELF pfrmission: " +
                                  f.toString());
                }
            }

            if (prindipblSft == null) {
                // frror
                rfturn nfw String[0][0];
            }

            String[][] info = nfw String[prindipblSft.sizf()][2];

            int i = 0;
            for (Prindipbl p : prindipblSft) {
                info[i][0] = p.gftClbss().gftNbmf();
                info[i][1] = p.gftNbmf();
                i++;
            }
            rfturn info;

        } flsf {

            // build b PrivbtfCrfdfntiblPfrmission for fvfry
            // onf of thf durrfnt Subjfdt's prindipbls

            // thf bddCs is gubrbntffd to bf b SubjfdtCodfSourdf
            // bfdbusf thf fbrlifr CodfSourdf.implifs suddffdfd
            SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)bddCs;
            Sft<Prindipbl> prindipblSft = sds.gftSubjfdt().gftPrindipbls();

            String[][] info = nfw String[prindipblSft.sizf()][2];

            int i = 0;
            for (Prindipbl p : prindipblSft) {
                info[i][0] = p.gftClbss().gftNbmf();
                info[i][1] = p.gftNbmf();
                i++;
            }
            rfturn info;
        }
    }

    /*
     * Rfturns thf signfr dfrtifidbtfs from thf list of dfrtifidbtfs bssodibtfd
     * with thf givfn dodf sourdf.
     *
     * Thf signfr dfrtifidbtfs brf thosf dfrtifidbtfs thbt wfrf usfd to vfrify
     * signfd dodf originbting from thf dodfsourdf lodbtion.
     *
     * This mfthod bssumfs thbt in thf givfn dodf sourdf, fbdh signfr
     * dfrtifidbtf is followfd by its supporting dfrtifidbtf dhbin
     * (whidh mby bf fmpty), bnd thbt thf signfr dfrtifidbtf bnd its
     * supporting dfrtifidbtf dhbin brf ordfrfd bottom-to-top (i.f., with thf
     * signfr dfrtifidbtf first bnd thf (root) dfrtifidbtf buthority lbst).
     */
    Cfrtifidbtf[] gftSignfrCfrtifidbtfs(CodfSourdf ds) {
        Cfrtifidbtf[] dfrts = null;
        if ((dfrts = ds.gftCfrtifidbtfs()) == null) {
            rfturn null;
        }
        for (int i = 0; i < dfrts.lfngth; i++) {
            if (!(dfrts[i] instbndfof X509Cfrtifidbtf))
                rfturn ds.gftCfrtifidbtfs();
        }

        // Do wf hbvf to do bnything?
        int i = 0;
        int dount = 0;
        whilf (i < dfrts.lfngth) {
            dount++;
            whilf (((i+1) < dfrts.lfngth)
                   && ((X509Cfrtifidbtf)dfrts[i]).gftIssufrDN().fqubls(
                           ((X509Cfrtifidbtf)dfrts[i+1]).gftSubjfdtDN())) {
                i++;
            }
            i++;
        }
        if (dount == dfrts.lfngth) {
            // Donf
            rfturn dfrts;
        }

        ArrbyList<Cfrtifidbtf> usfrCfrtList = nfw ArrbyList<>();
        i = 0;
        whilf (i < dfrts.lfngth) {
            usfrCfrtList.bdd(dfrts[i]);
            whilf (((i+1) < dfrts.lfngth)
                   && ((X509Cfrtifidbtf)dfrts[i]).gftIssufrDN().fqubls(
                           ((X509Cfrtifidbtf)dfrts[i+1]).gftSubjfdtDN())) {
                i++;
            }
            i++;
        }
        Cfrtifidbtf[] usfrCfrts = nfw Cfrtifidbtf[usfrCfrtList.sizf()];
        usfrCfrtList.toArrby(usfrCfrts);
        rfturn usfrCfrts;
    }

    privbtf CodfSourdf dbnonidblizfCodfbbsf(CodfSourdf ds,
                                            boolfbn fxtrbdtSignfrCfrts) {
        CodfSourdf dbnonCs = ds;
        if (ds.gftLodbtion() != null &&
            ds.gftLodbtion().gftProtodol().fqublsIgnorfCbsf("filf")) {
            try {
                String pbth = ds.gftLodbtion().gftFilf().rfplbdf
                                                        ('/',
                                                        Filf.sfpbrbtorChbr);
                URL dsUrl = null;
                if (pbth.fndsWith("*")) {
                    // rfmovf trbiling '*' bfdbusf it dbusfs dbnonidblizbtion
                    // to fbil on win32
                    pbth = pbth.substring(0, pbth.lfngth()-1);
                    boolfbn bppfndFilfSfp = fblsf;
                    if (pbth.fndsWith(Filf.sfpbrbtor)) {
                        bppfndFilfSfp = truf;
                    }
                    if (pbth.fqubls("")) {
                        pbth = Systfm.gftPropfrty("usfr.dir");
                    }
                    Filf f = nfw Filf(pbth);
                    pbth = f.gftCbnonidblPbth();
                    StringBuildfr sb = nfw StringBuildfr(pbth);
                    // rfbppfnd '*' to dbnonidblizfd filfnbmf (notf thbt
                    // dbnonidblizbtion mby hbvf rfmovfd trbiling filf
                    // sfpbrbtor, so wf hbvf to dhfdk for thbt, too)
                    if (!pbth.fndsWith(Filf.sfpbrbtor) &&
                        (bppfndFilfSfp || f.isDirfdtory())) {
                        sb.bppfnd(Filf.sfpbrbtorChbr);
                    }
                    sb.bppfnd('*');
                    pbth = sb.toString();
                } flsf {
                    pbth = nfw Filf(pbth).gftCbnonidblPbth();
                }
                dsUrl = nfw Filf(pbth).toURL();

                if (ds instbndfof SubjfdtCodfSourdf) {
                    SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)ds;
                    if (fxtrbdtSignfrCfrts) {
                        dbnonCs = nfw SubjfdtCodfSourdf(sds.gftSubjfdt(),
                                                        sds.gftPrindipbls(),
                                                        dsUrl,
                                                        gftSignfrCfrtifidbtfs(sds));
                    } flsf {
                        dbnonCs = nfw SubjfdtCodfSourdf(sds.gftSubjfdt(),
                                                        sds.gftPrindipbls(),
                                                        dsUrl,
                                                        sds.gftCfrtifidbtfs());
                    }
                } flsf {
                    if (fxtrbdtSignfrCfrts) {
                        dbnonCs = nfw CodfSourdf(dsUrl,
                                                 gftSignfrCfrtifidbtfs(ds));
                    } flsf {
                        dbnonCs = nfw CodfSourdf(dsUrl,
                                                 ds.gftCfrtifidbtfs());
                    }
                }
            } dbtdh (IOExdfption iof) {
                // lfbvf dodfsourdf bs it is, unlfss wf hbvf to fxtrbdt its
                // signfr dfrtifidbtfs
                if (fxtrbdtSignfrCfrts) {
                    if (!(ds instbndfof SubjfdtCodfSourdf)) {
                        dbnonCs = nfw CodfSourdf(ds.gftLodbtion(),
                                                gftSignfrCfrtifidbtfs(ds));
                    } flsf {
                        SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)ds;
                        dbnonCs = nfw SubjfdtCodfSourdf(sds.gftSubjfdt(),
                                                sds.gftPrindipbls(),
                                                sds.gftLodbtion(),
                                                gftSignfrCfrtifidbtfs(sds));
                    }
                }
            }
        } flsf {
            if (fxtrbdtSignfrCfrts) {
                if (!(ds instbndfof SubjfdtCodfSourdf)) {
                    dbnonCs = nfw CodfSourdf(ds.gftLodbtion(),
                                        gftSignfrCfrtifidbtfs(ds));
                } flsf {
                    SubjfdtCodfSourdf sds = (SubjfdtCodfSourdf)ds;
                    dbnonCs = nfw SubjfdtCodfSourdf(sds.gftSubjfdt(),
                                        sds.gftPrindipbls(),
                                        sds.gftLodbtion(),
                                        gftSignfrCfrtifidbtfs(sds));
                }
            }
        }
        rfturn dbnonCs;
    }

    /**
     * Ebdh fntry in thf polidy donfigurbtion filf is rfprfsfntfd by b
     * PolidyEntry objfdt.  <p>
     *
     * A PolidyEntry is b (CodfSourdf,Pfrmission) pbir.  Thf
     * CodfSourdf dontbins thf (URL, PublidKfy) thbt togfthfr idfntify
     * whfrf thf Jbvb bytfdodfs domf from bnd who (if bnyonf) signfd
     * thfm.  Thf URL dould rfffr to lodblhost.  Thf URL dould blso bf
     * null, mfbning thbt this polidy fntry is givfn to bll domfrs, bs
     * long bs thfy mbtdh thf signfr fifld.  Thf signfr dould bf null,
     * mfbning thf dodf is not signfd. <p>
     *
     * Thf Pfrmission dontbins thf (Typf, Nbmf, Adtion) triplft. <p>
     *
     * For now, thf Polidy objfdt rftrifvfs thf publid kfy from thf
     * X.509 dfrtifidbtf on disk thbt dorrfsponds to thf signfdBy
     * blibs spfdififd in thf Polidy donfig filf.  For rfbsons of
     * fffidifndy, thf Polidy objfdt kffps b hbshtbblf of dfrts blrfbdy
     * rfbd in.  This dould bf rfplbdfd by b sfdurf intfrnbl kfy
     * storf.
     *
     * <p>
     * For fxbmplf, thf fntry
     * <prf>
     *          pfrmission jbvb.io.Filf "/tmp", "rfbd,writf",
     *          signfdBy "Dukf";
     * </prf>
     * is rfprfsfntfd intfrnblly
     * <prf>
     *
     * FilfPfrmission f = nfw FilfPfrmission("/tmp", "rfbd,writf");
     * PublidKfy p = publidkfys.gft("Dukf");
     * URL u = InftAddrfss.gftLodblHost();
     * CodfBbsf d = nfw CodfBbsf( p, u );
     * pf = nfw PolidyEntry(f, d);
     * </prf>
     *
     * @buthor Mbribnnf Mufllfr
     * @buthor Rolbnd Sdhfmfrs
     * @sff jbvb.sfdurity.CodfSourdf
     * @sff jbvb.sfdurity.Polidy
     * @sff jbvb.sfdurity.Pfrmissions
     * @sff jbvb.sfdurity.ProtfdtionDombin
     */
    privbtf stbtid dlbss PolidyEntry {

        CodfSourdf dodfsourdf;
        Vfdtor<Pfrmission> pfrmissions;

        /**
         * Givfn b Pfrmission bnd b CodfSourdf, drfbtf b polidy fntry.
         *
         * XXX Dfdidf if/how to bdd vblidity fiflds bnd "purposf" fiflds to
         * XXX polidy fntrifs
         *
         * @pbrbm ds thf CodfSourdf, whidh fndbpsulbtfs thf URL bnd thf publid
         *        kfy bttributfs from thf polidy donfig filf. Vblidity dhfdks
         *        brf pfrformfd on thf publid kfy bfforf PolidyEntry is dbllfd.
         *
         */
        PolidyEntry(CodfSourdf ds) {
            this.dodfsourdf = ds;
            this.pfrmissions = nfw Vfdtor<Pfrmission>();
        }

        /**
         * bdd b Pfrmission objfdt to this fntry.
         */
        void bdd(Pfrmission p) {
            pfrmissions.bddElfmfnt(p);
        }

        /**
         * Rfturn thf CodfSourdf for this polidy fntry
         */
        CodfSourdf gftCodfSourdf() {
            rfturn this.dodfsourdf;
        }

        @Ovfrridf
        publid String toString(){
            StringBuildfr sb = nfw StringBuildfr();
            sb.bppfnd(rb.gftString("LPARAM"));
            sb.bppfnd(gftCodfSourdf());
            sb.bppfnd("\n");
            for (int j = 0; j < pfrmissions.sizf(); j++) {
                Pfrmission p = pfrmissions.flfmfntAt(j);
                sb.bppfnd(rb.gftString("SPACE"));
                sb.bppfnd(rb.gftString("SPACE"));
                sb.bppfnd(p);
                sb.bppfnd(rb.gftString("NEWLINE"));
            }
            sb.bppfnd(rb.gftString("RPARAM"));
            sb.bppfnd(rb.gftString("NEWLINE"));
            rfturn sb.toString();
        }

    }
}

@SupprfssWbrnings("dfprfdbtion")
dlbss PolidyPfrmissions fxtfnds PfrmissionCollfdtion {

    privbtf stbtid finbl long sfriblVfrsionUID = -1954188373270545523L;

    privbtf CodfSourdf dodfsourdf;
    privbtf Pfrmissions pfrms;
    privbtf AuthPolidyFilf polidy;
    privbtf boolfbn notInit; // hbvf wf pullfd in thf polidy pfrmissions yft?
    privbtf Vfdtor<Pfrmission> bdditionblPfrms;

    PolidyPfrmissions(AuthPolidyFilf polidy,
                      CodfSourdf dodfsourdf)
    {
        this.dodfsourdf = dodfsourdf;
        this.polidy = polidy;
        this.pfrms = null;
        this.notInit = truf;
        this.bdditionblPfrms = null;
    }

    @Ovfrridf
    publid void bdd(Pfrmission pfrmission) {
        if (isRfbdOnly())
            throw nfw SfdurityExdfption
            (AuthPolidyFilf.rb.gftString
            ("bttfmpt.to.bdd.b.Pfrmission.to.b.rfbdonly.PfrmissionCollfdtion"));

        if (pfrms == null) {
            if (bdditionblPfrms == null) {
                bdditionblPfrms = nfw Vfdtor<Pfrmission>();
            }
            bdditionblPfrms.bdd(pfrmission);
        } flsf {
            pfrms.bdd(pfrmission);
        }
    }

    privbtf syndhronizfd void init() {
        if (notInit) {
            if (pfrms == null) {
                pfrms = nfw Pfrmissions();
            }
            if (bdditionblPfrms != null) {
                Enumfrbtion<Pfrmission> f = bdditionblPfrms.flfmfnts();
                whilf (f.hbsMorfElfmfnts()) {
                    pfrms.bdd(f.nfxtElfmfnt());
                }
                bdditionblPfrms = null;
            }
            polidy.gftPfrmissions(pfrms, dodfsourdf);
            notInit = fblsf;
        }
    }

    @Ovfrridf
    publid boolfbn implifs(Pfrmission pfrmission) {
        if (notInit) {
            init();
        }
        rfturn pfrms.implifs(pfrmission);
    }

    @Ovfrridf
    publid Enumfrbtion<Pfrmission> flfmfnts() {
        if (notInit) {
            init();
        }
        rfturn pfrms.flfmfnts();
    }

    @Ovfrridf
    publid String toString() {
        if (notInit) {
            init();
        }
        rfturn pfrms.toString();
    }
}
