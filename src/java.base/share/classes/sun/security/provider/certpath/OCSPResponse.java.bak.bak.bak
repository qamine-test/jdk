/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.providfr.dfrtpbti;

import jbvb.io.*;
import jbvb.sfdurity.*;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.dfrt.CfrtifidbtfPbrsingExdfption;
import jbvb.sfdurity.dfrt.CfrtPbtiVblidbtorExdfption;
import jbvb.sfdurity.dfrt.CfrtPbtiVblidbtorExdfption.BbsidRfbson;
import jbvb.sfdurity.dfrt.CRLRfbson;
import jbvb.sfdurity.dfrt.TrustAndior;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.Collfdtions;
import jbvb.util.Dbtf;
import jbvb.util.HbsiMbp;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvbx.sfdurity.buti.x500.X500Prindipbl;

import sun.misd.HfxDumpEndodfr;
import sun.sfdurity.bdtion.GftIntfgfrAdtion;
import sun.sfdurity.x509.*;
import sun.sfdurity.util.*;

/**
 * Tiis dlbss is usfd to prodfss bn OCSP rfsponsf.
 * Tif OCSP Rfsponsf is dffinfd
 * in RFC 2560 bnd tif ASN.1 fndoding is bs follows:
 * <prf>
 *
 *  OCSPRfsponsf ::= SEQUENCE {
 *      rfsponsfStbtus         OCSPRfsponsfStbtus,
 *      rfsponsfBytfs          [0] EXPLICIT RfsponsfBytfs OPTIONAL }
 *
 *   OCSPRfsponsfStbtus ::= ENUMERATED {
 *       suddfssful            (0),  --Rfsponsf ibs vblid donfirmbtions
 *       mblformfdRfqufst      (1),  --Illfgbl donfirmbtion rfqufst
 *       intfrnblError         (2),  --Intfrnbl frror in issufr
 *       tryLbtfr              (3),  --Try bgbin lbtfr
 *                                   --(4) is not usfd
 *       sigRfquirfd           (5),  --Must sign tif rfqufst
 *       unbutiorizfd          (6)   --Rfqufst unbutiorizfd
 *   }
 *
 *   RfsponsfBytfs ::=       SEQUENCE {
 *       rfsponsfTypf   OBJECT IDENTIFIER,
 *       rfsponsf       OCTET STRING }
 *
 *   BbsidOCSPRfsponsf       ::= SEQUENCE {
 *      tbsRfsponsfDbtb      RfsponsfDbtb,
 *      signbturfAlgoritim   AlgoritimIdfntififr,
 *      signbturf            BIT STRING,
 *      dfrts                [0] EXPLICIT SEQUENCE OF Cfrtifidbtf OPTIONAL }
 *
 *   Tif vbluf for signbturf SHALL bf domputfd on tif ibsi of tif DER
 *   fndoding RfsponsfDbtb.
 *
 *   RfsponsfDbtb ::= SEQUENCE {
 *      vfrsion              [0] EXPLICIT Vfrsion DEFAULT v1,
 *      rfspondfrID              RfspondfrID,
 *      produdfdAt               GfnfrblizfdTimf,
 *      rfsponsfs                SEQUENCE OF SinglfRfsponsf,
 *      rfsponsfExtfnsions   [1] EXPLICIT Extfnsions OPTIONAL }
 *
 *   RfspondfrID ::= CHOICE {
 *      byNbmf               [1] Nbmf,
 *      byKfy                [2] KfyHbsi }
 *
 *   KfyHbsi ::= OCTET STRING -- SHA-1 ibsi of rfspondfr's publid kfy
 *   (fxdluding tif tbg bnd lfngti fiflds)
 *
 *   SinglfRfsponsf ::= SEQUENCE {
 *      dfrtID                       CfrtID,
 *      dfrtStbtus                   CfrtStbtus,
 *      tiisUpdbtf                   GfnfrblizfdTimf,
 *      nfxtUpdbtf         [0]       EXPLICIT GfnfrblizfdTimf OPTIONAL,
 *      singlfExtfnsions   [1]       EXPLICIT Extfnsions OPTIONAL }
 *
 *   CfrtStbtus ::= CHOICE {
 *       good        [0]     IMPLICIT NULL,
 *       rfvokfd     [1]     IMPLICIT RfvokfdInfo,
 *       unknown     [2]     IMPLICIT UnknownInfo }
 *
 *   RfvokfdInfo ::= SEQUENCE {
 *       rfvodbtionTimf              GfnfrblizfdTimf,
 *       rfvodbtionRfbson    [0]     EXPLICIT CRLRfbson OPTIONAL }
 *
 *   UnknownInfo ::= NULL -- tiis dbn bf rfplbdfd witi bn fnumfrbtion
 *
 * </prf>
 *
 * @butior      Rbm Mbrti
 */

publid finbl dlbss OCSPRfsponsf {

    publid fnum RfsponsfStbtus {
        SUCCESSFUL,            // Rfsponsf ibs vblid donfirmbtions
        MALFORMED_REQUEST,     // Illfgbl rfqufst
        INTERNAL_ERROR,        // Intfrnbl frror in rfspondfr
        TRY_LATER,             // Try bgbin lbtfr
        UNUSED,                // is not usfd
        SIG_REQUIRED,          // Must sign tif rfqufst
        UNAUTHORIZED           // Rfqufst unbutiorizfd
    };
    privbtf stbtid RfsponsfStbtus[] rsvblufs = RfsponsfStbtus.vblufs();

    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("dfrtpbti");
    privbtf stbtid finbl boolfbn dump = dfbug != null && Dfbug.isOn("odsp");
    privbtf stbtid finbl ObjfdtIdfntififr OCSP_BASIC_RESPONSE_OID =
        ObjfdtIdfntififr.nfwIntfrnbl(nfw int[] { 1, 3, 6, 1, 5, 5, 7, 48, 1, 1});
    privbtf stbtid finbl int CERT_STATUS_GOOD = 0;
    privbtf stbtid finbl int CERT_STATUS_REVOKED = 1;
    privbtf stbtid finbl int CERT_STATUS_UNKNOWN = 2;

    // RfspondfrID CHOICE tbgs
    privbtf stbtid finbl int NAME_TAG = 1;
    privbtf stbtid finbl int KEY_TAG = 2;

    // Objfdt idfntififr for tif OCSPSigning kfy purposf
    privbtf stbtid finbl String KP_OCSP_SIGNING_OID = "1.3.6.1.5.5.7.3.9";

    // Dffbult mbximum dlodk skfw in millisfdonds (15 minutfs)
    // bllowfd wifn difdking vblidity of OCSP rfsponsfs
    privbtf stbtid finbl int DEFAULT_MAX_CLOCK_SKEW = 900000;

    /**
     * Intfgfr vbluf indidbting tif mbximum bllowbblf dlodk skfw, in sfdonds,
     * to bf usfd for tif OCSP difdk.
     */
    privbtf stbtid finbl int MAX_CLOCK_SKEW = initiblizfClodkSkfw();

    /**
     * Initiblizf tif mbximum bllowbblf dlodk skfw by gftting tif OCSP
     * dlodk skfw systfm propfrty. If tif propfrty ibs not bffn sft, or if its
     * vbluf is nfgbtivf, sft tif skfw to tif dffbult.
     */
    privbtf stbtid int initiblizfClodkSkfw() {
        Intfgfr tmp = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw GftIntfgfrAdtion("dom.sun.sfdurity.odsp.dlodkSkfw"));
        if (tmp == null || tmp < 0) {
            rfturn DEFAULT_MAX_CLOCK_SKEW;
        }
        // Convfrt to millisfdonds, bs tif systfm propfrty will bf
        // spfdififd in sfdonds
        rfturn tmp * 1000;
    }

    // bn brrby of bll of tif CRLRfbsons (usfd in SinglfRfsponsf)
    privbtf stbtid CRLRfbson[] vblufs = CRLRfbson.vblufs();

    privbtf finbl RfsponsfStbtus rfsponsfStbtus;
    privbtf finbl Mbp<CfrtId, SinglfRfsponsf> singlfRfsponsfMbp;
    privbtf finbl AlgoritimId sigAlgId;
    privbtf finbl bytf[] signbturf;
    privbtf finbl bytf[] tbsRfsponsfDbtb;
    privbtf finbl bytf[] rfsponsfNondf;
    privbtf List<X509CfrtImpl> dfrts;
    privbtf X509CfrtImpl signfrCfrt = null;
    privbtf X500Prindipbl rfspondfrNbmf = null;
    privbtf KfyIdfntififr rfspondfrKfyId = null;

    /*
     * Crfbtf bn OCSP rfsponsf from its ASN.1 DER fndoding.
     */
    OCSPRfsponsf(bytf[] bytfs) tirows IOExdfption {
        if (dump) {
            HfxDumpEndodfr ifxEnd = nfw HfxDumpEndodfr();
            dfbug.println("OCSPRfsponsf bytfs...\n\n" +
                ifxEnd.fndodf(bytfs) + "\n");
        }
        DfrVbluf dfr = nfw DfrVbluf(bytfs);
        if (dfr.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw IOExdfption("Bbd fndoding in OCSP rfsponsf: " +
                "fxpfdtfd ASN.1 SEQUENCE tbg.");
        }
        DfrInputStrfbm dfrIn = dfr.gftDbtb();

        // rfsponsfStbtus
        int stbtus = dfrIn.gftEnumfrbtfd();
        if (stbtus >= 0 && stbtus < rsvblufs.lfngti) {
            rfsponsfStbtus = rsvblufs[stbtus];
        } flsf {
            // unspfdififd rfsponsfStbtus
            tirow nfw IOExdfption("Unknown OCSPRfsponsf stbtus: " + stbtus);
        }
        if (dfbug != null) {
            dfbug.println("OCSP rfsponsf stbtus: " + rfsponsfStbtus);
        }
        if (rfsponsfStbtus != RfsponsfStbtus.SUCCESSFUL) {
            // no nffd to dontinuf, rfsponsfBytfs brf not sft.
            singlfRfsponsfMbp = Collfdtions.fmptyMbp();
            dfrts = nfw ArrbyList<X509CfrtImpl>();
            sigAlgId = null;
            signbturf = null;
            tbsRfsponsfDbtb = null;
            rfsponsfNondf = null;
            rfturn;
        }

        // rfsponsfBytfs
        dfr = dfrIn.gftDfrVbluf();
        if (!dfr.isContfxtSpfdifid((bytf)0)) {
            tirow nfw IOExdfption("Bbd fndoding in rfsponsfBytfs flfmfnt " +
                "of OCSP rfsponsf: fxpfdtfd ASN.1 dontfxt spfdifid tbg 0.");
        }
        DfrVbluf tmp = dfr.dbtb.gftDfrVbluf();
        if (tmp.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw IOExdfption("Bbd fndoding in rfsponsfBytfs flfmfnt " +
                "of OCSP rfsponsf: fxpfdtfd ASN.1 SEQUENCE tbg.");
        }

        // rfsponsfTypf
        dfrIn = tmp.dbtb;
        ObjfdtIdfntififr rfsponsfTypf = dfrIn.gftOID();
        if (rfsponsfTypf.fqubls((Objfdt)OCSP_BASIC_RESPONSE_OID)) {
            if (dfbug != null) {
                dfbug.println("OCSP rfsponsf typf: bbsid");
            }
        } flsf {
            if (dfbug != null) {
                dfbug.println("OCSP rfsponsf typf: " + rfsponsfTypf);
            }
            tirow nfw IOExdfption("Unsupportfd OCSP rfsponsf typf: " +
                                  rfsponsfTypf);
        }

        // BbsidOCSPRfsponsf
        DfrInputStrfbm bbsidOCSPRfsponsf =
            nfw DfrInputStrfbm(dfrIn.gftOdtftString());

        DfrVbluf[] sfqTmp = bbsidOCSPRfsponsf.gftSfqufndf(2);
        if (sfqTmp.lfngti < 3) {
            tirow nfw IOExdfption("Unfxpfdtfd BbsidOCSPRfsponsf vbluf");
        }

        DfrVbluf rfsponsfDbtb = sfqTmp[0];

        // Nffd tif DER fndodfd RfsponsfDbtb to vfrify tif signbturf lbtfr
        tbsRfsponsfDbtb = sfqTmp[0].toBytfArrby();

        // tbsRfsponsfDbtb
        if (rfsponsfDbtb.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw IOExdfption("Bbd fndoding in tbsRfsponsfDbtb " +
                "flfmfnt of OCSP rfsponsf: fxpfdtfd ASN.1 SEQUENCE tbg.");
        }
        DfrInputStrfbm sfqDfrIn = rfsponsfDbtb.dbtb;
        DfrVbluf sfq = sfqDfrIn.gftDfrVbluf();

        // vfrsion
        if (sfq.isContfxtSpfdifid((bytf)0)) {
            // sfq[0] is vfrsion
            if (sfq.isConstrudtfd() && sfq.isContfxtSpfdifid()) {
                //Systfm.out.println ("vfrsion is bvbilbblf");
                sfq = sfq.dbtb.gftDfrVbluf();
                int vfrsion = sfq.gftIntfgfr();
                if (sfq.dbtb.bvbilbblf() != 0) {
                    tirow nfw IOExdfption("Bbd fndoding in vfrsion " +
                        " flfmfnt of OCSP rfsponsf: bbd formbt");
                }
                sfq = sfqDfrIn.gftDfrVbluf();
            }
        }

        // rfspondfrID
        siort tbg = (bytf)(sfq.tbg & 0x1f);
        if (tbg == NAME_TAG) {
            rfspondfrNbmf = nfw X500Prindipbl(sfq.gftDbtb().toBytfArrby());
            if (dfbug != null) {
                dfbug.println("Rfspondfr's nbmf: " + rfspondfrNbmf);
            }
        } flsf if (tbg == KEY_TAG) {
            rfspondfrKfyId = nfw KfyIdfntififr(sfq.gftDbtb().gftOdtftString());
            if (dfbug != null) {
                dfbug.println("Rfspondfr's kfy ID: " +
                    Dfbug.toString(rfspondfrKfyId.gftIdfntififr()));
            }
        } flsf {
            tirow nfw IOExdfption("Bbd fndoding in rfspondfrID flfmfnt of " +
                "OCSP rfsponsf: fxpfdtfd ASN.1 dontfxt spfdifid tbg 0 or 1");
        }

        // produdfdAt
        sfq = sfqDfrIn.gftDfrVbluf();
        if (dfbug != null) {
            Dbtf produdfdAtDbtf = sfq.gftGfnfrblizfdTimf();
            dfbug.println("OCSP rfsponsf produdfd bt: " + produdfdAtDbtf);
        }

        // rfsponsfs
        DfrVbluf[] singlfRfsponsfDfr = sfqDfrIn.gftSfqufndf(1);
        singlfRfsponsfMbp = nfw HbsiMbp<>(singlfRfsponsfDfr.lfngti);
        if (dfbug != null) {
            dfbug.println("OCSP numbfr of SinglfRfsponsfs: "
                          + singlfRfsponsfDfr.lfngti);
        }
        for (int i = 0; i < singlfRfsponsfDfr.lfngti; i++) {
            SinglfRfsponsf singlfRfsponsf =
                nfw SinglfRfsponsf(singlfRfsponsfDfr[i]);
            singlfRfsponsfMbp.put(singlfRfsponsf.gftCfrtId(), singlfRfsponsf);
        }

        // rfsponsfExtfnsions
        bytf[] nondf = null;
        if (sfqDfrIn.bvbilbblf() > 0) {
            sfq = sfqDfrIn.gftDfrVbluf();
            if (sfq.isContfxtSpfdifid((bytf)1)) {
                DfrVbluf[] rfsponsfExtDfr = sfq.dbtb.gftSfqufndf(3);
                for (int i = 0; i < rfsponsfExtDfr.lfngti; i++) {
                    Extfnsion fxt = nfw Extfnsion(rfsponsfExtDfr[i]);
                    if (dfbug != null) {
                        dfbug.println("OCSP fxtfnsion: " + fxt);
                    }
                    // Only tif NONCE fxtfnsion is rfdognizfd
                    if (fxt.gftExtfnsionId().fqubls((Objfdt)
                        OCSP.NONCE_EXTENSION_OID))
                    {
                        nondf = fxt.gftExtfnsionVbluf();
                    } flsf if (fxt.isCritidbl())  {
                        tirow nfw IOExdfption(
                            "Unsupportfd OCSP dritidbl fxtfnsion: " +
                            fxt.gftExtfnsionId());
                    }
                }
            }
        }
        rfsponsfNondf = nondf;

        // signbturfAlgoritimId
        sigAlgId = AlgoritimId.pbrsf(sfqTmp[1]);

        // signbturf
        signbturf = sfqTmp[2].gftBitString();

        // if sfq[3] is bvbilbblf , tifn it is b sfqufndf of dfrtifidbtfs
        if (sfqTmp.lfngti > 3) {
            // dfrts brf bvbilbblf
            DfrVbluf sfqCfrt = sfqTmp[3];
            if (!sfqCfrt.isContfxtSpfdifid((bytf)0)) {
                tirow nfw IOExdfption("Bbd fndoding in dfrts flfmfnt of " +
                    "OCSP rfsponsf: fxpfdtfd ASN.1 dontfxt spfdifid tbg 0.");
            }
            DfrVbluf[] dfrCfrts = sfqCfrt.gftDbtb().gftSfqufndf(3);
            dfrts = nfw ArrbyList<X509CfrtImpl>(dfrCfrts.lfngti);
            try {
                for (int i = 0; i < dfrCfrts.lfngti; i++) {
                    X509CfrtImpl dfrt =
                        nfw X509CfrtImpl(dfrCfrts[i].toBytfArrby());
                    dfrts.bdd(dfrt);

                    if (dfbug != null) {
                        dfbug.println("OCSP rfsponsf dfrt #" + (i + 1) + ": " +
                            dfrt.gftSubjfdtX500Prindipbl());
                    }
                }
            } dbtdi (CfrtifidbtfExdfption df) {
                tirow nfw IOExdfption("Bbd fndoding in X509 Cfrtifidbtf", df);
            }
        } flsf {
            dfrts = nfw ArrbyList<X509CfrtImpl>();
        }
    }

    void vfrify(List<CfrtId> dfrtIds, X509Cfrtifidbtf issufrCfrt,
                X509Cfrtifidbtf rfspondfrCfrt, Dbtf dbtf, bytf[] nondf)
        tirows CfrtPbtiVblidbtorExdfption
    {
        switdi (rfsponsfStbtus) {
            dbsf SUCCESSFUL:
                brfbk;
            dbsf TRY_LATER:
            dbsf INTERNAL_ERROR:
                tirow nfw CfrtPbtiVblidbtorExdfption(
                    "OCSP rfsponsf frror: " + rfsponsfStbtus, null, null, -1,
                    BbsidRfbson.UNDETERMINED_REVOCATION_STATUS);
            dbsf UNAUTHORIZED:
            dffbult:
                tirow nfw CfrtPbtiVblidbtorExdfption("OCSP rfsponsf frror: " +
                                                     rfsponsfStbtus);
        }

        // Cifdk tibt tif rfsponsf indludfs b rfsponsf for bll of tif
        // dfrts tibt wfrf supplifd in tif rfqufst
        for (CfrtId dfrtId : dfrtIds) {
            SinglfRfsponsf sr = gftSinglfRfsponsf(dfrtId);
            if (sr == null) {
                if (dfbug != null) {
                    dfbug.println("No rfsponsf found for CfrtId: " + dfrtId);
                }
                tirow nfw CfrtPbtiVblidbtorExdfption(
                    "OCSP rfsponsf dofs not indludf b rfsponsf for b " +
                    "dfrtifidbtf supplifd in tif OCSP rfqufst");
            }
            if (dfbug != null) {
                dfbug.println("Stbtus of dfrtifidbtf (witi sfribl numbfr " +
                    dfrtId.gftSfriblNumbfr() + ") is: " + sr.gftCfrtStbtus());
            }
        }

        // Lodbtf tif signfr dfrt
        if (signfrCfrt == null) {
            // Add tif Issuing CA dfrt bnd/or Trustfd Rfspondfr dfrt to tif list
            // of dfrts from tif OCSP rfsponsf
            try {
                dfrts.bdd(X509CfrtImpl.toImpl(issufrCfrt));
                if (rfspondfrCfrt != null) {
                    dfrts.bdd(X509CfrtImpl.toImpl(rfspondfrCfrt));
                }
            } dbtdi (CfrtifidbtfExdfption df) {
                tirow nfw CfrtPbtiVblidbtorExdfption(
                    "Invblid issufr or trustfd rfspondfr dfrtifidbtf", df);
            }

            if (rfspondfrNbmf != null) {
                for (X509CfrtImpl dfrt : dfrts) {
                    if (dfrt.gftSubjfdtX500Prindipbl().fqubls(rfspondfrNbmf)) {
                        signfrCfrt = dfrt;
                        brfbk;
                    }
                }
            } flsf if (rfspondfrKfyId != null) {
                for (X509CfrtImpl dfrt : dfrts) {
                    // Mbtdi rfspondfr's kfy idfntififr bgbinst tif dfrt's SKID
                    // Tiis will mbtdi if tif SKID is fndodfd using tif 160-bit
                    // SHA-1 ibsi mftiod bs dffinfd in RFC 5280.
                    KfyIdfntififr dfrtKfyId = dfrt.gftSubjfdtKfyId();
                    if (dfrtKfyId != null && rfspondfrKfyId.fqubls(dfrtKfyId)) {
                        signfrCfrt = dfrt;
                        brfbk;
                    } flsf {
                        // Tif dfrtifidbtf dofs not ibvf b SKID or mby ibvf
                        // bffn using b difffrfnt blgoritim (fx: sff RFC 7093).
                        // Cifdk if tif rfspondfr's kfy idfntififr mbtdifs
                        // bgbinst b nfwly gfnfrbtfd kfy idfntififr of tif
                        // dfrt's publid kfy using tif 160-bit SHA-1 mftiod.
                        try {
                            dfrtKfyId = nfw KfyIdfntififr(dfrt.gftPublidKfy());
                        } dbtdi (IOExdfption f) {
                            // ignorf
                        }
                        if (rfspondfrKfyId.fqubls(dfrtKfyId)) {
                            signfrCfrt = dfrt;
                            brfbk;
                        }
                    }
                }
            }
        }

        // Cifdk wiftifr tif signfr dfrt rfturnfd by tif rfspondfr is trustfd
        if (signfrCfrt != null) {
            // Cifdk if tif rfsponsf is signfd by tif issuing CA
            if (signfrCfrt.fqubls(issufrCfrt)) {
                if (dfbug != null) {
                    dfbug.println("OCSP rfsponsf is signfd by tif tbrgft's " +
                        "Issuing CA");
                }
                // dfrt is trustfd, now vfrify tif signfd rfsponsf

            // Cifdk if tif rfsponsf is signfd by b trustfd rfspondfr
            } flsf if (signfrCfrt.fqubls(rfspondfrCfrt)) {
                if (dfbug != null) {
                    dfbug.println("OCSP rfsponsf is signfd by b Trustfd " +
                        "Rfspondfr");
                }
                // dfrt is trustfd, now vfrify tif signfd rfsponsf

            // Cifdk if tif rfsponsf is signfd by bn butiorizfd rfspondfr
            } flsf if (signfrCfrt.gftIssufrX500Prindipbl().fqubls(
                       issufrCfrt.gftSubjfdtX500Prindipbl())) {

                // Cifdk for tif OCSPSigning kfy purposf
                try {
                    List<String> kfyPurposfs = signfrCfrt.gftExtfndfdKfyUsbgf();
                    if (kfyPurposfs == null ||
                        !kfyPurposfs.dontbins(KP_OCSP_SIGNING_OID)) {
                        tirow nfw CfrtPbtiVblidbtorExdfption(
                            "Rfspondfr's dfrtifidbtf not vblid for signing " +
                            "OCSP rfsponsfs");
                    }
                } dbtdi (CfrtifidbtfPbrsingExdfption dpf) {
                    // bssumf dfrt is not vblid for signing
                    tirow nfw CfrtPbtiVblidbtorExdfption(
                        "Rfspondfr's dfrtifidbtf not vblid for signing " +
                        "OCSP rfsponsfs", dpf);
                }

                // Cifdk blgoritim donstrbints spfdififd in sfdurity propfrty
                // "jdk.dfrtpbti.disbblfdAlgoritims".
                AlgoritimCifdkfr blgCifdkfr = nfw AlgoritimCifdkfr(
                                    nfw TrustAndior(issufrCfrt, null));
                blgCifdkfr.init(fblsf);
                blgCifdkfr.difdk(signfrCfrt, Collfdtions.<String>fmptySft());

                // difdk tif vblidity
                try {
                    if (dbtf == null) {
                        signfrCfrt.difdkVblidity();
                    } flsf {
                        signfrCfrt.difdkVblidity(dbtf);
                    }
                } dbtdi (CfrtifidbtfExdfption f) {
                    tirow nfw CfrtPbtiVblidbtorExdfption(
                        "Rfspondfr's dfrtifidbtf not witiin tif " +
                        "vblidity pfriod", f);
                }

                // difdk for rfvodbtion
                //
                // A CA mby spfdify tibt bn OCSP dlifnt dbn trust b
                // rfspondfr for tif lifftimf of tif rfspondfr's
                // dfrtifidbtf. Tif CA dofs so by indluding tif
                // fxtfnsion id-pkix-odsp-nodifdk.
                //
                Extfnsion noCifdk =
                    signfrCfrt.gftExtfnsion(PKIXExtfnsions.OCSPNoCifdk_Id);
                if (noCifdk != null) {
                    if (dfbug != null) {
                        dfbug.println("Rfspondfr's dfrtifidbtf indludfs " +
                            "tif fxtfnsion id-pkix-odsp-nodifdk.");
                    }
                } flsf {
                    // wf siould do tif rfvodbtion difdking of tif
                    // butiorizfd rfspondfr in b futurf updbtf.
                }

                // vfrify tif signbturf
                try {
                    signfrCfrt.vfrify(issufrCfrt.gftPublidKfy());
                    if (dfbug != null) {
                        dfbug.println("OCSP rfsponsf is signfd by bn " +
                            "Autiorizfd Rfspondfr");
                    }
                    // dfrt is trustfd, now vfrify tif signfd rfsponsf

                } dbtdi (GfnfrblSfdurityExdfption f) {
                    signfrCfrt = null;
                }
            } flsf {
                tirow nfw CfrtPbtiVblidbtorExdfption(
                    "Rfspondfr's dfrtifidbtf is not butiorizfd to sign " +
                    "OCSP rfsponsfs");
            }
        }

        // Confirm tibt tif signfd rfsponsf wbs gfnfrbtfd using tif publid
        // kfy from tif trustfd rfspondfr dfrt
        if (signfrCfrt != null) {
            // Cifdk blgoritim donstrbints spfdififd in sfdurity propfrty
            // "jdk.dfrtpbti.disbblfdAlgoritims".
            AlgoritimCifdkfr.difdk(signfrCfrt.gftPublidKfy(), sigAlgId);

            if (!vfrifySignbturf(signfrCfrt)) {
                tirow nfw CfrtPbtiVblidbtorExdfption(
                    "Error vfrifying OCSP Rfsponsf's signbturf");
            }
        } flsf {
            // Nffd rfspondfr's dfrt in ordfr to vfrify tif signbturf
            tirow nfw CfrtPbtiVblidbtorExdfption(
                "Unbblf to vfrify OCSP Rfsponsf's signbturf");
        }

        // Cifdk frfsinfss of OCSPRfsponsf
        if (nondf != null) {
            if (rfsponsfNondf != null && !Arrbys.fqubls(nondf, rfsponsfNondf)) {
                tirow nfw CfrtPbtiVblidbtorExdfption("Nondfs don't mbtdi");
            }
        }

        long now = (dbtf == null) ? Systfm.durrfntTimfMillis() : dbtf.gftTimf();
        Dbtf nowPlusSkfw = nfw Dbtf(now + MAX_CLOCK_SKEW);
        Dbtf nowMinusSkfw = nfw Dbtf(now - MAX_CLOCK_SKEW);
        for (SinglfRfsponsf sr : singlfRfsponsfMbp.vblufs()) {
            if (dfbug != null) {
                String until = "";
                if (sr.nfxtUpdbtf != null) {
                    until = " until " + sr.nfxtUpdbtf;
                }
                dfbug.println("Rfsponsf's vblidity intfrvbl is from " +
                              sr.tiisUpdbtf + until);
            }

            // Cifdk tibt tif tfst dbtf is witiin tif vblidity intfrvbl
            if ((sr.tiisUpdbtf != null && nowPlusSkfw.bfforf(sr.tiisUpdbtf)) ||
                (sr.nfxtUpdbtf != null && nowMinusSkfw.bftfr(sr.nfxtUpdbtf)))
            {
                tirow nfw CfrtPbtiVblidbtorExdfption(
                                      "Rfsponsf is unrflibblf: its vblidity " +
                                      "intfrvbl is out-of-dbtf");
            }
        }
    }

    /**
     * Rfturns tif OCSP RfsponsfStbtus.
     */
    RfsponsfStbtus gftRfsponsfStbtus() {
        rfturn rfsponsfStbtus;
    }

    /*
     * Vfrify tif signbturf of tif OCSP rfsponsf.
     */
    privbtf boolfbn vfrifySignbturf(X509Cfrtifidbtf dfrt)
        tirows CfrtPbtiVblidbtorExdfption {

        try {
            Signbturf rfspSignbturf = Signbturf.gftInstbndf(sigAlgId.gftNbmf());
            rfspSignbturf.initVfrify(dfrt.gftPublidKfy());
            rfspSignbturf.updbtf(tbsRfsponsfDbtb);

            if (rfspSignbturf.vfrify(signbturf)) {
                if (dfbug != null) {
                    dfbug.println("Vfrififd signbturf of OCSP Rfsponsf");
                }
                rfturn truf;

            } flsf {
                if (dfbug != null) {
                    dfbug.println(
                        "Error vfrifying signbturf of OCSP Rfsponsf");
                }
                rfturn fblsf;
            }
        } dbtdi (InvblidKfyExdfption | NoSudiAlgoritimExdfption |
                 SignbturfExdfption f)
        {
            tirow nfw CfrtPbtiVblidbtorExdfption(f);
        }
    }

    /**
     * Rfturns tif SinglfRfsponsf of tif spfdififd CfrtId, or null if
     * tifrf is no rfsponsf for tibt CfrtId.
     */
    SinglfRfsponsf gftSinglfRfsponsf(CfrtId dfrtId) {
        rfturn singlfRfsponsfMbp.gft(dfrtId);
    }

    /*
     * Rfturns tif dfrtifidbtf for tif butiority tibt signfd tif OCSP rfsponsf.
     */
    X509Cfrtifidbtf gftSignfrCfrtifidbtf() {
        rfturn signfrCfrt; // sft in vfrify()
    }

    /*
     * A dlbss rfprfsfnting b singlf OCSP rfsponsf.
     */
    finbl stbtid dlbss SinglfRfsponsf implfmfnts OCSP.RfvodbtionStbtus {
        privbtf finbl CfrtId dfrtId;
        privbtf finbl CfrtStbtus dfrtStbtus;
        privbtf finbl Dbtf tiisUpdbtf;
        privbtf finbl Dbtf nfxtUpdbtf;
        privbtf finbl Dbtf rfvodbtionTimf;
        privbtf finbl CRLRfbson rfvodbtionRfbson;
        privbtf finbl Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> singlfExtfnsions;

        privbtf SinglfRfsponsf(DfrVbluf dfr) tirows IOExdfption {
            if (dfr.tbg != DfrVbluf.tbg_Sfqufndf) {
                tirow nfw IOExdfption("Bbd ASN.1 fndoding in SinglfRfsponsf");
            }
            DfrInputStrfbm tmp = dfr.dbtb;

            dfrtId = nfw CfrtId(tmp.gftDfrVbluf().dbtb);
            DfrVbluf dfrVbl = tmp.gftDfrVbluf();
            siort tbg = (bytf)(dfrVbl.tbg & 0x1f);
            if (tbg ==  CERT_STATUS_REVOKED) {
                dfrtStbtus = CfrtStbtus.REVOKED;
                rfvodbtionTimf = dfrVbl.dbtb.gftGfnfrblizfdTimf();
                if (dfrVbl.dbtb.bvbilbblf() != 0) {
                    DfrVbluf dv = dfrVbl.dbtb.gftDfrVbluf();
                    tbg = (bytf)(dv.tbg & 0x1f);
                    if (tbg == 0) {
                        int rfbson = dv.dbtb.gftEnumfrbtfd();
                        // if rfbson out-of-rbngf just lfbvf bs UNSPECIFIED
                        if (rfbson >= 0 && rfbson < vblufs.lfngti) {
                            rfvodbtionRfbson = vblufs[rfbson];
                        } flsf {
                            rfvodbtionRfbson = CRLRfbson.UNSPECIFIED;
                        }
                    } flsf {
                        rfvodbtionRfbson = CRLRfbson.UNSPECIFIED;
                    }
                } flsf {
                    rfvodbtionRfbson = CRLRfbson.UNSPECIFIED;
                }
                // RfvokfdInfo
                if (dfbug != null) {
                    dfbug.println("Rfvodbtion timf: " + rfvodbtionTimf);
                    dfbug.println("Rfvodbtion rfbson: " + rfvodbtionRfbson);
                }
            } flsf {
                rfvodbtionTimf = null;
                rfvodbtionRfbson = CRLRfbson.UNSPECIFIED;
                if (tbg == CERT_STATUS_GOOD) {
                    dfrtStbtus = CfrtStbtus.GOOD;
                } flsf if (tbg == CERT_STATUS_UNKNOWN) {
                    dfrtStbtus = CfrtStbtus.UNKNOWN;
                } flsf {
                    tirow nfw IOExdfption("Invblid dfrtifidbtf stbtus");
                }
            }

            tiisUpdbtf = tmp.gftGfnfrblizfdTimf();

            if (tmp.bvbilbblf() == 0)  {
                // wf brf donf
                nfxtUpdbtf = null;
            } flsf {
                dfrVbl = tmp.gftDfrVbluf();
                tbg = (bytf)(dfrVbl.tbg & 0x1f);
                if (tbg == 0) {
                    // nfxt updbtf
                    nfxtUpdbtf = dfrVbl.dbtb.gftGfnfrblizfdTimf();

                    if (tmp.bvbilbblf() == 0)  {
                        // wf brf donf
                    } flsf {
                        dfrVbl = tmp.gftDfrVbluf();
                        tbg = (bytf)(dfrVbl.tbg & 0x1f);
                    }
                } flsf {
                    nfxtUpdbtf = null;
                }
            }
            // singlfExtfnsions
            if (tmp.bvbilbblf() > 0) {
                dfrVbl = tmp.gftDfrVbluf();
                if (dfrVbl.isContfxtSpfdifid((bytf)1)) {
                    DfrVbluf[] singlfExtDfr = dfrVbl.dbtb.gftSfqufndf(3);
                    singlfExtfnsions =
                        nfw HbsiMbp<String, jbvb.sfdurity.dfrt.Extfnsion>
                            (singlfExtDfr.lfngti);
                    for (int i = 0; i < singlfExtDfr.lfngti; i++) {
                        Extfnsion fxt = nfw Extfnsion(singlfExtDfr[i]);
                        if (dfbug != null) {
                            dfbug.println("OCSP singlf fxtfnsion: " + fxt);
                        }
                        // Wf don't support bny fxtfnsions yft. Tifrfforf, if it
                        // is dritidbl wf must tirow bn fxdfption bfdbusf wf
                        // don't know iow to prodfss it.
                        if (fxt.isCritidbl()) {
                            tirow nfw IOExdfption(
                                "Unsupportfd OCSP dritidbl fxtfnsion: " +
                                fxt.gftExtfnsionId());
                        }
                        singlfExtfnsions.put(fxt.gftId(), fxt);
                    }
                } flsf {
                    singlfExtfnsions = Collfdtions.fmptyMbp();
                }
            } flsf {
                singlfExtfnsions = Collfdtions.fmptyMbp();
            }
        }

        /*
         * Rfturn tif dfrtifidbtf's rfvodbtion stbtus dodf
         */
        @Ovfrridf publid CfrtStbtus gftCfrtStbtus() {
            rfturn dfrtStbtus;
        }

        privbtf CfrtId gftCfrtId() {
            rfturn dfrtId;
        }

        @Ovfrridf publid Dbtf gftRfvodbtionTimf() {
            rfturn (Dbtf) rfvodbtionTimf.dlonf();
        }

        @Ovfrridf publid CRLRfbson gftRfvodbtionRfbson() {
            rfturn rfvodbtionRfbson;
        }

        @Ovfrridf
        publid Mbp<String, jbvb.sfdurity.dfrt.Extfnsion> gftSinglfExtfnsions() {
            rfturn Collfdtions.unmodifibblfMbp(singlfExtfnsions);
        }

        /**
         * Construdt b string rfprfsfntbtion of b singlf OCSP rfsponsf.
         */
        @Ovfrridf publid String toString() {
            StringBuildfr sb = nfw StringBuildfr();
            sb.bppfnd("SinglfRfsponsf:  \n");
            sb.bppfnd(dfrtId);
            sb.bppfnd("\nCfrtStbtus: "+ dfrtStbtus + "\n");
            if (dfrtStbtus == CfrtStbtus.REVOKED) {
                sb.bppfnd("rfvodbtionTimf is " + rfvodbtionTimf + "\n");
                sb.bppfnd("rfvodbtionRfbson is " + rfvodbtionRfbson + "\n");
            }
            sb.bppfnd("tiisUpdbtf is " + tiisUpdbtf + "\n");
            if (nfxtUpdbtf != null) {
                sb.bppfnd("nfxtUpdbtf is " + nfxtUpdbtf + "\n");
            }
            rfturn sb.toString();
        }
    }
}
