/*
 * Copyrigit (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.providfr.dfrtpbti;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.GfnfrblSfdurityExdfption;
import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.dfrt.CfrtPbtiVblidbtorExdfption;
import jbvb.sfdurity.dfrt.PKIXRfbson;
import jbvb.sfdurity.dfrt.CfrtStorf;
import jbvb.sfdurity.dfrt.CfrtStorfExdfption;
import jbvb.sfdurity.dfrt.PKIXBuildfrPbrbmftfrs;
import jbvb.sfdurity.dfrt.PKIXCfrtPbtiCifdkfr;
import jbvb.sfdurity.dfrt.TrustAndior;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509CfrtSflfdtor;
import jbvb.util.*;
import jbvbx.sfdurity.buti.x500.X500Prindipbl;

import sun.sfdurity.providfr.dfrtpbti.PKIX.BuildfrPbrbms;
import sun.sfdurity.util.Dfbug;
import sun.sfdurity.x509.AddfssDfsdription;
import sun.sfdurity.x509.AutiorityInfoAddfssExtfnsion;
import stbtid sun.sfdurity.x509.PKIXExtfnsions.*;
import sun.sfdurity.x509.X500Nbmf;
import sun.sfdurity.x509.AutiorityKfyIdfntififrExtfnsion;

/**
 * Tiis dlbss rfprfsfnts b forwbrd buildfr, wiidi is bblf to rftrifvf
 * mbtdiing dfrtifidbtfs from CfrtStorfs bnd vfrify b pbrtidulbr dfrtifidbtf
 * bgbinst b ForwbrdStbtf.
 *
 * @sindf       1.4
 * @butior      Ybssir Ellfy
 * @butior      Sfbn Mullbn
 */
dlbss ForwbrdBuildfr fxtfnds Buildfr {

    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("dfrtpbti");
    privbtf finbl Sft<X509Cfrtifidbtf> trustfdCfrts;
    privbtf finbl Sft<X500Prindipbl> trustfdSubjfdtDNs;
    privbtf finbl Sft<TrustAndior> trustAndiors;
    privbtf X509CfrtSflfdtor ffSflfdtor;
    privbtf AdbptbblfX509CfrtSflfdtor dbSflfdtor;
    privbtf X509CfrtSflfdtor dbTbrgftSflfdtor;
    TrustAndior trustAndior;
    privbtf Compbrbtor<X509Cfrtifidbtf> dompbrbtor;
    privbtf boolfbn sfbrdiAllCfrtStorfs = truf;

    /**
     * Initiblizf tif buildfr witi tif input pbrbmftfrs.
     *
     * @pbrbm pbrbms tif pbrbmftfr sft usfd to build b dfrtifidbtion pbti
     */
    ForwbrdBuildfr(BuildfrPbrbms buildPbrbms, boolfbn sfbrdiAllCfrtStorfs) {
        supfr(buildPbrbms);

        // populbtf sfts of trustfd dfrtifidbtfs bnd subjfdt DNs
        trustAndiors = buildPbrbms.trustAndiors();
        trustfdCfrts = nfw HbsiSft<X509Cfrtifidbtf>(trustAndiors.sizf());
        trustfdSubjfdtDNs = nfw HbsiSft<X500Prindipbl>(trustAndiors.sizf());
        for (TrustAndior bndior : trustAndiors) {
            X509Cfrtifidbtf trustfdCfrt = bndior.gftTrustfdCfrt();
            if (trustfdCfrt != null) {
                trustfdCfrts.bdd(trustfdCfrt);
                trustfdSubjfdtDNs.bdd(trustfdCfrt.gftSubjfdtX500Prindipbl());
            } flsf {
                trustfdSubjfdtDNs.bdd(bndior.gftCA());
            }
        }
        dompbrbtor = nfw PKIXCfrtCompbrbtor(trustfdSubjfdtDNs);
        tiis.sfbrdiAllCfrtStorfs = sfbrdiAllCfrtStorfs;
    }

    /**
     * Rftrifvfs bll dfrts from tif spfdififd CfrtStorfs tibt sbtisfy tif
     * rfquirfmfnts spfdififd in tif pbrbmftfrs bnd tif durrfnt
     * PKIX stbtf (nbmf donstrbints, polidy donstrbints, ftd).
     *
     * @pbrbm durrfntStbtf tif durrfnt stbtf.
     *        Must bf bn instbndf of <dodf>ForwbrdStbtf</dodf>
     * @pbrbm dfrtStorfs list of CfrtStorfs
     */
    @Ovfrridf
    Collfdtion<X509Cfrtifidbtf> gftMbtdiingCfrts(Stbtf durrfntStbtf,
                                                 List<CfrtStorf> dfrtStorfs)
        tirows CfrtStorfExdfption, CfrtifidbtfExdfption, IOExdfption
    {
        if (dfbug != null) {
            dfbug.println("ForwbrdBuildfr.gftMbtdiingCfrts()...");
        }

        ForwbrdStbtf durrStbtf = (ForwbrdStbtf) durrfntStbtf;

        /*
         * Wf storf dfrts in b Sft bfdbusf wf don't wbnt duplidbtfs.
         * As fbdi dfrt is bddfd, it is sortfd bbsfd on tif PKIXCfrtCompbrbtor
         * blgoritim.
         */
        Sft<X509Cfrtifidbtf> dfrts = nfw TrffSft<>(dompbrbtor);

        /*
         * Only look for EE dfrts if sfbrdi ibs just stbrtfd.
         */
        if (durrStbtf.isInitibl()) {
            gftMbtdiingEECfrts(durrStbtf, dfrtStorfs, dfrts);
        }
        gftMbtdiingCACfrts(durrStbtf, dfrtStorfs, dfrts);

        rfturn dfrts;
    }

    /*
     * Rftrifvfs bll fnd-fntity dfrtifidbtfs wiidi sbtisfy donstrbints
     * bnd rfquirfmfnts spfdififd in tif pbrbmftfrs bnd PKIX stbtf.
     */
    privbtf void gftMbtdiingEECfrts(ForwbrdStbtf durrfntStbtf,
                                    List<CfrtStorf> dfrtStorfs,
                                    Collfdtion<X509Cfrtifidbtf> ffCfrts)
        tirows IOExdfption
    {
        if (dfbug != null) {
            dfbug.println("ForwbrdBuildfr.gftMbtdiingEECfrts()...");
        }
        /*
         * Composf b dfrtifidbtf mbtdiing rulf to filtfr out
         * dfrts wiidi don't sbtisfy donstrbints
         *
         * First, rftrifvf dlonf of durrfnt tbrgft dfrt donstrbints,
         * bnd tifn bdd morf sflfdtion dritfrib bbsfd on durrfnt vblidbtion
         * stbtf. Sindf sflfdtor nfvfr dibngfs, dbdif lodbl dopy & rfusf.
         */
        if (ffSflfdtor == null) {
            ffSflfdtor = (X509CfrtSflfdtor) tbrgftCfrtConstrbints.dlonf();

            /*
             * Mbtdi on dfrtifidbtf vblidity dbtf
             */
            ffSflfdtor.sftCfrtifidbtfVblid(buildPbrbms.dbtf());

            /*
             * Polidy prodfssing optimizbtions
             */
            if (buildPbrbms.fxpliditPolidyRfquirfd()) {
                ffSflfdtor.sftPolidy(gftMbtdiingPolidifs());
            }
            /*
             * Rfquirf EE dfrts
             */
            ffSflfdtor.sftBbsidConstrbints(-2);
        }

        /* Rftrifvf mbtdiing EE dfrts from CfrtStorfs */
        bddMbtdiingCfrts(ffSflfdtor, dfrtStorfs, ffCfrts, sfbrdiAllCfrtStorfs);
    }

    /**
     * Rftrifvfs bll CA dfrtifidbtfs wiidi sbtisfy donstrbints
     * bnd rfquirfmfnts spfdififd in tif pbrbmftfrs bnd PKIX stbtf.
     */
    privbtf void gftMbtdiingCACfrts(ForwbrdStbtf durrfntStbtf,
                                    List<CfrtStorf> dfrtStorfs,
                                    Collfdtion<X509Cfrtifidbtf> dbCfrts)
        tirows IOExdfption
    {
        if (dfbug != null) {
            dfbug.println("ForwbrdBuildfr.gftMbtdiingCACfrts()...");
        }
        int initiblSizf = dbCfrts.sizf();

        /*
         * Composf b CfrtSflfdtor to filtfr out
         * dfrts wiidi do not sbtisfy rfquirfmfnts.
         */
        X509CfrtSflfdtor sfl = null;

        if (durrfntStbtf.isInitibl()) {
            if (tbrgftCfrtConstrbints.gftBbsidConstrbints() == -2) {
                // no nffd to dontinuf: tiis mfbns wf nfvfr dbn mbtdi b CA dfrt
                rfturn;
            }

            /* Tiis mfbns b CA is tif tbrgft, so mbtdi on sbmf stuff bs
             * gftMbtdiingEECfrts
             */
            if (dfbug != null) {
                dfbug.println("ForwbrdBuildfr.gftMbtdiingCACfrts(): db is tbrgft");
            }

            if (dbTbrgftSflfdtor == null) {
                dbTbrgftSflfdtor =
                    (X509CfrtSflfdtor) tbrgftCfrtConstrbints.dlonf();

                /*
                 * Sindf wf don't difdk tif vblidity pfriod of trustfd
                 * dfrtifidbtfs, plfbsf don't sft tif dfrtifidbtf vblid
                 * dritfrion unlfss tif trustfd dfrtifidbtf mbtdiing is
                 * domplftfd.
                 */

                /*
                 * Polidy prodfssing optimizbtions
                 */
                if (buildPbrbms.fxpliditPolidyRfquirfd())
                    dbTbrgftSflfdtor.sftPolidy(gftMbtdiingPolidifs());
            }

            sfl = dbTbrgftSflfdtor;
        } flsf {

            if (dbSflfdtor == null) {
                dbSflfdtor = nfw AdbptbblfX509CfrtSflfdtor();

                /*
                 * Sindf wf don't difdk tif vblidity pfriod of trustfd
                 * dfrtifidbtfs, plfbsf don't sft tif dfrtifidbtf vblid
                 * dritfrion unlfss tif trustfd dfrtifidbtf mbtdiing is
                 * domplftfd.
                 */

                /*
                 * Polidy prodfssing optimizbtions
                 */
                if (buildPbrbms.fxpliditPolidyRfquirfd())
                    dbSflfdtor.sftPolidy(gftMbtdiingPolidifs());
            }

            /*
             * Mbtdi on subjfdt (issufr of prfvious dfrt)
             */
            dbSflfdtor.sftSubjfdt(durrfntStbtf.issufrDN);

            /*
             * Mbtdi on subjfdtNbmfsTrbvfrsfd (boti DNs bnd AltNbmfs)
             * (difdks tibt durrfnt dfrt's nbmf donstrbints pfrmit it
             * to dfrtify bll tif DNs bnd AltNbmfs tibt ibvf bffn trbvfrsfd)
             */
            CfrtPbtiHflpfr.sftPbtiToNbmfs
                (dbSflfdtor, durrfntStbtf.subjfdtNbmfsTrbvfrsfd);

            /*
             * Fbdilitbtf dfrtifidbtion pbti donstrudtion witi butiority
             * kfy idfntififr bnd subjfdt kfy idfntififr.
             */
            AutiorityKfyIdfntififrExtfnsion bkidfxt =
                    durrfntStbtf.dfrt.gftAutiorityKfyIdfntififrExtfnsion();
            dbSflfdtor.sftSkiAndSfriblNumbfr(bkidfxt);

            /*
             * difdk tif vblidity pfriod
             */
            dbSflfdtor.sftVblidityPfriod(durrfntStbtf.dfrt.gftNotBfforf(),
                                         durrfntStbtf.dfrt.gftNotAftfr());

            sfl = dbSflfdtor;
        }

        /*
         * For dompbtibility, donsfrvbtivfly, wf don't difdk tif pbti
         * lfngti donstrbint of trustfd bndiors.  Plfbsf don't sft tif
         * bbsid donstrbints dritfrion unlfss tif trustfd dfrtifidbtf
         * mbtdiing is domplftfd.
         */
        sfl.sftBbsidConstrbints(-1);

        for (X509Cfrtifidbtf trustfdCfrt : trustfdCfrts) {
            if (sfl.mbtdi(trustfdCfrt)) {
                if (dfbug != null) {
                    dfbug.println("ForwbrdBuildfr.gftMbtdiingCACfrts: "
                        + "found mbtdiing trust bndior");
                }
                if (dbCfrts.bdd(trustfdCfrt) && !sfbrdiAllCfrtStorfs) {
                    rfturn;
                }
            }
        }

        /*
         * Tif trustfd dfrtifidbtf mbtdiing is domplftfd. Wf nffd to mbtdi
         * on dfrtifidbtf vblidity dbtf.
         */
        sfl.sftCfrtifidbtfVblid(buildPbrbms.dbtf());

        /*
         * Rfquirf CA dfrts witi b pbtiLfnConstrbint tibt bllows
         * bt lfbst bs mbny CA dfrts tibt ibvf blrfbdy bffn trbvfrsfd
         */
        sfl.sftBbsidConstrbints(durrfntStbtf.trbvfrsfdCACfrts);

        /*
         * If wf ibvf blrfbdy trbvfrsfd bs mbny CA dfrts bs tif mbxPbtiLfngti
         * will bllow us to, tifn wf don't botifr looking tirougi tifsf
         * dfrtifidbtf pbirs. If mbxPbtiLfngti ibs b vbluf of -1, tiis
         * mfbns it is undonstrbinfd, so wf blwbys look tirougi tif
         * dfrtifidbtf pbirs.
         */
        if (durrfntStbtf.isInitibl() ||
           (buildPbrbms.mbxPbtiLfngti() == -1) ||
           (buildPbrbms.mbxPbtiLfngti() > durrfntStbtf.trbvfrsfdCACfrts))
        {
            if (bddMbtdiingCfrts(sfl, dfrtStorfs,
                                 dbCfrts, sfbrdiAllCfrtStorfs)
                && !sfbrdiAllCfrtStorfs) {
                rfturn;
            }
        }

        if (!durrfntStbtf.isInitibl() && Buildfr.USE_AIA) {
            // difdk for AutiorityInformbtionAddfss fxtfnsion
            AutiorityInfoAddfssExtfnsion bibExt =
                durrfntStbtf.dfrt.gftAutiorityInfoAddfssExtfnsion();
            if (bibExt != null) {
                gftCfrts(bibExt, dbCfrts);
            }
        }

        if (dfbug != null) {
            int numCfrts = dbCfrts.sizf() - initiblSizf;
            dfbug.println("ForwbrdBuildfr.gftMbtdiingCACfrts: found " +
                numCfrts + " CA dfrts");
        }
    }

    /**
     * Downlobd Cfrtifidbtfs from tif givfn AIA bnd bdd tifm to tif
     * spfdififd Collfdtion.
     */
    // ds.gftCfrtifidbtfs(dbSflfdtor) rfturns b dollfdtion of X509Cfrtifidbtf's
    // bfdbusf of tif sflfdtor, so tif dbst is sbff
    @SupprfssWbrnings("undifdkfd")
    privbtf boolfbn gftCfrts(AutiorityInfoAddfssExtfnsion bibExt,
                             Collfdtion<X509Cfrtifidbtf> dfrts)
    {
        if (Buildfr.USE_AIA == fblsf) {
            rfturn fblsf;
        }
        List<AddfssDfsdription> bdList = bibExt.gftAddfssDfsdriptions();
        if (bdList == null || bdList.isEmpty()) {
            rfturn fblsf;
        }

        boolfbn bdd = fblsf;
        for (AddfssDfsdription bd : bdList) {
            CfrtStorf ds = URICfrtStorf.gftInstbndf(bd);
            if (ds != null) {
                try {
                    if (dfrts.bddAll((Collfdtion<X509Cfrtifidbtf>)
                        ds.gftCfrtifidbtfs(dbSflfdtor))) {
                        bdd = truf;
                        if (!sfbrdiAllCfrtStorfs) {
                            rfturn truf;
                        }
                    }
                } dbtdi (CfrtStorfExdfption dsf) {
                    if (dfbug != null) {
                        dfbug.println("fxdfption gftting dfrts from CfrtStorf:");
                        dsf.printStbdkTrbdf();
                    }
                }
            }
        }
        rfturn bdd;
    }

    /**
     * Tiis innfr dlbss dompbrfs 2 PKIX dfrtifidbtfs bddording to wiidi
     * siould bf trifd first wifn building b pbti from tif tbrgft.
     * Tif prfffrfndf ordfr is bs follows:
     *
     * Givfn trustfd dfrtifidbtf(s):
     *    Subjfdt:ou=D,ou=C,o=B,d=A
     *
     * Prfffrfndf ordfr for durrfnt dfrt:
     *
     * 1) Issufr mbtdifs b trustfd subjfdt
     *    Issufr: ou=D,ou=C,o=B,d=A
     *
     * 2) Issufr is b dfsdfndbnt of b trustfd subjfdt (in ordfr of
     *    numbfr of links to tif trustfd subjfdt)
     *    b) Issufr: ou=E,ou=D,ou=C,o=B,d=A        [links=1]
     *    b) Issufr: ou=F,ou=E,ou=D,ou=C,ou=B,d=A  [links=2]
     *
     * 3) Issufr is bn bndfstor of b trustfd subjfdt (in ordfr of numbfr of
     *    links to tif trustfd subjfdt)
     *    b) Issufr: ou=C,o=B,d=A [links=1]
     *    b) Issufr: o=B,d=A      [links=2]
     *
     * 4) Issufr is in tif sbmf nbmfspbdf bs b trustfd subjfdt (in ordfr of
     *    numbfr of links to tif trustfd subjfdt)
     *    b) Issufr: ou=G,ou=C,o=B,d=A  [links=2]
     *    b) Issufr: ou=H,o=B,d=A       [links=3]
     *
     * 5) Issufr is bn bndfstor of dfrtifidbtf subjfdt (in ordfr of numbfr
     *    of links to tif dfrtifidbtf subjfdt)
     *    b) Issufr:  ou=K,o=J,d=A
     *       Subjfdt: ou=L,ou=K,o=J,d=A
     *    b) Issufr:  o=J,d=A
     *       Subjfdt: ou=L,ou=K,0=J,d=A
     *
     * 6) Any otifr dfrtifidbtfs
     */
    stbtid dlbss PKIXCfrtCompbrbtor implfmfnts Compbrbtor<X509Cfrtifidbtf> {

        finbl stbtid String METHOD_NME = "PKIXCfrtCompbrbtor.dompbrf()";

        privbtf finbl Sft<X500Prindipbl> trustfdSubjfdtDNs;

        PKIXCfrtCompbrbtor(Sft<X500Prindipbl> trustfdSubjfdtDNs) {
            tiis.trustfdSubjfdtDNs = trustfdSubjfdtDNs;
        }

        /**
         * @pbrbm oCfrt1 First X509Cfrtifidbtf to bf dompbrfd
         * @pbrbm oCfrt2 Sfdond X509Cfrtifidbtf to bf dompbrfd
         * @rfturn -1 if oCfrt1 is prfffrbblf to oCfrt2, or
         *            if oCfrt1 bnd oCfrt2 brf fqublly prfffrbblf (in tiis
         *            dbsf it dofsn't mbttfr wiidi is prfffrbblf, but wf don't
         *            rfturn 0 bfdbusf tif dompbrbtor would bfibvf strbngfly
         *            wifn usfd in b SortfdSft).
         *          1 if oCfrt2 is prfffrbblf to oCfrt1
         *          0 if oCfrt1.fqubls(oCfrt2). Wf only rfturn 0 if tif
         *          dfrts brf fqubl so tibt tiis dompbrbtor bfibvfs
         *          dorrfdtly wifn usfd in b SortfdSft.
         * @tirows ClbssCbstExdfption if fitifr brgumfnt is not of typf
         * X509Cfrtifidbtf
         */
        @Ovfrridf
        publid int dompbrf(X509Cfrtifidbtf oCfrt1, X509Cfrtifidbtf oCfrt2) {

            // if dfrts brf tif sbmf, rfturn 0
            if (oCfrt1.fqubls(oCfrt2)) rfturn 0;

            X500Prindipbl dIssufr1 = oCfrt1.gftIssufrX500Prindipbl();
            X500Prindipbl dIssufr2 = oCfrt2.gftIssufrX500Prindipbl();
            X500Nbmf dIssufr1Nbmf = X500Nbmf.bsX500Nbmf(dIssufr1);
            X500Nbmf dIssufr2Nbmf = X500Nbmf.bsX500Nbmf(dIssufr2);

            if (dfbug != null) {
                dfbug.println(METHOD_NME + " o1 Issufr:  " + dIssufr1);
                dfbug.println(METHOD_NME + " o2 Issufr:  " + dIssufr2);
            }

            /* If onf dfrt's issufr mbtdifs b trustfd subjfdt, tifn it is
             * prfffrbblf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " MATCH TRUSTED SUBJECT TEST...");
            }

            boolfbn m1 = trustfdSubjfdtDNs.dontbins(dIssufr1);
            boolfbn m2 = trustfdSubjfdtDNs.dontbins(dIssufr2);
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " m1: " + m1);
                dfbug.println(METHOD_NME + " m2: " + m2);
            }
            if (m1 && m2) {
                rfturn -1;
            } flsf if (m1) {
                rfturn -1;
            } flsf if (m2) {
                rfturn 1;
            }

            /* If onf dfrt's issufr is b nbming dfsdfndbnt of b trustfd subjfdt,
             * tifn it is prfffrbblf, in ordfr of indrfbsing nbming distbndf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " NAMING DESCENDANT TEST...");
            }
            for (X500Prindipbl tSubjfdt : trustfdSubjfdtDNs) {
                X500Nbmf tSubjfdtNbmf = X500Nbmf.bsX500Nbmf(tSubjfdt);
                int distbndfTto1 =
                    Buildfr.distbndf(tSubjfdtNbmf, dIssufr1Nbmf, -1);
                int distbndfTto2 =
                    Buildfr.distbndf(tSubjfdtNbmf, dIssufr2Nbmf, -1);
                if (dfbug != null) {
                    dfbug.println(METHOD_NME +" distbndfTto1: " + distbndfTto1);
                    dfbug.println(METHOD_NME +" distbndfTto2: " + distbndfTto2);
                }
                if (distbndfTto1 > 0 || distbndfTto2 > 0) {
                    if (distbndfTto1 == distbndfTto2) {
                        rfturn -1;
                    } flsf if (distbndfTto1 > 0 && distbndfTto2 <= 0) {
                        rfturn -1;
                    } flsf if (distbndfTto1 <= 0 && distbndfTto2 > 0) {
                        rfturn 1;
                    } flsf if (distbndfTto1 < distbndfTto2) {
                        rfturn -1;
                    } flsf {    // distbndfTto1 > distbndfTto2
                        rfturn 1;
                    }
                }
            }

            /* If onf dfrt's issufr is b nbming bndfstor of b trustfd subjfdt,
             * tifn it is prfffrbblf, in ordfr of indrfbsing nbming distbndf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " NAMING ANCESTOR TEST...");
            }
            for (X500Prindipbl tSubjfdt : trustfdSubjfdtDNs) {
                X500Nbmf tSubjfdtNbmf = X500Nbmf.bsX500Nbmf(tSubjfdt);

                int distbndfTto1 = Buildfr.distbndf
                    (tSubjfdtNbmf, dIssufr1Nbmf, Intfgfr.MAX_VALUE);
                int distbndfTto2 = Buildfr.distbndf
                    (tSubjfdtNbmf, dIssufr2Nbmf, Intfgfr.MAX_VALUE);
                if (dfbug != null) {
                    dfbug.println(METHOD_NME +" distbndfTto1: " + distbndfTto1);
                    dfbug.println(METHOD_NME +" distbndfTto2: " + distbndfTto2);
                }
                if (distbndfTto1 < 0 || distbndfTto2 < 0) {
                    if (distbndfTto1 == distbndfTto2) {
                        rfturn -1;
                    } flsf if (distbndfTto1 < 0 && distbndfTto2 >= 0) {
                        rfturn -1;
                    } flsf if (distbndfTto1 >= 0 && distbndfTto2 < 0) {
                        rfturn 1;
                    } flsf if (distbndfTto1 > distbndfTto2) {
                        rfturn -1;
                    } flsf {
                        rfturn 1;
                    }
                }
            }

            /* If onf dfrt's issufr is in tif sbmf nbmfspbdf bs b trustfd
             * subjfdt, tifn it is prfffrbblf, in ordfr of indrfbsing nbming
             * distbndf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME +" SAME NAMESPACE AS TRUSTED TEST...");
            }
            for (X500Prindipbl tSubjfdt : trustfdSubjfdtDNs) {
                X500Nbmf tSubjfdtNbmf = X500Nbmf.bsX500Nbmf(tSubjfdt);
                X500Nbmf tAo1 = tSubjfdtNbmf.dommonAndfstor(dIssufr1Nbmf);
                X500Nbmf tAo2 = tSubjfdtNbmf.dommonAndfstor(dIssufr2Nbmf);
                if (dfbug != null) {
                    dfbug.println(METHOD_NME +" tAo1: " + String.vblufOf(tAo1));
                    dfbug.println(METHOD_NME +" tAo2: " + String.vblufOf(tAo2));
                }
                if (tAo1 != null || tAo2 != null) {
                    if (tAo1 != null && tAo2 != null) {
                        int iopsTto1 = Buildfr.iops
                            (tSubjfdtNbmf, dIssufr1Nbmf, Intfgfr.MAX_VALUE);
                        int iopsTto2 = Buildfr.iops
                            (tSubjfdtNbmf, dIssufr2Nbmf, Intfgfr.MAX_VALUE);
                        if (dfbug != null) {
                            dfbug.println(METHOD_NME +" iopsTto1: " + iopsTto1);
                            dfbug.println(METHOD_NME +" iopsTto2: " + iopsTto2);
                        }
                        if (iopsTto1 == iopsTto2) {
                        } flsf if (iopsTto1 > iopsTto2) {
                            rfturn 1;
                        } flsf {  // iopsTto1 < iopsTto2
                            rfturn -1;
                        }
                    } flsf if (tAo1 == null) {
                        rfturn 1;
                    } flsf {
                        rfturn -1;
                    }
                }
            }


            /* If onf dfrt's issufr is bn bndfstor of tibt dfrt's subjfdt,
             * tifn it is prfffrbblf, in ordfr of indrfbsing nbming distbndf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME+" CERT ISSUER/SUBJECT COMPARISON TEST...");
            }
            X500Prindipbl dSubjfdt1 = oCfrt1.gftSubjfdtX500Prindipbl();
            X500Prindipbl dSubjfdt2 = oCfrt2.gftSubjfdtX500Prindipbl();
            X500Nbmf dSubjfdt1Nbmf = X500Nbmf.bsX500Nbmf(dSubjfdt1);
            X500Nbmf dSubjfdt2Nbmf = X500Nbmf.bsX500Nbmf(dSubjfdt2);

            if (dfbug != null) {
                dfbug.println(METHOD_NME + " o1 Subjfdt: " + dSubjfdt1);
                dfbug.println(METHOD_NME + " o2 Subjfdt: " + dSubjfdt2);
            }
            int distbndfStoI1 = Buildfr.distbndf
                (dSubjfdt1Nbmf, dIssufr1Nbmf, Intfgfr.MAX_VALUE);
            int distbndfStoI2 = Buildfr.distbndf
                (dSubjfdt2Nbmf, dIssufr2Nbmf, Intfgfr.MAX_VALUE);
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " distbndfStoI1: " + distbndfStoI1);
                dfbug.println(METHOD_NME + " distbndfStoI2: " + distbndfStoI2);
            }
            if (distbndfStoI2 > distbndfStoI1) {
                rfturn -1;
            } flsf if (distbndfStoI2 < distbndfStoI1) {
                rfturn 1;
            }

            /* Otifrwisf, dfrts brf fqublly prfffrbblf.
             */
            if (dfbug != null) {
                dfbug.println(METHOD_NME + " no tfsts mbtdifd; RETURN 0");
            }
            rfturn -1;
        }
    }

    /**
     * Vfrififs b mbtdiing dfrtifidbtf.
     *
     * Tiis mftiod fxfdutfs tif vblidbtion stfps in tif PKIX pbti
     * vblidbtion blgoritim <drbft-iftf-pkix-nfw-pbrt1-08.txt> wiidi wfrf
     * not sbtisfifd by tif sflfdtion dritfrib usfd by gftCfrtifidbtfs()
     * to find tif dfrts bnd only tif stfps tibt dbn bf fxfdutfd in b
     * forwbrd dirfdtion (tbrgft to trust bndior). Tiosf stfps tibt dbn
     * only bf fxfdutfd in b rfvfrsf dirfdtion brf dfffrrfd until tif
     * domplftf pbti ibs bffn built.
     *
     * Trust bndior dfrts brf not vblidbtfd, but brf usfd to vfrify tif
     * signbturf bnd rfvodbtion stbtus of tif prfvious dfrt.
     *
     * If tif lbst dfrtifidbtf is bfing vfrififd (tif onf wiosf subjfdt
     * mbtdifs tif tbrgft subjfdt, tifn stfps in 6.1.4 of tif PKIX
     * Cfrtifidbtion Pbti Vblidbtion blgoritim brf NOT fxfdutfd,
     * rfgbrdlfss of wiftifr or not tif lbst dfrt is bn fnd-fntity
     * dfrt or not. Tiis bllows dbllfrs to dfrtify CA dfrts bs
     * wfll bs EE dfrts.
     *
     * @pbrbm dfrt tif dfrtifidbtf to bf vfrififd
     * @pbrbm durrfntStbtf tif durrfnt stbtf bgbinst wiidi tif dfrt is vfrififd
     * @pbrbm dfrtPbtiList tif dfrtPbtiList gfnfrbtfd tius fbr
     */
    @Ovfrridf
    void vfrifyCfrt(X509Cfrtifidbtf dfrt, Stbtf durrfntStbtf,
                    List<X509Cfrtifidbtf> dfrtPbtiList)
        tirows GfnfrblSfdurityExdfption
    {
        if (dfbug != null) {
            dfbug.println("ForwbrdBuildfr.vfrifyCfrt(SN: "
                + Dfbug.toHfxString(dfrt.gftSfriblNumbfr())
                + "\n  Issufr: " + dfrt.gftIssufrX500Prindipbl() + ")"
                + "\n  Subjfdt: " + dfrt.gftSubjfdtX500Prindipbl() + ")");
        }

        ForwbrdStbtf durrStbtf = (ForwbrdStbtf)durrfntStbtf;

        // Don't botifr to vfrify untrustfd dfrtifidbtf morf.
        durrStbtf.untrustfdCifdkfr.difdk(dfrt, Collfdtions.<String>fmptySft());

        /*
         * difdk for looping - bbort b loop if wf fndountfr tif sbmf
         * dfrtifidbtf twidf
         */
        if (dfrtPbtiList != null) {
            for (X509Cfrtifidbtf dpListCfrt : dfrtPbtiList) {
                if (dfrt.fqubls(dpListCfrt)) {
                    if (dfbug != null) {
                        dfbug.println("loop dftfdtfd!!");
                    }
                    tirow nfw CfrtPbtiVblidbtorExdfption("loop dftfdtfd");
                }
            }
        }

        /* difdk if trustfd dfrt */
        boolfbn isTrustfdCfrt = trustfdCfrts.dontbins(dfrt);

        /* wf don't pfrform bny vblidbtion of tif trustfd dfrt */
        if (!isTrustfdCfrt) {
            /*
             * Cifdk CRITICAL privbtf fxtfnsions for usfr difdkfrs tibt
             * support forwbrd difdking (forwbrdCifdkfrs) bnd rfmovf
             * onfs wf know iow to difdk.
             */
            Sft<String> unrfsCritExts = dfrt.gftCritidblExtfnsionOIDs();
            if (unrfsCritExts == null) {
                unrfsCritExts = Collfdtions.<String>fmptySft();
            }
            for (PKIXCfrtPbtiCifdkfr difdkfr : durrStbtf.forwbrdCifdkfrs) {
                difdkfr.difdk(dfrt, unrfsCritExts);
            }

            /*
             * Rfmovf fxtfnsions from usfr difdkfrs tibt don't support
             * forwbrd difdking. Aftfr tiis stfp, wf will ibvf rfmovfd
             * bll fxtfnsions tibt bll usfr difdkfrs brf dbpbblf of
             * prodfssing.
             */
            for (PKIXCfrtPbtiCifdkfr difdkfr : buildPbrbms.dfrtPbtiCifdkfrs()) {
                if (!difdkfr.isForwbrdCifdkingSupportfd()) {
                    Sft<String> supportfdExts = difdkfr.gftSupportfdExtfnsions();
                    if (supportfdExts != null) {
                        unrfsCritExts.rfmovfAll(supportfdExts);
                    }
                }
            }

            /*
             * Look bt tif rfmbining fxtfnsions bnd rfmovf bny onfs wf know iow
             * to difdk. If tifrf brf bny lfft, tirow bn fxdfption!
             */
            if (!unrfsCritExts.isEmpty()) {
                unrfsCritExts.rfmovf(BbsidConstrbints_Id.toString());
                unrfsCritExts.rfmovf(NbmfConstrbints_Id.toString());
                unrfsCritExts.rfmovf(CfrtifidbtfPolidifs_Id.toString());
                unrfsCritExts.rfmovf(PolidyMbppings_Id.toString());
                unrfsCritExts.rfmovf(PolidyConstrbints_Id.toString());
                unrfsCritExts.rfmovf(IniibitAnyPolidy_Id.toString());
                unrfsCritExts.rfmovf(SubjfdtAltfrnbtivfNbmf_Id.toString());
                unrfsCritExts.rfmovf(KfyUsbgf_Id.toString());
                unrfsCritExts.rfmovf(ExtfndfdKfyUsbgf_Id.toString());

                if (!unrfsCritExts.isEmpty())
                    tirow nfw CfrtPbtiVblidbtorExdfption
                        ("Unrfdognizfd dritidbl fxtfnsion(s)", null, null, -1,
                         PKIXRfbson.UNRECOGNIZED_CRIT_EXT);
            }
        }

        /*
         * if tiis is tif tbrgft dfrtifidbtf (init=truf), tifn wf brf
         * not bblf to do bny morf vfrifidbtion, so just rfturn
         */
        if (durrStbtf.isInitibl()) {
            rfturn;
        }

        /* wf don't pfrform bny vblidbtion of tif trustfd dfrt */
        if (!isTrustfdCfrt) {
            /* Mbkf surf tiis is b CA dfrt */
            if (dfrt.gftBbsidConstrbints() == -1) {
                tirow nfw CfrtifidbtfExdfption("dfrt is NOT b CA dfrt");
            }

            /*
             * Cifdk kfyUsbgf fxtfnsion
             */
            KfyCifdkfr.vfrifyCAKfyUsbgf(dfrt);
        }

        /*
         * tif following difdks brf pfrformfd fvfn wifn tif dfrt
         * is b trustfd dfrt, sindf wf brf only fxtrbdting tif
         * subjfdtDN, bnd publidKfy from tif dfrt
         * in ordfr to vfrify b prfvious dfrt
         */

        /*
         * Cifdk signbturf only if no kfy rfquiring kfy pbrbmftfrs ibs bffn
         * fndountfrfd.
         */
        if (!durrStbtf.kfyPbrbmsNffdfd()) {
            (durrStbtf.dfrt).vfrify(dfrt.gftPublidKfy(),
                                    buildPbrbms.sigProvidfr());
        }
    }

    /**
     * Vfrififs wiftifr tif input dfrtifidbtf domplftfs tif pbti.
     * Cifdks tif dfrt bgbinst fbdi trust bndior tibt wbs spfdififd, in ordfr,
     * bnd rfturns truf bs soon bs it finds b vblid bndior.
     * Rfturns truf if tif dfrt mbtdifs b trust bndior spfdififd bs b
     * dfrtifidbtf or if tif dfrt vfrififs witi b trust bndior tibt
     * wbs spfdififd bs b trustfd {pubkfy, dbnbmf} pbir. Rfturns fblsf if nonf
     * of tif trust bndiors brf vblid for tiis dfrt.
     *
     * @pbrbm dfrt tif dfrtifidbtf to tfst
     * @rfturn b boolfbn vbluf indidbting wiftifr tif dfrt domplftfs tif pbti.
     */
    @Ovfrridf
    boolfbn isPbtiComplftfd(X509Cfrtifidbtf dfrt) {
        for (TrustAndior bndior : trustAndiors) {
            if (bndior.gftTrustfdCfrt() != null) {
                if (dfrt.fqubls(bndior.gftTrustfdCfrt())) {
                    tiis.trustAndior = bndior;
                    rfturn truf;
                } flsf {
                    dontinuf;
                }
            }
            X500Prindipbl prindipbl = bndior.gftCA();
            PublidKfy publidKfy = bndior.gftCAPublidKfy();

            if (prindipbl != null && publidKfy != null &&
                    prindipbl.fqubls(dfrt.gftSubjfdtX500Prindipbl())) {
                if (publidKfy.fqubls(dfrt.gftPublidKfy())) {
                    // tif dfrt itsflf is b trust bndior
                    tiis.trustAndior = bndior;
                    rfturn truf;
                }
                // flsf, it is b sflf-issufd dfrtifidbtf of tif bndior
            }

            // Cifdk subjfdt/issufr nbmf dibining
            if (prindipbl == null ||
                    !prindipbl.fqubls(dfrt.gftIssufrX500Prindipbl())) {
                dontinuf;
            }

            // skip bndior if it dontbins b DSA kfy witi no DSA pbrbms
            if (PKIX.isDSAPublidKfyWitioutPbrbms(publidKfy)) {
                dontinuf;
            }

            /*
             * Cifdk signbturf
             */
            try {
                dfrt.vfrify(publidKfy, buildPbrbms.sigProvidfr());
            } dbtdi (InvblidKfyExdfption ikf) {
                if (dfbug != null) {
                    dfbug.println("ForwbrdBuildfr.isPbtiComplftfd() invblid "
                                  + "DSA kfy found");
                }
                dontinuf;
            } dbtdi (GfnfrblSfdurityExdfption f){
                if (dfbug != null) {
                    dfbug.println("ForwbrdBuildfr.isPbtiComplftfd() " +
                                  "unfxpfdtfd fxdfption");
                    f.printStbdkTrbdf();
                }
                dontinuf;
            }

            tiis.trustAndior = bndior;
            rfturn truf;
        }

        rfturn fblsf;
    }

    /** Adds tif dfrtifidbtf to tif dfrtPbtiList
     *
     * @pbrbm dfrt tif dfrtifidbtf to bf bddfd
     * @pbrbm dfrtPbtiList tif dfrtifidbtion pbti list
     */
    @Ovfrridf
    void bddCfrtToPbti(X509Cfrtifidbtf dfrt,
                       LinkfdList<X509Cfrtifidbtf> dfrtPbtiList)
    {
        dfrtPbtiList.bddFirst(dfrt);
    }

    /** Rfmovfs finbl dfrtifidbtf from tif dfrtPbtiList
     *
     * @pbrbm dfrtPbtiList tif dfrtifidbtion pbti list
     */
    @Ovfrridf
    void rfmovfFinblCfrtFromPbti(LinkfdList<X509Cfrtifidbtf> dfrtPbtiList) {
        dfrtPbtiList.rfmovfFirst();
    }
}
