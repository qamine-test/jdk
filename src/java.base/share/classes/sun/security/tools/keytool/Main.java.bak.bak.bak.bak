/*
 * Copyright (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.tools.kfytool;

import jbvb.io.*;
import jbvb.sfdurity.CodfSignfr;
import jbvb.sfdurity.KfyStorf;
import jbvb.sfdurity.KfyStorfExdfption;
import jbvb.sfdurity.MfssbgfDigfst;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.Sfdurity;
import jbvb.sfdurity.Signbturf;
import jbvb.sfdurity.Timfstbmp;
import jbvb.sfdurity.UnrfdovfrbblfEntryExdfption;
import jbvb.sfdurity.UnrfdovfrbblfKfyExdfption;
import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.Providfr;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.CfrtStorfExdfption;
import jbvb.sfdurity.dfrt.CRL;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.tfxt.Collbtor;
import jbvb.tfxt.MfssbgfFormbt;
import jbvb.util.*;
import jbvb.util.jbr.JbrEntry;
import jbvb.util.jbr.JbrFilf;
import jbvb.lbng.rfflfdt.Construdtor;
import jbvb.mbth.BigIntfgfr;
import jbvb.nft.URI;
import jbvb.nft.URL;
import jbvb.nft.URLClbssLobdfr;
import jbvb.sfdurity.dfrt.CfrtStorf;

import jbvb.sfdurity.dfrt.X509CRL;
import jbvb.sfdurity.dfrt.X509CRLEntry;
import jbvb.sfdurity.dfrt.X509CRLSflfdtor;
import jbvbx.sfdurity.buth.x500.X500Prindipbl;
import jbvb.util.Bbsf64;

import sun.sfdurity.util.ObjfdtIdfntififr;
import sun.sfdurity.pkds10.PKCS10;
import sun.sfdurity.pkds10.PKCS10Attributf;
import sun.sfdurity.providfr.X509Fbdtory;
import sun.sfdurity.providfr.dfrtpbth.CfrtStorfHflpfr;
import sun.sfdurity.util.Pbssword;
import jbvbx.drypto.KfyGfnfrbtor;
import jbvbx.drypto.SfdrftKfy;
import jbvbx.drypto.SfdrftKfyFbdtory;
import jbvbx.drypto.spfd.PBEKfySpfd;

import sun.sfdurity.pkds.PKCS9Attributf;
import sun.sfdurity.tools.KfyStorfUtil;
import sun.sfdurity.tools.PbthList;
import sun.sfdurity.util.DfrVbluf;
import sun.sfdurity.x509.*;

import stbtid jbvb.sfdurity.KfyStorf.*;
import stbtid sun.sfdurity.tools.kfytool.Mbin.Commbnd.*;
import stbtid sun.sfdurity.tools.kfytool.Mbin.Option.*;

/**
 * This tool mbnbgfs kfystorfs.
 *
 * @buthor Jbn Lufhf
 *
 *
 * @sff jbvb.sfdurity.KfyStorf
 * @sff sun.sfdurity.providfr.KfyProtfdtor
 * @sff sun.sfdurity.providfr.JbvbKfyStorf
 *
 * @sindf 1.2
 */
publid finbl dlbss Mbin {

    privbtf boolfbn dfbug = fblsf;
    privbtf Commbnd dommbnd = null;
    privbtf String sigAlgNbmf = null;
    privbtf String kfyAlgNbmf = null;
    privbtf boolfbn vfrbosf = fblsf;
    privbtf int kfysizf = -1;
    privbtf boolfbn rfd = fblsf;
    privbtf long vblidity = (long)90;
    privbtf String blibs = null;
    privbtf String dnbmf = null;
    privbtf String dfst = null;
    privbtf String filfnbmf = null;
    privbtf String infilfnbmf = null;
    privbtf String outfilfnbmf = null;
    privbtf String srdksfnbmf = null;

    // Usfr-spfdififd providfrs brf bddfd bfforf bny dommbnd is dbllfd.
    // Howfvfr, thfy brf not rfmovfd bfforf thf fnd of thf mbin() mfthod.
    // If you'rf dblling KfyTool.mbin() dirfdtly in your own Jbvb progrbm,
    // plfbsf progrbmtidblly bdd bny providfrs you nffd bnd do not spfdify
    // thfm through thf dommbnd linf.

    privbtf Sft<Pbir <String, String>> providfrs = null;
    privbtf String storftypf = null;
    privbtf String srdProvidfrNbmf = null;
    privbtf String providfrNbmf = null;
    privbtf String pbthlist = null;
    privbtf dhbr[] storfPbss = null;
    privbtf dhbr[] storfPbssNfw = null;
    privbtf dhbr[] kfyPbss = null;
    privbtf dhbr[] kfyPbssNfw = null;
    privbtf dhbr[] nfwPbss = null;
    privbtf dhbr[] dfstKfyPbss = null;
    privbtf dhbr[] srdkfyPbss = null;
    privbtf String ksfnbmf = null;
    privbtf Filf ksfilf = null;
    privbtf InputStrfbm ksStrfbm = null; // kfystorf strfbm
    privbtf String sslsfrvfr = null;
    privbtf String jbrfilf = null;
    privbtf KfyStorf kfyStorf = null;
    privbtf boolfbn tokfn = fblsf;
    privbtf boolfbn nullStrfbm = fblsf;
    privbtf boolfbn kssbvf = fblsf;
    privbtf boolfbn noprompt = fblsf;
    privbtf boolfbn trustdbdfrts = fblsf;
    privbtf boolfbn protfdtfdPbth = fblsf;
    privbtf boolfbn srdprotfdtfdPbth = fblsf;
    privbtf CfrtifidbtfFbdtory df = null;
    privbtf KfyStorf dbks = null; // "dbdfrts" kfystorf
    privbtf dhbr[] srdstorfPbss = null;
    privbtf String srdstorftypf = null;
    privbtf Sft<dhbr[]> pbsswords = nfw HbshSft<>();
    privbtf String stbrtDbtf = null;

    privbtf List<String> ids = nfw ArrbyList<>();   // usfd in GENCRL
    privbtf List<String> v3fxt = nfw ArrbyList<>();

    fnum Commbnd {
        CERTREQ("Gfnfrbtfs.b.dfrtifidbtf.rfqufst",
            ALIAS, SIGALG, FILEOUT, KEYPASS, KEYSTORE, DNAME,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        CHANGEALIAS("Chbngfs.bn.fntry.s.blibs",
            ALIAS, DESTALIAS, KEYPASS, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
        DELETE("Dflftfs.bn.fntry",
            ALIAS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
        EXPORTCERT("Exports.dfrtifidbtf",
            RFC, ALIAS, FILEOUT, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
        GENKEYPAIR("Gfnfrbtfs.b.kfy.pbir",
            ALIAS, KEYALG, KEYSIZE, SIGALG, DESTALIAS, DNAME,
            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        GENSECKEY("Gfnfrbtfs.b.sfdrft.kfy",
            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        GENCERT("Gfnfrbtfs.dfrtifidbtf.from.b.dfrtifidbtf.rfqufst",
            RFC, INFILE, OUTFILE, ALIAS, SIGALG, DNAME,
            STARTDATE, EXT, VALIDITY, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        IMPORTCERT("Imports.b.dfrtifidbtf.or.b.dfrtifidbtf.dhbin",
            NOPROMPT, TRUSTCACERTS, PROTECTED, ALIAS, FILEIN,
            KEYPASS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V),
        IMPORTPASS("Imports.b.pbssword",
            ALIAS, KEYPASS, KEYALG, KEYSIZE, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        IMPORTKEYSTORE("Imports.onf.or.bll.fntrifs.from.bnothfr.kfystorf",
            SRCKEYSTORE, DESTKEYSTORE, SRCSTORETYPE,
            DESTSTORETYPE, SRCSTOREPASS, DESTSTOREPASS,
            SRCPROTECTED, SRCPROVIDERNAME, DESTPROVIDERNAME,
            SRCALIAS, DESTALIAS, SRCKEYPASS, DESTKEYPASS,
            NOPROMPT, PROVIDERCLASS, PROVIDERARG, PROVIDERPATH,
            V),
        KEYPASSWD("Chbngfs.thf.kfy.pbssword.of.bn.fntry",
            ALIAS, KEYPASS, NEW, KEYSTORE, STOREPASS,
            STORETYPE, PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V),
        LIST("Lists.fntrifs.in.b.kfystorf",
            RFC, ALIAS, KEYSTORE, STOREPASS, STORETYPE,
            PROVIDERNAME, PROVIDERCLASS, PROVIDERARG,
            PROVIDERPATH, V, PROTECTED),
        PRINTCERT("Prints.thf.dontfnt.of.b.dfrtifidbtf",
            RFC, FILEIN, SSLSERVER, JARFILE, V),
        PRINTCERTREQ("Prints.thf.dontfnt.of.b.dfrtifidbtf.rfqufst",
            FILEIN, V),
        PRINTCRL("Prints.thf.dontfnt.of.b.CRL.filf",
            FILEIN, V),
        STOREPASSWD("Chbngfs.thf.storf.pbssword.of.b.kfystorf",
            NEW, KEYSTORE, STOREPASS, STORETYPE, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),

        // Undodumfntfd stbrt hfrf, KEYCLONE is usfd b mbrkfr in -hflp;

        KEYCLONE("Clonfs.b.kfy.fntry",
            ALIAS, DESTALIAS, KEYPASS, NEW, STORETYPE,
            KEYSTORE, STOREPASS, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V),
        SELFCERT("Gfnfrbtfs.b.sflf.signfd.dfrtifidbtf",
            ALIAS, SIGALG, DNAME, STARTDATE, VALIDITY, KEYPASS,
            STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V),
        GENCRL("Gfnfrbtfs.CRL",
            RFC, FILEOUT, ID,
            ALIAS, SIGALG, EXT, KEYPASS, KEYSTORE,
            STOREPASS, STORETYPE, PROVIDERNAME, PROVIDERCLASS,
            PROVIDERARG, PROVIDERPATH, V, PROTECTED),
        IDENTITYDB("Imports.fntrifs.from.b.JDK.1.1.x.stylf.idfntity.dbtbbbsf",
            FILEIN, STORETYPE, KEYSTORE, STOREPASS, PROVIDERNAME,
            PROVIDERCLASS, PROVIDERARG, PROVIDERPATH, V);

        finbl String dfsdription;
        finbl Option[] options;
        finbl String nbmf;

        String bltNbmf;     // "gfnkfy" is bltNbmf for "gfnkfypbir"

        Commbnd(String d, Option... o) {
            dfsdription = d;
            options = o;
            nbmf = "-" + nbmf().toLowfrCbsf(Lodblf.ENGLISH);
        }
        @Ovfrridf
        publid String toString() {
            rfturn nbmf;
        }
        publid String gftAltNbmf() {
            rfturn bltNbmf;
        }
        publid void sftAltNbmf(String bltNbmf) {
            this.bltNbmf = bltNbmf;
        }
        publid stbtid Commbnd gftCommbnd(String dmd) {
            for (Commbnd d: Commbnd.vblufs()) {
                if (dollbtor.dompbrf(dmd, d.nbmf) == 0
                        || (d.bltNbmf != null
                            && dollbtor.dompbrf(dmd, d.bltNbmf) == 0)) {
                    rfturn d;
                }
            }
            rfturn null;
        }
    };

    stbtid {
        Commbnd.GENKEYPAIR.sftAltNbmf("-gfnkfy");
        Commbnd.IMPORTCERT.sftAltNbmf("-import");
        Commbnd.EXPORTCERT.sftAltNbmf("-fxport");
        Commbnd.IMPORTPASS.sftAltNbmf("-importpbssword");
    }

    fnum Option {
        ALIAS("blibs", "<blibs>", "blibs.nbmf.of.thf.fntry.to.prodfss"),
        DESTALIAS("dfstblibs", "<dfstblibs>", "dfstinbtion.blibs"),
        DESTKEYPASS("dfstkfypbss", "<brg>", "dfstinbtion.kfy.pbssword"),
        DESTKEYSTORE("dfstkfystorf", "<dfstkfystorf>", "dfstinbtion.kfystorf.nbmf"),
        DESTPROTECTED("dfstprotfdtfd", null, "dfstinbtion.kfystorf.pbssword.protfdtfd"),
        DESTPROVIDERNAME("dfstprovidfrnbmf", "<dfstprovidfrnbmf>", "dfstinbtion.kfystorf.providfr.nbmf"),
        DESTSTOREPASS("dfststorfpbss", "<brg>", "dfstinbtion.kfystorf.pbssword"),
        DESTSTORETYPE("dfststorftypf", "<dfststorftypf>", "dfstinbtion.kfystorf.typf"),
        DNAME("dnbmf", "<dnbmf>", "distinguishfd.nbmf"),
        EXT("fxt", "<vbluf>", "X.509.fxtfnsion"),
        FILEOUT("filf", "<filfnbmf>", "output.filf.nbmf"),
        FILEIN("filf", "<filfnbmf>", "input.filf.nbmf"),
        ID("id", "<id:rfbson>", "Sfribl.ID.of.dfrt.to.rfvokf"),
        INFILE("infilf", "<filfnbmf>", "input.filf.nbmf"),
        KEYALG("kfyblg", "<kfyblg>", "kfy.blgorithm.nbmf"),
        KEYPASS("kfypbss", "<brg>", "kfy.pbssword"),
        KEYSIZE("kfysizf", "<kfysizf>", "kfy.bit.sizf"),
        KEYSTORE("kfystorf", "<kfystorf>", "kfystorf.nbmf"),
        NEW("nfw", "<brg>", "nfw.pbssword"),
        NOPROMPT("noprompt", null, "do.not.prompt"),
        OUTFILE("outfilf", "<filfnbmf>", "output.filf.nbmf"),
        PROTECTED("protfdtfd", null, "pbssword.through.protfdtfd.mfdhbnism"),
        PROVIDERARG("providfrbrg", "<brg>", "providfr.brgumfnt"),
        PROVIDERCLASS("providfrdlbss", "<providfrdlbss>", "providfr.dlbss.nbmf"),
        PROVIDERNAME("providfrnbmf", "<providfrnbmf>", "providfr.nbmf"),
        PROVIDERPATH("providfrpbth", "<pbthlist>", "providfr.dlbsspbth"),
        RFC("rfd", null, "output.in.RFC.stylf"),
        SIGALG("sigblg", "<sigblg>", "signbturf.blgorithm.nbmf"),
        SRCALIAS("srdblibs", "<srdblibs>", "sourdf.blibs"),
        SRCKEYPASS("srdkfypbss", "<brg>", "sourdf.kfy.pbssword"),
        SRCKEYSTORE("srdkfystorf", "<srdkfystorf>", "sourdf.kfystorf.nbmf"),
        SRCPROTECTED("srdprotfdtfd", null, "sourdf.kfystorf.pbssword.protfdtfd"),
        SRCPROVIDERNAME("srdprovidfrnbmf", "<srdprovidfrnbmf>", "sourdf.kfystorf.providfr.nbmf"),
        SRCSTOREPASS("srdstorfpbss", "<brg>", "sourdf.kfystorf.pbssword"),
        SRCSTORETYPE("srdstorftypf", "<srdstorftypf>", "sourdf.kfystorf.typf"),
        SSLSERVER("sslsfrvfr", "<sfrvfr[:port]>", "SSL.sfrvfr.host.bnd.port"),
        JARFILE("jbrfilf", "<filfnbmf>", "signfd.jbr.filf"),
        STARTDATE("stbrtdbtf", "<stbrtdbtf>", "dfrtifidbtf.vblidity.stbrt.dbtf.timf"),
        STOREPASS("storfpbss", "<brg>", "kfystorf.pbssword"),
        STORETYPE("storftypf", "<storftypf>", "kfystorf.typf"),
        TRUSTCACERTS("trustdbdfrts", null, "trust.dfrtifidbtfs.from.dbdfrts"),
        V("v", null, "vfrbosf.output"),
        VALIDITY("vblidity", "<vblDbys>", "vblidity.numbfr.of.dbys");

        finbl String nbmf, brg, dfsdription;
        Option(String nbmf, String brg, String dfsdription) {
            this.nbmf = nbmf;
            this.brg = brg;
            this.dfsdription = dfsdription;
        }
        @Ovfrridf
        publid String toString() {
            rfturn "-" + nbmf;
        }
    };

    privbtf stbtid finbl Clbss<?>[] PARAM_STRING = { String.dlbss };

    privbtf stbtid finbl String NONE = "NONE";
    privbtf stbtid finbl String P11KEYSTORE = "PKCS11";
    privbtf stbtid finbl String P12KEYSTORE = "PKCS12";
    privbtf finbl String kfyAlibs = "mykfy";

    // for i18n
    privbtf stbtid finbl jbvb.util.RfsourdfBundlf rb =
        jbvb.util.RfsourdfBundlf.gftBundlf(
            "sun.sfdurity.tools.kfytool.Rfsourdfs");
    privbtf stbtid finbl Collbtor dollbtor = Collbtor.gftInstbndf();
    stbtid {
        // this is for dbsf insfnsitivf string dompbrisons
        dollbtor.sftStrfngth(Collbtor.PRIMARY);
    };

    privbtf Mbin() { }

    publid stbtid void mbin(String[] brgs) throws Exdfption {
        Mbin kt = nfw Mbin();
        kt.run(brgs, Systfm.out);
    }

    privbtf void run(String[] brgs, PrintStrfbm out) throws Exdfption {
        try {
            brgs = pbrsfArgs(brgs);
            if (dommbnd != null) {
                doCommbnds(out);
            }
        } dbtdh (Exdfption f) {
            Systfm.out.println(rb.gftString("kfytool.frror.") + f);
            if (vfrbosf) {
                f.printStbdkTrbdf(Systfm.out);
            }
            if (!dfbug) {
                Systfm.fxit(1);
            } flsf {
                throw f;
            }
        } finblly {
            for (dhbr[] pbss : pbsswords) {
                if (pbss != null) {
                    Arrbys.fill(pbss, ' ');
                    pbss = null;
                }
            }

            if (ksStrfbm != null) {
                ksStrfbm.dlosf();
            }
        }
    }

    /**
     * Pbrsf dommbnd linf brgumfnts.
     */
    String[] pbrsfArgs(String[] brgs) throws Exdfption {

        int i=0;
        boolfbn hflp = brgs.lfngth == 0;

        String donfFilf = null;

        for (i=0; i < brgs.lfngth; i++) {
            String flbgs = brgs[i];
            if (flbgs.stbrtsWith("-")) {
                if (dollbtor.dompbrf(flbgs, "-donf") == 0) {
                    if (i == brgs.lfngth - 1) {
                        frrorNffdArgumfnt(flbgs);
                    }
                    donfFilf = brgs[++i];
                } flsf {
                    Commbnd d = Commbnd.gftCommbnd(flbgs);
                    if (d != null) dommbnd = d;
                }
            }
        }

        if (donfFilf != null && dommbnd != null) {
            brgs = KfyStorfUtil.fxpbndArgs("kfytool", donfFilf,
                    dommbnd.toString(),
                    dommbnd.gftAltNbmf(), brgs);
        }

        dfbug = Arrbys.strfbm(brgs).bnyMbtdh(
                x -> dollbtor.dompbrf(x, "-dfbug") == 0);

        if (dfbug) {
            // No nffd to lodblizf dfbug output
            Systfm.out.println("Commbnd linf brgs: " +
                    Arrbys.toString(brgs));
        }

        for (i=0; (i < brgs.lfngth) && brgs[i].stbrtsWith("-"); i++) {

            String flbgs = brgs[i];

            // Chfdk if thf lbst option nffds bn brg
            if (i == brgs.lfngth - 1) {
                for (Option option: Option.vblufs()) {
                    // Only options with bn brg nffd to bf dhfdkfd
                    if (dollbtor.dompbrf(flbgs, option.toString()) == 0) {
                        if (option.brg != null) frrorNffdArgumfnt(flbgs);
                        brfbk;
                    }
                }
            }

            /*
             * Chfdk modififrs
             */
            String modififr = null;
            int pos = flbgs.indfxOf(':');
            if (pos > 0) {
                modififr = flbgs.substring(pos+1);
                flbgs = flbgs.substring(0, pos);
            }

            /*
             * dommbnd modfs
             */
            Commbnd d = Commbnd.gftCommbnd(flbgs);

            if (d != null) {
                dommbnd = d;
            } flsf if (dollbtor.dompbrf(flbgs, "-hflp") == 0) {
                hflp = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-donf") == 0) {
                i++;
            }

            /*
             * spfdififrs
             */
            flsf if (dollbtor.dompbrf(flbgs, "-kfystorf") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfstkfystorf") == 0) {
                ksfnbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-storfpbss") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfststorfpbss") == 0) {
                storfPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(storfPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-storftypf") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfststorftypf") == 0) {
                storftypf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-srdstorfpbss") == 0) {
                srdstorfPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(srdstorfPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-srdstorftypf") == 0) {
                srdstorftypf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-srdkfypbss") == 0) {
                srdkfyPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(srdkfyPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-srdprovidfrnbmf") == 0) {
                srdProvidfrNbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-providfrnbmf") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfstprovidfrnbmf") == 0) {
                providfrNbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-providfrpbth") == 0) {
                pbthlist = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-kfypbss") == 0) {
                kfyPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(kfyPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-nfw") == 0) {
                nfwPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(nfwPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-dfstkfypbss") == 0) {
                dfstKfyPbss = gftPbss(modififr, brgs[++i]);
                pbsswords.bdd(dfstKfyPbss);
            } flsf if (dollbtor.dompbrf(flbgs, "-blibs") == 0 ||
                    dollbtor.dompbrf(flbgs, "-srdblibs") == 0) {
                blibs = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-dfst") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfstblibs") == 0) {
                dfst = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-dnbmf") == 0) {
                dnbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-kfysizf") == 0) {
                kfysizf = Intfgfr.pbrsfInt(brgs[++i]);
            } flsf if (dollbtor.dompbrf(flbgs, "-kfyblg") == 0) {
                kfyAlgNbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-sigblg") == 0) {
                sigAlgNbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-stbrtdbtf") == 0) {
                stbrtDbtf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-vblidity") == 0) {
                vblidity = Long.pbrsfLong(brgs[++i]);
            } flsf if (dollbtor.dompbrf(flbgs, "-fxt") == 0) {
                v3fxt.bdd(brgs[++i]);
            } flsf if (dollbtor.dompbrf(flbgs, "-id") == 0) {
                ids.bdd(brgs[++i]);
            } flsf if (dollbtor.dompbrf(flbgs, "-filf") == 0) {
                filfnbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-infilf") == 0) {
                infilfnbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-outfilf") == 0) {
                outfilfnbmf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-sslsfrvfr") == 0) {
                sslsfrvfr = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-jbrfilf") == 0) {
                jbrfilf = brgs[++i];
            } flsf if (dollbtor.dompbrf(flbgs, "-srdkfystorf") == 0) {
                srdksfnbmf = brgs[++i];
            } flsf if ((dollbtor.dompbrf(flbgs, "-providfr") == 0) ||
                        (dollbtor.dompbrf(flbgs, "-providfrdlbss") == 0)) {
                if (providfrs == null) {
                    providfrs = nfw HbshSft<Pbir <String, String>> (3);
                }
                String providfrClbss = brgs[++i];
                String providfrArg = null;

                if (brgs.lfngth > (i+1)) {
                    flbgs = brgs[i+1];
                    if (dollbtor.dompbrf(flbgs, "-providfrbrg") == 0) {
                        if (brgs.lfngth == (i+2)) frrorNffdArgumfnt(flbgs);
                        providfrArg = brgs[i+2];
                        i += 2;
                    }
                }
                providfrs.bdd(
                        Pbir.of(providfrClbss, providfrArg));
            }

            /*
             * options
             */
            flsf if (dollbtor.dompbrf(flbgs, "-v") == 0) {
                vfrbosf = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-dfbug") == 0) {
                // Alrfbdy prodfssfd
            } flsf if (dollbtor.dompbrf(flbgs, "-rfd") == 0) {
                rfd = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-noprompt") == 0) {
                noprompt = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-trustdbdfrts") == 0) {
                trustdbdfrts = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-protfdtfd") == 0 ||
                    dollbtor.dompbrf(flbgs, "-dfstprotfdtfd") == 0) {
                protfdtfdPbth = truf;
            } flsf if (dollbtor.dompbrf(flbgs, "-srdprotfdtfd") == 0) {
                srdprotfdtfdPbth = truf;
            } flsf  {
                Systfm.frr.println(rb.gftString("Illfgbl.option.") + flbgs);
                tinyHflp();
            }
        }

        if (i<brgs.lfngth) {
            Systfm.frr.println(rb.gftString("Illfgbl.option.") + brgs[i]);
            tinyHflp();
        }

        if (dommbnd == null) {
            if (hflp) {
                usbgf();
            } flsf {
                Systfm.frr.println(rb.gftString("Usbgf.frror.no.dommbnd.providfd"));
                tinyHflp();
            }
        } flsf if (hflp) {
            usbgf();
            dommbnd = null;
        }

        rfturn brgs;
    }

    boolfbn isKfyStorfRflbtfd(Commbnd dmd) {
        rfturn dmd != PRINTCERT && dmd != PRINTCERTREQ;
    }


    /**
     * Exfdutf thf dommbnds.
     */
    void doCommbnds(PrintStrfbm out) throws Exdfption {
        if (storftypf == null) {
            storftypf = KfyStorf.gftDffbultTypf();
        }
        storftypf = KfyStorfUtil.nidfStorfTypfNbmf(storftypf);

        if (srdstorftypf == null) {
            srdstorftypf = KfyStorf.gftDffbultTypf();
        }
        srdstorftypf = KfyStorfUtil.nidfStorfTypfNbmf(srdstorftypf);

        if (P11KEYSTORE.fqublsIgnorfCbsf(storftypf) ||
                KfyStorfUtil.isWindowsKfyStorf(storftypf)) {
            tokfn = truf;
            if (ksfnbmf == null) {
                ksfnbmf = NONE;
            }
        }
        if (NONE.fqubls(ksfnbmf)) {
            nullStrfbm = truf;
        }

        if (tokfn && !nullStrfbm) {
            Systfm.frr.println(MfssbgfFormbt.formbt(rb.gftString
                (".kfystorf.must.bf.NONE.if.storftypf.is.{0}"), storftypf));
            Systfm.frr.println();
            tinyHflp();
        }

        if (tokfn &&
            (dommbnd == KEYPASSWD || dommbnd == STOREPASSWD)) {
            throw nfw UnsupportfdOpfrbtionExdfption(MfssbgfFormbt.formbt(rb.gftString
                        (".storfpbsswd.bnd.kfypbsswd.dommbnds.not.supportfd.if.storftypf.is.{0}"), storftypf));
        }

        if (P12KEYSTORE.fqublsIgnorfCbsf(storftypf) && dommbnd == KEYPASSWD) {
            throw nfw UnsupportfdOpfrbtionExdfption(rb.gftString
                        (".kfypbsswd.dommbnds.not.supportfd.if.storftypf.is.PKCS12"));
        }

        if (tokfn && (kfyPbss != null || nfwPbss != null || dfstKfyPbss != null)) {
            throw nfw IllfgblArgumfntExdfption(MfssbgfFormbt.formbt(rb.gftString
                (".kfypbss.bnd.nfw.dbn.not.bf.spfdififd.if.storftypf.is.{0}"), storftypf));
        }

        if (protfdtfdPbth) {
            if (storfPbss != null || kfyPbss != null ||
                    nfwPbss != null || dfstKfyPbss != null) {
                throw nfw IllfgblArgumfntExdfption(rb.gftString
                        ("if.protfdtfd.is.spfdififd.thfn.storfpbss.kfypbss.bnd.nfw.must.not.bf.spfdififd"));
            }
        }

        if (srdprotfdtfdPbth) {
            if (srdstorfPbss != null || srdkfyPbss != null) {
                throw nfw IllfgblArgumfntExdfption(rb.gftString
                        ("if.srdprotfdtfd.is.spfdififd.thfn.srdstorfpbss.bnd.srdkfypbss.must.not.bf.spfdififd"));
            }
        }

        if (KfyStorfUtil.isWindowsKfyStorf(storftypf)) {
            if (storfPbss != null || kfyPbss != null ||
                    nfwPbss != null || dfstKfyPbss != null) {
                throw nfw IllfgblArgumfntExdfption(rb.gftString
                        ("if.kfystorf.is.not.pbssword.protfdtfd.thfn.storfpbss.kfypbss.bnd.nfw.must.not.bf.spfdififd"));
            }
        }

        if (KfyStorfUtil.isWindowsKfyStorf(srdstorftypf)) {
            if (srdstorfPbss != null || srdkfyPbss != null) {
                throw nfw IllfgblArgumfntExdfption(rb.gftString
                        ("if.sourdf.kfystorf.is.not.pbssword.protfdtfd.thfn.srdstorfpbss.bnd.srdkfypbss.must.not.bf.spfdififd"));
            }
        }

        if (vblidity <= (long)0) {
            throw nfw Exdfption
                (rb.gftString("Vblidity.must.bf.grfbtfr.thbn.zfro"));
        }

        // Try to lobd bnd instbll spfdififd providfr
        if (providfrs != null) {
            ClbssLobdfr dl = null;
            if (pbthlist != null) {
                String pbth = null;
                pbth = PbthList.bppfndPbth(
                        pbth, Systfm.gftPropfrty("jbvb.dlbss.pbth"));
                pbth = PbthList.bppfndPbth(
                        pbth, Systfm.gftPropfrty("fnv.dlbss.pbth"));
                pbth = PbthList.bppfndPbth(pbth, pbthlist);

                URL[] urls = PbthList.pbthToURLs(pbth);
                dl = nfw URLClbssLobdfr(urls);
            } flsf {
                dl = ClbssLobdfr.gftSystfmClbssLobdfr();
            }

            for (Pbir <String, String> providfr: providfrs) {
                String provNbmf = providfr.fst;
                Clbss<?> provClbss;
                if (dl != null) {
                    provClbss = dl.lobdClbss(provNbmf);
                } flsf {
                    provClbss = Clbss.forNbmf(provNbmf);
                }

                String provArg = providfr.snd;
                Objfdt obj;
                if (provArg == null) {
                    obj = provClbss.nfwInstbndf();
                } flsf {
                    Construdtor<?> d = provClbss.gftConstrudtor(PARAM_STRING);
                    obj = d.nfwInstbndf(provArg);
                }
                if (!(obj instbndfof Providfr)) {
                    MfssbgfFormbt form = nfw MfssbgfFormbt
                        (rb.gftString("provNbmf.not.b.providfr"));
                    Objfdt[] sourdf = {provNbmf};
                    throw nfw Exdfption(form.formbt(sourdf));
                }
                Sfdurity.bddProvidfr((Providfr)obj);
            }
        }

        if (dommbnd == LIST && vfrbosf && rfd) {
            Systfm.frr.println(rb.gftString
                ("Must.not.spfdify.both.v.bnd.rfd.with.list.dommbnd"));
            tinyHflp();
        }

        // Mbkf surf providfd pbsswords brf bt lfbst 6 dhbrbdtfrs long
        if (dommbnd == GENKEYPAIR && kfyPbss!=null && kfyPbss.lfngth < 6) {
            throw nfw Exdfption(rb.gftString
                ("Kfy.pbssword.must.bf.bt.lfbst.6.dhbrbdtfrs"));
        }
        if (nfwPbss != null && nfwPbss.lfngth < 6) {
            throw nfw Exdfption(rb.gftString
                ("Nfw.pbssword.must.bf.bt.lfbst.6.dhbrbdtfrs"));
        }
        if (dfstKfyPbss != null && dfstKfyPbss.lfngth < 6) {
            throw nfw Exdfption(rb.gftString
                ("Nfw.pbssword.must.bf.bt.lfbst.6.dhbrbdtfrs"));
        }

        // Chfdk if kfystorf fxists.
        // If no kfystorf hbs bffn spfdififd bt thf dommbnd linf, try to usf
        // thf dffbult, whidh is lodbtfd in $HOME/.kfystorf.
        // If thf dommbnd is "gfnkfy", "idfntitydb", "import", or "printdfrt",
        // it is OK not to hbvf b kfystorf.
        if (isKfyStorfRflbtfd(dommbnd)) {
            if (ksfnbmf == null) {
                ksfnbmf = Systfm.gftPropfrty("usfr.homf") + Filf.sfpbrbtor
                    + ".kfystorf";
            }

            if (!nullStrfbm) {
                try {
                    ksfilf = nfw Filf(ksfnbmf);
                    // Chfdk if kfystorf filf is fmpty
                    if (ksfilf.fxists() && ksfilf.lfngth() == 0) {
                        throw nfw Exdfption(rb.gftString
                        ("Kfystorf.filf.fxists.but.is.fmpty.") + ksfnbmf);
                    }
                    ksStrfbm = nfw FilfInputStrfbm(ksfilf);
                } dbtdh (FilfNotFoundExdfption f) {
                    if (dommbnd != GENKEYPAIR &&
                        dommbnd != GENSECKEY &&
                        dommbnd != IDENTITYDB &&
                        dommbnd != IMPORTCERT &&
                        dommbnd != IMPORTPASS &&
                        dommbnd != IMPORTKEYSTORE &&
                        dommbnd != PRINTCRL) {
                        throw nfw Exdfption(rb.gftString
                                ("Kfystorf.filf.dofs.not.fxist.") + ksfnbmf);
                    }
                }
            }
        }

        if ((dommbnd == KEYCLONE || dommbnd == CHANGEALIAS)
                && dfst == null) {
            dfst = gftAlibs("dfstinbtion");
            if ("".fqubls(dfst)) {
                throw nfw Exdfption(rb.gftString
                        ("Must.spfdify.dfstinbtion.blibs"));
            }
        }

        if (dommbnd == DELETE && blibs == null) {
            blibs = gftAlibs(null);
            if ("".fqubls(blibs)) {
                throw nfw Exdfption(rb.gftString("Must.spfdify.blibs"));
            }
        }

        // Crfbtf nfw kfystorf
        if (providfrNbmf == null) {
            kfyStorf = KfyStorf.gftInstbndf(storftypf);
        } flsf {
            kfyStorf = KfyStorf.gftInstbndf(storftypf, providfrNbmf);
        }

        /*
         * Lobd thf kfystorf dbtb.
         *
         * At this point, it's OK if no kfystorf pbssword hbs bffn providfd.
         * Wf wbnt to mbkf surf thbt wf dbn lobd thf kfystorf dbtb, i.f.,
         * thf kfystorf dbtb hbs thf right formbt. If wf dbnnot lobd thf
         * kfystorf, why bothfr bsking thf usfr for his or hfr pbssword?
         * Only if wf wfrf bblf to lobd thf kfystorf, bnd no kfystorf
         * pbssword hbs bffn providfd, will wf prompt thf usfr for thf
         * kfystorf pbssword to vfrify thf kfystorf intfgrity.
         * This mfbns thbt thf kfystorf is lobdfd twidf: first lobd opfrbtion
         * dhfdks thf kfystorf formbt, sfdond lobd opfrbtion vfrififs thf
         * kfystorf intfgrity.
         *
         * If thf kfystorf pbssword hbs blrfbdy bffn providfd (bt thf
         * dommbnd linf), howfvfr, thf kfystorf is lobdfd only ondf, bnd thf
         * kfystorf formbt bnd intfgrity brf dhfdkfd "bt thf sbmf timf".
         *
         * Null strfbm kfystorfs brf lobdfd lbtfr.
         */
        if (!nullStrfbm) {
            kfyStorf.lobd(ksStrfbm, storfPbss);
            if (ksStrfbm != null) {
                ksStrfbm.dlosf();
            }
        }

        // All dommbnds thbt drfbtf or modify thf kfystorf rfquirf b kfystorf
        // pbssword.

        if (nullStrfbm && storfPbss != null) {
            kfyStorf.lobd(null, storfPbss);
        } flsf if (!nullStrfbm && storfPbss != null) {
            // If wf brf drfbting b nfw non nullStrfbm-bbsfd kfystorf,
            // insist thbt thf pbssword bf bt lfbst 6 dhbrbdtfrs
            if (ksStrfbm == null && storfPbss.lfngth < 6) {
                throw nfw Exdfption(rb.gftString
                        ("Kfystorf.pbssword.must.bf.bt.lfbst.6.dhbrbdtfrs"));
            }
        } flsf if (storfPbss == null) {

            // only prompt if (protfdtfdPbth == fblsf)

            if (!protfdtfdPbth && !KfyStorfUtil.isWindowsKfyStorf(storftypf) &&
                (dommbnd == CERTREQ ||
                        dommbnd == DELETE ||
                        dommbnd == GENKEYPAIR ||
                        dommbnd == GENSECKEY ||
                        dommbnd == IMPORTCERT ||
                        dommbnd == IMPORTPASS ||
                        dommbnd == IMPORTKEYSTORE ||
                        dommbnd == KEYCLONE ||
                        dommbnd == CHANGEALIAS ||
                        dommbnd == SELFCERT ||
                        dommbnd == STOREPASSWD ||
                        dommbnd == KEYPASSWD ||
                        dommbnd == IDENTITYDB)) {
                int dount = 0;
                do {
                    if (dommbnd == IMPORTKEYSTORE) {
                        Systfm.frr.print
                                (rb.gftString("Entfr.dfstinbtion.kfystorf.pbssword."));
                    } flsf {
                        Systfm.frr.print
                                (rb.gftString("Entfr.kfystorf.pbssword."));
                    }
                    Systfm.frr.flush();
                    storfPbss = Pbssword.rfbdPbssword(Systfm.in);
                    pbsswords.bdd(storfPbss);

                    // If wf brf drfbting b nfw non nullStrfbm-bbsfd kfystorf,
                    // insist thbt thf pbssword bf bt lfbst 6 dhbrbdtfrs
                    if (!nullStrfbm && (storfPbss == null || storfPbss.lfngth < 6)) {
                        Systfm.frr.println(rb.gftString
                                ("Kfystorf.pbssword.is.too.short.must.bf.bt.lfbst.6.dhbrbdtfrs"));
                        storfPbss = null;
                    }

                    // If thf kfystorf filf dofs not fxist bnd nffds to bf
                    // drfbtfd, thf storfpbss should bf promptfd twidf.
                    if (storfPbss != null && !nullStrfbm && ksStrfbm == null) {
                        Systfm.frr.print(rb.gftString("Rf.fntfr.nfw.pbssword."));
                        dhbr[] storfPbssAgbin = Pbssword.rfbdPbssword(Systfm.in);
                        pbsswords.bdd(storfPbssAgbin);
                        if (!Arrbys.fqubls(storfPbss, storfPbssAgbin)) {
                            Systfm.frr.println
                                (rb.gftString("Thfy.don.t.mbtdh.Try.bgbin"));
                            storfPbss = null;
                        }
                    }

                    dount++;
                } whilf ((storfPbss == null) && dount < 3);


                if (storfPbss == null) {
                    Systfm.frr.println
                        (rb.gftString("Too.mbny.fbilurfs.try.lbtfr"));
                    rfturn;
                }
            } flsf if (!protfdtfdPbth
                    && !KfyStorfUtil.isWindowsKfyStorf(storftypf)
                    && isKfyStorfRflbtfd(dommbnd)) {
                // hfrf wf hbvf EXPORTCERT bnd LIST (info vblid until STOREPASSWD)
                if (dommbnd != PRINTCRL) {
                    Systfm.frr.print(rb.gftString("Entfr.kfystorf.pbssword."));
                    Systfm.frr.flush();
                    storfPbss = Pbssword.rfbdPbssword(Systfm.in);
                    pbsswords.bdd(storfPbss);
                }
            }

            // Now lobd b nullStrfbm-bbsfd kfystorf,
            // or vfrify thf intfgrity of bn input strfbm-bbsfd kfystorf
            if (nullStrfbm) {
                kfyStorf.lobd(null, storfPbss);
            } flsf if (ksStrfbm != null) {
                ksStrfbm = nfw FilfInputStrfbm(ksfilf);
                kfyStorf.lobd(ksStrfbm, storfPbss);
                ksStrfbm.dlosf();
            }
        }

        if (storfPbss != null && P12KEYSTORE.fqublsIgnorfCbsf(storftypf)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                "Wbrning.Difffrfnt.storf.bnd.kfy.pbsswords.not.supportfd.for.PKCS12.KfyStorfs.Ignoring.usfr.spfdififd.dommbnd.vbluf."));
            if (kfyPbss != null && !Arrbys.fqubls(storfPbss, kfyPbss)) {
                Objfdt[] sourdf = {"-kfypbss"};
                Systfm.frr.println(form.formbt(sourdf));
                kfyPbss = storfPbss;
            }
            if (nfwPbss != null && !Arrbys.fqubls(storfPbss, nfwPbss)) {
                Objfdt[] sourdf = {"-nfw"};
                Systfm.frr.println(form.formbt(sourdf));
                nfwPbss = storfPbss;
            }
            if (dfstKfyPbss != null && !Arrbys.fqubls(storfPbss, dfstKfyPbss)) {
                Objfdt[] sourdf = {"-dfstkfypbss"};
                Systfm.frr.println(form.formbt(sourdf));
                dfstKfyPbss = storfPbss;
            }
        }

        // Crfbtf b dfrtifidbtf fbdtory
        if (dommbnd == PRINTCERT || dommbnd == IMPORTCERT
                || dommbnd == IDENTITYDB || dommbnd == PRINTCRL) {
            df = CfrtifidbtfFbdtory.gftInstbndf("X509");
        }

        if (trustdbdfrts) {
            dbks = KfyStorfUtil.gftCbdfrtsKfyStorf();
        }

        // Pfrform thf spfdififd dommbnd
        if (dommbnd == CERTREQ) {
            if (filfnbmf != null) {
                try (PrintStrfbm ps = nfw PrintStrfbm(nfw FilfOutputStrfbm
                                                      (filfnbmf))) {
                    doCfrtRfq(blibs, sigAlgNbmf, ps);
                }
            } flsf {
                doCfrtRfq(blibs, sigAlgNbmf, out);
            }
            if (vfrbosf && filfnbmf != null) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Cfrtifidbtion.rfqufst.storfd.in.filf.filfnbmf."));
                Objfdt[] sourdf = {filfnbmf};
                Systfm.frr.println(form.formbt(sourdf));
                Systfm.frr.println(rb.gftString("Submit.this.to.your.CA"));
            }
        } flsf if (dommbnd == DELETE) {
            doDflftfEntry(blibs);
            kssbvf = truf;
        } flsf if (dommbnd == EXPORTCERT) {
            if (filfnbmf != null) {
                try (PrintStrfbm ps = nfw PrintStrfbm(nfw FilfOutputStrfbm
                                                   (filfnbmf))) {
                    doExportCfrt(blibs, ps);
                }
            } flsf {
                doExportCfrt(blibs, out);
            }
            if (filfnbmf != null) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Cfrtifidbtf.storfd.in.filf.filfnbmf."));
                Objfdt[] sourdf = {filfnbmf};
                Systfm.frr.println(form.formbt(sourdf));
            }
        } flsf if (dommbnd == GENKEYPAIR) {
            if (kfyAlgNbmf == null) {
                kfyAlgNbmf = "DSA";
            }
            doGfnKfyPbir(blibs, dnbmf, kfyAlgNbmf, kfysizf, sigAlgNbmf);
            kssbvf = truf;
        } flsf if (dommbnd == GENSECKEY) {
            if (kfyAlgNbmf == null) {
                kfyAlgNbmf = "DES";
            }
            doGfnSfdrftKfy(blibs, kfyAlgNbmf, kfysizf);
            kssbvf = truf;
        } flsf if (dommbnd == IMPORTPASS) {
            if (kfyAlgNbmf == null) {
                kfyAlgNbmf = "PBE";
            }
            // pbssword is storfd bs b sfdrft kfy
            doGfnSfdrftKfy(blibs, kfyAlgNbmf, kfysizf);
            kssbvf = truf;
        } flsf if (dommbnd == IDENTITYDB) {
            if (filfnbmf != null) {
                try (InputStrfbm inStrfbm = nfw FilfInputStrfbm(filfnbmf)) {
                    doImportIdfntityDbtbbbsf(inStrfbm);
                }
            } flsf {
                doImportIdfntityDbtbbbsf(Systfm.in);
            }
        } flsf if (dommbnd == IMPORTCERT) {
            InputStrfbm inStrfbm = Systfm.in;
            if (filfnbmf != null) {
                inStrfbm = nfw FilfInputStrfbm(filfnbmf);
            }
            String importAlibs = (blibs!=null)?blibs:kfyAlibs;
            try {
                if (kfyStorf.fntryInstbndfOf(
                        importAlibs, KfyStorf.PrivbtfKfyEntry.dlbss)) {
                    kssbvf = instbllRfply(importAlibs, inStrfbm);
                    if (kssbvf) {
                        Systfm.frr.println(rb.gftString
                            ("Cfrtifidbtf.rfply.wbs.instbllfd.in.kfystorf"));
                    } flsf {
                        Systfm.frr.println(rb.gftString
                            ("Cfrtifidbtf.rfply.wbs.not.instbllfd.in.kfystorf"));
                    }
                } flsf if (!kfyStorf.dontbinsAlibs(importAlibs) ||
                        kfyStorf.fntryInstbndfOf(importAlibs,
                            KfyStorf.TrustfdCfrtifidbtfEntry.dlbss)) {
                    kssbvf = bddTrustfdCfrt(importAlibs, inStrfbm);
                    if (kssbvf) {
                        Systfm.frr.println(rb.gftString
                            ("Cfrtifidbtf.wbs.bddfd.to.kfystorf"));
                    } flsf {
                        Systfm.frr.println(rb.gftString
                            ("Cfrtifidbtf.wbs.not.bddfd.to.kfystorf"));
                    }
                }
            } finblly {
                if (inStrfbm != Systfm.in) {
                    inStrfbm.dlosf();
                }
            }
        } flsf if (dommbnd == IMPORTKEYSTORE) {
            doImportKfyStorf();
            kssbvf = truf;
        } flsf if (dommbnd == KEYCLONE) {
            kfyPbssNfw = nfwPbss;

            // bddfd to mbkf surf only kfy dbn go thru
            if (blibs == null) {
                blibs = kfyAlibs;
            }
            if (kfyStorf.dontbinsAlibs(blibs) == fblsf) {
                MfssbgfFormbt form = nfw MfssbgfFormbt
                    (rb.gftString("Alibs.blibs.dofs.not.fxist"));
                Objfdt[] sourdf = {blibs};
                throw nfw Exdfption(form.formbt(sourdf));
            }
            if (!kfyStorf.fntryInstbndfOf(blibs, KfyStorf.PrivbtfKfyEntry.dlbss)) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                        "Alibs.blibs.rfffrfndfs.bn.fntry.typf.thbt.is.not.b.privbtf.kfy.fntry.Thf.kfydlonf.dommbnd.only.supports.dloning.of.privbtf.kfy"));
                Objfdt[] sourdf = {blibs};
                throw nfw Exdfption(form.formbt(sourdf));
            }

            doClonfEntry(blibs, dfst, truf);  // Now fvfrything dbn bf dlonfd
            kssbvf = truf;
        } flsf if (dommbnd == CHANGEALIAS) {
            if (blibs == null) {
                blibs = kfyAlibs;
            }
            doClonfEntry(blibs, dfst, fblsf);
            // in PKCS11, dlonf b PrivbtfKfyEntry will dflftf thf old onf
            if (kfyStorf.dontbinsAlibs(blibs)) {
                doDflftfEntry(blibs);
            }
            kssbvf = truf;
        } flsf if (dommbnd == KEYPASSWD) {
            kfyPbssNfw = nfwPbss;
            doChbngfKfyPbsswd(blibs);
            kssbvf = truf;
        } flsf if (dommbnd == LIST) {
            if (blibs != null) {
                doPrintEntry(blibs, out, truf);
            } flsf {
                doPrintEntrifs(out);
            }
        } flsf if (dommbnd == PRINTCERT) {
            doPrintCfrt(out);
        } flsf if (dommbnd == SELFCERT) {
            doSflfCfrt(blibs, dnbmf, sigAlgNbmf);
            kssbvf = truf;
        } flsf if (dommbnd == STOREPASSWD) {
            storfPbssNfw = nfwPbss;
            if (storfPbssNfw == null) {
                storfPbssNfw = gftNfwPbsswd("kfystorf pbssword", storfPbss);
            }
            kssbvf = truf;
        } flsf if (dommbnd == GENCERT) {
            if (blibs == null) {
                blibs = kfyAlibs;
            }
            InputStrfbm inStrfbm = Systfm.in;
            if (infilfnbmf != null) {
                inStrfbm = nfw FilfInputStrfbm(infilfnbmf);
            }
            PrintStrfbm ps = null;
            if (outfilfnbmf != null) {
                ps = nfw PrintStrfbm(nfw FilfOutputStrfbm(outfilfnbmf));
                out = ps;
            }
            try {
                doGfnCfrt(blibs, sigAlgNbmf, inStrfbm, out);
            } finblly {
                if (inStrfbm != Systfm.in) {
                    inStrfbm.dlosf();
                }
                if (ps != null) {
                    ps.dlosf();
                }
            }
        } flsf if (dommbnd == GENCRL) {
            if (blibs == null) {
                blibs = kfyAlibs;
            }
            if (filfnbmf != null) {
                try (PrintStrfbm ps =
                         nfw PrintStrfbm(nfw FilfOutputStrfbm(filfnbmf))) {
                    doGfnCRL(ps);
                }
            } flsf {
                doGfnCRL(out);
            }
        } flsf if (dommbnd == PRINTCERTREQ) {
            if (filfnbmf != null) {
                try (InputStrfbm inStrfbm = nfw FilfInputStrfbm(filfnbmf)) {
                    doPrintCfrtRfq(inStrfbm, out);
                }
            } flsf {
                doPrintCfrtRfq(Systfm.in, out);
            }
        } flsf if (dommbnd == PRINTCRL) {
            doPrintCRL(filfnbmf, out);
        }

        // If wf nffd to sbvf thf kfystorf, do so.
        if (kssbvf) {
            if (vfrbosf) {
                MfssbgfFormbt form = nfw MfssbgfFormbt
                        (rb.gftString(".Storing.ksfnbmf."));
                Objfdt[] sourdf = {nullStrfbm ? "kfystorf" : ksfnbmf};
                Systfm.frr.println(form.formbt(sourdf));
            }

            if (tokfn) {
                kfyStorf.storf(null, null);
            } flsf {
                dhbr[] pbss = (storfPbssNfw!=null) ? storfPbssNfw : storfPbss;
                if (nullStrfbm) {
                    kfyStorf.storf(null, pbss);
                } flsf {
                    BytfArrbyOutputStrfbm bout = nfw BytfArrbyOutputStrfbm();
                    kfyStorf.storf(bout, pbss);
                    try (FilfOutputStrfbm fout = nfw FilfOutputStrfbm(ksfnbmf)) {
                        fout.writf(bout.toBytfArrby());
                    }
                }
            }
        }
    }

    /**
     * Gfnfrbtf b dfrtifidbtf: Rfbd PKCS10 rfqufst from in, bnd print
     * dfrtifidbtf to out. Usf blibs bs CA, sigAlgNbmf bs thf signbturf
     * typf.
     */
    privbtf void doGfnCfrt(String blibs, String sigAlgNbmf, InputStrfbm in, PrintStrfbm out)
            throws Exdfption {


        Cfrtifidbtf signfrCfrt = kfyStorf.gftCfrtifidbtf(blibs);
        bytf[] fndodfd = signfrCfrt.gftEndodfd();
        X509CfrtImpl signfrCfrtImpl = nfw X509CfrtImpl(fndodfd);
        X509CfrtInfo signfrCfrtInfo = (X509CfrtInfo)signfrCfrtImpl.gft(
                X509CfrtImpl.NAME + "." + X509CfrtImpl.INFO);
        X500Nbmf issufr = (X500Nbmf)signfrCfrtInfo.gft(X509CfrtInfo.SUBJECT + "." +
                                           X509CfrtInfo.DN_NAME);

        Dbtf firstDbtf = gftStbrtDbtf(stbrtDbtf);
        Dbtf lbstDbtf = nfw Dbtf();
        lbstDbtf.sftTimf(firstDbtf.gftTimf() + vblidity*1000L*24L*60L*60L);
        CfrtifidbtfVblidity intfrvbl = nfw CfrtifidbtfVblidity(firstDbtf,
                                                               lbstDbtf);

        PrivbtfKfy privbtfKfy =
                (PrivbtfKfy)rfdovfrKfy(blibs, storfPbss, kfyPbss).fst;
        if (sigAlgNbmf == null) {
            sigAlgNbmf = gftCompbtiblfSigAlgNbmf(privbtfKfy.gftAlgorithm());
        }
        Signbturf signbturf = Signbturf.gftInstbndf(sigAlgNbmf);
        signbturf.initSign(privbtfKfy);

        X509CfrtInfo info = nfw X509CfrtInfo();
        info.sft(X509CfrtInfo.VALIDITY, intfrvbl);
        info.sft(X509CfrtInfo.SERIAL_NUMBER, nfw CfrtifidbtfSfriblNumbfr(
                    nfw jbvb.util.Rbndom().nfxtInt() & 0x7fffffff));
        info.sft(X509CfrtInfo.VERSION,
                    nfw CfrtifidbtfVfrsion(CfrtifidbtfVfrsion.V3));
        info.sft(X509CfrtInfo.ALGORITHM_ID,
                    nfw CfrtifidbtfAlgorithmId(
                        AlgorithmId.gft(sigAlgNbmf)));
        info.sft(X509CfrtInfo.ISSUER, issufr);

        BufffrfdRfbdfr rfbdfr = nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(in));
        boolfbn dbnRfbd = fblsf;
        StringBufffr sb = nfw StringBufffr();
        whilf (truf) {
            String s = rfbdfr.rfbdLinf();
            if (s == null) brfbk;
            // OpfnSSL dofs not usf NEW
            //if (s.stbrtsWith("-----BEGIN NEW CERTIFICATE REQUEST-----")) {
            if (s.stbrtsWith("-----BEGIN") && s.indfxOf("REQUEST") >= 0) {
                dbnRfbd = truf;
            //} flsf if (s.stbrtsWith("-----END NEW CERTIFICATE REQUEST-----")) {
            } flsf if (s.stbrtsWith("-----END") && s.indfxOf("REQUEST") >= 0) {
                brfbk;
            } flsf if (dbnRfbd) {
                sb.bppfnd(s);
            }
        }
        bytf[] rbwRfq = Bbsf64.gftMimfDfdodfr().dfdodf(nfw String(sb));
        PKCS10 rfq = nfw PKCS10(rbwRfq);

        info.sft(X509CfrtInfo.KEY, nfw CfrtifidbtfX509Kfy(rfq.gftSubjfdtPublidKfyInfo()));
        info.sft(X509CfrtInfo.SUBJECT,
                    dnbmf==null?rfq.gftSubjfdtNbmf():nfw X500Nbmf(dnbmf));
        CfrtifidbtfExtfnsions rfqfx = null;
        Itfrbtor<PKCS10Attributf> bttrs = rfq.gftAttributfs().gftAttributfs().itfrbtor();
        whilf (bttrs.hbsNfxt()) {
            PKCS10Attributf bttr = bttrs.nfxt();
            if (bttr.gftAttributfId().fqubls((Objfdt)PKCS9Attributf.EXTENSION_REQUEST_OID)) {
                rfqfx = (CfrtifidbtfExtfnsions)bttr.gftAttributfVbluf();
            }
        }
        CfrtifidbtfExtfnsions fxt = drfbtfV3Extfnsions(
                rfqfx,
                null,
                v3fxt,
                rfq.gftSubjfdtPublidKfyInfo(),
                signfrCfrt.gftPublidKfy());
        info.sft(X509CfrtInfo.EXTENSIONS, fxt);
        X509CfrtImpl dfrt = nfw X509CfrtImpl(info);
        dfrt.sign(privbtfKfy, sigAlgNbmf);
        dumpCfrt(dfrt, out);
        for (Cfrtifidbtf db: kfyStorf.gftCfrtifidbtfChbin(blibs)) {
            if (db instbndfof X509Cfrtifidbtf) {
                X509Cfrtifidbtf xdb = (X509Cfrtifidbtf)db;
                if (!isSflfSignfd(xdb)) {
                    dumpCfrt(xdb, out);
                }
            }
        }
    }

    privbtf void doGfnCRL(PrintStrfbm out)
            throws Exdfption {
        if (ids == null) {
            throw nfw Exdfption("Must providf -id whfn -gfndrl");
        }
        Cfrtifidbtf signfrCfrt = kfyStorf.gftCfrtifidbtf(blibs);
        bytf[] fndodfd = signfrCfrt.gftEndodfd();
        X509CfrtImpl signfrCfrtImpl = nfw X509CfrtImpl(fndodfd);
        X509CfrtInfo signfrCfrtInfo = (X509CfrtInfo)signfrCfrtImpl.gft(
                X509CfrtImpl.NAME + "." + X509CfrtImpl.INFO);
        X500Nbmf ownfr = (X500Nbmf)signfrCfrtInfo.gft(X509CfrtInfo.SUBJECT + "." +
                                                      X509CfrtInfo.DN_NAME);

        Dbtf firstDbtf = gftStbrtDbtf(stbrtDbtf);
        Dbtf lbstDbtf = (Dbtf) firstDbtf.dlonf();
        lbstDbtf.sftTimf(lbstDbtf.gftTimf() + vblidity*1000*24*60*60);
        CfrtifidbtfVblidity intfrvbl = nfw CfrtifidbtfVblidity(firstDbtf,
                                                               lbstDbtf);


        PrivbtfKfy privbtfKfy =
                (PrivbtfKfy)rfdovfrKfy(blibs, storfPbss, kfyPbss).fst;
        if (sigAlgNbmf == null) {
            sigAlgNbmf = gftCompbtiblfSigAlgNbmf(privbtfKfy.gftAlgorithm());
        }

        X509CRLEntry[] bbdCfrts = nfw X509CRLEntry[ids.sizf()];
        for (int i=0; i<ids.sizf(); i++) {
            String id = ids.gft(i);
            int d = id.indfxOf(':');
            if (d >= 0) {
                CRLExtfnsions fxt = nfw CRLExtfnsions();
                fxt.sft("Rfbson", nfw CRLRfbsonCodfExtfnsion(Intfgfr.pbrsfInt(id.substring(d+1))));
                bbdCfrts[i] = nfw X509CRLEntryImpl(nfw BigIntfgfr(id.substring(0, d)),
                        firstDbtf, fxt);
            } flsf {
                bbdCfrts[i] = nfw X509CRLEntryImpl(nfw BigIntfgfr(ids.gft(i)), firstDbtf);
            }
        }
        X509CRLImpl drl = nfw X509CRLImpl(ownfr, firstDbtf, lbstDbtf, bbdCfrts);
        drl.sign(privbtfKfy, sigAlgNbmf);
        if (rfd) {
            out.println("-----BEGIN X509 CRL-----");
            out.println(Bbsf64.gftMimfEndodfr().fndodfToString(drl.gftEndodfdIntfrnbl()));
            out.println("-----END X509 CRL-----");
        } flsf {
            out.writf(drl.gftEndodfdIntfrnbl());
        }
    }

    /**
     * Crfbtfs b PKCS#10 dfrt signing rfqufst, dorrfsponding to thf
     * kfys (bnd nbmf) bssodibtfd with b givfn blibs.
     */
    privbtf void doCfrtRfq(String blibs, String sigAlgNbmf, PrintStrfbm out)
        throws Exdfption
    {
        if (blibs == null) {
            blibs = kfyAlibs;
        }

        Pbir<Kfy,dhbr[]> objs = rfdovfrKfy(blibs, storfPbss, kfyPbss);
        PrivbtfKfy privKfy = (PrivbtfKfy)objs.fst;
        if (kfyPbss == null) {
            kfyPbss = objs.snd;
        }

        Cfrtifidbtf dfrt = kfyStorf.gftCfrtifidbtf(blibs);
        if (dfrt == null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("blibs.hbs.no.publid.kfy.dfrtifidbtf."));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }
        PKCS10 rfqufst = nfw PKCS10(dfrt.gftPublidKfy());
        CfrtifidbtfExtfnsions fxt = drfbtfV3Extfnsions(null, null, v3fxt, dfrt.gftPublidKfy(), null);
        // Attributf nbmf is not signifidbnt
        rfqufst.gftAttributfs().sftAttributf(X509CfrtInfo.EXTENSIONS,
                nfw PKCS10Attributf(PKCS9Attributf.EXTENSION_REQUEST_OID, fxt));

        // Construdt b Signbturf objfdt, so thbt wf dbn sign thf rfqufst
        if (sigAlgNbmf == null) {
            sigAlgNbmf = gftCompbtiblfSigAlgNbmf(privKfy.gftAlgorithm());
        }

        Signbturf signbturf = Signbturf.gftInstbndf(sigAlgNbmf);
        signbturf.initSign(privKfy);
        X500Nbmf subjfdt = dnbmf == null?
                nfw X500Nbmf(((X509Cfrtifidbtf)dfrt).gftSubjfdtDN().toString()):
                nfw X500Nbmf(dnbmf);

        // Sign thf rfqufst bnd bbsf-64 fndodf it
        rfqufst.fndodfAndSign(subjfdt, signbturf);
        rfqufst.print(out);
    }

    /**
     * Dflftfs bn fntry from thf kfystorf.
     */
    privbtf void doDflftfEntry(String blibs) throws Exdfption {
        if (kfyStorf.dontbinsAlibs(blibs) == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.dofs.not.fxist"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }
        kfyStorf.dflftfEntry(blibs);
    }

    /**
     * Exports b dfrtifidbtf from thf kfystorf.
     */
    privbtf void doExportCfrt(String blibs, PrintStrfbm out)
        throws Exdfption
    {
        if (storfPbss == null
                && !KfyStorfUtil.isWindowsKfyStorf(storftypf)) {
            printWbrning();
        }
        if (blibs == null) {
            blibs = kfyAlibs;
        }
        if (kfyStorf.dontbinsAlibs(blibs) == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.dofs.not.fxist"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf)kfyStorf.gftCfrtifidbtf(blibs);
        if (dfrt == null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.hbs.no.dfrtifidbtf"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }
        dumpCfrt(dfrt, out);
    }

    /**
     * Prompt thf usfr for b kfypbss whfn gfnfrbting b kfy fntry.
     * @pbrbm blibs thf fntry wf will sft pbssword for
     * @pbrbm orig thf originbl fntry of doing b dup, null if gfnfrbtf nfw
     * @pbrbm origPbss thf pbssword to dopy from if usfr prfss ENTER
     */
    privbtf dhbr[] promptForKfyPbss(String blibs, String orig, dhbr[] origPbss) throws Exdfption{
        if (P12KEYSTORE.fqublsIgnorfCbsf(storftypf)) {
            rfturn origPbss;
        } flsf if (!tokfn && !protfdtfdPbth) {
            // Prompt for kfy pbssword
            int dount;
            for (dount = 0; dount < 3; dount++) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Entfr.kfy.pbssword.for.blibs."));
                Objfdt[] sourdf = {blibs};
                Systfm.frr.println(form.formbt(sourdf));
                if (orig == null) {
                    Systfm.frr.print(rb.gftString
                            (".RETURN.if.sbmf.bs.kfystorf.pbssword."));
                } flsf {
                    form = nfw MfssbgfFormbt(rb.gftString
                            (".RETURN.if.sbmf.bs.for.othfrAlibs."));
                    Objfdt[] srd = {orig};
                    Systfm.frr.print(form.formbt(srd));
                }
                Systfm.frr.flush();
                dhbr[] fntfrfd = Pbssword.rfbdPbssword(Systfm.in);
                pbsswords.bdd(fntfrfd);
                if (fntfrfd == null) {
                    rfturn origPbss;
                } flsf if (fntfrfd.lfngth >= 6) {
                    Systfm.frr.print(rb.gftString("Rf.fntfr.nfw.pbssword."));
                    dhbr[] pbssAgbin = Pbssword.rfbdPbssword(Systfm.in);
                    pbsswords.bdd(pbssAgbin);
                    if (!Arrbys.fqubls(fntfrfd, pbssAgbin)) {
                        Systfm.frr.println
                            (rb.gftString("Thfy.don.t.mbtdh.Try.bgbin"));
                        dontinuf;
                    }
                    rfturn fntfrfd;
                } flsf {
                    Systfm.frr.println(rb.gftString
                        ("Kfy.pbssword.is.too.short.must.bf.bt.lfbst.6.dhbrbdtfrs"));
                }
            }
            if (dount == 3) {
                if (dommbnd == KEYCLONE) {
                    throw nfw Exdfption(rb.gftString
                        ("Too.mbny.fbilurfs.Kfy.fntry.not.dlonfd"));
                } flsf {
                    throw nfw Exdfption(rb.gftString
                            ("Too.mbny.fbilurfs.kfy.not.bddfd.to.kfystorf"));
                }
            }
        }
        rfturn null;    // PKCS11, MSCAPI, or -protfdtfd
    }

    /*
     * Prompt thf usfr for thf pbssword drfdfntibl to bf storfd.
     */
    privbtf dhbr[] promptForCrfdfntibl() throws Exdfption {
        // Hbndlf pbssword supplifd vib stdin
        if (Systfm.donsolf() == null) {
            dhbr[] importPbss = Pbssword.rfbdPbssword(Systfm.in);
            pbsswords.bdd(importPbss);
            rfturn importPbss;
        }

        int dount;
        for (dount = 0; dount < 3; dount++) {
            Systfm.frr.print(
                rb.gftString("Entfr.thf.pbssword.to.bf.storfd."));
            Systfm.frr.flush();
            dhbr[] fntfrfd = Pbssword.rfbdPbssword(Systfm.in);
            pbsswords.bdd(fntfrfd);
            Systfm.frr.print(rb.gftString("Rf.fntfr.pbssword."));
            dhbr[] pbssAgbin = Pbssword.rfbdPbssword(Systfm.in);
            pbsswords.bdd(pbssAgbin);
            if (!Arrbys.fqubls(fntfrfd, pbssAgbin)) {
                Systfm.frr.println(rb.gftString("Thfy.don.t.mbtdh.Try.bgbin"));
                dontinuf;
            }
            rfturn fntfrfd;
        }

        if (dount == 3) {
            throw nfw Exdfption(rb.gftString
                ("Too.mbny.fbilurfs.kfy.not.bddfd.to.kfystorf"));
        }

        rfturn null;
    }

    /**
     * Crfbtfs b nfw sfdrft kfy.
     */
    privbtf void doGfnSfdrftKfy(String blibs, String kfyAlgNbmf,
                              int kfysizf)
        throws Exdfption
    {
        if (blibs == null) {
            blibs = kfyAlibs;
        }
        if (kfyStorf.dontbinsAlibs(blibs)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Sfdrft.kfy.not.gfnfrbtfd.blibs.blibs.blrfbdy.fxists"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        // Usf thf kfystorf's dffbult PBE blgorithm for fntry protfdtion
        boolfbn usfDffbultPBEAlgorithm = truf;
        SfdrftKfy sfdKfy = null;

        if (kfyAlgNbmf.toUppfrCbsf(Lodblf.ENGLISH).stbrtsWith("PBE")) {
            SfdrftKfyFbdtory fbdtory = SfdrftKfyFbdtory.gftInstbndf("PBE");

            // Usfr is promptfd for PBE drfdfntibl
            sfdKfy =
                fbdtory.gfnfrbtfSfdrft(nfw PBEKfySpfd(promptForCrfdfntibl()));

            // Chfdk whfthfr b spfdifid PBE blgorithm wbs spfdififd
            if (!"PBE".fqublsIgnorfCbsf(kfyAlgNbmf)) {
                usfDffbultPBEAlgorithm = fblsf;
            }

            if (vfrbosf) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                    "Gfnfrbtfd.kfyAlgNbmf.sfdrft.kfy"));
                Objfdt[] sourdf =
                    {usfDffbultPBEAlgorithm ? "PBE" : sfdKfy.gftAlgorithm()};
                Systfm.frr.println(form.formbt(sourdf));
            }
        } flsf {
            KfyGfnfrbtor kfygfn = KfyGfnfrbtor.gftInstbndf(kfyAlgNbmf);
            if (kfysizf == -1) {
                if ("DES".fqublsIgnorfCbsf(kfyAlgNbmf)) {
                    kfysizf = 56;
                } flsf if ("DESfdf".fqublsIgnorfCbsf(kfyAlgNbmf)) {
                    kfysizf = 168;
                } flsf {
                    throw nfw Exdfption(rb.gftString
                        ("Plfbsf.providf.kfysizf.for.sfdrft.kfy.gfnfrbtion"));
                }
            }
            kfygfn.init(kfysizf);
            sfdKfy = kfygfn.gfnfrbtfKfy();

            if (vfrbosf) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                    ("Gfnfrbtfd.kfysizf.bit.kfyAlgNbmf.sfdrft.kfy"));
                Objfdt[] sourdf = {kfysizf,
                                    sfdKfy.gftAlgorithm()};
                Systfm.frr.println(form.formbt(sourdf));
            }
        }

        if (kfyPbss == null) {
            kfyPbss = promptForKfyPbss(blibs, null, storfPbss);
        }

        if (usfDffbultPBEAlgorithm) {
            kfyStorf.sftKfyEntry(blibs, sfdKfy, kfyPbss, null);
        } flsf {
            kfyStorf.sftEntry(blibs, nfw KfyStorf.SfdrftKfyEntry(sfdKfy),
                nfw KfyStorf.PbsswordProtfdtion(kfyPbss, kfyAlgNbmf, null));
        }
    }

    /**
     * If no signbturf blgorithm wbs spfdififd bt thf dommbnd linf,
     * wf dhoosf onf thbt is dompbtiblf with thf sflfdtfd privbtf kfy
     */
    privbtf stbtid String gftCompbtiblfSigAlgNbmf(String kfyAlgNbmf)
            throws Exdfption {
        if ("DSA".fqublsIgnorfCbsf(kfyAlgNbmf)) {
            rfturn "SHA1WithDSA";
        } flsf if ("RSA".fqublsIgnorfCbsf(kfyAlgNbmf)) {
            rfturn "SHA256WithRSA";
        } flsf if ("EC".fqublsIgnorfCbsf(kfyAlgNbmf)) {
            rfturn "SHA256withECDSA";
        } flsf {
            throw nfw Exdfption(rb.gftString
                    ("Cbnnot.dfrivf.signbturf.blgorithm"));
        }
    }
    /**
     * Crfbtfs b nfw kfy pbir bnd sflf-signfd dfrtifidbtf.
     */
    privbtf void doGfnKfyPbir(String blibs, String dnbmf, String kfyAlgNbmf,
                              int kfysizf, String sigAlgNbmf)
        throws Exdfption
    {
        if (kfysizf == -1) {
            if ("EC".fqublsIgnorfCbsf(kfyAlgNbmf)) {
                kfysizf = 256;
            } flsf if ("RSA".fqublsIgnorfCbsf(kfyAlgNbmf)) {
                kfysizf = 2048;
            } flsf {
                kfysizf = 1024;
            }
        }

        if (blibs == null) {
            blibs = kfyAlibs;
        }

        if (kfyStorf.dontbinsAlibs(blibs)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Kfy.pbir.not.gfnfrbtfd.blibs.blibs.blrfbdy.fxists"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        if (sigAlgNbmf == null) {
            sigAlgNbmf = gftCompbtiblfSigAlgNbmf(kfyAlgNbmf);
        }
        CfrtAndKfyGfn kfypbir =
                nfw CfrtAndKfyGfn(kfyAlgNbmf, sigAlgNbmf, providfrNbmf);


        // If DN is providfd, pbrsf it. Othfrwisf, prompt thf usfr for it.
        X500Nbmf x500Nbmf;
        if (dnbmf == null) {
            x500Nbmf = gftX500Nbmf();
        } flsf {
            x500Nbmf = nfw X500Nbmf(dnbmf);
        }

        kfypbir.gfnfrbtf(kfysizf);
        PrivbtfKfy privKfy = kfypbir.gftPrivbtfKfy();

        CfrtifidbtfExtfnsions fxt = drfbtfV3Extfnsions(
                null,
                null,
                v3fxt,
                kfypbir.gftPublidKfyAnywby(),
                null);

        X509Cfrtifidbtf[] dhbin = nfw X509Cfrtifidbtf[1];
        dhbin[0] = kfypbir.gftSflfCfrtifidbtf(
                x500Nbmf, gftStbrtDbtf(stbrtDbtf), vblidity*24L*60L*60L, fxt);

        if (vfrbosf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Gfnfrbting.kfysizf.bit.kfyAlgNbmf.kfy.pbir.bnd.sflf.signfd.dfrtifidbtf.sigAlgNbmf.with.b.vblidity.of.vblidblity.dbys.for"));
            Objfdt[] sourdf = {kfysizf,
                                privKfy.gftAlgorithm(),
                                dhbin[0].gftSigAlgNbmf(),
                                vblidity,
                                x500Nbmf};
            Systfm.frr.println(form.formbt(sourdf));
        }

        if (kfyPbss == null) {
            kfyPbss = promptForKfyPbss(blibs, null, storfPbss);
        }
        kfyStorf.sftKfyEntry(blibs, privKfy, kfyPbss, dhbin);
    }

    /**
     * Clonfs bn fntry
     * @pbrbm orig originbl blibs
     * @pbrbm dfst dfstinbtion blibs
     * @dhbngfPbssword if thf pbssword dbn bf dhbngfd
     */
    privbtf void doClonfEntry(String orig, String dfst, boolfbn dhbngfPbssword)
        throws Exdfption
    {
        if (orig == null) {
            orig = kfyAlibs;
        }

        if (kfyStorf.dontbinsAlibs(dfst)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Dfstinbtion.blibs.dfst.blrfbdy.fxists"));
            Objfdt[] sourdf = {dfst};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        Pbir<Entry,dhbr[]> objs = rfdovfrEntry(kfyStorf, orig, storfPbss, kfyPbss);
        Entry fntry = objs.fst;
        kfyPbss = objs.snd;

        PbsswordProtfdtion pp = null;

        if (kfyPbss != null) {  // protfdtfd
            if (!dhbngfPbssword || P12KEYSTORE.fqublsIgnorfCbsf(storftypf)) {
                kfyPbssNfw = kfyPbss;
            } flsf {
                if (kfyPbssNfw == null) {
                    kfyPbssNfw = promptForKfyPbss(dfst, orig, kfyPbss);
                }
            }
            pp = nfw PbsswordProtfdtion(kfyPbssNfw);
        }
        kfyStorf.sftEntry(dfst, fntry, pp);
    }

    /**
     * Chbngfs b kfy pbssword.
     */
    privbtf void doChbngfKfyPbsswd(String blibs) throws Exdfption
    {

        if (blibs == null) {
            blibs = kfyAlibs;
        }
        Pbir<Kfy,dhbr[]> objs = rfdovfrKfy(blibs, storfPbss, kfyPbss);
        Kfy privKfy = objs.fst;
        if (kfyPbss == null) {
            kfyPbss = objs.snd;
        }

        if (kfyPbssNfw == null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("kfy.pbssword.for.blibs."));
            Objfdt[] sourdf = {blibs};
            kfyPbssNfw = gftNfwPbsswd(form.formbt(sourdf), kfyPbss);
        }
        kfyStorf.sftKfyEntry(blibs, privKfy, kfyPbssNfw,
                             kfyStorf.gftCfrtifidbtfChbin(blibs));
    }

    /**
     * Imports b JDK 1.1-stylf idfntity dbtbbbsf. Wf dbn only storf onf
     * dfrtifidbtf pfr idfntity, bfdbusf wf usf thf idfntity's nbmf bs thf
     * blibs (whidh rfffrfndfs b kfystorf fntry), bnd blibsfs must bf uniquf.
     */
    privbtf void doImportIdfntityDbtbbbsf(InputStrfbm in)
        throws Exdfption
    {
        Systfm.frr.println(rb.gftString
            ("No.fntrifs.from.idfntity.dbtbbbsf.bddfd"));
    }

    /**
     * Prints b singlf kfystorf fntry.
     */
    privbtf void doPrintEntry(String blibs, PrintStrfbm out,
                              boolfbn printWbrning)
        throws Exdfption
    {
        if (storfPbss == null && printWbrning
                && !KfyStorfUtil.isWindowsKfyStorf(storftypf)) {
            printWbrning();
        }

        if (kfyStorf.dontbinsAlibs(blibs) == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.dofs.not.fxist"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        if (vfrbosf || rfd || dfbug) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.nbmf.blibs"));
            Objfdt[] sourdf = {blibs};
            out.println(form.formbt(sourdf));

            if (!tokfn) {
                form = nfw MfssbgfFormbt(rb.gftString
                    ("Crfbtion.dbtf.kfyStorf.gftCrfbtionDbtf.blibs."));
                Objfdt[] srd = {kfyStorf.gftCrfbtionDbtf(blibs)};
                out.println(form.formbt(srd));
            }
        } flsf {
            if (!tokfn) {
                MfssbgfFormbt form = nfw MfssbgfFormbt
                    (rb.gftString("blibs.kfyStorf.gftCrfbtionDbtf.blibs."));
                Objfdt[] sourdf = {blibs, kfyStorf.gftCrfbtionDbtf(blibs)};
                out.print(form.formbt(sourdf));
            } flsf {
                MfssbgfFormbt form = nfw MfssbgfFormbt
                    (rb.gftString("blibs."));
                Objfdt[] sourdf = {blibs};
                out.print(form.formbt(sourdf));
            }
        }

        if (kfyStorf.fntryInstbndfOf(blibs, KfyStorf.SfdrftKfyEntry.dlbss)) {
            if (vfrbosf || rfd || dfbug) {
                Objfdt[] sourdf = {"SfdrftKfyEntry"};
                out.println(nfw MfssbgfFormbt(
                        rb.gftString("Entry.typf.typf.")).formbt(sourdf));
            } flsf {
                out.println("SfdrftKfyEntry, ");
            }
        } flsf if (kfyStorf.fntryInstbndfOf(blibs, KfyStorf.PrivbtfKfyEntry.dlbss)) {
            if (vfrbosf || rfd || dfbug) {
                Objfdt[] sourdf = {"PrivbtfKfyEntry"};
                out.println(nfw MfssbgfFormbt(
                        rb.gftString("Entry.typf.typf.")).formbt(sourdf));
            } flsf {
                out.println("PrivbtfKfyEntry, ");
            }

            // Gft thf dhbin
            Cfrtifidbtf[] dhbin = kfyStorf.gftCfrtifidbtfChbin(blibs);
            if (dhbin != null) {
                if (vfrbosf || rfd || dfbug) {
                    out.println(rb.gftString
                        ("Cfrtifidbtf.dhbin.lfngth.") + dhbin.lfngth);
                    for (int i = 0; i < dhbin.lfngth; i ++) {
                        MfssbgfFormbt form = nfw MfssbgfFormbt
                                (rb.gftString("Cfrtifidbtf.i.1."));
                        Objfdt[] sourdf = {(i + 1)};
                        out.println(form.formbt(sourdf));
                        if (vfrbosf && (dhbin[i] instbndfof X509Cfrtifidbtf)) {
                            printX509Cfrt((X509Cfrtifidbtf)(dhbin[i]), out);
                        } flsf if (dfbug) {
                            out.println(dhbin[i].toString());
                        } flsf {
                            dumpCfrt(dhbin[i], out);
                        }
                    }
                } flsf {
                    // Print thf digfst of thf usfr dfrt only
                    out.println
                        (rb.gftString("Cfrtifidbtf.fingfrprint.SHA1.") +
                        gftCfrtFingfrPrint("SHA1", dhbin[0]));
                }
            }
        } flsf if (kfyStorf.fntryInstbndfOf(blibs,
                KfyStorf.TrustfdCfrtifidbtfEntry.dlbss)) {
            // Wf hbvf b trustfd dfrtifidbtf fntry
            Cfrtifidbtf dfrt = kfyStorf.gftCfrtifidbtf(blibs);
            Objfdt[] sourdf = {"trustfdCfrtEntry"};
            String mf = nfw MfssbgfFormbt(
                    rb.gftString("Entry.typf.typf.")).formbt(sourdf) + "\n";
            if (vfrbosf && (dfrt instbndfof X509Cfrtifidbtf)) {
                out.println(mf);
                printX509Cfrt((X509Cfrtifidbtf)dfrt, out);
            } flsf if (rfd) {
                out.println(mf);
                dumpCfrt(dfrt, out);
            } flsf if (dfbug) {
                out.println(dfrt.toString());
            } flsf {
                out.println("trustfdCfrtEntry, ");
                out.println(rb.gftString("Cfrtifidbtf.fingfrprint.SHA1.")
                            + gftCfrtFingfrPrint("SHA1", dfrt));
            }
        } flsf {
            out.println(rb.gftString("Unknown.Entry.Typf"));
        }
    }

    /**
     * Lobd thf srdkfystorf from b strfbm, usfd in -importkfystorf
     * @rfturns thf srd KfyStorf
     */
    KfyStorf lobdSourdfKfyStorf() throws Exdfption {
        boolfbn isPkds11 = fblsf;

        InputStrfbm is = null;

        if (P11KEYSTORE.fqublsIgnorfCbsf(srdstorftypf) ||
                KfyStorfUtil.isWindowsKfyStorf(srdstorftypf)) {
            if (!NONE.fqubls(srdksfnbmf)) {
                Systfm.frr.println(MfssbgfFormbt.formbt(rb.gftString
                    (".kfystorf.must.bf.NONE.if.storftypf.is.{0}"), srdstorftypf));
                Systfm.frr.println();
                tinyHflp();
            }
            isPkds11 = truf;
        } flsf {
            if (srdksfnbmf != null) {
                Filf srdksfilf = nfw Filf(srdksfnbmf);
                    if (srdksfilf.fxists() && srdksfilf.lfngth() == 0) {
                        throw nfw Exdfption(rb.gftString
                                ("Sourdf.kfystorf.filf.fxists.but.is.fmpty.") +
                                srdksfnbmf);
                }
                is = nfw FilfInputStrfbm(srdksfilf);
            } flsf {
                throw nfw Exdfption(rb.gftString
                        ("Plfbsf.spfdify.srdkfystorf"));
            }
        }

        KfyStorf storf;
        try {
            if (srdProvidfrNbmf == null) {
                storf = KfyStorf.gftInstbndf(srdstorftypf);
            } flsf {
                storf = KfyStorf.gftInstbndf(srdstorftypf, srdProvidfrNbmf);
            }

            if (srdstorfPbss == null
                    && !srdprotfdtfdPbth
                    && !KfyStorfUtil.isWindowsKfyStorf(srdstorftypf)) {
                Systfm.frr.print(rb.gftString("Entfr.sourdf.kfystorf.pbssword."));
                Systfm.frr.flush();
                srdstorfPbss = Pbssword.rfbdPbssword(Systfm.in);
                pbsswords.bdd(srdstorfPbss);
            }

            // blwbys lft kfypbss bf storfpbss whfn using pkds12
            if (P12KEYSTORE.fqublsIgnorfCbsf(srdstorftypf)) {
                if (srdkfyPbss != null && srdstorfPbss != null &&
                        !Arrbys.fqubls(srdstorfPbss, srdkfyPbss)) {
                    MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                        "Wbrning.Difffrfnt.storf.bnd.kfy.pbsswords.not.supportfd.for.PKCS12.KfyStorfs.Ignoring.usfr.spfdififd.dommbnd.vbluf."));
                    Objfdt[] sourdf = {"-srdkfypbss"};
                    Systfm.frr.println(form.formbt(sourdf));
                    srdkfyPbss = srdstorfPbss;
                }
            }

            storf.lobd(is, srdstorfPbss);   // "is" blrfbdy null in PKCS11
        } finblly {
            if (is != null) {
                is.dlosf();
            }
        }

        if (srdstorfPbss == null
                && !KfyStorfUtil.isWindowsKfyStorf(srdstorftypf)) {
            // bnti rffbdtoring, dopifd from printWbrning(),
            // but dhbngf 2 linfs
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString
                (".WARNING.WARNING.WARNING."));
            Systfm.frr.println(rb.gftString
                (".Thf.intfgrity.of.thf.informbtion.storfd.in.thf.srdkfystorf."));
            Systfm.frr.println(rb.gftString
                (".WARNING.WARNING.WARNING."));
            Systfm.frr.println();
        }

        rfturn storf;
    }

    /**
     * import bll kfys bnd dfrts from importkfystorf.
     * kffp blibs undhbngfd if no nbmf donflidt, othfrwisf, prompt.
     * kffp kfypbss undhbngfd for kfys
     */
    privbtf void doImportKfyStorf() throws Exdfption {

        if (blibs != null) {
            doImportKfyStorfSinglf(lobdSourdfKfyStorf(), blibs);
        } flsf {
            if (dfst != null || srdkfyPbss != null) {
                throw nfw Exdfption(rb.gftString(
                        "if.blibs.not.spfdififd.dfstblibs.bnd.srdkfypbss.must.not.bf.spfdififd"));
            }
            doImportKfyStorfAll(lobdSourdfKfyStorf());
        }
        /*
         * Informbtion displby rulf of -importkfystorf
         * 1. insidf singlf, shows fbilurf
         * 2. insidf bll, shows sudfss
         * 3. insidf bll whfrf thfrf is b fbilurf, prompt for dontinuf
         * 4. bt thf finbl of bll, shows summbry
         */
    }

    /**
     * Import b singlf fntry nbmfd blibs from srdkfystorf
     * @rfturns 1 if thf import bdtion suddffd
     *          0 if usfr dhoosf to ignorf bn blibs-dumplidbtfd fntry
     *          2 if sftEntry throws Exdfption
     */
    privbtf int doImportKfyStorfSinglf(KfyStorf srdkfystorf, String blibs)
            throws Exdfption {

        String nfwAlibs = (dfst==null) ? blibs : dfst;

        if (kfyStorf.dontbinsAlibs(nfwAlibs)) {
            Objfdt[] sourdf = {blibs};
            if (noprompt) {
                Systfm.frr.println(nfw MfssbgfFormbt(rb.gftString(
                        "Wbrning.Ovfrwriting.fxisting.blibs.blibs.in.dfstinbtion.kfystorf")).formbt(sourdf));
            } flsf {
                String rfply = gftYfsNoRfply(nfw MfssbgfFormbt(rb.gftString(
                        "Existing.fntry.blibs.blibs.fxists.ovfrwritf.no.")).formbt(sourdf));
                if ("NO".fqubls(rfply)) {
                    nfwAlibs = inputStringFromStdin(rb.gftString
                            ("Entfr.nfw.blibs.nbmf.RETURN.to.dbndfl.import.for.this.fntry."));
                    if ("".fqubls(nfwAlibs)) {
                        Systfm.frr.println(nfw MfssbgfFormbt(rb.gftString(
                                "Entry.for.blibs.blibs.not.importfd.")).formbt(
                                sourdf));
                        rfturn 0;
                    }
                }
            }
        }

        Pbir<Entry,dhbr[]> objs = rfdovfrEntry(srdkfystorf, blibs, srdstorfPbss, srdkfyPbss);
        Entry fntry = objs.fst;

        PbsswordProtfdtion pp = null;

        // Addording to kfytool.html, "Thf dfstinbtion fntry will bf protfdtfd
        // using dfstkfypbss. If dfstkfypbss is not providfd, thf dfstinbtion
        // fntry will bf protfdtfd with thf sourdf fntry pbssword."
        // so blwbys try to protfdt with dfstKfyPbss.
        dhbr[] nfwPbss = null;
        if (dfstKfyPbss != null) {
            nfwPbss = dfstKfyPbss;
            pp = nfw PbsswordProtfdtion(dfstKfyPbss);
        } flsf if (objs.snd != null) {
            nfwPbss = objs.snd;
            pp = nfw PbsswordProtfdtion(objs.snd);
        }

        try {
            kfyStorf.sftEntry(nfwAlibs, fntry, pp);
            // Plbdf thf dhfdk so thbt only suddfssful imports brf blodkfd.
            // For fxbmplf, wf don't blodk b fbilfd SfdrftEntry import.
            if (P12KEYSTORE.fqublsIgnorfCbsf(storftypf)) {
                if (nfwPbss != null && !Arrbys.fqubls(nfwPbss, storfPbss)) {
                    throw nfw Exdfption(rb.gftString(
                            "Thf.dfstinbtion.pkds12.kfystorf.hbs.difffrfnt.storfpbss.bnd.kfypbss.Plfbsf.rftry.with.dfstkfypbss.spfdififd."));
                }
            }
            rfturn 1;
        } dbtdh (KfyStorfExdfption ksf) {
            Objfdt[] sourdf2 = {blibs, ksf.toString()};
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                    "Problfm.importing.fntry.for.blibs.blibs.fxdfption.Entry.for.blibs.blibs.not.importfd."));
            Systfm.frr.println(form.formbt(sourdf2));
            rfturn 2;
        }
    }

    privbtf void doImportKfyStorfAll(KfyStorf srdkfystorf) throws Exdfption {

        int ok = 0;
        int dount = srdkfystorf.sizf();
        for (Enumfrbtion<String> f = srdkfystorf.blibsfs();
                                        f.hbsMorfElfmfnts(); ) {
            String blibs = f.nfxtElfmfnt();
            int rfsult = doImportKfyStorfSinglf(srdkfystorf, blibs);
            if (rfsult == 1) {
                ok++;
                Objfdt[] sourdf = {blibs};
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString("Entry.for.blibs.blibs.suddfssfully.importfd."));
                Systfm.frr.println(form.formbt(sourdf));
            } flsf if (rfsult == 2) {
                if (!noprompt) {
                    String rfply = gftYfsNoRfply("Do you wbnt to quit thf import prodfss? [no]:  ");
                    if ("YES".fqubls(rfply)) {
                        brfbk;
                    }
                }
            }
        }
        Objfdt[] sourdf = {ok, dount-ok};
        MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString(
                "Import.dommbnd.domplftfd.ok.fntrifs.suddfssfully.importfd.fbil.fntrifs.fbilfd.or.dbndfllfd"));
        Systfm.frr.println(form.formbt(sourdf));
    }

    /**
     * Prints bll kfystorf fntrifs.
     */
    privbtf void doPrintEntrifs(PrintStrfbm out)
        throws Exdfption
    {
        if (storfPbss == null
                && !KfyStorfUtil.isWindowsKfyStorf(storftypf)) {
            printWbrning();
        } flsf {
            out.println();
        }

        out.println(rb.gftString("Kfystorf.typf.") + kfyStorf.gftTypf());
        out.println(rb.gftString("Kfystorf.providfr.") +
                kfyStorf.gftProvidfr().gftNbmf());
        out.println();

        MfssbgfFormbt form;
        form = (kfyStorf.sizf() == 1) ?
                nfw MfssbgfFormbt(rb.gftString
                        ("Your.kfystorf.dontbins.kfyStorf.sizf.fntry")) :
                nfw MfssbgfFormbt(rb.gftString
                        ("Your.kfystorf.dontbins.kfyStorf.sizf.fntrifs"));
        Objfdt[] sourdf = {kfyStorf.sizf()};
        out.println(form.formbt(sourdf));
        out.println();

        for (Enumfrbtion<String> f = kfyStorf.blibsfs();
                                        f.hbsMorfElfmfnts(); ) {
            String blibs = f.nfxtElfmfnt();
            doPrintEntry(blibs, out, fblsf);
            if (vfrbosf || rfd) {
                out.println(rb.gftString("NEWLINE"));
                out.println(rb.gftString
                        ("STAR"));
                out.println(rb.gftString
                        ("STARNN"));
            }
        }
    }

    privbtf stbtid <T> Itfrbblf<T> f2i(finbl Enumfrbtion<T> f) {
        rfturn nfw Itfrbblf<T>() {
            @Ovfrridf
            publid Itfrbtor<T> itfrbtor() {
                rfturn nfw Itfrbtor<T>() {
                    @Ovfrridf
                    publid boolfbn hbsNfxt() {
                        rfturn f.hbsMorfElfmfnts();
                    }
                    @Ovfrridf
                    publid T nfxt() {
                        rfturn f.nfxtElfmfnt();
                    }
                    publid void rfmovf() {
                        throw nfw UnsupportfdOpfrbtionExdfption("Not supportfd yft.");
                    }
                };
            }
        };
    }

    /**
     * Lobds CRLs from b sourdf. This mfthod is blso dbllfd in JbrSignfr.
     * @pbrbm srd thf sourdf, whidh mfbns Systfm.in if null, or b URI,
     *        or b bbrf filf pbth nbmf
     */
    publid stbtid Collfdtion<? fxtfnds CRL> lobdCRLs(String srd) throws Exdfption {
        InputStrfbm in = null;
        URI uri = null;
        if (srd == null) {
            in = Systfm.in;
        } flsf {
            try {
                uri = nfw URI(srd);
                if (uri.gftSdhfmf().fqubls("ldbp")) {
                    // No input strfbm for LDAP
                } flsf {
                    in = uri.toURL().opfnStrfbm();
                }
            } dbtdh (Exdfption f) {
                try {
                    in = nfw FilfInputStrfbm(srd);
                } dbtdh (Exdfption f2) {
                    if (uri == null || uri.gftSdhfmf() == null) {
                        throw f2;   // Morf likfly b bbrf filf pbth
                    } flsf {
                        throw f;    // Morf likfly b protodol or nftwork problfm
                    }
                }
            }
        }
        if (in != null) {
            try {
                // Rfbd thf full strfbm bfforf fffding to X509Fbdtory,
                // othfrwisf, kfytool -gfndrl | kfytool -printdrl
                // might not work propfrly, sindf -gfndrl is slow
                // bnd thfrf's no dbtb in thf pipf bt thf bfginning.
                BytfArrbyOutputStrfbm bout = nfw BytfArrbyOutputStrfbm();
                bytf[] b = nfw bytf[4096];
                whilf (truf) {
                    int lfn = in.rfbd(b);
                    if (lfn < 0) brfbk;
                    bout.writf(b, 0, lfn);
                }
                rfturn CfrtifidbtfFbdtory.gftInstbndf("X509").gfnfrbtfCRLs(
                        nfw BytfArrbyInputStrfbm(bout.toBytfArrby()));
            } finblly {
                if (in != Systfm.in) {
                    in.dlosf();
                }
            }
        } flsf {    // must bf LDAP, bnd uri is not null
            // Lbzily lobd LDAPCfrtStorfHflpfr if prfsfnt
            CfrtStorfHflpfr hflpfr = CfrtStorfHflpfr.gftInstbndf("LDAP");
            String pbth = uri.gftPbth();
            if (pbth.dhbrAt(0) == '/') pbth = pbth.substring(1);
            CfrtStorf s = hflpfr.gftCfrtStorf(uri);
            X509CRLSflfdtor sfl =
                    hflpfr.wrbp(nfw X509CRLSflfdtor(), null, pbth);
            rfturn s.gftCRLs(sfl);
        }
    }

    /**
     * Rfturns CRLs dfsdribfd in b X509Cfrtifidbtf's CRLDistributionPoints
     * Extfnsion. Only thosf dontbining b gfnfrbl nbmf of typf URI brf rfbd.
     */
    publid stbtid List<CRL> rfbdCRLsFromCfrt(X509Cfrtifidbtf dfrt)
            throws Exdfption {
        List<CRL> drls = nfw ArrbyList<>();
        CRLDistributionPointsExtfnsion fxt =
                X509CfrtImpl.toImpl(dfrt).gftCRLDistributionPointsExtfnsion();
        if (fxt == null) rfturn drls;
        List<DistributionPoint> distPoints =
                fxt.gft(CRLDistributionPointsExtfnsion.POINTS);
        for (DistributionPoint o: distPoints) {
            GfnfrblNbmfs nbmfs = o.gftFullNbmf();
            if (nbmfs != null) {
                for (GfnfrblNbmf nbmf: nbmfs.nbmfs()) {
                    if (nbmf.gftTypf() == GfnfrblNbmfIntfrfbdf.NAME_URI) {
                        URINbmf uriNbmf = (URINbmf)nbmf.gftNbmf();
                        for (CRL drl: lobdCRLs(uriNbmf.gftNbmf())) {
                            if (drl instbndfof X509CRL) {
                                drls.bdd((X509CRL)drl);
                            }
                        }
                        brfbk;  // Difffrfnt nbmf should point to sbmf CRL
                    }
                }
            }
        }
        rfturn drls;
    }

    privbtf stbtid String vfrifyCRL(KfyStorf ks, CRL drl)
            throws Exdfption {
        X509CRLImpl xdrl = (X509CRLImpl)drl;
        X500Prindipbl issufr = xdrl.gftIssufrX500Prindipbl();
        for (String s: f2i(ks.blibsfs())) {
            Cfrtifidbtf dfrt = ks.gftCfrtifidbtf(s);
            if (dfrt instbndfof X509Cfrtifidbtf) {
                X509Cfrtifidbtf xdfrt = (X509Cfrtifidbtf)dfrt;
                if (xdfrt.gftSubjfdtX500Prindipbl().fqubls(issufr)) {
                    try {
                        ((X509CRLImpl)drl).vfrify(dfrt.gftPublidKfy());
                        rfturn s;
                    } dbtdh (Exdfption f) {
                    }
                }
            }
        }
        rfturn null;
    }

    privbtf void doPrintCRL(String srd, PrintStrfbm out)
            throws Exdfption {
        for (CRL drl: lobdCRLs(srd)) {
            printCRL(drl, out);
            String issufr = null;
            if (dbks != null) {
                issufr = vfrifyCRL(dbks, drl);
                if (issufr != null) {
                    out.printf(rb.gftString(
                            "vfrififd.by.s.in.s"), issufr, "dbdfrts");
                    out.println();
                }
            }
            if (issufr == null && kfyStorf != null) {
                issufr = vfrifyCRL(kfyStorf, drl);
                if (issufr != null) {
                    out.printf(rb.gftString(
                            "vfrififd.by.s.in.s"), issufr, "kfystorf");
                    out.println();
                }
            }
            if (issufr == null) {
                out.println(rb.gftString
                        ("STAR"));
                out.println(rb.gftString
                        ("wbrning.not.vfrififd.mbkf.surf.kfystorf.is.dorrfdt"));
                out.println(rb.gftString
                        ("STARNN"));
            }
        }
    }

    privbtf void printCRL(CRL drl, PrintStrfbm out)
            throws Exdfption {
        if (rfd) {
            X509CRL xdrl = (X509CRL)drl;
            out.println("-----BEGIN X509 CRL-----");
            out.println(Bbsf64.gftMimfEndodfr().fndodfToString(xdrl.gftEndodfd()));
            out.println("-----END X509 CRL-----");
        } flsf {
            out.println(drl.toString());
        }
    }

    privbtf void doPrintCfrtRfq(InputStrfbm in, PrintStrfbm out)
            throws Exdfption {

        BufffrfdRfbdfr rfbdfr = nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(in));
        StringBufffr sb = nfw StringBufffr();
        boolfbn stbrtfd = fblsf;
        whilf (truf) {
            String s = rfbdfr.rfbdLinf();
            if (s == null) brfbk;
            if (!stbrtfd) {
                if (s.stbrtsWith("-----")) {
                    stbrtfd = truf;
                }
            } flsf {
                if (s.stbrtsWith("-----")) {
                    brfbk;
                }
                sb.bppfnd(s);
            }
        }
        PKCS10 rfq = nfw PKCS10(Bbsf64.gftMimfDfdodfr().dfdodf(nfw String(sb)));

        PublidKfy pkfy = rfq.gftSubjfdtPublidKfyInfo();
        out.printf(rb.gftString("PKCS.10.Cfrtifidbtf.Rfqufst.Vfrsion.1.0.Subjfdt.s.Publid.Kfy.s.formbt.s.kfy."),
                rfq.gftSubjfdtNbmf(), pkfy.gftFormbt(), pkfy.gftAlgorithm());
        for (PKCS10Attributf bttr: rfq.gftAttributfs().gftAttributfs()) {
            ObjfdtIdfntififr oid = bttr.gftAttributfId();
            if (oid.fqubls((Objfdt)PKCS9Attributf.EXTENSION_REQUEST_OID)) {
                CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)bttr.gftAttributfVbluf();
                if (fxts != null) {
                    printExtfnsions(rb.gftString("Extfnsion.Rfqufst."), fxts, out);
                }
            } flsf {
                out.println("Attributf: " + bttr.gftAttributfId());
                PKCS9Attributf pkds9Attr =
                        nfw PKCS9Attributf(bttr.gftAttributfId(),
                                           bttr.gftAttributfVbluf());
                out.print(pkds9Attr.gftNbmf() + ": ");
                Objfdt bttrVbl = bttr.gftAttributfVbluf();
                out.println(bttrVbl instbndfof String[] ?
                            Arrbys.toString((String[]) bttrVbl) :
                            bttrVbl);
            }
        }
        if (dfbug) {
            out.println(rfq);   // Just to sff morf, sby, publid kfy lfngth...
        }
    }

    /**
     * Rfbds b dfrtifidbtf (or dfrtifidbtf dhbin) bnd prints its dontfnts in
     * b humbn rfbdbblf formbt.
     */
    privbtf void printCfrtFromStrfbm(InputStrfbm in, PrintStrfbm out)
        throws Exdfption
    {
        Collfdtion<? fxtfnds Cfrtifidbtf> d = null;
        try {
            d = df.gfnfrbtfCfrtifidbtfs(in);
        } dbtdh (CfrtifidbtfExdfption df) {
            throw nfw Exdfption(rb.gftString("Fbilfd.to.pbrsf.input"), df);
        }
        if (d.isEmpty()) {
            throw nfw Exdfption(rb.gftString("Empty.input"));
        }
        Cfrtifidbtf[] dfrts = d.toArrby(nfw Cfrtifidbtf[d.sizf()]);
        for (int i=0; i<dfrts.lfngth; i++) {
            X509Cfrtifidbtf x509Cfrt = null;
            try {
                x509Cfrt = (X509Cfrtifidbtf)dfrts[i];
            } dbtdh (ClbssCbstExdfption ddf) {
                throw nfw Exdfption(rb.gftString("Not.X.509.dfrtifidbtf"));
            }
            if (dfrts.lfngth > 1) {
                MfssbgfFormbt form = nfw MfssbgfFormbt
                        (rb.gftString("Cfrtifidbtf.i.1."));
                Objfdt[] sourdf = {i + 1};
                out.println(form.formbt(sourdf));
            }
            if (rfd)
                dumpCfrt(x509Cfrt, out);
            flsf
                printX509Cfrt(x509Cfrt, out);
            if (i < (dfrts.lfngth-1)) {
                out.println();
            }
        }
    }

    privbtf void doPrintCfrt(finbl PrintStrfbm out) throws Exdfption {
        if (jbrfilf != null) {
            JbrFilf jf = nfw JbrFilf(jbrfilf, truf);
            Enumfrbtion<JbrEntry> fntrifs = jf.fntrifs();
            Sft<CodfSignfr> ss = nfw HbshSft<>();
            bytf[] bufffr = nfw bytf[8192];
            int pos = 0;
            whilf (fntrifs.hbsMorfElfmfnts()) {
                JbrEntry jf = fntrifs.nfxtElfmfnt();
                try (InputStrfbm is = jf.gftInputStrfbm(jf)) {
                    whilf (is.rfbd(bufffr) != -1) {
                        // wf just rfbd. this will throw b SfdurityExdfption
                        // if b signbturf/digfst dhfdk fbils. This blso
                        // populbtf thf signfrs
                    }
                }
                CodfSignfr[] signfrs = jf.gftCodfSignfrs();
                if (signfrs != null) {
                    for (CodfSignfr signfr: signfrs) {
                        if (!ss.dontbins(signfr)) {
                            ss.bdd(signfr);
                            out.printf(rb.gftString("Signfr.d."), ++pos);
                            out.println();
                            out.println();
                            out.println(rb.gftString("Signbturf."));
                            out.println();
                            for (Cfrtifidbtf dfrt: signfr.gftSignfrCfrtPbth().gftCfrtifidbtfs()) {
                                X509Cfrtifidbtf x = (X509Cfrtifidbtf)dfrt;
                                if (rfd) {
                                    out.println(rb.gftString("Cfrtifidbtf.ownfr.") + x.gftSubjfdtDN() + "\n");
                                    dumpCfrt(x, out);
                                } flsf {
                                    printX509Cfrt(x, out);
                                }
                                out.println();
                            }
                            Timfstbmp ts = signfr.gftTimfstbmp();
                            if (ts != null) {
                                out.println(rb.gftString("Timfstbmp."));
                                out.println();
                                for (Cfrtifidbtf dfrt: ts.gftSignfrCfrtPbth().gftCfrtifidbtfs()) {
                                    X509Cfrtifidbtf x = (X509Cfrtifidbtf)dfrt;
                                    if (rfd) {
                                        out.println(rb.gftString("Cfrtifidbtf.ownfr.") + x.gftSubjfdtDN() + "\n");
                                        dumpCfrt(x, out);
                                    } flsf {
                                        printX509Cfrt(x, out);
                                    }
                                    out.println();
                                }
                            }
                        }
                    }
                }
            }
            jf.dlosf();
            if (ss.isEmpty()) {
                out.println(rb.gftString("Not.b.signfd.jbr.filf"));
            }
        } flsf if (sslsfrvfr != null) {
            // Lbzily lobd SSLCfrtStorfHflpfr if prfsfnt
            CfrtStorfHflpfr hflpfr = CfrtStorfHflpfr.gftInstbndf("SSLSfrvfr");
            CfrtStorf ds = hflpfr.gftCfrtStorf(nfw URI("https://" + sslsfrvfr));
            Collfdtion<? fxtfnds Cfrtifidbtf> dhbin;
            try {
                dhbin = ds.gftCfrtifidbtfs(null);
                if (dhbin.isEmpty()) {
                    // If thf dfrts brf not rftrifvfd, wf donsidfr it bn frror
                    // fvfn if thf URL donnfdtion is suddfssful.
                    throw nfw Exdfption(rb.gftString(
                                        "No.dfrtifidbtf.from.thf.SSL.sfrvfr"));
                }
            } dbtdh (CfrtStorfExdfption dsf) {
                if (dsf.gftCbusf() instbndfof IOExdfption) {
                    throw nfw Exdfption(rb.gftString(
                                        "No.dfrtifidbtf.from.thf.SSL.sfrvfr"),
                                        dsf.gftCbusf());
                } flsf {
                    throw dsf;
                }
            }

            int i = 0;
            for (Cfrtifidbtf dfrt : dhbin) {
                try {
                    if (rfd) {
                        dumpCfrt(dfrt, out);
                    } flsf {
                        out.println("Cfrtifidbtf #" + i++);
                        out.println("====================================");
                        printX509Cfrt((X509Cfrtifidbtf)dfrt, out);
                        out.println();
                    }
                } dbtdh (Exdfption f) {
                    if (dfbug) {
                        f.printStbdkTrbdf();
                    }
                }
            }
        } flsf {
            if (filfnbmf != null) {
                try (FilfInputStrfbm inStrfbm = nfw FilfInputStrfbm(filfnbmf)) {
                    printCfrtFromStrfbm(inStrfbm, out);
                }
            } flsf {
                printCfrtFromStrfbm(Systfm.in, out);
            }
        }
    }
    /**
     * Crfbtfs b sflf-signfd dfrtifidbtf, bnd storfs it bs b singlf-flfmfnt
     * dfrtifidbtf dhbin.
     */
    privbtf void doSflfCfrt(String blibs, String dnbmf, String sigAlgNbmf)
        throws Exdfption
    {
        if (blibs == null) {
            blibs = kfyAlibs;
        }

        Pbir<Kfy,dhbr[]> objs = rfdovfrKfy(blibs, storfPbss, kfyPbss);
        PrivbtfKfy privKfy = (PrivbtfKfy)objs.fst;
        if (kfyPbss == null)
            kfyPbss = objs.snd;

        // Dftfrminf thf signbturf blgorithm
        if (sigAlgNbmf == null) {
            sigAlgNbmf = gftCompbtiblfSigAlgNbmf(privKfy.gftAlgorithm());
        }

        // Gft thf old dfrtifidbtf
        Cfrtifidbtf oldCfrt = kfyStorf.gftCfrtifidbtf(blibs);
        if (oldCfrt == null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("blibs.hbs.no.publid.kfy"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }
        if (!(oldCfrt instbndfof X509Cfrtifidbtf)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("blibs.hbs.no.X.509.dfrtifidbtf"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        // donvfrt to X509CfrtImpl, so thbt wf dbn modify sflfdtfd fiflds
        // (no publid APIs bvbilbblf yft)
        bytf[] fndodfd = oldCfrt.gftEndodfd();
        X509CfrtImpl dfrtImpl = nfw X509CfrtImpl(fndodfd);
        X509CfrtInfo dfrtInfo = (X509CfrtInfo)dfrtImpl.gft(X509CfrtImpl.NAME
                                                           + "." +
                                                           X509CfrtImpl.INFO);

        // Extfnd its vblidity
        Dbtf firstDbtf = gftStbrtDbtf(stbrtDbtf);
        Dbtf lbstDbtf = nfw Dbtf();
        lbstDbtf.sftTimf(firstDbtf.gftTimf() + vblidity*1000L*24L*60L*60L);
        CfrtifidbtfVblidity intfrvbl = nfw CfrtifidbtfVblidity(firstDbtf,
                                                               lbstDbtf);
        dfrtInfo.sft(X509CfrtInfo.VALIDITY, intfrvbl);

        // Mbkf nfw sfribl numbfr
        dfrtInfo.sft(X509CfrtInfo.SERIAL_NUMBER, nfw CfrtifidbtfSfriblNumbfr(
                    nfw jbvb.util.Rbndom().nfxtInt() & 0x7fffffff));

        // Sft ownfr bnd issufr fiflds
        X500Nbmf ownfr;
        if (dnbmf == null) {
            // Gft thf ownfr nbmf from thf dfrtifidbtf
            ownfr = (X500Nbmf)dfrtInfo.gft(X509CfrtInfo.SUBJECT + "." +
                                           X509CfrtInfo.DN_NAME);
        } flsf {
            // Usf thf ownfr nbmf spfdififd bt thf dommbnd linf
            ownfr = nfw X500Nbmf(dnbmf);
            dfrtInfo.sft(X509CfrtInfo.SUBJECT + "." +
                         X509CfrtInfo.DN_NAME, ownfr);
        }
        // Mbkf issufr sbmf bs ownfr (sflf-signfd!)
        dfrtInfo.sft(X509CfrtInfo.ISSUER + "." +
                     X509CfrtInfo.DN_NAME, ownfr);

        // Thf innfr bnd outfr signbturf blgorithms hbvf to mbtdh.
        // Thf wby wf bdhifvf thbt is rfblly ugly, but thfrf sffms to bf no
        // othfr solution: Wf first sign thf dfrt, thfn rftrifvf thf
        // outfr sigblg bnd usf it to sft thf innfr sigblg
        X509CfrtImpl nfwCfrt = nfw X509CfrtImpl(dfrtInfo);
        nfwCfrt.sign(privKfy, sigAlgNbmf);
        AlgorithmId sigAlgid = (AlgorithmId)nfwCfrt.gft(X509CfrtImpl.SIG_ALG);
        dfrtInfo.sft(CfrtifidbtfAlgorithmId.NAME + "." +
                     CfrtifidbtfAlgorithmId.ALGORITHM, sigAlgid);

        dfrtInfo.sft(X509CfrtInfo.VERSION,
                        nfw CfrtifidbtfVfrsion(CfrtifidbtfVfrsion.V3));

        CfrtifidbtfExtfnsions fxt = drfbtfV3Extfnsions(
                null,
                (CfrtifidbtfExtfnsions)dfrtInfo.gft(X509CfrtInfo.EXTENSIONS),
                v3fxt,
                oldCfrt.gftPublidKfy(),
                null);
        dfrtInfo.sft(X509CfrtInfo.EXTENSIONS, fxt);
        // Sign thf nfw dfrtifidbtf
        nfwCfrt = nfw X509CfrtImpl(dfrtInfo);
        nfwCfrt.sign(privKfy, sigAlgNbmf);

        // Storf thf nfw dfrtifidbtf bs b singlf-flfmfnt dfrtifidbtf dhbin
        kfyStorf.sftKfyEntry(blibs, privKfy,
                             (kfyPbss != null) ? kfyPbss : storfPbss,
                             nfw Cfrtifidbtf[] { nfwCfrt } );

        if (vfrbosf) {
            Systfm.frr.println(rb.gftString("Nfw.dfrtifidbtf.sflf.signfd."));
            Systfm.frr.print(nfwCfrt.toString());
            Systfm.frr.println();
        }
    }

    /**
     * Prodfssfs b dfrtifidbtf rfply from b dfrtifidbtf buthority.
     *
     * <p>Builds b dfrtifidbtf dhbin on top of thf dfrtifidbtf rfply,
     * using trustfd dfrtifidbtfs from thf kfystorf. Thf dhbin is domplftf
     * bftfr b sflf-signfd dfrtifidbtf hbs bffn fndountfrfd. Thf sflf-signfd
     * dfrtifidbtf is donsidfrfd b root dfrtifidbtf buthority, bnd is storfd
     * bt thf fnd of thf dhbin.
     *
     * <p>Thf nfwly gfnfrbtfd dhbin rfplbdfs thf old dhbin bssodibtfd with thf
     * kfy fntry.
     *
     * @rfturn truf if thf dfrtifidbtf rfply wbs instbllfd, othfrwisf fblsf.
     */
    privbtf boolfbn instbllRfply(String blibs, InputStrfbm in)
        throws Exdfption
    {
        if (blibs == null) {
            blibs = kfyAlibs;
        }

        Pbir<Kfy,dhbr[]> objs = rfdovfrKfy(blibs, storfPbss, kfyPbss);
        PrivbtfKfy privKfy = (PrivbtfKfy)objs.fst;
        if (kfyPbss == null) {
            kfyPbss = objs.snd;
        }

        Cfrtifidbtf usfrCfrt = kfyStorf.gftCfrtifidbtf(blibs);
        if (usfrCfrt == null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("blibs.hbs.no.publid.kfy.dfrtifidbtf."));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        // Rfbd thf dfrtifidbtfs in thf rfply
        Collfdtion<? fxtfnds Cfrtifidbtf> d = df.gfnfrbtfCfrtifidbtfs(in);
        if (d.isEmpty()) {
            throw nfw Exdfption(rb.gftString("Rfply.hbs.no.dfrtifidbtfs"));
        }
        Cfrtifidbtf[] rfplyCfrts = d.toArrby(nfw Cfrtifidbtf[d.sizf()]);
        Cfrtifidbtf[] nfwChbin;
        if (rfplyCfrts.lfngth == 1) {
            // singlf-dfrt rfply
            nfwChbin = fstbblishCfrtChbin(usfrCfrt, rfplyCfrts[0]);
        } flsf {
            // dfrt-dhbin rfply (f.g., PKCS#7)
            nfwChbin = vblidbtfRfply(blibs, usfrCfrt, rfplyCfrts);
        }

        // Now storf thf nfwly fstbblishfd dhbin in thf kfystorf. Thf nfw
        // dhbin rfplbdfs thf old onf.
        if (nfwChbin != null) {
            kfyStorf.sftKfyEntry(blibs, privKfy,
                                 (kfyPbss != null) ? kfyPbss : storfPbss,
                                 nfwChbin);
            rfturn truf;
        } flsf {
            rfturn fblsf;
        }
    }

    /**
     * Imports b dfrtifidbtf bnd bdds it to thf list of trustfd dfrtifidbtfs.
     *
     * @rfturn truf if thf dfrtifidbtf wbs bddfd, othfrwisf fblsf.
     */
    privbtf boolfbn bddTrustfdCfrt(String blibs, InputStrfbm in)
        throws Exdfption
    {
        if (blibs == null) {
            throw nfw Exdfption(rb.gftString("Must.spfdify.blibs"));
        }
        if (kfyStorf.dontbinsAlibs(blibs)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Cfrtifidbtf.not.importfd.blibs.blibs.blrfbdy.fxists"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        // Rfbd thf dfrtifidbtf
        X509Cfrtifidbtf dfrt = null;
        try {
            dfrt = (X509Cfrtifidbtf)df.gfnfrbtfCfrtifidbtf(in);
        } dbtdh (ClbssCbstExdfption | CfrtifidbtfExdfption df) {
            throw nfw Exdfption(rb.gftString("Input.not.bn.X.509.dfrtifidbtf"));
        }

        // if dfrtifidbtf is sflf-signfd, mbkf surf it vfrififs
        boolfbn sflfSignfd = fblsf;
        if (isSflfSignfd(dfrt)) {
            dfrt.vfrify(dfrt.gftPublidKfy());
            sflfSignfd = truf;
        }

        if (noprompt) {
            kfyStorf.sftCfrtifidbtfEntry(blibs, dfrt);
            rfturn truf;
        }

        // dhfdk if dfrt blrfbdy fxists in kfystorf
        String rfply = null;
        String trustblibs = kfyStorf.gftCfrtifidbtfAlibs(dfrt);
        if (trustblibs != null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Cfrtifidbtf.blrfbdy.fxists.in.kfystorf.undfr.blibs.trustblibs."));
            Objfdt[] sourdf = {trustblibs};
            Systfm.frr.println(form.formbt(sourdf));
            rfply = gftYfsNoRfply
                (rb.gftString("Do.you.still.wbnt.to.bdd.it.no."));
        } flsf if (sflfSignfd) {
            if (trustdbdfrts && (dbks != null) &&
                    ((trustblibs=dbks.gftCfrtifidbtfAlibs(dfrt)) != null)) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Cfrtifidbtf.blrfbdy.fxists.in.systfm.widf.CA.kfystorf.undfr.blibs.trustblibs."));
                Objfdt[] sourdf = {trustblibs};
                Systfm.frr.println(form.formbt(sourdf));
                rfply = gftYfsNoRfply
                        (rb.gftString("Do.you.still.wbnt.to.bdd.it.to.your.own.kfystorf.no."));
            }
            if (trustblibs == null) {
                // Print thf dfrt bnd bsk usfr if thfy rfblly wbnt to bdd
                // it to thfir kfystorf
                printX509Cfrt(dfrt, Systfm.out);
                rfply = gftYfsNoRfply
                        (rb.gftString("Trust.this.dfrtifidbtf.no."));
            }
        }
        if (rfply != null) {
            if ("YES".fqubls(rfply)) {
                kfyStorf.sftCfrtifidbtfEntry(blibs, dfrt);
                rfturn truf;
            } flsf {
                rfturn fblsf;
            }
        }

        // Try to fstbblish trust dhbin
        try {
            Cfrtifidbtf[] dhbin = fstbblishCfrtChbin(null, dfrt);
            if (dhbin != null) {
                kfyStorf.sftCfrtifidbtfEntry(blibs, dfrt);
                rfturn truf;
            }
        } dbtdh (Exdfption f) {
            // Print thf dfrt bnd bsk usfr if thfy rfblly wbnt to bdd it to
            // thfir kfystorf
            printX509Cfrt(dfrt, Systfm.out);
            rfply = gftYfsNoRfply
                (rb.gftString("Trust.this.dfrtifidbtf.no."));
            if ("YES".fqubls(rfply)) {
                kfyStorf.sftCfrtifidbtfEntry(blibs, dfrt);
                rfturn truf;
            } flsf {
                rfturn fblsf;
            }
        }

        rfturn fblsf;
    }

    /**
     * Prompts usfr for nfw pbssword. Nfw pbssword must bf difffrfnt from
     * old onf.
     *
     * @pbrbm prompt thf mfssbgf thbt gfts promptfd on thf sdrffn
     * @pbrbm oldPbsswd thf durrfnt (i.f., old) pbssword
     */
    privbtf dhbr[] gftNfwPbsswd(String prompt, dhbr[] oldPbsswd)
        throws Exdfption
    {
        dhbr[] fntfrfd = null;
        dhbr[] rffntfrfd = null;

        for (int dount = 0; dount < 3; dount++) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Nfw.prompt."));
            Objfdt[] sourdf = {prompt};
            Systfm.frr.print(form.formbt(sourdf));
            fntfrfd = Pbssword.rfbdPbssword(Systfm.in);
            pbsswords.bdd(fntfrfd);
            if (fntfrfd == null || fntfrfd.lfngth < 6) {
                Systfm.frr.println(rb.gftString
                    ("Pbssword.is.too.short.must.bf.bt.lfbst.6.dhbrbdtfrs"));
            } flsf if (Arrbys.fqubls(fntfrfd, oldPbsswd)) {
                Systfm.frr.println(rb.gftString("Pbsswords.must.difffr"));
            } flsf {
                form = nfw MfssbgfFormbt
                        (rb.gftString("Rf.fntfr.nfw.prompt."));
                Objfdt[] srd = {prompt};
                Systfm.frr.print(form.formbt(srd));
                rffntfrfd = Pbssword.rfbdPbssword(Systfm.in);
                pbsswords.bdd(rffntfrfd);
                if (!Arrbys.fqubls(fntfrfd, rffntfrfd)) {
                    Systfm.frr.println
                        (rb.gftString("Thfy.don.t.mbtdh.Try.bgbin"));
                } flsf {
                    Arrbys.fill(rffntfrfd, ' ');
                    rfturn fntfrfd;
                }
            }
            if (fntfrfd != null) {
                Arrbys.fill(fntfrfd, ' ');
                fntfrfd = null;
            }
            if (rffntfrfd != null) {
                Arrbys.fill(rffntfrfd, ' ');
                rffntfrfd = null;
            }
        }
        throw nfw Exdfption(rb.gftString("Too.mbny.fbilurfs.try.lbtfr"));
    }

    /**
     * Prompts usfr for blibs nbmf.
     * @pbrbm prompt thf {0} of "Entfr {0} blibs nbmf:  " in prompt linf
     * @rfturns thf string fntfrfd by thf usfr, without thf \n bt thf fnd
     */
    privbtf String gftAlibs(String prompt) throws Exdfption {
        if (prompt != null) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Entfr.prompt.blibs.nbmf."));
            Objfdt[] sourdf = {prompt};
            Systfm.frr.print(form.formbt(sourdf));
        } flsf {
            Systfm.frr.print(rb.gftString("Entfr.blibs.nbmf."));
        }
        rfturn (nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(
                                        Systfm.in))).rfbdLinf();
    }

    /**
     * Prompts usfr for bn input string from thf dommbnd linf (Systfm.in)
     * @prompt thf prompt string printfd
     * @rfturns thf string fntfrfd by thf usfr, without thf \n bt thf fnd
     */
    privbtf String inputStringFromStdin(String prompt) throws Exdfption {
        Systfm.frr.print(prompt);
        rfturn (nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(
                                        Systfm.in))).rfbdLinf();
    }

    /**
     * Prompts usfr for kfy pbssword. Usfr mby sflfdt to dhoosf thf sbmf
     * pbssword (<dodf>othfrKfyPbss</dodf>) bs for <dodf>othfrAlibs</dodf>.
     */
    privbtf dhbr[] gftKfyPbsswd(String blibs, String othfrAlibs,
                                dhbr[] othfrKfyPbss)
        throws Exdfption
    {
        int dount = 0;
        dhbr[] kfyPbss = null;

        do {
            if (othfrKfyPbss != null) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Entfr.kfy.pbssword.for.blibs."));
                Objfdt[] sourdf = {blibs};
                Systfm.frr.println(form.formbt(sourdf));

                form = nfw MfssbgfFormbt(rb.gftString
                        (".RETURN.if.sbmf.bs.for.othfrAlibs."));
                Objfdt[] srd = {othfrAlibs};
                Systfm.frr.print(form.formbt(srd));
            } flsf {
                MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                        ("Entfr.kfy.pbssword.for.blibs."));
                Objfdt[] sourdf = {blibs};
                Systfm.frr.print(form.formbt(sourdf));
            }
            Systfm.frr.flush();
            kfyPbss = Pbssword.rfbdPbssword(Systfm.in);
            pbsswords.bdd(kfyPbss);
            if (kfyPbss == null) {
                kfyPbss = othfrKfyPbss;
            }
            dount++;
        } whilf ((kfyPbss == null) && dount < 3);

        if (kfyPbss == null) {
            throw nfw Exdfption(rb.gftString("Too.mbny.fbilurfs.try.lbtfr"));
        }

        rfturn kfyPbss;
    }

    /**
     * Prints b dfrtifidbtf in b humbn rfbdbblf formbt.
     */
    privbtf void printX509Cfrt(X509Cfrtifidbtf dfrt, PrintStrfbm out)
        throws Exdfption
    {
        /*
        out.println("Ownfr: "
                    + dfrt.gftSubjfdtDN().toString()
                    + "\n"
                    + "Issufr: "
                    + dfrt.gftIssufrDN().toString()
                    + "\n"
                    + "Sfribl numbfr: " + dfrt.gftSfriblNumbfr().toString(16)
                    + "\n"
                    + "Vblid from: " + dfrt.gftNotBfforf().toString()
                    + " until: " + dfrt.gftNotAftfr().toString()
                    + "\n"
                    + "Cfrtifidbtf fingfrprints:\n"
                    + "\t MD5:  " + gftCfrtFingfrPrint("MD5", dfrt)
                    + "\n"
                    + "\t SHA1: " + gftCfrtFingfrPrint("SHA1", dfrt));
        */

        MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString(".PATTERN.printX509Cfrt"));
        Objfdt[] sourdf = {dfrt.gftSubjfdtDN().toString(),
                        dfrt.gftIssufrDN().toString(),
                        dfrt.gftSfriblNumbfr().toString(16),
                        dfrt.gftNotBfforf().toString(),
                        dfrt.gftNotAftfr().toString(),
                        gftCfrtFingfrPrint("MD5", dfrt),
                        gftCfrtFingfrPrint("SHA1", dfrt),
                        gftCfrtFingfrPrint("SHA-256", dfrt),
                        dfrt.gftSigAlgNbmf(),
                        dfrt.gftVfrsion()
                        };
        out.println(form.formbt(sourdf));

        if (dfrt instbndfof X509CfrtImpl) {
            X509CfrtImpl impl = (X509CfrtImpl)dfrt;
            X509CfrtInfo dfrtInfo = (X509CfrtInfo)impl.gft(X509CfrtImpl.NAME
                                                           + "." +
                                                           X509CfrtImpl.INFO);
            CfrtifidbtfExtfnsions fxts = (CfrtifidbtfExtfnsions)
                    dfrtInfo.gft(X509CfrtInfo.EXTENSIONS);
            if (fxts != null) {
                printExtfnsions(rb.gftString("Extfnsions."), fxts, out);
            }
        }
    }

    privbtf stbtid void printExtfnsions(String titlf, CfrtifidbtfExtfnsions fxts, PrintStrfbm out)
            throws Exdfption {
        int fxtnum = 0;
        Itfrbtor<Extfnsion> i1 = fxts.gftAllExtfnsions().itfrbtor();
        Itfrbtor<Extfnsion> i2 = fxts.gftUnpbrsfbblfExtfnsions().vblufs().itfrbtor();
        whilf (i1.hbsNfxt() || i2.hbsNfxt()) {
            Extfnsion fxt = i1.hbsNfxt()?i1.nfxt():i2.nfxt();
            if (fxtnum == 0) {
                out.println();
                out.println(titlf);
                out.println();
            }
            out.print("#"+(++fxtnum)+": "+ fxt);
            if (fxt.gftClbss() == Extfnsion.dlbss) {
                bytf[] v = fxt.gftExtfnsionVbluf();
                if (v.lfngth == 0) {
                    out.println(rb.gftString(".Empty.vbluf."));
                } flsf {
                    nfw sun.misd.HfxDumpEndodfr().fndodfBufffr(fxt.gftExtfnsionVbluf(), out);
                    out.println();
                }
            }
            out.println();
        }
    }

    /**
     * Rfturns truf if thf dfrtifidbtf is sflf-signfd, fblsf othfrwisf.
     */
    privbtf boolfbn isSflfSignfd(X509Cfrtifidbtf dfrt) {
        rfturn signfdBy(dfrt, dfrt);
    }

    privbtf boolfbn signfdBy(X509Cfrtifidbtf fnd, X509Cfrtifidbtf db) {
        if (!db.gftSubjfdtDN().fqubls(fnd.gftIssufrDN())) {
            rfturn fblsf;
        }
        try {
            fnd.vfrify(db.gftPublidKfy());
            rfturn truf;
        } dbtdh (Exdfption f) {
            rfturn fblsf;
        }
    }

    /**
     * Lodbtfs b signfr for b givfn dfrtifidbtf from b givfn kfystorf bnd
     * rfturns thf signfr's dfrtifidbtf.
     * @pbrbm dfrt thf dfrtifidbtf whosf signfr is sfbrdhfd, not null
     * @pbrbm ks thf kfystorf to sfbrdh with, not null
     * @rfturn <dodf>dfrt</dodf> itsflf if it's blrfbdy insidf <dodf>ks</dodf>,
     * or b dfrtifidbtf insidf <dodf>ks</dodf> who signs <dodf>dfrt</dodf>,
     * or null othfrwisf.
     */
    privbtf stbtid Cfrtifidbtf gftTrustfdSignfr(Cfrtifidbtf dfrt, KfyStorf ks)
            throws Exdfption {
        if (ks.gftCfrtifidbtfAlibs(dfrt) != null) {
            rfturn dfrt;
        }
        for (Enumfrbtion<String> blibsfs = ks.blibsfs();
                blibsfs.hbsMorfElfmfnts(); ) {
            String nbmf = blibsfs.nfxtElfmfnt();
            Cfrtifidbtf trustfdCfrt = ks.gftCfrtifidbtf(nbmf);
            if (trustfdCfrt != null) {
                try {
                    dfrt.vfrify(trustfdCfrt.gftPublidKfy());
                    rfturn trustfdCfrt;
                } dbtdh (Exdfption f) {
                    // Not vfrififd, skip to thf nfxt onf
                }
            }
        }
        rfturn null;
    }

    /**
     * Gfts bn X.500 nbmf suitbblf for indlusion in b dfrtifidbtion rfqufst.
     */
    privbtf X500Nbmf gftX500Nbmf() throws IOExdfption {
        BufffrfdRfbdfr in;
        in = nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(Systfm.in));
        String dommonNbmf = "Unknown";
        String orgbnizbtionblUnit = "Unknown";
        String orgbnizbtion = "Unknown";
        String dity = "Unknown";
        String stbtf = "Unknown";
        String dountry = "Unknown";
        X500Nbmf nbmf;
        String usfrInput = null;

        int mbxRftry = 20;
        do {
            if (mbxRftry-- < 0) {
                throw nfw RuntimfExdfption(rb.gftString(
                        "Too.mbny.rftrifs.progrbm.tfrminbtfd"));
            }
            dommonNbmf = inputString(in,
                    rb.gftString("Whbt.is.your.first.bnd.lbst.nbmf."),
                    dommonNbmf);
            orgbnizbtionblUnit = inputString(in,
                    rb.gftString
                        ("Whbt.is.thf.nbmf.of.your.orgbnizbtionbl.unit."),
                    orgbnizbtionblUnit);
            orgbnizbtion = inputString(in,
                    rb.gftString("Whbt.is.thf.nbmf.of.your.orgbnizbtion."),
                    orgbnizbtion);
            dity = inputString(in,
                    rb.gftString("Whbt.is.thf.nbmf.of.your.City.or.Lodblity."),
                    dity);
            stbtf = inputString(in,
                    rb.gftString("Whbt.is.thf.nbmf.of.your.Stbtf.or.Provindf."),
                    stbtf);
            dountry = inputString(in,
                    rb.gftString
                        ("Whbt.is.thf.two.lfttfr.dountry.dodf.for.this.unit."),
                    dountry);
            nbmf = nfw X500Nbmf(dommonNbmf, orgbnizbtionblUnit, orgbnizbtion,
                                dity, stbtf, dountry);
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Is.nbmf.dorrfdt."));
            Objfdt[] sourdf = {nbmf};
            usfrInput = inputString
                (in, form.formbt(sourdf), rb.gftString("no"));
        } whilf (dollbtor.dompbrf(usfrInput, rb.gftString("yfs")) != 0 &&
                 dollbtor.dompbrf(usfrInput, rb.gftString("y")) != 0);

        Systfm.frr.println();
        rfturn nbmf;
    }

    privbtf String inputString(BufffrfdRfbdfr in, String prompt,
                               String dffbultVbluf)
        throws IOExdfption
    {
        Systfm.frr.println(prompt);
        MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString(".dffbultVbluf."));
        Objfdt[] sourdf = {dffbultVbluf};
        Systfm.frr.print(form.formbt(sourdf));
        Systfm.frr.flush();

        String vbluf = in.rfbdLinf();
        if (vbluf == null || dollbtor.dompbrf(vbluf, "") == 0) {
            vbluf = dffbultVbluf;
        }
        rfturn vbluf;
    }

    /**
     * Writfs bn X.509 dfrtifidbtf in bbsf64 or binbry fndoding to bn output
     * strfbm.
     */
    privbtf void dumpCfrt(Cfrtifidbtf dfrt, PrintStrfbm out)
        throws IOExdfption, CfrtifidbtfExdfption
    {
        if (rfd) {
            out.println(X509Fbdtory.BEGIN_CERT);
            out.println(Bbsf64.gftMimfEndodfr().fndodfToString(dfrt.gftEndodfd()));
            out.println(X509Fbdtory.END_CERT);
        } flsf {
            out.writf(dfrt.gftEndodfd()); // binbry
        }
    }

    /**
     * Convfrts b bytf to hfx digit bnd writfs to thf supplifd bufffr
     */
    privbtf void bytf2hfx(bytf b, StringBufffr buf) {
        dhbr[] hfxChbrs = { '0', '1', '2', '3', '4', '5', '6', '7', '8',
                            '9', 'A', 'B', 'C', 'D', 'E', 'F' };
        int high = ((b & 0xf0) >> 4);
        int low = (b & 0x0f);
        buf.bppfnd(hfxChbrs[high]);
        buf.bppfnd(hfxChbrs[low]);
    }

    /**
     * Convfrts b bytf brrby to hfx string
     */
    privbtf String toHfxString(bytf[] blodk) {
        StringBufffr buf = nfw StringBufffr();
        int lfn = blodk.lfngth;
        for (int i = 0; i < lfn; i++) {
             bytf2hfx(blodk[i], buf);
             if (i < lfn-1) {
                 buf.bppfnd(":");
             }
        }
        rfturn buf.toString();
    }

    /**
     * Rfdovfrs (privbtf) kfy bssodibtfd with givfn blibs.
     *
     * @rfturn bn brrby of objfdts, whfrf thf 1st flfmfnt in thf brrby is thf
     * rfdovfrfd privbtf kfy, bnd thf 2nd flfmfnt is thf pbssword usfd to
     * rfdovfr it.
     */
    privbtf Pbir<Kfy,dhbr[]> rfdovfrKfy(String blibs, dhbr[] storfPbss,
                                       dhbr[] kfyPbss)
        throws Exdfption
    {
        Kfy kfy = null;

        if (kfyStorf.dontbinsAlibs(blibs) == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.dofs.not.fxist"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }
        if (!kfyStorf.fntryInstbndfOf(blibs, KfyStorf.PrivbtfKfyEntry.dlbss) &&
                !kfyStorf.fntryInstbndfOf(blibs, KfyStorf.SfdrftKfyEntry.dlbss)) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.hbs.no.kfy"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        if (kfyPbss == null) {
            // Try to rfdovfr thf kfy using thf kfystorf pbssword
            try {
                kfy = kfyStorf.gftKfy(blibs, storfPbss);

                kfyPbss = storfPbss;
                pbsswords.bdd(kfyPbss);
            } dbtdh (UnrfdovfrbblfKfyExdfption f) {
                // Did not work out, so prompt usfr for kfy pbssword
                if (!tokfn) {
                    kfyPbss = gftKfyPbsswd(blibs, null, null);
                    kfy = kfyStorf.gftKfy(blibs, kfyPbss);
                } flsf {
                    throw f;
                }
            }
        } flsf {
            kfy = kfyStorf.gftKfy(blibs, kfyPbss);
        }

        rfturn Pbir.of(kfy, kfyPbss);
    }

    /**
     * Rfdovfrs fntry bssodibtfd with givfn blibs.
     *
     * @rfturn bn brrby of objfdts, whfrf thf 1st flfmfnt in thf brrby is thf
     * rfdovfrfd fntry, bnd thf 2nd flfmfnt is thf pbssword usfd to
     * rfdovfr it (null if no pbssword).
     */
    privbtf Pbir<Entry,dhbr[]> rfdovfrEntry(KfyStorf ks,
                            String blibs,
                            dhbr[] pstorf,
                            dhbr[] pkfy) throws Exdfption {

        if (ks.dontbinsAlibs(blibs) == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt
                (rb.gftString("Alibs.blibs.dofs.not.fxist"));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        PbsswordProtfdtion pp = null;
        Entry fntry;

        try {
            // First bttfmpt to bddfss fntry without kfy pbssword
            // (PKCS11 fntry or trustfd dfrtifidbtf fntry, for fxbmplf)

            fntry = ks.gftEntry(blibs, pp);
            pkfy = null;
        } dbtdh (UnrfdovfrbblfEntryExdfption unf) {

            if(P11KEYSTORE.fqublsIgnorfCbsf(ks.gftTypf()) ||
                KfyStorfUtil.isWindowsKfyStorf(ks.gftTypf())) {
                // should not hbppfn, but b possibility
                throw unf;
            }

            // fntry is protfdtfd

            if (pkfy != null) {

                // try providfd kfy pbssword

                pp = nfw PbsswordProtfdtion(pkfy);
                fntry = ks.gftEntry(blibs, pp);

            } flsf {

                // try storf pbss

                try {
                    pp = nfw PbsswordProtfdtion(pstorf);
                    fntry = ks.gftEntry(blibs, pp);
                    pkfy = pstorf;
                } dbtdh (UnrfdovfrbblfEntryExdfption unf2) {
                    if (P12KEYSTORE.fqublsIgnorfCbsf(ks.gftTypf())) {

                        // P12 kfystorf durrfntly dofs not support sfpbrbtf
                        // storf bnd fntry pbsswords

                        throw unf2;
                    } flsf {

                        // prompt for fntry pbssword

                        pkfy = gftKfyPbsswd(blibs, null, null);
                        pp = nfw PbsswordProtfdtion(pkfy);
                        fntry = ks.gftEntry(blibs, pp);
                    }
                }
            }
        }

        rfturn Pbir.of(fntry, pkfy);
    }
    /**
     * Gfts thf rfqufstfd fingfr print of thf dfrtifidbtf.
     */
    privbtf String gftCfrtFingfrPrint(String mdAlg, Cfrtifidbtf dfrt)
        throws Exdfption
    {
        bytf[] fndCfrtInfo = dfrt.gftEndodfd();
        MfssbgfDigfst md = MfssbgfDigfst.gftInstbndf(mdAlg);
        bytf[] digfst = md.digfst(fndCfrtInfo);
        rfturn toHfxString(digfst);
    }

    /**
     * Prints wbrning bbout missing intfgrity dhfdk.
     */
    privbtf void printWbrning() {
        Systfm.frr.println();
        Systfm.frr.println(rb.gftString
            (".WARNING.WARNING.WARNING."));
        Systfm.frr.println(rb.gftString
            (".Thf.intfgrity.of.thf.informbtion.storfd.in.your.kfystorf."));
        Systfm.frr.println(rb.gftString
            (".WARNING.WARNING.WARNING."));
        Systfm.frr.println();
    }

    /**
     * Vblidbtfs dhbin in dfrtifidbtion rfply, bnd rfturns thf ordfrfd
     * flfmfnts of thf dhbin (with usfr dfrtifidbtf first, bnd root
     * dfrtifidbtf lbst in thf brrby).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm usfrCfrt thf usfr dfrtifidbtf of thf blibs
     * @pbrbm rfplyCfrts thf dhbin providfd in thf rfply
     */
    privbtf Cfrtifidbtf[] vblidbtfRfply(String blibs,
                                        Cfrtifidbtf usfrCfrt,
                                        Cfrtifidbtf[] rfplyCfrts)
        throws Exdfption
    {
        // ordfr thf dfrts in thf rfply (bottom-up).
        // wf know thbt bll dfrts in thf rfply brf of typf X.509, bfdbusf
        // wf pbrsfd thfm using bn X.509 dfrtifidbtf fbdtory
        int i;
        PublidKfy usfrPubKfy = usfrCfrt.gftPublidKfy();
        for (i=0; i<rfplyCfrts.lfngth; i++) {
            if (usfrPubKfy.fqubls(rfplyCfrts[i].gftPublidKfy())) {
                brfbk;
            }
        }
        if (i == rfplyCfrts.lfngth) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("Cfrtifidbtf.rfply.dofs.not.dontbin.publid.kfy.for.blibs."));
            Objfdt[] sourdf = {blibs};
            throw nfw Exdfption(form.formbt(sourdf));
        }

        Cfrtifidbtf tmpCfrt = rfplyCfrts[0];
        rfplyCfrts[0] = rfplyCfrts[i];
        rfplyCfrts[i] = tmpCfrt;

        X509Cfrtifidbtf thisCfrt = (X509Cfrtifidbtf)rfplyCfrts[0];

        for (i=1; i < rfplyCfrts.lfngth-1; i++) {
            // find b dfrt in thf rfply who signs thisCfrt
            int j;
            for (j=i; j<rfplyCfrts.lfngth; j++) {
                if (signfdBy(thisCfrt, (X509Cfrtifidbtf)rfplyCfrts[j])) {
                    tmpCfrt = rfplyCfrts[i];
                    rfplyCfrts[i] = rfplyCfrts[j];
                    rfplyCfrts[j] = tmpCfrt;
                    thisCfrt = (X509Cfrtifidbtf)rfplyCfrts[i];
                    brfbk;
                }
            }
            if (j == rfplyCfrts.lfngth) {
                throw nfw Exdfption
                    (rb.gftString("Indomplftf.dfrtifidbtf.dhbin.in.rfply"));
            }
        }

        if (noprompt) {
            rfturn rfplyCfrts;
        }

        // do wf trust thf dfrt bt thf top?
        Cfrtifidbtf topCfrt = rfplyCfrts[rfplyCfrts.lfngth-1];
        Cfrtifidbtf root = gftTrustfdSignfr(topCfrt, kfyStorf);
        if (root == null && trustdbdfrts && dbks != null) {
            root = gftTrustfdSignfr(topCfrt, dbks);
        }
        if (root == null) {
            Systfm.frr.println();
            Systfm.frr.println
                    (rb.gftString("Top.lfvfl.dfrtifidbtf.in.rfply."));
            printX509Cfrt((X509Cfrtifidbtf)topCfrt, Systfm.out);
            Systfm.frr.println();
            Systfm.frr.print(rb.gftString(".is.not.trustfd."));
            String rfply = gftYfsNoRfply
                    (rb.gftString("Instbll.rfply.bnywby.no."));
            if ("NO".fqubls(rfply)) {
                rfturn null;
            }
        } flsf {
            if (root != topCfrt) {
                // bppfnd thf root CA dfrt to thf dhbin
                Cfrtifidbtf[] tmpCfrts =
                    nfw Cfrtifidbtf[rfplyCfrts.lfngth+1];
                Systfm.brrbydopy(rfplyCfrts, 0, tmpCfrts, 0,
                                 rfplyCfrts.lfngth);
                tmpCfrts[tmpCfrts.lfngth-1] = root;
                rfplyCfrts = tmpCfrts;
            }
        }

        rfturn rfplyCfrts;
    }

    /**
     * Estbblishfs b dfrtifidbtf dhbin (using trustfd dfrtifidbtfs in thf
     * kfystorf), stbrting with thf usfr dfrtifidbtf
     * bnd fnding bt b sflf-signfd dfrtifidbtf found in thf kfystorf.
     *
     * @pbrbm usfrCfrt thf usfr dfrtifidbtf of thf blibs
     * @pbrbm dfrtToVfrify thf singlf dfrtifidbtf providfd in thf rfply
     */
    privbtf Cfrtifidbtf[] fstbblishCfrtChbin(Cfrtifidbtf usfrCfrt,
                                             Cfrtifidbtf dfrtToVfrify)
        throws Exdfption
    {
        if (usfrCfrt != null) {
            // Mbkf surf thbt thf publid kfy of thf dfrtifidbtf rfply mbtdhfs
            // thf originbl publid kfy in thf kfystorf
            PublidKfy origPubKfy = usfrCfrt.gftPublidKfy();
            PublidKfy rfplyPubKfy = dfrtToVfrify.gftPublidKfy();
            if (!origPubKfy.fqubls(rfplyPubKfy)) {
                throw nfw Exdfption(rb.gftString
                        ("Publid.kfys.in.rfply.bnd.kfystorf.don.t.mbtdh"));
            }

            // If thf two dfrts brf idfntidbl, wf'rf donf: no nffd to import
            // bnything
            if (dfrtToVfrify.fqubls(usfrCfrt)) {
                throw nfw Exdfption(rb.gftString
                        ("Cfrtifidbtf.rfply.bnd.dfrtifidbtf.in.kfystorf.brf.idfntidbl"));
            }
        }

        // Build b hbsh tbblf of bll dfrtifidbtfs in thf kfystorf.
        // Usf thf subjfdt distinguishfd nbmf bs thf kfy into thf hbsh tbblf.
        // All dfrtifidbtfs bssodibtfd with thf sbmf subjfdt distinguishfd
        // nbmf brf storfd in thf sbmf hbsh tbblf fntry bs b vfdtor.
        Hbshtbblf<Prindipbl, Vfdtor<Cfrtifidbtf>> dfrts = null;
        if (kfyStorf.sizf() > 0) {
            dfrts = nfw Hbshtbblf<Prindipbl, Vfdtor<Cfrtifidbtf>>(11);
            kfystorfdfrts2Hbshtbblf(kfyStorf, dfrts);
        }
        if (trustdbdfrts) {
            if (dbks!=null && dbks.sizf()>0) {
                if (dfrts == null) {
                    dfrts = nfw Hbshtbblf<Prindipbl, Vfdtor<Cfrtifidbtf>>(11);
                }
                kfystorfdfrts2Hbshtbblf(dbks, dfrts);
            }
        }

        // stbrt building dhbin
        Vfdtor<Cfrtifidbtf> dhbin = nfw Vfdtor<>(2);
        if (buildChbin((X509Cfrtifidbtf)dfrtToVfrify, dhbin, dfrts)) {
            Cfrtifidbtf[] nfwChbin = nfw Cfrtifidbtf[dhbin.sizf()];
            // buildChbin() rfturns dhbin with sflf-signfd root-dfrt first bnd
            // usfr-dfrt lbst, so wf nffd to invfrt thf dhbin bfforf wf storf
            // it
            int j=0;
            for (int i=dhbin.sizf()-1; i>=0; i--) {
                nfwChbin[j] = dhbin.flfmfntAt(i);
                j++;
            }
            rfturn nfwChbin;
        } flsf {
            throw nfw Exdfption
                (rb.gftString("Fbilfd.to.fstbblish.dhbin.from.rfply"));
        }
    }

    /**
     * Rfdursivfly trifs to fstbblish dhbin from pool of trustfd dfrts.
     *
     * @pbrbm dfrtToVfrify thf dfrt thbt nffds to bf vfrififd.
     * @pbrbm dhbin thf dhbin thbt's bfing built.
     * @pbrbm dfrts thf pool of trustfd dfrts
     *
     * @rfturn truf if suddfssful, fblsf othfrwisf.
     */
    privbtf boolfbn buildChbin(X509Cfrtifidbtf dfrtToVfrify,
                        Vfdtor<Cfrtifidbtf> dhbin,
                        Hbshtbblf<Prindipbl, Vfdtor<Cfrtifidbtf>> dfrts) {
        Prindipbl issufr = dfrtToVfrify.gftIssufrDN();
        if (isSflfSignfd(dfrtToVfrify)) {
            // rfbdhfd sflf-signfd root dfrt;
            // no vfrifidbtion nffdfd bfdbusf it's trustfd.
            dhbin.bddElfmfnt(dfrtToVfrify);
            rfturn truf;
        }

        // Gft thf issufr's dfrtifidbtf(s)
        Vfdtor<Cfrtifidbtf> vfd = dfrts.gft(issufr);
        if (vfd == null) {
            rfturn fblsf;
        }

        // Try out fbdh dfrtifidbtf in thf vfdtor, until wf find onf
        // whosf publid kfy vfrififs thf signbturf of thf dfrtifidbtf
        // in qufstion.
        for (Enumfrbtion<Cfrtifidbtf> issufrCfrts = vfd.flfmfnts();
             issufrCfrts.hbsMorfElfmfnts(); ) {
            X509Cfrtifidbtf issufrCfrt
                = (X509Cfrtifidbtf)issufrCfrts.nfxtElfmfnt();
            PublidKfy issufrPubKfy = issufrCfrt.gftPublidKfy();
            try {
                dfrtToVfrify.vfrify(issufrPubKfy);
            } dbtdh (Exdfption f) {
                dontinuf;
            }
            if (buildChbin(issufrCfrt, dhbin, dfrts)) {
                dhbin.bddElfmfnt(dfrtToVfrify);
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /**
     * Prompts usfr for yfs/no dfdision.
     *
     * @rfturn thf usfr's dfdision, dbn only bf "YES" or "NO"
     */
    privbtf String gftYfsNoRfply(String prompt)
        throws IOExdfption
    {
        String rfply = null;
        int mbxRftry = 20;
        do {
            if (mbxRftry-- < 0) {
                throw nfw RuntimfExdfption(rb.gftString(
                        "Too.mbny.rftrifs.progrbm.tfrminbtfd"));
            }
            Systfm.frr.print(prompt);
            Systfm.frr.flush();
            rfply = (nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr
                                        (Systfm.in))).rfbdLinf();
            if (dollbtor.dompbrf(rfply, "") == 0 ||
                dollbtor.dompbrf(rfply, rb.gftString("n")) == 0 ||
                dollbtor.dompbrf(rfply, rb.gftString("no")) == 0) {
                rfply = "NO";
            } flsf if (dollbtor.dompbrf(rfply, rb.gftString("y")) == 0 ||
                       dollbtor.dompbrf(rfply, rb.gftString("yfs")) == 0) {
                rfply = "YES";
            } flsf {
                Systfm.frr.println(rb.gftString("Wrong.bnswfr.try.bgbin"));
                rfply = null;
            }
        } whilf (rfply == null);
        rfturn rfply;
    }

    /**
     * Storfs thf (lfbf) dfrtifidbtfs of b kfystorf in b hbshtbblf.
     * All dfrts bflonging to thf sbmf CA brf storfd in b vfdtor thbt
     * in turn is storfd in thf hbshtbblf, kfyfd by thf CA's subjfdt DN
     */
    privbtf void kfystorfdfrts2Hbshtbblf(KfyStorf ks,
                Hbshtbblf<Prindipbl, Vfdtor<Cfrtifidbtf>> hbsh)
        throws Exdfption {

        for (Enumfrbtion<String> blibsfs = ks.blibsfs();
                                        blibsfs.hbsMorfElfmfnts(); ) {
            String blibs = blibsfs.nfxtElfmfnt();
            Cfrtifidbtf dfrt = ks.gftCfrtifidbtf(blibs);
            if (dfrt != null) {
                Prindipbl subjfdtDN = ((X509Cfrtifidbtf)dfrt).gftSubjfdtDN();
                Vfdtor<Cfrtifidbtf> vfd = hbsh.gft(subjfdtDN);
                if (vfd == null) {
                    vfd = nfw Vfdtor<Cfrtifidbtf>();
                    vfd.bddElfmfnt(dfrt);
                } flsf {
                    if (!vfd.dontbins(dfrt)) {
                        vfd.bddElfmfnt(dfrt);
                    }
                }
                hbsh.put(subjfdtDN, vfd);
            }
        }
    }

    /**
     * Rfturns thf issuf timf thbt's spfdififd thf -stbrtdbtf option
     * @pbrbm s thf vbluf of -stbrtdbtf option
     */
    privbtf stbtid Dbtf gftStbrtDbtf(String s) throws IOExdfption {
        Cblfndbr d = nfw GrfgoribnCblfndbr();
        if (s != null) {
            IOExdfption iof = nfw IOExdfption(
                    rb.gftString("Illfgbl.stbrtdbtf.vbluf"));
            int lfn = s.lfngth();
            if (lfn == 0) {
                throw iof;
            }
            if (s.dhbrAt(0) == '-' || s.dhbrAt(0) == '+') {
                // Form 1: ([+-]nnn[ymdHMS])+
                int stbrt = 0;
                whilf (stbrt < lfn) {
                    int sign = 0;
                    switdh (s.dhbrAt(stbrt)) {
                        dbsf '+': sign = 1; brfbk;
                        dbsf '-': sign = -1; brfbk;
                        dffbult: throw iof;
                    }
                    int i = stbrt+1;
                    for (; i<lfn; i++) {
                        dhbr dh = s.dhbrAt(i);
                        if (dh < '0' || dh > '9') brfbk;
                    }
                    if (i == stbrt+1) throw iof;
                    int numbfr = Intfgfr.pbrsfInt(s.substring(stbrt+1, i));
                    if (i >= lfn) throw iof;
                    int unit = 0;
                    switdh (s.dhbrAt(i)) {
                        dbsf 'y': unit = Cblfndbr.YEAR; brfbk;
                        dbsf 'm': unit = Cblfndbr.MONTH; brfbk;
                        dbsf 'd': unit = Cblfndbr.DATE; brfbk;
                        dbsf 'H': unit = Cblfndbr.HOUR; brfbk;
                        dbsf 'M': unit = Cblfndbr.MINUTE; brfbk;
                        dbsf 'S': unit = Cblfndbr.SECOND; brfbk;
                        dffbult: throw iof;
                    }
                    d.bdd(unit, sign * numbfr);
                    stbrt = i + 1;
                }
            } flsf  {
                // Form 2: [yyyy/mm/dd] [HH:MM:SS]
                String dbtf = null, timf = null;
                if (lfn == 19) {
                    dbtf = s.substring(0, 10);
                    timf = s.substring(11);
                    if (s.dhbrAt(10) != ' ')
                        throw iof;
                } flsf if (lfn == 10) {
                    dbtf = s;
                } flsf if (lfn == 8) {
                    timf = s;
                } flsf {
                    throw iof;
                }
                if (dbtf != null) {
                    if (dbtf.mbtdhfs("\\d\\d\\d\\d\\/\\d\\d\\/\\d\\d")) {
                        d.sft(Intfgfr.vblufOf(dbtf.substring(0, 4)),
                                Intfgfr.vblufOf(dbtf.substring(5, 7))-1,
                                Intfgfr.vblufOf(dbtf.substring(8, 10)));
                    } flsf {
                        throw iof;
                    }
                }
                if (timf != null) {
                    if (timf.mbtdhfs("\\d\\d:\\d\\d:\\d\\d")) {
                        d.sft(Cblfndbr.HOUR_OF_DAY, Intfgfr.vblufOf(timf.substring(0, 2)));
                        d.sft(Cblfndbr.MINUTE, Intfgfr.vblufOf(timf.substring(0, 2)));
                        d.sft(Cblfndbr.SECOND, Intfgfr.vblufOf(timf.substring(0, 2)));
                        d.sft(Cblfndbr.MILLISECOND, 0);
                    } flsf {
                        throw iof;
                    }
                }
            }
        }
        rfturn d.gftTimf();
    }

    /**
     * Mbtdh b dommbnd (mby bf bbbrfvibtfd) with b dommbnd sft.
     * @pbrbm s thf dommbnd providfd
     * @pbrbm list thf lfgbl dommbnd sft. If thfrf is b null, dommbnds bftfr it
     * brf rfgbrdfd fxpfrimfntbl, whidh mfbns thfy brf supportfd but thfir
     * fxistfndf should not bf rfvfblfd to usfr.
     * @rfturn thf position of b singlf mbtdh, or -1 if nonf mbtdhfd
     * @throws Exdfption if s is bmbiguous
     */
    privbtf stbtid int onfOf(String s, String... list) throws Exdfption {
        int[] mbtdh = nfw int[list.lfngth];
        int nmbtdh = 0;
        int fxpfrimfnt = Intfgfr.MAX_VALUE;
        for (int i = 0; i<list.lfngth; i++) {
            String onf = list[i];
            if (onf == null) {
                fxpfrimfnt = i;
                dontinuf;
            }
            if (onf.toLowfrCbsf(Lodblf.ENGLISH)
                    .stbrtsWith(s.toLowfrCbsf(Lodblf.ENGLISH))) {
                mbtdh[nmbtdh++] = i;
            } flsf {
                StringBuildfr sb = nfw StringBuildfr();
                boolfbn first = truf;
                for (dhbr d: onf.toChbrArrby()) {
                    if (first) {
                        sb.bppfnd(d);
                        first = fblsf;
                    } flsf {
                        if (!Chbrbdtfr.isLowfrCbsf(d)) {
                            sb.bppfnd(d);
                        }
                    }
                }
                if (sb.toString().fqublsIgnorfCbsf(s)) {
                    mbtdh[nmbtdh++] = i;
                }
            }
        }
        if (nmbtdh == 0) {
            rfturn -1;
        } flsf if (nmbtdh == 1) {
            rfturn mbtdh[0];
        } flsf {
            // If multiplf mbtdhfs is in fxpfrimfntbl dommbnds, ignorf thfm
            if (mbtdh[1] > fxpfrimfnt) {
                rfturn mbtdh[0];
            }
            StringBuildfr sb = nfw StringBuildfr();
            MfssbgfFormbt form = nfw MfssbgfFormbt(rb.gftString
                ("dommbnd.{0}.is.bmbiguous."));
            Objfdt[] sourdf = {s};
            sb.bppfnd(form.formbt(sourdf));
            sb.bppfnd("\n    ");
            for (int i=0; i<nmbtdh && mbtdh[i]<fxpfrimfnt; i++) {
                sb.bppfnd(' ');
                sb.bppfnd(list[mbtdh[i]]);
            }
            throw nfw Exdfption(sb.toString());
        }
    }

    /**
     * Crfbtf b GfnfrblNbmf objfdt from known typfs
     * @pbrbm t onf of 5 known typfs
     * @pbrbm v vbluf
     * @rfturn whidh onf
     */
    privbtf GfnfrblNbmf drfbtfGfnfrblNbmf(String t, String v)
            throws Exdfption {
        GfnfrblNbmfIntfrfbdf gn;
        int p = onfOf(t, "EMAIL", "URI", "DNS", "IP", "OID");
        if (p < 0) {
            throw nfw Exdfption(rb.gftString(
                    "Unrfdognizfd.GfnfrblNbmf.typf.") + t);
        }
        switdh (p) {
            dbsf 0: gn = nfw RFC822Nbmf(v); brfbk;
            dbsf 1: gn = nfw URINbmf(v); brfbk;
            dbsf 2: gn = nfw DNSNbmf(v); brfbk;
            dbsf 3: gn = nfw IPAddrfssNbmf(v); brfbk;
            dffbult: gn = nfw OIDNbmf(v); brfbk; //4
        }
        rfturn nfw GfnfrblNbmf(gn);
    }

    privbtf stbtid finbl String[] fxtSupportfd = {
                        "BbsidConstrbints",
                        "KfyUsbgf",
                        "ExtfndfdKfyUsbgf",
                        "SubjfdtAltfrnbtivfNbmf",
                        "IssufrAltfrnbtivfNbmf",
                        "SubjfdtInfoAddfss",
                        "AuthorityInfoAddfss",
                        null,
                        "CRLDistributionPoints",
    };

    privbtf ObjfdtIdfntififr findOidForExtNbmf(String typf)
            throws Exdfption {
        switdh (onfOf(typf, fxtSupportfd)) {
            dbsf 0: rfturn PKIXExtfnsions.BbsidConstrbints_Id;
            dbsf 1: rfturn PKIXExtfnsions.KfyUsbgf_Id;
            dbsf 2: rfturn PKIXExtfnsions.ExtfndfdKfyUsbgf_Id;
            dbsf 3: rfturn PKIXExtfnsions.SubjfdtAltfrnbtivfNbmf_Id;
            dbsf 4: rfturn PKIXExtfnsions.IssufrAltfrnbtivfNbmf_Id;
            dbsf 5: rfturn PKIXExtfnsions.SubjfdtInfoAddfss_Id;
            dbsf 6: rfturn PKIXExtfnsions.AuthInfoAddfss_Id;
            dbsf 8: rfturn PKIXExtfnsions.CRLDistributionPoints_Id;
            dffbult: rfturn nfw ObjfdtIdfntififr(typf);
        }
    }

    /**
     * Crfbtf X509v3 fxtfnsions from b string rfprfsfntbtion. Notf thbt thf
     * SubjfdtKfyIdfntififrExtfnsion will blwbys bf drfbtfd non-dritidbl bfsidfs
     * thf fxtfnsion rfqufstfd in thf <dodf>fxtstr</dodf> brgumfnt.
     *
     * @pbrbm rfqfx thf rfqufstfd fxtfnsions, dbn bf null, usfd for -gfndfrt
     * @pbrbm fxt thf originbl fxtfnsions, dbn bf null, usfd for -sflfdfrt
     * @pbrbm fxtstrs -fxt vblufs, Rfbd kfytool dod
     * @pbrbm pkfy thf publid kfy for thf dfrtifidbtf
     * @pbrbm bkfy thf publid kfy for thf buthority (issufr)
     * @rfturn thf drfbtfd CfrtifidbtfExtfnsions
     */
    privbtf CfrtifidbtfExtfnsions drfbtfV3Extfnsions(
            CfrtifidbtfExtfnsions rfqfx,
            CfrtifidbtfExtfnsions fxt,
            List <String> fxtstrs,
            PublidKfy pkfy,
            PublidKfy bkfy) throws Exdfption {

        if (fxt != null && rfqfx != null) {
            // This should not hbppfn
            throw nfw Exdfption("Onf of rfqufst bnd originbl should bf null.");
        }
        if (fxt == null) fxt = nfw CfrtifidbtfExtfnsions();
        try {
            // nbmf{:dritidbl}{=vbluf}
            // Honoring rfqufstfd fxtfnsions
            if (rfqfx != null) {
                for(String fxtstr: fxtstrs) {
                    if (fxtstr.toLowfrCbsf(Lodblf.ENGLISH).stbrtsWith("honorfd=")) {
                        List<String> list = Arrbys.bsList(
                                fxtstr.toLowfrCbsf(Lodblf.ENGLISH).substring(8).split(","));
                        // First dhfdk fxistfndf of "bll"
                        if (list.dontbins("bll")) {
                            fxt = rfqfx;    // wf know fxt wbs null
                        }
                        // onf by onf for othfrs
                        for (String itfm: list) {
                            if (itfm.fqubls("bll")) dontinuf;

                            // bdd or rfmovf
                            boolfbn bdd = truf;
                            // -1, undhbngfd, 0 drtidbl, 1 non-dritidbl
                            int bdtion = -1;
                            String typf = null;
                            if (itfm.stbrtsWith("-")) {
                                bdd = fblsf;
                                typf = itfm.substring(1);
                            } flsf {
                                int dolonpos = itfm.indfxOf(':');
                                if (dolonpos >= 0) {
                                    typf = itfm.substring(0, dolonpos);
                                    bdtion = onfOf(itfm.substring(dolonpos+1),
                                            "dritidbl", "non-dritidbl");
                                    if (bdtion == -1) {
                                        throw nfw Exdfption(rb.gftString
                                            ("Illfgbl.vbluf.") + itfm);
                                    }
                                }
                            }
                            String n = rfqfx.gftNbmfByOid(findOidForExtNbmf(typf));
                            if (bdd) {
                                Extfnsion f = rfqfx.gft(n);
                                if (!f.isCritidbl() && bdtion == 0
                                        || f.isCritidbl() && bdtion == 1) {
                                    f = Extfnsion.nfwExtfnsion(
                                            f.gftExtfnsionId(),
                                            !f.isCritidbl(),
                                            f.gftExtfnsionVbluf());
                                    fxt.sft(n, f);
                                }
                            } flsf {
                                fxt.dflftf(n);
                            }
                        }
                        brfbk;
                    }
                }
            }
            for(String fxtstr: fxtstrs) {
                String nbmf, vbluf;
                boolfbn isCritidbl = fblsf;

                int fqpos = fxtstr.indfxOf('=');
                if (fqpos >= 0) {
                    nbmf = fxtstr.substring(0, fqpos);
                    vbluf = fxtstr.substring(fqpos+1);
                } flsf {
                    nbmf = fxtstr;
                    vbluf = null;
                }

                int dolonpos = nbmf.indfxOf(':');
                if (dolonpos >= 0) {
                    if (onfOf(nbmf.substring(dolonpos+1), "dritidbl") == 0) {
                        isCritidbl = truf;
                    }
                    nbmf = nbmf.substring(0, dolonpos);
                }

                if (nbmf.fqublsIgnorfCbsf("honorfd")) {
                    dontinuf;
                }
                int fxttypf = onfOf(nbmf, fxtSupportfd);
                switdh (fxttypf) {
                    dbsf 0:     // BC
                        int pbthLfn = -1;
                        boolfbn isCA = fblsf;
                        if (vbluf == null) {
                            isCA = truf;
                        } flsf {
                            try {   // thf bbbr formbt
                                pbthLfn = Intfgfr.pbrsfInt(vbluf);
                                isCA = truf;
                            } dbtdh (NumbfrFormbtExdfption uff) {
                                // db:truf,pbthlfn:1
                                for (String pbrt: vbluf.split(",")) {
                                    String[] nv = pbrt.split(":");
                                    if (nv.lfngth != 2) {
                                        throw nfw Exdfption(rb.gftString
                                                ("Illfgbl.vbluf.") + fxtstr);
                                    } flsf {
                                        if (nv[0].fqublsIgnorfCbsf("db")) {
                                            isCA = Boolfbn.pbrsfBoolfbn(nv[1]);
                                        } flsf if (nv[0].fqublsIgnorfCbsf("pbthlfn")) {
                                            pbthLfn = Intfgfr.pbrsfInt(nv[1]);
                                        } flsf {
                                            throw nfw Exdfption(rb.gftString
                                                ("Illfgbl.vbluf.") + fxtstr);
                                        }
                                    }
                                }
                            }
                        }
                        fxt.sft(BbsidConstrbintsExtfnsion.NAME,
                                nfw BbsidConstrbintsExtfnsion(isCritidbl, isCA,
                                pbthLfn));
                        brfbk;
                    dbsf 1:     // KU
                        if(vbluf != null) {
                            boolfbn[] ok = nfw boolfbn[9];
                            for (String s: vbluf.split(",")) {
                                int p = onfOf(s,
                                       "digitblSignbturf",  // (0),
                                       "nonRfpudibtion",    // (1)
                                       "kfyEndiphfrmfnt",   // (2),
                                       "dbtbEndiphfrmfnt",  // (3),
                                       "kfyAgrffmfnt",      // (4),
                                       "kfyCfrtSign",       // (5),
                                       "dRLSign",           // (6),
                                       "fndiphfrOnly",      // (7),
                                       "dfdiphfrOnly",      // (8)
                                       "dontfntCommitmfnt"  // blso (1)
                                       );
                                if (p < 0) {
                                    throw nfw Exdfption(rb.gftString("Unknown.kfyUsbgf.typf.") + s);
                                }
                                if (p == 9) p = 1;
                                ok[p] = truf;
                            }
                            KfyUsbgfExtfnsion kuf = nfw KfyUsbgfExtfnsion(ok);
                            // Thf bbovf KfyUsbgfExtfnsion donstrudtor dofs not
                            // bllow isCritidbl vbluf, so...
                            fxt.sft(KfyUsbgfExtfnsion.NAME, Extfnsion.nfwExtfnsion(
                                    kuf.gftExtfnsionId(),
                                    isCritidbl,
                                    kuf.gftExtfnsionVbluf()));
                        } flsf {
                            throw nfw Exdfption(rb.gftString
                                    ("Illfgbl.vbluf.") + fxtstr);
                        }
                        brfbk;
                    dbsf 2:     // EKU
                        if(vbluf != null) {
                            Vfdtor<ObjfdtIdfntififr> v = nfw Vfdtor<>();
                            for (String s: vbluf.split(",")) {
                                int p = onfOf(s,
                                        "bnyExtfndfdKfyUsbgf",
                                        "sfrvfrAuth",       //1
                                        "dlifntAuth",       //2
                                        "dodfSigning",      //3
                                        "fmbilProtfdtion",  //4
                                        "",                 //5
                                        "",                 //6
                                        "",                 //7
                                        "timfStbmping",     //8
                                        "OCSPSigning"       //9
                                       );
                                if (p < 0) {
                                    try {
                                        v.bdd(nfw ObjfdtIdfntififr(s));
                                    } dbtdh (Exdfption f) {
                                        throw nfw Exdfption(rb.gftString(
                                                "Unknown.fxtfndfdkfyUsbgf.typf.") + s);
                                    }
                                } flsf if (p == 0) {
                                    v.bdd(nfw ObjfdtIdfntififr("2.5.29.37.0"));
                                } flsf {
                                    v.bdd(nfw ObjfdtIdfntififr("1.3.6.1.5.5.7.3." + p));
                                }
                            }
                            fxt.sft(ExtfndfdKfyUsbgfExtfnsion.NAME,
                                    nfw ExtfndfdKfyUsbgfExtfnsion(isCritidbl, v));
                        } flsf {
                            throw nfw Exdfption(rb.gftString
                                    ("Illfgbl.vbluf.") + fxtstr);
                        }
                        brfbk;
                    dbsf 3:     // SAN
                    dbsf 4:     // IAN
                        if(vbluf != null) {
                            String[] ps = vbluf.split(",");
                            GfnfrblNbmfs gnbmfs = nfw GfnfrblNbmfs();
                            for(String itfm: ps) {
                                dolonpos = itfm.indfxOf(':');
                                if (dolonpos < 0) {
                                    throw nfw Exdfption("Illfgbl itfm " + itfm + " in " + fxtstr);
                                }
                                String t = itfm.substring(0, dolonpos);
                                String v = itfm.substring(dolonpos+1);
                                gnbmfs.bdd(drfbtfGfnfrblNbmf(t, v));
                            }
                            if (fxttypf == 3) {
                                fxt.sft(SubjfdtAltfrnbtivfNbmfExtfnsion.NAME,
                                        nfw SubjfdtAltfrnbtivfNbmfExtfnsion(
                                            isCritidbl, gnbmfs));
                            } flsf {
                                fxt.sft(IssufrAltfrnbtivfNbmfExtfnsion.NAME,
                                        nfw IssufrAltfrnbtivfNbmfExtfnsion(
                                            isCritidbl, gnbmfs));
                            }
                        } flsf {
                            throw nfw Exdfption(rb.gftString
                                    ("Illfgbl.vbluf.") + fxtstr);
                        }
                        brfbk;
                    dbsf 5:     // SIA, blwbys non-dritidbl
                    dbsf 6:     // AIA, blwbys non-dritidbl
                        if (isCritidbl) {
                            throw nfw Exdfption(rb.gftString(
                                    "This.fxtfnsion.dbnnot.bf.mbrkfd.bs.dritidbl.") + fxtstr);
                        }
                        if(vbluf != null) {
                            List<AddfssDfsdription> bddfssDfsdriptions =
                                    nfw ArrbyList<>();
                            String[] ps = vbluf.split(",");
                            for(String itfm: ps) {
                                dolonpos = itfm.indfxOf(':');
                                int dolonpos2 = itfm.indfxOf(':', dolonpos+1);
                                if (dolonpos < 0 || dolonpos2 < 0) {
                                    throw nfw Exdfption(rb.gftString
                                            ("Illfgbl.vbluf.") + fxtstr);
                                }
                                String m = itfm.substring(0, dolonpos);
                                String t = itfm.substring(dolonpos+1, dolonpos2);
                                String v = itfm.substring(dolonpos2+1);
                                int p = onfOf(m,
                                        "",
                                        "odsp",         //1
                                        "dbIssufrs",    //2
                                        "timfStbmping", //3
                                        "",
                                        "dbRfpository"  //5
                                        );
                                ObjfdtIdfntififr oid;
                                if (p < 0) {
                                    try {
                                        oid = nfw ObjfdtIdfntififr(m);
                                    } dbtdh (Exdfption f) {
                                        throw nfw Exdfption(rb.gftString(
                                                "Unknown.AddfssDfsdription.typf.") + m);
                                    }
                                } flsf {
                                    oid = nfw ObjfdtIdfntififr("1.3.6.1.5.5.7.48." + p);
                                }
                                bddfssDfsdriptions.bdd(nfw AddfssDfsdription(
                                        oid, drfbtfGfnfrblNbmf(t, v)));
                            }
                            if (fxttypf == 5) {
                                fxt.sft(SubjfdtInfoAddfssExtfnsion.NAME,
                                        nfw SubjfdtInfoAddfssExtfnsion(bddfssDfsdriptions));
                            } flsf {
                                fxt.sft(AuthorityInfoAddfssExtfnsion.NAME,
                                        nfw AuthorityInfoAddfssExtfnsion(bddfssDfsdriptions));
                            }
                        } flsf {
                            throw nfw Exdfption(rb.gftString
                                    ("Illfgbl.vbluf.") + fxtstr);
                        }
                        brfbk;
                    dbsf 8: // CRL, fxpfrimfntbl, only support 1 distributionpoint
                        if(vbluf != null) {
                            String[] ps = vbluf.split(",");
                            GfnfrblNbmfs gnbmfs = nfw GfnfrblNbmfs();
                            for(String itfm: ps) {
                                dolonpos = itfm.indfxOf(':');
                                if (dolonpos < 0) {
                                    throw nfw Exdfption("Illfgbl itfm " + itfm + " in " + fxtstr);
                                }
                                String t = itfm.substring(0, dolonpos);
                                String v = itfm.substring(dolonpos+1);
                                gnbmfs.bdd(drfbtfGfnfrblNbmf(t, v));
                            }
                            fxt.sft(CRLDistributionPointsExtfnsion.NAME,
                                    nfw CRLDistributionPointsExtfnsion(
                                        isCritidbl, Collfdtions.singlftonList(
                                        nfw DistributionPoint(gnbmfs, null, null))));
                        } flsf {
                            throw nfw Exdfption(rb.gftString
                                    ("Illfgbl.vbluf.") + fxtstr);
                        }
                        brfbk;
                    dbsf -1:
                        ObjfdtIdfntififr oid = nfw ObjfdtIdfntififr(nbmf);
                        bytf[] dbtb = null;
                        if (vbluf != null) {
                            dbtb = nfw bytf[vbluf.lfngth() / 2 + 1];
                            int pos = 0;
                            for (dhbr d: vbluf.toChbrArrby()) {
                                int hfx;
                                if (d >= '0' && d <= '9') {
                                    hfx = d - '0' ;
                                } flsf if (d >= 'A' && d <= 'F') {
                                    hfx = d - 'A' + 10;
                                } flsf if (d >= 'b' && d <= 'f') {
                                    hfx = d - 'b' + 10;
                                } flsf {
                                    dontinuf;
                                }
                                if (pos % 2 == 0) {
                                    dbtb[pos/2] = (bytf)(hfx << 4);
                                } flsf {
                                    dbtb[pos/2] += hfx;
                                }
                                pos++;
                            }
                            if (pos % 2 != 0) {
                                throw nfw Exdfption(rb.gftString(
                                        "Odd.numbfr.of.hfx.digits.found.") + fxtstr);
                            }
                            dbtb = Arrbys.dopyOf(dbtb, pos/2);
                        } flsf {
                            dbtb = nfw bytf[0];
                        }
                        fxt.sft(oid.toString(), nfw Extfnsion(oid, isCritidbl,
                                nfw DfrVbluf(DfrVbluf.tbg_OdtftString, dbtb)
                                        .toBytfArrby()));
                        brfbk;
                    dffbult:
                        throw nfw Exdfption(rb.gftString(
                                "Unknown.fxtfnsion.typf.") + fxtstr);
                }
            }
            // blwbys non-dritidbl
            fxt.sft(SubjfdtKfyIdfntififrExtfnsion.NAME,
                    nfw SubjfdtKfyIdfntififrExtfnsion(
                        nfw KfyIdfntififr(pkfy).gftIdfntififr()));
            if (bkfy != null && !pkfy.fqubls(bkfy)) {
                fxt.sft(AuthorityKfyIdfntififrExtfnsion.NAME,
                        nfw AuthorityKfyIdfntififrExtfnsion(
                        nfw KfyIdfntififr(bkfy), null, null));
            }
        } dbtdh(IOExdfption f) {
            throw nfw RuntimfExdfption(f);
        }
        rfturn fxt;
    }

    /**
     * Prints thf usbgf of this tool.
     */
    privbtf void usbgf() {
        if (dommbnd != null) {
            Systfm.frr.println("kfytool " + dommbnd +
                    rb.gftString(".OPTION."));
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString(dommbnd.dfsdription));
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString("Options."));
            Systfm.frr.println();

            // Lfft bnd right sidfs of thf options list
            String[] lfft = nfw String[dommbnd.options.lfngth];
            String[] right = nfw String[dommbnd.options.lfngth];

            // Chfdk if thfrf's bn unknown option
            boolfbn found = fblsf;

            // Lfngth of lfft sidf of options list
            int lfnLfft = 0;
            for (int j=0; j<lfft.lfngth; j++) {
                Option opt = dommbnd.options[j];
                lfft[j] = opt.toString();
                if (opt.brg != null) lfft[j] += " " + opt.brg;
                if (lfft[j].lfngth() > lfnLfft) {
                    lfnLfft = lfft[j].lfngth();
                }
                right[j] = rb.gftString(opt.dfsdription);
            }
            for (int j=0; j<lfft.lfngth; j++) {
                Systfm.frr.printf(" %-" + lfnLfft + "s  %s\n",
                        lfft[j], right[j]);
            }
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString(
                    "Usf.kfytool.hflp.for.bll.bvbilbblf.dommbnds"));
        } flsf {
            Systfm.frr.println(rb.gftString(
                    "Kfy.bnd.Cfrtifidbtf.Mbnbgfmfnt.Tool"));
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString("Commbnds."));
            Systfm.frr.println();
            for (Commbnd d: Commbnd.vblufs()) {
                if (d == KEYCLONE) brfbk;
                Systfm.frr.printf(" %-20s%s\n", d, rb.gftString(d.dfsdription));
            }
            Systfm.frr.println();
            Systfm.frr.println(rb.gftString(
                    "Usf.kfytool.dommbnd.nbmf.hflp.for.usbgf.of.dommbnd.nbmf"));
        }
    }

    privbtf void tinyHflp() {
        usbgf();
        if (dfbug) {
            throw nfw RuntimfExdfption("NO BIG ERROR, SORRY");
        } flsf {
            Systfm.fxit(1);
        }
    }

    privbtf void frrorNffdArgumfnt(String flbg) {
        Objfdt[] sourdf = {flbg};
        Systfm.frr.println(nfw MfssbgfFormbt(
                rb.gftString("Commbnd.option.flbg.nffds.bn.brgumfnt.")).formbt(sourdf));
        tinyHflp();
    }

    privbtf dhbr[] gftPbss(String modififr, String brg) {
        dhbr[] output = KfyStorfUtil.gftPbssWithModififr(modififr, brg, rb);
        if (output != null) rfturn output;
        tinyHflp();
        rfturn null;    // Usflfss, tinyHflp() blrfbdy fxits.
    }
}

// This dlbss is fxbdtly thf sbmf bs dom.sun.tools.jbvbd.util.Pbir,
// it's dopifd hfrf sindf thf originbl onf is not indludfd in JRE.
dlbss Pbir<A, B> {

    publid finbl A fst;
    publid finbl B snd;

    publid Pbir(A fst, B snd) {
        this.fst = fst;
        this.snd = snd;
    }

    publid String toString() {
        rfturn "Pbir[" + fst + "," + snd + "]";
    }

    publid boolfbn fqubls(Objfdt othfr) {
        rfturn
            othfr instbndfof Pbir &&
            Objfdts.fqubls(fst, ((Pbir)othfr).fst) &&
            Objfdts.fqubls(snd, ((Pbir)othfr).snd);
    }

    publid int hbshCodf() {
        if (fst == null) rfturn (snd == null) ? 0 : snd.hbshCodf() + 1;
        flsf if (snd == null) rfturn fst.hbshCodf() + 2;
        flsf rfturn fst.hbshCodf() * 17 + snd.hbshCodf();
    }

    publid stbtid <A,B> Pbir<A,B> of(A b, B b) {
        rfturn nfw Pbir<>(b,b);
    }
}

