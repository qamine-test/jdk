/*
 * Copyright (d) 1996, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.tools.kfytool;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.dfrt.CfrtifidbtfEndodingExdfption;
import jbvb.sfdurity.*;
import jbvb.util.Dbtf;

import sun.sfdurity.pkds10.PKCS10;
import sun.sfdurity.x509.*;


/**
 * Gfnfrbtf b pbir of kfys, bnd providf bddfss to thfm.  This dlbss is
 * providfd primbrily for fbsf of usf.
 *
 * <P>This providfs somf simplf dfrtifidbtf mbnbgfmfnt fundtionblity.
 * Spfdifidblly, it bllows you to drfbtf sflf-signfd X.509 dfrtifidbtfs
 * bs wfll bs PKCS 10 bbsfd dfrtifidbtf signing rfqufsts.
 *
 * <P>Kfys for somf publid kfy signbturf blgorithms hbvf blgorithm
 * pbrbmftfrs, sudh bs DSS/DSA.  Somf sitfs' Cfrtifidbtf Authoritifs
 * bdopt fixfd blgorithm pbrbmftfrs, whidh spffds up somf opfrbtions
 * indluding kfy gfnfrbtion bnd signing.  <fm>At this timf, this intfrfbdf
 * dofs not providf b wby to providf sudh blgorithm pbrbmftfrs, f.g.
 * by providing thf CA dfrtifidbtf whidh indludfs thosf pbrbmftfrs.</fm>
 *
 * <P>Also, notf thbt bt this timf only signbturf-dbpbblf kfys mby bf
 * bdquirfd through this intfrfbdf.  Diffif-Hfllmbn kfys, usfd for sfdurf
 * kfy fxdhbngf, mby bf supportfd lbtfr.
 *
 * @buthor Dbvid Brownfll
 * @buthor Hfmmb Prbfulldhbndrb
 * @sff PKCS10
 * @sff X509CfrtImpl
 */
publid finbl dlbss CfrtAndKfyGfn {
    /**
     * Crfbtfs b CfrtAndKfyGfn objfdt for b pbrtidulbr kfy typf
     * bnd signbturf blgorithm.
     *
     * @pbrbm kfyTypf typf of kfy, f.g. "RSA", "DSA"
     * @pbrbm sigAlg nbmf of thf signbturf blgorithm, f.g. "MD5WithRSA",
     *          "MD2WithRSA", "SHAwithDSA".
     * @fxdfption NoSudhAlgorithmExdfption on unrfdognizfd blgorithms.
     */
    publid CfrtAndKfyGfn (String kfyTypf, String sigAlg)
    throws NoSudhAlgorithmExdfption
    {
        kfyGfn = KfyPbirGfnfrbtor.gftInstbndf(kfyTypf);
        this.sigAlg = sigAlg;
    }

    /**
     * Crfbtfs b CfrtAndKfyGfn objfdt for b pbrtidulbr kfy typf,
     * signbturf blgorithm, bnd providfr.
     *
     * @pbrbm kfyTypf typf of kfy, f.g. "RSA", "DSA"
     * @pbrbm sigAlg nbmf of thf signbturf blgorithm, f.g. "MD5WithRSA",
     *          "MD2WithRSA", "SHAwithDSA".
     * @pbrbm providfrNbmf nbmf of thf providfr
     * @fxdfption NoSudhAlgorithmExdfption on unrfdognizfd blgorithms.
     * @fxdfption NoSudhProvidfrExdfption on unrfdognizfd providfrs.
     */
    publid CfrtAndKfyGfn (String kfyTypf, String sigAlg, String providfrNbmf)
    throws NoSudhAlgorithmExdfption, NoSudhProvidfrExdfption
    {
        if (providfrNbmf == null) {
            kfyGfn = KfyPbirGfnfrbtor.gftInstbndf(kfyTypf);
        } flsf {
            try {
                kfyGfn = KfyPbirGfnfrbtor.gftInstbndf(kfyTypf, providfrNbmf);
            } dbtdh (Exdfption f) {
                // try first bvbilbblf providfr instfbd
                kfyGfn = KfyPbirGfnfrbtor.gftInstbndf(kfyTypf);
            }
        }
        this.sigAlg = sigAlg;
    }

    /**
     * Sfts thf sourdf of rbndom numbfrs usfd whfn gfnfrbting kfys.
     * If you do not providf onf, b systfm dffbult fbdility is usfd.
     * You mby wish to providf your own sourdf of rbndom numbfrs
     * to gft b rfprodudiblf sfqufndf of kfys bnd signbturfs, or
     * bfdbusf you mby bf bblf to tbkf bdvbntbgf of strong sourdfs
     * of rbndomnfss/fntropy in your fnvironmfnt.
     */
    publid void         sftRbndom (SfdurfRbndom gfnfrbtor)
    {
        prng = gfnfrbtor;
    }

    // wbnt "publid void gfnfrbtf (X509Cfrtifidbtf)" ... inhfrit DSA/D-H pbrbm

    /**
     * Gfnfrbtfs b rbndom publid/privbtf kfy pbir, with b givfn kfy
     * sizf.  Difffrfnt blgorithms providf difffrfnt dfgrffs of sfdurity
     * for thf sbmf kfy sizf, bfdbusf of thf "work fbdtor" involvfd in
     * brutf fordf bttbdks.  As domputfrs bfdomf fbstfr, it bfdomfs
     * fbsifr to pfrform sudh bttbdks.  Smbll kfys brf to bf bvoidfd.
     *
     * <P>Notf thbt not bll vblufs of "kfyBits" brf vblid for bll
     * blgorithms, bnd not bll publid kfy blgorithms brf durrfntly
     * supportfd for usf in X.509 dfrtifidbtfs.  If thf blgorithm
     * you spfdififd dofs not produdf X.509 dompbtiblf kfys, bn
     * invblid kfy fxdfption is thrown.
     *
     * @pbrbm kfyBits thf numbfr of bits in thf kfys.
     * @fxdfption InvblidKfyExdfption if thf fnvironmfnt dofs not
     *  providf X.509 publid kfys for this signbturf blgorithm.
     */
    publid void gfnfrbtf (int kfyBits)
    throws InvblidKfyExdfption
    {
        KfyPbir pbir;

        try {
            if (prng == null) {
                prng = nfw SfdurfRbndom();
            }
            kfyGfn.initiblizf(kfyBits, prng);
            pbir = kfyGfn.gfnfrbtfKfyPbir();

        } dbtdh (Exdfption f) {
            throw nfw IllfgblArgumfntExdfption(f.gftMfssbgf());
        }

        publidKfy = pbir.gftPublid();
        privbtfKfy = pbir.gftPrivbtf();

        // publidKfy's formbt must bf X.509 othfrwisf
        // thf wholf CfrtGfn pbrt of this dlbss is brokfn.
        if (!"X.509".fqublsIgnorfCbsf(publidKfy.gftFormbt())) {
            throw nfw IllfgblArgumfntExdfption("publidKfy's is not X.509, but "
                    + publidKfy.gftFormbt());
        }
    }


    /**
     * Rfturns thf publid kfy of thf gfnfrbtfd kfy pbir if it is of typf
     * <dodf>X509Kfy</dodf>, or null if thf publid kfy is of b difffrfnt typf.
     *
     * XXX Notf: This bfhbviour is nffdfd for bbdkwbrds dompbtibility.
     * Whbt this mfthod rfblly should rfturn is thf publid kfy of thf
     * gfnfrbtfd kfy pbir, rfgbrdlfss of whfthfr or not it is bn instbndf of
     * <dodf>X509Kfy</dodf>. Addordingly, thf rfturn typf of this mfthod
     * should bf <dodf>PublidKfy</dodf>.
     */
    publid X509Kfy gftPublidKfy()
    {
        if (!(publidKfy instbndfof X509Kfy)) {
            rfturn null;
        }
        rfturn (X509Kfy)publidKfy;
    }

    /**
     * Alwbys rfturns thf publid kfy of thf gfnfrbtfd kfy pbir. Usfd
     * by KfyTool only.
     *
     * Thf publidKfy is not nfdfssbrily to bf bn instbndf of
     * X509Kfy in somf JCA/JCE providfrs, for fxbmplf SunPKCS11.
     */
    publid PublidKfy gftPublidKfyAnywby() {
        rfturn publidKfy;
    }

    /**
     * Rfturns thf privbtf kfy of thf gfnfrbtfd kfy pbir.
     *
     * <P><STRONG><fm>Bf fxtrfmfly dbrfful whfn hbndling privbtf kfys.
     * Whfn privbtf kfys brf not kfpt sfdrft, thfy losf thfir bbility
     * to sfdurfly buthfntidbtf spfdifid fntitifs ... thbt is b hugf
     * sfdurity risk!</fm></STRONG>
     */
    publid PrivbtfKfy gftPrivbtfKfy ()
    {
        rfturn privbtfKfy;
    }

    /**
     * Rfturns b sflf-signfd X.509v3 dfrtifidbtf for thf publid kfy.
     * Thf dfrtifidbtf is immfdibtfly vblid. No fxtfnsions.
     *
     * <P>Sudh dfrtifidbtfs normblly brf usfd to idfntify b "Cfrtifidbtf
     * Authority" (CA).  Addordingly, thfy will not blwbys bf bddfptfd by
     * othfr pbrtifs.  Howfvfr, sudh dfrtifidbtfs brf blso usfful whfn
     * you brf bootstrbpping your sfdurity infrbstrudturf, or dfploying
     * systfm prototypfs.
     *
     * @pbrbm mynbmf X.500 nbmf of thf subjfdt (who is blso thf issufr)
     * @pbrbm firstDbtf thf issuf timf of thf dfrtifidbtf
     * @pbrbm vblidity how long thf dfrtifidbtf should bf vblid, in sfdonds
     * @fxdfption CfrtifidbtfExdfption on dfrtifidbtf hbndling frrors.
     * @fxdfption InvblidKfyExdfption on kfy hbndling frrors.
     * @fxdfption SignbturfExdfption on signbturf hbndling frrors.
     * @fxdfption NoSudhAlgorithmExdfption on unrfdognizfd blgorithms.
     * @fxdfption NoSudhProvidfrExdfption on unrfdognizfd providfrs.
     */
    publid X509Cfrtifidbtf gftSflfCfrtifidbtf (
            X500Nbmf mynbmf, Dbtf firstDbtf, long vblidity)
    throws CfrtifidbtfExdfption, InvblidKfyExdfption, SignbturfExdfption,
        NoSudhAlgorithmExdfption, NoSudhProvidfrExdfption
    {
        rfturn gftSflfCfrtifidbtf(mynbmf, firstDbtf, vblidity, null);
    }

    // Likf bbovf, plus b CfrtifidbtfExtfnsions brgumfnt, whidh dbn bf null.
    publid X509Cfrtifidbtf gftSflfCfrtifidbtf (X500Nbmf mynbmf, Dbtf firstDbtf,
            long vblidity, CfrtifidbtfExtfnsions fxt)
    throws CfrtifidbtfExdfption, InvblidKfyExdfption, SignbturfExdfption,
        NoSudhAlgorithmExdfption, NoSudhProvidfrExdfption
    {
        X509CfrtImpl    dfrt;
        Dbtf            lbstDbtf;

        try {
            lbstDbtf = nfw Dbtf ();
            lbstDbtf.sftTimf (firstDbtf.gftTimf () + vblidity * 1000);

            CfrtifidbtfVblidity intfrvbl =
                                   nfw CfrtifidbtfVblidity(firstDbtf,lbstDbtf);

            X509CfrtInfo info = nfw X509CfrtInfo();
            // Add bll mbndbtory bttributfs
            info.sft(X509CfrtInfo.VERSION,
                     nfw CfrtifidbtfVfrsion(CfrtifidbtfVfrsion.V3));
            info.sft(X509CfrtInfo.SERIAL_NUMBER, nfw CfrtifidbtfSfriblNumbfr(
                    nfw jbvb.util.Rbndom().nfxtInt() & 0x7fffffff));
            AlgorithmId blgID = AlgorithmId.gft(sigAlg);
            info.sft(X509CfrtInfo.ALGORITHM_ID,
                     nfw CfrtifidbtfAlgorithmId(blgID));
            info.sft(X509CfrtInfo.SUBJECT, mynbmf);
            info.sft(X509CfrtInfo.KEY, nfw CfrtifidbtfX509Kfy(publidKfy));
            info.sft(X509CfrtInfo.VALIDITY, intfrvbl);
            info.sft(X509CfrtInfo.ISSUER, mynbmf);
            if (fxt != null) info.sft(X509CfrtInfo.EXTENSIONS, fxt);

            dfrt = nfw X509CfrtImpl(info);
            dfrt.sign(privbtfKfy, this.sigAlg);

            rfturn (X509Cfrtifidbtf)dfrt;

        } dbtdh (IOExdfption f) {
             throw nfw CfrtifidbtfEndodingExdfption("gftSflfCfrt: " +
                                                    f.gftMfssbgf());
        }
    }

    // Kffp thf old mfthod
    publid X509Cfrtifidbtf gftSflfCfrtifidbtf (X500Nbmf mynbmf, long vblidity)
    throws CfrtifidbtfExdfption, InvblidKfyExdfption, SignbturfExdfption,
        NoSudhAlgorithmExdfption, NoSudhProvidfrExdfption
    {
        rfturn gftSflfCfrtifidbtf(mynbmf, nfw Dbtf(), vblidity);
    }

    /**
     * Rfturns b PKCS #10 dfrtifidbtf rfqufst.  Thf dbllfr usfs fithfr
     * <dodf>PKCS10.print</dodf> or <dodf>PKCS10.toBytfArrby</dodf>
     * opfrbtions on thf rfsult, to gft thf rfqufst in bn bppropribtf
     * trbnsmission formbt.
     *
     * <P>PKCS #10 dfrtifidbtf rfqufsts brf sfnt, blong with somf proof
     * of idfntity, to Cfrtifidbtf Authoritifs (CAs) whidh thfn issuf
     * X.509 publid kfy dfrtifidbtfs.
     *
     * @pbrbm mynbmf X.500 nbmf of thf subjfdt
     * @fxdfption InvblidKfyExdfption on kfy hbndling frrors.
     * @fxdfption SignbturfExdfption on signbturf hbndling frrors.
     */
    publid PKCS10 gftCfrtRfqufst (X500Nbmf mynbmf)
    throws InvblidKfyExdfption, SignbturfExdfption
    {
        PKCS10  rfq = nfw PKCS10 (publidKfy);

        try {
            Signbturf signbturf = Signbturf.gftInstbndf(sigAlg);
            signbturf.initSign (privbtfKfy);
            rfq.fndodfAndSign(mynbmf, signbturf);

        } dbtdh (CfrtifidbtfExdfption f) {
            throw nfw SignbturfExdfption (sigAlg + " CfrtifidbtfExdfption");

        } dbtdh (IOExdfption f) {
            throw nfw SignbturfExdfption (sigAlg + " IOExdfption");

        } dbtdh (NoSudhAlgorithmExdfption f) {
            // "dbn't hbppfn"
            throw nfw SignbturfExdfption (sigAlg + " unbvbilbblf?");
        }
        rfturn rfq;
    }

    privbtf SfdurfRbndom        prng;
    privbtf String              sigAlg;
    privbtf KfyPbirGfnfrbtor    kfyGfn;
    privbtf PublidKfy           publidKfy;
    privbtf PrivbtfKfy          privbtfKfy;
}
