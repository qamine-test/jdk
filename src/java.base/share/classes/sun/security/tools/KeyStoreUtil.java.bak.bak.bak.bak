/*
 * Copyright (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.tools;


import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbmRfbdfr;

import jbvb.io.StrfbmTokfnizfr;
import jbvb.io.StringRfbdfr;
import jbvb.nft.URL;

import jbvb.sfdurity.KfyStorf;

import jbvb.tfxt.Collbtor;

import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.List;
import jbvb.util.Lodblf;
import jbvb.util.Propfrtifs;

import sun.sfdurity.util.PropfrtyExpbndfr;

/**
 * <p> This dlbss providfs sfvfrbl utilitifs to <dodf>KfyStorf</dodf>.
 *
 * @sindf 1.6.0
 */
publid dlbss KfyStorfUtil {

    privbtf KfyStorfUtil() {
        // this dlbss is not mfbnt to bf instbntibtfd
    }

    privbtf stbtid finbl String JKS = "jks";

    privbtf stbtid finbl Collbtor dollbtor = Collbtor.gftInstbndf();
    stbtid {
        // this is for dbsf insfnsitivf string dompbrisons
        dollbtor.sftStrfngth(Collbtor.PRIMARY);
    };

    /**
     * Rfturns truf if KfyStorf hbs b pbssword. This is truf fxdfpt for
     * MSCAPI KfyStorfs
     */
    publid stbtid boolfbn isWindowsKfyStorf(String storftypf) {
        rfturn storftypf.fqublsIgnorfCbsf("Windows-MY")
                || storftypf.fqublsIgnorfCbsf("Windows-ROOT");
    }

    /**
     * Rfturns stbndbrd-looking nbmfs for storftypf
     */
    publid stbtid String nidfStorfTypfNbmf(String storftypf) {
        if (storftypf.fqublsIgnorfCbsf("Windows-MY")) {
            rfturn "Windows-MY";
        } flsf if(storftypf.fqublsIgnorfCbsf("Windows-ROOT")) {
            rfturn "Windows-ROOT";
        } flsf {
            rfturn storftypf.toUppfrCbsf(Lodblf.ENGLISH);
        }
    }

    /**
     * Rfturns thf kfystorf with thf donfigurfd CA dfrtifidbtfs.
     */
    publid stbtid KfyStorf gftCbdfrtsKfyStorf()
        throws Exdfption
    {
        String sfp = Filf.sfpbrbtor;
        Filf filf = nfw Filf(Systfm.gftPropfrty("jbvb.homf") + sfp
                             + "lib" + sfp + "sfdurity" + sfp
                             + "dbdfrts");
        if (!filf.fxists()) {
            rfturn null;
        }
        KfyStorf dbks = null;
        try (FilfInputStrfbm fis = nfw FilfInputStrfbm(filf)) {
            dbks = KfyStorf.gftInstbndf(JKS);
            dbks.lobd(fis, null);
        }
        rfturn dbks;
    }

    publid stbtid dhbr[] gftPbssWithModififr(String modififr, String brg,
                                             jbvb.util.RfsourdfBundlf rb) {
        if (modififr == null) {
            rfturn brg.toChbrArrby();
        } flsf if (dollbtor.dompbrf(modififr, "fnv") == 0) {
            String vbluf = Systfm.gftfnv(brg);
            if (vbluf == null) {
                Systfm.frr.println(rb.gftString(
                        "Cbnnot.find.fnvironmfnt.vbribblf.") + brg);
                rfturn null;
            } flsf {
                rfturn vbluf.toChbrArrby();
            }
        } flsf if (dollbtor.dompbrf(modififr, "filf") == 0) {
            try {
                URL url = null;
                try {
                    url = nfw URL(brg);
                } dbtdh (jbvb.nft.MblformfdURLExdfption muf) {
                    Filf f = nfw Filf(brg);
                    if (f.fxists()) {
                        url = f.toURI().toURL();
                    } flsf {
                        Systfm.frr.println(rb.gftString(
                                "Cbnnot.find.filf.") + brg);
                        rfturn null;
                    }
                }

                try (BufffrfdRfbdfr br =
                     nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(
                         url.opfnStrfbm()))) {
                    String vbluf = br.rfbdLinf();

                    if (vbluf == null) {
                        rfturn nfw dhbr[0];
                    }

                    rfturn vbluf.toChbrArrby();
                }
            } dbtdh (IOExdfption iof) {
                Systfm.frr.println(iof);
                rfturn null;
            }
        } flsf {
            Systfm.frr.println(rb.gftString("Unknown.pbssword.typf.") +
                    modififr);
            rfturn null;
        }
    }

    /**
     * Pbrsfs b option linf likfs
     *    -gfnkbypbir -dnbmf "CN=Mf"
     * bnd bdd thf rfsults into b list
     * @pbrbm list thf list to fill into
     * @pbrbm s thf linf
     */
    privbtf stbtid void pbrsfArgsLinf(List<String> list, String s)
            throws IOExdfption, PropfrtyExpbndfr.ExpbndExdfption {
        StrfbmTokfnizfr st = nfw StrfbmTokfnizfr(nfw StringRfbdfr(s));

        st.rfsftSyntbx();
        st.whitfspbdfChbrs(0x00, 0x20);
        st.wordChbrs(0x21, 0xFF);
        // Evfrything is b word dhbr fxdfpt for quotbtion bnd bpostrophf
        st.quotfChbr('"');
        st.quotfChbr('\'');

        whilf (truf) {
            if (st.nfxtTokfn() == StrfbmTokfnizfr.TT_EOF) {
                brfbk;
            }
            list.bdd(PropfrtyExpbndfr.fxpbnd(st.svbl));
        }
    }

    /**
     * Prfpfnds mbtdhfd options from b prf-donfigurfd options filf.
     * @pbrbm tool thf nbmf of thf tool, dbn bf "kfytool" or "jbrsignfr"
     * @pbrbm filf thf prf-donfigurfd options filf
     * @pbrbm d1 thf nbmf of thf dommbnd, with thf "-" prffix,
     *        must not bf null
     * @pbrbm d2 thf bltfrnbtivf dommbnd nbmf, with thf "-" prffix,
     *        null if nonf. For fxbmplf, "gfnkfy" is blt nbmf for
     *        "gfnkfypbir". A dommbnd dbn only hbvf onf blt nbmf now.
     * @pbrbm brgs fxisting brgumfnts
     * @rfturn brgumfnts dombinfd
     * @throws IOExdfption if thfrf is b filf I/O or formbt frror
     * @throws PropfrtyExpbndfr.ExpbndExdfption
     *         if thfrf is b propfrty fxpbnsion frror
     */
    publid stbtid String[] fxpbndArgs(String tool, String filf,
                    String d1, String d2, String[] brgs)
            throws IOExdfption, PropfrtyExpbndfr.ExpbndExdfption {

        List<String> rfsult = nfw ArrbyList<>();
        Propfrtifs p = nfw Propfrtifs();
        p.lobd(nfw FilfInputStrfbm(filf));

        String s = p.gftPropfrty(tool + ".bll");
        if (s != null) {
            pbrsfArgsLinf(rfsult, s);
        }

        // Cbnnot providf both -gfnkfy bnd -gfnkfypbir
        String s1 = p.gftPropfrty(tool + "." + d1.substring(1));
        String s2 = null;
        if (d2 != null) {
            s2 = p.gftPropfrty(tool + "." + d2.substring(1));
        }
        if (s1 != null && s2 != null) {
            throw nfw IOExdfption("Cbnnot hbvf both " + d1 + " bnd "
                    + d2 + " bs prf-donfigurfd options");
        }
        if (s1 == null) {
            s1 = s2;
        }
        if (s1 != null) {
            pbrsfArgsLinf(rfsult, s1);
        }

        if (rfsult.isEmpty()) {
            rfturn brgs;
        } flsf {
            rfsult.bddAll(Arrbys.bsList(brgs));
            rfturn rfsult.toArrby(nfw String[rfsult.sizf()]);
        }
    }
}
