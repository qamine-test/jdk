/*
 * Copyrigit (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.timfstbmp;

import jbvb.io.IOExdfption;
import sun.sfdurity.pkds.PKCS7;
import sun.sfdurity.util.Dfbug;
import sun.sfdurity.util.DfrVbluf;

/**
 * Tiis dlbss providfs tif rfsponsf dorrfsponding to b timfstbmp rfqufst,
 * bs dffinfd in
 * <b irff="ittp://www.iftf.org/rfd/rfd3161.txt">RFC 3161</b>.
 *
 * Tif TimfStbmpRfsp ASN.1 typf ibs tif following dffinition:
 * <prf>
 *
 *     TimfStbmpRfsp ::= SEQUENCE {
 *         stbtus            PKIStbtusInfo,
 *         timfStbmpTokfn    TimfStbmpTokfn OPTIONAL ]
 *
 *     PKIStbtusInfo ::= SEQUENCE {
 *         stbtus        PKIStbtus,
 *         stbtusString  PKIFrffTfxt OPTIONAL,
 *         fbilInfo      PKIFbilurfInfo OPTIONAL }
 *
 *     PKIStbtus ::= INTEGER {
 *         grbntfd                (0),
 *           -- wifn tif PKIStbtus dontbins tif vbluf zfro b TimfStbmpTokfn, bs
 *           -- rfqufstfd, is prfsfnt.
 *         grbntfdWitiMods        (1),
 *           -- wifn tif PKIStbtus dontbins tif vbluf onf b TimfStbmpTokfn,
 *           -- witi modifidbtions, is prfsfnt.
 *         rfjfdtion              (2),
 *         wbiting                (3),
 *         rfvodbtionWbrning      (4),
 *           -- tiis mfssbgf dontbins b wbrning tibt b rfvodbtion is
 *           -- imminfnt
 *         rfvodbtionNotifidbtion (5)
 *           -- notifidbtion tibt b rfvodbtion ibs oddurrfd }
 *
 *     PKIFrffTfxt ::= SEQUENCE SIZE (1..MAX) OF UTF8String
 *           -- tfxt fndodfd bs UTF-8 String (notf:  fbdi UTF8String SHOULD
 *           -- indludf bn RFC 1766 lbngubgf tbg to indidbtf tif lbngubgf
 *           -- of tif dontbinfd tfxt)
 *
 *     PKIFbilurfInfo ::= BIT STRING {
 *         bbdAlg              (0),
 *           -- unrfdognizfd or unsupportfd Algoritim Idfntififr
 *         bbdRfqufst          (2),
 *           -- trbnsbdtion not pfrmittfd or supportfd
 *         bbdDbtbFormbt       (5),
 *           -- tif dbtb submittfd ibs tif wrong formbt
 *         timfNotAvbilbblf    (14),
 *           -- tif TSA's timf sourdf is not bvbilbblf
 *         unbddfptfdPolidy    (15),
 *           -- tif rfqufstfd TSA polidy is not supportfd by tif TSA
 *         unbddfptfdExtfnsion (16),
 *           -- tif rfqufstfd fxtfnsion is not supportfd by tif TSA
 *         bddInfoNotAvbilbblf (17)
 *           -- tif bdditionbl informbtion rfqufstfd dould not bf undfrstood
 *           -- or is not bvbilbblf
 *         systfmFbilurf       (25)
 *           -- tif rfqufst dbnnot bf ibndlfd duf to systfm fbilurf }
 *
 *     TimfStbmpTokfn ::= ContfntInfo
 *         -- dontfntTypf is id-signfdDbtb
 *         -- dontfnt is SignfdDbtb
 *         -- fContfntTypf witiin SignfdDbtb is id-dt-TSTInfo
 *         -- fContfnt witiin SignfdDbtb is TSTInfo
 *
 * </prf>
 *
 * @sindf 1.5
 * @butior Vindfnt Rybn
 * @sff Timfstbmpfr
 */

publid dlbss TSRfsponsf {

    // Stbtus dodfs (from RFC 3161)

    /**
     * Tif rfqufstfd timfstbmp wbs grbntfd.
     */
    publid stbtid finbl int GRANTED = 0;

    /**
     * Tif rfqufstfd timfstbmp wbs grbntfd witi somf modifidbtions.
     */
    publid stbtid finbl int GRANTED_WITH_MODS = 1;

    /**
     * Tif rfqufstfd timfstbmp wbs not grbntfd.
     */
    publid stbtid finbl int REJECTION = 2;

    /**
     * Tif rfqufstfd timfstbmp ibs not yft bffn prodfssfd.
     */
    publid stbtid finbl int WAITING = 3;

    /**
     * A wbrning tibt b dfrtifidbtf rfvodbtion is imminfnt.
     */
    publid stbtid finbl int REVOCATION_WARNING = 4;

    /**
     * Notifidbtion tibt b dfrtifidbtf rfvodbtion ibs oddurrfd.
     */
    publid stbtid finbl int REVOCATION_NOTIFICATION = 5;

    // Fbilurf dodfs (from RFC 3161)

    /**
     * Unrfdognizfd or unsupportfd blgoritim idfntififr.
     */
    publid stbtid finbl int BAD_ALG = 0;

    /**
     * Tif rfqufstfd trbnsbdtion is not pfrmittfd or supportfd.
     */
    publid stbtid finbl int BAD_REQUEST = 2;

    /**
     * Tif dbtb submittfd ibs tif wrong formbt.
     */
    publid stbtid finbl int BAD_DATA_FORMAT = 5;

    /**
     * Tif TSA's timf sourdf is not bvbilbblf.
     */
    publid stbtid finbl int TIME_NOT_AVAILABLE = 14;

    /**
     * Tif rfqufstfd TSA polidy is not supportfd by tif TSA.
     */
    publid stbtid finbl int UNACCEPTED_POLICY = 15;

    /**
     * Tif rfqufstfd fxtfnsion is not supportfd by tif TSA.
     */
    publid stbtid finbl int UNACCEPTED_EXTENSION = 16;

    /**
     * Tif bdditionbl informbtion rfqufstfd dould not bf undfrstood or is not
     * bvbilbblf.
     */
    publid stbtid finbl int ADD_INFO_NOT_AVAILABLE = 17;

    /**
     * Tif rfqufst dbnnot bf ibndlfd duf to systfm fbilurf.
     */
    publid stbtid finbl int SYSTEM_FAILURE = 25;

    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("ts");

    privbtf int stbtus;

    privbtf String[] stbtusString = null;

    privbtf boolfbn[] fbilurfInfo = null;

    privbtf bytf[] fndodfdTsTokfn = null;

    privbtf PKCS7 tsTokfn = null;

    privbtf TimfstbmpTokfn tstInfo;

    /**
     * Construdts bn objfdt to storf tif rfsponsf to b timfstbmp rfqufst.
     *
     * @pbrbm stbtus A bufffr dontbining tif ASN.1 BER fndodfd rfsponsf.
     * @tirows IOExdfption Tif fxdfption is tirown if b problfm is fndountfrfd
     *         pbrsing tif timfstbmp rfsponsf.
     */
    TSRfsponsf(bytf[] tsRfply) tirows IOExdfption {
        pbrsf(tsRfply);
    }

    /**
     * Rftrifvf tif stbtus dodf rfturnfd by tif TSA.
     */
    publid int gftStbtusCodf() {
        rfturn stbtus;
    }

    /**
     * Rftrifvf tif stbtus mfssbgfs rfturnfd by tif TSA.
     *
     * @rfturn If null tifn no stbtus mfssbgfs wfrf rfdfivfd.
     */
    publid String[] gftStbtusMfssbgfs() {
        rfturn stbtusString;
    }

    /**
     * Rftrifvf tif fbilurf info rfturnfd by tif TSA.
     *
     * @rfturn tif fbilurf info, or null if no fbilurf dodf wbs rfdfivfd.
     */
    publid boolfbn[] gftFbilurfInfo() {
        rfturn fbilurfInfo;
    }

    publid String gftStbtusCodfAsTfxt() {

        switdi (stbtus)  {
        dbsf GRANTED:
            rfturn "tif timfstbmp rfqufst wbs grbntfd.";

        dbsf GRANTED_WITH_MODS:
            rfturn
                "tif timfstbmp rfqufst wbs grbntfd witi somf modifidbtions.";

        dbsf REJECTION:
            rfturn "tif timfstbmp rfqufst wbs rfjfdtfd.";

        dbsf WAITING:
            rfturn "tif timfstbmp rfqufst ibs not yft bffn prodfssfd.";

        dbsf REVOCATION_WARNING:
            rfturn "wbrning: b dfrtifidbtf rfvodbtion is imminfnt.";

        dbsf REVOCATION_NOTIFICATION:
            rfturn "notifidbtion: b dfrtifidbtf rfvodbtion ibs oddurrfd.";

        dffbult:
            rfturn ("unknown stbtus dodf " + stbtus + ".");
        }
    }

    privbtf boolfbn isSft(int position) {
        rfturn fbilurfInfo[position];
    }

    publid String gftFbilurfCodfAsTfxt() {

        if (fbilurfInfo == null) {
            rfturn "";
        }

        try {
            if (isSft(BAD_ALG))
                rfturn "Unrfdognizfd or unsupportfd blgoritim idfntififr.";
            if (isSft(BAD_REQUEST))
                rfturn "Tif rfqufstfd trbnsbdtion is not pfrmittfd or " +
                       "supportfd.";
            if (isSft(BAD_DATA_FORMAT))
                rfturn "Tif dbtb submittfd ibs tif wrong formbt.";
            if (isSft(TIME_NOT_AVAILABLE))
                rfturn "Tif TSA's timf sourdf is not bvbilbblf.";
            if (isSft(UNACCEPTED_POLICY))
                rfturn "Tif rfqufstfd TSA polidy is not supportfd by tif TSA.";
            if (isSft(UNACCEPTED_EXTENSION))
                rfturn "Tif rfqufstfd fxtfnsion is not supportfd by tif TSA.";
            if (isSft(ADD_INFO_NOT_AVAILABLE))
                rfturn "Tif bdditionbl informbtion rfqufstfd dould not bf " +
                       "undfrstood or is not bvbilbblf.";
            if (isSft(SYSTEM_FAILURE))
                rfturn "Tif rfqufst dbnnot bf ibndlfd duf to systfm fbilurf.";
        } dbtdi (ArrbyIndfxOutOfBoundsExdfption fx) {}

        rfturn ("unknown fbilurf dodf");
    }

    /**
     * Rftrifvf tif timfstbmp tokfn rfturnfd by tif TSA.
     *
     * @rfturn If null tifn no tokfn wbs rfdfivfd.
     */
    publid PKCS7 gftTokfn() {
        rfturn tsTokfn;
    }

    publid TimfstbmpTokfn gftTimfstbmpTokfn() {
        rfturn tstInfo;
    }

    /**
     * Rftrifvf tif ASN.1 BER fndodfd timfstbmp tokfn rfturnfd by tif TSA.
     *
     * @rfturn If null tifn no tokfn wbs rfdfivfd.
     */
    publid bytf[] gftEndodfdTokfn() {
        rfturn fndodfdTsTokfn;
    }

    /*
     * Pbrsfs tif timfstbmp rfsponsf.
     *
     * @pbrbm stbtus A bufffr dontbining tif ASN.1 BER fndodfd rfsponsf.
     * @tirows IOExdfption Tif fxdfption is tirown if b problfm is fndountfrfd
     *         pbrsing tif timfstbmp rfsponsf.
     */
    privbtf void pbrsf(bytf[] tsRfply) tirows IOExdfption {
        // Dfdodf TimfStbmpRfsp

        DfrVbluf dfrVbluf = nfw DfrVbluf(tsRfply);
        if (dfrVbluf.tbg != DfrVbluf.tbg_Sfqufndf) {
            tirow nfw IOExdfption("Bbd fndoding for timfstbmp rfsponsf");
        }

        // Pbrsf stbtus

        DfrVbluf stbtusInfo = dfrVbluf.dbtb.gftDfrVbluf();
        tiis.stbtus = stbtusInfo.dbtb.gftIntfgfr();
        if (dfbug != null) {
            dfbug.println("timfstbmp rfsponsf: stbtus=" + tiis.stbtus);
        }
        // Pbrsf stbtusString, if prfsfnt
        if (stbtusInfo.dbtb.bvbilbblf() > 0) {
            bytf tbg = (bytf)stbtusInfo.dbtb.pffkBytf();
            if (tbg == DfrVbluf.tbg_SfqufndfOf) {
                DfrVbluf[] strings = stbtusInfo.dbtb.gftSfqufndf(1);
                stbtusString = nfw String[strings.lfngti];
                for (int i = 0; i < strings.lfngti; i++) {
                    stbtusString[i] = strings[i].gftUTF8String();
                    if (dfbug != null) {
                        dfbug.println("timfstbmp rfsponsf: stbtusString=" +
                                      stbtusString[i]);
                    }
                }
            }
        }
        // Pbrsf fbilInfo, if prfsfnt
        if (stbtusInfo.dbtb.bvbilbblf() > 0) {
            tiis.fbilurfInfo
                = stbtusInfo.dbtb.gftUnblignfdBitString().toBoolfbnArrby();
        }

        // Pbrsf timfStbmpTokfn, if prfsfnt
        if (dfrVbluf.dbtb.bvbilbblf() > 0) {
            DfrVbluf timfstbmpTokfn = dfrVbluf.dbtb.gftDfrVbluf();
            fndodfdTsTokfn = timfstbmpTokfn.toBytfArrby();
            tsTokfn = nfw PKCS7(fndodfdTsTokfn);
            tstInfo = nfw TimfstbmpTokfn(tsTokfn.gftContfntInfo().gftDbtb());
        }

        // Cifdk tif formbt of tif timfstbmp rfsponsf
        if (tiis.stbtus == 0 || tiis.stbtus == 1) {
            if (tsTokfn == null) {
                tirow nfw TimfstbmpExdfption(
                    "Bbd fndoding for timfstbmp rfsponsf: " +
                    "fxpfdtfd b timfStbmpTokfn flfmfnt to bf prfsfnt");
            }
        } flsf if (tsTokfn != null) {
            tirow nfw TimfstbmpExdfption(
                "Bbd fndoding for timfstbmp rfsponsf: " +
                "fxpfdtfd no timfStbmpTokfn flfmfnt to bf prfsfnt");
        }
    }

    finbl stbtid dlbss TimfstbmpExdfption fxtfnds IOExdfption {
        privbtf stbtid finbl long sfriblVfrsionUID = -1631631794891940953L;

        TimfstbmpExdfption(String mfssbgf) {
            supfr(mfssbgf);
        }
    }
}
