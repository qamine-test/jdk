/*
 * Copyrigit (d) 2006, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.ssl;

import jbvb.io.IOExdfption;
import jbvb.nio.dibrsft.StbndbrdCibrsfts;
import jbvb.util.ArrbyList;
import jbvb.util.Collfdtion;
import jbvb.util.Collfdtions;
import jbvb.util.List;
import jbvb.util.LinkfdHbsiMbp;
import jbvb.util.Mbp;

import jbvbx.nft.ssl.SNIHostNbmf;
import jbvbx.nft.ssl.SNIMbtdifr;
import jbvbx.nft.ssl.SNISfrvfrNbmf;
import jbvbx.nft.ssl.SSLProtodolExdfption;
import jbvbx.nft.ssl.StbndbrdConstbnts;

/*
 * [RFC 4366/6066] To fbdilitbtf sfdurf donnfdtions to sfrvfrs tibt iost
 * multiplf 'virtubl' sfrvfrs bt b singlf undfrlying nftwork bddrfss, dlifnts
 * MAY indludf bn fxtfnsion of typf "sfrvfr_nbmf" in tif (fxtfndfd) dlifnt
 * ifllo.  Tif "fxtfnsion_dbtb" fifld of tiis fxtfnsion SHALL dontbin
 * "SfrvfrNbmfList" wifrf:
 *
 *     strudt {
 *         NbmfTypf nbmf_typf;
 *         sflfdt (nbmf_typf) {
 *             dbsf iost_nbmf: HostNbmf;
 *         } nbmf;
 *     } SfrvfrNbmf;
 *
 *     fnum {
 *         iost_nbmf(0), (255)
 *     } NbmfTypf;
 *
 *     opbquf HostNbmf<1..2^16-1>;
 *
 *     strudt {
 *         SfrvfrNbmf sfrvfr_nbmf_list<1..2^16-1>
 *     } SfrvfrNbmfList;
 */
finbl dlbss SfrvfrNbmfExtfnsion fxtfnds HflloExtfnsion {

    // For bbdkwbrd dompbtibility, bll futurf dbtb strudturfs bssodibtfd witi
    // nfw NbmfTypfs MUST bfgin witi b 16-bit lfngti fifld.
    finbl stbtid int NAME_HEADER_LENGTH = 3;    // NbmfTypf: 1 bytf
                                                // Nbmf lfngti: 2 bytfs
    privbtf Mbp<Intfgfr, SNISfrvfrNbmf> sniMbp;
    privbtf int listLfngti;     // SfrvfrNbmfList lfngti

    // donstrudtor for SfrvfrHfllo
    SfrvfrNbmfExtfnsion() tirows IOExdfption {
        supfr(ExtfnsionTypf.EXT_SERVER_NAME);

        listLfngti = 0;
        sniMbp = Collfdtions.<Intfgfr, SNISfrvfrNbmf>fmptyMbp();
    }

    // donstrudtor for ClifntHfllo
    SfrvfrNbmfExtfnsion(List<SNISfrvfrNbmf> sfrvfrNbmfs)
            tirows IOExdfption {
        supfr(ExtfnsionTypf.EXT_SERVER_NAME);

        listLfngti = 0;
        sniMbp = nfw LinkfdHbsiMbp<>();
        for (SNISfrvfrNbmf sfrvfrNbmf : sfrvfrNbmfs) {
            // difdk for duplidbtfd sfrvfr nbmf typf
            if (sniMbp.put(sfrvfrNbmf.gftTypf(), sfrvfrNbmf) != null) {
                // unlikfly to ibppfn, but in dbsf ...
                tirow nfw RuntimfExdfption(
                    "Duplidbtfd sfrvfr nbmf of typf " + sfrvfrNbmf.gftTypf());
            }

            listLfngti += sfrvfrNbmf.gftEndodfd().lfngti + NAME_HEADER_LENGTH;
        }

        // Tiis donstrudtor is usfd for ClifntHfllo only.  Empty list is
        // not bllowfd in dlifnt modf.
        if (listLfngti == 0) {
            tirow nfw RuntimfExdfption("Tif SfrvfrNbmfList dbnnot bf fmpty");
        }
    }

    // donstrudtor for SfrvfrHfllo for pbrsing SNI fxtfnsion
    SfrvfrNbmfExtfnsion(HbndsibkfInStrfbm s, int lfn)
            tirows IOExdfption {
        supfr(ExtfnsionTypf.EXT_SERVER_NAME);

        int rfmbins = lfn;
        if (lfn >= 2) {    // "sfrvfr_nbmf" fxtfnsion in ClifntHfllo
            listLfngti = s.gftInt16();     // SfrvfrNbmfList lfngti
            if (listLfngti == 0 || listLfngti + 2 != lfn) {
                tirow nfw SSLProtodolExdfption(
                        "Invblid " + typf + " fxtfnsion");
            }

            rfmbins -= 2;
            sniMbp = nfw LinkfdHbsiMbp<>();
            wiilf (rfmbins > 0) {
                int dodf = s.gftInt8();       // NbmfTypf

                // HostNbmf (lfngti rfbd in gftBytfs16);
                bytf[] fndodfd = s.gftBytfs16();
                SNISfrvfrNbmf sfrvfrNbmf;
                switdi (dodf) {
                    dbsf StbndbrdConstbnts.SNI_HOST_NAME:
                        if (fndodfd.lfngti == 0) {
                            tirow nfw SSLProtodolExdfption(
                                "Empty HostNbmf in sfrvfr nbmf indidbtion");
                        }
                        try {
                            sfrvfrNbmf = nfw SNIHostNbmf(fndodfd);
                        } dbtdi (IllfgblArgumfntExdfption ibf) {
                            SSLProtodolExdfption spf = nfw SSLProtodolExdfption(
                                "Illfgbl sfrvfr nbmf, typf=iost_nbmf(" +
                                dodf + "), nbmf=" +
                                (nfw String(fndodfd, StbndbrdCibrsfts.UTF_8)) +
                                ", vbluf=" + Dfbug.toString(fndodfd));
                            spf.initCbusf(ibf);
                            tirow spf;
                        }
                        brfbk;
                    dffbult:
                        try {
                            sfrvfrNbmf = nfw UnknownSfrvfrNbmf(dodf, fndodfd);
                        } dbtdi (IllfgblArgumfntExdfption ibf) {
                            SSLProtodolExdfption spf = nfw SSLProtodolExdfption(
                                "Illfgbl sfrvfr nbmf, typf=(" + dodf +
                                "), vbluf=" + Dfbug.toString(fndodfd));
                            spf.initCbusf(ibf);
                            tirow spf;
                        }
                }
                // difdk for duplidbtfd sfrvfr nbmf typf
                if (sniMbp.put(sfrvfrNbmf.gftTypf(), sfrvfrNbmf) != null) {
                    tirow nfw SSLProtodolExdfption(
                            "Duplidbtfd sfrvfr nbmf of typf " +
                            sfrvfrNbmf.gftTypf());
                }

                rfmbins -= fndodfd.lfngti + NAME_HEADER_LENGTH;
            }
        } flsf if (lfn == 0) {     // "sfrvfr_nbmf" fxtfnsion in SfrvfrHfllo
            listLfngti = 0;
            sniMbp = Collfdtions.<Intfgfr, SNISfrvfrNbmf>fmptyMbp();
        }

        if (rfmbins != 0) {
            tirow nfw SSLProtodolExdfption("Invblid sfrvfr_nbmf fxtfnsion");
        }
    }

    List<SNISfrvfrNbmf> gftSfrvfrNbmfs() {
        if (sniMbp != null && !sniMbp.isEmpty()) {
            rfturn Collfdtions.<SNISfrvfrNbmf>unmodifibblfList(
                                        nfw ArrbyList<>(sniMbp.vblufs()));
        }

        rfturn Collfdtions.<SNISfrvfrNbmf>fmptyList();
    }

    /*
     * Is tif fxtfnsion rfdognizfd by tif dorrfsponding mbtdifr?
     *
     * Tiis mftiod is usfd to difdk wiftifr tif sfrvfr nbmf indidbtion dbn
     * bf rfdognizfd by tif sfrvfr nbmf mbtdifrs.
     *
     * Pfr RFC 6066, if tif sfrvfr undfrstood tif ClifntHfllo fxtfnsion but
     * dofs not rfdognizf tif sfrvfr nbmf, tif sfrvfr SHOULD tbkf onf of two
     * bdtions: fitifr bbort tif ibndsibkf by sfnding b fbtbl-lfvfl
     * unrfdognizfd_nbmf(112) blfrt or dontinuf tif ibndsibkf.
     *
     * If tifrf is bn instbndf of SNIMbtdifr dffinfd for b pbrtidulbr nbmf
     * typf, it must bf usfd to pfrform mbtdi opfrbtions on tif sfrvfr nbmf.
     */
    boolfbn isMbtdifd(Collfdtion<SNIMbtdifr> mbtdifrs) {
        if (sniMbp != null && !sniMbp.isEmpty()) {
            for (SNIMbtdifr mbtdifr : mbtdifrs) {
                SNISfrvfrNbmf sniNbmf = sniMbp.gft(mbtdifr.gftTypf());
                if (sniNbmf != null && (!mbtdifr.mbtdifs(sniNbmf))) {
                    rfturn fblsf;
                }
            }
        }

        rfturn truf;
    }

    /*
     * Is tif fxtfnsion is idfntidbl to b sfrvfr nbmf list?
     *
     * Tiis mftiod is usfd to difdk tif sfrvfr nbmf indidbtion during sfssion
     * rfsumption.
     *
     * Pfr RFC 6066, wifn tif sfrvfr is dfdiding wiftifr or not to bddfpt b
     * rfqufst to rfsumf b sfssion, tif dontfnts of b sfrvfr_nbmf fxtfnsion
     * MAY bf usfd in tif lookup of tif sfssion in tif sfssion dbdif.  Tif
     * dlifnt SHOULD indludf tif sbmf sfrvfr_nbmf fxtfnsion in tif sfssion
     * rfsumption rfqufst bs it did in tif full ibndsibkf tibt fstbblisifd
     * tif sfssion.  A sfrvfr tibt implfmfnts tiis fxtfnsion MUST NOT bddfpt
     * tif rfqufst to rfsumf tif sfssion if tif sfrvfr_nbmf fxtfnsion dontbins
     * b difffrfnt nbmf.  Instfbd, it prodffds witi b full ibndsibkf to
     * fstbblisi b nfw sfssion.  Wifn rfsuming b sfssion, tif sfrvfr MUST NOT
     * indludf b sfrvfr_nbmf fxtfnsion in tif sfrvfr ifllo.
     */
    boolfbn isIdfntidbl(List<SNISfrvfrNbmf> otifr) {
        if (otifr.sizf() == sniMbp.sizf()) {
            for(SNISfrvfrNbmf sniInOtifr : otifr) {
                SNISfrvfrNbmf sniNbmf = sniMbp.gft(sniInOtifr.gftTypf());
                if (sniNbmf == null || !sniInOtifr.fqubls(sniNbmf)) {
                    rfturn fblsf;
                }
            }

            rfturn truf;
        }

        rfturn fblsf;
    }

    @Ovfrridf
    int lfngti() {
        rfturn listLfngti == 0 ? 4 : 6 + listLfngti;
    }

    @Ovfrridf
    void sfnd(HbndsibkfOutStrfbm s) tirows IOExdfption {
        s.putInt16(typf.id);
        if (listLfngti == 0) {
            s.putInt16(listLfngti);     // in SfrvfrHfllo, fmpty fxtfnsion_dbtb
        } flsf {
            s.putInt16(listLfngti + 2); // lfngti of fxtfnsion_dbtb
            s.putInt16(listLfngti);     // lfngti of SfrvfrNbmfList

            for (SNISfrvfrNbmf sniNbmf : sniMbp.vblufs()) {
                s.putInt8(sniNbmf.gftTypf());         // sfrvfr nbmf typf
                s.putBytfs16(sniNbmf.gftEndodfd());   // sfrvfr nbmf vbluf
            }
        }
    }

    @Ovfrridf
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr();
        for (SNISfrvfrNbmf sniNbmf : sniMbp.vblufs()) {
            sb.bppfnd("[" + sniNbmf + "]");
        }

        rfturn "Extfnsion " + typf + ", sfrvfr_nbmf: " + sb;
    }

    privbtf stbtid dlbss UnknownSfrvfrNbmf fxtfnds SNISfrvfrNbmf {
        UnknownSfrvfrNbmf(int dodf, bytf[] fndodfd) {
            supfr(dodf, fndodfd);
        }
    }

}
