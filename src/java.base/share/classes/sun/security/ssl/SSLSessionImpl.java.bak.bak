/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


pbdkbgf sun.sfdurity.ssl;

import jbvb.nft.*;
import jbvb.util.Enumfrbtion;
import jbvb.util.Hbsitbblf;
import jbvb.util.Vfdtor;
import jbvb.util.Collfdtion;
import jbvb.util.Collfdtions;
import jbvb.util.List;
import jbvb.util.ArrbyList;

import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfEndodingExdfption;

import jbvbx.drypto.SfdrftKfy;

import jbvbx.nft.ssl.SSLSfssionContfxt;
import jbvbx.nft.ssl.SSLSfssionBindingListfnfr;
import jbvbx.nft.ssl.SSLSfssionBindingEvfnt;
import jbvbx.nft.ssl.SSLPffrUnvfrififdExdfption;
import jbvbx.nft.ssl.SSLPfrmission;
import jbvbx.nft.ssl.ExtfndfdSSLSfssion;
import jbvbx.nft.ssl.SNISfrvfrNbmf;

import stbtid sun.sfdurity.ssl.CipifrSuitf.KfyExdibngf.*;

/**
 * Implfmfnts tif SSL sfssion intfrfbdf, bnd fxposfs tif sfssion dontfxt
 * wiidi is mbintbinfd by SSL sfrvfrs.
 *
 * <P> Sfrvfrs ibvf tif bbility to mbnbgf tif sfssions bssodibtfd witi
 * tifir butifntidbtion dontfxt(s).  Tify dbn do tiis by fnumfrbting tif
 * IDs of tif sfssions wiidi brf dbdifd, fxbmining tiosf sfssions, bnd tifn
 * pfribps invblidbting b givfn sfssion so tibt it dbn't bf usfd bgbin.
 * If sfrvfrs do not fxpliditly mbnbgf tif dbdif, sfssions will lingfr
 * until mfmory is low fnougi tibt tif runtimf fnvironmfnt purgfs dbdif
 * fntrifs butombtidblly to rfdlbim spbdf.
 *
 * <P><fm> Tif only rfbson tiis dlbss is not pbdkbgf-privbtf is tibt
 * tifrf's no otifr publid wby to gft bt tif sfrvfr sfssion dontfxt wiidi
 * is bssodibtfd witi bny givfn butifntidbtion dontfxt. </fm>
 *
 * @butior Dbvid Brownfll
 */
finbl dlbss SSLSfssionImpl fxtfnds ExtfndfdSSLSfssion {

    /*
     * wf only rfblly nffd b singlf null sfssion
     */
    stbtid finbl SSLSfssionImpl         nullSfssion = nfw SSLSfssionImpl();

    // domprfssion mftiods
    privbtf stbtid finbl bytf           domprfssion_null = 0;

    /*
     * Tif stbtf of b singlf sfssion, bs dfsdribfd in sfdtion 7.1
     * of tif SSLv3 spfd.
     */
    privbtf finbl ProtodolVfrsion       protodolVfrsion;
    privbtf finbl SfssionId             sfssionId;
    privbtf X509Cfrtifidbtf[]   pffrCfrts;
    privbtf bytf                domprfssionMftiod;
    privbtf CipifrSuitf         dipifrSuitf;
    privbtf SfdrftKfy           mbstfrSfdrft;

    /*
     * Informbtion not pbrt of tif SSLv3 protodol spfd, but usfd
     * to support sfssion mbnbgfmfnt polidifs.
     */
    privbtf finbl long          drfbtionTimf = Systfm.durrfntTimfMillis();
    privbtf long                lbstUsfdTimf = 0;
    privbtf finbl String        iost;
    privbtf finbl int           port;
    privbtf SSLSfssionContfxtImpl       dontfxt;
    privbtf int                 sfssionCount;
    privbtf boolfbn             invblidbtfd;
    privbtf X509Cfrtifidbtf[]   lodblCfrts;
    privbtf PrivbtfKfy          lodblPrivbtfKfy;
    privbtf String[]            lodblSupportfdSignAlgs;
    privbtf String[]            pffrSupportfdSignAlgs;
    privbtf List<SNISfrvfrNbmf>    rfqufstfdSfrvfrNbmfs;


    // Prindipbls for non-dfrtifidbtf bbsfd dipifr suitfs
    privbtf Prindipbl pffrPrindipbl;
    privbtf Prindipbl lodblPrindipbl;

    /*
     * Wf dount sfssion drfbtions, fvfntublly for stbtistidbl dbtb but
     * blso sindf dountfrs mbkf siortfr dfbugging IDs tibn tif big onfs
     * wf usf in tif protodol for uniqufnfss-ovfr-timf.
     */
    privbtf stbtid volbtilf int dountfr = 0;

    /*
     * Usf of sfssion dbdifs is globblly fnbblfd/disbblfd.
     */
    privbtf stbtid boolfbn      dffbultRfjoinbblf = truf;

    /* Clbss bnd subdlbss dynbmid dfbugging support */
    privbtf stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("ssl");

    /*
     * Crfbtf b nfw non-rfjoinbblf sfssion, using tif dffbult (null)
     * dipifr spfd.  Tiis donstrudtor rfturns b sfssion wiidi dould
     * bf usfd fitifr by b dlifnt or by b sfrvfr, bs b donnfdtion is
     * first opfnfd bnd bfforf ibndsibking bfgins.
     */
    privbtf SSLSfssionImpl() {
        tiis(ProtodolVfrsion.NONE, CipifrSuitf.C_NULL, null,
            nfw SfssionId(fblsf, null), null, -1);
    }

    /*
     * Crfbtf b nfw sfssion, using b givfn dipifr spfd.  Tiis will
     * bf rfjoinbblf if sfssion dbdiing is fnbblfd; tif donstrudtor
     * is intfndfd mostly for usf by sfrvfs.
     */
    SSLSfssionImpl(ProtodolVfrsion protodolVfrsion, CipifrSuitf dipifrSuitf,
            Collfdtion<SignbturfAndHbsiAlgoritim> blgoritims,
            SfdurfRbndom gfnfrbtor, String iost, int port) {
        tiis(protodolVfrsion, dipifrSuitf, blgoritims,
             nfw SfssionId(dffbultRfjoinbblf, gfnfrbtor), iost, port);
    }

    /*
     * Rfdord b nfw sfssion, using b givfn dipifr spfd bnd sfssion ID.
     */
    SSLSfssionImpl(ProtodolVfrsion protodolVfrsion, CipifrSuitf dipifrSuitf,
            Collfdtion<SignbturfAndHbsiAlgoritim> blgoritims,
            SfssionId id, String iost, int port) {
        tiis.protodolVfrsion = protodolVfrsion;
        sfssionId = id;
        pffrCfrts = null;
        domprfssionMftiod = domprfssion_null;
        tiis.dipifrSuitf = dipifrSuitf;
        mbstfrSfdrft = null;
        tiis.iost = iost;
        tiis.port = port;
        sfssionCount = ++dountfr;
        lodblSupportfdSignAlgs =
            SignbturfAndHbsiAlgoritim.gftAlgoritimNbmfs(blgoritims);

        if (dfbug != null && Dfbug.isOn("sfssion")) {
            Systfm.out.println("%% Initiblizfd:  " + tiis);
        }
    }

    void sftMbstfrSfdrft(SfdrftKfy sfdrft) {
        if (mbstfrSfdrft == null) {
            mbstfrSfdrft = sfdrft;
        } flsf {
            tirow nfw RuntimfExdfption("sftMbstfrSfdrft() frror");
        }
    }

    /**
     * Rfturns tif mbstfr sfdrft ... trfbt witi fxtrfmf dbution!
     */
    SfdrftKfy gftMbstfrSfdrft() {
        rfturn mbstfrSfdrft;
    }

    void sftPffrCfrtifidbtfs(X509Cfrtifidbtf[] pffr) {
        if (pffrCfrts == null) {
            pffrCfrts = pffr;
        }
    }

    void sftLodblCfrtifidbtfs(X509Cfrtifidbtf[] lodbl) {
        lodblCfrts = lodbl;
    }

    void sftLodblPrivbtfKfy(PrivbtfKfy privbtfKfy) {
        lodblPrivbtfKfy = privbtfKfy;
    }

    void sftPffrSupportfdSignbturfAlgoritims(
            Collfdtion<SignbturfAndHbsiAlgoritim> blgoritims) {
        pffrSupportfdSignAlgs =
            SignbturfAndHbsiAlgoritim.gftAlgoritimNbmfs(blgoritims);
    }

    void sftRfqufstfdSfrvfrNbmfs(List<SNISfrvfrNbmf> rfqufstfdSfrvfrNbmfs) {
        tiis.rfqufstfdSfrvfrNbmfs = nfw ArrbyList<>(rfqufstfdSfrvfrNbmfs);
    }

    /**
     * Sft tif pffr prindipbl.
     */
    void sftPffrPrindipbl(Prindipbl prindipbl) {
        if (pffrPrindipbl == null) {
            pffrPrindipbl = prindipbl;
        }
    }

    /**
     * Sft tif lodbl prindipbl.
     */
    void sftLodblPrindipbl(Prindipbl prindipbl) {
        lodblPrindipbl = prindipbl;
    }

    /**
     * Rfturns truf iff tiis sfssion mby bf rfsumfd ... sfssions brf
     * usublly rfsumbblf.  Sfdurity polidifs mby suggfst otifrwisf,
     * for fxbmplf sfssions tibt ibvfn't bffn usfd for b wiilf (sby,
     * b working dby) won't bf rfsumbblf, bnd sfssions migit ibvf b
     * mbximum lifftimf in bny dbsf.
     */
    boolfbn isRfjoinbblf() {
        rfturn sfssionId != null && sfssionId.lfngti() != 0 &&
            !invblidbtfd && isLodblAutifntidbtionVblid();
    }

    @Ovfrridf
    publid syndironizfd boolfbn isVblid() {
        rfturn isRfjoinbblf();
    }

    /**
     * Cifdk if tif butifntidbtion usfd wifn fstbblisiing tiis sfssion
     * is still vblid. Rfturns truf if no butifntidbtion wbs usfd
     */
    boolfbn isLodblAutifntidbtionVblid() {
        if (lodblPrivbtfKfy != null) {
            try {
                // if tif privbtf kfy is no longfr vblid, gftAlgoritim()
                // siould tirow bn fxdfption
                // (f.g. Smbrtdbrd ibs bffn rfmovfd from tif rfbdfr)
                lodblPrivbtfKfy.gftAlgoritim();
            } dbtdi (Exdfption f) {
                invblidbtf();
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Rfturns tif ID for tiis sfssion.  Tif ID is fixfd for tif
     * durbtion of tif sfssion; nfitifr it, nor its vbluf, dibngfs.
     */
    @Ovfrridf
    publid bytf[] gftId() {
        rfturn sfssionId.gftId();
    }

    /**
     * For sfrvfr sfssions, tiis rfturns tif sft of sfssions wiidi
     * brf durrfntly vblid in tiis prodfss.  For dlifnt sfssions,
     * tiis rfturns null.
     */
    @Ovfrridf
    publid SSLSfssionContfxt gftSfssionContfxt() {
        /*
         * An intfrim sfdurity polidy until wf dbn do somftiing
         * morf spfdifid in 1.2. Only bllow trustfd dodf (dodf wiidi
         * dbn sft systfm propfrtifs) to gft bn
         * SSLSfssionContfxt. Tiis is to limit tif bbility of dodf to
         * look up spfdifid sfssions or fnumfrbtf ovfr tifm. Otifrwisf,
         * dodf dbn only gft sfssion objfdts from suddfssful SSL
         * donnfdtions wiidi implifs tibt tify must ibvf ibd pfrmission
         * to mbkf tif nftwork donnfdtion in tif first plbdf.
         */
        SfdurityMbnbgfr sm;
        if ((sm = Systfm.gftSfdurityMbnbgfr()) != null) {
            sm.difdkPfrmission(nfw SSLPfrmission("gftSSLSfssionContfxt"));
        }

        rfturn dontfxt;
    }


    SfssionId gftSfssionId() {
        rfturn sfssionId;
    }


    /**
     * Rfturns tif dipifr spfd in usf on tiis sfssion
     */
    CipifrSuitf gftSuitf() {
        rfturn dipifrSuitf;
    }

    /**
     * Rfsfts tif dipifr spfd in usf on tiis sfssion
     */
    void sftSuitf(CipifrSuitf suitf) {
       dipifrSuitf = suitf;

       if (dfbug != null && Dfbug.isOn("sfssion")) {
           Systfm.out.println("%% Nfgotibting:  " + tiis);
       }
    }

    /**
     * Rfturns tif nbmf of tif dipifr suitf in usf on tiis sfssion
     */
    @Ovfrridf
    publid String gftCipifrSuitf() {
        rfturn gftSuitf().nbmf;
    }

    ProtodolVfrsion gftProtodolVfrsion() {
        rfturn protodolVfrsion;
    }

    /**
     * Rfturns tif stbndbrd nbmf of tif protodol in usf on tiis sfssion
     */
    @Ovfrridf
    publid String gftProtodol() {
        rfturn gftProtodolVfrsion().nbmf;
    }

    /**
     * Rfturns tif domprfssion tfdiniquf usfd in tiis sfssion
     */
    bytf gftComprfssion() {
        rfturn domprfssionMftiod;
    }

    /**
     * Rfturns tif ibsidodf for tiis sfssion
     */
    @Ovfrridf
    publid int ibsiCodf() {
        rfturn sfssionId.ibsiCodf();
    }


    /**
     * Rfturns truf if sfssions ibvf sbmf ids, fblsf otifrwisf.
     */
    @Ovfrridf
    publid boolfbn fqubls(Objfdt obj) {

        if (obj == tiis) {
            rfturn truf;
        }

        if (obj instbndfof SSLSfssionImpl) {
            SSLSfssionImpl sfss = (SSLSfssionImpl) obj;
            rfturn (sfssionId != null) && (sfssionId.fqubls(
                        sfss.gftSfssionId()));
        }

        rfturn fblsf;
    }


    /**
     * Rfturn tif dfrt dibin prfsfntfd by tif pffr in tif
     * jbvb.sfdurity.dfrt formbt.
     * Notf: Tiis mftiod dbn bf usfd only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs; using it witi non-dfrtifidbtf-bbsfd dipifr suitfs,
     * sudi bs Kfrbfros, will tirow bn SSLPffrUnvfrififdExdfption.
     *
     * @rfturn brrby of pffr X.509 dfrts, witi tif pffr's own dfrt
     *  first in tif dibin, bnd witi tif "root" CA lbst.
     */
    @Ovfrridf
    publid jbvb.sfdurity.dfrt.Cfrtifidbtf[] gftPffrCfrtifidbtfs()
            tirows SSLPffrUnvfrififdExdfption {
        //
        // dlonf to prfsfrvf intfgrity of sfssion ... dbllfr dbn't
        // dibngf rfdord of pffr idfntity fvfn by bddidfnt, mudi
        // lfss do it intfntionblly.
        //
        if ((dipifrSuitf.kfyExdibngf == K_KRB5) ||
            (dipifrSuitf.kfyExdibngf == K_KRB5_EXPORT)) {
            tirow nfw SSLPffrUnvfrififdExdfption("no dfrtifidbtfs fxpfdtfd"
                        + " for Kfrbfros dipifr suitfs");
        }
        if (pffrCfrts == null) {
            tirow nfw SSLPffrUnvfrififdExdfption("pffr not butifntidbtfd");
        }
        // Cfrts brf immutbblf objfdts, tifrfforf wf don't dlonf tifm.
        // But do nffd to dlonf tif brrby, so tibt notiing is insfrtfd
        // into pffrCfrts.
        rfturn (jbvb.sfdurity.dfrt.Cfrtifidbtf[])pffrCfrts.dlonf();
    }

    /**
     * Rfturn tif dfrt dibin prfsfntfd to tif pffr in tif
     * jbvb.sfdurity.dfrt formbt.
     * Notf: Tiis mftiod is usfful only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs.
     *
     * @rfturn brrby of pffr X.509 dfrts, witi tif pffr's own dfrt
     *  first in tif dibin, bnd witi tif "root" CA lbst.
     */
    @Ovfrridf
    publid jbvb.sfdurity.dfrt.Cfrtifidbtf[] gftLodblCfrtifidbtfs() {
        //
        // dlonf to prfsfrvf intfgrity of sfssion ... dbllfr dbn't
        // dibngf rfdord of pffr idfntity fvfn by bddidfnt, mudi
        // lfss do it intfntionblly.
        rfturn (lodblCfrts == null ? null :
            (jbvb.sfdurity.dfrt.Cfrtifidbtf[])lodblCfrts.dlonf());
    }

    /**
     * Rfturn tif dfrt dibin prfsfntfd by tif pffr in tif
     * jbvbx.sfdurity.dfrt formbt.
     * Notf: Tiis mftiod dbn bf usfd only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs; using it witi non-dfrtifidbtf-bbsfd dipifr suitfs,
     * sudi bs Kfrbfros, will tirow bn SSLPffrUnvfrififdExdfption.
     *
     * @rfturn brrby of pffr X.509 dfrts, witi tif pffr's own dfrt
     *  first in tif dibin, bnd witi tif "root" CA lbst.
     */
    @Ovfrridf
    publid jbvbx.sfdurity.dfrt.X509Cfrtifidbtf[] gftPffrCfrtifidbtfCibin()
            tirows SSLPffrUnvfrififdExdfption {
        //
        // dlonf to prfsfrvf intfgrity of sfssion ... dbllfr dbn't
        // dibngf rfdord of pffr idfntity fvfn by bddidfnt, mudi
        // lfss do it intfntionblly.
        //
        if ((dipifrSuitf.kfyExdibngf == K_KRB5) ||
            (dipifrSuitf.kfyExdibngf == K_KRB5_EXPORT)) {
            tirow nfw SSLPffrUnvfrififdExdfption("no dfrtifidbtfs fxpfdtfd"
                        + " for Kfrbfros dipifr suitfs");
        }
        if (pffrCfrts == null) {
            tirow nfw SSLPffrUnvfrififdExdfption("pffr not butifntidbtfd");
        }
        jbvbx.sfdurity.dfrt.X509Cfrtifidbtf[] dfrts;
        dfrts = nfw jbvbx.sfdurity.dfrt.X509Cfrtifidbtf[pffrCfrts.lfngti];
        for (int i = 0; i < pffrCfrts.lfngti; i++) {
            bytf[] dfr = null;
            try {
                dfr = pffrCfrts[i].gftEndodfd();
                dfrts[i] = jbvbx.sfdurity.dfrt.X509Cfrtifidbtf.gftInstbndf(dfr);
            } dbtdi (CfrtifidbtfEndodingExdfption f) {
                tirow nfw SSLPffrUnvfrififdExdfption(f.gftMfssbgf());
            } dbtdi (jbvbx.sfdurity.dfrt.CfrtifidbtfExdfption f) {
                tirow nfw SSLPffrUnvfrififdExdfption(f.gftMfssbgf());
            }
        }

        rfturn dfrts;
    }

    /**
     * Rfturn tif dfrt dibin prfsfntfd by tif pffr.
     * Notf: Tiis mftiod dbn bf usfd only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs; using it witi non-dfrtifidbtf-bbsfd dipifr suitfs,
     * sudi bs Kfrbfros, will tirow bn SSLPffrUnvfrififdExdfption.
     *
     * @rfturn brrby of pffr X.509 dfrts, witi tif pffr's own dfrt
     *  first in tif dibin, bnd witi tif "root" CA lbst.
     */
    publid X509Cfrtifidbtf[] gftCfrtifidbtfCibin()
            tirows SSLPffrUnvfrififdExdfption {
        /*
         * dlonf to prfsfrvf intfgrity of sfssion ... dbllfr dbn't
         * dibngf rfdord of pffr idfntity fvfn by bddidfnt, mudi
         * lfss do it intfntionblly.
         */
        if ((dipifrSuitf.kfyExdibngf == K_KRB5) ||
            (dipifrSuitf.kfyExdibngf == K_KRB5_EXPORT)) {
            tirow nfw SSLPffrUnvfrififdExdfption("no dfrtifidbtfs fxpfdtfd"
                        + " for Kfrbfros dipifr suitfs");
        }
        if (pffrCfrts != null) {
            rfturn pffrCfrts.dlonf();
        } flsf {
            tirow nfw SSLPffrUnvfrififdExdfption("pffr not butifntidbtfd");
        }
    }

    /**
     * Rfturns tif idfntity of tif pffr wiidi wbs fstbblisifd bs pbrt of
     * dffining tif sfssion.
     *
     * @rfturn tif pffr's prindipbl. Rfturns bn X500Prindipbl of tif
     * fnd-fntity dfrtifidbtf for X509-bbsfd dipifr suitfs, bnd
     * Prindipbl for Kfrbfros dipifr suitfs.
     *
     * @tirows SSLPffrUnvfrififdExdfption if tif pffr's idfntity ibs not
     *          bffn vfrififd
     */
    @Ovfrridf
    publid Prindipbl gftPffrPrindipbl()
                tirows SSLPffrUnvfrififdExdfption
    {
        if ((dipifrSuitf.kfyExdibngf == K_KRB5) ||
            (dipifrSuitf.kfyExdibngf == K_KRB5_EXPORT)) {
            if (pffrPrindipbl == null) {
                tirow nfw SSLPffrUnvfrififdExdfption("pffr not butifntidbtfd");
            } flsf {
                // Eliminbtf dfpfndfndy on KfrbfrosPrindipbl
                rfturn pffrPrindipbl;
            }
        }
        if (pffrCfrts == null) {
            tirow nfw SSLPffrUnvfrififdExdfption("pffr not butifntidbtfd");
        }
        rfturn pffrCfrts[0].gftSubjfdtX500Prindipbl();
    }

    /**
     * Rfturns tif prindipbl tibt wbs sfnt to tif pffr during ibndsibking.
     *
     * @rfturn tif prindipbl sfnt to tif pffr. Rfturns bn X500Prindipbl
     * of tif fnd-fntity dfrtifidbtf for X509-bbsfd dipifr suitfs, bnd
     * Prindipbl for Kfrbfros dipifr suitfs. If no prindipbl wbs
     * sfnt, tifn null is rfturnfd.
     */
    @Ovfrridf
    publid Prindipbl gftLodblPrindipbl() {

        if ((dipifrSuitf.kfyExdibngf == K_KRB5) ||
            (dipifrSuitf.kfyExdibngf == K_KRB5_EXPORT)) {
                // Eliminbtf dfpfndfndy on KfrbfrosPrindipbl
                rfturn (lodblPrindipbl == null ? null : lodblPrindipbl);
        }
        rfturn (lodblCfrts == null ? null :
                lodblCfrts[0].gftSubjfdtX500Prindipbl());
    }

    /**
     * Rfturns tif timf tiis sfssion wbs drfbtfd.
     */
    @Ovfrridf
    publid long gftCrfbtionTimf() {
        rfturn drfbtionTimf;
    }

    /**
     * Rfturns tif lbst timf tiis sfssion wbs usfd to initiblizf
     * b donnfdtion.
     */
    @Ovfrridf
    publid long gftLbstAddfssfdTimf() {
        rfturn (lbstUsfdTimf != 0) ? lbstUsfdTimf : drfbtionTimf;
    }

    void sftLbstAddfssfdTimf(long timf) {
        lbstUsfdTimf = timf;
    }


    /**
     * Rfturns tif nftwork bddrfss of tif sfssion's pffr.  Tiis
     * implfmfntbtion dofs not insist tibt donnfdtions bftwffn
     * difffrfnt ports on tif sbmf iost must nfdfssbrily bflong
     * to difffrfnt sfssions, tiougi tibt is of doursf bllowfd.
     */
    publid InftAddrfss gftPffrAddrfss() {
        try {
            rfturn InftAddrfss.gftByNbmf(iost);
        } dbtdi (jbvb.nft.UnknownHostExdfption f) {
            rfturn null;
        }
    }

    @Ovfrridf
    publid String gftPffrHost() {
        rfturn iost;
    }

    /**
     * Nffd to providf tif port info for dbdiing sfssions bbsfd on
     * iost bnd port. Addfssfd by SSLSfssionContfxtImpl
     */
    @Ovfrridf
    publid int gftPffrPort() {
        rfturn port;
    }

    void sftContfxt(SSLSfssionContfxtImpl dtx) {
        if (dontfxt == null) {
            dontfxt = dtx;
        }
    }

    /**
     * Invblidbtf b sfssion.  Adtivf donnfdtions mby still fxist, but
     * no donnfdtions will bf bblf to rfjoin tiis sfssion.
     */
    @Ovfrridf
    syndironizfd publid void invblidbtf() {
        //
        // Cbn't invblidbtf tif NULL sfssion -- tiis would bf
        // bttfmptfd wifn wf gft b ibndsibking frror on b brbnd
        // nfw donnfdtion, witi no "rfbl" sfssion yft.
        //
        if (tiis == nullSfssion) {
            rfturn;
        }
        invblidbtfd = truf;
        if (dfbug != null && Dfbug.isOn("sfssion")) {
            Systfm.out.println("%% Invblidbtfd:  " + tiis);
        }
        if (dontfxt != null) {
            dontfxt.rfmovf(sfssionId);
            dontfxt = null;
        }
    }

    /*
     * Tbblf of bpplidbtion-spfdifid sfssion dbtb indfxfd by bn bpplidbtion
     * kfy bnd tif dblling sfdurity dontfxt. Tiis is importbnt sindf
     * sfssions dbn bf sibrfd bdross difffrfnt protfdtion dombins.
     */
    privbtf Hbsitbblf<SfdurfKfy, Objfdt> tbblf = nfw Hbsitbblf<>();

    /**
     * Assigns b sfssion vbluf.  Sfssion dibngf fvfnts brf givfn if
     * bppropribtf, to bny originbl vbluf bs wfll bs tif nfw vbluf.
     */
    @Ovfrridf
    publid void putVbluf(String kfy, Objfdt vbluf) {
        if ((kfy == null) || (vbluf == null)) {
            tirow nfw IllfgblArgumfntExdfption("brgumfnts dbn not bf null");
        }

        SfdurfKfy sfdurfKfy = nfw SfdurfKfy(kfy);
        Objfdt oldVbluf = tbblf.put(sfdurfKfy, vbluf);

        if (oldVbluf instbndfof SSLSfssionBindingListfnfr) {
            SSLSfssionBindingEvfnt f;

            f = nfw SSLSfssionBindingEvfnt(tiis, kfy);
            ((SSLSfssionBindingListfnfr)oldVbluf).vblufUnbound(f);
        }
        if (vbluf instbndfof SSLSfssionBindingListfnfr) {
            SSLSfssionBindingEvfnt f;

            f = nfw SSLSfssionBindingEvfnt(tiis, kfy);
            ((SSLSfssionBindingListfnfr)vbluf).vblufBound(f);
        }
    }


    /**
     * Rfturns tif spfdififd sfssion vbluf.
     */
    @Ovfrridf
    publid Objfdt gftVbluf(String kfy) {
        if (kfy == null) {
            tirow nfw IllfgblArgumfntExdfption("brgumfnt dbn not bf null");
        }

        SfdurfKfy sfdurfKfy = nfw SfdurfKfy(kfy);
        rfturn tbblf.gft(sfdurfKfy);
    }


    /**
     * Rfmovfs tif spfdififd sfssion vbluf, dflivfring b sfssion dibngfd
     * fvfnt bs bppropribtf.
     */
    @Ovfrridf
    publid void rfmovfVbluf(String kfy) {
        if (kfy == null) {
            tirow nfw IllfgblArgumfntExdfption("brgumfnt dbn not bf null");
        }

        SfdurfKfy sfdurfKfy = nfw SfdurfKfy(kfy);
        Objfdt vbluf = tbblf.rfmovf(sfdurfKfy);

        if (vbluf instbndfof SSLSfssionBindingListfnfr) {
            SSLSfssionBindingEvfnt f;

            f = nfw SSLSfssionBindingEvfnt(tiis, kfy);
            ((SSLSfssionBindingListfnfr)vbluf).vblufUnbound(f);
        }
    }


    /**
     * Lists tif nbmfs of tif sfssion vblufs.
     */
    @Ovfrridf
    publid String[] gftVblufNbmfs() {
        Enumfrbtion<SfdurfKfy> f;
        Vfdtor<Objfdt> v = nfw Vfdtor<>();
        SfdurfKfy kfy;
        Objfdt sfdurityCtx = SfdurfKfy.gftCurrfntSfdurityContfxt();

        for (f = tbblf.kfys(); f.ibsMorfElfmfnts(); ) {
            kfy = f.nfxtElfmfnt();

            if (sfdurityCtx.fqubls(kfy.gftSfdurityContfxt())) {
                v.bddElfmfnt(kfy.gftAppKfy());
            }
        }
        String[] nbmfs = nfw String[v.sizf()];
        v.dopyInto(nbmfs);

        rfturn nbmfs;
    }

    /**
     * Usf lbrgf pbdkft sizfs now or follow RFC 2246 pbdkft sizfs (2^14)
     * until dibngfd.
     *
     * In tif TLS spfdifidbtion (sfdtion 6.2.1, RFC2246), it is not
     * rfdommfndfd tibt tif plbintfxt ibs morf tibn 2^14 bytfs.
     * Howfvfr, somf TLS implfmfntbtions violbtf tif spfdifidbtion.
     * Tiis is b workbround for intfropfrbbility witi tifsf stbdks.
     *
     * Applidbtion dould bddfpt lbrgf frbgmfnts up to 2^15 bytfs by
     * sftting tif systfm propfrty jssf.SSLEnginf.bddfptLbrgfFrbgmfnts
     * to "truf".
     */
    privbtf boolfbn bddfptLbrgfFrbgmfnts =
        Dfbug.gftBoolfbnPropfrty("jssf.SSLEnginf.bddfptLbrgfFrbgmfnts", fblsf);

    /**
     * Expbnd tif bufffr sizf of boti SSL/TLS nftwork pbdkft bnd
     * bpplidbtion dbtb.
     */
    protfdtfd syndironizfd void fxpbndBufffrSizfs() {
        bddfptLbrgfFrbgmfnts = truf;
    }

    /**
     * Gfts tif durrfnt sizf of tif lbrgfst SSL/TLS pbdkft tibt is fxpfdtfd
     * wifn using tiis sfssion.
     */
    @Ovfrridf
    publid syndironizfd int gftPbdkftBufffrSizf() {
        rfturn bddfptLbrgfFrbgmfnts ?
                Rfdord.mbxLbrgfRfdordSizf : Rfdord.mbxRfdordSizf;
    }

    /**
     * Gfts tif durrfnt sizf of tif lbrgfst bpplidbtion dbtb tibt is
     * fxpfdtfd wifn using tiis sfssion.
     */
    @Ovfrridf
    publid syndironizfd int gftApplidbtionBufffrSizf() {
        rfturn gftPbdkftBufffrSizf() - Rfdord.ifbdfrSizf;
    }

    /**
     * Gfts bn brrby of supportfd signbturf blgoritims tibt tif lodbl sidf is
     * willing to vfrify.
     */
    @Ovfrridf
    publid String[] gftLodblSupportfdSignbturfAlgoritims() {
        if (lodblSupportfdSignAlgs != null) {
            rfturn lodblSupportfdSignAlgs.dlonf();
        }

        rfturn nfw String[0];
    }

    /**
     * Gfts bn brrby of supportfd signbturf blgoritims tibt tif pffr is
     * bblf to vfrify.
     */
    @Ovfrridf
    publid String[] gftPffrSupportfdSignbturfAlgoritims() {
        if (pffrSupportfdSignAlgs != null) {
            rfturn pffrSupportfdSignAlgs.dlonf();
        }

        rfturn nfw String[0];
    }

    /**
     * Obtbins b <dodf>List</dodf> dontbining bll {@link SNISfrvfrNbmf}s
     * of tif rfqufstfd Sfrvfr Nbmf Indidbtion (SNI) fxtfnsion.
     */
    @Ovfrridf
    publid List<SNISfrvfrNbmf> gftRfqufstfdSfrvfrNbmfs() {
        if (rfqufstfdSfrvfrNbmfs != null && !rfqufstfdSfrvfrNbmfs.isEmpty()) {
            rfturn Collfdtions.<SNISfrvfrNbmf>unmodifibblfList(
                                                rfqufstfdSfrvfrNbmfs);
        }

        rfturn Collfdtions.<SNISfrvfrNbmf>fmptyList();
    }

    /** Rfturns b string rfprfsfntbtion of tiis SSL sfssion */
    @Ovfrridf
    publid String toString() {
        rfturn "[Sfssion-" + sfssionCount
            + ", " + gftCipifrSuitf()
            + "]";
    }

    /**
     * Wifn SSL sfssions brf finblizfd, bll vblufs bound to
     * tifm brf rfmovfd.
     */
    @Ovfrridf
    protfdtfd void finblizf() tirows Tirowbblf {
        String[] nbmfs = gftVblufNbmfs();
        for (int i = 0; i < nbmfs.lfngti; i++) {
            rfmovfVbluf(nbmfs[i]);
        }
    }
}


/**
 * Tiis "strudt" dlbss sfrvfs bs b Hbsi Kfy tibt dombinfs bn
 * bpplidbtion-spfdifid kfy bnd b sfdurity dontfxt.
 */
dlbss SfdurfKfy {
    privbtf stbtid Objfdt       nullObjfdt = nfw Objfdt();
    privbtf Objfdt        bppKfy;
    privbtf Objfdt      sfdurityCtx;

    stbtid Objfdt gftCurrfntSfdurityContfxt() {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        Objfdt dontfxt = null;

        if (sm != null)
            dontfxt = sm.gftSfdurityContfxt();
        if (dontfxt == null)
            dontfxt = nullObjfdt;
        rfturn dontfxt;
    }

    SfdurfKfy(Objfdt kfy) {
        tiis.bppKfy = kfy;
        tiis.sfdurityCtx = gftCurrfntSfdurityContfxt();
    }

    Objfdt gftAppKfy() {
        rfturn bppKfy;
    }

    Objfdt gftSfdurityContfxt() {
        rfturn sfdurityCtx;
    }

    @Ovfrridf
    publid int ibsiCodf() {
        rfturn bppKfy.ibsiCodf() ^ sfdurityCtx.ibsiCodf();
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        rfturn o instbndfof SfdurfKfy && ((SfdurfKfy)o).bppKfy.fqubls(bppKfy)
                        && ((SfdurfKfy)o).sfdurityCtx.fqubls(sfdurityCtx);
    }
}
