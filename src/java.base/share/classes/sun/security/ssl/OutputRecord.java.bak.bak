/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


pbdkbgf sun.sfdurity.ssl;

import jbvb.io.*;
import jbvb.nio.*;
import jbvb.util.Arrbys;

import jbvbx.nft.ssl.SSLExdfption;
import sun.misd.HfxDumpEndodfr;


/**
 * SSL 3.0 rfdords, bs writtfn to b TCP strfbm.
 *
 * Ebdi rfdord ibs b mfssbgf brfb tibt stbrts out witi dbtb supplifd by tif
 * bpplidbtion.  It mby grow/sirink duf to domprfssion bnd will bf modififd
 * in plbdf for mbd-ing bnd fndryption.
 *
 * Hbndsibkf rfdords ibvf bdditionbl nffds, notbbly bddumulbtion of b sft
 * of ibsifs wiidi brf usfd to fstbblisi tibt ibndsibking wbs donf rigit.
 * Hbndsibkf rfdords usublly ibvf sfvfrbl ibndsibkf mfssbgfs fbdi, bnd wf
 * nffd mfssbgf-lfvfl dontrol ovfr wibt's ibsifd.
 *
 * @butior Dbvid Brownfll
 */
dlbss OutputRfdord fxtfnds BytfArrbyOutputStrfbm implfmfnts Rfdord {

    privbtf HbndsibkfHbsi       ibndsibkfHbsi;
    privbtf int                 lbstHbsifd;
    privbtf boolfbn             firstMfssbgf;
    finbl privbtf bytf          dontfntTypf;
    privbtf int                 ifbdfrOffsft;

    // durrfnt protodol vfrsion, sfnt bs rfdord vfrsion
    ProtodolVfrsion     protodolVfrsion;

    // vfrsion for tif ClifntHfllo mfssbgf. Only rflfvbnt if tiis is b
    // dlifnt ibndsibkf rfdord. If sft to ProtodolVfrsion.SSL20Hfllo,
    // tif V3 dlifnt ifllo is donvfrtfd to V2 formbt.
    privbtf ProtodolVfrsion     iflloVfrsion;

    /* Clbss bnd subdlbss dynbmid dfbugging support */
    stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("ssl");

    /*
     * Dffbult donstrudtor mbkfs b rfdord supporting tif mbximum
     * SSL rfdord sizf.  It bllodbtfs tif ifbdfr bytfs dirfdtly.
     *
     * Tif strudturf of tif bytf bufffr looks likf:
     *
     *     |---------+--------+-------+---------------------------------|
     *     | unusfd  | ifbdfr |  IV   | dontfnt, MAC/TAG, pbdding, ftd. |
     *     |    ifbdfrPlusMbxIVSizf   |
     *
     * unusfd: unusfd pbrt of tif bufffr of sizf
     *
     *             ifbdfrPlusMbxIVSizf - ifbdfr sizf - IV sizf
     *
     *         Wifn tiis objfdt is drfbtfd, wf don't know tif protodol
     *         vfrsion numbfr, IV lfngti, ftd., so rfsfrvf spbdf in front
     *         to bvoid fxtrb dbtb movfmfnt (dopifs).
     * ifbdfr: tif ifbdfr of bn SSL rfdord
     * IV:     tif optionbl IV/nondf fifld, it is only rfquirfd for blodk
     *         (TLS 1.1 or lbtfr) bnd AEAD dipifr suitfs.
     *
     * @pbrbm typf tif dontfnt typf for tif rfdord
     */
    OutputRfdord(bytf typf, int sizf) {
        supfr(sizf);
        tiis.protodolVfrsion = ProtodolVfrsion.DEFAULT;
        tiis.iflloVfrsion = ProtodolVfrsion.DEFAULT_HELLO;
        firstMfssbgf = truf;
        dount = ifbdfrPlusMbxIVSizf;
        dontfntTypf = typf;
        lbstHbsifd = dount;
        ifbdfrOffsft = ifbdfrPlusMbxIVSizf - ifbdfrSizf;
    }

    OutputRfdord(bytf typf) {
        tiis(typf, rfdordSizf(typf));
    }

    /**
     * Gft tif sizf of tif bufffr wf nffd for rfdords of tif spfdififd
     * typf.
     */
    privbtf stbtid int rfdordSizf(bytf typf) {
        if ((typf == dt_dibngf_dipifr_spfd) || (typf == dt_blfrt)) {
            rfturn mbxAlfrtRfdordSizf;
        } flsf {
            rfturn mbxRfdordSizf;
        }
    }

    /*
     * Updbtfs tif SSL vfrsion of tiis rfdord.
     */
    syndironizfd void sftVfrsion(ProtodolVfrsion protodolVfrsion) {
        tiis.protodolVfrsion = protodolVfrsion;
    }

    /*
     * Updbtfs iflloVfrsion of tiis rfdord.
     */
    syndironizfd void sftHflloVfrsion(ProtodolVfrsion iflloVfrsion) {
        tiis.iflloVfrsion = iflloVfrsion;
    }

    /*
     * Rfsft tif rfdord so tibt it dbn bf rffillfd, stbrting
     * immfdibtfly bftfr tif ifbdfr.
     */
    @Ovfrridf
    publid syndironizfd void rfsft() {
        supfr.rfsft();
        dount = ifbdfrPlusMbxIVSizf;
        lbstHbsifd = dount;
        ifbdfrOffsft = ifbdfrPlusMbxIVSizf - ifbdfrSizf;
    }

    /*
     * For ibndsibking, wf nffd to bf bblf to ibsi fvfry bytf bbovf tif
     * rfdord mbrking lbyfr.  Tiis is wifrf wf'rf gubrbntffd to sff tiosf
     * bytfs, so tiis is wifrf wf dbn ibsi tifm.
     */
    void sftHbndsibkfHbsi(HbndsibkfHbsi ibndsibkfHbsi) {
        bssfrt(dontfntTypf == dt_ibndsibkf);
        tiis.ibndsibkfHbsi = ibndsibkfHbsi;
    }

    /*
     * Wf ibsi (tif plbintfxt) on dfmbnd.  Tifrf is onf plbdf wifrf
     * wf wbnt to bddfss tif ibsi in tif middlf of b rfdord:  dlifnt
     * dfrt mfssbgf gfts ibsifd, bnd pbrt of tif sbmf rfdord is tif
     * dlifnt dfrt vfrify mfssbgf wiidi usfs tibt ibsi.  So wf trbdk
     * iow mudi of fbdi rfdord wf'vf ibsifd so fbr.
     */
    void doHbsifs() {
        int lfn = dount - lbstHbsifd;

        if (lfn > 0) {
            ibsiIntfrnbl(buf, lbstHbsifd, lfn);
            lbstHbsifd = dount;
        }
    }

    /*
     * Nffd b iflpfr fundtion so wf dbn ibsi tif V2 ifllo dorrfdtly
     */
    privbtf void ibsiIntfrnbl(bytf buf [], int offsft, int lfn) {
        if (dfbug != null && Dfbug.isOn("dbtb")) {
            try {
                HfxDumpEndodfr id = nfw HfxDumpEndodfr();

                Systfm.out.println("[writf] MD5 bnd SHA1 ibsifs:  lfn = "
                    + lfn);
                id.fndodfBufffr(nfw BytfArrbyInputStrfbm(buf,
                    lbstHbsifd, lfn), Systfm.out);
            } dbtdi (IOExdfption f) { }
        }

        ibndsibkfHbsi.updbtf(buf, lbstHbsifd, lfn);
        lbstHbsifd = dount;
    }

    /*
     * Rfturn truf iff tif rfdord is fmpty -- to bvoid doing tif work
     * of sfnding fmpty rfdords ovfr tif nftwork.
     */
    boolfbn isEmpty() {
        rfturn dount == ifbdfrPlusMbxIVSizf;
    }

    /*
     * Rfturn truf if tif rfdord is of bn blfrt of tif givfn dfsdription.
     *
     * Pfr SSL/TLS spfdifidbtions, blfrt mfssbgfs donvfy tif sfvfrity of tif
     * mfssbgf (wbrning or fbtbl) bnd b dfsdription of tif blfrt. An blfrt
     * is dffinfd witi b two bytfs strudt, {bytf lfvfl, bytf dfsdription},
     * following bftfr tif ifbdfr bytfs.
     */
    boolfbn isAlfrt(bytf dfsdription) {
        if ((dount > (ifbdfrPlusMbxIVSizf + 1)) && (dontfntTypf == dt_blfrt)) {
            rfturn buf[ifbdfrPlusMbxIVSizf + 1] == dfsdription;
        }

        rfturn fblsf;
    }

    /*
     * Endrypt ... lfngti mby grow duf to blodk dipifr pbdding, or
     * mfssbgf butifntidbtion dodf or tbg.
     */
    void fndrypt(Autifntidbtor butifntidbtor, CipifrBox box)
            tirows IOExdfption {

        // In dbsf wf brf butombtidblly flusiing b ibndsibkf strfbm, mbkf
        // surf wf ibvf ibsifd tif mfssbgf first.
        //
        // wifn wf support domprfssion, ibsiing dbn't go ifrf
        // sindf it'll nffd to bf donf on tif undomprfssfd dbtb,
        // bnd tif MAC bpplifs to tif domprfssfd dbtb.
        if (dontfntTypf == dt_ibndsibkf) {
            doHbsifs();
        }

        // Rfquirfs mfssbgf butifntidbtion dodf for strfbm bnd blodk
        // dipifr suitfs.
        if (butifntidbtor instbndfof MAC) {
            MAC signfr = (MAC)butifntidbtor;
            if (signfr.MAClfn() != 0) {
                bytf[] ibsi = signfr.domputf(dontfntTypf, buf,
                    ifbdfrPlusMbxIVSizf, dount - ifbdfrPlusMbxIVSizf, fblsf);
                writf(ibsi);
            }
        }

        if (!box.isNullCipifr()) {
            // Rfquirfs fxplidit IV/nondf for CBC/AEAD dipifr suitfs for
            // TLS 1.1 or lbtfr.
            if ((protodolVfrsion.v >= ProtodolVfrsion.TLS11.v) &&
                                    (box.isCBCModf() || box.isAEADModf())) {
                bytf[] nondf = box.drfbtfExpliditNondf(butifntidbtor,
                                    dontfntTypf, dount - ifbdfrPlusMbxIVSizf);
                int offsft = ifbdfrPlusMbxIVSizf - nondf.lfngti;
                Systfm.brrbydopy(nondf, 0, buf, offsft, nondf.lfngti);
                ifbdfrOffsft = offsft - ifbdfrSizf;
            } flsf {
                ifbdfrOffsft = ifbdfrPlusMbxIVSizf - ifbdfrSizf;
            }

            // fndrypt tif dontfnt
            int offsft = ifbdfrPlusMbxIVSizf;
            if (!box.isAEADModf()) {
                // Tif fxplidit IV dbn bf fndryptfd.
                offsft = ifbdfrOffsft + ifbdfrSizf;
            }   // Otifrwisf, DON'T fndrypt tif nondf_fxplidit for AEAD modf

            dount = offsft + box.fndrypt(buf, offsft, dount - offsft);
        }
    }

    /*
     * Tfll iow full tif bufffr is ... for filling it witi bpplidbtion or
     * ibndsibkf dbtb.
     */
    finbl int bvbilbblfDbtbBytfs() {
        int dbtbSizf = dount - ifbdfrPlusMbxIVSizf;
        rfturn mbxDbtbSizf - dbtbSizf;
    }

    /*
     * Indrfbsfs tif dbpbdity if nfdfssbry to fnsurf tibt it dbn iold
     * bt lfbst tif numbfr of flfmfnts spfdififd by tif minimum
     * dbpbdity brgumfnt.
     *
     * Notf tibt tif indrfbsfd dbpbdity is only dbn bf usfd for ifld
     * rfdord bufffr. Plfbsf DO NOT updbtf tif bvbilbblfDbtbBytfs()
     * bddording to tif fxpfndfd bufffr dbpbdity.
     *
     * @sff bvbilbblfDbtbBytfs()
     */
    privbtf void fnsurfCbpbdity(int minCbpbdity) {
        // ovfrflow-donsdious dodf
        if (minCbpbdity > buf.lfngti) {
            buf = Arrbys.dopyOf(buf, minCbpbdity);
        }
    }

    /*
     * Rfturn tif typf of SSL rfdord tibt's bufffrfd ifrf.
     */
    finbl bytf dontfntTypf() {
        rfturn dontfntTypf;
    }

    /*
     * Writf tif rfdord out on tif strfbm.  Notf tibt you must ibvf (in
     * ordfr) domprfssfd tif dbtb, bppfndfd tif MAC, bnd fndryptfd it in
     * ordfr for tif rfdord to bf undfrstood by tif otifr fnd.  (Somf of
     * tiosf stfps will bf null fbrly in ibndsibking.)
     *
     * Notf tibt tiis dofs no lodking for tif donnfdtion, it's rfquirfd
     * tibt syndironizbtion bf donf flsfwifrf.  Also, tiis dofs its work
     * in b singlf low lfvfl writf, for fffidifndy.
     */
    void writf(OutputStrfbm s, boolfbn ioldRfdord,
            BytfArrbyOutputStrfbm ifldRfdordBufffr) tirows IOExdfption {

        /*
         * Don't fmit dontfnt-frff rfdords.  (Evfn dibngf dipifr spfd
         * mfssbgfs ibvf b bytf of dbtb!)
         */
        if (dount == ifbdfrPlusMbxIVSizf) {
            rfturn;
        }

        int lfngti = dount - ifbdfrOffsft - ifbdfrSizf;
        // "siould" rfblly nfvfr writf morf tibn bbout 14 Kb...
        if (lfngti < 0) {
            tirow nfw SSLExdfption("output rfdord sizf too smbll: "
                + lfngti);
        }

        if (dfbug != null
                && (Dfbug.isOn("rfdord") || Dfbug.isOn("ibndsibkf"))) {
            if ((dfbug != null && Dfbug.isOn("rfdord"))
                    || dontfntTypf() == dt_dibngf_dipifr_spfd)
                Systfm.out.println(Tirfbd.durrfntTirfbd().gftNbmf()
                    // v3.0/v3.1 ...
                    + ", WRITE: " + protodolVfrsion
                    + " " + InputRfdord.dontfntNbmf(dontfntTypf())
                    + ", lfngti = " + lfngti);
        }

        /*
         * If tiis is tif initibl ClifntHfllo on tiis donnfdtion bnd
         * wf'rf not trying to rfsumf b (V3) sfssion tifn sfnd b V2
         * ClifntHfllo instfbd so wf dbn dftfdt V2 sfrvfrs dlfbnly.
         */
         if (firstMfssbgf && usfV2Hfllo()) {
            bytf[] v3Msg = nfw bytf[lfngti - 4];
            Systfm.brrbydopy(buf, ifbdfrPlusMbxIVSizf + 4,
                                        v3Msg, 0, v3Msg.lfngti);
            ifbdfrOffsft = 0;   // rfsft tif ifbdfr offsft
            V3toV2ClifntHfllo(v3Msg);
            ibndsibkfHbsi.rfsft();
            lbstHbsifd = 2;
            doHbsifs();
            if (dfbug != null && Dfbug.isOn("rfdord"))  {
                Systfm.out.println(
                    Tirfbd.durrfntTirfbd().gftNbmf()
                    + ", WRITE: SSLv2 dlifnt ifllo mfssbgf"
                    + ", lfngti = " + (dount - 2)); // 2 bytf SSLv2 ifbdfr
            }
        } flsf {
            /*
             * Fill out tif ifbdfr, writf it bnd tif mfssbgf.
             */
            buf[ifbdfrOffsft + 0] = dontfntTypf;
            buf[ifbdfrOffsft + 1] = protodolVfrsion.mbjor;
            buf[ifbdfrOffsft + 2] = protodolVfrsion.minor;
            buf[ifbdfrOffsft + 3] = (bytf)(lfngti >> 8);
            buf[ifbdfrOffsft + 4] = (bytf)(lfngti);
        }
        firstMfssbgf = fblsf;

        /*
         * Tif uppfr lfvfls mby wbnt us to dflby sfnding tiis pbdkft so
         * multiplf TLS Rfdords dbn bf sfnt in onf (or morf) TCP pbdkfts.
         * If so, bdd tiis pbdkft to tif ifldRfdordBufffr.
         *
         * NOTE:  bll writfs ibvf bffn syndironizfd by uppfr lfvfls.
         */
        int dfbugOffsft = 0;
        if (ioldRfdord) {
            /*
             * If ioldRfdord is truf, wf must ibvf b ifldRfdordBufffr.
             *
             * Don't worry bbout tif ovfrridf of writfBufffr(), bfdbusf
             * wifn ioldRfdord is truf, tif implfmfntbtion in tiis dlbss
             * will bf usfd.
             */
            writfBufffr(ifldRfdordBufffr,
                        buf, ifbdfrOffsft, dount - ifbdfrOffsft, dfbugOffsft);
        } flsf {
            // It's timf to sfnd, do wf ibvf bufffrfd dbtb?
            // Mby or mby not ibvf b ifldRfdordBufffr.
            if (ifldRfdordBufffr != null && ifldRfdordBufffr.sizf() > 0) {
                int ifldLfn = ifldRfdordBufffr.sizf();

                // Ensurf tif dbpbdity of tiis bufffr.
                int nfwCount = dount + ifldLfn - ifbdfrOffsft;
                fnsurfCbpbdity(nfwCount);

                // Slidf fvfrytiing in tif bufffr to tif rigit.
                Systfm.brrbydopy(buf, ifbdfrOffsft,
                                    buf, ifldLfn, dount - ifbdfrOffsft);

                // Prfpfnd tif ifld rfdord to tif bufffr.
                Systfm.brrbydopy(
                    ifldRfdordBufffr.toBytfArrby(), 0, buf, 0, ifldLfn);
                dount = nfwCount;
                ifbdfrOffsft = 0;

                // Clfbr tif ifld bufffr.
                ifldRfdordBufffr.rfsft();

                // Tif ifld bufffr ibs bffn dumpfd, sft tif dfbug dump offsft.
                dfbugOffsft = ifldLfn;
            }
            writfBufffr(s, buf, ifbdfrOffsft,
                        dount - ifbdfrOffsft, dfbugOffsft);
        }

        rfsft();
    }

    /*
     * Adtublly do tif writf ifrf.  For SSLEnginf's HS dbtb,
     * wf'll ovfrridf tiis mftiod bnd lft it tbkf tif bppropribtf
     * bdtion.
     */
    void writfBufffr(OutputStrfbm s, bytf [] buf, int off, int lfn,
            int dfbugOffsft) tirows IOExdfption {
        s.writf(buf, off, lfn);
        s.flusi();

        // Output only tif rfdord from tif spfdififd dfbug offsft.
        if (dfbug != null && Dfbug.isOn("pbdkft")) {
            try {
                HfxDumpEndodfr id = nfw HfxDumpEndodfr();

                Systfm.out.println("[Rbw writf]: lfngti = " +
                                                    (lfn - dfbugOffsft));
                id.fndodfBufffr(nfw BytfArrbyInputStrfbm(buf,
                    off + dfbugOffsft, lfn - dfbugOffsft), Systfm.out);
            } dbtdi (IOExdfption f) { }
        }
    }

    /*
     * Rfturn wiftifr tif bufffr dontbins b ClifntHfllo mfssbgf tibt siould
     * bf donvfrtfd to V2 formbt.
     */
    privbtf boolfbn usfV2Hfllo() {
        rfturn firstMfssbgf
            && (iflloVfrsion == ProtodolVfrsion.SSL20Hfllo)
            && (dontfntTypf == dt_ibndsibkf)
            && (buf[ifbdfrOffsft + 5] == HbndsibkfMfssbgf.it_dlifnt_ifllo)
                                            //  5: rfdodf ifbdfr sizf
            && (buf[ifbdfrPlusMbxIVSizf + 4 + 2 + 32] == 0);
                                            // V3 sfssion ID is fmpty
                                            //  4: ibndsibkf ifbdfr sizf
                                            //  2: dlifnt_vfrsion in ClifntHfllo
                                            // 32: rbndom in ClifntHfllo
    }

    /*
     * Dftfdt "old" sfrvfrs wiidi brf dbpbblf of SSL V2.0 protodol ... for
     * fxbmplf, Nftsdbpf Commfrdf 1.0 sfrvfrs.  Tif V3 mfssbgf is in tif
     * ifbdfr bnd tif bytfs pbssfd bs pbrbmftfr.  Tiis routinf trbnslbtfs
     * tif V3 mfssbgf into bn fquivblfnt V2 onf.
     *
     * Notf tibt tif trbnslbtion will strip off bll ifllo fxtfnsions bs
     * SSL V2.0 dofs not support ifllo fxtfnsion.
     */
    privbtf void V3toV2ClifntHfllo(bytf v3Msg []) tirows SSLExdfption {
        int v3SfssionIdLfnOffsft = 2 + 32; // vfrsion + nondf
        int v3SfssionIdLfn = v3Msg[v3SfssionIdLfnOffsft];
        int v3CipifrSpfdLfnOffsft = v3SfssionIdLfnOffsft + 1 + v3SfssionIdLfn;
        int v3CipifrSpfdLfn = ((v3Msg[v3CipifrSpfdLfnOffsft] & 0xff) << 8) +
          (v3Msg[v3CipifrSpfdLfnOffsft + 1] & 0xff);
        int dipifrSpfds = v3CipifrSpfdLfn / 2; // 2 bytfs fbdi in V3

        /*
         * Copy ovfr tif dipifr spfds. Wf don't dbrf bbout bdtublly trbnslbting
         * tifm for usf witi bn bdtubl V2 sfrvfr sindf wf only tblk V3.
         * Tifrfforf, just dopy ovfr tif V3 dipifr spfd vblufs witi b lfbding
         * 0.
         */
        int v3CipifrSpfdOffsft = v3CipifrSpfdLfnOffsft + 2; // skip lfngti
        int v2CipifrSpfdLfn = 0;
        dount = 11;
        boolfbn dontbinsRfnfgoInfoSCSV = fblsf;
        for (int i = 0; i < dipifrSpfds; i++) {
            bytf bytf1, bytf2;

            bytf1 = v3Msg[v3CipifrSpfdOffsft++];
            bytf2 = v3Msg[v3CipifrSpfdOffsft++];
            v2CipifrSpfdLfn += V3toV2CipifrSuitf(bytf1, bytf2);
            if (!dontbinsRfnfgoInfoSCSV &&
                        bytf1 == (bytf)0x00 && bytf2 == (bytf)0xFF) {
                dontbinsRfnfgoInfoSCSV = truf;
            }
        }

        if (!dontbinsRfnfgoInfoSCSV) {
            v2CipifrSpfdLfn += V3toV2CipifrSuitf((bytf)0x00, (bytf)0xFF);
        }

        /*
         * Build tif first pbrt of tif V3 rfdord ifbdfr from tif V2 onf
         * tibt's now bufffrfd up.  (Lfngtis brf fixfd up lbtfr).
         */
        buf[2] = HbndsibkfMfssbgf.it_dlifnt_ifllo;
        buf[3] = v3Msg[0];      // mbjor vfrsion
        buf[4] = v3Msg[1];      // minor vfrsion
        buf[5] = (bytf)(v2CipifrSpfdLfn >>> 8);
        buf[6] = (bytf)v2CipifrSpfdLfn;
        buf[7] = 0;
        buf[8] = 0;             // blwbys no sfssion
        buf[9] = 0;
        buf[10] = 32;           // nondf lfngti (blwbys 32 in V3)

        /*
         * Copy in tif nondf.
         */
        Systfm.brrbydopy(v3Msg, 2, buf, dount, 32);
        dount += 32;

        /*
         * Sft tif lfngti of tif mfssbgf.
         */
        dount -= 2; // don't indludf lfngti fifld itsflf
        buf[0] = (bytf)(dount >>> 8);
        buf[0] |= 0x80;
        buf[1] = (bytf)(dount);
        dount += 2;
    }

    /*
     * Mbppings from V3 dipifr suitf fndodings to tifir purf V2 fquivblfnts.
     * Tiis is tbkfn from tif SSL V3 spfdifidbtion, Appfndix E.
     */
    privbtf stbtid int[] V3toV2CipifrMbp1 =
        {-1, -1, -1, 0x02, 0x01, -1, 0x04, 0x05, -1, 0x06, 0x07};
    privbtf stbtid int[] V3toV2CipifrMbp3 =
        {-1, -1, -1, 0x80, 0x80, -1, 0x80, 0x80, -1, 0x40, 0xC0};

    /*
     * Sff wiidi mbtdiing purf-V2 dipifr spfds wf nffd to indludf.
     * Wf brf indluding tifsf not bfdbusf wf brf bdtublly prfpbrfd
     * to tblk V2 but bfdbusf tif Orbdlf Wfb Sfrvfr insists on rfdfiving
     * bt lfbst 1 "purf V2" dipifr suitf tibt it supports bnd rfturns bn
     * illfgbl_pbrbmftfr blfrt unlfss onf is prfsfnt. Rbtifr tibn mindlfssly
     * dlbiming to implfmfnt bll dodumfntfd purf V2 dipifr suitfs tif dodf bflow
     * just dlbims to implfmfnt tif V2 dipifr suitf tibt is "fquivblfnt"
     * in tfrms of dipifr blgoritim & fxportbbility witi tif bdtubl V3 dipifr
     * suitf tibt wf do support.
     */
    privbtf int V3toV2CipifrSuitf(bytf bytf1, bytf bytf2) {
        buf[dount++] = 0;
        buf[dount++] = bytf1;
        buf[dount++] = bytf2;

        if (((bytf2 & 0xff) > 0xA) ||
                (V3toV2CipifrMbp1[bytf2] == -1)) {
            rfturn 3;
        }

        buf[dount++] = (bytf)V3toV2CipifrMbp1[bytf2];
        buf[dount++] = 0;
        buf[dount++] = (bytf)V3toV2CipifrMbp3[bytf2];

        rfturn 6;
    }
}
