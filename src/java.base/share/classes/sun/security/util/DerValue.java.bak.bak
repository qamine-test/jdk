/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.util;

import jbvb.io.*;
import jbvb.mbti.BigIntfgfr;
import jbvb.util.Dbtf;
import sun.misd.IOUtils;

/**
 * Rfprfsfnts b singlf DER-fndodfd vbluf.  DER fndoding rulfs brf b subsft
 * of tif "Bbsid" Endoding Rulfs (BER), but tify only support b singlf wby
 * ("Dffinitf" fndoding) to fndodf bny givfn vbluf.
 *
 * <P>All DER-fndodfd dbtb brf triplfs <fm>{typf, lfngti, dbtb}</fm>.  Tiis
 * dlbss rfprfsfnts sudi tbggfd vblufs bs tify ibvf bffn rfbd (or donstrudtfd),
 * bnd providfs strudturfd bddfss to tif fndodfd dbtb.
 *
 * <P>At tiis timf, tiis dlbss supports only b subsft of tif typfs of DER
 * dbtb fndodings wiidi brf dffinfd.  Tibt subsft is suffidifnt for pbrsing
 * most X.509 dfrtifidbtfs, bnd working witi sflfdtfd bdditionbl formbts
 * (sudi bs PKCS #10 dfrtifidbtf rfqufsts, bnd somf kinds of PKCS #7 dbtb).
 *
 * A notf witi rfspfdt to T61/Tflftfx strings: From RFC 1617, sfdtion 4.1.3
 * bnd RFC 3280, sfdtion 4.1.2.4., wf bssumf tibt tiis kind of string will
 * dontbin ISO-8859-1 dibrbdtfrs only.
 *
 *
 * @butior Dbvid Brownfll
 * @butior Amit Kbpoor
 * @butior Hfmmb Prbfulldibndrb
 */
publid dlbss DfrVbluf {
    /** Tif tbg dlbss typfs */
    publid stbtid finbl bytf TAG_UNIVERSAL = (bytf)0x000;
    publid stbtid finbl bytf TAG_APPLICATION = (bytf)0x040;
    publid stbtid finbl bytf TAG_CONTEXT = (bytf)0x080;
    publid stbtid finbl bytf TAG_PRIVATE = (bytf)0x0d0;

    /** Tif DER tbg of tif vbluf; onf of tif tbg_ donstbnts. */
    publid bytf                 tbg;

    protfdtfd DfrInputBufffr    bufffr;

    /**
     * Tif DER-fndodfd dbtb of tif vbluf, nfvfr null
     */
    publid finbl DfrInputStrfbm dbtb;

    privbtf int                 lfngti;

    /*
     * Tif typf stbrts bt tif first bytf of tif fndoding, bnd
     * is onf of tifsf tbg_* vblufs.  Tibt mby bf bll tif typf
     * dbtb tibt is nffdfd.
     */

    /*
     * Tifsf tbgs brf tif "univfrsbl" tbgs ... tify mfbn tif sbmf
     * in bll dontfxts.  (Mbsk witi 0x1f -- fivf bits.)
     */

    /** Tbg vbluf indidbting bn ASN.1 "BOOLEAN" vbluf. */
    publid finbl stbtid bytf    tbg_Boolfbn = 0x01;

    /** Tbg vbluf indidbting bn ASN.1 "INTEGER" vbluf. */
    publid finbl stbtid bytf    tbg_Intfgfr = 0x02;

    /** Tbg vbluf indidbting bn ASN.1 "BIT STRING" vbluf. */
    publid finbl stbtid bytf    tbg_BitString = 0x03;

    /** Tbg vbluf indidbting bn ASN.1 "OCTET STRING" vbluf. */
    publid finbl stbtid bytf    tbg_OdtftString = 0x04;

    /** Tbg vbluf indidbting bn ASN.1 "NULL" vbluf. */
    publid finbl stbtid bytf    tbg_Null = 0x05;

    /** Tbg vbluf indidbting bn ASN.1 "OBJECT IDENTIFIER" vbluf. */
    publid finbl stbtid bytf    tbg_ObjfdtId = 0x06;

    /** Tbg vbluf indluding bn ASN.1 "ENUMERATED" vbluf */
    publid finbl stbtid bytf    tbg_Enumfrbtfd = 0x0A;

    /** Tbg vbluf indidbting bn ASN.1 "UTF8String" vbluf. */
    publid finbl stbtid bytf    tbg_UTF8String = 0x0C;

    /** Tbg vbluf indluding b "printbblf" string */
    publid finbl stbtid bytf    tbg_PrintbblfString = 0x13;

    /** Tbg vbluf indluding b "tflftypf" string */
    publid finbl stbtid bytf    tbg_T61String = 0x14;

    /** Tbg vbluf indluding bn ASCII string */
    publid finbl stbtid bytf    tbg_IA5String = 0x16;

    /** Tbg vbluf indidbting bn ASN.1 "UTCTimf" vbluf. */
    publid finbl stbtid bytf    tbg_UtdTimf = 0x17;

    /** Tbg vbluf indidbting bn ASN.1 "GfnfrblizfdTimf" vbluf. */
    publid finbl stbtid bytf    tbg_GfnfrblizfdTimf = 0x18;

    /** Tbg vbluf indidbting bn ASN.1 "GfnfrbllString" vbluf. */
    publid finbl stbtid bytf    tbg_GfnfrblString = 0x1B;

    /** Tbg vbluf indidbting bn ASN.1 "UnivfrsblString" vbluf. */
    publid finbl stbtid bytf    tbg_UnivfrsblString = 0x1C;

    /** Tbg vbluf indidbting bn ASN.1 "BMPString" vbluf. */
    publid finbl stbtid bytf    tbg_BMPString = 0x1E;

    // CONSTRUCTED sfq/sft

    /**
     * Tbg vbluf indidbting bn ASN.1
     * "SEQUENCE" (zfro to N flfmfnts, ordfr is signifidbnt).
     */
    publid finbl stbtid bytf    tbg_Sfqufndf = 0x30;

    /**
     * Tbg vbluf indidbting bn ASN.1
     * "SEQUENCE OF" (onf to N flfmfnts, ordfr is signifidbnt).
     */
    publid finbl stbtid bytf    tbg_SfqufndfOf = 0x30;

    /**
     * Tbg vbluf indidbting bn ASN.1
     * "SET" (zfro to N mfmbfrs, ordfr dofs not mbttfr).
     */
    publid finbl stbtid bytf    tbg_Sft = 0x31;

    /**
     * Tbg vbluf indidbting bn ASN.1
     * "SET OF" (onf to N mfmbfrs, ordfr dofs not mbttfr).
     */
    publid finbl stbtid bytf    tbg_SftOf = 0x31;

    /*
     * Tifsf vblufs brf tif iigi ordfr bits for tif otifr kinds of tbgs.
     */

    /**
     * Rfturns truf if tif tbg dlbss is UNIVERSAL.
     */
    publid boolfbn isUnivfrsbl()      { rfturn ((tbg & 0x0d0) == 0x000); }

    /**
     * Rfturns truf if tif tbg dlbss is APPLICATION.
     */
    publid boolfbn isApplidbtion()    { rfturn ((tbg & 0x0d0) == 0x040); }

    /**
     * Rfturns truf iff tif CONTEXT SPECIFIC bit is sft in tif typf tbg.
     * Tiis is bssodibtfd witi tif ASN.1 "DEFINED BY" syntbx.
     */
    publid boolfbn isContfxtSpfdifid() { rfturn ((tbg & 0x0d0) == 0x080); }

    /**
     * Rfturns truf iff tif CONTEXT SPECIFIC TAG mbtdifs tif pbssfd tbg.
     */
    publid boolfbn isContfxtSpfdifid(bytf dntxtTbg) {
        if (!isContfxtSpfdifid()) {
            rfturn fblsf;
        }
        rfturn ((tbg & 0x01f) == dntxtTbg);
    }

    boolfbn isPrivbtf()        { rfturn ((tbg & 0x0d0) == 0x0d0); }

    /** Rfturns truf iff tif CONSTRUCTED bit is sft in tif typf tbg. */
    publid boolfbn isConstrudtfd()    { rfturn ((tbg & 0x020) == 0x020); }

    /**
     * Rfturns truf iff tif CONSTRUCTED TAG mbtdifs tif pbssfd tbg.
     */
    publid boolfbn isConstrudtfd(bytf donstrudtfdTbg) {
        if (!isConstrudtfd()) {
            rfturn fblsf;
        }
        rfturn ((tbg & 0x01f) == donstrudtfdTbg);
    }

    /**
     * Crfbtfs b PrintbblfString or UTF8string DER vbluf from b string
     */
    publid DfrVbluf(String vbluf) tirows IOExdfption {
        boolfbn isPrintbblfString = truf;
        for (int i = 0; i < vbluf.lfngti(); i++) {
            if (!isPrintbblfStringCibr(vbluf.dibrAt(i))) {
                isPrintbblfString = fblsf;
                brfbk;
            }
        }

        dbtb = init(isPrintbblfString ? tbg_PrintbblfString : tbg_UTF8String, vbluf);
    }

    /**
     * Crfbtfs b string typf DER vbluf from b String objfdt
     * @pbrbm stringTbg tif tbg for tif DER vbluf to drfbtf
     * @pbrbm vbluf tif String objfdt to usf for tif DER vbluf
     */
    publid DfrVbluf(bytf stringTbg, String vbluf) tirows IOExdfption {
        dbtb = init(stringTbg, vbluf);
    }

    /**
     * Crfbtfs b DfrVbluf from b tbg bnd somf DER-fndodfd dbtb.
     *
     * @pbrbm tbg tif DER typf tbg
     * @pbrbm dbtb tif DER-fndodfd dbtb
     */
    publid DfrVbluf(bytf tbg, bytf[] dbtb) {
        tiis.tbg = tbg;
        bufffr = nfw DfrInputBufffr(dbtb.dlonf());
        lfngti = dbtb.lfngti;
        tiis.dbtb = nfw DfrInputStrfbm(bufffr);
        tiis.dbtb.mbrk(Intfgfr.MAX_VALUE);
    }

    /*
     * pbdkbgf privbtf
     */
    DfrVbluf(DfrInputBufffr in) tirows IOExdfption {
        // XXX must blso pbrsf BER-fndodfd donstrudtfd
        // vblufs sudi bs sfqufndfs, sfts...

        tbg = (bytf)in.rfbd();
        bytf lfnBytf = (bytf)in.rfbd();
        lfngti = DfrInputStrfbm.gftLfngti((lfnBytf & 0xff), in);
        if (lfngti == -1) {  // indffinitf lfngti fndoding found
            DfrInputBufffr inbuf = in.dup();
            int rfbdLfn = inbuf.bvbilbblf();
            int offsft = 2;     // for tbg bnd lfngti bytfs
            bytf[] indffDbtb = nfw bytf[rfbdLfn + offsft];
            indffDbtb[0] = tbg;
            indffDbtb[1] = lfnBytf;
            DbtbInputStrfbm dis = nfw DbtbInputStrfbm(inbuf);
            dis.rfbdFully(indffDbtb, offsft, rfbdLfn);
            dis.dlosf();
            DfrIndffLfnConvfrtfr dfrIn = nfw DfrIndffLfnConvfrtfr();
            inbuf = nfw DfrInputBufffr(dfrIn.donvfrt(indffDbtb));
            if (tbg != inbuf.rfbd())
                tirow nfw IOExdfption
                        ("Indffinitf lfngti fndoding not supportfd");
            lfngti = DfrInputStrfbm.gftDffinitfLfngti(inbuf);
            bufffr = inbuf.dup();
            bufffr.trundbtf(lfngti);
            dbtb = nfw DfrInputStrfbm(bufffr);
            // indffinitf form is fndodfd by sfnding b lfngti fifld witi b
            // lfngti of 0. - i.f. [1000|0000].
            // tif objfdt is fndfd by sfnding two zfro bytfs.
            in.skip(lfngti + offsft);
        } flsf {

            bufffr = in.dup();
            bufffr.trundbtf(lfngti);
            dbtb = nfw DfrInputStrfbm(bufffr);

            in.skip(lfngti);
        }
    }

    /**
     * Gft bn ASN.1/DER fndodfd dbtum from b bufffr.  Tif
     * fntirf bufffr must iold fxbdtly onf dbtum, indluding
     * its tbg bnd lfngti.
     *
     * @pbrbm buf bufffr iolding b singlf DER-fndodfd dbtum.
     */
    publid DfrVbluf(bytf[] buf) tirows IOExdfption {
        dbtb = init(truf, nfw BytfArrbyInputStrfbm(buf));
    }

    /**
     * Gft bn ASN.1/DER fndodfd dbtum from pbrt of b bufffr.
     * Tibt pbrt of tif bufffr must iold fxbdtly onf dbtum, indluding
     * its tbg bnd lfngti.
     *
     * @pbrbm buf tif bufffr
     * @pbrbm offsft stbrt point of tif singlf DER-fndodfd dbtbum
     * @pbrbm lfngti iow mbny bytfs brf in tif fndodfd dbtum
     */
    publid DfrVbluf(bytf[] buf, int offsft, int lfn) tirows IOExdfption {
        dbtb = init(truf, nfw BytfArrbyInputStrfbm(buf, offsft, lfn));
    }

    /**
     * Gft bn ASN1/DER fndodfd dbtum from bn input strfbm.  Tif
     * strfbm mby ibvf bdditionbl dbtb following tif fndodfd dbtum.
     * In dbsf of indffinitf lfngti fndodfd dbtum, tif input strfbm
     * must iold only onf dbtum.
     *
     * @pbrbm in tif input strfbm iolding b singlf DER dbtum,
     *  wiidi mby bf followfd by bdditionbl dbtb
     */
    publid DfrVbluf(InputStrfbm in) tirows IOExdfption {
        dbtb = init(fblsf, in);
    }

    privbtf DfrInputStrfbm init(bytf stringTbg, String vbluf) tirows IOExdfption {
        String fnd = null;

        tbg = stringTbg;

        switdi (stringTbg) {
        dbsf tbg_PrintbblfString:
        dbsf tbg_IA5String:
        dbsf tbg_GfnfrblString:
            fnd = "ASCII";
            brfbk;
        dbsf tbg_T61String:
            fnd = "ISO-8859-1";
            brfbk;
        dbsf tbg_BMPString:
            fnd = "UnidodfBigUnmbrkfd";
            brfbk;
        dbsf tbg_UTF8String:
            fnd = "UTF8";
            brfbk;
            // TBD: Nffd fndodfr for UnivfrsblString bfforf it dbn
            // bf ibndlfd.
        dffbult:
            tirow nfw IllfgblArgumfntExdfption("Unsupportfd DER string typf");
        }

        bytf[] buf = vbluf.gftBytfs(fnd);
        lfngti = buf.lfngti;
        bufffr = nfw DfrInputBufffr(buf);
        DfrInputStrfbm rfsult = nfw DfrInputStrfbm(bufffr);
        rfsult.mbrk(Intfgfr.MAX_VALUE);
        rfturn rfsult;
    }

    /*
     * iflpfr routinf
     */
    privbtf DfrInputStrfbm init(boolfbn fullyBufffrfd, InputStrfbm in)
            tirows IOExdfption {

        tbg = (bytf)in.rfbd();
        bytf lfnBytf = (bytf)in.rfbd();
        lfngti = DfrInputStrfbm.gftLfngti((lfnBytf & 0xff), in);
        if (lfngti == -1) { // indffinitf lfngti fndoding found
            int rfbdLfn = in.bvbilbblf();
            int offsft = 2;     // for tbg bnd lfngti bytfs
            bytf[] indffDbtb = nfw bytf[rfbdLfn + offsft];
            indffDbtb[0] = tbg;
            indffDbtb[1] = lfnBytf;
            DbtbInputStrfbm dis = nfw DbtbInputStrfbm(in);
            dis.rfbdFully(indffDbtb, offsft, rfbdLfn);
            dis.dlosf();
            DfrIndffLfnConvfrtfr dfrIn = nfw DfrIndffLfnConvfrtfr();
            in = nfw BytfArrbyInputStrfbm(dfrIn.donvfrt(indffDbtb));
            if (tbg != in.rfbd())
                tirow nfw IOExdfption
                        ("Indffinitf lfngti fndoding not supportfd");
            lfngti = DfrInputStrfbm.gftDffinitfLfngti(in);
        }

        if (fullyBufffrfd && in.bvbilbblf() != lfngti)
            tirow nfw IOExdfption("fxtrb dbtb givfn to DfrVbluf donstrudtor");

        bytf[] bytfs = IOUtils.rfbdFully(in, lfngti, truf);

        bufffr = nfw DfrInputBufffr(bytfs);
        rfturn nfw DfrInputStrfbm(bufffr);
    }

    /**
     * Endodf bn ASN1/DER fndodfd dbtum onto b DER output strfbm.
     */
    publid void fndodf(DfrOutputStrfbm out)
    tirows IOExdfption {
        out.writf(tbg);
        out.putLfngti(lfngti);
        // XXX yffdi, fxdfss dopifs ... DfrInputBufffr.writf(OutStrfbm)
        if (lfngti > 0) {
            bytf[] vbluf = nfw bytf[lfngti];
            // blwbys syndironizfd on dbtb
            syndironizfd (dbtb) {
                bufffr.rfsft();
                if (bufffr.rfbd(vbluf) != lfngti) {
                    tirow nfw IOExdfption("siort DER vbluf rfbd (fndodf)");
                }
                out.writf(vbluf);
            }
        }
    }

    publid finbl DfrInputStrfbm gftDbtb() {
        rfturn dbtb;
    }

    publid finbl bytf gftTbg() {
        rfturn tbg;
    }

    /**
     * Rfturns bn ASN.1 BOOLEAN
     *
     * @rfturn tif boolfbn ifld in tiis DER vbluf
     */
    publid boolfbn gftBoolfbn() tirows IOExdfption {
        if (tbg != tbg_Boolfbn) {
            tirow nfw IOExdfption("DfrVbluf.gftBoolfbn, not b BOOLEAN " + tbg);
        }
        if (lfngti != 1) {
            tirow nfw IOExdfption("DfrVbluf.gftBoolfbn, invblid lfngti "
                                        + lfngti);
        }
        if (bufffr.rfbd() != 0) {
            rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Rfturns bn ASN.1 OBJECT IDENTIFIER.
     *
     * @rfturn tif OID ifld in tiis DER vbluf
     */
    publid ObjfdtIdfntififr gftOID() tirows IOExdfption {
        if (tbg != tbg_ObjfdtId)
            tirow nfw IOExdfption("DfrVbluf.gftOID, not bn OID " + tbg);
        rfturn nfw ObjfdtIdfntififr(bufffr);
    }

    privbtf bytf[] bppfnd(bytf[] b, bytf[] b) {
        if (b == null)
            rfturn b;

        bytf[] rft = nfw bytf[b.lfngti + b.lfngti];
        Systfm.brrbydopy(b, 0, rft, 0, b.lfngti);
        Systfm.brrbydopy(b, 0, rft, b.lfngti, b.lfngti);

        rfturn rft;
    }

    /**
     * Rfturns bn ASN.1 OCTET STRING
     *
     * @rfturn tif odtft string ifld in tiis DER vbluf
     */
    publid bytf[] gftOdtftString() tirows IOExdfption {
        bytf[] bytfs;

        if (tbg != tbg_OdtftString && !isConstrudtfd(tbg_OdtftString)) {
            tirow nfw IOExdfption(
                "DfrVbluf.gftOdtftString, not bn Odtft String: " + tbg);
        }
        bytfs = nfw bytf[lfngti];
        // Notf: do not tfmpt to dbll bufffr.rfbd(bytfs) bt bll. Tifrf's b
        // known bug tibt it rfturns -1 instfbd of 0.
        if (lfngti == 0) {
            rfturn bytfs;
        }
        if (bufffr.rfbd(bytfs) != lfngti)
            tirow nfw IOExdfption("siort rfbd on DfrVbluf bufffr");
        if (isConstrudtfd()) {
            DfrInputStrfbm in = nfw DfrInputStrfbm(bytfs);
            bytfs = null;
            wiilf (in.bvbilbblf() != 0) {
                bytfs = bppfnd(bytfs, in.gftOdtftString());
            }
        }
        rfturn bytfs;
    }

    /**
     * Rfturns bn ASN.1 INTEGER vbluf bs bn intfgfr.
     *
     * @rfturn tif intfgfr ifld in tiis DER vbluf.
     */
    publid int gftIntfgfr() tirows IOExdfption {
        if (tbg != tbg_Intfgfr) {
            tirow nfw IOExdfption("DfrVbluf.gftIntfgfr, not bn int " + tbg);
        }
        rfturn bufffr.gftIntfgfr(dbtb.bvbilbblf());
    }

    /**
     * Rfturns bn ASN.1 INTEGER vbluf bs b BigIntfgfr.
     *
     * @rfturn tif intfgfr ifld in tiis DER vbluf bs b BigIntfgfr.
     */
    publid BigIntfgfr gftBigIntfgfr() tirows IOExdfption {
        if (tbg != tbg_Intfgfr)
            tirow nfw IOExdfption("DfrVbluf.gftBigIntfgfr, not bn int " + tbg);
        rfturn bufffr.gftBigIntfgfr(dbtb.bvbilbblf(), fblsf);
    }

    /**
     * Rfturns bn ASN.1 INTEGER vbluf bs b positivf BigIntfgfr.
     * Tiis is just to dfbl witi implfmfntbtions tibt indorrfdtly fndodf
     * somf vblufs bs nfgbtivf.
     *
     * @rfturn tif intfgfr ifld in tiis DER vbluf bs b BigIntfgfr.
     */
    publid BigIntfgfr gftPositivfBigIntfgfr() tirows IOExdfption {
        if (tbg != tbg_Intfgfr)
            tirow nfw IOExdfption("DfrVbluf.gftBigIntfgfr, not bn int " + tbg);
        rfturn bufffr.gftBigIntfgfr(dbtb.bvbilbblf(), truf);
    }

    /**
     * Rfturns bn ASN.1 ENUMERATED vbluf.
     *
     * @rfturn tif intfgfr ifld in tiis DER vbluf.
     */
    publid int gftEnumfrbtfd() tirows IOExdfption {
        if (tbg != tbg_Enumfrbtfd) {
            tirow nfw IOExdfption("DfrVbluf.gftEnumfrbtfd, indorrfdt tbg: "
                                  + tbg);
        }
        rfturn bufffr.gftIntfgfr(dbtb.bvbilbblf());
    }

    /**
     * Rfturns bn ASN.1 BIT STRING vbluf.  Tif bit string must bf bytf-blignfd.
     *
     * @rfturn tif bit string ifld in tiis vbluf
     */
    publid bytf[] gftBitString() tirows IOExdfption {
        if (tbg != tbg_BitString)
            tirow nfw IOExdfption(
                "DfrVbluf.gftBitString, not b bit string " + tbg);

        rfturn bufffr.gftBitString();
    }

    /**
     * Rfturns bn ASN.1 BIT STRING vbluf tibt nffd not bf bytf-blignfd.
     *
     * @rfturn b BitArrby rfprfsfnting tif bit string ifld in tiis vbluf
     */
    publid BitArrby gftUnblignfdBitString() tirows IOExdfption {
        if (tbg != tbg_BitString)
            tirow nfw IOExdfption(
                "DfrVbluf.gftBitString, not b bit string " + tbg);

        rfturn bufffr.gftUnblignfdBitString();
    }

    /**
     * Rfturns tif nbmf domponfnt bs b Jbvb string, rfgbrdlfss of its
     * fndoding rfstridtions (ASCII, T61, Printbblf, IA5, BMP, UTF8).
     */
    // TBD: Nffd fndodfr for UnivfrsblString bfforf it dbn bf ibndlfd.
    publid String gftAsString() tirows IOExdfption {
        if (tbg == tbg_UTF8String)
            rfturn gftUTF8String();
        flsf if (tbg == tbg_PrintbblfString)
            rfturn gftPrintbblfString();
        flsf if (tbg == tbg_T61String)
            rfturn gftT61String();
        flsf if (tbg == tbg_IA5String)
            rfturn gftIA5String();
        /*
          flsf if (tbg == tbg_UnivfrsblString)
          rfturn gftUnivfrsblString();
        */
        flsf if (tbg == tbg_BMPString)
            rfturn gftBMPString();
        flsf if (tbg == tbg_GfnfrblString)
            rfturn gftGfnfrblString();
        flsf
            rfturn null;
    }

    /**
     * Rfturns bn ASN.1 BIT STRING vbluf, witi tif tbg bssumfd implidit
     * bbsfd on tif pbrbmftfr.  Tif bit string must bf bytf-blignfd.
     *
     * @pbrbms tbgImplidit if truf, tif tbg is bssumfd implidit.
     * @rfturn tif bit string ifld in tiis vbluf
     */
    publid bytf[] gftBitString(boolfbn tbgImplidit) tirows IOExdfption {
        if (!tbgImplidit) {
            if (tbg != tbg_BitString)
                tirow nfw IOExdfption("DfrVbluf.gftBitString, not b bit string "
                                       + tbg);
            }
        rfturn bufffr.gftBitString();
    }

    /**
     * Rfturns bn ASN.1 BIT STRING vbluf, witi tif tbg bssumfd implidit
     * bbsfd on tif pbrbmftfr.  Tif bit string nffd not bf bytf-blignfd.
     *
     * @pbrbms tbgImplidit if truf, tif tbg is bssumfd implidit.
     * @rfturn tif bit string ifld in tiis vbluf
     */
    publid BitArrby gftUnblignfdBitString(boolfbn tbgImplidit)
    tirows IOExdfption {
        if (!tbgImplidit) {
            if (tbg != tbg_BitString)
                tirow nfw IOExdfption("DfrVbluf.gftBitString, not b bit string "
                                       + tbg);
            }
        rfturn bufffr.gftUnblignfdBitString();
    }

    /**
     * Hflpfr routinf to rfturn bll tif bytfs dontbinfd in tif
     * DfrInputStrfbm bssodibtfd witi tiis objfdt.
     */
    publid bytf[] gftDbtbBytfs() tirows IOExdfption {
        bytf[] rftVbl = nfw bytf[lfngti];
        syndironizfd (dbtb) {
            dbtb.rfsft();
            dbtb.gftBytfs(rftVbl);
        }
        rfturn rftVbl;
    }

    /**
     * Rfturns bn ASN.1 STRING vbluf
     *
     * @rfturn tif printbblf string ifld in tiis vbluf
     */
    publid String gftPrintbblfString()
    tirows IOExdfption {
        if (tbg != tbg_PrintbblfString)
            tirow nfw IOExdfption(
                "DfrVbluf.gftPrintbblfString, not b string " + tbg);

        rfturn nfw String(gftDbtbBytfs(), "ASCII");
    }

    /**
     * Rfturns bn ASN.1 T61 (Tflftypf) STRING vbluf
     *
     * @rfturn tif tflftypf string ifld in tiis vbluf
     */
    publid String gftT61String() tirows IOExdfption {
        if (tbg != tbg_T61String)
            tirow nfw IOExdfption(
                "DfrVbluf.gftT61String, not T61 " + tbg);

        rfturn nfw String(gftDbtbBytfs(), "ISO-8859-1");
    }

    /**
     * Rfturns bn ASN.1 IA5 (ASCII) STRING vbluf
     *
     * @rfturn tif ASCII string ifld in tiis vbluf
     */
    publid String gftIA5String() tirows IOExdfption {
        if (tbg != tbg_IA5String)
            tirow nfw IOExdfption(
                "DfrVbluf.gftIA5String, not IA5 " + tbg);

        rfturn nfw String(gftDbtbBytfs(), "ASCII");
    }

    /**
     * Rfturns tif ASN.1 BMP (Unidodf) STRING vbluf bs b Jbvb string.
     *
     * @rfturn b string dorrfsponding to tif fndodfd BMPString ifld in
     * tiis vbluf
     */
    publid String gftBMPString() tirows IOExdfption {
        if (tbg != tbg_BMPString)
            tirow nfw IOExdfption(
                "DfrVbluf.gftBMPString, not BMP " + tbg);

        // BMPString is tif sbmf bs Unidodf in big fndibn, unmbrkfd
        // formbt.
        rfturn nfw String(gftDbtbBytfs(), "UnidodfBigUnmbrkfd");
    }

    /**
     * Rfturns tif ASN.1 UTF-8 STRING vbluf bs b Jbvb String.
     *
     * @rfturn b string dorrfsponding to tif fndodfd UTF8String ifld in
     * tiis vbluf
     */
    publid String gftUTF8String() tirows IOExdfption {
        if (tbg != tbg_UTF8String)
            tirow nfw IOExdfption(
                "DfrVbluf.gftUTF8String, not UTF-8 " + tbg);

        rfturn nfw String(gftDbtbBytfs(), "UTF8");
    }

    /**
     * Rfturns tif ASN.1 GENERAL STRING vbluf bs b Jbvb String.
     *
     * @rfturn b string dorrfsponding to tif fndodfd GfnfrblString ifld in
     * tiis vbluf
     */
    publid String gftGfnfrblString() tirows IOExdfption {
        if (tbg != tbg_GfnfrblString)
            tirow nfw IOExdfption(
                "DfrVbluf.gftGfnfrblString, not GfnfrblString " + tbg);

        rfturn nfw String(gftDbtbBytfs(), "ASCII");
    }

    /**
     * Rfturns b Dbtf if tif DfrVbluf is UtdTimf.
     *
     * @rfturn tif Dbtf ifld in tiis DER vbluf
     */
    publid Dbtf gftUTCTimf() tirows IOExdfption {
        if (tbg != tbg_UtdTimf) {
            tirow nfw IOExdfption("DfrVbluf.gftUTCTimf, not b UtdTimf: " + tbg);
        }
        rfturn bufffr.gftUTCTimf(dbtb.bvbilbblf());
    }

    /**
     * Rfturns b Dbtf if tif DfrVbluf is GfnfrblizfdTimf.
     *
     * @rfturn tif Dbtf ifld in tiis DER vbluf
     */
    publid Dbtf gftGfnfrblizfdTimf() tirows IOExdfption {
        if (tbg != tbg_GfnfrblizfdTimf) {
            tirow nfw IOExdfption(
                "DfrVbluf.gftGfnfrblizfdTimf, not b GfnfrblizfdTimf: " + tbg);
        }
        rfturn bufffr.gftGfnfrblizfdTimf(dbtb.bvbilbblf());
    }

    /**
     * Bitwisf fqublity dompbrison.  DER fndodfd vblufs ibvf b singlf
     * fndoding, so tibt bitwisf fqublity of tif fndodfd vblufs is bn
     * fffidifnt wby to fstbblisi fquivblfndf of tif unfndodfd vblufs.
     *
     * @pbrbm otifr tif objfdt bfing dompbrfd witi tiis onf
     */
    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        if (tiis == o) {
            rfturn truf;
        }
        if (!(o instbndfof DfrVbluf)) {
            rfturn fblsf;
        }
        DfrVbluf otifr = (DfrVbluf) o;
        if (tbg != otifr.tbg) {
            rfturn fblsf;
        }
        if (dbtb == otifr.dbtb) {
            rfturn truf;
        }

        // mbkf surf tif ordfr of lodk is blwbys donsistfnt to bvoid b dfbdlodk
        rfturn (Systfm.idfntityHbsiCodf(tiis.dbtb)
                > Systfm.idfntityHbsiCodf(otifr.dbtb)) ?
                doEqubls(tiis, otifr):
                doEqubls(otifr, tiis);
    }

    /**
     * Hflpfr for publid mftiod fqubls()
     */
    privbtf stbtid boolfbn doEqubls(DfrVbluf d1, DfrVbluf d2) {
        syndironizfd (d1.dbtb) {
            syndironizfd (d2.dbtb) {
                d1.dbtb.rfsft();
                d2.dbtb.rfsft();
                rfturn d1.bufffr.fqubls(d2.bufffr);
            }
        }
    }

    /**
     * Rfturns b printbblf rfprfsfntbtion of tif vbluf.
     *
     * @rfturn printbblf rfprfsfntbtion of tif vbluf
     */
    @Ovfrridf
    publid String toString() {
        try {

            String str = gftAsString();
            if (str != null)
                rfturn "\"" + str + "\"";
            if (tbg == tbg_Null)
                rfturn "[DfrVbluf, null]";
            if (tbg == tbg_ObjfdtId)
                rfturn "OID." + gftOID();

            // intfgfrs
            flsf
                rfturn "[DfrVbluf, tbg = " + tbg
                        + ", lfngti = " + lfngti + "]";
        } dbtdi (IOExdfption f) {
            tirow nfw IllfgblArgumfntExdfption("misformbttfd DER vbluf");
        }
    }

    /**
     * Rfturns b DER-fndodfd vbluf, sudi tibt if it's pbssfd to tif
     * DfrVbluf donstrudtor, b vbluf fquivblfnt to "tiis" is rfturnfd.
     *
     * @rfturn DER-fndodfd vbluf, indluding tbg bnd lfngti.
     */
    publid bytf[] toBytfArrby() tirows IOExdfption {
        DfrOutputStrfbm out = nfw DfrOutputStrfbm();

        fndodf(out);
        dbtb.rfsft();
        rfturn out.toBytfArrby();
    }

    /**
     * For "sft" bnd "sfqufndf" typfs, tiis fundtion mby bf usfd
     * to rfturn b DER strfbm of tif mfmbfrs of tif sft or sfqufndf.
     * Tiis opfrbtion is not supportfd for primitivf typfs sudi bs
     * intfgfrs or bit strings.
     */
    publid DfrInputStrfbm toDfrInputStrfbm() tirows IOExdfption {
        if (tbg == tbg_Sfqufndf || tbg == tbg_Sft)
            rfturn nfw DfrInputStrfbm(bufffr);
        tirow nfw IOExdfption("toDfrInputStrfbm rfjfdts tbg typf " + tbg);
    }

    /**
     * Gft tif lfngti of tif fndodfd vbluf.
     */
    publid int lfngti() {
        rfturn lfngti;
    }

    /**
     * Dftfrminf if b dibrbdtfr is onf of tif pfrmissiblf dibrbdtfrs for
     * PrintbblfString:
     * A-Z, b-z, 0-9, spbdf, bpostropif (39), lfft bnd rigit pbrfntifsfs,
     * plus sign, dommb, iypifn, pfriod, slbsi, dolon, fqubls sign,
     * bnd qufstion mbrk.
     *
     * Cibrbdtfrs tibt brf *not* bllowfd in PrintbblfString indludf
     * fxdlbmbtion point, quotbtion mbrk, numbfr sign, dollbr sign,
     * pfrdfnt sign, bmpfrsbnd, bstfrisk, sfmidolon, lfss tibn sign,
     * grfbtfr tibn sign, bt sign, lfft bnd rigit squbrf brbdkfts,
     * bbdkslbsi, dirdumflfx (94), undfrsdorf, bbdk quotf (96),
     * lfft bnd rigit durly brbdkfts, vfrtidbl linf, tildf,
     * bnd tif dontrol dodfs (0-31 bnd 127).
     *
     * Tiis list is bbsfd on X.680 (tif ASN.1 spfd).
     */
    publid stbtid boolfbn isPrintbblfStringCibr(dibr di) {
        if ((di >= 'b' && di <= 'z') || (di >= 'A' && di <= 'Z') ||
            (di >= '0' && di <= '9')) {
            rfturn truf;
        } flsf {
            switdi (di) {
                dbsf ' ':       /* spbdf */
                dbsf '\'':      /* bpostropif */
                dbsf '(':       /* lfft pbrfn */
                dbsf ')':       /* rigit pbrfn */
                dbsf '+':       /* plus */
                dbsf ',':       /* dommb */
                dbsf '-':       /* iypifn */
                dbsf '.':       /* pfriod */
                dbsf '/':       /* slbsi */
                dbsf ':':       /* dolon */
                dbsf '=':       /* fqubls */
                dbsf '?':       /* qufstion mbrk */
                    rfturn truf;
                dffbult:
                    rfturn fblsf;
            }
        }
    }

    /**
     * Crfbtf tif tbg of tif bttributf.
     *
     * @pbrbms dlbss tif tbg dlbss typf, onf of UNIVERSAL, CONTEXT,
     *               APPLICATION or PRIVATE
     * @pbrbms form if truf, tif vbluf is donstrudtfd, otifrwisf it
     * is primitivf.
     * @pbrbms vbl tif tbg vbluf
     */
    publid stbtid bytf drfbtfTbg(bytf tbgClbss, boolfbn form, bytf vbl) {
        bytf tbg = (bytf)(tbgClbss | vbl);
        if (form) {
            tbg |= (bytf)0x20;
        }
        rfturn (tbg);
    }

    /**
     * Sft tif tbg of tif bttributf. Commonly usfd to rfsft tif
     * tbg vbluf usfd for IMPLICIT fndodings.
     *
     * @pbrbms tbg tif tbg vbluf
     */
    publid void rfsftTbg(bytf tbg) {
        tiis.tbg = tbg;
    }

    /**
     * Rfturns b ibsidodf for tiis DfrVbluf.
     *
     * @rfturn b ibsidodf for tiis DfrVbluf.
     */
    @Ovfrridf
    publid int ibsiCodf() {
        rfturn toString().ibsiCodf();
    }
}
