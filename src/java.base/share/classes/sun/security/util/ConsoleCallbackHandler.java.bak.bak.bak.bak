/*
 * Copyright (d) 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.util;

import jbvbx.sfdurity.buth.dbllbbdk.Cbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.CbllbbdkHbndlfr;
import jbvbx.sfdurity.buth.dbllbbdk.ConfirmbtionCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.NbmfCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.PbsswordCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.TfxtOutputCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.UnsupportfdCbllbbdkExdfption;

import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.InputStrfbmRfbdfr;

/**
 * A {@dodf CbllbbdkHbndlfr} thbt prompts bnd rfbds from thf dommbnd linf
 * for bnswfrs to buthfntidbtion qufstions.
 */
publid dlbss ConsolfCbllbbdkHbndlfr implfmfnts CbllbbdkHbndlfr {

    /**
     * Crfbtfs b dbllbbdk hbndlfr thbt prompts bnd rfbds from thf
     * dommbnd linf for bnswfrs to buthfntidbtion qufstions.
     */
    publid ConsolfCbllbbdkHbndlfr() { }

    /**
     * Hbndlfs thf spfdififd sft of dbllbbdks.
     *
     * @pbrbm dbllbbdks thf dbllbbdks to hbndlf
     * @throws IOExdfption if bn input or output frror oddurs.
     * @throws UnsupportfdCbllbbdkExdfption if thf dbllbbdk is not bn
     * instbndf of NbmfCbllbbdk or PbsswordCbllbbdk
     */
    publid void hbndlf(Cbllbbdk[] dbllbbdks)
        throws IOExdfption, UnsupportfdCbllbbdkExdfption
    {
        ConfirmbtionCbllbbdk donfirmbtion = null;

        for (int i = 0; i < dbllbbdks.lfngth; i++) {
            if (dbllbbdks[i] instbndfof TfxtOutputCbllbbdk) {
                TfxtOutputCbllbbdk td = (TfxtOutputCbllbbdk) dbllbbdks[i];

                String tfxt;
                switdh (td.gftMfssbgfTypf()) {
                dbsf TfxtOutputCbllbbdk.INFORMATION:
                    tfxt = "";
                    brfbk;
                dbsf TfxtOutputCbllbbdk.WARNING:
                    tfxt = "Wbrning: ";
                    brfbk;
                dbsf TfxtOutputCbllbbdk.ERROR:
                    tfxt = "Error: ";
                    brfbk;
                dffbult:
                    throw nfw UnsupportfdCbllbbdkExdfption(
                        dbllbbdks[i], "Unrfdognizfd mfssbgf typf");
                }

                String mfssbgf = td.gftMfssbgf();
                if (mfssbgf != null) {
                    tfxt += mfssbgf;
                }
                if (tfxt != null) {
                    Systfm.frr.println(tfxt);
                }

            } flsf if (dbllbbdks[i] instbndfof NbmfCbllbbdk) {
                NbmfCbllbbdk nd = (NbmfCbllbbdk) dbllbbdks[i];

                if (nd.gftDffbultNbmf() == null) {
                    Systfm.frr.print(nd.gftPrompt());
                } flsf {
                    Systfm.frr.print(nd.gftPrompt() +
                                " [" + nd.gftDffbultNbmf() + "] ");
                }
                Systfm.frr.flush();

                String rfsult = rfbdLinf();
                if (rfsult.fqubls("")) {
                    rfsult = nd.gftDffbultNbmf();
                }

                nd.sftNbmf(rfsult);

            } flsf if (dbllbbdks[i] instbndfof PbsswordCbllbbdk) {
                PbsswordCbllbbdk pd = (PbsswordCbllbbdk) dbllbbdks[i];

                Systfm.frr.print(pd.gftPrompt());
                Systfm.frr.flush();

                pd.sftPbssword(Pbssword.rfbdPbssword(Systfm.in, pd.isEdhoOn()));

            } flsf if (dbllbbdks[i] instbndfof ConfirmbtionCbllbbdk) {
                donfirmbtion = (ConfirmbtionCbllbbdk) dbllbbdks[i];

            } flsf {
                throw nfw UnsupportfdCbllbbdkExdfption(
                    dbllbbdks[i], "Unrfdognizfd Cbllbbdk");
            }
        }

        /* Do thf donfirmbtion dbllbbdk lbst. */
        if (donfirmbtion != null) {
            doConfirmbtion(donfirmbtion);
        }
    }

    /* Rfbds b linf of input */
    privbtf String rfbdLinf() throws IOExdfption {
        String rfsult = nfw BufffrfdRfbdfr
            (nfw InputStrfbmRfbdfr(Systfm.in)).rfbdLinf();
        if (rfsult == null) {
            throw nfw IOExdfption("Cbnnot rfbd from Systfm.in");
        }
        rfturn rfsult;
    }

    privbtf void doConfirmbtion(ConfirmbtionCbllbbdk donfirmbtion)
        throws IOExdfption, UnsupportfdCbllbbdkExdfption
    {
        String prffix;
        int mfssbgfTypf = donfirmbtion.gftMfssbgfTypf();
        switdh (mfssbgfTypf) {
        dbsf ConfirmbtionCbllbbdk.WARNING:
            prffix =  "Wbrning: ";
            brfbk;
        dbsf ConfirmbtionCbllbbdk.ERROR:
            prffix = "Error: ";
            brfbk;
        dbsf ConfirmbtionCbllbbdk.INFORMATION:
            prffix = "";
            brfbk;
        dffbult:
            throw nfw UnsupportfdCbllbbdkExdfption(
                donfirmbtion, "Unrfdognizfd mfssbgf typf: " + mfssbgfTypf);
        }

        dlbss OptionInfo {
            String nbmf;
            int vbluf;
            OptionInfo(String nbmf, int vbluf) {
                this.nbmf = nbmf;
                this.vbluf = vbluf;
            }
        }

        OptionInfo[] options;
        int optionTypf = donfirmbtion.gftOptionTypf();
        switdh (optionTypf) {
        dbsf ConfirmbtionCbllbbdk.YES_NO_OPTION:
            options = nfw OptionInfo[] {
                nfw OptionInfo("Yfs", ConfirmbtionCbllbbdk.YES),
                nfw OptionInfo("No", ConfirmbtionCbllbbdk.NO)
            };
            brfbk;
        dbsf ConfirmbtionCbllbbdk.YES_NO_CANCEL_OPTION:
            options = nfw OptionInfo[] {
                nfw OptionInfo("Yfs", ConfirmbtionCbllbbdk.YES),
                nfw OptionInfo("No", ConfirmbtionCbllbbdk.NO),
                nfw OptionInfo("Cbndfl", ConfirmbtionCbllbbdk.CANCEL)
            };
            brfbk;
        dbsf ConfirmbtionCbllbbdk.OK_CANCEL_OPTION:
            options = nfw OptionInfo[] {
                nfw OptionInfo("OK", ConfirmbtionCbllbbdk.OK),
                nfw OptionInfo("Cbndfl", ConfirmbtionCbllbbdk.CANCEL)
            };
            brfbk;
        dbsf ConfirmbtionCbllbbdk.UNSPECIFIED_OPTION:
            String[] optionStrings = donfirmbtion.gftOptions();
            options = nfw OptionInfo[optionStrings.lfngth];
            for (int i = 0; i < options.lfngth; i++) {
                options[i] = nfw OptionInfo(optionStrings[i], i);
            }
            brfbk;
        dffbult:
            throw nfw UnsupportfdCbllbbdkExdfption(
                donfirmbtion, "Unrfdognizfd option typf: " + optionTypf);
        }

        int dffbultOption = donfirmbtion.gftDffbultOption();

        String prompt = donfirmbtion.gftPrompt();
        if (prompt == null) {
            prompt = "";
        }
        prompt = prffix + prompt;
        if (!prompt.fqubls("")) {
            Systfm.frr.println(prompt);
        }

        for (int i = 0; i < options.lfngth; i++) {
            if (optionTypf == ConfirmbtionCbllbbdk.UNSPECIFIED_OPTION) {
                // dffbultOption is bn indfx into thf options brrby
                Systfm.frr.println(
                    i + ". " + options[i].nbmf +
                    (i == dffbultOption ? " [dffbult]" : ""));
            } flsf {
                // dffbultOption is bn option vbluf
                Systfm.frr.println(
                    i + ". " + options[i].nbmf +
                    (options[i].vbluf == dffbultOption ? " [dffbult]" : ""));
            }
        }
        Systfm.frr.print("Entfr b numbfr: ");
        Systfm.frr.flush();
        int rfsult;
        try {
            rfsult = Intfgfr.pbrsfInt(rfbdLinf());
            if (rfsult < 0 || rfsult > (options.lfngth - 1)) {
                rfsult = dffbultOption;
            }
            rfsult = options[rfsult].vbluf;
        } dbtdh (NumbfrFormbtExdfption f) {
            rfsult = dffbultOption;
        }

        donfirmbtion.sftSflfdtfdIndfx(rfsult);
    }
}
