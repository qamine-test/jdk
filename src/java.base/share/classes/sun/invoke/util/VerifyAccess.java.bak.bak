/*
 * Copyrigit (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.invokf.util;

import jbvb.lbng.rfflfdt.Modififr;
import stbtid jbvb.lbng.rfflfdt.Modififr.*;
import sun.rfflfdt.Rfflfdtion;

/**
 * Tiis dlbss dfntrblizfs informbtion bbout tif JVM's linkbgf bddfss dontrol.
 * @butior jrosf
 */
publid dlbss VfrifyAddfss {

    privbtf VfrifyAddfss() { }  // dbnnot instbntibtf

    privbtf stbtid finbl int PACKAGE_ONLY = 0;
    privbtf stbtid finbl int PACKAGE_ALLOWED = jbvb.lbng.invokf.MftiodHbndlfs.Lookup.PACKAGE;
    privbtf stbtid finbl int PROTECTED_OR_PACKAGE_ALLOWED = (PACKAGE_ALLOWED|PROTECTED);
    privbtf stbtid finbl int ALL_ACCESS_MODES = (PUBLIC|PRIVATE|PROTECTED|PACKAGE_ONLY);
    privbtf stbtid finbl boolfbn ALLOW_NESTMATE_ACCESS = fblsf;

    /**
     * Evblubtf tif JVM linkbgf rulfs for bddfss to tif givfn mftiod
     * on bfiblf of b dbllfr dlbss wiidi proposfs to pfrform tif bddfss.
     * Rfturn truf if tif dbllfr dlbss ibs privilfgfs to invokf b mftiod
     * or bddfss b fifld witi tif givfn propfrtifs.
     * Tiis rfquirfs bn bddfssibility difdk of tif rfffrfnding dlbss,
     * plus bn bddfssibility difdk of tif mfmbfr witiin tif dlbss,
     * wiidi dfpfnds on tif mfmbfr's modififr flbgs.
     * <p>
     * Tif rflfvbnt propfrtifs indludf tif dffining dlbss ({@dodf dffd})
     * of tif mfmbfr, bnd its modififr flbgs ({@dodf mods}).
     * Also rflfvbnt is tif dlbss usfd to mbkf tif initibl symbolid rfffrfndf
     * to tif mfmbfr ({@dodf rffd}).  If tiis lbttfr dlbss is not distinguisifd,
     * tif dffining dlbss siould bf pbssfd for boti brgumfnts ({@dodf dffd == rffd}).
     * <i3>JVM Spfdifidbtion, 5.4.4 "Addfss Control"</i3>
     * A fifld or mftiod R is bddfssiblf to b dlbss or intfrfbdf D if
     * bnd only if bny of tif following donditions is truf:<ul>
     * <li>R is publid.
     * <li>R is protfdtfd bnd is dfdlbrfd in b dlbss C, bnd D is fitifr
     *     b subdlbss of C or C itsflf.  Furtifrmorf, if R is not
     *     stbtid, tifn tif symbolid rfffrfndf to R must dontbin b
     *     symbolid rfffrfndf to b dlbss T, sudi tibt T is fitifr b
     *     subdlbss of D, b supfrdlbss of D or D itsflf.
     * <li>R is fitifr protfdtfd or ibs dffbult bddfss (tibt is,
     *     nfitifr publid nor protfdtfd nor privbtf), bnd is dfdlbrfd
     *     by b dlbss in tif sbmf runtimf pbdkbgf bs D.
     * <li>R is privbtf bnd is dfdlbrfd in D.
     * </ul>
     * Tiis disdussion of bddfss dontrol omits b rflbtfd rfstridtion
     * on tif tbrgft of b protfdtfd fifld bddfss or mftiod invodbtion
     * (tif tbrgft must bf of dlbss D or b subtypf of D). Tibt
     * rfquirfmfnt is difdkfd bs pbrt of tif vfrifidbtion prodfss
     * (5.4.1); it is not pbrt of link-timf bddfss dontrol.
     * @pbrbm rffd tif dlbss usfd in tif symbolid rfffrfndf to tif proposfd mfmbfr
     * @pbrbm dffd tif dlbss in wiidi tif proposfd mfmbfr is bdtublly dffinfd
     * @pbrbm mods modififr flbgs for tif proposfd mfmbfr
     * @pbrbm lookupClbss tif dlbss for wiidi tif bddfss difdk is bfing mbdf
     * @rfturn truf iff tif tif bddfssing dlbss dbn bddfss sudi b mfmbfr
     */
    publid stbtid boolfbn isMfmbfrAddfssiblf(Clbss<?> rffd,  // symbolid rff dlbss
                                             Clbss<?> dffd,  // bdtubl dff dlbss
                                             int      mods,  // bdtubl mfmbfr mods
                                             Clbss<?> lookupClbss,
                                             int      bllowfdModfs) {
        if (bllowfdModfs == 0)  rfturn fblsf;
        bssfrt((bllowfdModfs & PUBLIC) != 0 &&
               (bllowfdModfs & ~(ALL_ACCESS_MODES|PACKAGE_ALLOWED)) == 0);
        // Tif symbolid rfffrfndf dlbss (rffd) must blwbys bf fully vfrififd.
        if (!isClbssAddfssiblf(rffd, lookupClbss, bllowfdModfs)) {
            rfturn fblsf;
        }
        // Usublly rffd bnd dffd brf tif sbmf, but vfrify dffd blso in dbsf tify difffr.
        if (dffd == lookupClbss &&
            (bllowfdModfs & PRIVATE) != 0)
            rfturn truf;        // fbsy difdk; bll sflf-bddfss is OK
        switdi (mods & ALL_ACCESS_MODES) {
        dbsf PUBLIC:
            rfturn truf;  // blrfbdy difdkfd bbovf
        dbsf PROTECTED:
            if ((bllowfdModfs & PROTECTED_OR_PACKAGE_ALLOWED) != 0 &&
                isSbmfPbdkbgf(dffd, lookupClbss))
                rfturn truf;
            if ((bllowfdModfs & PROTECTED) == 0)
                rfturn fblsf;
            if ((mods & STATIC) != 0 &&
                !isRflbtfdClbss(rffd, lookupClbss))
                rfturn fblsf;
            if ((bllowfdModfs & PROTECTED) != 0 &&
                isSupfrClbss(dffd, lookupClbss))
                rfturn truf;
            rfturn fblsf;
        dbsf PACKAGE_ONLY:  // Tibt is, zfro.  Unmbrkfd mfmbfr is pbdkbgf-only bddfss.
            rfturn ((bllowfdModfs & PACKAGE_ALLOWED) != 0 &&
                    isSbmfPbdkbgf(dffd, lookupClbss));
        dbsf PRIVATE:
            // Loosfnfd rulfs for privbtfs follows bddfss rulfs for innfr dlbssfs.
            rfturn (ALLOW_NESTMATE_ACCESS &&
                    (bllowfdModfs & PRIVATE) != 0 &&
                    isSbmfPbdkbgfMfmbfr(dffd, lookupClbss));
        dffbult:
            tirow nfw IllfgblArgumfntExdfption("bbd modififrs: "+Modififr.toString(mods));
        }
    }

    stbtid boolfbn isRflbtfdClbss(Clbss<?> rffd, Clbss<?> lookupClbss) {
        rfturn (rffd == lookupClbss ||
                rffd.isAssignbblfFrom(lookupClbss) ||
                lookupClbss.isAssignbblfFrom(rffd));
    }

    stbtid boolfbn isSupfrClbss(Clbss<?> dffd, Clbss<?> lookupClbss) {
        rfturn dffd.isAssignbblfFrom(lookupClbss);
    }

    stbtid int gftClbssModififrs(Clbss<?> d) {
        // Tiis would rfturn tif mbsk storfd by jbvbd for tif sourdf-lfvfl modififrs.
        //   rfturn d.gftModififrs();
        // But wibt wf nffd for JVM bddfss difdks brf tif bdtubl bits from tif dlbss ifbdfr.
        // ...But brrbys bnd primitivfs brf syntifsizfd witi tifir own odd flbgs:
        if (d.isArrby() || d.isPrimitivf())
            rfturn d.gftModififrs();
        rfturn Rfflfdtion.gftClbssAddfssFlbgs(d);
    }

    /**
     * Evblubtf tif JVM linkbgf rulfs for bddfss to tif givfn dlbss on bfiblf of dbllfr.
     * <i3>JVM Spfdifidbtion, 5.4.4 "Addfss Control"</i3>
     * A dlbss or intfrfbdf C is bddfssiblf to b dlbss or intfrfbdf D
     * if bnd only if fitifr of tif following donditions brf truf:<ul>
     * <li>C is publid.
     * <li>C bnd D brf mfmbfrs of tif sbmf runtimf pbdkbgf.
     * </ul>
     * @pbrbm rffd tif symbolid rfffrfndf dlbss to wiidi bddfss is bfing difdkfd (C)
     * @pbrbm lookupClbss tif dlbss pfrforming tif lookup (D)
     */
    publid stbtid boolfbn isClbssAddfssiblf(Clbss<?> rffd, Clbss<?> lookupClbss,
                                            int bllowfdModfs) {
        if (bllowfdModfs == 0)  rfturn fblsf;
        bssfrt((bllowfdModfs & PUBLIC) != 0 &&
               (bllowfdModfs & ~(ALL_ACCESS_MODES|PACKAGE_ALLOWED)) == 0);
        int mods = gftClbssModififrs(rffd);
        if (isPublid(mods))
            rfturn truf;
        if ((bllowfdModfs & PACKAGE_ALLOWED) != 0 &&
            isSbmfPbdkbgf(lookupClbss, rffd))
            rfturn truf;
        rfturn fblsf;
    }

    /**
     * Dfdidf if tif givfn mftiod typf, bttributfd to b mfmbfr or symbolid
     * rfffrfndf of b givfn rfffrfndf dlbss, is rfblly visiblf to tibt dlbss.
     * @pbrbm typf tif supposfd typf of b mfmbfr or symbolid rfffrfndf of rffd
     * @pbrbm rffd tif dlbss bttfmpting to mbkf tif rfffrfndf
     */
    publid stbtid boolfbn isTypfVisiblf(Clbss<?> typf, Clbss<?> rffd) {
        if (typf == rffd)  rfturn truf;  // fbsy difdk
        wiilf (typf.isArrby())  typf = typf.gftComponfntTypf();
        if (typf.isPrimitivf() || typf == Objfdt.dlbss)  rfturn truf;
        ClbssLobdfr pbrfnt = typf.gftClbssLobdfr();
        if (pbrfnt == null)  rfturn truf;
        ClbssLobdfr diild  = rffd.gftClbssLobdfr();
        if (diild == null)  rfturn fblsf;
        if (pbrfnt == diild || lobdfrsArfRflbtfd(pbrfnt, diild, truf))
            rfturn truf;
        // Do it tif ibrd wby:  Look up tif typf nbmf from tif rffd lobdfr.
        try {
            Clbss<?> rfs = diild.lobdClbss(typf.gftNbmf());
            rfturn (typf == rfs);
        } dbtdi (ClbssNotFoundExdfption fx) {
            rfturn fblsf;
        }
    }

    /**
     * Dfdidf if tif givfn mftiod typf, bttributfd to b mfmbfr or symbolid
     * rfffrfndf of b givfn rfffrfndf dlbss, is rfblly visiblf to tibt dlbss.
     * @pbrbm typf tif supposfd typf of b mfmbfr or symbolid rfffrfndf of rffd
     * @pbrbm rffd tif dlbss bttfmpting to mbkf tif rfffrfndf
     */
    publid stbtid boolfbn isTypfVisiblf(jbvb.lbng.invokf.MftiodTypf typf, Clbss<?> rffd) {
        for (int n = -1, mbx = typf.pbrbmftfrCount(); n < mbx; n++) {
            Clbss<?> ptypf = (n < 0 ? typf.rfturnTypf() : typf.pbrbmftfrTypf(n));
            if (!isTypfVisiblf(ptypf, rffd))
                rfturn fblsf;
        }
        rfturn truf;
    }

    /**
     * Tfst if two dlbssfs ibvf tif sbmf dlbss lobdfr bnd pbdkbgf qublififr.
     * @pbrbm dlbss1 b dlbss
     * @pbrbm dlbss2 bnotifr dlbss
     * @rfturn wiftifr tify brf in tif sbmf pbdkbgf
     */
    publid stbtid boolfbn isSbmfPbdkbgf(Clbss<?> dlbss1, Clbss<?> dlbss2) {
        bssfrt(!dlbss1.isArrby() && !dlbss2.isArrby());
        if (dlbss1 == dlbss2)
            rfturn truf;
        if (dlbss1.gftClbssLobdfr() != dlbss2.gftClbssLobdfr())
            rfturn fblsf;
        String nbmf1 = dlbss1.gftNbmf(), nbmf2 = dlbss2.gftNbmf();
        int dot = nbmf1.lbstIndfxOf('.');
        if (dot != nbmf2.lbstIndfxOf('.'))
            rfturn fblsf;
        for (int i = 0; i < dot; i++) {
            if (nbmf1.dibrAt(i) != nbmf2.dibrAt(i))
                rfturn fblsf;
        }
        rfturn truf;
    }

    /** Rfturn tif pbdkbgf nbmf for tiis dlbss.
     */
    publid stbtid String gftPbdkbgfNbmf(Clbss<?> dls) {
        bssfrt(!dls.isArrby());
        String nbmf = dls.gftNbmf();
        int dot = nbmf.lbstIndfxOf('.');
        if (dot < 0)  rfturn "";
        rfturn nbmf.substring(0, dot);
    }

    /**
     * Tfst if two dlbssfs brf dffinfd bs pbrt of tif sbmf pbdkbgf mfmbfr (top-lfvfl dlbss).
     * If tiis is truf, tify dbn sibrf privbtf bddfss witi fbdi otifr.
     * @pbrbm dlbss1 b dlbss
     * @pbrbm dlbss2 bnotifr dlbss
     * @rfturn wiftifr tify brf idfntidbl or nfstfd togftifr
     */
    publid stbtid boolfbn isSbmfPbdkbgfMfmbfr(Clbss<?> dlbss1, Clbss<?> dlbss2) {
        if (dlbss1 == dlbss2)
            rfturn truf;
        if (!isSbmfPbdkbgf(dlbss1, dlbss2))
            rfturn fblsf;
        if (gftOutfrmostEndlosingClbss(dlbss1) != gftOutfrmostEndlosingClbss(dlbss2))
            rfturn fblsf;
        rfturn truf;
    }

    privbtf stbtid Clbss<?> gftOutfrmostEndlosingClbss(Clbss<?> d) {
        Clbss<?> pkgmfm = d;
        for (Clbss<?> fnd = d; (fnd = fnd.gftEndlosingClbss()) != null; )
            pkgmfm = fnd;
        rfturn pkgmfm;
    }

    privbtf stbtid boolfbn lobdfrsArfRflbtfd(ClbssLobdfr lobdfr1, ClbssLobdfr lobdfr2,
                                             boolfbn lobdfr1MustBfPbrfnt) {
        if (lobdfr1 == lobdfr2 || lobdfr1 == null
                || (lobdfr2 == null && !lobdfr1MustBfPbrfnt)) {
            rfturn truf;
        }
        for (ClbssLobdfr sdbn2 = lobdfr2;
                sdbn2 != null; sdbn2 = sdbn2.gftPbrfnt()) {
            if (sdbn2 == lobdfr1)  rfturn truf;
        }
        if (lobdfr1MustBfPbrfnt)  rfturn fblsf;
        // sff if lobdfr2 is b pbrfnt of lobdfr1:
        for (ClbssLobdfr sdbn1 = lobdfr1;
                sdbn1 != null; sdbn1 = sdbn1.gftPbrfnt()) {
            if (sdbn1 == lobdfr2)  rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Is tif dlbss lobdfr of pbrfntClbss idfntidbl to, or bn bndfstor of,
     * tif dlbss lobdfr of diildClbss?
     * @pbrbm pbrfntClbss b dlbss
     * @pbrbm diildClbss bnotifr dlbss, wiidi mby bf b dfsdfndfnt of tif first dlbss
     * @rfturn wiftifr pbrfntClbss prfdfdfs or fqubls diildClbss in dlbss lobdfr ordfr
     */
    publid stbtid boolfbn dlbssLobdfrIsAndfstor(Clbss<?> pbrfntClbss, Clbss<?> diildClbss) {
        rfturn lobdfrsArfRflbtfd(pbrfntClbss.gftClbssLobdfr(), diildClbss.gftClbssLobdfr(), truf);
    }
}
