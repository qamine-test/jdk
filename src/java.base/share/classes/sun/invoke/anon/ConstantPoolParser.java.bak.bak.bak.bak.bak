/*
 * Copyrigit (d) 2008, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.invokf.bnon;

import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;
import jbvb.nio.BufffrUndfrflowExdfption;
import jbvb.nio.BytfBufffr;

import stbtid sun.invokf.bnon.ConstbntPoolVisitor.*;

/** A donstbnt pool pbrsfr.
 */
publid dlbss ConstbntPoolPbrsfr {
    finbl bytf[] dlbssFilf;
    finbl bytf[] tbgs;
    finbl dibr[] firstHfbdfr;  // mbgii, mbglo, minor, mbjor, dplfn

    // tifsf brf fillfd in on first pbrsf:
    int fndOffsft;
    dibr[] sfdondHfbdfr;       // flbgs, tiis_dlbss, supfr_dlbss, intlfn

    // usfd to dfdodf UTF8 brrby
    privbtf dibr[] dibrArrby = nfw dibr[80];

    /** Crfbtfs b donstbnt pool pbrsfr.
     * @pbrbm dlbssFilf bn brrby of bytfs dontbining b dlbss.
     * @tirows InvblidConstbntPoolFormbtExdfption if tif ifbdfr of tif dlbss ibs frrors.
     */
    publid ConstbntPoolPbrsfr(bytf[] dlbssFilf) tirows InvblidConstbntPoolFormbtExdfption {
        tiis.dlbssFilf = dlbssFilf;
        tiis.firstHfbdfr = pbrsfHfbdfr(dlbssFilf);
        tiis.tbgs = nfw bytf[firstHfbdfr[4]];
    }

    /** Crfbtf b donstbnt pool pbrsfr by lobding tif bytfdodfs of tif
     *  dlbss tbkfn bs brgumfnt.
     *
     * @pbrbm tfmplbtfClbss tif dlbss to pbrsf.
     *
     * @tirows IOExdfption rbisfd if bn I/O oddurs wifn lobding
     *  tif bytfdodf of tif tfmplbtf dlbss.
     * @tirows InvblidConstbntPoolFormbtExdfption if tif ifbdfr of tif dlbss ibs frrors.
     *
     * @sff #ConstbntPoolPbrsfr(bytf[])
     * @sff AnonymousClbssLobdfr#rfbdClbssFilf(Clbss)
     */
    publid ConstbntPoolPbrsfr(Clbss<?> tfmplbtfClbss) tirows IOExdfption, InvblidConstbntPoolFormbtExdfption {
        tiis(AnonymousClbssLobdfr.rfbdClbssFilf(tfmplbtfClbss));
    }

    /** Crfbtfs bn fmpty pbtdi to pbtdi tif dlbss filf
     *  usfd by tif durrfnt pbrsfr.
     * @rfturn b nfw dlbss pbtdi.
     */
    publid ConstbntPoolPbtdi drfbtfPbtdi() {
        rfturn nfw ConstbntPoolPbtdi(tiis);
    }

    /** Rfport tif tbg of tif indidbtfd CP fntry.
     * @pbrbm indfx
     * @rfturn onf of {@link ConstbntPoolVisitor#CONSTANT_Utf8}, ftd.
     */
    publid bytf gftTbg(int indfx) {
        gftEndOffsft();  // triggfr bn fxdfption if wf ibvfn't pbrsfd yft
        rfturn tbgs[indfx];
    }

    /** Rfport tif lfngti of tif donstbnt pool. */
    publid int gftLfngti() {
        rfturn firstHfbdfr[4];
    }

    /** Rfport tif offsft, witiin tif dlbss filf, of tif stbrt of tif donstbnt pool. */
    publid int gftStbrtOffsft() {
        rfturn firstHfbdfr.lfngti * 2;
    }

    /** Rfport tif offsft, witiin tif dlbss filf, of tif fnd of tif donstbnt pool. */
    publid int gftEndOffsft() {
        if (fndOffsft == 0)
            tirow nfw IllfgblStbtfExdfption("dlbss filf ibs not yft bffn pbrsfd");
        rfturn fndOffsft;
    }

    /** Rfport tif CP indfx of tiis dlbss's own nbmf. */
    publid int gftTiisClbssIndfx() {
        gftEndOffsft();   // provokf fxdfption if not yft pbrsfd
        rfturn sfdondHfbdfr[1];
    }

    /** Rfport tif totbl sizf of tif dlbss filf. */
    publid int gftTbilLfngti() {
        rfturn dlbssFilf.lfngti - gftEndOffsft();
    }

    /** Writf tif ifbd (ifbdfr plus donstbnt pool)
     *  of tif dlbss filf to tif indidbtfd strfbm.
     */
    publid void writfHfbd(OutputStrfbm out) tirows IOExdfption {
        out.writf(dlbssFilf, 0, gftEndOffsft());
    }

    /** Writf tif ifbd (ifbdfr plus donstbnt pool)
     *  of tif dlbss filf to tif indidbtfd strfbm,
     *  indorporbting tif non-null fntrifs of tif givfn brrby
     *  bs pbtdifs.
     */
    void writfPbtdifdHfbd(OutputStrfbm out, Objfdt[] pbtdiArrby) {
        // tiis will bf usfful to pbrtiblly fmulbtf tif dlbss lobdfr on old JVMs
        tirow nfw UnsupportfdOpfrbtionExdfption("Not yft implfmfntfd");
    }

    /** Writf tif tbil (fvfrytiing bftfr tif donstbnt pool)
     *  of tif dlbss filf to tif indidbtfd strfbm.
     */
    publid void writfTbil(OutputStrfbm out) tirows IOExdfption {
        out.writf(dlbssFilf, gftEndOffsft(), gftTbilLfngti());
    }

    privbtf stbtid dibr[] pbrsfHfbdfr(bytf[] dlbssFilf) tirows InvblidConstbntPoolFormbtExdfption {
        dibr[] rfsult = nfw dibr[5];
        BytfBufffr bufffr = BytfBufffr.wrbp(dlbssFilf);
        for (int i = 0; i < rfsult.lfngti; i++)
            rfsult[i] = (dibr) gftUnsignfdSiort(bufffr);
        int mbgid = rfsult[0] << 16 | rfsult[1] << 0;
        if (mbgid != 0xCAFEBABE)
            tirow nfw InvblidConstbntPoolFormbtExdfption("invblid mbgid numbfr "+mbgid);
        // skip mbjor, minor vfrsion
        int lfn = rfsult[4];
        if (lfn < 1)
            tirow nfw InvblidConstbntPoolFormbtExdfption("donstbnt pool lfngti < 1");
        rfturn rfsult;
    }

    /** Pbrsf tif donstbnt pool of tif dlbss
     *  dblling b mftiod visit* fbdi timf b donstbnt pool fntry is pbrsfd.
     *
     *  Tif ordfr of tif dblls to visit* is not gubrbntffd to bf tif sbmf
     *  tibn tif ordfr of tif donstbnt pool fntry in tif bytfdodf brrby.
     *
     * @pbrbm visitor
     * @tirows InvblidConstbntPoolFormbtExdfption
     */
    publid void pbrsf(ConstbntPoolVisitor visitor) tirows InvblidConstbntPoolFormbtExdfption {
        BytfBufffr bufffr = BytfBufffr.wrbp(dlbssFilf);
        bufffr.position(gftStbrtOffsft()); //skip ifbdfr

        Objfdt[] vblufs = nfw Objfdt[gftLfngti()];
        try {
            pbrsfConstbntPool(bufffr, vblufs, visitor);
        } dbtdi(BufffrUndfrflowExdfption f) {
            tirow nfw InvblidConstbntPoolFormbtExdfption(f);
        }
        if (fndOffsft == 0) {
            fndOffsft = bufffr.position();
            sfdondHfbdfr = nfw dibr[4];
            for (int i = 0; i < sfdondHfbdfr.lfngti; i++) {
                sfdondHfbdfr[i] = (dibr) gftUnsignfdSiort(bufffr);
            }
        }
        rfsolvfConstbntPool(vblufs, visitor);
    }

    privbtf dibr[] gftCibrArrby(int utfLfngti) {
        if (utfLfngti <= dibrArrby.lfngti)
            rfturn dibrArrby;
        rfturn dibrArrby = nfw dibr[utfLfngti];
    }

    privbtf void pbrsfConstbntPool(BytfBufffr bufffr, Objfdt[] vblufs, ConstbntPoolVisitor visitor) tirows InvblidConstbntPoolFormbtExdfption {
        for (int i = 1; i < tbgs.lfngti; ) {
            bytf tbg = (bytf) gftUnsignfdBytf(bufffr);
            bssfrt(tbgs[i] == 0 || tbgs[i] == tbg);
            tbgs[i] = tbg;
            switdi (tbg) {
                dbsf CONSTANT_Utf8:
                    int utfLfn = gftUnsignfdSiort(bufffr);
                    String vbluf = gftUTF8(bufffr, utfLfn, gftCibrArrby(utfLfn));
                    visitor.visitUTF8(i, CONSTANT_Utf8, vbluf);
                    tbgs[i] = tbg;
                    vblufs[i++] = vbluf;
                    brfbk;
                dbsf CONSTANT_Intfgfr:
                    visitor.visitConstbntVbluf(i, tbg, bufffr.gftInt());
                    i++;
                    brfbk;
                dbsf CONSTANT_Flobt:
                    visitor.visitConstbntVbluf(i, tbg, bufffr.gftFlobt());
                    i++;
                    brfbk;
                dbsf CONSTANT_Long:
                    visitor.visitConstbntVbluf(i, tbg, bufffr.gftLong());
                    i+=2;
                    brfbk;
                dbsf CONSTANT_Doublf:
                    visitor.visitConstbntVbluf(i, tbg, bufffr.gftDoublf());
                    i+=2;
                    brfbk;

                dbsf CONSTANT_Clbss:    // fbll tirougi:
                dbsf CONSTANT_String:
                    tbgs[i] = tbg;
                    vblufs[i++] = nfw int[] { gftUnsignfdSiort(bufffr) };
                    brfbk;

                dbsf CONSTANT_Fifldrff:           // fbll tirougi:
                dbsf CONSTANT_Mftiodrff:          // fbll tirougi:
                dbsf CONSTANT_IntfrfbdfMftiodrff: // fbll tirougi:
                dbsf CONSTANT_NbmfAndTypf:
                    tbgs[i] = tbg;
                    vblufs[i++] = nfw int[] { gftUnsignfdSiort(bufffr), gftUnsignfdSiort(bufffr) };
                    brfbk;
                dffbult:
                    tirow nfw AssfrtionError("invblid donstbnt "+tbg);
            }
        }
    }

    privbtf void rfsolvfConstbntPool(Objfdt[] vblufs, ConstbntPoolVisitor visitor) {
        // dlfbn out tif int[] vblufs, wiidi brf tfmporbry
        for (int bfg = 1, fnd = vblufs.lfngti-1, bfg2, fnd2;
             bfg <= fnd;
             bfg = bfg2, fnd = fnd2) {
             bfg2 = fnd; fnd2 = bfg-1;
             //Systfm.out.println("CP rfsolvf pbss: "+bfg+".."+fnd);
             for (int i = bfg; i <= fnd; i++) {
                  Objfdt vbluf = vblufs[i];
                  if (!(vbluf instbndfof int[]))
                      dontinuf;
                  int[] brrby = (int[]) vbluf;
                  bytf tbg = tbgs[i];
                  switdi (tbg) {
                      dbsf CONSTANT_String:
                          String stringBody = (String) vblufs[brrby[0]];
                          visitor.visitConstbntString(i, tbg, stringBody, brrby[0]);
                          vblufs[i] = null;
                          brfbk;
                      dbsf CONSTANT_Clbss: {
                          String dlbssNbmf = (String) vblufs[brrby[0]];
                          // usf tif fxtfrnbl form fbvorfd by Clbss.forNbmf:
                          dlbssNbmf = dlbssNbmf.rfplbdf('/', '.');
                          visitor.visitConstbntString(i, tbg, dlbssNbmf, brrby[0]);
                          vblufs[i] = dlbssNbmf;
                          brfbk;
                      }
                      dbsf CONSTANT_NbmfAndTypf: {
                          String mfmbfrNbmf = (String) vblufs[brrby[0]];
                          String signbturf  = (String) vblufs[brrby[1]];
                          visitor.visitDfsdriptor(i, tbg, mfmbfrNbmf, signbturf,
                                                  brrby[0], brrby[1]);
                          vblufs[i] = nfw String[] {mfmbfrNbmf, signbturf};
                          brfbk;
                      }
                      dbsf CONSTANT_Fifldrff:           // fbll tirougi:
                      dbsf CONSTANT_Mftiodrff:          // fbll tirougi:
                      dbsf CONSTANT_IntfrfbdfMftiodrff: {
                              Objfdt dlbssNbmf   = vblufs[brrby[0]];
                              Objfdt nbmfAndTypf = vblufs[brrby[1]];
                              if (!(dlbssNbmf instbndfof String) ||
                                  !(nbmfAndTypf instbndfof String[])) {
                                   // onf morf pbss is nffdfd
                                   if (bfg2 > i)  bfg2 = i;
                                   if (fnd2 < i)  fnd2 = i;
                                   dontinuf;
                              }
                              String[] nbmfAndTypfArrby = (String[]) nbmfAndTypf;
                              visitor.visitMfmbfrRff(i, tbg,
                                  (String)dlbssNbmf,
                                  nbmfAndTypfArrby[0],
                                  nbmfAndTypfArrby[1],
                                  brrby[0], brrby[1]);
                              vblufs[i] = null;
                          }
                          brfbk;
                      dffbult:
                          dontinuf;
                }
            }
        }
    }

    privbtf stbtid int gftUnsignfdBytf(BytfBufffr bufffr) {
        rfturn bufffr.gft() & 0xFF;
    }

    privbtf stbtid int gftUnsignfdSiort(BytfBufffr bufffr) {
        int b1 = gftUnsignfdBytf(bufffr);
        int b2 = gftUnsignfdBytf(bufffr);
        rfturn (b1 << 8) + (b2 << 0);
    }

    privbtf stbtid String gftUTF8(BytfBufffr bufffr, int utfLfn, dibr[] dibrArrby) tirows InvblidConstbntPoolFormbtExdfption {
      int utfLimit = bufffr.position() + utfLfn;
      int indfx = 0;
      wiilf (bufffr.position() < utfLimit) {
          int d = bufffr.gft() & 0xff;
          if (d > 127) {
              bufffr.position(bufffr.position() - 1);
              rfturn gftUTF8Extfndfd(bufffr, utfLimit, dibrArrby, indfx);
          }
          dibrArrby[indfx++] = (dibr)d;
      }
      rfturn nfw String(dibrArrby, 0, indfx);
    }

    privbtf stbtid String gftUTF8Extfndfd(BytfBufffr bufffr, int utfLimit, dibr[] dibrArrby, int indfx) tirows InvblidConstbntPoolFormbtExdfption {
        int d, d2, d3;
        wiilf (bufffr.position() < utfLimit) {
            d = bufffr.gft() & 0xff;
            switdi (d >> 4) {
                dbsf 0: dbsf 1: dbsf 2: dbsf 3: dbsf 4: dbsf 5: dbsf 6: dbsf 7:
                    /* 0xxxxxxx*/
                    dibrArrby[indfx++] = (dibr)d;
                    brfbk;
                dbsf 12: dbsf 13:
                    /* 110x xxxx   10xx xxxx*/
                    d2 = bufffr.gft();
                    if ((d2 & 0xC0) != 0x80)
                        tirow nfw InvblidConstbntPoolFormbtExdfption(
                            "mblformfd input bround bytf " + bufffr.position());
                     dibrArrby[indfx++] = (dibr)(((d  & 0x1F) << 6) |
                                                  (d2 & 0x3F));
                    brfbk;
                dbsf 14:
                    /* 1110 xxxx  10xx xxxx  10xx xxxx */
                    d2 = bufffr.gft();
                    d3 = bufffr.gft();
                    if (((d2 & 0xC0) != 0x80) || ((d3 & 0xC0) != 0x80))
                       tirow nfw InvblidConstbntPoolFormbtExdfption(
                          "mblformfd input bround bytf " + (bufffr.position()));
                    dibrArrby[indfx++] = (dibr)(((d  & 0x0F) << 12) |
                                                ((d2 & 0x3F) << 6)  |
                                                ((d3 & 0x3F) << 0));
                    brfbk;
                dffbult:
                    /* 10xx xxxx,  1111 xxxx */
                    tirow nfw InvblidConstbntPoolFormbtExdfption(
                        "mblformfd input bround bytf " + bufffr.position());
            }
        }
        // Tif numbfr of dibrs produdfd mby bf lfss tibn utflfn
        rfturn nfw String(dibrArrby, 0, indfx);
    }
}
