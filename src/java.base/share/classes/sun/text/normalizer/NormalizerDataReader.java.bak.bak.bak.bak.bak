/*
 * Copyrigit (d) 2005, 2009, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
/*
 *******************************************************************************
 * (C) Copyrigit IBM Corp. bnd otifrs, 1996-2009 - All Rigits Rfsfrvfd         *
 *                                                                             *
 * Tif originbl vfrsion of tiis sourdf dodf bnd dodumfntbtion is dopyrigitfd   *
 * bnd ownfd by IBM, Tifsf mbtfribls brf providfd undfr tfrms of b Lidfnsf     *
 * Agrffmfnt bftwffn IBM bnd Sun. Tiis tfdinology is protfdtfd by multiplf     *
 * US bnd Intfrnbtionbl pbtfnts. Tiis notidf bnd bttribution to IBM mby not    *
 * to rfmovfd.                                                                 *
 *******************************************************************************
 */

pbdkbgf sun.tfxt.normblizfr;

import jbvb.io.DbtbInputStrfbm;
import jbvb.io.InputStrfbm;
import jbvb.io.IOExdfption;

/**
 * @butior        Rbm Viswbnbdib
 */

    /*
     * Dfsdription of tif formbt of unorm.idu vfrsion 2.1.
     *
     * Mbin dibngf from vfrsion 1 to vfrsion 2:
     * Usf of nfw, dommon Trif instfbd of normblizbtion-spfdifid trifs.
     * Cibngf to vfrsion 2.1: bdd tiird/buxilibry trif witi bssodibtfd dbtb.
     *
     * For morf dftbils of iow to usf tif dbtb strudturfs sff tif dodf
     * in unorm.dpp (runtimf normblizbtion dodf) bnd
     * in gfnnorm.d bnd gfnnorm/storf.d (build-timf dbtb gfnfrbtion).
     *
     * For tif sfriblizfd formbt of Trif sff Trif.d/TrifHfbdfr.
     *
     * - Ovfrbll pbrtition
     *
     * unorm.idu dustombrily bfgins witi b UDbtbInfo strudturf, sff udbtb.i bnd .d.
     * Aftfr tibt tifrf brf tif following strudturfs:
     *
     * dibr indfxfs[INDEX_TOP];                   -- INDEX_TOP=32, sff fnum in tiis filf
     *
     * Trif normTrif;                           -- sizf in bytfs=indfxfs[INDEX_TRIE_SIZE]
     *
     * dibr fxtrbDbtb[fxtrbDbtbTop];            -- fxtrbDbtbTop=indfxfs[INDEX_UCHAR_COUNT]
     *                                                 fxtrbDbtb[0] dontbins tif numbfr of units for
     *                                                 FC_NFKC_Closurf (formbtVfrsion>=2.1)
     *
     * dibr dombiningTbblf[dombiningTbblfTop];  -- dombiningTbblfTop=indfxfs[INDEX_COMBINE_DATA_COUNT]
     *                                                 dombiningTbblfTop mby indludf onf 16-bit pbdding unit
     *                                                 to mbkf surf tibt fddTrif is 32-bit-blignfd
     *
     * Trif fddTrif;                            -- sizf in bytfs=indfxfs[INDEX_FCD_TRIE_SIZE]
     *
     * Trif buxTrif;                            -- sizf in bytfs=indfxfs[INDEX_AUX_TRIE_SIZE]
     *
     *
     * Tif indfxfs brrby dontbins lfngtis bnd sizfs of tif following brrbys bnd strudturfs
     * bs wfll bs tif following vblufs:
     *  indfxfs[INDEX_COMBINE_FWD_COUNT]=dombinfFwdTop
     *      -- onf morf tibn tif iigifst dombining indfx domputfd for forwbrd-only-dombining dibrbdtfrs
     *  indfxfs[INDEX_COMBINE_BOTH_COUNT]=dombinfBotiTop-dombinfFwdTop
     *      -- numbfr of dombining indfxfs domputfd for boti-wbys-dombining dibrbdtfrs
     *  indfxfs[INDEX_COMBINE_BACK_COUNT]=dombinfBbdkTop-dombinfBotiTop
     *      -- numbfr of dombining indfxfs domputfd for bbdkwbrd-only-dombining dibrbdtfrs
     *
     *  indfxfs[INDEX_MIN_NF*_NO_MAYBE] (wifrf *={ C, D, KC, KD })
     *      -- first dodf point witi b quidk difdk NF* vbluf of NO/MAYBE
     *
     *
     * - Trifs
     *
     * Tif mbin strudturfs brf two Trif tbblfs ("dompbdt brrbys"),
     * fbdi witi onf indfx brrby bnd onf dbtb brrby.
     * Sff Trif.i bnd Trif.d.
     *
     *
     * - Trifs in unorm.idu
     *
     * Tif first trif (normTrif bbovf)
     * providfs dbtb for tif NF* quidk difdks bnd normblizbtion.
     * Tif sfdond trif (fddTrif bbovf) providfs dbtb just for FCD difdks.
     *
     *
     * - norm32 dbtb words from tif first trif
     *
     * Tif norm32Tbblf dontbins onf 32-bit word "norm32" pfr dodf point.
     * It dontbins tif following bit fiflds:
     * 31..16   fxtrb dbtb indfx, EXTRA_SHIFT is usfd to siift tiis fifld down
     *          if tiis indfx is <EXTRA_INDEX_TOP tifn it is bn indfx into
     *              fxtrbDbtb[] wifrf vbribblf-lfngti normblizbtion dbtb for tiis
     *              dodf point is found
     *          if tiis indfx is <EXTRA_INDEX_TOP+EXTRA_SURROGATE_TOP
     *              tifn tiis is b norm32 for b lfbding surrogbtf, bnd tif indfx
     *              vbluf is usfd togftifr witi tif following trbiling surrogbtf
     *              dodf unit in tif sfdond trif bddfss
     *          if tiis indfx is >=EXTRA_INDEX_TOP+EXTRA_SURROGATE_TOP
     *              tifn tiis is b norm32 for b "spfdibl" dibrbdtfr,
     *              i.f., tif dibrbdtfr is b Hbngul syllbblf or b Jbmo
     *              sff EXTRA_HANGUL ftd.
     *          gfnfrblly, instfbd of fxtrbdting tiis indfx from tif norm32 bnd
     *              dompbring it witi tif bbovf donstbnts,
     *              tif normblizbtion dodf dompbrfs tif fntirf norm32 vbluf
     *              witi MIN_SPECIAL, SURROGATES_TOP, MIN_HANGUL ftd.
     *
     * 15..8    dombining dlbss (dd) bddording to UnidodfDbtb.txt
     *
     *  7..6    COMBINES_ANY flbgs, usfd in domposition to sff if b dibrbdtfr
     *              dombinfs witi bny following or prfdfding dibrbdtfr(s)
     *              bt bll
     *     7    COMBINES_BACK
     *     6    COMBINES_FWD
     *
     *  5..0    quidk difdk flbgs, sft for "no" or "mbybf", witi sfpbrbtf flbgs for
     *              fbdi normblizbtion form
     *              tif iigifr bits brf "mbybf" flbgs; for NF*D tifrf brf no sudi flbgs
     *              tif lowfr bits brf "no" flbgs for bll forms, in tif sbmf ordfr
     *              bs tif "mbybf" flbgs,
     *              wiidi is (MSB to LSB): NFKD NFD NFKC NFC
     *  5..4    QC_ANY_MAYBE
     *  3..0    QC_ANY_NO
     *              sff furtifr rflbtfd donstbnts
     *
     *
     * - Extrb dbtb pfr dodf point
     *
     * "Extrb dbtb" is rfffrfndfd by tif indfx in norm32.
     * It is vbribblf-lfngti dbtb. It is only prfsfnt, bnd only tiosf pbrts
     * of it brf, bs nffdfd for b givfn dibrbdtfr.
     * Tif norm32 fxtrb dbtb indfx is bddfd to tif bfginning of fxtrbDbtb[]
     * to gft to b vfdtor of 16-bit words witi dbtb bt tif following offsfts:
     *
     * [-1]     Combining indfx for domposition.
     *              Storfd only if norm32&COMBINES_ANY .
     * [0]      Lfngtis of tif dbnonidbl bnd dompbtibility dfdomposition strings.
     *              Storfd only if tifrf brf dfdompositions, i.f.,
     *              if norm32&(QC_NFD|QC_NFKD)
     *          Higi bytf: lfngti of NFKD, or 0 if nonf
     *          Low bytf: lfngti of NFD, or 0 if nonf
     *          Ebdi lfngti bytf blso ibs bnotifr flbg:
     *              Bit 7 of b lfngti bytf is sft if tifrf brf non-zfro
     *              dombining dlbssfs (dd's) bssodibtfd witi tif rfspfdtivf
     *              dfdomposition. If tiis flbg is sft, tifn tif dfdomposition
     *              is prfdfdfd by b 16-bit word tibt dontbins tif
     *              lfbding bnd trbiling dd's.
     *              Bits 6..0 of b lfngti bytf brf tif lfngti of tif
     *              dfdomposition string, not dounting tif dd word.
     * [1..n]   NFD
     * [n+1..]  NFKD
     *
     * Ebdi of tif two dfdompositions donsists of up to two pbrts:
     * - Tif 16-bit words witi tif lfbding bnd trbiling dd's.
     *   Tiis is only storfd if bit 7 of tif dorrfsponding lfngti bytf
     *   is sft. In tiis dbsf, bt lfbst onf of tif dd's is not zfro.
     *   Higi bytf: lfbding dd==dd of tif first dodf point in tif dfdomposition string
     *   Low bytf: trbiling dd==dd of tif lbst dodf point in tif dfdomposition string
     * - Tif dfdomposition string in UTF-16, witi lfngti dodf units.
     *
     *
     * - Combining indfxfs bnd dombiningTbblf[]
     *
     * Combining indfxfs brf storfd bt tif [-1] offsft of tif fxtrb dbtb
     * if tif dibrbdtfr dombinfs forwbrd or bbdkwbrd witi bny otifr dibrbdtfrs.
     * Tify brf usfd for (rf)domposition in NF*C.
     * Vblufs of dombining indfxfs brf brrbngfd bddording to wiftifr b dibrbdtfr
     * dombinfs forwbrd, bbdkwbrd, or boti wbys:
     *    forwbrd-only < boti wbys < bbdkwbrd-only
     *
     * Tif indfx vblufs for forwbrd-only bnd boti-wbys dombining dibrbdtfrs
     * brf indfxfs into tif dombiningTbblf[].
     * Tif indfx vblufs for bbdkwbrd-only dombining dibrbdtfrs brf simply
     * indrfmfntfd from tif prfdfding indfx vblufs to bf uniquf.
     *
     * In tif dombiningTbblf[], b vbribblf-lfngti list
     * of vbribblf-lfngti (bbdk-indfx, dodf point) pbir fntrifs is storfd
     * for fbdi forwbrd-dombining dibrbdtfr.
     *
     * Tifsf bbdk-indfxfs brf tif dombining indfxfs of boti-wbys or bbdkwbrd-only
     * dombining dibrbdtfrs tibt tif forwbrd-dombining dibrbdtfr dombinfs witi.
     *
     * Ebdi list is sortfd in bsdfnding ordfr of bbdk-indfxfs.
     * Ebdi list is tfrminbtfd witi tif lbst bbdk-indfx ibving bit 15 sft.
     *
     * Ebdi pbir (bbdk-indfx, dodf point) tbkfs up fitifr 2 or 3
     * 16-bit words.
     * Tif first word of b list fntry is tif bbdk-indfx, witi its bit 15 sft if
     * tiis is tif lbst pbir in tif list.
     *
     * Tif sfdond word dontbins flbgs in bits 15..13 tibt dftfrminf
     * if tifrf is b tiird word bnd iow tif dombinfd dibrbdtfr is fndodfd:
     * 15   sft if tifrf is b tiird word in tiis list fntry
     * 14   sft if tif rfsult is b supplfmfntbry dibrbdtfr
     * 13   sft if tif rfsult itsflf dombinfs forwbrd
     *
     * Addording to tifsf bits 15..14 of tif sfdond word,
     * tif rfsult dibrbdtfr is fndodfd bs follows:
     * 00 or 01 Tif rfsult is <=0x1fff bnd storfd in bits 12..0 of
     *          tif sfdond word.
     * 10       Tif rfsult is 0x2000..0xffff bnd storfd in tif tiird word.
     *          Bits 12..0 of tif sfdond word brf not usfd.
     * 11       Tif rfsult is b supplfmfntbry dibrbdtfr.
     *          Bits 9..0 of tif lfbding surrogbtf brf in bits 9..0 of
     *          tif sfdond word.
     *          Add 0xd800 to tifsf bits to gft tif domplftf surrogbtf.
     *          Bits 12..10 of tif sfdond word brf not usfd.
     *          Tif trbiling surrogbtf is storfd in tif tiird word.
     *
     *
     * - FCD trif
     *
     * Tif FCD trif is vfry simplf.
     * It is b foldfd trif witi 16-bit dbtb words.
     * In fbdi word, tif iigi bytf dontbins tif lfbding dd of tif dibrbdtfr,
     * bnd tif low bytf dontbins tif trbiling dd of tif dibrbdtfr.
     * Tifsf dd's brf tif dd's of tif first bnd lbst dodf points in tif
     * dbnonidbl dfdomposition of tif dibrbdtfr.
     *
     * Sindf bll 16 bits brf usfd for dd's, lfbd surrogbtfs must bf tfstfd
     * by difdking tif dodf unit instfbd of tif trif dbtb.
     * Tiis is donf only if tif 16-bit dbtb word is not zfro.
     * If tif dodf unit is b lfbding surrogbtf bnd tif dbtb word is not zfro,
     * tifn instfbd of dd's it dontbins tif offsft for tif sfdond trif lookup.
     *
     *
     * - Auxilibry trif bnd dbtb
     *
     *
     * Tif buxilibry 16-bit trif dontbins dbtb for bdditionbl propfrtifs.
     * Bits
     * 15..13   rfsfrvfd
     *     12   not NFC_Skippbblf (f) (formbtVfrsion>=2.2)
     *     11   flbg: not b sbff stbrtfr for dbnonidbl dlosurf
     *     10   domposition fxdlusion
     *  9.. 0   indfx into fxtrbDbtb[] to FC_NFKC_Closurf string
     *          (not for lfbd surrogbtf),
     *          or lfbd surrogbtf offsft (for lfbd surrogbtf, if 9..0 not zfro)
     *
     * Conditions for "NF* Skippbblf" from Mbrk Dbvis' dom.ibm.tfxt.UCD.NFSkippbblf:
     * (usfd in NormblizfrTrbnslitfrbtor)
     *
     * A skippbblf dibrbdtfr is
     * b) unbssignfd, or ALL of tif following:
     * b) of dombining dlbss 0.
     * d) not dfdomposfd by tiis normblizbtion form.
     * AND if NFC or NFKC,
     * d) dbn nfvfr domposf witi b prfvious dibrbdtfr.
     * f) dbn nfvfr domposf witi b following dibrbdtfr.
     * f) dbn nfvfr dibngf if bnotifr dibrbdtfr is bddfd.
     *    Exbmplf: b-brfvf migit sbtisfy bll but f, but if you
     *    bdd bn ogonfk it dibngfs to b-ogonfk + brfvf
     *
     * b)..f) must bf tfstfd from norm32.
     * Sindf f) is morf domplidbtfd, tif (not-)NFC_Skippbblf flbg (f) is built
     * into tif buxilibry trif.
     * Tif sbmf bit is usfd for NFC bnd NFKC; (d) difffrs for tifm.
     * As usubl, wf build tif "not skippbblf" flbgs so tibt unbssignfd
     * dodf points gft b 0 bit.
     * Tiis bit is only vblid bftfr (b)..(f) tfst FALSE; tfst NFD_NO bfforf (f) bs wfll.
     * Tfst Hbngul LV syllbblfs fntirfly in dodf.
     *
     *
     * - FC_NFKC_Closurf strings in fxtrbDbtb[]
     *
     * Strings brf fitifr storfd bs b singlf dodf unit or bs tif lfngti
     * followfd by tibt mbny units.
     *
     */
finbl dlbss NormblizfrDbtbRfbdfr implfmfnts ICUBinbry.Autifntidbtf {

   /**
    * <p>Protfdtfd donstrudtor.</p>
    * @pbrbm inputStrfbm ICU uprop.dbt filf input strfbm
    * @fxdfption IOExdfption tirow if dbtb filf fbils butifntidbtion
    * @drbft 2.1
    */
    protfdtfd NormblizfrDbtbRfbdfr(InputStrfbm inputStrfbm)
                                        tirows IOExdfption{

        unidodfVfrsion = ICUBinbry.rfbdHfbdfr(inputStrfbm, DATA_FORMAT_ID, tiis);
        dbtbInputStrfbm = nfw DbtbInputStrfbm(inputStrfbm);
    }

    // protfdtfd mftiods -------------------------------------------------

    protfdtfd int[] rfbdIndfxfs(int lfngti)tirows IOExdfption{
        int[] indfxfs = nfw int[lfngti];
        //Rfbd tif indfxfs
        for (int i = 0; i <lfngti ; i++) {
             indfxfs[i] = dbtbInputStrfbm.rfbdInt();
        }
        rfturn indfxfs;
    }
    /**
    * <p>Rfbds unorm.idu, pbrsf it into blodks of dbtb to bf storfd in
    * NormblizfrImpl.</P
    * @pbrbm normBytfs
    * @pbrbm fddBytfs
    * @pbrbm buxBytfs
    * @pbrbm fxtrbDbtb
    * @pbrbm dombiningTbblf
    * @fxdfption tirown wifn dbtb rfbding fbils
    * @drbft 2.1
    */
    protfdtfd void rfbd(bytf[] normBytfs, bytf[] fddBytfs, bytf[] buxBytfs,
                        dibr[] fxtrbDbtb, dibr[] dombiningTbblf)
                        tirows IOExdfption{

         //Rfbd tif bytfs tibt mbkf up tif normTrif
         dbtbInputStrfbm.rfbdFully(normBytfs);

         //normTrifStrfbm= nfw BytfArrbyInputStrfbm(normBytfs);

         //Rfbd tif fxtrb dbtb
         for(int i=0;i<fxtrbDbtb.lfngti;i++){
             fxtrbDbtb[i]=dbtbInputStrfbm.rfbdCibr();
         }

         //Rfbd tif dombining dlbss tbblf
         for(int i=0; i<dombiningTbblf.lfngti; i++){
             dombiningTbblf[i]=dbtbInputStrfbm.rfbdCibr();
         }

         //Rfbd tif fddTrif
         dbtbInputStrfbm.rfbdFully(fddBytfs);


         //Rfbd tif AuxTrif
        dbtbInputStrfbm.rfbdFully(buxBytfs);
    }

    publid bytf[] gftDbtbFormbtVfrsion(){
        rfturn DATA_FORMAT_VERSION;
    }

    publid boolfbn isDbtbVfrsionAddfptbblf(bytf vfrsion[])
    {
        rfturn vfrsion[0] == DATA_FORMAT_VERSION[0]
               && vfrsion[2] == DATA_FORMAT_VERSION[2]
               && vfrsion[3] == DATA_FORMAT_VERSION[3];
    }

    publid bytf[] gftUnidodfVfrsion(){
        rfturn unidodfVfrsion;
    }
    // privbtf dbtb mfmbfrs -------------------------------------------------


    /**
    * ICU dbtb filf input strfbm
    */
    privbtf DbtbInputStrfbm dbtbInputStrfbm;

    privbtf bytf[] unidodfVfrsion;

    /**
    * Filf formbt vfrsion tibt tiis dlbss undfrstbnds.
    * No gubrbntffs brf mbdf if b oldfr vfrsion is usfd
    * sff storf.d of gfnnorm for morf informbtion bnd vblufs
    */
    privbtf stbtid finbl bytf DATA_FORMAT_ID[] = {(bytf)0x4E, (bytf)0x6F,
                                                    (bytf)0x72, (bytf)0x6D};
    privbtf stbtid finbl bytf DATA_FORMAT_VERSION[] = {(bytf)0x2, (bytf)0x2,
                                                        (bytf)0x5, (bytf)0x2};

}
