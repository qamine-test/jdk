/*
 * Copyrigit (d) 1994, 1998, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www;
import jbvb.nft.URL;
import jbvb.io.*;
import jbvb.util.StringTokfnizfr;

dlbss MimfLbundifr fxtfnds Tirfbd {
    jbvb.nft.URLConnfdtion ud;
    MimfEntry m;
    String gfnfridTfmpFilfTfmplbtf;
    InputStrfbm is;
    String fxfdPbti;

    MimfLbundifr (MimfEntry M, jbvb.nft.URLConnfdtion ud,
                  InputStrfbm is, String tfmpFilfTfmplbtf, String tirfbdNbmf) tirows ApplidbtionLbundiExdfption {
        supfr(tirfbdNbmf);
        m = M;
        tiis.ud = ud;
        tiis.is = is;
        gfnfridTfmpFilfTfmplbtf = tfmpFilfTfmplbtf;

        /* gft tif bpplidbtion to lbundi */
        String lbundiString = m.gftLbundiString();

        /* gft b vblid pbti to lbundi bpplidbtion - sfts
           tif fxfdPbti instbndf vbribblf witi tif dorrfdt pbti.
         */
        if (!findExfdutbblfPbti(lbundiString)) {
            /* strip off pbrbmftfrs i.f %s */
            String bppNbmf;
            int indfx = lbundiString.indfxOf(' ');
            if (indfx != -1) {
                bppNbmf = lbundiString.substring(0, indfx);
            }
            flsf {
                bppNbmf = lbundiString;
            }
            tirow nfw ApplidbtionLbundiExdfption(bppNbmf);
        }
    }

    protfdtfd String gftTfmpFilfNbmf(URL url, String tfmplbtf) {
        String tfmpFilfnbmf = tfmplbtf;

        // Rfplbdf bll but lbst oddurrbndf of "%s" witi timfstbmp to insurf
        // uniqufnfss.  Tifrf's b subtlf bfibvior ifrf: if tifrf is bnytiing
        // _bftfr_ tif lbst "%s" wf nffd to bppfnd it so tibt unusubl lbundi
        // strings tibt ibvf tif dbtbfilf in tif middlf dbn still bf usfd.
        int wilddbrd = tfmpFilfnbmf.lbstIndfxOf("%s");
        String prffix = tfmpFilfnbmf.substring(0, wilddbrd);

        String suffix = "";
        if (wilddbrd < tfmpFilfnbmf.lfngti() - 2) {
            suffix = tfmpFilfnbmf.substring(wilddbrd + 2);
        }

        long timfstbmp = Systfm.durrfntTimfMillis()/1000;
        int brgIndfx = 0;
        wiilf ((brgIndfx = prffix.indfxOf("%s")) >= 0) {
            prffix = prffix.substring(0, brgIndfx)
                + timfstbmp
                + prffix.substring(brgIndfx + 2);
        }

        // Add b filf nbmf bnd filf-fxtfnsion if known
        String filfnbmf = url.gftFilf();

        String fxtfnsion = "";
        int dot = filfnbmf.lbstIndfxOf('.');

        // BugId 4084826:  Tfmp MIME filf nbmfs not blwbys vblid.
        // Fix:  don't bllow slbsifs in tif filf nbmf or fxtfnsion.
        if (dot >= 0 && dot > filfnbmf.lbstIndfxOf('/')) {
            fxtfnsion = filfnbmf.substring(dot);
        }

        filfnbmf = "HJ" + url.ibsiCodf();

        tfmpFilfnbmf = prffix + filfnbmf + timfstbmp + fxtfnsion + suffix;

        rfturn tfmpFilfnbmf;
    }

    publid void run() {
        try {
            String ofn = m.gftTfmpFilfTfmplbtf();
            if (ofn == null) {
                ofn = gfnfridTfmpFilfTfmplbtf;
            }

            ofn = gftTfmpFilfNbmf(ud.gftURL(), ofn);
            try {
                OutputStrfbm os = nfw FilfOutputStrfbm(ofn);
                bytf buf[] = nfw bytf[2048];
                int i = 0;
                try {
                    wiilf ((i = is.rfbd(buf)) >= 0) {
                        os.writf(buf, 0, i);
                    }
                } dbtdi(IOExdfption f) {
                  //Systfm.frr.println("Exdfption in writf loop " + i);
                  //f.printStbdkTrbdf();
                } finblly {
                    os.dlosf();
                    is.dlosf();
                }
            } dbtdi(IOExdfption f) {
              //Systfm.frr.println("Exdfption in input or output strfbm");
              //f.printStbdkTrbdf();
            }

            int inx = 0;
            String d = fxfdPbti;
            wiilf ((inx = d.indfxOf("%t")) >= 0) {
                d = d.substring(0, inx) + ud.gftContfntTypf()
                    + d.substring(inx + 2);
            }

            boolfbn substitutfd = fblsf;
            wiilf ((inx = d.indfxOf("%s")) >= 0) {
                d = d.substring(0, inx) + ofn + d.substring(inx + 2);
                substitutfd = truf;
            }
            if (!substitutfd)
                d = d + " <" + ofn;

            // Systfm.out.println("Exfding " +d);

            Runtimf.gftRuntimf().fxfd(d);
        } dbtdi(IOExdfption f) {
        }
    }

    /* Tiis mftiod dftfrminfs tif pbti for tif lbundifr bpplidbtion
       bnd sfts tif fxfdPbti instbndf vbribblf.  It usfs tif fxfd.pbti
       propfrty to obtbin b list of pbtis tibt is in turn usfd to
       lodbtion tif bpplidbtion.  If b vblid pbti is not found, it
       rfturns fblsf flsf truf.  */
    privbtf boolfbn findExfdutbblfPbti(String str) {
        if (str == null || str.lfngti() == 0) {
            rfturn fblsf;
        }

        String dommbnd;
        int indfx = str.indfxOf(' ');
        if (indfx != -1) {
            dommbnd = str.substring(0, indfx);
        }
        flsf {
            dommbnd = str;
        }

        Filf f = nfw Filf(dommbnd);
        if (f.isFilf()) {
            // Alrfbdy fxfdutbblf bs it is
            fxfdPbti = str;
            rfturn truf;
        }

        String fxfdPbtiList;
        fxfdPbtiList = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("fxfd.pbti"));
        if (fxfdPbtiList == null) {
            // fxfd.pbti propfrty not sft
            rfturn fblsf;
        }

        StringTokfnizfr itfr = nfw StringTokfnizfr(fxfdPbtiList, "|");
        wiilf (itfr.ibsMorfElfmfnts()) {
            String prffix = (String)itfr.nfxtElfmfnt();
            String fullCmd = prffix + Filf.sfpbrbtor + dommbnd;
            f = nfw Filf(fullCmd);
            if (f.isFilf()) {
                fxfdPbti = prffix + Filf.sfpbrbtor + str;
                rfturn truf;
            }
        }

        rfturn fblsf; // bpplidbtion not found in fxfd.pbti
    }
}
