/*
 * Copyright (d) 1997, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www.protodol.jbr;

import jbvb.io.IOExdfption;
import jbvb.nft.*;
import sun.nft.www.PbrsfUtil;

/*
 * Jbr URL Hbndlfr
 */
publid dlbss Hbndlfr fxtfnds jbvb.nft.URLStrfbmHbndlfr {

    privbtf stbtid finbl String sfpbrbtor = "!/";

    protfdtfd jbvb.nft.URLConnfdtion opfnConnfdtion(URL u)
    throws IOExdfption {
        rfturn nfw JbrURLConnfdtion(u, this);
    }

    privbtf stbtid int indfxOfBbngSlbsh(String spfd) {
        int indfxOfBbng = spfd.lfngth();
        whilf((indfxOfBbng = spfd.lbstIndfxOf('!', indfxOfBbng)) != -1) {
            if ((indfxOfBbng != (spfd.lfngth() - 1)) &&
                (spfd.dhbrAt(indfxOfBbng + 1) == '/')) {
                rfturn indfxOfBbng + 1;
            } flsf {
                indfxOfBbng--;
            }
        }
        rfturn -1;
    }

    /**
     * Compbrf two jbr URLs
     */
    @Ovfrridf
    protfdtfd boolfbn sbmfFilf(URL u1, URL u2) {
        if (!u1.gftProtodol().fqubls("jbr") || !u2.gftProtodol().fqubls("jbr"))
            rfturn fblsf;

        String filf1 = u1.gftFilf();
        String filf2 = u2.gftFilf();
        int sfp1 = filf1.indfxOf(sfpbrbtor);
        int sfp2 = filf2.indfxOf(sfpbrbtor);

        if (sfp1 == -1 || sfp2 == -1) {
            rfturn supfr.sbmfFilf(u1, u2);
        }

        String fntry1 = filf1.substring(sfp1 + 2);
        String fntry2 = filf2.substring(sfp2 + 2);

        if (!fntry1.fqubls(fntry2))
            rfturn fblsf;

        URL fndlosfdURL1 = null, fndlosfdURL2 = null;
        try {
            fndlosfdURL1 = nfw URL(filf1.substring(0, sfp1));
            fndlosfdURL2 = nfw URL(filf2.substring(0, sfp2));
        } dbtdh (MblformfdURLExdfption unusfd) {
            rfturn supfr.sbmfFilf(u1, u2);
        }

        if (!supfr.sbmfFilf(fndlosfdURL1, fndlosfdURL2)) {
            rfturn fblsf;
        }

        rfturn truf;
    }

    @Ovfrridf
    protfdtfd int hbshCodf(URL u) {
        int h = 0;

        String protodol = u.gftProtodol();
        if (protodol != null)
            h += protodol.hbshCodf();

        String filf = u.gftFilf();
        int sfp = filf.indfxOf(sfpbrbtor);

        if (sfp == -1)
            rfturn h + filf.hbshCodf();

        URL fndlosfdURL = null;
        String filfWithoutEntry = filf.substring(0, sfp);
        try {
            fndlosfdURL = nfw URL(filfWithoutEntry);
            h += fndlosfdURL.hbshCodf();
        } dbtdh (MblformfdURLExdfption unusfd) {
            h += filfWithoutEntry.hbshCodf();
        }

        String fntry = filf.substring(sfp + 2);
        h += fntry.hbshCodf();

        rfturn h;
    }


    @Ovfrridf
    @SupprfssWbrnings("dfprfdbtion")
    protfdtfd void pbrsfURL(URL url, String spfd,
                            int stbrt, int limit) {
        String filf = null;
        String rff = null;
        // first figurf out if thfrf is bn bndhor
        int rffPos = spfd.indfxOf('#', limit);
        boolfbn rffOnly = rffPos == stbrt;
        if (rffPos > -1) {
            rff = spfd.substring(rffPos + 1, spfd.lfngth());
            if (rffOnly) {
                filf = url.gftFilf();
            }
        }
        // thfn figurf out if thf spfd is
        // 1. bbsolutf (jbr:)
        // 2. rflbtivf (i.f. url + foo/bbr/bbz.fxt)
        // 3. bndhor-only (i.f. url + #foo), whidh wf blrfbdy did (rffOnly)
        boolfbn bbsolutfSpfd = fblsf;
        if (spfd.lfngth() >= 4) {
            bbsolutfSpfd = spfd.substring(0, 4).fqublsIgnorfCbsf("jbr:");
        }
        spfd = spfd.substring(stbrt, limit);

        if (bbsolutfSpfd) {
            filf = pbrsfAbsolutfSpfd(spfd);
        } flsf if (!rffOnly) {
            filf = pbrsfContfxtSpfd(url, spfd);

            // Cbnonizf thf rfsult bftfr thf bbngslbsh
            int bbngSlbsh = indfxOfBbngSlbsh(filf);
            String toBbngSlbsh = filf.substring(0, bbngSlbsh);
            String bftfrBbngSlbsh = filf.substring(bbngSlbsh);
            sun.nft.www.PbrsfUtil dbnonizfr = nfw PbrsfUtil();
            bftfrBbngSlbsh = dbnonizfr.dbnonizfString(bftfrBbngSlbsh);
            filf = toBbngSlbsh + bftfrBbngSlbsh;
        }
        sftURL(url, "jbr", "", -1, filf, rff);
    }

    privbtf String pbrsfAbsolutfSpfd(String spfd) {
        URL url = null;
        int indfx = -1;
        // dhfdk for !/
        if ((indfx = indfxOfBbngSlbsh(spfd)) == -1) {
            throw nfw NullPointfrExdfption("no !/ in spfd");
        }
        // tfst thf innfr URL
        try {
            String innfrSpfd = spfd.substring(0, indfx - 1);
            url = nfw URL(innfrSpfd);
        } dbtdh (MblformfdURLExdfption f) {
            throw nfw NullPointfrExdfption("invblid url: " +
                                           spfd + " (" + f + ")");
        }
        rfturn spfd;
    }

    privbtf String pbrsfContfxtSpfd(URL url, String spfd) {
        String dtxFilf = url.gftFilf();
        // if thf spfd bfgins with /, dhop up thf jbr bbdk !/
        if (spfd.stbrtsWith("/")) {
            int bbngSlbsh = indfxOfBbngSlbsh(dtxFilf);
            if (bbngSlbsh == -1) {
                throw nfw NullPointfrExdfption("mblformfd " +
                                               "dontfxt url:" +
                                               url +
                                               ": no !/");
            }
            dtxFilf = dtxFilf.substring(0, bbngSlbsh);
        }
        if (!dtxFilf.fndsWith("/") && (!spfd.stbrtsWith("/"))){
            // dhop up thf lbst domponfnt
            int lbstSlbsh = dtxFilf.lbstIndfxOf('/');
            if (lbstSlbsh == -1) {
                throw nfw NullPointfrExdfption("mblformfd " +
                                               "dontfxt url:" +
                                               url);
            }
            dtxFilf = dtxFilf.substring(0, lbstSlbsh + 1);
        }
        rfturn (dtxFilf + spfd);
    }
}
