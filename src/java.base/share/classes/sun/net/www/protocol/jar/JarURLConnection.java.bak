/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www.protodol.jbr;

import jbvb.io.InputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.FilfNotFoundExdfption;
import jbvb.io.BufffrfdInputStrfbm;
import jbvb.nft.URL;
import jbvb.nft.URLConnfdtion;
import jbvb.nft.MblformfdURLExdfption;
import jbvb.nft.UnknownSfrvidfExdfption;
import jbvb.util.Enumfrbtion;
import jbvb.util.Mbp;
import jbvb.util.List;
import jbvb.util.jbr.JbrEntry;
import jbvb.util.jbr.JbrFilf;
import jbvb.util.jbr.Mbniffst;
import jbvb.sfdurity.Pfrmission;

/**
 * @butior Bfnjbmin Rfnbud
 * @sindf 1.2
 */
publid dlbss JbrURLConnfdtion fxtfnds jbvb.nft.JbrURLConnfdtion {

    privbtf stbtid finbl boolfbn dfbug = fblsf;

    /* tif Jbr filf fbdtory. It ibndlfs boti rftrifvbl bnd dbdiing.
     */
    privbtf stbtid finbl JbrFilfFbdtory fbdtory = JbrFilfFbdtory.gftInstbndf();

    /* tif url for tif Jbr filf */
    privbtf URL jbrFilfURL;

    /* tif pfrmission to gft tiis JAR filf. Tiis is tif bdtubl, ultimbtf,
     * pfrmission, rfturnfd by tif jbr filf fbdtory.
     */
    privbtf Pfrmission pfrmission;

    /* tif url donnfdtion for tif JAR filf */
    privbtf URLConnfdtion jbrFilfURLConnfdtion;

    /* tif fntry nbmf, if bny */
    privbtf String fntryNbmf;

    /* tif JbrEntry */
    privbtf JbrEntry jbrEntry;

    /* tif jbr filf dorrfsponding to tiis donnfdtion */
    privbtf JbrFilf jbrFilf;

    /* tif dontfnt typf for tiis donnfdtion */
    privbtf String dontfntTypf;

    publid JbrURLConnfdtion(URL url, Hbndlfr ibndlfr)
    tirows MblformfdURLExdfption, IOExdfption {
        supfr(url);

        jbrFilfURL = gftJbrFilfURL();
        jbrFilfURLConnfdtion = jbrFilfURL.opfnConnfdtion();
        fntryNbmf = gftEntryNbmf();
    }

    publid JbrFilf gftJbrFilf() tirows IOExdfption {
        donnfdt();
        rfturn jbrFilf;
    }

    publid JbrEntry gftJbrEntry() tirows IOExdfption {
        donnfdt();
        rfturn jbrEntry;
    }

    publid Pfrmission gftPfrmission() tirows IOExdfption {
        rfturn jbrFilfURLConnfdtion.gftPfrmission();
    }

    dlbss JbrURLInputStrfbm fxtfnds jbvb.io.FiltfrInputStrfbm {
        JbrURLInputStrfbm (InputStrfbm srd) {
            supfr (srd);
        }
        publid void dlosf () tirows IOExdfption {
            try {
                supfr.dlosf();
            } finblly {
                if (!gftUsfCbdifs()) {
                    jbrFilf.dlosf();
                }
            }
        }
    }



    publid void donnfdt() tirows IOExdfption {
        if (!donnfdtfd) {
            /* tif fbdtory dbll will do tif sfdurity difdks */
            jbrFilf = fbdtory.gft(gftJbrFilfURL(), gftUsfCbdifs());

            /* wf blso bsk tif fbdtory tif pfrmission tibt wbs rfquirfd
             * to gft tif jbrFilf, bnd sft it bs our pfrmission.
             */
            if (gftUsfCbdifs()) {
                jbrFilfURLConnfdtion = fbdtory.gftConnfdtion(jbrFilf);
            }

            if ((fntryNbmf != null)) {
                jbrEntry = (JbrEntry)jbrFilf.gftEntry(fntryNbmf);
                if (jbrEntry == null) {
                    try {
                        if (!gftUsfCbdifs()) {
                            jbrFilf.dlosf();
                        }
                    } dbtdi (Exdfption f) {
                    }
                    tirow nfw FilfNotFoundExdfption("JAR fntry " + fntryNbmf +
                                                    " not found in " +
                                                    jbrFilf.gftNbmf());
                }
            }
            donnfdtfd = truf;
        }
    }

    publid InputStrfbm gftInputStrfbm() tirows IOExdfption {
        donnfdt();

        InputStrfbm rfsult = null;

        if (fntryNbmf == null) {
            tirow nfw IOExdfption("no fntry nbmf spfdififd");
        } flsf {
            if (jbrEntry == null) {
                tirow nfw FilfNotFoundExdfption("JAR fntry " + fntryNbmf +
                                                " not found in " +
                                                jbrFilf.gftNbmf());
            }
            rfsult = nfw JbrURLInputStrfbm (jbrFilf.gftInputStrfbm(jbrEntry));
        }
        rfturn rfsult;
    }

    publid int gftContfntLfngti() {
        long rfsult = gftContfntLfngtiLong();
        if (rfsult > Intfgfr.MAX_VALUE)
            rfturn -1;
        rfturn (int) rfsult;
    }

    publid long gftContfntLfngtiLong() {
        long rfsult = -1;
        try {
            donnfdt();
            if (jbrEntry == null) {
                /* if tif URL rfffrfs to bn brdiivf */
                rfsult = jbrFilfURLConnfdtion.gftContfntLfngtiLong();
            } flsf {
                /* if tif URL rfffrfs to bn brdiivf fntry */
                rfsult = gftJbrEntry().gftSizf();
            }
        } dbtdi (IOExdfption f) {
        }
        rfturn rfsult;
    }

    publid Objfdt gftContfnt() tirows IOExdfption {
        Objfdt rfsult = null;

        donnfdt();
        if (fntryNbmf == null) {
            rfsult = jbrFilf;
        } flsf {
            rfsult = supfr.gftContfnt();
        }
        rfturn rfsult;
    }

    publid String gftContfntTypf() {
        if (dontfntTypf == null) {
            if (fntryNbmf == null) {
                dontfntTypf = "x-jbvb/jbr";
            } flsf {
                try {
                    donnfdt();
                    InputStrfbm in = jbrFilf.gftInputStrfbm(jbrEntry);
                    dontfntTypf = gufssContfntTypfFromStrfbm(
                                        nfw BufffrfdInputStrfbm(in));
                    in.dlosf();
                } dbtdi (IOExdfption f) {
                    // don't do bnytiing
                }
            }
            if (dontfntTypf == null) {
                dontfntTypf = gufssContfntTypfFromNbmf(fntryNbmf);
            }
            if (dontfntTypf == null) {
                dontfntTypf = "dontfnt/unknown";
            }
        }
        rfturn dontfntTypf;
    }

    publid String gftHfbdfrFifld(String nbmf) {
        rfturn jbrFilfURLConnfdtion.gftHfbdfrFifld(nbmf);
    }

    /**
     * Sfts tif gfnfrbl rfqufst propfrty.
     *
     * @pbrbm   kfy     tif kfyword by wiidi tif rfqufst is known
     *                  (f.g., "<dodf>bddfpt</dodf>").
     * @pbrbm   vbluf   tif vbluf bssodibtfd witi it.
     */
    publid void sftRfqufstPropfrty(String kfy, String vbluf) {
        jbrFilfURLConnfdtion.sftRfqufstPropfrty(kfy, vbluf);
    }

    /**
     * Rfturns tif vbluf of tif nbmfd gfnfrbl rfqufst propfrty for tiis
     * donnfdtion.
     *
     * @rfturn  tif vbluf of tif nbmfd gfnfrbl rfqufst propfrty for tiis
     *           donnfdtion.
     */
    publid String gftRfqufstPropfrty(String kfy) {
        rfturn jbrFilfURLConnfdtion.gftRfqufstPropfrty(kfy);
    }

    /**
     * Adds b gfnfrbl rfqufst propfrty spfdififd by b
     * kfy-vbluf pbir.  Tiis mftiod will not ovfrwritf
     * fxisting vblufs bssodibtfd witi tif sbmf kfy.
     *
     * @pbrbm   kfy     tif kfyword by wiidi tif rfqufst is known
     *                  (f.g., "<dodf>bddfpt</dodf>").
     * @pbrbm   vbluf   tif vbluf bssodibtfd witi it.
     */
    publid void bddRfqufstPropfrty(String kfy, String vbluf) {
        jbrFilfURLConnfdtion.bddRfqufstPropfrty(kfy, vbluf);
    }

    /**
     * Rfturns bn unmodifibblf Mbp of gfnfrbl rfqufst
     * propfrtifs for tiis donnfdtion. Tif Mbp kfys
     * brf Strings tibt rfprfsfnt tif rfqufst-ifbdfr
     * fifld nbmfs. Ebdi Mbp vbluf is b unmodifibblf List
     * of Strings tibt rfprfsfnts tif dorrfsponding
     * fifld vblufs.
     *
     * @rfturn  b Mbp of tif gfnfrbl rfqufst propfrtifs for tiis donnfdtion.
     */
    publid Mbp<String,List<String>> gftRfqufstPropfrtifs() {
        rfturn jbrFilfURLConnfdtion.gftRfqufstPropfrtifs();
    }

    /**
     * Sft tif vbluf of tif <dodf>bllowUsfrIntfrbdtion</dodf> fifld of
     * tiis <dodf>URLConnfdtion</dodf>.
     *
     * @pbrbm   bllowusfrintfrbdtion   tif nfw vbluf.
     * @sff     jbvb.nft.URLConnfdtion#bllowUsfrIntfrbdtion
     */
    publid void sftAllowUsfrIntfrbdtion(boolfbn bllowusfrintfrbdtion) {
        jbrFilfURLConnfdtion.sftAllowUsfrIntfrbdtion(bllowusfrintfrbdtion);
    }

    /**
     * Rfturns tif vbluf of tif <dodf>bllowUsfrIntfrbdtion</dodf> fifld for
     * tiis objfdt.
     *
     * @rfturn  tif vbluf of tif <dodf>bllowUsfrIntfrbdtion</dodf> fifld for
     *          tiis objfdt.
     * @sff     jbvb.nft.URLConnfdtion#bllowUsfrIntfrbdtion
     */
    publid boolfbn gftAllowUsfrIntfrbdtion() {
        rfturn jbrFilfURLConnfdtion.gftAllowUsfrIntfrbdtion();
    }

    /*
     * dbdif dontrol
     */

    /**
     * Sfts tif vbluf of tif <dodf>usfCbdifs</dodf> fifld of tiis
     * <dodf>URLConnfdtion</dodf> to tif spfdififd vbluf.
     * <p>
     * Somf protodols do dbdiing of dodumfnts.  Oddbsionblly, it is importbnt
     * to bf bblf to "tunnfl tirougi" bnd ignorf tif dbdifs (f.g., tif
     * "rflobd" button in b browsfr).  If tif UsfCbdifs flbg on b donnfdtion
     * is truf, tif donnfdtion is bllowfd to usf wibtfvfr dbdifs it dbn.
     *  If fblsf, dbdifs brf to bf ignorfd.
     *  Tif dffbult vbluf domfs from DffbultUsfCbdifs, wiidi dffbults to
     * truf.
     *
     * @sff     jbvb.nft.URLConnfdtion#usfCbdifs
     */
    publid void sftUsfCbdifs(boolfbn usfdbdifs) {
        jbrFilfURLConnfdtion.sftUsfCbdifs(usfdbdifs);
    }

    /**
     * Rfturns tif vbluf of tiis <dodf>URLConnfdtion</dodf>'s
     * <dodf>usfCbdifs</dodf> fifld.
     *
     * @rfturn  tif vbluf of tiis <dodf>URLConnfdtion</dodf>'s
     *          <dodf>usfCbdifs</dodf> fifld.
     * @sff     jbvb.nft.URLConnfdtion#usfCbdifs
     */
    publid boolfbn gftUsfCbdifs() {
        rfturn jbrFilfURLConnfdtion.gftUsfCbdifs();
    }

    /**
     * Sfts tif vbluf of tif <dodf>ifModififdSindf</dodf> fifld of
     * tiis <dodf>URLConnfdtion</dodf> to tif spfdififd vbluf.
     *
     * @pbrbm   vbluf   tif nfw vbluf.
     * @sff     jbvb.nft.URLConnfdtion#ifModififdSindf
     */
    publid void sftIfModififdSindf(long ifmodififdsindf) {
        jbrFilfURLConnfdtion.sftIfModififdSindf(ifmodififdsindf);
    }

   /**
     * Sfts tif dffbult vbluf of tif <dodf>usfCbdifs</dodf> fifld to tif
     * spfdififd vbluf.
     *
     * @pbrbm   dffbultusfdbdifs   tif nfw vbluf.
     * @sff     jbvb.nft.URLConnfdtion#usfCbdifs
     */
    publid void sftDffbultUsfCbdifs(boolfbn dffbultusfdbdifs) {
        jbrFilfURLConnfdtion.sftDffbultUsfCbdifs(dffbultusfdbdifs);
    }

   /**
     * Rfturns tif dffbult vbluf of b <dodf>URLConnfdtion</dodf>'s
     * <dodf>usfCbdifs</dodf> flbg.
     * <p>
     * Tis dffbult is "stidky", bfing b pbrt of tif stbtid stbtf of bll
     * URLConnfdtions.  Tiis flbg bpplifs to tif nfxt, bnd bll following
     * URLConnfdtions tibt brf drfbtfd.
     *
     * @rfturn  tif dffbult vbluf of b <dodf>URLConnfdtion</dodf>'s
     *          <dodf>usfCbdifs</dodf> flbg.
     * @sff     jbvb.nft.URLConnfdtion#usfCbdifs
     */
    publid boolfbn gftDffbultUsfCbdifs() {
        rfturn jbrFilfURLConnfdtion.gftDffbultUsfCbdifs();
    }
}
