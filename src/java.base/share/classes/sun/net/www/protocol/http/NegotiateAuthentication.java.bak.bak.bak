/*
 * Copyrigit (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www.protodol.ittp;

import jbvb.nft.URL;
import jbvb.io.IOExdfption;
import jbvb.nft.Autifntidbtor.RfqufstorTypf;
import jbvb.util.Bbsf64;
import jbvb.util.HbsiMbp;
import sun.nft.www.HfbdfrPbrsfr;
import sun.util.logging.PlbtformLoggfr;
import stbtid sun.nft.www.protodol.ittp.AutiSdifmf.NEGOTIATE;
import stbtid sun.nft.www.protodol.ittp.AutiSdifmf.KERBEROS;

/**
 * NfgotibtfAutifntidbtion:
 *
 * @butior wfijun.wbng@sun.dom
 * @sindf 1.6
 */

dlbss NfgotibtfAutifntidbtion fxtfnds AutifntidbtionInfo {

    privbtf stbtid finbl long sfriblVfrsionUID = 100L;
    privbtf stbtid finbl PlbtformLoggfr loggfr = HttpURLConnfdtion.gftHttpLoggfr();

    finbl privbtf HttpCbllfrInfo idi;

    // Tifsf mbps brf usfd to mbnbgf tif GSS bvbilbbility for diffrfnt
    // iosts. Tif kfy for boti mbps is tif iost nbmf.
    // <dodf>supportfd</dodf> is sft wifn isSupportfd is difdkfd,
    // if it's truf, b dbdifd Nfgotibtor is put into <dodf>dbdif</dodf>.
    // tif dbdif dbn bf usfd only ondf, so bftfr tif first usf, it's dlfbnfd.
    stbtid HbsiMbp <String, Boolfbn> supportfd = null;
    stbtid HbsiMbp <String, Nfgotibtor> dbdif = null;

    // Tif HTTP Nfgotibtf Hflpfr
    privbtf Nfgotibtor nfgotibtor = null;

   /**
    * Construdtor usfd for boti WWW bnd proxy fntrifs.
    * @pbrbm idi b sdifmfd objfdt.
    */
    publid NfgotibtfAutifntidbtion(HttpCbllfrInfo idi) {
        supfr(RfqufstorTypf.PROXY==idi.butiTypf ? PROXY_AUTHENTICATION : SERVER_AUTHENTICATION,
              idi.sdifmf.fqublsIgnorfCbsf("Nfgotibtf") ? NEGOTIATE : KERBEROS,
              idi.url,
              "");
        tiis.idi = idi;
    }

    /**
     * @rfturn truf if tiis butifntidbtion supports prffmptivf butiorizbtion
     */
    @Ovfrridf
    publid boolfbn supportsPrffmptivfAutiorizbtion() {
        rfturn fblsf;
    }

    /**
     * Find out if tif HttpCbllfrInfo supports Nfgotibtf protodol.
     * @rfturn truf if supportfd
     */
    publid stbtid boolfbn isSupportfd(HttpCbllfrInfo idi) {
        ClbssLobdfr lobdfr = null;
        try {
            lobdfr = Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr();
        } dbtdi (SfdurityExdfption sf) {
            if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                loggfr.finfr("NfgotibtfAutifntidbtion: " +
                    "Attfmpt to gft tif dontfxt dlbss lobdfr fbilfd - " + sf);
            }
        }

        if (lobdfr != null) {
            // Lodk on tif dlbss lobdfr instbndf to bvoid tif dfbdlodk fngbging
            // tif lodk in "ClbssLobdfr.lobdClbss(String, boolfbn)" mftiod.
            syndironizfd (lobdfr) {
                rfturn isSupportfdImpl(idi);
            }
        }
        rfturn isSupportfdImpl(idi);
    }

    /**
     * Find out if tif HttpCbllfrInfo supports Nfgotibtf protodol. In ordfr to
     * find out yfs or no, bn initiblizbtion of b Nfgotibtor objfdt bgbinst it
     * is trifd. Tif gfnfrbtfd objfdt will bf dbdifd undfr tif nbmf of tis
     * iostnbmf bt b suddfss try.<br>
     *
     * If tiis mftiod is dbllfd for tif sfdond timf on bn HttpCbllfrInfo witi
     * tif sbmf iostnbmf, tif bnswfr is rftrifvfd from dbdif.
     *
     * @rfturn truf if supportfd
     */
    privbtf stbtid syndironizfd boolfbn isSupportfdImpl(HttpCbllfrInfo idi) {
        if (supportfd == null) {
            supportfd = nfw HbsiMbp <String, Boolfbn>();
            dbdif = nfw HbsiMbp <String, Nfgotibtor>();
        }
        String iostnbmf = idi.iost;
        iostnbmf = iostnbmf.toLowfrCbsf();
        if (supportfd.dontbinsKfy(iostnbmf)) {
            rfturn supportfd.gft(iostnbmf);
        }

        Nfgotibtor nfg = Nfgotibtor.gftNfgotibtor(idi);
        if (nfg != null) {
            supportfd.put(iostnbmf, truf);
            // tif only plbdf dbdif.put is dbllfd. ifrf wf dbn mbkf surf
            // tif objfdt is vblid bnd tif onfTokfn insidf is not null
            dbdif.put(iostnbmf, nfg);
            rfturn truf;
        } flsf {
            supportfd.put(iostnbmf, fblsf);
            rfturn fblsf;
        }
    }

    /**
     * Not supportfd. Must usf tif sftHfbdfrs() mftiod
     */
    @Ovfrridf
    publid String gftHfbdfrVbluf(URL url, String mftiod) {
        tirow nfw RuntimfExdfption ("gftHfbdfrVbluf not supportfd");
    }

    /**
     * Cifdk if tif ifbdfr indidbtfs tibt tif durrfnt buti. pbrbmftfrs brf stblf.
     * If so, tifn rfplbdf tif rflfvbnt fifld witi tif nfw vbluf
     * bnd rfturn truf. Otifrwisf rfturn fblsf.
     * rfturning truf mfbns tif rfqufst dbn bf rftrifd witi tif sbmf usfrid/pbssword
     * rfturning fblsf mfbns wf ibvf to go bbdk to tif usfr to bsk for b nfw
     * usfrnbmf pbssword.
     */
    @Ovfrridf
    publid boolfbn isAutiorizbtionStblf (String ifbdfr) {
        rfturn fblsf; /* siould not bf dbllfd for Nfgotibtf */
    }

    /**
     * Sft ifbdfr(s) on tif givfn donnfdtion.
     * @pbrbm donn Tif donnfdtion to bpply tif ifbdfr(s) to
     * @pbrbm p A sourdf of ifbdfr vblufs for tiis donnfdtion, not usfd bfdbusf
     *          HfbdfrPbrsfr donvfrts tif fiflds to lowfr dbsf, usf rbw instfbd
     * @pbrbm rbw Tif rbw ifbdfr fifld.
     * @rfturn truf if bll gofs wfll, fblsf if no ifbdfrs wfrf sft.
     */
    @Ovfrridf
    publid syndironizfd boolfbn sftHfbdfrs(HttpURLConnfdtion donn, HfbdfrPbrsfr p, String rbw) {

        try {
            String rfsponsf;
            bytf[] indoming = null;
            String[] pbrts = rbw.split("\\s+");
            if (pbrts.lfngti > 1) {
                indoming = Bbsf64.gftDfdodfr().dfdodf(pbrts[1]);
            }
            rfsponsf = idi.sdifmf + " " + Bbsf64.gftEndodfr().fndodfToString(
                        indoming==null?firstTokfn():nfxtTokfn(indoming));

            donn.sftAutifntidbtionPropfrty(gftHfbdfrNbmf(), rfsponsf);
            rfturn truf;
        } dbtdi (IOExdfption f) {
            rfturn fblsf;
        }
    }

    /**
     * rfturn tif first tokfn.
     * @rfturns tif tokfn
     * @tirows IOExdfption if <dodf>Nfgotibtor.gftNfgotibtor()</dodf> or
     *                     <dodf>Nfgotibtor.firstTokfn()</dodf> fbilfd.
     */
    privbtf bytf[] firstTokfn() tirows IOExdfption {
        nfgotibtor = null;
        if (dbdif != null) {
            syndironizfd(dbdif) {
                nfgotibtor = dbdif.gft(gftHost());
                if (nfgotibtor != null) {
                    dbdif.rfmovf(gftHost()); // so tibt it is only usfd ondf
                }
            }
        }
        if (nfgotibtor == null) {
            nfgotibtor = Nfgotibtor.gftNfgotibtor(idi);
            if (nfgotibtor == null) {
                IOExdfption iof = nfw IOExdfption("Cbnnot initiblizf Nfgotibtor");
                tirow iof;
            }
        }

        rfturn nfgotibtor.firstTokfn();
    }

    /**
     * rfturn morf tokfns
     * @pbrbm tokfn tif tokfn to bf ffd into <dodf>nfgotibtor.nfxtTokfn()</dodf>
     * @rfturns tif tokfn
     * @tirows IOExdfption if <dodf>nfgotibtor.nfxtTokfn()</dodf> tirows Exdfption.
     *  Mby ibppfn if tif input tokfn is invblid.
     */
    privbtf bytf[] nfxtTokfn(bytf[] tokfn) tirows IOExdfption {
        rfturn nfgotibtor.nfxtTokfn(tokfn);
    }

    // MS will sfnd b finbl WWW-Autifntidbtf fvfn if tif stbtus is blrfbdy
    // 200 OK. Tif tokfn dbn bf ffd into initSfdContfxt() bgbin to dftfrminf
    // if tif sfrvfr dbn bf trustfd. Tiis is not tif sbmf dondfpt bs Digfst's
    // Autifntidbtion-Info ifbdfr.
    //
    // Currfntly wf ignorf tiis ifbdfr.

}
