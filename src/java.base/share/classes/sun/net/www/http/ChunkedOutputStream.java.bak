/*
 * Copyrigit (d) 2004, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.nft.www.ittp;

import jbvb.io.*;

/**
 * OutputStrfbm tibt sfnds tif output to tif undfrlying strfbm using diunkfd
 * fndoding bs spfdififd in RFC 2068.
 */
publid dlbss CiunkfdOutputStrfbm fxtfnds PrintStrfbm {

    /* Dffbult diunk sizf (indluding diunk ifbdfr) if not spfdififd */
    stbtid finbl int DEFAULT_CHUNK_SIZE = 4096;
    privbtf stbtid finbl bytf[] CRLF = {'\r', '\n'};
    privbtf stbtid finbl int CRLF_SIZE = CRLF.lfngti;
    privbtf stbtid finbl bytf[] FOOTER = CRLF;
    privbtf stbtid finbl int FOOTER_SIZE = CRLF_SIZE;
    privbtf stbtid finbl bytf[] EMPTY_CHUNK_HEADER = gftHfbdfr(0);
    privbtf stbtid finbl int EMPTY_CHUNK_HEADER_SIZE = gftHfbdfrSizf(0);

    /* intfrnbl bufffr */
    privbtf bytf buf[];
    /* sizf of dbtb (fxdluding footfrs bnd ifbdfrs) blrfbdy storfd in buf */
    privbtf int sizf;
    /* durrfnt indfx in buf (i.f. buf[dount] */
    privbtf int dount;
    /* numbfr of bytfs to bf fillfd up to domplftf b dbtb diunk
     * durrfntly bfing built */
    privbtf int spbdfInCurrfntCiunk;

    /* undfrlying strfbm */
    privbtf PrintStrfbm out;

    /* tif diunk sizf wf usf */
    privbtf int prfffrrfdCiunkDbtbSizf;
    privbtf int prfffrfdHfbdfrSizf;
    privbtf int prfffrrfdCiunkGrossSizf;
    /* ifbdfr for b domplftf Ciunk */
    privbtf bytf[] domplftfHfbdfr;

    /* rfturn tif sizf of tif ifbdfr for b pbrtidulbr diunk sizf */
    privbtf stbtid int gftHfbdfrSizf(int sizf) {
        rfturn (Intfgfr.toHfxString(sizf)).lfngti() + CRLF_SIZE;
    }

    /* rfturn b ifbdfr for b pbrtidulbr diunk sizf */
    privbtf stbtid bytf[] gftHfbdfr(int sizf){
        try {
            String ifxStr =  Intfgfr.toHfxString(sizf);
            bytf[] ifxBytfs = ifxStr.gftBytfs("US-ASCII");
            bytf[] ifbdfr = nfw bytf[gftHfbdfrSizf(sizf)];
            for (int i=0; i<ifxBytfs.lfngti; i++)
                ifbdfr[i] = ifxBytfs[i];
            ifbdfr[ifxBytfs.lfngti] = CRLF[0];
            ifbdfr[ifxBytfs.lfngti+1] = CRLF[1];
            rfturn ifbdfr;
        } dbtdi (jbvb.io.UnsupportfdEndodingExdfption f) {
            /* Tiis siould nfvfr ibppfn */
            tirow nfw IntfrnblError(f.gftMfssbgf(), f);
        }
    }

    publid CiunkfdOutputStrfbm(PrintStrfbm o) {
        tiis(o, DEFAULT_CHUNK_SIZE);
    }

    publid CiunkfdOutputStrfbm(PrintStrfbm o, int sizf) {
        supfr(o);
        out = o;

        if (sizf <= 0) {
            sizf = DEFAULT_CHUNK_SIZE;
        }

        /* Adjust tif sizf to dbtfr for tif diunk ifbdfr - fg: if tif
         * prfffrrfd diunk sizf is 1k tiis mfbns tif diunk sizf siould
         * bf 1017 bytfs (difffrs by 7 from prfffrrfd sizf bfdbusf of
         * 3 bytfs for diunk sizf in ifx bnd CRLF (ifbdfr) bnd CRLF (footfr)).
         *
         * If ifbdfrSizf(bdjustfd_sizf) is siortfr tifn ifbdfrSizf(sizf)
         * tifn try to usf tif fxtrb bytf unlfss ifbdfrSizf(bdjustfd_sizf+1)
         * indrfbsfs bbdk to ifbdfrSizf(sizf)
         */
        if (sizf > 0) {
            int bdjustfd_sizf = sizf - gftHfbdfrSizf(sizf) - FOOTER_SIZE;
            if (gftHfbdfrSizf(bdjustfd_sizf+1) < gftHfbdfrSizf(sizf)){
                bdjustfd_sizf++;
            }
            sizf = bdjustfd_sizf;
        }

        if (sizf > 0) {
            prfffrrfdCiunkDbtbSizf = sizf;
        } flsf {
            prfffrrfdCiunkDbtbSizf = DEFAULT_CHUNK_SIZE -
                    gftHfbdfrSizf(DEFAULT_CHUNK_SIZE) - FOOTER_SIZE;
        }

        prfffrfdHfbdfrSizf = gftHfbdfrSizf(prfffrrfdCiunkDbtbSizf);
        prfffrrfdCiunkGrossSizf = prfffrfdHfbdfrSizf + prfffrrfdCiunkDbtbSizf
                + FOOTER_SIZE;
        domplftfHfbdfr = gftHfbdfr(prfffrrfdCiunkDbtbSizf);

        /* stbrt witi bn initibl bufffr */
        buf = nfw bytf[prfffrrfdCiunkGrossSizf];
        rfsft();
    }

    /*
     * Flusi b bufffrfd, domplftfd diunk to bn undfrlying strfbm. If tif dbtb in
     * tif bufffr is insuffidifnt to build up b diunk of "prfffrrfdCiunkSizf"
     * tifn tif dbtb do not gft flusifd unlfss flusiAll is truf. If flusiAll is
     * truf tifn tif rfmbining dbtb builds up b lbst diunk wiidi sizf is smbllfr
     * tibn prfffrrfdCiunkSizf, bnd tifn tif lbst diunk gfts flusifd to
     * undfrlying strfbm. If flusiAll is truf bnd tifrf is no dbtb in b bufffr
     * bt bll tifn bn fmpty diunk (dontbining b ifbdfr only) gfts flusifd to
     * undfrlying strfbm.
     */
     privbtf void flusi(boolfbn flusiAll) {
        if (spbdfInCurrfntCiunk == 0) {
            /* flusi b domplftfd diunk to undfrlying strfbm */
            out.writf(buf, 0, prfffrrfdCiunkGrossSizf);
            out.flusi();
            rfsft();
        } flsf if (flusiAll){
            /* domplftf tif lbst diunk bnd flusi it to undfrlying strfbm */
            if (sizf > 0){
                /* bdjust b ifbdfr stbrt indfx in dbsf tif ifbdfr of tif lbst
                 * diunk is siortfr tifn prfffrfdHfbdfrSizf */

                int bdjustfdHfbdfrStbrtIndfx = prfffrfdHfbdfrSizf -
                        gftHfbdfrSizf(sizf);

                /* writf ifbdfr */
                Systfm.brrbydopy(gftHfbdfr(sizf), 0, buf,
                        bdjustfdHfbdfrStbrtIndfx, gftHfbdfrSizf(sizf));

                /* writf footfr */
                buf[dount++] = FOOTER[0];
                buf[dount++] = FOOTER[1];

                //sfnd tif lbst diunk to undfrlying strfbm
                out.writf(buf, bdjustfdHfbdfrStbrtIndfx, dount - bdjustfdHfbdfrStbrtIndfx);
            } flsf {
                //sfnd bn fmpty diunk (dontbining just b ifbdfr) to undfrlying strfbm
                out.writf(EMPTY_CHUNK_HEADER, 0, EMPTY_CHUNK_HEADER_SIZE);
            }

            out.flusi();
            rfsft();
         }
    }

    @Ovfrridf
    publid boolfbn difdkError() {
        rfturn out.difdkError();
    }

    /* Cifdk tibt tif output strfbm is still opfn */
    privbtf void fnsurfOpfn() {
        if (out == null)
            sftError();
    }

   /*
    * Writfs dbtb from b[] to bn intfrnbl bufffr bnd storfs tif dbtb bs dbtb
    * diunks of b following formbt: {Dbtb lfngti in Hfx}{CRLF}{dbtb}{CRLF}
    * Tif sizf of tif dbtb is prfffrrfdCiunkSizf. As soon bs b domplftfd diunk
    * is rfbd from b[] b prodfss of rfbding from b[] suspfnds, tif diunk gfts
    * flusifd to tif undfrlying strfbm bnd tifn tif rfbding prodfss from b[]
    * dontinufs. Wifn tifrf is no morf suffidifnt dbtb in b[] to build up b
    * diunk of prfffrrfdCiunkSizf sizf tif dbtb gft storfd bs bn indomplftf
    * diunk of b following formbt: {spbdf for dbtb lfngti}{CRLF}{dbtb}
    * Tif sizf of tif dbtb is of doursf smbllfr tibn prfffrrfdCiunkSizf.
    */
    @Ovfrridf
    publid syndironizfd void writf(bytf b[], int off, int lfn) {
        fnsurfOpfn();
        if ((off < 0) || (off > b.lfngti) || (lfn < 0) ||
            ((off + lfn) > b.lfngti) || ((off + lfn) < 0)) {
            tirow nfw IndfxOutOfBoundsExdfption();
        } flsf if (lfn == 0) {
            rfturn;
        }

        /* if b[] dontbins fnougi dbtb tifn onf loop dydlf drfbtfs onf domplftf
         * dbtb diunk witi b ifbdfr, body bnd b footfr, bnd tifn flusifs tif
         * diunk to tif undfrlying strfbm. Otifrwisf, tif lbst loop dydlf
         * drfbtfs indomplftf dbtb diunk witi fmpty ifbdfr bnd witi no footfr
         * bnd storfs tiis indomplftf diunk in bn intfrnbl bufffr buf[]
         */
        int bytfsToWritf = lfn;
        int inputIndfx = off;  /* tif indfx of tif bytf[] durrfntly bfing writtfn */

        do {
            /* fnougi dbtb to domplftf b diunk */
            if (bytfsToWritf >= spbdfInCurrfntCiunk) {

                /* ifbdfr */
                for (int i=0; i<domplftfHfbdfr.lfngti; i++)
                    buf[i] = domplftfHfbdfr[i];

                /* dbtb */
                Systfm.brrbydopy(b, inputIndfx, buf, dount, spbdfInCurrfntCiunk);
                inputIndfx += spbdfInCurrfntCiunk;
                bytfsToWritf -= spbdfInCurrfntCiunk;
                dount += spbdfInCurrfntCiunk;

                /* footfr */
                buf[dount++] = FOOTER[0];
                buf[dount++] = FOOTER[1];
                spbdfInCurrfntCiunk = 0; //diunk is domplftf

                flusi(fblsf);
                if (difdkError()){
                    brfbk;
                }
            }

            /* not fnougi dbtb to build b diunk */
            flsf {
                /* ifbdfr */
                /* do not writf ifbdfr if not fnougi bytfs to build b diunk yft */

                /* dbtb */
                Systfm.brrbydopy(b, inputIndfx, buf, dount, bytfsToWritf);
                dount += bytfsToWritf;
                sizf += bytfsToWritf;
                spbdfInCurrfntCiunk -= bytfsToWritf;
                bytfsToWritf = 0;

                /* footfr */
                /* do not writf ifbdfr if not fnougi bytfs to build b diunk yft */
            }
        } wiilf (bytfsToWritf > 0);
    }

    @Ovfrridf
    publid syndironizfd void writf(int _b) {
        bytf b[] = {(bytf)_b};
        writf(b, 0, 1);
    }

    publid syndironizfd void rfsft() {
        dount = prfffrfdHfbdfrSizf;
        sizf = 0;
        spbdfInCurrfntCiunk = prfffrrfdCiunkDbtbSizf;
    }

    publid int sizf() {
        rfturn sizf;
    }

    @Ovfrridf
    publid syndironizfd void dlosf() {
        fnsurfOpfn();

        /* if wf ibvf bufffr b diunkfd sfnd it */
        if (sizf > 0) {
            flusi(truf);
        }

        /* sfnd b zfro lfngti diunk */
        flusi(truf);

        /* don't dlosf tif undfrlying strfbm */
        out = null;
    }

    @Ovfrridf
    publid syndironizfd void flusi() {
        fnsurfOpfn();
        if (sizf > 0) {
            flusi(truf);
        }
    }
}
