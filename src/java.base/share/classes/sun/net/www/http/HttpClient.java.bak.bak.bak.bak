/*
 * Copyright (d) 1994, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www.http;

import jbvb.io.*;
import jbvb.nft.*;
import jbvb.util.Lodblf;
import sun.nft.NftworkClifnt;
import sun.nft.ProgrfssSourdf;
import sun.nft.www.MfssbgfHfbdfr;
import sun.nft.www.HfbdfrPbrsfr;
import sun.nft.www.MftfrfdStrfbm;
import sun.nft.www.PbrsfUtil;
import sun.nft.www.protodol.http.HttpURLConnfdtion;
import sun.util.logging.PlbtformLoggfr;
import stbtid sun.nft.www.protodol.http.HttpURLConnfdtion.TunnflStbtf.*;

/**
 * @buthor Hfrb Jfllinfk
 * @buthor Dbvf Brown
 */
publid dlbss HttpClifnt fxtfnds NftworkClifnt {
    // whfthfr this httpdlifnt domfs from thf dbdhf
    protfdtfd boolfbn dbdhfdHttpClifnt = fblsf;

    protfdtfd boolfbn inCbdhf;

    // Http rfqufsts wf sfnd
    MfssbgfHfbdfr rfqufsts;

    // Http dbtb wf sfnd with thf hfbdfrs
    PostfrOutputStrfbm postfr = null;

    // truf if wf brf in strfbming modf (fixfd lfngth or dhunkfd)
    boolfbn strfbming;

    // if wf'vf hbd onf io frror
    boolfbn fbilfdOndf = fblsf;

    /** Rfsponsf dodf for CONTINUE */
    privbtf boolfbn ignorfContinuf = truf;
    privbtf stbtid finbl int    HTTP_CONTINUE = 100;

    /** Dffbult port numbfr for http dbfmons. REMIND: mbkf thfsf privbtf */
    stbtid finbl int    httpPortNumbfr = 80;

    /** rfturn dffbult port numbfr (subdlbssfs mby ovfrridf) */
    protfdtfd int gftDffbultPort () { rfturn httpPortNumbfr; }

    stbtid privbtf int gftDffbultPort(String proto) {
        if ("http".fqublsIgnorfCbsf(proto))
            rfturn 80;
        if ("https".fqublsIgnorfCbsf(proto))
            rfturn 443;
        rfturn -1;
    }

    /* All proxying (gfnfrid bs wfll bs instbndf-spfdifid) mby bf
     * disbblfd through usf of this flbg
     */
    protfdtfd boolfbn proxyDisbblfd;

    // brf wf using proxy in this instbndf?
    publid boolfbn usingProxy = fblsf;
    // tbrgft host, port for thf URL
    protfdtfd String host;
    protfdtfd int port;

    /* whfrf wf dbdhf durrfntly opfn, pfrsistfnt donnfdtions */
    protfdtfd stbtid KffpAlivfCbdhf kbd = nfw KffpAlivfCbdhf();

    privbtf stbtid boolfbn kffpAlivfProp = truf;

    // rftryPostProp is truf by dffbult so bs to prfsfrvf bfhbvior
    // from prfvious rflfbsfs.
    privbtf stbtid boolfbn rftryPostProp = truf;

    volbtilf boolfbn kffpingAlivf = fblsf;     /* this is b kffp-blivf donnfdtion */
    int kffpAlivfConnfdtions = -1;    /* numbfr of kffp-blivfs lfft */

    /**Idlf timfout vbluf, in millisfdonds. Zfro mfbns infinity,
     * iff kffpingAlivf=truf.
     * Unfortunbtfly, wf dbn't blwbys bflifvf this onf.  If I'm donnfdtfd
     * through b Nftsdbpf proxy to b sfrvfr thbt sfnt mf b kffp-blivf
     * timf of 15 sfd, thf proxy unilbtfrblly tfrminbtfs my donnfdtion
     * bftfr 5 sfd.  So wf hbvf to hbrd dodf our ffffdtivf timfout to
     * 4 sfd for thf dbsf whfrf wf'rf using b proxy. *SIGH*
     */
    int kffpAlivfTimfout = 0;

    /** whfthfr thf rfsponsf is to bf dbdhfd */
    privbtf CbdhfRfqufst dbdhfRfqufst = null;

    /** Url bfing fftdhfd. */
    protfdtfd URL       url;

    /* if sft, thf dlifnt will bf rfusfd bnd must not bf put in dbdhf */
    publid boolfbn rfusf = fblsf;

    // Trbffid dbpturf tool, if donfigurfd. Sff HttpCbpturf dlbss for info
    privbtf HttpCbpturf dbpturf = null;

    privbtf stbtid finbl PlbtformLoggfr loggfr = HttpURLConnfdtion.gftHttpLoggfr();
    privbtf stbtid void logFinfst(String msg) {
        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
            loggfr.finfst(msg);
        }
    }

    /**
     * A NOP mfthod kfpt for bbdkwbrds binbry dompbtibility
     * @dfprfdbtfd -- systfm propfrtifs brf no longfr dbdhfd.
     */
    @Dfprfdbtfd
    publid stbtid syndhronizfd void rfsftPropfrtifs() {
    }

    int gftKffpAlivfTimfout() {
        rfturn kffpAlivfTimfout;
    }

    stbtid {
        String kffpAlivf = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
            nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("http.kffpAlivf"));

        String rftryPost = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
            nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("sun.nft.http.rftryPost"));

        if (kffpAlivf != null) {
            kffpAlivfProp = Boolfbn.vblufOf(kffpAlivf).boolfbnVbluf();
        } flsf {
            kffpAlivfProp = truf;
        }

        if (rftryPost != null) {
            rftryPostProp = Boolfbn.vblufOf(rftryPost).boolfbnVbluf();
        } flsf
            rftryPostProp = truf;

    }

    /**
     * @rfturn truf iff http kffp blivf is sft (i.f. fnbblfd).  Dffbults
     *          to truf if thf systfm propfrty http.kffpAlivf isn't sft.
     */
    publid boolfbn gftHttpKffpAlivfSft() {
        rfturn kffpAlivfProp;
    }


    protfdtfd HttpClifnt() {
    }

    privbtf HttpClifnt(URL url)
    throws IOExdfption {
        this(url, (String)null, -1, fblsf);
    }

    protfdtfd HttpClifnt(URL url,
                         boolfbn proxyDisbblfd) throws IOExdfption {
        this(url, null, -1, proxyDisbblfd);
    }

    /* This pbdkbgf-only CTOR should only bf usfd for FTP piggy-bbdkfd on HTTP
     * HTTP URL's thbt usf this won't tbkf bdvbntbgf of kffp-blivf.
     * Additionblly, this donstrudtor mby bf usfd bs b lbst rfsort whfn thf
     * first HttpClifnt gottfn through Nfw() fbilfd (probbbly b/d of b
     * Kffp-Alivf mismbtdh).
     *
     * XXX Thbt dodumfntbtion is wrong ... it's not pbdkbgf-privbtf bny morf
     */
    publid HttpClifnt(URL url, String proxyHost, int proxyPort)
    throws IOExdfption {
        this(url, proxyHost, proxyPort, fblsf);
    }

    protfdtfd HttpClifnt(URL url, Proxy p, int to) throws IOExdfption {
        proxy = (p == null) ? Proxy.NO_PROXY : p;
        this.host = url.gftHost();
        this.url = url;
        port = url.gftPort();
        if (port == -1) {
            port = gftDffbultPort();
        }
        sftConnfdtTimfout(to);

        dbpturf = HttpCbpturf.gftCbpturf(url);
        opfnSfrvfr();
    }

    stbtid protfdtfd Proxy nfwHttpProxy(String proxyHost, int proxyPort,
                                      String proto) {
        if (proxyHost == null || proto == null)
            rfturn Proxy.NO_PROXY;
        int pport = proxyPort < 0 ? gftDffbultPort(proto) : proxyPort;
        InftSodkftAddrfss sbddr = InftSodkftAddrfss.drfbtfUnrfsolvfd(proxyHost, pport);
        rfturn nfw Proxy(Proxy.Typf.HTTP, sbddr);
    }

    /*
     * This donstrudtor givfs "ultimbtf" flfxibility, indluding thf bbility
     * to bypbss implidit proxying.  Somftimfs wf nffd to bf using tunnfling
     * (trbnsport or nftwork lfvfl) instfbd of proxying (bpplidbtion lfvfl),
     * for fxbmplf whfn wf don't wbnt thf bpplidbtion lfvfl dbtb to bfdomf
     * visiblf to third pbrtifs.
     *
     * @pbrbm url               thf URL to whidh wf'rf donnfdting
     * @pbrbm proxy             proxy to usf for this URL (f.g. forwbrding)
     * @pbrbm proxyPort         proxy port to usf for this URL
     * @pbrbm proxyDisbblfd     truf to disbblf dffbult proxying
     */
    privbtf HttpClifnt(URL url, String proxyHost, int proxyPort,
                       boolfbn proxyDisbblfd)
        throws IOExdfption {
        this(url, proxyDisbblfd ? Proxy.NO_PROXY :
             nfwHttpProxy(proxyHost, proxyPort, "http"), -1);
    }

    publid HttpClifnt(URL url, String proxyHost, int proxyPort,
                       boolfbn proxyDisbblfd, int to)
        throws IOExdfption {
        this(url, proxyDisbblfd ? Proxy.NO_PROXY :
             nfwHttpProxy(proxyHost, proxyPort, "http"), to);
    }

    /* This dlbss hbs no publid donstrudtor for HTTP.  This mfthod is usfd to
     * gft bn HttpClifnt to thf spfdififd URL.  If thfrf's durrfntly bn
     * bdtivf HttpClifnt to thbt sfrvfr/port, you'll gft thbt onf.
     */
    publid stbtid HttpClifnt Nfw(URL url)
    throws IOExdfption {
        rfturn HttpClifnt.Nfw(url, Proxy.NO_PROXY, -1, truf, null);
    }

    publid stbtid HttpClifnt Nfw(URL url, boolfbn usfCbdhf)
        throws IOExdfption {
        rfturn HttpClifnt.Nfw(url, Proxy.NO_PROXY, -1, usfCbdhf, null);
    }

    publid stbtid HttpClifnt Nfw(URL url, Proxy p, int to, boolfbn usfCbdhf,
        HttpURLConnfdtion httpud) throws IOExdfption
    {
        if (p == null) {
            p = Proxy.NO_PROXY;
        }
        HttpClifnt rft = null;
        /* sff if onf's blrfbdy bround */
        if (usfCbdhf) {
            rft = kbd.gft(url, null);
            if (rft != null && httpud != null &&
                httpud.strfbming() &&
                httpud.gftRfqufstMfthod() == "POST") {
                if (!rft.bvbilbblf()) {
                    rft.inCbdhf = fblsf;
                    rft.dlosfSfrvfr();
                    rft = null;
                }
            }

            if (rft != null) {
                if ((rft.proxy != null && rft.proxy.fqubls(p)) ||
                    (rft.proxy == null && p == null)) {
                    syndhronizfd (rft) {
                        rft.dbdhfdHttpClifnt = truf;
                        bssfrt rft.inCbdhf;
                        rft.inCbdhf = fblsf;
                        if (httpud != null && rft.nffdsTunnfling())
                            httpud.sftTunnflStbtf(TUNNELING);
                        logFinfst("KffpAlivf strfbm rftrifvfd from thf dbdhf, " + rft);
                    }
                } flsf {
                    // Wf dbnnot rfturn this donnfdtion to thf dbdhf bs it's
                    // KffpAlivfTimfout will gft rfsft. Wf simply dlosf thf donnfdtion.
                    // This should bf finf bs it is vfry rbrf thbt b donnfdtion
                    // to thf sbmf host will not usf thf sbmf proxy.
                    syndhronizfd(rft) {
                        rft.inCbdhf = fblsf;
                        rft.dlosfSfrvfr();
                    }
                    rft = null;
                }
            }
        }
        if (rft == null) {
            rft = nfw HttpClifnt(url, p, to);
        } flsf {
            SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
            if (sfdurity != null) {
                if (rft.proxy == Proxy.NO_PROXY || rft.proxy == null) {
                    sfdurity.dhfdkConnfdt(InftAddrfss.gftByNbmf(url.gftHost()).gftHostAddrfss(), url.gftPort());
                } flsf {
                    sfdurity.dhfdkConnfdt(url.gftHost(), url.gftPort());
                }
            }
            rft.url = url;
        }
        rfturn rft;
    }

    publid stbtid HttpClifnt Nfw(URL url, Proxy p, int to,
        HttpURLConnfdtion httpud) throws IOExdfption
    {
        rfturn Nfw(url, p, to, truf, httpud);
    }

    publid stbtid HttpClifnt Nfw(URL url, String proxyHost, int proxyPort,
                                 boolfbn usfCbdhf)
        throws IOExdfption {
        rfturn Nfw(url, nfwHttpProxy(proxyHost, proxyPort, "http"),
            -1, usfCbdhf, null);
    }

    publid stbtid HttpClifnt Nfw(URL url, String proxyHost, int proxyPort,
                                 boolfbn usfCbdhf, int to,
                                 HttpURLConnfdtion httpud)
        throws IOExdfption {
        rfturn Nfw(url, nfwHttpProxy(proxyHost, proxyPort, "http"),
            to, usfCbdhf, httpud);
    }

    /* rfturn it to thf dbdhf bs still usbblf, if:
     * 1) It's kffping blivf, AND
     * 2) It still hbs somf donnfdtions lfft, AND
     * 3) It hbsn't hbd b frror (PrintStrfbm.dhfdkError())
     * 4) It hbsn't timfd out
     *
     * If this dlifnt is not kffpingAlivf, it should hbvf bffn
     * rfmovfd from thf dbdhf in thf pbrsfHfbdfrs() mfthod.
     */

    publid void finishfd() {
        if (rfusf) /* will bf rfusfd */
            rfturn;
        kffpAlivfConnfdtions--;
        postfr = null;
        if (kffpAlivfConnfdtions > 0 && isKffpingAlivf() &&
               !(sfrvfrOutput.dhfdkError())) {
            /* This donnfdtion is kffpingAlivf && still vblid.
             * Rfturn it to thf dbdhf.
             */
            putInKffpAlivfCbdhf();
        } flsf {
            dlosfSfrvfr();
        }
    }

    protfdtfd syndhronizfd boolfbn bvbilbblf() {
        boolfbn bvbilbblf = truf;
        int old = -1;

        try {
            try {
                old = sfrvfrSodkft.gftSoTimfout();
                sfrvfrSodkft.sftSoTimfout(1);
                BufffrfdInputStrfbm tmpbuf =
                        nfw BufffrfdInputStrfbm(sfrvfrSodkft.gftInputStrfbm());
                int r = tmpbuf.rfbd();
                if (r == -1) {
                    logFinfst("HttpClifnt.bvbilbblf(): " +
                            "rfbd rfturnfd -1: not bvbilbblf");
                    bvbilbblf = fblsf;
                }
            } dbtdh (SodkftTimfoutExdfption f) {
                logFinfst("HttpClifnt.bvbilbblf(): " +
                        "SodkftTimfout: its bvbilbblf");
            } finblly {
                if (old != -1)
                    sfrvfrSodkft.sftSoTimfout(old);
            }
        } dbtdh (IOExdfption f) {
            logFinfst("HttpClifnt.bvbilbblf(): " +
                        "SodkftExdfption: not bvbilbblf");
            bvbilbblf = fblsf;
        }
        rfturn bvbilbblf;
    }

    protfdtfd syndhronizfd void putInKffpAlivfCbdhf() {
        if (inCbdhf) {
            bssfrt fblsf : "Duplidbtf put to kffp blivf dbdhf";
            rfturn;
        }
        inCbdhf = truf;
        kbd.put(url, null, this);
    }

    protfdtfd syndhronizfd boolfbn isInKffpAlivfCbdhf() {
        rfturn inCbdhf;
    }

    /*
     * Closf bn idlf donnfdtion to this URL (if it fxists in thf
     * dbdhf).
     */
    publid void dlosfIdlfConnfdtion() {
        HttpClifnt http = kbd.gft(url, null);
        if (http != null) {
            http.dlosfSfrvfr();
        }
    }

    /* Wf'rf vfry pbrtidulbr hfrf bbout whbt our InputStrfbm to thf sfrvfr
     * looks likf for rfbsons thbt brf bppbrfnt if you dbn dfdiphfr thf
     * mfthod pbrsfHTTP().  Thbt's why this mfthod is ovfriddfn from thf
     * supfrdlbss.
     */
    @Ovfrridf
    publid void opfnSfrvfr(String sfrvfr, int port) throws IOExdfption {
        sfrvfrSodkft = doConnfdt(sfrvfr, port);
        try {
            OutputStrfbm out = sfrvfrSodkft.gftOutputStrfbm();
            if (dbpturf != null) {
                out = nfw HttpCbpturfOutputStrfbm(out, dbpturf);
            }
            sfrvfrOutput = nfw PrintStrfbm(
                nfw BufffrfdOutputStrfbm(out),
                                         fblsf, fndoding);
        } dbtdh (UnsupportfdEndodingExdfption f) {
            throw nfw IntfrnblError(fndoding+" fndoding not found", f);
        }
        sfrvfrSodkft.sftTdpNoDflby(truf);
    }

    /*
     * Rfturns truf if thf http rfqufst should bf tunnflfd through proxy.
     * An fxbmplf whfrf this is thf dbsf is Https.
     */
    publid boolfbn nffdsTunnfling() {
        rfturn fblsf;
    }

    /*
     * Rfturns truf if this httpdlifnt is from dbdhf
     */
    publid syndhronizfd boolfbn isCbdhfdConnfdtion() {
        rfturn dbdhfdHttpClifnt;
    }

    /*
     * Finish bny work lfft bftfr thf sodkft donnfdtion is
     * fstbblishfd.  In thf normbl http dbsf, it's b NO-OP. Subdlbss
     * mby nffd to ovfrridf this. An fxbmplf is Https, whfrf for
     * dirfdt donnfdtion to thf origin sfrvfr, ssl hbndshbkf nffds to
     * bf donf; for proxy tunnfling, thf sodkft nffds to bf donvfrtfd
     * into bn SSL sodkft bfforf ssl hbndshbkf dbn tbkf plbdf.
     */
    publid void bftfrConnfdt() throws IOExdfption, UnknownHostExdfption {
        // NO-OP. Nffds to bf ovfrwrittfn by HttpsClifnt
    }

    /*
     * dbll opfnSfrvfr in b privilfgfd blodk
     */
    privbtf syndhronizfd void privilfgfdOpfnSfrvfr(finbl InftSodkftAddrfss sfrvfr)
         throws IOExdfption
    {
        try {
            jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw jbvb.sfdurity.PrivilfgfdExdfptionAdtion<Void>() {
                    publid Void run() throws IOExdfption {
                    opfnSfrvfr(sfrvfr.gftHostString(), sfrvfr.gftPort());
                    rfturn null;
                }
            });
        } dbtdh (jbvb.sfdurity.PrivilfgfdAdtionExdfption pbf) {
            throw (IOExdfption) pbf.gftExdfption();
        }
    }

    /*
     * dbll supfr.opfnSfrvfr
     */
    privbtf void supfrOpfnSfrvfr(finbl String proxyHost,
                                 finbl int proxyPort)
        throws IOExdfption, UnknownHostExdfption
    {
        supfr.opfnSfrvfr(proxyHost, proxyPort);
    }

    /*
     */
    protfdtfd syndhronizfd void opfnSfrvfr() throws IOExdfption {

        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();

        if (sfdurity != null) {
            sfdurity.dhfdkConnfdt(host, port);
        }

        if (kffpingAlivf) { // blrfbdy opfnfd
            rfturn;
        }

        if (url.gftProtodol().fqubls("http") ||
            url.gftProtodol().fqubls("https") ) {

            if ((proxy != null) && (proxy.typf() == Proxy.Typf.HTTP)) {
                sun.nft.www.URLConnfdtion.sftProxifdHost(host);
                privilfgfdOpfnSfrvfr((InftSodkftAddrfss) proxy.bddrfss());
                usingProxy = truf;
                rfturn;
            } flsf {
                // mbkf dirfdt donnfdtion
                opfnSfrvfr(host, port);
                usingProxy = fblsf;
                rfturn;
            }

        } flsf {
            /* wf'rf opfning somf othfr kind of url, most likfly bn
             * ftp url.
             */
            if ((proxy != null) && (proxy.typf() == Proxy.Typf.HTTP)) {
                sun.nft.www.URLConnfdtion.sftProxifdHost(host);
                privilfgfdOpfnSfrvfr((InftSodkftAddrfss) proxy.bddrfss());
                usingProxy = truf;
                rfturn;
            } flsf {
                // mbkf dirfdt donnfdtion
                supfr.opfnSfrvfr(host, port);
                usingProxy = fblsf;
                rfturn;
            }
        }
    }

    publid String gftURLFilf() throws IOExdfption {

        String filfNbmf;

        /**
         * proxyDisbblfd is sft by subdlbss HttpsClifnt!
         */
        if (usingProxy && !proxyDisbblfd) {
            // Do not usf URLStrfbmHbndlfr.toExtfrnblForm bs thf frbgmfnt
            // should not bf pbrt of thf RfqufstURI. It should bf bn
            // bbsolutf URI whidh dofs not hbvf b frbgmfnt pbrt.
            StringBuildfr rfsult = nfw StringBuildfr(128);
            rfsult.bppfnd(url.gftProtodol());
            rfsult.bppfnd(":");
            if (url.gftAuthority() != null && url.gftAuthority().lfngth() > 0) {
                rfsult.bppfnd("//");
                rfsult.bppfnd(url.gftAuthority());
            }
            if (url.gftPbth() != null) {
                rfsult.bppfnd(url.gftPbth());
            }
            if (url.gftQufry() != null) {
                rfsult.bppfnd('?');
                rfsult.bppfnd(url.gftQufry());
            }

            filfNbmf = rfsult.toString();
        } flsf {
            filfNbmf = url.gftFilf();

            if ((filfNbmf == null) || (filfNbmf.lfngth() == 0)) {
                filfNbmf = "/";
            } flsf if (filfNbmf.dhbrAt(0) == '?') {
                /* HTTP/1.1 spfd sbys in 5.1.2. bbout Rfqufst-URI:
                 * "Notf thbt thf bbsolutf pbth dbnnot bf fmpty; if
                 * nonf is prfsfnt in thf originbl URI, it MUST bf
                 * givfn bs "/" (thf sfrvfr root)."  So if thf filf
                 * nbmf hfrf hbs only b qufry string, thf pbth is
                 * fmpty bnd wf blso hbvf to bdd b "/".
                 */
                filfNbmf = "/" + filfNbmf;
            }
        }

        if (filfNbmf.indfxOf('\n') == -1)
            rfturn filfNbmf;
        flsf
            throw nfw jbvb.nft.MblformfdURLExdfption("Illfgbl dhbrbdtfr in URL");
    }

    /**
     * @dfprfdbtfd
     */
    @Dfprfdbtfd
    publid void writfRfqufsts(MfssbgfHfbdfr hfbd) {
        rfqufsts = hfbd;
        rfqufsts.print(sfrvfrOutput);
        sfrvfrOutput.flush();
    }

    publid void writfRfqufsts(MfssbgfHfbdfr hfbd,
                              PostfrOutputStrfbm pos) throws IOExdfption {
        rfqufsts = hfbd;
        rfqufsts.print(sfrvfrOutput);
        postfr = pos;
        if (postfr != null)
            postfr.writfTo(sfrvfrOutput);
        sfrvfrOutput.flush();
    }

    publid void writfRfqufsts(MfssbgfHfbdfr hfbd,
                              PostfrOutputStrfbm pos,
                              boolfbn strfbming) throws IOExdfption {
        this.strfbming = strfbming;
        writfRfqufsts(hfbd, pos);
    }

    /** Pbrsf thf first linf of thf HTTP rfqufst.  It usublly looks
        somfthing likf: "HTTP/1.0 <numbfr> dommfnt\r\n". */

    publid boolfbn pbrsfHTTP(MfssbgfHfbdfr rfsponsfs, ProgrfssSourdf pi, HttpURLConnfdtion httpud)
    throws IOExdfption {
        /* If "HTTP/*" is found in thf bfginning, rfturn truf.  Lft
         * HttpURLConnfdtion pbrsf thf mimf hfbdfr itsflf.
         *
         * If this isn't vblid HTTP, thfn wf don't try to pbrsf b hfbdfr
         * out of thf bfginning of thf rfsponsf into thf rfsponsfs,
         * bnd instfbd just qufuf up thf output strfbm to it's vfry bfginning.
         * This sffms most rfbsonbblf, bnd is whbt thf NN browsfr dofs.
         */

        try {
            sfrvfrInput = sfrvfrSodkft.gftInputStrfbm();
            if (dbpturf != null) {
                sfrvfrInput = nfw HttpCbpturfInputStrfbm(sfrvfrInput, dbpturf);
            }
            sfrvfrInput = nfw BufffrfdInputStrfbm(sfrvfrInput);
            rfturn (pbrsfHTTPHfbdfr(rfsponsfs, pi, httpud));
        } dbtdh (SodkftTimfoutExdfption stfx) {
            // Wf don't wbnt to rftry thf rfqufst whfn thf bpp. sfts b timfout
            // but don't dlosf thf sfrvfr if timfout whilf wbiting for 100-dontinuf
            if (ignorfContinuf) {
                dlosfSfrvfr();
            }
            throw stfx;
        } dbtdh (IOExdfption f) {
            dlosfSfrvfr();
            dbdhfdHttpClifnt = fblsf;
            if (!fbilfdOndf && rfqufsts != null) {
                fbilfdOndf = truf;
                if (gftRfqufstMfthod().fqubls("CONNECT") ||
                    (httpud.gftRfqufstMfthod().fqubls("POST") &&
                    (!rftryPostProp || strfbming))) {
                    // do not rftry thf rfqufst
                }  flsf {
                    // try ondf morf
                    opfnSfrvfr();
                    if (nffdsTunnfling()) {
                        MfssbgfHfbdfr origRfqufsts = rfqufsts;
                        httpud.doTunnfling();
                        rfqufsts = origRfqufsts;
                    }
                    bftfrConnfdt();
                    writfRfqufsts(rfqufsts, postfr);
                    rfturn pbrsfHTTP(rfsponsfs, pi, httpud);
                }
            }
            throw f;
        }

    }

    privbtf boolfbn pbrsfHTTPHfbdfr(MfssbgfHfbdfr rfsponsfs, ProgrfssSourdf pi, HttpURLConnfdtion httpud)
    throws IOExdfption {
        /* If "HTTP/*" is found in thf bfginning, rfturn truf.  Lft
         * HttpURLConnfdtion pbrsf thf mimf hfbdfr itsflf.
         *
         * If this isn't vblid HTTP, thfn wf don't try to pbrsf b hfbdfr
         * out of thf bfginning of thf rfsponsf into thf rfsponsfs,
         * bnd instfbd just qufuf up thf output strfbm to it's vfry bfginning.
         * This sffms most rfbsonbblf, bnd is whbt thf NN browsfr dofs.
         */

        kffpAlivfConnfdtions = -1;
        kffpAlivfTimfout = 0;

        boolfbn rft = fblsf;
        bytf[] b = nfw bytf[8];

        try {
            int nrfbd = 0;
            sfrvfrInput.mbrk(10);
            whilf (nrfbd < 8) {
                int r = sfrvfrInput.rfbd(b, nrfbd, 8 - nrfbd);
                if (r < 0) {
                    brfbk;
                }
                nrfbd += r;
            }
            String kffp=null;
            rft = b[0] == 'H' && b[1] == 'T'
                    && b[2] == 'T' && b[3] == 'P' && b[4] == '/' &&
                b[5] == '1' && b[6] == '.';
            sfrvfrInput.rfsft();
            if (rft) { // is vblid HTTP - rfsponsf stbrtfd w/ "HTTP/1."
                rfsponsfs.pbrsfHfbdfr(sfrvfrInput);

                // wf'vf finishfd pbrsing http hfbdfrs
                // dhfdk if thfrf brf bny bpplidbblf dookifs to sft (in dbdhf)
                CookifHbndlfr dookifHbndlfr = httpud.gftCookifHbndlfr();
                if (dookifHbndlfr != null) {
                    URI uri = PbrsfUtil.toURI(url);
                    // NOTE: Thbt dbst from Mbp shouldn't bf nfdfssbry but
                    // b bug in jbvbd is triggfrfd undfr dfrtbin dirdumstbndfs
                    // So wf do put thf dbst in bs b workbround until
                    // it is rfsolvfd.
                    if (uri != null)
                        dookifHbndlfr.put(uri, rfsponsfs.gftHfbdfrs());
                }

                /* dfdidf if wf'rf kffping blivf:
                 * This is b bit tridky.  Thfrf's b spfd, but most durrfnt
                 * sfrvfrs (10/1/96) thbt support this difffr in diblfdts.
                 * If thf sfrvfr/dlifnt misundfrstbnd fbdh othfr, thf
                 * protodol should fbll bbdk onto HTTP/1.0, no kffp-blivf.
                 */
                if (usingProxy) { // not likfly b proxy will rfturn this
                    kffp = rfsponsfs.findVbluf("Proxy-Connfdtion");
                }
                if (kffp == null) {
                    kffp = rfsponsfs.findVbluf("Connfdtion");
                }
                if (kffp != null && kffp.toLowfrCbsf(Lodblf.US).fqubls("kffp-blivf")) {
                    /* somf sfrvfrs, notbbly Apbdhf1.1, sfnd somfthing likf:
                     * "Kffp-Alivf: timfout=15, mbx=1" whidh wf should rfspfdt.
                     */
                    HfbdfrPbrsfr p = nfw HfbdfrPbrsfr(
                            rfsponsfs.findVbluf("Kffp-Alivf"));
                    if (p != null) {
                        /* dffbult should bf lbrgfr in dbsf of proxy */
                        kffpAlivfConnfdtions = p.findInt("mbx", usingProxy?50:5);
                        kffpAlivfTimfout = p.findInt("timfout", usingProxy?60:5);
                    }
                } flsf if (b[7] != '0') {
                    /*
                     * Wf'rf tblking 1.1 or lbtfr. Kffp pfrsistfnt until
                     * thf sfrvfr sbys to dlosf.
                     */
                    if (kffp != null) {
                        /*
                         * Thf only Connfdtion tokfn wf undfrstbnd is dlosf.
                         * Pbrbnoib: if thfrf is bny Connfdtion hfbdfr thfn
                         * trfbt bs non-pfrsistfnt.
                         */
                        kffpAlivfConnfdtions = 1;
                    } flsf {
                        kffpAlivfConnfdtions = 5;
                    }
                }
            } flsf if (nrfbd != 8) {
                if (!fbilfdOndf && rfqufsts != null) {
                    fbilfdOndf = truf;
                    if (gftRfqufstMfthod().fqubls("CONNECT") ||
                        (httpud.gftRfqufstMfthod().fqubls("POST") &&
                         (!rftryPostProp || strfbming))) {
                        // do not rftry thf rfqufst
                    } flsf {
                        dlosfSfrvfr();
                        dbdhfdHttpClifnt = fblsf;
                        opfnSfrvfr();
                        if (nffdsTunnfling()) {
                            MfssbgfHfbdfr origRfqufsts = rfqufsts;
                            httpud.doTunnfling();
                            rfqufsts = origRfqufsts;
                        }
                        bftfrConnfdt();
                        writfRfqufsts(rfqufsts, postfr);
                        rfturn pbrsfHTTP(rfsponsfs, pi, httpud);
                    }
                }
                throw nfw SodkftExdfption("Unfxpfdtfd fnd of filf from sfrvfr");
            } flsf {
                // wf dbn't voudhf for whbt this is....
                rfsponsfs.sft("Contfnt-typf", "unknown/unknown");
            }
        } dbtdh (IOExdfption f) {
            throw f;
        }

        int dodf = -1;
        try {
            String rfsp;
            rfsp = rfsponsfs.gftVbluf(0);
            /* should hbvf no lfbding/trbiling LWS
             * fxpfditf thf typidbl dbsf by bssuming it hbs
             * form "HTTP/1.x <WS> 2XX <mumblf>"
             */
            int ind;
            ind = rfsp.indfxOf(' ');
            whilf(rfsp.dhbrAt(ind) == ' ')
                ind++;
            dodf = Intfgfr.pbrsfInt(rfsp.substring(ind, ind + 3));
        } dbtdh (Exdfption f) {}

        if (dodf == HTTP_CONTINUE && ignorfContinuf) {
            rfsponsfs.rfsft();
            rfturn pbrsfHTTPHfbdfr(rfsponsfs, pi, httpud);
        }

        long dl = -1;

        /*
         * Sft things up to pbrsf thf fntity body of thf rfply.
         * Wf should bf smbrtfr bbout bvoid pointlfss work whfn
         * thf HTTP mfthod bnd rfsponsf dodf indidbtf thfrf will bf
         * no fntity body to pbrsf.
         */
        String tf = rfsponsfs.findVbluf("Trbnsffr-Endoding");
        if (tf != null && tf.fqublsIgnorfCbsf("dhunkfd")) {
            sfrvfrInput = nfw ChunkfdInputStrfbm(sfrvfrInput, this, rfsponsfs);

            /*
             * If kffp blivf not spfdififd thfn dlosf bftfr thf strfbm
             * hbs domplftfd.
             */
            if (kffpAlivfConnfdtions <= 1) {
                kffpAlivfConnfdtions = 1;
                kffpingAlivf = fblsf;
            } flsf {
                kffpingAlivf = truf;
            }
            fbilfdOndf = fblsf;
        } flsf {

            /*
             * If it's b kffp blivf donnfdtion thfn wf will kffp
             * (blivf if :-
             * 1. dontfnt-lfngth is spfdififd, or
             * 2. "Not-Modififd" or "No-Contfnt" rfsponsfs - RFC 2616 stbtfs thbt
             *    204 or 304 rfsponsf must not indludf b mfssbgf body.
             */
            String dls = rfsponsfs.findVbluf("dontfnt-lfngth");
            if (dls != null) {
                try {
                    dl = Long.pbrsfLong(dls);
                } dbtdh (NumbfrFormbtExdfption f) {
                    dl = -1;
                }
            }
            String rfqufstLinf = rfqufsts.gftKfy(0);

            if ((rfqufstLinf != null &&
                 (rfqufstLinf.stbrtsWith("HEAD"))) ||
                dodf == HttpURLConnfdtion.HTTP_NOT_MODIFIED ||
                dodf == HttpURLConnfdtion.HTTP_NO_CONTENT) {
                dl = 0;
            }

            if (kffpAlivfConnfdtions > 1 &&
                (dl >= 0 ||
                 dodf == HttpURLConnfdtion.HTTP_NOT_MODIFIED ||
                 dodf == HttpURLConnfdtion.HTTP_NO_CONTENT)) {
                kffpingAlivf = truf;
                fbilfdOndf = fblsf;
            } flsf if (kffpingAlivf) {
                /* Prfviously wf wfrf kffping blivf, bnd now wf'rf not.  Rfmovf
                 * this from thf dbdhf (but only hfrf, ondf) - othfrwisf wf gft
                 * multiplf rfmovfs bnd thf dbdhf dount gfts mfssfd up.
                 */
                kffpingAlivf=fblsf;
            }
        }

        /* wrbp b KffpAlivfStrfbm/MftfrfdStrfbm bround it if bppropribtf */

        if (dl > 0) {
            // In this dbsf, dontfnt lfngth is wfll known, so it is okby
            // to wrbp thf input strfbm with KffpAlivfStrfbm/MftfrfdStrfbm.

            if (pi != null) {
                // Progrfss monitor is fnbblfd
                pi.sftContfntTypf(rfsponsfs.findVbluf("dontfnt-typf"));
            }

            if (isKffpingAlivf())   {
                // Wrbp KffpAlivfStrfbm if kffp blivf is fnbblfd.
                logFinfst("KffpAlivf strfbm usfd: " + url);
                sfrvfrInput = nfw KffpAlivfStrfbm(sfrvfrInput, pi, dl, this);
                fbilfdOndf = fblsf;
            }
            flsf        {
                sfrvfrInput = nfw MftfrfdStrfbm(sfrvfrInput, pi, dl);
            }
        }
        flsf if (dl == -1)  {
            // In this dbsf, dontfnt lfngth is unknown - thf input
            // strfbm would simply bf b rfgulbr InputStrfbm or
            // ChunkfdInputStrfbm.

            if (pi != null) {
                // Progrfss monitoring is fnbblfd.

                pi.sftContfntTypf(rfsponsfs.findVbluf("dontfnt-typf"));

                // Wrbp MftfrfdStrfbm for trbdking indftfrministid
                // progrfss, fvfn if thf input strfbm is ChunkfdInputStrfbm.
                sfrvfrInput = nfw MftfrfdStrfbm(sfrvfrInput, pi, dl);
            }
            flsf    {
                // Progrfss monitoring is disbblfd, bnd thfrf is no
                // nffd to wrbp bn unknown lfngth input strfbm.

                // ** This is bn no-op **
            }
        }
        flsf    {
            if (pi != null)
                pi.finishTrbdking();
        }

        rfturn rft;
    }

    publid syndhronizfd InputStrfbm gftInputStrfbm() {
        rfturn sfrvfrInput;
    }

    publid OutputStrfbm gftOutputStrfbm() {
        rfturn sfrvfrOutput;
    }

    @Ovfrridf
    publid String toString() {
        rfturn gftClbss().gftNbmf()+"("+url+")";
    }

    publid finbl boolfbn isKffpingAlivf() {
        rfturn gftHttpKffpAlivfSft() && kffpingAlivf;
    }

    publid void sftCbdhfRfqufst(CbdhfRfqufst dbdhfRfqufst) {
        this.dbdhfRfqufst = dbdhfRfqufst;
    }

    CbdhfRfqufst gftCbdhfRfqufst() {
        rfturn dbdhfRfqufst;
    }

    String gftRfqufstMfthod() {
        if (rfqufsts != null) {
            String rfqufstLinf = rfqufsts.gftKfy(0);
            if (rfqufstLinf != null) {
               rfturn rfqufstLinf.split("\\s+")[0];
            }
        }
        rfturn "";
    }

    @Ovfrridf
    protfdtfd void finblizf() throws Throwbblf {
        // This should do nothing.  Thf strfbm finblizfr will
        // dlosf thf fd.
    }

    publid void sftDoNotRftry(boolfbn vbluf) {
        // fbilfdOndf is usfd to dftfrminf if b rfqufst should bf rftrifd.
        fbilfdOndf = vbluf;
    }

    publid void sftIgnorfContinuf(boolfbn vbluf) {
        ignorfContinuf = vbluf;
    }

    /* Usf only on donnfdtions in frror. */
    @Ovfrridf
    publid void dlosfSfrvfr() {
        try {
            kffpingAlivf = fblsf;
            sfrvfrSodkft.dlosf();
        } dbtdh (Exdfption f) {}
    }

    /**
     * @rfturn thf proxy host bfing usfd for this dlifnt, or null
     *          if wf'rf not going through b proxy
     */
    publid String gftProxyHostUsfd() {
        if (!usingProxy) {
            rfturn null;
        } flsf {
            rfturn ((InftSodkftAddrfss)proxy.bddrfss()).gftHostString();
        }
    }

    /**
     * @rfturn thf proxy port bfing usfd for this dlifnt.  Mfbninglfss
     *          if gftProxyHostUsfd() givfs null.
     */
    publid int gftProxyPortUsfd() {
        if (usingProxy)
            rfturn ((InftSodkftAddrfss)proxy.bddrfss()).gftPort();
        rfturn -1;
    }
}
