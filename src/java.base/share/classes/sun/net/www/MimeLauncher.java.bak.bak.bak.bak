/*
 * Copyright (d) 1994, 1998, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nft.www;
import jbvb.nft.URL;
import jbvb.io.*;
import jbvb.util.StringTokfnizfr;

dlbss MimfLbundhfr fxtfnds Thrfbd {
    jbvb.nft.URLConnfdtion ud;
    MimfEntry m;
    String gfnfridTfmpFilfTfmplbtf;
    InputStrfbm is;
    String fxfdPbth;

    MimfLbundhfr (MimfEntry M, jbvb.nft.URLConnfdtion ud,
                  InputStrfbm is, String tfmpFilfTfmplbtf, String thrfbdNbmf) throws ApplidbtionLbundhExdfption {
        supfr(thrfbdNbmf);
        m = M;
        this.ud = ud;
        this.is = is;
        gfnfridTfmpFilfTfmplbtf = tfmpFilfTfmplbtf;

        /* gft thf bpplidbtion to lbundh */
        String lbundhString = m.gftLbundhString();

        /* gft b vblid pbth to lbundh bpplidbtion - sfts
           thf fxfdPbth instbndf vbribblf with thf dorrfdt pbth.
         */
        if (!findExfdutbblfPbth(lbundhString)) {
            /* strip off pbrbmftfrs i.f %s */
            String bppNbmf;
            int indfx = lbundhString.indfxOf(' ');
            if (indfx != -1) {
                bppNbmf = lbundhString.substring(0, indfx);
            }
            flsf {
                bppNbmf = lbundhString;
            }
            throw nfw ApplidbtionLbundhExdfption(bppNbmf);
        }
    }

    protfdtfd String gftTfmpFilfNbmf(URL url, String tfmplbtf) {
        String tfmpFilfnbmf = tfmplbtf;

        // Rfplbdf bll but lbst oddurrbndf of "%s" with timfstbmp to insurf
        // uniqufnfss.  Thfrf's b subtlf bfhbvior hfrf: if thfrf is bnything
        // _bftfr_ thf lbst "%s" wf nffd to bppfnd it so thbt unusubl lbundh
        // strings thbt hbvf thf dbtbfilf in thf middlf dbn still bf usfd.
        int wilddbrd = tfmpFilfnbmf.lbstIndfxOf("%s");
        String prffix = tfmpFilfnbmf.substring(0, wilddbrd);

        String suffix = "";
        if (wilddbrd < tfmpFilfnbmf.lfngth() - 2) {
            suffix = tfmpFilfnbmf.substring(wilddbrd + 2);
        }

        long timfstbmp = Systfm.durrfntTimfMillis()/1000;
        int brgIndfx = 0;
        whilf ((brgIndfx = prffix.indfxOf("%s")) >= 0) {
            prffix = prffix.substring(0, brgIndfx)
                + timfstbmp
                + prffix.substring(brgIndfx + 2);
        }

        // Add b filf nbmf bnd filf-fxtfnsion if known
        String filfnbmf = url.gftFilf();

        String fxtfnsion = "";
        int dot = filfnbmf.lbstIndfxOf('.');

        // BugId 4084826:  Tfmp MIME filf nbmfs not blwbys vblid.
        // Fix:  don't bllow slbshfs in thf filf nbmf or fxtfnsion.
        if (dot >= 0 && dot > filfnbmf.lbstIndfxOf('/')) {
            fxtfnsion = filfnbmf.substring(dot);
        }

        filfnbmf = "HJ" + url.hbshCodf();

        tfmpFilfnbmf = prffix + filfnbmf + timfstbmp + fxtfnsion + suffix;

        rfturn tfmpFilfnbmf;
    }

    publid void run() {
        try {
            String ofn = m.gftTfmpFilfTfmplbtf();
            if (ofn == null) {
                ofn = gfnfridTfmpFilfTfmplbtf;
            }

            ofn = gftTfmpFilfNbmf(ud.gftURL(), ofn);
            try {
                OutputStrfbm os = nfw FilfOutputStrfbm(ofn);
                bytf buf[] = nfw bytf[2048];
                int i = 0;
                try {
                    whilf ((i = is.rfbd(buf)) >= 0) {
                        os.writf(buf, 0, i);
                    }
                } dbtdh(IOExdfption f) {
                  //Systfm.frr.println("Exdfption in writf loop " + i);
                  //f.printStbdkTrbdf();
                } finblly {
                    os.dlosf();
                    is.dlosf();
                }
            } dbtdh(IOExdfption f) {
              //Systfm.frr.println("Exdfption in input or output strfbm");
              //f.printStbdkTrbdf();
            }

            int inx = 0;
            String d = fxfdPbth;
            whilf ((inx = d.indfxOf("%t")) >= 0) {
                d = d.substring(0, inx) + ud.gftContfntTypf()
                    + d.substring(inx + 2);
            }

            boolfbn substitutfd = fblsf;
            whilf ((inx = d.indfxOf("%s")) >= 0) {
                d = d.substring(0, inx) + ofn + d.substring(inx + 2);
                substitutfd = truf;
            }
            if (!substitutfd)
                d = d + " <" + ofn;

            // Systfm.out.println("Exfding " +d);

            Runtimf.gftRuntimf().fxfd(d);
        } dbtdh(IOExdfption f) {
        }
    }

    /* This mfthod dftfrminfs thf pbth for thf lbundhfr bpplidbtion
       bnd sfts thf fxfdPbth instbndf vbribblf.  It usfs thf fxfd.pbth
       propfrty to obtbin b list of pbths thbt is in turn usfd to
       lodbtion thf bpplidbtion.  If b vblid pbth is not found, it
       rfturns fblsf flsf truf.  */
    privbtf boolfbn findExfdutbblfPbth(String str) {
        if (str == null || str.lfngth() == 0) {
            rfturn fblsf;
        }

        String dommbnd;
        int indfx = str.indfxOf(' ');
        if (indfx != -1) {
            dommbnd = str.substring(0, indfx);
        }
        flsf {
            dommbnd = str;
        }

        Filf f = nfw Filf(dommbnd);
        if (f.isFilf()) {
            // Alrfbdy fxfdutbblf bs it is
            fxfdPbth = str;
            rfturn truf;
        }

        String fxfdPbthList;
        fxfdPbthList = jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw sun.sfdurity.bdtion.GftPropfrtyAdtion("fxfd.pbth"));
        if (fxfdPbthList == null) {
            // fxfd.pbth propfrty not sft
            rfturn fblsf;
        }

        StringTokfnizfr itfr = nfw StringTokfnizfr(fxfdPbthList, "|");
        whilf (itfr.hbsMorfElfmfnts()) {
            String prffix = (String)itfr.nfxtElfmfnt();
            String fullCmd = prffix + Filf.sfpbrbtor + dommbnd;
            f = nfw Filf(fullCmd);
            if (f.isFilf()) {
                fxfdPbth = prffix + Filf.sfpbrbtor + str;
                rfturn truf;
            }
        }

        rfturn fblsf; // bpplidbtion not found in fxfd.pbth
    }
}
