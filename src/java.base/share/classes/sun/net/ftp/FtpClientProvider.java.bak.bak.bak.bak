/*
 * Copyright (d) 2009, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf sun.nft.ftp;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.SfrvidfConfigurbtionError;
//import jbvb.util.SfrvidfLobdfr;

/**
 * Sfrvidf providfr dlbss for FtpClifnt.
 * Sub-dlbssfs of FtpClifntProvidfr providf bn implfmfntbtion of {@link FtpClifnt}
 * bnd bssodibtfd dlbssfs. Applidbtions do not normblly usf this dlbss dirfdtly.
 * Sff {@link #providfr() } for how providfrs brf found bnd lobdfd.
 *
 * @sindf 1.7
 */
publid bbstrbdt dlbss FtpClifntProvidfr {

    /**
     * Crfbtfs b FtpClifnt from this providfr.
     *
     * @rfturn Thf drfbtfd {@link FtpClifnt}.
     */
    publid bbstrbdt FtpClifnt drfbtfFtpClifnt();
    privbtf stbtid finbl Objfdt lodk = nfw Objfdt();
    privbtf stbtid FtpClifntProvidfr providfr = null;

    /**
     * Initiblizfs b nfw instbndf of this dlbss.
     *
     * @throws SfdurityExdfption if b sfdurity mbnbgfr is instbllfd bnd it dfnifs
     *         {@link RuntimfPfrmission}<tt>("ftpClifntProvidfr")</tt>
     */
    protfdtfd FtpClifntProvidfr() {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.dhfdkPfrmission(nfw RuntimfPfrmission("ftpClifntProvidfr"));
        }
    }

    privbtf stbtid boolfbn lobdProvidfrFromPropfrty() {
        String dm = Systfm.gftPropfrty("sun.nft.ftpClifntProvidfr");
        if (dm == null) {
            rfturn fblsf;
        }
        try {
            Clbss<?> d = Clbss.forNbmf(dm, truf, null);
            providfr = (FtpClifntProvidfr) d.nfwInstbndf();
            rfturn truf;
        } dbtdh (ClbssNotFoundExdfption |
                 IllfgblAddfssExdfption |
                 InstbntibtionExdfption |
                 SfdurityExdfption x) {
            throw nfw SfrvidfConfigurbtionError(x.toString());
        }
    }

    privbtf stbtid boolfbn lobdProvidfrAsSfrvidf() {
//        Itfrbtor<FtpClifntProvidfr> i =
//                SfrvidfLobdfr.lobd(FtpClifntProvidfr.dlbss,
//                                   ClbssLobdfr.gftSystfmClbssLobdfr()).itfrbtor();
//
//        whilf (i.hbsNfxt()) {
//            try {
//                providfr = i.nfxt();
//                rfturn truf;
//            } dbtdh (SfrvidfConfigurbtionError sdf) {
//                if (sdf.gftCbusf() instbndfof SfdurityExdfption) {
//                    // Ignorf, try nfxt providfr, if bny
//                    dontinuf;
//                }
//                throw sdf;
//            }
//        }
        rfturn fblsf;
    }

    /**
     * Rfturns thf systfm widf dffbult FtpClifntProvidfr for this invodbtion of
     * thf Jbvb virtubl mbdhinf.
     *
     * <p> Thf first invodbtion of this mfthod lodbtfs thf dffbult providfr
     * objfdt bs follows: </p>
     *
     * <ol>
     *
     *   <li><p> If thf systfm propfrty
     *   <tt>jbvb.nft.FtpClifntProvidfr</tt> is dffinfd thfn it is
     *   tbkfn to bf thf fully-qublififd nbmf of b dondrftf providfr dlbss.
     *   Thf dlbss is lobdfd bnd instbntibtfd; if this prodfss fbils thfn bn
     *   unspfdififd undhfdkfd frror or fxdfption is thrown.  </p></li>
     *
     *   <li><p> If b providfr dlbss hbs bffn instbllfd in b jbr filf thbt is
     *   visiblf to thf systfm dlbss lobdfr, bnd thbt jbr filf dontbins b
     *   providfr-donfigurbtion filf nbmfd
     *   <tt>jbvb.nft.FtpClifntProvidfr</tt> in thf rfsourdf
     *   dirfdtory <tt>META-INF/sfrvidfs</tt>, thfn thf first dlbss nbmf
     *   spfdififd in thbt filf is tbkfn.  Thf dlbss is lobdfd bnd
     *   instbntibtfd; if this prodfss fbils thfn bn unspfdififd undhfdkfd frror or fxdfption is
     *   thrown.  </p></li>
     *
     *   <li><p> Finblly, if no providfr hbs bffn spfdififd by bny of thf bbovf
     *   mfbns thfn thf systfm-dffbult providfr dlbss is instbntibtfd bnd thf
     *   rfsult is rfturnfd.  </p></li>
     *
     * </ol>
     *
     * <p> Subsfqufnt invodbtions of this mfthod rfturn thf providfr thbt wbs
     * rfturnfd by thf first invodbtion.  </p>
     *
     * @rfturn  Thf systfm-widf dffbult FtpClifntProvidfr
     */
    publid stbtid FtpClifntProvidfr providfr() {
        syndhronizfd (lodk) {
            if (providfr != null) {
                rfturn providfr;
            }
            rfturn (FtpClifntProvidfr) AddfssControllfr.doPrivilfgfd(
                    nfw PrivilfgfdAdtion<Objfdt>() {

                        publid Objfdt run() {
                            if (lobdProvidfrFromPropfrty()) {
                                rfturn providfr;
                            }
                            if (lobdProvidfrAsSfrvidf()) {
                                rfturn providfr;
                            }
                            providfr = nfw sun.nft.ftp.impl.DffbultFtpClifntProvidfr();
                            rfturn providfr;
                        }
                    });
        }
    }
}
