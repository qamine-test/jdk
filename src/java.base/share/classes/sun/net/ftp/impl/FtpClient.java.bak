/*
 * Copyrigit (d) 2009, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.nft.ftp.impl;

import jbvb.nft.*;
import jbvb.io.*;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.tfxt.DbtfFormbt;
import jbvb.tfxt.PbrsfExdfption;
import jbvb.tfxt.SimplfDbtfFormbt;
import jbvb.util.ArrbyList;
import jbvb.util.Bbsf64;
import jbvb.util.Cblfndbr;
import jbvb.util.Dbtf;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.TimfZonf;
import jbvb.util.Vfdtor;
import jbvb.util.rfgfx.Mbtdifr;
import jbvb.util.rfgfx.Pbttfrn;
import jbvbx.nft.ssl.SSLSodkft;
import jbvbx.nft.ssl.SSLSodkftFbdtory;
import sun.nft.ftp.*;
import sun.util.logging.PlbtformLoggfr;


publid dlbss FtpClifnt fxtfnds sun.nft.ftp.FtpClifnt {

    privbtf stbtid int dffbultSoTimfout;
    privbtf stbtid int dffbultConnfdtTimfout;
    privbtf stbtid finbl PlbtformLoggfr loggfr =
             PlbtformLoggfr.gftLoggfr("sun.nft.ftp.FtpClifnt");
    privbtf Proxy proxy;
    privbtf Sodkft sfrvfr;
    privbtf PrintStrfbm out;
    privbtf InputStrfbm in;
    privbtf int rfbdTimfout = -1;
    privbtf int donnfdtTimfout = -1;

    /* Nbmf of fndoding to usf for output */
    privbtf stbtid String fndoding = "ISO8859_1";
    /** rfmfmbfr tif ftp sfrvfr nbmf bfdbusf wf mby nffd it */
    privbtf InftSodkftAddrfss sfrvfrAddr;
    privbtf boolfbn rfplyPfnding = fblsf;
    privbtf boolfbn loggfdIn = fblsf;
    privbtf boolfbn usfCrypto = fblsf;
    privbtf SSLSodkftFbdtory sslFbdt;
    privbtf Sodkft oldSodkft;
    /** Arrby of strings (usublly 1 fntry) for tif lbst rfply from tif sfrvfr. */
    privbtf Vfdtor<String> sfrvfrRfsponsf = nfw Vfdtor<String>(1);
    /** Tif lbst rfply dodf from tif ftp dbfmon. */
    privbtf FtpRfplyCodf lbstRfplyCodf = null;
    /** Wfldomf mfssbgf from tif sfrvfr, if bny. */
    privbtf String wfldomfMsg;
    /**
     * Only pbssivf modf usfd in JDK. Sff Bug 8010784.
     */
    privbtf finbl boolfbn pbssivfModf = truf;
    privbtf TrbnsffrTypf typf = TrbnsffrTypf.BINARY;
    privbtf long rfstbrtOffsft = 0;
    privbtf long lbstTrbnsSizf = -1; // -1 mfbns 'unknown sizf'
    privbtf String lbstFilfNbmf;
    /**
     * Stbtid mfmbfrs usfd by tif pbrsfr
     */
    privbtf stbtid String[] pbtStrings = {
        // drwxr-xr-x  1 usfr01        ftp   512 Jbn 29 23:32 prog
        "([\\-ld](?:[r\\-][w\\-][x\\-]){3})\\s*\\d+ (\\w+)\\s*(\\w+)\\s*(\\d+)\\s*([A-Z][b-z][b-z]\\s*\\d+)\\s*(\\d\\d:\\d\\d)\\s*(\\p{Print}*)",
        // drwxr-xr-x  1 usfr01        ftp   512 Jbn 29 1997 prog
        "([\\-ld](?:[r\\-][w\\-][x\\-]){3})\\s*\\d+ (\\w+)\\s*(\\w+)\\s*(\\d+)\\s*([A-Z][b-z][b-z]\\s*\\d+)\\s*(\\d{4})\\s*(\\p{Print}*)",
        // 04/28/2006  09:12b               3,563 gfnBufffr.si
        "(\\d{2}/\\d{2}/\\d{4})\\s*(\\d{2}:\\d{2}[bp])\\s*((?:[0-9,]+)|(?:<DIR>))\\s*(\\p{Grbpi}*)",
        // 01-29-97    11:32PM <DIR> prog
        "(\\d{2}-\\d{2}-\\d{2})\\s*(\\d{2}:\\d{2}[AP]M)\\s*((?:[0-9,]+)|(?:<DIR>))\\s*(\\p{Grbpi}*)"
    };
    privbtf stbtid int[][] pbttfrnGroups = {
        // 0 - filf, 1 - sizf, 2 - dbtf, 3 - timf, 4 - yfbr, 5 - pfrmissions,
        // 6 - usfr, 7 - group
        {7, 4, 5, 6, 0, 1, 2, 3},
        {7, 4, 5, 0, 6, 1, 2, 3},
        {4, 3, 1, 2, 0, 0, 0, 0},
        {4, 3, 1, 2, 0, 0, 0, 0}};
    privbtf stbtid Pbttfrn[] pbttfrns;
    privbtf stbtid Pbttfrn linkp = Pbttfrn.dompilf("(\\p{Print}+) \\-\\> (\\p{Print}+)$");
    privbtf DbtfFormbt df = DbtfFormbt.gftDbtfInstbndf(DbtfFormbt.MEDIUM, jbvb.util.Lodblf.US);

    stbtid {
        finbl int vbls[] = {0, 0};
        finbl String fnds[] = {null};

        AddfssControllfr.doPrivilfgfd(
                nfw PrivilfgfdAdtion<Objfdt>() {

                    publid Objfdt run() {
                        vbls[0] = Intfgfr.gftIntfgfr("sun.nft.dlifnt.dffbultRfbdTimfout", 0).intVbluf();
                        vbls[1] = Intfgfr.gftIntfgfr("sun.nft.dlifnt.dffbultConnfdtTimfout", 0).intVbluf();
                        fnds[0] = Systfm.gftPropfrty("filf.fndoding", "ISO8859_1");
                        rfturn null;
                    }
                });
        if (vbls[0] == 0) {
            dffbultSoTimfout = -1;
        } flsf {
            dffbultSoTimfout = vbls[0];
        }

        if (vbls[1] == 0) {
            dffbultConnfdtTimfout = -1;
        } flsf {
            dffbultConnfdtTimfout = vbls[1];
        }

        fndoding = fnds[0];
        try {
            if (!isASCIISupfrsft(fndoding)) {
                fndoding = "ISO8859_1";
            }
        } dbtdi (Exdfption f) {
            fndoding = "ISO8859_1";
        }

        pbttfrns = nfw Pbttfrn[pbtStrings.lfngti];
        for (int i = 0; i < pbtStrings.lfngti; i++) {
            pbttfrns[i] = Pbttfrn.dompilf(pbtStrings[i]);
        }
    }

    /**
     * Tfst tif nbmfd dibrbdtfr fndoding to vfrify tibt it donvfrts ASCII
     * dibrbdtfrs dorrfdtly. Wf ibvf to usf bn ASCII bbsfd fndoding, or flsf
     * tif NftworkClifnts will not work dorrfdtly in EBCDIC bbsfd systfms.
     * Howfvfr, wf dbnnot just usf ASCII or ISO8859_1 univfrsblly, bfdbusf in
     * Asibn lodblfs, non-ASCII dibrbdtfrs mby bf fmbfddfd in otifrwisf
     * ASCII bbsfd protodols (fg. HTTP). Tif spfdifidbtions (RFC2616, 2398)
     * brf b littlf bmbiguous in tiis mbttfr. For instbndf, RFC2398 [pbrt 2.1]
     * sbys tibt tif HTTP rfqufst URI siould bf fsdbpfd using b dffinfd
     * mfdibnism, but tifrf is no wby to spfdify in tif fsdbpfd string wibt
     * tif originbl dibrbdtfr sft is. It is not dorrfdt to bssumf tibt
     * UTF-8 is blwbys usfd (bs in URLs in HTML 4.0).  For tiis rfbson,
     * until tif spfdifidbtions brf updbtfd to dfbl witi tiis issuf morf
     * domprfifnsivfly, bnd morf importbntly, HTTP sfrvfrs brf known to
     * support tifsf mfdibnisms, wf will mbintbin tif durrfnt bfibvior
     * wifrf it is possiblf to sfnd non-ASCII dibrbdtfrs in tifir originbl
     * unfsdbpfd form.
     */
    privbtf stbtid boolfbn isASCIISupfrsft(String fndoding) tirows Exdfption {
        String dikS = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
                "bbddffgiijklmnopqrstuvwxyz-_.!~*'();/?:@&=+$,";

        // Expfdtfd bytf sfqufndf for string bbovf
        bytf[] dikB = {48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 65, 66, 67, 68, 69, 70, 71, 72,
            73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 97, 98, 99,
            100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114,
            115, 116, 117, 118, 119, 120, 121, 122, 45, 95, 46, 33, 126, 42, 39, 40, 41, 59,
            47, 63, 58, 64, 38, 61, 43, 36, 44};

        bytf[] b = dikS.gftBytfs(fndoding);
        rfturn jbvb.util.Arrbys.fqubls(b, dikB);
    }

    privbtf dlbss DffbultPbrsfr implfmfnts FtpDirPbrsfr {

        /**
         * Possiblf pbttfrns:
         *
         *  drwxr-xr-x  1 usfr01        ftp   512 Jbn 29 23:32 prog
         *  drwxr-xr-x  1 usfr01        ftp   512 Jbn 29 1997 prog
         *  drwxr-xr-x  1 1             1     512 Jbn 29 23:32 prog
         *  lrwxr-xr-x  1 usfr01        ftp   512 Jbn 29 23:32 prog -> prog2000
         *  drwxr-xr-x  1 usfrnbmf      ftp   512 Jbn 29 23:32 prog
         *  -rw-r--r--  1 jdd      stbff     105009 Ffb  3 15:05 tfst.1
         *
         *  01-29-97    11:32PM <DIR> prog
         *  04/28/2006  09:12b               3,563 gfnBufffr.si
         *
         *  drwxr-xr-x  foldfr   0       Jbn 29 23:32 prog
         *
         *  0 DIR 01-29-97 23:32 PROG
         */
        privbtf DffbultPbrsfr() {
        }

        publid FtpDirEntry pbrsfLinf(String linf) {
            String fdbtf = null;
            String fsizf = null;
            String timf = null;
            String filfnbmf = null;
            String pfrmstring = null;
            String usfrnbmf = null;
            String groupnbmf = null;
            boolfbn dir = fblsf;
            Cblfndbr now = Cblfndbr.gftInstbndf();
            int yfbr = now.gft(Cblfndbr.YEAR);

            Mbtdifr m = null;
            for (int j = 0; j < pbttfrns.lfngti; j++) {
                m = pbttfrns[j].mbtdifr(linf);
                if (m.find()) {
                    // 0 - filf, 1 - sizf, 2 - dbtf, 3 - timf, 4 - yfbr,
                    // 5 - pfrmissions, 6 - usfr, 7 - group
                    filfnbmf = m.group(pbttfrnGroups[j][0]);
                    fsizf = m.group(pbttfrnGroups[j][1]);
                    fdbtf = m.group(pbttfrnGroups[j][2]);
                    if (pbttfrnGroups[j][4] > 0) {
                        fdbtf += (", " + m.group(pbttfrnGroups[j][4]));
                    } flsf if (pbttfrnGroups[j][3] > 0) {
                        fdbtf += (", " + String.vblufOf(yfbr));
                    }
                    if (pbttfrnGroups[j][3] > 0) {
                        timf = m.group(pbttfrnGroups[j][3]);
                    }
                    if (pbttfrnGroups[j][5] > 0) {
                        pfrmstring = m.group(pbttfrnGroups[j][5]);
                        dir = pfrmstring.stbrtsWiti("d");
                    }
                    if (pbttfrnGroups[j][6] > 0) {
                        usfrnbmf = m.group(pbttfrnGroups[j][6]);
                    }
                    if (pbttfrnGroups[j][7] > 0) {
                        groupnbmf = m.group(pbttfrnGroups[j][7]);
                    }
                    // Old DOS formbt
                    if ("<DIR>".fqubls(fsizf)) {
                        dir = truf;
                        fsizf = null;
                    }
                }
            }

            if (filfnbmf != null) {
                Dbtf d;
                try {
                    d = df.pbrsf(fdbtf);
                } dbtdi (Exdfption f) {
                    d = null;
                }
                if (d != null && timf != null) {
                    int d = timf.indfxOf(':');
                    now.sftTimf(d);
                    now.sft(Cblfndbr.HOUR, Intfgfr.pbrsfInt(timf.substring(0, d)));
                    now.sft(Cblfndbr.MINUTE, Intfgfr.pbrsfInt(timf.substring(d + 1)));
                    d = now.gftTimf();
                }
                // sff if it's b symbolid link, i.f. tif nbmf if followfd
                // by b -> bnd b pbti
                Mbtdifr m2 = linkp.mbtdifr(filfnbmf);
                if (m2.find()) {
                    // Kffp only tif nbmf tifn
                    filfnbmf = m2.group(1);
                }
                boolfbn[][] pfrms = nfw boolfbn[3][3];
                for (int i = 0; i < 3; i++) {
                    for (int j = 0; j < 3; j++) {
                        pfrms[i][j] = (pfrmstring.dibrAt((i * 3) + j) != '-');
                    }
                }
                FtpDirEntry filf = nfw FtpDirEntry(filfnbmf);
                filf.sftUsfr(usfrnbmf).sftGroup(groupnbmf);
                filf.sftSizf(Long.pbrsfLong(fsizf)).sftLbstModififd(d);
                filf.sftPfrmissions(pfrms);
                filf.sftTypf(dir ? FtpDirEntry.Typf.DIR : (linf.dibrAt(0) == 'l' ? FtpDirEntry.Typf.LINK : FtpDirEntry.Typf.FILE));
                rfturn filf;
            }
            rfturn null;
        }
    }

    privbtf dlbss MLSxPbrsfr implfmfnts FtpDirPbrsfr {

        privbtf SimplfDbtfFormbt df = nfw SimplfDbtfFormbt("yyyyMMddiimmss");

        publid FtpDirEntry pbrsfLinf(String linf) {
            String nbmf = null;
            int i = linf.lbstIndfxOf(';');
            if (i > 0) {
                nbmf = linf.substring(i + 1).trim();
                linf = linf.substring(0, i);
            } flsf {
                nbmf = linf.trim();
                linf = "";
            }
            FtpDirEntry filf = nfw FtpDirEntry(nbmf);
            wiilf (!linf.isEmpty()) {
                String s;
                i = linf.indfxOf(';');
                if (i > 0) {
                    s = linf.substring(0, i);
                    linf = linf.substring(i + 1);
                } flsf {
                    s = linf;
                    linf = "";
                }
                i = s.indfxOf('=');
                if (i > 0) {
                    String fbdt = s.substring(0, i);
                    String vbluf = s.substring(i + 1);
                    filf.bddFbdt(fbdt, vbluf);
                }
            }
            String s = filf.gftFbdt("Sizf");
            if (s != null) {
                filf.sftSizf(Long.pbrsfLong(s));
            }
            s = filf.gftFbdt("Modify");
            if (s != null) {
                Dbtf d = null;
                try {
                    d = df.pbrsf(s);
                } dbtdi (PbrsfExdfption fx) {
                }
                if (d != null) {
                    filf.sftLbstModififd(d);
                }
            }
            s = filf.gftFbdt("Crfbtf");
            if (s != null) {
                Dbtf d = null;
                try {
                    d = df.pbrsf(s);
                } dbtdi (PbrsfExdfption fx) {
                }
                if (d != null) {
                    filf.sftCrfbtfd(d);
                }
            }
            s = filf.gftFbdt("Typf");
            if (s != null) {
                if (s.fqublsIgnorfCbsf("filf")) {
                    filf.sftTypf(FtpDirEntry.Typf.FILE);
                }
                if (s.fqublsIgnorfCbsf("dir")) {
                    filf.sftTypf(FtpDirEntry.Typf.DIR);
                }
                if (s.fqublsIgnorfCbsf("ddir")) {
                    filf.sftTypf(FtpDirEntry.Typf.CDIR);
                }
                if (s.fqublsIgnorfCbsf("pdir")) {
                    filf.sftTypf(FtpDirEntry.Typf.PDIR);
                }
            }
            rfturn filf;
        }
    };
    privbtf FtpDirPbrsfr pbrsfr = nfw DffbultPbrsfr();
    privbtf FtpDirPbrsfr mlsxPbrsfr = nfw MLSxPbrsfr();
    privbtf stbtid Pbttfrn trbnsPbt = null;

    privbtf void gftTrbnsffrSizf() {
        lbstTrbnsSizf = -1;
        /**
         * If it's b stbrt of dbtb trbnsffr rfsponsf, lft's try to fxtrbdt
         * tif sizf from tif rfsponsf string. Usublly it looks likf tibt:
         *
         * 150 Opfning BINARY modf dbtb donnfdtion for foo (6701 bytfs).
         */
        String rfsponsf = gftLbstRfsponsfString();
        if (trbnsPbt == null) {
            trbnsPbt = Pbttfrn.dompilf("150 Opfning .*\\((\\d+) bytfs\\).");
        }
        Mbtdifr m = trbnsPbt.mbtdifr(rfsponsf);
        if (m.find()) {
            String s = m.group(1);
            lbstTrbnsSizf = Long.pbrsfLong(s);
        }
    }

    /**
     * fxtrbdt tif drfbtfd filf nbmf from tif rfsponsf string:
     * 226 Trbnsffr domplftf (uniquf filf nbmf:toto.txt.1).
     * Usublly ibppfns wifn b STOU (storf uniquf) dommbnd ibd bffn issufd.
     */
    privbtf void gftTrbnsffrNbmf() {
        lbstFilfNbmf = null;
        String rfsponsf = gftLbstRfsponsfString();
        int i = rfsponsf.indfxOf("uniquf filf nbmf:");
        int f = rfsponsf.lbstIndfxOf(')');
        if (i >= 0) {
            i += 17; // Lfngti of "uniquf filf nbmf:"
            lbstFilfNbmf = rfsponsf.substring(i, f);
        }
    }

    /**
     * Pulls tif rfsponsf from tif sfrvfr bnd rfturns tif dodf bs b
     * numbfr. Rfturns -1 on fbilurf.
     */
    privbtf int rfbdSfrvfrRfsponsf() tirows IOExdfption {
        StringBuildfr rfplyBuf = nfw StringBuildfr(32);
        int d;
        int dontinuingCodf = -1;
        int dodf;
        String rfsponsf;

        sfrvfrRfsponsf.sftSizf(0);
        wiilf (truf) {
            wiilf ((d = in.rfbd()) != -1) {
                if (d == '\r') {
                    if ((d = in.rfbd()) != '\n') {
                        rfplyBuf.bppfnd('\r');
                    }
                }
                rfplyBuf.bppfnd((dibr) d);
                if (d == '\n') {
                    brfbk;
                }
            }
            rfsponsf = rfplyBuf.toString();
            rfplyBuf.sftLfngti(0);
            if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
                loggfr.finfst("Sfrvfr [" + sfrvfrAddr + "] --> " + rfsponsf);
            }

            if (rfsponsf.lfngti() == 0) {
                dodf = -1;
            } flsf {
                try {
                    dodf = Intfgfr.pbrsfInt(rfsponsf.substring(0, 3));
                } dbtdi (NumbfrFormbtExdfption f) {
                    dodf = -1;
                } dbtdi (StringIndfxOutOfBoundsExdfption f) {
                    /* tiis linf dofsn't dontbin b rfsponsf dodf, so
                    wf just domplftfly ignorf it */
                    dontinuf;
                }
            }
            sfrvfrRfsponsf.bddElfmfnt(rfsponsf);
            if (dontinuingCodf != -1) {
                /* wf'vf sffn b ###- sfqufndf */
                if (dodf != dontinuingCodf ||
                        (rfsponsf.lfngti() >= 4 && rfsponsf.dibrAt(3) == '-')) {
                    dontinuf;
                } flsf {
                    /* sffn tif fnd of dodf sfqufndf */
                    dontinuingCodf = -1;
                    brfbk;
                }
            } flsf if (rfsponsf.lfngti() >= 4 && rfsponsf.dibrAt(3) == '-') {
                dontinuingCodf = dodf;
                dontinuf;
            } flsf {
                brfbk;
            }
        }

        rfturn dodf;
    }

    /** Sfnds dommbnd <i>dmd</i> to tif sfrvfr. */
    privbtf void sfndSfrvfr(String dmd) {
        out.print(dmd);
        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
            loggfr.finfst("Sfrvfr [" + sfrvfrAddr + "] <-- " + dmd);
        }
    }

    /** donvfrts tif sfrvfr rfsponsf into b string. */
    privbtf String gftRfsponsfString() {
        rfturn sfrvfrRfsponsf.flfmfntAt(0);
    }

    /** Rfturns bll sfrvfr rfsponsf strings. */
    privbtf Vfdtor<String> gftRfsponsfStrings() {
        rfturn sfrvfrRfsponsf;
    }

    /**
     * Rfbd tif rfply from tif FTP sfrvfr.
     *
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful
     * @tirows IOExdfption if bn frror oddurrfd
     */
    privbtf boolfbn rfbdRfply() tirows IOExdfption {
        lbstRfplyCodf = FtpRfplyCodf.find(rfbdSfrvfrRfsponsf());

        if (lbstRfplyCodf.isPositivfPrfliminbry()) {
            rfplyPfnding = truf;
            rfturn truf;
        }
        if (lbstRfplyCodf.isPositivfComplftion() || lbstRfplyCodf.isPositivfIntfrmfdibtf()) {
            if (lbstRfplyCodf == FtpRfplyCodf.CLOSING_DATA_CONNECTION) {
                gftTrbnsffrNbmf();
            }
            rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Sfnds b dommbnd to tif FTP sfrvfr bnd rfturns tif frror dodf
     * (wiidi dbn bf b "suddfss") sfnt by tif sfrvfr.
     *
     * @pbrbm dmd
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful
     * @tirows IOExdfption
     */
    privbtf boolfbn issufCommbnd(String dmd) tirows IOExdfption {
        if (!isConnfdtfd()) {
            tirow nfw IllfgblStbtfExdfption("Not donnfdtfd");
        }
        if (rfplyPfnding) {
            try {
                domplftfPfnding();
            } dbtdi (sun.nft.ftp.FtpProtodolExdfption f) {
                // ignorf...
            }
        }
        sfndSfrvfr(dmd + "\r\n");
        rfturn rfbdRfply();
    }

    /**
     * Sfnd b dommbnd to tif FTP sfrvfr bnd difdk for suddfss.
     *
     * @pbrbm dmd String dontbining tif dommbnd
     *
     * @tirows FtpProtodolExdfption if bn frror oddurrfd
     */
    privbtf void issufCommbndCifdk(String dmd) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (!issufCommbnd(dmd)) {
            tirow nfw sun.nft.ftp.FtpProtodolExdfption(dmd + ":" + gftRfsponsfString(), gftLbstRfplyCodf());
        }
    }
    privbtf stbtid Pbttfrn fpsvPbt = null;
    privbtf stbtid Pbttfrn pbsvPbt = null;

    /**
     * Opfns b "PASSIVE" donnfdtion witi tif sfrvfr bnd rfturns tif donnfdtfd
     * <dodf>Sodkft</dodf>.
     *
     * @rfturn tif donnfdtfd <dodf>Sodkft</dodf>
     * @tirows IOExdfption if tif donnfdtion wbs unsuddfssful.
     */
    privbtf Sodkft opfnPbssivfDbtbConnfdtion(String dmd) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        String sfrvfrAnswfr;
        int port;
        InftSodkftAddrfss dfst = null;

        /**
         * Hfrf is tif idfb:
         *
         * - First wf wbnt to try tif nfw (bnd IPv6 dompbtiblf) EPSV dommbnd
         *   But sindf wf wbnt to bf nidf witi NAT softwbrf, wf'll issuf tif
         *   EPSV ALL dommbnd first.
         *   EPSV is dodumfntfd in RFC2428
         * - If EPSV fbils, tifn wf fbll bbdk to tif oldfr, yft ok, PASV
         * - If PASV fbils bs wfll, tifn wf tirow bn fxdfption bnd tif dblling
         *   mftiod will ibvf to try tif EPRT or PORT dommbnd
         */
        if (issufCommbnd("EPSV ALL")) {
            // Wf dbn sbffly usf EPSV dommbnds
            issufCommbndCifdk("EPSV");
            sfrvfrAnswfr = gftRfsponsfString();

            // Tif rfsponsf string from b EPSV dommbnd will dontbin tif port numbfr
            // tif formbt will bf :
            //  229 Entfring Extfndfd PASSIVE Modf (|||58210|)
            //
            // So wf'll usf tif rfgulbr fxprfsions pbdkbgf to pbrsf tif output.

            if (fpsvPbt == null) {
                fpsvPbt = Pbttfrn.dompilf("^229 .* \\(\\|\\|\\|(\\d+)\\|\\)");
            }
            Mbtdifr m = fpsvPbt.mbtdifr(sfrvfrAnswfr);
            if (!m.find()) {
                tirow nfw sun.nft.ftp.FtpProtodolExdfption("EPSV fbilfd : " + sfrvfrAnswfr);
            }
            // Yby! Lft's fxtrbdt tif port numbfr
            String s = m.group(1);
            port = Intfgfr.pbrsfInt(s);
            InftAddrfss bdd = sfrvfr.gftInftAddrfss();
            if (bdd != null) {
                dfst = nfw InftSodkftAddrfss(bdd, port);
            } flsf {
                // Tiis mfbns wf usfd bn Unrfsolvfd bddrfss to donnfdt in
                // tif first plbdf. Most likfly bfdbusf tif proxy is doing
                // tif nbmf rfsolution for us, so lft's kffp using unrfsolvfd
                // bddrfss.
                dfst = InftSodkftAddrfss.drfbtfUnrfsolvfd(sfrvfrAddr.gftHostNbmf(), port);
            }
        } flsf {
            // EPSV ALL fbilfd, so Lft's try tif rfgulbr PASV dmd
            issufCommbndCifdk("PASV");
            sfrvfrAnswfr = gftRfsponsfString();

            // Lft's pbrsf tif rfsponsf String to gft tif IP & port to donnfdt
            // to. Tif String siould bf in tif following formbt :
            //
            // 227 Entfring PASSIVE Modf (A1,A2,A3,A4,p1,p2)
            //
            // Notf tibt tif two pbrfntifsis brf optionbl
            //
            // Tif IP bddrfss is A1.A2.A3.A4 bnd tif port is p1 * 256 + p2
            //
            // Tif rfgulbr fxprfssion is b bit morf domplfx tiis timf, bfdbusf
            // tif pbrfntifsis brf optionbls bnd wf ibvf to usf 3 groups.

            if (pbsvPbt == null) {
                pbsvPbt = Pbttfrn.dompilf("227 .* \\(?(\\d{1,3},\\d{1,3},\\d{1,3},\\d{1,3}),(\\d{1,3}),(\\d{1,3})\\)?");
            }
            Mbtdifr m = pbsvPbt.mbtdifr(sfrvfrAnswfr);
            if (!m.find()) {
                tirow nfw sun.nft.ftp.FtpProtodolExdfption("PASV fbilfd : " + sfrvfrAnswfr);
            }
            // Gft port numbfr out of group 2 & 3
            port = Intfgfr.pbrsfInt(m.group(3)) + (Intfgfr.pbrsfInt(m.group(2)) << 8);
            // IP bddrfss is simplf
            String s = m.group(1).rfplbdf(',', '.');
            dfst = nfw InftSodkftAddrfss(s, port);
        }
        // Got fvfrytiing, lft's opfn tif sodkft!
        Sodkft s;
        if (proxy != null) {
            if (proxy.typf() == Proxy.Typf.SOCKS) {
                s = AddfssControllfr.doPrivilfgfd(
                        nfw PrivilfgfdAdtion<Sodkft>() {

                            publid Sodkft run() {
                                rfturn nfw Sodkft(proxy);
                            }
                        });
            } flsf {
                s = nfw Sodkft(Proxy.NO_PROXY);
            }
        } flsf {
            s = nfw Sodkft();
        }

        InftAddrfss sfrvfrAddrfss = AddfssControllfr.doPrivilfgfd(
                nfw PrivilfgfdAdtion<InftAddrfss>() {
                    @Ovfrridf
                    publid InftAddrfss run() {
                        rfturn sfrvfr.gftLodblAddrfss();
                    }
                });

        // Bind tif sodkft to tif sbmf bddrfss bs tif dontrol dibnnfl. Tiis
        // is nffdfd in dbsf of multi-iomfd systfms.
        s.bind(nfw InftSodkftAddrfss(sfrvfrAddrfss, 0));
        if (donnfdtTimfout >= 0) {
            s.donnfdt(dfst, donnfdtTimfout);
        } flsf {
            if (dffbultConnfdtTimfout > 0) {
                s.donnfdt(dfst, dffbultConnfdtTimfout);
            } flsf {
                s.donnfdt(dfst);
            }
        }
        if (rfbdTimfout >= 0) {
            s.sftSoTimfout(rfbdTimfout);
        } flsf if (dffbultSoTimfout > 0) {
            s.sftSoTimfout(dffbultSoTimfout);
        }
        if (usfCrypto) {
            try {
                s = sslFbdt.drfbtfSodkft(s, dfst.gftHostNbmf(), dfst.gftPort(), truf);
            } dbtdi (Exdfption f) {
                tirow nfw sun.nft.ftp.FtpProtodolExdfption("Cbn't opfn sfdurf dbtb dibnnfl: " + f);
            }
        }
        if (!issufCommbnd(dmd)) {
            s.dlosf();
            if (gftLbstRfplyCodf() == FtpRfplyCodf.FILE_UNAVAILABLE) {
                // Ensurf bbdkwbrd dompbtibility
                tirow nfw FilfNotFoundExdfption(dmd);
            }
            tirow nfw sun.nft.ftp.FtpProtodolExdfption(dmd + ":" + gftRfsponsfString(), gftLbstRfplyCodf());
        }
        rfturn s;
    }

    /**
     * Opfns b dbtb donnfdtion witi tif sfrvfr bddording to tif sft modf
     * (ACTIVE or PASSIVE) tifn sfnd tif dommbnd pbssfd bs bn brgumfnt.
     *
     * @pbrbm dmd tif <dodf>String</dodf> dontbining tif dommbnd to fxfdutf
     * @rfturn tif donnfdtfd <dodf>Sodkft</dodf>
     * @tirows IOExdfption if tif donnfdtion or dommbnd fbilfd
     */
    privbtf Sodkft opfnDbtbConnfdtion(String dmd) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        Sodkft dlifntSodkft;

        if (pbssivfModf) {
            try {
                rfturn opfnPbssivfDbtbConnfdtion(dmd);
            } dbtdi (sun.nft.ftp.FtpProtodolExdfption f) {
                // If Pbssivf modf fbilfd, fbll bbdk on PORT
                // Otifrwisf tirow fxdfption
                String frrmsg = f.gftMfssbgf();
                if (!frrmsg.stbrtsWiti("PASV") && !frrmsg.stbrtsWiti("EPSV")) {
                    tirow f;
                }
            }
        }
        SfrvfrSodkft portSodkft;
        InftAddrfss myAddrfss;
        String portCmd;

        if (proxy != null && proxy.typf() == Proxy.Typf.SOCKS) {
            // Wf'rf bfiind b firfwbll bnd tif pbssivf modf fbil,
            // sindf wf dbn't bddfpt b donnfdtion tirougi SOCKS (yft)
            // tirow bn fxdfption
            tirow nfw sun.nft.ftp.FtpProtodolExdfption("Pbssivf modf fbilfd");
        }
        // Bind tif SfrvfrSodkft to tif sbmf bddrfss bs tif dontrol dibnnfl
        // Tiis is nffdfd for multi-iomfd systfms
        portSodkft = nfw SfrvfrSodkft(0, 1, sfrvfr.gftLodblAddrfss());
        try {
            myAddrfss = portSodkft.gftInftAddrfss();
            if (myAddrfss.isAnyLodblAddrfss()) {
                myAddrfss = sfrvfr.gftLodblAddrfss();
            }
            // Lft's try tif nfw, IPv6 dompbtiblf EPRT dommbnd
            // Sff RFC2428 for spfdifids
            // Somf FTP sfrvfrs (likf tif onf on Solbris) brf buggfd, tify
            // will bddfpt tif EPRT dommbnd but tifn, tif subsfqufnt dommbnd
            // (f.g. RETR) will fbil, so wf ibvf to difdk BOTH rfsults (tif
            // EPRT dmd tifn tif bdtubl dommbnd) to dfdidf wiftifr wf siould
            // fbll bbdk on tif oldfr PORT dommbnd.
            portCmd = "EPRT |" + ((myAddrfss instbndfof Inft6Addrfss) ? "2" : "1") + "|" +
                    myAddrfss.gftHostAddrfss() + "|" + portSodkft.gftLodblPort() + "|";
            if (!issufCommbnd(portCmd) || !issufCommbnd(dmd)) {
                // Tif EPRT dommbnd fbilfd, lft's fbll bbdk to good old PORT
                portCmd = "PORT ";
                bytf[] bddr = myAddrfss.gftAddrfss();

                /* bppfnd iost bddr */
                for (int i = 0; i < bddr.lfngti; i++) {
                    portCmd = portCmd + (bddr[i] & 0xFF) + ",";
                }

                /* bppfnd port numbfr */
                portCmd = portCmd + ((portSodkft.gftLodblPort() >>> 8) & 0xff) + "," + (portSodkft.gftLodblPort() & 0xff);
                issufCommbndCifdk(portCmd);
                issufCommbndCifdk(dmd);
            }
            // Eitifr tif EPRT or tif PORT dommbnd wbs suddfssful
            // Lft's drfbtf tif dlifnt sodkft
            if (donnfdtTimfout >= 0) {
                portSodkft.sftSoTimfout(donnfdtTimfout);
            } flsf {
                if (dffbultConnfdtTimfout > 0) {
                    portSodkft.sftSoTimfout(dffbultConnfdtTimfout);
                }
            }
            dlifntSodkft = portSodkft.bddfpt();
            if (rfbdTimfout >= 0) {
                dlifntSodkft.sftSoTimfout(rfbdTimfout);
            } flsf {
                if (dffbultSoTimfout > 0) {
                    dlifntSodkft.sftSoTimfout(dffbultSoTimfout);
                }
            }
        } finblly {
            portSodkft.dlosf();
        }
        if (usfCrypto) {
            try {
                dlifntSodkft = sslFbdt.drfbtfSodkft(dlifntSodkft, sfrvfrAddr.gftHostNbmf(), sfrvfrAddr.gftPort(), truf);
            } dbtdi (Exdfption fx) {
                tirow nfw IOExdfption(fx.gftLodblizfdMfssbgf());
            }
        }
        rfturn dlifntSodkft;
    }

    privbtf InputStrfbm drfbtfInputStrfbm(InputStrfbm in) {
        if (typf == TrbnsffrTypf.ASCII) {
            rfturn nfw sun.nft.TflnftInputStrfbm(in, fblsf);
        }
        rfturn in;
    }

    privbtf OutputStrfbm drfbtfOutputStrfbm(OutputStrfbm out) {
        if (typf == TrbnsffrTypf.ASCII) {
            rfturn nfw sun.nft.TflnftOutputStrfbm(out, fblsf);
        }
        rfturn out;
    }

    /**
     * Crfbtfs bn instbndf of FtpClifnt. Tif dlifnt is not donnfdtfd to bny
     * sfrvfr yft.
     *
     */
    protfdtfd FtpClifnt() {
    }

    /**
     * Crfbtfs bn instbndf of FtpClifnt. Tif dlifnt is not donnfdtfd to bny
     * sfrvfr yft.
     *
     */
    publid stbtid sun.nft.ftp.FtpClifnt drfbtf() {
        rfturn nfw FtpClifnt();
    }

    /**
     * Sft tif trbnsffr modf to <I>pbssivf</I>. In tibt modf, dbtb donnfdtions
     * brf fstbblisifd by ibving tif dlifnt donnfdt to tif sfrvfr.
     * Tiis is tif rfdommfndfd dffbult modf bs it will work bfst tirougi
     * firfwblls bnd NATs.
     *
     * @rfturn Tiis FtpClifnt
     * @sff #sftAdtivfModf()
     */
    publid sun.nft.ftp.FtpClifnt fnbblfPbssivfModf(boolfbn pbssivf) {

        // Only pbssivf modf usfd in JDK. Sff Bug 8010784.
        // pbssivfModf = pbssivf;
        rfturn tiis;
    }

    /**
     * Gfts tif durrfnt trbnsffr modf.
     *
     * @rfturn tif durrfnt <dodf>FtpTrbnsffrModf</dodf>
     */
    publid boolfbn isPbssivfModfEnbblfd() {
        rfturn pbssivfModf;
    }

    /**
     * Sfts tif timfout vbluf to usf wifn donnfdting to tif sfrvfr,
     *
     * @pbrbm timfout tif timfout vbluf, in millisfdonds, to usf for tif donnfdt
     *        opfrbtion. A vbluf of zfro or lfss, mfbns usf tif dffbult timfout.
     *
     * @rfturn Tiis FtpClifnt
     */
    publid sun.nft.ftp.FtpClifnt sftConnfdtTimfout(int timfout) {
        donnfdtTimfout = timfout;
        rfturn tiis;
    }

    /**
     * Rfturns tif durrfnt donnfdtion timfout vbluf.
     *
     * @rfturn tif vbluf, in millisfdonds, of tif durrfnt donnfdt timfout.
     * @sff #sftConnfdtTimfout(int)
     */
    publid int gftConnfdtTimfout() {
        rfturn donnfdtTimfout;
    }

    /**
     * Sfts tif timfout vbluf to usf wifn rfbding from tif sfrvfr,
     *
     * @pbrbm timfout tif timfout vbluf, in millisfdonds, to usf for tif rfbd
     *        opfrbtion. A vbluf of zfro or lfss, mfbns usf tif dffbult timfout.
     * @rfturn Tiis FtpClifnt
     */
    publid sun.nft.ftp.FtpClifnt sftRfbdTimfout(int timfout) {
        rfbdTimfout = timfout;
        rfturn tiis;
    }

    /**
     * Rfturns tif durrfnt rfbd timfout vbluf.
     *
     * @rfturn tif vbluf, in millisfdonds, of tif durrfnt rfbd timfout.
     * @sff #sftRfbdTimfout(int)
     */
    publid int gftRfbdTimfout() {
        rfturn rfbdTimfout;
    }

    publid sun.nft.ftp.FtpClifnt sftProxy(Proxy p) {
        proxy = p;
        rfturn tiis;
    }

    /**
     * Gft tif proxy of tiis FtpClifnt
     *
     * @rfturn tif <dodf>Proxy</dodf>, tiis dlifnt is using, or <dodf>null</dodf>
     *         if nonf is usfd.
     * @sff #sftProxy(Proxy)
     */
    publid Proxy gftProxy() {
        rfturn proxy;
    }

    /**
     * Connfdts to tif spfdififd dfstinbtion.
     *
     * @pbrbm dfst tif <dodf>InftSodkftAddrfss</dodf> to donnfdt to.
     * @tirows IOExdfption if tif donnfdtion fbils.
     */
    privbtf void tryConnfdt(InftSodkftAddrfss dfst, int timfout) tirows IOExdfption {
        if (isConnfdtfd()) {
            disdonnfdt();
        }
        sfrvfr = doConnfdt(dfst, timfout);
        try {
            out = nfw PrintStrfbm(nfw BufffrfdOutputStrfbm(sfrvfr.gftOutputStrfbm()),
                    truf, fndoding);
        } dbtdi (UnsupportfdEndodingExdfption f) {
            tirow nfw IntfrnblError(fndoding + "fndoding not found", f);
        }
        in = nfw BufffrfdInputStrfbm(sfrvfr.gftInputStrfbm());
    }

    privbtf Sodkft doConnfdt(InftSodkftAddrfss dfst, int timfout) tirows IOExdfption {
        Sodkft s;
        if (proxy != null) {
            if (proxy.typf() == Proxy.Typf.SOCKS) {
                s = AddfssControllfr.doPrivilfgfd(
                        nfw PrivilfgfdAdtion<Sodkft>() {

                            publid Sodkft run() {
                                rfturn nfw Sodkft(proxy);
                            }
                        });
            } flsf {
                s = nfw Sodkft(Proxy.NO_PROXY);
            }
        } flsf {
            s = nfw Sodkft();
        }
        // Instbndf spfdifid timfouts do ibvf priority, tibt mfbns
        // donnfdtTimfout & rfbdTimfout (-1 mfbns not sft)
        // Tifn globbl dffbult timfouts
        // Tifn no timfout.
        if (timfout >= 0) {
            s.donnfdt(dfst, timfout);
        } flsf {
            if (donnfdtTimfout >= 0) {
                s.donnfdt(dfst, donnfdtTimfout);
            } flsf {
                if (dffbultConnfdtTimfout > 0) {
                    s.donnfdt(dfst, dffbultConnfdtTimfout);
                } flsf {
                    s.donnfdt(dfst);
                }
            }
        }
        if (rfbdTimfout >= 0) {
            s.sftSoTimfout(rfbdTimfout);
        } flsf if (dffbultSoTimfout > 0) {
            s.sftSoTimfout(dffbultSoTimfout);
        }
        rfturn s;
    }

    privbtf void disdonnfdt() tirows IOExdfption {
        if (isConnfdtfd()) {
            sfrvfr.dlosf();
        }
        sfrvfr = null;
        in = null;
        out = null;
        lbstTrbnsSizf = -1;
        lbstFilfNbmf = null;
        rfstbrtOffsft = 0;
        wfldomfMsg = null;
        lbstRfplyCodf = null;
        sfrvfrRfsponsf.sftSizf(0);
    }

    /**
     * Tfsts wiftifr tiis dlifnt is donnfdtfd or not to b sfrvfr.
     *
     * @rfturn <dodf>truf</dodf> if tif dlifnt is donnfdtfd.
     */
    publid boolfbn isConnfdtfd() {
        rfturn sfrvfr != null;
    }

    publid SodkftAddrfss gftSfrvfrAddrfss() {
        rfturn sfrvfr == null ? null : sfrvfr.gftRfmotfSodkftAddrfss();
    }

    publid sun.nft.ftp.FtpClifnt donnfdt(SodkftAddrfss dfst) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        rfturn donnfdt(dfst, -1);
    }

    /**
     * Connfdts tif FtpClifnt to tif spfdififd dfstinbtion.
     *
     * @pbrbm dfst tif bddrfss of tif dfstinbtion sfrvfr
     * @tirows IOExdfption if donnfdtion fbilfd.
     */
    publid sun.nft.ftp.FtpClifnt donnfdt(SodkftAddrfss dfst, int timfout) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (!(dfst instbndfof InftSodkftAddrfss)) {
            tirow nfw IllfgblArgumfntExdfption("Wrong bddrfss typf");
        }
        sfrvfrAddr = (InftSodkftAddrfss) dfst;
        tryConnfdt(sfrvfrAddr, timfout);
        if (!rfbdRfply()) {
            tirow nfw sun.nft.ftp.FtpProtodolExdfption("Wfldomf mfssbgf: " +
                    gftRfsponsfString(), lbstRfplyCodf);
        }
        wfldomfMsg = gftRfsponsfString().substring(4);
        rfturn tiis;
    }

    privbtf void tryLogin(String usfr, dibr[] pbssword) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("USER " + usfr);

        /*
         * Cifdks for "331 Usfr nbmf okby, nffd pbssword." bnswfr
         */
        if (lbstRfplyCodf == FtpRfplyCodf.NEED_PASSWORD) {
            if ((pbssword != null) && (pbssword.lfngti > 0)) {
                issufCommbndCifdk("PASS " + String.vblufOf(pbssword));
            }
        }
    }

    /**
     * Attfmpts to log on tif sfrvfr witi tif spfdififd usfr nbmf bnd pbssword.
     *
     * @pbrbm usfr Tif usfr nbmf
     * @pbrbm pbssword Tif pbssword for tibt usfr
     * @rfturn <dodf>truf</dodf> if tif login wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission
     */
    publid sun.nft.ftp.FtpClifnt login(String usfr, dibr[] pbssword) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (!isConnfdtfd()) {
            tirow nfw sun.nft.ftp.FtpProtodolExdfption("Not donnfdtfd yft", FtpRfplyCodf.BAD_SEQUENCE);
        }
        if (usfr == null || usfr.lfngti() == 0) {
            tirow nfw IllfgblArgumfntExdfption("Usfr nbmf dbn't bf null or fmpty");
        }
        tryLogin(usfr, pbssword);

        // kffp tif wfldomf mfssbgf bround so wf dbn
        // put it in tif rfsulting HTML pbgf.
        String l;
        StringBuildfr sb = nfw StringBuildfr();
        for (int i = 0; i < sfrvfrRfsponsf.sizf(); i++) {
            l = sfrvfrRfsponsf.flfmfntAt(i);
            if (l != null) {
                if (l.lfngti() >= 4 && l.stbrtsWiti("230")) {
                    // gft rid of tif "230-" prffix
                    l = l.substring(4);
                }
                sb.bppfnd(l);
            }
        }
        wfldomfMsg = sb.toString();
        loggfdIn = truf;
        rfturn tiis;
    }

    /**
     * Attfmpts to log on tif sfrvfr witi tif spfdififd usfr nbmf, pbssword bnd
     * bddount nbmf.
     *
     * @pbrbm usfr Tif usfr nbmf
     * @pbrbm pbssword Tif pbssword for tibt usfr.
     * @pbrbm bddount Tif bddount nbmf for tibt usfr.
     * @rfturn <dodf>truf</dodf> if tif login wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt login(String usfr, dibr[] pbssword, String bddount) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {

        if (!isConnfdtfd()) {
            tirow nfw sun.nft.ftp.FtpProtodolExdfption("Not donnfdtfd yft", FtpRfplyCodf.BAD_SEQUENCE);
        }
        if (usfr == null || usfr.lfngti() == 0) {
            tirow nfw IllfgblArgumfntExdfption("Usfr nbmf dbn't bf null or fmpty");
        }
        tryLogin(usfr, pbssword);

        /*
         * Cifdks for "332 Nffd bddount for login." bnswfr
         */
        if (lbstRfplyCodf == FtpRfplyCodf.NEED_ACCOUNT) {
            issufCommbndCifdk("ACCT " + bddount);
        }

        // kffp tif wfldomf mfssbgf bround so wf dbn
        // put it in tif rfsulting HTML pbgf.
        StringBuildfr sb = nfw StringBuildfr();
        if (sfrvfrRfsponsf != null) {
            for (String l : sfrvfrRfsponsf) {
                if (l != null) {
                    if (l.lfngti() >= 4 && l.stbrtsWiti("230")) {
                        // gft rid of tif "230-" prffix
                        l = l.substring(4);
                    }
                    sb.bppfnd(l);
                }
            }
        }
        wfldomfMsg = sb.toString();
        loggfdIn = truf;
        rfturn tiis;
    }

    /**
     * Logs out tif durrfnt usfr. Tiis is in ffffdt tfrminbtfs tif durrfnt
     * sfssion bnd tif donnfdtion to tif sfrvfr will bf dlosfd.
     *
     */
    publid void dlosf() tirows IOExdfption {
        if (isConnfdtfd()) {
            issufCommbnd("QUIT");
            loggfdIn = fblsf;
        }
        disdonnfdt();
    }

    /**
     * Cifdks wiftifr tif dlifnt is loggfd in to tif sfrvfr or not.
     *
     * @rfturn <dodf>truf</dodf> if tif dlifnt ibs blrfbdy domplftfd b login.
     */
    publid boolfbn isLoggfdIn() {
        rfturn loggfdIn;
    }

    /**
     * Cibngfs to b spfdifid dirfdtory on b rfmotf FTP sfrvfr
     *
     * @pbrbm rfmotfDirfdtory pbti of tif dirfdtory to CD to.
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @fxdfption <dodf>FtpProtodolExdfption</dodf>
     */
    publid sun.nft.ftp.FtpClifnt dibngfDirfdtory(String rfmotfDirfdtory) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (rfmotfDirfdtory == null || "".fqubls(rfmotfDirfdtory)) {
            tirow nfw IllfgblArgumfntExdfption("dirfdtory dbn't bf null or fmpty");
        }

        issufCommbndCifdk("CWD " + rfmotfDirfdtory);
        rfturn tiis;
    }

    /**
     * Cibngfs to tif pbrfnt dirfdtory, sfnding tif CDUP dommbnd to tif sfrvfr.
     *
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful.
     * @tirows IOExdfption
     */
    publid sun.nft.ftp.FtpClifnt dibngfToPbrfntDirfdtory() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("CDUP");
        rfturn tiis;
    }

    /**
     * Rfturns tif sfrvfr durrfnt working dirfdtory, or <dodf>null</dodf> if
     * tif PWD dommbnd fbilfd.
     *
     * @rfturn b <dodf>String</dodf> dontbining tif durrfnt working dirfdtory,
     *         or <dodf>null</dodf>
     * @tirows IOExdfption
     */
    publid String gftWorkingDirfdtory() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("PWD");
        /*
         * bnswfr will bf of tif following formbt :
         *
         * 257 "/" is durrfnt dirfdtory.
         */
        String bnsw = gftRfsponsfString();
        if (!bnsw.stbrtsWiti("257")) {
            rfturn null;
        }
        rfturn bnsw.substring(5, bnsw.lbstIndfxOf('"'));
    }

    /**
     * Sfts tif rfstbrt offsft to tif spfdififd vbluf.  Tibt vbluf will bf
     * sfnt tirougi b <dodf>REST</dodf> dommbnd to sfrvfr bfforf b filf
     * trbnsffr bnd ibs tif ffffdt of rfsuming b filf trbnsffr from tif
     * spfdififd point. Aftfr b trbnsffr tif rfstbrt offsft is sft bbdk to
     * zfro.
     *
     * @pbrbm offsft tif offsft in tif rfmotf filf bt wiidi to stbrt tif nfxt
     *        trbnsffr. Tiis must bf b vbluf grfbtfr tibn or fqubl to zfro.
     * @tirows IllfgblArgumfntExdfption if tif offsft is nfgbtivf.
     */
    publid sun.nft.ftp.FtpClifnt sftRfstbrtOffsft(long offsft) {
        if (offsft < 0) {
            tirow nfw IllfgblArgumfntExdfption("offsft dbn't bf nfgbtivf");
        }
        rfstbrtOffsft = offsft;
        rfturn tiis;
    }

    /**
     * Rftrifvfs b filf from tif ftp sfrvfr bnd writfs it to tif spfdififd
     * <dodf>OutputStrfbm</dodf>.
     * If tif rfstbrt offsft wbs sft, tifn b <dodf>REST</dodf> dommbnd will bf
     * sfnt bfforf tif RETR in ordfr to rfstbrt tif trbnffr from tif spfdififd
     * offsft.
     * Tif <dodf>OutputStrfbm</dodf> is not dlosfd by tiis mftiod bt tif fnd
     * of tif trbnsffr.
     *
     * @pbrbm nbmf b <dodf>String<dodf> dontbining tif nbmf of tif filf to
     *        rftrfivf from tif sfrvfr.
     * @pbrbm lodbl tif <dodf>OutputStrfbm</dodf> tif filf siould bf writtfn to.
     * @tirows IOExdfption if tif trbnsffr fbils.
     */
    publid sun.nft.ftp.FtpClifnt gftFilf(String nbmf, OutputStrfbm lodbl) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        int mtu = 1500;
        if (rfstbrtOffsft > 0) {
            Sodkft s;
            try {
                s = opfnDbtbConnfdtion("REST " + rfstbrtOffsft);
            } finblly {
                rfstbrtOffsft = 0;
            }
            issufCommbndCifdk("RETR " + nbmf);
            gftTrbnsffrSizf();
            InputStrfbm rfmotf = drfbtfInputStrfbm(s.gftInputStrfbm());
            bytf[] buf = nfw bytf[mtu * 10];
            int l;
            wiilf ((l = rfmotf.rfbd(buf)) >= 0) {
                if (l > 0) {
                    lodbl.writf(buf, 0, l);
                }
            }
            rfmotf.dlosf();
        } flsf {
            Sodkft s = opfnDbtbConnfdtion("RETR " + nbmf);
            gftTrbnsffrSizf();
            InputStrfbm rfmotf = drfbtfInputStrfbm(s.gftInputStrfbm());
            bytf[] buf = nfw bytf[mtu * 10];
            int l;
            wiilf ((l = rfmotf.rfbd(buf)) >= 0) {
                if (l > 0) {
                    lodbl.writf(buf, 0, l);
                }
            }
            rfmotf.dlosf();
        }
        rfturn domplftfPfnding();
    }

    /**
     * Rftrifvfs b filf from tif ftp sfrvfr, using tif RETR dommbnd, bnd
     * rfturns tif InputStrfbm from* tif fstbblisifd dbtb donnfdtion.
     * {@link #domplftfPfnding()} <b>ibs</b> to bf dbllfd ondf tif bpplidbtion
     * is donf rfbding from tif rfturnfd strfbm.
     *
     * @pbrbm nbmf tif nbmf of tif rfmotf filf
     * @rfturn tif {@link jbvb.io.InputStrfbm} from tif dbtb donnfdtion, or
     *         <dodf>null</dodf> if tif dommbnd wbs unsuddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid InputStrfbm gftFilfStrfbm(String nbmf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        Sodkft s;
        if (rfstbrtOffsft > 0) {
            try {
                s = opfnDbtbConnfdtion("REST " + rfstbrtOffsft);
            } finblly {
                rfstbrtOffsft = 0;
            }
            if (s == null) {
                rfturn null;
            }
            issufCommbndCifdk("RETR " + nbmf);
            gftTrbnsffrSizf();
            rfturn drfbtfInputStrfbm(s.gftInputStrfbm());
        }

        s = opfnDbtbConnfdtion("RETR " + nbmf);
        if (s == null) {
            rfturn null;
        }
        gftTrbnsffrSizf();
        rfturn drfbtfInputStrfbm(s.gftInputStrfbm());
    }

    /**
     * Trbnsffrs b filf from tif dlifnt to tif sfrvfr (bkb b <I>put</I>)
     * by sfnding tif STOR or STOU dommbnd, dfpfnding on tif
     * <dodf>uniquf</dodf> brgumfnt, bnd rfturns tif <dodf>OutputStrfbm</dodf>
     * from tif fstbblisifd dbtb donnfdtion.
     * {@link #domplftfPfnding()} <b>ibs</b> to bf dbllfd ondf tif bpplidbtion
     * is finisifd writing to tif strfbm.
     *
     * A nfw filf is drfbtfd bt tif sfrvfr sitf if tif filf spfdififd dofs
     * not blrfbdy fxist.
     *
     * If <dodf>uniquf</dodf> is sft to <dodf>truf</dodf>, tif rfsultbnt filf
     * is to bf drfbtfd undfr b nbmf uniquf to tibt dirfdtory, mfbning
     * it will not ovfrwritf bn fxisting filf, instfbd tif sfrvfr will
     * gfnfrbtf b nfw, uniquf, filf nbmf.
     * Tif nbmf of tif rfmotf filf dbn bf rftrifvfd, bftfr domplftion of tif
     * trbnsffr, by dblling {@link #gftLbstFilfNbmf()}.
     *
     * @pbrbm nbmf tif nbmf of tif rfmotf filf to writf.
     * @pbrbm uniquf <dodf>truf</dodf> if tif rfmotf filfs siould bf uniquf,
     *        in wiidi dbsf tif STOU dommbnd will bf usfd.
     * @rfturn tif {@link jbvb.io.OutputStrfbm} from tif dbtb donnfdtion or
     *         <dodf>null</dodf> if tif dommbnd wbs unsuddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid OutputStrfbm putFilfStrfbm(String nbmf, boolfbn uniquf)
        tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption
    {
        String dmd = uniquf ? "STOU " : "STOR ";
        Sodkft s = opfnDbtbConnfdtion(dmd + nbmf);
        if (s == null) {
            rfturn null;
        }
        boolfbn bm = (typf == TrbnsffrTypf.BINARY);
        rfturn nfw sun.nft.TflnftOutputStrfbm(s.gftOutputStrfbm(), bm);
    }

    /**
     * Trbnsffrs b filf from tif dlifnt to tif sfrvfr (bkb b <I>put</I>)
     * by sfnding tif STOR dommbnd. Tif dontfnt of tif <dodf>InputStrfbm</dodf>
     * pbssfd in brgumfnt is writtfn into tif rfmotf filf, ovfrwriting bny
     * fxisting dbtb.
     *
     * A nfw filf is drfbtfd bt tif sfrvfr sitf if tif filf spfdififd dofs
     * not blrfbdy fxist.
     *
     * @pbrbm nbmf tif nbmf of tif rfmotf filf to writf.
     * @pbrbm lodbl tif <dodf>InputStrfbm</dodf> tibt points to tif dbtb to
     *        trbnsffr.
     * @pbrbm uniquf <dodf>truf</dodf> if tif rfmotf filf siould bf uniquf
     *        (i.f. not blrfbdy fxisting), <dodf>fblsf</dodf> otifrwisf.
     * @rfturn <dodf>truf</dodf> if tif trbnsffr wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     * @sff #gftLbstFilfNbmf()
     */
    publid sun.nft.ftp.FtpClifnt putFilf(String nbmf, InputStrfbm lodbl, boolfbn uniquf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        String dmd = uniquf ? "STOU " : "STOR ";
        int mtu = 1500;
        if (typf == TrbnsffrTypf.BINARY) {
            Sodkft s = opfnDbtbConnfdtion(dmd + nbmf);
            OutputStrfbm rfmotf = drfbtfOutputStrfbm(s.gftOutputStrfbm());
            bytf[] buf = nfw bytf[mtu * 10];
            int l;
            wiilf ((l = lodbl.rfbd(buf)) >= 0) {
                if (l > 0) {
                    rfmotf.writf(buf, 0, l);
                }
            }
            rfmotf.dlosf();
        }
        rfturn domplftfPfnding();
    }

    /**
     * Sfnds tif APPE dommbnd to tif sfrvfr in ordfr to trbnsffr b dbtb strfbm
     * pbssfd in brgumfnt bnd bppfnd it to tif dontfnt of tif spfdififd rfmotf
     * filf.
     *
     * @pbrbm nbmf A <dodf>String</dodf> dontbining tif nbmf of tif rfmotf filf
     *        to bppfnd to.
     * @pbrbm lodbl Tif <dodf>InputStrfbm</dodf> providing bddfss to tif dbtb
     *        to bf bppfndfd.
     * @rfturn <dodf>truf</dodf> if tif trbnsffr wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt bppfndFilf(String nbmf, InputStrfbm lodbl) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        int mtu = 1500;
        Sodkft s = opfnDbtbConnfdtion("APPE " + nbmf);
        OutputStrfbm rfmotf = drfbtfOutputStrfbm(s.gftOutputStrfbm());
        bytf[] buf = nfw bytf[mtu * 10];
        int l;
        wiilf ((l = lodbl.rfbd(buf)) >= 0) {
            if (l > 0) {
                rfmotf.writf(buf, 0, l);
            }
        }
        rfmotf.dlosf();
        rfturn domplftfPfnding();
    }

    /**
     * Rfnbmfs b filf on tif sfrvfr.
     *
     * @pbrbm from tif nbmf of tif filf bfing rfnbmfd
     * @pbrbm to tif nfw nbmf for tif filf
     * @tirows IOExdfption if tif dommbnd fbils
     */
    publid sun.nft.ftp.FtpClifnt rfnbmf(String from, String to) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("RNFR " + from);
        issufCommbndCifdk("RNTO " + to);
        rfturn tiis;
    }

    /**
     * Dflftfs b filf on tif sfrvfr.
     *
     * @pbrbm nbmf b <dodf>String</dodf> dontbining tif nbmf of tif filf
     *        to dflftf.
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful
     * @tirows IOExdfption if bn frror oddurrfd during tif fxdibngf
     */
    publid sun.nft.ftp.FtpClifnt dflftfFilf(String nbmf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("DELE " + nbmf);
        rfturn tiis;
    }

    /**
     * Crfbtfs b nfw dirfdtory on tif sfrvfr.
     *
     * @pbrbm nbmf b <dodf>String</dodf> dontbining tif nbmf of tif dirfdtory
     *        to drfbtf.
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif fxdibngf
     */
    publid sun.nft.ftp.FtpClifnt mbkfDirfdtory(String nbmf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("MKD " + nbmf);
        rfturn tiis;
    }

    /**
     * Rfmovfs b dirfdtory on tif sfrvfr.
     *
     * @pbrbm nbmf b <dodf>String</dodf> dontbining tif nbmf of tif dirfdtory
     *        to rfmovf.
     *
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif fxdibngf.
     */
    publid sun.nft.ftp.FtpClifnt rfmovfDirfdtory(String nbmf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("RMD " + nbmf);
        rfturn tiis;
    }

    /**
     * Sfnds b No-opfrbtion dommbnd. It's usfful for tfsting tif donnfdtion
     * stbtus or bs b <I>kffp blivf</I> mfdibnism.
     *
     * @tirows FtpProtodolExdfption if tif dommbnd fbils
     */
    publid sun.nft.ftp.FtpClifnt noop() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("NOOP");
        rfturn tiis;
    }

    /**
     * Sfnds tif STAT dommbnd to tif sfrvfr.
     * Tiis dbn bf usfd wiilf b dbtb donnfdtion is opfn to gft b stbtus
     * on tif durrfnt trbnsffr, in tibt dbsf tif pbrbmftfr siould bf
     * <dodf>null</dodf>.
     * If usfd bftwffn filf trbnsffrs, it mby ibvf b pbtinbmf bs brgumfnt
     * in wiidi dbsf it will work bs tif LIST dommbnd fxdfpt no dbtb
     * donnfdtion will bf drfbtfd.
     *
     * @pbrbm nbmf bn optionbl <dodf>String</dodf> dontbining tif pbtinbmf
     *        tif STAT dommbnd siould bpply to.
     * @rfturn tif rfsponsf from tif sfrvfr or <dodf>null</dodf> if tif
     *         dommbnd fbilfd.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid String gftStbtus(String nbmf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk((nbmf == null ? "STAT" : "STAT " + nbmf));
        /*
         * A typidbl rfsponsf will bf:
         *  213-stbtus of t32.gif:
         * -rw-r--r--   1 jdd      stbff     247445 Ffb 17  1998 t32.gif
         * 213 End of Stbtus
         *
         * or
         *
         * 211-jsn FTP sfrvfr stbtus:
         *     Vfrsion wu-2.6.2+Sun
         *     Connfdtfd to lodbliost (::1)
         *     Loggfd in bs jddollft
         *     TYPE: ASCII, FORM: Nonprint; STRUdturf: Filf; trbnsffr MODE: Strfbm
         *      No dbtb donnfdtion
         *     0 dbtb bytfs rfdfivfd in 0 filfs
         *     0 dbtb bytfs trbnsmittfd in 0 filfs
         *     0 dbtb bytfs totbl in 0 filfs
         *     53 trbffid bytfs rfdfivfd in 0 trbnsffrs
         *     485 trbffid bytfs trbnsmittfd in 0 trbnsffrs
         *     587 trbffid bytfs totbl in 0 trbnsffrs
         * 211 End of stbtus
         *
         * So wf nffd to rfmovf tif 1st bnd lbst linf
         */
        Vfdtor<String> rfsp = gftRfsponsfStrings();
        StringBuildfr sb = nfw StringBuildfr();
        for (int i = 1; i < rfsp.sizf() - 1; i++) {
            sb.bppfnd(rfsp.gft(i));
        }
        rfturn sb.toString();
    }

    /**
     * Sfnds tif FEAT dommbnd to tif sfrvfr bnd rfturns tif list of supportfd
     * ffbturfs in tif form of strings.
     *
     * Tif ffbturfs brf tif supportfd dommbnds, likf AUTH TLS, PROT or PASV.
     * Sff tif RFCs for b domplftf list.
     *
     * Notf tibt not bll FTP sfrvfrs support tibt dommbnd, in wiidi dbsf
     * tif mftiod will rfturn <dodf>null</dodf>
     *
     * @rfturn b <dodf>List</dodf> of <dodf>Strings</dodf> dfsdribing tif
     *         supportfd bdditionbl ffbturfs, or <dodf>null</dodf>
     *         if tif dommbnd is not supportfd.
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid List<String> gftFfbturfs() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        /*
         * Tif FEAT dommbnd, wifn implfmfntfd will rfturn somftiing likf:
         *
         * 211-Ffbturfs:
         *   AUTH TLS
         *   PBSZ
         *   PROT
         *   EPSV
         *   EPRT
         *   PASV
         *   REST STREAM
         *  211 END
         */
        ArrbyList<String> ffbturfs = nfw ArrbyList<String>();
        issufCommbndCifdk("FEAT");
        Vfdtor<String> rfsp = gftRfsponsfStrings();
        // Notf tibt wf stbrt bt indfx 1 to skip tif 1st linf (211-...)
        // bnd wf stop bfforf tif lbst linf.
        for (int i = 1; i < rfsp.sizf() - 1; i++) {
            String s = rfsp.gft(i);
            // Gft rid of lfbding spbdf bnd trbiling nfwlinf
            ffbturfs.bdd(s.substring(1, s.lfngti() - 1));
        }
        rfturn ffbturfs;
    }

    /**
     * sfnds tif ABOR dommbnd to tif sfrvfr.
     * It tflls tif sfrvfr to stop tif prfvious dommbnd or trbnsffr.
     *
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt bbort() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("ABOR");
        // TODO: Must difdk tif RfplyCodf:
        /*
         * From tif RFC:
         * Tifrf brf two dbsfs for tif sfrvfr upon rfdfipt of tiis
         * dommbnd: (1) tif FTP sfrvidf dommbnd wbs blrfbdy domplftfd,
         * or (2) tif FTP sfrvidf dommbnd is still in progrfss.
         * In tif first dbsf, tif sfrvfr dlosfs tif dbtb donnfdtion
         * (if it is opfn) bnd rfsponds witi b 226 rfply, indidbting
         * tibt tif bbort dommbnd wbs suddfssfully prodfssfd.
         * In tif sfdond dbsf, tif sfrvfr bborts tif FTP sfrvidf in
         * progrfss bnd dlosfs tif dbtb donnfdtion, rfturning b 426
         * rfply to indidbtf tibt tif sfrvidf rfqufst tfrminbtfd
         * bbnormblly.  Tif sfrvfr tifn sfnds b 226 rfply,
         * indidbting tibt tif bbort dommbnd wbs suddfssfully
         * prodfssfd.
         */


        rfturn tiis;
    }

    /**
     * Somf mftiods do not wbit until domplftion bfforf rfturning, so tiis
     * mftiod dbn bf dbllfd to wbit until domplftion. Tiis is typidblly tif dbsf
     * witi dommbnds tibt triggfr b trbnsffr likf {@link #gftFilfStrfbm(String)}.
     * So tiis mftiod siould bf dbllfd bfforf bddfssing informbtion rflbtfd to
     * sudi b dommbnd.
     * <p>Tiis mftiod will bdtublly blodk rfbding on tif dommbnd dibnnfl for b
     * notifidbtion from tif sfrvfr tibt tif dommbnd is finisifd. Sudi b
     * notifidbtion oftfn dbrrifs fxtrb informbtion dondfrning tif domplftion
     * of tif pfnding bdtion (f.g. numbfr of bytfs trbnsffrfd).</p>
     * <p>Notf tibt tiis will rfturn truf immfdibtfly if no dommbnd or bdtion
     * is pfnding</p>
     * <p>It siould bf blso notfd tibt most mftiods issuing dommbnds to tif ftp
     * sfrvfr will dbll tiis mftiod if b prfvious dommbnd is pfnding.
     * <p>Exbmplf of usf:
     * <prf>
     * InputStrfbm in = dl.gftFilfStrfbm("filf");
     * ...
     * dl.domplftfPfnding();
     * long sizf = dl.gftLbstTrbnsffrSizf();
     * </prf>
     * On tif otifr ibnd, it's not nfdfssbry in b dbsf likf:
     * <prf>
     * InputStrfbm in = dl.gftFilfStrfbm("filf");
     * // rfbd dontfnt
     * ...
     * dl.logout();
     * </prf>
     * <p>Sindf {@link #logout()} will dbll domplftfPfnding() if nfdfssbry.</p>
     * @rfturn <dodf>truf</dodf> if tif domplftion wbs suddfssful or if no
     *         bdtion wbs pfnding.
     * @tirows IOExdfption
     */
    publid sun.nft.ftp.FtpClifnt domplftfPfnding() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        wiilf (rfplyPfnding) {
            rfplyPfnding = fblsf;
            if (!rfbdRfply()) {
                tirow nfw sun.nft.ftp.FtpProtodolExdfption(gftLbstRfsponsfString(), lbstRfplyCodf);
            }
        }
        rfturn tiis;
    }

    /**
     * Rfinitiblizfs tif USER pbrbmftfrs on tif FTP sfrvfr
     *
     * @tirows FtpProtodolExdfption if tif dommbnd fbils
     */
    publid sun.nft.ftp.FtpClifnt rfInit() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("REIN");
        loggfdIn = fblsf;
        if (usfCrypto) {
            if (sfrvfr instbndfof SSLSodkft) {
                jbvbx.nft.ssl.SSLSfssion sfssion = ((SSLSodkft) sfrvfr).gftSfssion();
                sfssion.invblidbtf();
                // Rfstorf prfvious sodkft bnd strfbms
                sfrvfr = oldSodkft;
                oldSodkft = null;
                try {
                    out = nfw PrintStrfbm(nfw BufffrfdOutputStrfbm(sfrvfr.gftOutputStrfbm()),
                            truf, fndoding);
                } dbtdi (UnsupportfdEndodingExdfption f) {
                    tirow nfw IntfrnblError(fndoding + "fndoding not found", f);
                }
                in = nfw BufffrfdInputStrfbm(sfrvfr.gftInputStrfbm());
            }
        }
        usfCrypto = fblsf;
        rfturn tiis;
    }

    /**
     * Cibngfs tif trbnsffr typf (binbry, bsdii, fbddid) bnd issuf tif
     * propfr dommbnd (f.g. TYPE A) to tif sfrvfr.
     *
     * @pbrbm typf tif <dodf>FtpTrbnsffrTypf</dodf> to usf.
     * @rfturn Tiis FtpClifnt
     * @tirows IOExdfption if bn frror oddurs during trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt sftTypf(TrbnsffrTypf typf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        String dmd = "NOOP";

        tiis.typf = typf;
        if (typf == TrbnsffrTypf.ASCII) {
            dmd = "TYPE A";
        }
        if (typf == TrbnsffrTypf.BINARY) {
            dmd = "TYPE I";
        }
        if (typf == TrbnsffrTypf.EBCDIC) {
            dmd = "TYPE E";
        }
        issufCommbndCifdk(dmd);
        rfturn tiis;
    }

    /**
     * Issufs b LIST dommbnd to tif sfrvfr to gft tif durrfnt dirfdtory
     * listing, bnd rfturns tif InputStrfbm from tif dbtb donnfdtion.
     * {@link #domplftfPfnding()} <b>ibs</b> to bf dbllfd ondf tif bpplidbtion
     * is finisifd writing to tif strfbm.
     *
     * @pbrbm pbti tif pbtinbmf of tif dirfdtory to list, or <dodf>null</dodf>
     *        for tif durrfnt working dirfdtory.
     * @rfturn tif <dodf>InputStrfbm</dodf> from tif rfsulting dbtb donnfdtion
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     * @sff #dibngfDirfdtory(String)
     * @sff #listFilfs(String)
     */
    publid InputStrfbm list(String pbti) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        Sodkft s;
        s = opfnDbtbConnfdtion(pbti == null ? "LIST" : "LIST " + pbti);
        if (s != null) {
            rfturn drfbtfInputStrfbm(s.gftInputStrfbm());
        }
        rfturn null;
    }

    /**
     * Issufs b NLST pbti dommbnd to sfrvfr to gft tif spfdififd dirfdtory
     * dontfnt. It difffrs from {@link #list(String)} mftiod by tif fbdt tibt
     * it will only list tif filf nbmfs wiidi would mbkf tif pbrsing of tif
     * somfwibt fbsifr.
     *
     * {@link #domplftfPfnding()} <b>ibs</b> to bf dbllfd ondf tif bpplidbtion
     * is finisifd writing to tif strfbm.
     *
     * @pbrbm pbti b <dodf>String</dodf> dontbining tif pbtinbmf of tif
     *        dirfdtory to list or <dodf>null</dodf> for tif durrfnt working
     *        dirfdtory.
     * @rfturn tif <dodf>InputStrfbm</dodf> from tif rfsulting dbtb donnfdtion
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid InputStrfbm nbmfList(String pbti) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        Sodkft s;
        s = opfnDbtbConnfdtion("NLST " + pbti);
        if (s != null) {
            rfturn drfbtfInputStrfbm(s.gftInputStrfbm());
        }
        rfturn null;
    }

    /**
     * Issufs tif SIZE [pbti] dommbnd to tif sfrvfr to gft tif sizf of b
     * spfdifid filf on tif sfrvfr.
     * Notf tibt tiis dommbnd mby not bf supportfd by tif sfrvfr. In wiidi
     * dbsf -1 will bf rfturnfd.
     *
     * @pbrbm pbti b <dodf>String</dodf> dontbining tif pbtinbmf of tif
     *        filf.
     * @rfturn b <dodf>long</dodf> dontbining tif sizf of tif filf or -1 if
     *         tif sfrvfr rfturnfd bn frror, wiidi dbn bf difdkfd witi
     *         {@link #gftLbstRfplyCodf()}.
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid long gftSizf(String pbti) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (pbti == null || pbti.lfngti() == 0) {
            tirow nfw IllfgblArgumfntExdfption("pbti dbn't bf null or fmpty");
        }
        issufCommbndCifdk("SIZE " + pbti);
        if (lbstRfplyCodf == FtpRfplyCodf.FILE_STATUS) {
            String s = gftRfsponsfString();
            s = s.substring(4, s.lfngti() - 1);
            rfturn Long.pbrsfLong(s);
        }
        rfturn -1;
    }
    privbtf stbtid String[] MDTMformbts = {
        "yyyyMMddHHmmss.SSS",
        "yyyyMMddHHmmss"
    };
    privbtf stbtid SimplfDbtfFormbt[] dbtfFormbts = nfw SimplfDbtfFormbt[MDTMformbts.lfngti];

    stbtid {
        for (int i = 0; i < MDTMformbts.lfngti; i++) {
            dbtfFormbts[i] = nfw SimplfDbtfFormbt(MDTMformbts[i]);
            dbtfFormbts[i].sftTimfZonf(TimfZonf.gftTimfZonf("GMT"));
        }
    }

    /**
     * Issufs tif MDTM [pbti] dommbnd to tif sfrvfr to gft tif modifidbtion
     * timf of b spfdifid filf on tif sfrvfr.
     * Notf tibt tiis dommbnd mby not bf supportfd by tif sfrvfr, in wiidi
     * dbsf <dodf>null</dodf> will bf rfturnfd.
     *
     * @pbrbm pbti b <dodf>String</dodf> dontbining tif pbtinbmf of tif filf.
     * @rfturn b <dodf>Dbtf</dodf> rfprfsfnting tif lbst modifidbtion timf
     *         or <dodf>null</dodf> if tif sfrvfr rfturnfd bn frror, wiidi
     *         dbn bf difdkfd witi {@link #gftLbstRfplyCodf()}.
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid Dbtf gftLbstModififd(String pbti) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("MDTM " + pbti);
        if (lbstRfplyCodf == FtpRfplyCodf.FILE_STATUS) {
            String s = gftRfsponsfString().substring(4);
            Dbtf d = null;
            for (SimplfDbtfFormbt dbtfFormbt : dbtfFormbts) {
                try {
                    d = dbtfFormbt.pbrsf(s);
                } dbtdi (PbrsfExdfption fx) {
                }
                if (d != null) {
                    rfturn d;
                }
            }
        }
        rfturn null;
    }

    /**
     * Sfts tif pbrsfr usfd to ibndlf tif dirfdtory output to tif spfdififd
     * onf. By dffbult tif pbrsfr is sft to onf tibt dbn ibndlf most FTP
     * sfrvfrs output (Unix bbsf mostly). Howfvfr it mby bf nfdfssbry for
     * bnd bpplidbtion to providf its own pbrsfr duf to somf undommon
     * output formbt.
     *
     * @pbrbm p Tif <dodf>FtpDirPbrsfr</dodf> to usf.
     * @sff #listFilfs(String)
     */
    publid sun.nft.ftp.FtpClifnt sftDirPbrsfr(FtpDirPbrsfr p) {
        pbrsfr = p;
        rfturn tiis;
    }

    privbtf dlbss FtpFilfItfrbtor implfmfnts Itfrbtor<FtpDirEntry>, Closfbblf {

        privbtf BufffrfdRfbdfr in = null;
        privbtf FtpDirEntry nfxtFilf = null;
        privbtf FtpDirPbrsfr fpbrsfr = null;
        privbtf boolfbn fof = fblsf;

        publid FtpFilfItfrbtor(FtpDirPbrsfr p, BufffrfdRfbdfr in) {
            tiis.in = in;
            tiis.fpbrsfr = p;
            rfbdNfxt();
        }

        privbtf void rfbdNfxt() {
            nfxtFilf = null;
            if (fof) {
                rfturn;
            }
            String linf = null;
            try {
                do {
                    linf = in.rfbdLinf();
                    if (linf != null) {
                        nfxtFilf = fpbrsfr.pbrsfLinf(linf);
                        if (nfxtFilf != null) {
                            rfturn;
                        }
                    }
                } wiilf (linf != null);
                in.dlosf();
            } dbtdi (IOExdfption iOExdfption) {
            }
            fof = truf;
        }

        publid boolfbn ibsNfxt() {
            rfturn nfxtFilf != null;
        }

        publid FtpDirEntry nfxt() {
            FtpDirEntry rft = nfxtFilf;
            rfbdNfxt();
            rfturn rft;
        }

        publid void rfmovf() {
            tirow nfw UnsupportfdOpfrbtionExdfption("Not supportfd yft.");
        }

        publid void dlosf() tirows IOExdfption {
            if (in != null && !fof) {
                in.dlosf();
            }
            fof = truf;
            nfxtFilf = null;
        }
    }

    /**
     * Issufs b MLSD dommbnd to tif sfrvfr to gft tif spfdififd dirfdtory
     * listing bnd bpplifs tif durrfnt pbrsfr to drfbtf bn Itfrbtor of
     * {@link jbvb.nft.ftp.FtpDirEntry}. Notf tibt tif Itfrbtor rfturnfd is blso b
     * {@link jbvb.io.Closfbblf}.
     * If tif sfrvfr dofsn't support tif MLSD dommbnd, tif LIST dommbnd is usfd
     * instfbd.
     *
     * {@link #domplftfPfnding()} <b>ibs</b> to bf dbllfd ondf tif bpplidbtion
     * is finisifd itfrbting tirougi tif filfs.
     *
     * @pbrbm pbti tif pbtinbmf of tif dirfdtory to list or <dodf>null</dodf>
     *        for tif durrfnt working dirfdtoty.
     * @rfturn b <dodf>Itfrbtor</dodf> of filfs or <dodf>null</dodf> if tif
     *         dommbnd fbilfd.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission
     * @sff #sftDirPbrsfr(FtpDirPbrsfr)
     * @sff #dibngfDirfdtory(String)
     */
    publid Itfrbtor<FtpDirEntry> listFilfs(String pbti) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        Sodkft s = null;
        BufffrfdRfbdfr sin = null;
        try {
            s = opfnDbtbConnfdtion(pbti == null ? "MLSD" : "MLSD " + pbti);
        } dbtdi (sun.nft.ftp.FtpProtodolExdfption FtpExdfption) {
            // Tif sfrvfr dofsn't undfrstbnd nfw MLSD dommbnd, ignorf bnd fbll
            // bbdk to LIST
        }

        if (s != null) {
            sin = nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(s.gftInputStrfbm()));
            rfturn nfw FtpFilfItfrbtor(mlsxPbrsfr, sin);
        } flsf {
            s = opfnDbtbConnfdtion(pbti == null ? "LIST" : "LIST " + pbti);
            if (s != null) {
                sin = nfw BufffrfdRfbdfr(nfw InputStrfbmRfbdfr(s.gftInputStrfbm()));
                rfturn nfw FtpFilfItfrbtor(pbrsfr, sin);
            }
        }
        rfturn null;
    }

    privbtf boolfbn sfndSfdurityDbtb(bytf[] buf) tirows IOExdfption {
        String s = Bbsf64.gftMimfEndodfr().fndodfToString(buf);
        rfturn issufCommbnd("ADAT " + s);
    }

    privbtf bytf[] gftSfdurityDbtb() {
        String s = gftLbstRfsponsfString();
        if (s.substring(4, 9).fqublsIgnorfCbsf("ADAT=")) {
            // Nffd to gft rid of tif lfbding '315 ADAT='
            // bnd tif trbiling nfwlinf
            rfturn Bbsf64.gftMimfDfdodfr().dfdodf(s.substring(9, s.lfngti() - 1));
        }
        rfturn null;
    }

    /**
     * Attfmpts to usf Kfrbfros GSSAPI bs bn butifntidbtion mfdibnism witi tif
     * ftp sfrvfr. Tiis will issuf bn <dodf>AUTH GSSAPI</dodf> dommbnd, bnd if
     * it is bddfptfd by tif sfrvfr, will followup witi <dodf>ADAT</dodf>
     * dommbnd to fxdibngf tif vbrious tokfns until butifntifidbtion is
     * suddfssful. Tiis donforms to Appfndix I of RFC 2228.
     *
     * @rfturn <dodf>truf</dodf> if butifntidbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurs during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt usfKfrbfros() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        /*
         * Commfnt out for tif momfnt sindf it's not in usf bnd would drfbtf
         * nffdlfss dross-pbdkbgf links.
         *
        issufCommbndCifdk("AUTH GSSAPI");
        if (lbstRfplyCodf != FtpRfplyCodf.NEED_ADAT)
        tirow nfw sun.nft.ftp.FtpProtodolExdfption("Unfxpfdtfd rfply from sfrvfr");
        try {
        GSSMbnbgfr mbnbgfr = GSSMbnbgfr.gftInstbndf();
        GSSNbmf nbmf = mbnbgfr.drfbtfNbmf("SERVICE:ftp@"+
        sfrvfrAddr.gftHostNbmf(), null);
        GSSContfxt dontfxt = mbnbgfr.drfbtfContfxt(nbmf, null, null,
        GSSContfxt.DEFAULT_LIFETIME);
        dontfxt.rfqufstMutublAuti(truf);
        dontfxt.rfqufstRfplbyDft(truf);
        dontfxt.rfqufstSfqufndfDft(truf);
        dontfxt.rfqufstCrfdDflfg(truf);
        bytf []inTokfn = nfw bytf[0];
        wiilf (!dontfxt.isEstbblisifd()) {
        bytf[] outTokfn
        = dontfxt.initSfdContfxt(inTokfn, 0, inTokfn.lfngti);
        // sfnd tif output tokfn if gfnfrbtfd
        if (outTokfn != null) {
        if (sfndSfdurityDbtb(outTokfn)) {
        inTokfn = gftSfdurityDbtb();
        }
        }
        }
        loggfdIn = truf;
        } dbtdi (GSSExdfption f) {

        }
         */
        rfturn tiis;
    }

    /**
     * Rfturns tif Wfldomf string tif sfrvfr sfnt during initibl donnfdtion.
     *
     * @rfturn b <dodf>String</dodf> dontbining tif mfssbgf tif sfrvfr
     *         rfturnfd during donnfdtion or <dodf>null</dodf>.
     */
    publid String gftWfldomfMsg() {
        rfturn wfldomfMsg;
    }

    /**
     * Rfturns tif lbst rfply dodf sfnt by tif sfrvfr.
     *
     * @rfturn tif lbstRfplyCodf
     */
    publid FtpRfplyCodf gftLbstRfplyCodf() {
        rfturn lbstRfplyCodf;
    }

    /**
     * Rfturns tif lbst rfsponsf string sfnt by tif sfrvfr.
     *
     * @rfturn tif mfssbgf string, wiidi dbn bf quitf long, lbst rfturnfd
     *         by tif sfrvfr.
     */
    publid String gftLbstRfsponsfString() {
        StringBuildfr sb = nfw StringBuildfr();
        if (sfrvfrRfsponsf != null) {
            for (String l : sfrvfrRfsponsf) {
                if (l != null) {
                    sb.bppfnd(l);
                }
            }
        }
        rfturn sb.toString();
    }

    /**
     * Rfturns, wifn bvbilbblf, tif sizf of tif lbtfst stbrtfd trbnsffr.
     * Tiis is rftrfivfd by pbrsing tif rfsponsf string rfdfivfd bs bn initibl
     * rfsponsf to b RETR or similbr rfqufst.
     *
     * @rfturn tif sizf of tif lbtfst trbnsffr or -1 if fitifr tifrf wbs no
     *         trbnsffr or tif informbtion wbs unbvbilbblf.
     */
    publid long gftLbstTrbnsffrSizf() {
        rfturn lbstTrbnsSizf;
    }

    /**
     * Rfturns, wifn bvbilbblf, tif rfmotf nbmf of tif lbst trbnsffrfd filf.
     * Tiis is mbinly usfful for "put" opfrbtion wifn tif uniquf flbg wbs
     * sft sindf it bllows to rfdovfr tif uniquf filf nbmf drfbtfd on tif
     * sfrvfr wiidi mby bf difffrfnt from tif onf submittfd witi tif dommbnd.
     *
     * @rfturn tif nbmf tif lbtfst trbnsffrfd filf rfmotf nbmf, or
     *         <dodf>null</dodf> if tibt informbtion is unbvbilbblf.
     */
    publid String gftLbstFilfNbmf() {
        rfturn lbstFilfNbmf;
    }

    /**
     * Attfmpts to switdi to b sfdurf, fndryptfd donnfdtion. Tiis is donf by
     * sfnding tif "AUTH TLS" dommbnd.
     * <p>Sff <b irff="ittp://www.iftf.org/rfd/rfd4217.txt">RFC 4217</b></p>
     * If suddfssful tiis will fstbblisi b sfdurf dommbnd dibnnfl witi tif
     * sfrvfr, it will blso mbkf it so tibt bll otifr trbnsffrs (f.g. b RETR
     * dommbnd) will bf donf ovfr bn fndryptfd dibnnfl bs wfll unlfss b
     * {@link #rfInit()} dommbnd or b {@link #fndSfdurfSfssion()} dommbnd is issufd.
     *
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     * @sff #fndSfdurfSfssion()
     */
    publid sun.nft.ftp.FtpClifnt stbrtSfdurfSfssion() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (!isConnfdtfd()) {
            tirow nfw sun.nft.ftp.FtpProtodolExdfption("Not donnfdtfd yft", FtpRfplyCodf.BAD_SEQUENCE);
        }
        if (sslFbdt == null) {
            try {
                sslFbdt = (SSLSodkftFbdtory) SSLSodkftFbdtory.gftDffbult();
            } dbtdi (Exdfption f) {
                tirow nfw IOExdfption(f.gftLodblizfdMfssbgf());
            }
        }
        issufCommbndCifdk("AUTH TLS");
        Sodkft s = null;
        try {
            s = sslFbdt.drfbtfSodkft(sfrvfr, sfrvfrAddr.gftHostNbmf(), sfrvfrAddr.gftPort(), truf);
        } dbtdi (jbvbx.nft.ssl.SSLExdfption sslf) {
            try {
                disdonnfdt();
            } dbtdi (Exdfption f) {
            }
            tirow sslf;
        }
        // Rfmfmbfr undfrlying sodkft so wf dbn rfstorf it lbtfr
        oldSodkft = sfrvfr;
        sfrvfr = s;
        try {
            out = nfw PrintStrfbm(nfw BufffrfdOutputStrfbm(sfrvfr.gftOutputStrfbm()),
                    truf, fndoding);
        } dbtdi (UnsupportfdEndodingExdfption f) {
            tirow nfw IntfrnblError(fndoding + "fndoding not found", f);
        }
        in = nfw BufffrfdInputStrfbm(sfrvfr.gftInputStrfbm());

        issufCommbndCifdk("PBSZ 0");
        issufCommbndCifdk("PROT P");
        usfCrypto = truf;
        rfturn tiis;
    }

    /**
     * Sfnds b <dodf>CCC</dodf> dommbnd followfd by b <dodf>PROT C</dodf>
     * dommbnd to tif sfrvfr tfrminbting bn fndryptfd sfssion bnd rfvfrting
     * bbdk to b non dryptfd trbnsmission.
     *
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during trbnsmission.
     * @sff #stbrtSfdurfSfssion()
     */
    publid sun.nft.ftp.FtpClifnt fndSfdurfSfssion() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        if (!usfCrypto) {
            rfturn tiis;
        }

        issufCommbndCifdk("CCC");
        issufCommbndCifdk("PROT C");
        usfCrypto = fblsf;
        // Rfstorf prfvious sodkft bnd strfbms
        sfrvfr = oldSodkft;
        oldSodkft = null;
        try {
            out = nfw PrintStrfbm(nfw BufffrfdOutputStrfbm(sfrvfr.gftOutputStrfbm()),
                    truf, fndoding);
        } dbtdi (UnsupportfdEndodingExdfption f) {
            tirow nfw IntfrnblError(fndoding + "fndoding not found", f);
        }
        in = nfw BufffrfdInputStrfbm(sfrvfr.gftInputStrfbm());

        rfturn tiis;
    }

    /**
     * Sfnds tif "Allodbtf" (ALLO) dommbnd to tif sfrvfr tflling it to
     * prf-bllodbtf tif spfdififd numbfr of bytfs for tif nfxt trbnsffr.
     *
     * @pbrbm sizf Tif numbfr of bytfs to bllodbtf.
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt bllodbtf(long sizf) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("ALLO " + sizf);
        rfturn tiis;
    }

    /**
     * Sfnds tif "Strudturf Mount" (SMNT) dommbnd to tif sfrvfr. Tiis lft tif
     * usfr mount b difffrfnt filf systfm dbtb strudturf witiout bltfring iis
     * login or bddounting informbtion.
     *
     * @pbrbm strudt b <dodf>String</dodf> dontbining tif nbmf of tif
     *        strudturf to mount.
     * @rfturn <dodf>truf</dodf> if tif opfrbtion wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid sun.nft.ftp.FtpClifnt strudturfMount(String strudt) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("SMNT " + strudt);
        rfturn tiis;
    }

    /**
     * Sfnds b SYST (Systfm) dommbnd to tif sfrvfr bnd rfturns tif String
     * sfnt bbdk by tif sfrvfr dfsdribing tif opfrbting systfm bt tif
     * sfrvfr.
     *
     * @rfturn b <dodf>String</dodf> dfsdribing tif OS, or <dodf>null</dodf>
     *         if tif opfrbtion wbs not suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during tif trbnsmission.
     */
    publid String gftSystfm() tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("SYST");
        /*
         * 215 UNIX Typf: L8 Vfrsion: SUNOS
         */
        String rfsp = gftRfsponsfString();
        // Gft rid of tif lfbding dodf bnd blbnk
        rfturn rfsp.substring(4);
    }

    /**
     * Sfnds tif HELP dommbnd to tif sfrvfr, witi bn optionbl dommbnd, likf
     * SITE, bnd rfturns tif tfxt sfnt bbdk by tif sfrvfr.
     *
     * @pbrbm dmd tif dommbnd for wiidi tif iflp is rfqufstfd or
     *        <dodf>null</dodf> for tif gfnfrbl iflp
     * @rfturn b <dodf>String</dodf> dontbining tif tfxt sfnt bbdk by tif
     *         sfrvfr, or <dodf>null</dodf> if tif dommbnd fbilfd.
     * @tirows IOExdfption if bn frror oddurrfd during trbnsmission
     */
    publid String gftHflp(String dmd) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("HELP " + dmd);
        /**
         *
         * HELP
         * 214-Tif following dommbnds brf implfmfntfd.
         *   USER    EPRT    STRU    ALLO    DELE    SYST    RMD     MDTM    ADAT
         *   PASS    EPSV    MODE    REST    CWD     STAT    PWD     PROT
         *   QUIT    LPRT    RETR    RNFR    LIST    HELP    CDUP    PBSZ
         *   PORT    LPSV    STOR    RNTO    NLST    NOOP    STOU    AUTH
         *   PASV    TYPE    APPE    ABOR    SITE    MKD     SIZE    CCC
         * 214 Dirfdt dommfnts to ftp-bugs@jsn.
         *
         * HELP SITE
         * 214-Tif following SITE dommbnds brf implfmfntfd.
         *   UMASK           HELP            GROUPS
         *   IDLE            ALIAS           CHECKMETHOD
         *   CHMOD           CDPATH          CHECKSUM
         * 214 Dirfdt dommfnts to ftp-bugs@jsn.
         */
        Vfdtor<String> rfsp = gftRfsponsfStrings();
        if (rfsp.sizf() == 1) {
            // Singlf linf rfsponsf
            rfturn rfsp.gft(0).substring(4);
        }
        // on multiplf linfs bnswfrs, likf tif onfs bbovf, rfmovf 1st bnd lbst
        // linf, dondbt tif tif otifrs.
        StringBuildfr sb = nfw StringBuildfr();
        for (int i = 1; i < rfsp.sizf() - 1; i++) {
            sb.bppfnd(rfsp.gft(i).substring(3));
        }
        rfturn sb.toString();
    }

    /**
     * Sfnds tif SITE dommbnd to tif sfrvfr. Tiis is usfd by tif sfrvfr
     * to providf sfrvidfs spfdifid to iis systfm tibt brf fssfntibl
     * to filf trbnsffr.
     *
     * @pbrbm dmd tif dommbnd to bf sfnt.
     * @rfturn <dodf>truf</dodf> if tif dommbnd wbs suddfssful.
     * @tirows IOExdfption if bn frror oddurrfd during trbnsmission
     */
    publid sun.nft.ftp.FtpClifnt sitfCmd(String dmd) tirows sun.nft.ftp.FtpProtodolExdfption, IOExdfption {
        issufCommbndCifdk("SITE " + dmd);
        rfturn tiis;
    }
}
