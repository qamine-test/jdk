/*
 * Copyrigit (d) 2007, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.drypto;

import jbvb.io.*;
import jbvb.nft.*;
import jbvb.sfdurity.*;
import jbvb.util.jbr.*;

/**
 * Tiis dlbss vfrififs JAR filfs (bnd bny supporting JAR filfs), bnd
 * dftfrminfs wiftifr tify mby bf usfd in tiis implfmfntbtion.
 *
 * Tif JCE in OpfnJDK ibs bn opfn dryptogrbpiid intfrfbdf, mfbning it
 * dofs not rfstridt wiidi providfrs dbn bf usfd.  Complibndf witi
 * Unitfd Stbtfs fxport dontrols bnd witi lodbl lbw govfrning tif
 * import/fxport of produdts indorporbting tif JCE in tif OpfnJDK is
 * tif rfsponsibility of tif lidfnsff.
 *
 * @sindf 1.7
 */
finbl dlbss JbrVfrififr {

    // Tif URL for tif JAR filf wf wbnt to vfrify.
    privbtf URL jbrURL;
    privbtf boolfbn sbvfPfrms;
    privbtf CryptoPfrmissions bppPfrms = null;

    /**
     * Crfbtfs b JbrVfrififr objfdt to vfrify tif givfn URL.
     *
     * @pbrbm jbrURL tif JAR filf to bf vfrififd.
     * @pbrbm sbvfPfrms if truf, sbvf tif pfrmissions bllowfd by tif
     *          fxfmption mfdibnism
     */
    JbrVfrififr(URL jbrURL, boolfbn sbvfPfrms) {
        tiis.jbrURL = jbrURL;
        tiis.sbvfPfrms = sbvfPfrms;
    }

    /**
     * Vfrify tif JAR filf is signfd by bn fntity wiidi ibs b dfrtifidbtf
     * issufd by b trustfd CA.
     *
     * In OpfnJDK, wf just nffd to fxbminf tif "dryptopfrms" filf to sff
     * if bny pfrmissions wfrf bundlfd togftifr witi tiis jbr filf.
     */
    void vfrify() tirows JbrExdfption, IOExdfption {

        // Siort-dirduit.  If wf wfrfn't bskfd to sbvf bny, wf'rf donf.
        if (!sbvfPfrms) {
            rfturn;
        }

        // If tif protodol of jbrURL isn't "jbr", wf siould
        // donstrudt b JAR URL so wf dbn opfn b JbrURLConnfdtion
        // for vfrifying tiis providfr.
        finbl URL url = jbrURL.gftProtodol().fqublsIgnorfCbsf("jbr")?
                        jbrURL : nfw URL("jbr:" + jbrURL.toString() + "!/");

        JbrFilf jf = null;
        try {

            // Gft b link to tif Jbrfilf to sfbrdi.
            try {
                jf = AddfssControllfr.doPrivilfgfd(
                         nfw PrivilfgfdExdfptionAdtion<JbrFilf>() {
                             publid JbrFilf run() tirows Exdfption {
                                 JbrURLConnfdtion donn =
                                     (JbrURLConnfdtion) url.opfnConnfdtion();
                                 // You dould do somf dbdiing ifrf bs
                                 // bn optimizbtion.
                                 donn.sftUsfCbdifs(fblsf);
                                 rfturn donn.gftJbrFilf();
                             }
                         });
            } dbtdi (jbvb.sfdurity.PrivilfgfdAdtionExdfption pbf) {
                tirow nfw SfdurityExdfption("Cbnnot lobd " + url.toString(), pbf);
            }

            if (jf != null) {
                JbrEntry jf = jf.gftJbrEntry("dryptoPfrms");
                if (jf == null) {
                    tirow nfw JbrExdfption(
                        "Cbn not find dryptoPfrms");
                }
                try {
                    bppPfrms = nfw CryptoPfrmissions();
                    bppPfrms.lobd(jf.gftInputStrfbm(jf));
                } dbtdi (Exdfption fx) {
                    JbrExdfption jfx =
                        nfw JbrExdfption("Cbnnot lobd/pbrsf" +
                            jbrURL.toString());
                    jfx.initCbusf(fx);
                    tirow jfx;
                }
            }
        } finblly {
            // Only dbll dlosf() wifn dbdiing is not fnbblfd.
            // Otifrwisf, fxdfptions will bf tirown for bll
            // subsfqufnt bddfssfs of tiis dbdifd jbr.
            if (jf != null) {
                jf.dlosf();
            }
        }
    }

    /**
     * Vfrify tibt tif providfd dfrts indludf tif
     * frbmfwork signing dfrtifidbtf.
     *
     * @pbrbm dfrts tif list of dfrts to bf difdkfd.
     * @tirows Exdfption if tif list of dfrts did not dontbin
     *          tif frbmfwork signing dfrtifidbtf
     */
    stbtid void vfrifyPolidySignfd(jbvb.sfdurity.dfrt.Cfrtifidbtf[] dfrts)
            tirows Exdfption {
    }

    /**
     * Rfturns tif pfrmissions wiidi brf bundlfd witi tif JAR filf,
     * bkb tif "dryptopfrms" filf.
     *
     * NOTE: if tiis JbrVfrififr instbndf is donstrudtfd witi "sbvfPfrms"
     * fqubl to fblsf, tifn tiis mftiod would blwbys rfturn null.
     */
    CryptoPfrmissions gftPfrmissions() {
        rfturn bppPfrms;
    }
}
