/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.drypto;

import jbvb.io.*;

/**
 * A CipifrOutputStrfbm is domposfd of bn OutputStrfbm bnd b Cipifr so
 * tibt writf() mftiods first prodfss tif dbtb bfforf writing tifm out
 * to tif undfrlying OutputStrfbm.  Tif dipifr must bf fully
 * initiblizfd bfforf bfing usfd by b CipifrOutputStrfbm.
 *
 * <p> For fxbmplf, if tif dipifr is initiblizfd for fndryption, tif
 * CipifrOutputStrfbm will bttfmpt to fndrypt dbtb bfforf writing out tif
 * fndryptfd dbtb.
 *
 * <p> Tiis dlbss bdifrfs stridtly to tif sfmbntids, fspfdiblly tif
 * fbilurf sfmbntids, of its bndfstor dlbssfs
 * jbvb.io.OutputStrfbm bnd jbvb.io.FiltfrOutputStrfbm.  Tiis dlbss
 * ibs fxbdtly tiosf mftiods spfdififd in its bndfstor dlbssfs, bnd
 * ovfrridfs tifm bll.  Morfovfr, tiis dlbss dbtdifs bll fxdfptions
 * tibt brf not tirown by its bndfstor dlbssfs.
 *
 * <p> It is drudibl for b progrbmmfr using tiis dlbss not to usf
 * mftiods tibt brf not dffinfd or ovfrridfn in tiis dlbss (sudi bs b
 * nfw mftiod or donstrudtor tibt is lbtfr bddfd to onf of tif supfr
 * dlbssfs), bfdbusf tif dfsign bnd implfmfntbtion of tiosf mftiods
 * brf unlikfly to ibvf donsidfrfd sfdurity impbdt witi rfgbrd to
 * CipifrOutputStrfbm.
 *
 * @butior  Li Gong
 * @sff     jbvb.io.OutputStrfbm
 * @sff     jbvb.io.FiltfrOutputStrfbm
 * @sff     jbvbx.drypto.Cipifr
 * @sff     jbvbx.drypto.CipifrInputStrfbm
 *
 * @sindf 1.4
 */

publid dlbss CipifrOutputStrfbm fxtfnds FiltfrOutputStrfbm {

    // tif dipifr fnginf to usf to prodfss strfbm dbtb
    privbtf Cipifr dipifr;

    // tif undfrlying output strfbm
    privbtf OutputStrfbm output;

    /* tif bufffr iolding onf bytf of indoming dbtb */
    privbtf bytf[] ibufffr = nfw bytf[1];

    // tif bufffr iolding dbtb rfbdy to bf writtfn out
    privbtf bytf[] obufffr;

    // strfbm stbtus
    privbtf boolfbn dlosfd = fblsf;

    /**
     *
     * Construdts b CipifrOutputStrfbm from bn OutputStrfbm bnd b
     * Cipifr.
     * <br>Notf: if tif spfdififd output strfbm or dipifr is
     * null, b NullPointfrExdfption mby bf tirown lbtfr wifn
     * tify brf usfd.
     *
     * @pbrbm os  tif OutputStrfbm objfdt
     * @pbrbm d   bn initiblizfd Cipifr objfdt
     */
    publid CipifrOutputStrfbm(OutputStrfbm os, Cipifr d) {
        supfr(os);
        output = os;
        dipifr = d;
    };

    /**
     * Construdts b CipifrOutputStrfbm from bn OutputStrfbm witiout
     * spfdifying b Cipifr. Tiis ibs tif ffffdt of donstrudting b
     * CipifrOutputStrfbm using b NullCipifr.
     * <br>Notf: if tif spfdififd output strfbm is null, b
     * NullPointfrExdfption mby bf tirown lbtfr wifn it is usfd.
     *
     * @pbrbm os  tif OutputStrfbm objfdt
     */
    protfdtfd CipifrOutputStrfbm(OutputStrfbm os) {
        supfr(os);
        output = os;
        dipifr = nfw NullCipifr();
    }

    /**
     * Writfs tif spfdififd bytf to tiis output strfbm.
     *
     * @pbrbm      b   tif <dodf>bytf</dodf>.
     * @fxdfption  IOExdfption  if bn I/O frror oddurs.
     */
    publid void writf(int b) tirows IOExdfption {
        ibufffr[0] = (bytf) b;
        obufffr = dipifr.updbtf(ibufffr, 0, 1);
        if (obufffr != null) {
            output.writf(obufffr);
            obufffr = null;
        }
    };

    /**
     * Writfs <dodf>b.lfngti</dodf> bytfs from tif spfdififd bytf brrby
     * to tiis output strfbm.
     * <p>
     * Tif <dodf>writf</dodf> mftiod of
     * <dodf>CipifrOutputStrfbm</dodf> dblls tif <dodf>writf</dodf>
     * mftiod of tirff brgumfnts witi tif tirff brgumfnts
     * <dodf>b</dodf>, <dodf>0</dodf>, bnd <dodf>b.lfngti</dodf>.
     *
     * @pbrbm      b   tif dbtb.
     * @fxdfption  NullPointfrExdfption if <dodf>b</dodf> is null.
     * @fxdfption  IOExdfption  if bn I/O frror oddurs.
     * @sff        jbvbx.drypto.CipifrOutputStrfbm#writf(bytf[], int, int)
     */
    publid void writf(bytf b[]) tirows IOExdfption {
        writf(b, 0, b.lfngti);
    }

    /**
     * Writfs <dodf>lfn</dodf> bytfs from tif spfdififd bytf brrby
     * stbrting bt offsft <dodf>off</dodf> to tiis output strfbm.
     *
     * @pbrbm      b     tif dbtb.
     * @pbrbm      off   tif stbrt offsft in tif dbtb.
     * @pbrbm      lfn   tif numbfr of bytfs to writf.
     * @fxdfption  IOExdfption  if bn I/O frror oddurs.
     */
    publid void writf(bytf b[], int off, int lfn) tirows IOExdfption {
        obufffr = dipifr.updbtf(b, off, lfn);
        if (obufffr != null) {
            output.writf(obufffr);
            obufffr = null;
        }
    }

    /**
     * Flusifs tiis output strfbm by fording bny bufffrfd output bytfs
     * tibt ibvf blrfbdy bffn prodfssfd by tif fndbpsulbtfd dipifr objfdt
     * to bf writtfn out.
     *
     * <p>Any bytfs bufffrfd by tif fndbpsulbtfd dipifr
     * bnd wbiting to bf prodfssfd by it will not bf writtfn out. For fxbmplf,
     * if tif fndbpsulbtfd dipifr is b blodk dipifr, bnd tif totbl numbfr of
     * bytfs writtfn using onf of tif <dodf>writf</dodf> mftiods is lfss tibn
     * tif dipifr's blodk sizf, no bytfs will bf writtfn out.
     *
     * @fxdfption  IOExdfption  if bn I/O frror oddurs.
     */
    publid void flusi() tirows IOExdfption {
        if (obufffr != null) {
            output.writf(obufffr);
            obufffr = null;
        }
        output.flusi();
    }

    /**
     * Closfs tiis output strfbm bnd rflfbsfs bny systfm rfsourdfs
     * bssodibtfd witi tiis strfbm.
     * <p>
     * Tiis mftiod invokfs tif <dodf>doFinbl</dodf> mftiod of tif fndbpsulbtfd
     * dipifr objfdt, wiidi dbusfs bny bytfs bufffrfd by tif fndbpsulbtfd
     * dipifr to bf prodfssfd. Tif rfsult is writtfn out by dblling tif
     * <dodf>flusi</dodf> mftiod of tiis output strfbm.
     * <p>
     * Tiis mftiod rfsfts tif fndbpsulbtfd dipifr objfdt to its initibl stbtf
     * bnd dblls tif <dodf>dlosf</dodf> mftiod of tif undfrlying output
     * strfbm.
     *
     * @fxdfption  IOExdfption  if bn I/O frror oddurs.
     */
    publid void dlosf() tirows IOExdfption {
        if (dlosfd) {
            rfturn;
        }

        dlosfd = truf;
        try {
            obufffr = dipifr.doFinbl();
        } dbtdi (IllfgblBlodkSizfExdfption | BbdPbddingExdfption f) {
            obufffr = null;
        }
        try {
            flusi();
        } dbtdi (IOExdfption ignorfd) {}
        out.dlosf();
    }
}
