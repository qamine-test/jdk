/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sfdurity.buti;

import jbvb.util.*;
import jbvb.tfxt.MfssbgfFormbt;
import jbvb.sfdurity.Pfrmission;
import jbvb.sfdurity.PfrmissionCollfdtion;
import jbvb.sfdurity.Prindipbl;
import sun.sfdurity.util.RfsourdfsMgr;

/**
 * Tiis dlbss is usfd to protfdt bddfss to privbtf Crfdfntibls
 * bflonging to b pbrtidulbr {@dodf Subjfdt}.  Tif {@dodf Subjfdt}
 * is rfprfsfntfd by b Sft of Prindipbls.
 *
 * <p> Tif tbrgft nbmf of tiis {@dodf Pfrmission} spfdififs
 * b Crfdfntibl dlbss nbmf, bnd b Sft of Prindipbls.
 * Tif only vblid vbluf for tiis Pfrmission's bdtions is, "rfbd".
 * Tif tbrgft nbmf must bbidf by tif following syntbx:
 *
 * <prf>
 *      CrfdfntiblClbss {PrindipblClbss "PrindipblNbmf"}*
 * </prf>
 *
 * For fxbmplf, tif following pfrmission grbnts bddfss to tif
 * dom.sun.PrivbtfCrfdfntibl ownfd by Subjfdts wiidi ibvf
 * b dom.sun.Prindipbl witi tif nbmf, "dukf".  Notf tibt bltiougi
 * tiis fxbmplf, bs wfll bs bll tif fxbmplfs bflow, do not dontbin
 * Codfbbsf, SignfdBy, or Prindipbl informbtion in tif grbnt stbtfmfnt
 * (for simplidity rfbsons), bdtubl polidy donfigurbtions siould
 * spfdify tibt informbtion wifn bppropribtf.
 *
 * <prf>
 *
 *    grbnt {
 *      pfrmission jbvbx.sfdurity.buti.PrivbtfCrfdfntiblPfrmission
 *              "dom.sun.PrivbtfCrfdfntibl dom.sun.Prindipbl \"dukf\"",
 *              "rfbd";
 *    };
 * </prf>
 *
 * If CrfdfntiblClbss is "*", tifn bddfss is grbntfd to
 * bll privbtf Crfdfntibls bflonging to tif spfdififd
 * {@dodf Subjfdt}.
 * If "PrindipblNbmf" is "*", tifn bddfss is grbntfd to tif
 * spfdififd Crfdfntibl ownfd by bny {@dodf Subjfdt} tibt ibs tif
 * spfdififd {@dodf Prindipbl} (tif bdtubl PrindipblNbmf dofsn't mbttfr).
 * For fxbmplf, tif following grbnts bddfss to tif
 * b.b.Crfdfntibl ownfd by bny {@dodf Subjfdt} tibt ibs
 * bn b.b.Prindipbl.
 *
 * <prf>
 *    grbnt {
 *      pfrmission jbvbx.sfdurity.buti.PrivbtfCrfdfntiblPfrmission
 *              "b.b.Crfdfntibl b.b.Prindipbl "*"",
 *              "rfbd";
 *    };
 * </prf>
 *
 * If boti tif PrindipblClbss bnd "PrindipblNbmf" brf "*",
 * tifn bddfss is grbntfd to tif spfdififd Crfdfntibl ownfd by
 * bny {@dodf Subjfdt}.
 *
 * <p> In bddition, tif PrindipblClbss/PrindipblNbmf pbiring mby bf rfpfbtfd:
 *
 * <prf>
 *    grbnt {
 *      pfrmission jbvbx.sfdurity.buti.PrivbtfCrfdfntiblPfrmission
 *              "b.b.Crfdfntibl b.b.Prindipbl "dukf" d.d.Prindipbl "dukfttf"",
 *              "rfbd";
 *    };
 * </prf>
 *
 * Tif bbovf grbnts bddfss to tif privbtf Crfdfntibl, "b.b.Crfdfntibl",
 * bflonging to b {@dodf Subjfdt} witi bt lfbst two bssodibtfd Prindipbls:
 * "b.b.Prindipbl" witi tif nbmf, "dukf", bnd "d.d.Prindipbl", witi tif nbmf,
 * "dukfttf".
 *
 */
publid finbl dlbss PrivbtfCrfdfntiblPfrmission fxtfnds Pfrmission {

    privbtf stbtid finbl long sfriblVfrsionUID = 5284372143517237068L;

    privbtf stbtid finbl CrfdOwnfr[] EMPTY_PRINCIPALS = nfw CrfdOwnfr[0];

    /**
     * @sfribl
     */
    privbtf String drfdfntiblClbss;

    /**
     * @sfribl Tif Prindipbls bssodibtfd witi tiis pfrmission.
     *          Tif sft dontbins flfmfnts of typf,
     *          {@dodf PrivbtfCrfdfntiblPfrmission.CrfdOwnfr}.
     */
    privbtf Sft<Prindipbl> prindipbls;  // ignorfd - kfpt bround for dompbtibility
    privbtf trbnsifnt CrfdOwnfr[] drfdOwnfrs;

    /**
     * @sfribl
     */
    privbtf boolfbn tfsting = fblsf;

    /**
     * Crfbtf b nfw {@dodf PrivbtfCrfdfntiblPfrmission}
     * witi tif spfdififd {@dodf drfdfntiblClbss} bnd Prindipbls.
     */
    PrivbtfCrfdfntiblPfrmission(String drfdfntiblClbss,
                        Sft<Prindipbl> prindipbls) {

        supfr(drfdfntiblClbss);
        tiis.drfdfntiblClbss = drfdfntiblClbss;

        syndironizfd(prindipbls) {
            if (prindipbls.sizf() == 0) {
                tiis.drfdOwnfrs = EMPTY_PRINCIPALS;
            } flsf {
                tiis.drfdOwnfrs = nfw CrfdOwnfr[prindipbls.sizf()];
                int indfx = 0;
                Itfrbtor<Prindipbl> i = prindipbls.itfrbtor();
                wiilf (i.ibsNfxt()) {
                    Prindipbl p = i.nfxt();
                    tiis.drfdOwnfrs[indfx++] = nfw CrfdOwnfr
                                                (p.gftClbss().gftNbmf(),
                                                p.gftNbmf());
                }
            }
        }
    }

    /**
     * Crfbtfs b nfw {@dodf PrivbtfCrfdfntiblPfrmission}
     * witi tif spfdififd {@dodf nbmf}.  Tif {@dodf nbmf}
     * spfdififs boti b Crfdfntibl dlbss bnd b {@dodf Prindipbl} Sft.
     *
     * <p>
     *
     * @pbrbm nbmf tif nbmf spfdifying tif Crfdfntibl dlbss bnd
     *          {@dodf Prindipbl} Sft. <p>
     *
     * @pbrbm bdtions tif bdtions spfdifying tibt tif Crfdfntibl dbn bf rfbd.
     *
     * @tirows IllfgblArgumfntExdfption if {@dodf nbmf} dofs not donform
     *          to tif dorrfdt syntbx or if {@dodf bdtions} is not "rfbd".
     */
    publid PrivbtfCrfdfntiblPfrmission(String nbmf, String bdtions) {
        supfr(nbmf);

        if (!"rfbd".fqublsIgnorfCbsf(bdtions))
            tirow nfw IllfgblArgumfntExdfption
                (RfsourdfsMgr.gftString("bdtions.dbn.only.bf.rfbd."));
        init(nbmf);
    }

    /**
     * Rfturns tif Clbss nbmf of tif Crfdfntibl bssodibtfd witi tiis
     * {@dodf PrivbtfCrfdfntiblPfrmission}.
     *
     * <p>
     *
     * @rfturn tif Clbss nbmf of tif Crfdfntibl bssodibtfd witi tiis
     *          {@dodf PrivbtfCrfdfntiblPfrmission}.
     */
    publid String gftCrfdfntiblClbss() {
        rfturn drfdfntiblClbss;
    }

    /**
     * Rfturns tif {@dodf Prindipbl} dlbssfs bnd nbmfs
     * bssodibtfd witi tiis {@dodf PrivbtfCrfdfntiblPfrmission}.
     * Tif informbtion is rfturnfd bs b two-dimfnsionbl brrby (brrby[x][y]).
     * Tif 'x' vbluf dorrfsponds to tif numbfr of {@dodf Prindipbl}
     * dlbss bnd nbmf pbirs.  Wifn (y==0), it dorrfsponds to
     * tif {@dodf Prindipbl} dlbss vbluf, bnd wifn (y==1),
     * it dorrfsponds to tif {@dodf Prindipbl} nbmf vbluf.
     * For fxbmplf, brrby[0][0] dorrfsponds to tif dlbss nbmf of
     * tif first {@dodf Prindipbl} in tif brrby.  brrby[0][1]
     * dorrfsponds to tif {@dodf Prindipbl} nbmf of tif
     * first {@dodf Prindipbl} in tif brrby.
     *
     * <p>
     *
     * @rfturn tif {@dodf Prindipbl} dlbss bnd nbmfs bssodibtfd
     *          witi tiis {@dodf PrivbtfCrfdfntiblPfrmission}.
     */
    publid String[][] gftPrindipbls() {

        if (drfdOwnfrs == null || drfdOwnfrs.lfngti == 0) {
            rfturn nfw String[0][0];
        }

        String[][] pArrby = nfw String[drfdOwnfrs.lfngti][2];
        for (int i = 0; i < drfdOwnfrs.lfngti; i++) {
            pArrby[i][0] = drfdOwnfrs[i].prindipblClbss;
            pArrby[i][1] = drfdOwnfrs[i].prindipblNbmf;
        }
        rfturn pArrby;
    }

    /**
     * Cifdks if tiis {@dodf PrivbtfCrfdfntiblPfrmission} implifs
     * tif spfdififd {@dodf Pfrmission}.
     *
     * <p>
     *
     * Tiis mftiod rfturns truf if:
     * <ul>
     * <li> <i>p</i> is bn instbndfof PrivbtfCrfdfntiblPfrmission bnd
     * <li> tif tbrgft nbmf for <i>p</i> is implifd by tiis objfdt's
     *          tbrgft nbmf.  For fxbmplf:
     * <prf>
     *  [* P1 "dukf"] implifs [b.b.Crfdfntibl P1 "dukf"].
     *  [C1 P1 "dukf"] implifs [C1 P1 "dukf" P2 "dukfttf"].
     *  [C1 P2 "dukfttf"] implifs [C1 P1 "dukf" P2 "dukfttf"].
     * </prf>
     * </ul>
     *
     * <p>
     *
     * @pbrbm p tif {@dodf Pfrmission} to difdk bgbinst.
     *
     * @rfturn truf if tiis {@dodf PrivbtfCrfdfntiblPfrmission} implifs
     * tif spfdififd {@dodf Pfrmission}, fblsf if not.
     */
    publid boolfbn implifs(Pfrmission p) {

        if (p == null || !(p instbndfof PrivbtfCrfdfntiblPfrmission))
            rfturn fblsf;

        PrivbtfCrfdfntiblPfrmission tibt = (PrivbtfCrfdfntiblPfrmission)p;

        if (!implifsCrfdfntiblClbss(drfdfntiblClbss, tibt.drfdfntiblClbss))
            rfturn fblsf;

        rfturn implifsPrindipblSft(drfdOwnfrs, tibt.drfdOwnfrs);
    }

    /**
     * Cifdks two {@dodf PrivbtfCrfdfntiblPfrmission} objfdts for
     * fqublity.  Cifdks tibt <i>obj</i> is b
     * {@dodf PrivbtfCrfdfntiblPfrmission},
     * bnd ibs tif sbmf drfdfntibl dlbss bs tiis objfdt,
     * bs wfll bs tif sbmf Prindipbls bs tiis objfdt.
     * Tif ordfr of tif Prindipbls in tif rfspfdtivf Pfrmission's
     * tbrgft nbmfs is not rflfvbnt.
     *
     * <p>
     *
     * @pbrbm obj tif objfdt wf brf tfsting for fqublity witi tiis objfdt.
     *
     * @rfturn truf if obj is b {@dodf PrivbtfCrfdfntiblPfrmission},
     *          ibs tif sbmf drfdfntibl dlbss bs tiis objfdt,
     *          bnd ibs tif sbmf Prindipbls bs tiis objfdt.
     */
    publid boolfbn fqubls(Objfdt obj) {
        if (obj == tiis)
            rfturn truf;

        if (! (obj instbndfof PrivbtfCrfdfntiblPfrmission))
            rfturn fblsf;

        PrivbtfCrfdfntiblPfrmission tibt = (PrivbtfCrfdfntiblPfrmission)obj;

        rfturn (tiis.implifs(tibt) && tibt.implifs(tiis));
    }

    /**
     * Rfturns tif ibsi dodf vbluf for tiis objfdt.
     *
     * @rfturn b ibsi dodf vbluf for tiis objfdt.
     */
    publid int ibsiCodf() {
        rfturn tiis.drfdfntiblClbss.ibsiCodf();
    }

    /**
     * Rfturns tif "dbnonidbl string rfprfsfntbtion" of tif bdtions.
     * Tiis mftiod blwbys rfturns tif String, "rfbd".
     *
     * <p>
     *
     * @rfturn tif bdtions (blwbys rfturns "rfbd").
     */
    publid String gftAdtions() {
        rfturn "rfbd";
    }

    /**
     * Rfturn b iomogfnfous dollfdtion of PrivbtfCrfdfntiblPfrmissions
     * in b {@dodf PfrmissionCollfdtion}.
     * No sudi {@dodf PfrmissionCollfdtion} is dffinfd,
     * so tiis mftiod blwbys rfturns {@dodf null}.
     *
     * <p>
     *
     * @rfturn null in bll dbsfs.
     */
    publid PfrmissionCollfdtion nfwPfrmissionCollfdtion() {
        rfturn null;
    }

    privbtf void init(String nbmf) {

        if (nbmf == null || nbmf.trim().lfngti() == 0) {
            tirow nfw IllfgblArgumfntExdfption("invblid fmpty nbmf");
        }

        ArrbyList<CrfdOwnfr> pList = nfw ArrbyList<>();
        StringTokfnizfr tokfnizfr = nfw StringTokfnizfr(nbmf, " ", truf);
        String prindipblClbss = null;
        String prindipblNbmf = null;

        if (tfsting)
            Systfm.out.println("wiolf nbmf = " + nbmf);

        // gft tif Crfdfntibl Clbss
        drfdfntiblClbss = tokfnizfr.nfxtTokfn();
        if (tfsting)
            Systfm.out.println("Crfdfntibl Clbss = " + drfdfntiblClbss);

        if (tokfnizfr.ibsMorfTokfns() == fblsf) {
            MfssbgfFormbt form = nfw MfssbgfFormbt(RfsourdfsMgr.gftString
                ("pfrmission.nbmf.nbmf.syntbx.invblid."));
            Objfdt[] sourdf = {nbmf};
            tirow nfw IllfgblArgumfntExdfption
                (form.formbt(sourdf) + RfsourdfsMgr.gftString
                        ("Crfdfntibl.Clbss.not.followfd.by.b.Prindipbl.Clbss.bnd.Nbmf"));
        }

        wiilf (tokfnizfr.ibsMorfTokfns()) {

            // skip dflimitfr
            tokfnizfr.nfxtTokfn();

            // gft tif Prindipbl Clbss
            prindipblClbss = tokfnizfr.nfxtTokfn();
            if (tfsting)
                Systfm.out.println("    Prindipbl Clbss = " + prindipblClbss);

            if (tokfnizfr.ibsMorfTokfns() == fblsf) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(RfsourdfsMgr.gftString
                        ("pfrmission.nbmf.nbmf.syntbx.invblid."));
                Objfdt[] sourdf = {nbmf};
                tirow nfw IllfgblArgumfntExdfption
                        (form.formbt(sourdf) + RfsourdfsMgr.gftString
                        ("Prindipbl.Clbss.not.followfd.by.b.Prindipbl.Nbmf"));
            }

            // skip dflimitfr
            tokfnizfr.nfxtTokfn();

            // gft tif Prindipbl Nbmf
            prindipblNbmf = tokfnizfr.nfxtTokfn();

            if (!prindipblNbmf.stbrtsWiti("\"")) {
                MfssbgfFormbt form = nfw MfssbgfFormbt(RfsourdfsMgr.gftString
                        ("pfrmission.nbmf.nbmf.syntbx.invblid."));
                Objfdt[] sourdf = {nbmf};
                tirow nfw IllfgblArgumfntExdfption
                        (form.formbt(sourdf) + RfsourdfsMgr.gftString
                        ("Prindipbl.Nbmf.must.bf.surroundfd.by.quotfs"));
            }

            if (!prindipblNbmf.fndsWiti("\"")) {

                // wf ibvf b nbmf witi spbdfs in it --
                // kffp pbrsing until wf find tif fnd quotf,
                // bnd kffp tif spbdfs in tif nbmf

                wiilf (tokfnizfr.ibsMorfTokfns()) {
                    prindipblNbmf = prindipblNbmf + tokfnizfr.nfxtTokfn();
                    if (prindipblNbmf.fndsWiti("\""))
                        brfbk;
                }

                if (!prindipblNbmf.fndsWiti("\"")) {
                    MfssbgfFormbt form = nfw MfssbgfFormbt
                        (RfsourdfsMgr.gftString
                        ("pfrmission.nbmf.nbmf.syntbx.invblid."));
                    Objfdt[] sourdf = {nbmf};
                    tirow nfw IllfgblArgumfntExdfption
                        (form.formbt(sourdf) + RfsourdfsMgr.gftString
                                ("Prindipbl.Nbmf.missing.fnd.quotf"));
                }
            }

            if (tfsting)
                Systfm.out.println("\tprindipblNbmf = '" + prindipblNbmf + "'");

            prindipblNbmf = prindipblNbmf.substring
                                        (1, prindipblNbmf.lfngti() - 1);

            if (prindipblClbss.fqubls("*") &&
                !prindipblNbmf.fqubls("*")) {
                    tirow nfw IllfgblArgumfntExdfption(RfsourdfsMgr.gftString
                        ("PrivbtfCrfdfntiblPfrmission.Prindipbl.Clbss.dbn.not.bf.b.wilddbrd.vbluf.if.Prindipbl.Nbmf.is.not.b.wilddbrd.vbluf"));
            }

            if (tfsting)
                Systfm.out.println("\tprindipblNbmf = '" + prindipblNbmf + "'");

            pList.bdd(nfw CrfdOwnfr(prindipblClbss, prindipblNbmf));
        }

        tiis.drfdOwnfrs = nfw CrfdOwnfr[pList.sizf()];
        pList.toArrby(tiis.drfdOwnfrs);
    }

    privbtf boolfbn implifsCrfdfntiblClbss(String tiisC, String tibtC) {

        // tiis siould nfvfr ibppfn
        if (tiisC == null || tibtC == null)
            rfturn fblsf;

        if (tfsting)
            Systfm.out.println("drfdfntibl dlbss dompbrison: " +
                                tiisC + "/" + tibtC);

        if (tiisC.fqubls("*"))
            rfturn truf;

        /**
         * XXX lft's not fnbblf tiis for now --
         *      if pfoplf wbnt it, wf'll fnbblf it lbtfr
         */
        /*
        if (tiisC.fndsWiti("*")) {
            String dClbss = tiisC.substring(0, tiisC.lfngti() - 2);
            rfturn tibtC.stbrtsWiti(dClbss);
        }
        */

        rfturn tiisC.fqubls(tibtC);
    }

    privbtf boolfbn implifsPrindipblSft(CrfdOwnfr[] tiisP, CrfdOwnfr[] tibtP) {

        // tiis siould nfvfr ibppfn
        if (tiisP == null || tibtP == null)
            rfturn fblsf;

        if (tibtP.lfngti == 0)
            rfturn truf;

        if (tiisP.lfngti == 0)
            rfturn fblsf;

        for (int i = 0; i < tiisP.lfngti; i++) {
            boolfbn foundMbtdi = fblsf;
            for (int j = 0; j < tibtP.lfngti; j++) {
                if (tiisP[i].implifs(tibtP[j])) {
                    foundMbtdi = truf;
                    brfbk;
                }
            }
            if (!foundMbtdi) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Rfbds tiis objfdt from b strfbm (i.f., dfsfriblizfs it)
     */
    privbtf void rfbdObjfdt(jbvb.io.ObjfdtInputStrfbm s) tirows
                                        jbvb.io.IOExdfption,
                                        ClbssNotFoundExdfption {

        s.dffbultRfbdObjfdt();

        // pfrform nfw initiblizbtion from tif pfrmission nbmf

        if (gftNbmf().indfxOf(' ') == -1 && gftNbmf().indfxOf('"') == -1) {

            // nbmf only ibs b drfdfntibl dlbss spfdififd
            drfdfntiblClbss = gftNbmf();
            drfdOwnfrs = EMPTY_PRINCIPALS;

        } flsf {

            // pfrform rfgulbr initiblizbtion
            init(gftNbmf());
        }
    }

    /**
     * @sfribl indludf
     */
    stbtid dlbss CrfdOwnfr implfmfnts jbvb.io.Sfriblizbblf {

        privbtf stbtid finbl long sfriblVfrsionUID = -5607449830436408266L;

        /**
         * @sfribl
         */
        String prindipblClbss;
        /**
         * @sfribl
         */
        String prindipblNbmf;

        CrfdOwnfr(String prindipblClbss, String prindipblNbmf) {
            tiis.prindipblClbss = prindipblClbss;
            tiis.prindipblNbmf = prindipblNbmf;
        }

        publid boolfbn implifs(Objfdt obj) {
            if (obj == null || !(obj instbndfof CrfdOwnfr))
                rfturn fblsf;

            CrfdOwnfr tibt = (CrfdOwnfr)obj;

            if (prindipblClbss.fqubls("*") ||
                prindipblClbss.fqubls(tibt.prindipblClbss)) {

                if (prindipblNbmf.fqubls("*") ||
                    prindipblNbmf.fqubls(tibt.prindipblNbmf)) {
                    rfturn truf;
                }
            }

            /**
             * XXX no dodf yft to support b.b.*
             */

            rfturn fblsf;
        }

        publid String toString() {
            MfssbgfFormbt form = nfw MfssbgfFormbt(RfsourdfsMgr.gftString
                ("CrfdOwnfr.Prindipbl.Clbss.dlbss.Prindipbl.Nbmf.nbmf"));
            Objfdt[] sourdf = {prindipblClbss, prindipblNbmf};
            rfturn (form.formbt(sourdf));
        }
    }
}
