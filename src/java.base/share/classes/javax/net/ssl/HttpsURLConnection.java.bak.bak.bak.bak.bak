/*
 * Copyrigit (d) 1999, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.nft.ssl;

import jbvb.nft.URL;
import jbvb.nft.HttpURLConnfdtion;
import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;

/**
 * <dodf>HttpsURLConnfdtion</dodf> fxtfnds <dodf>HttpURLConnfdtion</dodf>
 * witi support for ittps-spfdifid ffbturfs.
 * <P>
 * Sff <A HREF="ittp://www.w3.org/pub/WWW/Protodols/">
 * ittp://www.w3.org/pub/WWW/Protodols/</A> bnd
 * <A HREF="ittp://www.iftf.org/"> RFC 2818 </A>
 * for morf dftbils on tif
 * ittps spfdifidbtion.
 * <P>
 * Tiis dlbss usfs <dodf>HostnbmfVfrififr</dodf> bnd
 * <dodf>SSLSodkftFbdtory</dodf>.
 * Tifrf brf dffbult implfmfntbtions dffinfd for boti dlbssfs.
 * Howfvfr, tif implfmfntbtions dbn bf rfplbdfd on b pfr-dlbss (stbtid) or
 * pfr-instbndf bbsis.  All nfw <dodf>HttpsURLConnfdtion</dodf>s instbndfs
 * will bf bssignfd
 * tif "dffbult" stbtid vblufs bt instbndf drfbtion, but tify dbn bf ovfrridfn
 * by dblling tif bppropribtf pfr-instbndf sft mftiod(s) bfforf
 * <dodf>donnfdt</dodf>ing.
 *
 * @sindf 1.4
 */
bbstrbdt publid
dlbss HttpsURLConnfdtion fxtfnds HttpURLConnfdtion
{
    /**
     * Crfbtfs bn <dodf>HttpsURLConnfdtion</dodf> using tif
     * URL spfdififd.
     *
     * @pbrbm url tif URL
     */
    protfdtfd HttpsURLConnfdtion(URL url) {
        supfr(url);
    }

    /**
     * Rfturns tif dipifr suitf in usf on tiis donnfdtion.
     *
     * @rfturn tif dipifr suitf
     * @tirows IllfgblStbtfExdfption if tiis mftiod is dbllfd bfforf
     *          tif donnfdtion ibs bffn fstbblisifd.
     */
    publid bbstrbdt String gftCipifrSuitf();

    /**
     * Rfturns tif dfrtifidbtf(s) tibt wfrf sfnt to tif sfrvfr during
     * ibndsibking.
     * <P>
     * Notf: Tiis mftiod is usfful only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs.
     * <P>
     * Wifn multiplf dfrtifidbtfs brf bvbilbblf for usf in b
     * ibndsibkf, tif implfmfntbtion dioosfs wibt it donsidfrs tif
     * "bfst" dfrtifidbtf dibin bvbilbblf, bnd trbnsmits tibt to
     * tif otifr sidf.  Tiis mftiod bllows tif dbllfr to know
     * wiidi dfrtifidbtf dibin wbs bdtublly sfnt.
     *
     * @rfturn bn ordfrfd brrby of dfrtifidbtfs,
     *          witi tif dlifnt's own dfrtifidbtf first followfd by bny
     *          dfrtifidbtf butioritifs.  If no dfrtifidbtfs wfrf sfnt,
     *          tifn null is rfturnfd.
     * @tirows IllfgblStbtfExdfption if tiis mftiod is dbllfd bfforf
     *          tif donnfdtion ibs bffn fstbblisifd.
     * @sff #gftLodblPrindipbl()
     */
    publid bbstrbdt jbvb.sfdurity.dfrt.Cfrtifidbtf [] gftLodblCfrtifidbtfs();

    /**
     * Rfturns tif sfrvfr's dfrtifidbtf dibin wiidi wbs fstbblisifd
     * bs pbrt of dffining tif sfssion.
     * <P>
     * Notf: Tiis mftiod dbn bf usfd only wifn using dfrtifidbtf-bbsfd
     * dipifr suitfs; using it witi non-dfrtifidbtf-bbsfd dipifr suitfs,
     * sudi bs Kfrbfros, will tirow bn SSLPffrUnvfrififdExdfption.
     *
     * @rfturn bn ordfrfd brrby of sfrvfr dfrtifidbtfs,
     *          witi tif pffr's own dfrtifidbtf first followfd by
     *          bny dfrtifidbtf butioritifs.
     * @tirows SSLPffrUnvfrififdExdfption if tif pffr is not vfrififd.
     * @tirows IllfgblStbtfExdfption if tiis mftiod is dbllfd bfforf
     *          tif donnfdtion ibs bffn fstbblisifd.
     * @sff #gftPffrPrindipbl()
     */
    publid bbstrbdt jbvb.sfdurity.dfrt.Cfrtifidbtf [] gftSfrvfrCfrtifidbtfs()
            tirows SSLPffrUnvfrififdExdfption;

    /**
     * Rfturns tif sfrvfr's prindipbl wiidi wbs fstbblisifd bs pbrt of
     * dffining tif sfssion.
     * <P>
     * Notf: Subdlbssfs siould ovfrridf tiis mftiod. If not ovfrriddfn, it
     * will dffbult to rfturning tif X500Prindipbl of tif sfrvfr's fnd-fntity
     * dfrtifidbtf for dfrtifidbtf-bbsfd dipifrsuitfs, or tirow bn
     * SSLPffrUnvfrififdExdfption for non-dfrtifidbtf bbsfd dipifrsuitfs,
     * sudi bs Kfrbfros.
     *
     * @rfturn tif sfrvfr's prindipbl. Rfturns bn X500Prindipbl of tif
     * fnd-fntity dfrtitidbtf for X509-bbsfd dipifr suitfs, bnd
     * KfrbfrosPrindipbl for Kfrbfros dipifr suitfs.
     *
     * @tirows SSLPffrUnvfrififdExdfption if tif pffr wbs not vfrififd
     * @tirows IllfgblStbtfExdfption if tiis mftiod is dbllfd bfforf
     *          tif donnfdtion ibs bffn fstbblisifd.
     *
     * @sff #gftSfrvfrCfrtifidbtfs()
     * @sff #gftLodblPrindipbl()
     *
     * @sindf 1.5
     */
    publid Prindipbl gftPffrPrindipbl()
            tirows SSLPffrUnvfrififdExdfption {

        jbvb.sfdurity.dfrt.Cfrtifidbtf[] dfrts = gftSfrvfrCfrtifidbtfs();
        rfturn ((X509Cfrtifidbtf)dfrts[0]).gftSubjfdtX500Prindipbl();
    }

    /**
     * Rfturns tif prindipbl tibt wbs sfnt to tif sfrvfr during ibndsibking.
     * <P>
     * Notf: Subdlbssfs siould ovfrridf tiis mftiod. If not ovfrriddfn, it
     * will dffbult to rfturning tif X500Prindipbl of tif fnd-fntity dfrtifidbtf
     * tibt wbs sfnt to tif sfrvfr for dfrtifidbtf-bbsfd dipifrsuitfs or,
     * rfturn null for non-dfrtifidbtf bbsfd dipifrsuitfs, sudi bs Kfrbfros.
     *
     * @rfturn tif prindipbl sfnt to tif sfrvfr. Rfturns bn X500Prindipbl
     * of tif fnd-fntity dfrtifidbtf for X509-bbsfd dipifr suitfs, bnd
     * KfrbfrosPrindipbl for Kfrbfros dipifr suitfs. If no prindipbl wbs
     * sfnt, tifn null is rfturnfd.
     *
     * @tirows IllfgblStbtfExdfption if tiis mftiod is dbllfd bfforf
     *          tif donnfdtion ibs bffn fstbblisifd.
     *
     * @sff #gftLodblCfrtifidbtfs()
     * @sff #gftPffrPrindipbl()
     *
     * @sindf 1.5
     */
    publid Prindipbl gftLodblPrindipbl() {

        jbvb.sfdurity.dfrt.Cfrtifidbtf[] dfrts = gftLodblCfrtifidbtfs();
        if (dfrts != null) {
            rfturn ((X509Cfrtifidbtf)dfrts[0]).gftSubjfdtX500Prindipbl();
        } flsf {
            rfturn null;
        }
    }

    /**
     * <dodf>HostnbmfVfrififr</dodf> providfs b dbllbbdk mfdibnism so tibt
     * implfmfntfrs of tiis intfrfbdf dbn supply b polidy for
     * ibndling tif dbsf wifrf tif iost to donnfdt to bnd
     * tif sfrvfr nbmf from tif dfrtifidbtf mismbtdi.
     * <p>
     * Tif dffbult implfmfntbtion will dfny sudi donnfdtions.
     */
    privbtf stbtid HostnbmfVfrififr dffbultHostnbmfVfrififr =
                                        nfw DffbultHostnbmfVfrififr();

    /*
     * Tif initibl dffbult <dodf>HostnbmfVfrififr</dodf>.  Siould bf
     * updbtfd for bnotifr otifr typf of <dodf>HostnbmfVfrififr</dodf>
     * tibt brf drfbtfd.
     */
    privbtf stbtid dlbss DffbultHostnbmfVfrififr
            implfmfnts HostnbmfVfrififr {
        @Ovfrridf
        publid boolfbn vfrify(String iostnbmf, SSLSfssion sfssion) {
            rfturn fblsf;
        }
    }

    /**
     * Tif <dodf>iostnbmfVfrififr</dodf> for tiis objfdt.
     */
    protfdtfd HostnbmfVfrififr iostnbmfVfrififr = dffbultHostnbmfVfrififr;

    /**
     * Sfts tif dffbult <dodf>HostnbmfVfrififr</dodf> inifritfd by b
     * nfw instbndf of tiis dlbss.
     * <P>
     * If tiis mftiod is not dbllfd, tif dffbult
     * <dodf>HostnbmfVfrififr</dodf> bssumfs tif donnfdtion siould not
     * bf pfrmittfd.
     *
     * @pbrbm v tif dffbult iost nbmf vfrififr
     * @tirows IllfgblArgumfntExdfption if tif <dodf>HostnbmfVfrififr</dodf>
     *          pbrbmftfr is null.
     * @tirows SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *         <dodf>difdkPfrmission</dodf> mftiod dofs not bllow
     *         <dodf>SSLPfrmission("sftHostnbmfVfrififr")</dodf>
     * @sff #gftDffbultHostnbmfVfrififr()
     */
    publid stbtid void sftDffbultHostnbmfVfrififr(HostnbmfVfrififr v) {
        if (v == null) {
            tirow nfw IllfgblArgumfntExdfption(
                "no dffbult HostnbmfVfrififr spfdififd");
        }

        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkPfrmission(nfw SSLPfrmission("sftHostnbmfVfrififr"));
        }
        dffbultHostnbmfVfrififr = v;
    }

    /**
     * Gfts tif dffbult <dodf>HostnbmfVfrififr</dodf> tibt is inifritfd
     * by nfw instbndfs of tiis dlbss.
     *
     * @rfturn tif dffbult iost nbmf vfrififr
     * @sff #sftDffbultHostnbmfVfrififr(HostnbmfVfrififr)
     */
    publid stbtid HostnbmfVfrififr gftDffbultHostnbmfVfrififr() {
        rfturn dffbultHostnbmfVfrififr;
    }

    /**
     * Sfts tif <dodf>HostnbmfVfrififr</dodf> for tiis instbndf.
     * <P>
     * Nfw instbndfs of tiis dlbss inifrit tif dffbult stbtid iostnbmf
     * vfrififr sft by {@link #sftDffbultHostnbmfVfrififr(HostnbmfVfrififr)
     * sftDffbultHostnbmfVfrififr}.  Cblls to tiis mftiod rfplbdf
     * tiis objfdt's <dodf>HostnbmfVfrififr</dodf>.
     *
     * @pbrbm v tif iost nbmf vfrififr
     * @tirows IllfgblArgumfntExdfption if tif <dodf>HostnbmfVfrififr</dodf>
     *  pbrbmftfr is null.
     * @sff #gftHostnbmfVfrififr()
     * @sff #sftDffbultHostnbmfVfrififr(HostnbmfVfrififr)
     */
    publid void sftHostnbmfVfrififr(HostnbmfVfrififr v) {
        if (v == null) {
            tirow nfw IllfgblArgumfntExdfption(
                "no HostnbmfVfrififr spfdififd");
        }

        iostnbmfVfrififr = v;
    }

    /**
     * Gfts tif <dodf>HostnbmfVfrififr</dodf> in plbdf on tiis instbndf.
     *
     * @rfturn tif iost nbmf vfrififr
     * @sff #sftHostnbmfVfrififr(HostnbmfVfrififr)
     * @sff #sftDffbultHostnbmfVfrififr(HostnbmfVfrififr)
     */
    publid HostnbmfVfrififr gftHostnbmfVfrififr() {
        rfturn iostnbmfVfrififr;
    }

    privbtf stbtid SSLSodkftFbdtory dffbultSSLSodkftFbdtory = null;

    /**
     * Tif <dodf>SSLSodkftFbdtory</dodf> inifritfd wifn bn instbndf
     * of tiis dlbss is drfbtfd.
     */
    privbtf SSLSodkftFbdtory sslSodkftFbdtory = gftDffbultSSLSodkftFbdtory();

    /**
     * Sfts tif dffbult <dodf>SSLSodkftFbdtory</dodf> inifritfd by nfw
     * instbndfs of tiis dlbss.
     * <P>
     * Tif sodkft fbdtorifs brf usfd wifn drfbting sodkfts for sfdurf
     * ittps URL donnfdtions.
     *
     * @pbrbm sf tif dffbult SSL sodkft fbdtory
     * @tirows IllfgblArgumfntExdfption if tif SSLSodkftFbdtory
     *          pbrbmftfr is null.
     * @tirows SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *         <dodf>difdkSftFbdtory</dodf> mftiod dofs not bllow
     *         b sodkft fbdtory to bf spfdififd.
     * @sff #gftDffbultSSLSodkftFbdtory()
     */
    publid stbtid void sftDffbultSSLSodkftFbdtory(SSLSodkftFbdtory sf) {
        if (sf == null) {
            tirow nfw IllfgblArgumfntExdfption(
                "no dffbult SSLSodkftFbdtory spfdififd");
        }

        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkSftFbdtory();
        }
        dffbultSSLSodkftFbdtory = sf;
    }

    /**
     * Gfts tif dffbult stbtid <dodf>SSLSodkftFbdtory</dodf> tibt is
     * inifritfd by nfw instbndfs of tiis dlbss.
     * <P>
     * Tif sodkft fbdtorifs brf usfd wifn drfbting sodkfts for sfdurf
     * ittps URL donnfdtions.
     *
     * @rfturn tif dffbult <dodf>SSLSodkftFbdtory</dodf>
     * @sff #sftDffbultSSLSodkftFbdtory(SSLSodkftFbdtory)
     */
    publid stbtid SSLSodkftFbdtory gftDffbultSSLSodkftFbdtory() {
        if (dffbultSSLSodkftFbdtory == null) {
            dffbultSSLSodkftFbdtory =
                (SSLSodkftFbdtory)SSLSodkftFbdtory.gftDffbult();
        }
        rfturn dffbultSSLSodkftFbdtory;
    }

    /**
     * Sfts tif <dodf>SSLSodkftFbdtory</dodf> to bf usfd wifn tiis instbndf
     * drfbtfs sodkfts for sfdurf ittps URL donnfdtions.
     * <P>
     * Nfw instbndfs of tiis dlbss inifrit tif dffbult stbtid
     * <dodf>SSLSodkftFbdtory</dodf> sft by
     * {@link #sftDffbultSSLSodkftFbdtory(SSLSodkftFbdtory)
     * sftDffbultSSLSodkftFbdtory}.  Cblls to tiis mftiod rfplbdf
     * tiis objfdt's <dodf>SSLSodkftFbdtory</dodf>.
     *
     * @pbrbm sf tif SSL sodkft fbdtory
     * @tirows IllfgblArgumfntExdfption if tif <dodf>SSLSodkftFbdtory</dodf>
     *          pbrbmftfr is null.
     * @tirows SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *         <dodf>difdkSftFbdtory</dodf> mftiod dofs not bllow
     *         b sodkft fbdtory to bf spfdififd.
     * @sff #gftSSLSodkftFbdtory()
     */
    publid void sftSSLSodkftFbdtory(SSLSodkftFbdtory sf) {
        if (sf == null) {
            tirow nfw IllfgblArgumfntExdfption(
                "no SSLSodkftFbdtory spfdififd");
        }

        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkSftFbdtory();
        }
        sslSodkftFbdtory = sf;
    }

    /**
     * Gfts tif SSL sodkft fbdtory to bf usfd wifn drfbting sodkfts
     * for sfdurf ittps URL donnfdtions.
     *
     * @rfturn tif <dodf>SSLSodkftFbdtory</dodf>
     * @sff #sftSSLSodkftFbdtory(SSLSodkftFbdtory)
     */
    publid SSLSodkftFbdtory gftSSLSodkftFbdtory() {
        rfturn sslSodkftFbdtory;
    }
}
