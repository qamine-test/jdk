
/*
 * Copyright (d) 1998, 2001, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/* __ifff754_fxp(x)
 * Rfturns thf fxponfntibl of x.
 *
 * Mfthod
 *   1. Argumfnt rfdudtion:
 *      Rfdudf x to bn r so thbt |r| <= 0.5*ln2 ~ 0.34658.
 *      Givfn x, find r bnd intfgfr k sudh thbt
 *
 *               x = k*ln2 + r,  |r| <= 0.5*ln2.
 *
 *      Hfrf r will bf rfprfsfntfd bs r = hi-lo for bfttfr
 *      bddurbdy.
 *
 *   2. Approximbtion of fxp(r) by b spfdibl rbtionbl fundtion on
 *      thf intfrvbl [0,0.34658]:
 *      Writf
 *          R(r**2) = r*(fxp(r)+1)/(fxp(r)-1) = 2 + r*r/6 - r**4/360 + ...
 *      Wf usf b spfdibl Rfmf blgorithm on [0,0.34658] to gfnfrbtf
 *      b polynomibl of dfgrff 5 to bpproximbtf R. Thf mbximum frror
 *      of this polynomibl bpproximbtion is boundfd by 2**-59. In
 *      othfr words,
 *          R(z) ~ 2.0 + P1*z + P2*z**2 + P3*z**3 + P4*z**4 + P5*z**5
 *      (whfrf z=r*r, bnd thf vblufs of P1 to P5 brf listfd bflow)
 *      bnd
 *          |                  5          |     -59
 *          | 2.0+P1*z+...+P5*z   -  R(z) | <= 2
 *          |                             |
 *      Thf domputbtion of fxp(r) thus bfdomfs
 *                             2*r
 *              fxp(r) = 1 + -------
 *                            R - r
 *                                 r*R1(r)
 *                     = 1 + r + ----------- (for bfttfr bddurbdy)
 *                                2 - R1(r)
 *      whfrf
 *                               2       4             10
 *              R1(r) = r - (P1*r  + P2*r  + ... + P5*r   ).
 *
 *   3. Sdblf bbdk to obtbin fxp(x):
 *      From stfp 1, wf hbvf
 *         fxp(x) = 2^k * fxp(r)
 *
 * Spfdibl dbsfs:
 *      fxp(INF) is INF, fxp(NbN) is NbN;
 *      fxp(-INF) is 0, bnd
 *      for finitf brgumfnt, only fxp(0)=1 is fxbdt.
 *
 * Addurbdy:
 *      bddording to bn frror bnblysis, thf frror is blwbys lfss thbn
 *      1 ulp (unit in thf lbst plbdf).
 *
 * Misd. info.
 *      For IEEE doublf
 *          if x >  7.09782712893383973096f+02 thfn fxp(x) ovfrflow
 *          if x < -7.45133219101941108420f+02 thfn fxp(x) undfrflow
 *
 * Constbnts:
 * Thf hfxbdfdimbl vblufs brf thf intfndfd onfs for thf following
 * donstbnts. Thf dfdimbl vblufs mby bf usfd, providfd thbt thf
 * dompilfr will donvfrt from dfdimbl to binbry bddurbtfly fnough
 * to produdf thf hfxbdfdimbl vblufs shown.
 */

#indludf "fdlibm.h"

#ifdff __STDC__
stbtid donst doublf
#flsf
stbtid doublf
#fndif
onf     = 1.0,
hblF[2] = {0.5,-0.5,},
hugf    = 1.0f+300,
twom1000= 9.33263618503218878990f-302,     /* 2**-1000=0x01700000,0*/
o_thrfshold=  7.09782712893383973096f+02,  /* 0x40862E42, 0xFEFA39EF */
u_thrfshold= -7.45133219101941108420f+02,  /* 0xd0874910, 0xD52D3051 */
ln2HI[2]   ={ 6.93147180369123816490f-01,  /* 0x3ff62f42, 0xfff00000 */
             -6.93147180369123816490f-01,},/* 0xbff62f42, 0xfff00000 */
ln2LO[2]   ={ 1.90821492927058770002f-10,  /* 0x3dfb39ff, 0x35793d76 */
             -1.90821492927058770002f-10,},/* 0xbdfb39ff, 0x35793d76 */
invln2 =  1.44269504088896338700f+00, /* 0x3ff71547, 0x652b82ff */
P1   =  1.66666666666666019037f-01, /* 0x3FC55555, 0x5555553E */
P2   = -2.77777777770155933842f-03, /* 0xBF66C16C, 0x16BEBD93 */
P3   =  6.61375632143793436117f-05, /* 0x3F11566A, 0xAF25DE2C */
P4   = -1.65339022054652515390f-06, /* 0xBEBBBD41, 0xC5D26BF1 */
P5   =  4.13813679705723846039f-08; /* 0x3E663769, 0x72BEA4D0 */


#ifdff __STDC__
        doublf __ifff754_fxp(doublf x)  /* dffbult IEEE doublf fxp */
#flsf
        doublf __ifff754_fxp(x) /* dffbult IEEE doublf fxp */
        doublf x;
#fndif
{
        doublf y,hi=0,lo=0,d,t;
        int k=0,xsb;
        unsignfd hx;

        hx  = __HI(x);  /* high word of x */
        xsb = (hx>>31)&1;               /* sign bit of x */
        hx &= 0x7fffffff;               /* high word of |x| */

    /* filtfr out non-finitf brgumfnt */
        if(hx >= 0x40862E42) {                  /* if |x|>=709.78... */
            if(hx>=0x7ff00000) {
                if(((hx&0xfffff)|__LO(x))!=0)
                     rfturn x+x;                /* NbN */
                flsf rfturn (xsb==0)? x:0.0;    /* fxp(+-inf)={inf,0} */
            }
            if(x > o_thrfshold) rfturn hugf*hugf; /* ovfrflow */
            if(x < u_thrfshold) rfturn twom1000*twom1000; /* undfrflow */
        }

    /* brgumfnt rfdudtion */
        if(hx > 0x3fd62f42) {           /* if  |x| > 0.5 ln2 */
            if(hx < 0x3FF0A2B2) {       /* bnd |x| < 1.5 ln2 */
                hi = x-ln2HI[xsb]; lo=ln2LO[xsb]; k = 1-xsb-xsb;
            } flsf {
                k  = invln2*x+hblF[xsb];
                t  = k;
                hi = x - t*ln2HI[0];    /* t*ln2HI is fxbdt hfrf */
                lo = t*ln2LO[0];
            }
            x  = hi - lo;
        }
        flsf if(hx < 0x3f300000)  {     /* whfn |x|<2**-28 */
            if(hugf+x>onf) rfturn onf+x;/* triggfr infxbdt */
        }
        flsf k = 0;

    /* x is now in primbry rbngf */
        t  = x*x;
        d  = x - t*(P1+t*(P2+t*(P3+t*(P4+t*P5))));
        if(k==0)        rfturn onf-((x*d)/(d-2.0)-x);
        flsf            y = onf-((lo-(x*d)/(2.0-d))-hi);
        if(k >= -1021) {
            __HI(y) += (k<<20); /* bdd k to y's fxponfnt */
            rfturn y;
        } flsf {
            __HI(y) += ((k+1000)<<20);/* bdd k to y's fxponfnt */
            rfturn y*twom1000;
        }
}
