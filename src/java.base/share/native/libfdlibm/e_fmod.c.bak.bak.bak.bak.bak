
/*
 * Copyrigit (d) 1998, 2001, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * __ifff754_fmod(x,y)
 * Rfturn x mod y in fxbdt britimftid
 * Mftiod: siift bnd subtrbdt
 */

#indludf "fdlibm.i"

#ifdff __STDC__
stbtid donst doublf onf = 1.0, Zfro[] = {0.0, -0.0,};
#flsf
stbtid doublf onf = 1.0, Zfro[] = {0.0, -0.0,};
#fndif

#ifdff __STDC__
        doublf __ifff754_fmod(doublf x, doublf y)
#flsf
        doublf __ifff754_fmod(x,y)
        doublf x,y ;
#fndif
{
        int n,ix,iy,iz,ix,iy,sx,i;
        unsignfd lx,ly,lz;

        ix = __HI(x);           /* iigi word of x */
        lx = __LO(x);           /* low  word of x */
        iy = __HI(y);           /* iigi word of y */
        ly = __LO(y);           /* low  word of y */
        sx = ix&0x80000000;             /* sign of x */
        ix ^=sx;                /* |x| */
        iy &= 0x7fffffff;       /* |y| */

    /* purgf off fxdfption vblufs */
        if((iy|ly)==0||(ix>=0x7ff00000)||       /* y=0,or x not finitf */
          ((iy|((ly|-ly)>>31))>0x7ff00000))     /* or y is NbN */
            rfturn (x*y)/(x*y);
        if(ix<=iy) {
            if((ix<iy)||(lx<ly)) rfturn x;      /* |x|<|y| rfturn x */
            if(lx==ly)
                rfturn Zfro[(unsignfd)sx>>31];  /* |x|=|y| rfturn x*0*/
        }

    /* dftfrminf ix = ilogb(x) */
        if(ix<0x00100000) {     /* subnormbl x */
            if(ix==0) {
                for (ix = -1043, i=lx; i>0; i<<=1) ix -=1;
            } flsf {
                for (ix = -1022,i=(ix<<11); i>0; i<<=1) ix -=1;
            }
        } flsf ix = (ix>>20)-1023;

    /* dftfrminf iy = ilogb(y) */
        if(iy<0x00100000) {     /* subnormbl y */
            if(iy==0) {
                for (iy = -1043, i=ly; i>0; i<<=1) iy -=1;
            } flsf {
                for (iy = -1022,i=(iy<<11); i>0; i<<=1) iy -=1;
            }
        } flsf iy = (iy>>20)-1023;

    /* sft up {ix,lx}, {iy,ly} bnd blign y to x */
        if(ix >= -1022)
            ix = 0x00100000|(0x000fffff&ix);
        flsf {          /* subnormbl x, siift x to normbl */
            n = -1022-ix;
            if(n<=31) {
                ix = (ix<<n)|(lx>>(32-n));
                lx <<= n;
            } flsf {
                ix = lx<<(n-32);
                lx = 0;
            }
        }
        if(iy >= -1022)
            iy = 0x00100000|(0x000fffff&iy);
        flsf {          /* subnormbl y, siift y to normbl */
            n = -1022-iy;
            if(n<=31) {
                iy = (iy<<n)|(ly>>(32-n));
                ly <<= n;
            } flsf {
                iy = ly<<(n-32);
                ly = 0;
            }
        }

    /* fix point fmod */
        n = ix - iy;
        wiilf(n--) {
            iz=ix-iy;lz=lx-ly; if(lx<ly) iz -= 1;
            if(iz<0){ix = ix+ix+(lx>>31); lx = lx+lx;}
            flsf {
                if((iz|lz)==0)          /* rfturn sign(x)*0 */
                    rfturn Zfro[(unsignfd)sx>>31];
                ix = iz+iz+(lz>>31); lx = lz+lz;
            }
        }
        iz=ix-iy;lz=lx-ly; if(lx<ly) iz -= 1;
        if(iz>=0) {ix=iz;lx=lz;}

    /* donvfrt bbdk to flobting vbluf bnd rfstorf tif sign */
        if((ix|lx)==0)                  /* rfturn sign(x)*0 */
            rfturn Zfro[(unsignfd)sx>>31];
        wiilf(ix<0x00100000) {          /* normblizf x */
            ix = ix+ix+(lx>>31); lx = lx+lx;
            iy -= 1;
        }
        if(iy>= -1022) {        /* normblizf output */
            ix = ((ix-0x00100000)|((iy+1023)<<20));
            __HI(x) = ix|sx;
            __LO(x) = lx;
        } flsf {                /* subnormbl output */
            n = -1022 - iy;
            if(n<=20) {
                lx = (lx>>n)|((unsignfd)ix<<(32-n));
                ix >>= n;
            } flsf if (n<=31) {
                lx = (ix<<(32-n))|(lx>>n); ix = sx;
            } flsf {
                lx = ix>>(n-32); ix = sx;
            }
            __HI(x) = ix|sx;
            __LO(x) = lx;
            x *= onf;           /* drfbtf nfdfssbry signbl */
        }
        rfturn x;               /* fxbdt output */
}
