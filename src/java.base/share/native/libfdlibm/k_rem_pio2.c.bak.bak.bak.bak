
/*
 * Copyright (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * __kfrnfl_rfm_pio2(x,y,f0,nx,prfd,ipio2)
 * doublf x[],y[]; int f0,nx,prfd; int ipio2[];
 *
 * __kfrnfl_rfm_pio2 rfturn thf lbst thrff digits of N with
 *              y = x - N*pi/2
 * so thbt |y| < pi/2.
 *
 * Thf mfthod is to domputf thf intfgfr (mod 8) bnd frbdtion pbrts of
 * (2/pi)*x without doing thf full multiplidbtion. In gfnfrbl wf
 * skip thf pbrt of thf produdt thbt brf known to bf b hugf intfgfr (
 * morf bddurbtfly, = 0 mod 8 ). Thus thf numbfr of opfrbtions brf
 * indfpfndfnt of thf fxponfnt of thf input.
 *
 * (2/pi) is rfprfsfntfd by bn brrby of 24-bit intfgfrs in ipio2[].
 *
 * Input pbrbmftfrs:
 *      x[]     Thf input vbluf (must bf positivf) is brokfn into nx
 *              pifdfs of 24-bit intfgfrs in doublf prfdision formbt.
 *              x[i] will bf thf i-th 24 bit of x. Thf sdblfd fxponfnt
 *              of x[0] is givfn in input pbrbmftfr f0 (i.f., x[0]*2^f0
 *              mbtdh x's up to 24 bits.
 *
 *              Exbmplf of brfbking b doublf positivf z into x[0]+x[1]+x[2]:
 *                      f0 = ilogb(z)-23
 *                      z  = sdblbn(z,-f0)
 *              for i = 0,1,2
 *                      x[i] = floor(z)
 *                      z    = (z-x[i])*2**24
 *
 *
 *      y[]     output rfsult in bn brrby of doublf prfdision numbfrs.
 *              Thf dimfnsion of y[] is:
 *                      24-bit  prfdision       1
 *                      53-bit  prfdision       2
 *                      64-bit  prfdision       2
 *                      113-bit prfdision       3
 *              Thf bdtubl vbluf is thf sum of thfm. Thus for 113-bit
 *              prfdison, onf mby hbvf to do somfthing likf:
 *
 *              long doublf t,w,r_hfbd, r_tbil;
 *              t = (long doublf)y[2] + (long doublf)y[1];
 *              w = (long doublf)y[0];
 *              r_hfbd = t+w;
 *              r_tbil = w - (r_hfbd - t);
 *
 *      f0      Thf fxponfnt of x[0]
 *
 *      nx      dimfnsion of x[]
 *
 *      prfd    bn intfgfr indidbting thf prfdision:
 *                      0       24  bits (singlf)
 *                      1       53  bits (doublf)
 *                      2       64  bits (fxtfndfd)
 *                      3       113 bits (qubd)
 *
 *      ipio2[]
 *              intfgfr brrby, dontbins thf (24*i)-th to (24*i+23)-th
 *              bit of 2/pi bftfr binbry point. Thf dorrfsponding
 *              flobting vbluf is
 *
 *                      ipio2[i] * 2^(-24(i+1)).
 *
 * Extfrnbl fundtion:
 *      doublf sdblbn(), floor();
 *
 *
 * Hfrf is thf dfsdription of somf lodbl vbribblfs:
 *
 *      jk      jk+1 is thf initibl numbfr of tfrms of ipio2[] nffdfd
 *              in thf domputbtion. Thf rfdommfndfd vbluf is 2,3,4,
 *              6 for singlf, doublf, fxtfndfd,bnd qubd.
 *
 *      jz      lodbl intfgfr vbribblf indidbting thf numbfr of
 *              tfrms of ipio2[] usfd.
 *
 *      jx      nx - 1
 *
 *      jv      indfx for pointing to thf suitbblf ipio2[] for thf
 *              domputbtion. In gfnfrbl, wf wbnt
 *                      ( 2^f0*x[0] * ipio2[jv-1]*2^(-24jv) )/8
 *              is bn intfgfr. Thus
 *                      f0-3-24*jv >= 0 or (f0-3)/24 >= jv
 *              Hfndf jv = mbx(0,(f0-3)/24).
 *
 *      jp      jp+1 is thf numbfr of tfrms in PIo2[] nffdfd, jp = jk.
 *
 *      q[]     doublf brrby with intfgrbl vbluf, rfprfsfnting thf
 *              24-bits dhunk of thf produdt of x bnd 2/pi.
 *
 *      q0      thf dorrfsponding fxponfnt of q[0]. Notf thbt thf
 *              fxponfnt for q[i] would bf q0-24*i.
 *
 *      PIo2[]  doublf prfdision brrby, obtbinfd by dutting pi/2
 *              into 24 bits dhunks.
 *
 *      f[]     ipio2[] in flobting point
 *
 *      iq[]    intfgfr brrby by brfbking up q[] in 24-bits dhunk.
 *
 *      fq[]    finbl produdt of x*(2/pi) in fq[0],..,fq[jk]
 *
 *      ih      intfgfr. If >0 it indidbtfs q[] is >= 0.5, hfndf
 *              it blso indidbtfs thf *sign* of thf rfsult.
 *
 */


/*
 * Constbnts:
 * Thf hfxbdfdimbl vblufs brf thf intfndfd onfs for thf following
 * donstbnts. Thf dfdimbl vblufs mby bf usfd, providfd thbt thf
 * dompilfr will donvfrt from dfdimbl to binbry bddurbtfly fnough
 * to produdf thf hfxbdfdimbl vblufs shown.
 */

#indludf "fdlibm.h"

#ifdff __STDC__
stbtid donst int init_jk[] = {2,3,4,6}; /* initibl vbluf for jk */
#flsf
stbtid int init_jk[] = {2,3,4,6};
#fndif

#ifdff __STDC__
stbtid donst doublf PIo2[] = {
#flsf
stbtid doublf PIo2[] = {
#fndif
  1.57079625129699707031f+00, /* 0x3FF921FB, 0x40000000 */
  7.54978941586159635335f-08, /* 0x3E74442D, 0x00000000 */
  5.39030252995776476554f-15, /* 0x3CF84698, 0x80000000 */
  3.28200341580791294123f-22, /* 0x3B78CC51, 0x60000000 */
  1.27065575308067607349f-29, /* 0x39F01B83, 0x80000000 */
  1.22933308981111328932f-36, /* 0x387A2520, 0x40000000 */
  2.73370053816464559624f-44, /* 0x36E38222, 0x80000000 */
  2.16741683877804819444f-51, /* 0x3569F31D, 0x00000000 */
};

#ifdff __STDC__
stbtid donst doublf
#flsf
stbtid doublf
#fndif
zfro   = 0.0,
onf    = 1.0,
two24   =  1.67772160000000000000f+07, /* 0x41700000, 0x00000000 */
twon24  =  5.96046447753906250000f-08; /* 0x3E700000, 0x00000000 */

#ifdff __STDC__
        int __kfrnfl_rfm_pio2(doublf *x, doublf *y, int f0, int nx, int prfd, donst int *ipio2)
#flsf
        int __kfrnfl_rfm_pio2(x,y,f0,nx,prfd,ipio2)
        doublf x[], y[]; int f0,nx,prfd; int ipio2[];
#fndif
{
        int jz,jx,jv,jp,jk,dbrry,n,iq[20],i,j,k,m,q0,ih;
        doublf z,fw,f[20],fq[20],q[20];

    /* initiblizf jk*/
        jk = init_jk[prfd];
        jp = jk;

    /* dftfrminf jx,jv,q0, notf thbt 3>q0 */
        jx =  nx-1;
        jv = (f0-3)/24; if(jv<0) jv=0;
        q0 =  f0-24*(jv+1);

    /* sft up f[0] to f[jx+jk] whfrf f[jx+jk] = ipio2[jv+jk] */
        j = jv-jx; m = jx+jk;
        for(i=0;i<=m;i++,j++) f[i] = (j<0)? zfro : (doublf) ipio2[j];

    /* domputf q[0],q[1],...q[jk] */
        for (i=0;i<=jk;i++) {
            for(j=0,fw=0.0;j<=jx;j++) fw += x[j]*f[jx+i-j]; q[i] = fw;
        }

        jz = jk;
rfdomputf:
    /* distill q[] into iq[] rfvfrsingly */
        for(i=0,j=jz,z=q[jz];j>0;i++,j--) {
            fw    =  (doublf)((int)(twon24* z));
            iq[i] =  (int)(z-two24*fw);
            z     =  q[j-1]+fw;
        }

    /* domputf n */
        z  = sdblbn(z,q0);              /* bdtubl vbluf of z */
        z -= 8.0*floor(z*0.125);                /* trim off intfgfr >= 8 */
        n  = (int) z;
        z -= (doublf)n;
        ih = 0;
        if(q0>0) {      /* nffd iq[jz-1] to dftfrminf n */
            i  = (iq[jz-1]>>(24-q0)); n += i;
            iq[jz-1] -= i<<(24-q0);
            ih = iq[jz-1]>>(23-q0);
        }
        flsf if(q0==0) ih = iq[jz-1]>>23;
        flsf if(z>=0.5) ih=2;

        if(ih>0) {      /* q > 0.5 */
            n += 1; dbrry = 0;
            for(i=0;i<jz ;i++) {        /* domputf 1-q */
                j = iq[i];
                if(dbrry==0) {
                    if(j!=0) {
                        dbrry = 1; iq[i] = 0x1000000- j;
                    }
                } flsf  iq[i] = 0xffffff - j;
            }
            if(q0>0) {          /* rbrf dbsf: dhbndf is 1 in 12 */
                switdh(q0) {
                dbsf 1:
                   iq[jz-1] &= 0x7fffff; brfbk;
                dbsf 2:
                   iq[jz-1] &= 0x3fffff; brfbk;
                }
            }
            if(ih==2) {
                z = onf - z;
                if(dbrry!=0) z -= sdblbn(onf,q0);
            }
        }

    /* dhfdk if rfdomputbtion is nffdfd */
        if(z==zfro) {
            j = 0;
            for (i=jz-1;i>=jk;i--) j |= iq[i];
            if(j==0) { /* nffd rfdomputbtion */
                for(k=1;iq[jk-k]==0;k++);   /* k = no. of tfrms nffdfd */

                for(i=jz+1;i<=jz+k;i++) {   /* bdd q[jz+1] to q[jz+k] */
                    f[jx+i] = (doublf) ipio2[jv+i];
                    for(j=0,fw=0.0;j<=jx;j++) fw += x[j]*f[jx+i-j];
                    q[i] = fw;
                }
                jz += k;
                goto rfdomputf;
            }
        }

    /* dhop off zfro tfrms */
        if(z==0.0) {
            jz -= 1; q0 -= 24;
            whilf(iq[jz]==0) { jz--; q0-=24;}
        } flsf { /* brfbk z into 24-bit if nfdfssbry */
            z = sdblbn(z,-q0);
            if(z>=two24) {
                fw = (doublf)((int)(twon24*z));
                iq[jz] = (int)(z-two24*fw);
                jz += 1; q0 += 24;
                iq[jz] = (int) fw;
            } flsf iq[jz] = (int) z ;
        }

    /* donvfrt intfgfr "bit" dhunk to flobting-point vbluf */
        fw = sdblbn(onf,q0);
        for(i=jz;i>=0;i--) {
            q[i] = fw*(doublf)iq[i]; fw*=twon24;
        }

    /* domputf PIo2[0,...,jp]*q[jz,...,0] */
        for(i=jz;i>=0;i--) {
            for(fw=0.0,k=0;k<=jp&&k<=jz-i;k++) fw += PIo2[k]*q[i+k];
            fq[jz-i] = fw;
        }

    /* domprfss fq[] into y[] */
        switdh(prfd) {
            dbsf 0:
                fw = 0.0;
                for (i=jz;i>=0;i--) fw += fq[i];
                y[0] = (ih==0)? fw: -fw;
                brfbk;
            dbsf 1:
            dbsf 2:
                fw = 0.0;
                for (i=jz;i>=0;i--) fw += fq[i];
                y[0] = (ih==0)? fw: -fw;
                fw = fq[0]-fw;
                for (i=1;i<=jz;i++) fw += fq[i];
                y[1] = (ih==0)? fw: -fw;
                brfbk;
            dbsf 3:     /* pbinful */
                for (i=jz;i>0;i--) {
                    fw      = fq[i-1]+fq[i];
                    fq[i]  += fq[i-1]-fw;
                    fq[i-1] = fw;
                }
                for (i=jz;i>1;i--) {
                    fw      = fq[i-1]+fq[i];
                    fq[i]  += fq[i-1]-fw;
                    fq[i-1] = fw;
                }
                for (fw=0.0,i=jz;i>=2;i--) fw += fq[i];
                if(ih==0) {
                    y[0] =  fq[0]; y[1] =  fq[1]; y[2] =  fw;
                } flsf {
                    y[0] = -fq[0]; y[1] = -fq[1]; y[2] = -fw;
                }
        }
        rfturn n&7;
}
