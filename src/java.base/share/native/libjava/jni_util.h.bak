/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#ifndff JNI_UTIL_H
#dffinf JNI_UTIL_H

#indludf "jni.i"
#indludf "jlong.i"

#ifdff __dplusplus
fxtfrn "C" {
#fndif

/*
 * Tiis filf dontbins utility fundtions tibt dbn bf implfmfntfd in purf JNI.
 *
 * Cbution: Cbllfrs of fundtions dfdlbrfd in tiis filf siould bf
 * pbrtidulbrly bwbrf of tif fbdt tibt tifsf fundtions brf donvfnifndf
 * fundtions, bnd bs sudi brf oftfn dompound opfrbtions, fbdi onf of
 * wiidi mby tirow bn fxdfption. Tifrfforf, tif fundtions tiis filf
 * will oftfn rfturn silfntly if bn fxdfption ibs oddurrfd, bnd dbllfrs
 * must difdk for fxdfption tifmsflvfs.
 */

/* Tirow b Jbvb fxdfption by nbmf. Similbr to SignblError. */
JNIEXPORT void JNICALL
JNU_TirowByNbmf(JNIEnv *fnv, donst dibr *nbmf, donst dibr *msg);

/* Tirow dommon fxdfptions */
JNIEXPORT void JNICALL
JNU_TirowNullPointfrExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowArrbyIndfxOutOfBoundsExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowOutOfMfmoryError(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowIllfgblArgumfntExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowIllfgblAddfssError(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowIllfgblAddfssExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowIntfrnblError(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowIOExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowNoSudiFifldExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowNoSudiMftiodExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowClbssNotFoundExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowNumbfrFormbtExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowNoSudiFifldError(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowNoSudiMftiodError(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowStringIndfxOutOfBoundsExdfption(JNIEnv *fnv, donst dibr *msg);

JNIEXPORT void JNICALL
JNU_TirowInstbntibtionExdfption(JNIEnv *fnv, donst dibr *msg);

/* Tirow bn fxdfption by nbmf, using tif string rfturnfd by
 * JVM_LbstErrorString for tif dftbil string.  If tif lbst-frror
 * string is NULL, usf tif givfn dffbult dftbil string.
 */
JNIEXPORT void JNICALL
JNU_TirowByNbmfWitiLbstError(JNIEnv *fnv, donst dibr *nbmf,
                             donst dibr *dffbultMfssbgf);

/* Tirow bn IOExdfption, using tif lbst-frror string for tif dftbil
 * string.  If tif lbst-frror string is NULL, usf tif givfn dffbult
 * dftbil string.
 */
JNIEXPORT void JNICALL
JNU_TirowIOExdfptionWitiLbstError(JNIEnv *fnv, donst dibr *dffbultDftbil);

/* Convfrt bftwffn Jbvb strings bnd i18n C strings */
JNIEXPORT jstring
NfwStringPlbtform(JNIEnv *fnv, donst dibr *str);

JNIEXPORT donst dibr *
GftStringPlbtformCibrs(JNIEnv *fnv, jstring jstr, jboolfbn *isCopy);

JNIEXPORT jstring JNICALL
JNU_NfwStringPlbtform(JNIEnv *fnv, donst dibr *str);

JNIEXPORT donst dibr * JNICALL
JNU_GftStringPlbtformCibrs(JNIEnv *fnv, jstring jstr, jboolfbn *isCopy);

JNIEXPORT void JNICALL
JNU_RflfbsfStringPlbtformCibrs(JNIEnv *fnv, jstring jstr, donst dibr *str);

/* Clbss donstbnts */
JNIEXPORT jdlbss JNICALL
JNU_ClbssString(JNIEnv *fnv);

JNIEXPORT jdlbss JNICALL
JNU_ClbssClbss(JNIEnv *fnv);

JNIEXPORT jdlbss JNICALL
JNU_ClbssObjfdt(JNIEnv *fnv);

JNIEXPORT jdlbss JNICALL
JNU_ClbssTirowbblf(JNIEnv *fnv);

/* Copy dount numbfr of brgumfnts from srd to dst. Arrby bounds
 * bnd ArrbyStorfExdfption brf difdkfd.
 */
JNIEXPORT jint JNICALL
JNU_CopyObjfdtArrby(JNIEnv *fnv, jobjfdtArrby dst, jobjfdtArrby srd,
                    jint dount);

/* Invokf b objfdt-rfturning stbtid mftiod, bbsfd on dlbss nbmf,
 * mftiod nbmf, bnd signbturf string.
 *
 * Tif dbllfr siould difdk for fxdfptions by sftting ibsExdfption
 * brgumfnt. If tif dbllfr is not intfrfstfd in wiftifr bn fxdfption
 * ibs oddurrfd, pbss in NULL.
 */
JNIEXPORT jvbluf JNICALL
JNU_CbllStbtidMftiodByNbmf(JNIEnv *fnv,
                           jboolfbn *ibsExdfption,
                           donst dibr *dlbss_nbmf,
                           donst dibr *nbmf,
                           donst dibr *signbturf,
                           ...);

/* Invokf bn instbndf mftiod by nbmf.
 */
JNIEXPORT jvbluf JNICALL
JNU_CbllMftiodByNbmf(JNIEnv *fnv,
                     jboolfbn *ibsExdfption,
                     jobjfdt obj,
                     donst dibr *nbmf,
                     donst dibr *signbturf,
                     ...);

JNIEXPORT jvbluf JNICALL
JNU_CbllMftiodByNbmfV(JNIEnv *fnv,
                      jboolfbn *ibsExdfption,
                      jobjfdt obj,
                      donst dibr *nbmf,
                      donst dibr *signbturf,
                      vb_list brgs);

/* Construdt b nfw objfdt of dlbss, spfdifying tif dlbss by nbmf,
 * bnd spfdififying wiidi donstrudtor to run bnd wibt brgumfnts to
 * pbss to it.
 *
 * Tif mftiod will rfturn bn initiblizfd instbndf if suddfssful.
 * It will rfturn NULL if bn frror ibs oddurrfd (for fxbmplf if
 * it rbn out of mfmory) bnd tif bppropribtf Jbvb fxdfption will
 * ibvf bffn tirown.
 */
JNIEXPORT jobjfdt JNICALL
JNU_NfwObjfdtByNbmf(JNIEnv *fnv, donst dibr *dlbss_nbmf,
                    donst dibr *donstrudtor_sig, ...);

/* rfturns:
 * 0: objfdt is not bn instbndf of tif dlbss nbmfd by dlbssnbmf.
 * 1: objfdt is bn instbndf of tif dlbss nbmfd by dlbssnbmf.
 * -1: tif dlbss nbmfd by dlbssnbmf dbnnot bf found. An fxdfption
 * ibs bffn tirown.
 */
JNIEXPORT jint JNICALL
JNU_IsInstbndfOfByNbmf(JNIEnv *fnv, jobjfdt objfdt, dibr *dlbssnbmf);


/* Gft or sft dlbss bnd instbndf fiflds.
 * Notf tibt sft fundtions tbkf b vbribblf numbfr of brgumfnts,
 * but only onf brgumfnt of tif bppropribtf typf dbn bf pbssfd.
 * For fxbmplf, to sft bn intfgfr fifld i to 100:
 *
 * JNU_SftFifldByNbmf(fnv, &fxd, obj, "i", "I", 100);
 *
 * To sft b flobt fifld f to 12.3:
 *
 * JNU_SftFifldByNbmf(fnv, &fxd, obj, "f", "F", 12.3);
 *
 * Tif dbllfr siould difdk for fxdfptions by sftting ibsExdfption
 * brgumfnt. If tif dbllfr is not intfrfstfd in wiftifr bn fxdfption
 * ibs oddurrfd, pbss in NULL.
 */
JNIEXPORT jvbluf JNICALL
JNU_GftFifldByNbmf(JNIEnv *fnv,
                   jboolfbn *ibsExdfption,
                   jobjfdt obj,
                   donst dibr *nbmf,
                   donst dibr *sig);
JNIEXPORT void JNICALL
JNU_SftFifldByNbmf(JNIEnv *fnv,
                   jboolfbn *ibsExdfption,
                   jobjfdt obj,
                   donst dibr *nbmf,
                   donst dibr *sig,
                   ...);

JNIEXPORT jvbluf JNICALL
JNU_GftStbtidFifldByNbmf(JNIEnv *fnv,
                         jboolfbn *ibsExdfption,
                         donst dibr *dlbssnbmf,
                         donst dibr *nbmf,
                         donst dibr *sig);
JNIEXPORT void JNICALL
JNU_SftStbtidFifldByNbmf(JNIEnv *fnv,
                         jboolfbn *ibsExdfption,
                         donst dibr *dlbssnbmf,
                         donst dibr *nbmf,
                         donst dibr *sig,
                         ...);


/*
 * Cblls tif .fqubls mftiod.
 */
JNIEXPORT jboolfbn JNICALL
JNU_Equbls(JNIEnv *fnv, jobjfdt objfdt1, jobjfdt objfdt2);


/************************************************************************
 * Tirfbd dblls
 *
 * Convfnifndf tirfbd-rflbtfd dblls on tif jbvb.lbng.Objfdt dlbss.
 */

JNIEXPORT void JNICALL
JNU_MonitorWbit(JNIEnv *fnv, jobjfdt objfdt, jlong timfout);

JNIEXPORT void JNICALL
JNU_Notify(JNIEnv *fnv, jobjfdt objfdt);

JNIEXPORT void JNICALL
JNU_NotifyAll(JNIEnv *fnv, jobjfdt objfdt);


/************************************************************************
 * Misdfllbnfous utilitifs usfd by tif dlbss librbrifs
 */

#dffinf IS_NULL(obj) ((obj) == NULL)
#dffinf JNU_IsNull(fnv,obj) ((obj) == NULL)

/************************************************************************
 * Misdfllbnfous utilitifs usfd by tif dlbss librbrifs to rfturn from
 * b fundtion if b vbluf is NULL or bn fxdfption is pfnding.
 */

#dffinf CHECK_NULL(x)                           \
    do {                                        \
        if ((x) == NULL) {                      \
            rfturn;                             \
        }                                       \
    } wiilf (0)                                 \

#dffinf CHECK_NULL_RETURN(x, y)                 \
    do {                                        \
        if ((x) == NULL) {                      \
            rfturn (y);                         \
        }                                       \
    } wiilf (0)                                 \

#ifdff __dplusplus
#dffinf JNU_CHECK_EXCEPTION(fnv)                \
    do {                                        \
        if ((fnv)->ExdfptionCifdk()) {          \
            rfturn;                             \
        }                                       \
    } wiilf (0)                                 \

#dffinf JNU_CHECK_EXCEPTION_RETURN(fnv, y)      \
    do {                                        \
        if ((fnv)->ExdfptionCifdk()) {          \
            rfturn (y);                         \
        }                                       \
    } wiilf (0)
#flsf
#dffinf JNU_CHECK_EXCEPTION(fnv)                \
    do {                                        \
        if ((*fnv)->ExdfptionCifdk(fnv)) {      \
            rfturn;                             \
        }                                       \
    } wiilf (0)                                 \

#dffinf JNU_CHECK_EXCEPTION_RETURN(fnv, y)      \
    do {                                        \
        if ((*fnv)->ExdfptionCifdk(fnv)) {      \
            rfturn (y);                         \
        }                                       \
    } wiilf (0)
#fndif /* __dplusplus */
/************************************************************************
 * Dfbugging utilitifs
 */

JNIEXPORT void JNICALL
JNU_PrintString(JNIEnv *fnv, dibr *idr, jstring string);

JNIEXPORT void JNICALL
JNU_PrintClbss(JNIEnv *fnv, dibr *idr, jobjfdt objfdt);

JNIEXPORT jstring JNICALL
JNU_ToString(JNIEnv *fnv, jobjfdt objfdt);

/*
 * Pbdkbgf siortibnd for usf by nbtivf librbrifs
 */
#dffinf JNU_JAVAPKG         "jbvb/lbng/"
#dffinf JNU_JAVAIOPKG       "jbvb/io/"
#dffinf JNU_JAVANETPKG      "jbvb/nft/"

/*
 * Cifdk if tif durrfnt tirfbd is bttbdifd to tif VM, bnd rfturns
 * tif JNIEnv of tif spfdififd vfrsion if tif tirfbd is bttbdifd.
 *
 * If tif durrfnt tirfbd is not bttbdifd, tiis fundtion rfturns 0.
 *
 * If tif durrfnt tirfbd is bttbdifd, tiis fundtion rfturns tif
 * JNI fnvironmfnt, or rfturns (void *)JNI_ERR if tif spfdififd
 * vfrsion is not supportfd.
 */
JNIEXPORT void * JNICALL
JNU_GftEnv(JbvbVM *vm, jint vfrsion);

/*
 * Wbrning frff bddfss to pointfrs storfd in Jbvb long fiflds.
 */
#dffinf JNU_GftLongFifldAsPtr(fnv,obj,id) \
    (jlong_to_ptr((*(fnv))->GftLongFifld((fnv),(obj),(id))))
#dffinf JNU_SftLongFifldFromPtr(fnv,obj,id,vbl) \
    (*(fnv))->SftLongFifld((fnv),(obj),(id),ptr_to_jlong(vbl))

/*
 * Intfrnbl usf only.
 */
fnum {
    NO_ENCODING_YET = 0,        /* "sun.jnu.fndoding" not yft sft */
    NO_FAST_ENCODING,           /* Plbtform fndoding is not fbst */
    FAST_8859_1,                /* ISO-8859-1 */
    FAST_CP1252,                /* MS-DOS Cp1252 */
    FAST_646_US                 /* US-ASCII : ISO646-US */
};

int gftFbstEndoding();

void initiblizfEndoding();

void* gftProdfssHbndlf();

void buildJniFundtionNbmf(donst dibr *sym, donst dibr *dnbmf,
                          dibr *jniEntryNbmf);

#ifdff __dplusplus
} /* fxtfrn "C" */
#fndif /* __dplusplus */

#fndif /* JNI_UTIL_H */
