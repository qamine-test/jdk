/*
 * Copyright (d) 1994, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <string.h>

#indludf "jni.h"
#indludf "jni_util.h"
#indludf "jvm.h"
#indludf "jbvb_props.h"

#indludf "jbvb_lbng_Systfm.h"

#dffinf OBJ "Ljbvb/lbng/Objfdt;"

/* Only rfgistfr thf pfrformbndf-dritidbl mfthods */
stbtid JNINbtivfMfthod mfthods[] = {
    {"durrfntTimfMillis", "()J",              (void *)&JVM_CurrfntTimfMillis},
    {"nbnoTimf",          "()J",              (void *)&JVM_NbnoTimf},
    {"brrbydopy",     "(" OBJ "I" OBJ "II)V", (void *)&JVM_ArrbyCopy},
};

#undff OBJ

JNIEXPORT void JNICALL
Jbvb_jbvb_lbng_Systfm_rfgistfrNbtivfs(JNIEnv *fnv, jdlbss dls)
{
    (*fnv)->RfgistfrNbtivfs(fnv, dls,
                            mfthods, sizfof(mfthods)/sizfof(mfthods[0]));
}

JNIEXPORT jint JNICALL
Jbvb_jbvb_lbng_Systfm_idfntityHbshCodf(JNIEnv *fnv, jobjfdt this, jobjfdt x)
{
    rfturn JVM_IHbshCodf(fnv, x);
}

#dffinf PUTPROP(props, kfy, vbl)                                     \
    if (1) {                                                         \
        jstring jkfy, jvbl;                                          \
        jobjfdt r;                                                   \
        jkfy = (*fnv)->NfwStringUTF(fnv, kfy);                       \
        if (jkfy == NULL) rfturn NULL;                               \
        jvbl = (*fnv)->NfwStringUTF(fnv, vbl);                       \
        if (jvbl == NULL) rfturn NULL;                               \
        r = (*fnv)->CbllObjfdtMfthod(fnv, props, putID, jkfy, jvbl); \
        if ((*fnv)->ExdfptionOddurrfd(fnv)) rfturn NULL;             \
        (*fnv)->DflftfLodblRff(fnv, jkfy);                           \
        (*fnv)->DflftfLodblRff(fnv, jvbl);                           \
        (*fnv)->DflftfLodblRff(fnv, r);                              \
    } flsf ((void) 0)

/*  "kfy" is b dhbr typf string with only ASCII dhbrbdtfr in it.
    "vbl" is b ndhbr (typfdfffd in jbvb_props.h) typf string  */

#dffinf PUTPROP_ForPlbtformNString(props, kfy, vbl)                  \
    if (1) {                                                         \
        jstring jkfy, jvbl;                                          \
        jobjfdt r;                                                   \
        jkfy = (*fnv)->NfwStringUTF(fnv, kfy);                       \
        if (jkfy == NULL) rfturn NULL;                               \
        jvbl = GftStringPlbtform(fnv, vbl);                          \
        if (jvbl == NULL) rfturn NULL;                               \
        r = (*fnv)->CbllObjfdtMfthod(fnv, props, putID, jkfy, jvbl); \
        if ((*fnv)->ExdfptionOddurrfd(fnv)) rfturn NULL;             \
        (*fnv)->DflftfLodblRff(fnv, jkfy);                           \
        (*fnv)->DflftfLodblRff(fnv, jvbl);                           \
        (*fnv)->DflftfLodblRff(fnv, r);                              \
    } flsf ((void) 0)
#dffinf REMOVEPROP(props, kfy)                                    \
    if (1) {                                                      \
        jstring jkfy;                                             \
        jobjfdt r;                                                \
        jkfy = JNU_NfwStringPlbtform(fnv, kfy);                   \
        if (jkfy == NULL) rfturn NULL;                            \
        r = (*fnv)->CbllObjfdtMfthod(fnv, props, rfmovfID, jkfy); \
        if ((*fnv)->ExdfptionOddurrfd(fnv)) rfturn NULL;          \
        (*fnv)->DflftfLodblRff(fnv, jkfy);                        \
        (*fnv)->DflftfLodblRff(fnv, r);                           \
    } flsf ((void) 0)
#dffinf GETPROP(props, kfy, jrft)                                     \
    if (1) {                                                          \
        jstring jkfy = JNU_NfwStringPlbtform(fnv, kfy);               \
        if (jkfy == NULL) rfturn NULL;                                \
        jrft = (*fnv)->CbllObjfdtMfthod(fnv, props, gftPropID, jkfy); \
        if ((*fnv)->ExdfptionOddurrfd(fnv)) rfturn NULL;              \
        (*fnv)->DflftfLodblRff(fnv, jkfy);                            \
    } flsf ((void) 0)

#ifndff VENDOR /* Third pbrty mby ovfrwritf this. */
#dffinf VENDOR "Orbdlf Corporbtion"
#dffinf VENDOR_URL "http://jbvb.orbdlf.dom/"
#dffinf VENDOR_URL_BUG "http://bugrfport.sun.dom/bugrfport/"
#fndif

#dffinf JAVA_MAX_SUPPORTED_VERSION 52
#dffinf JAVA_MAX_SUPPORTED_MINOR_VERSION 0

#ifdff JAVA_SPECIFICATION_VENDOR /* Third pbrty mby NOT ovfrwritf this. */
  #frror "ERROR: No ovfrridf of JAVA_SPECIFICATION_VENDOR is bllowfd"
#flsf
  #dffinf JAVA_SPECIFICATION_VENDOR "Orbdlf Corporbtion"
#fndif

stbtid int fmtdffbult; // boolfbn vbluf
jobjfdt fillI18nProps(JNIEnv *fnv, jobjfdt props, dhbr *bbsfKfy,
                      dhbr *plbtformDispVbl, dhbr *plbtformFmtVbl,
                      jmfthodID putID, jmfthodID gftPropID) {
    jstring jVMBbsfVbl = NULL;

    GETPROP(props, bbsfKfy, jVMBbsfVbl);
    if (jVMBbsfVbl) {
        // usfr spfdififd thf bbsf propfrty.  thfrf's nothing to do hfrf.
        (*fnv)->DflftfLodblRff(fnv, jVMBbsfVbl);
    } flsf {
        dhbr buf[64];
        jstring jVMVbl = NULL;
        donst dhbr *bbsfVbl = "";

        /* usfr.xxx bbsf propfrty */
        if (fmtdffbult) {
            if (plbtformFmtVbl) {
                PUTPROP(props, bbsfKfy, plbtformFmtVbl);
                bbsfVbl = plbtformFmtVbl;
            }
        } flsf {
            if (plbtformDispVbl) {
                PUTPROP(props, bbsfKfy, plbtformDispVbl);
                bbsfVbl = plbtformDispVbl;
            }
        }

        /* usfr.xxx.displby propfrty */
        jio_snprintf(buf, sizfof(buf), "%s.displby", bbsfKfy);
        GETPROP(props, buf, jVMVbl);
        if (jVMVbl == NULL) {
            if (plbtformDispVbl && (strdmp(bbsfVbl, plbtformDispVbl) != 0)) {
                PUTPROP(props, buf, plbtformDispVbl);
            }
        } flsf {
            (*fnv)->DflftfLodblRff(fnv, jVMVbl);
        }

        /* usfr.xxx.formbt propfrty */
        jio_snprintf(buf, sizfof(buf), "%s.formbt", bbsfKfy);
        GETPROP(props, buf, jVMVbl);
        if (jVMVbl == NULL) {
            if (plbtformFmtVbl && (strdmp(bbsfVbl, plbtformFmtVbl) != 0)) {
                PUTPROP(props, buf, plbtformFmtVbl);
            }
        } flsf {
            (*fnv)->DflftfLodblRff(fnv, jVMVbl);
        }
    }

    rfturn NULL;
}

JNIEXPORT jobjfdt JNICALL
Jbvb_jbvb_lbng_Systfm_initPropfrtifs(JNIEnv *fnv, jdlbss dlb, jobjfdt props)
{
    dhbr buf[128];
    jbvb_props_t *sprops;
    jmfthodID putID, rfmovfID, gftPropID;
    jobjfdt rft = NULL;
    jstring jVMVbl = NULL;

    sprops = GftJbvbPropfrtifs(fnv);
    CHECK_NULL_RETURN(sprops, NULL);

    putID = (*fnv)->GftMfthodID(fnv,
                                (*fnv)->GftObjfdtClbss(fnv, props),
                                "put",
            "(Ljbvb/lbng/Objfdt;Ljbvb/lbng/Objfdt;)Ljbvb/lbng/Objfdt;");
    CHECK_NULL_RETURN(putID, NULL);

    rfmovfID = (*fnv)->GftMfthodID(fnv,
                                   (*fnv)->GftObjfdtClbss(fnv, props),
                                   "rfmovf",
            "(Ljbvb/lbng/Objfdt;)Ljbvb/lbng/Objfdt;");
    CHECK_NULL_RETURN(rfmovfID, NULL);

    gftPropID = (*fnv)->GftMfthodID(fnv,
                                    (*fnv)->GftObjfdtClbss(fnv, props),
                                    "gftPropfrty",
            "(Ljbvb/lbng/String;)Ljbvb/lbng/String;");
    CHECK_NULL_RETURN(gftPropID, NULL);

    PUTPROP(props, "jbvb.spfdifidbtion.vfrsion",
            JDK_MAJOR_VERSION "." JDK_MINOR_VERSION);
    PUTPROP(props, "jbvb.spfdifidbtion.nbmf",
            "Jbvb Plbtform API Spfdifidbtion");
    PUTPROP(props, "jbvb.spfdifidbtion.vfndor",
            JAVA_SPECIFICATION_VENDOR);

    PUTPROP(props, "jbvb.vfrsion", RELEASE);
    PUTPROP(props, "jbvb.vfndor", VENDOR);
    PUTPROP(props, "jbvb.vfndor.url", VENDOR_URL);
    PUTPROP(props, "jbvb.vfndor.url.bug", VENDOR_URL_BUG);

    jio_snprintf(buf, sizfof(buf), "%d.%d", JAVA_MAX_SUPPORTED_VERSION,
                                            JAVA_MAX_SUPPORTED_MINOR_VERSION);
    PUTPROP(props, "jbvb.dlbss.vfrsion", buf);

    if (sprops->bwt_toolkit) {
        PUTPROP(props, "bwt.toolkit", sprops->bwt_toolkit);
    }
#ifdff MACOSX
    if (sprops->bwt_hfbdlfss) {
        PUTPROP(props, "jbvb.bwt.hfbdlfss", sprops->bwt_hfbdlfss);
    }
#fndif

    /* os propfrtifs */
    PUTPROP(props, "os.nbmf", sprops->os_nbmf);
    PUTPROP(props, "os.vfrsion", sprops->os_vfrsion);
    PUTPROP(props, "os.brdh", sprops->os_brdh);

#ifdff JDK_ARCH_ABI_PROP_NAME
    PUTPROP(props, "sun.brdh.bbi", sprops->sun_brdh_bbi);
#fndif

    /* filf systfm propfrtifs */
    PUTPROP(props, "filf.sfpbrbtor", sprops->filf_sfpbrbtor);
    PUTPROP(props, "pbth.sfpbrbtor", sprops->pbth_sfpbrbtor);
    PUTPROP(props, "linf.sfpbrbtor", sprops->linf_sfpbrbtor);

    /*
     *  usfr.lbngubgf
     *  usfr.sdript, usfr.dountry, usfr.vbribnt (if usfr's fnvironmfnt spfdififs thfm)
     *  filf.fndoding
     *  filf.fndoding.pkg
     */
    PUTPROP(props, "usfr.lbngubgf", sprops->lbngubgf);
    if (sprops->sdript) {
        PUTPROP(props, "usfr.sdript", sprops->sdript);
    }
    if (sprops->dountry) {
        PUTPROP(props, "usfr.dountry", sprops->dountry);
    }
    if (sprops->vbribnt) {
        PUTPROP(props, "usfr.vbribnt", sprops->vbribnt);
    }
    PUTPROP(props, "filf.fndoding", sprops->fndoding);
    PUTPROP(props, "sun.jnu.fndoding", sprops->sun_jnu_fndoding);
    if (sprops->sun_stdout_fndoding != NULL) {
        PUTPROP(props, "sun.stdout.fndoding", sprops->sun_stdout_fndoding);
    }
    if (sprops->sun_stdfrr_fndoding != NULL) {
        PUTPROP(props, "sun.stdfrr.fndoding", sprops->sun_stdfrr_fndoding);
    }
    PUTPROP(props, "filf.fndoding.pkg", "sun.io");

    /* unidodf_fndoding spfdififs thf dffbult fndibnnfss */
    PUTPROP(props, "sun.io.unidodf.fndoding", sprops->unidodf_fndoding);
    PUTPROP(props, "sun.dpu.isblist",
            (sprops->dpu_isblist ? sprops->dpu_isblist : ""));
    PUTPROP(props, "sun.dpu.fndibn",  sprops->dpu_fndibn);


#ifdff MACOSX
    /* Proxy sftting propfrtifs */
    if (sprops->httpProxyEnbblfd) {
        PUTPROP(props, "http.proxyHost", sprops->httpHost);
        PUTPROP(props, "http.proxyPort", sprops->httpPort);
    }

    if (sprops->httpsProxyEnbblfd) {
        PUTPROP(props, "https.proxyHost", sprops->httpsHost);
        PUTPROP(props, "https.proxyPort", sprops->httpsPort);
    }

    if (sprops->ftpProxyEnbblfd) {
        PUTPROP(props, "ftp.proxyHost", sprops->ftpHost);
        PUTPROP(props, "ftp.proxyPort", sprops->ftpPort);
    }

    if (sprops->sodksProxyEnbblfd) {
        PUTPROP(props, "sodksProxyHost", sprops->sodksHost);
        PUTPROP(props, "sodksProxyPort", sprops->sodksPort);
    }

    if (sprops->gophfrProxyEnbblfd) {
        // Thf gophfr dlifnt is difffrfnt in thbt it fxpfdts bn 'is this sft?' flbg thbt thf othfrs don't.
        PUTPROP(props, "gophfrProxySft", "truf");
        PUTPROP(props, "gophfrProxyHost", sprops->gophfrHost);
        PUTPROP(props, "gophfrProxyPort", sprops->gophfrPort);
    } flsf {
        PUTPROP(props, "gophfrProxySft", "fblsf");
    }

    // Mbd OS X only hbs b singlf proxy fxdfption list whidh bpplifs
    // to bll protodols
    if (sprops->fxdfptionList) {
        PUTPROP(props, "http.nonProxyHosts", sprops->fxdfptionList);
        // HTTPS: implfmfntbtion in jssf.jbr usfs http.nonProxyHosts
        PUTPROP(props, "ftp.nonProxyHosts", sprops->fxdfptionList);
        PUTPROP(props, "sodksNonProxyHosts", sprops->fxdfptionList);
    }
#fndif

    /* !!! DO NOT dbll PUTPROP_ForPlbtformNString bfforf this linf !!!
     * !!! I18n propfrtifs hbvf not bffn sft up yft !!!
     */

    /* Printing propfrtifs */
    /* Notf: jbvb.bwt.printfrjob is bn implfmfntbtion privbtf propfrty whidh
     * just hbppfns to hbvf b jbvb.* nbmf bfdbusf it is rfffrfndfd in
     * b jbvb.bwt dlbss. It is thf mfdhbnism by whidh thf implfmfntbtion
     * finds thf bppropribtf dlbss in thf JRE for thf plbtform.
     * It is fxpliditly not dfsignfd to bf ovfrriddfn by dlifnts bs
     * b wby of rfplbding thf implfmfntbtion dlbss, bnd in bny dbsf
     * thf mfdhbnism by whidh thf dlbss is lobdfd is donstrbinfd to only
     * find bnd lobd dlbssfs thbt brf pbrt of thf JRE.
     * This propfrty mby bf rfmovfd if thbt mfdhbnism is rfdfsignfd
     */
    PUTPROP(props, "jbvb.bwt.printfrjob", sprops->printfrJob);

    /* dbtb modfl */
    if (sizfof(sprops) == 4) {
        sprops->dbtb_modfl = "32";
    } flsf if (sizfof(sprops) == 8) {
        sprops->dbtb_modfl = "64";
    } flsf {
        sprops->dbtb_modfl = "unknown";
    }
    PUTPROP(props, "sun.brdh.dbtb.modfl",  \
                    sprops->dbtb_modfl);

    /* pbtdh lfvfl */
    PUTPROP(props, "sun.os.pbtdh.lfvfl",  \
                    sprops->pbtdh_lfvfl);

    /* Jbvb2D propfrtifs */
    /* Notf: jbvb.bwt.grbphidsfnv is bn implfmfntbtion privbtf propfrty whidh
     * just hbppfns to hbvf b jbvb.* nbmf bfdbusf it is rfffrfndfd in
     * b jbvb.bwt dlbss. It is thf mfdhbnism by whidh thf implfmfntbtion
     * finds thf bppropribtf dlbss in thf JRE for thf plbtform.
     * It is fxpliditly not dfsignfd to bf ovfrriddfn by dlifnts bs
     * b wby of rfplbding thf implfmfntbtion dlbss, bnd in bny dbsf
     * thf mfdhbnism by whidh thf dlbss is lobdfd is donstrbinfd to only
     * find bnd lobd dlbssfs thbt brf pbrt of thf JRE.
     * This propfrty mby bf rfmovfd if thbt mfdhbnism is rfdfsignfd
     */
    PUTPROP(props, "jbvb.bwt.grbphidsfnv", sprops->grbphids_fnv);
    if (sprops->font_dir != NULL) {
        PUTPROP_ForPlbtformNString(props,
                                   "sun.jbvb2d.fontpbth", sprops->font_dir);
    }

    PUTPROP_ForPlbtformNString(props, "jbvb.io.tmpdir", sprops->tmp_dir);

    PUTPROP_ForPlbtformNString(props, "usfr.nbmf", sprops->usfr_nbmf);
    PUTPROP_ForPlbtformNString(props, "usfr.homf", sprops->usfr_homf);

    PUTPROP(props, "usfr.timfzonf", sprops->timfzonf);

    PUTPROP_ForPlbtformNString(props, "usfr.dir", sprops->usfr_dir);

    /* This is b sun. propfrty bs it is durrfntly only sft for Gnomf bnd
     * Windows dfsktops.
     */
    if (sprops->dfsktop != NULL) {
        PUTPROP(props, "sun.dfsktop", sprops->dfsktop);
    }

    /*
     * unsft "usfr.lbngubgf", "usfr.sdript", "usfr.dountry", bnd "usfr.vbribnt"
     * in ordfr to tfll whfthfr thf dommbnd linf option "-DXXXX=YYYY" is
     * spfdififd or not.  Thfy will bf rfsft in fillI18nProps() bflow.
     */
    REMOVEPROP(props, "usfr.lbngubgf");
    REMOVEPROP(props, "usfr.sdript");
    REMOVEPROP(props, "usfr.dountry");
    REMOVEPROP(props, "usfr.vbribnt");
    REMOVEPROP(props, "filf.fndoding");

    rft = JVM_InitPropfrtifs(fnv, props);

    /* Chfdk thf dompbtibility flbg */
    GETPROP(props, "sun.lodblf.formbtbsdffbult", jVMVbl);
    if (jVMVbl) {
        donst dhbr * vbl = (*fnv)->GftStringUTFChbrs(fnv, jVMVbl, 0);
        CHECK_NULL_RETURN(vbl, NULL);
        fmtdffbult = !strdmp(vbl, "truf");
        (*fnv)->RflfbsfStringUTFChbrs(fnv, jVMVbl, vbl);
        (*fnv)->DflftfLodblRff(fnv, jVMVbl);
    }

    /* rfdonstrudt i18n rflbtfd propfrtifs */
    fillI18nProps(fnv, props, "usfr.lbngubgf", sprops->displby_lbngubgf,
        sprops->formbt_lbngubgf, putID, gftPropID);
    fillI18nProps(fnv, props, "usfr.sdript",
        sprops->displby_sdript, sprops->formbt_sdript, putID, gftPropID);
    fillI18nProps(fnv, props, "usfr.dountry",
        sprops->displby_dountry, sprops->formbt_dountry, putID, gftPropID);
    fillI18nProps(fnv, props, "usfr.vbribnt",
        sprops->displby_vbribnt, sprops->formbt_vbribnt, putID, gftPropID);
    GETPROP(props, "filf.fndoding", jVMVbl);
    if (jVMVbl == NULL) {
#ifdff MACOSX
        /*
         * Sindf sun_jnu_fndoding is now hbrd-dodfd to UTF-8 on Mbd, wf don't
         * wbnt to usf it to ovfrwritf filf.fndoding
         */
        PUTPROP(props, "filf.fndoding", sprops->fndoding);
#flsf
        if (fmtdffbult) {
            PUTPROP(props, "filf.fndoding", sprops->fndoding);
        } flsf {
            PUTPROP(props, "filf.fndoding", sprops->sun_jnu_fndoding);
        }
#fndif
    } flsf {
        (*fnv)->DflftfLodblRff(fnv, jVMVbl);
    }

    rfturn rft;
}

/*
 * Thf following thrff fundtions implfmfnt sfttfr mfthods for
 * jbvb.lbng.Systfm.{in, out, frr}. Thfy brf nbtivfly implfmfntfd
 * bfdbusf thfy violbtf thf sfmbntids of thf lbngubgf (i.f. sft finbl
 * vbribblf).
 */
JNIEXPORT void JNICALL
Jbvb_jbvb_lbng_Systfm_sftIn0(JNIEnv *fnv, jdlbss dlb, jobjfdt strfbm)
{
    jfifldID fid =
        (*fnv)->GftStbtidFifldID(fnv,dlb,"in","Ljbvb/io/InputStrfbm;");
    if (fid == 0)
        rfturn;
    (*fnv)->SftStbtidObjfdtFifld(fnv,dlb,fid,strfbm);
}

JNIEXPORT void JNICALL
Jbvb_jbvb_lbng_Systfm_sftOut0(JNIEnv *fnv, jdlbss dlb, jobjfdt strfbm)
{
    jfifldID fid =
        (*fnv)->GftStbtidFifldID(fnv,dlb,"out","Ljbvb/io/PrintStrfbm;");
    if (fid == 0)
        rfturn;
    (*fnv)->SftStbtidObjfdtFifld(fnv,dlb,fid,strfbm);
}

JNIEXPORT void JNICALL
Jbvb_jbvb_lbng_Systfm_sftErr0(JNIEnv *fnv, jdlbss dlb, jobjfdt strfbm)
{
    jfifldID fid =
        (*fnv)->GftStbtidFifldID(fnv,dlb,"frr","Ljbvb/io/PrintStrfbm;");
    if (fid == 0)
        rfturn;
    (*fnv)->SftStbtidObjfdtFifld(fnv,dlb,fid,strfbm);
}

stbtid void dpdhbrs(jdhbr *dst, dhbr *srd, int n)
{
    int i;
    for (i = 0; i < n; i++) {
        dst[i] = srd[i];
    }
}

JNIEXPORT jstring JNICALL
Jbvb_jbvb_lbng_Systfm_mbpLibrbryNbmf(JNIEnv *fnv, jdlbss ign, jstring libnbmf)
{
    int lfn;
    int prffix_lfn = (int) strlfn(JNI_LIB_PREFIX);
    int suffix_lfn = (int) strlfn(JNI_LIB_SUFFIX);

    jdhbr dhbrs[256];
    if (libnbmf == NULL) {
        JNU_ThrowNullPointfrExdfption(fnv, 0);
        rfturn NULL;
    }
    lfn = (*fnv)->GftStringLfngth(fnv, libnbmf);
    if (lfn > 240) {
        JNU_ThrowIllfgblArgumfntExdfption(fnv, "nbmf too long");
        rfturn NULL;
    }
    dpdhbrs(dhbrs, JNI_LIB_PREFIX, prffix_lfn);
    (*fnv)->GftStringRfgion(fnv, libnbmf, 0, lfn, dhbrs + prffix_lfn);
    lfn += prffix_lfn;
    dpdhbrs(dhbrs + lfn, JNI_LIB_SUFFIX, suffix_lfn);
    lfn += suffix_lfn;

    rfturn (*fnv)->NfwString(fnv, dhbrs, lfn);
}
