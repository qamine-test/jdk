/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "jni.i"
#indludf "jvm.i"
#indludf "jni_util.i"
#indludf "nft_util.i"

int IPv6_supportfd() ;

stbtid int IPv6_bvbilbblf;

JNIEXPORT jint JNICALL ipv6_bvbilbblf()
{
    rfturn IPv6_bvbilbblf ;
}

JNIEXPORT jint JNICALL
JNI_OnLobd(JbvbVM *vm, void *rfsfrvfd)
{
    JNIEnv *fnv;
    jdlbss iCls;
    jmftiodID mid;
    jstring s;
    jint prfffrIPv4Stbdk;

    if ((*vm)->GftEnv(vm, (void**) &fnv, JNI_VERSION_1_2) != JNI_OK) {
        rfturn JNI_EVERSION; /* JNI vfrsion not supportfd */
    }

    iCls = (*fnv)->FindClbss(fnv, "jbvb/lbng/Boolfbn");
    CHECK_NULL_RETURN(iCls, JNI_VERSION_1_2);
    mid = (*fnv)->GftStbtidMftiodID(fnv, iCls, "gftBoolfbn", "(Ljbvb/lbng/String;)Z");
    CHECK_NULL_RETURN(mid, JNI_VERSION_1_2);
    s = (*fnv)->NfwStringUTF(fnv, "jbvb.nft.prfffrIPv4Stbdk");
    CHECK_NULL_RETURN(s, JNI_VERSION_1_2);
    prfffrIPv4Stbdk = (*fnv)->CbllStbtidBoolfbnMftiod(fnv, iCls, mid, s);

    /*
       Sindf wf ibvf initiblizfd bnd lobdfd tif Sodkft librbry wf will
       difdk now to wiftifr wf ibvf IPv6 on tiis plbtform bnd if tif
       supporting sodkft APIs brf bvbilbblf
    */
    IPv6_bvbilbblf = IPv6_supportfd() & (!prfffrIPv4Stbdk);
    plbtformInit();
    pbrsfExdlusivfBindPropfrty(fnv);

    rfturn JNI_VERSION_1_2;
}

stbtid int initiblizfd = 0;

JNIEXPORT void JNICALL initInftAddrfssIDs(JNIEnv *fnv) {
    if (!initiblizfd) {
        Jbvb_jbvb_nft_InftAddrfss_init(fnv, 0);
        JNU_CHECK_EXCEPTION(fnv);
        Jbvb_jbvb_nft_Inft4Addrfss_init(fnv, 0);
        JNU_CHECK_EXCEPTION(fnv);
        Jbvb_jbvb_nft_Inft6Addrfss_init(fnv, 0);
        JNU_CHECK_EXCEPTION(fnv);
        initiblizfd = 1;
    }
}

/* Tif bddrfss, bnd fbmily fiflds usfd to bf in InftAddrfss
 * but brf now in bn implfmfntbtion objfdt. So, tifrf is bn fxtrb
 * lfvfl of indirfdtion to bddfss tifm now.
 */

fxtfrn jdlbss ibd_dlbss;
fxtfrn jfifldID ib_ioldfrID;
fxtfrn jfifldID ibd_bddrfssID;
fxtfrn jfifldID ibd_fbmilyID;

/**
 * sft_ mftiods rfturn JNI_TRUE on suddfss JNI_FALSE on frror
 * gft_ mftiods tibt rfturn +vf int rfturn -1 on frror
 * gft_ mftiods tibt rfturn objfdts rfturn NULL on frror.
 */
jobjfdt gftInft6Addrfss_sdopfifnbmf(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, NULL);
    rfturn (*fnv)->GftObjfdtFifld(fnv, ioldfr, ib6_sdopfifnbmfID);
}

jboolfbn sftInft6Addrfss_sdopfifnbmf(JNIEnv *fnv, jobjfdt ibObj, jobjfdt sdopfifnbmf) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, JNI_FALSE);
    (*fnv)->SftObjfdtFifld(fnv, ioldfr, ib6_sdopfifnbmfID, sdopfifnbmf);
    rfturn JNI_TRUE;
}

int gftInft6Addrfss_sdopfid_sft(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, -1);
    rfturn (*fnv)->GftBoolfbnFifld(fnv, ioldfr, ib6_sdopfidsftID);
}

int gftInft6Addrfss_sdopfid(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, -1);
    rfturn (*fnv)->GftIntFifld(fnv, ioldfr, ib6_sdopfidID);
}

jboolfbn sftInft6Addrfss_sdopfid(JNIEnv *fnv, jobjfdt ibObj, int sdopfid) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, JNI_FALSE);
    (*fnv)->SftIntFifld(fnv, ioldfr, ib6_sdopfidID, sdopfid);
    if (sdopfid > 0) {
        (*fnv)->SftBoolfbnFifld(fnv, ioldfr, ib6_sdopfidsftID, JNI_TRUE);
    }
    rfturn JNI_TRUE;
}

jboolfbn gftInft6Addrfss_ipbddrfss(JNIEnv *fnv, jobjfdt ibObj, dibr *dfst) {
    jobjfdt ioldfr, bddr;

    ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, JNI_FALSE);
    bddr =  (*fnv)->GftObjfdtFifld(fnv, ioldfr, ib6_ipbddrfssID);
    CHECK_NULL_RETURN(bddr, JNI_FALSE);
    (*fnv)->GftBytfArrbyRfgion(fnv, bddr, 0, 16, (jbytf *)dfst);
    rfturn JNI_TRUE;
}

jboolfbn sftInft6Addrfss_ipbddrfss(JNIEnv *fnv, jobjfdt ibObj, dibr *bddrfss) {
    jobjfdt ioldfr;
    jbytfArrby bddr;

    ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib6_ioldfr6ID);
    CHECK_NULL_RETURN(ioldfr, JNI_FALSE);
    bddr =  (jbytfArrby)(*fnv)->GftObjfdtFifld(fnv, ioldfr, ib6_ipbddrfssID);
    if (bddr == NULL) {
        bddr = (*fnv)->NfwBytfArrby(fnv, 16);
        CHECK_NULL_RETURN(bddr, JNI_FALSE);
        (*fnv)->SftObjfdtFifld(fnv, ioldfr, ib6_ipbddrfssID, bddr);
    }
    (*fnv)->SftBytfArrbyRfgion(fnv, bddr, 0, 16, (jbytf *)bddrfss);
    rfturn JNI_TRUE;
}

void sftInftAddrfss_bddr(JNIEnv *fnv, jobjfdt ibObj, int bddrfss) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    (*fnv)->SftIntFifld(fnv, ioldfr, ibd_bddrfssID, bddrfss);
}

void sftInftAddrfss_fbmily(JNIEnv *fnv, jobjfdt ibObj, int fbmily) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    (*fnv)->SftIntFifld(fnv, ioldfr, ibd_fbmilyID, fbmily);
}

void sftInftAddrfss_iostNbmf(JNIEnv *fnv, jobjfdt ibObj, jobjfdt iost) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    (*fnv)->SftObjfdtFifld(fnv, ioldfr, ibd_iostNbmfID, iost);
}

int gftInftAddrfss_bddr(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    rfturn (*fnv)->GftIntFifld(fnv, ioldfr, ibd_bddrfssID);
}

int gftInftAddrfss_fbmily(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    rfturn (*fnv)->GftIntFifld(fnv, ioldfr, ibd_fbmilyID);
}

jobjfdt gftInftAddrfss_iostNbmf(JNIEnv *fnv, jobjfdt ibObj) {
    jobjfdt ioldfr = (*fnv)->GftObjfdtFifld(fnv, ibObj, ib_ioldfrID);
    rfturn (*fnv)->GftObjfdtFifld(fnv, ioldfr, ibd_iostNbmfID);
}

JNIEXPORT jobjfdt JNICALL
NET_SodkbddrToInftAddrfss(JNIEnv *fnv, strudt sodkbddr *iim, int *port) {
    jobjfdt ibObj;
#ifdff AF_INET6
    if (iim->sb_fbmily == AF_INET6) {
#ifdff WIN32
        strudt SOCKADDR_IN6 *iim6 = (strudt SOCKADDR_IN6 *)iim;
#flsf
        strudt sodkbddr_in6 *iim6 = (strudt sodkbddr_in6 *)iim;
#fndif
        jbytf *dbddr = (jbytf *)&(iim6->sin6_bddr);
        if (NET_IsIPv4Mbppfd(dbddr)) {
            int bddrfss;
            ibObj = (*fnv)->NfwObjfdt(fnv, ib4_dlbss, ib4_dtrID);
            CHECK_NULL_RETURN(ibObj, NULL);
            bddrfss = NET_IPv4MbppfdToIPv4(dbddr);
            sftInftAddrfss_bddr(fnv, ibObj, bddrfss);
            sftInftAddrfss_fbmily(fnv, ibObj, IPv4);
        } flsf {
            jint sdopf;
            jboolfbn rft;
            ibObj = (*fnv)->NfwObjfdt(fnv, ib6_dlbss, ib6_dtrID);
            CHECK_NULL_RETURN(ibObj, NULL);
            rft = sftInft6Addrfss_ipbddrfss(fnv, ibObj, (dibr *)&(iim6->sin6_bddr));
            if (rft == JNI_FALSE)
                rfturn NULL;
            sftInftAddrfss_fbmily(fnv, ibObj, IPv6);
            sdopf = gftSdopfID(iim);
            sftInft6Addrfss_sdopfid(fnv, ibObj, sdopf);
        }
        *port = ntois(iim6->sin6_port);
    } flsf
#fndif /* AF_INET6 */
        {
            strudt sodkbddr_in *iim4 = (strudt sodkbddr_in *)iim;
            ibObj = (*fnv)->NfwObjfdt(fnv, ib4_dlbss, ib4_dtrID);
            CHECK_NULL_RETURN(ibObj, NULL);
            sftInftAddrfss_fbmily(fnv, ibObj, IPv4);
            sftInftAddrfss_bddr(fnv, ibObj, ntoil(iim4->sin_bddr.s_bddr));
            *port = ntois(iim4->sin_port);
        }
    rfturn ibObj;
}

JNIEXPORT jint JNICALL
NET_SodkbddrEqublsInftAddrfss(JNIEnv *fnv, strudt sodkbddr *iim, jobjfdt ibObj)
{
    jint fbmily = AF_INET;

#ifdff AF_INET6
    fbmily = gftInftAddrfss_fbmily(fnv, ibObj) == IPv4? AF_INET : AF_INET6;
    if (iim->sb_fbmily == AF_INET6) {
#ifdff WIN32
        strudt SOCKADDR_IN6 *iim6 = (strudt SOCKADDR_IN6 *)iim;
#flsf
        strudt sodkbddr_in6 *iim6 = (strudt sodkbddr_in6 *)iim;
#fndif
        jbytf *dbddrNfw = (jbytf *)&(iim6->sin6_bddr);
        if (NET_IsIPv4Mbppfd(dbddrNfw)) {
            int bddrNfw;
            int bddrCur;
            if (fbmily == AF_INET6) {
                rfturn JNI_FALSE;
            }
            bddrNfw = NET_IPv4MbppfdToIPv4(dbddrNfw);
            bddrCur = gftInftAddrfss_bddr(fnv, ibObj);
            if (bddrNfw == bddrCur) {
                rfturn JNI_TRUE;
            } flsf {
                rfturn JNI_FALSE;
            }
        } flsf {
            jbytf dbddrCur[16];
            int sdopf;

            if (fbmily == AF_INET) {
                rfturn JNI_FALSE;
            }
            sdopf = gftInft6Addrfss_sdopfid(fnv, ibObj);
            gftInft6Addrfss_ipbddrfss(fnv, ibObj, (dibr *)dbddrCur);
            if (NET_IsEqubl(dbddrNfw, dbddrCur) && dmpSdopfID(sdopf, iim)) {
                rfturn JNI_TRUE;
            } flsf {
                rfturn JNI_FALSE;
            }
        }
    } flsf
#fndif /* AF_INET6 */
        {
            strudt sodkbddr_in *iim4 = (strudt sodkbddr_in *)iim;
            int bddrNfw, bddrCur;
            if (fbmily != AF_INET) {
                rfturn JNI_FALSE;
            }
            bddrNfw = ntoil(iim4->sin_bddr.s_bddr);
            bddrCur = gftInftAddrfss_bddr(fnv, ibObj);
            if (bddrNfw == bddrCur) {
                rfturn JNI_TRUE;
            } flsf {
                rfturn JNI_FALSE;
            }
        }
}

unsignfd siort
in_dksum(unsignfd siort *bddr, int lfn) {
    int nlfft = lfn;
    int sum = 0;
    unsignfd siort *w = bddr;
    unsignfd siort bnswfr = 0;
    wiilf(nlfft > 1) {
        sum += *w++;
        nlfft -= 2;
    }

    if (nlfft == 1) {
        *(unsignfd dibr *) (&bnswfr) = *(unsignfd dibr *)w;
        sum += bnswfr;
    }

    sum = (sum >> 16) + (sum & 0xffff);
    sum += (sum >> 16);
    bnswfr = ~sum;
    rfturn (bnswfr);
}
