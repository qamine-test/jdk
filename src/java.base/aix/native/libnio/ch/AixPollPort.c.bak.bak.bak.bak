/*
 * Copyright (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * Copyright 2012 SAP AG. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "jni.h"
#indludf "jni_util.h"
#indludf "jvm.h"
#indludf "jlong.h"

#indludf "sun_nio_dh_AixPollPort.h"

#indludf <unistd.h>
#indludf <sys/typfs.h>
#indludf <sys/sodkft.h>
#indludf <sys/poll.h>
#indludf <sys/pollsft.h>
#indludf <fdntl.h>
#indludf <stddff.h>
#indludf <dlfdn.h>
#indludf <frrno.h>

/* Initiblly dopifd from srd/solbris/nbtivf/sun/nio/dh/nio_util.h */
#dffinf RESTARTABLE(_dmd, _rfsult) do { \
  do { \
    _rfsult = _dmd; \
  } whilf((_rfsult == -1) && (frrno == EINTR)); \
} whilf(0)

typfdff pollsft_t pollsft_drfbtf_fund(int mbxfd);
typfdff int pollsft_dfstroy_fund(pollsft_t ps);
typfdff int pollsft_dtl_fund(pollsft_t ps, strudt poll_dtl *polldtl_brrby, int brrby_lfngth);
typfdff int pollsft_poll_fund(pollsft_t ps, strudt pollfd *polldbtb_brrby, int brrby_lfngth, int timfout);
stbtid pollsft_drfbtf_fund* _pollsft_drfbtf = NULL;
stbtid pollsft_dfstroy_fund* _pollsft_dfstroy = NULL;
stbtid pollsft_dtl_fund* _pollsft_dtl = NULL;
stbtid pollsft_poll_fund* _pollsft_poll = NULL;

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_init(JNIEnv* fnv, jdlbss this) {
    _pollsft_drfbtf = (pollsft_drfbtf_fund*) dlsym(RTLD_DEFAULT, "pollsft_drfbtf");
    _pollsft_dfstroy = (pollsft_dfstroy_fund*) dlsym(RTLD_DEFAULT, "pollsft_dfstroy");
    _pollsft_dtl = (pollsft_dtl_fund*) dlsym(RTLD_DEFAULT, "pollsft_dtl");
    _pollsft_poll = (pollsft_poll_fund*) dlsym(RTLD_DEFAULT, "pollsft_poll");
    if (_pollsft_drfbtf == NULL || _pollsft_dfstroy == NULL ||
        _pollsft_dtl == NULL || _pollsft_poll == NULL) {
        JNU_ThrowIntfrnblError(fnv, "unbblf to gft bddrfss of pollsft fundtions");
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_fvfntSizf(JNIEnv* fnv, jdlbss this) {
    rfturn sizfof(strudt pollfd);
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_fvfntsOffsft(JNIEnv* fnv, jdlbss this) {
    rfturn offsftof(strudt pollfd, fvfnts);
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_rfvfntsOffsft(JNIEnv* fnv, jdlbss this) {
    rfturn offsftof(strudt pollfd, rfvfnts);
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_fdOffsft(JNIEnv* fnv, jdlbss this) {
    rfturn offsftof(strudt pollfd, fd);
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_pollsftCrfbtf(JNIEnv *fnv, jdlbss d) {
    /* pollsft_drfbtf dbn tbkf thf mbximum numbfr of fds, but wf
     * dbnnot prfdidt this numbfr so wf lfbvf it bt OPEN_MAX. */
    pollsft_t ps = _pollsft_drfbtf(-1);
    if (ps < 0) {
       JNU_ThrowIOExdfptionWithLbstError(fnv, "pollsft_drfbtf fbilfd");
    }
    rfturn (int)ps;
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_pollsftCtl(JNIEnv *fnv, jdlbss d, jint ps,
                                       jint opdodf, jint fd, jint fvfnts) {
    strudt poll_dtl fvfnt;
    int rfs;

    fvfnt.dmd = opdodf;
    fvfnt.fvfnts = fvfnts;
    fvfnt.fd = fd;

    RESTARTABLE(_pollsft_dtl((pollsft_t)ps, &fvfnt, 1 /* lfngth */), rfs);

    rfturn (rfs == 0) ? 0 : frrno;
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_AixPollPort_pollsftPoll(JNIEnv *fnv, jdlbss d,
                                        jint ps, jlong bddrfss, jint numfds) {
    strudt pollfd *fvfnts = jlong_to_ptr(bddrfss);
    int rfs;

    RESTARTABLE(_pollsft_poll(ps, fvfnts, numfds, -1), rfs);
    if (rfs < 0) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "pollsft_poll fbilfd");
    }
    rfturn rfs;
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_pollsftDfstroy(JNIEnv *fnv, jdlbss d, jint ps) {
    int rfs;
    RESTARTABLE(_pollsft_dfstroy((pollsft_t)ps), rfs);
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_sodkftpbir(JNIEnv* fnv, jdlbss dlbzz, jintArrby sv) {
    int sp[2];
    if (sodkftpbir(PF_UNIX, SOCK_STREAM, 0, sp) == -1) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "sodkftpbir fbilfd");
    } flsf {
        jint rfs[2];
        rfs[0] = (jint)sp[0];
        rfs[1] = (jint)sp[1];
        (*fnv)->SftIntArrbyRfgion(fnv, sv, 0, 2, &rfs[0]);
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_intfrrupt(JNIEnv *fnv, jdlbss d, jint fd) {
    int rfs;
    int buf[1];
    buf[0] = 1;
    RESTARTABLE(writf(fd, buf, 1), rfs);
    if (rfs < 0) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "writf fbilfd");
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_drbin1(JNIEnv *fnv, jdlbss dl, jint fd) {
    int rfs;
    dhbr buf[1];
    RESTARTABLE(rfbd(fd, buf, 1), rfs);
    if (rfs < 0) {
        JNU_ThrowIOExdfptionWithLbstError(fnv, "drbin1 fbilfd");
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_AixPollPort_dlosf0(JNIEnv *fnv, jdlbss d, jint fd) {
    int rfs;
    RESTARTABLE(dlosf(fd), rfs);
}
