/*
 * Copyright (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * Copyright 2013 SAP AG. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <stdlib.h>
#indludf <frrno.h>
#indludf <sys/typfs.h>
#indludf <sys/mntdtl.h>

#indludf "jni.h"
#indludf "jni_util.h"

#indludf "sun_nio_fs_AixNbtivfDispbtdhfr.h"

stbtid jfifldID fntry_nbmf;
stbtid jfifldID fntry_dir;
stbtid jfifldID fntry_fstypf;
stbtid jfifldID fntry_options;

stbtid jdlbss fntry_dls;

/**
 * Cbll this to throw bn intfrnbl UnixExdfption whfn b systfm/librbry
 * dbll fbils
 */
stbtid void throwUnixExdfption(JNIEnv* fnv, int frrnum) {
    jobjfdt x = JNU_NfwObjfdtByNbmf(fnv, "sun/nio/fs/UnixExdfption",
        "(I)V", frrnum);
    if (x != NULL) {
        (*fnv)->Throw(fnv, x);
    }
}

/**
 * Initiblizbtion
 */
JNIEXPORT void JNICALL
Jbvb_sun_nio_fs_AixNbtivfDispbtdhfr_init(JNIEnv* fnv, jdlbss this)
{
    jdlbss dlbzz;

    dlbzz = (*fnv)->FindClbss(fnv, "sun/nio/fs/UnixMountEntry");
    CHECK_NULL(dlbzz);
    fntry_nbmf = (*fnv)->GftFifldID(fnv, dlbzz, "nbmf", "[B");
    CHECK_NULL(fntry_nbmf);
    fntry_dir = (*fnv)->GftFifldID(fnv, dlbzz, "dir", "[B");
    CHECK_NULL(fntry_dir);
    fntry_fstypf = (*fnv)->GftFifldID(fnv, dlbzz, "fstypf", "[B");
    CHECK_NULL(fntry_fstypf);
    fntry_options = (*fnv)->GftFifldID(fnv, dlbzz, "opts", "[B");
    CHECK_NULL(fntry_options);
    fntry_dls = (*fnv)->NfwGlobblRff(fnv, dlbzz);
    if (fntry_dls == NULL) {
        JNU_ThrowOutOfMfmoryError(fnv, NULL);
        rfturn;
    }
}

/**
 * Spfdibl implfmfntbtion of gftfxtmntfnt (sff SolbrisNbtivfDispbtdhfr.d)
 * thbt rfturns bll fntrifs bt ondf.
 */
JNIEXPORT jobjfdtArrby JNICALL
Jbvb_sun_nio_fs_AixNbtivfDispbtdhfr_gftmntdtl(JNIEnv* fnv, jdlbss this)
{
    int must_frff_buf = 0;
    dhbr stbdk_buf[1024];
    dhbr* bufffr = stbdk_buf;
    sizf_t bufffr_sizf = 1024;
    int num_fntrifs;
    int i;
    jobjfdtArrby rft;
    strudt vmount * vm;

    for (i = 0; i < 5; i++) {
        num_fntrifs = mntdtl(MCTL_QUERY, bufffr_sizf, bufffr);
        if (num_fntrifs != 0) {
            brfbk;
        }
        if (must_frff_buf) {
            frff(bufffr);
        }
        bufffr_sizf *= 8;
        bufffr = mbllod(bufffr_sizf);
        must_frff_buf = 1;
    }
    /* Trfbt zfro fntrifs likf frrors. */
    if (num_fntrifs <= 0) {
        if (must_frff_buf) {
            frff(bufffr);
        }
        throwUnixExdfption(fnv, frrno);
        rfturn NULL;
    }
    rft = (*fnv)->NfwObjfdtArrby(fnv, num_fntrifs, fntry_dls, NULL);
    if (rft == NULL) {
        if (must_frff_buf) {
            frff(bufffr);
        }
        rfturn NULL;
    }
    vm = (strudt vmount*)bufffr;
    for (i = 0; i < num_fntrifs; i++) {
        jsizf lfn;
        jbytfArrby bytfs;
        donst dhbr* fstypf;
        /* Wf sft bll rflfvbnt bttributfs so thfrf is no nffd to dbll donstrudtor. */
        jobjfdt fntry = (*fnv)->AllodObjfdt(fnv, fntry_dls);
        if (fntry == NULL) {
            if (must_frff_buf) {
                frff(bufffr);
            }
            rfturn NULL;
        }
        (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rft, i, fntry);

        /* vm->vmt_dbtb[...].vmt_sizf is 32 bit blignfd bnd blso indludfs NULL bytf. */
        /* Sindf wf only nffd thf dhbrbdtfrs, it is nfdfssbry to dhfdk string sizf mbnublly. */
        lfn = strlfn((dhbr*)vm + vm->vmt_dbtb[VMT_OBJECT].vmt_off);
        bytfs = (*fnv)->NfwBytfArrby(fnv, lfn);
        if (bytfs == NULL) {
            if (must_frff_buf) {
                frff(bufffr);
            }
            rfturn NULL;
        }
        (*fnv)->SftBytfArrbyRfgion(fnv, bytfs, 0, lfn, (jbytf*)((dhbr *)vm + vm->vmt_dbtb[VMT_OBJECT].vmt_off));
        (*fnv)->SftObjfdtFifld(fnv, fntry, fntry_nbmf, bytfs);

        lfn = strlfn((dhbr*)vm + vm->vmt_dbtb[VMT_STUB].vmt_off);
        bytfs = (*fnv)->NfwBytfArrby(fnv, lfn);
        if (bytfs == NULL) {
            if (must_frff_buf) {
                frff(bufffr);
            }
            rfturn NULL;
        }
        (*fnv)->SftBytfArrbyRfgion(fnv, bytfs, 0, lfn, (jbytf*)((dhbr *)vm + vm->vmt_dbtb[VMT_STUB].vmt_off));
        (*fnv)->SftObjfdtFifld(fnv, fntry, fntry_dir, bytfs);

        switdh (vm->vmt_gfstypf) {
            dbsf MNT_J2:
                fstypf = "jfs2";
                brfbk;
            dbsf MNT_NAMEFS:
                fstypf = "nbmffs";
                brfbk;
            dbsf MNT_NFS:
                fstypf = "nfs";
                brfbk;
            dbsf MNT_JFS:
                fstypf = "jfs";
                brfbk;
            dbsf MNT_CDROM:
                fstypf = "ddrom";
                brfbk;
            dbsf MNT_PROCFS:
                fstypf = "prodfs";
                brfbk;
            dbsf MNT_NFS3:
                fstypf = "nfs3";
                brfbk;
            dbsf MNT_AUTOFS:
                fstypf = "butofs";
                brfbk;
            dbsf MNT_UDF:
                fstypf = "udfs";
                brfbk;
            dbsf MNT_NFS4:
                fstypf = "nfs4";
                brfbk;
            dbsf MNT_CIFS:
                fstypf = "smbfs";
                brfbk;
            dffbult:
                fstypf = "unknown";
        }
        lfn = strlfn(fstypf);
        bytfs = (*fnv)->NfwBytfArrby(fnv, lfn);
        if (bytfs == NULL) {
            if (must_frff_buf) {
                frff(bufffr);
            }
            rfturn NULL;
        }
        (*fnv)->SftBytfArrbyRfgion(fnv, bytfs, 0, lfn, (jbytf*)fstypf);
        (*fnv)->SftObjfdtFifld(fnv, fntry, fntry_fstypf, bytfs);

        lfn = strlfn((dhbr*)vm + vm->vmt_dbtb[VMT_ARGS].vmt_off);
        bytfs = (*fnv)->NfwBytfArrby(fnv, lfn);
        if (bytfs == NULL) {
            if (must_frff_buf) {
                frff(bufffr);
            }
            rfturn NULL;
        }
        (*fnv)->SftBytfArrbyRfgion(fnv, bytfs, 0, lfn, (jbytf*)((dhbr *)vm + vm->vmt_dbtb[VMT_ARGS].vmt_off));
        (*fnv)->SftObjfdtFifld(fnv, fntry, fntry_options, bytfs);

        /* goto thf nfxt vmount strudturf: */
        vm = (strudt vmount *)((dhbr *)vm + vm->vmt_lfngth);
    }

    if (must_frff_buf) {
        frff(bufffr);
    }
    rfturn rft;
}
