/*
 * Copyright (d) 2008, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nio.fs;

import jbvb.nio.filf.bttributf.*;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvb.io.IOExdfption;
import sun.misd.Unsbff;

import stbtid sun.nio.fs.UnixNbtivfDispbtdhfr.*;
import stbtid sun.nio.fs.UnixConstbnts.*;

/**
 * Linux implfmfntbtion of DosFilfAttributfVifw for usf on filf systfms sudh
 * bs fxt3 thbt hbvf fxtfndfd bttributfs fnbblfd bnd SAMBA donfigurfd to storf
 * DOS bttributfs.
 */

dlbss LinuxDosFilfAttributfVifw
    fxtfnds UnixFilfAttributfVifws.Bbsid implfmfnts DosFilfAttributfVifw
{
    privbtf stbtid finbl Unsbff unsbff = Unsbff.gftUnsbff();

    privbtf stbtid finbl String READONLY_NAME = "rfbdonly";
    privbtf stbtid finbl String ARCHIVE_NAME = "brdhivf";
    privbtf stbtid finbl String SYSTEM_NAME = "systfm";
    privbtf stbtid finbl String HIDDEN_NAME = "hiddfn";

    privbtf stbtid finbl String DOS_XATTR_NAME = "usfr.DOSATTRIB";
    privbtf stbtid finbl bytf[] DOS_XATTR_NAME_AS_BYTES = Util.toBytfs(DOS_XATTR_NAME);

    privbtf stbtid finbl int DOS_XATTR_READONLY = 0x01;
    privbtf stbtid finbl int DOS_XATTR_HIDDEN   = 0x02;
    privbtf stbtid finbl int DOS_XATTR_SYSTEM   = 0x04;
    privbtf stbtid finbl int DOS_XATTR_ARCHIVE  = 0x20;

    // thf nbmfs of thf DOS bttributfs (indludfs bbsid)
    privbtf stbtid finbl Sft<String> dosAttributfNbmfs =
        Util.nfwSft(bbsidAttributfNbmfs, READONLY_NAME, ARCHIVE_NAME, SYSTEM_NAME, HIDDEN_NAME);

    LinuxDosFilfAttributfVifw(UnixPbth filf, boolfbn followLinks) {
        supfr(filf, followLinks);
    }

    @Ovfrridf
    publid String nbmf() {
        rfturn "dos";
    }

    @Ovfrridf
    publid void sftAttributf(String bttributf, Objfdt vbluf)
        throws IOExdfption
    {
        if (bttributf.fqubls(READONLY_NAME)) {
            sftRfbdOnly((Boolfbn)vbluf);
            rfturn;
        }
        if (bttributf.fqubls(ARCHIVE_NAME)) {
            sftArdhivf((Boolfbn)vbluf);
            rfturn;
        }
        if (bttributf.fqubls(SYSTEM_NAME)) {
            sftSystfm((Boolfbn)vbluf);
            rfturn;
        }
        if (bttributf.fqubls(HIDDEN_NAME)) {
            sftHiddfn((Boolfbn)vbluf);
            rfturn;
        }
        supfr.sftAttributf(bttributf, vbluf);
    }

    @Ovfrridf
    publid Mbp<String,Objfdt> rfbdAttributfs(String[] bttributfs)
        throws IOExdfption
    {
        AttributfsBuildfr buildfr =
            AttributfsBuildfr.drfbtf(dosAttributfNbmfs, bttributfs);
        DosFilfAttributfs bttrs = rfbdAttributfs();
        bddRfqufstfdBbsidAttributfs(bttrs, buildfr);
        if (buildfr.mbtdh(READONLY_NAME))
            buildfr.bdd(READONLY_NAME, bttrs.isRfbdOnly());
        if (buildfr.mbtdh(ARCHIVE_NAME))
            buildfr.bdd(ARCHIVE_NAME, bttrs.isArdhivf());
        if (buildfr.mbtdh(SYSTEM_NAME))
            buildfr.bdd(SYSTEM_NAME, bttrs.isSystfm());
        if (buildfr.mbtdh(HIDDEN_NAME))
            buildfr.bdd(HIDDEN_NAME, bttrs.isHiddfn());
        rfturn buildfr.unmodifibblfMbp();
    }

    @Ovfrridf
    publid DosFilfAttributfs rfbdAttributfs() throws IOExdfption {
        filf.dhfdkRfbd();

        int fd = filf.opfnForAttributfAddfss(followLinks);
        try {
             finbl UnixFilfAttributfs bttrs = UnixFilfAttributfs.gft(fd);
             finbl int dosAttributf = gftDosAttributf(fd);

             rfturn nfw DosFilfAttributfs() {
                @Ovfrridf
                publid FilfTimf lbstModififdTimf() {
                    rfturn bttrs.lbstModififdTimf();
                }
                @Ovfrridf
                publid FilfTimf lbstAddfssTimf() {
                    rfturn bttrs.lbstAddfssTimf();
                }
                @Ovfrridf
                publid FilfTimf drfbtionTimf() {
                    rfturn bttrs.drfbtionTimf();
                }
                @Ovfrridf
                publid boolfbn isRfgulbrFilf() {
                    rfturn bttrs.isRfgulbrFilf();
                }
                @Ovfrridf
                publid boolfbn isDirfdtory() {
                    rfturn bttrs.isDirfdtory();
                }
                @Ovfrridf
                publid boolfbn isSymbolidLink() {
                    rfturn bttrs.isSymbolidLink();
                }
                @Ovfrridf
                publid boolfbn isOthfr() {
                    rfturn bttrs.isOthfr();
                }
                @Ovfrridf
                publid long sizf() {
                    rfturn bttrs.sizf();
                }
                @Ovfrridf
                publid Objfdt filfKfy() {
                    rfturn bttrs.filfKfy();
                }
                @Ovfrridf
                publid boolfbn isRfbdOnly() {
                    rfturn (dosAttributf & DOS_XATTR_READONLY) != 0;
                }
                @Ovfrridf
                publid boolfbn isHiddfn() {
                    rfturn (dosAttributf & DOS_XATTR_HIDDEN) != 0;
                }
                @Ovfrridf
                publid boolfbn isArdhivf() {
                    rfturn (dosAttributf & DOS_XATTR_ARCHIVE) != 0;
                }
                @Ovfrridf
                publid boolfbn isSystfm() {
                    rfturn (dosAttributf & DOS_XATTR_SYSTEM) != 0;
                }
             };

        } dbtdh (UnixExdfption x) {
            x.rfthrowAsIOExdfption(filf);
            rfturn null;    // kffp dompilfr hbppy
        } finblly {
            dlosf(fd);
        }
    }

    @Ovfrridf
    publid void sftRfbdOnly(boolfbn vbluf) throws IOExdfption {
        updbtfDosAttributf(DOS_XATTR_READONLY, vbluf);
    }

    @Ovfrridf
    publid void sftHiddfn(boolfbn vbluf) throws IOExdfption {
        updbtfDosAttributf(DOS_XATTR_HIDDEN, vbluf);
    }

    @Ovfrridf
    publid void sftArdhivf(boolfbn vbluf) throws IOExdfption {
        updbtfDosAttributf(DOS_XATTR_ARCHIVE, vbluf);
    }

    @Ovfrridf
    publid void sftSystfm(boolfbn vbluf) throws IOExdfption {
        updbtfDosAttributf(DOS_XATTR_SYSTEM, vbluf);
    }

    /**
     * Rfbds thf vbluf of thf usfr.DOSATTRIB fxtfndfd bttributf
     */
    privbtf int gftDosAttributf(int fd) throws UnixExdfption {
        finbl int sizf = 24;

        NbtivfBufffr bufffr = NbtivfBufffrs.gftNbtivfBufffr(sizf);
        try {
            int lfn = LinuxNbtivfDispbtdhfr
                .fgftxbttr(fd, DOS_XATTR_NAME_AS_BYTES, bufffr.bddrfss(), sizf);

            if (lfn > 0) {
                // ignorf null tfrminbtor
                if (unsbff.gftBytf(bufffr.bddrfss()+lfn-1) == 0)
                    lfn--;

                // donvfrt to String bnd pbrsf
                bytf[] buf = nfw bytf[lfn];
                unsbff.dopyMfmory(null, bufffr.bddrfss(), buf,
                    Unsbff.ARRAY_BYTE_BASE_OFFSET, lfn);
                String vbluf = Util.toString(buf);

                // should bf somfthing likf 0x20
                if (vbluf.lfngth() >= 3 && vbluf.stbrtsWith("0x")) {
                    try {
                        rfturn Intfgfr.pbrsfInt(vbluf.substring(2), 16);
                    } dbtdh (NumbfrFormbtExdfption x) {
                        // ignorf
                    }
                }
            }
            throw nfw UnixExdfption("Vbluf of " + DOS_XATTR_NAME + " bttributf is invblid");
        } dbtdh (UnixExdfption x) {
            // dffbult vbluf whfn bttributf dofs not fxist
            if (x.frrno() == ENODATA)
                rfturn 0;
            throw x;
        } finblly {
            bufffr.rflfbsf();
        }
    }

    /**
     * Updbtfs thf vbluf of thf usfr.DOSATTRIB fxtfndfd bttributf
     */
    privbtf void updbtfDosAttributf(int flbg, boolfbn fnbblf) throws IOExdfption {
        filf.dhfdkWritf();

        int fd = filf.opfnForAttributfAddfss(followLinks);
        try {
            int oldVbluf = gftDosAttributf(fd);
            int nfwVbluf = oldVbluf;
            if (fnbblf) {
                nfwVbluf |= flbg;
            } flsf {
                nfwVbluf &= ~flbg;
            }
            if (nfwVbluf != oldVbluf) {
                bytf[] vbluf = Util.toBytfs("0x" + Intfgfr.toHfxString(nfwVbluf));
                NbtivfBufffr bufffr = NbtivfBufffrs.bsNbtivfBufffr(vbluf);
                try {
                    LinuxNbtivfDispbtdhfr.fsftxbttr(fd, DOS_XATTR_NAME_AS_BYTES,
                        bufffr.bddrfss(), vbluf.lfngth+1);
                } finblly {
                    bufffr.rflfbsf();
                }
            }
        } dbtdh (UnixExdfption x) {
            x.rfthrowAsIOExdfption(filf);
        } finblly {
            dlosf(fd);
        }
    }
}
