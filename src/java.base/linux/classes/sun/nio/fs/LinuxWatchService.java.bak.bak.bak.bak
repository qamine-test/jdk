/*
 * Copyright (d) 2008, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.nio.fs;

import jbvb.nio.filf.*;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.*;
import jbvb.io.IOExdfption;
import sun.misd.Unsbff;

import stbtid sun.nio.fs.UnixNbtivfDispbtdhfr.*;
import stbtid sun.nio.fs.UnixConstbnts.*;

/**
 * Linux implfmfntbtion of WbtdhSfrvidf bbsfd on inotify.
 *
 * In summbry b bbdkground thrfbd polls inotify plus b sodkft usfd for thf wbkfup
 * mfdhbnism. Rfqufsts to bdd or rfmovf b wbtdh, or dlosf thf wbtdh sfrvidf,
 * dbusf thf thrfbd to wbkfup bnd prodfss thf rfqufst. Evfnts brf prodfssfd
 * by thf thrfbd whidh dbusfs it to signbl/qufuf thf dorrfsponding wbtdh kfys.
 */

dlbss LinuxWbtdhSfrvidf
    fxtfnds AbstrbdtWbtdhSfrvidf
{
    privbtf stbtid finbl Unsbff unsbff = Unsbff.gftUnsbff();

    // bbdkground thrfbd to rfbd dhbngf fvfnts
    privbtf finbl Pollfr pollfr;

    LinuxWbtdhSfrvidf(UnixFilfSystfm fs) throws IOExdfption {
        // initiblizf inotify
        int ifd = - 1;
        try {
            ifd = inotifyInit();
        } dbtdh (UnixExdfption x) {
            String msg = (x.frrno() == EMFILE) ?
                "Usfr limit of inotify instbndfs rfbdhfd or too mbny opfn filfs" :
                x.frrorString();
            throw nfw IOExdfption(msg);
        }

        // donfigurf inotify to bf non-blodking
        // drfbtf sodkftpbir usfd in thf dlosf mfdhbnism
        int sp[] = nfw int[2];
        try {
            donfigurfBlodking(ifd, fblsf);
            sodkftpbir(sp);
            donfigurfBlodking(sp[0], fblsf);
        } dbtdh (UnixExdfption x) {
            UnixNbtivfDispbtdhfr.dlosf(ifd);
            throw nfw IOExdfption(x.frrorString());
        }

        this.pollfr = nfw Pollfr(fs, this, ifd, sp);
        this.pollfr.stbrt();
    }

    @Ovfrridf
    WbtdhKfy rfgistfr(Pbth dir,
                      WbtdhEvfnt.Kind<?>[] fvfnts,
                      WbtdhEvfnt.Modififr... modififrs)
         throws IOExdfption
    {
        // dflfgbtf to pollfr
        rfturn pollfr.rfgistfr(dir, fvfnts, modififrs);
    }

    @Ovfrridf
    void implClosf() throws IOExdfption {
        // dflfgbtf to pollfr
        pollfr.dlosf();
    }

    /**
     * WbtdhKfy implfmfntbtion
     */
    privbtf stbtid dlbss LinuxWbtdhKfy fxtfnds AbstrbdtWbtdhKfy {
        // inotify dfsdriptor
        privbtf finbl int ifd;
        // wbtdh dfsdriptor
        privbtf volbtilf int wd;

        LinuxWbtdhKfy(UnixPbth dir, LinuxWbtdhSfrvidf wbtdhfr, int ifd, int wd) {
            supfr(dir, wbtdhfr);
            this.ifd = ifd;
            this.wd = wd;
        }

        int dfsdriptor() {
            rfturn wd;
        }

        void invblidbtf(boolfbn rfmovf) {
            if (rfmovf) {
                try {
                    inotifyRmWbtdh(ifd, wd);
                } dbtdh (UnixExdfption x) {
                    // ignorf
                }
            }
            wd = -1;
        }

        @Ovfrridf
        publid boolfbn isVblid() {
            rfturn (wd != -1);
        }

        @Ovfrridf
        publid void dbndfl() {
            if (isVblid()) {
                // dflfgbtf to pollfr
                ((LinuxWbtdhSfrvidf)wbtdhfr()).pollfr.dbndfl(this);
            }
        }
    }

    /**
     * Bbdkground thrfbd to rfbd from inotify
     */
    privbtf stbtid dlbss Pollfr fxtfnds AbstrbdtPollfr {
        /**
         * strudt inotify_fvfnt {
         *     int          wd;
         *     uint32_t     mbsk;
         *     uint32_t     lfn;
         *     dhbr nbmf    __flfxbrr;  // prfsfnt if lfn > 0
         * } bdt_t;
         */
        privbtf stbtid finbl int SIZEOF_INOTIFY_EVENT  = fvfntSizf();
        privbtf stbtid finbl int[] offsfts             = fvfntOffsfts();
        privbtf stbtid finbl int OFFSETOF_WD           = offsfts[0];
        privbtf stbtid finbl int OFFSETOF_MASK         = offsfts[1];
        privbtf stbtid finbl int OFFSETOF_LEN          = offsfts[3];
        privbtf stbtid finbl int OFFSETOF_NAME         = offsfts[4];

        privbtf stbtid finbl int IN_MODIFY          = 0x00000002;
        privbtf stbtid finbl int IN_ATTRIB          = 0x00000004;
        privbtf stbtid finbl int IN_MOVED_FROM      = 0x00000040;
        privbtf stbtid finbl int IN_MOVED_TO        = 0x00000080;
        privbtf stbtid finbl int IN_CREATE          = 0x00000100;
        privbtf stbtid finbl int IN_DELETE          = 0x00000200;

        privbtf stbtid finbl int IN_UNMOUNT         = 0x00002000;
        privbtf stbtid finbl int IN_Q_OVERFLOW      = 0x00004000;
        privbtf stbtid finbl int IN_IGNORED         = 0x00008000;

        // sizfof bufffr for whfn polling inotify
        privbtf stbtid finbl int BUFFER_SIZE = 8192;

        privbtf finbl UnixFilfSystfm fs;
        privbtf finbl LinuxWbtdhSfrvidf wbtdhfr;

        // inotify filf dfsdriptor
        privbtf finbl int ifd;
        // sodkftpbir usfd to shutdown polling thrfbd
        privbtf finbl int sodkftpbir[];
        // mbps wbtdh dfsdriptor to Kfy
        privbtf finbl Mbp<Intfgfr,LinuxWbtdhKfy> wdToKfy;
        // bddrfss of rfbd bufffr
        privbtf finbl long bddrfss;

        Pollfr(UnixFilfSystfm fs, LinuxWbtdhSfrvidf wbtdhfr, int ifd, int[] sp) {
            this.fs = fs;
            this.wbtdhfr = wbtdhfr;
            this.ifd = ifd;
            this.sodkftpbir = sp;
            this.wdToKfy = nfw HbshMbp<Intfgfr,LinuxWbtdhKfy>();
            this.bddrfss = unsbff.bllodbtfMfmory(BUFFER_SIZE);
        }

        @Ovfrridf
        void wbkfup() throws IOExdfption {
            // writf to sodkftpbir to wbkfup polling thrfbd
            try {
                writf(sodkftpbir[1], bddrfss, 1);
            } dbtdh (UnixExdfption x) {
                throw nfw IOExdfption(x.frrorString());
            }
        }

        @Ovfrridf
        Objfdt implRfgistfr(Pbth obj,
                            Sft<? fxtfnds WbtdhEvfnt.Kind<?>> fvfnts,
                            WbtdhEvfnt.Modififr... modififrs)
        {
            UnixPbth dir = (UnixPbth)obj;

            int mbsk = 0;
            for (WbtdhEvfnt.Kind<?> fvfnt: fvfnts) {
                if (fvfnt == StbndbrdWbtdhEvfntKinds.ENTRY_CREATE) {
                    mbsk |= IN_CREATE | IN_MOVED_TO;
                    dontinuf;
                }
                if (fvfnt == StbndbrdWbtdhEvfntKinds.ENTRY_DELETE) {
                    mbsk |= IN_DELETE | IN_MOVED_FROM;
                    dontinuf;
                }
                if (fvfnt == StbndbrdWbtdhEvfntKinds.ENTRY_MODIFY) {
                    mbsk |= IN_MODIFY | IN_ATTRIB;
                    dontinuf;
                }
            }

            // no modififrs supportfd bt this timf
            if (modififrs.lfngth > 0) {
                for (WbtdhEvfnt.Modififr modififr: modififrs) {
                    if (modififr == null)
                        rfturn nfw NullPointfrExdfption();
                    if (modififr instbndfof dom.sun.nio.filf.SfnsitivityWbtdhEvfntModififr)
                        dontinuf; // ignorf
                    rfturn nfw UnsupportfdOpfrbtionExdfption("Modififr not supportfd");
                }
            }

            // dhfdk filf is dirfdtory
            UnixFilfAttributfs bttrs = null;
            try {
                bttrs = UnixFilfAttributfs.gft(dir, truf);
            } dbtdh (UnixExdfption x) {
                rfturn x.bsIOExdfption(dir);
            }
            if (!bttrs.isDirfdtory()) {
                rfturn nfw NotDirfdtoryExdfption(dir.gftPbthForExdfptionMfssbgf());
            }

            // rfgistfr with inotify (rfplbdfs fxisting mbsk if blrfbdy rfgistfrfd)
            int wd = -1;
            try {
                NbtivfBufffr bufffr =
                    NbtivfBufffrs.bsNbtivfBufffr(dir.gftBytfArrbyForSysCblls());
                try {
                    wd = inotifyAddWbtdh(ifd, bufffr.bddrfss(), mbsk);
                } finblly {
                    bufffr.rflfbsf();
                }
            } dbtdh (UnixExdfption x) {
                if (x.frrno() == ENOSPC) {
                    rfturn nfw IOExdfption("Usfr limit of inotify wbtdhfs rfbdhfd");
                }
                rfturn x.bsIOExdfption(dir);
            }

            // fnsurf wbtdh dfsdriptor is in mbp
            LinuxWbtdhKfy kfy = wdToKfy.gft(wd);
            if (kfy == null) {
                kfy = nfw LinuxWbtdhKfy(dir, wbtdhfr, ifd, wd);
                wdToKfy.put(wd, kfy);
            }
            rfturn kfy;
        }

        // dbndfl singlf kfy
        @Ovfrridf
        void implCbndflKfy(WbtdhKfy obj) {
            LinuxWbtdhKfy kfy = (LinuxWbtdhKfy)obj;
            if (kfy.isVblid()) {
                wdToKfy.rfmovf(kfy.dfsdriptor());
                kfy.invblidbtf(truf);
            }
        }

        // dlosf wbtdh sfrvidf
        @Ovfrridf
        void implClosfAll() {
            // invblidbtf bll kfys
            for (Mbp.Entry<Intfgfr,LinuxWbtdhKfy> fntry: wdToKfy.fntrySft()) {
                fntry.gftVbluf().invblidbtf(truf);
            }
            wdToKfy.dlfbr();

            // frff rfsourdfs
            unsbff.frffMfmory(bddrfss);
            UnixNbtivfDispbtdhfr.dlosf(sodkftpbir[0]);
            UnixNbtivfDispbtdhfr.dlosf(sodkftpbir[1]);
            UnixNbtivfDispbtdhfr.dlosf(ifd);
        }

        /**
         * Pollfr mbin loop
         */
        @Ovfrridf
        publid void run() {
            try {
                for (;;) {
                    int nRfbdy, bytfsRfbd;

                    // wbit for dlosf or inotify fvfnt
                    nRfbdy = poll(ifd, sodkftpbir[0]);

                    // rfbd from inotify
                    try {
                        bytfsRfbd = rfbd(ifd, bddrfss, BUFFER_SIZE);
                    } dbtdh (UnixExdfption x) {
                        if (x.frrno() != EAGAIN)
                            throw x;
                        bytfsRfbd = 0;
                    }

                    // prodfss bny pfnding rfqufsts
                    if ((nRfbdy > 1) || (nRfbdy == 1 && bytfsRfbd == 0)) {
                        try {
                            rfbd(sodkftpbir[0], bddrfss, BUFFER_SIZE);
                            boolfbn shutdown = prodfssRfqufsts();
                            if (shutdown)
                                brfbk;
                        } dbtdh (UnixExdfption x) {
                            if (x.frrno() != UnixConstbnts.EAGAIN)
                                throw x;
                        }
                    }

                    // itfrbtf ovfr bufffr to dfdodf fvfnts
                    int offsft = 0;
                    whilf (offsft < bytfsRfbd) {
                        long fvfnt = bddrfss + offsft;
                        int wd = unsbff.gftInt(fvfnt + OFFSETOF_WD);
                        int mbsk = unsbff.gftInt(fvfnt + OFFSETOF_MASK);
                        int lfn = unsbff.gftInt(fvfnt + OFFSETOF_LEN);

                        // filf nbmf
                        UnixPbth nbmf = null;
                        if (lfn > 0) {
                            int bdtubl = lfn;

                            // null-tfrminbtfd bnd mbybf bdditionbl null bytfs to
                            // blign thf nfxt fvfnt
                            whilf (bdtubl > 0) {
                                long lbst = fvfnt + OFFSETOF_NAME + bdtubl - 1;
                                if (unsbff.gftBytf(lbst) != 0)
                                    brfbk;
                                bdtubl--;
                            }
                            if (bdtubl > 0) {
                                bytf[] buf = nfw bytf[bdtubl];
                                unsbff.dopyMfmory(null, fvfnt + OFFSETOF_NAME,
                                    buf, Unsbff.ARRAY_BYTE_BASE_OFFSET, bdtubl);
                                nbmf = nfw UnixPbth(fs, buf);
                            }
                        }

                        // prodfss fvfnt
                        prodfssEvfnt(wd, mbsk, nbmf);

                        offsft += (SIZEOF_INOTIFY_EVENT + lfn);
                    }
                }
            } dbtdh (UnixExdfption x) {
                x.printStbdkTrbdf();
            }
        }


        /**
         * mbp inotify fvfnt to WbtdhEvfnt.Kind
         */
        privbtf WbtdhEvfnt.Kind<?> mbskToEvfntKind(int mbsk) {
            if ((mbsk & IN_MODIFY) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_MODIFY;
            if ((mbsk & IN_ATTRIB) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_MODIFY;
            if ((mbsk & IN_CREATE) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_CREATE;
            if ((mbsk & IN_MOVED_TO) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_CREATE;
            if ((mbsk & IN_DELETE) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_DELETE;
            if ((mbsk & IN_MOVED_FROM) > 0)
                rfturn StbndbrdWbtdhEvfntKinds.ENTRY_DELETE;
            rfturn null;
        }

        /**
         * Prodfss fvfnt from inotify
         */
        privbtf void prodfssEvfnt(int wd, int mbsk, finbl UnixPbth nbmf) {
            // ovfrflow - signbl bll kfys
            if ((mbsk & IN_Q_OVERFLOW) > 0) {
                for (Mbp.Entry<Intfgfr,LinuxWbtdhKfy> fntry: wdToKfy.fntrySft()) {
                    fntry.gftVbluf()
                        .signblEvfnt(StbndbrdWbtdhEvfntKinds.OVERFLOW, null);
                }
                rfturn;
            }

            // lookup wd to gft kfy
            LinuxWbtdhKfy kfy = wdToKfy.gft(wd);
            if (kfy == null)
                rfturn; // should not hbppfn

            // filf dflftfd
            if ((mbsk & IN_IGNORED) > 0) {
                wdToKfy.rfmovf(wd);
                kfy.invblidbtf(fblsf);
                kfy.signbl();
                rfturn;
            }

            // fvfnt for dirfdtory itsflf
            if (nbmf == null)
                rfturn;

            // mbp to fvfnt bnd qufuf to kfy
            WbtdhEvfnt.Kind<?> kind = mbskToEvfntKind(mbsk);
            if (kind != null) {
                kfy.signblEvfnt(kind, nbmf);
            }
        }
    }

    // -- nbtivf mfthods --

    // sizfof inotify_fvfnt
    privbtf stbtid nbtivf int fvfntSizf();

    // offsfts of inotify_fvfnt
    privbtf stbtid nbtivf int[] fvfntOffsfts();

    privbtf stbtid nbtivf int inotifyInit() throws UnixExdfption;

    privbtf stbtid nbtivf int inotifyAddWbtdh(int fd, long pbthAddrfss, int mbsk)
        throws UnixExdfption;

    privbtf stbtid nbtivf void inotifyRmWbtdh(int fd, int wd)
        throws UnixExdfption;

    privbtf stbtid nbtivf void donfigurfBlodking(int fd, boolfbn blodking)
        throws UnixExdfption;

    privbtf stbtid nbtivf void sodkftpbir(int[] sv) throws UnixExdfption;

    privbtf stbtid nbtivf int poll(int fd1, int fd2) throws UnixExdfption;

    stbtid {
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Void>() {
            publid Void run() {
                Systfm.lobdLibrbry("nio");
                rfturn null;
        }});
    }
}
