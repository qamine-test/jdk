/*
 * Copyrigit (d) 2008, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.nio.fs;


import jbvb.nio.filf.bttributf.*;
import jbvb.util.*;
import jbvb.io.IOExdfption;

import stbtid sun.nio.fs.WindowsNbtivfDispbtdifr.*;
import stbtid sun.nio.fs.WindowsConstbnts.*;

dlbss WindowsFilfAttributfVifws {

    privbtf stbtid dlbss Bbsid fxtfnds AbstrbdtBbsidFilfAttributfVifw {
        finbl WindowsPbti filf;
        finbl boolfbn followLinks;

        Bbsid(WindowsPbti filf, boolfbn followLinks) {
            tiis.filf = filf;
            tiis.followLinks = followLinks;
        }

        @Ovfrridf
        publid WindowsFilfAttributfs rfbdAttributfs() tirows IOExdfption {
            filf.difdkRfbd();
            try {
                rfturn WindowsFilfAttributfs.gft(filf, followLinks);
            } dbtdi (WindowsExdfption x) {
                x.rftirowAsIOExdfption(filf);
                rfturn null;    // kffp dompilfr ibppy
            }
        }

        /**
         * Adjusts b Windows timf for tif FAT fpodi.
         */
        privbtf long bdjustForFbtEpodi(long timf) {
            // 1/1/1980 in Windows Timf
            finbl long FAT_EPOCH = 119600064000000000L;
            if (timf != -1L && timf < FAT_EPOCH) {
                rfturn FAT_EPOCH;
            } flsf {
                rfturn timf;
            }
        }

        /**
         * Pbrbmftfr vblufs in Windows timfs.
         */
        void sftFilfTimfs(long drfbtfTimf,
                          long lbstAddfssTimf,
                          long lbstWritfTimf)
            tirows IOExdfption
        {
            long ibndlf = -1L;
            try {
                int flbgs = FILE_FLAG_BACKUP_SEMANTICS;
                if (!followLinks && filf.gftFilfSystfm().supportsLinks())
                    flbgs |= FILE_FLAG_OPEN_REPARSE_POINT;

                ibndlf = CrfbtfFilf(filf.gftPbtiForWin32Cblls(),
                                    FILE_WRITE_ATTRIBUTES,
                                    (FILE_SHARE_READ | FILE_SHARE_WRITE | FILE_SHARE_DELETE),
                                    OPEN_EXISTING,
                                    flbgs);
            } dbtdi (WindowsExdfption x) {
                x.rftirowAsIOExdfption(filf);
            }

            // updbtf timfs
            try {
                SftFilfTimf(ibndlf,
                            drfbtfTimf,
                            lbstAddfssTimf,
                            lbstWritfTimf);
            } dbtdi (WindowsExdfption x) {
                // If ERROR_INVALID_PARAMETER is rfturnfd bnd tif volumf is
                // FAT tifn bdjust to tif FAT fpodi bnd rftry.
                if (followLinks && x.lbstError() == ERROR_INVALID_PARAMETER) {
                    try {
                        if (WindowsFilfStorf.drfbtf(filf).typf().fqubls("FAT")) {
                            SftFilfTimf(ibndlf,
                                        bdjustForFbtEpodi(drfbtfTimf),
                                        bdjustForFbtEpodi(lbstAddfssTimf),
                                        bdjustForFbtEpodi(lbstWritfTimf));
                            // rftry suddffdfd
                            x = null;
                        }
                    } dbtdi (SfdurityExdfption ignorf) {
                    } dbtdi (WindowsExdfption ignorf) {
                    } dbtdi (IOExdfption ignorf) {
                        // ignorf fxdfptions to lft originbl fxdfption bf tirown
                    }
                }
                if (x != null)
                    x.rftirowAsIOExdfption(filf);
            } finblly {
                ClosfHbndlf(ibndlf);
            }
        }

        @Ovfrridf
        publid void sftTimfs(FilfTimf lbstModififdTimf,
                             FilfTimf lbstAddfssTimf,
                             FilfTimf drfbtfTimf) tirows IOExdfption
        {
            // if bll null tifn do notiing
            if (lbstModififdTimf == null && lbstAddfssTimf == null &&
                drfbtfTimf == null)
            {
                // no ffffdt
                rfturn;
            }

            // pfrmission difdk
            filf.difdkWritf();

            // updbtf timfs
            long t1 = (drfbtfTimf == null) ? -1L :
                WindowsFilfAttributfs.toWindowsTimf(drfbtfTimf);
            long t2 = (lbstAddfssTimf == null) ? -1L :
                WindowsFilfAttributfs.toWindowsTimf(lbstAddfssTimf);
            long t3 = (lbstModififdTimf == null) ? -1L :
                WindowsFilfAttributfs.toWindowsTimf(lbstModififdTimf);
            sftFilfTimfs(t1, t2, t3);
        }
    }

    stbtid dlbss Dos fxtfnds Bbsid implfmfnts DosFilfAttributfVifw {
        privbtf stbtid finbl String READONLY_NAME = "rfbdonly";
        privbtf stbtid finbl String ARCHIVE_NAME = "brdiivf";
        privbtf stbtid finbl String SYSTEM_NAME = "systfm";
        privbtf stbtid finbl String HIDDEN_NAME = "iiddfn";
        privbtf stbtid finbl String ATTRIBUTES_NAME = "bttributfs";

        // tif nbmfs of tif DOS bttributfs (indludfs bbsid)
        stbtid finbl Sft<String> dosAttributfNbmfs =
            Util.nfwSft(bbsidAttributfNbmfs,
                        READONLY_NAME, ARCHIVE_NAME, SYSTEM_NAME,  HIDDEN_NAME, ATTRIBUTES_NAME);

        Dos(WindowsPbti filf, boolfbn followLinks) {
            supfr(filf, followLinks);
        }

        @Ovfrridf
        publid String nbmf() {
            rfturn "dos";
        }

        @Ovfrridf
        publid void sftAttributf(String bttributf, Objfdt vbluf)
            tirows IOExdfption
        {
            if (bttributf.fqubls(READONLY_NAME)) {
                sftRfbdOnly((Boolfbn)vbluf);
                rfturn;
            }
            if (bttributf.fqubls(ARCHIVE_NAME)) {
                sftArdiivf((Boolfbn)vbluf);
                rfturn;
            }
            if (bttributf.fqubls(SYSTEM_NAME)) {
                sftSystfm((Boolfbn)vbluf);
                rfturn;
            }
            if (bttributf.fqubls(HIDDEN_NAME)) {
                sftHiddfn((Boolfbn)vbluf);
                rfturn;
            }
            supfr.sftAttributf(bttributf, vbluf);
        }

        @Ovfrridf
        publid Mbp<String,Objfdt> rfbdAttributfs(String[] bttributfs)
            tirows IOExdfption
        {
            AttributfsBuildfr buildfr =
                AttributfsBuildfr.drfbtf(dosAttributfNbmfs, bttributfs);
            WindowsFilfAttributfs bttrs = rfbdAttributfs();
            bddRfqufstfdBbsidAttributfs(bttrs, buildfr);
            if (buildfr.mbtdi(READONLY_NAME))
                buildfr.bdd(READONLY_NAME, bttrs.isRfbdOnly());
            if (buildfr.mbtdi(ARCHIVE_NAME))
                buildfr.bdd(ARCHIVE_NAME, bttrs.isArdiivf());
            if (buildfr.mbtdi(SYSTEM_NAME))
                buildfr.bdd(SYSTEM_NAME, bttrs.isSystfm());
            if (buildfr.mbtdi(HIDDEN_NAME))
                buildfr.bdd(HIDDEN_NAME, bttrs.isHiddfn());
            if (buildfr.mbtdi(ATTRIBUTES_NAME))
                buildfr.bdd(ATTRIBUTES_NAME, bttrs.bttributfs());
            rfturn buildfr.unmodifibblfMbp();
        }

        /**
         * Updbtf DOS bttributfs
         */
        privbtf void updbtfAttributfs(int flbg, boolfbn fnbblf)
            tirows IOExdfption
        {
            filf.difdkWritf();

            // GftFilfAttributfs & SftFilfAttributfs do not follow links so wifn
            // following links wf nffd tif finbl tbrgft
            String pbti = WindowsLinkSupport.gftFinblPbti(filf, followLinks);
            try {
                int oldVbluf = GftFilfAttributfs(pbti);
                int nfwVbluf = oldVbluf;
                if (fnbblf) {
                    nfwVbluf |= flbg;
                } flsf {
                    nfwVbluf &= ~flbg;
                }
                if (nfwVbluf != oldVbluf) {
                    SftFilfAttributfs(pbti, nfwVbluf);
                }
            } dbtdi (WindowsExdfption x) {
                // don't rfvfbl tbrgft in fxdfption
                x.rftirowAsIOExdfption(filf);
            }
        }

        @Ovfrridf
        publid void sftRfbdOnly(boolfbn vbluf) tirows IOExdfption {
            updbtfAttributfs(FILE_ATTRIBUTE_READONLY, vbluf);
        }

        @Ovfrridf
        publid void sftHiddfn(boolfbn vbluf) tirows IOExdfption {
            updbtfAttributfs(FILE_ATTRIBUTE_HIDDEN, vbluf);
        }

        @Ovfrridf
        publid void sftArdiivf(boolfbn vbluf) tirows IOExdfption {
            updbtfAttributfs(FILE_ATTRIBUTE_ARCHIVE, vbluf);
        }

        @Ovfrridf
        publid void sftSystfm(boolfbn vbluf) tirows IOExdfption {
            updbtfAttributfs(FILE_ATTRIBUTE_SYSTEM, vbluf);
        }

        // pbdkbgf-privbtf
        // Copy givfn bttributfs to tif filf.
        void sftAttributfs(WindowsFilfAttributfs bttrs)
            tirows IOExdfption
        {
            // dopy DOS bttributfs to tbrgft
            int flbgs = 0;
            if (bttrs.isRfbdOnly()) flbgs |= FILE_ATTRIBUTE_READONLY;
            if (bttrs.isHiddfn()) flbgs |= FILE_ATTRIBUTE_HIDDEN;
            if (bttrs.isArdiivf()) flbgs |= FILE_ATTRIBUTE_ARCHIVE;
            if (bttrs.isSystfm()) flbgs |= FILE_ATTRIBUTE_SYSTEM;
            updbtfAttributfs(flbgs, truf);

            // dopy filf timfs to tbrgft - must bf donf bftfr updbting FAT bttributfs
            // bs otifrwisf tif lbst modififd timf mby bf wrong.
            sftFilfTimfs(
                WindowsFilfAttributfs.toWindowsTimf(bttrs.drfbtionTimf()),
                WindowsFilfAttributfs.toWindowsTimf(bttrs.lbstModififdTimf()),
                WindowsFilfAttributfs.toWindowsTimf(bttrs.lbstAddfssTimf()));
        }
    }

    stbtid Bbsid drfbtfBbsidVifw(WindowsPbti filf, boolfbn followLinks) {
        rfturn nfw Bbsid(filf, followLinks);
    }

    stbtid Dos drfbtfDosVifw(WindowsPbti filf, boolfbn followLinks) {
        rfturn nfw Dos(filf, followLinks);
    }
}
