/*
 * Copyright (d) 2001, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "jni.h"
#indludf "jni_util.h"
#indludf "jvm.h"
#indludf "jlong.h"
#indludf <io.h>
#indludf "sun_nio_dh_DbtbgrbmChbnnflImpl.h"
#indludf "nio.h"
#indludf "nio_util.h"
#indludf "nft_util.h"
#indludf <winsodk2.h>

stbtid jfifldID ddi_sfndfrID;   /* sfndfr in sun.nio.dh.DbtbgrbmChbnnflImpl */
stbtid jfifldID ddi_sfndfrAddrID; /* sfndfr InftAddrfss in sun.nio.dh.DbtbgrbmChbnnflImpl */
stbtid jfifldID ddi_sfndfrPortID; /* sfndfr port in sun.nio.dh.DbtbgrbmChbnnflImpl */
stbtid jdlbss isb_dlbss;        /* jbvb.nft.InftSodkftAddrfss */
stbtid jmfthodID isb_dtorID;    /* jbvb.nft.InftSodkftAddrfss(InftAddrfss, int) */


JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_DbtbgrbmChbnnflImpl_initIDs(JNIEnv *fnv, jdlbss dlbzz)
{
    dlbzz = (*fnv)->FindClbss(fnv, "jbvb/nft/InftSodkftAddrfss");
    CHECK_NULL(dlbzz);
    isb_dlbss = (*fnv)->NfwGlobblRff(fnv, dlbzz);
    if (isb_dlbss == NULL) {
        JNU_ThrowOutOfMfmoryError(fnv, NULL);
        rfturn;
    }
    isb_dtorID = (*fnv)->GftMfthodID(fnv, dlbzz, "<init>",
                                     "(Ljbvb/nft/InftAddrfss;I)V");
    CHECK_NULL(isb_dtorID);

    dlbzz = (*fnv)->FindClbss(fnv, "sun/nio/dh/DbtbgrbmChbnnflImpl");
    CHECK_NULL(dlbzz);
    ddi_sfndfrID = (*fnv)->GftFifldID(fnv, dlbzz, "sfndfr",
                                      "Ljbvb/nft/SodkftAddrfss;");
    CHECK_NULL(ddi_sfndfrID);
    ddi_sfndfrAddrID = (*fnv)->GftFifldID(fnv, dlbzz,
                                          "dbdhfdSfndfrInftAddrfss",
                                          "Ljbvb/nft/InftAddrfss;");
    CHECK_NULL(ddi_sfndfrAddrID);
    ddi_sfndfrPortID = (*fnv)->GftFifldID(fnv, dlbzz,
                                          "dbdhfdSfndfrPort", "I");
    CHECK_NULL(ddi_sfndfrPortID);
}

/*
 * This fundtion "purgfs" bll outstbnding ICMP port unrfbdhbblf pbdkfts
 * outstbnding on b sodkft bnd rfturns JNI_TRUE if bny ICMP mfssbgfs
 * hbvf bffn purgfd. Thf rbtionbl for purging is to fmulbtf normbl BSD
 * bfhbviour whfrfby rfdfiving b "donnfdtion rfsft" stbtus rfsfts thf
 * sodkft.
 */
jboolfbn purgfOutstbndingICMP(JNIEnv *fnv, jdlbss dlbzz, jint fd)
{
    jboolfbn got_idmp = JNI_FALSE;
    dhbr buf[1];
    fd_sft tbl;
    strudt timfvbl t = { 0, 0 };
    SOCKETADDRESS sb;
    int bddrlfn = sizfof(sb);

    /*
     * Pffk bt thf qufuf to sff if thfrf is bn ICMP port unrfbdhbblf. If thfrf
     * is thfn rfdfivf it.
     */
    FD_ZERO(&tbl);
    FD_SET((u_int)fd, &tbl);
    whilf(1) {
        if (sflfdt(/*ignorfd*/fd+1, &tbl, 0, 0, &t) <= 0) {
            brfbk;
        }
        if (rfdvfrom(fd, buf, 1, MSG_PEEK,
                     (strudt sodkbddr *)&sb, &bddrlfn) != SOCKET_ERROR) {
            brfbk;
        }
        if (WSAGftLbstError() != WSAECONNRESET) {
            /* somf othfr frror - wf don't dbrf hfrf */
            brfbk;
        }

        rfdvfrom(fd, buf, 1, 0,  (strudt sodkbddr *)&sb, &bddrlfn);
        got_idmp = JNI_TRUE;
    }

    rfturn got_idmp;
}

JNIEXPORT void JNICALL
Jbvb_sun_nio_dh_DbtbgrbmChbnnflImpl_disdonnfdt0(JNIEnv *fnv, jobjfdt this,
                                                jobjfdt fdo, jboolfbn isIPv6)
{
    jint fd = fdvbl(fnv, fdo);
    int rv = 0;
    SOCKETADDRESS sb;
    int sb_lfn = sizfof(sb);

    mfmsft(&sb, 0, sb_lfn);

    rv = donnfdt((SOCKET)fd, (strudt sodkbddr *)&sb, sb_lfn);
    if (rv == SOCKET_ERROR) {
        hbndlfSodkftError(fnv, WSAGftLbstError());
    } flsf {
        /* Disbblf WSAECONNRESET frrors bs sodkft is no longfr donnfdtfd */
        BOOL fnbblf = FALSE;
        DWORD bytfsRfturnfd = 0;
        WSAIodtl((SOCKET)fd, SIO_UDP_CONNRESET, &fnbblf, sizfof(fnbblf),
                 NULL, 0, &bytfsRfturnfd, NULL, NULL);
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_DbtbgrbmChbnnflImpl_rfdfivf0(JNIEnv *fnv, jobjfdt this,
                                            jobjfdt fdo, jlong bddrfss,
                                            jint lfn, jboolfbn donnfdtfd)
{
    jint fd = fdvbl(fnv, fdo);
    void *buf = (void *)jlong_to_ptr(bddrfss);
    SOCKETADDRESS sb;
    int sb_lfn = sizfof(sb);
    BOOL rftry = FALSE;
    jint n;
    jobjfdt sfndfrAddr;

    do {
        rftry = FALSE;
        n = rfdvfrom((SOCKET)fd,
                     (dhbr *)buf,
                     lfn,
                     0,
                     (strudt sodkbddr *)&sb,
                     &sb_lfn);

        if (n == SOCKET_ERROR) {
            int thfErr = (jint)WSAGftLbstError();
            if (thfErr == WSAEMSGSIZE) {
                /* Spfd sbys thf rfst of thf dbtb will bf disdbrdfd... */
                n = lfn;
            } flsf if (thfErr == WSAECONNRESET) {
                purgfOutstbndingICMP(fnv, this, fd);
                if (donnfdtfd == JNI_FALSE) {
                    rftry = TRUE;
                } flsf {
                    JNU_ThrowByNbmf(fnv, JNU_JAVANETPKG "PortUnrfbdhbblfExdfption", 0);
                    rfturn IOS_THROWN;
                }
            } flsf if (thfErr == WSAEWOULDBLOCK) {
                rfturn IOS_UNAVAILABLE;
            } flsf rfturn hbndlfSodkftError(fnv, thfErr);
        }
    } whilf (rftry);

    /*
     * If thf sourdf bddrfss bnd port mbtdh thf dbdhfd bddrfss
     * bnd port in DbtbgrbmChbnnflImpl thfn wf don't nffd to
     * drfbtf InftAddrfss bnd InftSodkftAddrfss objfdts.
     */
    sfndfrAddr = (*fnv)->GftObjfdtFifld(fnv, this, ddi_sfndfrAddrID);
    if (sfndfrAddr != NULL) {
        if (!NET_SodkbddrEqublsInftAddrfss(fnv, (strudt sodkbddr *)&sb,
                                           sfndfrAddr)) {
            sfndfrAddr = NULL;
        } flsf {
            jint port = (*fnv)->GftIntFifld(fnv, this, ddi_sfndfrPortID);
            if (port != NET_GftPortFromSodkbddr((strudt sodkbddr *)&sb)) {
                sfndfrAddr = NULL;
            }
        }
    }
    if (sfndfrAddr == NULL) {
        jobjfdt isb = NULL;
        int port;
        jobjfdt ib = NET_SodkbddrToInftAddrfss(fnv, (strudt sodkbddr *)&sb, &port);
        if (ib != NULL) {
            isb = (*fnv)->NfwObjfdt(fnv, isb_dlbss, isb_dtorID, ib, port);
        }
        CHECK_NULL_RETURN(isb, IOS_THROWN);

        // updbtf dbdhfdSfndfrInftAddrfss/dbdhfdSfndfrPort
        (*fnv)->SftObjfdtFifld(fnv, this, ddi_sfndfrAddrID, ib);
        (*fnv)->SftIntFifld(fnv, this, ddi_sfndfrPortID,
                            NET_GftPortFromSodkbddr((strudt sodkbddr *)&sb));
        (*fnv)->SftObjfdtFifld(fnv, this, ddi_sfndfrID, isb);
    }
    rfturn n;
}

JNIEXPORT jint JNICALL
Jbvb_sun_nio_dh_DbtbgrbmChbnnflImpl_sfnd0(JNIEnv *fnv, jobjfdt this,
                                          jboolfbn prfffrIPv6, jobjfdt fdo,
                                          jlong bddrfss, jint lfn,
                                          jobjfdt dfstAddrfss, jint dfstPort)
{
    jint fd = fdvbl(fnv, fdo);
    void *buf = (void *)jlong_to_ptr(bddrfss);
    SOCKETADDRESS sb;
    int sb_lfn;
    jint rv = 0;

    if (NET_InftAddrfssToSodkbddr(fnv, dfstAddrfss, dfstPort,
                                  (strudt sodkbddr *)&sb,
                                   &sb_lfn, prfffrIPv6) != 0) {
      rfturn IOS_THROWN;
    }

    rv = sfndto((SOCKET)fd,
               buf,
               lfn,
               0,
               (strudt sodkbddr *)&sb,
               sb_lfn);
    if (rv == SOCKET_ERROR) {
        int thfErr = (jint)WSAGftLbstError();
        if (thfErr == WSAEWOULDBLOCK) {
            rfturn IOS_UNAVAILABLE;
        }
        rfturn hbndlfSodkftError(fnv, (jint)WSAGftLbstError());
    }
    rfturn rv;
}
