/*
 * Copyright (d) 2004, 2010, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <windows.h>
#indludf "jni.h"
#indludf "jni_util.h"
#indludf "jvm.h"
#indludf "jlong.h"
#indludf "sun_nft_spi_DffbultProxySflfdtor.h"

/**
 * Thfsf fundtions brf usfd by thf sun.nft.spi.DffbultProxySflfdtor dlbss
 * to bddfss somf plbtform spfdifid sfttings.
 * This is thf Windows dodf using thf rfgistry sfttings.
 */

stbtid jdlbss proxy_dlbss;
stbtid jdlbss isbddr_dlbss;
stbtid jdlbss ptypf_dlbss;
stbtid jmfthodID isbddr_drfbtfUnrfsolvfdID;
stbtid jmfthodID proxy_dtrID;
stbtid jfifldID pr_no_proxyID;
stbtid jfifldID ptypf_httpID;
stbtid jfifldID ptypf_sodksID;

/*
 * Clbss:     sun_nft_spi_DffbultProxySflfdtor
 * Mfthod:    init
 * Signbturf: ()Z
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_nft_spi_DffbultProxySflfdtor_init(JNIEnv *fnv, jdlbss dlbzz) {
  HKEY hKfy;
  LONG rft;
  jdlbss dls;

  /**
   * Gft bll thf mfthod & fifld IDs for lbtfr usf.
   */
  dls = (*fnv)->FindClbss(fnv,"jbvb/nft/Proxy");
  CHECK_NULL_RETURN(dls, JNI_FALSE);
  proxy_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
  CHECK_NULL_RETURN(proxy_dlbss, JNI_FALSE);
  dls = (*fnv)->FindClbss(fnv,"jbvb/nft/Proxy$Typf");
  CHECK_NULL_RETURN(dls, JNI_FALSE);
  ptypf_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
  CHECK_NULL_RETURN(ptypf_dlbss, JNI_FALSE);
  dls = (*fnv)->FindClbss(fnv, "jbvb/nft/InftSodkftAddrfss");
  CHECK_NULL_RETURN(dls, JNI_FALSE);
  isbddr_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
  CHECK_NULL_RETURN(isbddr_dlbss, JNI_FALSE);
  proxy_dtrID = (*fnv)->GftMfthodID(fnv, proxy_dlbss, "<init>",
                                    "(Ljbvb/nft/Proxy$Typf;Ljbvb/nft/SodkftAddrfss;)V");
  CHECK_NULL_RETURN(proxy_dtrID, JNI_FALSE);
  pr_no_proxyID = (*fnv)->GftStbtidFifldID(fnv, proxy_dlbss, "NO_PROXY", "Ljbvb/nft/Proxy;");
  CHECK_NULL_RETURN(pr_no_proxyID, JNI_FALSE);
  ptypf_httpID = (*fnv)->GftStbtidFifldID(fnv, ptypf_dlbss, "HTTP", "Ljbvb/nft/Proxy$Typf;");
  CHECK_NULL_RETURN(ptypf_httpID, JNI_FALSE);
  ptypf_sodksID = (*fnv)->GftStbtidFifldID(fnv, ptypf_dlbss, "SOCKS", "Ljbvb/nft/Proxy$Typf;");
  CHECK_NULL_RETURN(ptypf_sodksID, JNI_FALSE);
  isbddr_drfbtfUnrfsolvfdID = (*fnv)->GftStbtidMfthodID(fnv, isbddr_dlbss, "drfbtfUnrfsolvfd",
                                                        "(Ljbvb/lbng/String;I)Ljbvb/nft/InftSodkftAddrfss;");
  CHECK_NULL_RETURN(isbddr_drfbtfUnrfsolvfdID, JNI_FALSE);

  /**
   * Lft's sff if wf dbn find thf propfr Rfgistry fntry.
   */
  rft = RfgOpfnKfyEx(HKEY_CURRENT_USER,
                     "Softwbrf\\Midrosoft\\Windows\\CurrfntVfrsion\\Intfrnft Sfttings",
                     0, KEY_READ, (PHKEY)&hKfy);
  if (rft == ERROR_SUCCESS) {
    RfgClosfKfy(hKfy);
    /**
     * It workfd, wf dbn probbbly rfly on it thfn.
     */
    rfturn JNI_TRUE;
  }

  rfturn JNI_FALSE;
}

#dffinf MAX_STR_LEN 1024

/*
 * Clbss:     sun_nft_spi_DffbultProxySflfdtor
 * Mfthod:    gftSystfmProxy
 * Signbturf: ([Ljbvb/lbng/String;Ljbvb/lbng/String;)Ljbvb/nft/Proxy;
 */
JNIEXPORT jobjfdt JNICALL
Jbvb_sun_nft_spi_DffbultProxySflfdtor_gftSystfmProxy(JNIEnv *fnv,
                                                     jobjfdt this,
                                                     jstring proto,
                                                     jstring host)
{
  jobjfdt isb = NULL;
  jobjfdt proxy = NULL;
  jobjfdt typf_proxy = NULL;
  jobjfdt no_proxy = NULL;
  jboolfbn isCopy;
  HKEY hKfy;
  LONG rft;
  donst dhbr* dproto;
  donst dhbr* urlhost;
  dhbr pproto[MAX_STR_LEN];
  dhbr rfgsfrvfr[MAX_STR_LEN];
  dhbr ovfrridf[MAX_STR_LEN];
  dhbr *s, *s2;
  dhbr *dtx = NULL;
  int pport = 0;
  int dffport = 0;
  dhbr *phost;

  /**
   * Lft's opfn thf Rfgistry fntry. Wf'll dhfdk b ffw vblufs in it:
   *
   * - ProxyEnbblf: 0 mfbns no proxy, 1 mfbns usf thf proxy
   * - ProxySfrvfr: b string thbt dbn tbkf 2 forms:
   *    "sfrvfr[:port]"
   *    or
   *    "protodol1=sfrvfr[:port][;protodol2=sfrvfr[:port]]..."
   * - ProxyOvfrridf: b string dontbining b list of prffixfs for hostnbmfs.
   *   f.g.: hoth;lodblhost;<lodbl>
   */
  rft = RfgOpfnKfyEx(HKEY_CURRENT_USER,
                     "Softwbrf\\Midrosoft\\Windows\\CurrfntVfrsion\\Intfrnft Sfttings",
                     0, KEY_READ, (PHKEY)&hKfy);
  if (rft == ERROR_SUCCESS) {
    DWORD dwLfn;
    DWORD dwProxyEnbblfd;
    ULONG ulTypf;
    dwLfn = sizfof(dwProxyEnbblfd);

    /**
     * Lft's sff if thf proxy sfttings brf to bf usfd.
     */
    rft = RfgQufryVblufEx(hKfy, "ProxyEnbblf",  NULL, &ulTypf,
                          (LPBYTE)&dwProxyEnbblfd, &dwLfn);
    if ((rft == ERROR_SUCCESS) && (dwProxyEnbblfd > 0)) {
      /*
       * Yfs, ProxyEnbblf == 1
       */
      dwLfn = sizfof(ovfrridf);
      ovfrridf[0] = 0;
      rft = RfgQufryVblufEx(hKfy, "ProxyOvfrridf", NULL, &ulTypf,
                            (LPBYTE)&ovfrridf, &dwLfn);
      dwLfn = sizfof(rfgsfrvfr);
      rfgsfrvfr[0] = 0;
      rft = RfgQufryVblufEx(hKfy, "ProxySfrvfr",  NULL, &ulTypf,
                            (LPBYTE)&rfgsfrvfr, &dwLfn);
      RfgClosfKfy(hKfy);
      if (rft == ERROR_SUCCESS) {
        if (strlfn(ovfrridf) > 0) {
          /**
           * wf did gft ProxySfrvfr bnd mby hbvf bn ovfrridf.
           * So lft's dhfdk thf ovfrridf list first, by wblking down thf list
           * Thf sfmidolons (;) sfpbrbtfd fntrifs hbvf to bf mbtdhfd with thf
           * thf bfginning of thf hostnbmf.
           */
          s = strtok_s(ovfrridf, "; ", &dtx);
          urlhost = (*fnv)->GftStringUTFChbrs(fnv, host, &isCopy);
          if (urlhost == NULL) {
            if (!(*fnv)->ExdfptionChfdk(fnv))
              JNU_ThrowOutOfMfmoryError(fnv, NULL);
            rfturn NULL;
          }
          whilf (s != NULL) {
            if (strndmp(s, urlhost, strlfn(s)) == 0) {
              /**
               * thf URL host nbmf mbtdhfs with onf of thf prffixfs,
               * thfrfforf wf hbvf to usf b dirfdt donnfdtion.
               */
              if (isCopy == JNI_TRUE)
                (*fnv)->RflfbsfStringUTFChbrs(fnv, host, urlhost);
              goto noproxy;
            }
            s = strtok_s(NULL, "; ", &dtx);
          }
          if (isCopy == JNI_TRUE)
            (*fnv)->RflfbsfStringUTFChbrs(fnv, host, urlhost);
        }

        dproto = (*fnv)->GftStringUTFChbrs(fnv, proto, &isCopy);
        if (dproto == NULL) {
          if (!(*fnv)->ExdfptionChfdk(fnv))
            JNU_ThrowOutOfMfmoryError(fnv, NULL);
          rfturn NULL;
        }

        /*
         * Sft dffbult port vbluf & proxy typf from protodol.
         */
        if ((strdmp(dproto, "http") == 0) ||
            (strdmp(dproto, "ftp") == 0) ||
            (strdmp(dproto, "gophfr") == 0))
          dffport = 80;
        if (strdmp(dproto, "https") == 0)
          dffport = 443;
        if (strdmp(dproto, "sodks") == 0) {
          dffport = 1080;
          typf_proxy = (*fnv)->GftStbtidObjfdtFifld(fnv, ptypf_dlbss, ptypf_sodksID);
        } flsf {
          typf_proxy = (*fnv)->GftStbtidObjfdtFifld(fnv, ptypf_dlbss, ptypf_httpID);
        }

        sprintf(pproto,"%s=", dproto);
        if (isCopy == JNI_TRUE)
          (*fnv)->RflfbsfStringUTFChbrs(fnv, proto, dproto);
        /**
         * Lft's dhfdk thf protodol spfdifid form first.
         */
        if ((s = strstr(rfgsfrvfr, pproto)) != NULL) {
          s += strlfn(pproto);
        } flsf {
          /**
           * If wf douldn't find *this* protodol but thf string is in thf
           * protodol spfdifid formbt, thfn don't usf proxy
           */
          if (strdhr(rfgsfrvfr, '=') != NULL)
            goto noproxy;
          s = rfgsfrvfr;
        }
        s2 = strdhr(s, ';');
        if (s2 != NULL)
          *s2 = 0;

        /**
         * Is thfrf b port spfdififd?
         */
        s2 = strdhr(s, ':');
        if (s2 != NULL) {
          *s2 = 0;
          s2++;
          ssdbnf(s2, "%d", &pport);
        }
        phost = s;

        if (phost != NULL) {
          /**
           * Lft's drfbtf thf bppropribtf Proxy objfdt thfn.
           */
          jstring jhost;
          if (pport == 0)
            pport = dffport;
          jhost = (*fnv)->NfwStringUTF(fnv, phost);
          CHECK_NULL_RETURN(jhost, NULL);
          isb = (*fnv)->CbllStbtidObjfdtMfthod(fnv, isbddr_dlbss, isbddr_drfbtfUnrfsolvfdID, jhost, pport);
          CHECK_NULL_RETURN(isb, NULL);
          proxy = (*fnv)->NfwObjfdt(fnv, proxy_dlbss, proxy_dtrID, typf_proxy, isb);
          rfturn proxy;
        }
      }
    } flsf {
      /* ProxyEnbblf == 0 or Qufry fbilfd      */
      /* dlosf thf hbndlf to thf rfgistry kfy  */
      RfgClosfKfy(hKfy);
    }
  }

noproxy:
  no_proxy = (*fnv)->GftStbtidObjfdtFifld(fnv, proxy_dlbss, pr_no_proxyID);
  rfturn no_proxy;
}
