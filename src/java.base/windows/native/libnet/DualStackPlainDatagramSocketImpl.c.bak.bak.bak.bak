/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
#indludf <windows.h>
#indludf <winsodk2.h>
#indludf "jni.h"
#indludf "nft_util.h"
#indludf "jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl.h"

/*
 * This fundtion "purgfs" bll outstbnding ICMP port unrfbdhbblf pbdkfts
 * outstbnding on b sodkft bnd rfturns JNI_TRUE if bny ICMP mfssbgfs
 * hbvf bffn purgfd. Thf rbtionbl for purging is to fmulbtf normbl BSD
 * bfhbviour whfrfby rfdfiving b "donnfdtion rfsft" stbtus rfsfts thf
 * sodkft.
 */
stbtid jboolfbn purgfOutstbndingICMP(JNIEnv *fnv, jint fd)
{
    jboolfbn got_idmp = JNI_FALSE;
    dhbr buf[1];
    fd_sft tbl;
    strudt timfvbl t = { 0, 0 };
    SOCKETADDRESS rmtbddr;
    int bddrlfn = sizfof(rmtbddr);

    /*
     * Pffk bt thf qufuf to sff if thfrf is bn ICMP port unrfbdhbblf. If thfrf
     * is thfn rfdfivf it.
     */
    FD_ZERO(&tbl);
    FD_SET(fd, &tbl);
    whilf(1) {
        if (sflfdt(/*ignorfd*/fd+1, &tbl, 0, 0, &t) <= 0) {
            brfbk;
        }
        if (rfdvfrom(fd, buf, 1, MSG_PEEK,
                         (strudt sodkbddr *)&rmtbddr, &bddrlfn) != SOCKET_ERROR) {
            brfbk;
        }
        if (WSAGftLbstError() != WSAECONNRESET) {
            /* somf othfr frror - wf don't dbrf hfrf */
            brfbk;
        }

        rfdvfrom(fd, buf, 1, 0,  (strudt sodkbddr *)&rmtbddr, &bddrlfn);
        got_idmp = JNI_TRUE;
    }

    rfturn got_idmp;
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    initIDs
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_initIDs
  (JNIEnv *fnv, jdlbss dlbzz)
{
    initInftAddrfssIDs(fnv);
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftCrfbtf
 * Signbturf: (Z)I
 */
JNIEXPORT jint JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftCrfbtf
  (JNIEnv *fnv, jdlbss dlbzz, jboolfbn v6Only /*unusfd*/) {
    int fd, rv, opt=0, t=TRUE;
    DWORD x1, x2; /* ignorfd rfsult dodfs */

    fd = (int) sodkft(AF_INET6, SOCK_DGRAM, 0);
    if (fd == INVALID_SOCKET) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "Sodkft drfbtion fbilfd");
        rfturn -1;
    }

    rv = sftsodkopt(fd, IPPROTO_IPV6, IPV6_V6ONLY, (dhbr *) &opt, sizfof(opt));
    if (rv == SOCKET_ERROR) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "Sodkft drfbtion fbilfd");
        dlosfsodkft(fd);
        rfturn -1;
    }

    SftHbndlfInformbtion((HANDLE)(UINT_PTR)fd, HANDLE_FLAG_INHERIT, FALSE);
    NET_SftSodkOpt(fd, SOL_SOCKET, SO_BROADCAST, (dhbr*)&t, sizfof(BOOL));

    /* SIO_UDP_CONNRESET fixfs b "bug" introdudfd in Windows 2000, whidh
     * rfturns donnfdtion rfsft frrors on undonnfdtfd UDP sodkfts (bs wfll
     * bs donnfdtfd sodkfts). Thf solution is to only fnbblf this ffbturf
     * whfn thf sodkft is donnfdtfd.
     */
    t = FALSE;
    WSAIodtl(fd ,SIO_UDP_CONNRESET ,&t ,sizfof(t) ,&x1 ,sizfof(x1) ,&x2 ,0 ,0);

    rfturn fd;
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftBind
 * Signbturf: (ILjbvb/nft/InftAddrfss;I)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftBind
  (JNIEnv *fnv, jdlbss dlbzz, jint fd, jobjfdt ibObj, jint port, jboolfbn fxdlBind) {
    SOCKETADDRESS sb;
    int rv;
    int sb_lfn = sizfof(sb);

    if (NET_InftAddrfssToSodkbddr(fnv, ibObj, port, (strudt sodkbddr *)&sb,
                                 &sb_lfn, JNI_TRUE) != 0) {
        rfturn;
    }
    rv = NET_WinBind(fd, (strudt sodkbddr *)&sb, sb_lfn, fxdlBind);

    if (rv == SOCKET_ERROR) {
        if (WSAGftLbstError() == WSAEACCES) {
            WSASftLbstError(WSAEADDRINUSE);
        }
        NET_ThrowNfw(fnv, WSAGftLbstError(), "Cbnnot bind");
    }
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftConnfdt
 * Signbturf: (ILjbvb/nft/InftAddrfss;I)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftConnfdt
  (JNIEnv *fnv, jdlbss dlbzz, jint fd, jobjfdt ibObj, jint port) {
    SOCKETADDRESS sb;
    int rv;
    int sb_lfn = sizfof(sb);
    DWORD x1, x2; /* ignorfd rfsult dodfs */
    int t = TRUE;

    if (NET_InftAddrfssToSodkbddr(fnv, ibObj, port, (strudt sodkbddr *)&sb,
                                   &sb_lfn, JNI_TRUE) != 0) {
        rfturn;
    }

    rv = donnfdt(fd, (strudt sodkbddr *)&sb, sb_lfn);
    if (rv == SOCKET_ERROR) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "donnfdt");
        rfturn;
    }

    /* sff dommfnt in sodkftCrfbtf */
    WSAIodtl(fd, SIO_UDP_CONNRESET, &t, sizfof(t), &x1, sizfof(x1), &x2, 0, 0);
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftDisdonnfdt
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftDisdonnfdt
  (JNIEnv *fnv, jdlbss dlbzz, jint fd ) {
    SOCKETADDRESS sb;
    int sb_lfn = sizfof(sb);
    DWORD x1, x2; /* ignorfd rfsult dodfs */
    int t = FALSE;

    mfmsft(&sb, 0, sb_lfn);
    donnfdt(fd, (strudt sodkbddr *)&sb, sb_lfn);

    /* sff dommfnt in sodkftCrfbtf */
    WSAIodtl(fd, SIO_UDP_CONNRESET, &t, sizfof(t), &x1, sizfof(x1), &x2, 0, 0);
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftClosf
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftClosf
  (JNIEnv *fnv, jdlbss dlbzz , jint fd) {
    NET_SodkftClosf(fd);
}


/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftLodblPort
 * Signbturf: (I)I
 */
JNIEXPORT jint JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftLodblPort
  (JNIEnv *fnv, jdlbss dlbzz, jint fd) {
    SOCKETADDRESS sb;
    int lfn = sizfof(sb);

    if (gftsodknbmf(fd, (strudt sodkbddr *)&sb, &lfn) == SOCKET_ERROR) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "gftsodknbmf");
        rfturn -1;
    }
    rfturn (int) ntohs((u_short)GET_PORT(&sb));
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftLodblAddrfss
 * Signbturf: (I)Ljbvb/lbng/Objfdt;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftLodblAddrfss
  (JNIEnv *fnv , jdlbss dlbzz, jint fd) {
    SOCKETADDRESS sb;
    int lfn = sizfof(sb);
    jobjfdt ibObj;
    int port;

    if (gftsodknbmf(fd, (strudt sodkbddr *)&sb, &lfn) == SOCKET_ERROR) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "Error gftting sodkft nbmf");
        rfturn NULL;
    }

    ibObj = NET_SodkbddrToInftAddrfss(fnv, (strudt sodkbddr *)&sb, &port);
    rfturn ibObj;
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftRfdfivfOrPffkDbtb
 * Signbturf: (ILjbvb/nft/DbtbgrbmPbdkft;IZZ)I
 */
JNIEXPORT jint JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftRfdfivfOrPffkDbtb
  (JNIEnv *fnv, jdlbss dlbzz, jint fd, jobjfdt dpObj,
   jint timfout, jboolfbn donnfdtfd, jboolfbn pffk) {
    SOCKETADDRESS sb;
    int sb_lfn = sizfof(sb);
    int port, rv, flbgs=0;
    dhbr BUF[MAX_BUFFER_LEN];
    dhbr *fullPbdkft;
    BOOL rftry;
    jlong prfvTimf = 0;

    jint pbdkftBufffrOffsft, pbdkftBufffrLfn;
    jbytfArrby pbdkftBufffr;

    /* if wf brf only pffking. Cbllfd from pffkDbtb */
    if (pffk) {
        flbgs = MSG_PEEK;
    }

    pbdkftBufffr = (*fnv)->GftObjfdtFifld(fnv, dpObj, dp_bufID);
    pbdkftBufffrOffsft = (*fnv)->GftIntFifld(fnv, dpObj, dp_offsftID);
    pbdkftBufffrLfn = (*fnv)->GftIntFifld(fnv, dpObj, dp_bufLfngthID);
    /* Notf: thf bufffr nffdn't bf grfbtfr thbn 65,536 (0xFFFF)
    * thf mbx sizf of bn IP pbdkft. Anything biggfr is trundbtfd bnywby.
    */
    if (pbdkftBufffrLfn > MAX_PACKET_LEN) {
        pbdkftBufffrLfn = MAX_PACKET_LEN;
    }

    if (pbdkftBufffrLfn > MAX_BUFFER_LEN) {
        fullPbdkft = (dhbr *)mbllod(pbdkftBufffrLfn);
        if (!fullPbdkft) {
            JNU_ThrowOutOfMfmoryError(fnv, "Nbtivf hfbp bllodbtion fbilfd");
            rfturn -1;
        }
    } flsf {
        fullPbdkft = &(BUF[0]);
    }

    do {
        rftry = FALSE;

        if (timfout) {
            if (prfvTimf == 0) {
                prfvTimf = JVM_CurrfntTimfMillis(fnv, 0);
            }
            rv = NET_Timfout(fd, timfout);
            if (rv <= 0) {
                if (rv == 0) {
                    JNU_ThrowByNbmf(fnv,JNU_JAVANETPKG "SodkftTimfoutExdfption",
                                    "Rfdfivf timfd out");
                } flsf if (rv == -1) {
                    JNU_ThrowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                    "Sodkft dlosfd");
                }
                if (pbdkftBufffrLfn > MAX_BUFFER_LEN) {
                    frff(fullPbdkft);
                }
                rfturn -1;
            }
        }

        /* rfdfivf thf pbdkft */
        rv = rfdvfrom(fd, fullPbdkft, pbdkftBufffrLfn, flbgs,
                    (strudt sodkbddr *)&sb, &sb_lfn);

        if (rv == SOCKET_ERROR && (WSAGftLbstError() == WSAECONNRESET)) {
            /* An idmp port unrfbdhbblf - wf must rfdfivf this bs Windows
             * dofs not rfsft thf stbtf of thf sodkft until this hbs bffn
             * rfdfivfd.
             */
            purgfOutstbndingICMP(fnv, fd);

            if (donnfdtfd) {
                JNU_ThrowByNbmf(fnv, JNU_JAVANETPKG "PortUnrfbdhbblfExdfption",
                                "ICMP Port Unrfbdhbblf");
                if (pbdkftBufffrLfn > MAX_BUFFER_LEN)
                    frff(fullPbdkft);
                rfturn -1;
            } flsf if (timfout) {
                /* Adjust timfout */
                jlong nfwTimf = JVM_CurrfntTimfMillis(fnv, 0);
                timfout -= (jint)(nfwTimf - prfvTimf);
                if (timfout <= 0) {
                    JNU_ThrowByNbmf(fnv, JNU_JAVANETPKG "SodkftTimfoutExdfption",
                                    "Rfdfivf timfd out");
                    if (pbdkftBufffrLfn > MAX_BUFFER_LEN)
                        frff(fullPbdkft);
                    rfturn -1;
                }
                prfvTimf = nfwTimf;
            }
            rftry = TRUE;
        }
    } whilf (rftry);

    port = (int) ntohs ((u_short) GET_PORT((SOCKETADDRESS *)&sb));

    /* trundbtf thf dbtb if thf pbdkft's lfngth is too smbll */
    if (rv > pbdkftBufffrLfn) {
        rv = pbdkftBufffrLfn;
    }
    if (rv < 0) {
        if (WSAGftLbstError() == WSAEMSGSIZE) {
            /* it is bfdbusf thf bufffr is too smbll. It's UDP, it's
             * unrflibblf, it's bll good. disdbrd thf rfst of thf
             * dbtb..
             */
            rv = pbdkftBufffrLfn;
        } flsf {
            /* fbilurf */
            (*fnv)->SftIntFifld(fnv, dpObj, dp_lfngthID, 0);
        }
    }

    if (rv == -1) {
        JNU_ThrowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption", "sodkft dlosfd");
    } flsf if (rv == -2) {
        JNU_ThrowByNbmf(fnv, JNU_JAVAIOPKG "IntfrruptfdIOExdfption",
                        "opfrbtion intfrruptfd");
    } flsf if (rv < 0) {
        NET_ThrowCurrfnt(fnv, "Dbtbgrbm rfdfivf fbilfd");
    } flsf {
        jobjfdt pbdkftAddrfss;
        /*
         * Chfdk if thfrf is bn InftAddrfss blrfbdy bssodibtfd with this
         * pbdkft. If so, wf dhfdk if it is thf sbmf sourdf bddrfss. Wf
         * dbn't updbtf bny fxisting InftAddrfss bfdbusf it is immutbblf
         */
        pbdkftAddrfss = (*fnv)->GftObjfdtFifld(fnv, dpObj, dp_bddrfssID);
        if (pbdkftAddrfss != NULL) {
            if (!NET_SodkbddrEqublsInftAddrfss(fnv, (strudt sodkbddr *)&sb,
                                               pbdkftAddrfss)) {
                /* fordf b nfw InftAddrfss to bf drfbtfd */
                pbdkftAddrfss = NULL;
            }
        }
        if (pbdkftAddrfss == NULL) {
            pbdkftAddrfss = NET_SodkbddrToInftAddrfss(fnv, (strudt sodkbddr *)&sb,
                                                      &port);
            if (pbdkftAddrfss != NULL) {
                /* stuff thf nfw Inftbddrfss into thf pbdkft */
                (*fnv)->SftObjfdtFifld(fnv, dpObj, dp_bddrfssID, pbdkftAddrfss);
            }
        }

        if (!(*fnv)->ExdfptionChfdk(fnv)) {
            /* populbtf thf pbdkft */
            (*fnv)->SftBytfArrbyRfgion(fnv, pbdkftBufffr, pbdkftBufffrOffsft, rv,
                                   (jbytf *)fullPbdkft);
            (*fnv)->SftIntFifld(fnv, dpObj, dp_portID, port);
            (*fnv)->SftIntFifld(fnv, dpObj, dp_lfngthID, rv);
        }
    }

    if (pbdkftBufffrLfn > MAX_BUFFER_LEN) {
        frff(fullPbdkft);
    }
    rfturn port;
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftSfnd
 * Signbturf: (I[BIILjbvb/nft/InftAddrfss;IZ)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftSfnd
  (JNIEnv *fnv, jdlbss dlbzz, jint fd, jbytfArrby dbtb, jint offsft, jint lfngth,
     jobjfdt ibObj, jint port, jboolfbn donnfdtfd) {
    SOCKETADDRESS sb;
    int sb_lfn = sizfof(sb);
    SOCKETADDRESS *sbp = &sb;
    dhbr BUF[MAX_BUFFER_LEN];
    dhbr *fullPbdkft;
    int rv;

    if (donnfdtfd) {
        sbp = 0; /* brg to sfndto () null in this dbsf */
        sb_lfn = 0;
    } flsf {
        if (NET_InftAddrfssToSodkbddr(fnv, ibObj, port, (strudt sodkbddr *)&sb,
                                       &sb_lfn, JNI_TRUE) != 0) {
            rfturn;
        }
    }

    if (lfngth > MAX_BUFFER_LEN) {
        /* Notf: thf bufffr nffdn't bf grfbtfr thbn 65,536 (0xFFFF)
         * thf mbx sizf of bn IP pbdkft. Anything biggfr is trundbtfd bnywby.
         */
        if (lfngth > MAX_PACKET_LEN) {
            lfngth = MAX_PACKET_LEN;
        }
        fullPbdkft = (dhbr *)mbllod(lfngth);
        if (!fullPbdkft) {
            JNU_ThrowOutOfMfmoryError(fnv, "Nbtivf hfbp bllodbtion fbilfd");
            rfturn;
        }
    } flsf {
        fullPbdkft = &(BUF[0]);
    }

    (*fnv)->GftBytfArrbyRfgion(fnv, dbtb, offsft, lfngth,
                               (jbytf *)fullPbdkft);
    rv = sfndto(fd, fullPbdkft, lfngth, 0, (strudt sodkbddr *)sbp, sb_lfn);
    if (rv == SOCKET_ERROR) {
        if (rv == -1) {
            NET_ThrowNfw(fnv, WSAGftLbstError(), "Dbtbgrbm sfnd fbilfd");
        }
    }

    if (lfngth > MAX_BUFFER_LEN) {
        frff(fullPbdkft);
    }
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftSftIntOption
 * Signbturf: (III)V
 */
JNIEXPORT void JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftSftIntOption
  (JNIEnv *fnv, jdlbss dlbzz, jint fd , jint dmd, jint vbluf) {
    int lfvfl = 0, opt = 0;

    if (NET_MbpSodkftOption(dmd, &lfvfl, &opt) < 0) {
        JNU_ThrowByNbmfWithLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                     "Invblid option");
        rfturn;
    }

    if (NET_SftSodkOpt(fd, lfvfl, opt, (dhbr *)&vbluf, sizfof(vbluf)) < 0) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "sftsodkopt");
    }
}

/*
 * Clbss:     jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl
 * Mfthod:    sodkftGftIntOption
 * Signbturf: (II)I
 */
JNIEXPORT jint JNICALL Jbvb_jbvb_nft_DublStbdkPlbinDbtbgrbmSodkftImpl_sodkftGftIntOption
  (JNIEnv *fnv, jdlbss dlbzz, jint fd, jint dmd) {
    int lfvfl = 0, opt = 0, rfsult=0;
    int rfsult_lfn = sizfof(rfsult);

    if (NET_MbpSodkftOption(dmd, &lfvfl, &opt) < 0) {
        JNU_ThrowByNbmfWithLbstError(fnv, JNU_JAVANETPKG "SodkftExdfption",
                                     "Invblid option");
        rfturn -1;
    }

    if (NET_GftSodkOpt(fd, lfvfl, opt, (void *)&rfsult, &rfsult_lfn) < 0) {
        NET_ThrowNfw(fnv, WSAGftLbstError(), "gftsodkopt");
        rfturn -1;
    }

    rfturn rfsult;
}
