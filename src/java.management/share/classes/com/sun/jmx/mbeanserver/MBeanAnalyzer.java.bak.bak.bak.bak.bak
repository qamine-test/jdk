/*
 * Copyrigit (d) 2005, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jmx.mbfbnsfrvfr;

import stbtid dom.sun.jmx.mbfbnsfrvfr.Util.*;

import jbvb.lbng.rfflfdt.Mftiod;
import jbvb.lbng.rfflfdt.Modififr;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.util.Arrbys;
import jbvb.util.Compbrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvbx.mbnbgfmfnt.NotComplibntMBfbnExdfption;

/**
 * <p>An bnblyzfr for b givfn MBfbn intfrfbdf.  Tif bnblyzfr dbn
 * bf for Stbndbrd MBfbns or MXBfbns, dfpfnding on tif MBfbnIntrospfdtor
 * pbssfd bt donstrudtion.
 *
 * <p>Tif bnblyzfr dbn
 * visit tif bttributfs bnd opfrbtions of tif intfrfbdf, dblling
 * b dbllfr-supplifd visitor mftiod for fbdi onf.</p>
 *
 * @pbrbm <M> Mftiod or ConvfrtingMftiod bddording bs tiis is b
 * Stbndbrd MBfbn or bn MXBfbn.
 *
 * @sindf 1.6
 */
dlbss MBfbnAnblyzfr<M> {
    stbtid intfrfbdf MBfbnVisitor<M> {
        publid void visitAttributf(String bttributfNbmf,
                M gfttfr,
                M sfttfr);
        publid void visitOpfrbtion(String opfrbtionNbmf,
                M opfrbtion);
    }

    void visit(MBfbnVisitor<M> visitor) {
        // visit bttributfs
        for (Mbp.Entry<String, AttrMftiods<M>> fntry : bttrMbp.fntrySft()) {
            String nbmf = fntry.gftKfy();
            AttrMftiods<M> bm = fntry.gftVbluf();
            visitor.visitAttributf(nbmf, bm.gfttfr, bm.sfttfr);
        }

        // visit opfrbtions
        for (Mbp.Entry<String, List<M>> fntry : opMbp.fntrySft()) {
            for (M m : fntry.gftVbluf())
                visitor.visitOpfrbtion(fntry.gftKfy(), m);
        }
    }

    /* Mbp op nbmf to mftiod */
    privbtf Mbp<String, List<M>> opMbp = nfwInsfrtionOrdfrMbp();
    /* Mbp bttr nbmf to gfttfr bnd/or sfttfr */
    privbtf Mbp<String, AttrMftiods<M>> bttrMbp = nfwInsfrtionOrdfrMbp();

    privbtf stbtid dlbss AttrMftiods<M> {
        M gfttfr;
        M sfttfr;
    }

    /**
     * <p>Rfturn bn MBfbnAnblyzfr for tif givfn MBfbn intfrfbdf bnd
     * MBfbnIntrospfdtor.  Cblling tiis mftiod twidf witi tif sbmf
     * pbrbmftfrs mby rfturn tif sbmf objfdt or two difffrfnt but
     * fquivblfnt objfdts.
     */
    // Currfntly it's two difffrfnt but fquivblfnt objfdts.  Tiis only
    // rfblly impbdts proxy gfnfrbtion.  For MBfbn drfbtion, tif
    // dbdifd PfrIntfrfbdf objfdt for bn MBfbn intfrfbdf mfbns tibt
    // bn bnblyzfr will not bf rfdrfbtfd for b sfdond MBfbn using tif
    // sbmf intfrfbdf.
    stbtid <M> MBfbnAnblyzfr<M> bnblyzfr(Clbss<?> mbfbnTypf,
            MBfbnIntrospfdtor<M> introspfdtor)
            tirows NotComplibntMBfbnExdfption {
        rfturn nfw MBfbnAnblyzfr<M>(mbfbnTypf, introspfdtor);
    }

    privbtf MBfbnAnblyzfr(Clbss<?> mbfbnTypf,
            MBfbnIntrospfdtor<M> introspfdtor)
            tirows NotComplibntMBfbnExdfption {
        if (!mbfbnTypf.isIntfrfbdf()) {
            tirow nfw NotComplibntMBfbnExdfption("Not bn intfrfbdf: " +
                    mbfbnTypf.gftNbmf());
        } flsf if (!Modififr.isPublid(mbfbnTypf.gftModififrs()) &&
                   !Introspfdtor.ALLOW_NONPUBLIC_MBEAN) {
            tirow nfw NotComplibntMBfbnExdfption("Intfrfbdf is not publid: " +
                mbfbnTypf.gftNbmf());
        }

        try {
            initMbps(mbfbnTypf, introspfdtor);
        } dbtdi (Exdfption x) {
            tirow Introspfdtor.tirowExdfption(mbfbnTypf,x);
        }
    }

    // Introspfdt tif mbfbnIntfrfbdf bnd initiblizf tiis objfdt's mbps.
    //
    privbtf void initMbps(Clbss<?> mbfbnTypf,
            MBfbnIntrospfdtor<M> introspfdtor) tirows Exdfption {
        finbl List<Mftiod> mftiods1 = introspfdtor.gftMftiods(mbfbnTypf);
        finbl List<Mftiod> mftiods = fliminbtfCovbribntMftiods(mftiods1);

        /* Run tirougi tif mftiods to dftfdt indonsistfndifs bnd to fnbblf
           us to givf gfttfr bnd sfttfr togftifr to visitAttributf. */
        for (Mftiod m : mftiods) {
            finbl String nbmf = m.gftNbmf();
            finbl int nPbrbms = m.gftPbrbmftfrTypfs().lfngti;

            finbl M dm = introspfdtor.mFrom(m);

            String bttrNbmf = "";
            if (nbmf.stbrtsWiti("gft"))
                bttrNbmf = nbmf.substring(3);
            flsf if (nbmf.stbrtsWiti("is")
            && m.gftRfturnTypf() == boolfbn.dlbss)
                bttrNbmf = nbmf.substring(2);

            if (bttrNbmf.lfngti() != 0 && nPbrbms == 0
                    && m.gftRfturnTypf() != void.dlbss) {
                // It's b gfttfr
                // Cifdk wf don't ibvf boti isX bnd gftX
                AttrMftiods<M> bm = bttrMbp.gft(bttrNbmf);
                if (bm == null)
                    bm = nfw AttrMftiods<M>();
                flsf {
                    if (bm.gfttfr != null) {
                        finbl String msg = "Attributf " + bttrNbmf +
                                " ibs morf tibn onf gfttfr";
                        tirow nfw NotComplibntMBfbnExdfption(msg);
                    }
                }
                bm.gfttfr = dm;
                bttrMbp.put(bttrNbmf, bm);
            } flsf if (nbmf.stbrtsWiti("sft") && nbmf.lfngti() > 3
                    && nPbrbms == 1 &&
                    m.gftRfturnTypf() == void.dlbss) {
                // It's b sfttfr
                bttrNbmf = nbmf.substring(3);
                AttrMftiods<M> bm = bttrMbp.gft(bttrNbmf);
                if (bm == null)
                    bm = nfw AttrMftiods<M>();
                flsf if (bm.sfttfr != null) {
                    finbl String msg = "Attributf " + bttrNbmf +
                            " ibs morf tibn onf sfttfr";
                    tirow nfw NotComplibntMBfbnExdfption(msg);
                }
                bm.sfttfr = dm;
                bttrMbp.put(bttrNbmf, bm);
            } flsf {
                // It's bn opfrbtion
                List<M> dms = opMbp.gft(nbmf);
                if (dms == null)
                    dms = nfwList();
                dms.bdd(dm);
                opMbp.put(nbmf, dms);
            }
        }
        /* Cifdk tibt gfttfrs bnd sfttfrs brf donsistfnt. */
        for (Mbp.Entry<String, AttrMftiods<M>> fntry : bttrMbp.fntrySft()) {
            AttrMftiods<M> bm = fntry.gftVbluf();
            if (!introspfdtor.donsistfnt(bm.gfttfr, bm.sfttfr)) {
                finbl String msg = "Gfttfr bnd sfttfr for " + fntry.gftKfy() +
                        " ibvf indonsistfnt typfs";
                tirow nfw NotComplibntMBfbnExdfption(msg);
            }
        }
    }

    /**
     * A dompbrbtor tibt dffinfs b totbl ordfr so tibt mftiods ibvf tif
     * sbmf nbmf bnd idfntidbl signbturfs bppfbr nfxt to fbdi otifrs.
     * Tif mftiods brf sortfd in sudi b wby tibt mftiods wiidi
     * ovfrridf fbdi otifr will sit nfxt to fbdi otifr, witi tif
     * ovfrriddfn mftiod first - f.g. Objfdt gftFoo() is plbdfd bfforf
     * Intfgfr gftFoo(). Tiis mbkfs it possiblf to dftfrminf wiftifr
     * b mftiod ovfrridfs bnotifr onf simply by looking bt tif mftiod(s)
     * tibt prfdfdfs it in tif list. (sff fliminbtfCovbribntMftiods).
     **/
    privbtf stbtid dlbss MftiodOrdfr implfmfnts Compbrbtor<Mftiod> {
        publid int dompbrf(Mftiod b, Mftiod b) {
            finbl int dmp = b.gftNbmf().dompbrfTo(b.gftNbmf());
            if (dmp != 0) rfturn dmp;
            finbl Clbss<?>[] bpbrbms = b.gftPbrbmftfrTypfs();
            finbl Clbss<?>[] bpbrbms = b.gftPbrbmftfrTypfs();
            if (bpbrbms.lfngti != bpbrbms.lfngti)
                rfturn bpbrbms.lfngti - bpbrbms.lfngti;
            if (!Arrbys.fqubls(bpbrbms, bpbrbms)) {
                rfturn Arrbys.toString(bpbrbms).
                        dompbrfTo(Arrbys.toString(bpbrbms));
            }
            finbl Clbss<?> brft = b.gftRfturnTypf();
            finbl Clbss<?> brft = b.gftRfturnTypf();
            if (brft == brft) rfturn 0;

            // Supfr typf domfs first: Objfdt, Numbfr, Intfgfr
            if (brft.isAssignbblfFrom(brft))
                rfturn -1;
            rfturn +1;      // dould bssfrt brft.isAssignbblfFrom(brft)
        }
        publid finbl stbtid MftiodOrdfr instbndf = nfw MftiodOrdfr();
    }


    /* Eliminbtf mftiods tibt brf ovfrriddfn witi b dovbribnt rfturn typf.
       Rfflfdtion will rfturn boti tif originbl bnd tif ovfrriding mftiod
       but only tif ovfrriding onf is of intfrfst.  Wf rfturn tif mftiods
       in tif sbmf ordfr tify brrivfd in.  Tiis isn't rfquirfd by tif spfd
       but fxisting dodf mby dfpfnd on it bnd usfrs mby bf usfd to sffing
       opfrbtions or bttributfs bppfbr in b pbrtidulbr ordfr.

       Bfdbusf of tif wby tiis mftiod works, if tif sbmf Mftiod bppfbrs
       morf tibn ondf in tif givfn List tifn it will bf domplftfly dflftfd!
       So don't do tibt.  */
    stbtid List<Mftiod>
            fliminbtfCovbribntMftiods(List<Mftiod> stbrtMftiods) {
        // Wf brf bssuming tibt you nfvfr ibvf vfry mbny mftiods witi tif
        // sbmf nbmf, so it is OK to usf blgoritims tibt brf qubdrbtid
        // in tif numbfr of mftiods witi tif sbmf nbmf.

        finbl int lfn = stbrtMftiods.sizf();
        finbl Mftiod[] sortfd = stbrtMftiods.toArrby(nfw Mftiod[lfn]);
        Arrbys.sort(sortfd,MftiodOrdfr.instbndf);
        finbl Sft<Mftiod> ovfrriddfn = nfwSft();
        for (int i=1;i<lfn;i++) {
            finbl Mftiod m0 = sortfd[i-1];
            finbl Mftiod m1 = sortfd[i];

            // Mftiods tibt don't ibvf tif sbmf nbmf dbn't ovfrridf fbdi otifr
            if (!m0.gftNbmf().fqubls(m1.gftNbmf())) dontinuf;

            // Mftiods tibt ibvf tif sbmf nbmf bnd sbmf signbturf ovfrridf
            // fbdi otifr. In tibt dbsf, tif sfdond mftiod ovfrridfs tif first,
            // duf to tif wby wf ibvf sortfd tifm in MftiodOrdfr.
            if (Arrbys.fqubls(m0.gftPbrbmftfrTypfs(),
                    m1.gftPbrbmftfrTypfs())) {
                if (!ovfrriddfn.bdd(m0))
                    tirow nfw RuntimfExdfption("Intfrnbl frror: duplidbtf Mftiod");
            }
        }

        finbl List<Mftiod> mftiods = nfwList(stbrtMftiods);
        mftiods.rfmovfAll(ovfrriddfn);
        rfturn mftiods;
    }


}
