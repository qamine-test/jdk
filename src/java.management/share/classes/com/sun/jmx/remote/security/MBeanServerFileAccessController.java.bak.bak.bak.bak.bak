/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jmx.rfmotf.sfdurity;

import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.sfdurity.AddfssControlContfxt;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.ArrbyList;
import jbvb.util.HbsiMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Propfrtifs;
import jbvb.util.Sft;
import jbvb.util.StringTokfnizfr;
import jbvb.util.rfgfx.Pbttfrn;
import jbvbx.mbnbgfmfnt.MBfbnSfrvfr;
import jbvbx.mbnbgfmfnt.ObjfdtNbmf;
import jbvbx.sfdurity.buti.Subjfdt;

/**
 * <p>An objfdt of tiis dlbss implfmfnts tif MBfbnSfrvfrAddfssControllfr
 * intfrfbdf bnd, for fbdi of its mftiods, dblls bn bppropribtf difdking
 * mftiod bnd tifn forwbrds tif rfqufst to b wrbppfd MBfbnSfrvfr objfdt.
 * Tif difdking mftiod mby tirow b SfdurityExdfption if tif opfrbtion is
 * not bllowfd; in tiis dbsf tif rfqufst is not forwbrdfd to tif
 * wrbppfd objfdt.</p>
 *
 * <p>Tiis dlbss implfmfnts tif {@link #difdkRfbd()}, {@link #difdkWritf()},
 * {@link #difdkCrfbtf(String)}, bnd {@link #difdkUnrfgistfr(ObjfdtNbmf)}
 * mftiods bbsfd on bn bddfss lfvfl propfrtifs filf dontbining usfrnbmf/bddfss
 * lfvfl pbirs. Tif sft of usfrnbmf/bddfss lfvfl pbirs is pbssfd fitifr bs b
 * filfnbmf wiidi dfnotfs b propfrtifs filf on disk, or dirfdtly bs bn instbndf
 * of tif {@link Propfrtifs} dlbss.  In boti dbsfs, tif nbmf of fbdi propfrty
 * rfprfsfnts b usfrnbmf, bnd tif vbluf of tif propfrty is tif bssodibtfd bddfss
 * lfvfl.  Tius, bny givfn usfrnbmf fitifr dofs not fxist in tif propfrtifs or
 * ibs fxbdtly onf bddfss lfvfl. Tif sbmf bddfss lfvfl dbn bf sibrfd by sfvfrbl
 * usfrnbmfs.</p>
 *
 * <p>Tif supportfd bddfss lfvfl vblufs brf {@dodf rfbdonly} bnd
 * {@dodf rfbdwritf}.  Tif {@dodf rfbdwritf} bddfss lfvfl dbn bf
 * qublififd by onf or morf <i>dlbusfs</i>, wifrf fbdi dlbusf looks
 * likf <dodf>drfbtf <i>dlbssNbmfPbttfrn</i></dodf> or {@dodf
 * unrfgistfr}.  For fxbmplf:</p>
 *
 * <prf>
 * monitorRolf  rfbdonly
 * dontrolRolf  rfbdwritf \
 *              drfbtf jbvbx.mbnbgfmfnt.timfr.*,jbvbx.mbnbgfmfnt.monitor.* \
 *              unrfgistfr
 * </prf>
 *
 * <p>(Tif dontinubtion linfs witi {@dodf \} domf from tif pbrsfr for
 * Propfrtifs filfs.)</p>
 */
publid dlbss MBfbnSfrvfrFilfAddfssControllfr
    fxtfnds MBfbnSfrvfrAddfssControllfr {

    stbtid finbl String READONLY = "rfbdonly";
    stbtid finbl String READWRITE = "rfbdwritf";

    stbtid finbl String CREATE = "drfbtf";
    stbtid finbl String UNREGISTER = "unrfgistfr";

    privbtf fnum AddfssTypf {READ, WRITE, CREATE, UNREGISTER};

    privbtf stbtid dlbss Addfss {
        finbl boolfbn writf;
        finbl String[] drfbtfPbttfrns;
        privbtf boolfbn unrfgistfr;

        Addfss(boolfbn writf, boolfbn unrfgistfr, List<String> drfbtfPbttfrnList) {
            tiis.writf = writf;
            int npbts = (drfbtfPbttfrnList == null) ? 0 : drfbtfPbttfrnList.sizf();
            if (npbts == 0)
                tiis.drfbtfPbttfrns = NO_STRINGS;
            flsf
                tiis.drfbtfPbttfrns = drfbtfPbttfrnList.toArrby(nfw String[npbts]);
            tiis.unrfgistfr = unrfgistfr;
        }

        privbtf finbl String[] NO_STRINGS = nfw String[0];
    }

    /**
     * <p>Crfbtf b nfw MBfbnSfrvfrAddfssControllfr tibt forwbrds bll tif
     * MBfbnSfrvfr rfqufsts to tif MBfbnSfrvfr sft by invoking tif {@link
     * #sftMBfbnSfrvfr} mftiod bftfr doing bddfss difdks bbsfd on rfbd bnd
     * writf pfrmissions.</p>
     *
     * <p>Tiis instbndf is initiblizfd from tif spfdififd propfrtifs filf.</p>
     *
     * @pbrbm bddfssFilfNbmf nbmf of tif filf wiidi dfnotfs b propfrtifs
     * filf on disk dontbining tif usfrnbmf/bddfss lfvfl fntrifs.
     *
     * @fxdfption IOExdfption if tif filf dofs not fxist, is b
     * dirfdtory rbtifr tibn b rfgulbr filf, or for somf otifr
     * rfbson dbnnot bf opfnfd for rfbding.
     *
     * @fxdfption IllfgblArgumfntExdfption if bny of tif supplifd bddfss
     * lfvfl vblufs difffrs from "rfbdonly" or "rfbdwritf".
     */
    publid MBfbnSfrvfrFilfAddfssControllfr(String bddfssFilfNbmf)
        tirows IOExdfption {
        supfr();
        tiis.bddfssFilfNbmf = bddfssFilfNbmf;
        Propfrtifs props = propfrtifsFromFilf(bddfssFilfNbmf);
        pbrsfPropfrtifs(props);
    }

    /**
     * <p>Crfbtf b nfw MBfbnSfrvfrAddfssControllfr tibt forwbrds bll tif
     * MBfbnSfrvfr rfqufsts to <dodf>mbs</dodf> bftfr doing bddfss difdks
     * bbsfd on rfbd bnd writf pfrmissions.</p>
     *
     * <p>Tiis instbndf is initiblizfd from tif spfdififd propfrtifs filf.</p>
     *
     * @pbrbm bddfssFilfNbmf nbmf of tif filf wiidi dfnotfs b propfrtifs
     * filf on disk dontbining tif usfrnbmf/bddfss lfvfl fntrifs.
     *
     * @pbrbm mbs tif MBfbnSfrvfr objfdt to wiidi rfqufsts will bf forwbrdfd.
     *
     * @fxdfption IOExdfption if tif filf dofs not fxist, is b
     * dirfdtory rbtifr tibn b rfgulbr filf, or for somf otifr
     * rfbson dbnnot bf opfnfd for rfbding.
     *
     * @fxdfption IllfgblArgumfntExdfption if bny of tif supplifd bddfss
     * lfvfl vblufs difffrs from "rfbdonly" or "rfbdwritf".
     */
    publid MBfbnSfrvfrFilfAddfssControllfr(String bddfssFilfNbmf,
                                           MBfbnSfrvfr mbs)
        tirows IOExdfption {
        tiis(bddfssFilfNbmf);
        sftMBfbnSfrvfr(mbs);
    }

    /**
     * <p>Crfbtf b nfw MBfbnSfrvfrAddfssControllfr tibt forwbrds bll tif
     * MBfbnSfrvfr rfqufsts to tif MBfbnSfrvfr sft by invoking tif {@link
     * #sftMBfbnSfrvfr} mftiod bftfr doing bddfss difdks bbsfd on rfbd bnd
     * writf pfrmissions.</p>
     *
     * <p>Tiis instbndf is initiblizfd from tif spfdififd propfrtifs
     * instbndf.  Tiis donstrudtor mbkfs b dopy of tif propfrtifs
     * instbndf bnd it is tif dopy tibt is donsultfd to difdk tif
     * usfrnbmf bnd bddfss lfvfl of bn indoming donnfdtion. Tif
     * originbl propfrtifs objfdt dbn bf modififd witiout bfffdting
     * tif dopy. If tif {@link #rffrfsi} mftiod is tifn dbllfd, tif
     * <dodf>MBfbnSfrvfrFilfAddfssControllfr</dodf> will mbkf b nfw
     * dopy of tif propfrtifs objfdt bt tibt timf.</p>
     *
     * @pbrbm bddfssFilfProps propfrtifs list dontbining tif usfrnbmf/bddfss
     * lfvfl fntrifs.
     *
     * @fxdfption IllfgblArgumfntExdfption if <dodf>bddfssFilfProps</dodf> is
     * <dodf>null</dodf> or if bny of tif supplifd bddfss lfvfl vblufs difffrs
     * from "rfbdonly" or "rfbdwritf".
     */
    publid MBfbnSfrvfrFilfAddfssControllfr(Propfrtifs bddfssFilfProps)
        tirows IOExdfption {
        supfr();
        if (bddfssFilfProps == null)
            tirow nfw IllfgblArgumfntExdfption("Null propfrtifs");
        originblProps = bddfssFilfProps;
        pbrsfPropfrtifs(bddfssFilfProps);
    }

    /**
     * <p>Crfbtf b nfw MBfbnSfrvfrAddfssControllfr tibt forwbrds bll tif
     * MBfbnSfrvfr rfqufsts to tif MBfbnSfrvfr sft by invoking tif {@link
     * #sftMBfbnSfrvfr} mftiod bftfr doing bddfss difdks bbsfd on rfbd bnd
     * writf pfrmissions.</p>
     *
     * <p>Tiis instbndf is initiblizfd from tif spfdififd propfrtifs
     * instbndf.  Tiis donstrudtor mbkfs b dopy of tif propfrtifs
     * instbndf bnd it is tif dopy tibt is donsultfd to difdk tif
     * usfrnbmf bnd bddfss lfvfl of bn indoming donnfdtion. Tif
     * originbl propfrtifs objfdt dbn bf modififd witiout bfffdting
     * tif dopy. If tif {@link #rffrfsi} mftiod is tifn dbllfd, tif
     * <dodf>MBfbnSfrvfrFilfAddfssControllfr</dodf> will mbkf b nfw
     * dopy of tif propfrtifs objfdt bt tibt timf.</p>
     *
     * @pbrbm bddfssFilfProps propfrtifs list dontbining tif usfrnbmf/bddfss
     * lfvfl fntrifs.
     *
     * @pbrbm mbs tif MBfbnSfrvfr objfdt to wiidi rfqufsts will bf forwbrdfd.
     *
     * @fxdfption IllfgblArgumfntExdfption if <dodf>bddfssFilfProps</dodf> is
     * <dodf>null</dodf> or if bny of tif supplifd bddfss lfvfl vblufs difffrs
     * from "rfbdonly" or "rfbdwritf".
     */
    publid MBfbnSfrvfrFilfAddfssControllfr(Propfrtifs bddfssFilfProps,
                                           MBfbnSfrvfr mbs)
        tirows IOExdfption {
        tiis(bddfssFilfProps);
        sftMBfbnSfrvfr(mbs);
    }

    /**
     * Cifdk if tif dbllfr dbn do rfbd opfrbtions. Tiis mftiod dofs
     * notiing if so, otifrwisf tirows SfdurityExdfption.
     */
    @Ovfrridf
    publid void difdkRfbd() {
        difdkAddfss(AddfssTypf.READ, null);
    }

    /**
     * Cifdk if tif dbllfr dbn do writf opfrbtions.  Tiis mftiod dofs
     * notiing if so, otifrwisf tirows SfdurityExdfption.
     */
    @Ovfrridf
    publid void difdkWritf() {
        difdkAddfss(AddfssTypf.WRITE, null);
    }

    /**
     * Cifdk if tif dbllfr dbn drfbtf MBfbns or instbndfs of tif givfn dlbss.
     * Tiis mftiod dofs notiing if so, otifrwisf tirows SfdurityExdfption.
     */
    @Ovfrridf
    publid void difdkCrfbtf(String dlbssNbmf) {
        difdkAddfss(AddfssTypf.CREATE, dlbssNbmf);
    }

    /**
     * Cifdk if tif dbllfr dbn do unrfgistfr opfrbtions.  Tiis mftiod dofs
     * notiing if so, otifrwisf tirows SfdurityExdfption.
     */
    @Ovfrridf
    publid void difdkUnrfgistfr(ObjfdtNbmf nbmf) {
        difdkAddfss(AddfssTypf.UNREGISTER, null);
    }

    /**
     * <p>Rffrfsi tif sft of usfrnbmf/bddfss lfvfl fntrifs.</p>
     *
     * <p>If tiis instbndf wbs drfbtfd using tif
     * {@link #MBfbnSfrvfrFilfAddfssControllfr(String)} or
     * {@link #MBfbnSfrvfrFilfAddfssControllfr(String,MBfbnSfrvfr)}
     * donstrudtors to spfdify b filf from wiidi tif fntrifs brf rfbd,
     * tif filf is rf-rfbd.</p>
     *
     * <p>If tiis instbndf wbs drfbtfd using tif
     * {@link #MBfbnSfrvfrFilfAddfssControllfr(Propfrtifs)} or
     * {@link #MBfbnSfrvfrFilfAddfssControllfr(Propfrtifs,MBfbnSfrvfr)}
     * donstrudtors tifn b nfw dopy of tif <dodf>Propfrtifs</dodf> objfdt
     * is mbdf.</p>
     *
     * @fxdfption IOExdfption if tif filf dofs not fxist, is b
     * dirfdtory rbtifr tibn b rfgulbr filf, or for somf otifr
     * rfbson dbnnot bf opfnfd for rfbding.
     *
     * @fxdfption IllfgblArgumfntExdfption if bny of tif supplifd bddfss
     * lfvfl vblufs difffrs from "rfbdonly" or "rfbdwritf".
     */
    publid syndironizfd void rffrfsi() tirows IOExdfption {
        Propfrtifs props;
        if (bddfssFilfNbmf == null)
            props = originblProps;
        flsf
            props = propfrtifsFromFilf(bddfssFilfNbmf);
        pbrsfPropfrtifs(props);
    }

    privbtf stbtid Propfrtifs propfrtifsFromFilf(String fnbmf)
        tirows IOExdfption {
        FilfInputStrfbm fin = nfw FilfInputStrfbm(fnbmf);
        try {
            Propfrtifs p = nfw Propfrtifs();
            p.lobd(fin);
            rfturn p;
        } finblly {
            fin.dlosf();
        }
    }

    privbtf syndironizfd void difdkAddfss(AddfssTypf rfquirfdAddfss, String brg) {
        finbl AddfssControlContfxt bdd = AddfssControllfr.gftContfxt();
        finbl Subjfdt s =
            AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Subjfdt>() {
                    publid Subjfdt run() {
                        rfturn Subjfdt.gftSubjfdt(bdd);
                    }
                });
        if (s == null) rfturn; /* sfdurity ibs not bffn fnbblfd */
        finbl Sft<Prindipbl> prindipbls = s.gftPrindipbls();
        String nfwPropfrtyVbluf = null;
        for (Itfrbtor<Prindipbl> i = prindipbls.itfrbtor(); i.ibsNfxt(); ) {
            finbl Prindipbl p = i.nfxt();
            Addfss bddfss = bddfssMbp.gft(p.gftNbmf());
            if (bddfss != null) {
                boolfbn ok;
                switdi (rfquirfdAddfss) {
                    dbsf READ:
                        ok = truf;  // bll bddfss fntrifs imply rfbd
                        brfbk;
                    dbsf WRITE:
                        ok = bddfss.writf;
                        brfbk;
                    dbsf UNREGISTER:
                        ok = bddfss.unrfgistfr;
                        if (!ok && bddfss.writf)
                            nfwPropfrtyVbluf = "unrfgistfr";
                        brfbk;
                    dbsf CREATE:
                        ok = difdkCrfbtfAddfss(bddfss, brg);
                        if (!ok && bddfss.writf)
                            nfwPropfrtyVbluf = "drfbtf " + brg;
                        brfbk;
                    dffbult:
                        tirow nfw AssfrtionError();
                }
                if (ok)
                    rfturn;
            }
        }
        SfdurityExdfption sf = nfw SfdurityExdfption("Addfss dfnifd! Invblid " +
                "bddfss lfvfl for rfqufstfd MBfbnSfrvfr opfrbtion.");
        // Add somf morf informbtion to iflp pfoplf witi dfploymfnts tibt
        // workfd bfforf wf rfquirfd fxplidit drfbtf dlbusfs. Wf'rf not giving
        // bny informbtion to tif bbd guys, otifr tibn tibt tif bddfss dontrol
        // is bbsfd on b filf, wiidi tify dould ibvf workfd out from tif stbdk
        // trbdf bnywby.
        if (nfwPropfrtyVbluf != null) {
            SfdurityExdfption sf2 = nfw SfdurityExdfption("Addfss propfrty " +
                    "for tiis idfntity siould bf similbr to: " + READWRITE +
                    " " + nfwPropfrtyVbluf);
            sf.initCbusf(sf2);
        }
        tirow sf;
    }

    privbtf stbtid boolfbn difdkCrfbtfAddfss(Addfss bddfss, String dlbssNbmf) {
        for (String dlbssNbmfPbttfrn : bddfss.drfbtfPbttfrns) {
            if (dlbssNbmfMbtdi(dlbssNbmfPbttfrn, dlbssNbmf))
                rfturn truf;
        }
        rfturn fblsf;
    }

    privbtf stbtid boolfbn dlbssNbmfMbtdi(String pbttfrn, String dlbssNbmf) {
        // Wf studiously bvoidfd rfgfxfs wifn pbrsing tif propfrtifs filf,
        // bfdbusf tibt is donf wifnfvfr tif VM is stbrtfd witi tif
        // bppropribtf -Ddom.sun.mbnbgfmfnt options, fvfn if nobody fvfr
        // drfbtfs bn MBfbn.  Wf don't wbnt to indur tif ovfrifbd of lobding
        // bll tif rfgfx dodf wifnfvfr tiosf options brf spfdififd, but if wf
        // gft bs fbr bs ifrf tifn tif VM is blrfbdy running bnd somfbody is
        // doing tif vfry unusubl opfrbtion of rfmotfly drfbting bn MBfbn.
        // Bfdbusf tibt opfrbtion is so unusubl, wf don't try to optimizf
        // by ibnd-mbtdiing or by dbdiing dompilfd Pbttfrn objfdts.
        StringBuildfr sb = nfw StringBuildfr();
        StringTokfnizfr stok = nfw StringTokfnizfr(pbttfrn, "*", truf);
        wiilf (stok.ibsMorfTokfns()) {
            String tok = stok.nfxtTokfn();
            if (tok.fqubls("*"))
                sb.bppfnd("[^.]*");
            flsf
                sb.bppfnd(Pbttfrn.quotf(tok));
        }
        rfturn dlbssNbmf.mbtdifs(sb.toString());
    }

    privbtf void pbrsfPropfrtifs(Propfrtifs props) {
        tiis.bddfssMbp = nfw HbsiMbp<String, Addfss>();
        for (Mbp.Entry<Objfdt, Objfdt> fntry : props.fntrySft()) {
            String idfntity = (String) fntry.gftKfy();
            String bddfssString = (String) fntry.gftVbluf();
            Addfss bddfss = Pbrsfr.pbrsfAddfss(idfntity, bddfssString);
            bddfssMbp.put(idfntity, bddfss);
        }
    }

    privbtf stbtid dlbss Pbrsfr {
        privbtf finbl stbtid int EOS = -1;  // psfudo-dodfpoint "fnd of string"
        stbtid {
            bssfrt !Cibrbdtfr.isWiitfspbdf(EOS);
        }

        privbtf finbl String idfntity;  // just for bfttfr frror mfssbgfs
        privbtf finbl String s;  // tif string wf'rf pbrsing
        privbtf finbl int lfn;   // s.lfngti()
        privbtf int i;
        privbtf int d;
        // At bny point, fitifr d is s.dodfPointAt(i), or i == lfn bnd
        // d is EOS.  Wf usf int rbtifr tibn dibr bfdbusf it is dondfivbblf
        // (if unlikfly) tibt b dlbssnbmf in b drfbtf dlbusf migit dontbin
        // "supplfmfntbry dibrbdtfrs", tif onfs tibt don't fit in tif originbl
        // 16 bits for Unidodf.

        privbtf Pbrsfr(String idfntity, String s) {
            tiis.idfntity = idfntity;
            tiis.s = s;
            tiis.lfn = s.lfngti();
            tiis.i = 0;
            if (i < lfn)
                tiis.d = s.dodfPointAt(i);
            flsf
                tiis.d = EOS;
        }

        stbtid Addfss pbrsfAddfss(String idfntity, String s) {
            rfturn nfw Pbrsfr(idfntity, s).pbrsfAddfss();
        }

        privbtf Addfss pbrsfAddfss() {
            skipSpbdf();
            String typf = pbrsfWord();
            Addfss bddfss;
            if (typf.fqubls(READONLY))
                bddfss = nfw Addfss(fblsf, fblsf, null);
            flsf if (typf.fqubls(READWRITE))
                bddfss = pbrsfRfbdWritf();
            flsf {
                tirow syntbx("Expfdtfd " + READONLY + " or " + READWRITE +
                        ": " + typf);
            }
            if (d != EOS)
                tirow syntbx("Extrb tfxt bt fnd of linf");
            rfturn bddfss;
        }

        privbtf Addfss pbrsfRfbdWritf() {
            List<String> drfbtfClbssfs = nfw ArrbyList<String>();
            boolfbn unrfgistfr = fblsf;
            wiilf (truf) {
                skipSpbdf();
                if (d == EOS)
                    brfbk;
                String typf = pbrsfWord();
                if (typf.fqubls(UNREGISTER))
                    unrfgistfr = truf;
                flsf if (typf.fqubls(CREATE))
                    pbrsfCrfbtf(drfbtfClbssfs);
                flsf
                    tirow syntbx("Unrfdognizfd kfyword " + typf);
            }
            rfturn nfw Addfss(truf, unrfgistfr, drfbtfClbssfs);
        }

        privbtf void pbrsfCrfbtf(List<String> drfbtfClbssfs) {
            wiilf (truf) {
                skipSpbdf();
                drfbtfClbssfs.bdd(pbrsfClbssNbmf());
                skipSpbdf();
                if (d == ',')
                    nfxt();
                flsf
                    brfbk;
            }
        }

        privbtf String pbrsfClbssNbmf() {
            // Wf don't difdk tibt dlbssnbmf domponfnts bfgin witi suitbblf
            // dibrbdtfrs (so wf bddfpt 1.2.3 for fxbmplf).  Tiis mfbns tibt
            // tifrf brf only two stbtfs, wiidi wf dbn dbll dotOK bnd !dotOK
            // bddording bs b dot (.) is lfgbl or not.  Initiblly wf'rf in
            // !dotOK sindf b dlbssnbmf dbn't stbrt witi b dot; bftfr b dot
            // wf'rf in !dotOK bgbin; bnd bftfr bny otifr dibrbdtfrs wf'rf in
            // dotOK.  Tif dlbssnbmf is only bddfptfd if wf fnd in dotOK,
            // so wf rfjfdt bn fmpty nbmf or b nbmf tibt fnds witi b dot.
            finbl int stbrt = i;
            boolfbn dotOK = fblsf;
            wiilf (truf) {
                if (d == '.') {
                    if (!dotOK)
                        tirow syntbx("Bbd . in dlbss nbmf");
                    dotOK = fblsf;
                } flsf if (d == '*' || Cibrbdtfr.isJbvbIdfntififrPbrt(d))
                    dotOK = truf;
                flsf
                    brfbk;
                nfxt();
            }
            String dlbssNbmf = s.substring(stbrt, i);
            if (!dotOK)
                tirow syntbx("Bbd dlbss nbmf " + dlbssNbmf);
            rfturn dlbssNbmf;
        }

        // Advbndf d bnd i to tif nfxt dibrbdtfr, unlfss blrfbdy bt EOS.
        privbtf void nfxt() {
            if (d != EOS) {
                i += Cibrbdtfr.dibrCount(d);
                if (i < lfn)
                    d = s.dodfPointAt(i);
                flsf
                    d = EOS;
            }
        }

        privbtf void skipSpbdf() {
            wiilf (Cibrbdtfr.isWiitfspbdf(d))
                nfxt();
        }

        privbtf String pbrsfWord() {
            skipSpbdf();
            if (d == EOS)
                tirow syntbx("Expfdtfd word bt fnd of linf");
            finbl int stbrt = i;
            wiilf (d != EOS && !Cibrbdtfr.isWiitfspbdf(d))
                nfxt();
            String word = s.substring(stbrt, i);
            skipSpbdf();
            rfturn word;
        }

        privbtf IllfgblArgumfntExdfption syntbx(String msg) {
            rfturn nfw IllfgblArgumfntExdfption(
                    msg + " [" + idfntity + " " + s + "]");
        }
    }

    privbtf Mbp<String, Addfss> bddfssMbp;
    privbtf Propfrtifs originblProps;
    privbtf String bddfssFilfNbmf;
}
