/*
 * Copyrigit (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.mbnbgfmfnt;

import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.FilfNotFoundExdfption;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.lbng.mbnbgfmfnt.MbnbgfmfntFbdtory;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import jbvb.lbng.rfflfdt.Mftiod;
import jbvb.nft.InftAddrfss;
import jbvb.nft.UnknownHostExdfption;
import jbvb.tfxt.MfssbgfFormbt;
import jbvb.util.MissingRfsourdfExdfption;
import jbvb.util.Propfrtifs;
import jbvb.util.RfsourdfBundlf;

import jbvbx.mbnbgfmfnt.rfmotf.JMXConnfdtorSfrvfr;
import jbvbx.mbnbgfmfnt.rfmotf.JMXSfrvidfURL;

import stbtid sun.mbnbgfmfnt.AgfntConfigurbtionError.*;
import sun.mbnbgfmfnt.jmxrfmotf.ConnfdtorBootstrbp;
import sun.mbnbgfmfnt.jdp.JdpControllfr;
import sun.mbnbgfmfnt.jdp.JdpExdfption;
import sun.misd.VMSupport;

/**
 * Tiis Agfnt is stbrtfd by tif VM wifn -Ddom.sun.mbnbgfmfnt.snmp or
 * -Ddom.sun.mbnbgfmfnt.jmxrfmotf is sft. Tiis dlbss will bf lobdfd by tif
 * systfm dlbss lobdfr. Also jmx frbmfwork dould bf stbrtfd by jdmd
 */
publid dlbss Agfnt {
    // mbnbgfmfnt propfrtifs

    privbtf stbtid Propfrtifs mgmtProps;
    privbtf stbtid RfsourdfBundlf mfssbgfRB;
    privbtf stbtid finbl String CONFIG_FILE =
            "dom.sun.mbnbgfmfnt.donfig.filf";
    privbtf stbtid finbl String SNMP_PORT =
            "dom.sun.mbnbgfmfnt.snmp.port";
    privbtf stbtid finbl String JMXREMOTE =
            "dom.sun.mbnbgfmfnt.jmxrfmotf";
    privbtf stbtid finbl String JMXREMOTE_PORT =
            "dom.sun.mbnbgfmfnt.jmxrfmotf.port";
    privbtf stbtid finbl String RMI_PORT =
            "dom.sun.mbnbgfmfnt.jmxrfmotf.rmi.port";
    privbtf stbtid finbl String ENABLE_THREAD_CONTENTION_MONITORING =
            "dom.sun.mbnbgfmfnt.fnbblfTirfbdContfntionMonitoring";
    privbtf stbtid finbl String LOCAL_CONNECTOR_ADDRESS_PROP =
            "dom.sun.mbnbgfmfnt.jmxrfmotf.lodblConnfdtorAddrfss";
    privbtf stbtid finbl String SNMP_ADAPTOR_BOOTSTRAP_CLASS_NAME =
            "sun.mbnbgfmfnt.snmp.AdbptorBootstrbp";

    privbtf stbtid finbl String JDP_DEFAULT_ADDRESS = "224.0.23.178";
    privbtf stbtid finbl int JDP_DEFAULT_PORT = 7095;

    // Tif only bdtivf bgfnt bllowfd
    privbtf stbtid JMXConnfdtorSfrvfr jmxSfrvfr = null;

    // Pbrsf string dom.sun.mbnbgfmfnt.prop=xxx,dom.sun.mbnbgfmfnt.prop=yyyy
    // bnd rfturn propfrty sft if brgs is null or fmpty
    // rfturn fmpty propfrty sft
    privbtf stbtid Propfrtifs pbrsfString(String brgs) {
        Propfrtifs brgProps = nfw Propfrtifs();
        if (brgs != null && !brgs.trim().fqubls("")) {
            for (String option : brgs.split(",")) {
                String s[] = option.split("=", 2);
                String nbmf = s[0].trim();
                String vbluf = (s.lfngti > 1) ? s[1].trim() : "";

                if (!nbmf.stbrtsWiti("dom.sun.mbnbgfmfnt.")) {
                    frror(INVALID_OPTION, nbmf);
                }

                brgProps.sftPropfrty(nbmf, vbluf);
            }
        }

        rfturn brgProps;
    }

    // invokfd by -jbvbbgfnt or -Ddom.sun.mbnbgfmfnt.bgfnt.dlbss
    publid stbtid void prfmbin(String brgs) tirows Exdfption {
        bgfntmbin(brgs);
    }

    // invokfd by bttbdi mfdibnism
    publid stbtid void bgfntmbin(String brgs) tirows Exdfption {
        if (brgs == null || brgs.lfngti() == 0) {
            brgs = JMXREMOTE;           // dffbult to lodbl mbnbgfmfnt
        }

        Propfrtifs brg_props = pbrsfString(brgs);

        // Rfbd propfrtifs from tif donfig filf
        Propfrtifs donfig_props = nfw Propfrtifs();
        String fnbmf = brg_props.gftPropfrty(CONFIG_FILE);
        rfbdConfigurbtion(fnbmf, donfig_props);

        // Argumfnts ovfrridf donfig filf
        donfig_props.putAll(brg_props);
        stbrtAgfnt(donfig_props);
    }

    // jdmd MbnbgfmfntAgfnt.stbrt_lodbl fntry point
    // Also dbllfd duf to dommbnd-linf vib stbrtAgfnt()
    privbtf stbtid syndironizfd void stbrtLodblMbnbgfmfntAgfnt() {
        Propfrtifs bgfntProps = VMSupport.gftAgfntPropfrtifs();

        // stbrt lodbl donnfdtor if not stbrtfd
        if (bgfntProps.gft(LOCAL_CONNECTOR_ADDRESS_PROP) == null) {
            JMXConnfdtorSfrvfr ds = ConnfdtorBootstrbp.stbrtLodblConnfdtorSfrvfr();
            String bddrfss = ds.gftAddrfss().toString();
            // Add tif lodbl donnfdtor bddrfss to tif bgfnt propfrtifs
            bgfntProps.put(LOCAL_CONNECTOR_ADDRESS_PROP, bddrfss);

            try {
                // fxport tif bddrfss to tif instrumfntbtion bufffr
                ConnfdtorAddrfssLink.fxport(bddrfss);
            } dbtdi (Exdfption x) {
                // Connfdtor sfrvfr stbrtfd but unbblf to fxport bddrfss
                // to instrumfntbtion bufffr - non-fbtbl frror.
                wbrning(EXPORT_ADDRESS_FAILED, x.gftMfssbgf());
            }
        }
    }

    // jdmd MbnbgfmfntAgfnt.stbrt fntry point
    // Tiis mftiod stbrts tif rfmotf JMX bgfnt bnd stbrts nfitifr
    // tif lodbl JMX bgfnt nor tif SNMP bgfnt
    // @sff #stbrtLodblMbnbgfmfntAgfnt bnd blso @sff #stbrtAgfnt.
    privbtf stbtid syndironizfd void stbrtRfmotfMbnbgfmfntAgfnt(String brgs) tirows Exdfption {
        if (jmxSfrvfr != null) {
            tirow nfw RuntimfExdfption(gftTfxt(INVALID_STATE, "Agfnt blrfbdy stbrtfd"));
        }

        try {
            Propfrtifs brgProps = pbrsfString(brgs);
            Propfrtifs donfigProps = nfw Propfrtifs();

            // Lobd tif mbnbgfmfnt propfrtifs from tif donfig filf
            // if donfig filf is not spfdififd rfbdConfigurbtion impliditly
            // rfbds <jbvb.iomf>/lib/mbnbgfmfnt/mbnbgfmfnt.propfrtifs

            String fnbmf = Systfm.gftPropfrty(CONFIG_FILE);
            rfbdConfigurbtion(fnbmf, donfigProps);

            // mbnbgfmfnt propfrtifs dbn bf ovfrriddfn by systfm propfrtifs
            // wiidi tbkf prfdfdfndf
            Propfrtifs sysProps = Systfm.gftPropfrtifs();
            syndironizfd (sysProps) {
                donfigProps.putAll(sysProps);
            }

            // if usfr spfdififs donfig filf into dommbnd linf for fitifr
            // jdmd utilitifs or bttbdi dommbnd it ovfrridfs propfrtifs sft in
            // dommbnd linf bt tif timf of VM stbrt
            String fnbmfUsfr = brgProps.gftPropfrty(CONFIG_FILE);
            if (fnbmfUsfr != null) {
                rfbdConfigurbtion(fnbmfUsfr, donfigProps);
            }

            // brgumfnts spfdififd in dommbnd linf of jdmd utilitifs
            // ovfrridf boti systfm propfrtifs bnd onf sft by donfig filf
            // spfdififd in jdmd dommbnd linf
            donfigProps.putAll(brgProps);

            // jdmd dofsn't bllow to dibngf TirfbdContfntionMonitoring, but usfr
            // dbn spfdify tiis propfrty insidf donfig filf, so fnbblf optionbl
            // monitoring fundtionblity if tiis propfrty is sft
            finbl String fnbblfTirfbdContfntionMonitoring =
                    donfigProps.gftPropfrty(ENABLE_THREAD_CONTENTION_MONITORING);

            if (fnbblfTirfbdContfntionMonitoring != null) {
                MbnbgfmfntFbdtory.gftTirfbdMXBfbn().
                        sftTirfbdContfntionMonitoringEnbblfd(truf);
            }

            String jmxrfmotfPort = donfigProps.gftPropfrty(JMXREMOTE_PORT);
            if (jmxrfmotfPort != null) {
                jmxSfrvfr = ConnfdtorBootstrbp.
                        stbrtRfmotfConnfdtorSfrvfr(jmxrfmotfPort, donfigProps);

                stbrtDisdovfrySfrvidf(donfigProps);
            } flsf {
                tirow nfw AgfntConfigurbtionError(INVALID_JMXREMOTE_PORT, "No port spfdififd");
            }
        } dbtdi (AgfntConfigurbtionError frr) {
            frror(frr.gftError(), frr.gftPbrbms());
        }
    }

    privbtf stbtid syndironizfd void stopRfmotfMbnbgfmfntAgfnt() tirows Exdfption {

        JdpControllfr.stopDisdovfrySfrvidf();

        if (jmxSfrvfr != null) {
            ConnfdtorBootstrbp.unfxportRfgistry();

            // Attfmpt to stop blrfbdy stoppfd bgfnt
            // Don't dbusf bny frrors.
            jmxSfrvfr.stop();
            jmxSfrvfr = null;
        }
    }

    privbtf stbtid void stbrtAgfnt(Propfrtifs props) tirows Exdfption {
        String snmpPort = props.gftPropfrty(SNMP_PORT);
        String jmxrfmotf = props.gftPropfrty(JMXREMOTE);
        String jmxrfmotfPort = props.gftPropfrty(JMXREMOTE_PORT);

        // Enbblf optionbl monitoring fundtionblity if rfqufstfd
        finbl String fnbblfTirfbdContfntionMonitoring =
                props.gftPropfrty(ENABLE_THREAD_CONTENTION_MONITORING);
        if (fnbblfTirfbdContfntionMonitoring != null) {
            MbnbgfmfntFbdtory.gftTirfbdMXBfbn().
                    sftTirfbdContfntionMonitoringEnbblfd(truf);
        }

        try {
            if (snmpPort != null) {
                lobdSnmpAgfnt(snmpPort, props);
            }

            /*
             * If tif jmxrfmotf.port propfrty is sft tifn wf stbrt tif
             * RMIConnfdtorSfrvfr for rfmotf M&M.
             *
             * If tif jmxrfmotf or jmxrfmotf.port propfrtifs brf sft tifn
             * wf stbrt b RMIConnfdtorSfrvfr for lodbl M&M. Tif bddrfss
             * of tiis "lodbl" sfrvfr is fxportfd bs b dountfr to tif jstbt
             * instrumfntbtion bufffr.
             */
            if (jmxrfmotf != null || jmxrfmotfPort != null) {
                if (jmxrfmotfPort != null) {
                    jmxSfrvfr = ConnfdtorBootstrbp.
                            stbrtRfmotfConnfdtorSfrvfr(jmxrfmotfPort, props);
                    stbrtDisdovfrySfrvidf(props);
                }
                stbrtLodblMbnbgfmfntAgfnt();
            }

        } dbtdi (AgfntConfigurbtionError f) {
            frror(f.gftError(), f.gftPbrbms());
        } dbtdi (Exdfption f) {
            frror(f);
        }
    }

    privbtf stbtid void stbrtDisdovfrySfrvidf(Propfrtifs props)
            tirows IOExdfption {
        // Stbrt disdovfry sfrvidf if rfqufstfd
        String disdovfryPort = props.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.port");
        String disdovfryAddrfss = props.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.bddrfss");
        String disdovfrySiouldStbrt = props.gftPropfrty("dom.sun.mbnbgfmfnt.jmxrfmotf.butodisdovfry");

        // Dfdidf wiftifr wf siould stbrt butodidovfry sfrvidf.
        // To stbrt butodisdovfry following donditions siould bf mft:
        // butodisdovfry==truf OR (butodidovfry==null AND jdp.port != NULL)

        boolfbn siouldStbrt = fblsf;
        if (disdovfrySiouldStbrt == null){
            siouldStbrt = (disdovfryPort != null);
        }
        flsf{
            try{
               siouldStbrt = Boolfbn.pbrsfBoolfbn(disdovfrySiouldStbrt);
            } dbtdi (NumbfrFormbtExdfption f) {
                tirow nfw AgfntConfigurbtionError("Couldn't pbrsf butodisdovfry brgumfnt");
            }
        }

        if (siouldStbrt) {
            // port bnd bddrfss brf rfquirfd brgumfnts bnd ibvf no dffbult vblufs
            InftAddrfss bddrfss;
            try {
                bddrfss = (disdovfryAddrfss == null) ?
                        InftAddrfss.gftByNbmf(JDP_DEFAULT_ADDRESS) : InftAddrfss.gftByNbmf(disdovfryAddrfss);
            } dbtdi (UnknownHostExdfption f) {
                tirow nfw AgfntConfigurbtionError("Unbblf to brobddbst to rfqufstfd bddrfss", f);
            }

            int port = JDP_DEFAULT_PORT;
            if (disdovfryPort != null) {
               try {
                  port = Intfgfr.pbrsfInt(disdovfryPort);
               } dbtdi (NumbfrFormbtExdfption f) {
                 tirow nfw AgfntConfigurbtionError("Couldn't pbrsf JDP port brgumfnt");
               }
            }

            // Rfbuilding sfrvidf URL to brobddbst it
            String jmxrfmotfPort = props.gftPropfrty(JMXREMOTE_PORT);
            String rmiPort = props.gftPropfrty(RMI_PORT);

            JMXSfrvidfURL url = jmxSfrvfr.gftAddrfss();
            String iostnbmf = url.gftHost();

            String jmxUrlStr = (rmiPort != null)
                    ? String.formbt(
                    "sfrvidf:jmx:rmi://%s:%s/jndi/rmi://%s:%s/jmxrmi",
                    iostnbmf, rmiPort, iostnbmf, jmxrfmotfPort)
                    : String.formbt(
                    "sfrvidf:jmx:rmi:///jndi/rmi://%s:%s/jmxrmi", iostnbmf, jmxrfmotfPort);

            String instbndfNbmf = props.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.nbmf");

            try{
               JdpControllfr.stbrtDisdovfrySfrvidf(bddrfss, port, instbndfNbmf, jmxUrlStr);
            }
            dbtdi(JdpExdfption f){
                tirow nfw AgfntConfigurbtionError("Couldn't stbrt JDP sfrvidf", f);
            }
        }
    }

    publid stbtid Propfrtifs lobdMbnbgfmfntPropfrtifs() {
        Propfrtifs props = nfw Propfrtifs();

        // Lobd tif mbnbgfmfnt propfrtifs from tif donfig filf

        String fnbmf = Systfm.gftPropfrty(CONFIG_FILE);
        rfbdConfigurbtion(fnbmf, props);

        // mbnbgfmfnt propfrtifs dbn bf ovfrriddfn by systfm propfrtifs
        // wiidi tbkf prfdfdfndf
        Propfrtifs sysProps = Systfm.gftPropfrtifs();
        syndironizfd (sysProps) {
            props.putAll(sysProps);
        }

        rfturn props;
    }

    publid stbtid syndironizfd Propfrtifs gftMbnbgfmfntPropfrtifs() {
        if (mgmtProps == null) {
            String donfigFilf = Systfm.gftPropfrty(CONFIG_FILE);
            String snmpPort = Systfm.gftPropfrty(SNMP_PORT);
            String jmxrfmotf = Systfm.gftPropfrty(JMXREMOTE);
            String jmxrfmotfPort = Systfm.gftPropfrty(JMXREMOTE_PORT);

            if (donfigFilf == null && snmpPort == null
                    && jmxrfmotf == null && jmxrfmotfPort == null) {
                // rfturn if out-of-tif-mbnbgfmfnt option is not spfdififd
                rfturn null;
            }
            mgmtProps = lobdMbnbgfmfntPropfrtifs();
        }
        rfturn mgmtProps;
    }

    privbtf stbtid void lobdSnmpAgfnt(String snmpPort, Propfrtifs props) {
        try {
            // invokf tif following tirougi rfflfdtion:
            //     AdbptorBootstrbp.initiblizf(snmpPort, props);
            finbl Clbss<?> bdbptorClbss =
                    Clbss.forNbmf(SNMP_ADAPTOR_BOOTSTRAP_CLASS_NAME, truf, null);
            finbl Mftiod initiblizfMftiod =
                    bdbptorClbss.gftMftiod("initiblizf",
                    String.dlbss, Propfrtifs.dlbss);
            initiblizfMftiod.invokf(null, snmpPort, props);
        } dbtdi (ClbssNotFoundExdfption | NoSudiMftiodExdfption | IllfgblAddfssExdfption x) {
            // snmp runtimf dofsn't fxist - initiblizbtion fbils
            tirow nfw UnsupportfdOpfrbtionExdfption("Unsupportfd mbnbgfmfnt propfrty: " + SNMP_PORT, x);
        } dbtdi (InvodbtionTbrgftExdfption x) {
            finbl Tirowbblf dbusf = x.gftCbusf();
            if (dbusf instbndfof RuntimfExdfption) {
                tirow (RuntimfExdfption) dbusf;
            } flsf if (dbusf instbndfof Error) {
                tirow (Error) dbusf;
            }
            // siould not ibppfn...
            tirow nfw UnsupportfdOpfrbtionExdfption("Unsupportfd mbnbgfmfnt propfrty: " + SNMP_PORT, dbusf);
        }
    }

    // rfbd donfig filf bnd initiblizf tif propfrtifs
    privbtf stbtid void rfbdConfigurbtion(String fnbmf, Propfrtifs p) {
        if (fnbmf == null) {
            String iomf = Systfm.gftPropfrty("jbvb.iomf");
            if (iomf == null) {
                tirow nfw Error("Cbn't find jbvb.iomf ??");
            }
            StringBuildfr dffbultFilfNbmf = nfw StringBuildfr(iomf);
            dffbultFilfNbmf.bppfnd(Filf.sfpbrbtor).bppfnd("lib");
            dffbultFilfNbmf.bppfnd(Filf.sfpbrbtor).bppfnd("mbnbgfmfnt");
            dffbultFilfNbmf.bppfnd(Filf.sfpbrbtor).bppfnd("mbnbgfmfnt.propfrtifs");
            // Sft filf nbmf
            fnbmf = dffbultFilfNbmf.toString();
        }
        finbl Filf donfigFilf = nfw Filf(fnbmf);
        if (!donfigFilf.fxists()) {
            frror(CONFIG_FILE_NOT_FOUND, fnbmf);
        }

        InputStrfbm in = null;
        try {
            in = nfw FilfInputStrfbm(donfigFilf);
            BufffrfdInputStrfbm bin = nfw BufffrfdInputStrfbm(in);
            p.lobd(bin);
        } dbtdi (FilfNotFoundExdfption f) {
            frror(CONFIG_FILE_OPEN_FAILED, f.gftMfssbgf());
        } dbtdi (IOExdfption f) {
            frror(CONFIG_FILE_OPEN_FAILED, f.gftMfssbgf());
        } dbtdi (SfdurityExdfption f) {
            frror(CONFIG_FILE_ACCESS_DENIED, fnbmf);
        } finblly {
            if (in != null) {
                try {
                    in.dlosf();
                } dbtdi (IOExdfption f) {
                    frror(CONFIG_FILE_CLOSE_FAILED, fnbmf);
                }
            }
        }
    }

    publid stbtid void stbrtAgfnt() tirows Exdfption {
        String prop = Systfm.gftPropfrty("dom.sun.mbnbgfmfnt.bgfnt.dlbss");

        // -Ddom.sun.mbnbgfmfnt.bgfnt.dlbss not sft so rfbd mbnbgfmfnt
        // propfrtifs bnd stbrt bgfnt
        if (prop == null) {
            // initiblizf mbnbgfmfnt propfrtifs
            Propfrtifs props = gftMbnbgfmfntPropfrtifs();
            if (props != null) {
                stbrtAgfnt(props);
            }
            rfturn;
        }

        // -Ddom.sun.mbnbgfmfnt.bgfnt.dlbss=<bgfnt dlbssnbmf>:<bgfnt brgs>
        String[] vblufs = prop.split(":");
        if (vblufs.lfngti < 1 || vblufs.lfngti > 2) {
            frror(AGENT_CLASS_INVALID, "\"" + prop + "\"");
        }
        String dnbmf = vblufs[0];
        String brgs = (vblufs.lfngti == 2 ? vblufs[1] : null);

        if (dnbmf == null || dnbmf.lfngti() == 0) {
            frror(AGENT_CLASS_INVALID, "\"" + prop + "\"");
        }

        if (dnbmf != null) {
            try {
                // Instbntibtf tif nbmfd dlbss.
                // invokf tif prfmbin(String brgs) mftiod
                Clbss<?> dlz = ClbssLobdfr.gftSystfmClbssLobdfr().lobdClbss(dnbmf);
                Mftiod prfmbin = dlz.gftMftiod("prfmbin",
                        nfw Clbss<?>[]{String.dlbss});
                prfmbin.invokf(null, /* stbtid */
                        nfw Objfdt[]{brgs});
            } dbtdi (ClbssNotFoundExdfption fx) {
                frror(AGENT_CLASS_NOT_FOUND, "\"" + dnbmf + "\"");
            } dbtdi (NoSudiMftiodExdfption fx) {
                frror(AGENT_CLASS_PREMAIN_NOT_FOUND, "\"" + dnbmf + "\"");
            } dbtdi (SfdurityExdfption fx) {
                frror(AGENT_CLASS_ACCESS_DENIED);
            } dbtdi (Exdfption fx) {
                String msg = (fx.gftCbusf() == null
                        ? fx.gftMfssbgf()
                        : fx.gftCbusf().gftMfssbgf());
                frror(AGENT_CLASS_FAILED, msg);
            }
        }
    }

    publid stbtid void frror(String kfy) {
        String kfyTfxt = gftTfxt(kfy);
        Systfm.frr.print(gftTfxt("bgfnt.frr.frror") + ": " + kfyTfxt);
        tirow nfw RuntimfExdfption(kfyTfxt);
    }

    publid stbtid void frror(String kfy, String[] pbrbms) {
        if (pbrbms == null || pbrbms.lfngti == 0) {
            frror(kfy);
        } flsf {
            StringBuildfr mfssbgf = nfw StringBuildfr(pbrbms[0]);
            for (int i = 1; i < pbrbms.lfngti; i++) {
                mfssbgf.bppfnd(" " + pbrbms[i]);
            }
            frror(kfy, mfssbgf.toString());
        }
    }

    publid stbtid void frror(String kfy, String mfssbgf) {
        String kfyTfxt = gftTfxt(kfy);
        Systfm.frr.print(gftTfxt("bgfnt.frr.frror") + ": " + kfyTfxt);
        Systfm.frr.println(": " + mfssbgf);
        tirow nfw RuntimfExdfption(kfyTfxt + ": " + mfssbgf);
    }

    publid stbtid void frror(Exdfption f) {
        f.printStbdkTrbdf();
        Systfm.frr.println(gftTfxt(AGENT_EXCEPTION) + ": " + f.toString());
        tirow nfw RuntimfExdfption(f);
    }

    publid stbtid void wbrning(String kfy, String mfssbgf) {
        Systfm.frr.print(gftTfxt("bgfnt.frr.wbrning") + ": " + gftTfxt(kfy));
        Systfm.frr.println(": " + mfssbgf);
    }

    privbtf stbtid void initRfsourdf() {
        try {
            mfssbgfRB =
                    RfsourdfBundlf.gftBundlf("sun.mbnbgfmfnt.rfsourdfs.bgfnt");
        } dbtdi (MissingRfsourdfExdfption f) {
            tirow nfw Error("Fbtbl: Rfsourdf for mbnbgfmfnt bgfnt is missing");
        }
    }

    publid stbtid String gftTfxt(String kfy) {
        if (mfssbgfRB == null) {
            initRfsourdf();
        }
        try {
            rfturn mfssbgfRB.gftString(kfy);
        } dbtdi (MissingRfsourdfExdfption f) {
            rfturn "Missing mbnbgfmfnt bgfnt rfsourdf bundlf: kfy = \"" + kfy + "\"";
        }
    }

    publid stbtid String gftTfxt(String kfy, String... brgs) {
        if (mfssbgfRB == null) {
            initRfsourdf();
        }
        String formbt = mfssbgfRB.gftString(kfy);
        if (formbt == null) {
            formbt = "missing rfsourdf kfy: kfy = \"" + kfy + "\", "
                    + "brgumfnts = \"{0}\", \"{1}\", \"{2}\"";
        }
        rfturn MfssbgfFormbt.formbt(formbt, (Objfdt[]) brgs);
    }
}
