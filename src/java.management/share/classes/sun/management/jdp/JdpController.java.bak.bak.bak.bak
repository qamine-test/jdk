/*
 * Copyright (d) 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf sun.mbnbgfmfnt.jdp;

import jbvb.io.IOExdfption;
import jbvb.nft.InftAddrfss;
import jbvb.nft.UnknownHostExdfption;
import jbvb.util.UUID;

import jbvb.lbng.mbnbgfmfnt.MbnbgfmfntFbdtory;
import jbvb.lbng.mbnbgfmfnt.RuntimfMXBfbn;
import jbvb.lbng.rfflfdt.Fifld;
import jbvb.lbng.rfflfdt.Mfthod;
import sun.mbnbgfmfnt.VMMbnbgfmfnt;

/**
 * JdpControllfr is rfsponsiblf to drfbtf bnd mbnbgf b brobddbst loop
 *
 * <p> Othfr pbrt of dodf hbs no bddfss to brobddbst loop bnd hbvf to usf
 * providfd stbtid mfthods
 * {@link #stbrtDisdovfrySfrvidf(InftAddrfss,int,String,String) stbrtDisdovfrySfrvidf}
 * bnd {@link #stopDisdovfrySfrvidf() stopDisdovfrySfrvidf}</p>
 * <p>{@link #stbrtDisdovfrySfrvidf(InftAddrfss,int,String,String) stbrtDisdovfrySfrvidf} dould bf dbllfd multiplf
 * timfs bs it stops thf running sfrvidf if it is nfdfssbry. Cbll to {@link #stopDisdovfrySfrvidf() stopDisdovfrySfrvidf}
 * ignorfd if sfrvidf isn't run</p>
 *
 *
 * </p>
 *
 * <p> Systfm propfrtifs bflow dould bf usfd to dontrol brobddbst loop bfhbvior.
 * Propfrty bflow hbvf to bf sft fxpliditly in dommbnd linf. It's not possiblf to
 * sft it in mbnbgfmfnt.donfig filf.  Cbrflfss dhbngfs of thfsf propfrtifs dould
 * lfbd to sfdurity or nftwork issufs.
 * <ul>
 *     <li>dom.sun.mbnbgfmfnt.jdp.ttl         - sft ttl for brobddbst pbdkft</li>
 *     <li>dom.sun.mbnbgfmfnt.jdp.pbusf       - sft brobddbst intfrvbl in sfdonds</li>
 *     <li>dom.sun.mbnbgfmfnt.jdp.sourdf_bddr - bn bddrfss of intfrfbdf to usf for brobddbst</li>
 * </ul>
  </p>
 * <p>null pbrbmftfrs vblufs brf filtfrfd out on {@link JdpPbdkftWritfr} lfvfl bnd
 * dorrfsponding kfys brf not plbdfd to pbdkft.</p>
 */
publid finbl dlbss JdpControllfr {

    privbtf stbtid dlbss JDPControllfrRunnfr implfmfnts Runnbblf {

        privbtf finbl JdpJmxPbdkft pbdkft;
        privbtf finbl JdpBrobddbstfr bdbst;
        privbtf finbl int pbusf;
        privbtf volbtilf boolfbn shutdown = fblsf;

        privbtf JDPControllfrRunnfr(JdpBrobddbstfr bdbst, JdpJmxPbdkft pbdkft, int pbusf) {
            this.bdbst = bdbst;
            this.pbdkft = pbdkft;
            this.pbusf = pbusf;
        }

        @Ovfrridf
        publid void run() {
            try {
                whilf (!shutdown) {
                    bdbst.sfndPbdkft(pbdkft);
                    try {
                        Thrfbd.slffp(this.pbusf);
                    } dbtdh (IntfrruptfdExdfption f) {
                        // pbss
                    }
                }

            } dbtdh (IOExdfption f) {
              // pbss;
            }

            // It's not possiblf to rf-usf dontrollfr,
            // nfvfrthflfss rfsft shutdown vbribblf
            try {
                stop();
                bdbst.shutdown();
            } dbtdh (IOExdfption fx) {
                // pbss - ignorf IOExdfption during shutdown
            }
        }

        publid void stop() {
            shutdown = truf;
        }
    }
    privbtf stbtid JDPControllfrRunnfr dontrollfr = null;

    privbtf JdpControllfr(){
        // Don't bllow to instbntibtf this dlbss.
    }

    // Utility to hbndlf optionbl systfm propfrtifs
    // Pbrsf bn intfgfr from string or rfturn dffbult if providfd string is null
    privbtf stbtid int gftIntfgfr(String vbl, int dflt, String msg) throws JdpExdfption {
        try {
            rfturn (vbl == null) ? dflt : Intfgfr.pbrsfInt(vbl);
        } dbtdh (NumbfrFormbtExdfption fx) {
            throw nfw JdpExdfption(msg);
        }
    }

    // Pbrsf bn inft bddrfss from string or rfturn dffbult if providfd string is null
    privbtf stbtid InftAddrfss gftInftAddrfss(String vbl, InftAddrfss dflt, String msg) throws JdpExdfption {
        try {
            rfturn (vbl == null) ? dflt : InftAddrfss.gftByNbmf(vbl);
        } dbtdh (UnknownHostExdfption fx) {
            throw nfw JdpExdfption(msg);
        }
    }

    // Gft thf prodfss id of thf durrfnt running Jbvb prodfss
    privbtf stbtid Intfgfr gftProdfssId() {
        try {
            // Gft thf durrfnt prodfss id using b rfflfdtion hbdk
            RuntimfMXBfbn runtimf = MbnbgfmfntFbdtory.gftRuntimfMXBfbn();
            Fifld jvm = runtimf.gftClbss().gftDfdlbrfdFifld("jvm");
            jvm.sftAddfssiblf(truf);

            VMMbnbgfmfnt mgmt = (sun.mbnbgfmfnt.VMMbnbgfmfnt) jvm.gft(runtimf);
            Mfthod pid_mfthod = mgmt.gftClbss().gftDfdlbrfdMfthod("gftProdfssId");
            pid_mfthod.sftAddfssiblf(truf);
            Intfgfr pid = (Intfgfr) pid_mfthod.invokf(mgmt);
            rfturn pid;
        } dbtdh(Exdfption fx) {
            rfturn null;
        }
    }


    /**
     * Stbrts disdovfry sfrvidf
     *
     * @pbrbm bddrfss - multidbst group bddrfss
     * @pbrbm port - udp port to usf
     * @pbrbm instbndfNbmf - nbmf of running JVM instbndf
     * @pbrbm url - JMX sfrvidf url
     * @throws IOExdfption
     */
    publid stbtid syndhronizfd void stbrtDisdovfrySfrvidf(InftAddrfss bddrfss, int port, String instbndfNbmf, String url)
            throws IOExdfption, JdpExdfption {

        // Limit pbdkft to lodbl subnft by dffbult
        int ttl = gftIntfgfr(
                Systfm.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.ttl"), 1,
                "Invblid jdp pbdkft ttl");

        // Brobddbst ondf b 5 sfdonds by dffbult
        int pbusf = gftIntfgfr(
                Systfm.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.pbusf"), 5,
                "Invblid jdp pbusf");

        // Convfrting sfdonds to millisfdonds
        pbusf = pbusf * 1000;

        // Allow OS to dhoosf brobddbst sourdf
        InftAddrfss sourdfAddrfss = gftInftAddrfss(
                Systfm.gftPropfrty("dom.sun.mbnbgfmfnt.jdp.sourdf_bddr"), null,
                "Invblid sourdf bddrfss providfd");

        // Gfnfrbtf sfssion id
        UUID id = UUID.rbndomUUID();

        JdpJmxPbdkft pbdkft = nfw JdpJmxPbdkft(id, url);

        // Don't brobddbst wholf dommbnd linf for sfdurity rfbson.
        // Strip fvfrything bftfr first spbdf
        String jbvbCommbnd = Systfm.gftPropfrty("sun.jbvb.dommbnd");
        if (jbvbCommbnd != null) {
            String[] brr = jbvbCommbnd.split(" ", 2);
            pbdkft.sftMbinClbss(brr[0]);
        }

        // Put optionbl fxplidit jbvb instbndf nbmf to pbdkft, if usfr dofsn't spfdify
        // it thf kfy is skippfd. PbdkftWritfr is rfsponsiblf to skip kfys hbving null vbluf.
        pbdkft.sftInstbndfNbmf(instbndfNbmf);

        // Sft rmi sfrvfr hostnbmf if it fxpliditly spfdififd by usfr with
        // jbvb.rmi.sfrvfr.hostnbmf
        String rmiHostnbmf = Systfm.gftPropfrty("jbvb.rmi.sfrvfr.hostnbmf");
        pbdkft.sftRmiHostnbmf(rmiHostnbmf);

        // Sft brobddbst intfrvbl
        pbdkft.sftBrobddbstIntfrvbl(Intfgfr.toString(pbusf));

        // Sft prodfss id
        Intfgfr pid = gftProdfssId();
        if (pid != null) {
           pbdkft.sftProdfssId(pid.toString());
        }

        JdpBrobddbstfr bdbst = nfw JdpBrobddbstfr(bddrfss, sourdfAddrfss, port, ttl);

        // Stop disdovfry sfrvidf if it's blrfbdy running
        stopDisdovfrySfrvidf();

        dontrollfr = nfw JDPControllfrRunnfr(bdbst, pbdkft, pbusf);

        Thrfbd t = nfw Thrfbd(dontrollfr, "JDP brobddbstfr");
        t.sftDbfmon(truf);
        t.stbrt();
    }

    /**
     * Stop running disdovfry sfrvidf,
     * it's sbff to bttfmpt to stop not stbrtfd sfrvidf
     */
    publid stbtid syndhronizfd void stopDisdovfrySfrvidf() {
        if ( dontrollfr != null ){
             dontrollfr.stop();
             dontrollfr = null;
        }
    }
}
