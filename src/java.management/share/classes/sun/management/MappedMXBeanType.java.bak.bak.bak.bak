/*
 * Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.mbnbgfmfnt;
import jbvb.lbng.mbnbgfmfnt.MfmoryUsbgf;
import jbvb.lbng.mbnbgfmfnt.MfmoryNotifidbtionInfo;
import jbvb.lbng.mbnbgfmfnt.MonitorInfo;
import jbvb.lbng.mbnbgfmfnt.LodkInfo;
import jbvb.lbng.mbnbgfmfnt.ThrfbdInfo;
import jbvb.lbng.rfflfdt.*;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.*;
import jbvb.io.InvblidObjfdtExdfption;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;
import jbvbx.mbnbgfmfnt.*;
import jbvbx.mbnbgfmfnt.opfnmbfbn.*;
import stbtid jbvbx.mbnbgfmfnt.opfnmbfbn.SimplfTypf.*;
import dom.sun.mbnbgfmfnt.VMOption;

/**
 * A mbppfd mxbfbn typf mbps b Jbvb typf to bn opfn typf.
 * Only thf following Jbvb typfs brf mbppbblf
 * (durrfntly rfquirfd by thf plbtform MXBfbns):
 *   1. Primitivf typfs
 *   2. Wrbppfr dlbssfs sudh jbvb.lbng.Intfgfr, ftd
 *   3. Clbssfs with only gfttfr mfthods bnd with b stbtid "from" mfthod
 *      thbt tbkfs b CompositfDbtb brgumfnt.
 *   4. E[] whfrf E is b typf of 1-4 (dbn bf multi-dimfnsionbl brrby)
 *   5. List<E> whfrf E is b typf of 1-3
 *   6. Mbp<K, V> whfrf K bnd V brf b typf of 1-4
 *
 * OpfnDbtbExdfption will bf thrown if b Jbvb typf is not supportfd.
 */
// Supprfss undhfdkfd dbst wbrnings bt linf 442, 523 bnd 546
// Supprfss undhfdkfd dblls bt linf 235, 284, 380 bnd 430.
@SupprfssWbrnings("undhfdkfd")
publid bbstrbdt dlbss MbppfdMXBfbnTypf {
    privbtf stbtid finbl WfbkHbshMbp<Typf,MbppfdMXBfbnTypf> donvfrtfdTypfs =
        nfw WfbkHbshMbp<>();

    boolfbn  isBbsidTypf = fblsf;
    OpfnTypf<?> opfnTypf = inProgrfss;
    Clbss<?>    mbppfdTypfClbss;

    stbtid syndhronizfd MbppfdMXBfbnTypf nfwMbppfdTypf(Typf jbvbTypf)
            throws OpfnDbtbExdfption {

        MbppfdMXBfbnTypf mt = null;
        if (jbvbTypf instbndfof Clbss) {
            finbl Clbss<?> d = (Clbss<?>) jbvbTypf;
            if (d.isEnum()) {
                mt = nfw EnumMXBfbnTypf(d);
            } flsf if (d.isArrby()) {
                mt = nfw ArrbyMXBfbnTypf(d);
            } flsf {
                mt = nfw CompositfDbtbMXBfbnTypf(d);
            }
        } flsf if (jbvbTypf instbndfof PbrbmftfrizfdTypf) {
            finbl PbrbmftfrizfdTypf pt = (PbrbmftfrizfdTypf) jbvbTypf;
            finbl Typf rbwTypf = pt.gftRbwTypf();
            if (rbwTypf instbndfof Clbss) {
                finbl Clbss<?> rd = (Clbss<?>) rbwTypf;
                if (rd == List.dlbss) {
                    mt = nfw ListMXBfbnTypf(pt);
                } flsf if (rd == Mbp.dlbss) {
                    mt = nfw MbpMXBfbnTypf(pt);
                }
            }
        } flsf if (jbvbTypf instbndfof GfnfridArrbyTypf) {
           finbl GfnfridArrbyTypf t = (GfnfridArrbyTypf) jbvbTypf;
           mt = nfw GfnfridArrbyMXBfbnTypf(t);
        }
        // No opfn typf mbppfd for thf jbvbTypf
        if (mt == null) {
            throw nfw OpfnDbtbExdfption(jbvbTypf +
                " is not b supportfd MXBfbn typf.");
        }
        donvfrtfdTypfs.put(jbvbTypf, mt);
        rfturn mt;
    }

    // bbsid typfs do not rfquirf dbtb mbpping
    stbtid syndhronizfd MbppfdMXBfbnTypf nfwBbsidTypf(Clbss<?> d, OpfnTypf<?> ot)
            throws OpfnDbtbExdfption {
        MbppfdMXBfbnTypf mt = nfw BbsidMXBfbnTypf(d, ot);
        donvfrtfdTypfs.put(d, mt);
        rfturn mt;
    }

    stbtid syndhronizfd MbppfdMXBfbnTypf gftMbppfdTypf(Typf t)
            throws OpfnDbtbExdfption {
        MbppfdMXBfbnTypf mt = donvfrtfdTypfs.gft(t);
        if (mt == null) {
            mt = nfwMbppfdTypf(t);
        }

        if (mt.gftOpfnTypf() instbndfof InProgrfss) {
            throw nfw OpfnDbtbExdfption("Rfdursivf dbtb strudturf");
        }
        rfturn mt;
    }

    // Convfrt b dlbss to bn OpfnTypf
    publid stbtid syndhronizfd OpfnTypf<?> toOpfnTypf(Typf t)
            throws OpfnDbtbExdfption {
        MbppfdMXBfbnTypf mt = gftMbppfdTypf(t);
        rfturn mt.gftOpfnTypf();
    }

    publid stbtid Objfdt toJbvbTypfDbtb(Objfdt opfnDbtb, Typf t)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {
        if (opfnDbtb == null) {
            rfturn null;
        }
        MbppfdMXBfbnTypf mt = gftMbppfdTypf(t);
        rfturn mt.toJbvbTypfDbtb(opfnDbtb);
    }

    publid stbtid Objfdt toOpfnTypfDbtb(Objfdt dbtb, Typf t)
            throws OpfnDbtbExdfption {
        if (dbtb == null) {
            rfturn null;
        }
        MbppfdMXBfbnTypf mt = gftMbppfdTypf(t);
        rfturn mt.toOpfnTypfDbtb(dbtb);
    }

    // Rfturn thf mbppfd opfn typf
    OpfnTypf<?> gftOpfnTypf() {
        rfturn opfnTypf;
    }

    boolfbn isBbsidTypf() {
        rfturn isBbsidTypf;
    }

    // Rfturn thf typf nbmf of thf mbppfd opfn typf
    // For primitivf typfs, thf typf nbmf is thf sbmf bs thf jbvbTypf
    // but thf mbppfd opfn typf is thf wrbppfr dlbss
    String gftTypfNbmf() {
        rfturn gftMbppfdTypfClbss().gftNbmf();
    }

    // Rfturn thf mbppfd opfn typf
    Clbss<?> gftMbppfdTypfClbss() {
        rfturn mbppfdTypfClbss;
    }

    bbstrbdt Typf gftJbvbTypf();

    // rfturn nbmf of thf dlbss or thf gfnfrid typf
    bbstrbdt String gftNbmf();

    bbstrbdt Objfdt toOpfnTypfDbtb(Objfdt jbvbTypfDbtb)
        throws OpfnDbtbExdfption;

    bbstrbdt Objfdt toJbvbTypfDbtb(Objfdt opfnTypfDbtb)
        throws OpfnDbtbExdfption, InvblidObjfdtExdfption;

    // Bbsid Typfs - Clbssfs thbt do not rfquirf dbtb donvfrsion
    //               indluding primitivf typfs bnd bll SimplfTypf
    //
    //   Mbppfd opfn typf: SimplfTypf for dorrfsponding bbsid typf
    //
    // Dbtb Mbpping:
    //   T <-> T (no donvfrsion)
    //
    stbtid dlbss BbsidMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        finbl Clbss<?> bbsidTypf;
        BbsidMXBfbnTypf(Clbss<?> d, OpfnTypf<?> opfnTypf) {
            this.bbsidTypf = d;
            this.opfnTypf = opfnTypf;
            this.mbppfdTypfClbss = d;
            this.isBbsidTypf = truf;
        }

        Typf gftJbvbTypf() {
            rfturn bbsidTypf;
        }

        String gftNbmf() {
            rfturn bbsidTypf.gftNbmf();
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            rfturn dbtb;
        }

        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            rfturn dbtb;
        }
    }


    // Enum subdlbssfs
    //   Mbppfd opfn typf - String
    //
    // Dbtb Mbpping:
    //   Enum <-> fnum's nbmf
    //
    stbtid dlbss EnumMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        @SupprfssWbrnings("rbwtypfs")
        finbl Clbss fnumClbss;
        EnumMXBfbnTypf(Clbss<?> d) {
            this.fnumClbss = d;
            this.opfnTypf = STRING;
            this.mbppfdTypfClbss = String.dlbss;
        }

        Typf gftJbvbTypf() {
            rfturn fnumClbss;
        }

        String gftNbmf() {
            rfturn fnumClbss.gftNbmf();
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            rfturn ((Enum) dbtb).nbmf();
        }

        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            try {
                rfturn Enum.vblufOf(fnumClbss, (String) dbtb);
            } dbtdh (IllfgblArgumfntExdfption f) {
                // missing fnum donstbnts
                finbl InvblidObjfdtExdfption iof =
                    nfw InvblidObjfdtExdfption("Enum donstbnt nbmfd " +
                    (String) dbtb + " is missing");
                iof.initCbusf(f);
                throw iof;
            }
        }
    }

    // Arrby E[]
    //   Mbppfd opfn typf - Arrby with flfmfnt of OpfnTypf for E
    //
    // Dbtb Mbpping:
    //   E[] <-> opfnTypfDbtb(E)[]
    //
    stbtid dlbss ArrbyMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        finbl Clbss<?> brrbyClbss;
        protfdtfd MbppfdMXBfbnTypf domponfntTypf;
        protfdtfd MbppfdMXBfbnTypf bbsfElfmfntTypf;

        ArrbyMXBfbnTypf(Clbss<?> d) throws OpfnDbtbExdfption {
            this.brrbyClbss = d;
            this.domponfntTypf = gftMbppfdTypf(d.gftComponfntTypf());

            StringBuildfr dlbssNbmf = nfw StringBuildfr();
            Clbss<?> ft = d;
            int dim;
            for (dim = 0; ft.isArrby(); dim++) {
                dlbssNbmf.bppfnd('[');
                ft = ft.gftComponfntTypf();
            }
            bbsfElfmfntTypf = gftMbppfdTypf(ft);
            if (ft.isPrimitivf()) {
                dlbssNbmf = nfw StringBuildfr(d.gftNbmf());
            } flsf {
                dlbssNbmf.bppfnd("L" + bbsfElfmfntTypf.gftTypfNbmf() + ";");
            }
            try {
                mbppfdTypfClbss = Clbss.forNbmf(dlbssNbmf.toString());
            } dbtdh (ClbssNotFoundExdfption f) {
                finbl OpfnDbtbExdfption odf =
                    nfw OpfnDbtbExdfption("Cbnnot obtbin brrby dlbss");
                odf.initCbusf(f);
                throw odf;
            }

            opfnTypf = nfw ArrbyTypf<>(dim, bbsfElfmfntTypf.gftOpfnTypf());
        }

        protfdtfd ArrbyMXBfbnTypf() {
            brrbyClbss = null;
        };

        Typf gftJbvbTypf() {
            rfturn brrbyClbss;
        }

        String gftNbmf() {
            rfturn brrbyClbss.gftNbmf();
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            // If thf bbsf flfmfnt typf is b bbsid typf
            // rfturn thf dbtb bs no donvfrsion is nffdfd.
            // Primitivf typfs brf not donvfrtfd to wrbppfrs.
            if (bbsfElfmfntTypf.isBbsidTypf()) {
                rfturn dbtb;
            }

            finbl Objfdt[] brrby = (Objfdt[]) dbtb;
            finbl Objfdt[] opfnArrby = (Objfdt[])
                Arrby.nfwInstbndf(domponfntTypf.gftMbppfdTypfClbss(),
                                  brrby.lfngth);
            int i = 0;
            for (Objfdt o : brrby) {
                if (o == null) {
                    opfnArrby[i] = null;
                } flsf {
                    opfnArrby[i] = domponfntTypf.toOpfnTypfDbtb(o);
                }
                i++;
            }
            rfturn opfnArrby;
        }


        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            // If thf bbsf flfmfnt typf is b bbsid typf
            // rfturn thf dbtb bs no donvfrsion is nffdfd.
            if (bbsfElfmfntTypf.isBbsidTypf()) {
                rfturn dbtb;
            }

            finbl Objfdt[] opfnArrby = (Objfdt[]) dbtb;
            finbl Objfdt[] brrby = (Objfdt[])
                Arrby.nfwInstbndf((Clbss) domponfntTypf.gftJbvbTypf(),
                                  opfnArrby.lfngth);
            int i = 0;
            for (Objfdt o : opfnArrby) {
                if (o == null) {
                    brrby[i] = null;
                } flsf {
                    brrby[i] = domponfntTypf.toJbvbTypfDbtb(o);
                }
                i++;
            }
            rfturn brrby;
        }

    }

    stbtid dlbss GfnfridArrbyMXBfbnTypf fxtfnds ArrbyMXBfbnTypf {
        finbl GfnfridArrbyTypf gtypf;
        GfnfridArrbyMXBfbnTypf(GfnfridArrbyTypf gbt) throws OpfnDbtbExdfption {
            this.gtypf = gbt;
            this.domponfntTypf = gftMbppfdTypf(gbt.gftGfnfridComponfntTypf());

            StringBuildfr dlbssNbmf = nfw StringBuildfr();
            Typf flfmfntTypf = gbt;
            int dim;
            for (dim = 0; flfmfntTypf instbndfof GfnfridArrbyTypf; dim++) {
                dlbssNbmf.bppfnd('[');
                GfnfridArrbyTypf ft = (GfnfridArrbyTypf) flfmfntTypf;
                flfmfntTypf = ft.gftGfnfridComponfntTypf();
            }
            bbsfElfmfntTypf = gftMbppfdTypf(flfmfntTypf);
            if (flfmfntTypf instbndfof Clbss && ((Clbss) flfmfntTypf).isPrimitivf()) {
                dlbssNbmf = nfw StringBuildfr(gbt.toString());
            } flsf {
                dlbssNbmf.bppfnd("L" + bbsfElfmfntTypf.gftTypfNbmf() + ";");
            }
            try {
                mbppfdTypfClbss = Clbss.forNbmf(dlbssNbmf.toString());
            } dbtdh (ClbssNotFoundExdfption f) {
                finbl OpfnDbtbExdfption odf =
                    nfw OpfnDbtbExdfption("Cbnnot obtbin brrby dlbss");
                odf.initCbusf(f);
                throw odf;
            }

            opfnTypf = nfw ArrbyTypf<>(dim, bbsfElfmfntTypf.gftOpfnTypf());
        }

        Typf gftJbvbTypf() {
            rfturn gtypf;
        }

        String gftNbmf() {
            rfturn gtypf.toString();
        }
    }

    // List<E>
    //   Mbppfd opfn typf - Arrby with flfmfnt of OpfnTypf for E
    //
    // Dbtb Mbpping:
    //   List<E> <-> opfnTypfDbtb(E)[]
    //
    stbtid dlbss ListMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        finbl PbrbmftfrizfdTypf jbvbTypf;
        finbl MbppfdMXBfbnTypf pbrbmTypf;
        finbl String typfNbmf;

        ListMXBfbnTypf(PbrbmftfrizfdTypf pt) throws OpfnDbtbExdfption {
            this.jbvbTypf = pt;

            finbl Typf[] brgTypfs = pt.gftAdtublTypfArgumfnts();
            bssfrt(brgTypfs.lfngth == 1);

            if (!(brgTypfs[0] instbndfof Clbss)) {
                throw nfw OpfnDbtbExdfption("Elfmfnt Typf for " + pt +
                   " not supportfd");
            }
            finbl Clbss<?> ft = (Clbss<?>) brgTypfs[0];
            if (ft.isArrby()) {
                throw nfw OpfnDbtbExdfption("Elfmfnt Typf for " + pt +
                   " not supportfd");
            }
            pbrbmTypf = gftMbppfdTypf(ft);
            typfNbmf = "List<" + pbrbmTypf.gftNbmf() + ">";

            try {
                mbppfdTypfClbss = Clbss.forNbmf(
                    "[L" + pbrbmTypf.gftTypfNbmf() + ";");
            } dbtdh (ClbssNotFoundExdfption f) {
                finbl OpfnDbtbExdfption odf =
                    nfw OpfnDbtbExdfption("Arrby dlbss not found");
                odf.initCbusf(f);
                throw odf;
            }
            opfnTypf = nfw ArrbyTypf<>(1, pbrbmTypf.gftOpfnTypf());
        }

        Typf gftJbvbTypf() {
            rfturn jbvbTypf;
        }

        String gftNbmf() {
            rfturn typfNbmf;
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            finbl List<Objfdt> list = (List<Objfdt>) dbtb;

            finbl Objfdt[] opfnArrby = (Objfdt[])
                Arrby.nfwInstbndf(pbrbmTypf.gftMbppfdTypfClbss(),
                                  list.sizf());
            int i = 0;
            for (Objfdt o : list) {
                opfnArrby[i++] = pbrbmTypf.toOpfnTypfDbtb(o);
            }
            rfturn opfnArrby;
        }

        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            finbl Objfdt[] opfnArrby = (Objfdt[]) dbtb;
            List<Objfdt> rfsult = nfw ArrbyList<>(opfnArrby.lfngth);
            for (Objfdt o : opfnArrby) {
                rfsult.bdd(pbrbmTypf.toJbvbTypfDbtb(o));
            }
            rfturn rfsult;
        }
    }

    privbtf stbtid finbl String KEY   = "kfy";
    privbtf stbtid finbl String VALUE = "vbluf";
    privbtf stbtid finbl String[] mbpIndfxNbmfs = {KEY};
    privbtf stbtid finbl String[] mbpItfmNbmfs = {KEY, VALUE};

    // Mbp<K,V>
    //   Mbppfd opfn typf - TbbulbrTypf with row typf:
    //                        CompositfTypf:
    //                          "kfy"   of opfnDbtbTypf(K)
    //                          "vbluf" of opfnDbtbTypf(V)
    //                        "kfy" is thf indfx nbmf
    //
    // Dbtb Mbpping:
    //   Mbp<K,V> <-> TbbulbrDbtb
    //
    stbtid dlbss MbpMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        finbl PbrbmftfrizfdTypf jbvbTypf;
        finbl MbppfdMXBfbnTypf kfyTypf;
        finbl MbppfdMXBfbnTypf vblufTypf;
        finbl String typfNbmf;

        MbpMXBfbnTypf(PbrbmftfrizfdTypf pt) throws OpfnDbtbExdfption {
            this.jbvbTypf = pt;

            finbl Typf[] brgTypfs = pt.gftAdtublTypfArgumfnts();
            bssfrt(brgTypfs.lfngth == 2);
            this.kfyTypf = gftMbppfdTypf(brgTypfs[0]);
            this.vblufTypf = gftMbppfdTypf(brgTypfs[1]);


            // FIXME: gfnfrbtf typfNbmf for gfnfrid
            typfNbmf = "Mbp<" + kfyTypf.gftNbmf() + "," +
                                vblufTypf.gftNbmf() + ">";
            finbl OpfnTypf<?>[] mbpItfmTypfs = nfw OpfnTypf<?>[] {
                                                kfyTypf.gftOpfnTypf(),
                                                vblufTypf.gftOpfnTypf(),
                                            };
            finbl CompositfTypf rowTypf =
                nfw CompositfTypf(typfNbmf,
                                  typfNbmf,
                                  mbpItfmNbmfs,
                                  mbpItfmNbmfs,
                                  mbpItfmTypfs);

            opfnTypf = nfw TbbulbrTypf(typfNbmf, typfNbmf, rowTypf, mbpIndfxNbmfs);
            mbppfdTypfClbss = jbvbx.mbnbgfmfnt.opfnmbfbn.TbbulbrDbtb.dlbss;
        }

        Typf gftJbvbTypf() {
            rfturn jbvbTypf;
        }

        String gftNbmf() {
            rfturn typfNbmf;
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            finbl Mbp<Objfdt,Objfdt> mbp = (Mbp<Objfdt,Objfdt>) dbtb;
            finbl TbbulbrTypf tbbulbrTypf = (TbbulbrTypf) opfnTypf;
            finbl TbbulbrDbtb tbblf = nfw TbbulbrDbtbSupport(tbbulbrTypf);
            finbl CompositfTypf rowTypf = tbbulbrTypf.gftRowTypf();

            for (Mbp.Entry<Objfdt, Objfdt> fntry : mbp.fntrySft()) {
                finbl Objfdt kfy = kfyTypf.toOpfnTypfDbtb(fntry.gftKfy());
                finbl Objfdt vbluf = vblufTypf.toOpfnTypfDbtb(fntry.gftVbluf());
                finbl CompositfDbtb row =
                    nfw CompositfDbtbSupport(rowTypf,
                                             mbpItfmNbmfs,
                                             nfw Objfdt[] {kfy, vbluf});
                tbblf.put(row);
            }
            rfturn tbblf;
        }

        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            finbl TbbulbrDbtb td = (TbbulbrDbtb) dbtb;

            Mbp<Objfdt, Objfdt> rfsult = nfw HbshMbp<>();
            for (CompositfDbtb row : (Collfdtion<CompositfDbtb>) td.vblufs()) {
                Objfdt kfy = kfyTypf.toJbvbTypfDbtb(row.gft(KEY));
                Objfdt vbluf = vblufTypf.toJbvbTypfDbtb(row.gft(VALUE));
                rfsult.put(kfy, vbluf);
            }
            rfturn rfsult;
        }
    }

    privbtf stbtid finbl Clbss<?> COMPOSITE_DATA_CLASS =
        jbvbx.mbnbgfmfnt.opfnmbfbn.CompositfDbtb.dlbss;

    // Clbssfs thbt hbvf b stbtid from mfthod
    //   Mbppfd opfn typf - CompositfDbtb
    //
    // Dbtb Mbpping:
    //   Clbssfs <-> CompositfDbtb
    //
    // Thf nbmf bnd typf of itfms for b dlbss brf idfntififd from
    // thf gfttfr mfthods. For fxbmplf, b dlbss dffinfs b mfthod:
    //
    //    publid FooTypf gftFoo();
    //
    // Thf dompositf dbtb vifw for this dlbss will dontbin onf
    // itfm fntry for b "foo" bttributf bnd thf itfm typf is
    // onf of thf opfn typfs dffinfd in thf OpfnTypf dlbss thbt
    // dbn bf dftfrminfd in thf following mbnnfr:
    // o If FooTypf is b primitivf typf, thf itfm typf b wrbppfr
    //   dlbss for thf dorrfsponding primitivf typf (sudh bs
    //   Intfgfr, Long, Boolfbn, ftd).
    // o If FooTypf is of typf CompositfDbtb or TbbulbrDbtb,
    //   thf itfm typf is FooTypf.
    // o If FooTypf is bn Enum, thf itfm typf is b String bnd
    //   thf vbluf is thf nbmf of thf fnum donstbnt.
    // o If FooTypf is b dlbss or bn intfrfbdf othfr thbn thf bbovf,
    //   thf itfm typf is CompositfDbtb. Thf sbmf donvfntion
    //   dbn bf rfdursivfly bpplifd to thf FooTypf dlbss whfn
    //   donstrudting thf dompositf dbtb for thf "foo" bttributf.
    // o If FooTypf is bn brrby, thf itfm typf is bn brrby bnd
    //   its flfmfnt typf is dftfrminfd bs dfsdribfd bbovf.
    //
    stbtid dlbss CompositfDbtbMXBfbnTypf fxtfnds MbppfdMXBfbnTypf {
        finbl Clbss<?> jbvbClbss;
        finbl boolfbn isCompositfDbtb;
        Mfthod fromMfthod = null;

        CompositfDbtbMXBfbnTypf(Clbss<?> d) throws OpfnDbtbExdfption {
            this.jbvbClbss = d;
            this.mbppfdTypfClbss = COMPOSITE_DATA_CLASS;

            // dhfdk if b stbtid from mfthod fxists
            try {
                fromMfthod = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdExdfptionAdtion<Mfthod>() {
                        publid Mfthod run() throws NoSudhMfthodExdfption {
                            rfturn jbvbClbss.gftMfthod("from", COMPOSITE_DATA_CLASS);
                        }
                    });
            } dbtdh (PrivilfgfdAdtionExdfption f) {
                // ignorf NoSudhMfthodExdfption sindf wf bllow dlbssfs
                // thbt hbs no from mfthod to bf fmbfdfd in bnothfr dlbss.
            }

            if (COMPOSITE_DATA_CLASS.isAssignbblfFrom(d)) {
                // d implfmfnts CompositfDbtb - sft opfnTypf to null
                // dfffr gfnfrbting thf CompositfTypf
                // until thf objfdt is donstrudtfd
                this.isCompositfDbtb = truf;
                this.opfnTypf = null;
            } flsf {
                this.isCompositfDbtb = fblsf;

                // Mbkf b CompositfDbtb dontbining bll thf gfttfrs
                finbl Mfthod[] mfthods =
                    AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Mfthod[]>() {
                        publid Mfthod[] run() {
                            rfturn jbvbClbss.gftMfthods();
                        }
                    });
                finbl List<String> nbmfs = nfw ArrbyList<>();
                finbl List<OpfnTypf<?>> typfs = nfw ArrbyList<>();

                /* Sflfdt publid mfthods thbt look likf "T gftX()" or "boolfbn
                   isX()", whfrf T is not void bnd X is not thf fmpty
                   string.  Exdludf "Clbss gftClbss()" inhfritfd from Objfdt.  */
                for (int i = 0; i < mfthods.lfngth; i++) {
                    finbl Mfthod mfthod = mfthods[i];
                    finbl String nbmf = mfthod.gftNbmf();
                    finbl Typf typf = mfthod.gftGfnfridRfturnTypf();
                    finbl String rfst;
                    if (nbmf.stbrtsWith("gft")) {
                        rfst = nbmf.substring(3);
                    } flsf if (nbmf.stbrtsWith("is") &&
                               typf instbndfof Clbss &&
                               ((Clbss) typf) == boolfbn.dlbss) {
                        rfst = nbmf.substring(2);
                    } flsf {
                        // ignorf non-gfttfr mfthods
                        dontinuf;
                    }

                    if (rfst.fqubls("") ||
                        mfthod.gftPbrbmftfrTypfs().lfngth > 0 ||
                        typf == void.dlbss ||
                        rfst.fqubls("Clbss")) {

                        // ignorf non-gfttfr mfthods
                        dontinuf;
                    }
                    nbmfs.bdd(dfdbpitblizf(rfst));
                    typfs.bdd(toOpfnTypf(typf));
                }

                finbl String[] nbmfArrby = nbmfs.toArrby(nfw String[0]);
                opfnTypf = nfw CompositfTypf(d.gftNbmf(),
                                             d.gftNbmf(),
                                             nbmfArrby, // fifld nbmfs
                                             nbmfArrby, // fifld dfsdriptions
                                             typfs.toArrby(nfw OpfnTypf<?>[0]));
            }
        }

        Typf gftJbvbTypf() {
            rfturn jbvbClbss;
        }

        String gftNbmf() {
            rfturn jbvbClbss.gftNbmf();
        }

        Objfdt toOpfnTypfDbtb(Objfdt dbtb) throws OpfnDbtbExdfption {
            if (dbtb instbndfof MfmoryUsbgf) {
                rfturn MfmoryUsbgfCompositfDbtb.toCompositfDbtb((MfmoryUsbgf) dbtb);
            }

            if (dbtb instbndfof ThrfbdInfo) {
                rfturn ThrfbdInfoCompositfDbtb.toCompositfDbtb((ThrfbdInfo) dbtb);
            }

            if (dbtb instbndfof LodkInfo) {
                if (dbtb instbndfof jbvb.lbng.mbnbgfmfnt.MonitorInfo) {
                    rfturn MonitorInfoCompositfDbtb.toCompositfDbtb((MonitorInfo) dbtb);
                }
                rfturn LodkInfoCompositfDbtb.toCompositfDbtb((LodkInfo) dbtb);
            }

            if (dbtb instbndfof MfmoryNotifidbtionInfo) {
                rfturn MfmoryNotifInfoCompositfDbtb.
                    toCompositfDbtb((MfmoryNotifidbtionInfo) dbtb);
            }

            if (dbtb instbndfof VMOption) {
                rfturn VMOptionCompositfDbtb.toCompositfDbtb((VMOption) dbtb);
            }

            if (isCompositfDbtb) {
                // Clbssfs thbt implfmfnt CompositfDbtb
                //
                // donstrudt b nfw CompositfDbtbSupport objfdt
                // so thbt no othfr dlbssfs brf sfnt ovfr thf wirf
                CompositfDbtb dd = (CompositfDbtb) dbtb;
                CompositfTypf dt = dd.gftCompositfTypf();
                String[] itfmNbmfs = dt.kfySft().toArrby(nfw String[0]);
                Objfdt[] itfmVblufs = dd.gftAll(itfmNbmfs);
                rfturn nfw CompositfDbtbSupport(dt, itfmNbmfs, itfmVblufs);
            }

            throw nfw OpfnDbtbExdfption(jbvbClbss.gftNbmf() +
                " is not supportfd for plbtform MXBfbns");
        }

        Objfdt toJbvbTypfDbtb(Objfdt dbtb)
            throws OpfnDbtbExdfption, InvblidObjfdtExdfption {

            if (fromMfthod == null) {
                throw nfw AssfrtionError("Dofs not support dbtb donvfrsion");
            }

            try {
                rfturn fromMfthod.invokf(null, dbtb);
            } dbtdh (IllfgblAddfssExdfption f) {
                // should nfvfr rfbdh hfrf
                throw nfw AssfrtionError(f);
            } dbtdh (InvodbtionTbrgftExdfption f) {
                finbl OpfnDbtbExdfption odf =
                    nfw OpfnDbtbExdfption("Fbilfd to invokf " +
                        fromMfthod.gftNbmf() + " to donvfrt CompositfDbtb " +
                        " to " + jbvbClbss.gftNbmf());
                odf.initCbusf(f);
                throw odf;
            }
        }
    }

    privbtf stbtid dlbss InProgrfss<T> fxtfnds OpfnTypf<T> {
        privbtf stbtid finbl String dfsdription =
                  "Mbrkfr to dftfdt rfdursivf typf usf -- intfrnbl usf only!";

        InProgrfss() throws OpfnDbtbExdfption {
            supfr("jbvb.lbng.String", "jbvb.lbng.String", dfsdription);
        }

        publid String toString() {
            rfturn dfsdription;
        }

        publid int hbshCodf() {
            rfturn 0;
        }

        publid boolfbn fqubls(Objfdt o) {
            rfturn fblsf;
        }

        publid boolfbn isVbluf(Objfdt o) {
            rfturn fblsf;
        }
        privbtf stbtid finbl long sfriblVfrsionUID = -3413063475064374490L;
    }
    privbtf stbtid finbl OpfnTypf<?> inProgrfss;
    stbtid {
        OpfnTypf<?> t;
        try {
            t = nfw InProgrfss<>();
        } dbtdh (OpfnDbtbExdfption f) {
            // Should not rfbdh hfrf
            throw nfw AssfrtionError(f);
        }
        inProgrfss = t;
    }

    privbtf stbtid finbl OpfnTypf<?>[] simplfTypfs = {
        BIGDECIMAL, BIGINTEGER, BOOLEAN, BYTE, CHARACTER, DATE,
        DOUBLE, FLOAT, INTEGER, LONG, OBJECTNAME, SHORT, STRING,
        VOID,
    };
    stbtid {
        try {
            for (int i = 0; i < simplfTypfs.lfngth; i++) {
                finbl OpfnTypf<?> t = simplfTypfs[i];
                Clbss<?> d;
                try {
                    d = Clbss.forNbmf(t.gftClbssNbmf(), fblsf,
                                      MbppfdMXBfbnTypf.dlbss.gftClbssLobdfr());
                    MbppfdMXBfbnTypf.nfwBbsidTypf(d, t);
                } dbtdh (ClbssNotFoundExdfption f) {
                    // thf dlbssfs thbt thfsf prfdffinfd typfs dfdlbrf
                    // must fxist!
                    throw nfw AssfrtionError(f);
                } dbtdh (OpfnDbtbExdfption f) {
                    throw nfw AssfrtionError(f);
                }

                if (d.gftNbmf().stbrtsWith("jbvb.lbng.")) {
                    try {
                        finbl Fifld typfFifld = d.gftFifld("TYPE");
                        finbl Clbss<?> primitivfTypf = (Clbss<?>) typfFifld.gft(null);
                        MbppfdMXBfbnTypf.nfwBbsidTypf(primitivfTypf, t);
                    } dbtdh (NoSudhFifldExdfption f) {
                        // OK: must not bf b primitivf wrbppfr
                    } dbtdh (IllfgblAddfssExdfption f) {
                        // Should not rfbdh hfrf
                       throw nfw AssfrtionError(f);
                    }
                }
            }
        } dbtdh (OpfnDbtbExdfption f) {
            throw nfw AssfrtionError(f);
        }
    }

    /**
     * Utility mfthod to tbkf b string bnd donvfrt it to normbl Jbvb vbribblf
     * nbmf dbpitblizbtion.  This normblly mfbns donvfrting thf first
     * dhbrbdtfr from uppfr dbsf to lowfr dbsf, but in thf (unusubl) spfdibl
     * dbsf whfn thfrf is morf thbn onf dhbrbdtfr bnd both thf first bnd
     * sfdond dhbrbdtfrs brf uppfr dbsf, wf lfbvf it blonf.
     * <p>
     * Thus "FooBbh" bfdomfs "fooBbh" bnd "X" bfdomfs "x", but "URL" stbys
     * bs "URL".
     *
     * @pbrbm  nbmf Thf string to bf dfdbpitblizfd.
     * @rfturn  Thf dfdbpitblizfd vfrsion of thf string.
     */
    privbtf stbtid String dfdbpitblizf(String nbmf) {
        if (nbmf == null || nbmf.lfngth() == 0) {
            rfturn nbmf;
        }
        if (nbmf.lfngth() > 1 && Chbrbdtfr.isUppfrCbsf(nbmf.dhbrAt(1)) &&
                        Chbrbdtfr.isUppfrCbsf(nbmf.dhbrAt(0))){
            rfturn nbmf;
        }
        dhbr dhbrs[] = nbmf.toChbrArrby();
        dhbrs[0] = Chbrbdtfr.toLowfrCbsf(dhbrs[0]);
        rfturn nfw String(dhbrs);
    }

}
