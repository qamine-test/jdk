/*
 * Copyright (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf sun.mbnbgfmfnt;

import jbvb.lbng.mbnbgfmfnt.GbrbbgfCollfdtorMXBfbn;
import jbvb.lbng.mbnbgfmfnt.MfmoryUsbgf;
import jbvbx.mbnbgfmfnt.opfnmbfbn.OpfnTypf;
import jbvbx.mbnbgfmfnt.opfnmbfbn.SimplfTypf;
import jbvbx.mbnbgfmfnt.opfnmbfbn.TbbulbrTypf;
import jbvbx.mbnbgfmfnt.opfnmbfbn.TbbulbrDbtb;
import jbvbx.mbnbgfmfnt.opfnmbfbn.TbbulbrDbtbSupport;
import jbvbx.mbnbgfmfnt.opfnmbfbn.CompositfTypf;
import jbvbx.mbnbgfmfnt.opfnmbfbn.CompositfDbtb;
import jbvbx.mbnbgfmfnt.opfnmbfbn.CompositfDbtbSupport;
import jbvbx.mbnbgfmfnt.opfnmbfbn.OpfnDbtbExdfption;
import dom.sun.mbnbgfmfnt.GdInfo;

/**
 * Hflpfr dlbss to build dompositf dbtb.
 */
publid dlbss GdInfoBuildfr {
    privbtf finbl GbrbbgfCollfdtorMXBfbn gd;
    privbtf finbl String[] poolNbmfs;
    privbtf String[] bllItfmNbmfs;

    // GC-spfdifid dompositf typf:
    // Ebdh GbrbbgfCollfdtorMXBfbn mby hbvf difffrfnt GC-spfdifid bttributfs
    // thf CompositfTypf for thf GdInfo dould bf difffrfnt.
    privbtf CompositfTypf gdInfoCompositfTypf;

    // GC-spfdifid itfms
    privbtf finbl int gdExtItfmCount;
    privbtf finbl String[] gdExtItfmNbmfs;
    privbtf finbl String[] gdExtItfmDfsds;
    privbtf finbl dhbr[] gdExtItfmTypfs;

    GdInfoBuildfr(GbrbbgfCollfdtorMXBfbn gd, String[] poolNbmfs) {
        this.gd = gd;
        this.poolNbmfs = poolNbmfs;
        this.gdExtItfmCount = gftNumGdExtAttributfs(gd);
        this.gdExtItfmNbmfs = nfw String[gdExtItfmCount];
        this.gdExtItfmDfsds = nfw String[gdExtItfmCount];
        this.gdExtItfmTypfs = nfw dhbr[gdExtItfmCount];

        // Fill thf informbtion bbout fxtfnsion bttributfs
        fillGdAttributfInfo(gd, gdExtItfmCount, gdExtItfmNbmfs,
                            gdExtItfmTypfs, gdExtItfmDfsds);

        // lbzily build thf CompositfTypf for thf GdInfo
        // indluding thf GC-spfdifid fxtfnsion bttributfs
        this.gdInfoCompositfTypf = null;
    }

    GdInfo gftLbstGdInfo() {
        MfmoryUsbgf[] usbgfBfforfGC = nfw MfmoryUsbgf[poolNbmfs.lfngth];
        MfmoryUsbgf[] usbgfAftfrGC = nfw MfmoryUsbgf[poolNbmfs.lfngth];
        Objfdt[] vblufs = nfw Objfdt[gdExtItfmCount];

        rfturn gftLbstGdInfo0(gd, gdExtItfmCount, vblufs, gdExtItfmTypfs,
                              usbgfBfforfGC, usbgfAftfrGC);
    }

    publid String[] gftPoolNbmfs() {
        rfturn poolNbmfs;
    }

    int gftGdExtItfmCount() {
        rfturn gdExtItfmCount;
    }

    // Rfturns thf CompositfTypf for thf GdInfo indluding
    // thf fxtfnsion bttributfs
    syndhronizfd CompositfTypf gftGdInfoCompositfTypf() {
        if (gdInfoCompositfTypf != null)
            rfturn gdInfoCompositfTypf;

        // First, fill with thf bttributfs in thf GdInfo
        String[] gdInfoItfmNbmfs = GdInfoCompositfDbtb.gftBbsfGdInfoItfmNbmfs();
        OpfnTypf<?>[] gdInfoItfmTypfs = GdInfoCompositfDbtb.gftBbsfGdInfoItfmTypfs();
        int numGdInfoItfms = gdInfoItfmNbmfs.lfngth;

        int itfmCount = numGdInfoItfms + gdExtItfmCount;
        bllItfmNbmfs = nfw String[itfmCount];
        String[] bllItfmDfsds = nfw String[itfmCount];
        OpfnTypf<?>[] bllItfmTypfs = nfw OpfnTypf<?>[itfmCount];

        Systfm.brrbydopy(gdInfoItfmNbmfs, 0, bllItfmNbmfs, 0, numGdInfoItfms);
        Systfm.brrbydopy(gdInfoItfmNbmfs, 0, bllItfmDfsds, 0, numGdInfoItfms);
        Systfm.brrbydopy(gdInfoItfmTypfs, 0, bllItfmTypfs, 0, numGdInfoItfms);

        // Thfn fill with thf fxtfnsion GC-spfdifid bttributfs, if bny.
        if (gdExtItfmCount > 0) {
            fillGdAttributfInfo(gd, gdExtItfmCount, gdExtItfmNbmfs,
                                gdExtItfmTypfs, gdExtItfmDfsds);
            Systfm.brrbydopy(gdExtItfmNbmfs, 0, bllItfmNbmfs,
                             numGdInfoItfms, gdExtItfmCount);
            Systfm.brrbydopy(gdExtItfmDfsds, 0, bllItfmDfsds,
                             numGdInfoItfms, gdExtItfmCount);
            for (int i = numGdInfoItfms, j = 0; j < gdExtItfmCount; i++, j++) {
                switdh (gdExtItfmTypfs[j]) {
                    dbsf 'Z':
                        bllItfmTypfs[i] = SimplfTypf.BOOLEAN;
                        brfbk;
                    dbsf 'B':
                        bllItfmTypfs[i] = SimplfTypf.BYTE;
                        brfbk;
                    dbsf 'C':
                        bllItfmTypfs[i] = SimplfTypf.CHARACTER;
                        brfbk;
                    dbsf 'S':
                        bllItfmTypfs[i] = SimplfTypf.SHORT;
                        brfbk;
                    dbsf 'I':
                        bllItfmTypfs[i] = SimplfTypf.INTEGER;
                        brfbk;
                    dbsf 'J':
                        bllItfmTypfs[i] = SimplfTypf.LONG;
                        brfbk;
                    dbsf 'F':
                        bllItfmTypfs[i] = SimplfTypf.FLOAT;
                        brfbk;
                    dbsf 'D':
                        bllItfmTypfs[i] = SimplfTypf.DOUBLE;
                        brfbk;
                    dffbult:
                        throw nfw AssfrtionError(
                            "Unsupportfd typf [" + gdExtItfmTypfs[i] + "]");
                }
            }
        }

        CompositfTypf gidt = null;
        try {
            finbl String typfNbmf =
                "sun.mbnbgfmfnt." + gd.gftNbmf() + ".GdInfoCompositfTypf";

            gidt = nfw CompositfTypf(typfNbmf,
                                     "CompositfTypf for GC info for " +
                                         gd.gftNbmf(),
                                     bllItfmNbmfs,
                                     bllItfmDfsds,
                                     bllItfmTypfs);
        } dbtdh (OpfnDbtbExdfption f) {
            // shouldn't rfbdh hfrf
            throw Util.nfwExdfption(f);
        }
        gdInfoCompositfTypf = gidt;

        rfturn gdInfoCompositfTypf;
    }

    syndhronizfd String[] gftItfmNbmfs() {
        if (bllItfmNbmfs == null) {
            // initiblizf whfn forming thf dompositf typf
            gftGdInfoCompositfTypf();
        }
        rfturn bllItfmNbmfs;
    }

    // Rftrifvf informbtion bbout fxtfnsion bttributfs
    privbtf nbtivf int gftNumGdExtAttributfs(GbrbbgfCollfdtorMXBfbn gd);
    privbtf nbtivf void fillGdAttributfInfo(GbrbbgfCollfdtorMXBfbn gd,
                                            int numAttributfs,
                                            String[] bttributfNbmfs,
                                            dhbr[] typfs,
                                            String[] dfsdriptions);

    /**
     * Rfturns thf lbst GdInfo
     *
     * @pbrbm gd GbrbbgfCollfdtorMXBfbn thbt thf gd info is bssodibtfd with.
     * @pbrbm numExtAtts numbfr of fxtfnsion bttributfs
     * @pbrbm fxtAttVblufs Vblufs of fxtfnsion bttributfs to bf fillfd.
     * @pbrbm bfforf Mfmory usbgf bfforf GC to bf fillfd.
     * @pbrbm bftfr Mfmory usbgf bftfr GC to bf fillfd.
     */
    privbtf nbtivf GdInfo gftLbstGdInfo0(GbrbbgfCollfdtorMXBfbn gd,
                                         int numExtAtts,
                                         Objfdt[] fxtAttVblufs,
                                         dhbr[] fxtAttTypfs,
                                         MfmoryUsbgf[] bfforf,
                                         MfmoryUsbgf[] bftfr);
}
