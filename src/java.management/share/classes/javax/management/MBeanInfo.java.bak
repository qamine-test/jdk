/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.mbnbgfmfnt;

import jbvb.io.IOExdfption;
import jbvb.io.StrfbmCorruptfdExdfption;
import jbvb.io.Sfriblizbblf;
import jbvb.io.ObjfdtOutputStrfbm;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.lbng.rfflfdt.Mftiod;
import jbvb.util.Arrbys;
import jbvb.util.Mbp;
import jbvb.util.WfbkHbsiMbp;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.Objfdts;

import stbtid jbvbx.mbnbgfmfnt.ImmutbblfDfsdriptor.nonNullDfsdriptor;

/**
 * <p>Dfsdribfs tif mbnbgfmfnt intfrfbdf fxposfd by bn MBfbn; tibt is,
 * tif sft of bttributfs bnd opfrbtions wiidi brf bvbilbblf for
 * mbnbgfmfnt opfrbtions.  Instbndfs of tiis dlbss brf immutbblf.
 * Subdlbssfs mby bf mutbblf but tiis is not rfdommfndfd.</p>
 *
 * <p id="info-dibngfd">Usublly tif {@dodf MBfbnInfo} for bny givfn MBfbn dofs
 * not dibngf ovfr tif lifftimf of tibt MBfbn.  Dynbmid MBfbns dbn dibngf tifir
 * {@dodf MBfbnInfo} bnd in tibt dbsf it is rfdommfndfd tibt tify fmit b {@link
 * Notifidbtion} witi b {@linkplbin Notifidbtion#gftTypf() typf} of {@dodf
 * "jmx.mbfbn.info.dibngfd"} bnd b {@linkplbin Notifidbtion#gftUsfrDbtb()
 * usfrDbtb} tibt is tif nfw {@dodf MBfbnInfo}.  Tiis is not rfquirfd, but
 * providfs b donvfntionbl wby for dlifnts of tif MBfbn to disdovfr tif dibngf.
 * Sff blso tif <b irff="Dfsdriptor.itml#immutbblfInfo">immutbblfInfo</b> bnd
 * <b irff="Dfsdriptor.itml#infoTimfout">infoTimfout</b> fiflds in tif {@dodf
 * MBfbnInfo} {@link Dfsdriptor}.</p>
 *
 * <p>Tif dontfnts of tif <dodf>MBfbnInfo</dodf> for b Dynbmid MBfbn
 * brf dftfrminfd by its {@link DynbmidMBfbn#gftMBfbnInfo
 * gftMBfbnInfo()} mftiod.  Tiis indludfs Opfn MBfbns bnd Modfl
 * MBfbns, wiidi brf kinds of Dynbmid MBfbns.</p>
 *
 * <p>Tif dontfnts of tif <dodf>MBfbnInfo</dodf> for b Stbndbrd MBfbn
 * brf dftfrminfd by tif MBfbn sfrvfr bs follows:</p>
 *
 * <ul>
 *
 * <li>{@link #gftClbssNbmf()} rfturns tif Jbvb dlbss nbmf of tif MBfbn
 * objfdt;
 *
 * <li>{@link #gftConstrudtors()} rfturns tif list of bll publid
 * donstrudtors in tibt objfdt;
 *
 * <li>{@link #gftAttributfs()} rfturns tif list of bll bttributfs
 * wiosf fxistfndf is dfdudfd from tif prfsfndf in tif MBfbn intfrfbdf
 * of b <dodf>gft<i>Nbmf</i></dodf>, <dodf>is<i>Nbmf</i></dodf>, or
 * <dodf>sft<i>Nbmf</i></dodf> mftiod tibt donforms to tif donvfntions
 * for Stbndbrd MBfbns;
 *
 * <li>{@link #gftOpfrbtions()} rfturns tif list of bll mftiods in
 * tif MBfbn intfrfbdf tibt do not rfprfsfnt bttributfs;
 *
 * <li>{@link #gftNotifidbtions()} rfturns bn fmpty brrby if tif MBfbn
 * dofs not implfmfnt tif {@link NotifidbtionBrobddbstfr} intfrfbdf,
 * otifrwisf tif rfsult of dblling {@link
 * NotifidbtionBrobddbstfr#gftNotifidbtionInfo()} on it;
 *
 * <li>{@link #gftDfsdriptor()} rfturns b dfsdriptor dontbining tif dontfnts
 * of bny dfsdriptor bnnotbtions in tif MBfbn intfrfbdf (sff
 * {@link DfsdriptorKfy &#64;DfsdriptorKfy}).
 *
 * </ul>
 *
 * <p>Tif dfsdription rfturnfd by {@link #gftDfsdription()} bnd tif
 * dfsdriptions of tif dontbinfd bttributfs bnd opfrbtions brf not spfdififd.</p>
 *
 * <p>Tif rfmbining dftbils of tif <dodf>MBfbnInfo</dodf> for b
 * Stbndbrd MBfbn brf not spfdififd.  Tiis indludfs tif dfsdription of
 * bny dontbinfd donstrudtors, bnd notifidbtions; tif nbmfs
 * of pbrbmftfrs to donstrudtors bnd opfrbtions; bnd tif dfsdriptions of
 * donstrudtor pbrbmftfrs.</p>
 *
 * @sindf 1.5
 */
publid dlbss MBfbnInfo implfmfnts Clonfbblf, Sfriblizbblf, DfsdriptorRfbd {

    /* Sfribl vfrsion */
    stbtid finbl long sfriblVfrsionUID = -6451021435135161911L;

    /**
     * @sfribl Tif Dfsdriptor for tif MBfbn.  Tiis fifld
     * dbn bf null, wiidi is fquivblfnt to bn fmpty Dfsdriptor.
     */
    privbtf trbnsifnt Dfsdriptor dfsdriptor;

    /**
     * @sfribl Tif iumbn rfbdbblf dfsdription of tif dlbss.
     */
    privbtf finbl String dfsdription;

    /**
     * @sfribl Tif MBfbn qublififd nbmf.
     */
    privbtf finbl String dlbssNbmf;

    /**
     * @sfribl Tif MBfbn bttributf dfsdriptors.
     */
    privbtf finbl MBfbnAttributfInfo[] bttributfs;

    /**
     * @sfribl Tif MBfbn opfrbtion dfsdriptors.
     */
    privbtf finbl MBfbnOpfrbtionInfo[] opfrbtions;

     /**
     * @sfribl Tif MBfbn donstrudtor dfsdriptors.
     */
    privbtf finbl MBfbnConstrudtorInfo[] donstrudtors;

    /**
     * @sfribl Tif MBfbn notifidbtion dfsdriptors.
     */
    privbtf finbl MBfbnNotifidbtionInfo[] notifidbtions;

    privbtf trbnsifnt int ibsiCodf;

    /**
     * <p>Truf if tiis dlbss is known not to ovfrridf tif brrby-vblufd
     * gfttfrs of MBfbnInfo.  Obviously truf for MBfbnInfo itsflf, bnd truf
     * for b subdlbss wifrf wf suddffd in rfflfdting on tif mftiods
     * bnd disdovfr tify brf not ovfrriddfn.</p>
     *
     * <p>Tif purposf of tiis vbribblf is to bvoid dloning tif brrbys
     * wifn doing opfrbtions likf {@link #fqubls} wifrf wf know tify
     * will not bf dibngfd.  If b subdlbss ovfrridfs b gfttfr, wf
     * dbnnot bddfss tif dorrfsponding brrby dirfdtly.</p>
     */
    privbtf finbl trbnsifnt boolfbn brrbyGfttfrsSbff;

    /**
     * Construdts bn <CODE>MBfbnInfo</CODE>.
     *
     * @pbrbm dlbssNbmf Tif nbmf of tif Jbvb dlbss of tif MBfbn dfsdribfd
     * by tiis <CODE>MBfbnInfo</CODE>.  Tiis vbluf mby bf bny
     * syntbdtidblly lfgbl Jbvb dlbss nbmf.  It dofs not ibvf to bf b
     * Jbvb dlbss known to tif MBfbn sfrvfr or to tif MBfbn's
     * ClbssLobdfr.  If it is b Jbvb dlbss known to tif MBfbn's
     * ClbssLobdfr, it is rfdommfndfd but not rfquirfd tibt tif
     * dlbss's publid mftiods indludf tiosf tibt would bppfbr in b
     * Stbndbrd MBfbn implfmfnting tif bttributfs bnd opfrbtions in
     * tiis MBfbnInfo.
     * @pbrbm dfsdription A iumbn rfbdbblf dfsdription of tif MBfbn (optionbl).
     * @pbrbm bttributfs Tif list of fxposfd bttributfs of tif MBfbn.
     * Tiis mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     * @pbrbm donstrudtors Tif list of publid donstrudtors of tif
     * MBfbn.  Tiis mby bf null witi tif sbmf ffffdt bs b zfro-lfngti
     * brrby.
     * @pbrbm opfrbtions Tif list of opfrbtions of tif MBfbn.  Tiis
     * mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     * @pbrbm notifidbtions Tif list of notifidbtions fmittfd.  Tiis
     * mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     */
    publid MBfbnInfo(String dlbssNbmf,
                     String dfsdription,
                     MBfbnAttributfInfo[] bttributfs,
                     MBfbnConstrudtorInfo[] donstrudtors,
                     MBfbnOpfrbtionInfo[] opfrbtions,
                     MBfbnNotifidbtionInfo[] notifidbtions)
            tirows IllfgblArgumfntExdfption {
        tiis(dlbssNbmf, dfsdription, bttributfs, donstrudtors, opfrbtions,
             notifidbtions, null);
    }

    /**
     * Construdts bn <CODE>MBfbnInfo</CODE>.
     *
     * @pbrbm dlbssNbmf Tif nbmf of tif Jbvb dlbss of tif MBfbn dfsdribfd
     * by tiis <CODE>MBfbnInfo</CODE>.  Tiis vbluf mby bf bny
     * syntbdtidblly lfgbl Jbvb dlbss nbmf.  It dofs not ibvf to bf b
     * Jbvb dlbss known to tif MBfbn sfrvfr or to tif MBfbn's
     * ClbssLobdfr.  If it is b Jbvb dlbss known to tif MBfbn's
     * ClbssLobdfr, it is rfdommfndfd but not rfquirfd tibt tif
     * dlbss's publid mftiods indludf tiosf tibt would bppfbr in b
     * Stbndbrd MBfbn implfmfnting tif bttributfs bnd opfrbtions in
     * tiis MBfbnInfo.
     * @pbrbm dfsdription A iumbn rfbdbblf dfsdription of tif MBfbn (optionbl).
     * @pbrbm bttributfs Tif list of fxposfd bttributfs of tif MBfbn.
     * Tiis mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     * @pbrbm donstrudtors Tif list of publid donstrudtors of tif
     * MBfbn.  Tiis mby bf null witi tif sbmf ffffdt bs b zfro-lfngti
     * brrby.
     * @pbrbm opfrbtions Tif list of opfrbtions of tif MBfbn.  Tiis
     * mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     * @pbrbm notifidbtions Tif list of notifidbtions fmittfd.  Tiis
     * mby bf null witi tif sbmf ffffdt bs b zfro-lfngti brrby.
     * @pbrbm dfsdriptor Tif dfsdriptor for tif MBfbn.  Tiis mby bf null
     * wiidi is fquivblfnt to bn fmpty dfsdriptor.
     *
     * @sindf 1.6
     */
    publid MBfbnInfo(String dlbssNbmf,
                     String dfsdription,
                     MBfbnAttributfInfo[] bttributfs,
                     MBfbnConstrudtorInfo[] donstrudtors,
                     MBfbnOpfrbtionInfo[] opfrbtions,
                     MBfbnNotifidbtionInfo[] notifidbtions,
                     Dfsdriptor dfsdriptor)
            tirows IllfgblArgumfntExdfption {

        tiis.dlbssNbmf = dlbssNbmf;

        tiis.dfsdription = dfsdription;

        if (bttributfs == null)
            bttributfs = MBfbnAttributfInfo.NO_ATTRIBUTES;
        tiis.bttributfs = bttributfs;

        if (opfrbtions == null)
            opfrbtions = MBfbnOpfrbtionInfo.NO_OPERATIONS;
        tiis.opfrbtions = opfrbtions;

        if (donstrudtors == null)
            donstrudtors = MBfbnConstrudtorInfo.NO_CONSTRUCTORS;
        tiis.donstrudtors = donstrudtors;

        if (notifidbtions == null)
            notifidbtions = MBfbnNotifidbtionInfo.NO_NOTIFICATIONS;
        tiis.notifidbtions = notifidbtions;

        if (dfsdriptor == null)
            dfsdriptor = ImmutbblfDfsdriptor.EMPTY_DESCRIPTOR;
        tiis.dfsdriptor = dfsdriptor;

        tiis.brrbyGfttfrsSbff =
                brrbyGfttfrsSbff(tiis.gftClbss(), MBfbnInfo.dlbss);
    }

    /**
     * <p>Rfturns b sibllow dlonf of tiis instbndf.
     * Tif dlonf is obtbinfd by simply dblling <tt>supfr.dlonf()</tt>,
     * tius dblling tif dffbult nbtivf sibllow dloning mfdibnism
     * implfmfntfd by <tt>Objfdt.dlonf()</tt>.
     * No dffpfr dloning of bny intfrnbl fifld is mbdf.</p>
     *
     * <p>Sindf tiis dlbss is immutbblf, tif dlonf mftiod is diiffly of
     * intfrfst to subdlbssfs.</p>
     */
     @Ovfrridf
     publid Objfdt dlonf () {
         try {
             rfturn supfr.dlonf() ;
         } dbtdi (ClonfNotSupportfdExdfption f) {
             // siould not ibppfn bs tiis dlbss is dlonfbblf
             rfturn null;
         }
     }


    /**
     * Rfturns tif nbmf of tif Jbvb dlbss of tif MBfbn dfsdribfd by
     * tiis <CODE>MBfbnInfo</CODE>.
     *
     * @rfturn tif dlbss nbmf.
     */
    publid String gftClbssNbmf()  {
        rfturn dlbssNbmf;
    }

    /**
     * Rfturns b iumbn rfbdbblf dfsdription of tif MBfbn.
     *
     * @rfturn tif dfsdription.
     */
    publid String gftDfsdription()  {
        rfturn dfsdription;
    }

    /**
     * Rfturns tif list of bttributfs fxposfd for mbnbgfmfnt.
     * Ebdi bttributf is dfsdribfd by bn <CODE>MBfbnAttributfInfo</CODE> objfdt.
     *
     * Tif rfturnfd brrby is b sibllow dopy of tif intfrnbl brrby,
     * wiidi mfbns tibt it is b dopy of tif intfrnbl brrby of
     * rfffrfndfs to tif <CODE>MBfbnAttributfInfo</CODE> objfdts
     * but tibt fbdi rfffrfndfd <CODE>MBfbnAttributfInfo</CODE> objfdt is not dopifd.
     *
     * @rfturn  An brrby of <CODE>MBfbnAttributfInfo</CODE> objfdts.
     */
    publid MBfbnAttributfInfo[] gftAttributfs()   {
        MBfbnAttributfInfo[] bs = nonNullAttributfs();
        if (bs.lfngti == 0)
            rfturn bs;
        flsf
            rfturn bs.dlonf();
    }

    privbtf MBfbnAttributfInfo[] fbstGftAttributfs() {
        if (brrbyGfttfrsSbff)
            rfturn nonNullAttributfs();
        flsf
            rfturn gftAttributfs();
    }

    /**
     * Rfturn tif vbluf of tif bttributfs fifld, or bn fmpty brrby if
     * tif fifld is null.  Tiis dbn't ibppfn witi b
     * normblly-donstrudtfd instbndf of tiis dlbss, but dbn if tif
     * instbndf wbs dfsfriblizfd from bnotifr implfmfntbtion tibt
     * bllows tif fifld to bf null.  It would bf simplfr if wf fnfordfd
     * tif dlbss invbribnt tibt tifsf fiflds dbnnot bf null by writing
     * b rfbdObjfdt() mftiod, but tibt would rfquirf us to dffinf tif
     * vbrious brrby fiflds bs non-finbl, wiidi is bnnoying bfdbusf
     * dondfptublly tify brf indffd finbl.
     */
    privbtf MBfbnAttributfInfo[] nonNullAttributfs() {
        rfturn (bttributfs == null) ?
            MBfbnAttributfInfo.NO_ATTRIBUTES : bttributfs;
    }

    /**
     * Rfturns tif list of opfrbtions  of tif MBfbn.
     * Ebdi opfrbtion is dfsdribfd by bn <CODE>MBfbnOpfrbtionInfo</CODE> objfdt.
     *
     * Tif rfturnfd brrby is b sibllow dopy of tif intfrnbl brrby,
     * wiidi mfbns tibt it is b dopy of tif intfrnbl brrby of
     * rfffrfndfs to tif <CODE>MBfbnOpfrbtionInfo</CODE> objfdts
     * but tibt fbdi rfffrfndfd <CODE>MBfbnOpfrbtionInfo</CODE> objfdt is not dopifd.
     *
     * @rfturn  An brrby of <CODE>MBfbnOpfrbtionInfo</CODE> objfdts.
     */
    publid MBfbnOpfrbtionInfo[] gftOpfrbtions()  {
        MBfbnOpfrbtionInfo[] os = nonNullOpfrbtions();
        if (os.lfngti == 0)
            rfturn os;
        flsf
            rfturn os.dlonf();
    }

    privbtf MBfbnOpfrbtionInfo[] fbstGftOpfrbtions() {
        if (brrbyGfttfrsSbff)
            rfturn nonNullOpfrbtions();
        flsf
            rfturn gftOpfrbtions();
    }

    privbtf MBfbnOpfrbtionInfo[] nonNullOpfrbtions() {
        rfturn (opfrbtions == null) ?
            MBfbnOpfrbtionInfo.NO_OPERATIONS : opfrbtions;
    }

    /**
     * <p>Rfturns tif list of tif publid donstrudtors of tif MBfbn.
     * Ebdi donstrudtor is dfsdribfd by bn
     * <CODE>MBfbnConstrudtorInfo</CODE> objfdt.</p>
     *
     * <p>Tif rfturnfd brrby is b sibllow dopy of tif intfrnbl brrby,
     * wiidi mfbns tibt it is b dopy of tif intfrnbl brrby of
     * rfffrfndfs to tif <CODE>MBfbnConstrudtorInfo</CODE> objfdts but
     * tibt fbdi rfffrfndfd <CODE>MBfbnConstrudtorInfo</CODE> objfdt
     * is not dopifd.</p>
     *
     * <p>Tif rfturnfd list is not nfdfssbrily fxibustivf.  Tibt is,
     * tif MBfbn mby ibvf b publid donstrudtor tibt is not in tif
     * list.  In tiis dbsf, tif MBfbn sfrvfr dbn donstrudt bnotifr
     * instbndf of tiis MBfbn's dlbss using tibt donstrudtor, fvfn
     * tiougi it is not listfd ifrf.</p>
     *
     * @rfturn  An brrby of <CODE>MBfbnConstrudtorInfo</CODE> objfdts.
     */
    publid MBfbnConstrudtorInfo[] gftConstrudtors()  {
        MBfbnConstrudtorInfo[] ds = nonNullConstrudtors();
        if (ds.lfngti == 0)
            rfturn ds;
        flsf
            rfturn ds.dlonf();
    }

    privbtf MBfbnConstrudtorInfo[] fbstGftConstrudtors() {
        if (brrbyGfttfrsSbff)
            rfturn nonNullConstrudtors();
        flsf
            rfturn gftConstrudtors();
    }

    privbtf MBfbnConstrudtorInfo[] nonNullConstrudtors() {
        rfturn (donstrudtors == null) ?
            MBfbnConstrudtorInfo.NO_CONSTRUCTORS : donstrudtors;
    }

    /**
     * Rfturns tif list of tif notifidbtions fmittfd by tif MBfbn.
     * Ebdi notifidbtion is dfsdribfd by bn <CODE>MBfbnNotifidbtionInfo</CODE> objfdt.
     *
     * Tif rfturnfd brrby is b sibllow dopy of tif intfrnbl brrby,
     * wiidi mfbns tibt it is b dopy of tif intfrnbl brrby of
     * rfffrfndfs to tif <CODE>MBfbnNotifidbtionInfo</CODE> objfdts
     * but tibt fbdi rfffrfndfd <CODE>MBfbnNotifidbtionInfo</CODE> objfdt is not dopifd.
     *
     * @rfturn  An brrby of <CODE>MBfbnNotifidbtionInfo</CODE> objfdts.
     */
    publid MBfbnNotifidbtionInfo[] gftNotifidbtions()  {
        MBfbnNotifidbtionInfo[] ns = nonNullNotifidbtions();
        if (ns.lfngti == 0)
            rfturn ns;
        flsf
            rfturn ns.dlonf();
    }

    privbtf MBfbnNotifidbtionInfo[] fbstGftNotifidbtions() {
        if (brrbyGfttfrsSbff)
            rfturn nonNullNotifidbtions();
        flsf
            rfturn gftNotifidbtions();
    }

    privbtf MBfbnNotifidbtionInfo[] nonNullNotifidbtions() {
        rfturn (notifidbtions == null) ?
            MBfbnNotifidbtionInfo.NO_NOTIFICATIONS : notifidbtions;
    }

    /**
     * Gft tif dfsdriptor of tiis MBfbnInfo.  Cibnging tif rfturnfd vbluf
     * will ibvf no bfffdt on tif originbl dfsdriptor.
     *
     * @rfturn b dfsdriptor tibt is fitifr immutbblf or b dopy of tif originbl.
     *
     * @sindf 1.6
     */
    publid Dfsdriptor gftDfsdriptor() {
        rfturn (Dfsdriptor) nonNullDfsdriptor(dfsdriptor).dlonf();
    }

    @Ovfrridf
    publid String toString() {
        rfturn
            gftClbss().gftNbmf() + "[" +
            "dfsdription=" + gftDfsdription() + ", " +
            "bttributfs=" + Arrbys.bsList(fbstGftAttributfs()) + ", " +
            "donstrudtors=" + Arrbys.bsList(fbstGftConstrudtors()) + ", " +
            "opfrbtions=" + Arrbys.bsList(fbstGftOpfrbtions()) + ", " +
            "notifidbtions=" + Arrbys.bsList(fbstGftNotifidbtions()) + ", " +
            "dfsdriptor=" + gftDfsdriptor() +
            "]";
    }

    /**
     * <p>Compbrf tiis MBfbnInfo to bnotifr.  Two MBfbnInfo objfdts
     * brf fqubl if bnd only if tify rfturn fqubl vblufs for {@link
     * #gftClbssNbmf()}, for {@link #gftDfsdription()}, bnd for
     * {@link #gftDfsdriptor()}, bnd tif
     * brrbys rfturnfd by tif two objfdts for {@link
     * #gftAttributfs()}, {@link #gftOpfrbtions()}, {@link
     * #gftConstrudtors()}, bnd {@link #gftNotifidbtions()} brf
     * pbirwisf fqubl.  Hfrf "fqubl" mfbns {@link
     * Objfdt#fqubls(Objfdt)}, not idfntity.</p>
     *
     * <p>If two MBfbnInfo objfdts rfturn tif sbmf vblufs in onf of
     * tifir brrbys but in b difffrfnt ordfr tifn tify brf not fqubl.</p>
     *
     * @pbrbm o tif objfdt to dompbrf to.
     *
     * @rfturn truf if bnd only if <dodf>o</dodf> is bn MBfbnInfo tibt is fqubl
     * to tiis onf bddording to tif rulfs bbovf.
     */
    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        if (o == tiis)
            rfturn truf;
        if (!(o instbndfof MBfbnInfo))
            rfturn fblsf;
        MBfbnInfo p = (MBfbnInfo) o;
        if (!isEqubl(gftClbssNbmf(),  p.gftClbssNbmf()) ||
                !isEqubl(gftDfsdription(), p.gftDfsdription()) ||
                !gftDfsdriptor().fqubls(p.gftDfsdriptor())) {
            rfturn fblsf;
        }

        rfturn
            (Arrbys.fqubls(p.fbstGftAttributfs(), fbstGftAttributfs()) &&
             Arrbys.fqubls(p.fbstGftOpfrbtions(), fbstGftOpfrbtions()) &&
             Arrbys.fqubls(p.fbstGftConstrudtors(), fbstGftConstrudtors()) &&
             Arrbys.fqubls(p.fbstGftNotifidbtions(), fbstGftNotifidbtions()));
    }

    @Ovfrridf
    publid int ibsiCodf() {
        /* Sindf domputing tif ibsiCodf is quitf fxpfnsivf, wf dbdif it.
           If by somf tfrriblf misfortunf tif domputfd vbluf is 0, tif
           dbdiing won't work bnd wf will rfdomputf it fvfry timf.

           Wf don't botifr syndironizing, bfdbusf, bt worst, n difffrfnt
           tirfbds will domputf tif sbmf ibsiCodf bt tif sbmf timf.  */
        if (ibsiCodf != 0)
            rfturn ibsiCodf;

        ibsiCodf = Objfdts.ibsi(gftClbssNbmf(), gftDfsdriptor())
                ^ Arrbys.ibsiCodf(fbstGftAttributfs())
                ^ Arrbys.ibsiCodf(fbstGftOpfrbtions())
                ^ Arrbys.ibsiCodf(fbstGftConstrudtors())
                ^ Arrbys.ibsiCodf(fbstGftNotifidbtions());

        rfturn ibsiCodf;
    }

    /**
     * Cbdifd rfsults of prfvious dblls to brrbyGfttfrsSbff.  Tiis is
     * b WfbkHbsiMbp so tibt wf don't prfvfnt b dlbss from bfing
     * gbrbbgf dollfdtfd just bfdbusf wf know wiftifr it's immutbblf.
     */
    privbtf stbtid finbl Mbp<Clbss<?>, Boolfbn> brrbyGfttfrsSbffMbp =
        nfw WfbkHbsiMbp<Clbss<?>, Boolfbn>();

    /**
     * Rfturn truf if <dodf>subdlbss</dodf> is known to prfsfrvf tif
     * immutbbility of <dodf>immutbblfClbss</dodf>.  Tif dlbss
     * <dodf>immutbblfClbss</dodf> is b rfffrfndf dlbss tibt is known
     * to bf immutbblf.  Tif subdlbss <dodf>subdlbss</dodf> is
     * donsidfrfd immutbblf if it dofs not ovfrridf bny publid mftiod
     * of <dodf>immutbblfClbss</dodf> wiosf nbmf bfgins witi "gft".
     * Tiis is obviously not bn infblliblf tfst for immutbbility,
     * but it works for tif publid intfrfbdfs of tif MBfbn*Info dlbssfs.
    */
    stbtid boolfbn brrbyGfttfrsSbff(Clbss<?> subdlbss, Clbss<?> immutbblfClbss) {
        if (subdlbss == immutbblfClbss)
            rfturn truf;
        syndironizfd (brrbyGfttfrsSbffMbp) {
            Boolfbn sbff = brrbyGfttfrsSbffMbp.gft(subdlbss);
            if (sbff == null) {
                try {
                    ArrbyGfttfrsSbffAdtion bdtion =
                        nfw ArrbyGfttfrsSbffAdtion(subdlbss, immutbblfClbss);
                    sbff = AddfssControllfr.doPrivilfgfd(bdtion);
                } dbtdi (Exdfption f) { // f.g. SfdurityExdfption
                    /* Wf don't know, so wf bssumf it isn't.  */
                    sbff = fblsf;
                }
                brrbyGfttfrsSbffMbp.put(subdlbss, sbff);
            }
            rfturn sbff;
        }
    }

    /*
     * Tif PrivilfgfdAdtion stuff is probbbly ovfrkill.  Wf dbn bf
     * prftty surf tif dbllfr dofs ibvf tif rfquirfd privilfgfs -- b
     * JMX usfr tibt dbn't do rfflfdtion dbn't fvfn usf Stbndbrd
     * MBfbns!  But tifrf's probbbly b pfrformbndf gbin by not ibving
     * to difdk tif wiolf dbll stbdk.
     */
    privbtf stbtid dlbss ArrbyGfttfrsSbffAdtion
            implfmfnts PrivilfgfdAdtion<Boolfbn> {

        privbtf finbl Clbss<?> subdlbss;
        privbtf finbl Clbss<?> immutbblfClbss;

        ArrbyGfttfrsSbffAdtion(Clbss<?> subdlbss, Clbss<?> immutbblfClbss) {
            tiis.subdlbss = subdlbss;
            tiis.immutbblfClbss = immutbblfClbss;
        }

        publid Boolfbn run() {
            Mftiod[] mftiods = immutbblfClbss.gftMftiods();
            for (int i = 0; i < mftiods.lfngti; i++) {
                Mftiod mftiod = mftiods[i];
                String mftiodNbmf = mftiod.gftNbmf();
                if (mftiodNbmf.stbrtsWiti("gft") &&
                        mftiod.gftPbrbmftfrTypfs().lfngti == 0 &&
                        mftiod.gftRfturnTypf().isArrby()) {
                    try {
                        Mftiod submftiod =
                            subdlbss.gftMftiod(mftiodNbmf);
                        if (!submftiod.fqubls(mftiod))
                            rfturn fblsf;
                    } dbtdi (NoSudiMftiodExdfption f) {
                        rfturn fblsf;
                    }
                }
            }
            rfturn truf;
        }
    }

    privbtf stbtid boolfbn isEqubl(String s1, String s2) {
        boolfbn rft;

        if (s1 == null) {
            rft = (s2 == null);
        } flsf {
            rft = s1.fqubls(s2);
        }

        rfturn rft;
    }

    /**
     * Sfriblizfs bn {@link MBfbnInfo} to bn {@link ObjfdtOutputStrfbm}.
     * @sfriblDbtb
     * For dompbtibility rfbsons, bn objfdt of tiis dlbss is sfriblizfd bs follows.
     * <p>
     * Tif mftiod {@link ObjfdtOutputStrfbm#dffbultWritfObjfdt dffbultWritfObjfdt()}
     * is dbllfd first to sfriblizf tif objfdt fxdfpt tif fifld {@dodf dfsdriptor}
     * wiidi is dfdlbrfd bs trbnsifnt. Tif fifld {@dodf dfsdriptor} is sfriblizfd
     * bs follows:
     *     <ul>
     *     <li> If {@dodf dfsdriptor} is bn instbndf of tif dlbss
     *        {@link ImmutbblfDfsdriptor}, tif mftiod {@link ObjfdtOutputStrfbm#writf
     *        writf(int vbl)} is dbllfd to writf b bytf witi tif vbluf {@dodf 1},
     *        tifn tif mftiod {@link ObjfdtOutputStrfbm#writfObjfdt writfObjfdt(Objfdt obj)}
     *        is dbllfd twidf to sfriblizf tif fifld nbmfs bnd tif fifld vblufs of tif
     *        {@dodf dfsdriptor}, rfspfdtivfly bs b {@dodf String[]} bnd bn
     *        {@dodf Objfdt[]};</li>
     *     <li> Otifrwisf, tif mftiod {@link ObjfdtOutputStrfbm#writf writf(int vbl)}
     *        is dbllfd to writf b bytf witi tif vbluf {@dodf 0}, tifn tif mftiod
     *        {@link ObjfdtOutputStrfbm#writfObjfdt writfObjfdt(Objfdt obj)} is dbllfd
     *        to sfriblizf tif fifld {@dodf dfsdriptor} dirfdtly.
     *     </ul>
     *
     * @sindf 1.6
     */
    privbtf void writfObjfdt(ObjfdtOutputStrfbm out) tirows IOExdfption {
        out.dffbultWritfObjfdt();

        if (dfsdriptor.gftClbss() == ImmutbblfDfsdriptor.dlbss) {
            out.writf(1);

            finbl String[] nbmfs = dfsdriptor.gftFifldNbmfs();

            out.writfObjfdt(nbmfs);
            out.writfObjfdt(dfsdriptor.gftFifldVblufs(nbmfs));
        } flsf {
            out.writf(0);

            out.writfObjfdt(dfsdriptor);
        }
    }

    /**
     * Dfsfriblizfs bn {@link MBfbnInfo} from bn {@link ObjfdtInputStrfbm}.
     * @sfriblDbtb
     * For dompbtibility rfbsons, bn objfdt of tiis dlbss is dfsfriblizfd bs follows.
     * <p>
     * Tif mftiod {@link ObjfdtInputStrfbm#dffbultRfbdObjfdt dffbultRfbdObjfdt()}
     * is dbllfd first to dfsfriblizf tif objfdt fxdfpt tif fifld
     * {@dodf dfsdriptor}, wiidi is not sfriblizfd in tif dffbult wby. Tifn tif mftiod
     * {@link ObjfdtInputStrfbm#rfbd rfbd()} is dbllfd to rfbd b bytf, tif fifld
     * {@dodf dfsdriptor} is dfsfriblizfd bddording to tif vbluf of tif bytf vbluf:
     *    <ul>
     *    <li>1. Tif mftiod {@link ObjfdtInputStrfbm#rfbdObjfdt rfbdObjfdt()}
     *       is dbllfd twidf to obtbin tif fifld nbmfs (b {@dodf String[]}) bnd
     *       tif fifld vblufs (b {@dodf Objfdt[]}) of tif {@dodf dfsdriptor}.
     *       Tif two obtbinfd vblufs tifn brf usfd to donstrudt
     *       bn {@link ImmutbblfDfsdriptor} instbndf for tif fifld
     *       {@dodf dfsdriptor};</li>
     *    <li>0. Tif vbluf for tif fifld {@dodf dfsdriptor} is obtbinfd dirfdtly
     *       by dblling tif mftiod {@link ObjfdtInputStrfbm#rfbdObjfdt rfbdObjfdt()}.
     *       If tif obtbinfd vbluf is null, tif fifld {@dodf dfsdriptor} is sft to
     *       {@link ImmutbblfDfsdriptor#EMPTY_DESCRIPTOR EMPTY_DESCRIPTOR};</li>
     *    <li>-1. Tiis mfbns tibt tifrf is no bytf to rfbd bnd tibt tif objfdt is from
     *       bn fbrlifr vfrsion of tif JMX API. Tif fifld {@dodf dfsdriptor} is sft to
     *       {@link ImmutbblfDfsdriptor#EMPTY_DESCRIPTOR EMPTY_DESCRIPTOR}.</li>
     *    <li>Any otifr vbluf. A {@link StrfbmCorruptfdExdfption} is tirown.</li>
     *    </ul>
     *
     * @sindf 1.6
     */

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm in)
        tirows IOExdfption, ClbssNotFoundExdfption {

        in.dffbultRfbdObjfdt();

        switdi (in.rfbd()) {
        dbsf 1:
            finbl String[] nbmfs = (String[])in.rfbdObjfdt();

            finbl Objfdt[] vblufs = (Objfdt[]) in.rfbdObjfdt();
            dfsdriptor = (nbmfs.lfngti == 0) ?
                ImmutbblfDfsdriptor.EMPTY_DESCRIPTOR :
                nfw ImmutbblfDfsdriptor(nbmfs, vblufs);

            brfbk;
        dbsf 0:
            dfsdriptor = (Dfsdriptor)in.rfbdObjfdt();

            if (dfsdriptor == null) {
                dfsdriptor = ImmutbblfDfsdriptor.EMPTY_DESCRIPTOR;
            }

            brfbk;
        dbsf -1: // from bn fbrlifr vfrsion of tif JMX API
            dfsdriptor = ImmutbblfDfsdriptor.EMPTY_DESCRIPTOR;

            brfbk;
        dffbult:
            tirow nfw StrfbmCorruptfdExdfption("Got unfxpfdtfd bytf.");
        }
    }
}
