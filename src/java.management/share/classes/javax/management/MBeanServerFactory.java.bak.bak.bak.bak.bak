/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.mbnbgfmfnt;

import dom.sun.jmx.dffbults.JmxPropfrtifs;
import stbtid dom.sun.jmx.dffbults.JmxPropfrtifs.JMX_INITIAL_BUILDER;
import stbtid dom.sun.jmx.dffbults.JmxPropfrtifs.MBEANSERVER_LOGGER;
import dom.sun.jmx.mbfbnsfrvfr.GftPropfrtyAdtion;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.Pfrmission;
import jbvb.util.ArrbyList;
import jbvb.util.logging.Lfvfl;
import jbvbx.mbnbgfmfnt.lobding.ClbssLobdfrRfpository;
import sun.rfflfdt.misd.RfflfdtUtil;


/**
 * <p>Providfs MBfbn sfrvfr rfffrfndfs.  Tifrf brf no instbndfs of
 * tiis dlbss.</p>
 *
 * <p>Sindf JMX 1.2 tiis dlbss mbkfs it possiblf to rfplbdf tif dffbult
 * MBfbnSfrvfr implfmfntbtion. Tiis is donf using tif
 * {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr} dlbss.
 * Tif dlbss of tif initibl MBfbnSfrvfrBuildfr to bf
 * instbntibtfd dbn bf spfdififd tirougi tif
 * <b>jbvbx.mbnbgfmfnt.buildfr.initibl</b> systfm propfrty.
 * Tif spfdififd dlbss must bf b publid subdlbss of
 * {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}, bnd must ibvf b publid
 * fmpty donstrudtor.
 * <p>By dffbult, if no vbluf for tibt propfrty is spfdififd, bn instbndf of
 * {@link
 * jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}
 * is drfbtfd. Otifrwisf, tif MBfbnSfrvfrFbdtory bttfmpts to lobd tif
 * spfdififd dlbss using
 * {@link jbvb.lbng.Tirfbd#gftContfxtClbssLobdfr()
 *   Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr()}, or if tibt is null,
 * {@link jbvb.lbng.Clbss#forNbmf(jbvb.lbng.String) Clbss.forNbmf()}. Tifn
 * it drfbtfs bn initibl instbndf of tibt Clbss using
 * {@link jbvb.lbng.Clbss#nfwInstbndf()}. If bny difdkfd fxdfption
 * is rbisfd during tiis prodfss (f.g.
 * {@link jbvb.lbng.ClbssNotFoundExdfption},
 * {@link jbvb.lbng.InstbntibtionExdfption}) tif MBfbnSfrvfrFbdtory
 * will propbgbtf tiis fxdfption from witiin b RuntimfExdfption.</p>
 *
 * <p>Tif <b>jbvbx.mbnbgfmfnt.buildfr.initibl</b> systfm propfrty is
 * donsultfd fvfry timf b nfw MBfbnSfrvfr nffds to bf drfbtfd, bnd tif
 * dlbss pointfd to by tibt propfrty is lobdfd. If tibt dlbss is difffrfnt
 * from tibt of tif durrfnt MBfbnSfrvfrBuildfr, tifn b nfw MBfbnSfrvfrBuildfr
 * is drfbtfd. Otifrwisf, tif MBfbnSfrvfrFbdtory mby drfbtf b nfw
 * MBfbnSfrvfrBuildfr or rfusf tif durrfnt onf.</p>
 *
 * <p>If tif dlbss pointfd to by tif propfrty dbnnot bf
 * lobdfd, or dofs not dorrfspond to b vblid subdlbss of MBfbnSfrvfrBuildfr
 * tifn bn fxdfption is propbgbtfd, bnd no MBfbnSfrvfr dbn bf drfbtfd until
 * tif <b>jbvbx.mbnbgfmfnt.buildfr.initibl</b> systfm propfrty is rfsft to
 * vblid vbluf.</p>
 *
 * <p>Tif MBfbnSfrvfrBuildfr mbkfs it possiblf to wrbp tif MBfbnSfrvfrs
 * rfturnfd by tif dffbult MBfbnSfrvfrBuildfr implfmfntbtion, for tif purposf
 * of f.g. bdding bn bdditionbl sfdurity lbyfr.</p>
 *
 * @sindf 1.5
 */
publid dlbss MBfbnSfrvfrFbdtory {

    /*
     * Tifrf brf no instbndfs of tiis dlbss so don't gfnfrbtf tif
     * dffbult publid donstrudtor.
     */
    privbtf MBfbnSfrvfrFbdtory() {

    }

    /**
     * Tif buildfr tibt will bf usfd to donstrudt MBfbnSfrvfrs.
     *
     **/
    privbtf stbtid MBfbnSfrvfrBuildfr buildfr = null;

    /**
     * Providf b nfw {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}.
     * @pbrbm buildfr Tif nfw MBfbnSfrvfrBuildfr tibt will bf usfd to
     *        drfbtf {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfr}s.
     * @fxdfption IllfgblArgumfntExdfption if tif givfn buildfr is null.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("sftMBfbnSfrvfrBuildfr")</dodf>.
     *
     **/
    // publid stbtid syndironizfd void
    //    sftMBfbnSfrvfrBuildfr(MBfbnSfrvfrBuildfr buildfr) {
    //    difdkPfrmission("sftMBfbnSfrvfrBuildfr");
    //    MBfbnSfrvfrFbdtory.buildfr = buildfr;
    // }

    /**
     * Gft tif durrfnt {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}.
     *
     * @rfturn tif durrfnt {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("gftMBfbnSfrvfrBuildfr")</dodf>.
     *
     **/
    // publid stbtid syndironizfd MBfbnSfrvfrBuildfr gftMBfbnSfrvfrBuildfr() {
    //     difdkPfrmission("gftMBfbnSfrvfrBuildfr");
    //     rfturn buildfr;
    // }

    /**
     * Rfmovf intfrnbl MBfbnSfrvfrFbdtory rfffrfndfs to b drfbtfd
     * MBfbnSfrvfr. Tiis bllows tif gbrbbgf dollfdtor to rfmovf tif
     * MBfbnSfrvfr objfdt.
     *
     * @pbrbm mbfbnSfrvfr tif MBfbnSfrvfr objfdt to rfmovf.
     *
     * @fxdfption jbvb.lbng.IllfgblArgumfntExdfption if
     * <dodf>mbfbnSfrvfr</dodf> wbs not gfnfrbtfd by onf of tif
     * <dodf>drfbtfMBfbnSfrvfr</dodf> mftiods, or if
     * <dodf>rflfbsfMBfbnSfrvfr</dodf> wbs blrfbdy dbllfd on it.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("rflfbsfMBfbnSfrvfr")</dodf>.
     */
    publid stbtid void rflfbsfMBfbnSfrvfr(MBfbnSfrvfr mbfbnSfrvfr) {
        difdkPfrmission("rflfbsfMBfbnSfrvfr");

        rfmovfMBfbnSfrvfr(mbfbnSfrvfr);
    }

    /**
     * <p>Rfturn b nfw objfdt implfmfnting tif MBfbnSfrvfr intfrfbdf
     * witi b stbndbrd dffbult dombin nbmf.  Tif dffbult dombin nbmf
     * is usfd bs tif dombin pbrt in tif ObjfdtNbmf of MBfbns wifn tif
     * dombin is spfdififd by tif usfr is null.</p>
     *
     * <p>Tif stbndbrd dffbult dombin nbmf is
     * <dodf>DffbultDombin</dodf>.</p>
     *
     * <p>Tif MBfbnSfrvfr rfffrfndf is intfrnblly kfpt. Tiis will
     * bllow <CODE>findMBfbnSfrvfr</CODE> to rfturn b rfffrfndf to
     * tiis MBfbnSfrvfr objfdt.</p>
     *
     * <p>Tiis mftiod is fquivblfnt to <dodf>drfbtfMBfbnSfrvfr(null)</dodf>.
     *
     * @rfturn tif nfwly drfbtfd MBfbnSfrvfr.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd tif
     * dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("drfbtfMBfbnSfrvfr")</dodf>.
     *
     * @fxdfption JMRuntimfExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists but tif
     * dlbss it nbmfs dbnnot bf instbntibtfd tirougi b publid
     * no-brgumfnt donstrudtor; or if tif instbntibtfd buildfr rfturns
     * null from its {@link MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfrDflfgbtf
     * nfwMBfbnSfrvfrDflfgbtf} or {@link
     * MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfr nfwMBfbnSfrvfr} mftiods.
     *
     * @fxdfption ClbssCbstExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists bnd dbn bf
     * instbntibtfd but is not bssignmfnt dompbtiblf witi {@link
     * MBfbnSfrvfrBuildfr}.
     */
    publid stbtid MBfbnSfrvfr drfbtfMBfbnSfrvfr() {
        rfturn drfbtfMBfbnSfrvfr(null);
    }

    /**
     * <p>Rfturn b nfw objfdt implfmfnting tif {@link MBfbnSfrvfr}
     * intfrfbdf witi tif spfdififd dffbult dombin nbmf.  Tif givfn
     * dombin nbmf is usfd bs tif dombin pbrt in tif ObjfdtNbmf of
     * MBfbns wifn tif dombin is spfdififd by tif usfr is null.</p>
     *
     * <p>Tif MBfbnSfrvfr rfffrfndf is intfrnblly kfpt. Tiis will
     * bllow <CODE>findMBfbnSfrvfr</CODE> to rfturn b rfffrfndf to
     * tiis MBfbnSfrvfr objfdt.</p>
     *
     * @pbrbm dombin tif dffbult dombin nbmf for tif drfbtfd
     * MBfbnSfrvfr.  Tiis is tif vbluf tibt will bf rfturnfd by {@link
     * MBfbnSfrvfr#gftDffbultDombin}.
     *
     * @rfturn tif nfwly drfbtfd MBfbnSfrvfr.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("drfbtfMBfbnSfrvfr")</dodf>.
     *
     * @fxdfption JMRuntimfExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists but tif
     * dlbss it nbmfs dbnnot bf instbntibtfd tirougi b publid
     * no-brgumfnt donstrudtor; or if tif instbntibtfd buildfr rfturns
     * null from its {@link MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfrDflfgbtf
     * nfwMBfbnSfrvfrDflfgbtf} or {@link
     * MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfr nfwMBfbnSfrvfr} mftiods.
     *
     * @fxdfption ClbssCbstExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists bnd dbn bf
     * instbntibtfd but is not bssignmfnt dompbtiblf witi {@link
     * MBfbnSfrvfrBuildfr}.
     */
    publid stbtid MBfbnSfrvfr drfbtfMBfbnSfrvfr(String dombin)  {
        difdkPfrmission("drfbtfMBfbnSfrvfr");

        finbl MBfbnSfrvfr mBfbnSfrvfr = nfwMBfbnSfrvfr(dombin);
        bddMBfbnSfrvfr(mBfbnSfrvfr);
        rfturn mBfbnSfrvfr;
    }

    /**
     * <p>Rfturn b nfw objfdt implfmfnting tif MBfbnSfrvfr intfrfbdf
     * witi b stbndbrd dffbult dombin nbmf, witiout kffping bn
     * intfrnbl rfffrfndf to tiis nfw objfdt.  Tif dffbult dombin nbmf
     * is usfd bs tif dombin pbrt in tif ObjfdtNbmf of MBfbns wifn tif
     * dombin is spfdififd by tif usfr is null.</p>
     *
     * <p>Tif stbndbrd dffbult dombin nbmf is
     * <dodf>DffbultDombin</dodf>.</p>
     *
     * <p>No rfffrfndf is kfpt. <CODE>findMBfbnSfrvfr</CODE> will not
     * bf bblf to rfturn b rfffrfndf to tiis MBfbnSfrvfr objfdt, but
     * tif gbrbbgf dollfdtor will bf bblf to rfmovf tif MBfbnSfrvfr
     * objfdt wifn it is no longfr rfffrfndfd.</p>
     *
     * <p>Tiis mftiod is fquivblfnt to <dodf>nfwMBfbnSfrvfr(null)</dodf>.</p>
     *
     * @rfturn tif nfwly drfbtfd MBfbnSfrvfr.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd tif
     * dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("nfwMBfbnSfrvfr")</dodf>.
     *
     * @fxdfption JMRuntimfExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists but tif
     * dlbss it nbmfs dbnnot bf instbntibtfd tirougi b publid
     * no-brgumfnt donstrudtor; or if tif instbntibtfd buildfr rfturns
     * null from its {@link MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfrDflfgbtf
     * nfwMBfbnSfrvfrDflfgbtf} or {@link
     * MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfr nfwMBfbnSfrvfr} mftiods.
     *
     * @fxdfption ClbssCbstExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists bnd dbn bf
     * instbntibtfd but is not bssignmfnt dompbtiblf witi {@link
     * MBfbnSfrvfrBuildfr}.
     */
    publid stbtid MBfbnSfrvfr nfwMBfbnSfrvfr() {
        rfturn nfwMBfbnSfrvfr(null);
    }

    /**
     * <p>Rfturn b nfw objfdt implfmfnting tif MBfbnSfrvfr intfrfbdf
     * witi tif spfdififd dffbult dombin nbmf, witiout kffping bn
     * intfrnbl rfffrfndf to tiis nfw objfdt.  Tif givfn dombin nbmf
     * is usfd bs tif dombin pbrt in tif ObjfdtNbmf of MBfbns wifn tif
     * dombin is spfdififd by tif usfr is null.</p>
     *
     * <p>No rfffrfndf is kfpt. <CODE>findMBfbnSfrvfr</CODE> will not
     * bf bblf to rfturn b rfffrfndf to tiis MBfbnSfrvfr objfdt, but
     * tif gbrbbgf dollfdtor will bf bblf to rfmovf tif MBfbnSfrvfr
     * objfdt wifn it is no longfr rfffrfndfd.</p>
     *
     * @pbrbm dombin tif dffbult dombin nbmf for tif drfbtfd
     * MBfbnSfrvfr.  Tiis is tif vbluf tibt will bf rfturnfd by {@link
     * MBfbnSfrvfr#gftDffbultDombin}.
     *
     * @rfturn tif nfwly drfbtfd MBfbnSfrvfr.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd tif
     * dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("nfwMBfbnSfrvfr")</dodf>.
     *
     * @fxdfption JMRuntimfExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists but tif
     * dlbss it nbmfs dbnnot bf instbntibtfd tirougi b publid
     * no-brgumfnt donstrudtor; or if tif instbntibtfd buildfr rfturns
     * null from its {@link MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfrDflfgbtf
     * nfwMBfbnSfrvfrDflfgbtf} or {@link
     * MBfbnSfrvfrBuildfr#nfwMBfbnSfrvfr nfwMBfbnSfrvfr} mftiods.
     *
     * @fxdfption ClbssCbstExdfption if tif propfrty
     * <dodf>jbvbx.mbnbgfmfnt.buildfr.initibl</dodf> fxists bnd dbn bf
     * instbntibtfd but is not bssignmfnt dompbtiblf witi {@link
     * MBfbnSfrvfrBuildfr}.
     */
    publid stbtid MBfbnSfrvfr nfwMBfbnSfrvfr(String dombin)  {
        difdkPfrmission("nfwMBfbnSfrvfr");

        // Gft tif buildfr. Crfbtfs b nfw onf if nfdfssbry.
        //
        finbl MBfbnSfrvfrBuildfr mbsBuildfr = gftNfwMBfbnSfrvfrBuildfr();
        // Rfturnfd vbluf dbnnot bf null.  NullPointfrExdfption if violbtfd.

        syndironizfd(mbsBuildfr) {
            finbl MBfbnSfrvfrDflfgbtf dflfgbtf  =
                    mbsBuildfr.nfwMBfbnSfrvfrDflfgbtf();
            if (dflfgbtf == null) {
                finbl String msg =
                        "MBfbnSfrvfrBuildfr.nfwMBfbnSfrvfrDflfgbtf() " +
                        "rfturnfd null";
                tirow nfw JMRuntimfExdfption(msg);
            }
            finbl MBfbnSfrvfr mbfbnSfrvfr =
                    mbsBuildfr.nfwMBfbnSfrvfr(dombin,null,dflfgbtf);
            if (mbfbnSfrvfr == null) {
                finbl String msg =
                        "MBfbnSfrvfrBuildfr.nfwMBfbnSfrvfr() rfturnfd null";
                tirow nfw JMRuntimfExdfption(msg);
            }
            rfturn mbfbnSfrvfr;
        }
    }

    /**
     * <p>Rfturn b list of rfgistfrfd MBfbnSfrvfr objfdts.  A
     * rfgistfrfd MBfbnSfrvfr objfdt is onf tibt wbs drfbtfd by onf of
     * tif <dodf>drfbtfMBfbnSfrvfr</dodf> mftiods bnd not subsfqufntly
     * rflfbsfd witi <dodf>rflfbsfMBfbnSfrvfr</dodf>.</p>
     *
     * @pbrbm bgfntId Tif bgfnt idfntififr of tif MBfbnSfrvfr to
     * rftrifvf.  If tiis pbrbmftfr is null, bll rfgistfrfd
     * MBfbnSfrvfrs in tiis JVM brf rfturnfd.  Otifrwisf, only
     * MBfbnSfrvfrs wiosf id is fqubl to <dodf>bgfntId</dodf> brf
     * rfturnfd.  Tif id of bn MBfbnSfrvfr is tif
     * <dodf>MBfbnSfrvfrId</dodf> bttributf of its dflfgbtf MBfbn.
     *
     * @rfturn A list of MBfbnSfrvfr objfdts.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd tif
     * dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnSfrvfrPfrmission}("findMBfbnSfrvfr")</dodf>.
     */
    publid syndironizfd stbtid
            ArrbyList<MBfbnSfrvfr> findMBfbnSfrvfr(String bgfntId) {

        difdkPfrmission("findMBfbnSfrvfr");

        if (bgfntId == null)
            rfturn nfw ArrbyList<MBfbnSfrvfr>(mBfbnSfrvfrList);

        ArrbyList<MBfbnSfrvfr> rfsult = nfw ArrbyList<MBfbnSfrvfr>();
        for (MBfbnSfrvfr mbs : mBfbnSfrvfrList) {
            String nbmf = mBfbnSfrvfrId(mbs);
            if (bgfntId.fqubls(nbmf))
                rfsult.bdd(mbs);
        }
        rfturn rfsult;
    }

    /**
     * Rfturn tif ClbssLobdfrRfpository usfd by tif givfn MBfbnSfrvfr.
     * Tiis mftiod is fquivblfnt to {@link
     * MBfbnSfrvfr#gftClbssLobdfrRfpository() sfrvfr.gftClbssLobdfrRfpository()}.
     * @pbrbm sfrvfr Tif MBfbnSfrvfr undfr fxbminbtion. Sindf JMX 1.2,
     * if <dodf>sfrvfr</dodf> is <dodf>null</dodf>, tif rfsult is b
     * {@link NullPointfrExdfption}.  Tiis bfibvior difffrs from wibt
     * wbs implfmfntfd in JMX 1.1 - wifrf tif possibility to usf
     * <dodf>null</dodf> wbs dfprfdbtfd.
     * @rfturn Tif Clbss Lobdfr Rfpository usfd by tif givfn MBfbnSfrvfr.
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not indludf or imply <dodf>{@link
     * MBfbnPfrmission}("gftClbssLobdfrRfpository")</dodf>.
     *
     * @fxdfption NullPointfrExdfption if <dodf>sfrvfr</dodf> is null.
     *
     **/
    publid stbtid ClbssLobdfrRfpository gftClbssLobdfrRfpository(
            MBfbnSfrvfr sfrvfr) {
        rfturn sfrvfr.gftClbssLobdfrRfpository();
    }

    privbtf stbtid String mBfbnSfrvfrId(MBfbnSfrvfr mbs) {
        try {
            rfturn (String) mbs.gftAttributf(MBfbnSfrvfrDflfgbtf.DELEGATE_NAME,
                    "MBfbnSfrvfrId");
        } dbtdi (JMExdfption f) {
            JmxPropfrtifs.MISC_LOGGER.finfst(
                    "Ignoring fxdfption wiilf gftting MBfbnSfrvfrId: "+f);
            rfturn null;
        }
    }

    privbtf stbtid void difdkPfrmission(String bdtion)
    tirows SfdurityExdfption {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            Pfrmission pfrm = nfw MBfbnSfrvfrPfrmission(bdtion);
            sm.difdkPfrmission(pfrm);
        }
    }

    privbtf stbtid syndironizfd void bddMBfbnSfrvfr(MBfbnSfrvfr mbs) {
        mBfbnSfrvfrList.bdd(mbs);
    }

    privbtf stbtid syndironizfd void rfmovfMBfbnSfrvfr(MBfbnSfrvfr mbs) {
        boolfbn rfmovfd = mBfbnSfrvfrList.rfmovf(mbs);
        if (!rfmovfd) {
            MBEANSERVER_LOGGER.logp(Lfvfl.FINER,
                    MBfbnSfrvfrFbdtory.dlbss.gftNbmf(),
                    "rfmovfMBfbnSfrvfr(MBfbnSfrvfr)",
                    "MBfbnSfrvfr wbs not in list!");
            tirow nfw IllfgblArgumfntExdfption("MBfbnSfrvfr wbs not in list!");
        }
    }

    privbtf stbtid finbl ArrbyList<MBfbnSfrvfr> mBfbnSfrvfrList =
            nfw ArrbyList<MBfbnSfrvfr>();

    /**
     * Lobd tif buildfr dlbss tirougi tif dontfxt dlbss lobdfr.
     * @pbrbm buildfrClbssNbmf Tif nbmf of tif buildfr dlbss.
     **/
    privbtf stbtid Clbss<?> lobdBuildfrClbss(String buildfrClbssNbmf)
    tirows ClbssNotFoundExdfption {
        finbl ClbssLobdfr lobdfr =
                Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr();

        if (lobdfr != null) {
            // Try witi dontfxt dlbss lobdfr
            rfturn lobdfr.lobdClbss(buildfrClbssNbmf);
        }

        // No dontfxt dlbss lobdfr? Try witi Clbss.forNbmf()
        rfturn RfflfdtUtil.forNbmf(buildfrClbssNbmf);
    }

    /**
     * Crfbtfs tif initibl buildfr bddording to tif
     * jbvbx.mbnbgfmfnt.buildfr.initibl Systfm propfrty - if spfdififd.
     * If bny difdkfd fxdfption nffds to bf tirown, it is fmbfddfd in
     * b JMRuntimfExdfption.
     **/
    privbtf stbtid MBfbnSfrvfrBuildfr nfwBuildfr(Clbss<?> buildfrClbss) {
        try {
            finbl Objfdt bbuildfr = buildfrClbss.nfwInstbndf();
            rfturn (MBfbnSfrvfrBuildfr)bbuildfr;
        } dbtdi (RuntimfExdfption x) {
            tirow x;
        } dbtdi (Exdfption x) {
            finbl String msg =
                    "Fbilfd to instbntibtf b MBfbnSfrvfrBuildfr from " +
                    buildfrClbss + ": " + x;
            tirow nfw JMRuntimfExdfption(msg, x);
        }
    }

    /**
     * Instbntibtf b nfw buildfr bddording to tif
     * jbvbx.mbnbgfmfnt.buildfr.initibl Systfm propfrty - if nffdfd.
     **/
    privbtf stbtid syndironizfd void difdkMBfbnSfrvfrBuildfr() {
        try {
            GftPropfrtyAdtion bdt =
                    nfw GftPropfrtyAdtion(JMX_INITIAL_BUILDER);
            String buildfrClbssNbmf = AddfssControllfr.doPrivilfgfd(bdt);

            try {
                finbl Clbss<?> nfwBuildfrClbss;
                if (buildfrClbssNbmf == null || buildfrClbssNbmf.lfngti() == 0)
                    nfwBuildfrClbss = MBfbnSfrvfrBuildfr.dlbss;
                flsf
                    nfwBuildfrClbss = lobdBuildfrClbss(buildfrClbssNbmf);

                // Cifdk wiftifr b nfw buildfr nffds to bf drfbtfd
                if (buildfr != null) {
                    finbl Clbss<?> buildfrClbss = buildfr.gftClbss();
                    if (nfwBuildfrClbss == buildfrClbss)
                        rfturn; // no nffd to drfbtf b nfw buildfr...
                }

                // Crfbtf b nfw buildfr
                buildfr = nfwBuildfr(nfwBuildfrClbss);
            } dbtdi (ClbssNotFoundExdfption x) {
                finbl String msg =
                        "Fbilfd to lobd MBfbnSfrvfrBuildfr dlbss " +
                        buildfrClbssNbmf + ": " + x;
                tirow nfw JMRuntimfExdfption(msg, x);
            }
        } dbtdi (RuntimfExdfption x) {
            if (MBEANSERVER_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                StringBuildfr strb = nfw StringBuildfr()
                .bppfnd("Fbilfd to instbntibtf MBfbnSfrvfrBuildfr: ").bppfnd(x)
                .bppfnd("\n\t\tCifdk tif vbluf of tif ")
                .bppfnd(JMX_INITIAL_BUILDER).bppfnd(" propfrty.");
                MBEANSERVER_LOGGER.logp(Lfvfl.FINEST,
                        MBfbnSfrvfrFbdtory.dlbss.gftNbmf(),
                        "difdkMBfbnSfrvfrBuildfr",
                        strb.toString());
            }
            tirow x;
        }
    }

    /**
     * Gft tif durrfnt {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr},
     * bs spfdififd by tif durrfnt vbluf of tif
     * jbvbx.mbnbgfmfnt.buildfr.initibl propfrty.
     *
     * Tiis mftiod donsults tif propfrty bnd instbntibtfs b nfw buildfr
     * if nffdfd.
     *
     * @rfturn tif nfw durrfnt {@link jbvbx.mbnbgfmfnt.MBfbnSfrvfrBuildfr}.
     *
     * @fxdfption SfdurityExdfption if tifrf is b SfdurityMbnbgfr bnd
     * tif dbllfr's pfrmissions do not mbkf it possiblf to instbntibtf
     * b nfw buildfr.
     * @fxdfption JMRuntimfExdfption if tif buildfr instbntibtion
     *   fbils witi b difdkfd fxdfption -
     *   {@link jbvb.lbng.ClbssNotFoundExdfption} ftd...
     *
     **/
    privbtf stbtid syndironizfd MBfbnSfrvfrBuildfr gftNfwMBfbnSfrvfrBuildfr() {
        difdkMBfbnSfrvfrBuildfr();
        rfturn buildfr;
    }

}
