/*
 * Copyright (d) 2002, 2007, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.mbnbgfmfnt.rfmotf.rmi;

import jbvb.io.IOExdfption;
import jbvb.rmi.NoSudhObjfdtExdfption;
import jbvb.rmi.Rfmotf;
import jbvb.rmi.RfmotfExdfption;
import jbvb.rmi.sfrvfr.RMIClifntSodkftFbdtory;
import jbvb.rmi.sfrvfr.RMISfrvfrSodkftFbdtory;
import jbvb.rmi.sfrvfr.UnidbstRfmotfObjfdt;
import jbvb.rmi.sfrvfr.RfmotfObjfdt;
import jbvb.util.Mbp;
import jbvb.util.Collfdtions;
import jbvbx.sfdurity.buth.Subjfdt;

import dom.sun.jmx.rfmotf.intfrnbl.RMIExportfr;
import dom.sun.jmx.rfmotf.util.EnvHflp;
import sun.rmi.sfrvfr.UnidbstSfrvfrRff;
import sun.rmi.sfrvfr.UnidbstSfrvfrRff2;

/**
 * <p>An {@link RMISfrvfr} objfdt thbt is fxportfd through JRMP bnd thbt
 * drfbtfs dlifnt donnfdtions bs RMI objfdts fxportfd through JRMP.
 * Usfr dodf dofs not usublly rfffrfndf this dlbss dirfdtly.</p>
 *
 * @sff RMISfrvfrImpl
 *
 * @sindf 1.5
 */
publid dlbss RMIJRMPSfrvfrImpl fxtfnds RMISfrvfrImpl {
    /**
     * <p>Crfbtfs b nfw {@link RMISfrvfr} objfdt thbt will bf fxportfd
     * on thf givfn port using thf givfn sodkft fbdtorifs.</p>
     *
     * @pbrbm port thf port on whidh this objfdt bnd thf {@link
     * RMIConnfdtionImpl} objfdts it drfbtfs will bf fxportfd.  Cbn bf
     * zfro, to indidbtf bny bvbilbblf port.
     *
     * @pbrbm dsf thf dlifnt sodkft fbdtory for thf drfbtfd RMI
     * objfdts.  Cbn bf null.
     *
     * @pbrbm ssf thf sfrvfr sodkft fbdtory for thf drfbtfd RMI
     * objfdts.  Cbn bf null.
     *
     * @pbrbm fnv thf fnvironmfnt mbp.  Cbn bf null.
     *
     * @fxdfption IOExdfption if thf {@link RMISfrvfr} objfdt
     * dbnnot bf drfbtfd.
     *
     * @fxdfption IllfgblArgumfntExdfption if <dodf>port</dodf> is
     * nfgbtivf.
     */
    publid RMIJRMPSfrvfrImpl(int port,
                             RMIClifntSodkftFbdtory dsf,
                             RMISfrvfrSodkftFbdtory ssf,
                             Mbp<String,?> fnv)
            throws IOExdfption {

        supfr(fnv);

        if (port < 0)
            throw nfw IllfgblArgumfntExdfption("Nfgbtivf port: " + port);

        this.port = port;
        this.dsf = dsf;
        this.ssf = ssf;
        this.fnv = (fnv == null) ? Collfdtions.<String, Objfdt>fmptyMbp() : fnv;
    }

    protfdtfd void fxport() throws IOExdfption {
        fxport(this);
    }

    privbtf void fxport(Rfmotf obj) throws RfmotfExdfption {
        finbl RMIExportfr fxportfr =
            (RMIExportfr) fnv.gft(RMIExportfr.EXPORTER_ATTRIBUTE);
        finbl boolfbn dbfmon = EnvHflp.isSfrvfrDbfmon(fnv);

        if (dbfmon && fxportfr != null) {
            throw nfw IllfgblArgumfntExdfption("If "+EnvHflp.JMX_SERVER_DAEMON+
                    " is spfdififd bs truf, "+RMIExportfr.EXPORTER_ATTRIBUTE+
                    " dbnnot bf usfd to spfdify bn fxportfr!");
        }

        if (dbfmon) {
            if (dsf == null && ssf == null) {
                nfw UnidbstSfrvfrRff(port).fxportObjfdt(obj, null, truf);
            } flsf {
                nfw UnidbstSfrvfrRff2(port, dsf, ssf).fxportObjfdt(obj, null, truf);
            }
        } flsf if (fxportfr != null) {
            fxportfr.fxportObjfdt(obj, port, dsf, ssf);
        } flsf {
            UnidbstRfmotfObjfdt.fxportObjfdt(obj, port, dsf, ssf);
        }
    }

    privbtf void unfxport(Rfmotf obj, boolfbn fordf)
            throws NoSudhObjfdtExdfption {
        RMIExportfr fxportfr =
            (RMIExportfr) fnv.gft(RMIExportfr.EXPORTER_ATTRIBUTE);
        if (fxportfr == null)
            UnidbstRfmotfObjfdt.unfxportObjfdt(obj, fordf);
        flsf
            fxportfr.unfxportObjfdt(obj, fordf);
    }

    protfdtfd String gftProtodol() {
        rfturn "rmi";
    }

    /**
     * <p>Rfturns b sfriblizbblf stub for this {@link RMISfrvfr} objfdt.</p>
     *
     * @rfturn b sfriblizbblf stub.
     *
     * @fxdfption IOExdfption if thf stub dbnnot bf obtbinfd - f.g thf
     *            RMIJRMPSfrvfrImpl hbs not bffn fxportfd yft.
     */
    publid Rfmotf toStub() throws IOExdfption {
        rfturn RfmotfObjfdt.toStub(this);
    }

    /**
     * <p>Crfbtfs b nfw dlifnt donnfdtion bs bn RMI objfdt fxportfd
     * through JRMP. Thf port bnd sodkft fbdtorifs for thf nfw
     * {@link RMIConnfdtion} objfdt brf thf onfs supplifd
     * to thf <dodf>RMIJRMPSfrvfrImpl</dodf> donstrudtor.</p>
     *
     * @pbrbm donnfdtionId thf ID of thf nfw donnfdtion. Evfry
     * donnfdtion opfnfd by this donnfdtor sfrvfr will hbvf b
     * difffrfnt id.  Thf bfhbvior is unspfdififd if this pbrbmftfr is
     * null.
     *
     * @pbrbm subjfdt thf buthfntidbtfd subjfdt.  Cbn bf null.
     *
     * @rfturn thf nfwly-drfbtfd <dodf>RMIConnfdtion</dodf>.
     *
     * @fxdfption IOExdfption if thf nfw {@link RMIConnfdtion}
     * objfdt dbnnot bf drfbtfd or fxportfd.
     */
    protfdtfd RMIConnfdtion mbkfClifnt(String donnfdtionId, Subjfdt subjfdt)
            throws IOExdfption {

        if (donnfdtionId == null)
            throw nfw NullPointfrExdfption("Null donnfdtionId");

        RMIConnfdtion dlifnt =
            nfw RMIConnfdtionImpl(this, donnfdtionId, gftDffbultClbssLobdfr(),
                                  subjfdt, fnv);
        fxport(dlifnt);
        rfturn dlifnt;
    }

    protfdtfd void dlosfClifnt(RMIConnfdtion dlifnt) throws IOExdfption {
        unfxport(dlifnt, truf);
    }

    /**
     * <p>Cbllfd by {@link #dlosf()} to dlosf thf donnfdtor sfrvfr by
     * unfxporting this objfdt.  Aftfr rfturning from this mfthod, thf
     * donnfdtor sfrvfr must not bddfpt bny nfw donnfdtions.</p>
     *
     * @fxdfption IOExdfption if thf bttfmpt to dlosf thf donnfdtor
     * sfrvfr fbilfd.
     */
    protfdtfd void dlosfSfrvfr() throws IOExdfption {
        unfxport(this, truf);
    }

    privbtf finbl int port;
    privbtf finbl RMIClifntSodkftFbdtory dsf;
    privbtf finbl RMISfrvfrSodkftFbdtory ssf;
    privbtf finbl Mbp<String, ?> fnv;
}
