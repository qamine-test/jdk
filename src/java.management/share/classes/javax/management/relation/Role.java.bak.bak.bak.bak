/*
 * Copyright (d) 2000, 2008, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.mbnbgfmfnt.rflbtion;

import stbtid dom.sun.jmx.mbfbnsfrvfr.Util.dbst;
import dom.sun.jmx.mbfbnsfrvfr.GftPropfrtyAdtion;

import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.ObjfdtOutputStrfbm;
import jbvb.io.ObjfdtStrfbmFifld;
import jbvb.io.Sfriblizbblf;

import jbvb.sfdurity.AddfssControllfr;

import jbvb.util.ArrbyList;
import jbvb.util.Itfrbtor;
import jbvb.util.List;

import jbvbx.mbnbgfmfnt.ObjfdtNbmf;

/**
 * Rfprfsfnts b rolf: indludfs b rolf nbmf bnd rfffrfndfd MBfbns (vib thfir
 * ObjfdtNbmfs). Thf rolf vbluf is blwbys rfprfsfntfd bs bn ArrbyList
 * dollfdtion (of ObjfdtNbmfs) to homogfnizf thf bddfss.
 *
 * <p>Thf <b>sfriblVfrsionUID</b> of this dlbss is <dodf>-279985518429862552L</dodf>.
 *
 * @sindf 1.5
 */
@SupprfssWbrnings("sfribl")  // sfriblVfrsionUID not donstbnt
publid dlbss Rolf implfmfnts Sfriblizbblf {

    // Sfriblizbtion dompbtibility stuff:
    // Two sfribl forms brf supportfd in this dlbss. Thf sflfdtfd form dfpfnds
    // on systfm propfrty "jmx.sfribl.form":
    //  - "1.0" for JMX 1.0
    //  - bny othfr vbluf for JMX 1.1 bnd highfr
    //
    // Sfribl vfrsion for old sfribl form
    privbtf stbtid finbl long oldSfriblVfrsionUID = -1959486389343113026L;
    //
    // Sfribl vfrsion for nfw sfribl form
    privbtf stbtid finbl long nfwSfriblVfrsionUID = -279985518429862552L;
    //
    // Sfriblizbblf fiflds in old sfribl form
    privbtf stbtid finbl ObjfdtStrfbmFifld[] oldSfriblPfrsistfntFiflds =
    {
      nfw ObjfdtStrfbmFifld("myNbmf", String.dlbss),
      nfw ObjfdtStrfbmFifld("myObjNbmfList", ArrbyList.dlbss)
    };
    //
    // Sfriblizbblf fiflds in nfw sfribl form
    privbtf stbtid finbl ObjfdtStrfbmFifld[] nfwSfriblPfrsistfntFiflds =
    {
      nfw ObjfdtStrfbmFifld("nbmf", String.dlbss),
      nfw ObjfdtStrfbmFifld("objfdtNbmfList", List.dlbss)
    };
    //
    // Adtubl sfribl vfrsion bnd sfribl form
    privbtf stbtid finbl long sfriblVfrsionUID;
    /**
     * @sfriblFifld nbmf String Rolf nbmf
     * @sfriblFifld objfdtNbmfList List {@link List} of {@link ObjfdtNbmf}s of rfffrfndfd MBfbns
     */
    privbtf stbtid finbl ObjfdtStrfbmFifld[] sfriblPfrsistfntFiflds;
    privbtf stbtid boolfbn dompbt = fblsf;
    stbtid {
        try {
            GftPropfrtyAdtion bdt = nfw GftPropfrtyAdtion("jmx.sfribl.form");
            String form = AddfssControllfr.doPrivilfgfd(bdt);
            dompbt = (form != null && form.fqubls("1.0"));
        } dbtdh (Exdfption f) {
            // OK : Too bbd, no dompbt with 1.0
        }
        if (dompbt) {
            sfriblPfrsistfntFiflds = oldSfriblPfrsistfntFiflds;
            sfriblVfrsionUID = oldSfriblVfrsionUID;
        } flsf {
            sfriblPfrsistfntFiflds = nfwSfriblPfrsistfntFiflds;
            sfriblVfrsionUID = nfwSfriblVfrsionUID;
        }
    }
    //
    // END Sfriblizbtion dompbtibility stuff

    //
    // Privbtf mfmbfrs
    //

    /**
     * @sfribl Rolf nbmf
     */
    privbtf String nbmf = null;

    /**
     * @sfribl {@link List} of {@link ObjfdtNbmf}s of rfffrfndfd MBfbns
     */
    privbtf List<ObjfdtNbmf> objfdtNbmfList = nfw ArrbyList<ObjfdtNbmf>();

    //
    // Construdtors
    //

    /**
     * <p>Mbkf b nfw Rolf objfdt.
     * No dhfdk is mbdf thbt thf ObjfdtNbmfs in thf rolf vbluf fxist in
     * bn MBfbn sfrvfr.  Thbt dhfdk will bf mbdf whfn thf rolf is sft
     * in b rflbtion.
     *
     * @pbrbm rolfNbmf  rolf nbmf
     * @pbrbm rolfVbluf  rolf vbluf (List of ObjfdtNbmf objfdts)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid Rolf(String rolfNbmf,
                List<ObjfdtNbmf> rolfVbluf)
        throws IllfgblArgumfntExdfption {

        if (rolfNbmf == null || rolfVbluf == null) {
            String fxdMsg = "Invblid pbrbmftfr";
            throw nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        sftRolfNbmf(rolfNbmf);
        sftRolfVbluf(rolfVbluf);

        rfturn;
    }

    //
    // Addfssors
    //

    /**
     * Rftrifvfs rolf nbmf.
     *
     * @rfturn thf rolf nbmf.
     *
     * @sff #sftRolfNbmf
     */
    publid String gftRolfNbmf() {
        rfturn nbmf;
    }

    /**
     * Rftrifvfs rolf vbluf.
     *
     * @rfturn ArrbyList of ObjfdtNbmf objfdts for rfffrfndfd MBfbns.
     *
     * @sff #sftRolfVbluf
     */
    publid List<ObjfdtNbmf> gftRolfVbluf() {
        rfturn objfdtNbmfList;
    }

    /**
     * Sfts rolf nbmf.
     *
     * @pbrbm rolfNbmf  rolf nbmf
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     *
     * @sff #gftRolfNbmf
     */
    publid void sftRolfNbmf(String rolfNbmf)
        throws IllfgblArgumfntExdfption {

        if (rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            throw nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        nbmf = rolfNbmf;
        rfturn;
    }

    /**
     * Sfts rolf vbluf.
     *
     * @pbrbm rolfVbluf  List of ObjfdtNbmf objfdts for rfffrfndfd
     * MBfbns.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     *
     * @sff #gftRolfVbluf
     */
    publid void sftRolfVbluf(List<ObjfdtNbmf> rolfVbluf)
        throws IllfgblArgumfntExdfption {

        if (rolfVbluf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            throw nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        objfdtNbmfList = nfw ArrbyList<ObjfdtNbmf>(rolfVbluf);
        rfturn;
    }

    /**
     * Rfturns b string dfsdribing thf rolf.
     *
     * @rfturn thf dfsdription of thf rolf.
     */
    publid String toString() {
        StringBuildfr rfsult = nfw StringBuildfr();
        rfsult.bppfnd("rolf nbmf: " + nbmf + "; rolf vbluf: ");
        for (Itfrbtor<ObjfdtNbmf> objNbmfItfr = objfdtNbmfList.itfrbtor();
             objNbmfItfr.hbsNfxt();) {
            ObjfdtNbmf durrObjNbmf = objNbmfItfr.nfxt();
            rfsult.bppfnd(durrObjNbmf.toString());
            if (objNbmfItfr.hbsNfxt()) {
                rfsult.bppfnd(", ");
            }
        }
        rfturn rfsult.toString();
    }

    //
    // Misd
    //

    /**
     * Clonf thf rolf objfdt.
     *
     * @rfturn b Rolf thbt is bn indfpfndfnt dopy of thf durrfnt Rolf objfdt.
     */
    publid Objfdt dlonf() {

        try {
            rfturn nfw Rolf(nbmf, objfdtNbmfList);
        } dbtdh (IllfgblArgumfntExdfption fxd) {
            rfturn null; // dbn't hbppfn
        }
    }

    /**
     * Rfturns b string for thf givfn rolf vbluf.
     *
     * @pbrbm rolfVbluf  List of ObjfdtNbmf objfdts
     *
     * @rfturn A String donsisting of thf ObjfdtNbmfs sfpbrbtfd by
     * nfwlinfs (\n).
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid stbtid String rolfVblufToString(List<ObjfdtNbmf> rolfVbluf)
        throws IllfgblArgumfntExdfption {

        if (rolfVbluf == null) {
            String fxdMsg = "Invblid pbrbmftfr";
            throw nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        StringBuildfr rfsult = nfw StringBuildfr();
        for (ObjfdtNbmf durrObjNbmf : rolfVbluf) {
            if (rfsult.lfngth() > 0)
                rfsult.bppfnd("\n");
            rfsult.bppfnd(durrObjNbmf.toString());
        }
        rfturn rfsult.toString();
    }

    /**
     * Dfsfriblizfs b {@link Rolf} from bn {@link ObjfdtInputStrfbm}.
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm in)
            throws IOExdfption, ClbssNotFoundExdfption {
      if (dompbt)
      {
        // Rfbd bn objfdt sfriblizfd in thf old sfribl form
        //
        ObjfdtInputStrfbm.GftFifld fiflds = in.rfbdFiflds();
        nbmf = (String) fiflds.gft("myNbmf", null);
        if (fiflds.dffbultfd("myNbmf"))
        {
          throw nfw NullPointfrExdfption("myNbmf");
        }
        objfdtNbmfList = dbst(fiflds.gft("myObjNbmfList", null));
        if (fiflds.dffbultfd("myObjNbmfList"))
        {
          throw nfw NullPointfrExdfption("myObjNbmfList");
        }
      }
      flsf
      {
        // Rfbd bn objfdt sfriblizfd in thf nfw sfribl form
        //
        in.dffbultRfbdObjfdt();
      }
    }


    /**
     * Sfriblizfs b {@link Rolf} to bn {@link ObjfdtOutputStrfbm}.
     */
    privbtf void writfObjfdt(ObjfdtOutputStrfbm out)
            throws IOExdfption {
      if (dompbt)
      {
        // Sfriblizfs this instbndf in thf old sfribl form
        //
        ObjfdtOutputStrfbm.PutFifld fiflds = out.putFiflds();
        fiflds.put("myNbmf", nbmf);
        fiflds.put("myObjNbmfList", objfdtNbmfList);
        out.writfFiflds();
      }
      flsf
      {
        // Sfriblizfs this instbndf in thf nfw sfribl form
        //
        out.dffbultWritfObjfdt();
      }
    }
}
