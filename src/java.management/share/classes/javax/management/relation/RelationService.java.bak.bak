/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.mbnbgfmfnt.rflbtion;

import stbtid dom.sun.jmx.dffbults.JmxPropfrtifs.RELATION_LOGGER;
import stbtid dom.sun.jmx.mbfbnsfrvfr.Util.dbst;

import jbvb.util.ArrbyList;
import jbvb.util.Dbtf;
import jbvb.util.HbsiMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvb.util.dondurrfnt.btomid.AtomidLong;
import jbvb.util.logging.Lfvfl;

import jbvbx.mbnbgfmfnt.Attributf;
import jbvbx.mbnbgfmfnt.AttributfNotFoundExdfption;
import jbvbx.mbnbgfmfnt.InstbndfNotFoundExdfption;
import jbvbx.mbnbgfmfnt.InvblidAttributfVblufExdfption;
import jbvbx.mbnbgfmfnt.MBfbnExdfption;
import jbvbx.mbnbgfmfnt.MBfbnNotifidbtionInfo;
import jbvbx.mbnbgfmfnt.MBfbnRfgistrbtion;
import jbvbx.mbnbgfmfnt.MBfbnSfrvfr;
import jbvbx.mbnbgfmfnt.MBfbnSfrvfrDflfgbtf;
import jbvbx.mbnbgfmfnt.MBfbnSfrvfrNotifidbtion;
import jbvbx.mbnbgfmfnt.Notifidbtion;
import jbvbx.mbnbgfmfnt.NotifidbtionBrobddbstfrSupport;
import jbvbx.mbnbgfmfnt.NotifidbtionListfnfr;
import jbvbx.mbnbgfmfnt.ObjfdtNbmf;
import jbvbx.mbnbgfmfnt.RfflfdtionExdfption;

/**
 * Tif Rflbtion Sfrvidf is in dibrgf of drfbting bnd dflfting rflbtion typfs
 * bnd rflbtions, of ibndling tif donsistfndy bnd of providing qufry
 * mfdibnisms.
 * <P>It implfmfnts tif NotifidbtionBrobddbstfr by fxtfnding
 * NotifidbtionBrobddbstfrSupport to sfnd notifidbtions wifn b rflbtion is
 * rfmovfd from it.
 * <P>It implfmfnts tif NotifidbtionListfnfr intfrfbdf to bf bblf to rfdfivf
 * notifidbtions dondfrning unrfgistrbtion of MBfbns rfffrfndfd in rflbtion
 * rolfs bnd of rflbtion MBfbns.
 * <P>It implfmfnts tif MBfbnRfgistrbtion intfrfbdf to bf bblf to rftrifvf
 * its ObjfdtNbmf bnd MBfbn Sfrvfr.
 *
 * @sindf 1.5
 */
publid dlbss RflbtionSfrvidf fxtfnds NotifidbtionBrobddbstfrSupport
    implfmfnts RflbtionSfrvidfMBfbn, MBfbnRfgistrbtion, NotifidbtionListfnfr {

    //
    // Privbtf mfmbfrs
    //

    // Mbp bssodibting:
    //      <rflbtion id> -> <RflbtionSupport objfdt/ObjfdtNbmf>
    // dfpfnding if tif rflbtion ibs bffn drfbtfd using drfbtfRflbtion()
    // mftiod (so intfrnblly ibndlfd) or is bn MBfbn bddfd bs b rflbtion by tif
    // usfr
    privbtf Mbp<String,Objfdt> myRflId2ObjMbp = nfw HbsiMbp<String,Objfdt>();

    // Mbp bssodibting:
    //      <rflbtion id> -> <rflbtion typf nbmf>
    privbtf Mbp<String,String> myRflId2RflTypfMbp = nfw HbsiMbp<String,String>();

    // Mbp bssodibting:
    //      <rflbtion MBfbn Objfdt Nbmf> -> <rflbtion id>
    privbtf Mbp<ObjfdtNbmf,String> myRflMBfbnObjNbmf2RflIdMbp =
        nfw HbsiMbp<ObjfdtNbmf,String>();

    // Mbp bssodibting:
    //       <rflbtion typf nbmf> -> <RflbtionTypf objfdt>
    privbtf Mbp<String,RflbtionTypf> myRflTypf2ObjMbp =
        nfw HbsiMbp<String,RflbtionTypf>();

    // Mbp bssodibting:
    //       <rflbtion typf nbmf> -> ArrbyList of <rflbtion id>
    // to list bll tif rflbtions of b givfn typf
    privbtf Mbp<String,List<String>> myRflTypf2RflIdsMbp =
        nfw HbsiMbp<String,List<String>>();

    // Mbp bssodibting:
    //       <ObjfdtNbmf> -> HbsiMbp
    // tif vbluf HbsiMbp mbpping:
    //       <rflbtion id> -> ArrbyList of <rolf nbmf>
    // to trbdk wifrf b givfn MBfbn is rfffrfndfd.
    privbtf finbl Mbp<ObjfdtNbmf,Mbp<String,List<String>>>
        myRfffdMBfbnObjNbmf2RflIdsMbp =
            nfw HbsiMbp<ObjfdtNbmf,Mbp<String,List<String>>>();

    // Flbg to indidbtf if, wifn b notifidbtion is rfdfivfd for tif
    // unrfgistrbtion of bn MBfbn rfffrfndfd in b rflbtion, if bn immfdibtf
    // "purgf" of tif rflbtions (look for tif rflbtions no
    // longfr vblid) ibs to bf pfrformfd , or if tibt will bf pfrformfd only
    // wifn tif purgfRflbtions mftiod will bf fxpliditly dbllfd.
    // truf is immfdibtf purgf.
    privbtf boolfbn myPurgfFlbg = truf;

    // Intfrnbl dountfr to providf sfqufndf numbfrs for notifidbtions sfnt by:
    // - tif Rflbtion Sfrvidf
    // - b rflbtion ibndlfd by tif Rflbtion Sfrvidf
    privbtf finbl AtomidLong btomidSfqNo = nfw AtomidLong();

    // ObjfdtNbmf usfd to rfgistfr tif Rflbtion Sfrvidf in tif MBfbn Sfrvfr
    privbtf ObjfdtNbmf myObjNbmf = null;

    // MBfbn Sfrvfr wifrf tif Rflbtion Sfrvidf is rfgistfrfd
    privbtf MBfbnSfrvfr myMBfbnSfrvfr = null;

    // Filtfr rfgistfrfd in tif MBfbn Sfrvfr witi tif Rflbtion Sfrvidf to bf
    // informfd of rfffrfndfd MBfbn dfrfgistrbtions
    privbtf MBfbnSfrvfrNotifidbtionFiltfr myUnrfgNtfFiltfr = null;

    // List of unrfgistrbtion notifidbtions rfdfivfd (storbgf usfd if purgf
    // of rflbtions wifn unrfgistfring b rfffrfndfd MBfbn is not immfdibtf but
    // on usfr rfqufst)
    privbtf List<MBfbnSfrvfrNotifidbtion> myUnrfgNtfList =
        nfw ArrbyList<MBfbnSfrvfrNotifidbtion>();

    //
    // Construdtor
    //

    /**
     * Construdtor.
     *
     * @pbrbm immfdibtfPurgfFlbg  flbg to indidbtf wifn b notifidbtion is
     * rfdfivfd for tif unrfgistrbtion of bn MBfbn rfffrfndfd in b rflbtion, if
     * bn immfdibtf "purgf" of tif rflbtions (look for tif rflbtions no
     * longfr vblid) ibs to bf pfrformfd , or if tibt will bf pfrformfd only
     * wifn tif purgfRflbtions mftiod will bf fxpliditly dbllfd.
     * <P>truf is immfdibtf purgf.
     */
    publid RflbtionSfrvidf(boolfbn immfdibtfPurgfFlbg) {

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "RflbtionSfrvidf");

        sftPurgfFlbg(immfdibtfPurgfFlbg);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "RflbtionSfrvidf");
        rfturn;
    }

    /**
     * Cifdks if tif Rflbtion Sfrvidf is bdtivf.
     * Currfnt dondition is tibt tif Rflbtion Sfrvidf must bf rfgistfrfd in tif
     * MBfbn Sfrvfr
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if it is not
     * rfgistfrfd
     */
    publid void isAdtivf()
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption {
        if (myMBfbnSfrvfr == null) {
            // MBfbn Sfrvfr not sft by prfRfgistfr(): rflbtion sfrvidf not
            // rfgistfrfd
            String fxdMsg =
                "Rflbtion Sfrvidf not rfgistfrfd in tif MBfbn Sfrvfr.";
            tirow nfw RflbtionSfrvidfNotRfgistfrfdExdfption(fxdMsg);
        }
        rfturn;
    }

    //
    // MBfbnRfgistrbtion intfrfbdf
    //

    // Prf-rfgistrbtion: rftrifvfs its ObjfdtNbmf bnd MBfbn Sfrvfr
    //
    // No fxdfption tirown.
    publid ObjfdtNbmf prfRfgistfr(MBfbnSfrvfr sfrvfr,
                                  ObjfdtNbmf nbmf)
        tirows Exdfption {

        myMBfbnSfrvfr = sfrvfr;
        myObjNbmf = nbmf;
        rfturn nbmf;
    }

    // Post-rfgistrbtion: dofs notiing
    publid void postRfgistfr(Boolfbn rfgistrbtionDonf) {
        rfturn;
    }

    // Prf-unrfgistrbtion: dofs notiing
    publid void prfDfrfgistfr()
        tirows Exdfption {
        rfturn;
    }

    // Post-unrfgistrbtion: dofs notiing
    publid void postDfrfgistfr() {
        rfturn;
    }

    //
    // Addfssors
    //

    /**
     * Rfturns tif flbg to indidbtf if wifn b notifidbtion is rfdfivfd for tif
     * unrfgistrbtion of bn MBfbn rfffrfndfd in b rflbtion, if bn immfdibtf
     * "purgf" of tif rflbtions (look for tif rflbtions no longfr vblid)
     * ibs to bf pfrformfd , or if tibt will bf pfrformfd only wifn tif
     * purgfRflbtions mftiod will bf fxpliditly dbllfd.
     * <P>truf is immfdibtf purgf.
     *
     * @rfturn truf if purgfs brf butombtid.
     *
     * @sff #sftPurgfFlbg
     */
    publid boolfbn gftPurgfFlbg() {
        rfturn myPurgfFlbg;
    }

    /**
     * Sfts tif flbg to indidbtf if wifn b notifidbtion is rfdfivfd for tif
     * unrfgistrbtion of bn MBfbn rfffrfndfd in b rflbtion, if bn immfdibtf
     * "purgf" of tif rflbtions (look for tif rflbtions no longfr vblid)
     * ibs to bf pfrformfd , or if tibt will bf pfrformfd only wifn tif
     * purgfRflbtions mftiod will bf fxpliditly dbllfd.
     * <P>truf is immfdibtf purgf.
     *
     * @pbrbm purgfFlbg  flbg
     *
     * @sff #gftPurgfFlbg
     */
    publid void sftPurgfFlbg(boolfbn purgfFlbg) {

        myPurgfFlbg = purgfFlbg;
        rfturn;
    }

    //
    // Rflbtion typf ibndling
    //

    /**
     * Crfbtfs b rflbtion typf (b RflbtionTypfSupport objfdt) witi givfn
     * rolf infos (providfd by tif RolfInfo objfdts), bnd bdds it in tif
     * Rflbtion Sfrvidf.
     *
     * @pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf
     * @pbrbm rolfInfoArrby  brrby of rolf infos
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption InvblidRflbtionTypfExdfption  If:
     * <P>- tifrf is blrfbdy b rflbtion typf witi tibt nbmf
     * <P>- tif sbmf nbmf ibs bffn usfd for two difffrfnt rolf infos
     * <P>- no rolf info providfd
     * <P>- onf null rolf info providfd
     */
    publid void drfbtfRflbtionTypf(String rflbtionTypfNbmf,
                                   RolfInfo[] rolfInfoArrby)
        tirows IllfgblArgumfntExdfption,
               InvblidRflbtionTypfExdfption {

        if (rflbtionTypfNbmf == null || rolfInfoArrby == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "drfbtfRflbtionTypf", rflbtionTypfNbmf);

        // Cbn tirow bn InvblidRflbtionTypfExdfption
        RflbtionTypf rflTypf =
            nfw RflbtionTypfSupport(rflbtionTypfNbmf, rolfInfoArrby);

        bddRflbtionTypfInt(rflTypf);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "drfbtfRflbtionTypf");
        rfturn;
    }

    /**
     * Adds givfn objfdt bs b rflbtion typf. Tif objfdt is fxpfdtfd to
     * implfmfnt tif RflbtionTypf intfrfbdf.
     *
     * @pbrbm rflbtionTypfObj  rflbtion typf objfdt (implfmfnting tif
     * RflbtionTypf intfrfbdf)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr or if
     * {@link RflbtionTypf#gftRflbtionTypfNbmf
     * rflbtionTypfObj.gftRflbtionTypfNbmf()} rfturns null.
     * @fxdfption InvblidRflbtionTypfExdfption  if:
     * <P>- tif sbmf nbmf ibs bffn usfd for two difffrfnt rolfs
     * <P>- no rolf info providfd
     * <P>- onf null rolf info providfd
     * <P>- tifrf is blrfbdy b rflbtion typf witi tibt nbmf
     */
    publid void bddRflbtionTypf(RflbtionTypf rflbtionTypfObj)
        tirows IllfgblArgumfntExdfption,
               InvblidRflbtionTypfExdfption {

        if (rflbtionTypfObj == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionTypf");

        // Cifdks tif rolf infos
        List<RolfInfo> rolfInfoList = rflbtionTypfObj.gftRolfInfos();
        if (rolfInfoList == null) {
            String fxdMsg = "No rolf info providfd.";
            tirow nfw InvblidRflbtionTypfExdfption(fxdMsg);
        }

        RolfInfo[] rolfInfoArrby = nfw RolfInfo[rolfInfoList.sizf()];
        int i = 0;
        for (RolfInfo durrRolfInfo : rolfInfoList) {
            rolfInfoArrby[i] = durrRolfInfo;
            i++;
        }
        // Cbn tirow InvblidRflbtionTypfExdfption
        RflbtionTypfSupport.difdkRolfInfos(rolfInfoArrby);

        bddRflbtionTypfInt(rflbtionTypfObj);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionTypf");
        rfturn;
     }

    /**
     * Rftrifvfs nbmfs of bll known rflbtion typfs.
     *
     * @rfturn ArrbyList of rflbtion typf nbmfs (Strings)
     */
    publid List<String> gftAllRflbtionTypfNbmfs() {
        ArrbyList<String> rfsult;
        syndironizfd(myRflTypf2ObjMbp) {
            rfsult = nfw ArrbyList<String>(myRflTypf2ObjMbp.kfySft());
        }
        rfturn rfsult;
    }

    /**
     * Rftrifvfs list of rolf infos (RolfInfo objfdts) of b givfn rflbtion
     * typf.
     *
     * @pbrbm rflbtionTypfNbmf  nbmf of rflbtion typf
     *
     * @rfturn ArrbyList of RolfInfo.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  if tifrf is no rflbtion typf
     * witi tibt nbmf.
     */
    publid List<RolfInfo> gftRolfInfos(String rflbtionTypfNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        if (rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfInfos", rflbtionTypfNbmf);

        // Cbn tirow b RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfInfos");
        rfturn rflTypf.gftRolfInfos();
    }

    /**
     * Rftrifvfs rolf info for givfn rolf nbmf of b givfn rflbtion typf.
     *
     * @pbrbm rflbtionTypfNbmf  nbmf of rflbtion typf
     * @pbrbm rolfInfoNbmf  nbmf of rolf
     *
     * @rfturn RolfInfo objfdt.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  if tif rflbtion typf is not
     * known in tif Rflbtion Sfrvidf
     * @fxdfption RolfInfoNotFoundExdfption  if tif rolf is not pbrt of tif
     * rflbtion typf.
     */
    publid RolfInfo gftRolfInfo(String rflbtionTypfNbmf,
                                String rolfInfoNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption,
               RolfInfoNotFoundExdfption {

        if (rflbtionTypfNbmf == null || rolfInfoNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfInfo", nfw Objfdt[] {rflbtionTypfNbmf, rolfInfoNbmf});

        // Cbn tirow b RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        // Cbn tirow b RolfInfoNotFoundExdfption
        RolfInfo rolfInfo = rflTypf.gftRolfInfo(rolfInfoNbmf);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfInfo");
        rfturn rolfInfo;
    }

    /**
     * Rfmovfs givfn rflbtion typf from Rflbtion Sfrvidf.
     * <P>Tif rflbtion objfdts of tibt typf will bf rfmovfd from tif
     * Rflbtion Sfrvidf.
     *
     * @pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf to bf rfmovfd
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  If tifrf is no rflbtion typf
     * witi tibt nbmf
     */
    publid void rfmovfRflbtionTypf(String rflbtionTypfNbmf)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        if (rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfRflbtionTypf", rflbtionTypfNbmf);

        // Cifdks if tif rflbtion typf to bf rfmovfd fxists
        // Cbn tirow b RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        // Rftrifvfs tif rflbtion ids for rflbtions of tibt typf
        List<String> rflIdList = null;
        syndironizfd(myRflTypf2RflIdsMbp) {
            // Notf: tbkf b dopy of tif list bs it is b pbrt of b mbp tibt
            //       will bf updbtfd by rfmovfRflbtion() bflow.
            List<String> rflIdList1 =
                myRflTypf2RflIdsMbp.gft(rflbtionTypfNbmf);
            if (rflIdList1 != null) {
                rflIdList = nfw ArrbyList<String>(rflIdList1);
            }
        }

        // Rfmovfs tif rflbtion typf from bll mbps
        syndironizfd(myRflTypf2ObjMbp) {
            myRflTypf2ObjMbp.rfmovf(rflbtionTypfNbmf);
        }
        syndironizfd(myRflTypf2RflIdsMbp) {
            myRflTypf2RflIdsMbp.rfmovf(rflbtionTypfNbmf);
        }

        // Rfmovfs bll rflbtions of tibt typf
        if (rflIdList != null) {
            for (String durrRflId : rflIdList) {
                // Notf: will rfmovf it from myRflId2RflTypfMbp :)
                //
                // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption (dftfdtfd
                // bbovf)
                // Sibll not tirow b RflbtionNotFoundExdfption
                try {
                    rfmovfRflbtion(durrRflId);
                } dbtdi (RflbtionNotFoundExdfption fxd1) {
                    tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfRflbtionTypf");
        rfturn;
    }

    //
    // Rflbtion ibndling
    //

    /**
     * Crfbtfs b simplf rflbtion (rfprfsfntfd by b RflbtionSupport objfdt) of
     * givfn rflbtion typf, bnd bdds it in tif Rflbtion Sfrvidf.
     * <P>Rolfs brf initiblizfd bddording to tif rolf list providfd in
     * pbrbmftfr. Tif onfs not initiblizfd in tiis wby brf sft to bn fmpty
     * ArrbyList of ObjfdtNbmfs.
     * <P>A RflbtionNotifidbtion, witi typf RELATION_BASIC_CREATION, is sfnt.
     *
     * @pbrbm rflbtionId  rflbtion idfntififr, to idfntify uniqufly tif rflbtion
     * insidf tif Rflbtion Sfrvidf
     * @pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf (ibs to bf drfbtfd
     * in tif Rflbtion Sfrvidf)
     * @pbrbm rolfList  rolf list to initiblizf rolfs of tif rflbtion (dbn
     * bf null).
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr, fxdfpt tif rolf
     * list wiidi dbn bf null if no rolf initiblizbtion
     * @fxdfption RolfNotFoundExdfption  if b vbluf is providfd for b rolf
     * tibt dofs not fxist in tif rflbtion typf
     * @fxdfption InvblidRflbtionIdExdfption  if rflbtion id blrfbdy usfd
     * @fxdfption RflbtionTypfNotFoundExdfption  if rflbtion typf not known in
     * Rflbtion Sfrvidf
     * @fxdfption InvblidRolfVblufExdfption if:
     * <P>- tif sbmf rolf nbmf is usfd for two difffrfnt rolfs
     * <P>- tif numbfr of rfffrfndfd MBfbns in givfn vbluf is lfss tibn
     * fxpfdtfd minimum dfgrff
     * <P>- tif numbfr of rfffrfndfd MBfbns in providfd vbluf fxdffds fxpfdtfd
     * mbximum dfgrff
     * <P>- onf rfffrfndfd MBfbn in tif vbluf is not bn Objfdt of tif MBfbn
     * dlbss fxpfdtfd for tibt rolf
     * <P>- bn MBfbn providfd for tibt rolf dofs not fxist
     */
    publid void drfbtfRflbtion(String rflbtionId,
                               String rflbtionTypfNbmf,
                               RolfList rolfList)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RolfNotFoundExdfption,
               InvblidRflbtionIdExdfption,
               RflbtionTypfNotFoundExdfption,
               InvblidRolfVblufExdfption {

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        if (rflbtionId == null ||
            rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "drfbtfRflbtion",
                nfw Objfdt[] {rflbtionId, rflbtionTypfNbmf, rolfList});

        // Crfbtfs RflbtionSupport objfdt
        // Cbn tirow InvblidRolfVblufExdfption
        RflbtionSupport rflObj = nfw RflbtionSupport(rflbtionId,
                                               myObjNbmf,
                                               rflbtionTypfNbmf,
                                               rolfList);

        // Adds rflbtion objfdt bs b rflbtion into tif Rflbtion Sfrvidf
        // Cbn tirow RolfNotFoundExdfption, InvblidRflbtionId,
        // RflbtionTypfNotFoundExdfption, InvblidRolfVblufExdfption
        //
        // Cbnnot tirow MBfbnExdfption
        bddRflbtionInt(truf,
                       rflObj,
                       null,
                       rflbtionId,
                       rflbtionTypfNbmf,
                       rolfList);
        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "drfbtfRflbtion");
        rfturn;
    }

    /**
     * Adds bn MBfbn drfbtfd by tif usfr (bnd rfgistfrfd by iim in tif MBfbn
     * Sfrvfr) bs b rflbtion in tif Rflbtion Sfrvidf.
     * <P>To bf bddfd bs b rflbtion, tif MBfbn must donform to tif
     * following:
     * <P>- implfmfnt tif Rflbtion intfrfbdf
     * <P>- ibvf for RflbtionSfrvidf ObjfdtNbmf tif ObjfdtNbmf of durrfnt
     * Rflbtion Sfrvidf
     * <P>- ibvf b rflbtion id uniquf bnd unusfd in durrfnt Rflbtion Sfrvidf
     * <P>- ibvf for rflbtion typf b rflbtion typf drfbtfd in tif Rflbtion
     * Sfrvidf
     * <P>- ibvf rolfs donforming to tif rolf info providfd in tif rflbtion
     * typf.
     *
     * @pbrbm rflbtionObjfdtNbmf  ObjfdtNbmf of tif rflbtion MBfbn to bf bddfd.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption NoSudiMftiodExdfption  If tif MBfbn dofs not implfmfnt tif
     * Rflbtion intfrfbdf
     * @fxdfption InvblidRflbtionIdExdfption  if:
     * <P>- no rflbtion idfntififr in MBfbn
     * <P>- tif rflbtion idfntififr is blrfbdy usfd in tif Rflbtion Sfrvidf
     * @fxdfption InstbndfNotFoundExdfption  if tif MBfbn for givfn ObjfdtNbmf
     * ibs not bffn rfgistfrfd
     * @fxdfption InvblidRflbtionSfrvidfExdfption  if:
     * <P>- no Rflbtion Sfrvidf nbmf in MBfbn
     * <P>- tif Rflbtion Sfrvidf nbmf in tif MBfbn is not tif onf of tif
     * durrfnt Rflbtion Sfrvidf
     * @fxdfption RflbtionTypfNotFoundExdfption  if:
     * <P>- no rflbtion typf nbmf in MBfbn
     * <P>- tif rflbtion typf nbmf in MBfbn dofs not dorrfspond to b rflbtion
     * typf drfbtfd in tif Rflbtion Sfrvidf
     * @fxdfption InvblidRolfVblufExdfption  if:
     * <P>- tif numbfr of rfffrfndfd MBfbns in b rolf is lfss tibn
     * fxpfdtfd minimum dfgrff
     * <P>- tif numbfr of rfffrfndfd MBfbns in b rolf fxdffds fxpfdtfd
     * mbximum dfgrff
     * <P>- onf rfffrfndfd MBfbn in tif vbluf is not bn Objfdt of tif MBfbn
     * dlbss fxpfdtfd for tibt rolf
     * <P>- bn MBfbn providfd for b rolf dofs not fxist
     * @fxdfption RolfNotFoundExdfption  if b vbluf is providfd for b rolf
     * tibt dofs not fxist in tif rflbtion typf
     */
    publid void bddRflbtion(ObjfdtNbmf rflbtionObjfdtNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption,
               NoSudiMftiodExdfption,
               InvblidRflbtionIdExdfption,
               InstbndfNotFoundExdfption,
               InvblidRflbtionSfrvidfExdfption,
               RflbtionTypfNotFoundExdfption,
               RolfNotFoundExdfption,
               InvblidRolfVblufExdfption {

        if (rflbtionObjfdtNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtion", rflbtionObjfdtNbmf);

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cifdks tibt tif rflbtion MBfbn implfmfnts tif Rflbtion intfrfbdf.
        // It will blso difdk tibt tif providfd ObjfdtNbmf dorrfsponds to b
        // rfgistfrfd MBfbn (flsf will tirow bn InstbndfNotFoundExdfption)
        if ((!(myMBfbnSfrvfr.isInstbndfOf(rflbtionObjfdtNbmf, "jbvbx.mbnbgfmfnt.rflbtion.Rflbtion")))) {
            String fxdMsg = "Tiis MBfbn dofs not implfmfnt tif Rflbtion intfrfbdf.";
            tirow nfw NoSudiMftiodExdfption(fxdMsg);
        }
        // Cifdks tifrf is b rflbtion id in tif rflbtion MBfbn (its uniqufnfss
        // is difdkfd in bddRflbtionInt())
        // Cbn tirow InstbndfNotFoundExdfption (but dftfdtfd bbovf)
        // No MBfbnExdfption bs no fxdfption rbisfd by tiis mftiod, bnd no
        // RfflfdtionExdfption
        String rflId;
        try {
            rflId = (String)(myMBfbnSfrvfr.gftAttributf(rflbtionObjfdtNbmf,
                                                        "RflbtionId"));

        } dbtdi (MBfbnExdfption fxd1) {
            tirow nfw RuntimfExdfption(
                                     (fxd1.gftTbrgftExdfption()).gftMfssbgf());
        } dbtdi (RfflfdtionExdfption fxd2) {
            tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
        } dbtdi (AttributfNotFoundExdfption fxd3) {
            tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
        }

        if (rflId == null) {
            String fxdMsg = "Tiis MBfbn dofs not providf b rflbtion id.";
            tirow nfw InvblidRflbtionIdExdfption(fxdMsg);
        }
        // Cifdks tibt tif Rflbtion Sfrvidf wifrf tif rflbtion MBfbn is
        // fxpfdtfd to bf bddfd is tif durrfnt onf
        // Cbn tirow InstbndfNotFoundExdfption (but dftfdtfd bbovf)
        // No MBfbnExdfption bs no fxdfption rbisfd by tiis mftiod, no
        // RfflfdtionExdfption
        ObjfdtNbmf rflSfrvObjNbmf;
        try {
            rflSfrvObjNbmf = (ObjfdtNbmf)
                (myMBfbnSfrvfr.gftAttributf(rflbtionObjfdtNbmf,
                                            "RflbtionSfrvidfNbmf"));

        } dbtdi (MBfbnExdfption fxd1) {
            tirow nfw RuntimfExdfption(
                                     (fxd1.gftTbrgftExdfption()).gftMfssbgf());
        } dbtdi (RfflfdtionExdfption fxd2) {
            tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
        } dbtdi (AttributfNotFoundExdfption fxd3) {
            tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
        }

        boolfbn bbdRflSfrvFlbg = fblsf;
        if (rflSfrvObjNbmf == null) {
            bbdRflSfrvFlbg = truf;

        } flsf if (!(rflSfrvObjNbmf.fqubls(myObjNbmf))) {
            bbdRflSfrvFlbg = truf;
        }
        if (bbdRflSfrvFlbg) {
            String fxdMsg = "Tif Rflbtion Sfrvidf rfffrfndfd in tif MBfbn is not tif durrfnt onf.";
            tirow nfw InvblidRflbtionSfrvidfExdfption(fxdMsg);
        }
        // Cifdks tibt b rflbtion typf ibs bffn spfdififd for tif rflbtion
        // Cbn tirow InstbndfNotFoundExdfption (but dftfdtfd bbovf)
        // No MBfbnExdfption bs no fxdfption rbisfd by tiis mftiod, no
        // RfflfdtionExdfption
        String rflTypfNbmf;
        try {
            rflTypfNbmf = (String)(myMBfbnSfrvfr.gftAttributf(rflbtionObjfdtNbmf,
                                                              "RflbtionTypfNbmf"));

        } dbtdi (MBfbnExdfption fxd1) {
            tirow nfw RuntimfExdfption(
                                     (fxd1.gftTbrgftExdfption()).gftMfssbgf());
        }dbtdi (RfflfdtionExdfption fxd2) {
            tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
        } dbtdi (AttributfNotFoundExdfption fxd3) {
            tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
        }
        if (rflTypfNbmf == null) {
            String fxdMsg = "No rflbtion typf providfd.";
            tirow nfw RflbtionTypfNotFoundExdfption(fxdMsg);
        }
        // Rftrifvfs bll rolfs witiout donsidfring rfbd modf
        // Cbn tirow InstbndfNotFoundExdfption (but dftfdtfd bbovf)
        // No MBfbnExdfption bs no fxdfption rbisfd by tiis mftiod, no
        // RfflfdtionExdfption
        RolfList rolfList;
        try {
            rolfList = (RolfList)(myMBfbnSfrvfr.invokf(rflbtionObjfdtNbmf,
                                                       "rftrifvfAllRolfs",
                                                       null,
                                                       null));
        } dbtdi (MBfbnExdfption fxd1) {
            tirow nfw RuntimfExdfption(
                                     (fxd1.gftTbrgftExdfption()).gftMfssbgf());
        } dbtdi (RfflfdtionExdfption fxd2) {
            tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
        }

        // Cbn tirow RolfNotFoundExdfption, InvblidRflbtionIdExdfption,
        // RflbtionTypfNotFoundExdfption, InvblidRolfVblufExdfption
        bddRflbtionInt(fblsf,
                       null,
                       rflbtionObjfdtNbmf,
                       rflId,
                       rflTypfNbmf,
                       rolfList);
        // Adds rflbtion MBfbn ObjfdtNbmf in mbp
        syndironizfd(myRflMBfbnObjNbmf2RflIdMbp) {
            myRflMBfbnObjNbmf2RflIdMbp.put(rflbtionObjfdtNbmf, rflId);
        }

        // Updbtfs flbg to spfdify tibt tif rflbtion is mbnbgfd by tif Rflbtion
        // Sfrvidf
        // Tiis flbg bnd sfttfr brf inifritfd from RflbtionSupport bnd not pbrts
        // of tif Rflbtion intfrfbdf, so mby bf not supportfd.
        try {
            myMBfbnSfrvfr.sftAttributf(rflbtionObjfdtNbmf,
                                       nfw Attributf(
                                         "RflbtionSfrvidfMbnbgfmfntFlbg",
                                         Boolfbn.TRUE));
        } dbtdi (Exdfption fxd) {
            // OK : Tif flbg is not supportfd.
        }

        // Updbtfs listfnfr informbtion to rfdfivfd notifidbtion for
        // unrfgistrbtion of tiis MBfbn
        List<ObjfdtNbmf> nfwRffList = nfw ArrbyList<ObjfdtNbmf>();
        nfwRffList.bdd(rflbtionObjfdtNbmf);
        updbtfUnrfgistrbtionListfnfr(nfwRffList, null);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtion");
        rfturn;
    }

    /**
     * If tif rflbtion is rfprfsfntfd by bn MBfbn (drfbtfd by tif usfr bnd
     * bddfd bs b rflbtion in tif Rflbtion Sfrvidf), rfturns tif ObjfdtNbmf of
     * tif MBfbn.
     *
     * @pbrbm rflbtionId  rflbtion id idfntifying tif rflbtion
     *
     * @rfturn ObjfdtNbmf of tif dorrfsponding rflbtion MBfbn, or null if
     * tif rflbtion is not bn MBfbn.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption tifrf is no rflbtion bssodibtfd
     * to tibt id
     */
    publid ObjfdtNbmf isRflbtionMBfbn(String rflbtionId)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption{

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "isRflbtionMBfbn", rflbtionId);

        // Cbn tirow RflbtionNotFoundExdfption
        Objfdt rfsult = gftRflbtion(rflbtionId);
        if (rfsult instbndfof ObjfdtNbmf) {
            rfturn ((ObjfdtNbmf)rfsult);
        } flsf {
            rfturn null;
        }
    }

    /**
     * Rfturns tif rflbtion id bssodibtfd to tif givfn ObjfdtNbmf if tif
     * MBfbn ibs bffn bddfd bs b rflbtion in tif Rflbtion Sfrvidf.
     *
     * @pbrbm objfdtNbmf  ObjfdtNbmf of supposfd rflbtion
     *
     * @rfturn rflbtion id (String) or null (if tif ObjfdtNbmf is not b
     * rflbtion ibndlfd by tif Rflbtion Sfrvidf)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid String isRflbtion(ObjfdtNbmf objfdtNbmf)
        tirows IllfgblArgumfntExdfption {

        if (objfdtNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "isRflbtion", objfdtNbmf);

        String rfsult = null;
        syndironizfd(myRflMBfbnObjNbmf2RflIdMbp) {
            String rflId = myRflMBfbnObjNbmf2RflIdMbp.gft(objfdtNbmf);
            if (rflId != null) {
                rfsult = rflId;
            }
        }
        rfturn rfsult;
    }

    /**
     * Cifdks if tifrf is b rflbtion idfntififd in Rflbtion Sfrvidf witi givfn
     * rflbtion id.
     *
     * @pbrbm rflbtionId  rflbtion id idfntifying tif rflbtion
     *
     * @rfturn boolfbn: truf if tifrf is b rflbtion, fblsf flsf
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid Boolfbn ibsRflbtion(String rflbtionId)
        tirows IllfgblArgumfntExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "ibsRflbtion", rflbtionId);

        try {
            // Cbn tirow RflbtionNotFoundExdfption
            Objfdt rfsult = gftRflbtion(rflbtionId);
            rfturn truf;
        } dbtdi (RflbtionNotFoundExdfption fxd) {
            rfturn fblsf;
        }
    }

    /**
     * Rfturns bll tif rflbtion ids for bll tif rflbtions ibndlfd by tif
     * Rflbtion Sfrvidf.
     *
     * @rfturn ArrbyList of String
     */
    publid List<String> gftAllRflbtionIds() {
        List<String> rfsult;
        syndironizfd(myRflId2ObjMbp) {
            rfsult = nfw ArrbyList<String>(myRflId2ObjMbp.kfySft());
        }
        rfturn rfsult;
    }

    /**
     * Cifdks if givfn Rolf dbn bf rfbd in b rflbtion of tif givfn typf.
     *
     * @pbrbm rolfNbmf  nbmf of rolf to bf difdkfd
     * @pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf
     *
     * @rfturn bn Intfgfr wrbpping bn intfgfr dorrfsponding to possiblf
     * problfms rfprfsfntfd bs donstbnts in RolfUnrfsolvfd:
     * <P>- 0 if rolf dbn bf rfbd
     * <P>- intfgfr dorrfsponding to RolfStbtus.NO_ROLE_WITH_NAME
     * <P>- intfgfr dorrfsponding to RolfStbtus.ROLE_NOT_READABLE
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  if tif rflbtion typf is not
     * known in tif Rflbtion Sfrvidf
     */
    publid Intfgfr difdkRolfRfbding(String rolfNbmf,
                                    String rflbtionTypfNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        if (rolfNbmf == null || rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfRfbding", nfw Objfdt[] {rolfNbmf, rflbtionTypfNbmf});

        Intfgfr rfsult;

        // Cbn tirow b RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        try {
            // Cbn tirow b RolfInfoNotFoundExdfption to bf trbnsformfd into
            // rfturnfd vbluf RolfStbtus.NO_ROLE_WITH_NAME
            RolfInfo rolfInfo = rflTypf.gftRolfInfo(rolfNbmf);

            rfsult =  difdkRolfInt(1,
                                   rolfNbmf,
                                   null,
                                   rolfInfo,
                                   fblsf);

        } dbtdi (RolfInfoNotFoundExdfption fxd) {
            rfsult = Intfgfr.vblufOf(RolfStbtus.NO_ROLE_WITH_NAME);
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfRfbding");
        rfturn rfsult;
    }

    /**
     * Cifdks if givfn Rolf dbn bf sft in b rflbtion of givfn typf.
     *
     * @pbrbm rolf  rolf to bf difdkfd
     * @pbrbm rflbtionTypfNbmf  nbmf of rflbtion typf
     * @pbrbm initFlbg  flbg to spfdify tibt tif difdking is donf for tif
     * initiblizbtion of b rolf, writf bddfss sibll not bf vfrififd.
     *
     * @rfturn bn Intfgfr wrbpping bn intfgfr dorrfsponding to possiblf
     * problfms rfprfsfntfd bs donstbnts in RolfUnrfsolvfd:
     * <P>- 0 if rolf dbn bf sft
     * <P>- intfgfr dorrfsponding to RolfStbtus.NO_ROLE_WITH_NAME
     * <P>- intfgfr for RolfStbtus.ROLE_NOT_WRITABLE
     * <P>- intfgfr for RolfStbtus.LESS_THAN_MIN_ROLE_DEGREE
     * <P>- intfgfr for RolfStbtus.MORE_THAN_MAX_ROLE_DEGREE
     * <P>- intfgfr for RolfStbtus.REF_MBEAN_OF_INCORRECT_CLASS
     * <P>- intfgfr for RolfStbtus.REF_MBEAN_NOT_REGISTERED
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  if unknown rflbtion typf
     */
    publid Intfgfr difdkRolfWriting(Rolf rolf,
                                    String rflbtionTypfNbmf,
                                    Boolfbn initFlbg)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        if (rolf == null ||
            rflbtionTypfNbmf == null ||
            initFlbg == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfWriting",
                nfw Objfdt[] {rolf, rflbtionTypfNbmf, initFlbg});

        // Cbn tirow b RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        String rolfNbmf = rolf.gftRolfNbmf();
        List<ObjfdtNbmf> rolfVbluf = rolf.gftRolfVbluf();
        boolfbn writfCikFlbg = truf;
        if (initFlbg.boolfbnVbluf()) {
            writfCikFlbg = fblsf;
        }

        RolfInfo rolfInfo;
        try {
            rolfInfo = rflTypf.gftRolfInfo(rolfNbmf);
        } dbtdi (RolfInfoNotFoundExdfption fxd) {
            RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                    "difdkRolfWriting");
            rfturn Intfgfr.vblufOf(RolfStbtus.NO_ROLE_WITH_NAME);
        }

        Intfgfr rfsult = difdkRolfInt(2,
                                      rolfNbmf,
                                      rolfVbluf,
                                      rolfInfo,
                                      writfCikFlbg);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfWriting");
        rfturn rfsult;
    }

    /**
     * Sfnds b notifidbtion (RflbtionNotifidbtion) for b rflbtion drfbtion.
     * Tif notifidbtion typf is:
     * <P>- RflbtionNotifidbtion.RELATION_BASIC_CREATION if tif rflbtion is bn
     * objfdt intfrnbl to tif Rflbtion Sfrvidf
     * <P>- RflbtionNotifidbtion.RELATION_MBEAN_CREATION if tif rflbtion is b
     * MBfbn bddfd bs b rflbtion.
     * <P>Tif sourdf objfdt is tif Rflbtion Sfrvidf itsflf.
     * <P>It is dbllfd in Rflbtion Sfrvidf drfbtfRflbtion() bnd
     * bddRflbtion() mftiods.
     *
     * @pbrbm rflbtionId  rflbtion idfntififr of tif updbtfd rflbtion
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if tifrf is no rflbtion for givfn
     * rflbtion id
     */
    publid void sfndRflbtionCrfbtionNotifidbtion(String rflbtionId)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRflbtionCrfbtionNotifidbtion", rflbtionId);

        // Mfssbgf
        StringBuildfr ntfMsg = nfw StringBuildfr("Crfbtion of rflbtion ");
        ntfMsg.bppfnd(rflbtionId);

        // Cbn tirow RflbtionNotFoundExdfption
        sfndNotifidbtionInt(1,
                            ntfMsg.toString(),
                            rflbtionId,
                            null,
                            null,
                            null,
                            null);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRflbtionCrfbtionNotifidbtion");
        rfturn;
    }

    /**
     * Sfnds b notifidbtion (RflbtionNotifidbtion) for b rolf updbtf in tif
     * givfn rflbtion. Tif notifidbtion typf is:
     * <P>- RflbtionNotifidbtion.RELATION_BASIC_UPDATE if tif rflbtion is bn
     * objfdt intfrnbl to tif Rflbtion Sfrvidf
     * <P>- RflbtionNotifidbtion.RELATION_MBEAN_UPDATE if tif rflbtion is b
     * MBfbn bddfd bs b rflbtion.
     * <P>Tif sourdf objfdt is tif Rflbtion Sfrvidf itsflf.
     * <P>It is dbllfd in rflbtion MBfbn sftRolf() (for givfn rolf) bnd
     * sftRolfs() (for fbdi rolf) mftiods (implfmfntbtion providfd in
     * RflbtionSupport dlbss).
     * <P>It is blso dbllfd in Rflbtion Sfrvidf sftRolf() (for givfn rolf) bnd
     * sftRolfs() (for fbdi rolf) mftiods.
     *
     * @pbrbm rflbtionId  rflbtion idfntififr of tif updbtfd rflbtion
     * @pbrbm nfwRolf  nfw rolf (nbmf bnd nfw vbluf)
     * @pbrbm oldVbluf  old rolf vbluf (List of ObjfdtNbmf objfdts)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if tifrf is no rflbtion for givfn
     * rflbtion id
     */
    publid void sfndRolfUpdbtfNotifidbtion(String rflbtionId,
                                           Rolf nfwRolf,
                                           List<ObjfdtNbmf> oldVbluf)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null ||
            nfwRolf == null ||
            oldVbluf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        if (!(oldVbluf instbndfof ArrbyList<?>))
            oldVbluf = nfw ArrbyList<ObjfdtNbmf>(oldVbluf);

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRolfUpdbtfNotifidbtion",
                nfw Objfdt[] {rflbtionId, nfwRolf, oldVbluf});

        String rolfNbmf = nfwRolf.gftRolfNbmf();
        List<ObjfdtNbmf> nfwRolfVbl = nfwRolf.gftRolfVbluf();

        // Mfssbgf
        String nfwRolfVblString = Rolf.rolfVblufToString(nfwRolfVbl);
        String oldRolfVblString = Rolf.rolfVblufToString(oldVbluf);
        StringBuildfr ntfMsg = nfw StringBuildfr("Vbluf of rolf ");
        ntfMsg.bppfnd(rolfNbmf);
        ntfMsg.bppfnd(" ibs dibngfd\nOld vbluf:\n");
        ntfMsg.bppfnd(oldRolfVblString);
        ntfMsg.bppfnd("\nNfw vbluf:\n");
        ntfMsg.bppfnd(nfwRolfVblString);

        // Cbn tirow b RflbtionNotFoundExdfption
        sfndNotifidbtionInt(2,
                            ntfMsg.toString(),
                            rflbtionId,
                            null,
                            rolfNbmf,
                            nfwRolfVbl,
                            oldVbluf);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRolfUpdbtfNotifidbtion");
    }

    /**
     * Sfnds b notifidbtion (RflbtionNotifidbtion) for b rflbtion rfmovbl.
     * Tif notifidbtion typf is:
     * <P>- RflbtionNotifidbtion.RELATION_BASIC_REMOVAL if tif rflbtion is bn
     * objfdt intfrnbl to tif Rflbtion Sfrvidf
     * <P>- RflbtionNotifidbtion.RELATION_MBEAN_REMOVAL if tif rflbtion is b
     * MBfbn bddfd bs b rflbtion.
     * <P>Tif sourdf objfdt is tif Rflbtion Sfrvidf itsflf.
     * <P>It is dbllfd in Rflbtion Sfrvidf rfmovfRflbtion() mftiod.
     *
     * @pbrbm rflbtionId  rflbtion idfntififr of tif updbtfd rflbtion
     * @pbrbm unrfgMBfbnList  List of ObjfdtNbmfs of MBfbns fxpfdtfd
     * to bf unrfgistfrfd duf to rflbtion rfmovbl (dbn bf null)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if tifrf is no rflbtion for givfn
     * rflbtion id
     */
    publid void sfndRflbtionRfmovblNotifidbtion(String rflbtionId,
                                                List<ObjfdtNbmf> unrfgMBfbnList)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRflbtionRfmovblNotifidbtion",
                nfw Objfdt[] {rflbtionId, unrfgMBfbnList});

        // Cbn tirow RflbtionNotFoundExdfption
        sfndNotifidbtionInt(3,
                            "Rfmovbl of rflbtion " + rflbtionId,
                            rflbtionId,
                            unrfgMBfbnList,
                            null,
                            null,
                            null);


        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndRflbtionRfmovblNotifidbtion");
        rfturn;
    }

    /**
     * Hbndlfs updbtf of tif Rflbtion Sfrvidf rolf mbp for tif updbtf of givfn
     * rolf in givfn rflbtion.
     * <P>It is dbllfd in rflbtion MBfbn sftRolf() (for givfn rolf) bnd
     * sftRolfs() (for fbdi rolf) mftiods (implfmfntbtion providfd in
     * RflbtionSupport dlbss).
     * <P>It is blso dbllfd in Rflbtion Sfrvidf sftRolf() (for givfn rolf) bnd
     * sftRolfs() (for fbdi rolf) mftiods.
     * <P>To bllow tif Rflbtion Sfrvidf to mbintbin tif donsistfndy (in dbsf
     * of MBfbn unrfgistrbtion) bnd to bf bblf to pfrform qufrifs, tiis mftiod
     * must bf dbllfd wifn b rolf is updbtfd.
     *
     * @pbrbm rflbtionId  rflbtion idfntififr of tif updbtfd rflbtion
     * @pbrbm nfwRolf  nfw rolf (nbmf bnd nfw vbluf)
     * @pbrbm oldVbluf  old rolf vbluf (List of ObjfdtNbmf objfdts)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion for givfn id.
     */
    publid void updbtfRolfMbp(String rflbtionId,
                              Rolf nfwRolf,
                              List<ObjfdtNbmf> oldVbluf)
        tirows IllfgblArgumfntExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null ||
            nfwRolf == null ||
            oldVbluf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "updbtfRolfMbp", nfw Objfdt[] {rflbtionId, nfwRolf, oldVbluf});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Vfrififs tif rflbtion ibs bffn bddfd in tif Rflbtion Sfrvidf
        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rfsult = gftRflbtion(rflbtionId);

        String rolfNbmf = nfwRolf.gftRolfNbmf();
        List<ObjfdtNbmf> nfwRolfVbluf = nfwRolf.gftRolfVbluf();
        // Notf: no nffd to tfst if oldVbluf not null bfforf dloning,
        //       tfstfd bbovf.
        List<ObjfdtNbmf> oldRolfVbluf =
            nfw ArrbyList<ObjfdtNbmf>(oldVbluf);

        // List of ObjfdtNbmfs of nfw rfffrfndfd MBfbns
        List<ObjfdtNbmf> nfwRffList = nfw ArrbyList<ObjfdtNbmf>();

        for (ObjfdtNbmf durrObjNbmf : nfwRolfVbluf) {

            // Cifdks if tiis ObjfdtNbmf wbs blrfbdy prfsfnt in old vbluf
            // Notf: usf dopy (oldRolfVbluf) instfbd of originbl
            //       oldVbluf to spffd up, bs oldRolfVbluf is dfdrfbsfd
            //       by rfmoving undibngfd rfffrfndfs :)
            int durrObjNbmfPos = oldRolfVbluf.indfxOf(durrObjNbmf);

            if (durrObjNbmfPos == -1) {
                // Nfw rfffrfndf to bn ObjfdtNbmf

                // Storfs tiis rfffrfndf into mbp
                // Rfturns truf if nfw rfffrfndf, fblsf if MBfbn blrfbdy
                // rfffrfndfd
                boolfbn isNfwFlbg = bddNfwMBfbnRfffrfndf(durrObjNbmf,
                                                        rflbtionId,
                                                        rolfNbmf);

                if (isNfwFlbg) {
                    // Adds it into list of nfw rfffrfndf
                    nfwRffList.bdd(durrObjNbmf);
                }

            } flsf {
                // MBfbn wbs blrfbdy rfffrfndfd in old vbluf

                // Rfmovfs it from old vbluf (lodbl list) to ignorf it wifn
                // looking for rfmovf MBfbn rfffrfndfs
                oldRolfVbluf.rfmovf(durrObjNbmfPos);
            }
        }

        // List of ObjfdtNbmfs of MBfbns no longfr rfffrfndfd
        List<ObjfdtNbmf> obsRffList = nfw ArrbyList<ObjfdtNbmf>();

        // Ebdi ObjfdtNbmf rfmbining in oldRolfVbluf is bn ObjfdtNbmf no longfr
        // rfffrfndfd in nfw vbluf
        for (ObjfdtNbmf durrObjNbmf : oldRolfVbluf) {
            // Rfmovfs MBfbn rfffrfndf from mbp
            // Rfturns truf if tif MBfbn is no longfr rfffrfndfd in bny
            // rflbtion
            boolfbn noLongfrRffFlbg = rfmovfMBfbnRfffrfndf(durrObjNbmf,
                                                          rflbtionId,
                                                          rolfNbmf,
                                                          fblsf);

            if (noLongfrRffFlbg) {
                // Adds it into list of rfffrfndfs to bf rfmovfd
                obsRffList.bdd(durrObjNbmf);
            }
        }

        // To bvoid ibving onf listfnfr pfr ObjfdtNbmf of rfffrfndfd MBfbn,
        // bnd to indrfbsf pfrformbndfs, tifrf is only onf listfnfr rfdording
        // bll ObjfdtNbmfs of intfrfst
        updbtfUnrfgistrbtionListfnfr(nfwRffList, obsRffList);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "updbtfRolfMbp");
        rfturn;
    }

    /**
     * Rfmovfs givfn rflbtion from tif Rflbtion Sfrvidf.
     * <P>A RflbtionNotifidbtion notifidbtion is sfnt, its typf bfing:
     * <P>- RflbtionNotifidbtion.RELATION_BASIC_REMOVAL if tif rflbtion wbs
     * only intfrnbl to tif Rflbtion Sfrvidf
     * <P>- RflbtionNotifidbtion.RELATION_MBEAN_REMOVAL if tif rflbtion is
     * rfgistfrfd bs bn MBfbn.
     * <P>For MBfbns rfffrfndfd in sudi rflbtion, notiing will bf donf,
     *
     * @pbrbm rflbtionId  rflbtion id of tif rflbtion to bf rfmovfd
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion dorrfsponding to
     * givfn rflbtion id
     */
    publid void rfmovfRflbtion(String rflbtionId)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfRflbtion", rflbtionId);

        // Cifdks tifrf is b rflbtion witi tiis id
        // Cbn tirow RflbtionNotFoundExdfption
        Objfdt rfsult = gftRflbtion(rflbtionId);

        // Rfmovfs it from listfnfr filtfr
        if (rfsult instbndfof ObjfdtNbmf) {
            List<ObjfdtNbmf> obsRffList = nfw ArrbyList<ObjfdtNbmf>();
            obsRffList.bdd((ObjfdtNbmf)rfsult);
            // Cbn tirow b RflbtionSfrvidfNotRfgistfrfdExdfption
            updbtfUnrfgistrbtionListfnfr(null, obsRffList);
        }

        // Sfnds b notifidbtion
        // Notf: ibs to bf donf FIRST bs nffds tif rflbtion to bf still in tif
        //       Rflbtion Sfrvidf
        // No RflbtionNotFoundExdfption bs difdkfd bbovf

        // Rfvisit [dfbro] Hbndlf CIM "Dflftf" bnd "IfDflftfd" qublififrs:
        //   dflfting tif rflbtion dbn mfbn to dflftf rfffrfndfd MBfbns. In
        //   tibt dbsf, MBfbns to bf unrfgistfrfd brf put in b list sfnt blong
        //   witi tif notifidbtion bflow

        // Cbn tirow b RflbtionNotFoundExdfption (but dftfdtfd bbovf)
        sfndRflbtionRfmovblNotifidbtion(rflbtionId, null);

        // Rfmovfs tif rflbtion from vbrious intfrnbl mbps

        //  - MBfbn rfffrfndf mbp
        // Rftrifvfs tif MBfbns rfffrfndfd in tiis rflbtion
        // Notf: ifrf wf dbnnot usf rfmovfMBfbnRfffrfndf() bfdbusf it would
        //       rfquirf to know tif MBfbns rfffrfndfd in tif rflbtion. For
        //       tibt it would bf nfdfssbry to dbll 'gftRfffrfndfdMBfbns()'
        //       on tif rflbtion itsflf. Ok if it is bn intfrnbl onf, but if
        //       it is bn MBfbn, it is possiblf it is blrfbdy unrfgistfrfd, so
        //       not bvbilbblf tirougi tif MBfbn Sfrvfr.
        List<ObjfdtNbmf> rffMBfbnList = nfw ArrbyList<ObjfdtNbmf>();
        // List of MBfbns no longfr rfffrfndfd in bny rflbtion, to bf
        // rfmovfd fom tif mbp
        List<ObjfdtNbmf> nonRffObjNbmfList = nfw ArrbyList<ObjfdtNbmf>();

        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {

            for (ObjfdtNbmf durrRffObjNbmf :
                     myRfffdMBfbnObjNbmf2RflIdsMbp.kfySft()) {

                // Rftrifvfs rflbtions wifrf tif MBfbn is rfffrfndfd
                Mbp<String,List<String>> rflIdMbp =
                    myRfffdMBfbnObjNbmf2RflIdsMbp.gft(durrRffObjNbmf);

                if (rflIdMbp.dontbinsKfy(rflbtionId)) {
                    rflIdMbp.rfmovf(rflbtionId);
                    rffMBfbnList.bdd(durrRffObjNbmf);
                }

                if (rflIdMbp.isEmpty()) {
                    // MBfbn no longfr rfffrfndfd
                    // Notf: do not rfmovf it ifrf bfdbusf pointfd by tif
                    //       itfrbtor!
                    nonRffObjNbmfList.bdd(durrRffObjNbmf);
                }
            }

            // Clfbns MBfbn rfffrfndf mbp by rfmoving MBfbns no longfr
            // rfffrfndfd
            for (ObjfdtNbmf durrRffObjNbmf : nonRffObjNbmfList) {
                myRfffdMBfbnObjNbmf2RflIdsMbp.rfmovf(durrRffObjNbmf);
            }
        }

        // - Rflbtion id to objfdt mbp
        syndironizfd(myRflId2ObjMbp) {
            myRflId2ObjMbp.rfmovf(rflbtionId);
        }

        if (rfsult instbndfof ObjfdtNbmf) {
            // - ObjfdtNbmf to rflbtion id mbp
            syndironizfd(myRflMBfbnObjNbmf2RflIdMbp) {
                myRflMBfbnObjNbmf2RflIdMbp.rfmovf((ObjfdtNbmf)rfsult);
            }
        }

        // Rflbtion id to rflbtion typf nbmf mbp
        // First rftrifvfs tif rflbtion typf nbmf
        String rflTypfNbmf;
        syndironizfd(myRflId2RflTypfMbp) {
            rflTypfNbmf = myRflId2RflTypfMbp.gft(rflbtionId);
            myRflId2RflTypfMbp.rfmovf(rflbtionId);
        }
        // - Rflbtion typf nbmf to rflbtion id mbp
        syndironizfd(myRflTypf2RflIdsMbp) {
            List<String> rflIdList = myRflTypf2RflIdsMbp.gft(rflTypfNbmf);
            if (rflIdList != null) {
                // Cbn bf null if dbllfd from rfmovfRflbtionTypf()
                rflIdList.rfmovf(rflbtionId);
                if (rflIdList.isEmpty()) {
                    // No otifr rflbtion of tibt typf
                    myRflTypf2RflIdsMbp.rfmovf(rflTypfNbmf);
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfRflbtion");
        rfturn;
    }

    /**
     * Purgfs tif rflbtions.
     *
     * <P>Dfpfnding on tif purgfFlbg vbluf, tiis mftiod is fitifr dbllfd
     * butombtidblly wifn b notifidbtion is rfdfivfd for tif unrfgistrbtion of
     * bn MBfbn rfffrfndfd in b rflbtion (if tif flbg is sft to truf), or not
     * (if tif flbg is sft to fblsf).
     * <P>In tibt dbsf it is up to tif usfr to dbll it to mbintbin tif
     * donsistfndy of tif rflbtions. To bf kfpt in mind tibt if bn MBfbn is
     * unrfgistfrfd bnd tif purgf not donf immfdibtfly, if tif ObjfdtNbmf is
     * rfusfd bnd bssignfd to bnotifr MBfbn rfffrfndfd in b rflbtion, dblling
     * mbnublly tiis purgfRflbtions() mftiod will dbusf troublf, bs will
     * donsidfr tif ObjfdtNbmf bs dorrfsponding to tif unrfgistfrfd MBfbn, not
     * sffing tif nfw onf.
     *
     * <P>Tif bfibvior dfpfnds on tif dbrdinblity of tif rolf wifrf tif
     * unrfgistfrfd MBfbn is rfffrfndfd:
     * <P>- if rfmoving onf MBfbn rfffrfndf in tif rolf mbkfs its numbfr of
     * rfffrfndfs lfss tibn tif minimum dfgrff, tif rflbtion ibs to bf rfmovfd.
     * <P>- if tif rfmbining numbfr of rfffrfndfs bftfr rfmoving tif MBfbn
     * rfffrfndf is still in tif dbrdinblity rbngf, kffp tif rflbtion bnd
     * updbtf it dblling its ibndlfMBfbnUnrfgistrbtion() dbllbbdk.
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr.
     */
    publid void purgfRflbtions()
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption {

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "purgfRflbtions");

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Rfvisit [dfbro] Hbndlf tif CIM "Dflftf" bnd "IfDflftfd" qublififr:
        //    if tif unrfgistfrfd MBfbn ibs tif "IfDflftfd" qublififr,
        //    possiblf tibt tif rflbtion itsflf or otifr rfffrfndfd MBfbns
        //    ibvf to bf rfmovfd (tifn b notifidbtion would ibvf to bf sfnt
        //    to inform tibt tify siould bf unrfgistfrfd.


        // Clonfs tif list of notifidbtions to bf bblf to still rfdfivf nfw
        // notifidbtions wiilf prodffding tiosf onfs
        List<MBfbnSfrvfrNotifidbtion> lodblUnrfgNtfList;
        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {
            lodblUnrfgNtfList =
                nfw ArrbyList<MBfbnSfrvfrNotifidbtion>(myUnrfgNtfList);
            // Rfsfts list
            myUnrfgNtfList = nfw ArrbyList<MBfbnSfrvfrNotifidbtion>();
        }


        // Updbtfs tif listfnfr filtfr to bvoid rfdfiving notifidbtions for
        // tiosf MBfbns bgbin
        // Mbkfs blso b lodbl "myRfffdMBfbnObjNbmf2RflIdsMbp" mbp, mbpping
        // ObjfdtNbmf -> rflId -> rolfs, to rfmovf tif MBfbn from tif globbl
        // mbp
        // List of rfffrfndfs to bf rfmovfd from tif listfnfr filtfr
        List<ObjfdtNbmf> obsRffList = nfw ArrbyList<ObjfdtNbmf>();
        // Mbp indluding ObjfdtNbmfs for unrfgistfrfd MBfbns, witi
        // rfffrfnding rflbtion ids bnd rolfs
        Mbp<ObjfdtNbmf,Mbp<String,List<String>>> lodblMBfbn2RflIdMbp =
            nfw HbsiMbp<ObjfdtNbmf,Mbp<String,List<String>>>();

        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {
            for (MBfbnSfrvfrNotifidbtion durrNtf : lodblUnrfgNtfList) {

                ObjfdtNbmf unrfgMBfbnNbmf = durrNtf.gftMBfbnNbmf();

                // Adds tif unrfgsitfrfd MBfbn in tif list of rfffrfndfs to
                // rfmovf from tif listfnfr filtfr
                obsRffList.bdd(unrfgMBfbnNbmf);

                // Rftrifvfs tif bssodibtfd mbp of rflbtion ids bnd rolfs
                Mbp<String,List<String>> rflIdMbp =
                    myRfffdMBfbnObjNbmf2RflIdsMbp.gft(unrfgMBfbnNbmf);
                lodblMBfbn2RflIdMbp.put(unrfgMBfbnNbmf, rflIdMbp);

                myRfffdMBfbnObjNbmf2RflIdsMbp.rfmovf(unrfgMBfbnNbmf);
            }
        }

        // Updbtfs tif listfnfr
        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        updbtfUnrfgistrbtionListfnfr(null, obsRffList);

        for (MBfbnSfrvfrNotifidbtion durrNtf : lodblUnrfgNtfList) {

            ObjfdtNbmf unrfgMBfbnNbmf = durrNtf.gftMBfbnNbmf();

            // Rftrifvfs tif rflbtions wifrf tif MBfbn is rfffrfndfd
            Mbp<String,List<String>> lodblRflIdMbp =
                    lodblMBfbn2RflIdMbp.gft(unrfgMBfbnNbmf);

            // List of rflbtion ids wifrf tif unrfgistfrfd MBfbn is
            // rfffrfndfd
            for (Mbp.Entry<String,List<String>> durrRfl :
                        lodblRflIdMbp.fntrySft()) {
                finbl String durrRflId = durrRfl.gftKfy();
                // List of rolfs of tif rflbtion wifrf tif MBfbn is
                // rfffrfndfd
                List<String> lodblRolfNbmfList = durrRfl.gftVbluf();

                // Cifdks if tif rflbtion ibs to bf rfmovfd or not,
                // rfgbrding fxpfdtfd minimum rolf dbrdinblity bnd durrfnt
                // numbfr of rfffrfndfs bftfr rfmovbl of tif durrfnt onf
                // If tif rflbtion is kfpt, dblls
                // ibndlfMBfbnUnrfgistrbtion() dbllbbdk of tif rflbtion to
                // updbtf it
                //
                // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
                //
                // Sibll not tirow RflbtionNotFoundExdfption,
                // RolfNotFoundExdfption, MBfbnExdfption
                try {
                    ibndlfRfffrfndfUnrfgistrbtion(durrRflId,
                                                  unrfgMBfbnNbmf,
                                                  lodblRolfNbmfList);
                } dbtdi (RflbtionNotFoundExdfption fxd1) {
                    tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
                } dbtdi (RolfNotFoundExdfption fxd2) {
                    tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "purgfRflbtions");
        rfturn;
    }

    /**
     * Rftrifvfs tif rflbtions wifrf b givfn MBfbn is rfffrfndfd.
     * <P>Tiis dorrfsponds to tif CIM "Rfffrfndfs" bnd "RfffrfndfNbmfs"
     * opfrbtions.
     *
     * @pbrbm mbfbnNbmf  ObjfdtNbmf of MBfbn
     * @pbrbm rflbtionTypfNbmf  dbn bf null; if spfdififd, only tif rflbtions
     * of tibt typf will bf donsidfrfd in tif sfbrdi. Elsf bll rflbtion typfs
     * brf donsidfrfd.
     * @pbrbm rolfNbmf  dbn bf null; if spfdififd, only tif rflbtions
     * wifrf tif MBfbn is rfffrfndfd in tibt rolf will bf rfturnfd. Elsf bll
     * rolfs brf donsidfrfd.
     *
     * @rfturn bn HbsiMbp, wifrf tif kfys brf tif rflbtion ids of tif rflbtions
     * wifrf tif MBfbn is rfffrfndfd, bnd tif vbluf is, for fbdi kfy,
     * bn ArrbyList of rolf nbmfs (bs bn MBfbn dbn bf rfffrfndfd in sfvfrbl
     * rolfs in tif sbmf rflbtion).
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid Mbp<String,List<String>>
        findRfffrfndingRflbtions(ObjfdtNbmf mbfbnNbmf,
                                 String rflbtionTypfNbmf,
                                 String rolfNbmf)
            tirows IllfgblArgumfntExdfption {

        if (mbfbnNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findRfffrfndingRflbtions",
                nfw Objfdt[] {mbfbnNbmf, rflbtionTypfNbmf, rolfNbmf});

        Mbp<String,List<String>> rfsult = nfw HbsiMbp<String,List<String>>();

        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {

            // Rftrifvfs tif rflbtions rfffrfnding tif MBfbn
            Mbp<String,List<String>> rflId2RolfNbmfsMbp =
                myRfffdMBfbnObjNbmf2RflIdsMbp.gft(mbfbnNbmf);

            if (rflId2RolfNbmfsMbp != null) {

                // Rflbtion Ids wifrf tif MBfbn is rfffrfndfd
                Sft<String> bllRflIdSft = rflId2RolfNbmfsMbp.kfySft();

                // List of rflbtion ids of intfrfst rfgbrding tif sflfdtfd
                // rflbtion typf
                List<String> rflIdList;
                if (rflbtionTypfNbmf == null) {
                    // Considfrs bll rflbtions
                    rflIdList = nfw ArrbyList<String>(bllRflIdSft);

                } flsf {

                    rflIdList = nfw ArrbyList<String>();

                    // Considfrs only tif rflbtion ids for rflbtions of givfn
                    // typf
                    for (String durrRflId : bllRflIdSft) {

                        // Rftrifvfs its rflbtion typf
                        String durrRflTypfNbmf;
                        syndironizfd(myRflId2RflTypfMbp) {
                            durrRflTypfNbmf =
                                myRflId2RflTypfMbp.gft(durrRflId);
                        }

                        if (durrRflTypfNbmf.fqubls(rflbtionTypfNbmf)) {

                            rflIdList.bdd(durrRflId);

                        }
                    }
                }

                // Now looks bt tif rolfs wifrf tif MBfbn is fxpfdtfd to bf
                // rfffrfndfd

                for (String durrRflId : rflIdList) {
                    // Rftrifvfs list of rolf nbmfs wifrf tif MBfbn is
                    // rfffrfndfd
                    List<String> durrRolfNbmfList =
                        rflId2RolfNbmfsMbp.gft(durrRflId);

                    if (rolfNbmf == null) {
                        // All rolfs to bf donsidfrfd
                        // Notf: no nffd to tfst if list not null bfforf
                        //       dloning, MUST bf not null flsf bug :(
                        rfsult.put(durrRflId,
                                   nfw ArrbyList<String>(durrRolfNbmfList));

                    }  flsf if (durrRolfNbmfList.dontbins(rolfNbmf)) {
                        // Filtfrs only tif rflbtions wifrf tif MBfbn is
                        // rfffrfndfd in // givfn rolf
                        List<String> dummyList = nfw ArrbyList<String>();
                        dummyList.bdd(rolfNbmf);
                        rfsult.put(durrRflId, dummyList);
                    }
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findRfffrfndingRflbtions");
        rfturn rfsult;
    }

    /**
     * Rftrifvfs tif MBfbns bssodibtfd to givfn onf in b rflbtion.
     * <P>Tiis dorrfsponds to CIM Assodibtors bnd AssodibtorNbmfs opfrbtions.
     *
     * @pbrbm mbfbnNbmf  ObjfdtNbmf of MBfbn
     * @pbrbm rflbtionTypfNbmf  dbn bf null; if spfdififd, only tif rflbtions
     * of tibt typf will bf donsidfrfd in tif sfbrdi. Elsf bll
     * rflbtion typfs brf donsidfrfd.
     * @pbrbm rolfNbmf  dbn bf null; if spfdififd, only tif rflbtions
     * wifrf tif MBfbn is rfffrfndfd in tibt rolf will bf donsidfrfd. Elsf bll
     * rolfs brf donsidfrfd.
     *
     * @rfturn bn HbsiMbp, wifrf tif kfys brf tif ObjfdtNbmfs of tif MBfbns
     * bssodibtfd to givfn MBfbn, bnd tif vbluf is, for fbdi kfy, bn ArrbyList
     * of tif rflbtion ids of tif rflbtions wifrf tif kfy MBfbn is
     * bssodibtfd to givfn onf (bs tify dbn bf bssodibtfd in sfvfrbl difffrfnt
     * rflbtions).
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     */
    publid Mbp<ObjfdtNbmf,List<String>>
        findAssodibtfdMBfbns(ObjfdtNbmf mbfbnNbmf,
                             String rflbtionTypfNbmf,
                             String rolfNbmf)
            tirows IllfgblArgumfntExdfption {

        if (mbfbnNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findAssodibtfdMBfbns",
                nfw Objfdt[] {mbfbnNbmf, rflbtionTypfNbmf, rolfNbmf});

        // Rftrifvfs tif mbp <rflbtion id> -> <rolf nbmfs> for tiosf
        // dritfribs
        Mbp<String,List<String>> rflId2RolfNbmfsMbp =
            findRfffrfndingRflbtions(mbfbnNbmf,
                                     rflbtionTypfNbmf,
                                     rolfNbmf);

        Mbp<ObjfdtNbmf,List<String>> rfsult =
            nfw HbsiMbp<ObjfdtNbmf,List<String>>();

        for (String durrRflId : rflId2RolfNbmfsMbp.kfySft()) {

            // Rftrifvfs ObjfdtNbmfs of MBfbns rfffrfndfd in tiis rflbtion
            //
            // Sibll not tirow b RflbtionNotFoundExdfption if indorrfdt stbtus
            // of mbps :(
            Mbp<ObjfdtNbmf,List<String>> objNbmf2RolfNbmfsMbp;
            try {
                objNbmf2RolfNbmfsMbp = gftRfffrfndfdMBfbns(durrRflId);
            } dbtdi (RflbtionNotFoundExdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }

            // For fbdi MBfbn bssodibtfd to givfn onf in b rflbtion, bdds tif
            // bssodibtion <ObjfdtNbmf> -> <rflbtion id> into rfsult mbp
            for (ObjfdtNbmf durrObjNbmf : objNbmf2RolfNbmfsMbp.kfySft()) {

                if (!(durrObjNbmf.fqubls(mbfbnNbmf))) {

                    // Sffs if tiis MBfbn is blrfbdy bssodibtfd to tif givfn
                    // onf in bnotifr rflbtion
                    List<String> durrRflIdList = rfsult.gft(durrObjNbmf);
                    if (durrRflIdList == null) {

                        durrRflIdList = nfw ArrbyList<String>();
                        durrRflIdList.bdd(durrRflId);
                        rfsult.put(durrObjNbmf, durrRflIdList);

                    } flsf {
                        durrRflIdList.bdd(durrRflId);
                    }
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findAssodibtfdMBfbns");
        rfturn rfsult;
    }

    /**
     * Rfturns tif rflbtion ids for rflbtions of tif givfn typf.
     *
     * @pbrbm rflbtionTypfNbmf  rflbtion typf nbmf
     *
     * @rfturn bn ArrbyList of rflbtion ids.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionTypfNotFoundExdfption  if tifrf is no rflbtion typf
     * witi tibt nbmf.
     */
    publid List<String> findRflbtionsOfTypf(String rflbtionTypfNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        if (rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findRflbtionsOfTypf");

        // Cbn tirow RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        List<String> rfsult;
        syndironizfd(myRflTypf2RflIdsMbp) {
            List<String> rfsult1 = myRflTypf2RflIdsMbp.gft(rflbtionTypfNbmf);
            if (rfsult1 == null)
                rfsult = nfw ArrbyList<String>();
            flsf
                rfsult = nfw ArrbyList<String>(rfsult1);
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "findRflbtionsOfTypf");
        rfturn rfsult;
    }

    /**
     * Rftrifvfs rolf vbluf for givfn rolf nbmf in givfn rflbtion.
     *
     * @pbrbm rflbtionId  rflbtion id
     * @pbrbm rolfNbmf  nbmf of rolf
     *
     * @rfturn tif ArrbyList of ObjfdtNbmf objfdts bfing tif rolf vbluf
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion witi givfn id
     * @fxdfption RolfNotFoundExdfption  if:
     * <P>- tifrf is no rolf witi givfn nbmf
     * <P>or
     * <P>- tif rolf is not rfbdbblf.
     *
     * @sff #sftRolf
     */
    publid List<ObjfdtNbmf> gftRolf(String rflbtionId,
                                    String rolfNbmf)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption,
               RolfNotFoundExdfption {

        if (rflbtionId == null || rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolf", nfw Objfdt[] {rflbtionId, rolfNbmf});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        List<ObjfdtNbmf> rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            // Cbn tirow RolfNotFoundExdfption
            rfsult = dbst(
                ((RflbtionSupport)rflObj).gftRolfInt(rolfNbmf,
                                                     truf,
                                                     tiis,
                                                     fblsf));

        } flsf {
            // Rflbtion MBfbn
            Objfdt[] pbrbms = nfw Objfdt[1];
            pbrbms[0] = rolfNbmf;
            String[] signbturf = nfw String[1];
            signbturf[0] = "jbvb.lbng.String";
            // Cbn tirow MBfbnExdfption wrbpping b RolfNotFoundExdfption:
            // tirow wrbppfd fxdfption
            //
            // Sibll not tirow InstbndfNotFoundExdfption or RfflfdtionExdfption
            try {
                List<ObjfdtNbmf> invokfRfsult = dbst(
                    myMBfbnSfrvfr.invokf(((ObjfdtNbmf)rflObj),
                                         "gftRolf",
                                         pbrbms,
                                         signbturf));
                if (invokfRfsult == null || invokfRfsult instbndfof ArrbyList<?>)
                    rfsult = invokfRfsult;
                flsf
                    rfsult = nfw ArrbyList<ObjfdtNbmf>(invokfRfsult);
            } dbtdi (InstbndfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RfflfdtionExdfption fxd2) {
                tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
            } dbtdi (MBfbnExdfption fxd3) {
                Exdfption wrbppfdExd = fxd3.gftTbrgftExdfption();
                if (wrbppfdExd instbndfof RolfNotFoundExdfption) {
                    tirow ((RolfNotFoundExdfption)wrbppfdExd);
                } flsf {
                    tirow nfw RuntimfExdfption(wrbppfdExd.gftMfssbgf());
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(), "gftRolf");
        rfturn rfsult;
    }

    /**
     * Rftrifvfs vblufs of rolfs witi givfn nbmfs in givfn rflbtion.
     *
     * @pbrbm rflbtionId  rflbtion id
     * @pbrbm rolfNbmfArrby  brrby of nbmfs of rolfs to bf rftrifvfd
     *
     * @rfturn b RolfRfsult objfdt, indluding b RolfList (for rolfs
     * suddfssfully rftrifvfd) bnd b RolfUnrfsolvfdList (for rolfs not
     * rftrifvfd).
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion witi givfn id
     *
     * @sff #sftRolfs
     */
    publid RolfRfsult gftRolfs(String rflbtionId,
                               String[] rolfNbmfArrby)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null || rolfNbmfArrby == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfs", rflbtionId);

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        RolfRfsult rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            rfsult = ((RflbtionSupport)rflObj).gftRolfsInt(rolfNbmfArrby,
                                                        truf,
                                                        tiis);
        } flsf {
            // Rflbtion MBfbn
            Objfdt[] pbrbms = nfw Objfdt[1];
            pbrbms[0] = rolfNbmfArrby;
            String[] signbturf = nfw String[1];
            try {
                signbturf[0] = (rolfNbmfArrby.gftClbss()).gftNbmf();
            } dbtdi (Exdfption fxd) {
                // OK : Tiis is bn brrby of jbvb.lbng.String
                //      so tiis siould nfvfr ibppfn...
            }
            // Sibll not tirow InstbndfNotFoundExdfption, RfflfdtionExdfption
            // or MBfbnExdfption
            try {
                rfsult = (RolfRfsult)
                    (myMBfbnSfrvfr.invokf(((ObjfdtNbmf)rflObj),
                                          "gftRolfs",
                                          pbrbms,
                                          signbturf));
            } dbtdi (InstbndfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RfflfdtionExdfption fxd2) {
                tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
            } dbtdi (MBfbnExdfption fxd3) {
                tirow nfw
                    RuntimfExdfption((fxd3.gftTbrgftExdfption()).gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(), "gftRolfs");
        rfturn rfsult;
    }

    /**
     * Rfturns bll rolfs prfsfnt in tif rflbtion.
     *
     * @pbrbm rflbtionId  rflbtion id
     *
     * @rfturn b RolfRfsult objfdt, indluding b RolfList (for rolfs
     * suddfssfully rftrifvfd) bnd b RolfUnrfsolvfdList (for rolfs not
     * rfbdbblf).
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion for givfn id
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     */
    publid RolfRfsult gftAllRolfs(String rflbtionId)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfs", rflbtionId);

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        RolfRfsult rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            rfsult = ((RflbtionSupport)rflObj).gftAllRolfsInt(truf, tiis);

        } flsf {
            // Rflbtion MBfbn
            // Sibll not tirow bny Exdfption
            try {
                rfsult = (RolfRfsult)
                    (myMBfbnSfrvfr.gftAttributf(((ObjfdtNbmf)rflObj),
                                                "AllRolfs"));
            } dbtdi (Exdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(), "gftRolfs");
        rfturn rfsult;
    }

    /**
     * Rftrifvfs tif numbfr of MBfbns durrfntly rfffrfndfd in tif givfn rolf.
     *
     * @pbrbm rflbtionId  rflbtion id
     * @pbrbm rolfNbmf  nbmf of rolf
     *
     * @rfturn tif numbfr of durrfntly rfffrfndfd MBfbns in tibt rolf
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion witi givfn id
     * @fxdfption RolfNotFoundExdfption  if tifrf is no rolf witi givfn nbmf
     */
    publid Intfgfr gftRolfCbrdinblity(String rflbtionId,
                                      String rolfNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption,
               RolfNotFoundExdfption {

        if (rflbtionId == null || rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfCbrdinblity", nfw Objfdt[] {rflbtionId, rolfNbmf});

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        Intfgfr rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            // Cbn tirow RolfNotFoundExdfption
            rfsult = ((RflbtionSupport)rflObj).gftRolfCbrdinblity(rolfNbmf);

        } flsf {
            // Rflbtion MBfbn
            Objfdt[] pbrbms = nfw Objfdt[1];
            pbrbms[0] = rolfNbmf;
            String[] signbturf = nfw String[1];
            signbturf[0] = "jbvb.lbng.String";
            // Cbn tirow MBfbnExdfption wrbpping RolfNotFoundExdfption:
            // tirow wrbppfd fxdfption
            //
            // Sibll not tirow InstbndfNotFoundExdfption or RfflfdtionExdfption
            try {
                rfsult = (Intfgfr)
                    (myMBfbnSfrvfr.invokf(((ObjfdtNbmf)rflObj),
                                          "gftRolfCbrdinblity",
                                          pbrbms,
                                          signbturf));
            } dbtdi (InstbndfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RfflfdtionExdfption fxd2) {
                tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
            } dbtdi (MBfbnExdfption fxd3) {
                Exdfption wrbppfdExd = fxd3.gftTbrgftExdfption();
                if (wrbppfdExd instbndfof RolfNotFoundExdfption) {
                    tirow ((RolfNotFoundExdfption)wrbppfdExd);
                } flsf {
                    tirow nfw RuntimfExdfption(wrbppfdExd.gftMfssbgf());
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRolfCbrdinblity");
        rfturn rfsult;
    }

    /**
     * Sfts tif givfn rolf in givfn rflbtion.
     * <P>Will difdk tif rolf bddording to its dorrfsponding rolf dffinition
     * providfd in rflbtion's rflbtion typf
     * <P>Tif Rflbtion Sfrvidf will kffp trbdk of tif dibngf to kffp tif
     * donsistfndy of rflbtions by ibndling rfffrfndfd MBfbn dfrfgistrbtions.
     *
     * @pbrbm rflbtionId  rflbtion id
     * @pbrbm rolf  rolf to bf sft (nbmf bnd nfw vbluf)
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion witi givfn id
     * @fxdfption RolfNotFoundExdfption  if tif rolf dofs not fxist or is not
     * writbblf
     * @fxdfption InvblidRolfVblufExdfption  if vbluf providfd for rolf is not
     * vblid:
     * <P>- tif numbfr of rfffrfndfd MBfbns in givfn vbluf is lfss tibn
     * fxpfdtfd minimum dfgrff
     * <P>or
     * <P>- tif numbfr of rfffrfndfd MBfbns in providfd vbluf fxdffds fxpfdtfd
     * mbximum dfgrff
     * <P>or
     * <P>- onf rfffrfndfd MBfbn in tif vbluf is not bn Objfdt of tif MBfbn
     * dlbss fxpfdtfd for tibt rolf
     * <P>or
     * <P>- bn MBfbn providfd for tibt rolf dofs not fxist
     *
     * @sff #gftRolf
     */
    publid void sftRolf(String rflbtionId,
                        Rolf rolf)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption,
               RolfNotFoundExdfption,
               InvblidRolfVblufExdfption {

        if (rflbtionId == null || rolf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sftRolf", nfw Objfdt[] {rflbtionId, rolf});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            // Cbn tirow RolfNotFoundExdfption,
            // InvblidRolfVblufExdfption bnd
            // RflbtionSfrvidfNotRfgistfrfdExdfption
            //
            // Sibll not tirow RflbtionTypfNotFoundExdfption
            // (bs rflbtion fxists in tif RS, its rflbtion typf is known)
            try {
                ((RflbtionSupport)rflObj).sftRolfInt(rolf,
                                                  truf,
                                                  tiis,
                                                  fblsf);

            } dbtdi (RflbtionTypfNotFoundExdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }

        } flsf {
            // Rflbtion MBfbn
            Objfdt[] pbrbms = nfw Objfdt[1];
            pbrbms[0] = rolf;
            String[] signbturf = nfw String[1];
            signbturf[0] = "jbvbx.mbnbgfmfnt.rflbtion.Rolf";
            // Cbn tirow MBfbnExdfption wrbpping RolfNotFoundExdfption,
            // InvblidRolfVblufExdfption
            //
            // Sibll not MBfbnExdfption wrbpping bn MBfbnExdfption wrbpping
            // RflbtionTypfNotFoundExdfption, or RfflfdtionExdfption, or
            // InstbndfNotFoundExdfption
            try {
                myMBfbnSfrvfr.sftAttributf(((ObjfdtNbmf)rflObj),
                                           nfw Attributf("Rolf", rolf));

            } dbtdi (InstbndfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RfflfdtionExdfption fxd3) {
                tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
            } dbtdi (MBfbnExdfption fxd2) {
                Exdfption wrbppfdExd = fxd2.gftTbrgftExdfption();
                if (wrbppfdExd instbndfof RolfNotFoundExdfption) {
                    tirow ((RolfNotFoundExdfption)wrbppfdExd);
                } flsf if (wrbppfdExd instbndfof InvblidRolfVblufExdfption) {
                    tirow ((InvblidRolfVblufExdfption)wrbppfdExd);
                } flsf {
                    tirow nfw RuntimfExdfption(wrbppfdExd.gftMfssbgf());

                }
            } dbtdi (AttributfNotFoundExdfption fxd4) {
              tirow nfw RuntimfExdfption(fxd4.gftMfssbgf());
            } dbtdi (InvblidAttributfVblufExdfption fxd5) {
              tirow nfw RuntimfExdfption(fxd5.gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(), "sftRolf");
        rfturn;
    }

    /**
     * Sfts tif givfn rolfs in givfn rflbtion.
     * <P>Will difdk tif rolf bddording to its dorrfsponding rolf dffinition
     * providfd in rflbtion's rflbtion typf
     * <P>Tif Rflbtion Sfrvidf kffps trbdk of tif dibngfs to kffp tif
     * donsistfndy of rflbtions by ibndling rfffrfndfd MBfbn dfrfgistrbtions.
     *
     * @pbrbm rflbtionId  rflbtion id
     * @pbrbm rolfList  list of rolfs to bf sft
     *
     * @rfturn b RolfRfsult objfdt, indluding b RolfList (for rolfs
     * suddfssfully sft) bnd b RolfUnrfsolvfdList (for rolfs not
     * sft).
     *
     * @fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
     * Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion witi givfn id
     *
     * @sff #gftRolfs
     */
    publid RolfRfsult sftRolfs(String rflbtionId,
                               RolfList rolfList)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption,
               IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null || rolfList == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sftRolfs", nfw Objfdt[] {rflbtionId, rolfList});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        RolfRfsult rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
            //
            // Sibll not tirow RflbtionTypfNotFoundExdfption (bs rflbtion is
            // known, its rflbtion typf fxists)
            try {
                rfsult = ((RflbtionSupport)rflObj).sftRolfsInt(rolfList,
                                                            truf,
                                                            tiis);
            } dbtdi (RflbtionTypfNotFoundExdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }

        } flsf {
            // Rflbtion MBfbn
            Objfdt[] pbrbms = nfw Objfdt[1];
            pbrbms[0] = rolfList;
            String[] signbturf = nfw String[1];
            signbturf[0] = "jbvbx.mbnbgfmfnt.rflbtion.RolfList";
            // Sibll not tirow InstbndfNotFoundExdfption or bn MBfbnExdfption
            // or RfflfdtionExdfption
            try {
                rfsult = (RolfRfsult)
                    (myMBfbnSfrvfr.invokf(((ObjfdtNbmf)rflObj),
                                          "sftRolfs",
                                          pbrbms,
                                          signbturf));
            } dbtdi (InstbndfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RfflfdtionExdfption fxd3) {
                tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
            } dbtdi (MBfbnExdfption fxd2) {
                tirow nfw
                    RuntimfExdfption((fxd2.gftTbrgftExdfption()).gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(), "sftRolfs");
        rfturn rfsult;
    }

    /**
     * Rftrifvfs MBfbns rfffrfndfd in tif vbrious rolfs of tif rflbtion.
     *
     * @pbrbm rflbtionId  rflbtion id
     *
     * @rfturn b HbsiMbp mbpping:
     * <P> ObjfdtNbmf {@litfrbl ->} ArrbyList of String (rolf nbmfs)
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion for givfn
     * rflbtion id
     */
    publid Mbp<ObjfdtNbmf,List<String>>
        gftRfffrfndfdMBfbns(String rflbtionId)
            tirows IllfgblArgumfntExdfption,
        RflbtionNotFoundExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRfffrfndfdMBfbns", rflbtionId);

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        Mbp<ObjfdtNbmf,List<String>> rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            rfsult = ((RflbtionSupport)rflObj).gftRfffrfndfdMBfbns();

        } flsf {
            // Rflbtion MBfbn
            // No Exdfption
            try {
                rfsult = dbst(
                    myMBfbnSfrvfr.gftAttributf(((ObjfdtNbmf)rflObj),
                                               "RfffrfndfdMBfbns"));
            } dbtdi (Exdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRfffrfndfdMBfbns");
        rfturn rfsult;
    }

    /**
     * Rfturns nbmf of bssodibtfd rflbtion typf for givfn rflbtion.
     *
     * @pbrbm rflbtionId  rflbtion id
     *
     * @rfturn tif nbmf of tif bssodibtfd rflbtion typf.
     *
     * @fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
     * @fxdfption RflbtionNotFoundExdfption  if no rflbtion for givfn
     * rflbtion id
     */
    publid String gftRflbtionTypfNbmf(String rflbtionId)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtionTypfNbmf", rflbtionId);

        // Cbn tirow b RflbtionNotFoundExdfption
        Objfdt rflObj = gftRflbtion(rflbtionId);

        String rfsult;

        if (rflObj instbndfof RflbtionSupport) {
            // Intfrnbl rflbtion
            rfsult = ((RflbtionSupport)rflObj).gftRflbtionTypfNbmf();

        } flsf {
            // Rflbtion MBfbn
            // No Exdfption
            try {
                rfsult = (String)
                    (myMBfbnSfrvfr.gftAttributf(((ObjfdtNbmf)rflObj),
                                                "RflbtionTypfNbmf"));
            } dbtdi (Exdfption fxd) {
                tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtionTypfNbmf");
        rfturn rfsult;
    }

    //
    // NotifidbtionListfnfr Intfrfbdf
    //

    /**
     * Invokfd wifn b JMX notifidbtion oddurs.
     * Currfntly ibndlfs notifidbtions for unrfgistrbtion of MBfbns, fitifr
     * rfffrfndfd in b rflbtion rolf or bfing b rflbtion itsflf.
     *
     * @pbrbm notif  Tif notifidbtion.
     * @pbrbm ibndbbdk  An opbquf objfdt wiidi iflps tif listfnfr to
     * bssodibtf informbtion rfgbrding tif MBfbn fmittfr (dbn bf null).
     */
    publid void ibndlfNotifidbtion(Notifidbtion notif,
                                   Objfdt ibndbbdk) {

        if (notif == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "ibndlfNotifidbtion", notif);

        if (notif instbndfof MBfbnSfrvfrNotifidbtion) {

            MBfbnSfrvfrNotifidbtion mbsNtf = (MBfbnSfrvfrNotifidbtion) notif;
            String ntfTypf = notif.gftTypf();

            if (ntfTypf.fqubls(
                       MBfbnSfrvfrNotifidbtion.UNREGISTRATION_NOTIFICATION )) {
                ObjfdtNbmf mbfbnNbmf =
                    ((MBfbnSfrvfrNotifidbtion)notif).gftMBfbnNbmf();

                // Notf: usf b flbg to blodk bddfss to
                // myRfffdMBfbnObjNbmf2RflIdsMbp only for b quidk bddfss
                boolfbn isRfffdMBfbnFlbg = fblsf;
                syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {

                    if (myRfffdMBfbnObjNbmf2RflIdsMbp.dontbinsKfy(mbfbnNbmf)) {
                        // Unrfgistrbtion of b rfffrfndfd MBfbn
                        syndironizfd(myUnrfgNtfList) {
                            myUnrfgNtfList.bdd(mbsNtf);
                        }
                        isRfffdMBfbnFlbg = truf;
                    }
                    if (isRfffdMBfbnFlbg && myPurgfFlbg) {
                        // Immfdibtf purgf
                        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
                        // but bssumf tibt will bf finf :)
                        try {
                            purgfRflbtions();
                        } dbtdi (Exdfption fxd) {
                            tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
                        }
                    }
                }

                // Notf: do boti tfsts bs b rflbtion dbn bf bn MBfbn bnd bf
                //       itsflf rfffrfndfd in bnotifr rflbtion :)
                String rflId;
                syndironizfd(myRflMBfbnObjNbmf2RflIdMbp){
                    rflId = myRflMBfbnObjNbmf2RflIdMbp.gft(mbfbnNbmf);
                }
                if (rflId != null) {
                    // Unrfgistrbtion of b rflbtion MBfbn
                    // Cbn tirow RflbtionTypfNotFoundExdfption,
                    // RflbtionSfrvidfNotRfgistfrfdExdfption
                    //
                    // Sibll not tirow RflbtionTypfNotFoundExdfption or
                    // InstbndfNotFoundExdfption
                    try {
                        rfmovfRflbtion(rflId);
                    } dbtdi (Exdfption fxd) {
                        tirow nfw RuntimfExdfption(fxd.gftMfssbgf());
                    }
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "ibndlfNotifidbtion");
        rfturn;
    }

    //
    // NotifidbtionBrobddbstfr intfrfbdf
    //

    /**
     * Rfturns b NotifidbtionInfo objfdt dontbining tif nbmf of tif Jbvb dlbss
     * of tif notifidbtion bnd tif notifidbtion typfs sfnt.
     */
    publid MBfbnNotifidbtionInfo[] gftNotifidbtionInfo() {

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftNotifidbtionInfo");

        String ntfClbss = "jbvbx.mbnbgfmfnt.rflbtion.RflbtionNotifidbtion";

        String[] ntfTypfs = nfw String[] {
            RflbtionNotifidbtion.RELATION_BASIC_CREATION,
            RflbtionNotifidbtion.RELATION_MBEAN_CREATION,
            RflbtionNotifidbtion.RELATION_BASIC_UPDATE,
            RflbtionNotifidbtion.RELATION_MBEAN_UPDATE,
            RflbtionNotifidbtion.RELATION_BASIC_REMOVAL,
            RflbtionNotifidbtion.RELATION_MBEAN_REMOVAL,
        };

        String ntfDfsd = "Sfnt wifn b rflbtion is drfbtfd, updbtfd or dflftfd.";

        MBfbnNotifidbtionInfo ntfInfo =
            nfw MBfbnNotifidbtionInfo(ntfTypfs, ntfClbss, ntfDfsd);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftNotifidbtionInfo");
        rfturn nfw MBfbnNotifidbtionInfo[] {ntfInfo};
    }

    //
    // Misd
    //

    // Adds givfn objfdt bs b rflbtion typf.
    //
    // -pbrbm rflbtionTypfObj  rflbtion typf objfdt
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    // -fxdfption InvblidRflbtionTypfExdfption  if tifrf is blrfbdy b rflbtion
    //  typf witi tibt nbmf
    privbtf void bddRflbtionTypfInt(RflbtionTypf rflbtionTypfObj)
        tirows IllfgblArgumfntExdfption,
               InvblidRflbtionTypfExdfption {

        if (rflbtionTypfObj == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionTypfInt");

        String rflTypfNbmf = rflbtionTypfObj.gftRflbtionTypfNbmf();

        // Cifdks tibt tifrf is not blrfbdy b rflbtion typf witi tibt nbmf
        // fxisting in tif Rflbtion Sfrvidf
        try {
            // Cbn tirow b RflbtionTypfNotFoundExdfption (in fbdt siould ;)
            RflbtionTypf rflTypf = gftRflbtionTypf(rflTypfNbmf);

            if (rflTypf != null) {
                String fxdMsg = "Tifrf is blrfbdy b rflbtion typf in tif Rflbtion Sfrvidf witi nbmf ";
                StringBuildfr fxdMsgStrB = nfw StringBuildfr(fxdMsg);
                fxdMsgStrB.bppfnd(rflTypfNbmf);
                tirow nfw InvblidRflbtionTypfExdfption(fxdMsgStrB.toString());
            }

        } dbtdi (RflbtionTypfNotFoundExdfption fxd) {
            // OK : Tif RflbtionTypf dould not bf found.
        }

        // Adds tif rflbtion typf
        syndironizfd(myRflTypf2ObjMbp) {
            myRflTypf2ObjMbp.put(rflTypfNbmf, rflbtionTypfObj);
        }

        if (rflbtionTypfObj instbndfof RflbtionTypfSupport) {
            ((RflbtionTypfSupport)rflbtionTypfObj).sftRflbtionSfrvidfFlbg(truf);
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionTypfInt");
        rfturn;
     }

    // Rftrifvfs rflbtion typf witi givfn nbmf
    //
    // -pbrbm rflbtionTypfNbmf  fxpfdtfd nbmf of b rflbtion typf drfbtfd in tif
    //  Rflbtion Sfrvidf
    //
    // -rfturn RflbtionTypf objfdt dorrfsponding to givfn nbmf
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    // -fxdfption RflbtionTypfNotFoundExdfption  if no rflbtion typf for tibt
    //  nbmf drfbtfd in Rflbtion Sfrvidf
    //
    RflbtionTypf gftRflbtionTypf(String rflbtionTypfNbmf)
        tirows IllfgblArgumfntExdfption,
               RflbtionTypfNotFoundExdfption {

        if (rflbtionTypfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtionTypf", rflbtionTypfNbmf);

        // No null rflbtion typf bddfptfd, so dbn usf gft()
        RflbtionTypf rflTypf;
        syndironizfd(myRflTypf2ObjMbp) {
            rflTypf = (myRflTypf2ObjMbp.gft(rflbtionTypfNbmf));
        }

        if (rflTypf == null) {
            String fxdMsg = "No rflbtion typf drfbtfd in tif Rflbtion Sfrvidf witi tif nbmf ";
            StringBuildfr fxdMsgStrB = nfw StringBuildfr(fxdMsg);
            fxdMsgStrB.bppfnd(rflbtionTypfNbmf);
            tirow nfw RflbtionTypfNotFoundExdfption(fxdMsgStrB.toString());
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtionTypf");
        rfturn rflTypf;
    }

    // Rftrifvfs rflbtion dorrfsponding to givfn rflbtion id.
    // Rfturns fitifr:
    // - b RflbtionSupport objfdt if tif rflbtion is intfrnbl
    // or
    // - tif ObjfdtNbmf of tif dorrfsponding MBfbn
    //
    // -pbrbm rflbtionId  fxpfdtfd rflbtion id
    //
    // -rfturn RflbtionSupport objfdt or ObjfdtNbmf of rflbtion witi givfn id
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    // -fxdfption RflbtionNotFoundExdfption  if no rflbtion for tibt
    //  rflbtion id drfbtfd in Rflbtion Sfrvidf
    //
    Objfdt gftRflbtion(String rflbtionId)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (rflbtionId == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtion", rflbtionId);

        // No null rflbtion  bddfptfd, so dbn usf gft()
        Objfdt rfl;
        syndironizfd(myRflId2ObjMbp) {
            rfl = myRflId2ObjMbp.gft(rflbtionId);
        }

        if (rfl == null) {
            String fxdMsg = "No rflbtion bssodibtfd to rflbtion id " + rflbtionId;
            tirow nfw RflbtionNotFoundExdfption(fxdMsg);
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "gftRflbtion");
        rfturn rfl;
    }

    // Adds b nfw MBfbn rfffrfndf (rfffrfndf to bn ObjfdtNbmf) in tif
    // rfffrfndfd MBfbn mbp (myRfffdMBfbnObjNbmf2RflIdsMbp).
    //
    // -pbrbm objfdtNbmf  ObjfdtNbmf of nfw rfffrfndfd MBfbn
    // -pbrbm rflbtionId  rflbtion id of tif rflbtion wifrf tif MBfbn is
    //  rfffrfndfd
    // -pbrbm rolfNbmf  nbmf of tif rolf wifrf tif MBfbn is rfffrfndfd
    //
    // -rfturn boolfbn:
    //  - truf  if tif MBfbn wbs not rfffrfndfd bfforf, so rfblly b nfw
    //    rfffrfndf
    //  - fblsf flsf
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    privbtf boolfbn bddNfwMBfbnRfffrfndf(ObjfdtNbmf objfdtNbmf,
                                         String rflbtionId,
                                         String rolfNbmf)
        tirows IllfgblArgumfntExdfption {

        if (objfdtNbmf == null ||
            rflbtionId == null ||
            rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddNfwMBfbnRfffrfndf",
                nfw Objfdt[] {objfdtNbmf, rflbtionId, rolfNbmf});

        boolfbn isNfwFlbg = fblsf;

        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {

            // Cifdks if tif MBfbn wbs blrfbdy rfffrfndfd
            // No null vbluf bllowfd, usf gft() dirfdtly
            Mbp<String,List<String>> mbfbnRffMbp =
                myRfffdMBfbnObjNbmf2RflIdsMbp.gft(objfdtNbmf);

            if (mbfbnRffMbp == null) {
                // MBfbn not rfffrfndfd in bny rflbtion yft

                isNfwFlbg = truf;

                // List of rolfs wifrf tif MBfbn is rfffrfndfd in givfn
                // rflbtion
                List<String> rolfNbmfs = nfw ArrbyList<String>();
                rolfNbmfs.bdd(rolfNbmf);

                // Mbp of rflbtions wifrf tif MBfbn is rfffrfndfd
                mbfbnRffMbp = nfw HbsiMbp<String,List<String>>();
                mbfbnRffMbp.put(rflbtionId, rolfNbmfs);

                myRfffdMBfbnObjNbmf2RflIdsMbp.put(objfdtNbmf, mbfbnRffMbp);

            } flsf {
                // MBfbn blrfbdy rfffrfndfd in bt lfbst bnotifr rflbtion
                // Cifdks if blrfbdy rfffrfndfd in bnotifr rolf in durrfnt
                // rflbtion
                List<String> rolfNbmfs = mbfbnRffMbp.gft(rflbtionId);

                if (rolfNbmfs == null) {
                    // MBfbn not rfffrfndfd in durrfnt rflbtion

                    // List of rolfs wifrf tif MBfbn is rfffrfndfd in givfn
                    // rflbtion
                    rolfNbmfs = nfw ArrbyList<String>();
                    rolfNbmfs.bdd(rolfNbmf);

                    // Adds nfw rfffrfndf donf in durrfnt rflbtion
                    mbfbnRffMbp.put(rflbtionId, rolfNbmfs);

                } flsf {
                    // MBfbn blrfbdy rfffrfndfd in durrfnt rflbtion in bnotifr
                    // rolf
                    // Adds nfw rfffrfndf donf
                    rolfNbmfs.bdd(rolfNbmf);
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddNfwMBfbnRfffrfndf");
        rfturn isNfwFlbg;
    }

    // Rfmovfs bn obsolftf MBfbn rfffrfndf (rfffrfndf to bn ObjfdtNbmf) in
    // tif rfffrfndfd MBfbn mbp (myRfffdMBfbnObjNbmf2RflIdsMbp).
    //
    // -pbrbm objfdtNbmf  ObjfdtNbmf of MBfbn no longfr rfffrfndfd
    // -pbrbm rflbtionId  rflbtion id of tif rflbtion wifrf tif MBfbn wbs
    //  rfffrfndfd
    // -pbrbm rolfNbmf  nbmf of tif rolf wifrf tif MBfbn wbs rfffrfndfd
    // -pbrbm bllRolfsFlbg  flbg, if truf rfmovfs rfffrfndf to MBfbn for bll
    //  rolfs in tif rflbtion, not only for tif onf bbovf
    //
    // -rfturn boolfbn:
    //  - truf  if tif MBfbn is no longfr rfffrfndf in bny rflbtion
    //  - fblsf flsf
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    privbtf boolfbn rfmovfMBfbnRfffrfndf(ObjfdtNbmf objfdtNbmf,
                                         String rflbtionId,
                                         String rolfNbmf,
                                         boolfbn bllRolfsFlbg)
        tirows IllfgblArgumfntExdfption {

        if (objfdtNbmf == null ||
            rflbtionId == null ||
            rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfMBfbnRfffrfndf",
                nfw Objfdt[] {objfdtNbmf, rflbtionId, rolfNbmf, bllRolfsFlbg});

        boolfbn noLongfrRffFlbg = fblsf;

        syndironizfd(myRfffdMBfbnObjNbmf2RflIdsMbp) {

            // Rftrifvfs tif sft of rflbtions (dfsignfd vib tifir rflbtion ids)
            // wifrf tif MBfbn is rfffrfndfd
            // Notf tibt it is possiblf tibt tif MBfbn ibs blrfbdy bffn rfmovfd
            // from tif intfrnbl mbp: tiis is tif dbsf wifn tif MBfbn is
            // unrfgistfrfd, tif rolf is updbtfd, tifn wf brrivf ifrf.
            Mbp<String,List<String>> mbfbnRffMbp =
                (myRfffdMBfbnObjNbmf2RflIdsMbp.gft(objfdtNbmf));

            if (mbfbnRffMbp == null) {
                // Tif MBfbn is no longfr rfffrfndfd
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "rfmovfMBfbnRfffrfndf");
                rfturn truf;
            }

            List<String> rolfNbmfs = null;
            if (!bllRolfsFlbg) {
                // Now rftrifvfs tif rolfs of durrfnt rflbtion wifrf tif MBfbn
                // wbs rfffrfndfd
                rolfNbmfs = mbfbnRffMbp.gft(rflbtionId);

                // Rfmovfs obsolftf rfffrfndf to rolf
                int obsRffIdx = rolfNbmfs.indfxOf(rolfNbmf);
                if (obsRffIdx != -1) {
                    rolfNbmfs.rfmovf(obsRffIdx);
                }
            }

            // Cifdks if tifrf is still bt lfbst onf rolf in durrfnt rflbtion
            // wifrf tif MBfbn is rfffrfndfd
            if (rolfNbmfs.isEmpty() || bllRolfsFlbg) {
                // MBfbn no longfr rfffrfndfd in durrfnt rflbtion: rfmovfs
                // fntry
                mbfbnRffMbp.rfmovf(rflbtionId);
            }

            // Cifdks if tif MBfbn is still rfffrfndfd in bt lfbst on rflbtion
            if (mbfbnRffMbp.isEmpty()) {
                // MBfbn no longfr rfffrfndfd in bny rflbtion: rfmovfs fntry
                myRfffdMBfbnObjNbmf2RflIdsMbp.rfmovf(objfdtNbmf);
                noLongfrRffFlbg = truf;
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "rfmovfMBfbnRfffrfndf");
        rfturn noLongfrRffFlbg;
    }

    // Updbtfs tif listfnfr rfgistfrfd to tif MBfbn Sfrvfr to bf informfd of
    // rfffrfndfd MBfbn dfrfgistrbtions
    //
    // -pbrbm nfwRffList  ArrbyList of ObjfdtNbmfs for nfw rfffrfndfs donf
    //  to MBfbns (dbn bf null)
    // -pbrbm obsolftfRffList  ArrbyList of ObjfdtNbmfs for obsolftf rfffrfndfs
    //  to MBfbns (dbn bf null)
    //
    // -fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
    //  Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr.
    privbtf void updbtfUnrfgistrbtionListfnfr(List<ObjfdtNbmf> nfwRffList,
                                              List<ObjfdtNbmf> obsolftfRffList)
        tirows RflbtionSfrvidfNotRfgistfrfdExdfption {

        if (nfwRffList != null && obsolftfRffList != null) {
            if (nfwRffList.isEmpty() && obsolftfRffList.isEmpty()) {
                // Notiing to do :)
                rfturn;
            }
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "updbtfUnrfgistrbtionListfnfr",
                nfw Objfdt[] {nfwRffList, obsolftfRffList});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        if (nfwRffList != null || obsolftfRffList != null) {

            boolfbn nfwListfnfrFlbg = fblsf;
            if (myUnrfgNtfFiltfr == null) {
                // Initiblizf it to bf bblf to syndironisf it :)
                myUnrfgNtfFiltfr = nfw MBfbnSfrvfrNotifidbtionFiltfr();
                nfwListfnfrFlbg = truf;
            }

            syndironizfd(myUnrfgNtfFiltfr) {

                // Enbblfs ObjfdtNbmfs in nfwRffList
                if (nfwRffList != null) {
                    for (ObjfdtNbmf nfwObjNbmf : nfwRffList)
                        myUnrfgNtfFiltfr.fnbblfObjfdtNbmf(nfwObjNbmf);
                }

                if (obsolftfRffList != null) {
                    // Disbblfs ObjfdtNbmfs in obsolftfRffList
                    for (ObjfdtNbmf obsObjNbmf : obsolftfRffList)
                        myUnrfgNtfFiltfr.disbblfObjfdtNbmf(obsObjNbmf);
                }

// Undfr tfst
                if (nfwListfnfrFlbg) {
                    try {
                        myMBfbnSfrvfr.bddNotifidbtionListfnfr(
                                MBfbnSfrvfrDflfgbtf.DELEGATE_NAME,
                                tiis,
                                myUnrfgNtfFiltfr,
                                null);
                    } dbtdi (InstbndfNotFoundExdfption fxd) {
                        tirow nfw
                       RflbtionSfrvidfNotRfgistfrfdExdfption(fxd.gftMfssbgf());
                    }
                }
// End tfst


//              if (!nfwListfnfrFlbg) {
                    // Tif Rflbtion Sfrvidf wbs blrfbdy rfgistfrfd bs b
                    // listfnfr:
                    // rfmovfs it
                    // Sibll not tirow InstbndfNotFoundExdfption (bs tif
                    // MBfbn Sfrvfr Dflfgbtf is fxpfdtfd to fxist) or
                    // ListfnfrNotFoundExdfption (bs it ibs bffn difdkfd bbovf
                    // tibt tif Rflbtion Sfrvidf is rfgistfrfd)
//                  try {
//                      myMBfbnSfrvfr.rfmovfNotifidbtionListfnfr(
//                              MBfbnSfrvfrDflfgbtf.DELEGATE_NAME,
//                              tiis);
//                  } dbtdi (InstbndfNotFoundExdfption fxd1) {
//                      tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
//                  } dbtdi (ListfnfrNotFoundExdfption fxd2) {
//                      tirow nfw
//                          RflbtionSfrvidfNotRfgistfrfdExdfption(fxd2.gftMfssbgf());
//                  }
//              }

                // Adds Rflbtion Sfrvidf witi durrfnt filtfr
                // Cbn tirow InstbndfNotFoundExdfption if tif Rflbtion
                // Sfrvidf is not rfgistfrfd, to bf trbnsformfd into
                // RflbtionSfrvidfNotRfgistfrfdExdfption
                //
                // Assumf tibt tifrf will not bf bny InstbndfNotFoundExdfption
                // for tif MBfbn Sfrvfr Dflfgbtf :)
//              try {
//                  myMBfbnSfrvfr.bddNotifidbtionListfnfr(
//                              MBfbnSfrvfrDflfgbtf.DELEGATE_NAME,
//                              tiis,
//                              myUnrfgNtfFiltfr,
//                              null);
//              } dbtdi (InstbndfNotFoundExdfption fxd) {
//                  tirow nfw
//                     RflbtionSfrvidfNotRfgistfrfdExdfption(fxd.gftMfssbgf());
//              }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "updbtfUnrfgistrbtionListfnfr");
        rfturn;
    }

    // Adds b rflbtion (bfing fitifr b RflbtionSupport objfdt or bn MBfbn
    // rfffrfndfd using its ObjfdtNbmf) in tif Rflbtion Sfrvidf.
    // Will sfnd b notifidbtion RflbtionNotifidbtion witi typf:
    // - RflbtionNotifidbtion.RELATION_BASIC_CREATION for intfrnbl rflbtion
    //   drfbtion
    // - RflbtionNotifidbtion.RELATION_MBEAN_CREATION for bn MBfbn bfing bddfd
    //   bs b rflbtion.
    //
    // -pbrbm rflbtionBbsfFlbg  flbg truf if tif rflbtion is b RflbtionSupport
    //  objfdt, fblsf if it is bn MBfbn
    // -pbrbm rflbtionObj  RflbtionSupport objfdt (if rflbtion is intfrnbl)
    // -pbrbm rflbtionObjNbmf  ObjfdtNbmf of tif MBfbn to bf bddfd bs b rflbtion
    //  (only for tif rflbtion MBfbn)
    // -pbrbm rflbtionId  rflbtion idfntififr, to uniqufly idfntify tif rflbtion
    //  insidf tif Rflbtion Sfrvidf
    // -pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf (ibs to bf drfbtfd
    //  in tif Rflbtion Sfrvidf)
    // -pbrbm rolfList  rolf list to initiblizf rolfs of tif rflbtion
    //  (dbn bf null)
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmbtfr
    // -fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
    //  Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
    // -fxdfption RolfNotFoundExdfption  if b vbluf is providfd for b rolf
    //  tibt dofs not fxist in tif rflbtion typf
    // -fxdfption InvblidRflbtionIdExdfption  if rflbtion id blrfbdy usfd
    // -fxdfption RflbtionTypfNotFoundExdfption  if rflbtion typf not known in
    //  Rflbtion Sfrvidf
    // -fxdfption InvblidRolfVblufExdfption if:
    //  - tif sbmf rolf nbmf is usfd for two difffrfnt rolfs
    //  - tif numbfr of rfffrfndfd MBfbns in givfn vbluf is lfss tibn
    //    fxpfdtfd minimum dfgrff
    //  - tif numbfr of rfffrfndfd MBfbns in providfd vbluf fxdffds fxpfdtfd
    //    mbximum dfgrff
    //  - onf rfffrfndfd MBfbn in tif vbluf is not bn Objfdt of tif MBfbn
    //    dlbss fxpfdtfd for tibt rolf
    //  - bn MBfbn providfd for tibt rolf dofs not fxist
    privbtf void bddRflbtionInt(boolfbn rflbtionBbsfFlbg,
                                RflbtionSupport rflbtionObj,
                                ObjfdtNbmf rflbtionObjNbmf,
                                String rflbtionId,
                                String rflbtionTypfNbmf,
                                RolfList rolfList)
        tirows IllfgblArgumfntExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption,
               RolfNotFoundExdfption,
               InvblidRflbtionIdExdfption,
               RflbtionTypfNotFoundExdfption,
               InvblidRolfVblufExdfption {

        if (rflbtionId == null ||
            rflbtionTypfNbmf == null ||
            (rflbtionBbsfFlbg &&
             (rflbtionObj == null ||
              rflbtionObjNbmf != null)) ||
            (!rflbtionBbsfFlbg &&
             (rflbtionObjNbmf == null ||
              rflbtionObj != null))) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionInt", nfw Objfdt[] {rflbtionBbsfFlbg, rflbtionObj,
                rflbtionObjNbmf, rflbtionId, rflbtionTypfNbmf, rolfList});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Cifdks if tifrf is blrfbdy b rflbtion witi givfn id
        try {
            // Cbn tirow b RflbtionNotFoundExdfption (in fbdt siould :)
            Objfdt rfl = gftRflbtion(rflbtionId);

            if (rfl != null) {
                // Tifrf is blrfbdy b rflbtion witi tibt id
                String fxdMsg = "Tifrf is blrfbdy b rflbtion witi id ";
                StringBuildfr fxdMsgStrB = nfw StringBuildfr(fxdMsg);
                fxdMsgStrB.bppfnd(rflbtionId);
                tirow nfw InvblidRflbtionIdExdfption(fxdMsgStrB.toString());
            }
        } dbtdi (RflbtionNotFoundExdfption fxd) {
            // OK : Tif Rflbtion dould not bf found.
        }

        // Rftrifvfs tif rflbtion typf
        // Cbn tirow RflbtionTypfNotFoundExdfption
        RflbtionTypf rflTypf = gftRflbtionTypf(rflbtionTypfNbmf);

        // Cifdks tibt fbdi providfd rolf donforms to its rolf info providfd in
        // tif rflbtion typf
        // First rftrifvfs b lodbl list of tif rolf infos of tif rflbtion typf
        // to sff wiidi rolfs ibvf not bffn initiblizfd
        // Notf: no nffd to tfst if list not null bfforf dloning, not bllowfd
        //       to ibvf bn fmpty rflbtion typf.
        List<RolfInfo> rolfInfoList = nfw ArrbyList<RolfInfo>(rflTypf.gftRolfInfos());

        if (rolfList != null) {

            for (Rolf durrRolf : rolfList.bsList()) {
                String durrRolfNbmf = durrRolf.gftRolfNbmf();
                List<ObjfdtNbmf> durrRolfVbluf = durrRolf.gftRolfVbluf();
                // Rftrifvfs dorrfsponding rolf info
                // Cbn tirow b RolfInfoNotFoundExdfption to bf donvfrtfd into b
                // RolfNotFoundExdfption
                RolfInfo rolfInfo;
                try {
                    rolfInfo = rflTypf.gftRolfInfo(durrRolfNbmf);
                } dbtdi (RolfInfoNotFoundExdfption fxd) {
                    tirow nfw RolfNotFoundExdfption(fxd.gftMfssbgf());
                }

                // Cifdks tibt rolf donforms to rolf info,
                Intfgfr stbtus = difdkRolfInt(2,
                                              durrRolfNbmf,
                                              durrRolfVbluf,
                                              rolfInfo,
                                              fblsf);
                int pbTypf = stbtus.intVbluf();
                if (pbTypf != 0) {
                    // A problfm ibs oddurrfd: tirows bppropribtf fxdfption
                    // ifrf InvblidRolfVblufExdfption
                    tirowRolfProblfmExdfption(pbTypf, durrRolfNbmf);
                }

                // Rfmovfs rolf info for tibt list from list of rolf infos for
                // rolfs to bf dffbultfd
                int rolfInfoIdx = rolfInfoList.indfxOf(rolfInfo);
                // Notf: no nffd to difdk if != -1, MUST bf tifrf :)
                rolfInfoList.rfmovf(rolfInfoIdx);
            }
        }

        // Initiblizfs rolfs not initiblizfd by rolfList
        // Cbn tirow InvblidRolfVblufExdfption
        initiblizfMissingRolfs(rflbtionBbsfFlbg,
                               rflbtionObj,
                               rflbtionObjNbmf,
                               rflbtionId,
                               rflbtionTypfNbmf,
                               rolfInfoList);

        // Crfbtion of rflbtion suddfssfull!!!!

        // Updbtfs intfrnbl mbps
        // Rflbtion id to objfdt mbp
        syndironizfd(myRflId2ObjMbp) {
            if (rflbtionBbsfFlbg) {
                // Notf: do not dlonf rflbtion objfdt, drfbtfd by us :)
                myRflId2ObjMbp.put(rflbtionId, rflbtionObj);
            } flsf {
                myRflId2ObjMbp.put(rflbtionId, rflbtionObjNbmf);
            }
        }

        // Rflbtion id to rflbtion typf nbmf mbp
        syndironizfd(myRflId2RflTypfMbp) {
            myRflId2RflTypfMbp.put(rflbtionId,
                                   rflbtionTypfNbmf);
        }

        // Rflbtion typf to rflbtion id mbp
        syndironizfd(myRflTypf2RflIdsMbp) {
            List<String> rflIdList =
                myRflTypf2RflIdsMbp.gft(rflbtionTypfNbmf);
            boolfbn firstRflFlbg = fblsf;
            if (rflIdList == null) {
                firstRflFlbg = truf;
                rflIdList = nfw ArrbyList<String>();
            }
            rflIdList.bdd(rflbtionId);
            if (firstRflFlbg) {
                myRflTypf2RflIdsMbp.put(rflbtionTypfNbmf, rflIdList);
            }
        }

        // Rfffrfndfd MBfbn to rflbtion id mbp
        // Only rolf list pbrbmftfr usfd, bs dffbult initiblizbtion of rolfs
        // donf butombtidblly in initiblizfMissingRolfs() sfts fbdi
        // uninitiblizfd rolf to bn fmpty vbluf.
        for (Rolf durrRolf : rolfList.bsList()) {
            // Crfbtfs b dummy fmpty ArrbyList of ObjfdtNbmfs to bf tif old
            // rolf vbluf :)
            List<ObjfdtNbmf> dummyList = nfw ArrbyList<ObjfdtNbmf>();
            // Will not tirow b RflbtionNotFoundExdfption (bs tif RflId2Obj mbp
            // ibs bffn updbtfd bbovf) so dbtdi it :)
            try {
                updbtfRolfMbp(rflbtionId, durrRolf, dummyList);

            } dbtdi (RflbtionNotFoundExdfption fxd) {
                // OK : Tif Rflbtion dould not bf found.
            }
        }

        // Sfnds b notifidbtion for rflbtion drfbtion
        // Will not tirow RflbtionNotFoundExdfption so dbtdi it :)
        try {
            sfndRflbtionCrfbtionNotifidbtion(rflbtionId);

        } dbtdi (RflbtionNotFoundExdfption fxd) {
            // OK : Tif Rflbtion dould not bf found.
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "bddRflbtionInt");
        rfturn;
    }

    // Cifdks tibt givfn rolf donforms to givfn rolf info.
    //
    // -pbrbm dikTypf  typf of difdk:
    //  - 1: rfbd, just difdk rfbd bddfss
    //  - 2: writf, difdk vbluf bnd writf bddfss if writfCikFlbg
    // -pbrbm rolfNbmf  rolf nbmf
    // -pbrbm rolfVbluf  rolf vbluf
    // -pbrbm rolfInfo  dorrfsponding rolf info
    // -pbrbm writfCikFlbg  boolfbn to spfdify b durrfnt writf bddfss bnd
    //  to difdk it
    //
    // -rfturn Intfgfr witi vbluf:
    //  - 0: ok
    //  - RolfStbtus.NO_ROLE_WITH_NAME
    //  - RolfStbtus.ROLE_NOT_READABLE
    //  - RolfStbtus.ROLE_NOT_WRITABLE
    //  - RolfStbtus.LESS_THAN_MIN_ROLE_DEGREE
    //  - RolfStbtus.MORE_THAN_MAX_ROLE_DEGREE
    //  - RolfStbtus.REF_MBEAN_OF_INCORRECT_CLASS
    //  - RolfStbtus.REF_MBEAN_NOT_REGISTERED
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    privbtf Intfgfr difdkRolfInt(int dikTypf,
                                 String rolfNbmf,
                                 List<ObjfdtNbmf> rolfVbluf,
                                 RolfInfo rolfInfo,
                                 boolfbn writfCikFlbg)
        tirows IllfgblArgumfntExdfption {

        if (rolfNbmf == null ||
            rolfInfo == null ||
            (dikTypf == 2 && rolfVbluf == null)) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfInt", nfw Objfdt[] {dikTypf, rolfNbmf,
                rolfVbluf, rolfInfo, writfCikFlbg});

        // Compbrfs nbmfs
        String fxpNbmf = rolfInfo.gftNbmf();
        if (!(rolfNbmf.fqubls(fxpNbmf))) {
            RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                    "difdkRolfInt");
            rfturn Intfgfr.vblufOf(RolfStbtus.NO_ROLE_WITH_NAME);
        }

        // Cifdks rfbd bddfss if rfquirfd
        if (dikTypf == 1) {
            boolfbn isRfbdbblf = rolfInfo.isRfbdbblf();
            if (!isRfbdbblf) {
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "difdkRolfInt");
                rfturn Intfgfr.vblufOf(RolfStbtus.ROLE_NOT_READABLE);
            } flsf {
                // End of difdk :)
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "difdkRolfInt");
                rfturn 0;
            }
        }

        // Cifdks writf bddfss if rfquirfd
        if (writfCikFlbg) {
            boolfbn isWritbblf = rolfInfo.isWritbblf();
            if (!isWritbblf) {
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "difdkRolfInt");
                rfturn RolfStbtus.ROLE_NOT_WRITABLE;
            }
        }

        int rffNbr = rolfVbluf.sizf();

        // Cifdks minimum dbrdinblity
        boolfbn dikMinFlbg = rolfInfo.difdkMinDfgrff(rffNbr);
        if (!dikMinFlbg) {
            RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                    "difdkRolfInt");
            rfturn RolfStbtus.LESS_THAN_MIN_ROLE_DEGREE;
        }

        // Cifdks mbximum dbrdinblity
        boolfbn dikMbxFlbg = rolfInfo.difdkMbxDfgrff(rffNbr);
        if (!dikMbxFlbg) {
            RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                    "difdkRolfInt");
            rfturn RolfStbtus.MORE_THAN_MAX_ROLE_DEGREE;
        }

        // Vfrififs tibt fbdi rfffrfndfd MBfbn is rfgistfrfd in tif MBfbn
        // Sfrvfr bnd tibt it is bn instbndf of tif dlbss spfdififd in tif
        // rolf info, or of b subdlbss of it
        // Notf tibt ifrf bgbin tiis is undfr tif bssumption tibt
        // rfffrfndfd MBfbns, rflbtion MBfbns bnd tif Rflbtion Sfrvidf brf
        // rfgistfrfd in tif sbmf MBfbn Sfrvfr.
        String fxpClbssNbmf = rolfInfo.gftRffMBfbnClbssNbmf();

        for (ObjfdtNbmf durrObjNbmf : rolfVbluf) {

            // Cifdks it is rfgistfrfd
            if (durrObjNbmf == null) {
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "difdkRolfInt");
                rfturn RolfStbtus.REF_MBEAN_NOT_REGISTERED;
            }

            // Cifdks if it is of tif dorrfdt dlbss
            // Cbn tirow bn InstbndfNotFoundExdfption, if MBfbn not rfgistfrfd
            try {
                boolfbn dlbssSts = myMBfbnSfrvfr.isInstbndfOf(durrObjNbmf,
                                                              fxpClbssNbmf);
                if (!dlbssSts) {
                    RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                            "difdkRolfInt");
                    rfturn RolfStbtus.REF_MBEAN_OF_INCORRECT_CLASS;
                }

            } dbtdi (InstbndfNotFoundExdfption fxd) {
                RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                        "difdkRolfInt");
                rfturn RolfStbtus.REF_MBEAN_NOT_REGISTERED;
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "difdkRolfInt");
        rfturn 0;
    }


    // Initiblizfs rolfs bssodibtfd to givfn rolf infos to dffbult vbluf (fmpty
    // ArrbyList of ObjfdtNbmfs) in givfn rflbtion.
    // It will suddffd for fvfry rolf fxdfpt if tif rolf info ibs b minimum
    // dbrdinblity grfbtfr tibn 0. In tibt dbsf, bn InvblidRolfVblufExdfption
    // will bf rbisfd.
    //
    // -pbrbm rflbtionBbsfFlbg  flbg truf if tif rflbtion is b RflbtionSupport
    //  objfdt, fblsf if it is bn MBfbn
    // -pbrbm rflbtionObj  RflbtionSupport objfdt (if rflbtion is intfrnbl)
    // -pbrbm rflbtionObjNbmf  ObjfdtNbmf of tif MBfbn to bf bddfd bs b rflbtion
    //  (only for tif rflbtion MBfbn)
    // -pbrbm rflbtionId  rflbtion id
    // -pbrbm rflbtionTypfNbmf  nbmf of tif rflbtion typf (ibs to bf drfbtfd
    //  in tif Rflbtion Sfrvidf)
    // -pbrbm rolfInfoList  list of rolf infos for rolfs to bf dffbultfd
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmbtfr
    // -fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
    //  Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
    // -fxdfption InvblidRolfVblufExdfption  if rolf must ibvf b non-fmpty
    //  vbluf

    // Rfvisit [dfbro] Hbndlf CIM qublififrs bs REQUIRED to dftfdt rolfs wiidi
    //    siould ibvf bffn initiblizfd by tif usfr
    privbtf void initiblizfMissingRolfs(boolfbn rflbtionBbsfFlbg,
                                        RflbtionSupport rflbtionObj,
                                        ObjfdtNbmf rflbtionObjNbmf,
                                        String rflbtionId,
                                        String rflbtionTypfNbmf,
                                        List<RolfInfo> rolfInfoList)
        tirows IllfgblArgumfntExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption,
               InvblidRolfVblufExdfption {

        if ((rflbtionBbsfFlbg &&
             (rflbtionObj == null ||
              rflbtionObjNbmf != null)) ||
            (!rflbtionBbsfFlbg &&
             (rflbtionObjNbmf == null ||
              rflbtionObj != null)) ||
            rflbtionId == null ||
            rflbtionTypfNbmf == null ||
            rolfInfoList == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "initiblizfMissingRolfs", nfw Objfdt[] {rflbtionBbsfFlbg,
                rflbtionObj, rflbtionObjNbmf, rflbtionId, rflbtionTypfNbmf,
                rolfInfoList});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // For fbdi rolf info (dorrfsponding to b rolf not initiblizfd by tif
        // rolf list providfd by tif usfr), try to sft in tif rflbtion b rolf
        // witi bn fmpty list of ObjfdtNbmfs.
        // A difdk is pfrformfd to vfrify tibt tif rolf dbn bf sft to bn
        // fmpty vbluf, bddording to its minimum dbrdinblity
        for (RolfInfo durrRolfInfo : rolfInfoList) {

            String rolfNbmf = durrRolfInfo.gftNbmf();

            // Crfbtfs bn fmpty vbluf
            List<ObjfdtNbmf> fmptyVbluf = nfw ArrbyList<ObjfdtNbmf>();
            // Crfbtfs b rolf
            Rolf rolf = nfw Rolf(rolfNbmf, fmptyVbluf);

            if (rflbtionBbsfFlbg) {

                // Intfrnbl rflbtion
                // Cbn tirow InvblidRolfVblufExdfption
                //
                // Will not tirow RolfNotFoundExdfption (rolf to bf
                // initiblizfd), or RflbtionNotFoundExdfption, or
                // RflbtionTypfNotFoundExdfption
                try {
                    rflbtionObj.sftRolfInt(rolf, truf, tiis, fblsf);

                } dbtdi (RolfNotFoundExdfption fxd1) {
                    tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
                } dbtdi (RflbtionNotFoundExdfption fxd2) {
                    tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
                } dbtdi (RflbtionTypfNotFoundExdfption fxd3) {
                    tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
                }

            } flsf {

                // Rflbtion is bn MBfbn
                // Usf stbndbrd sftRolf()
                Objfdt[] pbrbms = nfw Objfdt[1];
                pbrbms[0] = rolf;
                String[] signbturf = nfw String[1];
                signbturf[0] = "jbvbx.mbnbgfmfnt.rflbtion.Rolf";
                // Cbn tirow MBfbnExdfption wrbpping
                // InvblidRolfVblufExdfption. Rfturns tif tbrgft fxdfption to
                // bf iomogfnfous.
                //
                // Will not tirow MBfbnExdfption (wrbpping
                // RolfNotFoundExdfption or MBfbnExdfption) or
                // InstbndfNotFoundExdfption, or RfflfdtionExdfption
                //
                // Agbin ifrf tif bssumption is tibt tif Rflbtion Sfrvidf bnd
                // tif rflbtion MBfbns brf rfgistfrfd in tif sbmf MBfbn Sfrvfr.
                try {
                    myMBfbnSfrvfr.sftAttributf(rflbtionObjNbmf,
                                               nfw Attributf("Rolf", rolf));

                } dbtdi (InstbndfNotFoundExdfption fxd1) {
                    tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
                } dbtdi (RfflfdtionExdfption fxd3) {
                    tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
                } dbtdi (MBfbnExdfption fxd2) {
                    Exdfption wrbppfdExd = fxd2.gftTbrgftExdfption();
                    if (wrbppfdExd instbndfof InvblidRolfVblufExdfption) {
                        tirow ((InvblidRolfVblufExdfption)wrbppfdExd);
                    } flsf {
                        tirow nfw RuntimfExdfption(wrbppfdExd.gftMfssbgf());
                    }
                } dbtdi (AttributfNotFoundExdfption fxd4) {
                  tirow nfw RuntimfExdfption(fxd4.gftMfssbgf());
                } dbtdi (InvblidAttributfVblufExdfption fxd5) {
                  tirow nfw RuntimfExdfption(fxd5.gftMfssbgf());
                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "initiblizfMissingRolfs");
        rfturn;
    }

    // Tirows bn fxdfption dorrfsponding to b givfn problfm typf
    //
    // -pbrbm pbTypf  possiblf problfm, dffinfd in RolfUnrfsolvfd
    // -pbrbm rolfNbmf  rolf nbmf
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    // -fxdfption RolfNotFoundExdfption  for problfms:
    //  - NO_ROLE_WITH_NAME
    //  - ROLE_NOT_READABLE
    //  - ROLE_NOT_WRITABLE
    // -fxdfption InvblidRolfVblufExdfption  for problfms:
    //  - LESS_THAN_MIN_ROLE_DEGREE
    //  - MORE_THAN_MAX_ROLE_DEGREE
    //  - REF_MBEAN_OF_INCORRECT_CLASS
    //  - REF_MBEAN_NOT_REGISTERED
    stbtid void tirowRolfProblfmExdfption(int pbTypf,
                                          String rolfNbmf)
        tirows IllfgblArgumfntExdfption,
               RolfNotFoundExdfption,
               InvblidRolfVblufExdfption {

        if (rolfNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        // Exdfption typf: 1 = RolfNotFoundExdfption
        //                 2 = InvblidRolfVblufExdfption
        int fxdTypf = 0;

        String fxdMsgPbrt = null;

        switdi (pbTypf) {
        dbsf RolfStbtus.NO_ROLE_WITH_NAME:
            fxdMsgPbrt = " dofs not fxist in rflbtion.";
            fxdTypf = 1;
            brfbk;
        dbsf RolfStbtus.ROLE_NOT_READABLE:
            fxdMsgPbrt = " is not rfbdbblf.";
            fxdTypf = 1;
            brfbk;
        dbsf RolfStbtus.ROLE_NOT_WRITABLE:
            fxdMsgPbrt = " is not writbblf.";
            fxdTypf = 1;
            brfbk;
        dbsf RolfStbtus.LESS_THAN_MIN_ROLE_DEGREE:
            fxdMsgPbrt = " ibs b numbfr of MBfbn rfffrfndfs lfss tibn tif fxpfdtfd minimum dfgrff.";
            fxdTypf = 2;
            brfbk;
        dbsf RolfStbtus.MORE_THAN_MAX_ROLE_DEGREE:
            fxdMsgPbrt = " ibs b numbfr of MBfbn rfffrfndfs grfbtfr tibn tif fxpfdtfd mbximum dfgrff.";
            fxdTypf = 2;
            brfbk;
        dbsf RolfStbtus.REF_MBEAN_OF_INCORRECT_CLASS:
            fxdMsgPbrt = " ibs bn MBfbn rfffrfndf to bn MBfbn not of tif fxpfdtfd dlbss of rfffrfndfs for tibt rolf.";
            fxdTypf = 2;
            brfbk;
        dbsf RolfStbtus.REF_MBEAN_NOT_REGISTERED:
            fxdMsgPbrt = " ibs b rfffrfndf to null or to bn MBfbn not rfgistfrfd.";
            fxdTypf = 2;
            brfbk;
        }
        // No dffbult bs wf must ibvf bffn in onf of tiosf dbsfs

        StringBuildfr fxdMsgStrB = nfw StringBuildfr(rolfNbmf);
        fxdMsgStrB.bppfnd(fxdMsgPbrt);
        String fxdMsg = fxdMsgStrB.toString();
        if (fxdTypf == 1) {
            tirow nfw RolfNotFoundExdfption(fxdMsg);

        } flsf if (fxdTypf == 2) {
            tirow nfw InvblidRolfVblufExdfption(fxdMsg);
        }
    }

    // Sfnds b notifidbtion of givfn typf, witi givfn pbrbmftfrs
    //
    // -pbrbm intNtfTypf  intfgfr to rfprfsfnt notifidbtion typf:
    //  - 1 : drfbtf
    //  - 2 : updbtf
    //  - 3 : dflftf
    // -pbrbm mfssbgf  iumbn-rfbdbblf mfssbgf
    // -pbrbm rflbtionId  rflbtion id of tif drfbtfd/updbtfd/dflftfd rflbtion
    // -pbrbm unrfgMBfbnList  list of ObjfdtNbmfs of rfffrfndfd MBfbns
    //  fxpfdtfd to bf unrfgistfrfd duf to rflbtion rfmovbl (only for rfmovbl,
    //  duf to CIM qublififrs, dbn bf null)
    // -pbrbm rolfNbmf  rolf nbmf
    // -pbrbm rolfNfwVbluf  rolf nfw vbluf (ArrbyList of ObjfdtNbmfs)
    // -pbrbm oldVbluf  old rolf vbluf (ArrbyList of ObjfdtNbmfs)
    //
    // -fxdfption IllfgblArgumfnt  if null pbrbmftfr
    // -fxdfption RflbtionNotFoundExdfption  if no rflbtion for givfn id
    privbtf void sfndNotifidbtionInt(int intNtfTypf,
                                     String mfssbgf,
                                     String rflbtionId,
                                     List<ObjfdtNbmf> unrfgMBfbnList,
                                     String rolfNbmf,
                                     List<ObjfdtNbmf> rolfNfwVbluf,
                                     List<ObjfdtNbmf> oldVbluf)
        tirows IllfgblArgumfntExdfption,
               RflbtionNotFoundExdfption {

        if (mfssbgf == null ||
            rflbtionId == null ||
            (intNtfTypf != 3 && unrfgMBfbnList != null) ||
            (intNtfTypf == 2 &&
             (rolfNbmf == null ||
              rolfNfwVbluf == null ||
              oldVbluf == null))) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndNotifidbtionInt", nfw Objfdt[] {intNtfTypf, mfssbgf,
                rflbtionId, unrfgMBfbnList, rolfNbmf, rolfNfwVbluf, oldVbluf});

        // Rflbtion typf nbmf
        // Notf: do not usf gftRflbtionTypfNbmf() bs if it is b rflbtion MBfbn
        //       it is blrfbdy unrfgistfrfd.
        String rflTypfNbmf;
        syndironizfd(myRflId2RflTypfMbp) {
            rflTypfNbmf = (myRflId2RflTypfMbp.gft(rflbtionId));
        }

        // ObjfdtNbmf (for b rflbtion MBfbn)
        // Cbn blso tirow b RflbtionNotFoundExdfption, but dftfdtfd bbovf
        ObjfdtNbmf rflObjNbmf = isRflbtionMBfbn(rflbtionId);

        String ntfTypf = null;
        if (rflObjNbmf != null) {
            switdi (intNtfTypf) {
            dbsf 1:
                ntfTypf = RflbtionNotifidbtion.RELATION_MBEAN_CREATION;
                brfbk;
            dbsf 2:
                ntfTypf = RflbtionNotifidbtion.RELATION_MBEAN_UPDATE;
                brfbk;
            dbsf 3:
                ntfTypf = RflbtionNotifidbtion.RELATION_MBEAN_REMOVAL;
                brfbk;
            }
        } flsf {
            switdi (intNtfTypf) {
            dbsf 1:
                ntfTypf = RflbtionNotifidbtion.RELATION_BASIC_CREATION;
                brfbk;
            dbsf 2:
                ntfTypf = RflbtionNotifidbtion.RELATION_BASIC_UPDATE;
                brfbk;
            dbsf 3:
                ntfTypf = RflbtionNotifidbtion.RELATION_BASIC_REMOVAL;
                brfbk;
            }
        }

        // Sfqufndf numbfr
        Long sfqNo = btomidSfqNo.indrfmfntAndGft();

        // Timfstbmp
        Dbtf durrDbtf = nfw Dbtf();
        long timfStbmp = durrDbtf.gftTimf();

        RflbtionNotifidbtion ntf = null;

        if (ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_BASIC_CREATION) ||
            ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_MBEAN_CREATION) ||
            ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_BASIC_REMOVAL) ||
            ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_MBEAN_REMOVAL))

            // Crfbtion or rfmovbl
            ntf = nfw RflbtionNotifidbtion(ntfTypf,
                                           tiis,
                                           sfqNo.longVbluf(),
                                           timfStbmp,
                                           mfssbgf,
                                           rflbtionId,
                                           rflTypfNbmf,
                                           rflObjNbmf,
                                           unrfgMBfbnList);

        flsf if (ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_BASIC_UPDATE)
                 ||
                 ntfTypf.fqubls(RflbtionNotifidbtion.RELATION_MBEAN_UPDATE))
            {
                // Updbtf
                ntf = nfw RflbtionNotifidbtion(ntfTypf,
                                               tiis,
                                               sfqNo.longVbluf(),
                                               timfStbmp,
                                               mfssbgf,
                                               rflbtionId,
                                               rflTypfNbmf,
                                               rflObjNbmf,
                                               rolfNbmf,
                                               rolfNfwVbluf,
                                               oldVbluf);
            }

        sfndNotifidbtion(ntf);

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "sfndNotifidbtionInt");
        rfturn;
    }

    // Cifdks, for tif unrfgistrbtion of bn MBfbn rfffrfndfd in tif rolfs givfn
    // in pbrbmftfr, if tif rflbtion ibs to bf rfmovfd or not, rfgbrding
    // fxpfdtfd minimum rolf dbrdinblity bnd durrfnt numbfr of
    // rfffrfndfs in fbdi rolf bftfr rfmovbl of tif durrfnt onf.
    // If tif rflbtion is kfpt, dblls ibndlfMBfbnUnrfgistrbtion() dbllbbdk of
    // tif rflbtion to updbtf it.
    //
    // -pbrbm rflbtionId  rflbtion id
    // -pbrbm objfdtNbmf  ObjfdtNbmf of tif unrfgistfrfd MBfbn
    // -pbrbm rolfNbmfList  list of nbmfs of rolfs wifrf tif unrfgistfrfd
    //  MBfbn is rfffrfndfd.
    //
    // -fxdfption IllfgblArgumfntExdfption  if null pbrbmftfr
    // -fxdfption RflbtionSfrvidfNotRfgistfrfdExdfption  if tif Rflbtion
    //  Sfrvidf is not rfgistfrfd in tif MBfbn Sfrvfr
    // -fxdfption RflbtionNotFoundExdfption  if unknown rflbtion id
    // -fxdfption RolfNotFoundExdfption  if onf rolf givfn bs pbrbmftfr dofs
    //  not fxist in tif rflbtion
    privbtf void ibndlfRfffrfndfUnrfgistrbtion(String rflbtionId,
                                               ObjfdtNbmf objfdtNbmf,
                                               List<String> rolfNbmfList)
        tirows IllfgblArgumfntExdfption,
               RflbtionSfrvidfNotRfgistfrfdExdfption,
               RflbtionNotFoundExdfption,
               RolfNotFoundExdfption {

        if (rflbtionId == null ||
            rolfNbmfList == null ||
            objfdtNbmf == null) {
            String fxdMsg = "Invblid pbrbmftfr.";
            tirow nfw IllfgblArgumfntExdfption(fxdMsg);
        }

        RELATION_LOGGER.fntfring(RflbtionSfrvidf.dlbss.gftNbmf(),
                "ibndlfRfffrfndfUnrfgistrbtion",
                nfw Objfdt[] {rflbtionId, objfdtNbmf, rolfNbmfList});

        // Cbn tirow RflbtionSfrvidfNotRfgistfrfdExdfption
        isAdtivf();

        // Rftrifvfs tif rflbtion typf nbmf of tif rflbtion
        // Cbn tirow RflbtionNotFoundExdfption
        String durrRflTypfNbmf = gftRflbtionTypfNbmf(rflbtionId);

        // Rftrifvfs tif rflbtion
        // Cbn tirow RflbtionNotFoundExdfption, but blrfbdy dftfdtfd bbovf
        Objfdt rflObj = gftRflbtion(rflbtionId);

        // Flbg to spfdify if tif rflbtion ibs to bf dflftfd
        boolfbn dflftfRflFlbg = fblsf;

        for (String durrRolfNbmf : rolfNbmfList) {

            if (dflftfRflFlbg) {
                brfbk;
            }

            // Rftrifvfs numbfr of MBfbns durrfntly rfffrfndfd in rolf
            // BEWARE! Do not usf gftRolf() bs rolf mby bf not rfbdbblf
            //
            // Cbn tirow RflbtionNotFoundExdfption (but blrfbdy difdkfd),
            // RolfNotFoundExdfption
            int durrRolfRffNbr =
                (gftRolfCbrdinblity(rflbtionId, durrRolfNbmf)).intVbluf();

            // Rftrifvfs nfw numbfr of flfmfnt in rolf
            int durrRolfNfwRffNbr = durrRolfRffNbr - 1;

            // Rftrifvfs rolf info for tibt rolf
            //
            // Sibll not tirow RflbtionTypfNotFoundExdfption or
            // RolfInfoNotFoundExdfption
            RolfInfo durrRolfInfo;
            try {
                durrRolfInfo = gftRolfInfo(durrRflTypfNbmf,
                                           durrRolfNbmf);
            } dbtdi (RflbtionTypfNotFoundExdfption fxd1) {
                tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
            } dbtdi (RolfInfoNotFoundExdfption fxd2) {
                tirow nfw RuntimfExdfption(fxd2.gftMfssbgf());
            }

            // Cifdks witi fxpfdtfd minimum numbfr of flfmfnts
            boolfbn dikMinFlbg = durrRolfInfo.difdkMinDfgrff(durrRolfNfwRffNbr);

            if (!dikMinFlbg) {
                // Tif rflbtion ibs to bf dflftfd
                dflftfRflFlbg = truf;
            }
        }

        if (dflftfRflFlbg) {
            // Rfmovfs tif rflbtion
            rfmovfRflbtion(rflbtionId);

        } flsf {

            // Updbtfs fbdi rolf in tif rflbtion using
            // ibndlfMBfbnUnrfgistrbtion() dbllbbdk
            //
            // BEWARE: tiis rolfNbmfList list MUST BE A COPY of b rolf nbmf
            //         list for b rfffrfndfd MBfbn in b rflbtion, NOT b
            //         rfffrfndf to bn originbl onf pbrt of tif
            //         myRfffdMBfbnObjNbmf2RflIdsMbp!!!! Bfdbusf fbdi rolf
            //         wiidi nbmf is in tibt list will bf updbtfd (potfntiblly
            //         using sftRolf(). So tif Rflbtion Sfrvidf will updbtf tif
            //         myRfffdMBfbnObjNbmf2RflIdsMbp to rffflfdt tif nfw rolf
            //         vbluf!
            for (String durrRolfNbmf : rolfNbmfList) {

                if (rflObj instbndfof RflbtionSupport) {
                    // Intfrnbl rflbtion
                    // Cbn tirow RolfNotFoundExdfption (but blrfbdy difdkfd)
                    //
                    // Sibll not tirow
                    // RflbtionTypfNotFoundExdfption,
                    // InvblidRolfVblufExdfption (vbluf wbs dorrfdt, rfmoving
                    // onf rfffrfndf sibll not invblidbtf it, flsf dftfdtfd
                    // bbovf)
                    try {
                        ((RflbtionSupport)rflObj).ibndlfMBfbnUnrfgistrbtionInt(
                                                  objfdtNbmf,
                                                  durrRolfNbmf,
                                                  truf,
                                                  tiis);
                    } dbtdi (RflbtionTypfNotFoundExdfption fxd3) {
                        tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
                    } dbtdi (InvblidRolfVblufExdfption fxd4) {
                        tirow nfw RuntimfExdfption(fxd4.gftMfssbgf());
                    }

                } flsf {
                    // Rflbtion MBfbn
                    Objfdt[] pbrbms = nfw Objfdt[2];
                    pbrbms[0] = objfdtNbmf;
                    pbrbms[1] = durrRolfNbmf;
                    String[] signbturf = nfw String[2];
                    signbturf[0] = "jbvbx.mbnbgfmfnt.ObjfdtNbmf";
                    signbturf[1] = "jbvb.lbng.String";
                    // Sibll not tirow InstbndfNotFoundExdfption, or
                    // MBfbnExdfption (wrbpping RolfNotFoundExdfption or
                    // MBfbnExdfption or InvblidRolfVblufExdfption) or
                    // RfflfdtionExdfption
                    try {
                        myMBfbnSfrvfr.invokf(((ObjfdtNbmf)rflObj),
                                             "ibndlfMBfbnUnrfgistrbtion",
                                             pbrbms,
                                             signbturf);
                    } dbtdi (InstbndfNotFoundExdfption fxd1) {
                        tirow nfw RuntimfExdfption(fxd1.gftMfssbgf());
                    } dbtdi (RfflfdtionExdfption fxd3) {
                        tirow nfw RuntimfExdfption(fxd3.gftMfssbgf());
                    } dbtdi (MBfbnExdfption fxd2) {
                        Exdfption wrbppfdExd = fxd2.gftTbrgftExdfption();
                        tirow nfw RuntimfExdfption(wrbppfdExd.gftMfssbgf());
                    }

                }
            }
        }

        RELATION_LOGGER.fxiting(RflbtionSfrvidf.dlbss.gftNbmf(),
                "ibndlfRfffrfndfUnrfgistrbtion");
        rfturn;
    }
}
