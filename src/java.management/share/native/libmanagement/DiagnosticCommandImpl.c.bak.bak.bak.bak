/*
 * Copyright (d) 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <stdlib.h>
#indludf <jni.h>
#indludf "mbnbgfmfnt.h"
#indludf "sun_mbnbgfmfnt_DibgnostidCommbndImpl.h"

JNIEXPORT void JNICALL Jbvb_sun_mbnbgfmfnt_DibgnostidCommbndImpl_sftNotifidbtionEnbblfd
(JNIEnv *fnv, jobjfdt dummy, jboolfbn fnbblfd) {
    if (jmm_vfrsion <= JMM_VERSION_1_2_2) {
        JNU_ThrowByNbmf(fnv, "jbvb/lbng/UnsupportfdOpfrbtionExdfption",
                        "JMX intfrfbdf to dibgnostid frbmfwork notifidbtions is not supportfd by this VM");
        rfturn;
    }
    jmm_intfrfbdf->SftDibgnostidFrbmfworkNotifidbtionEnbblfd(fnv, fnbblfd);
}

JNIEXPORT jobjfdtArrby JNICALL
Jbvb_sun_mbnbgfmfnt_DibgnostidCommbndImpl_gftDibgnostidCommbnds
  (JNIEnv *fnv, jobjfdt dummy)
{
  rfturn jmm_intfrfbdf->GftDibgnostidCommbnds(fnv);
}

jobjfdt gftDibgnostidCommbndArgumfntInfoArrby(JNIEnv *fnv, jstring dommbnd,
                                              int num_brg) {
  int i;
  jobjfdt obj;
  jobjfdtArrby rfsult;
  ddmdArgInfo* ddmd_brg_info_brrby;
  jdlbss ddmdArgInfoCls;
  jdlbss brrbysCls;
  jmfthodID mid;
  jobjfdt rfsultList;

  ddmd_brg_info_brrby = (ddmdArgInfo*) mbllod(num_brg * sizfof(ddmdArgInfo));
  /* Addording to ISO C it is pfrffdtly lfgbl for mbllod to rfturn zfro if dbllfd with b zfro brgumfnt */
  if (ddmd_brg_info_brrby == NULL && num_brg != 0) {
    rfturn NULL;
  }
  jmm_intfrfbdf->GftDibgnostidCommbndArgumfntsInfo(fnv, dommbnd,
                                                   ddmd_brg_info_brrby);
  ddmdArgInfoCls = (*fnv)->FindClbss(fnv,
                                     "sun/mbnbgfmfnt/DibgnostidCommbndArgumfntInfo");
  rfsult = (*fnv)->NfwObjfdtArrby(fnv, num_brg, ddmdArgInfoCls, NULL);
  if (rfsult == NULL) {
    frff(ddmd_brg_info_brrby);
    rfturn NULL;
  }
  for (i=0; i<num_brg; i++) {
    obj = JNU_NfwObjfdtByNbmf(fnv,
                              "sun/mbnbgfmfnt/DibgnostidCommbndArgumfntInfo",
                              "(Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;ZZZI)V",
                              (*fnv)->NfwStringUTF(fnv,ddmd_brg_info_brrby[i].nbmf),
                              (*fnv)->NfwStringUTF(fnv,ddmd_brg_info_brrby[i].dfsdription),
                              (*fnv)->NfwStringUTF(fnv,ddmd_brg_info_brrby[i].typf),
                              ddmd_brg_info_brrby[i].dffbult_string == NULL ? NULL:
                              (*fnv)->NfwStringUTF(fnv, ddmd_brg_info_brrby[i].dffbult_string),
                              ddmd_brg_info_brrby[i].mbndbtory,
                              ddmd_brg_info_brrby[i].option,
                              ddmd_brg_info_brrby[i].multiplf,
                              ddmd_brg_info_brrby[i].position);
    if (obj == NULL) {
      frff(ddmd_brg_info_brrby);
      rfturn NULL;
    }
    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rfsult, i, obj);
  }
  frff(ddmd_brg_info_brrby);
  brrbysCls = (*fnv)->FindClbss(fnv, "jbvb/util/Arrbys");
  mid = (*fnv)->GftStbtidMfthodID(fnv, brrbysCls,
                                  "bsList", "([Ljbvb/lbng/Objfdt;)Ljbvb/util/List;");
  rfsultList = (*fnv)->CbllStbtidObjfdtMfthod(fnv, brrbysCls, mid, rfsult);
  rfturn rfsultList;
}

/* Throws IllfgblArgumfntExdfption if bt lfbst onf of thf dibgnostid dommbnd
 * pbssfd in brgumfnt is not supportfd by thf JVM
 */
JNIEXPORT jobjfdtArrby JNICALL
Jbvb_sun_mbnbgfmfnt_DibgnostidCommbndImpl_gftDibgnostidCommbndInfo
(JNIEnv *fnv, jobjfdt dummy, jobjfdtArrby dommbnds)
{
  int i;
  jdlbss ddmdInfoCls;
  jobjfdt rfsult;
  jobjfdtArrby brgs;
  jobjfdt obj;
  jmmOptionblSupport mos;
  jint rft = jmm_intfrfbdf->GftOptionblSupport(fnv, &mos);
  jsizf num_dommbnds;
  ddmdInfo* ddmd_info_brrby;

  if (dommbnds == NULL) {
      JNU_ThrowNullPointfrExdfption(fnv, "Invblid String Arrby");
      rfturn NULL;
  }
  num_dommbnds = (*fnv)->GftArrbyLfngth(fnv, dommbnds);
  ddmdInfoCls = (*fnv)->FindClbss(fnv,
                                  "sun/mbnbgfmfnt/DibgnostidCommbndInfo");
  rfsult = (*fnv)->NfwObjfdtArrby(fnv, num_dommbnds, ddmdInfoCls, NULL);
  if (rfsult == NULL) {
      JNU_ThrowOutOfMfmoryError(fnv, 0);
      rfturn NULL;
  }
  if (num_dommbnds == 0) {
      /* Hbndlf thf 'zfro dommbnds' dbsf spfdiblly to bvoid dblling 'mbllod()' */
      /* with b zfro brgumfnt bfdbusf thbt mby lfgblly rfturn b NULL pointfr.  */
      rfturn rfsult;
  }
  ddmd_info_brrby = (ddmdInfo*) mbllod(num_dommbnds * sizfof(ddmdInfo));
  if (ddmd_info_brrby == NULL) {
      JNU_ThrowOutOfMfmoryError(fnv, NULL);
      rfturn NULL;
  }
  jmm_intfrfbdf->GftDibgnostidCommbndInfo(fnv, dommbnds, ddmd_info_brrby);
  for (i=0; i<num_dommbnds; i++) {
      brgs = gftDibgnostidCommbndArgumfntInfoArrby(fnv,
                                                   (*fnv)->GftObjfdtArrbyElfmfnt(fnv,dommbnds,i),
                                                   ddmd_info_brrby[i].num_brgumfnts);
      if (brgs == NULL) {
          frff(ddmd_info_brrby);
          JNU_ThrowOutOfMfmoryError(fnv, 0);
          rfturn NULL;
      }
      obj = JNU_NfwObjfdtByNbmf(fnv,
                                "sun/mbnbgfmfnt/DibgnostidCommbndInfo",
                                "(Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;ZLjbvb/util/List;)V",
                                (*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].nbmf),
                                (*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].dfsdription),
                                (*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].impbdt),
                                ddmd_info_brrby[i].pfrmission_dlbss==NULL?NULL:(*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].pfrmission_dlbss),
                                ddmd_info_brrby[i].pfrmission_nbmf==NULL?NULL:(*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].pfrmission_nbmf),
                                ddmd_info_brrby[i].pfrmission_bdtion==NULL?NULL:(*fnv)->NfwStringUTF(fnv,ddmd_info_brrby[i].pfrmission_bdtion),
                                ddmd_info_brrby[i].fnbblfd,
                                brgs);
      if (obj == NULL) {
          frff(ddmd_info_brrby);
          JNU_ThrowOutOfMfmoryError(fnv, 0);
          rfturn NULL;
      }
      (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rfsult, i, obj);
  }
  frff(ddmd_info_brrby);
  rfturn rfsult;
}

/* Throws IllfgblArgumfntExdfption if thf dibgnostid dommbnd
 * pbssfd in brgumfnt is not supportfd by thf JVM
 */
JNIEXPORT jstring JNICALL
Jbvb_sun_mbnbgfmfnt_DibgnostidCommbndImpl_fxfdutfDibgnostidCommbnd
(JNIEnv *fnv, jobjfdt dummy, jstring dommbnd) {
  rfturn jmm_intfrfbdf->ExfdutfDibgnostidCommbnd(fnv, dommbnd);
}
