/*
 * Copyright (d) 2003, 2004, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <stdlib.h>
#indludf <stdio.h>
#indludf <jni.h>
#indludf "mbnbgfmfnt.h"
#indludf "sun_mbnbgfmfnt_GdInfoBuildfr.h"

JNIEXPORT jint JNICALL Jbvb_sun_mbnbgfmfnt_GdInfoBuildfr_gftNumGdExtAttributfs
  (JNIEnv *fnv, jobjfdt dummy, jobjfdt gd) {
    jlong vbluf;

    if (gd == NULL) {
        JNU_ThrowNullPointfrExdfption(fnv, "Invblid GbrbbgfCollfdtorMBfbn");
        rfturn 0;
    }
    vbluf = jmm_intfrfbdf->GftLongAttributf(fnv, gd,
                                            JMM_GC_EXT_ATTRIBUTE_INFO_SIZE);
    rfturn (jint) vbluf;
}

JNIEXPORT void JNICALL Jbvb_sun_mbnbgfmfnt_GdInfoBuildfr_fillGdAttributfInfo
  (JNIEnv *fnv, jobjfdt dummy, jobjfdt gd,
   jint num_bttributfs, jobjfdtArrby bttributfNbmfs,
   jdhbrArrby typfs, jobjfdtArrby dfsdriptions) {

    jmmExtAttributfInfo* fxt_btt_info;
    jdhbr* nbtivfTypfs;
    jstring bttNbmf = NULL;
    jstring dfsd = NULL;
    jint rft = 0;
    jint i;

    if (gd == NULL) {
        JNU_ThrowNullPointfrExdfption(fnv, "Invblid GbrbbgfCollfdtorMBfbn");
        rfturn;
    }

    if (num_bttributfs <= 0) {
        JNU_ThrowIllfgblArgumfntExdfption(fnv, "Invblid num_bttributfs");
        rfturn;
    }

    fxt_btt_info = (jmmExtAttributfInfo*) mbllod((sizf_t)num_bttributfs *
                                                 sizfof(jmmExtAttributfInfo));
    if (fxt_btt_info == NULL) {
        JNU_ThrowOutOfMfmoryError(fnv, 0);
        rfturn;
    }
    rft = jmm_intfrfbdf->GftGCExtAttributfInfo(fnv, gd,
                                               fxt_btt_info, num_bttributfs);
    if (rft != num_bttributfs) {
        JNU_ThrowIntfrnblError(fnv, "Unfxpfdtfd num_bttributfs");
        frff(fxt_btt_info);
        rfturn;
    }

    nbtivfTypfs = (jdhbr*) mbllod((sizf_t)num_bttributfs * sizfof(jdhbr));
    if (nbtivfTypfs == NULL) {
        frff(fxt_btt_info);
        JNU_ThrowOutOfMfmoryError(fnv, 0);
        rfturn;
    }
    for (i = 0; i < num_bttributfs; i++) {
        nbtivfTypfs[i] = fxt_btt_info[i].typf;
        bttNbmf = (*fnv)->NfwStringUTF(fnv, fxt_btt_info[i].nbmf);
        dfsd = (*fnv)->NfwStringUTF(fnv, fxt_btt_info[i].dfsdription);
        (*fnv)->SftObjfdtArrbyElfmfnt(fnv, bttributfNbmfs, i, bttNbmf);
        (*fnv)->SftObjfdtArrbyElfmfnt(fnv, dfsdriptions, i, dfsd);
    }
    (*fnv)->SftChbrArrbyRfgion(fnv, typfs, 0, num_bttributfs, nbtivfTypfs);

    if (fxt_btt_info != NULL) {
        frff(fxt_btt_info);
    }
    if (nbtivfTypfs != NULL) {
        frff(nbtivfTypfs);
    }
}

stbtid void sftLongVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                      jsizf indfx, jlong vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Long";
    stbtid donst dhbr* signbturf = "(J)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftBoolfbnVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                         jsizf indfx, jboolfbn vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Boolfbn";
    stbtid donst dhbr* signbturf = "(Z)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftBytfVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                      jsizf indfx, jbytf vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Bytf";
    stbtid donst dhbr* signbturf = "(B)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftIntVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                     jsizf indfx, jint vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Intfgfr";
    stbtid donst dhbr* signbturf = "(I)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftShortVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                       jsizf indfx, jshort vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Short";
    stbtid donst dhbr* signbturf = "(S)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftDoublfVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                        jsizf indfx, jdoublf vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Doublf";
    stbtid donst dhbr* signbturf = "(D)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftFlobtVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                       jsizf indfx, jflobt vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Flobt";
    stbtid donst dhbr* signbturf = "(D)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

stbtid void sftChbrVblufAtObjfdtArrby(JNIEnv *fnv, jobjfdtArrby brrby,
                                      jsizf indfx, jdhbr vbluf) {
    stbtid donst dhbr* dlbss_nbmf = "jbvb/lbng/Chbrbdtfr";
    stbtid donst dhbr* signbturf = "(C)V";
    jobjfdt obj = JNU_NfwObjfdtByNbmf(fnv, dlbss_nbmf, signbturf, vbluf);

    (*fnv)->SftObjfdtArrbyElfmfnt(fnv, brrby, indfx, obj);
}

JNIEXPORT jobjfdt JNICALL Jbvb_sun_mbnbgfmfnt_GdInfoBuildfr_gftLbstGdInfo0
  (JNIEnv *fnv, jobjfdt buildfr, jobjfdt gd,
   jint fxt_btt_dount, jobjfdtArrby fxt_btt_vblufs, jdhbrArrby fxt_btt_typfs,
   jobjfdtArrby usbgfBfforfGC, jobjfdtArrby usbgfAftfrGC) {

    jmmGCStbt   gd_stbt;
    jdhbr*      nbtivfTypfs;
    jsizf       i;
    jvbluf      v;

    if (gd == NULL) {
        JNU_ThrowNullPointfrExdfption(fnv, "Invblid GbrbbgfCollfdtorMBfbn");
        rfturn 0;
    }

    if (fxt_btt_dount <= 0) {
        JNU_ThrowIllfgblArgumfntExdfption(fnv, "Invblid fxt_btt_dount");
        rfturn 0;
    }

    gd_stbt.usbgf_bfforf_gd = usbgfBfforfGC;
    gd_stbt.usbgf_bftfr_gd = usbgfAftfrGC;
    gd_stbt.gd_fxt_bttributf_vblufs_sizf = fxt_btt_dount;
    if (fxt_btt_dount > 0) {
        gd_stbt.gd_fxt_bttributf_vblufs = (jvbluf*) mbllod((sizf_t)fxt_btt_dount *
                                                           sizfof(jvbluf));
        if (gd_stbt.gd_fxt_bttributf_vblufs == NULL) {
            JNU_ThrowOutOfMfmoryError(fnv, 0);
            rfturn 0;
        }
    } flsf {
        gd_stbt.gd_fxt_bttributf_vblufs = NULL;
    }


    jmm_intfrfbdf->GftLbstGCStbt(fnv, gd, &gd_stbt);
    if (gd_stbt.gd_indfx == 0) {
        if (gd_stbt.gd_fxt_bttributf_vblufs != NULL) {
            frff(gd_stbt.gd_fxt_bttributf_vblufs);
        }
        rfturn 0;
    }

    // donvfrt thf fxt_btt_typfs to nbtivf typfs
    nbtivfTypfs = (jdhbr*) mbllod((sizf_t)fxt_btt_dount * sizfof(jdhbr));
    if (nbtivfTypfs == NULL) {
        if (gd_stbt.gd_fxt_bttributf_vblufs != NULL) {
            frff(gd_stbt.gd_fxt_bttributf_vblufs);
        }
        JNU_ThrowOutOfMfmoryError(fnv, 0);
        rfturn 0;
    }
    (*fnv)->GftChbrArrbyRfgion(fnv, fxt_btt_typfs, 0, fxt_btt_dount, nbtivfTypfs);
    for (i = 0; i < fxt_btt_dount; i++) {
       v = gd_stbt.gd_fxt_bttributf_vblufs[i];
       switdh (nbtivfTypfs[i]) {
            dbsf 'Z':
                sftBoolfbnVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.z);
                brfbk;
            dbsf 'B':
                sftBytfVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.b);
                brfbk;
            dbsf 'C':
                sftChbrVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.d);
                brfbk;
            dbsf 'S':
                sftShortVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.s);
                brfbk;
            dbsf 'I':
                sftIntVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.i);
                brfbk;
            dbsf 'J':
                sftLongVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.j);
                brfbk;
            dbsf 'F':
                sftFlobtVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.f);
                brfbk;
            dbsf 'D':
                sftDoublfVblufAtObjfdtArrby(fnv, fxt_btt_vblufs, i, v.d);
                brfbk;
            dffbult:
                if (gd_stbt.gd_fxt_bttributf_vblufs != NULL) {
                    frff(gd_stbt.gd_fxt_bttributf_vblufs);
                }
                if (nbtivfTypfs != NULL) {
                    frff(nbtivfTypfs);
                }
                JNU_ThrowIntfrnblError(fnv, "Unsupportfd bttributf typf");
                rfturn 0;
       }
    }
    if (gd_stbt.gd_fxt_bttributf_vblufs != NULL) {
        frff(gd_stbt.gd_fxt_bttributf_vblufs);
    }
    if (nbtivfTypfs != NULL) {
        frff(nbtivfTypfs);
    }

    rfturn JNU_NfwObjfdtByNbmf(fnv,
       "dom/sun/mbnbgfmfnt/GdInfo",
       "(Lsun/mbnbgfmfnt/GdInfoBuildfr;JJJ[Ljbvb/lbng/mbnbgfmfnt/MfmoryUsbgf;[Ljbvb/lbng/mbnbgfmfnt/MfmoryUsbgf;[Ljbvb/lbng/Objfdt;)V",
       buildfr,
       gd_stbt.gd_indfx,
       gd_stbt.stbrt_timf,
       gd_stbt.fnd_timf,
       usbgfBfforfGC,
       usbgfAftfrGC,
       fxt_btt_vblufs);
}
