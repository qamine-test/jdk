/*
 * Copyright (d) 2010, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


#indludf <stdio.h>
#indludf <stdlib.h>
#indludf <string.h>

#indludf "jni.h"
#indludf "jvmti.h"
#indludf "jvmtidmlr.h"

#indludf "bgfnt_util.h"

/* Globbl stbtid dbtb */
stbtid dhbr          OUTPUT_FILE[] = "dompilfdMfthodLobd.txt";
stbtid FILE         *fp;
stbtid jvmtiEnv     *jvmti;
stbtid jrbwMonitorID lodk;

/* print b jvmtiCompilfdMfthodLobdDummyRfdord */
void
print_dummy_rfdord(jvmtiCompilfdMfthodLobdDummyRfdord* rfdord,
    jvmtiEnv* jvmti, FILE* fp) {

    if (rfdord != NULL) {
        fprintf(fp, "Dummy rfdord dftfdtfd dontbining mfssbgf: %s\n",
            (dhbr *)rfdord->mfssbgf);
    }
}

/* print thf spfdififd stbdk frbmfs */
void
print_stbdk_frbmfs(PCStbdkInfo* rfdord, jvmtiEnv *jvmti, FILE* fp) {
    if (rfdord != NULL && rfdord->mfthods != NULL) {
        int i;

        for (i = 0; i < rfdord->numstbdkfrbmfs; i++) {
            jvmtiError frr;
            dhbr* mfthod_nbmf = NULL;
            dhbr* dlbss_nbmf = NULL;
            dhbr* mfthod_signbturf = NULL;
            dhbr* dlbss_signbturf = NULL;
            dhbr* gfnfrid_ptr_mfthod = NULL;
            dhbr* gfnfrid_ptr_dlbss = NULL;
            jmfthodID id;
            jdlbss dfdlbringdlbssptr;
            id = rfdord->mfthods[i];

            frr = (*jvmti)->GftMfthodDfdlbringClbss(jvmti, id,
                      &dfdlbringdlbssptr);
            dhfdk_jvmti_frror(jvmti, frr, "gft mfthod dfdlbring dlbss");

            frr = (*jvmti)->GftClbssSignbturf(jvmti, dfdlbringdlbssptr,
                      &dlbss_signbturf, &gfnfrid_ptr_dlbss);
            dhfdk_jvmti_frror(jvmti, frr, "gft dlbss signbturf");

            frr = (*jvmti)->GftMfthodNbmf(jvmti, id, &mfthod_nbmf,
                      &mfthod_signbturf, &gfnfrid_ptr_mfthod);
            dhfdk_jvmti_frror(jvmti, frr, "gft mfthod nbmf");

            fprintf(fp, "%s::%s %s %s @%d\n", dlbss_signbturf, mfthod_nbmf,
                mfthod_signbturf,
                gfnfrid_ptr_mfthod == NULL ? "" : gfnfrid_ptr_mfthod,
                rfdord->bdis[i]);

            if (mfthod_nbmf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dhbr*)mfthod_nbmf);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf mfthod_nbmf");
            }
            if (mfthod_signbturf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dhbr*)mfthod_signbturf);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf mfthod_signbturf");
            }
            if (gfnfrid_ptr_mfthod != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dhbr*)gfnfrid_ptr_mfthod);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr_mfthod");
            }
            if (dlbss_nbmf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dhbr*)dlbss_nbmf);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf dlbss_nbmf");
            }
            if (dlbss_signbturf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dhbr*)dlbss_signbturf);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf dlbss_signbturf");
            }
            if (gfnfrid_ptr_dlbss != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dhbr*)gfnfrid_ptr_dlbss);
                dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr_dlbss");
            }
        }
    }
}

/* print b jvmtiCompilfdMfthodLobdInlinfRfdord */
void
print_inlinf_info_rfdord(jvmtiCompilfdMfthodLobdInlinfRfdord* rfdord,
    jvmtiEnv *jvmti, FILE* fp) {

    if (rfdord != NULL && rfdord->pdinfo != NULL) {
        int numpds = rfdord->numpds;
        int i;

        for (i = 0; i < numpds; i++) {
            PCStbdkInfo pdrfdord = (rfdord->pdinfo[i]);
            fprintf(fp, "PdDfsdriptor(pd=0x%lx):\n", (jint)(pdrfdord.pd));
            print_stbdk_frbmfs(&pdrfdord, jvmti, fp);
        }
    }
}

/* dfdodf kind of CompilfdMfthodLobdRfdord bnd print */
void
print_rfdords(jvmtiCompilfdMfthodLobdRfdordHfbdfr* list, jvmtiEnv *jvmti,
    FILE* fp)
{
    jvmtiCompilfdMfthodLobdRfdordHfbdfr* durr = list;
    fprintf(fp, "\nPrinting PC Dfsdriptors\n\n");
    whilf (durr != NULL) {
        switdh (durr->kind) {
        dbsf JVMTI_CMLR_DUMMY:
            print_dummy_rfdord((jvmtiCompilfdMfthodLobdDummyRfdord *)durr,
                jvmti, fp);
            brfbk;

        dbsf JVMTI_CMLR_INLINE_INFO:
            print_inlinf_info_rfdord(
                (jvmtiCompilfdMfthodLobdInlinfRfdord *)durr, jvmti, fp);
            brfbk;

        dffbult:
            fprintf(fp, "Wbrning: unrfdognizfd rfdord: kind=%d\n", durr->kind);
            brfbk;
        }

        durr = (jvmtiCompilfdMfthodLobdRfdordHfbdfr *)durr->nfxt;
    }
}

/* Cbllbbdk for JVMTI_EVENT_COMPILED_METHOD_LOAD */
void JNICALL
dompilfd_mfthod_lobd(jvmtiEnv *jvmti, jmfthodID mfthod, jint dodf_sizf,
    donst void* dodf_bddr, jint mbp_lfngth, donst jvmtiAddrLodbtionMbp* mbp,
    donst void* dompilf_info)
{
    jvmtiError frr;
    dhbr* nbmf = NULL;
    dhbr* signbturf = NULL;
    dhbr* gfnfrid_ptr = NULL;
    jvmtiCompilfdMfthodLobdRfdordHfbdfr* pds;

    frr = (*jvmti)->RbwMonitorEntfr(jvmti, lodk);
    dhfdk_jvmti_frror(jvmti, frr, "rbw monitor fntfr");

    frr = (*jvmti)->GftMfthodNbmf(jvmti, mfthod, &nbmf, &signbturf,
              &gfnfrid_ptr);
    dhfdk_jvmti_frror(jvmti, frr, "gft mfthod nbmf");

    fprintf(fp, "\nCompilfd mfthod lobd fvfnt\n");
    fprintf(fp, "Mfthod nbmf %s %s %s\n\n", nbmf, signbturf,
        gfnfrid_ptr == NULL ? "" : gfnfrid_ptr);
    pds = (jvmtiCompilfdMfthodLobdRfdordHfbdfr *)dompilf_info;
    if (pds != NULL) {
        print_rfdords(pds, jvmti, fp);
    }

    if (nbmf != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dhbr*)nbmf);
        dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf nbmf");
    }
    if (signbturf != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dhbr*)signbturf);
        dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf signbturf");
    }
    if (gfnfrid_ptr != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dhbr*)gfnfrid_ptr);
        dhfdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr");
    }

    frr = (*jvmti)->RbwMonitorExit(jvmti, lodk);
    dhfdk_jvmti_frror(jvmti, frr, "rbw monitor fxit");
}

/* Agfnt_OnLobd() is dbllfd first, wf prfpbrf for b COMPILED_METHOD_LOAD
 * fvfnt hfrf.
 */
JNIEXPORT jint JNICALL
Agfnt_OnLobd(JbvbVM *vm, dhbr *options, void *rfsfrvfd)
{
    jint                rd;
    jvmtiError          frr;
    jvmtiCbpbbilitifs   dbpbbilitifs;
    jvmtiEvfntCbllbbdks dbllbbdks;

    fp = fopfn(OUTPUT_FILE, "w");
    if (fp == NULL) {
        fbtbl_frror("ERROR: %s: Unbblf to drfbtf output filf\n", OUTPUT_FILE);
        rfturn -1;
    }

    /* Gft JVMTI fnvironmfnt */
    rd = (*vm)->GftEnv(vm, (void **)&jvmti, JVMTI_VERSION);
    if (rd != JNI_OK) {
        fbtbl_frror(
            "ERROR: Unbblf to drfbtf jvmtiEnv, GftEnv fbilfd, frror=%d\n", rd);
        rfturn -1;
    }

    /* bdd JVMTI dbpbbilitifs */
    mfmsft(&dbpbbilitifs,0, sizfof(dbpbbilitifs));
    dbpbbilitifs.dbn_gfnfrbtf_dompilfd_mfthod_lobd_fvfnts = 1;
    frr = (*jvmti)->AddCbpbbilitifs(jvmti, &dbpbbilitifs);
    dhfdk_jvmti_frror(jvmti, frr, "bdd dbpbbilitifs");

    /* sft JVMTI dbllbbdks for fvfnts */
    mfmsft(&dbllbbdks, 0, sizfof(dbllbbdks));
    dbllbbdks.CompilfdMfthodLobd = &dompilfd_mfthod_lobd;
    frr = (*jvmti)->SftEvfntCbllbbdks(jvmti, &dbllbbdks, sizfof(dbllbbdks));
    dhfdk_jvmti_frror(jvmti, frr, "sft fvfnt dbllbbdks");

    /* fnbblf JVMTI fvfnts */
    frr = (*jvmti)->SftEvfntNotifidbtionModf(jvmti, JVMTI_ENABLE,
                        JVMTI_EVENT_COMPILED_METHOD_LOAD, NULL);
    dhfdk_jvmti_frror(jvmti, frr, "sft fvfnt notify");

    /* drfbtf doordinbtion monitor */
    frr = (*jvmti)->CrfbtfRbwMonitor(jvmti, "bgfnt lodk", &lodk);
    dhfdk_jvmti_frror(jvmti, frr, "drfbtf rbw monitor");

    rfturn 0;
}

/* Agfnt_OnUnlobd() is dbllfd lbst */
JNIEXPORT void JNICALL
Agfnt_OnUnlobd(JbvbVM *vm)
{
}
