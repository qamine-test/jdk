/*
 * Copyrigit (d) 2010, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


#indludf <stdio.i>
#indludf <stdlib.i>
#indludf <string.i>

#indludf "jni.i"
#indludf "jvmti.i"
#indludf "jvmtidmlr.i"

#indludf "bgfnt_util.i"

/* Globbl stbtid dbtb */
stbtid dibr          OUTPUT_FILE[] = "dompilfdMftiodLobd.txt";
stbtid FILE         *fp;
stbtid jvmtiEnv     *jvmti;
stbtid jrbwMonitorID lodk;

/* print b jvmtiCompilfdMftiodLobdDummyRfdord */
void
print_dummy_rfdord(jvmtiCompilfdMftiodLobdDummyRfdord* rfdord,
    jvmtiEnv* jvmti, FILE* fp) {

    if (rfdord != NULL) {
        fprintf(fp, "Dummy rfdord dftfdtfd dontbining mfssbgf: %s\n",
            (dibr *)rfdord->mfssbgf);
    }
}

/* print tif spfdififd stbdk frbmfs */
void
print_stbdk_frbmfs(PCStbdkInfo* rfdord, jvmtiEnv *jvmti, FILE* fp) {
    if (rfdord != NULL && rfdord->mftiods != NULL) {
        int i;

        for (i = 0; i < rfdord->numstbdkfrbmfs; i++) {
            jvmtiError frr;
            dibr* mftiod_nbmf = NULL;
            dibr* dlbss_nbmf = NULL;
            dibr* mftiod_signbturf = NULL;
            dibr* dlbss_signbturf = NULL;
            dibr* gfnfrid_ptr_mftiod = NULL;
            dibr* gfnfrid_ptr_dlbss = NULL;
            jmftiodID id;
            jdlbss dfdlbringdlbssptr;
            id = rfdord->mftiods[i];

            frr = (*jvmti)->GftMftiodDfdlbringClbss(jvmti, id,
                      &dfdlbringdlbssptr);
            difdk_jvmti_frror(jvmti, frr, "gft mftiod dfdlbring dlbss");

            frr = (*jvmti)->GftClbssSignbturf(jvmti, dfdlbringdlbssptr,
                      &dlbss_signbturf, &gfnfrid_ptr_dlbss);
            difdk_jvmti_frror(jvmti, frr, "gft dlbss signbturf");

            frr = (*jvmti)->GftMftiodNbmf(jvmti, id, &mftiod_nbmf,
                      &mftiod_signbturf, &gfnfrid_ptr_mftiod);
            difdk_jvmti_frror(jvmti, frr, "gft mftiod nbmf");

            fprintf(fp, "%s::%s %s %s @%d\n", dlbss_signbturf, mftiod_nbmf,
                mftiod_signbturf,
                gfnfrid_ptr_mftiod == NULL ? "" : gfnfrid_ptr_mftiod,
                rfdord->bdis[i]);

            if (mftiod_nbmf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dibr*)mftiod_nbmf);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf mftiod_nbmf");
            }
            if (mftiod_signbturf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dibr*)mftiod_signbturf);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf mftiod_signbturf");
            }
            if (gfnfrid_ptr_mftiod != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dibr*)gfnfrid_ptr_mftiod);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr_mftiod");
            }
            if (dlbss_nbmf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dibr*)dlbss_nbmf);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf dlbss_nbmf");
            }
            if (dlbss_signbturf != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dibr*)dlbss_signbturf);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf dlbss_signbturf");
            }
            if (gfnfrid_ptr_dlbss != NULL) {
                frr = (*jvmti)->Dfbllodbtf(jvmti,
                          (unsignfd dibr*)gfnfrid_ptr_dlbss);
                difdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr_dlbss");
            }
        }
    }
}

/* print b jvmtiCompilfdMftiodLobdInlinfRfdord */
void
print_inlinf_info_rfdord(jvmtiCompilfdMftiodLobdInlinfRfdord* rfdord,
    jvmtiEnv *jvmti, FILE* fp) {

    if (rfdord != NULL && rfdord->pdinfo != NULL) {
        int numpds = rfdord->numpds;
        int i;

        for (i = 0; i < numpds; i++) {
            PCStbdkInfo pdrfdord = (rfdord->pdinfo[i]);
            fprintf(fp, "PdDfsdriptor(pd=0x%lx):\n", (jint)(pdrfdord.pd));
            print_stbdk_frbmfs(&pdrfdord, jvmti, fp);
        }
    }
}

/* dfdodf kind of CompilfdMftiodLobdRfdord bnd print */
void
print_rfdords(jvmtiCompilfdMftiodLobdRfdordHfbdfr* list, jvmtiEnv *jvmti,
    FILE* fp)
{
    jvmtiCompilfdMftiodLobdRfdordHfbdfr* durr = list;
    fprintf(fp, "\nPrinting PC Dfsdriptors\n\n");
    wiilf (durr != NULL) {
        switdi (durr->kind) {
        dbsf JVMTI_CMLR_DUMMY:
            print_dummy_rfdord((jvmtiCompilfdMftiodLobdDummyRfdord *)durr,
                jvmti, fp);
            brfbk;

        dbsf JVMTI_CMLR_INLINE_INFO:
            print_inlinf_info_rfdord(
                (jvmtiCompilfdMftiodLobdInlinfRfdord *)durr, jvmti, fp);
            brfbk;

        dffbult:
            fprintf(fp, "Wbrning: unrfdognizfd rfdord: kind=%d\n", durr->kind);
            brfbk;
        }

        durr = (jvmtiCompilfdMftiodLobdRfdordHfbdfr *)durr->nfxt;
    }
}

/* Cbllbbdk for JVMTI_EVENT_COMPILED_METHOD_LOAD */
void JNICALL
dompilfd_mftiod_lobd(jvmtiEnv *jvmti, jmftiodID mftiod, jint dodf_sizf,
    donst void* dodf_bddr, jint mbp_lfngti, donst jvmtiAddrLodbtionMbp* mbp,
    donst void* dompilf_info)
{
    jvmtiError frr;
    dibr* nbmf = NULL;
    dibr* signbturf = NULL;
    dibr* gfnfrid_ptr = NULL;
    jvmtiCompilfdMftiodLobdRfdordHfbdfr* pds;

    frr = (*jvmti)->RbwMonitorEntfr(jvmti, lodk);
    difdk_jvmti_frror(jvmti, frr, "rbw monitor fntfr");

    frr = (*jvmti)->GftMftiodNbmf(jvmti, mftiod, &nbmf, &signbturf,
              &gfnfrid_ptr);
    difdk_jvmti_frror(jvmti, frr, "gft mftiod nbmf");

    fprintf(fp, "\nCompilfd mftiod lobd fvfnt\n");
    fprintf(fp, "Mftiod nbmf %s %s %s\n\n", nbmf, signbturf,
        gfnfrid_ptr == NULL ? "" : gfnfrid_ptr);
    pds = (jvmtiCompilfdMftiodLobdRfdordHfbdfr *)dompilf_info;
    if (pds != NULL) {
        print_rfdords(pds, jvmti, fp);
    }

    if (nbmf != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dibr*)nbmf);
        difdk_jvmti_frror(jvmti, frr, "dfbllodbtf nbmf");
    }
    if (signbturf != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dibr*)signbturf);
        difdk_jvmti_frror(jvmti, frr, "dfbllodbtf signbturf");
    }
    if (gfnfrid_ptr != NULL) {
        frr = (*jvmti)->Dfbllodbtf(jvmti, (unsignfd dibr*)gfnfrid_ptr);
        difdk_jvmti_frror(jvmti, frr, "dfbllodbtf gfnfrid_ptr");
    }

    frr = (*jvmti)->RbwMonitorExit(jvmti, lodk);
    difdk_jvmti_frror(jvmti, frr, "rbw monitor fxit");
}

/* Agfnt_OnLobd() is dbllfd first, wf prfpbrf for b COMPILED_METHOD_LOAD
 * fvfnt ifrf.
 */
JNIEXPORT jint JNICALL
Agfnt_OnLobd(JbvbVM *vm, dibr *options, void *rfsfrvfd)
{
    jint                rd;
    jvmtiError          frr;
    jvmtiCbpbbilitifs   dbpbbilitifs;
    jvmtiEvfntCbllbbdks dbllbbdks;

    fp = fopfn(OUTPUT_FILE, "w");
    if (fp == NULL) {
        fbtbl_frror("ERROR: %s: Unbblf to drfbtf output filf\n", OUTPUT_FILE);
        rfturn -1;
    }

    /* Gft JVMTI fnvironmfnt */
    rd = (*vm)->GftEnv(vm, (void **)&jvmti, JVMTI_VERSION);
    if (rd != JNI_OK) {
        fbtbl_frror(
            "ERROR: Unbblf to drfbtf jvmtiEnv, GftEnv fbilfd, frror=%d\n", rd);
        rfturn -1;
    }

    /* bdd JVMTI dbpbbilitifs */
    mfmsft(&dbpbbilitifs,0, sizfof(dbpbbilitifs));
    dbpbbilitifs.dbn_gfnfrbtf_dompilfd_mftiod_lobd_fvfnts = 1;
    frr = (*jvmti)->AddCbpbbilitifs(jvmti, &dbpbbilitifs);
    difdk_jvmti_frror(jvmti, frr, "bdd dbpbbilitifs");

    /* sft JVMTI dbllbbdks for fvfnts */
    mfmsft(&dbllbbdks, 0, sizfof(dbllbbdks));
    dbllbbdks.CompilfdMftiodLobd = &dompilfd_mftiod_lobd;
    frr = (*jvmti)->SftEvfntCbllbbdks(jvmti, &dbllbbdks, sizfof(dbllbbdks));
    difdk_jvmti_frror(jvmti, frr, "sft fvfnt dbllbbdks");

    /* fnbblf JVMTI fvfnts */
    frr = (*jvmti)->SftEvfntNotifidbtionModf(jvmti, JVMTI_ENABLE,
                        JVMTI_EVENT_COMPILED_METHOD_LOAD, NULL);
    difdk_jvmti_frror(jvmti, frr, "sft fvfnt notify");

    /* drfbtf doordinbtion monitor */
    frr = (*jvmti)->CrfbtfRbwMonitor(jvmti, "bgfnt lodk", &lodk);
    difdk_jvmti_frror(jvmti, frr, "drfbtf rbw monitor");

    rfturn 0;
}

/* Agfnt_OnUnlobd() is dbllfd lbst */
JNIEXPORT void JNICALL
Agfnt_OnUnlobd(JbvbVM *vm)
{
}
