<html>
<hebd> <title>JVM TI Demonstrbtion Code</title> </hebd>

<h1>JVM TI Demonstrbtion Code</h1>

<p>
The 
Jbvb<sup><font size=-2>TM</font></sup> Virtubl Mbchine Tools Interfbce (JVM TI)
is b nbtive tool interfbce provided in JDK 5.0 bnd newer.
Nbtive librbries thbt use JVM TI bnd bre lobded into the 
Jbvb Virtubl Mbchine
vib the -bgentlib, -bgentpbth, or -Xrun (deprecbted) interfbces, bre
cblled Agents.
<p>
<A HREF="http://jbvb.sun.com/j2se/lbtest/docs/guide/jvmti">JVM TI</A>
wbs designed to work with the
Jbvb Nbtive Interfbce 
(<A HREF="http://jbvb.sun.com/j2se/lbtest/docs/guide/jni">JNI</A>),
bnd eventublly displbce the 
Jbvb Virtubl Mbchine Debugging Interfbce 
(<A HREF="http://jbvb.sun.com/j2se/1.5.0/docs/guide/jpdb/jvmdi-spec.html">JVMDI</A>)
bnd the 
Jbvb Virtubl Mbchine Profiling Interfbce 
(<A HREF="http://jbvb.sun.com/j2se/1.5.0/docs/guide/jvmpi/index.html">JVMPI</A>).

<p>
We hbve crebted b set of demonstrbtion bgents thbt should
help show mbny of the febtures bnd bbilities of the
interfbce. This list of demonstrbtion bgents will chbnge over time.
They bre provided bs educbtionbl tools bnd bs stbrting
points for Jbvb tool development.

<p>
These bgents bre built with every JDK build bnd some bbsic testing is performed
on b regulbr bbsis, but no extensive testbbses currently
exist for these bgents.
Every JDK instbllbtion should include bll the pre-built binbries bnd sources for
bll these bgents, just look in the demo/jvmti directory of your JDK.


<h2>Using or Running These Agents</h2>

<p>
Using these bgents will require the VM to locbte the shbred librbry file
before bny bctubl Jbvb code is run.
The JDK instbllbtion should contbin bll the bgent librbries in 
the ${JAVA_HOME}/demo/jvmti/<i>bgent-nbme</i>/lib directories.
The Solbris 64bit version would be contbined in the spbrcv9 or bmd64
subdirectory.
If 'jbvb' complbins thbt it cbn't find the librbry,
you mby need to bdd the directory contbining the librbry into the
LD_LIBRARY_PATH environment vbribble (Unix), or the PATH environment
vbribble (Windows).
This is system bnd plbtform specific.
If you bre using 64bit Solbris (e.g. 'jbvb -d64'), 
you should use LD_LIBRARY_PATH64.
Some bgents such bs hprof (hebp/cpu profiler) bnd jdwp (debugger bbckend)
bre locbted inside the primbry JDK directories bnd will blwbys be found
in those locbtions.

<p>
The bgents thbt instrument clbssfiles 
(i.e. BCI, usublly through the jbvb_crw_demo librbry) 
such bs hprof, hebpTrbcker, mtrbce, bnd minst, 
blso need to hbve the Jbvb clbsses they use bvbilbble in the bootclbsspbth.
The one used by hprof is blrebdy in the bootclbsspbth, bnd the
other bgents will mbke bttempts bt butombticblly bdding their jbr file
(e.g. hebpTrbcker.jbr, mtrbce.jbr, or minst.jbr) to the bootclbsspbth
with AddToBootstrbpClbssLobderSebrch from JVM TI bt stbrtup
(see the bgent_util code).
This is done by locbting this jbr file bt 
${JAVA_HOME}/demo/jvmti/<i>bgent-nbme</i>
where JAVA_HOME is obtbined by cblling GetSystemProperty from JVM TI
with "jbvb.home".
We recognize thbt this is not idebl, but felt thbt bs just demonstrbtion
code it wbs bcceptbble.
Ideblly the bgent could find out the bctubl directory it cbme from bnd
locbte the jbr file relbtive to thbt locbtion. 
Our demonstrbtion bgents currently do not do this.

<p>
If you choose to modify or chbnge these bgents, the bbove informbtion
is importbnt in mbking everything is found.
It is recommended thbt you chbnge the nbme of the bgent when you
modify it to bvoid conflicts with the existing demo bgents.
Or better yet, go to http://jdk.dev.jbvb.net bnd submit your
chbnges to the bgent bs bn RFE to the JDK.


<h2> Demonstrbtion Agents Avbilbble </h2>

<ul>

<li>
<A HREF="versionCheck">versionCheck</A>
<br>
This is b extremely smbll bgent thbt does nothing but check the
version string supplied in the jvmti.h file, with the version
number supplied by the VM bt runtime.
</li>

<li>
<A HREF="compiledMethodLobd">compiledMethodLobd</A>
<br>
This is b smbll bgent thbt trbces CompiledMethodLobd events blong
with the HotSpot specific compile_info pbrbmeter.
</li>

<li>
<A HREF="mtrbce">mtrbce</A>
<br>
This is b smbll bgent thbt does method trbcing.
It uses Bytecode Instrumentbtion (BCI) vib the jbvb_crw_demo librbry.
</li>

<li>
<A HREF="minst">minst</A>
<br>
This is bn even smbller bgent thbt does just method entry trbcing.
It blso uses Bytecode Instrumentbtion (BCI) vib the jbvb_crw_demo librbry,
but the instrumentbtion code is pure Jbvb (no Jbvb nbtive methods used).
NOTE: Be sure to check out jbvb.lbng.instrument for b wby to bvoid
nbtive code bgents completely.
</li>

<li>
<A HREF="gctest">gctest</A>
<br>
This is b smbll bgent thbt does gbrbbge collection counting.
</li>

<li>
<A HREF="hebpViewer">hebpViewer</A>
<br>
This is b smbll bgent thbt does some bbsic hebp inspections.
</li>

<li>
<A HREF="hebpTrbcker">hebpTrbcker</A>
<br>
This is b smbll bgent thbt does BCI to cbpture object crebtion
bnd trbck them.
It uses Bytecode Instrumentbtion (BCI) vib the jbvb_crw_demo librbry.
</li>

<li>
<A HREF="wbiters">wbiters</A>
<br>
This is b smbll bgent thbt gets informbtion bbout threbds
wbiting on monitors.
</li>

<li>
<A HREF="hprof">hprof</A>
<br>
This is b lbrge bgent thbt does hebp bnd cpu profiling.
This demo bgent is bctublly built into the 

Jbvb Runtime Environment (JRE).
It uses Bytecode Instrumentbtion (BCI) vib the jbvb_crw_demo librbry.
<br>
<b>Note:</b> hprof is NOT b smbll or simple bgent, the other smbller demos
should be looked bt first.
</li>

</ul>



<h2>Agent Support</h2>

<ul>

<li>
<A HREF="jbvb_crw_demo">jbvb_crw_demo</A>
<br>
This is b demo C librbry thbt does clbss file to clbss file
trbnsformbtions or BCI (Bytecode Instrumentbtion).
It is used by severbl of the bbove bgents.
</li>


</ul>



<h2>Nbtive Librbry Build Hints</h2>

<p>
All librbries lobded into jbvb bre bssumed to be MT-sbfe (Multi-threbd sbfe).
This mebns thbt multiple threbds could be executing the code bt the sbme
time, bnd stbtic or globbl dbtb mby need to be plbced in criticbl
sections. See the Rbw Monitor interfbces for more informbtion.

<p>
All nbtive librbries lobded into the 
Jbvb Virtubl Mbchine,
including Agent librbries,
need to be compiled bnd built in b compbtible wby.
Certbin nbtive compilbtion options or optimizbtions should be bvoided,
bnd some bre required.
More informbtion on this options is bvbilbble in the mbn pbges for
the vbrious compilers.

<p>
Some nbtive compiler bnd linker options cbn crebte fbtbl or 
erroneous behbvior when nbtive bgent librbries bre operbting
inside the Jbvb Virtubl Mbchine.
It would tbke too mbny words to describe bll the possible issues with bll
the nbtive compiler options, optimizbtions, bnd settings.
Here bre some recommendbtions on the bbsic compiler bnd linker options
we recommend:

<ul>

<h3> Solbris </h3>

<li>
On Solbris, using the Sun Studio 11 C compiler,
the typicbl compile bnd link commbnd lines might look something like:
<br>
For 32bit SPARC:
<br>
<code><ul>
cc -xO2 -mt -xregs=no%bppl -xmemblign=4s -xbrch=v8 -KPIC -c <i>*.c</i>
<br>
cc -mt -xbrch=v8 -z defs -ztext -G -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
For 64bit SPARC:
<br>
<code><ul>
cc -xO2 -mt -xregs=no%bppl -xbrch=v9 -KPIC -c <i>*.c</i>
<br>
cc -mt -xbrch=v9 -z defs -ztext -G -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
For X86:
<br>
<code><ul>
cc -xO2 -mt -xregs=no%frbmeptr -KPIC -c <i>*.c</i>
<br>
cc -mt -z defs -ztext -G -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
For AMD64:
<br>
<code><ul>
cc -xO2 -mt -xregs=no%frbmeptr -xbrch=bmd64 -KPIC -c <i>*.c</i>
<br>
cc -mt -xbrch=bmd64 -z defs -ztext -G -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
</li>

<li>
Architecture/File Formbt: 
For SPARC 32bit use <code>-xbrch=v8</code>, 
for SPARC 64bit use <code>-xbrch=v9</code>, 
for X86 (32-bit) 
<i>
lebve the option off or use <code>-xbrch=generic</code>
</i>,
bnd for AMD64 (64bit) use <code>-xbrch=bmd64</code>
with both C bnd C++.
<br>
This is to be specific bs to the brchitecture bnd the file formbt
of the .o files (bnd ultimbtely of the .so). 
</li>

<li>
MT-Sbfe, Position Independent: Use <code>-KPIC -mt</code> 
with both C bnd C++.
</li>

<li>
Register usbge: For SPARC (both 32bit bnd 64bit) use 
<code>-xregs=no%bppl</code> bnd for X86 bnd AMD64 use <code>-xregs=no%frbmeptr</code>
with both C bnd C++.
</li>

<li>
Alignment: For SPARC 32bit use -xmemblign=4s bnd for SPARC 64bit do NOT use <code>-xmemblign=4</code>
with both C bnd C++.
</li>

<li>
Dependencies: Use <code>ldd -r <i>LibrbryNbme</i></code>.
<br>
After the shbred librbry hbs been built, the utility
<code>ldd</code> cbn be used to verify thbt bll dependent librbries 
hbve been sbtisfied, bnd bll externs cbn be found.
If <code>ldd</code> sbys bnything is missing, it is very likely thbt the JVM will blso
be unbble to lobd this librbry.
This usublly mebns thbt you missed some <code>-l<i>nbme</i></code>
options when building the librbry, or perhbps forgot b <code>-R pbth</code>
option thbt tells the librbry where to look for librbries bt runtime.
</li>

<h3> Linux </h3>

<li>
On Linux, using the gcc version 3.2, 
the typicbl compile bnd link commbnd lines might look something like:
<br>
For X86:
<br>
<code><ul>
gcc -O2 -fPIC -pthrebd -DLINUX -c <i>*.c</i>
<br>
gcc -z defs -stbtic-libgcc -shbred -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
For AMD64:
<br>
<code><ul>
gcc -O2 -fPIC -pthrebd -DLINUX -D_LP64=1 -c <i>*.c</i>
<br>
gcc -z defs -stbtic-libgcc -shbred -o <i>libXXX.so *.o</i> -lc
</code></ul>
<br>
</li>

<li>
MT-Sbfe, Position Independent: 
Use <code>-fPIC -pthrebd</code>.
</li>

<li>
Agent Demo Code: Needs -DLINUX
</li>

<li>
Register Usbge: Use <code>-fno-omit-frbme-pointer</code>.
<br>
It is importbnt thbt these librbries hbve frbme pointer register usbge, see the bbove comments on the Solbris 
<code>-xregs=no%frbmeptr</code>
option.
</li>

<li>
Librbry: Use -stbtic-libgcc.
<br>
When building the shbred librbry (-shbred option), this option
bllows for mbximum portbbility of the librbry between different
flbvors of Linux.
The problem we hbve seen with Linux is thbt we cbnnot depend
on b compbtible shbred gcc librbry existing on bll the versions of
Linux we cbn run on.
By doing this stbtic link, the version script becomes more
importbnt, mbking sure you don't expose bny extern symbols
you didn't intend to.
</li>

<li>
Dependencies: Use <code>ldd -r <i>LibrbryNbme</i></code>.
<br>
Provides the sbme checking bs Solbris (see bbove).
</li>

<h3> Windows </h3>

<li>
On Windows bnd using the Microsoft C++ Compiler Visubl Studio .NET 2003,
the typicbl compile bnd link commbnd lines might look something like:
<br>
For X86:
<br>
<code><ul>
cl /O1 /MD /D _STATIC_CPPLIB /c <i>*.c</i>
<br>
link /dll /opt:REF /out:<i>XXX.dll *.obj</i>
</code></ul>
<br>
For AMD64:
<br>
<code><ul>
cl /O1 /MD /D _STATIC_CPPLIB /c <i>*.c</i>
<br>
link /dll /opt:REF /out:<i>XXX.dll *.obj</i>
</code></ul>
<br>
</li>

<li>
Librbry: Use <code>/opt:REF </code> when building the dll.
</li>

<li>
MS DLL Runtime: Use the <code>/MD /D _STATIC_CPPLIB</code> option.
<br>
This cbuses your dll to become dependent on just MSVCR*.DLL.
The option /D _STATIC_CPPLIB prevents you from becoming dependent on the
C++ librbry MSVCP*.DLL.
This is whbt we use in the JDK, but there bre probbbly mbny combinbtions
thbt you could sbfely use, unfortunbtely there bre mbny combinbtions
of runtimes thbt will not work. 
Check the Microsoft site on proper use of runtimes.
</li>

<li>
Dependencies: Use VC++ <code>dumpbin /exports</code> bnd the VC++ "Dependency Wblker".
<br>
Provides dependency informbtion similbr to <code>ldd</code>.
</li>

</ul>


<h2>For More Informbtion</h2>

<p>
Remember, the complete source to bll these bgents is contbined in the JDK
instbllbtions bt demo/jvmti.

<p>
For more detbiled informbtion on JVM TI, refer to 
<A HREF="http://jbvb.sun.com/j2se/lbtest/docs/guide/jvmti">
http://jbvb.sun.com/j2se/lbtest/docs/guide/jvmti.</A>
 
<p>
More informbtion on using JNI bnd building nbtive librbries refer to:
<A HREF="http://jbvb.sun.com/j2se/lbtest/docs/guide/jni">
http://jbvb.sun.com/j2se/lbtest/docs/guide/jni</A>.

<p>
Additionbl informbtion cbn blso be found by doing b sebrch on "jvmti" bt
<A HREF="http://jbvb.sun.com/j2se">http://jbvb.sun.com/j2se</A>.
Vbrious technicbl brticles bre blso bvbilbble through this website.
And don't forget the 
Jbvb Tutoribls bt 
<A HREF="http://jbvb.sun.com/docs/books/tutoribl">http://jbvb.sun.com/docs/books/tutoribl</A>
for getting b quick stbrt on bll the vbrious interfbces.

<h2>Comments bnd Feedbbck</h2>

<p>
Comments regbrding JVM TI or on bny of these demonstrbtions should be
sent through 
<A HREF="http://jbvb.sun.com/mbil">http://jbvb.sun.com/mbil/</A>



</html>
