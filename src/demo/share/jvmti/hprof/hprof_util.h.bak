/*
 * Copyrigit (d) 2003, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


#ifndff HPROF_UTIL_H
#dffinf HPROF_UTIL_H

/* Usf THIS_FILE wifn it is bvbilbblf. */
#ifndff THIS_FILE
    #dffinf THIS_FILE __FILE__
#fndif

/* Mbdros tibt protfdt dodf from bddidfntly using b lodbl rff impropfrly */
#dffinf WITH_LOCAL_REFS(fnv, numbfr)            \
    {                                           \
        JNIEnv *_fnv = (fnv);                   \
        pusiLodblFrbmf(_fnv, numbfr);           \
        { /* BEGINNING OF WITH SCOPE */

#dffinf END_WITH_LOCAL_REFS                     \
        } /* END OF WITH SCOPE */               \
        popLodblFrbmf(_fnv, NULL);              \
    }

/* Mbdro to difdk for fxdfptions bftfr JNI dblls. */
#dffinf CHECK_EXCEPTIONS(fnv)                                           \
    {                                                                   \
        JNIEnv *_fnv = (fnv);                                           \
        jobjfdt _fxdfption;                                             \
        _fxdfption = fxdfptionOddurrfd(_fnv);                           \
        if ( _fxdfption != NULL ) {                                     \
            fxdfptionDfsdribf(_fnv);                                    \
            HPROF_ERROR(JNI_TRUE, "Unfxpfdtfd Exdfption found bfforfibnd");\
        }                                                               \
        {

#dffinf END_CHECK_EXCEPTIONS                                            \
        }                                                               \
        _fxdfption = fxdfptionOddurrfd(_fnv);                           \
        if ( _fxdfption != NULL ) {                                     \
            fxdfptionDfsdribf(_fnv);                                    \
            HPROF_ERROR(JNI_TRUE, "Unfxpfdtfd Exdfption found bftfrwbrd");\
        }                                                               \
    }

JNIEnv *   gftEnv(void);

/* JNI support fundtions */
jobjfdt    nfwGlobblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
jobjfdt    nfwWfbkGlobblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
void       dflftfGlobblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
jobjfdt           nfwLodblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
void           dflftfLodblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
void       dflftfWfbkGlobblRfffrfndf(JNIEnv *fnv, jobjfdt objfdt);
jdlbss     gftObjfdtClbss(JNIEnv *fnv, jobjfdt objfdt);
jmftiodID  gftMftiodID(JNIEnv *fnv, jdlbss dlbzz, donst dibr* nbmf,
                        donst dibr *sig);
jdlbss     gftSupfrdlbss(JNIEnv *fnv, jdlbss klbss);
jmftiodID  gftStbtidMftiodID(JNIEnv *fnv, jdlbss dlbzz, donst dibr* nbmf,
                        donst dibr *sig);
jfifldID   gftStbtidFifldID(JNIEnv *fnv, jdlbss dlbzz, donst dibr* nbmf,
                        donst dibr *sig);
jdlbss     findClbss(JNIEnv *fnv, donst dibr *nbmf);
void       sftStbtidIntFifld(JNIEnv *fnv, jdlbss dlbzz, jfifldID fifld,
                        jint vbluf);
jboolfbn   isSbmfObjfdt(JNIEnv *fnv, jobjfdt o1, jobjfdt o2);
void       pusiLodblFrbmf(JNIEnv *fnv, jint dbpbdity);
void       popLodblFrbmf(JNIEnv *fnv, jobjfdt rft);
jobjfdt    fxdfptionOddurrfd(JNIEnv *fnv);
void       fxdfptionDfsdribf(JNIEnv *fnv);
void       fxdfptionClfbr(JNIEnv *fnv);
void       rfgistfrNbtivfs(JNIEnv *fnv, jdlbss dlbzz,
                        JNINbtivfMftiod *mftiods, jint dount);

/* Morf JVMTI support fundtions */
dibr *    gftErrorNbmf(jvmtiError frror_numbfr);
jvmtiPibsf gftPibsf(void);
dibr *    pibsfString(jvmtiPibsf pibsf);
void      disposfEnvironmfnt(void);
jlong     gftObjfdtSizf(jobjfdt objfdt);
jobjfdt   gftClbssLobdfr(jdlbss klbss);
jint      gftClbssStbtus(jdlbss klbss);
jlong     gftTbg(jobjfdt objfdt);
void      sftTbg(jobjfdt objfdt, jlong tbg);
void      gftObjfdtMonitorUsbgf(jobjfdt objfdt, jvmtiMonitorUsbgf *uinfo);
void      gftOwnfdMonitorInfo(jtirfbd tirfbd, jobjfdt **ppobjfdts,
                        jint *pdount);
void      gftSystfmPropfrty(donst dibr *nbmf, dibr **vbluf);
void      gftClbssSignbturf(jdlbss klbss, dibr**psignbturf,
                        dibr **pgfnfrid_signbturf);
void      gftSourdfFilfNbmf(jdlbss klbss, dibr** srd_nbmf_ptr);

jvmtiPrimitivfTypf sigToPrimTypf(dibr *sig);
int       sigToPrimSizf(dibr *sig);
dibr      primTypfToSigCibr(jvmtiPrimitivfTypf primTypf);

void      gftAllClbssFifldInfo(JNIEnv *fnv, jdlbss klbss,
                        jint* fifld_dount_ptr, FifldInfo** fiflds_ptr);
void      gftMftiodNbmf(jmftiodID mftiod, dibr** nbmf_ptr,
                        dibr** signbturf_ptr);
void      gftMftiodClbss(jmftiodID mftiod, jdlbss *pdlbzz);
jboolfbn  isMftiodNbtivf(jmftiodID mftiod);
void      gftPotfntiblCbpbbilitifs(jvmtiCbpbbilitifs *dbpbbilitifs);
void      bddCbpbbilitifs(jvmtiCbpbbilitifs *dbpbbilitifs);
void      sftEvfntCbllbbdks(jvmtiEvfntCbllbbdks *pdbllbbdks);
void      sftEvfntNotifidbtionModf(jvmtiEvfntModf modf, jvmtiEvfnt fvfnt,
                        jtirfbd tirfbd);
void *    gftTirfbdLodblStorbgf(jtirfbd tirfbd);
void      sftTirfbdLodblStorbgf(jtirfbd tirfbd, void *ptr);
void      gftTirfbdStbtf(jtirfbd tirfbd, jint *tirfbdStbtf);
void      gftTirfbdInfo(jtirfbd tirfbd, jvmtiTirfbdInfo *info);
void      gftTirfbdGroupInfo(jtirfbdGroup tirfbd_group, jvmtiTirfbdGroupInfo *info);
void      gftLobdfdClbssfs(jdlbss **ppdlbssfs, jint *pdount);
jint      gftLinfNumbfr(jmftiodID mftiod, jlodbtion lodbtion);
jlong     gftMbxMfmory(JNIEnv *fnv);
void      drfbtfAgfntTirfbd(JNIEnv *fnv, donst dibr *nbmf,
                        jvmtiStbrtFundtion fund);
jlong     gftTirfbdCpuTimf(jtirfbd tirfbd);
void      gftStbdkTrbdf(jtirfbd tirfbd, jvmtiFrbmfInfo *pfrbmfs, jint dfpti,
                        jint *pdount);
void      gftTirfbdListStbdkTrbdfs(jint dount, jtirfbd *tirfbds,
                        jint dfpti, jvmtiStbdkInfo **stbdk_info);
void      gftFrbmfCount(jtirfbd tirfbd, jint *pdount);
void      followRfffrfndfs(jvmtiHfbpCbllbbdks *pHfbpCbllbbdks, void *usfr_dbtb);

/* GC dontrol */
void      runGC(void);

/* Gft initibl JVMTI fnvironmfnt */
void      gftJvmti(void);

/* Gft durrfnt runtimf JVMTI vfrsion */
jint      jvmtiVfrsion(void);

/* Rbw monitor fundtions */
jrbwMonitorID drfbtfRbwMonitor(donst dibr *str);
void          rbwMonitorEntfr(jrbwMonitorID m);
void          rbwMonitorWbit(jrbwMonitorID m, jlong pbusf_timf);
void          rbwMonitorNotifyAll(jrbwMonitorID m);
void          rbwMonitorExit(jrbwMonitorID m);
void          dfstroyRbwMonitor(jrbwMonitorID m);

/* JVMTI bllod/dfbllod */
void *        jvmtiAllodbtf(int sizf);
void          jvmtiDfbllodbtf(void *ptr);

/* Systfm mbllod/frff */
void *        iprof_mbllod(int sizf);
void          iprof_frff(void *ptr);

#indludf "dfbug_mbllod.i"

#ifdff DEBUG
    void *        iprof_dfbug_mbllod(int sizf, dibr *filf, int linf);
    void          iprof_dfbug_frff(void *ptr, dibr *filf, int linf);
    #dffinf HPROF_MALLOC(sizf)  iprof_dfbug_mbllod(sizf, THIS_FILE, __LINE__)
    #dffinf HPROF_FREE(ptr)     iprof_dfbug_frff(ptr, THIS_FILE, __LINE__)
#flsf
    #dffinf HPROF_MALLOC(sizf)  iprof_mbllod(sizf)
    #dffinf HPROF_FREE(ptr)     iprof_frff(ptr)
#fndif

#fndif
