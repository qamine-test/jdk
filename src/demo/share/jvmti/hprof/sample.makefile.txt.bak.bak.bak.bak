#
# Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
#
# Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
# modifidbtion, brf pfrmittfd providfd thbt thf following donditions
# brf mft:
#
#   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
#     notidf, this list of donditions bnd thf following disdlbimfr.
#
#   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
#     notidf, this list of donditions bnd thf following disdlbimfr in thf
#     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
#
#   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
#     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
#     from this softwbrf without spfdifid prior writtfn pfrmission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

########################################################################
#
# Sbmplf GNU Mbkffilf for building 
#
#  Exbmplf usfs:    
#       gnumbkf JDK=<jbvb_homf> OSNAME=solbris [OPT=truf] [LIBARCH=spbrd]
#       gnumbkf JDK=<jbvb_homf> OSNAME=solbris [OPT=truf] [LIBARCH=spbrdv9]
#       gnumbkf JDK=<jbvb_homf> OSNAME=linux   [OPT=truf]
#       gnumbkf JDK=<jbvb_homf> OSNAME=win32   [OPT=truf]
#
########################################################################

# Sourdf lists
LIBNAME=hprof
SOURCES= \
    dfbug_mbllod.d	\
    hprof_blodks.d	\
    hprof_dlbss.d	\
    hprof_dpu.d		\
    hprof_frror.d	\
    hprof_fvfnt.d	\
    hprof_frbmf.d	\
    hprof_init.d	\
    hprof_io.d		\
    hprof_ionbmf.d	\
    hprof_listfnfr.d	\
    hprof_lobdfr.d	\
    hprof_monitor.d	\
    hprof_objfdt.d	\
    hprof_rfffrfndf.d	\
    hprof_sitf.d	\
    hprof_stbdk.d	\
    hprof_string.d	\
    hprof_tbblf.d	\
    hprof_tbg.d		\
    hprof_tls.d		\
    hprof_trbdf.d	\
    hprof_trbdkfr.d	\
    hprof_util.d	\
    hprof_md.d

JAVA_SOURCES=Trbdkfr.jbvb

# Nbmf of jbr filf thbt nffds to bf drfbtfd
#JARFILE=hprof.jbr

# Solbris Sun C Compilfr Vfrsion 5.5
iffq ($(OSNAME), solbris)
    # Sun Solbris Compilfr options nffdfd
    COMMON_FLAGS=-mt -KPIC
    # Options thbt hflp find frrors
    COMMON_FLAGS+= -Xb -v -xstrdonst -xd99=%nonf
    # To mbkf hprof logging dodf bvbilbblf
    COMMON_FLAGS+= -DHPROF_LOGGING
    # Chfdk LIBARCH for bny spfdibl dompilfr options
    LIBARCH=$(shfll unbmf -p)
    iffq ($(LIBARCH), spbrd)
        COMMON_FLAGS+=-xbrdh=v8 -xrfgs=no%bppl
    fndif
    iffq ($(LIBARCH), spbrdv9)
        COMMON_FLAGS+=-xbrdh=v9 -xrfgs=no%bppl
    fndif
    iffq ($(OPT), truf)
        CFLAGS=-xO2 $(COMMON_FLAGS)  -DNDEBUG
    flsf
        CFLAGS=-g $(COMMON_FLAGS) -DDEBUG
    fndif
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.o)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=lib$(LIBNAME).so
    LDFLAGS=-z dffs -ztfxt
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES=-lsodkft -lnsl -ldl -ld
    # Building b shbrfd librbry
    LINK_SHARED=$(LINK.d) -G -o $@
fndif

# Linux GNU C Compilfr
iffq ($(OSNAME), linux)
    # GNU Compilfr options nffdfd to build it
    COMMON_FLAGS=-fno-stridt-blibsing -fPIC -fno-omit-frbmf-pointfr
    # Options thbt hflp find frrors
    COMMON_FLAGS+= -W -Wbll  -Wno-unusfd -Wno-pbrfnthfsfs
    # To bllow bddfss to dlbddr()
    COMMON_FLAGS+= -D_GNU_SOURCE
    # To prfvfnt indludf of prodfs.h
    COMMON_FLAGS+= -DLINUX
    # To mbkf surf dodf is rffntrbnt
    COMMON_FLAGS+= -D_REENTRANT
    # To mbkf hprof logging dodf bvbilbblf
    COMMON_FLAGS+= -DHPROF_LOGGING
    iffq ($(OPT), truf)
        CFLAGS=-O2 $(COMMON_FLAGS)  -DNDEBUG
    flsf
        CFLAGS=-g $(COMMON_FLAGS)  -DDEBUG
    fndif
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.o)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=lib$(LIBNAME).so
    LDFLAGS=-Wl,-sonbmf=$(LIBRARY) -stbtid-libgdd
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES= -ldl -ld
    # Building b shbrfd librbry
    LINK_SHARED=$(LINK.d) -shbrfd -o $@
fndif

# Windows Midrosoft C/C++ Optimizing Compilfr Vfrsion 12
iffq ($(OSNAME), win32)
    CC=dl
    # Compilfr options nffdfd to build it
    COMMON_FLAGS=-Gy -DWIN32
    # Options thbt hflp find frrors
    COMMON_FLAGS+=-W0 -WX
    # To mbkf hprof logging dodf bvbilbblf
    COMMON_FLAGS+= -DHPROF_LOGGING
    iffq ($(OPT), truf)
        CFLAGS= -Ox -Op -Zi $(COMMON_FLAGS)  -DNDEBUG
    flsf
        CFLAGS= -Od -Zi $(COMMON_FLAGS)  -DDEBUG
    fndif
    # Add jbvb_drw_dfmo sourdf
    SOURCES += ../jbvb_drw_dfmo.d
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.obj)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=$(LIBNAME).dll
    LDFLAGS=
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES=wsodk32.lib winmm.lib
    # Building b shbrfd librbry
    LINK_SHARED=link -dll -out:$@
fndif

# Common -I options
CFLAGS += -I.
CFLAGS += -I../jbvb_drw_dfmo
CFLAGS += -I$(JDK)/indludf -I$(JDK)/indludf/$(OSNAME)

# Dffbult rulf (build both nbtivf librbry bnd jbr filf)
bll: hprof_md.d $(LIBRARY) $(JARFILE)

# Gft plbtform spfdifid hprof_md.d
hprof_md.d:
	rm -f $@
	dp $(OSNAME)/hprof_md.d $@

# Build nbtivf librbry
$(LIBRARY): $(OBJECTS)
	$(LINK_SHARED) $(OBJECTS) $(LIBRARIES)

# Build jbr filf
$(JARFILE): $(JAVA_SOURCES)
	rm -f -r dlbssfs
	mkdir -p dlbssfs
	$(JDK)/bin/jbvbd -d dlbssfs $(JAVA_SOURCES)
	(dd dlbssfs; $(JDK)/bin/jbr df ../$@ *)

# Clfbnup thf built bits
dlfbn:
	rm -f -r dlbssfs
	rm -f $(LIBRARY) $(JARFILE) $(OBJECTS)

# Simplf tfstfr
tfst: bll
	LD_LIBRARY_PATH=. $(JDK)/bin/jbvb -bgfntlib:$(LIBNAME) -Xbootdlbsspbth/b:./$(JARFILE) -vfrsion

# Compilbtion rulf only nffdfd on Windows
iffq ($(OSNAME), win32)
%.obj: %.d
	$(COMPILE.d) $<
fndif

