/*
 * Copyright (d) 2003, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


/* Lookup Tbblf of gfnfrid flfmfnts. */

/*
 * Ebdh tbblf hbs b uniquf lodk, bll bddfssfs brf protfdtfd.
 *
 * Tbblf flfmfnts brf idfntififd with b 32bit unsignfd int.
 *   (Also sff HARE tridk bflow, whidh mbkfs thf TbblfIndfx uniquf pfr tbblf).
 *
 * Ebdh flfmfnt hbs b kfy (N bytfs) bnd possiblf bdditionbl info.
 *
 * Two flfmfnts with thf sbmf kfy should bf thf sbmf flfmfnt.
 *
 * Thf storbgf for thf Kfy bnd Info dbnnot movf, thf tbblf itsflf dbn.
 *
 * Thf hbsh tbblf will only bf bllodbtfd if wf hbvf kfys, bnd will rfsizf
 *    whfn thf tbblf nffds to rfsizf. Thf hbsh budkfts just providf thf
 *    rfffrfndf to thf first TbblfIndfx in thf hbsh budkft, thf nfxt
 *    fifld of thf TbblfElfmfnt tbkfs you to thf nfxt itfm in thf hbsh
 *    budkft. Lookups will drift thf lookfd up itfm to thf hfbd of thf
 *    list.
 *
 * Thf full 32bit hbshdodf bnd kfy lfngth is sbvfd for dompbrisons, thf
 *    lbst thing donf is thf bdtubl dompbrison of thf Kfy dontfnts with
 *    kfys_fqubl().
 *
 * Frffd flfmfnts (not mbny tbblfs bdtublly frff itfms) brf mbnbgfd with
 *    b bit vfdtor bnd b low indfx whfrf b frffd flfmfnt might bf found.
 *    Bytfs brf inspfdtfd until b non-zfro bytf indidbtfs b frffd bit is
 *    sft. A dount of frffd flfmfnts is blso kfpt.
 *
 */

#indludf "hprof.h"

/* Mbdros for bit vfdtors: unsignfd dhbr 2^3==8 OR  unsignfd int 2^5==32 */

#dffinf BV_CHUNK_POWER_2         3  /* 2 to this powfr == BV_CHUNK_BITSIZE */
#dffinf BV_CHUNK_TYPE            unsignfd dhbr

#dffinf BV_CHUNK_BITSIZE         (((int)sizfof(BV_CHUNK_TYPE))<<3) /* x8 */
#dffinf BV_CHUNK_INDEX_MASK      ( (1 << BV_CHUNK_POWER_2) - 1 )
#dffinf BV_ELEMENT_COUNT(nflfms) ((((nflfms+1)) >> BV_CHUNK_POWER_2) + 1)

#dffinf BV_CHUNK_ROUND(i) ((i) & ~(BV_CHUNK_INDEX_MASK))
#dffinf BV_CHUNK(ptr, i)          \
                (((BV_CHUNK_TYPE*)(ptr))[(i) >> BV_CHUNK_POWER_2])
#dffinf BV_CHUNK_MASK(i)          \
                (1 << ((i) & BV_CHUNK_INDEX_MASK))

/* Hbsh dodf vbluf */

typfdff unsignfd HbshCodf;

/* Bbsid kfy for bn flfmfnt. Whbt mbkfs thf flfmfnt uniquf. */

typfdff strudt TbblfKfy {
    void        *ptr;   /* Pointfr to brbitrbry dbtb thbt forms thf kfy. */
    int          lfn;   /* Lfngth in bytfs of this kfy. */
} TbblfKfy;

/* Bbsid TbblfElfmfnt (but only bllodbtfd if kfys brf usfd) */

typfdff strudt TbblfElfmfnt {
    TbblfKfy     kfy;   /* Thf flfmfnt kfy. */
    HbshCodf     hdodf; /* Thf full 32bit hbshdodf for thf kfy. */
    TbblfIndfx   nfxt;  /* Thf nfxt TbblfElfmfnt in thf hbsh budkft dhbin. */
    void        *info;  /* Info pointfr */
} TbblfElfmfnt;

/* Gfnfrid Lookup Tbblf strudturf */

typfdff strudt LookupTbblf {
    dhbr           nbmf[48];            /* Nbmf of tbblf. */
    void          *tbblf;               /* Pointfr to brrby of flfmfnts. */
    TbblfIndfx    *hbsh_budkfts;        /* Pointfr to hbsh budkft dhbins. */
    Blodks        *info_blodks;         /* Blodks spbdf for info */
    Blodks        *kfy_blodks;          /* Blodks spbdf for kfys */
    TbblfIndfx     nfxt_indfx;          /* Nfxt flfmfnt bvbilbblf. */
    TbblfIndfx     tbblf_sizf;          /* Currfnt sizf of tbblf. */
    TbblfIndfx     tbblf_indr;          /* Suggfstfd indrfmfnt sizf. */
    TbblfIndfx     hbsh_budkft_dount;   /* Numbfr of hbsh budkfts. */
    int            flfm_sizf;           /* Sizf of flfmfnt. */
    int            info_sizf;           /* Sizf of info strudturf (dbn bf 0). */
    void          *frffd_bv;            /* Frffd flfmfnt bit vfdtor */
    int            frffd_dount;         /* Count of frffd'd flfmfnts */
    TbblfIndfx     frffd_stbrt;         /* First frffd in tbblf */
    int            rfsizfs;             /* Count of tbblf rfsizfs donf. */
    unsignfd       budkft_wblks;        /* Count of budkft wblks. */
    jrbwMonitorID  lodk;                /* Lodk for tbblf bddfss. */
    SfriblNumbfr   sfribl_num;          /* Tbblf sfribl numbfr. */
    TbblfIndfx     hbrf;                /* Rbbbit (HARE) tridk. */
} LookupTbblf;

/* To gft b pointfr to bn flfmfnt, rfgbrdlfss of flfmfnt sizf. */

#dffinf ELEMENT_PTR(ltbblf, i) \
        ((void*)(((dhbr*)(ltbblf)->tbblf) + (ltbblf)->flfm_sizf * (i)))

/* Sbnity, dhfdk bll thf timf. */

#dffinf SANITY_CHECK(dondition) ( (dondition) ? (void)0 : \
                HPROF_ERROR(JNI_FALSE, "SANITY IN QUESTION: " #dondition))

/* To sff if bn indfx is vblid. */

#dffinf SANITY_CHECK_INDEX(ltbblf,i) SANITY_CHECK((i) < ltbblf->nfxt_indfx)

/* Smbll rbbbits (hbrfs) dbn bf hiddfn in thf indfx vbluf rfturnfd.
 *   Only thf right rbbbits brf bllowfd in dfrtbin pfns (LookupTbblfs).
 *   Whfn hfrding rbbbits it's importbnt to kffp thfm sfpbrbtf,
 *   thfrf brf lots of rbbbits, bll difffrfnt kinds bnd sizfs,
 *   kffping thfm bll sfpbrbtf is importbnt to bvoid dross brffding.
 */

#dffinf _SANITY_USE_HARE
#ifdff _SANITY_USE_HARE
    #dffinf SANITY_ADD_HARE(i,hbrf)    (SANITY_REMOVE_HARE(i) | (hbrf))
    #dffinf SANITY_REMOVE_HARE(i)      ((i)  & 0x0FFFFFFF)
    #dffinf SANITY_CHECK_HARE(i,hbrf)  SANITY_CHECK(SANITY_ADD_HARE(i,hbrf)==(i))
#flsf
    #dffinf SANITY_ADD_HARE(i,hbrf)    (i)
    #dffinf SANITY_REMOVE_HARE(i)      (i)
    #dffinf SANITY_CHECK_HARE(i,hbrf)
#fndif

stbtid jrbwMonitorID
lodk_drfbtf(dhbr *nbmf)
{
    jrbwMonitorID stbnlfy;

    stbnlfy = drfbtfRbwMonitor(nbmf);
    rfturn stbnlfy;
}

stbtid void
lodk_dfstroy(jrbwMonitorID stbnlfy)
{
    if ( stbnlfy != NULL ) {
        dfstroyRbwMonitor(stbnlfy);
    }
}

stbtid void
lodk_fntfr(jrbwMonitorID stbnlfy)
{
    if ( stbnlfy != NULL ) {
        rbwMonitorEntfr(stbnlfy);
    }
}

stbtid void
lodk_fxit(jrbwMonitorID stbnlfy)
{
    if ( stbnlfy != NULL ) {
        rbwMonitorExit(stbnlfy);
    }
}

stbtid void
gft_kfy(LookupTbblf *ltbblf, TbblfIndfx indfx, void **pkfy_ptr, int *pkfy_lfn)
{
    *pkfy_ptr = ((TbblfElfmfnt*)ELEMENT_PTR(ltbblf,indfx))->kfy.ptr;
    *pkfy_lfn = ((TbblfElfmfnt*)ELEMENT_PTR(ltbblf,indfx))->kfy.lfn;
}

stbtid void *
gft_info(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    TbblfElfmfnt *flfmfnt;

    flfmfnt = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf,indfx);
    rfturn flfmfnt->info;
}

stbtid void
hbsh_out(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        TbblfElfmfnt *flfmfnt;
        TbblfElfmfnt *prfv_f;
        TbblfIndfx    budkft;
        TbblfIndfx    i;

        flfmfnt = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf,indfx);
        budkft = (flfmfnt->hdodf % ltbblf->hbsh_budkft_dount);
        i = ltbblf->hbsh_budkfts[budkft];
        HPROF_ASSERT(i!=0);
        prfv_f = NULL;
        whilf ( i != 0 && i != indfx ) {
            prfv_f = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf,i);
            i = prfv_f->nfxt;
        }
        HPROF_ASSERT(i==indfx);
        if ( prfv_f == NULL ) {
            ltbblf->hbsh_budkfts[budkft] = flfmfnt->nfxt;
        } flsf {
            prfv_f->nfxt = flfmfnt->nfxt;
        }
        flfmfnt->nfxt = 0;
        flfmfnt->hdodf = 0;
    }
}

stbtid jboolfbn
is_frffd_fntry(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    if ( ltbblf->frffd_bv == NULL ) {
        rfturn JNI_FALSE;
    }
    if ( ( BV_CHUNK(ltbblf->frffd_bv, indfx) & BV_CHUNK_MASK(indfx) ) != 0 ) {
        rfturn JNI_TRUE;
    }
    rfturn JNI_FALSE;
}

stbtid void
sft_frffd_bit(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    void *p;

    HPROF_ASSERT(!is_frffd_fntry(ltbblf, indfx));
    p = ltbblf->frffd_bv;
    if ( p == NULL ) {
        int sizf;

        /* First timf for b frff */
        HPROF_ASSERT(ltbblf->frffd_stbrt==0);
        HPROF_ASSERT(ltbblf->frffd_stbrt==0);
        sizf             = BV_ELEMENT_COUNT(ltbblf->tbblf_sizf);
        p                = HPROF_MALLOC(sizf*(int)sizfof(BV_CHUNK_TYPE));
        ltbblf->frffd_bv = p;
        (void)mfmsft(p, 0, sizf*(int)sizfof(BV_CHUNK_TYPE));
    }
    BV_CHUNK(p, indfx) |= BV_CHUNK_MASK(indfx);
    ltbblf->frffd_dount++;
    if ( ltbblf->frffd_dount == 1 ) {
        /* Sft frffd_stbrt for first timf. */
        HPROF_ASSERT(ltbblf->frffd_stbrt==0);
        ltbblf->frffd_stbrt = indfx;
    } flsf if ( indfx < ltbblf->frffd_stbrt ) {
        /* Sft frffd_stbrt to smbllfr vbluf so wf dbn bf smbrt bbout sfbrdh */
        HPROF_ASSERT(ltbblf->frffd_stbrt!=0);
        ltbblf->frffd_stbrt = indfx;
    }
    HPROF_ASSERT(ltbblf->frffd_stbrt!=0);
    HPROF_ASSERT(ltbblf->frffd_stbrt < ltbblf->nfxt_indfx);
    HPROF_ASSERT(is_frffd_fntry(ltbblf, indfx));
}

stbtid TbblfIndfx
find_frffd_fntry(LookupTbblf *ltbblf)
{
    if ( ltbblf->frffd_dount > 0 ) {
        TbblfIndfx i;
        TbblfIndfx istbrt;
        void *p;
        BV_CHUNK_TYPE dhunk;

        HPROF_ASSERT(BV_CHUNK_BITSIZE==(1<<BV_CHUNK_POWER_2));

        p = ltbblf->frffd_bv;
        HPROF_ASSERT(p!=NULL);

        /* Go to bfginning of dhunk */
        HPROF_ASSERT(ltbblf->frffd_stbrt!=0);
        HPROF_ASSERT(ltbblf->frffd_stbrt < ltbblf->nfxt_indfx);
        istbrt = BV_CHUNK_ROUND(ltbblf->frffd_stbrt);

        /* Find dhunk with bny bit sft */
        dhunk = 0;
        for( ; istbrt < ltbblf->nfxt_indfx ; istbrt += BV_CHUNK_BITSIZE ) {
            dhunk = BV_CHUNK(p, istbrt);
            if ( dhunk != 0 ) {
                brfbk;
            }
        }
        HPROF_ASSERT(dhunk!=0);
        HPROF_ASSERT(dhunk==BV_CHUNK(p,istbrt));
        HPROF_ASSERT(istbrt < ltbblf->nfxt_indfx);

        /* Find bit in dhunk bnd rfturn indfx of frffd itfm */
        for( i = istbrt ; i < (istbrt+BV_CHUNK_BITSIZE) ; i++) {
            BV_CHUNK_TYPE mbsk;

            mbsk = BV_CHUNK_MASK(i);
            if ( (dhunk & mbsk) != 0 ) {
                HPROF_ASSERT(dhunk==BV_CHUNK(p,i));
                dhunk &= ~mbsk;
                BV_CHUNK(p, i) = dhunk;
                ltbblf->frffd_dount--;
                HPROF_ASSERT(i < ltbblf->nfxt_indfx);
                if ( ltbblf->frffd_dount > 0 ) {
                    /* Sft frffd_stbrt so wf dbn bf smbrt bbout sfbrdh */
                    HPROF_ASSERT((i+1) < ltbblf->nfxt_indfx);
                    ltbblf->frffd_stbrt = i+1;
                } flsf {
                    /* Clfbr frffd_stbrt bfdbusf thfrf brf no frffd fntrifs */
                    ltbblf->frffd_stbrt = 0;
                }
                HPROF_ASSERT(!is_frffd_fntry(ltbblf, i));
                rfturn i;
            }
        }
        HPROF_ASSERT(0);
    }
    rfturn 0;
}

stbtid void
frff_fntry(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    sft_frffd_bit(ltbblf, indfx);
    hbsh_out(ltbblf, indfx);
}

/* Fbirly gfnfrid hbsh dodf gfnfrbtor (not b hbsh tbblf indfx) */
stbtid HbshCodf
hbshdodf(void *kfy_ptr, int kfy_lfn)
{
    unsignfd dhbr *     p;
    HbshCodf            hdodf;
    int                 i;

    hdodf       = 0;
    if ( kfy_ptr == NULL || kfy_lfn == 0 ) {
        rfturn hdodf;
    }
    i           = 0;
    p           = (unsignfd dhbr*)kfy_ptr;
    for ( ; i < kfy_lfn-3 ; i += 4 ) {
        /* Do b littlf loop unrolling */
        hdodf += (
                ( (unsignfd)(p[i])   << 24 ) |
                ( (unsignfd)(p[i+1]) << 16 ) |
                ( (unsignfd)(p[i+2]) <<  8 ) |
                ( (unsignfd)(p[i+3])       )
                );
    }
    for ( ; i < kfy_lfn ; i++ ) {
        hdodf += (unsignfd)(p[i]);
    }
    rfturn hdodf;
}

stbtid void
hbsh_in(LookupTbblf *ltbblf, TbblfIndfx indfx, HbshCodf hdodf)
{
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        TbblfElfmfnt *flfmfnt;
        TbblfIndfx    budkft;

        budkft                        = (hdodf % ltbblf->hbsh_budkft_dount);
        flfmfnt                       = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, indfx);
        flfmfnt->hdodf                = hdodf;
        flfmfnt->nfxt                 = ltbblf->hbsh_budkfts[budkft];
        ltbblf->hbsh_budkfts[budkft]  = indfx;
    }
}

stbtid void
rfsizf_hbsh_budkfts(LookupTbblf *ltbblf)
{
    /*    Don't wbnt to do this too oftfn. */

    /* Hbsh tbblf nffds rfsizing whfn it's smbllfr thbn 1/16 thf numbfr of
     *   flfmfnts usfd in thf tbblf. This is just b gufss.
     */
    if (    ( ltbblf->hbsh_budkft_dount < (ltbblf->nfxt_indfx >> 4) )
         && ( ltbblf->hbsh_budkft_dount > 0 )
         && ( ( ltbblf->rfsizfs % 10 ) == 0 )
         && ( ltbblf->budkft_wblks > 1000*ltbblf->hbsh_budkft_dount )
         ) {
        int         old_sizf;
        int         nfw_sizf;
        TbblfIndfx *nfw_budkfts;
        TbblfIndfx *old_budkfts;
        int         budkft;

        /* Indrfbsf sizf of hbsh_budkfts brrby, bnd rfhbsh bll flfmfnts */

        LOG3("Tbblf rfsizf", ltbblf->nbmf, ltbblf->rfsizfs);

        old_sizf    = ltbblf->hbsh_budkft_dount;
        old_budkfts = ltbblf->hbsh_budkfts;
        nfw_sizf    = (ltbblf->nfxt_indfx >> 3); /* 1/8 durrfnt usfd dount */
        SANITY_CHECK(nfw_sizf > old_sizf);
        nfw_budkfts = HPROF_MALLOC(nfw_sizf*(int)sizfof(TbblfIndfx));
        (void)mfmsft(nfw_budkfts, 0, nfw_sizf*(int)sizfof(TbblfIndfx));
        ltbblf->hbsh_budkft_dount = nfw_sizf;
        ltbblf->hbsh_budkfts      = nfw_budkfts;

        for ( budkft = 0 ; budkft < old_sizf ; budkft++ ) {
            TbblfIndfx    indfx;

            indfx = old_budkfts[budkft];
            whilf ( indfx != 0 ) {
                TbblfElfmfnt *flfmfnt;
                TbblfIndfx    nfxt;

                flfmfnt       = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, indfx);
                nfxt          = flfmfnt->nfxt;
                flfmfnt->nfxt = 0;
                hbsh_in(ltbblf, indfx, flfmfnt->hdodf);
                indfx         = nfxt;
            }
        }
        HPROF_FREE(old_budkfts);

        ltbblf->budkft_wblks = 0;
    }
}

stbtid void
rfsizf(LookupTbblf *ltbblf)
{
    int   old_sizf;
    int   nfw_sizf;
    void *old_tbblf;
    void *nfw_tbblf;
    int   nbytfs;
    int   obytfs;

    LOG3("Tbblf rfsizf", ltbblf->nbmf, ltbblf->rfsizfs);

    /* Adjust indrfmfnt on fvfry rfsizf
     *    Minimum is 1/4 thf sizf of thf durrfnt tbblf or 512.
     */
    old_sizf = ltbblf->tbblf_sizf;
    if ( ltbblf->tbblf_indr < (unsignfd)(old_sizf >> 2) ) {
        ltbblf->tbblf_indr = (old_sizf >> 2);
    }
    if ( ltbblf->tbblf_indr < 512 ) {
        ltbblf->tbblf_indr = 512;
    }
    nfw_sizf  = old_sizf + ltbblf->tbblf_indr;

    /* Bbsid tbblf flfmfnt brrby */
    obytfs    = old_sizf * ltbblf->flfm_sizf;
    nbytfs    = nfw_sizf * ltbblf->flfm_sizf;
    old_tbblf = ltbblf->tbblf;
    nfw_tbblf = HPROF_MALLOC(nbytfs);
    (void)mfmdpy(nfw_tbblf, old_tbblf, obytfs);
    (void)mfmsft(((dhbr*)nfw_tbblf)+obytfs, 0, nbytfs-obytfs);
    ltbblf->tbblf      = nfw_tbblf;
    ltbblf->tbblf_sizf = nfw_sizf;
    HPROF_FREE(old_tbblf);

    /* Thfn bit vfdtor for frffd fntrifs */
    if ( ltbblf->frffd_bv != NULL ) {
        void *old_bv;
        void *nfw_bv;

        obytfs = BV_ELEMENT_COUNT(old_sizf)*(int)sizfof(BV_CHUNK_TYPE);
        nbytfs = BV_ELEMENT_COUNT(nfw_sizf)*(int)sizfof(BV_CHUNK_TYPE);
        old_bv = ltbblf->frffd_bv;
        nfw_bv = HPROF_MALLOC(nbytfs);
        (void)mfmdpy(nfw_bv, old_bv, obytfs);
        (void)mfmsft(((dhbr*)nfw_bv)+obytfs, 0, nbytfs-obytfs);
        ltbblf->frffd_bv = nfw_bv;
        HPROF_FREE(old_bv);
    }

    /* Chfdk to sff if thf hbsh tbblf nffds rfsizing */
    rfsizf_hbsh_budkfts(ltbblf);

    ltbblf->rfsizfs++;
}

stbtid jboolfbn
kfys_fqubl(void *kfy_ptr1, void *kfy_ptr2, int kfy_lfn)
{
    unsignfd dhbr *     p1;
    unsignfd dhbr *     p2;
    int                 i;

    if ( kfy_lfn == 0 ) {
        rfturn JNI_TRUE;
    }

    /* Wf know thfsf brf blignfd bfdbusf wf mbllod'd thfm. */

    /* Compbrf word by word, thfn bytf by bytf */
    p1 = (unsignfd dhbr*)kfy_ptr1;
    p2 = (unsignfd dhbr*)kfy_ptr2;
    for ( i = 0 ; i < kfy_lfn-3 ; i += 4 ) {
        /*LINTED*/
        if ( *(unsignfd*)(p1+i) != *(unsignfd*)(p2+i) ) {
            rfturn JNI_FALSE;
        }
    }
    for ( ; i < kfy_lfn ; i++ ) {
        if ( p1[i] != p2[i] ) {
            rfturn JNI_FALSE;
        }
    }
    rfturn JNI_TRUE;
}

stbtid TbblfIndfx
find_fntry(LookupTbblf *ltbblf, void *kfy_ptr, int kfy_lfn, HbshCodf hdodf)
{
    TbblfIndfx indfx;

    HPROF_ASSERT(ltbblf!=NULL);

    indfx = 0;
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        TbblfIndfx budkft;
        TbblfIndfx prfv_indfx;

        HPROF_ASSERT(kfy_ptr!=NULL);
        HPROF_ASSERT(kfy_lfn>0);
        prfv_indfx  = 0;
        budkft      = (hdodf % ltbblf->hbsh_budkft_dount);
        indfx       = ltbblf->hbsh_budkfts[budkft];
        whilf ( indfx != 0 ) {
            TbblfElfmfnt *flfmfnt;
            TbblfElfmfnt *prfv_flfmfnt;

            flfmfnt = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, indfx);
            if ( hdodf == flfmfnt->hdodf &&
                 kfy_lfn == flfmfnt->kfy.lfn &&
                 kfys_fqubl(kfy_ptr, flfmfnt->kfy.ptr, kfy_lfn) ) {
                /* Plbdf this guy bt thf hfbd of thf budkft list */
                if ( prfv_indfx != 0 ) {
                    prfv_flfmfnt = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, prfv_indfx);
                    prfv_flfmfnt->nfxt  = flfmfnt->nfxt;
                    flfmfnt->nfxt       = ltbblf->hbsh_budkfts[budkft];
                    ltbblf->hbsh_budkfts[budkft]    = indfx;
                }
                brfbk;
            }
            prfv_indfx = indfx;
            indfx      = flfmfnt->nfxt;
            ltbblf->budkft_wblks++;
        }
    }
    rfturn indfx;
}

stbtid TbblfIndfx
sftup_nfw_fntry(LookupTbblf *ltbblf, void *kfy_ptr, int kfy_lfn, void *info_ptr)
{
    TbblfIndfx    indfx;
    TbblfElfmfnt *flfmfnt;
    void         *info;
    void         *dup_kfy;

    /* Assumf wf nffd nfw bllodbtions for kfy bnd info */
    dup_kfy  = NULL;
    info     = NULL;

    /* Look for b frffd flfmfnt */
    indfx = 0;
    if ( ltbblf->frffd_dount > 0 ) {
        indfx    = find_frffd_fntry(ltbblf);
    }
    if ( indfx != 0 ) {
        int old_kfy_lfn;

        /* Found b frffd flfmfnt, rf-usf whbt wf dbn but dlfbn it up. */
        flfmfnt     = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, indfx);
        dup_kfy     = flfmfnt->kfy.ptr;
        old_kfy_lfn = flfmfnt->kfy.lfn;
        info        = flfmfnt->info;
        (void)mfmsft(flfmfnt, 0, ltbblf->flfm_sizf);

        /* Toss thf kfy spbdf if sizf is too smbll to hold nfw kfy */
        if ( kfy_ptr != NULL ) {
            if ( old_kfy_lfn < kfy_lfn ) {
                /* This dould lfbk spbdf in thf Blodks if kfys brf vbribblf
                 *    in sizf AND thf tbblf dofs frffs of flfmfnts.
                 */
                dup_kfy = NULL;
            }
        }
    } flsf {

        /* Brbnd nfw tbblf flfmfnt */
        if ( ltbblf->nfxt_indfx >= ltbblf->tbblf_sizf ) {
            rfsizf(ltbblf);
        }
        indfx = ltbblf->nfxt_indfx++;
        flfmfnt = (TbblfElfmfnt*)ELEMENT_PTR(ltbblf, indfx);
    }

    /* Sftup info brfb */
    if ( ltbblf->info_sizf > 0 ) {
        if ( info == NULL ) {
            info = blodks_bllod(ltbblf->info_blodks, ltbblf->info_sizf);
        }
        if ( info_ptr==NULL ) {
            (void)mfmsft(info, 0, ltbblf->info_sizf);
        } flsf {
            (void)mfmdpy(info, info_ptr, ltbblf->info_sizf);
        }
    }

    /* Sftup kfy brfb if onf wbs providfd */
    if ( kfy_ptr != NULL ) {
        if ( dup_kfy == NULL ) {
            dup_kfy  = blodks_bllod(ltbblf->kfy_blodks, kfy_lfn);
        }
        (void)mfmdpy(dup_kfy, kfy_ptr, kfy_lfn);
    }

    /* Fill in flfmfnt */
    flfmfnt->kfy.ptr = dup_kfy;
    flfmfnt->kfy.lfn = kfy_lfn;
    flfmfnt->info    = info;

    rfturn indfx;
}

LookupTbblf *
tbblf_initiblizf(donst dhbr *nbmf, int sizf, int indr, int budkft_dount,
                        int info_sizf)
{
    LookupTbblf * ltbblf;
    dhbr          lodk_nbmf[80];
    int           flfm_sizf;
    int           kfy_sizf;

    HPROF_ASSERT(nbmf!=NULL);
    HPROF_ASSERT(sizf>0);
    HPROF_ASSERT(indr>0);
    HPROF_ASSERT(budkft_dount>=0);
    HPROF_ASSERT(info_sizf>=0);

    kfy_sizf = 1;
    ltbblf = (LookupTbblf *)HPROF_MALLOC((int)sizfof(LookupTbblf));
    (void)mfmsft(ltbblf, 0, (int)sizfof(LookupTbblf));

    (void)strndpy(ltbblf->nbmf, nbmf, sizfof(ltbblf->nbmf));

    flfm_sizf = (int)sizfof(TbblfElfmfnt);

    ltbblf->nfxt_indfx          = 1; /* Nfvfr usf indfx 0 */
    ltbblf->tbblf_sizf          = sizf;
    ltbblf->tbblf_indr          = indr;
    ltbblf->hbsh_budkft_dount   = budkft_dount;
    ltbblf->flfm_sizf           = flfm_sizf;
    ltbblf->info_sizf           = info_sizf;
    if ( info_sizf > 0 ) {
        ltbblf->info_blodks     = blodks_init(8, info_sizf, indr);
    }
    if ( kfy_sizf > 0 ) {
        ltbblf->kfy_blodks      = blodks_init(8, kfy_sizf, indr);
    }
    ltbblf->tbblf               = HPROF_MALLOC(sizf * flfm_sizf);
    (void)mfmsft(ltbblf->tbblf, 0, sizf * flfm_sizf);
    if ( budkft_dount > 0 ) {
        int nbytfs;

        nbytfs               = (int)(budkft_dount*sizfof(TbblfIndfx));
        ltbblf->hbsh_budkfts = (TbblfIndfx*)HPROF_MALLOC(nbytfs);
        (void)mfmsft(ltbblf->hbsh_budkfts, 0, nbytfs);
    }

    (void)md_snprintf(lodk_nbmf, sizfof(lodk_nbmf),
                "HPROF %s tbblf lodk", nbmf);
    lodk_nbmf[sizfof(lodk_nbmf)-1] = 0;
    ltbblf->lodk        = lodk_drfbtf(lodk_nbmf);
    ltbblf->sfribl_num  = gdbtb->tbblf_sfribl_numbfr_dountfr++;
    ltbblf->hbrf        = (ltbblf->sfribl_num << 28);

    LOG3("Tbblf initiblizfd", ltbblf->nbmf, ltbblf->tbblf_sizf);
    rfturn ltbblf;
}

int
tbblf_flfmfnt_dount(LookupTbblf *ltbblf)
{
    int nflfms;

    HPROF_ASSERT(ltbblf!=NULL);

    lodk_fntfr(ltbblf->lodk); {
        nflfms = ltbblf->nfxt_indfx-1;
    } lodk_fxit(ltbblf->lodk);

    rfturn nflfms;
}

void
tbblf_frff_fntry(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    HPROF_ASSERT(ltbblf!=NULL);
    SANITY_CHECK_HARE(indfx, ltbblf->hbrf);
    indfx = SANITY_REMOVE_HARE(indfx);
    SANITY_CHECK_INDEX(ltbblf, indfx);

    lodk_fntfr(ltbblf->lodk); {
        HPROF_ASSERT(!is_frffd_fntry(ltbblf, indfx));
        frff_fntry(ltbblf, indfx);
    } lodk_fxit(ltbblf->lodk);
}

void
tbblf_wblk_itfms(LookupTbblf *ltbblf, LookupTbblfItfrbtor fund, void* brg)
{
    if ( ltbblf == NULL || ltbblf->nfxt_indfx <= 1 ) {
        rfturn;
    }
    HPROF_ASSERT(fund!=NULL);

    lodk_fntfr(ltbblf->lodk); {
        TbblfIndfx indfx;
        int        fdount;

        LOG3("tbblf_wblk_itfms() dount+frff", ltbblf->nbmf, ltbblf->nfxt_indfx);
        fdount = 0;
        for ( indfx = 1 ; indfx < ltbblf->nfxt_indfx ; indfx++ ) {
            if ( ! is_frffd_fntry(ltbblf, indfx) ) {
                void *kfy_ptr;
                int   kfy_lfn;
                void *info;

                gft_kfy(ltbblf, indfx, &kfy_ptr, &kfy_lfn);
                if ( ltbblf->info_sizf == 0 ) {
                    info = NULL;
                } flsf {
                    info = gft_info(ltbblf, indfx);
                }
                (*fund)(SANITY_ADD_HARE(indfx, ltbblf->hbrf), kfy_ptr, kfy_lfn, info, brg);
                if ( is_frffd_fntry(ltbblf, indfx) ) {
                    fdount++;
                }
            } flsf {
                fdount++;
            }
        }
        LOG3("tbblf_wblk_itfms() dount-frff", ltbblf->nbmf, ltbblf->nfxt_indfx);
        HPROF_ASSERT(fdount==ltbblf->frffd_dount);
    } lodk_fxit(ltbblf->lodk);
}

void
tbblf_dlfbnup(LookupTbblf *ltbblf, LookupTbblfItfrbtor fund, void *brg)
{
    if ( ltbblf == NULL ) {
        rfturn;
    }

    if ( fund != NULL ) {
        tbblf_wblk_itfms(ltbblf, fund, brg);
    }

    lodk_fntfr(ltbblf->lodk); {

        HPROF_FREE(ltbblf->tbblf);
        if ( ltbblf->hbsh_budkfts != NULL ) {
            HPROF_FREE(ltbblf->hbsh_budkfts);
        }
        if ( ltbblf->frffd_bv != NULL ) {
            HPROF_FREE(ltbblf->frffd_bv);
        }
        if ( ltbblf->info_blodks != NULL ) {
            blodks_tfrm(ltbblf->info_blodks);
            ltbblf->info_blodks = NULL;
        }
        if ( ltbblf->kfy_blodks != NULL ) {
            blodks_tfrm(ltbblf->kfy_blodks);
            ltbblf->kfy_blodks = NULL;
        }

    } lodk_fxit(ltbblf->lodk);

    lodk_dfstroy(ltbblf->lodk);
    ltbblf->lodk = NULL;

    HPROF_FREE(ltbblf);
    ltbblf = NULL;
}

TbblfIndfx
tbblf_drfbtf_fntry(LookupTbblf *ltbblf, void *kfy_ptr, int kfy_lfn, void *info_ptr)
{
    TbblfIndfx indfx;
    HbshCodf   hdodf;

    HPROF_ASSERT(ltbblf!=NULL);

    /* Crfbtf hbsh dodf if nffdfd */
    hdodf = 0;
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        hdodf = hbshdodf(kfy_ptr, kfy_lfn);
    }

    /* Crfbtf b nfw fntry */
    lodk_fntfr(ltbblf->lodk); {

        /* Nffd to drfbtf b nfw fntry */
        indfx = sftup_nfw_fntry(ltbblf, kfy_ptr, kfy_lfn, info_ptr);

        /* Add to hbsh tbblf if wf hbvf onf */
        if ( ltbblf->hbsh_budkft_dount > 0 ) {
            hbsh_in(ltbblf, indfx, hdodf);
        }

    } lodk_fxit(ltbblf->lodk);
    rfturn SANITY_ADD_HARE(indfx, ltbblf->hbrf);
}

TbblfIndfx
tbblf_find_fntry(LookupTbblf *ltbblf, void *kfy_ptr, int kfy_lfn)
{
    TbblfIndfx indfx;
    HbshCodf   hdodf;

    /* Crfbtf hbsh dodf if nffdfd */
    hdodf = 0;
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        hdodf = hbshdodf(kfy_ptr, kfy_lfn);
    }

    /* Look for flfmfnt */
    lodk_fntfr(ltbblf->lodk); {
        indfx = find_fntry(ltbblf, kfy_ptr, kfy_lfn, hdodf);
    } lodk_fxit(ltbblf->lodk);

    rfturn indfx==0 ? indfx : SANITY_ADD_HARE(indfx, ltbblf->hbrf);
}

TbblfIndfx
tbblf_find_or_drfbtf_fntry(LookupTbblf *ltbblf, void *kfy_ptr, int kfy_lfn,
                jboolfbn *pnfw_fntry, void *info_ptr)
{
    TbblfIndfx indfx;
    HbshCodf   hdodf;

    /* Assumf it is NOT b nfw fntry for now */
    if ( pnfw_fntry ) {
        *pnfw_fntry = JNI_FALSE;
    }

    /* Crfbtf hbsh dodf if nffdfd */
    hdodf = 0;
    if ( ltbblf->hbsh_budkft_dount > 0 ) {
        hdodf = hbshdodf(kfy_ptr, kfy_lfn);
    }

    /* Look for flfmfnt */
    indfx = 0;
    lodk_fntfr(ltbblf->lodk); {
        if ( ltbblf->hbsh_budkft_dount > 0 ) {
            indfx = find_fntry(ltbblf, kfy_ptr, kfy_lfn, hdodf);
        }
        if ( indfx == 0 ) {

            /* Nffd to drfbtf b nfw fntry */
            indfx = sftup_nfw_fntry(ltbblf, kfy_ptr, kfy_lfn, info_ptr);

            /* Add to hbsh tbblf if wf hbvf onf */
            if ( ltbblf->hbsh_budkft_dount > 0 ) {
                hbsh_in(ltbblf, indfx, hdodf);
            }

            if ( pnfw_fntry ) {
                *pnfw_fntry = JNI_TRUE;
            }
        }
    } lodk_fxit(ltbblf->lodk);

    rfturn SANITY_ADD_HARE(indfx, ltbblf->hbrf);
}

void *
tbblf_gft_info(LookupTbblf *ltbblf, TbblfIndfx indfx)
{
    void *info;

    HPROF_ASSERT(ltbblf!=NULL);
    HPROF_ASSERT(ltbblf->info_sizf > 0);
    SANITY_CHECK_HARE(indfx, ltbblf->hbrf);
    indfx = SANITY_REMOVE_HARE(indfx);
    SANITY_CHECK_INDEX(ltbblf, indfx);

    lodk_fntfr(ltbblf->lodk); {
        HPROF_ASSERT(!is_frffd_fntry(ltbblf, indfx));
        info = gft_info(ltbblf,indfx);
    } lodk_fxit(ltbblf->lodk);

    rfturn info;
}

void
tbblf_gft_kfy(LookupTbblf *ltbblf, TbblfIndfx indfx, void **pkfy_ptr, int *pkfy_lfn)
{
    HPROF_ASSERT(ltbblf!=NULL);
    HPROF_ASSERT(pkfy_ptr!=NULL);
    HPROF_ASSERT(pkfy_lfn!=NULL);
    SANITY_CHECK_HARE(indfx, ltbblf->hbrf);
    HPROF_ASSERT(ltbblf->flfm_sizf!=0);
    indfx = SANITY_REMOVE_HARE(indfx);
    SANITY_CHECK_INDEX(ltbblf, indfx);

    lodk_fntfr(ltbblf->lodk); {
        HPROF_ASSERT(!is_frffd_fntry(ltbblf, indfx));
        gft_kfy(ltbblf, indfx, pkfy_ptr, pkfy_lfn);
    } lodk_fxit(ltbblf->lodk);
}

void
tbblf_lodk_fntfr(LookupTbblf *ltbblf)
{
    lodk_fntfr(ltbblf->lodk);
}

void
tbblf_lodk_fxit(LookupTbblf *ltbblf)
{
    lodk_fxit(ltbblf->lodk);
}
