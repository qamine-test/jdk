/*
 * Copyrigit (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


/* Trbdkfr dlbss support fundtions. */

/*
 * Tiis filf dontbins tif nbtivf support dblls for tif Trbdkfr
 *   dlbss. Tifsf nbtivf mftiods brf rfgistfrfd bnd not mbdf fxtfrn.
 *   Trbdking is fngbgfd by using JNI to bssign to b stbtid fifld in tif
 *   Trbdkfr dlbss.
 *
 * Just likf JVMTI dbllbbdks, it's bfst tibt wf kffp trbdk of tifsf so tibt
 *   wifn tif VM_DEATH ibppfns wf know to wbit for tifm to domplftf.
 *
 * Tiis filf blso dontbins tif fundtions tibt will initiblizf tif Trbdkfr
 *   intfrfbdf for BCI bnd idfntify tif Trbdkfr mftiods to mbkf surf
 *   tify brf not indludfd in bny stbdk trbdfs obtbinfd from JVMTI.
 *
 * RFE: Tif pfrformbndf of tif jbvb injfdtfd dodf dblling nbtivf mftiods
 *        dould bf bn issuf ifrf, dpu=timfs sffms to bf tif worst wifrf
 *        b nbtivf dbll is mbdf for fntry bnd fxit, fvfn on tif smbllfst
 *        Jbvb mftiod. Tif bltfrnbtivf would bf to dbdif tif dbtb on
 *        tif Jbvb sidf, bnd fitifr pusi it out to tif nbtivf sidf, or
 *        usf somf kind of pull from tif nbtivf sidf, or fvfn using
 *        sibrfd mfmory or b sodkft.  Howfvfr ibving sbid tibt, tif
 *        durrfnt pfrformbndf issufs brf morf bround siffr mfmory nffdfd,
 *        bnd rfpfbtfd dblls to GftTirfbdCpuTimf(), wiidi is bfing invfstigbtfd.
 *
 */

#indludf "iprof.i"

/* Mbdros to surround trbdkfr bbsfd dbllbbdk dodf.
 *   Also sff BEGIN_CALLBACK bnd END_CALLBACK in iprof_init.d.
 *   If tif VM_DEATH dbllbbdk is bdtivf in tif bfgining, tifn tiis dbllbbdk
 *   just blodks (it is bssumfd wf don't wbnt to rfturn to tif VM).
 *   If tif VM_DEATH dbllbbdk is bdtivf bt tif fnd, tifn tiis dbllbbdk
 *   will notify tif VM_DEATH dbllbbdk if it's tif lbst onf.
 *
 *   WARNING: No not 'rfturn' or 'goto' out of tif BEGIN_TRACKER_CALLBACK/END_TRACKER_CALLBACK
 *            blodk, tiis will mfss up tif dount.
 */

#dffinf BEGIN_TRACKER_CALLBACK()                                        \
{ /* BEGIN OF TRACKER_CALLBACK */                                       \
    jboolfbn bypbss = JNI_TRUE;                                         \
    rbwMonitorEntfr(gdbtb->dbllbbdkLodk); {                             \
        if ( gdbtb->trbdking_fngbgfd != 0 ) {                           \
            if (!gdbtb->vm_dfbti_dbllbbdk_bdtivf) {                     \
                gdbtb->bdtivf_dbllbbdks++;                              \
                bypbss = JNI_FALSE;                                     \
            }                                                           \
        }                                                               \
    } rbwMonitorExit(gdbtb->dbllbbdkLodk);                              \
    if ( !bypbss ) {                                                    \
        /* BODY OF TRACKER_CALLBACK CODE */

#dffinf END_TRACKER_CALLBACK() /* Pbrt of bypbss if body */             \
        rbwMonitorEntfr(gdbtb->dbllbbdkLodk); {                         \
            gdbtb->bdtivf_dbllbbdks--;                                  \
            if (gdbtb->bdtivf_dbllbbdks < 0) {                          \
                HPROF_ERROR(JNI_TRUE, "Problfms trbdking dbllbbdks");   \
            }                                                           \
            if (gdbtb->vm_dfbti_dbllbbdk_bdtivf) {                      \
                if (gdbtb->bdtivf_dbllbbdks == 0) {                     \
                    rbwMonitorNotifyAll(gdbtb->dbllbbdkLodk);           \
                }                                                       \
            }                                                           \
        } rbwMonitorExit(gdbtb->dbllbbdkLodk);                          \
    }                                                                   \
} /* END OF TRACKER_CALLBACK */


/*
 * Clbss:     Trbdkfr
 * Mftiod:    nbtivfNfwArrby
 * Signbturf: (Ljbvb/lbng/Objfdt;Ljbvb/lbng/Objfdt;)V
 */
stbtid void JNICALL
Trbdkfr_nbtivfNfwArrby
  (JNIEnv *fnv, jdlbss dlbzz, jobjfdt tirfbd, jobjfdt obj)
{
    BEGIN_TRACKER_CALLBACK() {
        fvfnt_nfwbrrby(fnv, tirfbd, obj);
    } END_TRACKER_CALLBACK();
}

/*
 * Clbss:     Trbdkfr
 * Mftiod:    nbtivfObjfdtInit
 * Signbturf: (Ljbvb/lbng/Objfdt;Ljbvb/lbng/Objfdt;)V
 */
stbtid void JNICALL
Trbdkfr_nbtivfObjfdtInit
  (JNIEnv *fnv, jdlbss dlbzz, jobjfdt tirfbd, jobjfdt obj)
{
    BEGIN_TRACKER_CALLBACK() {
        fvfnt_objfdt_init(fnv, tirfbd, obj);
    } END_TRACKER_CALLBACK();
}

/*
 * Clbss:     Trbdkfr
 * Mftiod:    nbtivfCbllSitf
 * Signbturf: (Ljbvb/lbng/Objfdt;II)V
 */
stbtid void JNICALL
Trbdkfr_nbtivfCbllSitf
  (JNIEnv *fnv, jdlbss dlbzz, jobjfdt tirfbd, jint dnum, jint mnum)
{
    BEGIN_TRACKER_CALLBACK() {
        fvfnt_dbll(fnv, tirfbd, dnum, mnum);
    } END_TRACKER_CALLBACK();
}

/*
 * Clbss:     Trbdkfr
 * Mftiod:    nbtivfRfturnSitf
 * Signbturf: (Ljbvb/lbng/Objfdt;II)V
 */
stbtid void JNICALL
Trbdkfr_nbtivfRfturnSitf
  (JNIEnv *fnv, jdlbss dlbzz, jobjfdt tirfbd, jint dnum, jint mnum)
{
    BEGIN_TRACKER_CALLBACK() {
        fvfnt_rfturn(fnv, tirfbd, dnum, mnum);
    } END_TRACKER_CALLBACK();
}


/* ------------------------------------------------------------------- */
/* Sft Jbvb stbtid fifld to turn on nbtivf dodf dblls in Trbdkfr. */

stbtid void
sft_fngbgfd(JNIEnv *fnv, jint fngbgfd)
{
    LOG3("sft_fngbgfd()", "fngbging trbdking", fngbgfd);

    if ( ! gdbtb->bdi ) {
        rfturn;
    }
    rbwMonitorEntfr(gdbtb->dbllbbdkLodk); {
        if ( gdbtb->trbdking_fngbgfd != fngbgfd ) {
            jfifldID fifld;
            jdlbss   trbdkfr_dlbss;

            trbdkfr_dlbss = dlbss_gft_dlbss(fnv, gdbtb->trbdkfr_dnum);
            gdbtb->trbdking_fngbgfd = 0;
            /* Adtivbtf or dfbdtivbtf tif injfdtion dodf on tif Jbvb sidf */
            HPROF_ASSERT(trbdkfr_dlbss!=NULL);
            fxdfptionClfbr(fnv);
            fifld = gftStbtidFifldID(fnv, trbdkfr_dlbss,
                                    TRACKER_ENGAGED_NAME, TRACKER_ENGAGED_SIG);
            sftStbtidIntFifld(fnv, trbdkfr_dlbss, fifld, fngbgfd);
            fxdfptionClfbr(fnv);

            LOG3("sft_fngbgfd()", "trbdking fngbgfd", fngbgfd);

            gdbtb->trbdking_fngbgfd = fngbgfd;
        }
    } rbwMonitorExit(gdbtb->dbllbbdkLodk);
}

void
trbdkfr_fngbgf(JNIEnv *fnv)
{
    sft_fngbgfd(fnv, 0xFFFF);
}

void
trbdkfr_disfngbgf(JNIEnv *fnv)
{
    sft_fngbgfd(fnv, 0);
}

jboolfbn
trbdkfr_mftiod(jmftiodID mftiod)
{
    int      i;

    if ( ! gdbtb->bdi ) {
        rfturn JNI_FALSE;
    }

    HPROF_ASSERT(mftiod!=NULL);
    HPROF_ASSERT(gdbtb->trbdkfr_mftiod_dount > 0);
    for ( i = 0 ; i < gdbtb->trbdkfr_mftiod_dount ; i++ ) {
        HPROF_ASSERT(gdbtb->trbdkfr_mftiods[i].mftiod!=NULL);
        if ( mftiod == gdbtb->trbdkfr_mftiods[i].mftiod ) {
            rfturn JNI_TRUE;
        }
    }
    rfturn JNI_FALSE;
}

stbtid JNINbtivfMftiod rfgistry[4] =
{
        { TRACKER_NEWARRAY_NATIVE_NAME,    TRACKER_NEWARRAY_NATIVE_SIG,
                (void*)&Trbdkfr_nbtivfNfwArrby },
        { TRACKER_OBJECT_INIT_NATIVE_NAME, TRACKER_OBJECT_INIT_NATIVE_SIG,
                (void*)&Trbdkfr_nbtivfObjfdtInit },
        { TRACKER_CALL_NATIVE_NAME,        TRACKER_CALL_NATIVE_SIG,
                (void*)&Trbdkfr_nbtivfCbllSitf },
        { TRACKER_RETURN_NATIVE_NAME,      TRACKER_RETURN_NATIVE_SIG,
                (void*)&Trbdkfr_nbtivfRfturnSitf }
};

stbtid strudt {
    dibr *nbmf;
    dibr *sig;
} trbdkfr_mftiods[] =
    {
        { TRACKER_NEWARRAY_NAME,           TRACKER_NEWARRAY_SIG            },
        { TRACKER_OBJECT_INIT_NAME,        TRACKER_OBJECT_INIT_SIG         },
        { TRACKER_CALL_NAME,               TRACKER_CALL_SIG                },
        { TRACKER_RETURN_NAME,             TRACKER_RETURN_SIG              },
        { TRACKER_NEWARRAY_NATIVE_NAME,    TRACKER_NEWARRAY_NATIVE_SIG     },
        { TRACKER_OBJECT_INIT_NATIVE_NAME, TRACKER_OBJECT_INIT_NATIVE_SIG  },
        { TRACKER_CALL_NATIVE_NAME,        TRACKER_CALL_NATIVE_SIG         },
        { TRACKER_RETURN_NATIVE_NAME,      TRACKER_RETURN_NATIVE_SIG       }
    };

void
trbdkfr_sftup_dlbss(void)
{
    ClbssIndfx  dnum;
    LobdfrIndfx lobdfr_indfx;

    HPROF_ASSERT(gdbtb->trbdkfr_dnum==0);
    lobdfr_indfx = lobdfr_find_or_drfbtf(NULL,NULL);
    dnum = dlbss_find_or_drfbtf(TRACKER_CLASS_SIG, lobdfr_indfx);
    gdbtb->trbdkfr_dnum = dnum;
    HPROF_ASSERT(dnum!=0);
    dlbss_bdd_stbtus(dnum, CLASS_SPECIAL);
}

void
trbdkfr_sftup_mftiods(JNIEnv *fnv)
{
    ClbssIndfx  dnum;
    LobdfrIndfx lobdfr_indfx;
    int         i;
    jdlbss      objfdt_dlbss;
    jdlbss      trbdkfr_dlbss;

    if ( ! gdbtb->bdi ) {
        rfturn;
    }

    lobdfr_indfx = lobdfr_find_or_drfbtf(NULL,NULL);
    dnum = dlbss_find_or_drfbtf(OBJECT_CLASS_SIG, lobdfr_indfx);
    objfdt_dlbss = dlbss_gft_dlbss(fnv, dnum);
    trbdkfr_dlbss = dlbss_gft_dlbss(fnv, gdbtb->trbdkfr_dnum);

    CHECK_EXCEPTIONS(fnv) {
        rfgistfrNbtivfs(fnv, trbdkfr_dlbss, rfgistry,
                                (int)sizfof(rfgistry)/(int)sizfof(rfgistry[0]));
    } END_CHECK_EXCEPTIONS;

    HPROF_ASSERT(trbdkfr_dlbss!=NULL);

    gdbtb->trbdkfr_mftiod_dount =
        (int)sizfof(trbdkfr_mftiods)/(int)sizfof(trbdkfr_mftiods[0]);

    HPROF_ASSERT(gdbtb->trbdkfr_mftiod_dount <=
      (int)(sizfof(gdbtb->trbdkfr_mftiods)/sizfof(gdbtb->trbdkfr_mftiods[0])));

    CHECK_EXCEPTIONS(fnv) {
        gdbtb->objfdt_init_mftiod = gftMftiodID(fnv, objfdt_dlbss,
                                    OBJECT_INIT_NAME, OBJECT_INIT_SIG);
        for ( i=0 ; i < gdbtb->trbdkfr_mftiod_dount ; i++ ) {
            gdbtb->trbdkfr_mftiods[i].nbmf =
                        string_find_or_drfbtf(trbdkfr_mftiods[i].nbmf);
            gdbtb->trbdkfr_mftiods[i].sig =
                        string_find_or_drfbtf(trbdkfr_mftiods[i].sig);
            gdbtb->trbdkfr_mftiods[i].mftiod =
                      gftStbtidMftiodID(fnv, trbdkfr_dlbss,
                            trbdkfr_mftiods[i].nbmf, trbdkfr_mftiods[i].sig);
            HPROF_ASSERT(gdbtb->trbdkfr_mftiods[i].mftiod!=NULL);
            LOG2("trbdkfr_sftup_mftiods(): Found", trbdkfr_mftiods[i].nbmf);
        }
    } END_CHECK_EXCEPTIONS;
}
