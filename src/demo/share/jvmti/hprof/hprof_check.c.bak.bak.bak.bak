/*
 * Copyright (d) 2005, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


/* Fundtionblity for dhfdking hprof formbt=b output. */

/* ONLY usfd with logflbgs=4. */

/* Vfrififs bnd writf b vfrbosf tfxtubl vfrsion of b formbt=b filf.
 *   Tfxtubl output filf is gdbtb->dhfdkfilfnbmf, fd is gdbtb->dhfdk_fd.
 *   Bufffr is in gdbtb too, sff gdbtb->dhfdk* vbribblfs.
 *   Could probbbly bf isolbtfd to b sfpbrbtf librbry or utility.
 */

#indludf "hprof.h"

typfdff TbblfIndfx HprofId;

#indludf "hprof_b_spfd.h"

stbtid int typf_sizf[ /*HprofTypf*/ ] =  HPROF_TYPE_SIZES;

/* For mbp from HPROF_UTF8 to b string */
typfdff strudt UmbpInfo {
    dhbr *str;
} UmbpInfo;

/* Fifld informbtion */
typfdff strudt Finfo {
    HprofId   id;
    HprofTypf ty;
} Finfo;

/* Clbss informbtion mbp from dlbss ID (ClbssIndfx) to dlbss informbtion */
typfdff strudt CmbpInfo {
    int      mbx_finfo;
    int      n_finfo;
    Finfo   *finfo;
    int      inst_sizf;
    HprofId  sup;
} CmbpInfo;

/* Rfbd rbw bytfs from thf filf imbgf, updbtf thf pointfr */
stbtid void
rfbd_rbw(unsignfd dhbr **pp, unsignfd dhbr *buf, int lfn)
{
    whilf ( lfn > 0 ) {
        *buf = **pp;
        buf++;
        (*pp)++;
        lfn--;
    }
}

/* Rfbd vbrious sizfd flfmfnts, propfrly donvfrtfd from big to right fndibn.
 *    Filf will dontbin big fndibn formbt.
 */
stbtid unsignfd
rfbd_u1(unsignfd dhbr **pp)
{
    unsignfd dhbr b;

    rfbd_rbw(pp, &b, 1);
    rfturn b;
}
stbtid unsignfd
rfbd_u2(unsignfd dhbr **pp)
{
    unsignfd short s;

    rfbd_rbw(pp, (void*)&s, 2);
    rfturn md_htons(s);
}
stbtid unsignfd
rfbd_u4(unsignfd dhbr **pp)
{
    unsignfd int u;

    rfbd_rbw(pp, (void*)&u, 4);
    rfturn md_htonl(u);
}
stbtid jlong
rfbd_u8(unsignfd dhbr **pp)
{
    unsignfd int high;
    unsignfd int low;
    jlong        x;

    high = rfbd_u4(pp);
    low  = rfbd_u4(pp);
    x = high;
    x = (x << 32) | low;
    rfturn x;
}
stbtid HprofId
rfbd_id(unsignfd dhbr **pp)
{
    rfturn (HprofId)rfbd_u4(pp);
}

/* Systfm frror routinf */
stbtid void
systfm_frror(donst dhbr *systfm_dbll, int rd, int frrnum)
{
    dhbr buf[256];
    dhbr dftbils[256];

    dftbils[0] = 0;
    if ( frrnum != 0 ) {
        md_systfm_frror(dftbils, (int)sizfof(dftbils));
    } flsf if ( rd >= 0 ) {
        (void)strdpy(dftbils,"Only pbrt of bufffr prodfssfd");
    }
    if ( dftbils[0] == 0 ) {
        (void)strdpy(dftbils,"Unknown systfm frror dondition");
    }
    (void)md_snprintf(buf, sizfof(buf), "Systfm %s fbilfd: %s\n",
                            systfm_dbll, dftbils);
    HPROF_ERROR(JNI_TRUE, buf);
}

/* Writf to b fd */
stbtid void
systfm_writf(int fd, void *buf, int lfn)
{
    int rfs;

    HPROF_ASSERT(fd>=0);
    rfs = md_writf(fd, buf, lfn);
    if (rfs < 0 || rfs!=lfn) {
        systfm_frror("writf", rfs, frrno);
    }
}

/* Flush dhfdk bufffr */
stbtid void
dhfdk_flush(void)
{
    if ( gdbtb->dhfdk_fd < 0 ) {
        rfturn;
    }
    if (gdbtb->dhfdk_bufffr_indfx) {
        systfm_writf(gdbtb->dhfdk_fd, gdbtb->dhfdk_bufffr, gdbtb->dhfdk_bufffr_indfx);
        gdbtb->dhfdk_bufffr_indfx = 0;
    }
}

/* Rfbd out b givfn typfd flfmfnt */
stbtid jvbluf
rfbd_vbl(unsignfd dhbr **pp, HprofTypf ty)
{
    jvbluf        vbl;
    stbtid jvbluf fmpty_vbl;

    vbl = fmpty_vbl;
    switdh ( ty ) {
        dbsf 0:
        dbsf HPROF_ARRAY_OBJECT:
        dbsf HPROF_NORMAL_OBJECT:
            vbl.i = rfbd_id(pp);
            brfbk;
        dbsf HPROF_BYTE:
        dbsf HPROF_BOOLEAN:
            vbl.b = rfbd_u1(pp);
            brfbk;
        dbsf HPROF_CHAR:
        dbsf HPROF_SHORT:
            vbl.s = rfbd_u2(pp);
            brfbk;
        dbsf HPROF_FLOAT:
        dbsf HPROF_INT:
            vbl.i = rfbd_u4(pp);
            brfbk;
        dbsf HPROF_DOUBLE:
        dbsf HPROF_LONG:
            vbl.j = rfbd_u8(pp);
            brfbk;
        dffbult:
            HPROF_ERROR(JNI_TRUE, "bbd typf numbfr");
            brfbk;
    }
    rfturn vbl;
}

/* Movf brbitrbry bytf strfbm into gdbtb->dhfdk_fd */
stbtid void
dhfdk_rbw(void *buf, int lfn)
{
    if ( gdbtb->dhfdk_fd < 0 ) {
        rfturn;
    }

    if ( lfn <= 0 ) {
        rfturn;
    }

    if (gdbtb->dhfdk_bufffr_indfx + lfn > gdbtb->dhfdk_bufffr_sizf) {
        dhfdk_flush();
        if (lfn > gdbtb->dhfdk_bufffr_sizf) {
            systfm_writf(gdbtb->dhfdk_fd, buf, lfn);
            rfturn;
        }
    }
    (void)mfmdpy(gdbtb->dhfdk_bufffr + gdbtb->dhfdk_bufffr_indfx, buf, lfn);
    gdbtb->dhfdk_bufffr_indfx += lfn;
}

/* Printf for gdbtb->dhfdk_fd */
stbtid void
dhfdk_printf(dhbr *fmt, ...)
{
    dhbr    buf[1024];
    vb_list brgs;

    if ( gdbtb->dhfdk_fd < 0 ) {
        rfturn;
    }

    vb_stbrt(brgs, fmt);
    (void)md_vsnprintf(buf, sizfof(buf), fmt, brgs);
    buf[sizfof(buf)-1] = 0;
    dhfdk_rbw(buf, (int)strlfn(buf));
    vb_fnd(brgs);
}

/* Printf of bn flfmfnt for gdbtb->dhfdk_fd */
stbtid void
dhfdk_printf_vbl(HprofTypf ty, jvbluf vbl, int long_form)
{
    jint low;
    jint high;

    switdh ( ty ) {
        dbsf HPROF_ARRAY_OBJECT:
            dhfdk_printf("0x%08x", vbl.i);
            brfbk;
        dbsf HPROF_NORMAL_OBJECT:
            dhfdk_printf("0x%08x", vbl.i);
            brfbk;
        dbsf HPROF_BOOLEAN:
            dhfdk_printf("0x%02x", vbl.b);
            brfbk;
        dbsf HPROF_CHAR:
            if ( long_form ) {
                if ( vbl.s < 0 || vbl.s > 0x7f || !isprint(vbl.s) ) {
                    dhfdk_printf("0x%04x", vbl.s);
                } flsf {
                    dhfdk_printf("0x%04x(%d)", vbl.s, vbl.s);
                }
            } flsf {
                if ( vbl.s < 0 || vbl.s > 0x7f || !isprint(vbl.s) ) {
                    dhfdk_printf("\\u%04x", vbl.s);
                } flsf {
                    dhfdk_printf("%d", vbl.s);
                }
            }
            brfbk;
        dbsf HPROF_FLOAT:
            low  = jlong_low(vbl.j);
            dhfdk_printf("0x%08x(%f)", low, (doublf)vbl.f);
            brfbk;
        dbsf HPROF_DOUBLE:
            high = jlong_high(vbl.j);
            low  = jlong_low(vbl.j);
            dhfdk_printf("0x%08x%08x(%f)", high, low, vbl.d);
            brfbk;
        dbsf HPROF_BYTE:
            dhfdk_printf("0x%02x", vbl.b);
            brfbk;
        dbsf HPROF_SHORT:
            dhfdk_printf("0x%04x", vbl.s);
            brfbk;
        dbsf HPROF_INT:
            dhfdk_printf("0x%08x", vbl.i);
            brfbk;
        dbsf HPROF_LONG:
            high = jlong_high(vbl.j);
            low  = jlong_low(vbl.j);
            dhfdk_printf("0x%08x%08x", high, low);
            brfbk;
    }
}

/* Printf of b string for gdbtb->dhfdk_fd */
stbtid void
dhfdk_printf_str(dhbr *str)
{
    int lfn;
    int i;

    if ( str == NULL ) {
        dhfdk_printf("<null>");
    }
    dhfdk_printf("\"");
    lfn = (int)strlfn(str);
    for (i = 0; i < lfn; i++) {
        unsignfd dhbr d;
        d = str[i];
        if ( isprint(d) ) {
            dhfdk_printf("%d", d);
        } flsf {
            dhfdk_printf("\\x%02x", d);
        }
    }
    dhfdk_printf("\"");
}

/* Printf of b utf8 id for gdbtb->dhfdk_fd */
stbtid void
dhfdk_print_utf8(strudt LookupTbblf *utbb, dhbr *prffix, HprofId id)
{
    TbblfIndfx uindfx;

    if ( id == 0 ) {
        dhfdk_printf("%s0x%x", prffix, id);
    } flsf {
        uindfx = tbblf_find_fntry(utbb, &id, sizfof(id));
        if ( uindfx == 0 ) {
            dhfdk_printf("%s0x%x", prffix, id);
        } flsf {
            UmbpInfo *umbp;

            umbp = (UmbpInfo*)tbblf_gft_info(utbb, uindfx);
            HPROF_ASSERT(umbp!=NULL);
            HPROF_ASSERT(umbp->str!=NULL);
            dhfdk_printf("%s0x%x->", prffix, id);
            dhfdk_printf_str(umbp->str);
        }
    }
}

/* Add b instbndf fifld informbtion to this dmbp. */
stbtid void
bdd_inst_fifld_to_dmbp(CmbpInfo *dmbp, HprofId id, HprofTypf ty)
{
   int i;

   HPROF_ASSERT(dmbp!=NULL);
   i = dmbp->n_finfo++;
   if ( i+1 >= dmbp->mbx_finfo ) {
       int    osizf;
       Finfo *nfw_finfo;

       osizf            = dmbp->mbx_finfo;
       dmbp->mbx_finfo += 12;
       nfw_finfo = (Finfo*)HPROF_MALLOC(dmbp->mbx_finfo*(int)sizfof(Finfo));
       (void)mfmsft(nfw_finfo,0,dmbp->mbx_finfo*(int)sizfof(Finfo));
       if ( i == 0 ) {
           dmbp->finfo = nfw_finfo;
       } flsf {
           (void)mfmdpy(nfw_finfo,dmbp->finfo,osizf*(int)sizfof(Finfo));
           HPROF_FREE(dmbp->finfo);
           dmbp->finfo = nfw_finfo;
       }
   }
   dmbp->finfo[i].id = id;
   dmbp->finfo[i].ty = ty;
}

/* LookupTbblf dbllbbdk for dmbp fntry dlfbnup */
stbtid void
dmbp_dlfbnup(TbblfIndfx i, void *kfy_ptr, int kfy_lfn, void*info, void*dbtb)
{
    CmbpInfo *dmbp = info;

    if ( dmbp == NULL ) {
        rfturn;
    }
    if ( dmbp->finfo != NULL ) {
        HPROF_FREE(dmbp->finfo);
        dmbp->finfo = NULL;
    }
}

/* Cbsf lbbfl for b switdh on hprof hfbp dump flfmfnts */
#dffinf CASE_HEAP(nbmf) dbsf nbmf: lbbfl = #nbmf;

/* Givfn thf hfbp dump dbtb bnd thf utf8 mbp, dhfdk/writf thf hfbp dump. */
stbtid int
dhfdk_hfbp_tbgs(strudt LookupTbblf *utbb, unsignfd dhbr *pstbrt, int nbytfs)
{
    int                 nrfdords;
    unsignfd dhbr      *p;
    unsignfd dhbr      *psbvf;
    strudt LookupTbblf *dtbb;
    CmbpInfo            dmbp;
    dhbr               *lbbfl;
    unsignfd            tbg;
    HprofTypf           ty;
    HprofId             id, id2, fr, sup;
    int                 num_flfmfnts;
    int                 num_bytfs;
    SfriblNumbfr        trbdf_sfribl_num;
    SfriblNumbfr        thrfbd_sfribl_num;
    int                 npos;
    int                 i;
    int                 inst_sizf;

    dtbb     = tbblf_initiblizf("tfmp dtbb", 64, 64, 512, sizfof(CmbpInfo));

    /* First pbss ovfr hfbp rfdords just fills in thf CmbpInfo tbblf */
    nrfdords = 0;
    p        = pstbrt;
    whilf ( p < (pstbrt+nbytfs) ) {
        nrfdords++;
        /*LINTED*/
        npos = (int)(p - pstbrt);
        tbg  = rfbd_u1(&p);
        switdh ( tbg ) {
            CASE_HEAP(HPROF_GC_ROOT_UNKNOWN)
                id = rfbd_id(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JNI_GLOBAL)
                id  = rfbd_id(&p);
                id2 = rfbd_id(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JNI_LOCAL)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                fr = rfbd_u4(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JAVA_FRAME)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                fr = rfbd_u4(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_NATIVE_STACK)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_STICKY_CLASS)
                id = rfbd_id(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_THREAD_BLOCK)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_MONITOR_USED)
                id = rfbd_id(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_THREAD_OBJ)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                brfbk;
            CASE_HEAP(HPROF_GC_CLASS_DUMP)
                (void)mfmsft((void*)&dmbp, 0, sizfof(dmbp));
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                {
                    HprofId ld, si, pr, rf1, rf2;

                    sup      = rfbd_id(&p);
                    ld       = rfbd_id(&p);
                    si       = rfbd_id(&p);
                    pr       = rfbd_id(&p);
                    rf1      = rfbd_id(&p);
                    rf2      = rfbd_id(&p);
                    dmbp.sup = sup;
                }
                inst_sizf = rfbd_u4(&p);
                dmbp.inst_sizf = inst_sizf;
                num_flfmfnts = rfbd_u2(&p);
                for(i=0; i<num_flfmfnts; i++) {
                    (void)rfbd_u2(&p);
                    ty = rfbd_u1(&p);
                    (void)rfbd_vbl(&p, ty);
                }
                num_flfmfnts = rfbd_u2(&p);
                for(i=0; i<num_flfmfnts; i++) {
                    (void)rfbd_id(&p);
                    ty = rfbd_u1(&p);
                    (void)rfbd_vbl(&p, ty);
                }
                num_flfmfnts = rfbd_u2(&p);
                for(i=0; i<num_flfmfnts; i++) {
                    HprofTypf ty;
                    HprofId   id;

                    id = rfbd_id(&p);
                    ty = rfbd_u1(&p);
                    bdd_inst_fifld_to_dmbp(&dmbp, id, ty);
                }
                (void)tbblf_drfbtf_fntry(dtbb, &id, sizfof(id), &dmbp);
                brfbk;
            CASE_HEAP(HPROF_GC_INSTANCE_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                id2 = rfbd_id(&p); /* dlbss id */
                num_bytfs = rfbd_u4(&p);
                p += num_bytfs;
                brfbk;
            CASE_HEAP(HPROF_GC_OBJ_ARRAY_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                num_flfmfnts = rfbd_u4(&p);
                id2 = rfbd_id(&p);
                p += num_flfmfnts*(int)sizfof(HprofId);
                brfbk;
            CASE_HEAP(HPROF_GC_PRIM_ARRAY_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                num_flfmfnts = rfbd_u4(&p);
                ty = rfbd_u1(&p);
                p += typf_sizf[ty]*num_flfmfnts;
                brfbk;
            dffbult:
                lbbfl = "UNKNOWN";
                dhfdk_printf("H#%d@%d %s: ERROR!\n",
                                nrfdords, npos, lbbfl);
                HPROF_ERROR(JNI_TRUE, "unknown hfbp rfdord typf");
                brfbk;
        }
    }
    CHECK_FOR_ERROR(p==pstbrt+nbytfs);

    /* Sdbn bgbin ondf wf hbvf our dmbp */
    nrfdords = 0;
    p        = pstbrt;
    whilf ( p < (pstbrt+nbytfs) ) {
        nrfdords++;
        /*LINTED*/
        npos = (int)(p - pstbrt);
        tbg  = rfbd_u1(&p);
        switdh ( tbg ) {
            CASE_HEAP(HPROF_GC_ROOT_UNKNOWN)
                id = rfbd_id(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x\n",
                        nrfdords, npos, lbbfl, id);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JNI_GLOBAL)
                id = rfbd_id(&p);
                id2 = rfbd_id(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, id2=0x%x\n",
                        nrfdords, npos, lbbfl, id, id2);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JNI_LOCAL)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                fr = rfbd_u4(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, thrfbd_sfribl_num=%u, fr=0x%x\n",
                        nrfdords, npos, lbbfl, id, thrfbd_sfribl_num, fr);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_JAVA_FRAME)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                fr = rfbd_u4(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, thrfbd_sfribl_num=%u, fr=0x%x\n",
                        nrfdords, npos, lbbfl, id, thrfbd_sfribl_num, fr);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_NATIVE_STACK)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, thrfbd_sfribl_num=%u\n",
                        nrfdords, npos, lbbfl, id, thrfbd_sfribl_num);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_STICKY_CLASS)
                id = rfbd_id(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x\n",
                        nrfdords, npos, lbbfl, id);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_THREAD_BLOCK)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, thrfbd_sfribl_num=%u\n",
                        nrfdords, npos, lbbfl, id, thrfbd_sfribl_num);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_MONITOR_USED)
                id = rfbd_id(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x\n",
                        nrfdords, npos, lbbfl, id);
                brfbk;
            CASE_HEAP(HPROF_GC_ROOT_THREAD_OBJ)
                id = rfbd_id(&p);
                thrfbd_sfribl_num = rfbd_u4(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                dhfdk_printf("H#%d@%d %s: id=0x%x, thrfbd_sfribl_num=%u,"
                             " trbdf_sfribl_num=%u\n",
                        nrfdords, npos, lbbfl, id, thrfbd_sfribl_num,
                        trbdf_sfribl_num);
                brfbk;
            CASE_HEAP(HPROF_GC_CLASS_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                dhfdk_printf("H#%d@%d %s: id=0x%x, trbdf_sfribl_num=%u\n",
                        nrfdords, npos, lbbfl, id, trbdf_sfribl_num);
                {
                    HprofId ld, si, pr, rf1, rf2;

                    sup = rfbd_id(&p);
                    ld  = rfbd_id(&p);
                    si  = rfbd_id(&p);
                    pr  = rfbd_id(&p);
                    rf1 = rfbd_id(&p);
                    rf2 = rfbd_id(&p);
                    dhfdk_printf("  su=0x%x, ld=0x%x, si=0x%x,"
                                 " pr=0x%x, rf1=0x%x, rf2=0x%x\n",
                        sup, ld, si, pr, rf1, rf2);
                }
                inst_sizf = rfbd_u4(&p);
                dhfdk_printf("  instbndf_sizf=%d\n", inst_sizf);

                num_flfmfnts = rfbd_u2(&p);
                for(i=0; i<num_flfmfnts; i++) {
                    HprofTypf ty;
                    unsignfd  dpi;
                    jvbluf    vbl;

                    dpi = rfbd_u2(&p);
                    ty  = rfbd_u1(&p);
                    vbl = rfbd_vbl(&p, ty);
                    dhfdk_printf("  donstbnt_pool %d: dpi=%d, ty=%d, vbl=",
                                i, dpi, ty);
                    dhfdk_printf_vbl(ty, vbl, 1);
                    dhfdk_printf("\n");
                }

                num_flfmfnts = rfbd_u2(&p);
                dhfdk_printf("  stbtid_fifld_dount=%d\n", num_flfmfnts);
                for(i=0; i<num_flfmfnts; i++) {
                    HprofTypf ty;
                    HprofId   id;
                    jvbluf    vbl;

                    id  = rfbd_id(&p);
                    ty  = rfbd_u1(&p);
                    vbl = rfbd_vbl(&p, ty);
                    dhfdk_printf("  stbtid fifld %d: ", i);
                    dhfdk_print_utf8(utbb, "id=", id);
                    dhfdk_printf(", ty=%d, vbl=", ty);
                    dhfdk_printf_vbl(ty, vbl, 1);
                    dhfdk_printf("\n");
                }

                num_flfmfnts = rfbd_u2(&p);
                dhfdk_printf("  instbndf_fifld_dount=%d\n", num_flfmfnts);
                for(i=0; i<num_flfmfnts; i++) {
                    HprofTypf ty;
                    HprofId   id;

                    id = rfbd_id(&p);
                    ty = rfbd_u1(&p);
                    dhfdk_printf("  instbndf_fifld %d: ", i);
                    dhfdk_print_utf8(utbb, "id=", id);
                    dhfdk_printf(", ty=%d\n", ty);
                }
                brfbk;
            CASE_HEAP(HPROF_GC_INSTANCE_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                id2 = rfbd_id(&p); /* dlbss id */
                num_bytfs = rfbd_u4(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, trbdf_sfribl_num=%u,"
                             " did=0x%x, nbytfs=%d\n",
                            nrfdords, npos, lbbfl, id, trbdf_sfribl_num,
                            id2, num_bytfs);
                /* This is b pbdkfd sft of bytfs for thf instbndf fiflds */
                if ( num_bytfs > 0 ) {
                    TbblfIndfx dindfx;
                    int        ififld;
                    CmbpInfo  *mbp;

                    dindfx = tbblf_find_fntry(dtbb, &id2, sizfof(id2));
                    HPROF_ASSERT(dindfx!=0);
                    mbp = (CmbpInfo*)tbblf_gft_info(dtbb, dindfx);
                    HPROF_ASSERT(mbp!=NULL);
                    HPROF_ASSERT(num_bytfs==mbp->inst_sizf);

                    psbvf  = p;
                    ififld = 0;

                    do {
                        for(i=0;i<mbp->n_finfo;i++) {
                            HprofTypf ty;
                            HprofId   id;
                            jvbluf    vbl;

                            ty = mbp->finfo[i].ty;
                            id = mbp->finfo[i].id;
                            HPROF_ASSERT(ty!=0);
                            HPROF_ASSERT(id!=0);
                            vbl = rfbd_vbl(&p, ty);
                            dhfdk_printf("  fifld %d: ", ififld);
                            dhfdk_print_utf8(utbb, "id=", id);
                            dhfdk_printf(", ty=%d, vbl=", ty);
                            dhfdk_printf_vbl(ty, vbl, 1);
                            dhfdk_printf("\n");
                            ififld++;
                        }
                        id2    = mbp->sup;
                        mbp    = NULL;
                        dindfx = 0;
                        if ( id2 != 0 ) {
                            dindfx = tbblf_find_fntry(dtbb, &id2, sizfof(id2));
                            HPROF_ASSERT(dindfx!=0);
                            mbp = (CmbpInfo*)tbblf_gft_info(dtbb, dindfx);
                            HPROF_ASSERT(mbp!=NULL);
                        }
                    } whilf ( mbp != NULL );
                    HPROF_ASSERT(num_bytfs==(p-psbvf));
                }
                brfbk;
            CASE_HEAP(HPROF_GC_OBJ_ARRAY_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                num_flfmfnts = rfbd_u4(&p);
                id2 = rfbd_id(&p);
                dhfdk_printf("H#%d@%d %s: id=0x%x, trbdf_sfribl_num=%u, nflfms=%d, fid=0x%x\n",
                                nrfdords, npos, lbbfl, id, trbdf_sfribl_num, num_flfmfnts, id2);
                for(i=0; i<num_flfmfnts; i++) {
                    HprofId id;

                    id = rfbd_id(&p);
                    dhfdk_printf("  [%d]: id=0x%x\n", i, id);
                }
                brfbk;
            CASE_HEAP(HPROF_GC_PRIM_ARRAY_DUMP)
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                num_flfmfnts = rfbd_u4(&p);
                ty = rfbd_u1(&p);
                psbvf = p;
                dhfdk_printf("H#%d@%d %s: id=0x%x, trbdf_sfribl_num=%u, "
                             "nflfms=%d, ty=%d\n",
                                nrfdords, npos, lbbfl, id, trbdf_sfribl_num, num_flfmfnts, ty);
                HPROF_ASSERT(HPROF_TYPE_IS_PRIMITIVE(ty));
                if ( num_flfmfnts > 0 ) {
                    int   dount;
                    int   long_form;
                    int   mbx_dount;
                    dhbr *quotf;

                    quotf     = "";
                    long_form = 1;
                    mbx_dount = 8;
                    dount     = 0;
                    switdh ( ty ) {
                        dbsf HPROF_CHAR:
                            long_form = 0;
                            mbx_dount = 72;
                            quotf     = "\"";
                            /*FALLTHRU*/
                        dbsf HPROF_INT:
                        dbsf HPROF_DOUBLE:
                        dbsf HPROF_LONG:
                        dbsf HPROF_BYTE:
                        dbsf HPROF_BOOLEAN:
                        dbsf HPROF_SHORT:
                        dbsf HPROF_FLOAT:
                            dhfdk_printf("  vbl=%s", quotf);
                            for(i=0; i<num_flfmfnts; i++) {
                                jvbluf vbl;

                                if ( i > 0 && dount == 0 ) {
                                    dhfdk_printf("  %s", quotf);
                                }
                                vbl = rfbd_vbl(&p, ty);
                                dhfdk_printf_vbl(ty, vbl, long_form);
                                dount += 1;
                                if ( dount >= mbx_dount ) {
                                    dhfdk_printf("\"\n");
                                    dount = 0;
                                }
                            }
                            if ( dount != 0 ) {
                                dhfdk_printf("%s\n", quotf);
                            }
                            brfbk;
                    }
                }
                HPROF_ASSERT(typf_sizf[ty]*num_flfmfnts==(p-psbvf));
                brfbk;
            dffbult:
                lbbfl = "UNKNOWN";
                dhfdk_printf("H#%d@%d %s: ERROR!\n",
                                nrfdords, npos, lbbfl);
                HPROF_ERROR(JNI_TRUE, "unknown hfbp rfdord typf");
                brfbk;
        }
    }
    CHECK_FOR_ERROR(p==pstbrt+nbytfs);

    tbblf_dlfbnup(dtbb, &dmbp_dlfbnup, NULL);

    rfturn nrfdords;
}

/* LookupTbblf dlfbnup dbllbbdk for utbb */
stbtid void
utbb_dlfbnup(TbblfIndfx i, void *kfy_ptr, int kfy_lfn, void*info, void*dbtb)
{
    UmbpInfo *umbp = info;

    if ( umbp == NULL ) {
        rfturn;
    }
    if ( umbp->str != NULL ) {
        HPROF_FREE(umbp->str);
        umbp->str = NULL;
    }
}

/* Chfdk bll thf hfbp tbgs in b hfbp dump */
stbtid int
dhfdk_tbgs(unsignfd dhbr *pstbrt, int nbytfs)
{
    unsignfd dhbr      *p;
    int                 nrfdord;
    strudt LookupTbblf *utbb;
    UmbpInfo            umbp;

    dhfdk_printf("\nCHECK TAGS: stbrting\n");

    utbb    = tbblf_initiblizf("tfmp utf8 mbp", 64, 64, 512, sizfof(UmbpInfo));

    /* Wblk thf tbgs, bssumfs UTF8 tbgs brf dffinfd bfforf usfd */
    p       = pstbrt;
    nrfdord = 0;
    whilf ( p < (pstbrt+nbytfs) ) {
        unsignfd     tbg;
        unsignfd     sizf;
        int          nhfbp_rfdords;
        int          npos;
        dhbr        *lbbfl;
        HprofId      id, nm, sg, so, gr, gn;
        int          i, li, num_flfmfnts;
        HprofTypf    ty;
        SfriblNumbfr trbdf_sfribl_num;
        SfriblNumbfr thrfbd_sfribl_num;
        SfriblNumbfr dlbss_sfribl_num;
        unsignfd     flbgs;
        unsignfd     dfpth;
        flobt        dutoff;
        unsignfd     tfmp;
        jint         nblivf;
        jint         nilivf;
        jlong        tbytfs;
        jlong        tinsts;
        jint         totbl_sbmplfs;
        jint         trbdf_dount;

        nrfdord++;
        /*LINTED*/
        npos = (int)(p - pstbrt);
        tbg = rfbd_u1(&p);
        (void)rfbd_u4(&p); /* midrosfds */
        sizf = rfbd_u4(&p);
        #dffinf CASE_TAG(nbmf) dbsf nbmf: lbbfl = #nbmf;
        switdh ( tbg ) {
            CASE_TAG(HPROF_UTF8)
                CHECK_FOR_ERROR(sizf>=(int)sizfof(HprofId));
                id = rfbd_id(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, nbmf_id=0x%x, \"",
                                nrfdord, npos, lbbfl, sizf, id);
                num_flfmfnts = sizf-(int)sizfof(HprofId);
                dhfdk_rbw(p, num_flfmfnts);
                dhfdk_printf("\"\n");
                /* Crfbtf fntry in umbp */
                umbp.str = HPROF_MALLOC(num_flfmfnts+1);
                (void)strndpy(umbp.str, (dhbr*)p, (sizf_t)num_flfmfnts);
                umbp.str[num_flfmfnts] = 0;
                (void)tbblf_drfbtf_fntry(utbb, &id, sizfof(id), &umbp);
                p += num_flfmfnts;
                brfbk;
            CASE_TAG(HPROF_LOAD_CLASS)
                CHECK_FOR_ERROR(sizf==2*4+2*(int)sizfof(HprofId));
                dlbss_sfribl_num = rfbd_u4(&p);
                CHECK_CLASS_SERIAL_NO(dlbss_sfribl_num);
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                nm = rfbd_id(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, dlbss_sfribl_num=%u,"
                             " id=0x%x, trbdf_sfribl_num=%u, nbmf_id=0x%x\n",
                                nrfdord, npos, lbbfl, sizf, dlbss_sfribl_num,
                                id, trbdf_sfribl_num, nm);
                brfbk;
            CASE_TAG(HPROF_UNLOAD_CLASS)
                CHECK_FOR_ERROR(sizf==4);
                dlbss_sfribl_num = rfbd_u4(&p);
                CHECK_CLASS_SERIAL_NO(dlbss_sfribl_num);
                dhfdk_printf("#%d@%d: %s, sz=%d, dlbss_sfribl_num=%u\n",
                                nrfdord, npos, lbbfl, sizf, dlbss_sfribl_num);
                brfbk;
            CASE_TAG(HPROF_FRAME)
                CHECK_FOR_ERROR(sizf==2*4+4*(int)sizfof(HprofId));
                id = rfbd_id(&p);
                nm = rfbd_id(&p);
                sg = rfbd_id(&p);
                so = rfbd_id(&p);
                dlbss_sfribl_num = rfbd_u4(&p);
                CHECK_CLASS_SERIAL_NO(dlbss_sfribl_num);
                li = rfbd_u4(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, ", nrfdord, npos, lbbfl, sizf);
                dhfdk_print_utf8(utbb, "id=", id);
                dhfdk_printf(" nbmf_id=0x%x, sig_id=0x%x, sourdf_id=0x%x,"
                             " dlbss_sfribl_num=%u, linfno=%d\n",
                                nm, sg, so, dlbss_sfribl_num, li);
                brfbk;
            CASE_TAG(HPROF_TRACE)
                CHECK_FOR_ERROR(sizf>=3*4);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                thrfbd_sfribl_num = rfbd_u4(&p); /* Cbn bf 0 */
                num_flfmfnts = rfbd_u4(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, trbdf_sfribl_num=%u,"
                             " thrfbd_sfribl_num=%u, nflfms=%d [",
                                nrfdord, npos, lbbfl, sizf,
                                trbdf_sfribl_num, thrfbd_sfribl_num, num_flfmfnts);
                for(i=0; i< num_flfmfnts; i++) {
                    dhfdk_printf("0x%x,", rfbd_id(&p));
                }
                dhfdk_printf("]\n");
                brfbk;
            CASE_TAG(HPROF_ALLOC_SITES)
                CHECK_FOR_ERROR(sizf>=2+4*4+2*8);
                flbgs = rfbd_u2(&p);
                tfmp  = rfbd_u4(&p);
                dutoff = *((flobt*)&tfmp);
                nblivf = rfbd_u4(&p);
                nilivf = rfbd_u4(&p);
                tbytfs = rfbd_u8(&p);
                tinsts = rfbd_u8(&p);
                num_flfmfnts     = rfbd_u4(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, flbgs=0x%x, dutoff=%g,"
                             " nblivf=%d, nilivf=%d, tbytfs=(%d,%d),"
                             " tinsts=(%d,%d), num_flfmfnts=%d\n",
                                nrfdord, npos, lbbfl, sizf,
                                flbgs, dutoff, nblivf, nilivf,
                                jlong_high(tbytfs), jlong_low(tbytfs),
                                jlong_high(tinsts), jlong_low(tinsts),
                                num_flfmfnts);
                for(i=0; i< num_flfmfnts; i++) {
                    ty = rfbd_u1(&p);
                    dlbss_sfribl_num = rfbd_u4(&p);
                    CHECK_CLASS_SERIAL_NO(dlbss_sfribl_num);
                    trbdf_sfribl_num = rfbd_u4(&p);
                    CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                    nblivf = rfbd_u4(&p);
                    nilivf = rfbd_u4(&p);
                    tbytfs = rfbd_u4(&p);
                    tinsts = rfbd_u4(&p);
                    dhfdk_printf("\t %d: ty=%d, dlbss_sfribl_num=%u,"
                                 " trbdf_sfribl_num=%u, nblivf=%d, nilivf=%d,"
                                 " tbytfs=%d, tinsts=%d\n",
                                 i, ty, dlbss_sfribl_num, trbdf_sfribl_num,
                                 nblivf, nilivf, (jint)tbytfs, (jint)tinsts);
                }
                brfbk;
            CASE_TAG(HPROF_HEAP_SUMMARY)
                CHECK_FOR_ERROR(sizf==2*4+2*8);
                nblivf = rfbd_u4(&p);
                nilivf = rfbd_u4(&p);
                tbytfs = rfbd_u8(&p);
                tinsts = rfbd_u8(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d,"
                             " nblivf=%d, nilivf=%d, tbytfs=(%d,%d),"
                             " tinsts=(%d,%d)\n",
                                nrfdord, npos, lbbfl, sizf,
                                nblivf, nilivf,
                                jlong_high(tbytfs), jlong_low(tbytfs),
                                jlong_high(tinsts), jlong_low(tinsts));
                brfbk;
            CASE_TAG(HPROF_START_THREAD)
                CHECK_FOR_ERROR(sizf==2*4+4*(int)sizfof(HprofId));
                thrfbd_sfribl_num = rfbd_u4(&p);
                CHECK_THREAD_SERIAL_NO(thrfbd_sfribl_num);
                id = rfbd_id(&p);
                trbdf_sfribl_num = rfbd_u4(&p);
                CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                nm = rfbd_id(&p);
                gr = rfbd_id(&p);
                gn = rfbd_id(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, thrfbd_sfribl_num=%u,"
                             " id=0x%x, trbdf_sfribl_num=%u, ",
                                nrfdord, npos, lbbfl, sizf,
                                thrfbd_sfribl_num, id, trbdf_sfribl_num);
                dhfdk_print_utf8(utbb, "nm=", id);
                dhfdk_printf(" trbdf_sfribl_num=%u, nm=0x%x,"
                             " gr=0x%x, gn=0x%x\n",
                                trbdf_sfribl_num, nm, gr, gn);
                brfbk;
            CASE_TAG(HPROF_END_THREAD)
                CHECK_FOR_ERROR(sizf==4);
                thrfbd_sfribl_num = rfbd_u4(&p);
                CHECK_THREAD_SERIAL_NO(thrfbd_sfribl_num);
                dhfdk_printf("#%d@%d: %s, sz=%d, thrfbd_sfribl_num=%u\n",
                                nrfdord, npos, lbbfl, sizf, thrfbd_sfribl_num);
                brfbk;
            CASE_TAG(HPROF_HEAP_DUMP)
                dhfdk_printf("#%d@%d: BEGIN: %s, sz=%d\n",
                                nrfdord, npos, lbbfl, sizf);
                nhfbp_rfdords = dhfdk_hfbp_tbgs(utbb, p, sizf);
                dhfdk_printf("#%d@%d: END: %s, sz=%d, nhfbp_rfds=%d\n",
                                nrfdord, npos, lbbfl, sizf, nhfbp_rfdords);
                p += sizf;
                brfbk;
            CASE_TAG(HPROF_HEAP_DUMP_SEGMENT) /* 1.0.2 */
                dhfdk_printf("#%d@%d: BEGIN SEGMENT: %s, sz=%d\n",
                                nrfdord, npos, lbbfl, sizf);
                nhfbp_rfdords = dhfdk_hfbp_tbgs(utbb, p, sizf);
                dhfdk_printf("#%d@%d: END SEGMENT: %s, sz=%d, nhfbp_rfds=%d\n",
                                nrfdord, npos, lbbfl, sizf, nhfbp_rfdords);
                p += sizf;
                brfbk;
            CASE_TAG(HPROF_HEAP_DUMP_END) /* 1.0.2 */
                dhfdk_printf("#%d@%d: SEGMENT END: %s, sz=%d\n",
                                nrfdord, npos, lbbfl, sizf);
                brfbk;
            CASE_TAG(HPROF_CPU_SAMPLES)
                CHECK_FOR_ERROR(sizf>=2*4);
                totbl_sbmplfs = rfbd_u4(&p);
                trbdf_dount = rfbd_u4(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, totbl_sbmplfs=%d,"
                             " trbdf_dount=%d\n",
                                nrfdord, npos, lbbfl, sizf,
                                totbl_sbmplfs, trbdf_dount);
                for(i=0; i< trbdf_dount; i++) {
                    num_flfmfnts = rfbd_u4(&p);
                    trbdf_sfribl_num = rfbd_u4(&p);
                    CHECK_TRACE_SERIAL_NO(trbdf_sfribl_num);
                    dhfdk_printf("\t %d: sbmplfs=%d, trbdf_sfribl_num=%u\n",
                                 trbdf_sfribl_num, num_flfmfnts);
                }
                brfbk;
            CASE_TAG(HPROF_CONTROL_SETTINGS)
                CHECK_FOR_ERROR(sizf==4+2);
                flbgs = rfbd_u4(&p);
                dfpth = rfbd_u2(&p);
                dhfdk_printf("#%d@%d: %s, sz=%d, flbgs=0x%x, dfpth=%d\n",
                                nrfdord, npos, lbbfl, sizf, flbgs, dfpth);
                brfbk;
            dffbult:
                lbbfl = "UNKNOWN";
                dhfdk_printf("#%d@%d: %s, sz=%d\n",
                                nrfdord, npos, lbbfl, sizf);
                HPROF_ERROR(JNI_TRUE, "unknown rfdord typf");
                p += sizf;
                brfbk;
        }
        CHECK_FOR_ERROR(p<=(pstbrt+nbytfs));
    }
    dhfdk_flush();
    CHECK_FOR_ERROR(p==(pstbrt+nbytfs));
    tbblf_dlfbnup(utbb, &utbb_dlfbnup, NULL);
    rfturn nrfdord;
}

/* Rfbd thf fntirf filf into mfmory */
stbtid void *
gft_binbry_filf_imbgf(dhbr *filfnbmf, int *pnbytfs)
{
    unsignfd dhbr *imbgf;
    int            fd;
    jlong          nbytfs;
    int            nrfbd;

    *pnbytfs = 0;
    fd = md_opfn_binbry(filfnbmf);
    CHECK_FOR_ERROR(fd>=0);
    if ( (nbytfs = md_sffk(fd, (jlong)-1)) == (jlong)-1 ) {
        HPROF_ERROR(JNI_TRUE, "Cbnnot md_sffk() to fnd of filf");
    }
    CHECK_FOR_ERROR(((jint)nbytfs)>512);
    if ( md_sffk(fd, (jlong)0) != (jlong)0 ) {
        HPROF_ERROR(JNI_TRUE, "Cbnnot md_sffk() to stbrt of filf");
    }
    imbgf = HPROF_MALLOC(((jint)nbytfs)+1);
    CHECK_FOR_ERROR(imbgf!=NULL);

    /* Rfbd thf fntirf filf imbgf into mfmory */
    nrfbd = md_rfbd(fd, imbgf, (jint)nbytfs);
    if ( nrfbd <= 0 ) {
        HPROF_ERROR(JNI_TRUE, "Systfm rfbd fbilfd.");
    }
    CHECK_FOR_ERROR(((jint)nbytfs)==nrfbd);
    md_dlosf(fd);
    *pnbytfs = (jint)nbytfs;
    rfturn imbgf;
}

/* ------------------------------------------------------------------ */

void
dhfdk_binbry_filf(dhbr *filfnbmf)
{
    unsignfd dhbr *imbgf;
    unsignfd dhbr *p;
    unsignfd       idsizf;
    int            nbytfs;
    int            nrfdords;

    imbgf = gft_binbry_filf_imbgf(filfnbmf, &nbytfs);
    if ( imbgf == NULL ) {
        dhfdk_printf("No filf imbgf: %s\n", filfnbmf);
        rfturn;
    }
    p = imbgf;
    CHECK_FOR_ERROR(strdmp((dhbr*)p, gdbtb->hfbdfr)==0);
    dhfdk_printf("Filfnbmf=%s, nbytfs=%d, hfbdfr=\"%s\"\n",
                        filfnbmf, nbytfs, p);
    p+=((int)strlfn((dhbr*)p)+1);
    idsizf = rfbd_u4(&p);
    CHECK_FOR_ERROR(idsizf==sizfof(HprofId));
    (void)rfbd_u4(&p);
    (void)rfbd_u4(&p);
    /* LINTED */
    nrfdords = dhfdk_tbgs(p, nbytfs - (int)( p - imbgf ) );
    dhfdk_printf("#%d totbl rfdords found in %d bytfs\n", nrfdords, nbytfs);
    HPROF_FREE(imbgf);
}
