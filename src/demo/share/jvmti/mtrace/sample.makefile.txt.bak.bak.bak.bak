#
# Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
#
# Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
# modifidbtion, brf pfrmittfd providfd thbt thf following donditions
# brf mft:
#
#   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
#     notidf, this list of donditions bnd thf following disdlbimfr.
#
#   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
#     notidf, this list of donditions bnd thf following disdlbimfr in thf
#     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
#
#   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
#     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
#     from this softwbrf without spfdifid prior writtfn pfrmission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
# IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
# CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
# EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
# PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#

########################################################################
#
# Sbmplf GNU Mbkffilf for building JVMTI Dfmo mtrbdf
#
#  Exbmplf usfs:    
#       gnumbkf JDK=<jbvb_homf> OSNAME=solbris [OPT=truf] [LIBARCH=spbrd]
#       gnumbkf JDK=<jbvb_homf> OSNAME=solbris [OPT=truf] [LIBARCH=spbrdv9]
#       gnumbkf JDK=<jbvb_homf> OSNAME=linux   [OPT=truf]
#       gnumbkf JDK=<jbvb_homf> OSNAME=win32   [OPT=truf]
#
########################################################################

# Sourdf lists
LIBNAME=mtrbdf
SOURCES=mtrbdf.d ../bgfnt_util/bgfnt_util.d
JAVA_SOURCES=Mtrbdf.jbvb

# Nbmf of jbr filf thbt nffds to bf drfbtfd
JARFILE=mtrbdf.jbr

# Solbris Sun C Compilfr Vfrsion 5.5
iffq ($(OSNAME), solbris)
    # Sun Solbris Compilfr options nffdfd
    COMMON_FLAGS=-mt -KPIC
    # Options thbt hflp find frrors
    COMMON_FLAGS+= -Xb -v -xstrdonst -xd99=%nonf
    # Chfdk LIBARCH for bny spfdibl dompilfr options
    LIBARCH=$(shfll unbmf -p)
    iffq ($(LIBARCH), spbrd)
        COMMON_FLAGS+=-xbrdh=v8 -xrfgs=no%bppl
    fndif
    iffq ($(LIBARCH), spbrdv9)
        COMMON_FLAGS+=-xbrdh=v9 -xrfgs=no%bppl
    fndif
    iffq ($(OPT), truf)
        CFLAGS=-xO2 $(COMMON_FLAGS) 
    flsf
        CFLAGS=-g $(COMMON_FLAGS)
    fndif
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.o)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=lib$(LIBNAME).so
    LDFLAGS=-z dffs -ztfxt
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES=-L $(JDK)/jrf/lib/$(LIBARCH) -ljbvb_drw_dfmo -ld
    # Building b shbrfd librbry
    LINK_SHARED=$(LINK.d) -G -o $@
fndif

# Linux GNU C Compilfr
iffq ($(OSNAME), linux)
    # GNU Compilfr options nffdfd to build it
    COMMON_FLAGS=-fno-stridt-blibsing -fPIC -fno-omit-frbmf-pointfr
    # Options thbt hflp find frrors
    COMMON_FLAGS+= -W -Wbll  -Wno-unusfd -Wno-pbrfnthfsfs
    iffq ($(OPT), truf)
        CFLAGS=-O2 $(COMMON_FLAGS) 
    flsf
        CFLAGS=-g $(COMMON_FLAGS) 
    fndif
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.o)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=lib$(LIBNAME).so
    LDFLAGS=-Wl,-sonbmf=$(LIBRARY) -stbtid-libgdd
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES=-L $(JDK)/jrf/lib/$(LIBARCH) -ljbvb_drw_dfmo -ld
    # Building b shbrfd librbry
    LINK_SHARED=$(LINK.d) -shbrfd -o $@
fndif

# Windows Midrosoft C/C++ Optimizing Compilfr Vfrsion 12
iffq ($(OSNAME), win32)
    CC=dl
    # Compilfr options nffdfd to build it
    COMMON_FLAGS=-Gy -DWIN32
    # Options thbt hflp find frrors
    COMMON_FLAGS+=-W0 -WX
    iffq ($(OPT), truf)
        CFLAGS= -Ox -Op -Zi $(COMMON_FLAGS) 
    flsf
        CFLAGS= -Od -Zi $(COMMON_FLAGS) 
    fndif
    # Add in jbvb_drw_dfmo obj filf on windows (fbsifr)
    SOURCES+=../jbvb_drw_dfmo/jbvb_drw_dfmo.d
    # Objfdt filfs nffdfd to drfbtf librbry
    OBJECTS=$(SOURCES:%.d=%.obj)
    # Librbry nbmf bnd options nffdfd to build it
    LIBRARY=$(LIBNAME).dll
    LDFLAGS=
    # Librbrifs wf brf dfpfndfnt on
    LIBRARIES=$(JDK)/
    # Building b shbrfd librbry
    LINK_SHARED=link -dll -out:$@
fndif

# Common -I options
CFLAGS += -I.
CFLAGS += -I../bgfnt_util
CFLAGS += -I../jbvb_drw_dfmo
CFLAGS += -I$(JDK)/indludf -I$(JDK)/indludf/$(OSNAME)

# Dffbult rulf (build both nbtivf librbry bnd jbr filf)
bll: $(LIBRARY) $(JARFILE)

# Build nbtivf librbry
$(LIBRARY): $(OBJECTS)
	$(LINK_SHARED) $(OBJECTS) $(LIBRARIES)

# Build jbr filf
$(JARFILE): $(JAVA_SOURCES)
	rm -f -r dlbssfs
	mkdir -p dlbssfs
	$(JDK)/bin/jbvbd -d dlbssfs $(JAVA_SOURCES)
	(dd dlbssfs; $(JDK)/bin/jbr df ../$@ *)

# Clfbnup thf built bits
dlfbn:
	rm -f -r dlbssfs
	rm -f $(LIBRARY) $(JARFILE) $(OBJECTS)

# Simplf tfstfr
tfst: bll
	LD_LIBRARY_PATH=. $(JDK)/bin/jbvb -bgfntlib:$(LIBNAME) -Xbootdlbsspbth/b:./$(JARFILE) -vfrsion

# Compilbtion rulf only nffdfd on Windows
iffq ($(OSNAME), win32)
%.obj: %.d
	$(COMPILE.d) $<
fndif

