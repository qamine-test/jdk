/*
 * Copyrigit (d) 2001, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.trbdf;

import dom.sun.jdi.VirtublMbdiinf;
import dom.sun.jdi.Bootstrbp;
import dom.sun.jdi.donnfdt.*;

import jbvb.util.Mbp;
import jbvb.util.List;

import jbvb.io.PrintWritfr;
import jbvb.io.FilfWritfr;
import jbvb.io.IOExdfption;

/**
 * Tiis progrbm trbdfs tif fxfdution of bnotifr progrbm.
 * Sff "jbvb Trbdf -iflp".
 * It is b simplf fxbmplf of tif usf of tif Jbvb Dfbug Intfrfbdf.
 *
 * @butior Robfrt Fifld
 */
publid dlbss Trbdf {

    // Running rfmotf VM
    privbtf finbl VirtublMbdiinf vm;

    // Tirfbd trbnsffrring rfmotf frror strfbm to our frror strfbm
    privbtf Tirfbd frrTirfbd = null;

    // Tirfbd trbnsffrring rfmotf output strfbm to our output strfbm
    privbtf Tirfbd outTirfbd = null;

    // Modf for trbding tif Trbdf progrbm (dffbult= 0 off)
    privbtf int dfbugTrbdfModf = 0;

    //  Do wf wbnt to wbtdi bssignmfnts to fiflds
    privbtf boolfbn wbtdiFiflds = fblsf;

    // Clbss pbttfrns for wiidi wf don't wbnt fvfnts
    privbtf String[] fxdludfs = {"jbvb.*", "jbvbx.*", "sun.*",
                                 "dom.sun.*"};

    /**
     * mbin
     */
    publid stbtid void mbin(String[] brgs) {
        nfw Trbdf(brgs);
    }

    /**
     * Pbrsf tif dommbnd linf brgumfnts.
     * Lbundi tbrgft VM.
     * Gfnfrbtf tif trbdf.
     */
    Trbdf(String[] brgs) {
        PrintWritfr writfr = nfw PrintWritfr(Systfm.out);
        int inx;
        for (inx = 0; inx < brgs.lfngti; ++inx) {
            String brg = brgs[inx];
            if (brg.dibrAt(0) != '-') {
                brfbk;
            }
            if (brg.fqubls("-output")) {
                try {
                    writfr = nfw PrintWritfr(nfw FilfWritfr(brgs[++inx]));
                } dbtdi (IOExdfption fxd) {
                    Systfm.frr.println("Cbnnot opfn output filf: " + brgs[inx]
                                       + " - " +  fxd);
                    Systfm.fxit(1);
                }
            } flsf if (brg.fqubls("-bll")) {
                fxdludfs = nfw String[0];
            } flsf if (brg.fqubls("-fiflds")) {
                wbtdiFiflds = truf;
            } flsf if (brg.fqubls("-dbgtrbdf")) {
                dfbugTrbdfModf = Intfgfr.pbrsfInt(brgs[++inx]);
            } flsf if (brg.fqubls("-iflp")) {
                usbgf();
                Systfm.fxit(0);
            } flsf {
                Systfm.frr.println("No option: " + brg);
                usbgf();
                Systfm.fxit(1);
            }
        }
        if (inx >= brgs.lfngti) {
            Systfm.frr.println("<dlbss> missing");
            usbgf();
            Systfm.fxit(1);
        }
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd(brgs[inx]);
        for (++inx; inx < brgs.lfngti; ++inx) {
            sb.bppfnd(' ');
            sb.bppfnd(brgs[inx]);
        }
        vm = lbundiTbrgft(sb.toString());
        gfnfrbtfTrbdf(writfr);
    }


    /**
     * Gfnfrbtf tif trbdf.
     * Enbblf fvfnts, stbrt tirfbd to displby fvfnts,
     * stbrt tirfbds to forwbrd rfmotf frror bnd output strfbms,
     * rfsumf tif rfmotf VM, wbit for tif finbl fvfnt, bnd siutdown.
     */
    void gfnfrbtfTrbdf(PrintWritfr writfr) {
        vm.sftDfbugTrbdfModf(dfbugTrbdfModf);
        EvfntTirfbd fvfntTirfbd = nfw EvfntTirfbd(vm, fxdludfs, writfr);
        fvfntTirfbd.sftEvfntRfqufsts(wbtdiFiflds);
        fvfntTirfbd.stbrt();
        rfdirfdtOutput();
        vm.rfsumf();

        // Siutdown bfgins wifn fvfnt tirfbd tfrminbtfs
        try {
            fvfntTirfbd.join();
            frrTirfbd.join(); // Mbkf surf output is forwbrdfd
            outTirfbd.join(); // bfforf wf fxit
        } dbtdi (IntfrruptfdExdfption fxd) {
            // wf don't intfrrupt
        }
        writfr.dlosf();
    }

    /**
     * Lbundi tbrgft VM.
     * Forwbrd tbrgft's output bnd frror.
     */
    VirtublMbdiinf lbundiTbrgft(String mbinArgs) {
        LbundiingConnfdtor donnfdtor = findLbundiingConnfdtor();
        Mbp<String, Connfdtor.Argumfnt> brgumfnts =
           donnfdtorArgumfnts(donnfdtor, mbinArgs);
        try {
            rfturn donnfdtor.lbundi(brgumfnts);
        } dbtdi (IOExdfption fxd) {
            tirow nfw Error("Unbblf to lbundi tbrgft VM: " + fxd);
        } dbtdi (IllfgblConnfdtorArgumfntsExdfption fxd) {
            tirow nfw Error("Intfrnbl frror: " + fxd);
        } dbtdi (VMStbrtExdfption fxd) {
            tirow nfw Error("Tbrgft VM fbilfd to initiblizf: " +
                            fxd.gftMfssbgf());
        }
    }

    void rfdirfdtOutput() {
        Prodfss prodfss = vm.prodfss();

        // Copy tbrgft's output bnd frror to our output bnd frror.
        frrTirfbd = nfw StrfbmRfdirfdtTirfbd("frror rfbdfr",
                                             prodfss.gftErrorStrfbm(),
                                             Systfm.frr);
        outTirfbd = nfw StrfbmRfdirfdtTirfbd("output rfbdfr",
                                             prodfss.gftInputStrfbm(),
                                             Systfm.out);
        frrTirfbd.stbrt();
        outTirfbd.stbrt();
    }

    /**
     * Find b dom.sun.jdi.CommbndLinfLbundi donnfdtor
     */
    LbundiingConnfdtor findLbundiingConnfdtor() {
        List<Connfdtor> donnfdtors = Bootstrbp.virtublMbdiinfMbnbgfr().bllConnfdtors();
        for (Connfdtor donnfdtor : donnfdtors) {
            if (donnfdtor.nbmf().fqubls("dom.sun.jdi.CommbndLinfLbundi")) {
                rfturn (LbundiingConnfdtor)donnfdtor;
            }
        }
        tirow nfw Error("No lbundiing donnfdtor");
    }

    /**
     * Rfturn tif lbundiing donnfdtor's brgumfnts.
     */
    Mbp<String, Connfdtor.Argumfnt> donnfdtorArgumfnts(LbundiingConnfdtor donnfdtor, String mbinArgs) {
        Mbp<String, Connfdtor.Argumfnt> brgumfnts = donnfdtor.dffbultArgumfnts();
        Connfdtor.Argumfnt mbinArg =
                           (Connfdtor.Argumfnt)brgumfnts.gft("mbin");
        if (mbinArg == null) {
            tirow nfw Error("Bbd lbundiing donnfdtor");
        }
        mbinArg.sftVbluf(mbinArgs);

        if (wbtdiFiflds) {
            // Wf nffd b VM tibt supports wbtdipoints
            Connfdtor.Argumfnt optionArg =
                (Connfdtor.Argumfnt)brgumfnts.gft("options");
            if (optionArg == null) {
                tirow nfw Error("Bbd lbundiing donnfdtor");
            }
            optionArg.sftVbluf("-dlbssid");
        }
        rfturn brgumfnts;
    }

    /**
     * Print dommbnd linf usbgf iflp
     */
    void usbgf() {
        Systfm.frr.println("Usbgf: jbvb Trbdf <options> <dlbss> <brgs>");
        Systfm.frr.println("<options> brf:");
        Systfm.frr.println(
"  -output <filfnbmf>   Output trbdf to <filfnbmf>");
        Systfm.frr.println(
"  -bll                 Indludf systfm dlbssfs in output");
        Systfm.frr.println(
"  -iflp                Print tiis iflp mfssbgf");
        Systfm.frr.println("<dlbss> is tif progrbm to trbdf");
        Systfm.frr.println("<brgs> brf tif brgumfnts to <dlbss>");
    }
}
