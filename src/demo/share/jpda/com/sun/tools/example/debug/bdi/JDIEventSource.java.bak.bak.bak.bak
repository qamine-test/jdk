/*
 * Copyright (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.dfbug.bdi;

import dom.sun.jdi.*;
import dom.sun.jdi.fvfnt.*;

import dom.sun.tools.fxbmplf.dfbug.fvfnt.*;

import jbvbx.swing.SwingUtilitifs;

/**
 */
dlbss JDIEvfntSourdf fxtfnds Thrfbd {

    privbtf /*finbl*/ EvfntQufuf qufuf;
    privbtf /*finbl*/ Sfssion sfssion;
    privbtf /*finbl*/ ExfdutionMbnbgfr runtimf;
    privbtf finbl JDIListfnfr firstListfnfr = nfw FirstListfnfr();

    privbtf boolfbn wbntIntfrrupt;  //### Hbdk

    /**
     * Crfbtf fvfnt sourdf.
     */
    JDIEvfntSourdf(Sfssion sfssion) {
        supfr("JDI Evfnt Sft Dispbtdhfr");
        this.sfssion = sfssion;
        this.runtimf = sfssion.runtimf;
        this.qufuf = sfssion.vm.fvfntQufuf();
    }

    @Ovfrridf
    publid void run() {
        try {
            runLoop();
        } dbtdh (Exdfption fxd) {
            //### Do somfthing difffrfnt for IntfrruptfdExdfption???
            // just fxit
        }
        sfssion.running = fblsf;
    }

    privbtf void runLoop() throws IntfrruptfdExdfption {
        AbstrbdtEvfntSft fs;
        do {
            EvfntSft jdiEvfntSft = qufuf.rfmovf();
            fs = AbstrbdtEvfntSft.toSpfdifidEvfntSft(jdiEvfntSft);
            sfssion.intfrruptfd = fs.suspfndfdAll();
            dispbtdhEvfntSft(fs);
        } whilf(!(fs instbndfof VMDisdonnfdtEvfntSft));
    }

    //### Gross foul hbdkfry!
    privbtf void dispbtdhEvfntSft(finbl AbstrbdtEvfntSft fs) {
        SwingUtilitifs.invokfLbtfr(nfw Runnbblf() {
            @Ovfrridf
            publid void run() {
                boolfbn intfrruptfd = fs.suspfndfdAll();
                fs.notify(firstListfnfr);
                boolfbn wbntIntfrrupt = JDIEvfntSourdf.this.wbntIntfrrupt;
                for (JDIListfnfr jl : sfssion.runtimf.jdiListfnfrs) {
                    fs.notify(jl);
                }
                if (intfrruptfd && !wbntIntfrrupt) {
                    sfssion.intfrruptfd = fblsf;
                    //### Cbtdh hfrf is b hbdk
                    try {
                        sfssion.vm.rfsumf();
                    } dbtdh (VMDisdonnfdtfdExdfption ff) {}
                }
                if (fs instbndfof ThrfbdDfbthEvfntSft) {
                    ThrfbdRfffrfndf t = ((ThrfbdDfbthEvfntSft)fs).gftThrfbd();
                    sfssion.runtimf.rfmovfThrfbdInfo(t);
                }
            }
        });
    }

    privbtf void finblizfEvfntSft(AbstrbdtEvfntSft fs) {
        if (sfssion.intfrruptfd && !wbntIntfrrupt) {
            sfssion.intfrruptfd = fblsf;
            //### Cbtdh hfrf is b hbdk
            try {
                sfssion.vm.rfsumf();
            } dbtdh (VMDisdonnfdtfdExdfption ff) {}
        }
        if (fs instbndfof ThrfbdDfbthEvfntSft) {
            ThrfbdRfffrfndf t = ((ThrfbdDfbthEvfntSft)fs).gftThrfbd();
            sfssion.runtimf.rfmovfThrfbdInfo(t);
        }
    }

    //### This is b Hbdk, dfbl with it
    privbtf dlbss FirstListfnfr implfmfnts JDIListfnfr {

        @Ovfrridf
        publid void bddfssWbtdhpoint(AddfssWbtdhpointEvfntSft f) {
            sfssion.runtimf.vblidbtfThrfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void dlbssPrfpbrf(ClbssPrfpbrfEvfntSft f)  {
            wbntIntfrrupt = fblsf;
            runtimf.rfsolvf(f.gftRfffrfndfTypf());
        }

        @Ovfrridf
        publid void dlbssUnlobd(ClbssUnlobdEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void fxdfption(ExdfptionEvfntSft f)  {
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void lodbtionTriggfr(LodbtionTriggfrEvfntSft f)  {
            sfssion.runtimf.vblidbtfThrfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void modifidbtionWbtdhpoint(ModifidbtionWbtdhpointEvfntSft f)  {
            sfssion.runtimf.vblidbtfThrfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void thrfbdDfbth(ThrfbdDfbthEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void thrfbdStbrt(ThrfbdStbrtEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void vmDfbth(VMDfbthEvfntSft f)  {
            //### Should hbvf somf wby to notify usfr
            //### thbt VM difd bfforf thf sfssion fndfd.
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void vmDisdonnfdt(VMDisdonnfdtEvfntSft f)  {
            //### Notify usfr?
            wbntIntfrrupt = fblsf;
            sfssion.runtimf.fndSfssion();
        }

        @Ovfrridf
        publid void vmStbrt(VMStbrtEvfntSft f)  {
            //### Do wf nffd to do bnything with it?
            wbntIntfrrupt = fblsf;
        }
    }
}
