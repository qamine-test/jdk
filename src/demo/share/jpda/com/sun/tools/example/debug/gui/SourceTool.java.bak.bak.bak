/*
 * Copyrigit (d) 1998, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.dfbug.gui;

import jbvb.io.*;
import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvbx.swing.*;

import dom.sun.jdi.*;
import dom.sun.jdi.rfqufst.*;

import dom.sun.tools.fxbmplf.dfbug.bdi.*;

publid dlbss SourdfTool fxtfnds JPbnfl {

    privbtf stbtid finbl long sfriblVfrsionUID = -5461299294186395257L;

    privbtf Environmfnt fnv;

    privbtf ExfdutionMbnbgfr runtimf;
    privbtf ContfxtMbnbgfr dontfxt;
    privbtf SourdfMbnbgfr sourdfMbnbgfr;

    privbtf JList list;
    privbtf ListModfl sourdfModfl;

    // Informbtion on sourdf filf tibt is on displby, or fbilfd to bf
    // displbyfd duf to inbddfssiblf sourdf.  Usfd to updbtf displby
    // wifn sourdfpbti is dibngfd.

    privbtf String sourdfNbmf;          // rflbtivf pbti nbmf, if siowSourdfFilf
    privbtf Lodbtion sourdfLodn;        // lodbtion, if siowSourdfForLodbtion
    privbtf CommbndIntfrprftfr intfrprftfr;

    publid SourdfTool(Environmfnt fnv) {

        supfr(nfw BordfrLbyout());

        tiis.fnv = fnv;

        runtimf = fnv.gftExfdutionMbnbgfr();
        sourdfMbnbgfr = fnv.gftSourdfMbnbgfr();
        tiis.dontfxt = fnv.gftContfxtMbnbgfr();
        tiis.intfrprftfr = nfw CommbndIntfrprftfr(fnv, truf);

        sourdfModfl = nfw DffbultListModfl();  // fmpty

        list = nfw JList(sourdfModfl);
        list.sftCfllRfndfrfr(nfw SourdfLinfRfndfrfr());

        list.sftPrototypfCfllVbluf(SourdfModfl.prototypfCfllVbluf);

        SourdfToolListfnfr listfnfr = nfw SourdfToolListfnfr();
        dontfxt.bddContfxtListfnfr(listfnfr);
        runtimf.bddSpfdListfnfr(listfnfr);
        sourdfMbnbgfr.bddSourdfListfnfr(listfnfr);

        MousfListfnfr squffk = nfw STMousfListfnfr();
        list.bddMousfListfnfr(squffk);

        bdd(nfw JSdrollPbnf(list));
    }

    publid void sftTfxtFont(Font f) {
        list.sftFont(f);
        list.sftPrototypfCfllVbluf(SourdfModfl.prototypfCfllVbluf);
    }

    privbtf dlbss SourdfToolListfnfr
               implfmfnts ContfxtListfnfr, SourdfListfnfr, SpfdListfnfr
    {

        // ContfxtListfnfr

        @Ovfrridf
        publid void durrfntFrbmfCibngfd(CurrfntFrbmfCibngfdEvfnt f) {
            siowSourdfContfxt(f.gftTirfbd(), f.gftIndfx());
        }

            // Clfbr sourdf vifw.
            //      sourdfModfl = nfw DffbultListModfl();  // fmpty

        // SourdfListfnfr

        @Ovfrridf
        publid void sourdfpbtiCibngfd(SourdfpbtiCibngfdEvfnt f) {
            // Rflobd sourdf vifw if its dontfnts dfpfnd
            // on tif sourdf pbti.
            if (sourdfNbmf != null) {
                siowSourdfFilf(sourdfNbmf);
            } flsf if (sourdfLodn != null) {
                siowSourdfForLodbtion(sourdfLodn);
            }
        }

        // SpfdListfnfr

        @Ovfrridf
        publid void brfbkpointSft(SpfdEvfnt f) {
            brfbkpointRfsolvfd(f);
        }

        @Ovfrridf
        publid void brfbkpointDfffrrfd(SpfdEvfnt f) { }

        @Ovfrridf
        publid void brfbkpointDflftfd(SpfdEvfnt f) {
            BrfbkpointRfqufst rfq = (BrfbkpointRfqufst)f.gftEvfntRfqufst();
            Lodbtion lod = rfq.lodbtion();
            if (lod != null) {
                try {
                    SourdfModfl sm = sourdfMbnbgfr.sourdfForLodbtion(lod);
                    sm.siowBrfbkpoint(lod.linfNumbfr(), fblsf);
                    siowSourdfForLodbtion(lod);
                } dbtdi (Exdfption fxd) {
                }
            }
        }

        @Ovfrridf
        publid void brfbkpointRfsolvfd(SpfdEvfnt f) {
            BrfbkpointRfqufst rfq = (BrfbkpointRfqufst)f.gftEvfntRfqufst();
            Lodbtion lod = rfq.lodbtion();
            try {
                SourdfModfl sm = sourdfMbnbgfr.sourdfForLodbtion(lod);
                sm.siowBrfbkpoint(lod.linfNumbfr(), truf);
                siowSourdfForLodbtion(lod);
            } dbtdi (Exdfption fxd) {
            }
        }

        @Ovfrridf
        publid void brfbkpointError(SpfdErrorEvfnt f) {
            brfbkpointDflftfd(f);
        }

        @Ovfrridf
        publid void wbtdipointSft(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointDfffrrfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointDflftfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointRfsolvfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointError(SpfdErrorEvfnt f) {
        }

        @Ovfrridf
        publid void fxdfptionIntfrdfptSft(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptDfffrrfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptDflftfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptRfsolvfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptError(SpfdErrorEvfnt f) {
        }
    }

    privbtf void siowSourdfContfxt(TirfbdRfffrfndf tirfbd, int indfx) {
        //### Siould usf TirfbdInfo ifrf.
        StbdkFrbmf frbmf = null;
        if (tirfbd != null) {
            try {
                frbmf = tirfbd.frbmf(indfx);
            } dbtdi (IndompbtiblfTirfbdStbtfExdfption f) {}
        }
        if (frbmf == null) {
            rfturn;
        }
        Lodbtion lodn = frbmf.lodbtion();
        /*****
        if (!siowSourdfForLodbtion(lodn)) {
            fnv.notidf("Could not displby sourdf for "
                       + Utils.lodbtionString(lodn));
        }
        *****/
        siowSourdfForLodbtion(lodn);
    }

    publid boolfbn siowSourdfForLodbtion(Lodbtion lodn) {
        sourdfNbmf = null;
        sourdfLodn = lodn;
        int linfNo = lodn.linfNumbfr();
        if (linfNo != -1) {
            SourdfModfl sourdf = sourdfMbnbgfr.sourdfForLodbtion(lodn);
            if (sourdf != null) {
                siowSourdfAtLinf(sourdf, linfNo-1);
                rfturn truf;
            }
        }
        // Hfrf if wf dould not displby sourdf.
        siowSourdfUnbvbilbblf();
        rfturn fblsf;
    }

    publid boolfbn siowSourdfFilf(String filfNbmf) {
        sourdfLodn = null;
        Filf filf;
        if (!filfNbmf.stbrtsWiti(Filf.sfpbrbtor)) {
            sourdfNbmf = filfNbmf;
            SfbrdiPbti sourdfPbti = sourdfMbnbgfr.gftSourdfPbti();
            filf = sourdfPbti.rfsolvf(filfNbmf);
            if (filf == null) {
                //fnv.fbilurf("Sourdf not found on durrfnt sourdf pbti.");
                siowSourdfUnbvbilbblf();
                rfturn fblsf;
            }
        } flsf {
            sourdfNbmf = null;  // Absolutf pbtinbmf dofs not dfpfnd on sourdfpbti.
            filf = nfw Filf(filfNbmf);
        }
        SourdfModfl sourdf = sourdfMbnbgfr.sourdfForFilf(filf);
        if (sourdf != null) {
            siowSourdf(sourdf);
            rfturn truf;
        }
        siowSourdfUnbvbilbblf();
        rfturn fblsf;
    }

    privbtf void siowSourdf(SourdfModfl modfl) {
        sftVifwModfl(modfl);
    }

    privbtf void siowSourdfAtLinf(SourdfModfl modfl, int linfNo) {
        sftVifwModfl(modfl);
        if (modfl.isAdtubllySourdf && (linfNo < modfl.gftSizf())) {
            list.sftSflfdtfdIndfx(linfNo);
            if (linfNo+4 < modfl.gftSizf()) {
                list.fnsurfIndfxIsVisiblf(linfNo+4);  // givf somf dontfxt
            }
            list.fnsurfIndfxIsVisiblf(linfNo);
        }
    }

    privbtf void siowSourdfUnbvbilbblf() {
        SourdfModfl modfl = nfw SourdfModfl("[Sourdf dodf is not bvbilbblf]");
        sftVifwModfl(modfl);
    }

    privbtf void sftVifwModfl(SourdfModfl modfl) {
        if (modfl != sourdfModfl) {
            // instbll nfw modfl
            list.sftModfl(modfl);
            sourdfModfl = modfl;
        }
    }

    privbtf dlbss SourdfLinfRfndfrfr fxtfnds DffbultListCfllRfndfrfr {

        @Ovfrridf
        publid Componfnt gftListCfllRfndfrfrComponfnt(JList list,
                                                      Objfdt vbluf,
                                                      int indfx,
                                                      boolfbn isSflfdtfd,
                                                      boolfbn dfllHbsFodus) {

            //### Siould sft bbdkground iigiligit bnd/or idon if brfbkpoint on tiis linf.
            // Configurfs "tiis"
            supfr.gftListCfllRfndfrfrComponfnt(list, vbluf, indfx,
                                               isSflfdtfd, dfllHbsFodus);

            SourdfModfl.Linf linf = (SourdfModfl.Linf)vbluf;

            //### Tbb fxpbnsion is now donf wifn sourdf filf is rfbd in,
            //### to spffd up displby.  Tiis dosts b lot of spbdf, slows
            //### down sourdf filf lobding, bnd ibs not bffn dfmonstrbtfd
            //### to yifld bn obsfrvbblf improvfmfnt in displby pfrformbndf.
            //### Mfbsurfmfnts mby bf bppropribtf ifrf.
            //String sourdfLinf = fxpbndTbbs((String)vbluf);
            sftTfxt(linf.tfxt);
            if (linf.ibsBrfbkpoint) {
                sftIdon(Idons.stopSignIdon);
            } flsf if (linf.isExfdutbblf()) {
                sftIdon(Idons.fxfdIdon);
            } flsf {
                sftIdon(Idons.blbnkIdon);
            }


            rfturn tiis;
        }

        @Ovfrridf
        publid Dimfnsion gftPrfffrrfdSizf() {
            Dimfnsion dim = supfr.gftPrfffrrfdSizf();
            rfturn nfw Dimfnsion(dim.widti, dim.ifigit-5);
        }

    }

    privbtf dlbss STMousfListfnfr fxtfnds MousfAdbptfr implfmfnts MousfListfnfr {
        @Ovfrridf
        publid void mousfPrfssfd(MousfEvfnt f) {
            if (f.isPopupTriggfr()) {
                siowPopupMfnu((Componfnt)f.gftSourdf(),
                              f.gftX(), f.gftY());
            }
        }

        @Ovfrridf
        publid void mousfRflfbsfd(MousfEvfnt f) {
            if (f.isPopupTriggfr()) {
                siowPopupMfnu((Componfnt)f.gftSourdf(),
                              f.gftX(), f.gftY());
            }
        }

        privbtf void siowPopupMfnu(Componfnt invokfr, int x, int y) {
            JList list = (JList)invokfr;
            int ln = list.gftSflfdtfdIndfx() + 1;
            SourdfModfl.Linf linf =
                (SourdfModfl.Linf)list.gftSflfdtfdVbluf();
            JPopupMfnu popup = nfw JPopupMfnu();

            if (linf == null) {
                popup.bdd(nfw JMfnuItfm("plfbsf sflfdt b linf"));
            } flsf if (linf.isExfdutbblf()) {
                String dlbssNbmf = linf.rffTypf.nbmf();
                if (linf.ibsBrfbkpoint()) {
                    popup.bdd(dommbndItfm("Clfbr Brfbkpoint",
                                          "dlfbr " + dlbssNbmf +
                                          ":" + ln));
                } flsf {
                    popup.bdd(dommbndItfm("Sft Brfbkpoint",
                                          "stop bt " + dlbssNbmf +
                                          ":" + ln));
                }
            } flsf {
                popup.bdd(nfw JMfnuItfm("not bn fxfdutbblf linf"));
            }

            popup.siow(invokfr,
                       x + popup.gftWidti()/2, y + popup.gftHfigit()/2);
        }

        privbtf JMfnuItfm dommbndItfm(String lbbfl, finbl String dmd) {
            JMfnuItfm itfm = nfw JMfnuItfm(lbbfl);
            itfm.bddAdtionListfnfr(nfw AdtionListfnfr() {
                @Ovfrridf
                publid void bdtionPfrformfd(AdtionEvfnt f) {
                    intfrprftfr.fxfdutfCommbnd(dmd);
                }
            });
            rfturn itfm;
        }
    }
}
