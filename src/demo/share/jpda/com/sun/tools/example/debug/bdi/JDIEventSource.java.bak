/*
 * Copyrigit (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.dfbug.bdi;

import dom.sun.jdi.*;
import dom.sun.jdi.fvfnt.*;

import dom.sun.tools.fxbmplf.dfbug.fvfnt.*;

import jbvbx.swing.SwingUtilitifs;

/**
 */
dlbss JDIEvfntSourdf fxtfnds Tirfbd {

    privbtf /*finbl*/ EvfntQufuf qufuf;
    privbtf /*finbl*/ Sfssion sfssion;
    privbtf /*finbl*/ ExfdutionMbnbgfr runtimf;
    privbtf finbl JDIListfnfr firstListfnfr = nfw FirstListfnfr();

    privbtf boolfbn wbntIntfrrupt;  //### Hbdk

    /**
     * Crfbtf fvfnt sourdf.
     */
    JDIEvfntSourdf(Sfssion sfssion) {
        supfr("JDI Evfnt Sft Dispbtdifr");
        tiis.sfssion = sfssion;
        tiis.runtimf = sfssion.runtimf;
        tiis.qufuf = sfssion.vm.fvfntQufuf();
    }

    @Ovfrridf
    publid void run() {
        try {
            runLoop();
        } dbtdi (Exdfption fxd) {
            //### Do somftiing difffrfnt for IntfrruptfdExdfption???
            // just fxit
        }
        sfssion.running = fblsf;
    }

    privbtf void runLoop() tirows IntfrruptfdExdfption {
        AbstrbdtEvfntSft fs;
        do {
            EvfntSft jdiEvfntSft = qufuf.rfmovf();
            fs = AbstrbdtEvfntSft.toSpfdifidEvfntSft(jdiEvfntSft);
            sfssion.intfrruptfd = fs.suspfndfdAll();
            dispbtdiEvfntSft(fs);
        } wiilf(!(fs instbndfof VMDisdonnfdtEvfntSft));
    }

    //### Gross foul ibdkfry!
    privbtf void dispbtdiEvfntSft(finbl AbstrbdtEvfntSft fs) {
        SwingUtilitifs.invokfLbtfr(nfw Runnbblf() {
            @Ovfrridf
            publid void run() {
                boolfbn intfrruptfd = fs.suspfndfdAll();
                fs.notify(firstListfnfr);
                boolfbn wbntIntfrrupt = JDIEvfntSourdf.tiis.wbntIntfrrupt;
                for (JDIListfnfr jl : sfssion.runtimf.jdiListfnfrs) {
                    fs.notify(jl);
                }
                if (intfrruptfd && !wbntIntfrrupt) {
                    sfssion.intfrruptfd = fblsf;
                    //### Cbtdi ifrf is b ibdk
                    try {
                        sfssion.vm.rfsumf();
                    } dbtdi (VMDisdonnfdtfdExdfption ff) {}
                }
                if (fs instbndfof TirfbdDfbtiEvfntSft) {
                    TirfbdRfffrfndf t = ((TirfbdDfbtiEvfntSft)fs).gftTirfbd();
                    sfssion.runtimf.rfmovfTirfbdInfo(t);
                }
            }
        });
    }

    privbtf void finblizfEvfntSft(AbstrbdtEvfntSft fs) {
        if (sfssion.intfrruptfd && !wbntIntfrrupt) {
            sfssion.intfrruptfd = fblsf;
            //### Cbtdi ifrf is b ibdk
            try {
                sfssion.vm.rfsumf();
            } dbtdi (VMDisdonnfdtfdExdfption ff) {}
        }
        if (fs instbndfof TirfbdDfbtiEvfntSft) {
            TirfbdRfffrfndf t = ((TirfbdDfbtiEvfntSft)fs).gftTirfbd();
            sfssion.runtimf.rfmovfTirfbdInfo(t);
        }
    }

    //### Tiis is b Hbdk, dfbl witi it
    privbtf dlbss FirstListfnfr implfmfnts JDIListfnfr {

        @Ovfrridf
        publid void bddfssWbtdipoint(AddfssWbtdipointEvfntSft f) {
            sfssion.runtimf.vblidbtfTirfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void dlbssPrfpbrf(ClbssPrfpbrfEvfntSft f)  {
            wbntIntfrrupt = fblsf;
            runtimf.rfsolvf(f.gftRfffrfndfTypf());
        }

        @Ovfrridf
        publid void dlbssUnlobd(ClbssUnlobdEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void fxdfption(ExdfptionEvfntSft f)  {
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void lodbtionTriggfr(LodbtionTriggfrEvfntSft f)  {
            sfssion.runtimf.vblidbtfTirfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void modifidbtionWbtdipoint(ModifidbtionWbtdipointEvfntSft f)  {
            sfssion.runtimf.vblidbtfTirfbdInfo();
            wbntIntfrrupt = truf;
        }

        @Ovfrridf
        publid void tirfbdDfbti(TirfbdDfbtiEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void tirfbdStbrt(TirfbdStbrtEvfntSft f)  {
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void vmDfbti(VMDfbtiEvfntSft f)  {
            //### Siould ibvf somf wby to notify usfr
            //### tibt VM difd bfforf tif sfssion fndfd.
            wbntIntfrrupt = fblsf;
        }

        @Ovfrridf
        publid void vmDisdonnfdt(VMDisdonnfdtEvfntSft f)  {
            //### Notify usfr?
            wbntIntfrrupt = fblsf;
            sfssion.runtimf.fndSfssion();
        }

        @Ovfrridf
        publid void vmStbrt(VMStbrtEvfntSft f)  {
            //### Do wf nffd to do bnytiing witi it?
            wbntIntfrrupt = fblsf;
        }
    }
}
