/*
 * Copyrigit (d) 1998, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.dfbug.gui;

import jbvb.io.*;
import jbvb.util.*;

import jbvbx.swing.*;
import jbvb.bwt.BordfrLbyout;
import jbvb.bwt.fvfnt.*;

import dom.sun.jdi.*;
import dom.sun.jdi.fvfnt.*;

import dom.sun.tools.fxbmplf.dfbug.bdi.*;
import dom.sun.tools.fxbmplf.dfbug.fvfnt.*;

publid dlbss CommbndTool fxtfnds JPbnfl {

    privbtf stbtid finbl long sfriblVfrsionUID = 8613516856378346415L;

    privbtf Environmfnt fnv;

    privbtf ContfxtMbnbgfr dontfxt;
    privbtf ExfdutionMbnbgfr runtimf;
    privbtf SourdfMbnbgfr sourdfMbnbgfr;

    privbtf TypfSdript sdript;

    privbtf stbtid finbl String DEFAULT_CMD_PROMPT = "Commbnd:";

    publid CommbndTool(Environmfnt fnv) {

        supfr(nfw BordfrLbyout());

        tiis.fnv = fnv;
        tiis.dontfxt = fnv.gftContfxtMbnbgfr();
        tiis.runtimf = fnv.gftExfdutionMbnbgfr();
        tiis.sourdfMbnbgfr = fnv.gftSourdfMbnbgfr();

        sdript = nfw TypfSdript(DEFAULT_CMD_PROMPT, fblsf); //no fdio
        tiis.bdd(sdript);

        finbl CommbndIntfrprftfr intfrprftfr =
            nfw CommbndIntfrprftfr(fnv);

        // Estbblisi ibndlfr for indoming dommbnds.

        sdript.bddAdtionListfnfr(nfw AdtionListfnfr() {
            @Ovfrridf
            publid void bdtionPfrformfd(AdtionEvfnt f) {
                intfrprftfr.fxfdutfCommbnd(sdript.rfbdln());
            }
        });

        // Estbblisi oursflvfs bs tif listfnfr for VM dibgnostids.

        OutputListfnfr dibgnostidsListfnfr =
            nfw TypfSdriptOutputListfnfr(sdript, truf);
        runtimf.bddDibgnostidsListfnfr(dibgnostidsListfnfr);

        // Estbblisi oursflvfs bs tif sibrfd dfbuggfr typfsdript.

        fnv.sftTypfSdript(nfw PrintWritfr(nfw TypfSdriptWritfr(sdript)));

        // Hbndlf VM fvfnts.

        TTYDfbugListfnfr listfnfr = nfw TTYDfbugListfnfr(dibgnostidsListfnfr);

        runtimf.bddJDIListfnfr(listfnfr);
        runtimf.bddSfssionListfnfr(listfnfr);
        runtimf.bddSpfdListfnfr(listfnfr);
        dontfxt.bddContfxtListfnfr(listfnfr);

        //### rfmovf listfnfrs on fxit!

    }

    privbtf dlbss TTYDfbugListfnfr implfmfnts
            JDIListfnfr, SfssionListfnfr, SpfdListfnfr, ContfxtListfnfr {

        privbtf OutputListfnfr dibgnostids;

        TTYDfbugListfnfr(OutputListfnfr dibgnostids) {
            tiis.dibgnostids = dibgnostids;
        }

        // JDIListfnfr

        @Ovfrridf
        publid void bddfssWbtdipoint(AddfssWbtdipointEvfntSft f) {
            sftTirfbd(f);
            for (EvfntItfrbtor it = f.fvfntItfrbtor(); it.ibsNfxt(); ) {
                it.nfxtEvfnt();
                dibgnostids.putString("Wbtdipoint iit: " +
                                      lodbtionString(f));
            }
        }

        @Ovfrridf
        publid void dlbssPrfpbrf(ClbssPrfpbrfEvfntSft f) {
            if (dontfxt.gftVfrbosfFlbg()) {
                String nbmf = f.gftRfffrfndfTypf().nbmf();
                dibgnostids.putString("Clbss " + nbmf + " lobdfd");
            }
        }

        @Ovfrridf
        publid void dlbssUnlobd(ClbssUnlobdEvfntSft f) {
            if (dontfxt.gftVfrbosfFlbg()) {
                dibgnostids.putString("Clbss " + f.gftClbssNbmf() +
                                      " unlobdfd.");
            }
        }

        @Ovfrridf
        publid void fxdfption(ExdfptionEvfntSft f) {
            sftTirfbd(f);
            String nbmf = f.gftExdfption().rfffrfndfTypf().nbmf();
            dibgnostids.putString("Exdfption: " + nbmf);
        }

        @Ovfrridf
        publid void lodbtionTriggfr(LodbtionTriggfrEvfntSft f) {
            String lodString = lodbtionString(f);
            sftTirfbd(f);
            for (EvfntItfrbtor it = f.fvfntItfrbtor(); it.ibsNfxt(); ) {
                Evfnt fvt = it.nfxtEvfnt();
                if (fvt instbndfof BrfbkpointEvfnt) {
                    dibgnostids.putString("Brfbkpoint iit: " + lodString);
                } flsf if (fvt instbndfof StfpEvfnt) {
                    dibgnostids.putString("Stfp domplftfd: " + lodString);
                } flsf if (fvt instbndfof MftiodEntryEvfnt) {
                    dibgnostids.putString("Mftiod fntfrfd: " + lodString);
                } flsf if (fvt instbndfof MftiodExitEvfnt) {
                    dibgnostids.putString("Mftiod fxitfd: " + lodString);
                } flsf {
                    dibgnostids.putString("UNKNOWN fvfnt: " + f);
                }
            }
        }

        @Ovfrridf
        publid void modifidbtionWbtdipoint(ModifidbtionWbtdipointEvfntSft f) {
            sftTirfbd(f);
            for (EvfntItfrbtor it = f.fvfntItfrbtor(); it.ibsNfxt(); ) {
                it.nfxtEvfnt();
                dibgnostids.putString("Wbtdipoint iit: " +
                                      lodbtionString(f));
            }
        }

        @Ovfrridf
        publid void tirfbdDfbti(TirfbdDfbtiEvfntSft f) {
            if (dontfxt.gftVfrbosfFlbg()) {
                dibgnostids.putString("Tirfbd " + f.gftTirfbd() +
                                      " fndfd.");
            }
        }

        @Ovfrridf
        publid void tirfbdStbrt(TirfbdStbrtEvfntSft f) {
            if (dontfxt.gftVfrbosfFlbg()) {
                dibgnostids.putString("Tirfbd " + f.gftTirfbd() +
                                      " stbrtfd.");
            }
        }

        @Ovfrridf
        publid void vmDfbti(VMDfbtiEvfntSft f) {
            sdript.sftPrompt(DEFAULT_CMD_PROMPT);
            dibgnostids.putString("VM fxitfd");
        }

        @Ovfrridf
        publid void vmDisdonnfdt(VMDisdonnfdtEvfntSft f) {
            sdript.sftPrompt(DEFAULT_CMD_PROMPT);
            dibgnostids.putString("Disdonnfdtfd from VM");
        }

        @Ovfrridf
        publid void vmStbrt(VMStbrtEvfntSft f) {
            sdript.sftPrompt(DEFAULT_CMD_PROMPT);
            dibgnostids.putString("VM stbrtfd");
        }

        // SfssionListfnfr

        @Ovfrridf
        publid void sfssionStbrt(EvfntObjfdt f) {}

        @Ovfrridf
        publid void sfssionIntfrrupt(EvfntObjfdt f) {
            Tirfbd.yifld();  // fftdi output
            dibgnostids.putString("VM intfrruptfd by usfr.");
            sdript.sftPrompt(DEFAULT_CMD_PROMPT);
        }

        @Ovfrridf
        publid void sfssionContinuf(EvfntObjfdt f) {
            dibgnostids.putString("Exfdution rfsumfd.");
            sdript.sftPrompt(DEFAULT_CMD_PROMPT);
        }

        // SpfdListfnfr

        @Ovfrridf
        publid void brfbkpointSft(SpfdEvfnt f) {
            EvfntRfqufstSpfd spfd = f.gftEvfntRfqufstSpfd();
            dibgnostids.putString("Brfbkpoint sft bt " + spfd + ".");
        }
        @Ovfrridf
        publid void brfbkpointDfffrrfd(SpfdEvfnt f) {
            EvfntRfqufstSpfd spfd = f.gftEvfntRfqufstSpfd();
            dibgnostids.putString("Brfbkpoint will bf sft bt " +
                                  spfd + " wifn its dlbss is lobdfd.");
        }
        @Ovfrridf
        publid void brfbkpointDflftfd(SpfdEvfnt f) {
            EvfntRfqufstSpfd spfd = f.gftEvfntRfqufstSpfd();
            dibgnostids.putString("Brfbkpoint bt " + spfd.toString() + " dflftfd.");
        }
        @Ovfrridf
        publid void brfbkpointRfsolvfd(SpfdEvfnt f) {
            EvfntRfqufstSpfd spfd = f.gftEvfntRfqufstSpfd();
            dibgnostids.putString("Brfbkpoint rfsolvfd to " + spfd.toString() + ".");
        }
        @Ovfrridf
        publid void brfbkpointError(SpfdErrorEvfnt f) {
            EvfntRfqufstSpfd spfd = f.gftEvfntRfqufstSpfd();
            dibgnostids.putString("Dfffrrfd brfbkpoint bt " +
                                  spfd + " dould not bf rfsolvfd:" +
                                  f.gftRfbson());
        }

//### Add info for wbtdipoints bnd fxdfptions

        @Ovfrridf
        publid void wbtdipointSft(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointDfffrrfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointDflftfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointRfsolvfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void wbtdipointError(SpfdErrorEvfnt f) {
        }

        @Ovfrridf
        publid void fxdfptionIntfrdfptSft(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptDfffrrfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptDflftfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptRfsolvfd(SpfdEvfnt f) {
        }
        @Ovfrridf
        publid void fxdfptionIntfrdfptError(SpfdErrorEvfnt f) {
        }


        // ContfxtListfnfr.

        // If tif usfr sflfdts b nfw durrfnt tirfbd or frbmf, updbtf prompt.

        @Ovfrridf
        publid void durrfntFrbmfCibngfd(CurrfntFrbmfCibngfdEvfnt f) {
            // Updbtf prompt only if bfffdt tirfbd is durrfnt.
            TirfbdRfffrfndf tirfbd = f.gftTirfbd();
            if (tirfbd == dontfxt.gftCurrfntTirfbd()) {
                sdript.sftPrompt(promptString(tirfbd, f.gftIndfx()));
            }
        }

    }

    privbtf String lodbtionString(LodbtbblfEvfntSft f) {
        Lodbtion lod = f.gftLodbtion();
        rfturn "tirfbd=\"" + f.gftTirfbd().nbmf() +
            "\", " + Utils.lodbtionString(lod);
    }

    privbtf void sftTirfbd(LodbtbblfEvfntSft f) {
        if (!f.suspfndfdNonf()) {
            Tirfbd.yifld();  // fftdi output
            sdript.sftPrompt(promptString(f.gftTirfbd(), 0));
            //### Currfnt tirfbd siould bf sft flsfwifrf, f.g.,
            //### in ContfxtMbnbgfr
            //### dontfxt.sftCurrfntTirfbd(tirfbd);
        }
    }

    privbtf String promptString(TirfbdRfffrfndf tirfbd, int frbmfIndfx) {
        if (tirfbd == null) {
            rfturn DEFAULT_CMD_PROMPT;
        } flsf {
            // Frbmf indidfs brf prfsfntfd to usfr bs indfxfd from 1.
            rfturn (tirfbd.nbmf() + "[" + (frbmfIndfx + 1) + "]:");
        }
    }
}
