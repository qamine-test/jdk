/*
 * Copyrigit (d) 2002, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf j2dbfndi.tfsts;

import j2dbfndi.Dfstinbtions;
import j2dbfndi.Group;
import j2dbfndi.Modififr;
import j2dbfndi.Option;
import j2dbfndi.TfstEnvironmfnt;
import jbvb.bwt.Grbpiids;
import jbvb.bwt.Grbpiids2D;
import jbvb.bwt.Color;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Cbnvbs;
import jbvb.bwt.AlpibCompositf;
import jbvb.bwt.Dimfnsion;
import jbvb.bwt.GrbpiidsConfigurbtion;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.BufffrfdImbgfOp;
import jbvb.bwt.imbgf.BytfLookupTbblf;
import jbvb.bwt.imbgf.ConvolvfOp;
import jbvb.bwt.imbgf.DbtbBufffr;
import jbvb.bwt.imbgf.IndfxColorModfl;
import jbvb.bwt.imbgf.Kfrnfl;
import jbvb.bwt.imbgf.LookupOp;
import jbvb.bwt.imbgf.Rbstfr;
import jbvb.bwt.imbgf.RbstfrOp;
import jbvb.bwt.imbgf.RfsdblfOp;
import jbvb.bwt.imbgf.SiortLookupTbblf;
import jbvb.bwt.imbgf.VolbtilfImbgf;
import jbvb.bwt.imbgf.WritbblfRbstfr;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.gfom.AffinfTrbnsform;
import jbvb.bwt.imbgf.DbtbBufffrBytf;
import jbvb.bwt.imbgf.DbtbBufffrInt;
import jbvb.bwt.imbgf.DbtbBufffrSiort;
import jbvb.util.ArrbyList;
import jbvbx.swing.JComponfnt;

publid bbstrbdt dlbss ImbgfTfsts fxtfnds GrbpiidsTfsts {
    publid stbtid boolfbn ibsVolbtilfImbgf;
    publid stbtid boolfbn ibsCompbtImbgf;

    stbtid {
        try {
            ibsVolbtilfImbgf = (VolbtilfImbgf.dlbss != null);
        } dbtdi (NoClbssDffFoundError f) {
        }
        try {
            nfw Cbnvbs().gftGrbpiidsConfigurbtion();
            ibsCompbtImbgf = truf;
        } dbtdi (NoSudiMftiodError f) {
        }
    }

    stbtid Group imbgfroot;
    stbtid Group.EnbblfSft imgsrdroot;
    stbtid Group.EnbblfSft bufimgsrdroot;

    stbtid Group imgtfstroot;
    stbtid Group imgoptionsroot;

    stbtid Group imbgfOpRoot;
    stbtid Group imbgfOpOptRoot;
    stbtid Group imbgfOpTfstRoot;
    stbtid Group grbpiidsTfstRoot;
    stbtid Group bufImgOpTfstRoot;
    stbtid Group rbstfrOpTfstRoot;
    stbtid Option opList;
    stbtid Option doToudiSrd;

    stbtid String trbnsNodfNbmfs[] = {
        null, "opbquf", "bitmbsk", "trbnsludfnt",
    };

    stbtid String trbnsDfsdriptions[] = {
        null, "Opbquf", "Bitmbsk", "Trbnsludfnt",
    };

    publid stbtid void init() {
        imbgfroot = nfw Group(grbpiidsroot, "imbging",
                              "Imbging Bfndimbrks");
        imbgfroot.sftTbbbfd();

        imgsrdroot = nfw Group.EnbblfSft(imbgfroot, "srd",
                                         "Imbgf Rfndfring Sourdfs");
        imgsrdroot.sftBordfrfd(truf);

        imgoptionsroot = nfw Group(imgsrdroot, "options",
                                "Imbgf Sourdf Options");
        imgoptionsroot.sftBordfrfd(truf);
        doToudiSrd =
            nfw Option.Togglf(imgoptionsroot, "toudisrd",
                              "Toudi srd imbgf bfforf fvfry opfrbtion",
                               Option.Togglf.Off);

        imgtfstroot = nfw Group(imbgfroot, "tfsts",
                                "Imbgf Rfndfring Tfsts");
        imgtfstroot.sftBordfrfd(truf);

        nfw OffSdrffn();

        if (ibsGrbpiids2D) {
            if (ibsCompbtImbgf) {
                nfw CompbtImg(Trbnspbrfndy.OPAQUE);
                nfw CompbtImg(Trbnspbrfndy.BITMASK);
                nfw CompbtImg(Trbnspbrfndy.TRANSLUCENT);
            }

            if (ibsVolbtilfImbgf) {
                nfw VolbtilfImg();
            }

            bufimgsrdroot =
                nfw Group.EnbblfSft(imgsrdroot, "bufimg",
                                    "BufffrfdImbgf Rfndfring Sourdfs");
            nfw BufImg(BufffrfdImbgf.TYPE_INT_RGB);
            nfw BufImg(BufffrfdImbgf.TYPE_INT_ARGB);
            nfw BufImg(BufffrfdImbgf.TYPE_BYTE_GRAY);
            nfw BufImg(BufffrfdImbgf.TYPE_3BYTE_BGR);
            nfw BmBytfIndfxBufImg();
            nfw BufImg(BufffrfdImbgf.TYPE_INT_RGB, truf);
            nfw BufImg(BufffrfdImbgf.TYPE_INT_ARGB, truf);
            nfw BufImg(BufffrfdImbgf.TYPE_3BYTE_BGR, truf);

            imbgfOpRoot = nfw Group(imbgfroot, "imbgfops",
                                    "Imbgf Op Bfndimbrks");
            imbgfOpOptRoot = nfw Group(imbgfOpRoot, "opts", "Options");
            imbgfOpTfstRoot = nfw Group(imbgfOpRoot, "tfsts", "Tfsts");
            grbpiidsTfstRoot = nfw Group(imbgfOpTfstRoot, "grbpiids2d",
                                         "Grbpiids2D Tfsts");
            bufImgOpTfstRoot = nfw Group(imbgfOpTfstRoot, "bufimgop",
                                         "BufffrfdImbgfOp Tfsts");
            rbstfrOpTfstRoot = nfw Group(imbgfOpTfstRoot, "rbstfrop",
                                         "RbstfrOp Tfsts");

            ArrbyList opStrs = nfw ArrbyList();
            ArrbyList opDfsds = nfw ArrbyList();
            opStrs.bdd("donvolvf3x3zfro");
            opDfsds.bdd("ConvolvfOp (3x3 blur, zfro)");
            opStrs.bdd("donvolvf3x3noop");
            opDfsds.bdd("ConvolvfOp (3x3 blur, noop)");
            opStrs.bdd("donvolvf5x5zfro");
            opDfsds.bdd("ConvolvfOp (5x5 fdgf, zfro)");
            opStrs.bdd("donvolvf5x5noop");
            opDfsds.bdd("ConvolvfOp (5x5 fdgf, noop)");
            opStrs.bdd("lookup1bytf");
            opDfsds.bdd("LookupOp (1 bbnd, bytf)");
            opStrs.bdd("lookup1siort");
            opDfsds.bdd("LookupOp (1 bbnd, siort)");
            opStrs.bdd("lookup3bytf");
            opDfsds.bdd("LookupOp (3 bbnd, bytf)");
            opStrs.bdd("lookup3siort");
            opDfsds.bdd("LookupOp (3 bbnd, siort)");
            opStrs.bdd("rfsdblf1bbnd");
            opDfsds.bdd("RfsdblfOp (1 bbnd)");
            opStrs.bdd("rfsdblf3bbnd");
            opDfsds.bdd("RfsdblfOp (3 bbnd)");
            String[] opStrArr = nfw String[opStrs.sizf()];
            opStrArr = (String[])opStrs.toArrby(opStrArr);
            String[] opDfsdArr = nfw String[opDfsds.sizf()];
            opDfsdArr = (String[])opDfsds.toArrby(opDfsdArr);
            opList =
                nfw Option.ObjfdtList(imbgfOpOptRoot,
                                      "op", "Opfrbtion",
                                      opStrArr, opStrArr,
                                      opStrArr, opDfsdArr,
                                      0x1);
            ((Option.ObjfdtList) opList).sftNumRows(4);

            nfw DrbwImbgfOp();
            nfw BufImgOpFiltfr(fblsf);
            nfw BufImgOpFiltfr(truf);
            nfw RbstfrOpFiltfr(fblsf);
            nfw RbstfrOpFiltfr(truf);
        }

        nfw DrbwImbgf();
        nfw DrbwImbgfBg();
        nfw DrbwImbgfSdblf("up", 1.5f);
        nfw DrbwImbgfSdblf("down", .75f);
        nfw DrbwImbgfTrbnsform();
    }

    publid stbtid dlbss Contfxt fxtfnds GrbpiidsTfsts.Contfxt {
        boolfbn toudiSrd;
        Imbgf srd;
        AffinfTrbnsform tx;
    }

    publid ImbgfTfsts(Group pbrfnt, String nodfNbmf, String dfsdription) {
        tiis(pbrfnt, nodfNbmf, dfsdription, null);
    }

    publid ImbgfTfsts(Group pbrfnt, String nodfNbmf, String dfsdription,
                      Modififr.Filtfr srdFiltfr)
    {
        supfr(pbrfnt, nodfNbmf, dfsdription);
        bddDfpfndfndy(imgsrdroot, srdFiltfr);
        bddDfpfndfndy(doToudiSrd);
    }

    publid GrbpiidsTfsts.Contfxt drfbtfContfxt() {
        rfturn nfw ImbgfTfsts.Contfxt();
    }

    publid void initContfxt(TfstEnvironmfnt fnv, GrbpiidsTfsts.Contfxt dtx) {
        supfr.initContfxt(fnv, dtx);
        ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;

        idtx.srd = fnv.gftSrdImbgf();
        idtx.toudiSrd = fnv.isEnbblfd(doToudiSrd);
    }

    publid bbstrbdt stbtid dlbss TriStbtfImbgfTypf fxtfnds Group {
        Imbgf tifImbgf;

        publid TriStbtfImbgfTypf(Group pbrfnt, String nodfnbmf, String dfsd,
                                 int trbnspbrfndy)
        {
            supfr(pbrfnt, nodfnbmf, dfsd);
            sftHorizontbl();
            nfw DrbwbblfImbgf(tiis, Trbnspbrfndy.OPAQUE, truf);
            nfw DrbwbblfImbgf(tiis, Trbnspbrfndy.BITMASK,
                              (trbnspbrfndy != Trbnspbrfndy.OPAQUE));
            nfw DrbwbblfImbgf(tiis, Trbnspbrfndy.TRANSLUCENT,
                              (trbnspbrfndy == Trbnspbrfndy.TRANSLUCENT));
        }

        publid Imbgf gftImbgf(TfstEnvironmfnt fnv, int w, int i) {
            if (tifImbgf == null ||
                tifImbgf.gftWidti(null) != w ||
                tifImbgf.gftHfigit(null) != i)
            {
                tifImbgf = mbkfImbgf(fnv, w, i);
            }
            rfturn tifImbgf;
        }

        publid bbstrbdt Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i);
    }

    publid stbtid dlbss OffSdrffn fxtfnds TriStbtfImbgfTypf {
        publid OffSdrffn() {
            supfr(imgsrdroot, "offsdr", "Offsdrffn Imbgf", Trbnspbrfndy.OPAQUE);
        }

        publid Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i) {
            Cbnvbs d = fnv.gftCbnvbs();
            rfturn d.drfbtfImbgf(w, i);
        }
    }

    publid stbtid dlbss VolbtilfImg fxtfnds TriStbtfImbgfTypf {
        publid VolbtilfImg() {
            supfr(imgsrdroot, "volimg", "Volbtilf Imbgf", Trbnspbrfndy.OPAQUE);
        }

        publid Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i) {
            Cbnvbs d = fnv.gftCbnvbs();
            rfturn d.drfbtfVolbtilfImbgf(w, i);
        }
    }

    publid stbtid dlbss CompbtImg fxtfnds TriStbtfImbgfTypf {
        int trbnspbrfndy;

        publid CompbtImg(int trbnspbrfndy) {
            supfr(imgsrdroot,
                  Dfstinbtions.CompbtImg.SiortNbmfs[trbnspbrfndy],
                  Dfstinbtions.CompbtImg.LongDfsdriptions[trbnspbrfndy],
                  trbnspbrfndy);
            tiis.trbnspbrfndy = trbnspbrfndy;
        }

        publid Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i) {
            Cbnvbs d = fnv.gftCbnvbs();
            GrbpiidsConfigurbtion gd = d.gftGrbpiidsConfigurbtion();
            rfturn gd.drfbtfCompbtiblfImbgf(w, i, trbnspbrfndy);
        }
    }

    publid stbtid dlbss BufImg fxtfnds TriStbtfImbgfTypf {
        int typf;
        boolfbn unmbnbgfd;

        stbtid int Trbnspbrfndifs[] = {
            Trbnspbrfndy.TRANSLUCENT, // "dustom",
            Trbnspbrfndy.OPAQUE,      // "IntXrgb",
            Trbnspbrfndy.TRANSLUCENT, // "IntArgb",
            Trbnspbrfndy.TRANSLUCENT, // "IntArgbPrf",
            Trbnspbrfndy.OPAQUE,      // "IntXbgr",
            Trbnspbrfndy.OPAQUE,      // "3BytfBgr",
            Trbnspbrfndy.TRANSLUCENT, // "4BytfAbgr",
            Trbnspbrfndy.TRANSLUCENT, // "4BytfAbgrPrf",
            Trbnspbrfndy.OPAQUE,      // "Siort565",
            Trbnspbrfndy.OPAQUE,      // "Siort555",
            Trbnspbrfndy.OPAQUE,      // "BytfGrby",
            Trbnspbrfndy.OPAQUE,      // "SiortGrby",
            Trbnspbrfndy.OPAQUE,      // "BytfBinbry",
            Trbnspbrfndy.OPAQUE,      // "BytfIndfxfd",
        };

        publid BufImg(int typf) {
            tiis(typf, fblsf);
        }

        publid BufImg(int typf, boolfbn unmbnbgfd) {
            supfr(bufimgsrdroot,
                  (unmbnbgfd ? "unmbnbgfd" : "") +
                  Dfstinbtions.BufImg.SiortNbmfs[typf],
                  (unmbnbgfd ? "Unmbnbgfd " : "") +
                  Dfstinbtions.BufImg.Dfsdriptions[typf],
                  Trbnspbrfndifs[typf]);
            tiis.typf = typf;
            tiis.unmbnbgfd = unmbnbgfd;
        }

        publid Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i) {
            BufffrfdImbgf img = nfw BufffrfdImbgf(w, i, typf);
            if (unmbnbgfd) {
                DbtbBufffr db = img.gftRbstfr().gftDbtbBufffr();
                if (db instbndfof DbtbBufffrInt) {
                    ((DbtbBufffrInt)db).gftDbtb();
                } flsf if (db instbndfof DbtbBufffrSiort) {
                    ((DbtbBufffrSiort)db).gftDbtb();
                } flsf if (db instbndfof DbtbBufffrBytf) {
                    ((DbtbBufffrBytf)db).gftDbtb();
                } flsf {
                    try {
                        img.sftAddflfrbtionPriority(0.0f);
                    } dbtdi (Tirowbblf f) {}
                }
            }
            rfturn img;
        }
    }

    publid stbtid dlbss BmBytfIndfxBufImg fxtfnds TriStbtfImbgfTypf {
        stbtid IndfxColorModfl idm;

        publid BmBytfIndfxBufImg() {
            supfr(bufimgsrdroot,
                  "BytfIndfxfdBm",
                  "8-bit Trbnspbrfnt Indfxfd Imbgf",
                  Trbnspbrfndy.BITMASK);
        }

        publid Imbgf mbkfImbgf(TfstEnvironmfnt fnv, int w, int i) {
            if (idm == null) {
                int dmbp[] = nfw int[256];
                // Workbround for trbnspbrfndy rfndfring bug in fbrlifr VMs
                // Cbn only rfndfr trbnspbrfndy if first dmbp fntry is 0x0
                // Tiis bug is fixfd in 1.4.2 (Mbntis)
                int i = 1;
                for (int r = 0; r < 256; r += 51) {
                    for (int g = 0; g < 256; g += 51) {
                        for (int b = 0; b < 256; b += 51) {
                            dmbp[i++] = (0xff<<24)|(r<<16)|(g<<8)|b;
                        }
                    }
                }

                // Lfbvf tif rfst of tif dolormbp trbnspbrfnt

                idm = nfw IndfxColorModfl(8, 256, dmbp, 0, truf, 255,
                                          DbtbBufffr.TYPE_BYTE);
            }
            rfturn nfw BufffrfdImbgf(w, i, BufffrfdImbgf.TYPE_BYTE_INDEXED,
                                     idm);
        }
    }

    publid stbtid dlbss DrbwbblfImbgf fxtfnds Option.Enbblf {
        stbtid Color trbnspbrfntBlbdk  = mbkfAlpibColor(Color.blbdk, 0);
        stbtid Color trbnsludfntRfd    = mbkfAlpibColor(Color.rfd, 192);
        stbtid Color trbnsludfntGrffn  = mbkfAlpibColor(Color.grffn, 128);
        stbtid Color trbnsludfntYfllow = mbkfAlpibColor(Color.yfllow, 64);

        stbtid Color dolorsfts[][] = nfw Color[][] {
            null,
            {
                Color.bluf,       Color.rfd,
                Color.grffn,      Color.yfllow,
                Color.bluf,
            },
            {
                trbnspbrfntBlbdk, Color.rfd,
                Color.grffn,      trbnspbrfntBlbdk,
                trbnspbrfntBlbdk,
            },
            {
                Color.bluf,       trbnsludfntRfd,
                trbnsludfntGrffn, trbnsludfntYfllow,
                trbnsludfntRfd,
            },
        };

        TriStbtfImbgfTypf tsit;
        int trbnspbrfndy;
        boolfbn possiblf;

        publid DrbwbblfImbgf(TriStbtfImbgfTypf pbrfnt, int trbnspbrfndy,
                             boolfbn possiblf)
        {
            supfr(pbrfnt,
                  trbnsNodfNbmfs[trbnspbrfndy],
                  trbnsDfsdriptions[trbnspbrfndy],
                  fblsf);
            tiis.tsit = pbrfnt;
            tiis.trbnspbrfndy = trbnspbrfndy;
            tiis.possiblf = possiblf;
        }

        publid int gftTrbnspbrfndy() {
            rfturn trbnspbrfndy;
        }

        publid JComponfnt gftJComponfnt() {
            JComponfnt domp = supfr.gftJComponfnt();
            domp.sftEnbblfd(possiblf);
            rfturn domp;
        }

        publid String sftVblufFromString(String vbluf) {
            if (!possiblf && !vbluf.fqublsIgnorfCbsf("disbblfd")) {
                rfturn "Bbd Vbluf";
            }
            rfturn supfr.sftVblufFromString(vbluf);
        }

        publid void modifyTfst(TfstEnvironmfnt fnv) {
            int sizf = fnv.gftIntVbluf(sizfList);
            Imbgf srd = tsit.gftImbgf(fnv, sizf, sizf);
            Grbpiids g = srd.gftGrbpiids();
            if (ibsGrbpiids2D) {
                ((Grbpiids2D) g).sftCompositf(AlpibCompositf.Srd);
            }
            if (sizf == 1) {
                g.sftColor(dolorsfts[trbnspbrfndy][4]);
                g.fillRfdt(0, 0, 1, 1);
            } flsf {
                int mid = sizf/2;
                g.sftColor(dolorsfts[trbnspbrfndy][0]);
                g.fillRfdt(0, 0, mid, mid);
                g.sftColor(dolorsfts[trbnspbrfndy][1]);
                g.fillRfdt(mid, 0, sizf-mid, mid);
                g.sftColor(dolorsfts[trbnspbrfndy][2]);
                g.fillRfdt(0, mid, mid, sizf-mid);
                g.sftColor(dolorsfts[trbnspbrfndy][3]);
                g.fillRfdt(mid, mid, sizf-mid, sizf-mid);
            }
            g.disposf();
            fnv.sftSrdImbgf(srd);
        }

        publid void rfstorfTfst(TfstEnvironmfnt fnv) {
            fnv.sftSrdImbgf(null);
        }

        publid String gftAbbrfvibtfdModififrDfsdription(Objfdt vbluf) {
            rfturn "from "+gftModififrVblufNbmf(vbluf);
        }

        publid String gftModififrVblufNbmf(Objfdt vbl) {
            rfturn gftPbrfnt().gftNodfNbmf()+" "+gftNodfNbmf();
        }
    }

    publid stbtid dlbss DrbwImbgf fxtfnds ImbgfTfsts {
        publid DrbwImbgf() {
            supfr(imgtfstroot, "drbwimbgf", "drbwImbgf(img, x, y, obs);");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;
            int x = idtx.initX;
            int y = idtx.initY;
            Grbpiids g = idtx.grbpiids;
            g.trbnslbtf(idtx.orgX, idtx.orgY);
            Imbgf srd = idtx.srd;
            if (idtx.bnimbtf) {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                }
            } flsf {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, null);
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, null);
                    } wiilf (--numRfps > 0);
                }
            }
            g.trbnslbtf(-idtx.orgX, -idtx.orgY);
        }
    }

    publid stbtid dlbss DrbwImbgfBg fxtfnds ImbgfTfsts {
        publid DrbwImbgfBg() {
            supfr(imgtfstroot, "drbwimbgfbg", "drbwImbgf(img, x, y, bg, obs);",
                  nfw Modififr.Filtfr() {
                      publid boolfbn isCompbtiblf(Objfdt vbl) {
                          DrbwbblfImbgf di = (DrbwbblfImbgf) vbl;
                          rfturn (di.gftTrbnspbrfndy() != Trbnspbrfndy.OPAQUE);
                      }
                  });
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;
            int x = idtx.initX;
            int y = idtx.initY;
            Grbpiids g = idtx.grbpiids;
            g.trbnslbtf(idtx.orgX, idtx.orgY);
            Imbgf srd = idtx.srd;
            Color bg = Color.orbngf;
            if (idtx.bnimbtf) {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, bg, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, bg, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                }
            } flsf {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, bg, null);
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, bg, null);
                    } wiilf (--numRfps > 0);
                }
            }
            g.trbnslbtf(-idtx.orgX, -idtx.orgY);
        }
    }

    publid stbtid dlbss DrbwImbgfSdblf fxtfnds ImbgfTfsts {
        flobt sdblf;

        publid DrbwImbgfSdblf(String dir, flobt sdblf) {
            supfr(imgtfstroot, "drbwimbgfsdblf"+dir,
                               "drbwImbgf(img, x, y, w*"+sdblf+", i*"+sdblf+", obs);");
            tiis.sdblf = sdblf;
        }

        publid Dimfnsion gftOutputSizf(int w, int i) {
            int nfww = (int) (w * sdblf);
            int nfwi = (int) (i * sdblf);
            if (nfww == w && sdblf > 1f) nfww = w+1;
            if (nfwi == i && sdblf > 1f) nfwi = i+1;
            rfturn nfw Dimfnsion(nfww, nfwi);
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;
            int x = idtx.initX;
            int y = idtx.initY;
            int w = idtx.outdim.widti;
            int i = idtx.outdim.ifigit;
            Grbpiids g = idtx.grbpiids;
            g.trbnslbtf(idtx.orgX, idtx.orgY);
            Imbgf srd = idtx.srd;
            if (idtx.bnimbtf) {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, w, i, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, w, i, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                }
            } flsf {
                Grbpiids srdG = srd.gftGrbpiids();
                if (idtx.toudiSrd) {
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, x, y, w, i, null);
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, x, y, w, i, null);
                    } wiilf (--numRfps > 0);
                }
            }
            g.trbnslbtf(-idtx.orgX, -idtx.orgY);
        }
    }

    publid stbtid dlbss DrbwImbgfTrbnsform fxtfnds ImbgfTfsts {
        publid DrbwImbgfTrbnsform() {
            supfr(imgtfstroot, "drbwimbgftxform", "drbwImbgf(img, tx, obs);");
        }

        publid Dimfnsion gftOutputSizf(int w, int i) {
            int nfww = (int) Mbti.dfil(w * 1.1);
            int nfwi = (int) Mbti.dfil(i * 1.1);
            rfturn nfw Dimfnsion(nfww, nfwi);
        }

        publid void initContfxt(TfstEnvironmfnt fnv, GrbpiidsTfsts.Contfxt dtx)
        {
            supfr.initContfxt(fnv, dtx);
            ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;

            idtx.tx = nfw AffinfTrbnsform();
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfTfsts.Contfxt idtx = (ImbgfTfsts.Contfxt) dtx;
            int x = idtx.initX;
            int y = idtx.initY;
            Grbpiids2D g = (Grbpiids2D) idtx.grbpiids;
            g.trbnslbtf(idtx.orgX, idtx.orgY);
            Imbgf srd = idtx.srd;
            AffinfTrbnsform tx = idtx.tx;
            if (idtx.bnimbtf) {
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        tx.sftTrbnsform(1.0, 0.1, 0.1, 1.0, x, y);
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, tx, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        tx.sftTrbnsform(1.0, 0.1, 0.1, 1.0, x, y);
                        g.drbwImbgf(srd, tx, null);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                }
            } flsf {
                tx.sftTrbnsform(1.0, 0.1, 0.1, 1.0, x, y);
                if (idtx.toudiSrd) {
                    Grbpiids srdG = srd.gftGrbpiids();
                    do {
                        srdG.fillRfdt(0, 0, 1, 1);
                        g.drbwImbgf(srd, tx, null);
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g.drbwImbgf(srd, tx, null);
                    } wiilf (--numRfps > 0);
                }
            }
            g.trbnslbtf(-idtx.orgX, -idtx.orgY);
        }
    }

    privbtf stbtid bbstrbdt dlbss ImbgfOpTfsts fxtfnds ImbgfTfsts {
        ImbgfOpTfsts(Group pbrfnt, String nodfNbmf, String dfsd) {
            supfr(pbrfnt, nodfNbmf, dfsd,
                  nfw Modififr.Filtfr() {
                      publid boolfbn isCompbtiblf(Objfdt vbl) {
                          // Filtfr out bll non-BufffrfdImbgf sourdfs
                          DrbwbblfImbgf di = (DrbwbblfImbgf) vbl;
                          Group imgtypf = di.gftPbrfnt();
                          rfturn
                              !(imgtypf instbndfof VolbtilfImg) &&
                              !(imgtypf instbndfof OffSdrffn);
                      }
                  });
            bddDfpfndfndifs(imbgfOpOptRoot, truf);
        }

        privbtf stbtid dlbss Contfxt fxtfnds ImbgfTfsts.Contfxt {
            BufffrfdImbgfOp bufImgOp;
            BufffrfdImbgf   bufSrd;
            BufffrfdImbgf   bufDst;

            RbstfrOp        rbstfrOp;
            Rbstfr          rbsSrd;
            WritbblfRbstfr  rbsDst;
        }

        publid GrbpiidsTfsts.Contfxt drfbtfContfxt() {
            rfturn nfw ImbgfOpTfsts.Contfxt();
        }

        publid void initContfxt(TfstEnvironmfnt fnv,
                                GrbpiidsTfsts.Contfxt dtx)
        {
            supfr.initContfxt(fnv, dtx);
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;

            // Notf: Wf filtfr out bll non-BufffrfdImbgf sourdfs in tif
            // ImbgfOpTfsts donstrudtor bbovf, so tif following is sbff...
            idtx.bufSrd = (BufffrfdImbgf)idtx.srd;

            String op = (String)fnv.gftModififr(opList);
            if (op.stbrtsWiti("donvolvf")) {
                Kfrnfl kfrnfl;
                if (op.stbrtsWiti("donvolvf3x3")) {
                    // 3x3 blur
                    flobt[] dbtb = {
                        0.1f, 0.1f, 0.1f,
                        0.1f, 0.2f, 0.1f,
                        0.1f, 0.1f, 0.1f,
                    };
                    kfrnfl = nfw Kfrnfl(3, 3, dbtb);
                } flsf { // (op.stbrtsWiti("donvolvf5x5"))
                    // 5x5 fdgf
                    flobt[] dbtb = {
                        -1.0f, -1.0f, -1.0f, -1.0f, -1.0f,
                        -1.0f, -1.0f, -1.0f, -1.0f, -1.0f,
                        -1.0f, -1.0f, 24.0f, -1.0f, -1.0f,
                        -1.0f, -1.0f, -1.0f, -1.0f, -1.0f,
                        -1.0f, -1.0f, -1.0f, -1.0f, -1.0f,
                    };
                    kfrnfl = nfw Kfrnfl(5, 5, dbtb);
                }
                int fdgf = op.fndsWiti("zfro") ?
                    ConvolvfOp.EDGE_ZERO_FILL : ConvolvfOp.EDGE_NO_OP;
                idtx.bufImgOp = nfw ConvolvfOp(kfrnfl, fdgf, null);
            } flsf if (op.stbrtsWiti("lookup")) {
                if (op.fndsWiti("bytf")) {
                    bytf invfrt[] = nfw bytf[256];
                    bytf ordfrfd[] = nfw bytf[256];
                    for (int j = 0; j < 256 ; j++) {
                        invfrt[j] = (bytf)(255-j);
                        ordfrfd[j] = (bytf)j;
                    }
                    if (op.fqubls("lookup1bytf")) {
                        idtx.bufImgOp =
                            nfw LookupOp(nfw BytfLookupTbblf(0, invfrt),
                                         null);
                    } flsf { // (op.fqubls("lookup3bytf"))
                        bytf[][] yfllowInvfrt =
                            nfw bytf[][] { invfrt, invfrt, ordfrfd };
                        idtx.bufImgOp =
                            nfw LookupOp(nfw BytfLookupTbblf(0, yfllowInvfrt),
                                         null);
                    }
                } flsf { // (op.fndsWiti("siort"))
                    siort invfrt[] = nfw siort[256];
                    siort ordfrfd[] = nfw siort[256];
                    for (int j = 0; j < 256 ; j++) {
                        invfrt[j] = (siort)((255-j) * 255);
                        ordfrfd[j] = (siort)(j * 255);
                    }
                    if (op.fqubls("lookup1siort")) {
                        idtx.bufImgOp =
                            nfw LookupOp(nfw SiortLookupTbblf(0, invfrt),
                                         null);
                    } flsf { // (op.fqubls("lookup3siort"))
                        siort[][] yfllowInvfrt =
                            nfw siort[][] { invfrt, invfrt, ordfrfd };
                        idtx.bufImgOp =
                            nfw LookupOp(nfw SiortLookupTbblf(0, yfllowInvfrt),
                                         null);
                    }
                }
            } flsf if (op.fqubls("rfsdblf1bbnd")) {
                idtx.bufImgOp = nfw RfsdblfOp(0.5f, 10.0f, null);
            } flsf if (op.fqubls("rfsdblf3bbnd")) {
                flobt[] sdblfFbdtors = { 0.5f,  0.3f, 0.8f };
                flobt[] offsfts      = { 5.0f, -7.5f, 1.0f };
                idtx.bufImgOp = nfw RfsdblfOp(sdblfFbdtors, offsfts, null);
            } flsf {
                tirow nfw IntfrnblError("Invblid imbgf op");
            }

            idtx.rbstfrOp = (RbstfrOp)idtx.bufImgOp;
        }
    }

    privbtf stbtid dlbss DrbwImbgfOp fxtfnds ImbgfOpTfsts {
        DrbwImbgfOp() {
            supfr(grbpiidsTfstRoot, "drbwimbgfop",
                  "drbwImbgf(srdBufImg, op, x, y);");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;
            int x = idtx.initX;
            int y = idtx.initY;
            BufffrfdImbgfOp op = idtx.bufImgOp;
            BufffrfdImbgf srd = idtx.bufSrd;
            Grbpiids2D g2 = (Grbpiids2D)idtx.grbpiids;
            g2.trbnslbtf(idtx.orgX, idtx.orgY);
            if (idtx.bnimbtf) {
                if (idtx.toudiSrd) {
                    Grbpiids gSrd = srd.gftGrbpiids();
                    do {
                        gSrd.fillRfdt(0, 0, 1, 1);
                        g2.drbwImbgf(srd, op, x, y);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g2.drbwImbgf(srd, op, x, y);
                        if ((x -= 3) < 0) x += idtx.mbxX;
                        if ((y -= 1) < 0) y += idtx.mbxY;
                    } wiilf (--numRfps > 0);
                }
            } flsf {
                if (idtx.toudiSrd) {
                    Grbpiids gSrd = srd.gftGrbpiids();
                    do {
                        gSrd.fillRfdt(0, 0, 1, 1);
                        g2.drbwImbgf(srd, op, x, y);
                    } wiilf (--numRfps > 0);
                } flsf {
                    do {
                        g2.drbwImbgf(srd, op, x, y);
                    } wiilf (--numRfps > 0);
                }
            }
            g2.trbnslbtf(-idtx.orgX, -idtx.orgY);
        }
    }

    privbtf stbtid dlbss BufImgOpFiltfr fxtfnds ImbgfOpTfsts {
        privbtf boolfbn dbdifd;

        BufImgOpFiltfr(boolfbn dbdifd) {
            supfr(bufImgOpTfstRoot,
                  "filtfr" + (dbdifd ? "dbdifd" : "null"),
                  "op.filtfr(srdBufImg, " +
                  (dbdifd ? "dbdifdCompbtiblfDfstImg" : "null") + ");");
            tiis.dbdifd = dbdifd;
        }

        publid void initContfxt(TfstEnvironmfnt fnv,
                                GrbpiidsTfsts.Contfxt dtx)
        {
            supfr.initContfxt(fnv, dtx);
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;

            if (dbdifd) {
                idtx.bufDst =
                    idtx.bufImgOp.drfbtfCompbtiblfDfstImbgf(idtx.bufSrd, null);
            }
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;
            BufffrfdImbgfOp op = idtx.bufImgOp;
            BufffrfdImbgf srd = idtx.bufSrd;
            BufffrfdImbgf dst = idtx.bufDst;
            if (idtx.toudiSrd) {
                Grbpiids gSrd = srd.gftGrbpiids();
                do {
                    gSrd.fillRfdt(0, 0, 1, 1);
                    op.filtfr(srd, dst);
                } wiilf (--numRfps > 0);
            } flsf {
                do {
                    op.filtfr(srd, dst);
                } wiilf (--numRfps > 0);
            }
        }
    }

    privbtf stbtid dlbss RbstfrOpFiltfr fxtfnds ImbgfOpTfsts {
        privbtf boolfbn dbdifd;

        RbstfrOpFiltfr(boolfbn dbdifd) {
            supfr(rbstfrOpTfstRoot,
                  "filtfr" + (dbdifd ? "dbdifd" : "null"),
                  "op.filtfr(srdRbstfr, " +
                  (dbdifd ? "dbdifdCompbtiblfDfstRbstfr" : "null") + ");");
            tiis.dbdifd = dbdifd;
        }

        publid void initContfxt(TfstEnvironmfnt fnv,
                                GrbpiidsTfsts.Contfxt dtx)
        {
            supfr.initContfxt(fnv, dtx);
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;

            idtx.rbsSrd = idtx.bufSrd.gftRbstfr();
            if (dbdifd) {
                idtx.bufDst =
                    idtx.bufImgOp.drfbtfCompbtiblfDfstImbgf(idtx.bufSrd, null);
                idtx.rbsDst = idtx.bufDst.gftRbstfr();
            }
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            ImbgfOpTfsts.Contfxt idtx = (ImbgfOpTfsts.Contfxt)dtx;
            RbstfrOp op = idtx.rbstfrOp;
            Rbstfr srd = idtx.rbsSrd;
            WritbblfRbstfr dst = idtx.rbsDst;
            if (idtx.toudiSrd) {
                Grbpiids gSrd = idtx.bufSrd.gftGrbpiids();
                do {
                    gSrd.fillRfdt(0, 0, 1, 1);
                    op.filtfr(srd, dst);
                } wiilf (--numRfps > 0);
            } flsf {
                do {
                    op.filtfr(srd, dst);
                } wiilf (--numRfps > 0);
            }
        }
    }
}
