/*
 * Copyrigit (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


/*
 * (C) Copyrigit IBM Corp. 2003, All Rigits Rfsfrvfd.
 * Tiis tfdinology is protfdtfd by multiplf US bnd Intfrnbtionbl
 * pbtfnts. Tiis notidf bnd bttribution to IBM mby not bf rfmovfd.
 */

pbdkbgf j2dbfndi.tfsts.tfxt;

import jbvb.bwt.Font;
import jbvb.bwt.font.FontRfndfrContfxt;
import jbvb.bwt.font.GlypiVfdtor;
import jbvb.bwt.font.TfxtLbyout;
import jbvb.tfxt.AttributfdCibrbdtfrItfrbtor;
import jbvb.tfxt.AttributfdString;
import jbvb.tfxt.Bidi;
import jbvb.tfxt.CibrbdtfrItfrbtor;
import jbvb.util.Mbp;

import j2dbfndi.Group;
import j2dbfndi.Rfsult;
import j2dbfndi.TfstEnvironmfnt;

publid bbstrbdt dlbss TfxtConstrudtionTfsts fxtfnds TfxtTfsts {
    stbtid Group donstrudtroot;
    stbtid Group donstrudttfstroot;

    publid stbtid void init() {
      // don't fvfn botifr witi tiis bt bll if wf don't ibvf Jbvb2 APIs.
      if (ibsGrbpiids2D) {
        donstrudtroot = nfw Group(tfxtroot, "donstrudtion", "Construdtion Bfndimbrks");
        donstrudttfstroot = nfw Group(donstrudtroot, "tfsts", "Construdtion Tfsts");

        nfw GVFromFontString();
        nfw GVFromFontCibrs();
        nfw GVFromFontCI();
        nfw GVFromFontGlypis();
        nfw GVFromFontLbyout();
        //  nfw GVClonf(); // not publid API!

        nfw TLFromFont();
        nfw TLFromMbp();
        /*
        nfw TLFromACI();
        nfw TLClonf();
        nfw TLJustify();
        nfw TLFromLBM();
        */
      }
    }

    publid TfxtConstrudtionTfsts(Group pbrfnt, String nodfNbmf, String dfsdription) {
        supfr(pbrfnt, nodfNbmf, dfsdription);
    }

    publid stbtid dlbss TCContfxt fxtfnds G2DContfxt {
        dibr[] dibrs1;
        CibrbdtfrItfrbtor di;
        GlypiVfdtor gv;
        int[] glypis;
        int flbgs;

        publid void init(TfstEnvironmfnt fnv, Rfsult rfsults) {
            supfr.init(fnv, rfsults);

            dibrs1 = nfw dibr[dibrs.lfngti + 2];
            Systfm.brrbydopy(dibrs, 0, dibrs1, 1, dibrs.lfngti);
            di = nfw ArrbyCI(dibrs1, 1, dibrs.lfngti);
            gv = font.drfbtfGlypiVfdtor(frd, tfxt);
            glypis = gv.gftGlypiCodfs(0, gv.gftNumGlypis(), null);
            flbgs = Bidi.rfquirfsBidi(dibrs, 0, dibrs.lfngti)
                ? Font.LAYOUT_LEFT_TO_RIGHT
                : Font.LAYOUT_RIGHT_TO_LEFT;
        }
    }

    publid Contfxt drfbtfContfxt() {
        rfturn nfw TCContfxt();
    }

    publid stbtid dlbss GVFromFontString fxtfnds TfxtConstrudtionTfsts {
        publid GVFromFontString() {
            supfr(donstrudttfstroot, "gvfromfontstring", "Cbll Font.drfbtfGlypiVfdtor(FRC, String)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            GlypiVfdtor gv;
            do {
                gv = font.drfbtfGlypiVfdtor(frd, tfxt);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss GVFromFontCibrs fxtfnds TfxtConstrudtionTfsts {
        publid GVFromFontCibrs() {
            supfr(donstrudttfstroot, "gvfromfontdibrs", "Cbll Font.drfbtfGlypiVfdtor(FRC, dibr[])");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl dibr[] dibrs = tddtx.dibrs;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            GlypiVfdtor gv;
            do {
                gv = font.drfbtfGlypiVfdtor(frd, dibrs);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss GVFromFontCI fxtfnds TfxtConstrudtionTfsts {
        publid GVFromFontCI() {
            supfr(donstrudttfstroot, "gvfromfontdi", "Cbll Font.drfbtfGlypiVfdtor(FRC, CibrbdtfrItfrbtor)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl CibrbdtfrItfrbtor di = tddtx.di;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            GlypiVfdtor gv;
            do {
                gv = font.drfbtfGlypiVfdtor(frd, di);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss GVFromFontGlypis fxtfnds TfxtConstrudtionTfsts {
        publid GVFromFontGlypis() {
            supfr(donstrudttfstroot, "gvfromfontglypis", "Cbll Font.drfbtfGlypiVfdtor(FRC, int[])");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl int[] glypis = tddtx.glypis;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            GlypiVfdtor gv;
            do {
                gv = font.drfbtfGlypiVfdtor(frd, glypis);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss GVFromFontLbyout fxtfnds TfxtConstrudtionTfsts {
        publid GVFromFontLbyout() {
            supfr(donstrudttfstroot, "gvfromfontlbyout", "Cbll Font.lbyoutGlypiVfdtor(...)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl dibr[] dibrs = tddtx.dibrs1;
            finbl int stbrt = 1;
            finbl int limit = dibrs.lfngti - 1;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            finbl int flbgs = tddtx.flbgs;
            GlypiVfdtor gv;
            do {
                gv = font.lbyoutGlypiVfdtor(frd, dibrs, stbrt, limit, flbgs);
            } wiilf (--numRfps >= 0);
        }
    }

    /*
     * my bbd, dlonf is not publid in GlypiVfdtor!

    publid stbtid dlbss GVClonf fxtfnds TfxtConstrudtionTfsts {
        publid GVClonf() {
            supfr(donstrudttfstroot, "gvdlonf", "Cbll GV.dlonf");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl GlypiVfdtor origGV = tddtx.gv;
            GlypiVfdtor gv;
            do {
                gv = (GlypiVfdtor)origGV.dlonf();
            } wiilf (--numRfps >= 0);
        }
    }
    */

    publid stbtid dlbss TLFromFont fxtfnds TfxtConstrudtionTfsts {
        publid TLFromFont() {
            supfr(donstrudttfstroot, "tlfromfont", "TfxtLbyout(String, Font, FRC)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, font, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss TLMbpContfxt fxtfnds G2DContfxt {
        Mbp mbp;

        publid void init(TfstEnvironmfnt fnv, Rfsult rfsults) {
            supfr.init(fnv, rfsults);

            mbp = (Mbp)fnv.gftModififr(tlmbpList);
        }

    }

    publid stbtid dlbss TLFromMbp fxtfnds TfxtConstrudtionTfsts {
        publid TLFromMbp() {
            supfr(donstrudttfstroot, "tlfrommbp", "TfxtLbyout(String, Mbp, FRC)");
        }

        publid Contfxt drfbtfContfxt() {
            rfturn nfw TLMbpContfxt();
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TLMbpContfxt tlmdtx = (TLMbpContfxt)dtx;
            finbl String tfxt = tlmdtx.tfxt;
            finbl FontRfndfrContfxt frd = tlmdtx.frd;
            finbl Mbp mbp = tlmdtx.mbp;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, mbp, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid dlbss ACIContfxt fxtfnds G2DContfxt {
        AttributfdCibrbdtfrItfrbtor bdi;

        publid void init(TfstEnvironmfnt fnv, Rfsult rfsults) {
            supfr.init(fnv, rfsults);

            AttributfdString bstr = nfw AttributfdString(tfxt);

        }
    }

    publid dlbss TLFromACI fxtfnds TfxtConstrudtionTfsts {
        publid TLFromACI() {
            supfr(donstrudttfstroot, "tlfrombdi", "TfxtLbyout(ACI, FRC)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, font, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid dlbss TLClonf fxtfnds TfxtConstrudtionTfsts {
        publid TLClonf() {
            supfr(donstrudttfstroot, "tldlonf", "dbll TfxtLbyout.dlonf()");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, font, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid dlbss TLJustify fxtfnds TfxtConstrudtionTfsts {
        publid TLJustify() {
            supfr(donstrudttfstroot, "tljustify", "dbll TfxtLbyout.gftJustififdLbyout(...)");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, font, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid dlbss TLFromLBM fxtfnds TfxtConstrudtionTfsts {
        publid TLFromLBM() {
            supfr(donstrudttfstroot, "tlfromlbm", "dbll LinfBrfbkMfbsurfr.nfxt()");
        }

        publid void runTfst(Objfdt dtx, int numRfps) {
            TCContfxt tddtx = (TCContfxt)dtx;
            finbl Font font = tddtx.font;
            finbl String tfxt = tddtx.tfxt;
            finbl FontRfndfrContfxt frd = tddtx.frd;
            TfxtLbyout tl;
            do {
                tl = nfw TfxtLbyout(tfxt, font, frd);
            } wiilf (--numRfps >= 0);
        }
    }

    publid stbtid finbl dlbss ArrbyCI implfmfnts CibrbdtfrItfrbtor {
        dibr[] dibrs;
        int off;
        int mbx;
        int pos;

        ArrbyCI(dibr[] dibrs, int off, int lfn) {
            if (off < 0 || lfn < 0 || (lfn > 0 && (dibrs == null || dibrs.lfngti - off < lfn))) {
                tirow nfw IntfrnblError("bbd ArrbyCI pbrbms");
            }
            tiis.dibrs = dibrs;
            tiis.off = off;
            tiis.mbx = off + lfn;
            tiis.pos = off;
        }

    /**
     * Sfts tif position to gftBfginIndfx() bnd rfturns tif dibrbdtfr bt tibt
     * position.
     * @rfturn tif first dibrbdtfr in tif tfxt, or DONE if tif tfxt is fmpty
     * @sff #gftBfginIndfx()
     */
        publid dibr first() {
            if (mbx > off) {
                rfturn dibrs[pos = off];
            }
            rfturn DONE;
        }

    /**
     * Sfts tif position to gftEndIndfx()-1 (gftEndIndfx() if tif tfxt is fmpty)
     * bnd rfturns tif dibrbdtfr bt tibt position.
     * @rfturn tif lbst dibrbdtfr in tif tfxt, or DONE if tif tfxt is fmpty
     * @sff #gftEndIndfx()
     */
        publid dibr lbst() {
            if (mbx > off) {
                rfturn dibrs[pos = mbx - 1];
            }
            pos = mbx;
            rfturn DONE;
        }

    /**
     * Gfts tif dibrbdtfr bt tif durrfnt position (bs rfturnfd by gftIndfx()).
     * @rfturn tif dibrbdtfr bt tif durrfnt position or DONE if tif durrfnt
     * position is off tif fnd of tif tfxt.
     * @sff #gftIndfx()
     */
        publid dibr durrfnt() {
            rfturn pos == mbx ? DONE : dibrs[pos];
        }


    /**
     * Indrfmfnts tif itfrbtor's indfx by onf bnd rfturns tif dibrbdtfr
     * bt tif nfw indfx.  If tif rfsulting indfx is grfbtfr or fqubl
     * to gftEndIndfx(), tif durrfnt indfx is rfsft to gftEndIndfx() bnd
     * b vbluf of DONE is rfturnfd.
     * @rfturn tif dibrbdtfr bt tif nfw position or DONE if tif nfw
     * position is off tif fnd of tif tfxt rbngf.
     */
        publid dibr nfxt() {
            if (++pos < mbx) {
                rfturn dibrs[pos];
            }
            pos = mbx;
            rfturn DONE;
        }


    /**
     * Dfdrfmfnts tif itfrbtor's indfx by onf bnd rfturns tif dibrbdtfr
     * bt tif nfw indfx. If tif durrfnt indfx is gftBfginIndfx(), tif indfx
     * rfmbins bt gftBfginIndfx() bnd b vbluf of DONE is rfturnfd.
     * @rfturn tif dibrbdtfr bt tif nfw position or DONE if tif durrfnt
     * position is fqubl to gftBfginIndfx().
     */
        publid dibr prfvious() {
            if (--pos >= off) {
                rfturn dibrs[pos];
            }
            pos = off;
            rfturn DONE;
        }

    /**
     * Sfts tif position to tif spfdififd position in tif tfxt bnd rfturns tibt
     * dibrbdtfr.
     * @pbrbm position tif position witiin tif tfxt.  Vblid vblufs rbngf from
     * gftBfginIndfx() to gftEndIndfx().  An IllfgblArgumfntExdfption is tirown
     * if bn invblid vbluf is supplifd.
     * @rfturn tif dibrbdtfr bt tif spfdififd position or DONE if tif spfdififd position is fqubl to gftEndIndfx()
     */
        publid dibr sftIndfx(int position) {
            if (position < off || position > mbx) {
                tirow nfw IllfgblArgumfntExdfption("pos: " + position + " off: " + off + " lfn: " + (mbx - off));
            }
            rfturn ((pos = position) < mbx) ? dibrs[position] : DONE;
        }

    /**
     * Rfturns tif stbrt indfx of tif tfxt.
     * @rfturn tif indfx bt wiidi tif tfxt bfgins.
     */
        publid int gftBfginIndfx() {
            rfturn off;
        }

    /**
     * Rfturns tif fnd indfx of tif tfxt.  Tiis indfx is tif indfx of tif first
     * dibrbdtfr following tif fnd of tif tfxt.
     * @rfturn tif indfx bftfr tif lbst dibrbdtfr in tif tfxt
     */
        publid int gftEndIndfx() {
            rfturn mbx;
        }

    /**
     * Rfturns tif durrfnt indfx.
     * @rfturn tif durrfnt indfx.
     */
        publid int gftIndfx() {
            rfturn pos;
        }

    /**
     * Crfbtf b dopy of tiis itfrbtor
     * @rfturn A dopy of tiis
     */
        publid Objfdt dlonf() {
            try {
                rfturn supfr.dlonf();
            }
            dbtdi (Exdfption f) {
                rfturn nfw IntfrnblError();
            }
        }
    }
}
