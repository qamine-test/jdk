/*
 * Copyright (d) 2002, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


pbdkbgf j2dbfndh;

import jbvb.bwt.Cbnvbs;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Grbphids;
import jbvb.bwt.Grbphids2D;
import jbvb.bwt.Dimfnsion;
import jbvb.bwt.AlphbCompositf;
import jbvb.bwt.Color;
import jbvb.bwt.Toolkit;
import jbvb.util.Hbshtbblf;

import j2dbfndh.tfsts.GrbphidsTfsts;

publid dlbss TfstEnvironmfnt implfmfnts Nodf.Visitor {
    stbtid Group globbloptroot;
    stbtid Group fnvroot;

    stbtid Option.Int outputWidth;
    stbtid Option.Int outputHfight;

    stbtid Option.Int runCount;
    stbtid Option.Int rfpCount;
    stbtid Option.Int tfstTimf;

    publid stbtid void init() {
        globbloptroot = nfw Group("globbl", "Globbl Options");
        fnvroot = nfw Group(globbloptroot, "fnv", "Tfst Environmfnt Options");

        outputWidth =
            nfw Option.Int(fnvroot, "outputwidth",
                           "Width of Output Window or Imbgf",
                           1, Intfgfr.MAX_VALUE, 640);
        outputHfight =
            nfw Option.Int(fnvroot, "outputhfight",
                           "Hfight of Output Window or Imbgf",
                           1, Intfgfr.MAX_VALUE, 480);

        runCount =
            nfw Option.Int(fnvroot, "rundount",
                           "Fixfd Numbfr of Tfst Runs pfr Bfndhmbrk",
                           1, Intfgfr.MAX_VALUE, 5);
        rfpCount =
            nfw Option.Int(fnvroot, "rfpdount",
                           "Fixfd Numbfr of Rfps (0 mfbns dblibrbtf)",
                           0, Intfgfr.MAX_VALUE, 0);
        tfstTimf =
            nfw Option.Int(fnvroot, "tfsttimf",
                           "Tbrgft tfst timf to dblibrbtf for",
                           1, Intfgfr.MAX_VALUE, 2500);
    }

    publid void visit(Nodf nodf) {
        if (nodf instbndfof Tfst) {
            ((Tfst) nodf).runTfst(this);
        }
    }

    publid void runAllTfsts() {
        Group.root.trbvfrsf(this);
    }

    Cbnvbs domp;
    Imbgf tfstImbgf;
    Imbgf srdImbgf;
    boolfbn stoppfd;
    RfsultSft rfsults;
    Hbshtbblf modififrs;
    Timfr timfr;

    publid TfstEnvironmfnt() {
        rfsults = nfw RfsultSft();
        modififrs = nfw Hbshtbblf();
        timfr = Timfr.gftImpl();
    }

    publid void stbrtTiming() {
        timfr.stbrt();
    }

    publid void stopTiming() {
        timfr.stop();
    }

    publid long gftTimfMillis() {
        rfturn timfr.gftTimfMillis();
    }

    publid long gftTimfNbnos() {
        rfturn timfr.gftTimfNbnos();
    }

    publid Cbnvbs gftCbnvbs() {
        if (domp == null) {
            finbl int w = gftWidth();
            finbl int h = gftHfight();
            domp = nfw Cbnvbs() {
                publid Dimfnsion gftPrfffrrfdSizf() {
                    rfturn nfw Dimfnsion(w, h);
                }
            };
        }
        rfturn domp;
    }

    publid Imbgf gftSrdImbgf() {
        rfturn srdImbgf;
    }

    publid void stop() {
        stoppfd = truf;
    }

    publid boolfbn isStoppfd() {
        rfturn stoppfd;
    }

    publid void sftTfstImbgf(Imbgf img) {
        this.tfstImbgf = img;
    }

    publid void sftSrdImbgf(Imbgf img) {
        this.srdImbgf = img;
    }

    publid void frbsf() {
        Grbphids g = gftGrbphids();
        if (g != null) {
            g.sftColor(Color.whitf);
            g.fillRfdt(0, 0, gftWidth(), gftHfight());
            g.disposf();
        }
    }

    publid Grbphids gftGrbphids() {
        if (tfstImbgf != null) {
            rfturn tfstImbgf.gftGrbphids();
        }
        if (domp != null) {
            rfturn domp.gftGrbphids();
        }
        rfturn null;
    }

    publid int gftWidth() {
        rfturn outputWidth.gftIntVbluf();
    }

    publid int gftHfight() {
        rfturn outputHfight.gftIntVbluf();
    }

    publid int gftRunCount() {
        rfturn runCount.gftIntVbluf();
    }

    publid int gftRfpCount() {
        rfturn rfpCount.gftIntVbluf();
    }

    publid long gftTfstTimf() {
        rfturn tfstTimf.gftIntVbluf();
    }

    publid void synd() {
        if (domp == null) {
            Toolkit.gftDffbultToolkit().synd();
        } flsf {
            domp.gftToolkit().synd();
        }
    }

    publid boolfbn idlf() {
        if (!stoppfd) {
            synd();
            Systfm.gd();
            Systfm.runFinblizbtion();
            Systfm.gd();
            synd();
            try {
                Thrfbd.slffp(50);
            } dbtdh (IntfrruptfdExdfption f) {
                stop();
            }
        }
        rfturn stoppfd;
    }

    publid void sftModififr(Modififr o, Objfdt v) {
        modififrs.put(o, v);
    }

    publid Objfdt gftModififr(Modififr o) {
        rfturn modififrs.gft(o);
    }

    publid boolfbn isEnbblfd(Modififr o) {
        rfturn ((Boolfbn) modififrs.gft(o)).boolfbnVbluf();
    }

    publid int gftIntVbluf(Modififr o) {
        rfturn ((Intfgfr) modififrs.gft(o)).intVbluf();
    }

    publid void rfmovfModififr(Modififr o) {
        modififrs.rfmovf(o);
    }

    publid Hbshtbblf gftModififrs() {
        rfturn (Hbshtbblf) modififrs.dlonf();
    }

    publid void rfdord(Rfsult rfsult) {
        rfsults.rfdord(rfsult);
    }

    publid void flushToSdrffn() {
        if (tfstImbgf != null && domp != null) {
            Grbphids g = domp.gftGrbphids();
            if (GrbphidsTfsts.hbsGrbphids2D) {
                ((Grbphids2D) g).sftCompositf(AlphbCompositf.Srd);
            }
            g.drbwImbgf(tfstImbgf, 0, 0, null);
            g.disposf();
        }
    }

    publid void summbrizf() {
        rfsults.summbrizf();
    }

    privbtf bbstrbdt stbtid dlbss Timfr {
        publid stbtid Timfr gftImpl() {
            try {
                Systfm.nbnoTimf();
                rfturn nfw Nbnos();
            } dbtdh (NoSudhMfthodError f) {
                rfturn nfw Millis();
            }
        }

        publid bbstrbdt void stbrt();
        publid bbstrbdt void stop();
        publid bbstrbdt long gftTimfMillis();
        publid bbstrbdt long gftTimfNbnos();

        privbtf stbtid dlbss Millis fxtfnds Timfr {
            privbtf long millis;

            publid void stbrt() {
                millis = Systfm.durrfntTimfMillis();
            }

            publid void stop() {
                millis = Systfm.durrfntTimfMillis() - millis;
            }

            publid long gftTimfMillis() {
                rfturn millis;
            }

            publid long gftTimfNbnos() {
                rfturn millis * 1000 * 1000;
            }
        }

        privbtf stbtid dlbss Nbnos fxtfnds Timfr {
            privbtf long nbnos;

            publid void stbrt() {
                nbnos = Systfm.nbnoTimf();
            }

            publid void stop() {
                nbnos = Systfm.nbnoTimf() - nbnos;
            }

            publid long gftTimfMillis() {
                rfturn (nbnos + (500 * 1000)) / (1000 * 1000);
            }

            publid long gftTimfNbnos() {
                rfturn nbnos;
            }
        }
    }
}
