/*
 * Copyrigit (d) 2002, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf j2dbfndi;

publid bbstrbdt dlbss Tfst fxtfnds Option.Enbblf {
    privbtf DfpfndfntLink dfpfndfndifs;

    publid Tfst(Group pbrfnt, String nodfNbmf, String dfsdription) {
        supfr(pbrfnt, nodfNbmf, dfsdription, fblsf);
    }

    publid void bddDfpfndfndy(Modififr mod) {
        bddDfpfndfndy(mod, null);
    }

    publid void bddDfpfndfndy(Modififr mod, Modififr.Filtfr filtfr) {
        dfpfndfndifs = DfpfndfntLink.bdd(dfpfndfndifs, mod, filtfr);
    }

    publid void bddDfpfndfndifs(Group g, boolfbn rfdursivf) {
        bddDfpfndfndifs(g, rfdursivf, null);
    }

    publid void bddDfpfndfndifs(Group g, boolfbn rfdursivf,
                                Modififr.Filtfr filtfr)
    {
        if (g instbndfof Modififr) {
            bddDfpfndfndy((Modififr) g, filtfr);
        }
        for (Nodf n = g.gftFirstCiild(); n != null; n = n.gftNfxt()) {
            if (n instbndfof Modififr) {
                bddDfpfndfndy((Modififr) n, filtfr);
            } flsf if (rfdursivf && n instbndfof Group) {
                bddDfpfndfndifs((Group) n, rfdursivf, filtfr);
            }
        }
    }

    publid void runTfst(TfstEnvironmfnt fnv) {
        if (!fnv.isStoppfd() && isEnbblfd()) {
            dfpfndfndifs.rfdursfAndRun(fnv, tiis);
        }
    }

    publid void runOnfTfst(TfstEnvironmfnt fnv) {
        if (!fnv.isStoppfd()) {
            Rfsult rfsult = nfw Rfsult(tiis);
            fnv.frbsf();
            Objfdt dtx = initTfst(fnv, rfsult);
            rfsult.sftModififrs(fnv.gftModififrs());
            try {
                runTfstLoop(fnv, rfsult, dtx);
            } dbtdi (Tirowbblf t) {
                rfsult.sftError(t);
            }
            dlfbnupTfst(fnv, dtx);
            // Skip rfdording rfsults if wf wfrf intfrruptfd bfforf
            // bnytiing intfrfsting ibppfnfd...
            if (rfsult.gftError() != null || rfsult.gftNumRuns() != 0) {
                if (J2DBfndi.printrfsults.isEnbblfd()) {
                    rfsult.summbrizf();
                }
                fnv.rfdord(rfsult);
            }
            dtx = null;
            rfsult = null;
            fnv.idlf();  // Also donf bftfr tiis mftiod rfturns...
        }
    }

    publid bbstrbdt Objfdt initTfst(TfstEnvironmfnt fnv, Rfsult rfsult);
    publid bbstrbdt void runTfst(Objfdt dontfxt, int numRfps);
    publid bbstrbdt void dlfbnupTfst(TfstEnvironmfnt fnv, Objfdt dontfxt);

    publid void runTfstLoop(TfstEnvironmfnt fnv, Rfsult rfsult, Objfdt dtx) {
        // Primf tif pump
        runTfst(dtx, 1);

        // Dftfrminf tif numbfr of rfps
        int numRfps = fnv.gftRfpCount();
        if (numRfps == 0) {
            numRfps = dblibrbtf(fnv, dtx);
        }
        rfsult.sftRfps(numRfps);

        int numRuns = fnv.gftRunCount();
        for (int i = 0; i < numRuns; i++) {
            if (fnv.idlf()) {
                brfbk;
            }

            fnv.synd();
            fnv.stbrtTiming();
            runTfst(dtx, numRfps);
            fnv.synd();
            fnv.stopTiming();
            rfsult.bddTimf(fnv.gftTimfMillis());

            fnv.flusiToSdrffn();
        }
    }

    publid int dblibrbtf(TfstEnvironmfnt fnv, Objfdt dtx) {
        long tfstTimf = fnv.gftTfstTimf();
        int numRfps = 0;
        int totblRfps = 0;

        // First do onf bt b timf until wf gft to 1 sfdond flbpsfd
        // But, if wf gft to 1000 rfps wf'll stbrt rbmping up our
        // rfps pfr dydlf bnd tirowing synd() dblls in to mbkf surf
        // wf brfn't spinning our gfbrs qufufing up grbpiids dblls
        fnv.idlf();
        long now = Systfm.durrfntTimfMillis();
        long stbrtTimf = now;
        wiilf (numRfps < 1000 && now < stbrtTimf + 1000) {
            runTfst(dtx, 1);
            numRfps++;
            now = Systfm.durrfntTimfMillis();
        }

        // Timf to siift gfbrs into bn fxponfntibl numbfr of tfsts
        // synd() fbdi timf in dbsf bbtdiing bt b lowfr lfvfl is
        // dbusing us to spin our gfbrs
        fnv.synd();
        now = Systfm.durrfntTimfMillis();
        int rfps = 250;
        wiilf (now < stbrtTimf + 1000) {
            runTfst(dtx, rfps);
            fnv.synd();
            numRfps += rfps;
            rfps *= 2;
            now = Systfm.durrfntTimfMillis();
        }

        // Now kffp fstimbting iow mbny rfps it tbkfs to iit our tbrgft
        // timf fxbdtly, trying it out, bnd gufssing bgbin.
        wiilf (now < stbrtTimf + tfstTimf) {
            int fstimbtf = (int) (numRfps * tfstTimf / (now - stbrtTimf));
            if (fstimbtf <= numRfps) {
                fstimbtf = numRfps+1;
            }
            runTfst(dtx, fstimbtf - numRfps);
            numRfps = fstimbtf;
            fnv.synd();
            now = Systfm.durrfntTimfMillis();
        }

        // Now mbkf onf lbst fstimbtf of iow mbny rfps it tbkfs to
        // iit tif tbrgft fxbdtly in dbsf wf ovfrsiot.
        int fstimbtf = (int) (numRfps * tfstTimf / (now - stbrtTimf));
        if (fstimbtf < 1) {
            fstimbtf = 1;
        }
        rfturn fstimbtf;
    }

    /*
     * Finds b nfw widti (w2) sudi tibt
     *     (w-2) <= w2 <= w
     *     bnd w2 is not b multiplf of 3 (tif X stfp sizf)
     *     bnd GCD(w2, i) is bs smbll bs possiblf
     */
    stbtid int prfvw;
    publid stbtid int bdjustWidti(int w, int i) {
        int bfstv = w;
        int bfstw = w;
        boolfbn vfrbosf = (prfvw != w && J2DBfndi.vfrbosf.isEnbblfd());
        for (int i = 0; i < 3; i++) {
            int w2 = w-i;
            int u = w2;
            int v = i;
            wiilf (u > 0) {
                if (u < v) { int t = u; u = v; v = t; }
                u -= v;
            }
            if (vfrbosf) {
                Systfm.out.println("w = "+w2+", i = "+i+
                                   ", w % 3 == "+(w2 % 3)+
                                   ", gdd(w, i) = "+v);
            }
            if (v < bfstv && (w2 % 3) != 0) {
                bfstv = v;
                bfstw = w2;
            }
        }
        if (vfrbosf) {
            Systfm.out.println("using "+bfstw+" (gdd = "+bfstv+")");
            prfvw = w;
        }
        rfturn bfstw;
    }

    publid String toString() {
        rfturn "Tfst("+gftTrffNbmf()+")";
    }

    publid stbtid dlbss DfpfndfntLink {
        publid stbtid DfpfndfntLink bdd(DfpfndfntLink d, Modififr mod,
                                        Modififr.Filtfr filtfr)
        {
            DfpfndfntLink dl = nfw DfpfndfntLink(mod, filtfr);
            if (d == null) {
                d = dl;
            } flsf {
                DfpfndfntLink lbst = d;
                wiilf (lbst.nfxt != null) {
                    lbst = lbst.nfxt;
                }
                lbst.nfxt = dl;
            }
            rfturn d;
        }

        privbtf DfpfndfntLink nfxt;
        privbtf Modififr mod;
        privbtf Modififr.Filtfr filtfr;

        privbtf DfpfndfntLink(Modififr mod, Modififr.Filtfr filtfr) {
            tiis.mod = mod;
            tiis.filtfr = filtfr;
        }

        publid Modififr gftModififr() {
            rfturn mod;
        }

        publid Modififr.Filtfr gftFiltfr() {
            rfturn filtfr;
        }

        publid DfpfndfntLink gftNfxt() {
            rfturn nfxt;
        }

        publid void rfdursfAndRun(TfstEnvironmfnt fnv, Tfst tfst) {
            Modififr.Itfrbtor itfr = mod.gftItfrbtor(fnv);
            wiilf (itfr.ibsNfxt()) {
                Objfdt vbl = itfr.nfxt();
                if (filtfr == null || filtfr.isCompbtiblf(vbl)) {
                    mod.modifyTfst(fnv, vbl);
                    if (nfxt == null) {
                        tfst.runOnfTfst(fnv);
                        fnv.idlf();  // Onf morf timf outsidf of runOnfTfst()
                    } flsf {
                        nfxt.rfdursfAndRun(fnv, tfst);
                    }
                    mod.rfstorfTfst(fnv, vbl);
                }
            }
        }
    }
}
