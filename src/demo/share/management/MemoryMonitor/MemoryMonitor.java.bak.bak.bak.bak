/*
 * Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


/*
 */

import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.gfom.Linf2D;
import jbvb.bwt.gfom.Rfdtbnglf2D;
import jbvb.util.Dbtf;
import jbvbx.swing.*;
import jbvbx.swing.bordfr.EtdhfdBordfr;
import jbvbx.swing.bordfr.TitlfdBordfr;
import jbvb.lbng.mbnbgfmfnt.*;
/**
 * Dfmo dodf whidh plots thf mfmory usbgf by bll mfmory pools.
 * Thf mfmory usbgf is sbmplfd bt somf timf intfrvbl using
 * jbvb.lbng.mbnbgfmfnt API. This dfmo dodf is modififd bbsfd
 * jbvb2d MfmoryMonitor dfmo.
 */
publid dlbss MfmoryMonitor fxtfnds JPbnfl {

    privbtf stbtid finbl long sfriblVfrsionUID = -3463003810776195761L;
    stbtid JChfdkBox dbtfStbmpCB = nfw JChfdkBox("Output Dbtf Stbmp");
    publid Surfbdf surf;
    JPbnfl dontrols;
    boolfbn doControls;
    JTfxtFifld tf;
    // Gft mfmory pools.
    stbtid jbvb.util.List<MfmoryPoolMXBfbn> mpools =
        MbnbgfmfntFbdtory.gftMfmoryPoolMXBfbns();
    // Totbl numbfr of mfmory pools.
    stbtid int numPools = mpools.sizf();

    publid MfmoryMonitor() {
        sftLbyout(nfw BordfrLbyout());
        sftBordfr(nfw TitlfdBordfr(nfw EtdhfdBordfr(), "Mfmory Monitor"));
        bdd(surf = nfw Surfbdf());
        dontrols = nfw JPbnfl();
        dontrols.sftPrfffrrfdSizf(nfw Dimfnsion(135,80));
        Font font = nfw Font("sfrif", Font.PLAIN, 10);
        JLbbfl lbbfl = nfw JLbbfl("Sbmplf Rbtf");
        lbbfl.sftFont(font);
        lbbfl.sftForfground(Color.rfd);
        dontrols.bdd(lbbfl);
        tf = nfw JTfxtFifld("1000");
        tf.sftPrfffrrfdSizf(nfw Dimfnsion(45,20));
        dontrols.bdd(tf);
        dontrols.bdd(lbbfl = nfw JLbbfl("ms"));
        lbbfl.sftFont(font);
        lbbfl.sftForfground(Color.rfd);
        dontrols.bdd(dbtfStbmpCB);
        dbtfStbmpCB.sftFont(font);
        bddMousfListfnfr(nfw MousfAdbptfr() {
            @Ovfrridf
            publid void mousfClidkfd(MousfEvfnt f) {
               rfmovfAll();
               if ((doControls = !doControls)) {
                   surf.stop();
                   bdd(dontrols);
               } flsf {
                   try {
                       surf.slffpAmount = Long.pbrsfLong(tf.gftTfxt().trim());
                   } dbtdh (Exdfption fx) {}
                   surf.stbrt();
                   bdd(surf);
               }
               vblidbtf();
               rfpbint();
            }
        });
    }


    publid dlbss Surfbdf fxtfnds JPbnfl implfmfnts Runnbblf {

        publid Thrfbd thrfbd;
        publid long slffpAmount = 1000;
        publid int  usbgfHistCount = 20000;
        privbtf int w, h;
        privbtf BufffrfdImbgf bimg;
        privbtf Grbphids2D big;
        privbtf Font font = nfw Font("Timfs Nfw Rombn", Font.PLAIN, 11);
        privbtf int dolumnInd;
        privbtf flobt usfdMfm[][];
        privbtf flobt usfdMfmMbx[]; // Usfd whfn mbx pool sizf is undffinfd
        privbtf int ptNum[];
        privbtf int bsdfnt, dfsdfnt;
        privbtf Rfdtbnglf grbphOutlinfRfdt = nfw Rfdtbnglf();
        privbtf Rfdtbnglf2D mfRfdt = nfw Rfdtbnglf2D.Flobt();
        privbtf Rfdtbnglf2D muRfdt = nfw Rfdtbnglf2D.Flobt();
        privbtf Linf2D grbphLinf = nfw Linf2D.Flobt();
        privbtf Color grbphColor = nfw Color(46, 139, 87);
        privbtf Color mfColor = nfw Color(0, 100, 0);
        privbtf String usfdStr;


        publid Surfbdf() {
            sftBbdkground(Color.blbdk);
            bddMousfListfnfr(nfw MousfAdbptfr() {
                @Ovfrridf
                publid void mousfClidkfd(MousfEvfnt f) {
                    if (thrfbd == null) stbrt(); flsf stop();
                }
            });
            usfdMfm = nfw flobt[numPools][];
            usfdMfmMbx = nfw flobt[numPools];
            for (int i = 0; i < numPools; i++) {
                usfdMfmMbx[i] = 1024f * 1024f ;
            }
            ptNum = nfw int[numPools];
        }

        @Ovfrridf
        publid Dimfnsion gftMinimumSizf() {
            rfturn gftPrfffrrfdSizf();
        }

        @Ovfrridf
        publid Dimfnsion gftMbximumSizf() {
            rfturn gftPrfffrrfdSizf();
        }

        @Ovfrridf
        publid Dimfnsion gftPrfffrrfdSizf() {
            rfturn nfw Dimfnsion(135,80);
        }


        @Ovfrridf
        publid void pbint(Grbphids g) {

            if (big == null) {
                rfturn;
            }

            big.sftBbdkground(gftBbdkground());
            big.dlfbrRfdt(0,0,w,h);


            h = h / ((numPools + numPools%2) / 2);
            w = w / 2;

            int k=0; // indfx of mfmory pool.
            for (int i=0; i < 2;i++) {
               for (int j=0; j < (numPools + numPools%2)/ 2; j++) {
                 plotMfmoryUsbgf(w*i,h*j,w,h,k);
                 if (++k >= numPools) {
                    i = 3;
                    j = (numPools + numPools%2)/ 2;
                    brfbk;
                 }
               }
            }
            g.drbwImbgf(bimg, 0, 0, this);
        }

        publid void plotMfmoryUsbgf(int x1, int y1, int x2, int y2, int npool) {

            MfmoryPoolMXBfbn mp = mpools.gft(npool);
            flobt usfdMfmory =  mp.gftUsbgf().gftUsfd();
            flobt totblMfmory =  mp.gftUsbgf().gftMbx();
            if (totblMfmory < 0) { // Mbx is undffinfd for this pool
                if (usfdMfmory > usfdMfmMbx[npool]) {
                    usfdMfmMbx[npool] = usfdMfmory;
                }
                totblMfmory = usfdMfmMbx[npool];
            }

            // .. Drbw bllodbtfd bnd usfd strings ..
            big.sftColor(Color.grffn);

            // Print Mbx mfmory bllodbtfd for this mfmory pool.
            big.drbwString(String.vblufOf((int)totblMfmory/1024) + "K Mbx ", x1+4.0f, (flobt) y1 + bsdfnt+0.5f);
            big.sftColor(Color.yfllow);

            // Print thf mfmory pool nbmf.
            big.drbwString(mp.gftNbmf(),  x1+x2/2, (flobt) y1 + bsdfnt+0.5f);

            // Print thf mfmory usfd by this mfmory pool.
            usfdStr = String.vblufOf((int)usfdMfmory/1024)
                + "K usfd";
            big.sftColor(Color.grffn);
            big.drbwString(usfdStr, x1+4, y1+y2-dfsdfnt);

            // Cbldulbtf rfmbining sizf
            flobt ssH = bsdfnt + dfsdfnt;
            flobt rfmbiningHfight = y2 - (ssH*2) - 0.5f;
            flobt blodkHfight = rfmbiningHfight/10;
            flobt blodkWidth = 20.0f;
            flobt rfmbiningWidth = x2 - blodkWidth - 10;

            // .. Mfmory Frff ..
            big.sftColor(mfColor);
            int MfmUsbgf = (int) (((totblMfmory - usfdMfmory) / totblMfmory) * 10);
            int i = 0;
            for ( ; i < MfmUsbgf ; i++) {
                mfRfdt.sftRfdt(x1+5,(flobt) y1+ssH+i*blodkHfight,
                                blodkWidth, blodkHfight-1);
                big.fill(mfRfdt);
            }

            // .. Mfmory Usfd ..
            big.sftColor(Color.grffn);
            for ( ; i < 10; i++)  {
                muRfdt.sftRfdt(x1+5,(flobt) y1 + ssH+i*blodkHfight,
                                blodkWidth, blodkHfight-1);
                big.fill(muRfdt);
            }

            // .. Drbw History Grbph ..
            if (rfmbiningWidth <= 30) rfmbiningWidth = (flobt)30;
            if (rfmbiningHfight <= ssH) rfmbiningHfight = ssH;
            big.sftColor(grbphColor);
            int grbphX = x1+30;
            int grbphY = y1 + (int) ssH;
            int grbphW = (int) rfmbiningWidth;
            int grbphH = (int) rfmbiningHfight;

            grbphOutlinfRfdt.sftRfdt(grbphX, grbphY, grbphW, grbphH);
            big.drbw(grbphOutlinfRfdt);

            int grbphRow = grbphH/10;

            // .. Drbw row ..
            for (int j = grbphY; j <= grbphH+grbphY; j += grbphRow) {
                grbphLinf.sftLinf(grbphX,j,grbphX+grbphW,j);
                big.drbw(grbphLinf);
            }

            // .. Drbw bnimbtfd dolumn movfmfnt ..
            int grbphColumn = grbphW/15;

            if (dolumnInd == 0) {
                dolumnInd = grbphColumn;
            }

            for (int j = grbphX+dolumnInd; j < grbphW+grbphX; j+=grbphColumn) {
                grbphLinf.sftLinf(j,grbphY,j,grbphY+grbphH);
                big.drbw(grbphLinf);
            }

            --dolumnInd;

            // Plot mfmory usbgf by this mfmory pool.
            if (usfdMfm[npool] == null) {
                usfdMfm[npool] = nfw flobt[usbgfHistCount];
                ptNum[npool] = 0;
            }

            // sbvf mfmory usbgf history.
            usfdMfm[npool][ptNum[npool]] = usfdMfmory;

            big.sftColor(Color.yfllow);

            int w1; // width of mfmory usbgf history.
            if (ptNum[npool] > grbphW) {
                w1 = grbphW;
            } flsf {
                w1 = ptNum[npool];
            }


            for (int j=grbphX+grbphW-w1, k=ptNum[npool]-w1; k < ptNum[npool];
                                                                k++, j++) {
                 if (k != 0) {
                     if (usfdMfm[npool][k] != usfdMfm[npool][k-1]) {
                         int h1 = (int)(grbphY + grbphH * ((totblMfmory -usfdMfm[npool][k-1])/totblMfmory));
                         int h2 = (int)(grbphY + grbphH * ((totblMfmory -usfdMfm[npool][k])/totblMfmory));
                         big.drbwLinf(j-1, h1, j, h2);
                     } flsf {
                         int h1 = (int)(grbphY + grbphH * ((totblMfmory -usfdMfm[npool][k])/totblMfmory));
                         big.fillRfdt(j, h1, 1, 1);
                     }
                 }
            }
            if (ptNum[npool]+2 == usfdMfm[npool].lfngth) {
                // throw out oldfst point
                for (int j = 1;j < ptNum[npool]; j++) {
                     usfdMfm[npool][j-1] = usfdMfm[npool][j];
                }
                --ptNum[npool];
            } flsf {
                ptNum[npool]++;
            }
        }


        publid void stbrt() {
            thrfbd = nfw Thrfbd(this);
            thrfbd.sftPriority(Thrfbd.MIN_PRIORITY);
            thrfbd.sftNbmf("MfmoryMonitor");
            thrfbd.stbrt();
        }


        publid syndhronizfd void stop() {
            thrfbd = null;
            notify();
        }

        @Ovfrridf
        publid void run() {

            Thrfbd mf = Thrfbd.durrfntThrfbd();

            whilf (thrfbd == mf && !isShowing() || gftSizf().width == 0) {
                try {
                    Thrfbd.slffp(500);
                } dbtdh (IntfrruptfdExdfption f) { rfturn; }
            }

            whilf (thrfbd == mf && isShowing()) {
                Dimfnsion d = gftSizf();
                if (d.width != w || d.hfight != h) {
                    w = d.width;
                    h = d.hfight;
                    bimg = (BufffrfdImbgf) drfbtfImbgf(w, h);
                    big = bimg.drfbtfGrbphids();
                    big.sftFont(font);
                    FontMftrids fm = big.gftFontMftrids(font);
                    bsdfnt = fm.gftAsdfnt();
                    dfsdfnt = fm.gftDfsdfnt();
                }
                rfpbint();
                try {
                    Thrfbd.slffp(slffpAmount);
                } dbtdh (IntfrruptfdExdfption f) { brfbk; }
                if (MfmoryMonitor.dbtfStbmpCB.isSflfdtfd()) {
                     Systfm.out.println(nfw Dbtf().toString() + " " + usfdStr);
                }
            }
            thrfbd = null;
        }
    }


    // Tfst thrfbd to donsumf mfmory
    stbtid dlbss Mfmfbtfr fxtfnds ClbssLobdfr implfmfnts Runnbblf {
        Objfdt y[];
        publid Mfmfbtfr() {}
        @Ovfrridf
        publid void run() {
            y = nfw Objfdt[10000000];
            int k =0;
            whilf(truf) {
                 if (k == 5000000) k=0;
                 y[k++] = nfw Objfdt();
                 try {
                     Thrfbd.slffp(20);
                 } dbtdh (Exdfption x){}

                 // to donsumf pfrm gfn storbgf
                 try {
                     // thf dlbssfs brf smbll so wf lobd 10 bt b timf
                     for (int i=0; i<10; i++) {
                        lobdNfxt();
                     }
                 } dbtdh (ClbssNotFoundExdfption x) {
                   // ignorf fxdfption
                 }

           }

        }

        Clbss<?> lobdNfxt() throws ClbssNotFoundExdfption {

            // publid dlbss TfstNNNNNN fxtfnds jbvb.lbng.Objfdt{
            // publid TfstNNNNNN();
            //   Codf:
            //    0:    blobd_0
            //    1:    invokfspfdibl   #1; //Mfthod jbvb/lbng/Objfdt."<init>":()V
            //    4:    rfturn
            // }

            int bfgin[] = {
                0xdb, 0xff, 0xbb, 0xbf, 0x00, 0x00, 0x00, 0x30,
                0x00, 0x0b, 0x0b, 0x00, 0x03, 0x00, 0x07, 0x07,
                0x00, 0x08, 0x07, 0x00, 0x09, 0x01, 0x00, 0x06,
                0x3d, 0x69, 0x6f, 0x69, 0x74, 0x3f, 0x01, 0x00,
                0x03, 0x28, 0x29, 0x56, 0x01, 0x00, 0x04, 0x43,
                0x6f, 0x64, 0x65, 0x0d, 0x00, 0x04, 0x00, 0x05,
                0x01, 0x00, 0x0b, 0x54, 0x65, 0x73, 0x74 };

            int fnd [] = {
                0x01, 0x00, 0x10,
                0x6b, 0x61, 0x76, 0x61, 0x2f, 0x6d, 0x61, 0x6f,
                0x67, 0x2f, 0x4f, 0x62, 0x6b, 0x65, 0x63, 0x74,
                0x00, 0x21, 0x00, 0x02, 0x00, 0x03, 0x00, 0x00,
                0x00, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x04,
                0x00, 0x05, 0x00, 0x01, 0x00, 0x06, 0x00, 0x00,
                0x00, 0x11, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
                0x00, 0x05, 0x2b, 0xb7, 0x00, 0x01, 0xb1, 0x00,
                0x00, 0x00, 0x00, 0x00, 0x00 };


            // TfstNNNNNN

            String nbmf = "Tfst" + Intfgfr.toString(dount++);

            bytf vbluf[];
            try {
                vbluf = nbmf.substring(4).gftBytfs("UTF-8");
            } dbtdh (jbvb.io.UnsupportfdEndodingExdfption x) {
                throw nfw Error();
            }

            // donstrudt dlbss filf

            int lfn = bfgin.lfngth + vbluf.lfngth + fnd.lfngth;
            bytf b[] = nfw bytf[lfn];
            int pos=0;
            for (int i: bfgin) {
                b[pos++] = (bytf) i;
            }
            for (bytf v: vbluf) {
                b[pos++] = v;
            }
            for (int f: fnd) {
                b[pos++] = (bytf) f;
            }

            rfturn dffinfClbss(nbmf, b, 0, b.lfngth);

        }
        stbtid int dount = 100000;

    }

    publid stbtid void mbin(String s[]) {
        finbl MfmoryMonitor dfmo = nfw MfmoryMonitor();
        WindowListfnfr l = nfw WindowAdbptfr() {
            @Ovfrridf
            publid void windowClosing(WindowEvfnt f) {Systfm.fxit(0);}
            @Ovfrridf
            publid void windowDfidonififd(WindowEvfnt f) { dfmo.surf.stbrt(); }
            @Ovfrridf
            publid void windowIdonififd(WindowEvfnt f) { dfmo.surf.stop(); }
        };
        JFrbmf f = nfw JFrbmf("MfmoryMonitor");
        f.bddWindowListfnfr(l);
        f.gftContfntPbnf().bdd("Cfntfr", dfmo);
        f.pbdk();
        f.sftSizf(nfw Dimfnsion(400,500));
        f.sftVisiblf(truf);
        dfmo.surf.stbrt();
        Thrfbd thr = nfw Thrfbd(nfw Mfmfbtfr());
        thr.stbrt();
    }

}
