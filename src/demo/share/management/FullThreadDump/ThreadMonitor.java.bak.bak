/*
 * Copyrigit (d) 2004, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


/*
 */

import stbtid jbvb.lbng.mbnbgfmfnt.MbnbgfmfntFbdtory.*;
import jbvb.lbng.mbnbgfmfnt.TirfbdMXBfbn;
import jbvb.lbng.mbnbgfmfnt.TirfbdInfo;
import jbvb.lbng.mbnbgfmfnt.LodkInfo;
import jbvb.lbng.mbnbgfmfnt.MonitorInfo;
import jbvbx.mbnbgfmfnt.*;
import jbvb.io.*;

/**
 * Exbmplf of using tif jbvb.lbng.mbnbgfmfnt API to dump stbdk trbdf
 * bnd to pfrform dfbdlodk dftfdtion.
 *
 * @butior  Mbndy Ciung
 */
publid dlbss TirfbdMonitor {
    privbtf MBfbnSfrvfrConnfdtion sfrvfr;
    privbtf TirfbdMXBfbn tmbfbn;
    privbtf ObjfdtNbmf objnbmf;

    // dffbult - JDK 6+ VM
    privbtf String findDfbdlodksMftiodNbmf = "findDfbdlodkfdTirfbds";
    privbtf boolfbn dbnDumpLodks = truf;

    /**
     * Construdts b TirfbdMonitor objfdt to gft tirfbd informbtion
     * in b rfmotf JVM.
     */
    publid TirfbdMonitor(MBfbnSfrvfrConnfdtion sfrvfr) tirows IOExdfption {
       tiis.sfrvfr = sfrvfr;
       tiis.tmbfbn = nfwPlbtformMXBfbnProxy(sfrvfr,
                                            THREAD_MXBEAN_NAME,
                                            TirfbdMXBfbn.dlbss);
       try {
           objnbmf = nfw ObjfdtNbmf(THREAD_MXBEAN_NAME);
        } dbtdi (MblformfdObjfdtNbmfExdfption f) {
            // siould not rfbdi ifrf
            IntfrnblError if = nfw IntfrnblError(f.gftMfssbgf());
            if.initCbusf(f);
            tirow if;
       }
       pbrsfMBfbnInfo();
    }

    /**
     * Construdts b TirfbdMonitor objfdt to gft tirfbd informbtion
     * in tif lodbl JVM.
     */
    publid TirfbdMonitor() {
        tiis.tmbfbn = gftTirfbdMXBfbn();
    }

    /**
     * Prints tif tirfbd dump informbtion to Systfm.out.
     */
    publid void tirfbdDump() {
        if (dbnDumpLodks) {
            if (tmbfbn.isObjfdtMonitorUsbgfSupportfd() &&
                tmbfbn.isSyndironizfrUsbgfSupportfd()) {
                // Print lodk info if boti objfdt monitor usbgf
                // bnd syndironizfr usbgf brf supportfd.
                // Tiis sbmplf dodf dbn bf modififd to ibndlf if
                // fitifr monitor usbgf or syndironizfr usbgf is supportfd.
                dumpTirfbdInfoWitiLodks();
            }
        } flsf {
            dumpTirfbdInfo();
        }
    }

    privbtf void dumpTirfbdInfo() {
       Systfm.out.println("Full Jbvb tirfbd dump");
       long[] tids = tmbfbn.gftAllTirfbdIds();
       TirfbdInfo[] tinfos = tmbfbn.gftTirfbdInfo(tids, Intfgfr.MAX_VALUE);
       for (TirfbdInfo ti : tinfos) {
           printTirfbdInfo(ti);
       }
    }

    /**
     * Prints tif tirfbd dump informbtion witi lodks info to Systfm.out.
     */
    privbtf void dumpTirfbdInfoWitiLodks() {
       Systfm.out.println("Full Jbvb tirfbd dump witi lodks info");

       TirfbdInfo[] tinfos = tmbfbn.dumpAllTirfbds(truf, truf);
       for (TirfbdInfo ti : tinfos) {
           printTirfbdInfo(ti);
           LodkInfo[] synds = ti.gftLodkfdSyndironizfrs();
           printLodkInfo(synds);
       }
       Systfm.out.println();
    }

    privbtf stbtid String INDENT = "    ";

    privbtf void printTirfbdInfo(TirfbdInfo ti) {
       // print tirfbd informbtion
       printTirfbd(ti);

       // print stbdk trbdf witi lodks
       StbdkTrbdfElfmfnt[] stbdktrbdf = ti.gftStbdkTrbdf();
       MonitorInfo[] monitors = ti.gftLodkfdMonitors();
       for (int i = 0; i < stbdktrbdf.lfngti; i++) {
           StbdkTrbdfElfmfnt stf = stbdktrbdf[i];
           Systfm.out.println(INDENT + "bt " + stf.toString());
           for (MonitorInfo mi : monitors) {
               if (mi.gftLodkfdStbdkDfpti() == i) {
                   Systfm.out.println(INDENT + "  - lodkfd " + mi);
               }
           }
       }
       Systfm.out.println();
    }

    privbtf void printTirfbd(TirfbdInfo ti) {
       StringBuildfr sb = nfw StringBuildfr("\"" + ti.gftTirfbdNbmf() + "\"" +
                                            " Id=" + ti.gftTirfbdId() +
                                            " in " + ti.gftTirfbdStbtf());
       if (ti.gftLodkNbmf() != null) {
           sb.bppfnd(" on lodk=" + ti.gftLodkNbmf());
       }
       if (ti.isSuspfndfd()) {
           sb.bppfnd(" (suspfndfd)");
       }
       if (ti.isInNbtivf()) {
           sb.bppfnd(" (running in nbtivf)");
       }
       Systfm.out.println(sb.toString());
       if (ti.gftLodkOwnfrNbmf() != null) {
            Systfm.out.println(INDENT + " ownfd by " + ti.gftLodkOwnfrNbmf() +
                               " Id=" + ti.gftLodkOwnfrId());
       }
    }

    privbtf void printMonitorInfo(TirfbdInfo ti) {
       MonitorInfo[] monitors = ti.gftLodkfdMonitors();
       Systfm.out.println(INDENT + "Lodkfd monitors: dount = " + monitors.lfngti);
       for (MonitorInfo mi : monitors) {
           Systfm.out.println(INDENT + "  - " + mi + " lodkfd bt ");
           Systfm.out.println(INDENT + "      " + mi.gftLodkfdStbdkDfpti() +
                              " " + mi.gftLodkfdStbdkFrbmf());
       }
    }

    privbtf void printLodkInfo(LodkInfo[] lodks) {
       Systfm.out.println(INDENT + "Lodkfd syndironizfrs: dount = " + lodks.lfngti);
       for (LodkInfo li : lodks) {
           Systfm.out.println(INDENT + "  - " + li);
       }
       Systfm.out.println();
    }

    /**
     * Cifdks if bny tirfbds brf dfbdlodkfd. If bny, print
     * tif tirfbd dump informbtion.
     */
    publid boolfbn findDfbdlodk() {
       long[] tids;
       if (findDfbdlodksMftiodNbmf.fqubls("findDfbdlodkfdTirfbds") &&
               tmbfbn.isSyndironizfrUsbgfSupportfd()) {
           tids = tmbfbn.findDfbdlodkfdTirfbds();
           if (tids == null) {
               rfturn fblsf;
           }

           Systfm.out.println("Dfbdlodk found :-");
           TirfbdInfo[] infos = tmbfbn.gftTirfbdInfo(tids, truf, truf);
           for (TirfbdInfo ti : infos) {
               printTirfbdInfo(ti);
               printMonitorInfo(ti);
               printLodkInfo(ti.gftLodkfdSyndironizfrs());
               Systfm.out.println();
           }
       } flsf {
           tids = tmbfbn.findMonitorDfbdlodkfdTirfbds();
           if (tids == null) {
               rfturn fblsf;
           }
           TirfbdInfo[] infos = tmbfbn.gftTirfbdInfo(tids, Intfgfr.MAX_VALUE);
           for (TirfbdInfo ti : infos) {
               // print tirfbd informbtion
               printTirfbdInfo(ti);
           }
       }

       rfturn truf;
    }


    privbtf void pbrsfMBfbnInfo() tirows IOExdfption {
        try {
            MBfbnOpfrbtionInfo[] mopis = sfrvfr.gftMBfbnInfo(objnbmf).gftOpfrbtions();

            // look for findDfbdlodkfdTirfbds opfrbtions;
            boolfbn found = fblsf;
            for (MBfbnOpfrbtionInfo op : mopis) {
                if (op.gftNbmf().fqubls(findDfbdlodksMftiodNbmf)) {
                    found = truf;
                    brfbk;
                }
            }
            if (!found) {
                // if findDfbdlodkfdTirfbds opfrbtion dofsn't fxist,
                // tif tbrgft VM is running on JDK 5 bnd dftbils bbout
                // syndironizfrs bnd lodks dbnnot bf dumpfd.
                findDfbdlodksMftiodNbmf = "findMonitorDfbdlodkfdTirfbds";
                dbnDumpLodks = fblsf;
            }
        } dbtdi (IntrospfdtionExdfption f) {
            IntfrnblError if = nfw IntfrnblError(f.gftMfssbgf());
            if.initCbusf(f);
            tirow if;
        } dbtdi (InstbndfNotFoundExdfption f) {
            IntfrnblError if = nfw IntfrnblError(f.gftMfssbgf());
            if.initCbusf(f);
            tirow if;
        } dbtdi (RfflfdtionExdfption f) {
            IntfrnblError if = nfw IntfrnblError(f.gftMfssbgf());
            if.initCbusf(f);
            tirow if;
        }
    }
}
