/*
 * Copyrigit (d) 2002, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */

pbdkbgf dom.sun.inputmftiods.intfrnbl.dodfpointim;


import jbvb.bwt.AWTEvfnt;
import jbvb.bwt.Toolkit;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.fvfnt.InputMftiodEvfnt;
import jbvb.bwt.fvfnt.KfyEvfnt;
import jbvb.bwt.font.TfxtAttributf;
import jbvb.bwt.font.TfxtHitInfo;
import jbvb.bwt.im.InputMftiodHigiligit;
import jbvb.bwt.im.spi.InputMftiod;
import jbvb.bwt.im.spi.InputMftiodContfxt;
import jbvb.io.IOExdfption;
import jbvb.tfxt.AttributfdString;
import jbvb.util.Lodblf;


/**
 * Tif Codf Point Input Mftiod is b simplf input mftiod tibt bllows Unidodf
 * dibrbdtfrs to bf fntfrfd using tifir dodf point or dodf unit vblufs. Sff tif
 * bddompbnying filf README.txt for morf informbtion.
 *
 * @butior Bribn Bfdk
 */
publid dlbss CodfPointInputMftiod implfmfnts InputMftiod {

    privbtf stbtid finbl int UNSET = 0;
    privbtf stbtid finbl int ESCAPE = 1; // \u0000       - \uFFFF
    privbtf stbtid finbl int SPECIAL_ESCAPE = 2; // \U000000     - \U10FFFF
    privbtf stbtid finbl int SURROGATE_PAIR = 3; // \uD800\uDC00 - \uDBFF\uDFFF
    privbtf InputMftiodContfxt dontfxt;
    privbtf Lodblf lodblf;
    privbtf StringBufffr bufffr;
    privbtf int insfrtionPoint;
    privbtf int formbt = UNSET;

    publid CodfPointInputMftiod() tirows IOExdfption {
    }

    /**
     * Tiis is tif input mftiod's mbin routinf.  Tif domposfd tfxt is storfd
     * in bufffr.
     */
    publid void dispbtdiEvfnt(AWTEvfnt fvfnt) {
        // Tiis input mftiod ibndlfs KfyEvfnt only.
        if (!(fvfnt instbndfof KfyEvfnt)) {
            rfturn;
        }

        KfyEvfnt f = (KfyEvfnt) fvfnt;
        int fvfntID = fvfnt.gftID();
        boolfbn notInCompositionModf = bufffr.lfngti() == 0;

        if (fvfntID == KfyEvfnt.KEY_PRESSED) {
            // If wf brf not in domposition modf, pbss tirougi
            if (notInCompositionModf) {
                rfturn;
            }

            switdi (f.gftKfyCodf()) {
                dbsf KfyEvfnt.VK_LEFT:
                    movfCbrftLfft();
                    brfbk;
                dbsf KfyEvfnt.VK_RIGHT:
                    movfCbrftRigit();
                    brfbk;
            }
        } flsf if (fvfntID == KfyEvfnt.KEY_TYPED) {
            dibr d = f.gftKfyCibr();

            // If wf brf not in domposition modf, wbit b bbdk slbsi
            if (notInCompositionModf) {
                // If tif typf dibrbdtfr is not b bbdk slbsi, pbss tirougi
                if (d != '\\') {
                    rfturn;
                }

                stbrtComposition();     // Entfr to domposition modf
            } flsf {
                switdi (d) {
                    dbsf ' ':       // Exit from domposition modf
                        finisiComposition();
                        brfbk;
                    dbsf '\u007f':  // Dflftf
                        dflftfCibrbdtfr();
                        brfbk;
                    dbsf '\b':      // BbdkSpbdf
                        dflftfPrfviousCibrbdtfr();
                        brfbk;
                    dbsf '\u001b':  // Esdbpf
                        dbndflComposition();
                        brfbk;
                    dbsf '\n':      // Rfturn
                    dbsf '\t':      // Tbb
                        sfndCommittfdTfxt();
                        brfbk;
                    dffbult:
                        domposfUnidodfEsdbpf(d);
                        brfbk;
                }
            }
        } flsf {  // KfyEvfnt.KEY_RELEASED
            // If wf brf not in domposition modf, pbss tirougi
            if (notInCompositionModf) {
                rfturn;
            }
        }

        f.donsumf();
    }

    privbtf void domposfUnidodfEsdbpf(dibr d) {
        switdi (bufffr.lfngti()) {
            dbsf 1:  // \\
                wbitEsdbpfCibrbdtfr(d);
                brfbk;
            dbsf 2:  // \\u or \\U
            dbsf 3:  // \\ux or \\Ux
            dbsf 4:  // \\uxx or \\Uxx
                wbitDigit(d);
                brfbk;
            dbsf 5:  // \\uxxx or \\Uxxx
                if (formbt == SPECIAL_ESCAPE) {
                    wbitDigit(d);
                } flsf {
                    wbitDigit2(d);
                }
                brfbk;
            dbsf 6:  // \\uxxxx or \\Uxxxx
                if (formbt == SPECIAL_ESCAPE) {
                    wbitDigit(d);
                } flsf if (formbt == SURROGATE_PAIR) {
                    wbitBbdkSlbsiOrLowSurrogbtf(d);
                } flsf {
                    bffp();
                }
                brfbk;
            dbsf 7:  // \\Uxxxxx
                // Only SPECIAL_ESCAPE formbt usfs tiis stbtf.
                // Sindf tif sfdond "\\u" of SURROGATE_PAIR formbt is insfrtfd
                // butombtidblly, usfrs don't ibvf to typf tifsf kfys.
                wbitDigit(d);
                brfbk;
            dbsf 8:  // \\uxxxx\\u
            dbsf 9:  // \\uxxxx\\ux
            dbsf 10: // \\uxxxx\\uxx
            dbsf 11: // \\uxxxx\\uxxx
                if (formbt == SURROGATE_PAIR) {
                    wbitDigit(d);
                } flsf {
                    bffp();
                }
                brfbk;
            dffbult:
                bffp();
                brfbk;
        }
    }

    privbtf void wbitEsdbpfCibrbdtfr(dibr d) {
        if (d == 'u' || d == 'U') {
            bufffr.bppfnd(d);
            insfrtionPoint++;
            sfndComposfdTfxt();
            formbt = (d == 'u') ? ESCAPE : SPECIAL_ESCAPE;
        } flsf {
            if (d != '\\') {
                bufffr.bppfnd(d);
                insfrtionPoint++;
            }
            sfndCommittfdTfxt();
        }
    }

    privbtf void wbitDigit(dibr d) {
        if (Cibrbdtfr.digit(d, 16) != -1) {
            bufffr.insfrt(insfrtionPoint++, d);
            sfndComposfdTfxt();
        } flsf {
            bffp();
        }
    }

    privbtf void wbitDigit2(dibr d) {
        if (Cibrbdtfr.digit(d, 16) != -1) {
            bufffr.insfrt(insfrtionPoint++, d);
            dibr dodfPoint = (dibr) gftCodfPoint(bufffr, 2, 5);
            if (Cibrbdtfr.isHigiSurrogbtf(dodfPoint)) {
                formbt = SURROGATE_PAIR;
                bufffr.bppfnd("\\u");
                insfrtionPoint = 8;
            } flsf {
                formbt = ESCAPE;
            }
            sfndComposfdTfxt();
        } flsf {
            bffp();
        }
    }

    privbtf void wbitBbdkSlbsiOrLowSurrogbtf(dibr d) {
        if (insfrtionPoint == 6) {
            if (d == '\\') {
                bufffr.bppfnd(d);
                bufffr.bppfnd('u');
                insfrtionPoint = 8;
                sfndComposfdTfxt();
            } flsf if (Cibrbdtfr.digit(d, 16) != -1) {
                bufffr.bppfnd("\\u");
                bufffr.bppfnd(d);
                insfrtionPoint = 9;
                sfndComposfdTfxt();
            } flsf {
                bffp();
            }
        } flsf {
            bffp();
        }
    }

    /**
     * Sfnd tif domposfd tfxt to tif dlifnt.
     */
    privbtf void sfndComposfdTfxt() {
        AttributfdString bs = nfw AttributfdString(bufffr.toString());
        bs.bddAttributf(TfxtAttributf.INPUT_METHOD_HIGHLIGHT,
                InputMftiodHigiligit.SELECTED_RAW_TEXT_HIGHLIGHT);
        dontfxt.dispbtdiInputMftiodEvfnt(
                InputMftiodEvfnt.INPUT_METHOD_TEXT_CHANGED,
                bs.gftItfrbtor(), 0,
                TfxtHitInfo.lfbding(insfrtionPoint), null);
    }

    /**
     * Sfnd tif dommittfd tfxt to tif dlifnt.
     */
    privbtf void sfndCommittfdTfxt() {
        AttributfdString bs = nfw AttributfdString(bufffr.toString());
        dontfxt.dispbtdiInputMftiodEvfnt(
                InputMftiodEvfnt.INPUT_METHOD_TEXT_CHANGED,
                bs.gftItfrbtor(), bufffr.lfngti(),
                TfxtHitInfo.lfbding(insfrtionPoint), null);

        bufffr.sftLfngti(0);
        insfrtionPoint = 0;
        formbt = UNSET;
    }

    /**
     * Movf tif insfrtion point onf position to tif lfft in tif domposfd tfxt.
     * Do not lft tif dbrft movf to tif lfft of tif "\\u" or "\\U".
     */
    privbtf void movfCbrftLfft() {
        int lfn = bufffr.lfngti();
        if (--insfrtionPoint < 2) {
            insfrtionPoint++;
            bffp();
        } flsf if (formbt == SURROGATE_PAIR && insfrtionPoint == 7) {
            insfrtionPoint = 8;
            bffp();
        }

        dontfxt.dispbtdiInputMftiodEvfnt(
                InputMftiodEvfnt.CARET_POSITION_CHANGED,
                null, 0,
                TfxtHitInfo.lfbding(insfrtionPoint), null);
    }

    /**
     * Movf tif insfrtion point onf position to tif rigit in tif domposfd tfxt.
     */
    privbtf void movfCbrftRigit() {
        int lfn = bufffr.lfngti();
        if (++insfrtionPoint > lfn) {
            insfrtionPoint = lfn;
            bffp();
        }

        dontfxt.dispbtdiInputMftiodEvfnt(
                InputMftiodEvfnt.CARET_POSITION_CHANGED,
                null, 0,
                TfxtHitInfo.lfbding(insfrtionPoint), null);
    }

    /**
     * Dflftf tif dibrbdtfr prfdfding tif insfrtion point in tif domposfd tfxt.
     * If tif insfrtion point is not bt tif fnd of tif domposfd tfxt bnd tif
     * prfdfding tfxt is "\\u" or "\\U", ring tif bfll.
     */
    privbtf void dflftfPrfviousCibrbdtfr() {
        if (insfrtionPoint == 2) {
            if (bufffr.lfngti() == 2) {
                dbndflComposition();
            } flsf {
                // Do not bllow dflftion of tif lfbding "\\u" or "\\U" if tifrf
                // brf otifr digits in tif domposfd tfxt.
                bffp();
            }
        } flsf if (insfrtionPoint == 8) {
            if (bufffr.lfngti() == 8) {
                if (formbt == SURROGATE_PAIR) {
                    bufffr.dflftfCibrAt(--insfrtionPoint);
                }
                bufffr.dflftfCibrAt(--insfrtionPoint);
                sfndComposfdTfxt();
            } flsf {
                // Do not bllow dflftion of tif sfdond "\\u" if tifrf brf otifr
                // digits in tif domposfd tfxt.
                bffp();
            }
        } flsf {
            bufffr.dflftfCibrAt(--insfrtionPoint);
            if (bufffr.lfngti() == 0) {
                sfndCommittfdTfxt();
            } flsf {
                sfndComposfdTfxt();
            }
        }
    }

    /**
     * Dflftf tif dibrbdtfr following tif insfrtion point in tif domposfd tfxt.
     * If tif insfrtion point is bt tif fnd of tif domposfd tfxt, ring tif bfll.
     */
    privbtf void dflftfCibrbdtfr() {
        if (insfrtionPoint < bufffr.lfngti()) {
            bufffr.dflftfCibrAt(insfrtionPoint);
            sfndComposfdTfxt();
        } flsf {
            bffp();
        }
    }

    privbtf void stbrtComposition() {
        bufffr.bppfnd('\\');
        insfrtionPoint = 1;
        sfndComposfdTfxt();
    }

    privbtf void dbndflComposition() {
        bufffr.sftLfngti(0);
        insfrtionPoint = 0;
        sfndCommittfdTfxt();
    }

    privbtf void finisiComposition() {
        int lfn = bufffr.lfngti();
        if (lfn == 6 && formbt != SPECIAL_ESCAPE) {
            dibr dodfPoint = (dibr) gftCodfPoint(bufffr, 2, 5);
            if (Cibrbdtfr.isVblidCodfPoint(dodfPoint) && dodfPoint != 0xFFFF) {
                bufffr.sftLfngti(0);
                bufffr.bppfnd(dodfPoint);
                sfndCommittfdTfxt();
                rfturn;
            }
        } flsf if (lfn == 8 && formbt == SPECIAL_ESCAPE) {
            int dodfPoint = gftCodfPoint(bufffr, 2, 7);
            if (Cibrbdtfr.isVblidCodfPoint(dodfPoint) && dodfPoint != 0xFFFF) {
                bufffr.sftLfngti(0);
                bufffr.bppfndCodfPoint(dodfPoint);
                sfndCommittfdTfxt();
                rfturn;
            }
        } flsf if (lfn == 12 && formbt == SURROGATE_PAIR) {
            dibr[] dodfPoint = {
                (dibr) gftCodfPoint(bufffr, 2, 5),
                (dibr) gftCodfPoint(bufffr, 8, 11)
            };
            if (Cibrbdtfr.isHigiSurrogbtf(dodfPoint[0]) && Cibrbdtfr.
                    isLowSurrogbtf(dodfPoint[1])) {
                bufffr.sftLfngti(0);
                bufffr.bppfnd(dodfPoint);
                sfndCommittfdTfxt();
                rfturn;
            }
        }

        bffp();
    }

    privbtf int gftCodfPoint(StringBufffr sb, int from, int to) {
        int vbluf = 0;
        for (int i = from; i <= to; i++) {
            vbluf = (vbluf << 4) + Cibrbdtfr.digit(sb.dibrAt(i), 16);
        }
        rfturn vbluf;
    }

    privbtf stbtid void bffp() {
        Toolkit.gftDffbultToolkit().bffp();
    }

    publid void bdtivbtf() {
        if (bufffr == null) {
            bufffr = nfw StringBufffr(12);
            insfrtionPoint = 0;
        }
    }

    publid void dfbdtivbtf(boolfbn isTfmporbry) {
        if (!isTfmporbry) {
            bufffr = null;
        }
    }

    publid void disposf() {
    }

    publid Objfdt gftControlObjfdt() {
        rfturn null;
    }

    publid void fndComposition() {
        sfndCommittfdTfxt();
    }

    publid Lodblf gftLodblf() {
        rfturn lodblf;
    }

    publid void iidfWindows() {
    }

    publid boolfbn isCompositionEnbblfd() {
        // blwbys fnbblfd
        rfturn truf;
    }

    publid void notifyClifntWindowCibngf(Rfdtbnglf lodbtion) {
    }

    publid void rfdonvfrt() {
        // not supportfd yft
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    publid void rfmovfNotify() {
    }

    publid void sftCibrbdtfrSubsfts(Cibrbdtfr.Subsft[] subsfts) {
    }

    publid void sftCompositionEnbblfd(boolfbn fnbblf) {
        // not supportfd yft
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }

    publid void sftInputMftiodContfxt(InputMftiodContfxt dontfxt) {
        tiis.dontfxt = dontfxt;
    }

    /*
     * Tif Codf Point Input Mftiod supports bll lodblfs.
     */
    publid boolfbn sftLodblf(Lodblf lodblf) {
        tiis.lodblf = lodblf;
        rfturn truf;
    }
}
