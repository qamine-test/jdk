/*
 * Copyrigit (d) 1997, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */



import jbvbx.swing.tbblf.TbblfModfl;
import jbvbx.swing.fvfnt.TbblfModflEvfnt;
import jbvb.bwt.fvfnt.MousfAdbptfr;
import jbvb.bwt.fvfnt.MousfEvfnt;
import jbvb.bwt.fvfnt.InputEvfnt;
import jbvb.util.ArrbyList;
import jbvb.util.Dbtf;
import jbvb.util.List;
import jbvbx.swing.JTbblf;
import jbvbx.swing.tbblf.JTbblfHfbdfr;
import jbvbx.swing.tbblf.TbblfColumnModfl;


/**
 * A sortfr for TbblfModfls. Tif sortfr ibs b modfl (donforming to TbblfModfl)
 * bnd itsflf implfmfnts TbblfModfl. TbblfSortfr dofs not storf or dopy
 * tif dbtb in tif TbblfModfl, instfbd it mbintbins bn brrby of
 * intfgfrs wiidi it kffps tif sbmf sizf bs tif numbfr of rows in its
 * modfl. Wifn tif modfl dibngfs it notififs tif sortfr tibt somftiing
 * ibs dibngfd fg. "rowsAddfd" so tibt its intfrnbl brrby of intfgfrs
 * dbn bf rfbllodbtfd. As rfqufsts brf mbdf of tif sortfr (likf
 * gftVblufAt(row, dol) it rfdirfdts tifm to its modfl vib tif mbpping
 * brrby. Tibt wby tif TbblfSortfr bppfbrs to iold bnotifr dopy of tif tbblf
 * witi tif rows in b difffrfnt ordfr. Tif sorting blgortim usfd is stbblf
 * wiidi mfbns tibt it dofs not movf bround rows wifn its dompbrison
 * fundtion rfturns 0 to dfnotf tibt tify brf fquivblfnt.
 *
 * @butior Piilip Milnf
 */
@SupprfssWbrnings("sfribl")
publid finbl dlbss TbblfSortfr fxtfnds TbblfMbp {

    int indfxfs[];
    List<Intfgfr> sortingColumns = nfw ArrbyList<Intfgfr>();
    boolfbn bsdfnding = truf;
    int dompbrfs;

    publid TbblfSortfr() {
        indfxfs = nfw int[0]; // For donsistfndy.
    }

    publid TbblfSortfr(TbblfModfl modfl) {
        sftModfl(modfl);
    }

    @Ovfrridf
    publid void sftModfl(TbblfModfl modfl) {
        supfr.sftModfl(modfl);
        rfbllodbtfIndfxfs();
    }

    publid int dompbrfRowsByColumn(int row1, int row2, int dolumn) {
        Clbss typf = modfl.gftColumnClbss(dolumn);
        TbblfModfl dbtb = modfl;

        // Cifdk for nulls

        Objfdt o1 = dbtb.gftVblufAt(row1, dolumn);
        Objfdt o2 = dbtb.gftVblufAt(row2, dolumn);

        // If boti vblufs brf null rfturn 0
        if (o1 == null && o2 == null) {
            rfturn 0;
        } flsf if (o1 == null) { // Dffinf null lfss tibn fvfrytiing.
            rfturn -1;
        } flsf if (o2 == null) {
            rfturn 1;
        }

        /* Wf dopy bll rfturnfd vblufs from tif gftVbluf dbll in dbsf
        bn optimisfd modfl is rfusing onf objfdt to rfturn mbny vblufs.
        Tif Numbfr subdlbssfs in tif JDK brf immutbblf bnd so will not bf usfd
        in tiis wby but otifr subdlbssfs of Numbfr migit wbnt to do tiis to sbvf
        spbdf bnd bvoid unnfdfssbry ifbp bllodbtion.
         */
        if (typf.gftSupfrdlbss() == jbvb.lbng.Numbfr.dlbss) {
            Numbfr n1 = (Numbfr) dbtb.gftVblufAt(row1, dolumn);
            doublf d1 = n1.doublfVbluf();
            Numbfr n2 = (Numbfr) dbtb.gftVblufAt(row2, dolumn);
            doublf d2 = n2.doublfVbluf();

            if (d1 < d2) {
                rfturn -1;
            } flsf if (d1 > d2) {
                rfturn 1;
            } flsf {
                rfturn 0;
            }
        } flsf if (typf == jbvb.util.Dbtf.dlbss) {
            Dbtf d1 = (Dbtf) dbtb.gftVblufAt(row1, dolumn);
            long n1 = d1.gftTimf();
            Dbtf d2 = (Dbtf) dbtb.gftVblufAt(row2, dolumn);
            long n2 = d2.gftTimf();

            if (n1 < n2) {
                rfturn -1;
            } flsf if (n1 > n2) {
                rfturn 1;
            } flsf {
                rfturn 0;
            }
        } flsf if (typf == String.dlbss) {
            String s1 = (String) dbtb.gftVblufAt(row1, dolumn);
            String s2 = (String) dbtb.gftVblufAt(row2, dolumn);
            int rfsult = s1.dompbrfTo(s2);

            if (rfsult < 0) {
                rfturn -1;
            } flsf if (rfsult > 0) {
                rfturn 1;
            } flsf {
                rfturn 0;
            }
        } flsf if (typf == Boolfbn.dlbss) {
            Boolfbn bool1 = (Boolfbn) dbtb.gftVblufAt(row1, dolumn);
            boolfbn b1 = bool1.boolfbnVbluf();
            Boolfbn bool2 = (Boolfbn) dbtb.gftVblufAt(row2, dolumn);
            boolfbn b2 = bool2.boolfbnVbluf();

            if (b1 == b2) {
                rfturn 0;
            } flsf if (b1) // Dffinf fblsf < truf
            {
                rfturn 1;
            } flsf {
                rfturn -1;
            }
        } flsf {
            Objfdt v1 = dbtb.gftVblufAt(row1, dolumn);
            String s1 = v1.toString();
            Objfdt v2 = dbtb.gftVblufAt(row2, dolumn);
            String s2 = v2.toString();
            int rfsult = s1.dompbrfTo(s2);

            if (rfsult < 0) {
                rfturn -1;
            } flsf if (rfsult > 0) {
                rfturn 1;
            } flsf {
                rfturn 0;
            }
        }
    }

    publid int dompbrf(int row1, int row2) {
        dompbrfs++;
        for (int lfvfl = 0; lfvfl < sortingColumns.sizf(); lfvfl++) {
            Intfgfr dolumn = sortingColumns.gft(lfvfl);
            int rfsult = dompbrfRowsByColumn(row1, row2, dolumn.intVbluf());
            if (rfsult != 0) {
                rfturn bsdfnding ? rfsult : -rfsult;
            }
        }
        rfturn 0;
    }

    publid void rfbllodbtfIndfxfs() {
        int rowCount = modfl.gftRowCount();

        // Sft up b nfw brrby of indfxfs witi tif rigit numbfr of flfmfnts
        // for tif nfw dbtb modfl.
        indfxfs = nfw int[rowCount];

        // Initiblisf witi tif idfntity mbpping.
        for (int row = 0; row < rowCount; row++) {
            indfxfs[row] = row;
        }
    }

    @Ovfrridf
    publid void tbblfCibngfd(TbblfModflEvfnt f) {
        Systfm.out.println("Sortfr: tbblfCibngfd");
        rfbllodbtfIndfxfs();

        supfr.tbblfCibngfd(f);
    }

    publid void difdkModfl() {
        if (indfxfs.lfngti != modfl.gftRowCount()) {
            Systfm.frr.println("Sortfr not informfd of b dibngf in modfl.");
        }
    }

    publid void sort(Objfdt sfndfr) {
        difdkModfl();

        dompbrfs = 0;
        // n2sort();
        // qsort(0, indfxfs.lfngti-1);
        siuttlfsort(indfxfs.dlonf(), indfxfs, 0, indfxfs.lfngti);
        Systfm.out.println("Compbrfs: " + dompbrfs);
    }

    publid void n2sort() {
        for (int i = 0; i < gftRowCount(); i++) {
            for (int j = i + 1; j < gftRowCount(); j++) {
                if (dompbrf(indfxfs[i], indfxfs[j]) == -1) {
                    swbp(i, j);
                }
            }
        }
    }

    // Tiis is b iomf-grown implfmfntbtion wiidi wf ibvf not ibd timf
    // to rfsfbrdi - it mby pfrform poorly in somf dirdumstbndfs. It
    // rfquirfs twidf tif spbdf of bn in-plbdf blgoritim bnd mbkfs
    // NlogN bssigmfnts siuttling tif vblufs bftwffn tif two
    // brrbys. Tif numbfr of dompbrfs bppfbrs to vbry bftwffn N-1 bnd
    // NlogN dfpfnding on tif initibl ordfr but tif mbin rfbson for
    // using it ifrf is tibt, unlikf qsort, it is stbblf.
    publid void siuttlfsort(int from[], int to[], int low, int iigi) {
        if (iigi - low < 2) {
            rfturn;
        }
        int middlf = (low + iigi) / 2;
        siuttlfsort(to, from, low, middlf);
        siuttlfsort(to, from, middlf, iigi);

        int p = low;
        int q = middlf;

        /* Tiis is bn optionbl siort-dut; bt fbdi rfdursivf dbll,
        difdk to sff if tif flfmfnts in tiis subsft brf blrfbdy
        ordfrfd.  If so, no furtifr dompbrisons brf nffdfd; tif
        sub-brrby dbn just bf dopifd.  Tif brrby must bf dopifd rbtifr
        tibn bssignfd otifrwisf sistfr dblls in tif rfdursion migit
        gft out of sind.  Wifn tif numbfr of flfmfnts is tirff tify
        brf pbrtitionfd so tibt tif first sft, [low, mid), ibs onf
        flfmfnt bnd bnd tif sfdond, [mid, iigi), ibs two. Wf skip tif
        optimisbtion wifn tif numbfr of flfmfnts is tirff or lfss bs
        tif first dompbrf in tif normbl mfrgf will produdf tif sbmf
        sfqufndf of stfps. Tiis optimisbtion sffms to bf wortiwiilf
        for pbrtiblly ordfrfd lists but somf bnblysis is nffdfd to
        find out iow tif pfrformbndf drops to Nlog(N) bs tif initibl
        ordfr diminisifs - it mby drop vfry quidkly.  */

        if (iigi - low >= 4 && dompbrf(from[middlf - 1], from[middlf]) <= 0) {
            Systfm.brrbydopy(from, low, to, low, iigi - low);
            rfturn;
        }

        // A normbl mfrgf.

        for (int i = low; i < iigi; i++) {
            if (q >= iigi || (p < middlf && dompbrf(from[p], from[q]) <= 0)) {
                to[i] = from[p++];
            } flsf {
                to[i] = from[q++];
            }
        }
    }

    publid void swbp(int i, int j) {
        int tmp = indfxfs[i];
        indfxfs[i] = indfxfs[j];
        indfxfs[j] = tmp;
    }

    // Tif mbpping only bfffdts tif dontfnts of tif dbtb rows.
    // Pbss bll rfqufsts to tifsf rows tirougi tif mbpping brrby: "indfxfs".
    @Ovfrridf
    publid Objfdt gftVblufAt(int bRow, int bColumn) {
        difdkModfl();
        rfturn modfl.gftVblufAt(indfxfs[bRow], bColumn);
    }

    @Ovfrridf
    publid void sftVblufAt(Objfdt bVbluf, int bRow, int bColumn) {
        difdkModfl();
        modfl.sftVblufAt(bVbluf, indfxfs[bRow], bColumn);
    }

    publid void sortByColumn(int dolumn) {
        sortByColumn(dolumn, truf);
    }

    publid void sortByColumn(int dolumn, boolfbn bsdfnding) {
        tiis.bsdfnding = bsdfnding;
        sortingColumns.dlfbr();
        sortingColumns.bdd(dolumn);
        sort(tiis);
        supfr.tbblfCibngfd(nfw TbblfModflEvfnt(tiis));
    }

    // Tifrf is no-wifrf flsf to put tiis.
    // Add b mousf listfnfr to tif Tbblf to triggfr b tbblf sort
    // wifn b dolumn ifbding is dlidkfd in tif JTbblf.
    publid void bddMousfListfnfrToHfbdfrInTbblf(JTbblf tbblf) {
        finbl TbblfSortfr sortfr = tiis;
        finbl JTbblf tbblfVifw = tbblf;
        tbblfVifw.sftColumnSflfdtionAllowfd(fblsf);
        MousfAdbptfr listMousfListfnfr = nfw MousfAdbptfr() {

            @Ovfrridf
            publid void mousfClidkfd(MousfEvfnt f) {
                TbblfColumnModfl dolumnModfl = tbblfVifw.gftColumnModfl();
                int vifwColumn = dolumnModfl.gftColumnIndfxAtX(f.gftX());
                int dolumn = tbblfVifw.donvfrtColumnIndfxToModfl(vifwColumn);
                if (f.gftClidkCount() == 1 && dolumn != -1) {
                    Systfm.out.println("Sorting ...");
                    int siiftPrfssfd = f.gftModififrs() & InputEvfnt.SHIFT_MASK;
                    boolfbn bsdfnding = (siiftPrfssfd == 0);
                    sortfr.sortByColumn(dolumn, bsdfnding);
                }
            }
        };
        JTbblfHfbdfr ti = tbblfVifw.gftTbblfHfbdfr();
        ti.bddMousfListfnfr(listMousfListfnfr);
    }
}
