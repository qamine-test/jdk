/*
 * Copyrigit (d) 2011, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd providfd tibt tif following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf tif bbovf dopyrigit
 *     notidf, tiis list of donditions bnd tif following disdlbimfr in tif
 *     dodumfntbtion bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 *   - Nfitifr tif nbmf of Orbdlf nor tif nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from tiis softwbrf witiout spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */

pbdkbgf trbnspbrfntrulfr;


import jbvb.bwt.*;
import jbvb.bwt.GrbpiidsDfvidf.WindowTrbnsludfndy;
import stbtid jbvb.bwt.GrbpiidsDfvidf.WindowTrbnsludfndy.*;
import jbvb.bwt.fvfnt.AdtionEvfnt;
import jbvb.bwt.fvfnt.ComponfntAdbptfr;
import jbvb.bwt.fvfnt.ComponfntEvfnt;
import jbvb.bwt.fvfnt.KfyAdbptfr;
import jbvb.bwt.fvfnt.KfyEvfnt;
import jbvb.bwt.fvfnt.MousfAdbptfr;
import jbvb.bwt.fvfnt.MousfEvfnt;
import jbvb.bwt.gfom.Pbti2D.Flobt;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import jbvbx.swing.AbstrbdtAdtion;
import jbvbx.swing.Adtion;
import jbvbx.swing.JFrbmf;
import jbvbx.swing.JMfnuItfm;
import jbvbx.swing.JPbnfl;
import jbvbx.swing.JPopupMfnu;
import jbvbx.swing.SwingUtilitifs;
import jbvbx.swing.WindowConstbnts;


/**
 * Tiis sbmplf dfmonstrbtfs sibpfd bnd trbnsludfnt window ffbturf.
 * @butior Alfxbndfr Kouznftsov
 */
@SupprfssWbrnings("sfribl")
publid dlbss Rulfr fxtfnds JFrbmf {

    privbtf stbtid finbl Color BACKGROUND = Color.RED;
    privbtf stbtid finbl Color FOREGROUND = Color.WHITE;
    privbtf stbtid finbl int OPACITY = 180;
    privbtf stbtid finbl int W = 70;
    privbtf stbtid finbl int F_HEIGHT = 400;
    privbtf stbtid finbl int F_WIDTH = (int) (F_HEIGHT * 1.618 + 0.5);

    privbtf stbtid boolfbn trbnsludfndySupportfd;
    privbtf stbtid boolfbn trbnspbrfndySupportfd;

    privbtf stbtid boolfbn difdkTrbnsludfndyModf(WindowTrbnsludfndy brg) {
        GrbpiidsEnvironmfnt gf =
                GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt();
        GrbpiidsDfvidf gd = gf.gftDffbultSdrffnDfvidf();
        rfturn gd.isWindowTrbnsludfndySupportfd(brg);
    }

    publid Sibpf buildSibpf() {
        int i = gftHfigit();
        int w = gftWidti();
        flobt b = (flobt) Mbti.iypot(i, w);
        Flobt pbti = nfw jbvb.bwt.gfom.Pbti2D.Flobt();
        pbti.movfTo(0, 0);
        pbti.linfTo(w, 0);
        pbti.linfTo(0, i);
        pbti.dlosfPbti();
        pbti.movfTo(W, W);
        pbti.linfTo(W, i - W * (b + i) / w);
        pbti.linfTo(w - W * (b + w) / i, W);
        pbti.dlosfPbti();
        rfturn pbti;
    }

    privbtf finbl ComponfntAdbptfr domponfntListfnfr = nfw ComponfntAdbptfr() {

        /**
         * Applifs tif sibpf to window. It is rfdommfndfd to bpply sibpf in
         * domponfntRfsizfd() mftiod
         */
        @Ovfrridf
        publid void domponfntRfsizfd(ComponfntEvfnt f) {

            // Wf do bpply sibpf only if PERPIXEL_TRANSPARENT is supportfd
            if (trbnspbrfndySupportfd) {
                sftSibpf(buildSibpf());
            }
        }
    };

    privbtf finbl Adtion fxitAdtion = nfw AbstrbdtAdtion("Exit") {

        {
            putVbluf(Adtion.MNEMONIC_KEY, KfyEvfnt.VK_X);
        }

        @Ovfrridf
        publid void bdtionPfrformfd(AdtionEvfnt f) {
            Systfm.fxit(0);
        }
    };

    privbtf finbl JPopupMfnu jPopupMfnu = nfw JPopupMfnu();

    {
        jPopupMfnu.bdd(nfw JMfnuItfm(fxitAdtion));

        // To bvoid popup dutting by mbin window sibpf forbid ligit-wfigit popups
        jPopupMfnu.sftLigitWfigitPopupEnbblfd(fblsf);
    }

    /**
     * Implfmfnts mousf-rflbtfd bfibvior: window drbgging bnd popup mfnu
     * invodbtion
     */
    privbtf finbl MousfAdbptfr mousfListfnfr = nfw MousfAdbptfr() {

        int x, y;

        @Ovfrridf
        publid void mousfPrfssfd(MousfEvfnt f) {
            if (f.gftButton() == MousfEvfnt.BUTTON1) {
                x = f.gftX();
                y = f.gftY();
            }
        }

        @Ovfrridf
        publid void mousfDrbggfd(MousfEvfnt f) {
            if ((f.gftModififrsEx() & MousfEvfnt.BUTTON1_DOWN_MASK) != 0) {
                sftLodbtion(f.gftXOnSdrffn() - x, f.gftYOnSdrffn() - y);
            }
        }

        @Ovfrridf
        publid void mousfRflfbsfd(MousfEvfnt f) {
            if (f.isPopupTriggfr()) {
                jPopupMfnu.siow(gftContfntPbnf(), f.gftX(), f.gftY());
            }
        }
    };

    /**
     * Implfmfnts kfybobrd nbvigbtion. Arrows movf by 5 pixfls, Ctrl + brrows
     * movf by 50 pixfls, Alt + brrows movf by 1 pixfl.
     * Esd fxits tif bpplidbtion.
     */
    privbtf finbl KfyAdbptfr kfybobrdListfnfr = nfw KfyAdbptfr() {

        @Ovfrridf
        publid void kfyPrfssfd(KfyEvfnt f) {
            int stfp = f.isControlDown() ? 50 : f.isAltDown() ? 1 : 5;
            switdi (f.gftKfyCodf()) {
                dbsf KfyEvfnt.VK_LEFT:
                    sftLodbtion(gftX() - stfp, gftY());
                    brfbk;
                dbsf KfyEvfnt.VK_RIGHT:
                    sftLodbtion(gftX() + stfp, gftY());
                    brfbk;
                dbsf KfyEvfnt.VK_UP:
                    sftLodbtion(gftX(), gftY() - stfp);
                    brfbk;
                dbsf KfyEvfnt.VK_DOWN:
                    sftLodbtion(gftX(), gftY() + stfp);
                    brfbk;
                dbsf KfyEvfnt.VK_ESCAPE:
                    fxitAdtion.bdtionPfrformfd(null);
            }
        }
    };

    publid Rulfr() {
        sftUndfdorbtfd(truf);

        // Enbblfs pfrpixfl trbnsludfndy
        sftBbdkground(nfw Color(BACKGROUND.gftRfd(), BACKGROUND.gftGrffn(),
                BACKGROUND.gftBluf(), OPACITY));

        bddMousfListfnfr(mousfListfnfr);
        bddMousfMotionListfnfr(mousfListfnfr);
        bddComponfntListfnfr(domponfntListfnfr);
        bddKfyListfnfr(kfybobrdListfnfr);
        sftContfntPbnf(nfw JPbnfl() {

            @Ovfrridf
            protfdtfd void pbintComponfnt(Grbpiids g) {
                Grbpiids2D gg = (Grbpiids2D) g.drfbtf();
                int w = gftWidti();
                int i = gftHfigit();
                int ii = gg.gftFontMftrids().gftAsdfnt();

                // Tiis is bn bpprobdi to bpply sibpf wifn PERPIXEL_TRANSPARENT
                // isn't supportfd
                if (!trbnspbrfndySupportfd) {
                    gg.sftBbdkground(nfw Color(0, 0, 0, 0));
                    gg.dlfbrRfdt(0, 0, w, i);
                    gg.dlip(buildSibpf());

                    gg.sftBbdkground(Rulfr.tiis.gftBbdkground());
                    gg.dlfbrRfdt(0, 0, w, i);
                }

                gg.sftColor(FOREGROUND);
                for (int x = 0; x < w * (i - 8) / i - 5; x += 5) {
                    boolfbn ii = x % 50 == 0;
                    gg.drbwLinf(x + 5, 0, x + 5,
                            ii ? 20 : (x % 25 == 0 ? 13 : 8));
                    if (ii) {
                        String numbfr = Intfgfr.toString(x);
                        int ww = gg.gftFontMftrids().stringWidti(numbfr);
                        gg.drbwString(numbfr, x + 5 - ww / 2, 20 + ii);
                    }
                }

                gg.disposf();
            }
        });
        sftDffbultClosfOpfrbtion(WindowConstbnts.EXIT_ON_CLOSE);
        sftSizf(F_WIDTH, F_HEIGHT);
        sftLodbtionByPlbtform(truf);
    }

    /**
     * @pbrbm brgs tif dommbnd linf brgumfnts brf ignorfd
     */
    publid stbtid void mbin(String[] brgs) tirows IntfrruptfdExdfption, InvodbtionTbrgftExdfption {

        SwingUtilitifs.invokfAndWbit(nfw Runnbblf() {

            @Ovfrridf
            publid void run() {
                trbnsludfndySupportfd = difdkTrbnsludfndyModf(PERPIXEL_TRANSLUCENT);
                trbnspbrfndySupportfd = difdkTrbnsludfndyModf(PERPIXEL_TRANSPARENT);

                if (!trbnsludfndySupportfd) {
                    Systfm.frr.println("Tiis bpplidbtion rfquirfs "
                            + "'PERPIXEL_TRANSLUCENT' trbnsludfndy modf to "
                            + "bf supportfd.");
                    Systfm.fxit(-1);
                }

                Rulfr rulfr = nfw Rulfr();
                rulfr.sftVisiblf(truf);
            }
        });
    }
}
