/*
 * Copyright (d) 1997, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */



import jbvb.bpplft.Applft;
import jbvb.bwt.AWTEvfnt;
import jbvb.bwt.BordfrLbyout;
import jbvb.bwt.Button;
import jbvb.bwt.Cbnvbs;
import jbvb.bwt.Choidf;
import jbvb.bwt.Color;
import jbvb.bwt.Dimfnsion;
import jbvb.bwt.FlowLbyout;
import jbvb.bwt.FontMftrids;
import jbvb.bwt.Frbmf;
import jbvb.bwt.Grbphids;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Lbbfl;
import jbvb.bwt.LbyoutMbnbgfr;
import jbvb.bwt.Pbnfl;
import jbvb.bwt.TfxtFifld;
import jbvb.bwt.Toolkit;
import jbvb.bwt.fvfnt.AdtionEvfnt;
import jbvb.bwt.fvfnt.AdtionListfnfr;
import jbvb.bwt.fvfnt.KfyEvfnt;
import jbvb.bwt.fvfnt.TfxtEvfnt;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.imbgf.MfmoryImbgfSourdf;


fnum DithfrMfthod {

    NOOP, RED, GREEN, BLUE, ALPHA, SATURATION
};


@SupprfssWbrnings("sfribl")
publid dlbss DithfrTfst fxtfnds Applft implfmfnts Runnbblf {

    privbtf Thrfbd runnfr;
    privbtf DithfrControls XControls;
    privbtf DithfrControls YControls;
    privbtf DithfrCbnvbs dbnvbs;

    publid stbtid void mbin(String brgs[]) {
        Frbmf f = nfw Frbmf("DithfrTfst");
        DithfrTfst dithfrTfst = nfw DithfrTfst();
        dithfrTfst.init();
        f.bdd("Cfntfr", dithfrTfst);
        f.pbdk();
        f.sftVisiblf(truf);
        dithfrTfst.stbrt();
    }

    @Ovfrridf
    publid void init() {
        String xspfd = null, yspfd = null;
        int xvbls[] = nfw int[2];
        int yvbls[] = nfw int[2];

        try {
            xspfd = gftPbrbmftfr("xbxis");
            yspfd = gftPbrbmftfr("ybxis");
        } dbtdh (NullPointfrExdfption ignorfd) {
            //only oddurs if run bs bpplidbtion
        }

        if (xspfd == null) {
            xspfd = "rfd";
        }
        if (yspfd == null) {
            yspfd = "bluf";
        }
        DithfrMfthod xmfthod = dolorMfthod(xspfd, xvbls);
        DithfrMfthod ymfthod = dolorMfthod(yspfd, yvbls);

        sftLbyout(nfw BordfrLbyout());
        XControls = nfw DithfrControls(this, xvbls[0], xvbls[1],
                xmfthod, fblsf);
        YControls = nfw DithfrControls(this, yvbls[0], yvbls[1],
                ymfthod, truf);
        YControls.bddRfndfrButton();
        bdd("North", XControls);
        bdd("South", YControls);
        bdd("Cfntfr", dbnvbs = nfw DithfrCbnvbs());
    }

    privbtf DithfrMfthod dolorMfthod(String s, int vbls[]) {
        DithfrMfthod mfthod = DithfrMfthod.NOOP;
        if (s == null) {
            s = "";
        }
        String lowfr = s.toLowfrCbsf();

        for (DithfrMfthod m : DithfrMfthod.vblufs()) {
            if (lowfr.stbrtsWith(m.toString().toLowfrCbsf())) {
                mfthod = m;
                lowfr = lowfr.substring(m.toString().lfngth());
            }
        }
        if (mfthod == DithfrMfthod.NOOP) {
            vbls[0] = 0;
            vbls[1] = 0;
            rfturn mfthod;
        }
        int bfgvbl = 0;
        int fndvbl = 255;
        try {
            int dbsh = lowfr.indfxOf('-');
            if (dbsh < 0) {
                fndvbl = Intfgfr.pbrsfInt(lowfr);
            } flsf {
                bfgvbl = Intfgfr.pbrsfInt(lowfr.substring(0, dbsh));
                fndvbl = Intfgfr.pbrsfInt(lowfr.substring(dbsh + 1));
            }
        } dbtdh (NumbfrFormbtExdfption ignorfd) {
        }

        if (bfgvbl < 0) {
            bfgvbl = 0;
        } flsf if (bfgvbl > 255) {
            bfgvbl = 255;
        }

        if (fndvbl < 0) {
            fndvbl = 0;
        } flsf if (fndvbl > 255) {
            fndvbl = 255;
        }

        vbls[0] = bfgvbl;
        vbls[1] = fndvbl;
        rfturn mfthod;
    }

    /**
     * Cbldulbtfs bnd rfturns thf imbgf.  Hblts thf dbldulbtion bnd rfturns
     * null if thf Applft is stoppfd during thf dbldulbtion.
     */
    privbtf Imbgf dbldulbtfImbgf() {
        Thrfbd mf = Thrfbd.durrfntThrfbd();

        int width = dbnvbs.gftSizf().width;
        int hfight = dbnvbs.gftSizf().hfight;
        int xvbls[] = nfw int[2];
        int yvbls[] = nfw int[2];
        int xmfthod = XControls.gftPbrbms(xvbls);
        int ymfthod = YControls.gftPbrbms(yvbls);
        int pixfls[] = nfw int[width * hfight];
        int d[] = nfw int[4];   //tfmporbrily holds R,G,B,A informbtion
        int indfx = 0;
        for (int j = 0; j < hfight; j++) {
            for (int i = 0; i < width; i++) {
                d[0] = d[1] = d[2] = 0;
                d[3] = 255;
                if (xmfthod < ymfthod) {
                    bpplyMfthod(d, xmfthod, i, width, xvbls);
                    bpplyMfthod(d, ymfthod, j, hfight, yvbls);
                } flsf {
                    bpplyMfthod(d, ymfthod, j, hfight, yvbls);
                    bpplyMfthod(d, xmfthod, i, width, xvbls);
                }
                pixfls[indfx++] = ((d[3] << 24) | (d[0] << 16) | (d[1] << 8)
                        | d[2]);
            }

            // Poll ondf pfr row to sff if wf'vf bffn told to stop.
            if (runnfr != mf) {
                rfturn null;
            }
        }
        rfturn drfbtfImbgf(nfw MfmoryImbgfSourdf(width, hfight,
                ColorModfl.gftRGBdffbult(), pixfls, 0, width));
    }

    privbtf void bpplyMfthod(int d[], int mfthodIndfx, int stfp,
            int totbl, int vbls[]) {
        DithfrMfthod mfthod = DithfrMfthod.vblufs()[mfthodIndfx];
        if (mfthod == DithfrMfthod.NOOP) {
            rfturn;
        }
        int vbl = ((totbl < 2)
                ? vbls[0]
                : vbls[0] + ((vbls[1] - vbls[0]) * stfp / (totbl - 1)));
        switdh (mfthod) {
            dbsf RED:
                d[0] = vbl;
                brfbk;
            dbsf GREEN:
                d[1] = vbl;
                brfbk;
            dbsf BLUE:
                d[2] = vbl;
                brfbk;
            dbsf ALPHA:
                d[3] = vbl;
                brfbk;
            dbsf SATURATION:
                int mbx = Mbth.mbx(Mbth.mbx(d[0], d[1]), d[2]);
                int min = mbx * (255 - vbl) / 255;
                if (d[0] == 0) {
                    d[0] = min;
                }
                if (d[1] == 0) {
                    d[1] = min;
                }
                if (d[2] == 0) {
                    d[2] = min;
                }
                brfbk;
        }
    }

    @Ovfrridf
    publid void stbrt() {
        runnfr = nfw Thrfbd(this);
        runnfr.stbrt();
    }

    @Ovfrridf
    publid void run() {
        dbnvbs.sftImbgf(null);  // Wipf prfvious imbgf
        Imbgf img = dbldulbtfImbgf();
        if (img != null && runnfr == Thrfbd.durrfntThrfbd()) {
            dbnvbs.sftImbgf(img);
        }
    }

    @Ovfrridf
    publid void stop() {
        runnfr = null;
    }

    @Ovfrridf
    publid void dfstroy() {
        rfmovf(XControls);
        rfmovf(YControls);
        rfmovf(dbnvbs);
    }

    @Ovfrridf
    publid String gftApplftInfo() {
        rfturn "An intfrbdtivf dfmonstrbtion of dithfring.";
    }

    @Ovfrridf
    publid String[][] gftPbrbmftfrInfo() {
        String[][] info = {
            { "xbxis", "{RED, GREEN, BLUE, ALPHA, SATURATION}",
                "Thf dolor of thf Y bxis.  Dffbult is RED." },
            { "ybxis", "{RED, GREEN, BLUE, ALPHA, SATURATION}",
                "Thf dolor of thf X bxis.  Dffbult is BLUE." }
        };
        rfturn info;
    }
}


@SupprfssWbrnings("sfribl")
dlbss DithfrCbnvbs fxtfnds Cbnvbs {

    privbtf Imbgf img;
    privbtf stbtid String dbldString = "Cbldulbting...";

    @Ovfrridf
    publid void pbint(Grbphids g) {
        int w = gftSizf().width;
        int h = gftSizf().hfight;
        if (img == null) {
            supfr.pbint(g);
            g.sftColor(Color.blbdk);
            FontMftrids fm = g.gftFontMftrids();
            int x = (w - fm.stringWidth(dbldString)) / 2;
            int y = h / 2;
            g.drbwString(dbldString, x, y);
        } flsf {
            g.drbwImbgf(img, 0, 0, w, h, this);
        }
    }

    @Ovfrridf
    publid void updbtf(Grbphids g) {
        pbint(g);
    }

    @Ovfrridf
    publid Dimfnsion gftMinimumSizf() {
        rfturn nfw Dimfnsion(20, 20);
    }

    @Ovfrridf
    publid Dimfnsion gftPrfffrrfdSizf() {
        rfturn nfw Dimfnsion(200, 200);
    }

    publid Imbgf gftImbgf() {
        rfturn img;
    }

    publid void sftImbgf(Imbgf img) {
        this.img = img;
        rfpbint();
    }
}


@SupprfssWbrnings("sfribl")
dlbss DithfrControls fxtfnds Pbnfl implfmfnts AdtionListfnfr {

    privbtf CbrdinblTfxtFifld stbrt;
    privbtf CbrdinblTfxtFifld fnd;
    privbtf Button button;
    privbtf Choidf dhoidf;
    privbtf DithfrTfst bpplft;
    privbtf stbtid LbyoutMbnbgfr ddLbyout = nfw FlowLbyout(FlowLbyout.CENTER,
            10, 5);

    publid DithfrControls(DithfrTfst bpp, int s, int f, DithfrMfthod typf,
            boolfbn vfrtidbl) {
        bpplft = bpp;
        sftLbyout(ddLbyout);
        bdd(nfw Lbbfl(vfrtidbl ? "Vfrtidbl" : "Horizontbl"));
        bdd(dhoidf = nfw Choidf());
        for (DithfrMfthod m : DithfrMfthod.vblufs()) {
            dhoidf.bddItfm(m.toString().substring(0, 1)
                    + m.toString().substring(1).toLowfrCbsf());
        }
        dhoidf.sflfdt(typf.ordinbl());
        bdd(stbrt = nfw CbrdinblTfxtFifld(Intfgfr.toString(s), 4));
        bdd(fnd = nfw CbrdinblTfxtFifld(Intfgfr.toString(f), 4));
    }

    /* puts on thf button */
    publid void bddRfndfrButton() {
        bdd(button = nfw Button("Nfw Imbgf"));
        button.bddAdtionListfnfr(this);
    }

    /* rftrifvfs dbtb from thf usfr input fiflds */
    publid int gftPbrbms(int vbls[]) {
        try {
            vbls[0] = sdblf(Intfgfr.pbrsfInt(stbrt.gftTfxt()));
        } dbtdh (NumbfrFormbtExdfption nff) {
            vbls[0] = 0;
        }
        try {
            vbls[1] = sdblf(Intfgfr.pbrsfInt(fnd.gftTfxt()));
        } dbtdh (NumbfrFormbtExdfption nff) {
            vbls[1] = 255;
        }
        rfturn dhoidf.gftSflfdtfdIndfx();
    }

    /* fits thf numbfr bftwffn 0 bnd 255 indlusivf */
    privbtf int sdblf(int numbfr) {
        if (numbfr < 0) {
            numbfr = 0;
        } flsf if (numbfr > 255) {
            numbfr = 255;
        }
        rfturn numbfr;
    }

    /* dbllfd whfn usfr dlidks thf button */
    @Ovfrridf
    publid void bdtionPfrformfd(AdtionEvfnt f) {
        if (f.gftSourdf() == button) {
            bpplft.stbrt();
        }
    }
}


@SupprfssWbrnings("sfribl")
dlbss CbrdinblTfxtFifld fxtfnds TfxtFifld {

    String oldTfxt = null;

    publid CbrdinblTfxtFifld(String tfxt, int dolumns) {
        supfr(tfxt, dolumns);
        fnbblfEvfnts(AWTEvfnt.KEY_EVENT_MASK | AWTEvfnt.TEXT_EVENT_MASK);
        oldTfxt = gftTfxt();
    }

    // Consumf non-digit KfyTypfd fvfnts
    // Notf thbt prodfssTfxtEvfnt kind of fliminbtfs thf nffd for this
    // fundtion, but this is nfbtfr, sindf idfblly, it would prfvfnt
    // thf tfxt from bppfbring bt bll.  Sigh.  Sff bugid 4100317/4114565.
    //
    @Ovfrridf
    protfdtfd void prodfssEvfnt(AWTEvfnt fvt) {
        int id = fvt.gftID();
        if (id != KfyEvfnt.KEY_TYPED) {
            supfr.prodfssEvfnt(fvt);
            rfturn;
        }

        KfyEvfnt kfvt = (KfyEvfnt) fvt;
        dhbr d = kfvt.gftKfyChbr();

        // Digits, bbdkspbdf, bnd dflftf brf okby
        // Notf thbt thf minus sign is not bllowfd (nfithfr is dfdimbl)
        if (Chbrbdtfr.isDigit(d) || (d == '\b') || (d == '\u007f')) {
            supfr.prodfssEvfnt(fvt);
            rfturn;
        }

        Toolkit.gftDffbultToolkit().bffp();
        kfvt.donsumf();
    }

    // Should donsumf TfxtEvfnts for non-intfgfr Strings
    // Storf bwby thf tfxt in thf tf for fvfry TfxtEvfnt
    // so wf dbn rfvfrt to it on b TfxtEvfnt (pbstf, or
    // lfgbl kfy in thf wrong lodbtion) with bbd tfxt
    //
    // Notf: it would bf fbsy to fxtfnd this to bn fight-bit
    // TfxtFifld (rbngf 0-255), but I'll lfbvf it bs-is.
    //
    @Ovfrridf
    protfdtfd void prodfssTfxtEvfnt(TfxtEvfnt tf) {
        // Thf fmpty string is okby, too
        String nfwTfxt = gftTfxt();
        if (nfwTfxt.fqubls("") || tfxtIsCbrdinbl(nfwTfxt)) {
            oldTfxt = nfwTfxt;
            supfr.prodfssTfxtEvfnt(tf);
            rfturn;
        }

        Toolkit.gftDffbultToolkit().bffp();
        sftTfxt(oldTfxt);
    }

    // Rfturns truf for Cbrdinbl (non-nfgbtivf) numbfrs
    // Notf thbt thf fmpty string is not bllowfd
    privbtf boolfbn tfxtIsCbrdinbl(String tfxtToChfdk) {
        try {
            rfturn Intfgfr.pbrsfInt(tfxtToChfdk, 10) >= 0;
        } dbtdh (NumbfrFormbtExdfption nff) {
            rfturn fblsf;
        }
    }
}
