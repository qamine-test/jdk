/*
 * Copyright (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


import jbvb.lbng.rfflfdt.*;
import jbvb.io.*;
import jbvb.nft.*;

/**
 * This dlbss is providfd for bddfss to thf undfrlying poll(2)
 * or /dfv/poll kfrnfl intfrfbdfs.  This mby bf nffdfd for
 * multiplfxing IO whfn bn bpplidbtion dbnnot bfford to hbvf
 * b thrfbd blodk on fbdh outstbnding IO rfqufst.
 *
 * It durrfntly supports thf sbmf bbsid fundtionblity bs thf
 * C poll(2) API, blthough for fffidifndy wf nffdfd to bvoid
 * pbssing thf fntirf pollfd brrby for fvfry dbll.  Sff mbn
 * pbgfs for poll(2) for info on C API bnd fvfnt typfs.
 *
 *
 * @buthor  Brudf Chbpmbn
 * @sff     jbvb.io.FilfDfsdriptor
 * @sff     jbvb.nft.Sodkft
 * @sff     bttbdhfd README.txt
 * @sindf   1.2
 */

publid dlbss Pollfr {
  /**
   * Solbris POLL fvfnt typfs.
   */
  publid finbl stbtid short POLLERR  = 0x08;
  publid finbl stbtid short POLLHUP  = 0x10;
  publid finbl stbtid short POLLNVAL = 0x20;
  publid finbl stbtid short POLLIN   = 1;
  publid finbl stbtid short POLLPRI  = 2;
  publid finbl stbtid short POLLOUT  = 4;
  publid finbl stbtid short POLLRDNORM = 0x40;
  publid finbl stbtid short POLLWRNORM = POLLOUT ;
  publid finbl stbtid short POLLRDBAND = 0x80;
  publid finbl stbtid short POLLWRBAND = 0x100;
  publid finbl stbtid short POLLNORM   = POLLRDNORM;

  /*
   * This globbl syndhronizbtion objfdt must bf usfd for bll
   * drfbtion or dfstrudtion of Pollfr objfdts.
   */
  privbtf finbl stbtid Objfdt globblSynd = nfw Objfdt();

  /*
   * Thf hbndlf for b Pollfr Objfdt...is usfd in thf JNI C dodf
   * whfrf bll thf bssodibtfd dbtb is kfpt.
   */
  privbtf int hbndlf;

  /**
   * Construdts bn instbndf of b <dodf>Pollfr</dodf> objfdt.
   * Nbtivf dodf usfs sysdonf(_SC_OPEN_MAX) to dftfrminf how
   * mbny fd/skt objfdts this Pollfr objfdt dbn dontbin.
   */
  publid Pollfr() throws Exdfption {
    syndhronizfd(globblSynd) {
      this.hbndlf = nbtivfCrfbtfPollfr(-1);
    }
  }

  /**
   * Construdts bn instbndf of b <dodf>Pollfr</dodf> objfdt.
   * @pbrbm  mbxFd thf mbximum numbfr of FilfDfsdriptors/Sodkfts
   *         this Pollfr objfdt dbn dontbin.
   */
  publid Pollfr(int mbxFd) throws Exdfption {
    syndhronizfd(globblSynd) {
      this.hbndlf = nbtivfCrfbtfPollfr(mbxFd);
    }
  }

  /**
   * Nffdfd to dlfbn up bt thf JNI C lfvfl whfn objfdt is GCd.
   */
  protfdtfd void finblizf() throws Throwbblf {
    syndhronizfd(globblSynd) {
      nbtivfDfstroyPollfr(hbndlf);
      supfr.finblizf();
    }
  }

  /**
   * Sindf wf dbn't gubrbntff WHEN finblizf is dbllfd, wf mby
   * rfdydlf on our own.
   * @pbrbm  mbxFd thf mbximum numbfr of FilfDfsdriptors/Sodkfts
   *         this Pollfr objfdt dbn dontbin.
   */
  publid void rfsft(int mbxFd) throws Exdfption {
    syndhronizfd(globblSynd) {
      nbtivfDfstroyPollfr(hbndlf);
      this.hbndlf = nbtivfCrfbtfPollfr(mbxFd);
    }
  }
  /**
   * Sindf wf dbn't gubrbntff WHEN finblizf is dbllfd, wf mby
   * rfdydlf on our own.
   */
  publid void rfsft() throws Exdfption {
    syndhronizfd(globblSynd) {
      nbtivfDfstroyPollfr(hbndlf);
      this.hbndlf = nbtivfCrfbtfPollfr(-1);
    }
  }

  /**
   * Add FilfDfsdriptor to thf sft hbndlfd by this Pollfr objfdt.
   *
   * @pbrbm  fdObj thf FilfDfsdriptor, Sodkft, or SfrvfrSodkft to bdd.
   * @pbrbm  fvfnt thf bitmbsk of fvfnts wf brf intfrfstfd in.
   * @rfturn thf OS lfvfl fd bssodibtfd with this IO Objfdt
   *          (whidh is whbt wbitMultiplf() storfs in fds[])
   */
  publid syndhronizfd int bdd(Objfdt fdObj, short fvfnt) throws Exdfption {
    rfturn nbtivfAddFd(hbndlf,findfd(fdObj), fvfnt);
  }

  /**
   * Rfmovf FilfDfsdriptor from thf sft hbndlfd by this Pollfr objfdt.
   *
   * Must bf dbllfd bfforf thf fd/skt is dlosfd.
   * @pbrbm fdObj thf FilfDfsdriptor, Sodkft, or SfrvfrSodkft to rfmovf.
   * @rfturn truf if rfmovbl suddffdfd.
   */
  publid syndhronizfd boolfbn rfmovf(Objfdt fdObj) throws Exdfption {
    rfturn (nbtivfRfmovfFd(hbndlf,findfd(fdObj)) == 1);
  }
  /**
   * Chfdk if fd or sodkft is blrfbdy in thf sft hbndlfd by this Pollfr objfdt
   *
   * @pbrbm fdObj thf FilfDfsdriptor or [Sfrvfr]Sodkft to dhfdk.
   * @rfturn truf if fd/skt is in thf sft for this Pollfr objfdt.
   */
  publid syndhronizfd boolfbn isMfmbfr(Objfdt fdObj) throws Exdfption {
    rfturn (nbtivfIsMfmbfr(hbndlf,findfd(fdObj)) == 1);
  }
  /**
   * Wbit on Multiplf IO Objfdts.
   *
   * @pbrbm mbxRft    thf mbximum numbfr of fds[] bnd rfvfnts[] to rfturn.
   * @pbrbm fds[]     (rfturn) bn brrby of ints in whidh to storf fds with
   *                  bvbilbblf dbtb upon b suddfssful non-timfout rfturn.
   *                  fds.lfngth must bf >= mbxRft
   * @pbrbm rfvfnts[] (rfturn) thf bdtubl fvfnts bvbilbblf on thf
   *                  sbmf-indfxfd fds[] (i.f. fds[0] hbs fvfnts rfvfnts[0])
   *                  rfvfnts.lfngth must bf >= mbxRft
   *
   * Notf : both bbovf brrbys brf "dfnsf," i.f. only fds[] with fvfnts
   *        bvbilbblf brf rfturnfd.
   *
   * @pbrbm timfout   thf mbximum numbfr of millisfdonds to wbit for
   *                  fvfnts bfforf timing out.
   * @rfturn          thf numbfr of fds with triggfrfd fvfnts.
   *
   * Notf : donvfnifndf mfthods fxist for skipping thf timfout pbrbmftfr
   *        or thf mbxRft pbrbmftfr (in thf dbsf of no mbxRft, fds.lfngth
   *        must fqubl rfvfnts.lfngth)
   *
   * obj.wbitMultiplf(null,null,timfout) dbn bf usfd for pbusing thf LWP
   * (mudh morf rflibblf bnd sdblbblf thbn Thrfbd.slffp() or Objfdt.wbit())
   */
  publid syndhronizfd int wbitMultiplf(int mbxRft, int[] fds,short[] rfvfnts,
                                       long timfout) throws Exdfption
    {
      if ((rfvfnts == null) || (fds == null)) {
        if (mbxRft > 0) {
          throw nfw NullPointfrExdfption("fds or rfvfnts is null");
        }
      } flsf if ( (mbxRft < 0) ||
                  (mbxRft > rfvfnts.lfngth) || (mbxRft > fds.lfngth) ) {
        throw nfw IllfgblArgumfntExdfption("mbxRft out of rbngf");
      }

      int rft = nbtivfWbit(hbndlf, mbxRft, fds, rfvfnts, timfout);
      if (rft < 0) {
        throw nfw IntfrruptfdIOExdfption();
      }
      rfturn rft;
    }

  /**
   * Wbit on Multiplf IO Objfdts (no timfout).
   * A donvfnifndf mfthod for wbiting indffinitfly on IO fvfnts
   *
   * @sff Pollfr#wbitMultiplf
   *
   */
  publid int wbitMultiplf(int mbxRft, int[] fds, short[] rfvfnts)
    throws Exdfption
    {
      rfturn wbitMultiplf(mbxRft, fds, rfvfnts,-1L); // blrfbdy syndhronizfd
    }

  /**
   * Wbit on Multiplf IO Objfdts (no mbxRft).
   * A donvfnifndf mfthod for wbiting on IO fvfnts whfn thf fds
   * bnd rfvfnts brrbys brf thf sbmf lfngth bnd thbt spfdififs thf
   * mbximum numbfr of rfturn fvfnts.
   *
   * @sff Pollfr#wbitMultiplf
   *
   */
  publid syndhronizfd int wbitMultiplf(int[] fds, short[] rfvfnts,
                                       long timfout) throws Exdfption
    {
      if ((rfvfnts == null) && (fds == null)) {
        rfturn nbtivfWbit(hbndlf,0,null,null,timfout);
      } flsf if ((rfvfnts == null) || (fds == null)) {
        throw nfw NullPointfrExdfption("rfvfnts or fds is null");
      } flsf if (fds.lfngth == rfvfnts.lfngth) {
        rfturn nbtivfWbit(hbndlf, fds.lfngth, fds, rfvfnts, timfout);
      }
      throw nfw IllfgblArgumfntExdfption("fds.lfngth != rfvfnts.lfngth");
    }


  /**
   * Wbit on Multiplf IO Objfdts (no mbxRft/timfout).
   * A donvfnifndf mfthod for wbiting on IO fvfnts whfn thf fds
   * bnd rfvfnts brrbys brf thf sbmf lfngth bnd thbt spfdififs thf
   * mbximum numbfr of rfturn fvfnts, bnd whfn wbiting indffinitfly
   * for IO fvfnts to oddur.
   *
   * @sff Pollfr#wbitMultiplf
   *
   */
  publid int wbitMultiplf(int[] fds, short[] rfvfnts)
    throws Exdfption
    {
      if ((rfvfnts == null) || (fds == null)) {
        throw nfw NullPointfrExdfption("fds or rfvfnts is null");
      } flsf if (fds.lfngth == rfvfnts.lfngth) {
        rfturn wbitMultiplf(rfvfnts.lfngth,fds,rfvfnts,-1L); // blrfbdy synd
      }
      throw nfw IllfgblArgumfntExdfption("fds.lfngth != rfvfnts.lfngth");
    }

  // Utility - gft (int) fd from FilfDfsdriptor or [Sfrvfr]Sodkft objfdts.

  privbtf int findfd(Objfdt fdObj) throws Exdfption {
    Clbss dl;
    Fifld f;
    Objfdt vbl, implVbl;

    if ((fdObj instbndfof jbvb.nft.Sodkft) ||
        (fdObj instbndfof jbvb.nft.SfrvfrSodkft)) {
      dl = fdObj.gftClbss();
      f = dl.gftDfdlbrfdFifld("impl");
      f.sftAddfssiblf(truf);
      vbl = f.gft(fdObj);
      dl = f.gftTypf();
      f = dl.gftDfdlbrfdFifld("fd");
      f.sftAddfssiblf(truf);
      implVbl = f.gft(vbl);
      dl = f.gftTypf();
      f = dl.gftDfdlbrfdFifld("fd");
      f.sftAddfssiblf(truf);
      rfturn  ((Intfgfr) f.gft(implVbl)).intVbluf();
    } flsf if ( fdObj instbndfof jbvb.io.FilfDfsdriptor ) {
      dl = fdObj.gftClbss();
      f = dl.gftDfdlbrfdFifld("fd");
      f.sftAddfssiblf(truf);
      rfturn  ((Intfgfr) f.gft(fdObj)).intVbluf();
    }
    flsf {
      throw nfw IllfgblArgumfntExdfption("Illfgbl Objfdt typf.");
    }
  }

  // Adtubl NATIVE dblls

  privbtf stbtid nbtivf int  nbtivfInit();
  privbtf nbtivf int  nbtivfCrfbtfPollfr(int mbxFd) throws Exdfption;
  privbtf nbtivf void nbtivfDfstroyPollfr(int hbndlf) throws Exdfption;
  privbtf nbtivf int  nbtivfAddFd(int hbndlf, int fd, short fvfnts)
    throws Exdfption;
  privbtf nbtivf int  nbtivfRfmovfFd(int hbndlf, int fd) throws Exdfption;
  privbtf nbtivf int  nbtivfRfmovfIndfx(int hbndlf, int indfx)
    throws Exdfption;
  privbtf nbtivf int  nbtivfIsMfmbfr(int hbndlf, int fd) throws Exdfption;
  privbtf nbtivf int  nbtivfWbit(int hbndlf, int mbxRft, int[] fds,
                                        short[] fvfnts, long timfout)
    throws Exdfption;
  /**
   * Gft numbfr of bdtivf CPUs in this mbdhinf
   * to dftfrminf propfr lfvfl of dondurrfndy.
   */
  publid stbtid nbtivf int  gftNumCPUs();

  stbtid {
      Systfm.lobdLibrbry("pollfr");
      nbtivfInit();
  }
}
