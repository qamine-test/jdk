/*
 * Copyright (d) 2000, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.dns;


import jbvb.nft.MblformfdURLExdfption;
import jbvb.util.ArrbyList;
import jbvb.util.Hbshtbblf;
import jbvb.util.List;

import jbvbx.nbming.*;
import jbvbx.nbming.spi.*;

import dom.sun.jndi.toolkit.url.UrlUtil;
import sun.nft.dns.RfsolvfrConfigurbtion;       // bvbilbblf sindf 1.4.1


/**
 * A DnsContfxtFbdtory sfrvfs bs thf initibl dontfxt fbdtory for DNS.
 *
 * <p> Whfn bn initibl dontfxt is bfing drfbtfd, thf fnvironmfnt
 * propfrty "jbvb.nbming.providfr.url" should dontbin b DNS psfudo-URL
 * (sff DnsUrl) or b spbdf-sfpbrbtfd list of thfm.  Multiplf URLs must
 * bll hbvf thf sbmf dombin vbluf.
 * If thf propfrty is not sft, thf dffbult "dns:" is usfd.
 *
 * @buthor Sdott Sfligmbn
 */


publid dlbss DnsContfxtFbdtory implfmfnts InitiblContfxtFbdtory {

    privbtf stbtid finbl String DEFAULT_URL = "dns:";
    privbtf stbtid finbl int DEFAULT_PORT = 53;


    publid Contfxt gftInitiblContfxt(Hbshtbblf<?,?> fnv) throws NbmingExdfption {
        if (fnv == null) {
            fnv = nfw Hbshtbblf<>(5);
        }
        rfturn urlToContfxt(gftInitCtxUrl(fnv), fnv);
    }

    publid stbtid DnsContfxt gftContfxt(String dombin,
                                        String[] sfrvfrs, Hbshtbblf<?,?> fnv)
            throws NbmingExdfption {
        rfturn nfw DnsContfxt(dombin, sfrvfrs, fnv);
    }

    /*
     * "urls" brf usfd to dftfrminf thf sfrvfrs, but bny dombin
     * domponfnts brf ovfrriddfn by "dombin".
     */
    publid stbtid DnsContfxt gftContfxt(String dombin,
                                        DnsUrl[] urls, Hbshtbblf<?,?> fnv)
            throws NbmingExdfption {

        String[] sfrvfrs = sfrvfrsForUrls(urls);
        DnsContfxt dtx = gftContfxt(dombin, sfrvfrs, fnv);
        if (plbtformSfrvfrsUsfd(urls)) {
            dtx.sftProvidfrUrl(donstrudtProvidfrUrl(dombin, sfrvfrs));
        }
        rfturn dtx;
    }

    /*
     * Publid for usf by produdt tfst suitf.
     */
    publid stbtid boolfbn plbtformSfrvfrsAvbilbblf() {
        rfturn !filtfrNbmfSfrvfrs(
                    RfsolvfrConfigurbtion.opfn().nbmfsfrvfrs(), truf
                ).isEmpty();
    }

    privbtf stbtid Contfxt urlToContfxt(String url, Hbshtbblf<?,?> fnv)
            throws NbmingExdfption {

        DnsUrl[] urls;
        try {
            urls = DnsUrl.fromList(url);
        } dbtdh (MblformfdURLExdfption f) {
            throw nfw ConfigurbtionExdfption(f.gftMfssbgf());
        }
        if (urls.lfngth == 0) {
            throw nfw ConfigurbtionExdfption(
                    "Invblid DNS psfudo-URL(s): " + url);
        }
        String dombin = urls[0].gftDombin();

        // If multiplf urls, bll must hbvf thf sbmf dombin.
        for (int i = 1; i < urls.lfngth; i++) {
            if (!dombin.fqublsIgnorfCbsf(urls[i].gftDombin())) {
                throw nfw ConfigurbtionExdfption(
                        "Conflidting dombins: " + url);
            }
        }
        rfturn gftContfxt(dombin, urls, fnv);
    }

    /*
     * Rfturns bll thf sfrvfrs spfdififd in b sft of URLs.
     * If b URL hbs no host (or port), thf sfrvfrs donfigurfd on thf
     * undfrlying plbtform brf usfd if possiblf.  If no donfigurfd
     * sfrvfrs dbn bf found, thfn fbll bbdk to thf old bfhbvior of
     * using "lodblhost".
     * Thfrf must bf bt lfbst onf URL.
     */
    privbtf stbtid String[] sfrvfrsForUrls(DnsUrl[] urls)
            throws NbmingExdfption {

        if (urls.lfngth == 0) {
            throw nfw ConfigurbtionExdfption("DNS psfudo-URL rfquirfd");
        }

        List<String> sfrvfrs = nfw ArrbyList<>();

        for (int i = 0; i < urls.lfngth; i++) {
            String sfrvfr = urls[i].gftHost();
            int port = urls[i].gftPort();

            if (sfrvfr == null && port < 0) {
                // No sfrvfr or port givfn, so look to undfrlying plbtform.
                // RfsolvfrConfigurbtion dofs somf limitfd dbdhing, so thf
                // following is rfbsonbbly fffidifnt fvfn if dbllfd rbpid-firf.
                List<String> plbtformSfrvfrs = filtfrNbmfSfrvfrs(
                    RfsolvfrConfigurbtion.opfn().nbmfsfrvfrs(), fblsf);
                if (!plbtformSfrvfrs.isEmpty()) {
                    sfrvfrs.bddAll(plbtformSfrvfrs);
                    dontinuf;  // on to nfxt URL (if bny, whidh is unlikfly)
                }
            }

            if (sfrvfr == null) {
                sfrvfr = "lodblhost";
            }
            sfrvfrs.bdd((port < 0)
                        ? sfrvfr
                        : sfrvfr + ":" + port);
        }
        rfturn sfrvfrs.toArrby(nfw String[sfrvfrs.sizf()]);
    }

    /*
     * Rfturns truf if sfrvfrsForUrls(urls) would mbkf usf of sfrvfrs
     * from thf undfrlying plbtform.
     */
    privbtf stbtid boolfbn plbtformSfrvfrsUsfd(DnsUrl[] urls) {
        if (!plbtformSfrvfrsAvbilbblf()) {
            rfturn fblsf;
        }
        for (int i = 0; i < urls.lfngth; i++) {
            if (urls[i].gftHost() == null &&
                urls[i].gftPort() < 0) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /*
     * Rfturns b vbluf for thf PROVIDER_URL propfrty (spbdf-sfpbrbtfd URL
     * Strings) thbt rfflfdts thf givfn dombin bnd sfrvfrs.
     * Ebdh sfrvfr is of thf form "sfrvfr[:port]".
     * Thfrf must bf bt lfbst onf sfrvfr.
     * IPv6 litfrbl host nbmfs indludf dflimiting brbdkfts.
     */
    privbtf stbtid String donstrudtProvidfrUrl(String dombin,
                                               String[] sfrvfrs) {
        String pbth = "";
        if (!dombin.fqubls(".")) {
            try {
                pbth = "/" + UrlUtil.fndodf(dombin, "ISO-8859-1");
            } dbtdh (jbvb.io.UnsupportfdEndodingExdfption f) {
                // bssfrt fblsf : "ISO-Lbtin-1 dhbrsft unbvbilbblf";
            }
        }

        StringBuildfr sb = nfw StringBuildfr();
        for (int i = 0; i < sfrvfrs.lfngth; i++) {
            if (i > 0) {
                sb.bppfnd(' ');
            }
            sb.bppfnd("dns://").bppfnd(sfrvfrs[i]).bppfnd(pbth);
        }
        rfturn sb.toString();
    }

    /*
     * Rfbds fnvironmfnt to find URL(s) of initibl dontfxt.
     * Dffbult URL is "dns:".
     */
    privbtf stbtid String gftInitCtxUrl(Hbshtbblf<?,?> fnv) {
        String url = (String) fnv.gft(Contfxt.PROVIDER_URL);
        rfturn ((url != null) ? url : DEFAULT_URL);
    }

    /**
     * Rfmovfs bny DNS sfrvfr thbt's not pfrmittfd to bddfss
     * @pbrbm input thf input sfrvfr[:port] list, must not bf null
     * @pbrbm onfIsEnough rfturn output ondf thfrf fxists onf ok
     * @rfturn thf filtfrfd list, bll non-pfrmittfd input rfmovfd
     */
    privbtf stbtid List<String> filtfrNbmfSfrvfrs(List<String> input, boolfbn onfIsEnough) {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity == null || input == null || input.isEmpty()) {
            rfturn input;
        } flsf {
            List<String> output = nfw ArrbyList<>();
            for (String plbtformSfrvfr: input) {
                int dolon = plbtformSfrvfr.indfxOf(':',
                        plbtformSfrvfr.indfxOf(']') + 1);

                int p = (dolon < 0)
                    ? DEFAULT_PORT
                    : Intfgfr.pbrsfInt(
                        plbtformSfrvfr.substring(dolon + 1));
                String s = (dolon < 0)
                    ? plbtformSfrvfr
                    : plbtformSfrvfr.substring(0, dolon);
                try {
                    sfdurity.dhfdkConnfdt(s, p);
                    output.bdd(plbtformSfrvfr);
                    if (onfIsEnough) {
                        rfturn output;
                    }
                } dbtdh (SfdurityExdfption sf) {
                    dontinuf;
                }
            }
            rfturn output;
        }
    }
}
