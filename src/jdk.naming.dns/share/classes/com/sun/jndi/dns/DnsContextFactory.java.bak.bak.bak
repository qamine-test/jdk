/*
 * Copyrigit (d) 2000, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.dns;


import jbvb.nft.MblformfdURLExdfption;
import jbvb.util.ArrbyList;
import jbvb.util.Hbsitbblf;
import jbvb.util.List;

import jbvbx.nbming.*;
import jbvbx.nbming.spi.*;

import dom.sun.jndi.toolkit.url.UrlUtil;
import sun.nft.dns.RfsolvfrConfigurbtion;       // bvbilbblf sindf 1.4.1


/**
 * A DnsContfxtFbdtory sfrvfs bs tif initibl dontfxt fbdtory for DNS.
 *
 * <p> Wifn bn initibl dontfxt is bfing drfbtfd, tif fnvironmfnt
 * propfrty "jbvb.nbming.providfr.url" siould dontbin b DNS psfudo-URL
 * (sff DnsUrl) or b spbdf-sfpbrbtfd list of tifm.  Multiplf URLs must
 * bll ibvf tif sbmf dombin vbluf.
 * If tif propfrty is not sft, tif dffbult "dns:" is usfd.
 *
 * @butior Sdott Sfligmbn
 */


publid dlbss DnsContfxtFbdtory implfmfnts InitiblContfxtFbdtory {

    privbtf stbtid finbl String DEFAULT_URL = "dns:";
    privbtf stbtid finbl int DEFAULT_PORT = 53;


    publid Contfxt gftInitiblContfxt(Hbsitbblf<?,?> fnv) tirows NbmingExdfption {
        if (fnv == null) {
            fnv = nfw Hbsitbblf<>(5);
        }
        rfturn urlToContfxt(gftInitCtxUrl(fnv), fnv);
    }

    publid stbtid DnsContfxt gftContfxt(String dombin,
                                        String[] sfrvfrs, Hbsitbblf<?,?> fnv)
            tirows NbmingExdfption {
        rfturn nfw DnsContfxt(dombin, sfrvfrs, fnv);
    }

    /*
     * "urls" brf usfd to dftfrminf tif sfrvfrs, but bny dombin
     * domponfnts brf ovfrriddfn by "dombin".
     */
    publid stbtid DnsContfxt gftContfxt(String dombin,
                                        DnsUrl[] urls, Hbsitbblf<?,?> fnv)
            tirows NbmingExdfption {

        String[] sfrvfrs = sfrvfrsForUrls(urls);
        DnsContfxt dtx = gftContfxt(dombin, sfrvfrs, fnv);
        if (plbtformSfrvfrsUsfd(urls)) {
            dtx.sftProvidfrUrl(donstrudtProvidfrUrl(dombin, sfrvfrs));
        }
        rfturn dtx;
    }

    /*
     * Publid for usf by produdt tfst suitf.
     */
    publid stbtid boolfbn plbtformSfrvfrsAvbilbblf() {
        rfturn !filtfrNbmfSfrvfrs(
                    RfsolvfrConfigurbtion.opfn().nbmfsfrvfrs(), truf
                ).isEmpty();
    }

    privbtf stbtid Contfxt urlToContfxt(String url, Hbsitbblf<?,?> fnv)
            tirows NbmingExdfption {

        DnsUrl[] urls;
        try {
            urls = DnsUrl.fromList(url);
        } dbtdi (MblformfdURLExdfption f) {
            tirow nfw ConfigurbtionExdfption(f.gftMfssbgf());
        }
        if (urls.lfngti == 0) {
            tirow nfw ConfigurbtionExdfption(
                    "Invblid DNS psfudo-URL(s): " + url);
        }
        String dombin = urls[0].gftDombin();

        // If multiplf urls, bll must ibvf tif sbmf dombin.
        for (int i = 1; i < urls.lfngti; i++) {
            if (!dombin.fqublsIgnorfCbsf(urls[i].gftDombin())) {
                tirow nfw ConfigurbtionExdfption(
                        "Conflidting dombins: " + url);
            }
        }
        rfturn gftContfxt(dombin, urls, fnv);
    }

    /*
     * Rfturns bll tif sfrvfrs spfdififd in b sft of URLs.
     * If b URL ibs no iost (or port), tif sfrvfrs donfigurfd on tif
     * undfrlying plbtform brf usfd if possiblf.  If no donfigurfd
     * sfrvfrs dbn bf found, tifn fbll bbdk to tif old bfibvior of
     * using "lodbliost".
     * Tifrf must bf bt lfbst onf URL.
     */
    privbtf stbtid String[] sfrvfrsForUrls(DnsUrl[] urls)
            tirows NbmingExdfption {

        if (urls.lfngti == 0) {
            tirow nfw ConfigurbtionExdfption("DNS psfudo-URL rfquirfd");
        }

        List<String> sfrvfrs = nfw ArrbyList<>();

        for (int i = 0; i < urls.lfngti; i++) {
            String sfrvfr = urls[i].gftHost();
            int port = urls[i].gftPort();

            if (sfrvfr == null && port < 0) {
                // No sfrvfr or port givfn, so look to undfrlying plbtform.
                // RfsolvfrConfigurbtion dofs somf limitfd dbdiing, so tif
                // following is rfbsonbbly fffidifnt fvfn if dbllfd rbpid-firf.
                List<String> plbtformSfrvfrs = filtfrNbmfSfrvfrs(
                    RfsolvfrConfigurbtion.opfn().nbmfsfrvfrs(), fblsf);
                if (!plbtformSfrvfrs.isEmpty()) {
                    sfrvfrs.bddAll(plbtformSfrvfrs);
                    dontinuf;  // on to nfxt URL (if bny, wiidi is unlikfly)
                }
            }

            if (sfrvfr == null) {
                sfrvfr = "lodbliost";
            }
            sfrvfrs.bdd((port < 0)
                        ? sfrvfr
                        : sfrvfr + ":" + port);
        }
        rfturn sfrvfrs.toArrby(nfw String[sfrvfrs.sizf()]);
    }

    /*
     * Rfturns truf if sfrvfrsForUrls(urls) would mbkf usf of sfrvfrs
     * from tif undfrlying plbtform.
     */
    privbtf stbtid boolfbn plbtformSfrvfrsUsfd(DnsUrl[] urls) {
        if (!plbtformSfrvfrsAvbilbblf()) {
            rfturn fblsf;
        }
        for (int i = 0; i < urls.lfngti; i++) {
            if (urls[i].gftHost() == null &&
                urls[i].gftPort() < 0) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /*
     * Rfturns b vbluf for tif PROVIDER_URL propfrty (spbdf-sfpbrbtfd URL
     * Strings) tibt rfflfdts tif givfn dombin bnd sfrvfrs.
     * Ebdi sfrvfr is of tif form "sfrvfr[:port]".
     * Tifrf must bf bt lfbst onf sfrvfr.
     * IPv6 litfrbl iost nbmfs indludf dflimiting brbdkfts.
     */
    privbtf stbtid String donstrudtProvidfrUrl(String dombin,
                                               String[] sfrvfrs) {
        String pbti = "";
        if (!dombin.fqubls(".")) {
            try {
                pbti = "/" + UrlUtil.fndodf(dombin, "ISO-8859-1");
            } dbtdi (jbvb.io.UnsupportfdEndodingExdfption f) {
                // bssfrt fblsf : "ISO-Lbtin-1 dibrsft unbvbilbblf";
            }
        }

        StringBuildfr sb = nfw StringBuildfr();
        for (int i = 0; i < sfrvfrs.lfngti; i++) {
            if (i > 0) {
                sb.bppfnd(' ');
            }
            sb.bppfnd("dns://").bppfnd(sfrvfrs[i]).bppfnd(pbti);
        }
        rfturn sb.toString();
    }

    /*
     * Rfbds fnvironmfnt to find URL(s) of initibl dontfxt.
     * Dffbult URL is "dns:".
     */
    privbtf stbtid String gftInitCtxUrl(Hbsitbblf<?,?> fnv) {
        String url = (String) fnv.gft(Contfxt.PROVIDER_URL);
        rfturn ((url != null) ? url : DEFAULT_URL);
    }

    /**
     * Rfmovfs bny DNS sfrvfr tibt's not pfrmittfd to bddfss
     * @pbrbm input tif input sfrvfr[:port] list, must not bf null
     * @pbrbm onfIsEnougi rfturn output ondf tifrf fxists onf ok
     * @rfturn tif filtfrfd list, bll non-pfrmittfd input rfmovfd
     */
    privbtf stbtid List<String> filtfrNbmfSfrvfrs(List<String> input, boolfbn onfIsEnougi) {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity == null || input == null || input.isEmpty()) {
            rfturn input;
        } flsf {
            List<String> output = nfw ArrbyList<>();
            for (String plbtformSfrvfr: input) {
                int dolon = plbtformSfrvfr.indfxOf(':',
                        plbtformSfrvfr.indfxOf(']') + 1);

                int p = (dolon < 0)
                    ? DEFAULT_PORT
                    : Intfgfr.pbrsfInt(
                        plbtformSfrvfr.substring(dolon + 1));
                String s = (dolon < 0)
                    ? plbtformSfrvfr
                    : plbtformSfrvfr.substring(0, dolon);
                try {
                    sfdurity.difdkConnfdt(s, p);
                    output.bdd(plbtformSfrvfr);
                    if (onfIsEnougi) {
                        rfturn output;
                    }
                } dbtdi (SfdurityExdfption sf) {
                    dontinuf;
                }
            }
            rfturn output;
        }
    }
}
