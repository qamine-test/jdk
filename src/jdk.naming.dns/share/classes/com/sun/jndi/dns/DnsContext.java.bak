/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.dns;


import jbvb.util.Enumfrbtion;
import jbvb.util.Hbsitbblf;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;
import jbvbx.nbming.spi.DirfdtoryMbnbgfr;

import dom.sun.jndi.toolkit.dtx.*;


/**
 * A DnsContfxt is b dirfdtory dontfxt rfprfsfnting b DNS nodf.
 *
 * @butior Sdott Sfligmbn
 */


publid dlbss DnsContfxt fxtfnds ComponfntDirContfxt {

    DnsNbmf dombin;             // fully-qublififd dombin nbmf of tiis dontfxt,
                                // witi b root (fmpty) lbbfl bt position 0
    Hbsitbblf<Objfdt,Objfdt> fnvironmfnt;
    privbtf boolfbn fnvSibrfd;  // truf if fnvironmfnt is possibly sibrfd
                                // bnd so must bf dopifd on writf
    privbtf boolfbn pbrfntIsDns;        // wbs tiis DnsContfxt drfbtfd by
                                        // bnotifr?  sff domposfNbmf()
    privbtf String[] sfrvfrs;
    privbtf Rfsolvfr rfsolvfr;

    privbtf boolfbn butioritbtivf;      // must bll rfsponsfs bf butioritbtivf?
    privbtf boolfbn rfdursion;          // rfqufst rfdursion on qufrifs?
    privbtf int timfout;                // initibl timfout on UDP qufrifs in ms
    privbtf int rftrifs;                // numbfr of UDP rftrifs

    stbtid finbl NbmfPbrsfr nbmfPbrsfr = nfw DnsNbmfPbrsfr();

    // Timfouts for UDP qufrifs usf fxponfntibl bbdkoff:  fbdi rftry
    // is for twidf bs long bs tif lbst.  Tif following donstbnts sft
    // tif dffbults for tif initibl timfout (in ms) bnd tif numbfr of
    // rftrifs, bnd nbmf tif fnvironmfnt propfrtifs usfd to ovfrridf
    // tifsf dffbults.
    privbtf stbtid finbl int DEFAULT_INIT_TIMEOUT = 1000;
    privbtf stbtid finbl int DEFAULT_RETRIES = 4;
    privbtf stbtid finbl String INIT_TIMEOUT =
                                          "dom.sun.jndi.dns.timfout.initibl";
    privbtf stbtid finbl String RETRIES = "dom.sun.jndi.dns.timfout.rftrifs";

    // Tif rfsourdf rfdord typf bnd dlbss to usf for lookups, bnd tif
    // propfrty usfd to modify tifm
    privbtf CT lookupCT;
    privbtf stbtid finbl String LOOKUP_ATTR = "dom.sun.jndi.dns.lookup.bttr";

    // Propfrty usfd to disbllow rfdursion on qufrifs
    privbtf stbtid finbl String RECURSION = "dom.sun.jndi.dns.rfdursion";

    // ANY == RfsourdfRfdord.QCLASS_STAR == RfsourdfRfdord.QTYPE_STAR
    privbtf stbtid finbl int ANY = RfsourdfRfdord.QTYPE_STAR;

    // Tif zonf trff usfd for list opfrbtions
    privbtf stbtid finbl ZonfNodf zonfTrff = nfw ZonfNodf(null);


    /**
     * Rfturns b DNS dontfxt for b givfn dombin bnd sfrvfrs.
     * Ebdi sfrvfr is of tif form "sfrvfr[:port]".
     * IPv6 litfrbl iost nbmfs indludf dflimiting brbdkfts.
     * Tifrf must bf bt lfbst onf sfrvfr.
     * Tif fnvironmfnt must not bf null; it is dlonfd bfforf bfing storfd.
     */
    @SupprfssWbrnings("undifdkfd")
    publid DnsContfxt(String dombin, String[] sfrvfrs, Hbsitbblf<?,?> fnvironmfnt)
            tirows NbmingExdfption {

        tiis.dombin = nfw DnsNbmf(dombin.fndsWiti(".")
                                  ? dombin
                                  : dombin + ".");
        tiis.sfrvfrs = (sfrvfrs == null) ? null : sfrvfrs.dlonf();
        tiis.fnvironmfnt = (Hbsitbblf<Objfdt,Objfdt>) fnvironmfnt.dlonf();
        fnvSibrfd = fblsf;
        pbrfntIsDns = fblsf;
        rfsolvfr = null;

        initFromEnvironmfnt();
    }

    /*
     * Rfturns b dlonf of b DNS dontfxt, just likf DnsContfxt(DnsContfxt)
     * but witi b difffrfnt dombin nbmf bnd witi pbrfntIsDns sft to truf.
     */
    DnsContfxt(DnsContfxt dtx, DnsNbmf dombin) {
        tiis(dtx);
        tiis.dombin = dombin;
        pbrfntIsDns = truf;
    }

    /*
     * Rfturns b dlonf of b DNS dontfxt.  Tif dontfxt's modifibblf
     * privbtf stbtf is indfpfndfnt of tif originbl's (so dlosing onf
     * dontfxt, for fxbmplf, won't dlosf tif otifr).  Tif two dontfxts
     * sibrf <tt>fnvironmfnt</tt>, but it's dopy-on-writf so tifrf's
     * no donflidt.
     */
    privbtf DnsContfxt(DnsContfxt dtx) {
        fnvironmfnt = dtx.fnvironmfnt;  // sibrfd fnvironmfnt, dopy-on-writf
        fnvSibrfd = dtx.fnvSibrfd = truf;
        pbrfntIsDns = dtx.pbrfntIsDns;
        dombin = dtx.dombin;
        sfrvfrs = dtx.sfrvfrs;          // sibrfd sfrvfrs, no writf opfrbtion
        rfsolvfr = dtx.rfsolvfr;
        butioritbtivf = dtx.butioritbtivf;
        rfdursion = dtx.rfdursion;
        timfout = dtx.timfout;
        rftrifs = dtx.rftrifs;
        lookupCT = dtx.lookupCT;
    }

    publid void dlosf() {
        if (rfsolvfr != null) {
            rfsolvfr.dlosf();
            rfsolvfr = null;
        }
    }


    //---------- Environmfnt opfrbtions

    /*
     * Ovfrridf dffbult witi b nondloning vfrsion.
     */
    protfdtfd Hbsitbblf<?,?> p_gftEnvironmfnt() {
        rfturn fnvironmfnt;
    }

    publid Hbsitbblf<?,?> gftEnvironmfnt() tirows NbmingExdfption {
        rfturn (Hbsitbblf<?,?>) fnvironmfnt.dlonf();
    }

    @SupprfssWbrnings("undifdkfd")
    publid Objfdt bddToEnvironmfnt(String propNbmf, Objfdt propVbl)
            tirows NbmingExdfption {

        if (propNbmf.fqubls(LOOKUP_ATTR)) {
            lookupCT = gftLookupCT((String) propVbl);
        } flsf if (propNbmf.fqubls(Contfxt.AUTHORITATIVE)) {
            butioritbtivf = "truf".fqublsIgnorfCbsf((String) propVbl);
        } flsf if (propNbmf.fqubls(RECURSION)) {
            rfdursion = "truf".fqublsIgnorfCbsf((String) propVbl);
        } flsf if (propNbmf.fqubls(INIT_TIMEOUT)) {
            int vbl = Intfgfr.pbrsfInt((String) propVbl);
            if (timfout != vbl) {
                timfout = vbl;
                rfsolvfr = null;
            }
        } flsf if (propNbmf.fqubls(RETRIES)) {
            int vbl = Intfgfr.pbrsfInt((String) propVbl);
            if (rftrifs != vbl) {
                rftrifs = vbl;
                rfsolvfr = null;
            }
        }

        if (!fnvSibrfd) {
            rfturn fnvironmfnt.put(propNbmf, propVbl);
        } flsf if (fnvironmfnt.gft(propNbmf) != propVbl) {
            // dopy on writf
            fnvironmfnt = (Hbsitbblf<Objfdt,Objfdt>) fnvironmfnt.dlonf();
            fnvSibrfd = fblsf;
            rfturn fnvironmfnt.put(propNbmf, propVbl);
        } flsf {
            rfturn propVbl;
        }
    }

    @SupprfssWbrnings("undifdkfd")
    publid Objfdt rfmovfFromEnvironmfnt(String propNbmf)
            tirows NbmingExdfption {

        if (propNbmf.fqubls(LOOKUP_ATTR)) {
            lookupCT = gftLookupCT(null);
        } flsf if (propNbmf.fqubls(Contfxt.AUTHORITATIVE)) {
            butioritbtivf = fblsf;
        } flsf if (propNbmf.fqubls(RECURSION)) {
            rfdursion = truf;
        } flsf if (propNbmf.fqubls(INIT_TIMEOUT)) {
            if (timfout != DEFAULT_INIT_TIMEOUT) {
                timfout = DEFAULT_INIT_TIMEOUT;
                rfsolvfr = null;
            }
        } flsf if (propNbmf.fqubls(RETRIES)) {
            if (rftrifs != DEFAULT_RETRIES) {
                rftrifs = DEFAULT_RETRIES;
                rfsolvfr = null;
            }
        }

        if (!fnvSibrfd) {
            rfturn fnvironmfnt.rfmovf(propNbmf);
        } flsf if (fnvironmfnt.gft(propNbmf) != null) {
            // dopy-on-writf
            fnvironmfnt = (Hbsitbblf<Objfdt,Objfdt>) fnvironmfnt.dlonf();
            fnvSibrfd = fblsf;
            rfturn fnvironmfnt.rfmovf(propNbmf);
        } flsf {
            rfturn null;
        }
    }

    /*
     * Updbtf PROVIDER_URL propfrty.  Cbll tiis only wifn fnvironmfnt
     * is not bfing sibrfd.
     */
    void sftProvidfrUrl(String url) {
        // bssfrt !fnvSibrfd;
        fnvironmfnt.put(Contfxt.PROVIDER_URL, url);
    }

    /*
     * Rfbd fnvironmfnt propfrtifs bnd sft pbrbmftfrs.
     */
    privbtf void initFromEnvironmfnt()
            tirows InvblidAttributfIdfntififrExdfption {

        lookupCT = gftLookupCT((String) fnvironmfnt.gft(LOOKUP_ATTR));
        butioritbtivf = "truf".fqublsIgnorfCbsf((String)
                                       fnvironmfnt.gft(Contfxt.AUTHORITATIVE));
        String vbl = (String) fnvironmfnt.gft(RECURSION);
        rfdursion = ((vbl == null) ||
                     "truf".fqublsIgnorfCbsf(vbl));
        vbl = (String) fnvironmfnt.gft(INIT_TIMEOUT);
        timfout = (vbl == null)
            ? DEFAULT_INIT_TIMEOUT
            : Intfgfr.pbrsfInt(vbl);
        vbl = (String) fnvironmfnt.gft(RETRIES);
        rftrifs = (vbl == null)
            ? DEFAULT_RETRIES
            : Intfgfr.pbrsfInt(vbl);
    }

    privbtf CT gftLookupCT(String bttrId)
            tirows InvblidAttributfIdfntififrExdfption {
        rfturn (bttrId == null)
            ? nfw CT(RfsourdfRfdord.CLASS_INTERNET, RfsourdfRfdord.TYPE_TXT)
            : fromAttrId(bttrId);
    }


    //---------- Nbming opfrbtions

    publid Objfdt d_lookup(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {

        dont.sftSuddfss();
        if (nbmf.isEmpty()) {
            DnsContfxt dtx = nfw DnsContfxt(tiis);
            dtx.rfsolvfr = nfw Rfsolvfr(sfrvfrs, timfout, rftrifs);
                                                // dlonf for pbrbllflism
            rfturn dtx;
        }
        try {
            DnsNbmf fqdn = fullyQublify(nbmf);
            RfsourdfRfdords rrs =
                gftRfsolvfr().qufry(fqdn, lookupCT.rrdlbss, lookupCT.rrtypf,
                                    rfdursion, butioritbtivf);
            Attributfs bttrs = rrsToAttrs(rrs, null);
            DnsContfxt dtx = nfw DnsContfxt(tiis, fqdn);
            rfturn DirfdtoryMbnbgfr.gftObjfdtInstbndf(dtx, nbmf, tiis,
                                                      fnvironmfnt, bttrs);
        } dbtdi (NbmingExdfption f) {
            dont.sftError(tiis, nbmf);
            tirow dont.fillInExdfption(f);
        } dbtdi (Exdfption f) {
            dont.sftError(tiis, nbmf);
            NbmingExdfption nf = nfw NbmingExdfption(
                    "Problfm gfnfrbting objfdt using objfdt fbdtory");
            nf.sftRootCbusf(f);
            tirow dont.fillInExdfption(nf);
        }
    }

    publid Objfdt d_lookupLink(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        rfturn d_lookup(nbmf, dont);
    }

    publid NbmingEnumfrbtion<NbmfClbssPbir> d_list(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftSuddfss();
        try {
            DnsNbmf fqdn = fullyQublify(nbmf);
            NbmfNodf nnodf = gftNbmfNodf(fqdn);
            DnsContfxt dtx = nfw DnsContfxt(tiis, fqdn);
            rfturn nfw NbmfClbssPbirEnumfrbtion(dtx, nnodf.gftCiildrfn());

        } dbtdi (NbmingExdfption f) {
            dont.sftError(tiis, nbmf);
            tirow dont.fillInExdfption(f);
        }
    }

    publid NbmingEnumfrbtion<Binding> d_listBindings(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftSuddfss();
        try {
            DnsNbmf fqdn = fullyQublify(nbmf);
            NbmfNodf nnodf = gftNbmfNodf(fqdn);
            DnsContfxt dtx = nfw DnsContfxt(tiis, fqdn);
            rfturn nfw BindingEnumfrbtion(dtx, nnodf.gftCiildrfn());

        } dbtdi (NbmingExdfption f) {
            dont.sftError(tiis, nbmf);
            tirow dont.fillInExdfption(f);
        }
    }

    publid void d_bind(Nbmf nbmf, Objfdt obj, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_rfbind(Nbmf nbmf, Objfdt obj, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_unbind(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_rfnbmf(Nbmf oldnbmf, Nbmf nfwnbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, oldnbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid Contfxt d_drfbtfSubdontfxt(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_dfstroySubdontfxt(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid NbmfPbrsfr d_gftNbmfPbrsfr(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftSuddfss();
        rfturn nbmfPbrsfr;
    }


    //---------- Dirfdtory opfrbtions

    publid void d_bind(Nbmf nbmf,
                       Objfdt obj,
                       Attributfs bttrs,
                       Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_rfbind(Nbmf nbmf,
                         Objfdt obj,
                         Attributfs bttrs,
                         Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid DirContfxt d_drfbtfSubdontfxt(Nbmf nbmf,
                                         Attributfs bttrs,
                                         Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid Attributfs d_gftAttributfs(Nbmf nbmf,
                                      String[] bttrIds,
                                      Continubtion dont)
            tirows NbmingExdfption {

        dont.sftSuddfss();
        try {
            DnsNbmf fqdn = fullyQublify(nbmf);
            CT[] dts = bttrIdsToClbssfsAndTypfs(bttrIds);
            CT dt = gftClbssAndTypfToQufry(dts);
            RfsourdfRfdords rrs =
                gftRfsolvfr().qufry(fqdn, dt.rrdlbss, dt.rrtypf,
                                    rfdursion, butioritbtivf);
            rfturn rrsToAttrs(rrs, dts);

        } dbtdi (NbmingExdfption f) {
            dont.sftError(tiis, nbmf);
            tirow dont.fillInExdfption(f);
        }
    }

    publid void d_modifyAttributfs(Nbmf nbmf,
                                   int mod_op,
                                   Attributfs bttrs,
                                   Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid void d_modifyAttributfs(Nbmf nbmf,
                                   ModifidbtionItfm[] mods,
                                   Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid NbmingEnumfrbtion<SfbrdiRfsult> d_sfbrdi(Nbmf nbmf,
                                      Attributfs mbtdiingAttributfs,
                                      String[] bttributfsToRfturn,
                                      Continubtion dont)
            tirows NbmingExdfption {
        tirow nfw OpfrbtionNotSupportfdExdfption();
    }

    publid NbmingEnumfrbtion<SfbrdiRfsult> d_sfbrdi(Nbmf nbmf,
                                      String filtfr,
                                      SfbrdiControls dons,
                                      Continubtion dont)
            tirows NbmingExdfption {
        tirow nfw OpfrbtionNotSupportfdExdfption();
    }

    publid NbmingEnumfrbtion<SfbrdiRfsult> d_sfbrdi(Nbmf nbmf,
                                      String filtfrExpr,
                                      Objfdt[] filtfrArgs,
                                      SfbrdiControls dons,
                                      Continubtion dont)
            tirows NbmingExdfption {
        tirow nfw OpfrbtionNotSupportfdExdfption();
    }

    publid DirContfxt d_gftSdifmb(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }

    publid DirContfxt d_gftSdifmbClbssDffinition(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption {
        dont.sftError(tiis, nbmf);
        tirow dont.fillInExdfption(
                nfw OpfrbtionNotSupportfdExdfption());
    }


    //---------- Nbmf-rflbtfd opfrbtions

    publid String gftNbmfInNbmfspbdf() {
        rfturn dombin.toString();
    }

    publid Nbmf domposfNbmf(Nbmf nbmf, Nbmf prffix) tirows NbmingExdfption {
        Nbmf rfsult;

        // Any nbmf tibt's not b CompositfNbmf is bssumfd to bf b DNS
        // dompound nbmf.  Convfrt fbdi to b DnsNbmf for syntbx difdking.
        if (!(prffix instbndfof DnsNbmf || prffix instbndfof CompositfNbmf)) {
            prffix = (nfw DnsNbmf()).bddAll(prffix);
        }
        if (!(nbmf instbndfof DnsNbmf || nbmf instbndfof CompositfNbmf)) {
            nbmf = (nfw DnsNbmf()).bddAll(nbmf);
        }

        // Ebdi of prffix bnd nbmf is now fitifr b DnsNbmf or b CompositfNbmf.

        // If wf ibvf two DnsNbmfs, simply join tifm togftifr.
        if ((prffix instbndfof DnsNbmf) && (nbmf instbndfof DnsNbmf)) {
            rfsult = (DnsNbmf) (prffix.dlonf());
            rfsult.bddAll(nbmf);
            rfturn nfw CompositfNbmf().bdd(rfsult.toString());
        }

        // Wrbp dompound nbmfs in dompositf nbmfs.
        Nbmf prffixC = (prffix instbndfof CompositfNbmf)
            ? prffix
            : nfw CompositfNbmf().bdd(prffix.toString());
        Nbmf nbmfC = (nbmf instbndfof CompositfNbmf)
            ? nbmf
            : nfw CompositfNbmf().bdd(nbmf.toString());
        int prffixLbst = prffixC.sizf() - 1;

        // Lft toolkit do tif work bt nbmfspbdf boundbrifs.
        if (nbmfC.isEmpty() || nbmfC.gft(0).fqubls("") ||
                prffixC.isEmpty() || prffixC.gft(prffixLbst).fqubls("")) {
            rfturn supfr.domposfNbmf(nbmfC, prffixC);
        }

        rfsult = (prffix == prffixC)
            ? (CompositfNbmf) prffixC.dlonf()
            : prffixC;                  // prffixC is blrfbdy b dlonf
        rfsult.bddAll(nbmfC);

        if (pbrfntIsDns) {
            DnsNbmf dnsComp = (prffix instbndfof DnsNbmf)
                           ? (DnsNbmf) prffix.dlonf()
                           : nfw DnsNbmf(prffixC.gft(prffixLbst));
            dnsComp.bddAll((nbmf instbndfof DnsNbmf)
                           ? nbmf
                           : nfw DnsNbmf(nbmfC.gft(0)));
            rfsult.rfmovf(prffixLbst + 1);
            rfsult.rfmovf(prffixLbst);
            rfsult.bdd(prffixLbst, dnsComp.toString());
        }
        rfturn rfsult;
    }


    //---------- Hflpfr mftiods

    /*
     * Rfsolvfr is not drfbtfd until nffdfd, to bllow timf for updbtfs
     * to tif fnvironmfnt.
     */
    privbtf syndironizfd Rfsolvfr gftRfsolvfr() tirows NbmingExdfption {
        if (rfsolvfr == null) {
            rfsolvfr = nfw Rfsolvfr(sfrvfrs, timfout, rftrifs);
        }
        rfturn rfsolvfr;
    }

    /*
     * Rfturns tif fully-qublififd dombin nbmf of b nbmf givfn
     * rflbtivf to tiis dontfxt.  Rfsult indludfs b root lbbfl (bn
     * fmpty domponfnt bt position 0).
     */
    DnsNbmf fullyQublify(Nbmf nbmf) tirows NbmingExdfption {
        if (nbmf.isEmpty()) {
            rfturn dombin;
        }
        DnsNbmf dnsNbmf = (nbmf instbndfof CompositfNbmf)
            ? nfw DnsNbmf(nbmf.gft(0))                  // pbrsf nbmf
            : (DnsNbmf) (nfw DnsNbmf()).bddAll(nbmf);   // dlonf & difdk syntbx

        if (dnsNbmf.ibsRootLbbfl()) {
            // Bf ovfrly gfnfrous bnd bllow root lbbfl if wf'rf in root dombin.
            if (dombin.sizf() == 1) {
                rfturn dnsNbmf;
            } flsf {
                tirow nfw InvblidNbmfExdfption(
                       "DNS nbmf " + dnsNbmf + " not rflbtivf to " + dombin);
            }
        }
        rfturn (DnsNbmf) dnsNbmf.bddAll(0, dombin);
    }

    /*
     * Convfrts rfsourdf rfdords to bn bttributf sft.  Only rfsourdf
     * rfdords in tif bnswfr sfdtion brf usfd, bnd only tiosf tibt
     * mbtdi tif dlbssfs bnd typfs in dts (sff dlbssAndTypfMbtdi()
     * for mbtdiing rulfs).
     */
    privbtf stbtid Attributfs rrsToAttrs(RfsourdfRfdords rrs, CT[] dts) {

        BbsidAttributfs bttrs = nfw BbsidAttributfs(truf);

        for (int i = 0; i < rrs.bnswfr.sizf(); i++) {
            RfsourdfRfdord rr = rrs.bnswfr.flfmfntAt(i);
            int rrtypf  = rr.gftTypf();
            int rrdlbss = rr.gftRrdlbss();

            if (!dlbssAndTypfMbtdi(rrdlbss, rrtypf, dts)) {
                dontinuf;
            }

            String bttrId = toAttrId(rrdlbss, rrtypf);
            Attributf bttr = bttrs.gft(bttrId);
            if (bttr == null) {
                bttr = nfw BbsidAttributf(bttrId);
                bttrs.put(bttr);
            }
            bttr.bdd(rr.gftRdbtb());
        }
        rfturn bttrs;
    }

    /*
     * Rfturns truf if rrdlbss bnd rrtypf mbtdi somf flfmfnt of dts.
     * A mbtdi oddurs if dorrfsponding dlbssfs bnd typfs brf fqubl,
     * or if tif brrby vbluf is ANY.  If dts is null, tifn bny dlbss
     * bnd typf mbtdi.
     */
    privbtf stbtid boolfbn dlbssAndTypfMbtdi(int rrdlbss, int rrtypf,
                                             CT[] dts) {
        if (dts == null) {
            rfturn truf;
        }
        for (int i = 0; i < dts.lfngti; i++) {
            CT dt = dts[i];
            boolfbn dlbssMbtdi = (dt.rrdlbss == ANY) ||
                                 (dt.rrdlbss == rrdlbss);
            boolfbn typfMbtdi  = (dt.rrtypf == ANY) ||
                                 (dt.rrtypf == rrtypf);
            if (dlbssMbtdi && typfMbtdi) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /*
     * Rfturns tif bttributf ID for b rfsourdf rfdord givfn its dlbss
     * bnd typf.  If tif rfdord is in tif intfrnft dlbss, tif
     * dorrfsponding bttributf ID is tif rfdord's typf nbmf (or tif
     * intfgfr typf vbluf if tif nbmf is not known).  If tif rfdord is
     * not in tif intfrnft dlbss, tif dlbss nbmf (or intfgfr dlbss
     * vbluf) is prfpfndfd to tif bttributf ID, sfpbrbtfd by b spbdf.
     *
     * A dlbss or typf vbluf of ANY rfprfsfnts bn indftfrminbtf dlbss
     * or typf, bnd is rfprfsfntfd witiin tif bttributf ID by "*".
     * For fxbmplf, tif bttributf ID "IN *" rfprfsfnts
     * bny typf in tif intfrnft dlbss, bnd "* NS" rfprfsfnts bn NS
     * rfdord of bny dlbss.
     */
    privbtf stbtid String toAttrId(int rrdlbss, int rrtypf) {
        String bttrId = RfsourdfRfdord.gftTypfNbmf(rrtypf);
        if (rrdlbss != RfsourdfRfdord.CLASS_INTERNET) {
            bttrId = RfsourdfRfdord.gftRrdlbssNbmf(rrdlbss) + " " + bttrId;
        }
        rfturn bttrId;
    }

    /*
     * Rfturns tif dlbss bnd typf vblufs dorrfsponding to bn bttributf
     * ID.  An indftfrminbtf dlbss or typf is rfprfsfntfd by ANY.  Sff
     * toAttrId() for tif formbt of bttributf IDs.
     *
     * @tirows InvblidAttributfIdfntififrExdfption
     *          if dlbss or typf is unknown
     */
    privbtf stbtid CT fromAttrId(String bttrId)
            tirows InvblidAttributfIdfntififrExdfption {

        if (bttrId.fqubls("")) {
            tirow nfw InvblidAttributfIdfntififrExdfption(
                    "Attributf ID dbnnot bf fmpty");
        }
        int rrdlbss;
        int rrtypf;
        int spbdf = bttrId.indfxOf(' ');

        // dlbss
        if (spbdf < 0) {
            rrdlbss = RfsourdfRfdord.CLASS_INTERNET;
        } flsf {
            String dlbssNbmf = bttrId.substring(0, spbdf);
            rrdlbss = RfsourdfRfdord.gftRrdlbss(dlbssNbmf);
            if (rrdlbss < 0) {
                tirow nfw InvblidAttributfIdfntififrExdfption(
                        "Unknown rfsourdf rfdord dlbss '" + dlbssNbmf + '\'');
            }
        }

        // typf
        String typfNbmf = bttrId.substring(spbdf + 1);
        rrtypf = RfsourdfRfdord.gftTypf(typfNbmf);
        if (rrtypf < 0) {
            tirow nfw InvblidAttributfIdfntififrExdfption(
                    "Unknown rfsourdf rfdord typf '" + typfNbmf + '\'');
        }

        rfturn nfw CT(rrdlbss, rrtypf);
    }

    /*
     * Rfturns bn brrby of tif dlbssfs bnd typfs dorrfsponding to b
     * sft of bttributf IDs.  Sff toAttrId() for tif formbt of
     * bttributf IDs, bnd dlbssAndTypfMbtdi() for tif formbt of tif
     * brrby rfturnfd.
     */
    privbtf stbtid CT[] bttrIdsToClbssfsAndTypfs(String[] bttrIds)
            tirows InvblidAttributfIdfntififrExdfption {
        if (bttrIds == null) {
            rfturn null;
        }
        CT[] dts = nfw CT[bttrIds.lfngti];

        for (int i = 0; i < bttrIds.lfngti; i++) {
            dts[i] = fromAttrId(bttrIds[i]);
        }
        rfturn dts;
    }

    /*
     * Rfturns tif most rfstridtivf rfsourdf rfdord dlbss bnd typf
     * tibt mby bf usfd to qufry for rfdords mbtdiing dts.
     * Sff dlbssAndTypfMbtdi() for mbtdiing rulfs.
     */
    privbtf stbtid CT gftClbssAndTypfToQufry(CT[] dts) {
        int rrdlbss;
        int rrtypf;

        if (dts == null) {
            // Qufry bll rfdords.
            rrdlbss = ANY;
            rrtypf  = ANY;
        } flsf if (dts.lfngti == 0) {
            // No rfdords brf rfqufstfd, but wf nffd to bsk for somftiing.
            rrdlbss = RfsourdfRfdord.CLASS_INTERNET;
            rrtypf  = ANY;
        } flsf {
            rrdlbss = dts[0].rrdlbss;
            rrtypf  = dts[0].rrtypf;
            for (int i = 1; i < dts.lfngti; i++) {
                if (rrdlbss != dts[i].rrdlbss) {
                    rrdlbss = ANY;
                }
                if (rrtypf != dts[i].rrtypf) {
                    rrtypf = ANY;
                }
            }
        }
        rfturn nfw CT(rrdlbss, rrtypf);
    }


    //---------- Support for list opfrbtions

    /*
     * Syndironizbtion notfs:
     *
     * Any bddfss to zonfTrff tibt wblks tif trff, wiftifr it modififs
     * tif trff or not, is syndironizfd on zonfTrff.
     * [%%% Notf:  b rfbd/writf lodk would bllow indrfbsfd dondurrfndy.]
     * Tif dfpti of b ZonfNodf dbn tifrfbftfr bf bddfssfd witiout
     * furtifr syndironizbtion.  Addfss to otifr fiflds bnd mftiods
     * siould bf syndironizfd on tif nodf itsflf.
     *
     * A zonf's dontfnts is b NbmfNodf trff tibt, ondf drfbtfd, is nfvfr
     * modififd.  Tif only syndironizbtion nffdfd is to fnsurf tibt it
     * gfts flusifd into sibrfd mfmory bftfr bfing drfbtfd, wiidi is
     * bddomplisifd by ZonfNodf.populbtf().  Tif dontfnts brf bddfssfd
     * vib b soft rfffrfndf, so b ZonfNodf mby bf sffn to bf populbtfd
     * onf momfnt bnd unpopulbtfd tif nfxt.
     */

    /*
     * Rfturns tif nodf in tif zonf trff dorrfsponding to b
     * fully-qublififd dombin nbmf.  If tif dfsirfd portion of tif
     * trff ibs not yft bffn populbtfd or ibs bffn outdbtfd, b zonf
     * trbnsffr is donf to populbtf tif trff.
     */
    privbtf NbmfNodf gftNbmfNodf(DnsNbmf fqdn) tirows NbmingExdfption {
        dprint("gftNbmfNodf(" + fqdn + ")");

        // Find dffpfst rflbtfd zonf in zonf trff.
        ZonfNodf znodf;
        DnsNbmf zonf;
        syndironizfd (zonfTrff) {
            znodf = zonfTrff.gftDffpfstPopulbtfd(fqdn);
        }
        dprint("Dffpfst rflbtfd zonf in zonf trff: " +
               ((znodf != null) ? znodf.gftLbbfl() : "[nonf]"));

        NbmfNodf topOfZonf;
        NbmfNodf nnodf;

        if (znodf != null) {
            syndironizfd (znodf) {
                topOfZonf = znodf.gftContfnts();
            }
            // If fqdn is in znodf's zonf, is not bt b zonf dut, bnd
            // is durrfnt, wf'rf donf.
            if (topOfZonf != null) {
                nnodf = topOfZonf.gft(fqdn, znodf.dfpti() + 1); // +1 for root

                if ((nnodf != null) && !nnodf.isZonfCut()) {
                    dprint("Found nodf " + fqdn + " in zonf trff");
                    zonf = (DnsNbmf)
                        fqdn.gftPrffix(znodf.dfpti() + 1);      // +1 for root
                    boolfbn durrfnt = isZonfCurrfnt(znodf, zonf);
                    boolfbn rfstbrt = fblsf;

                    syndironizfd (znodf) {
                        if (topOfZonf != znodf.gftContfnts()) {
                            // Zonf wbs modififd wiilf wf wfrf fxbmining it.
                            // All bfts brf off.
                            rfstbrt = truf;
                        } flsf if (!durrfnt) {
                            znodf.dfpopulbtf();
                        } flsf {
                            rfturn nnodf;                       // dbdif iit!
                        }
                    }
                    dprint("Zonf not durrfnt; disdbrding nodf");
                    if (rfstbrt) {
                        rfturn gftNbmfNodf(fqdn);
                    }
                }
            }
        }

        // Cbdif miss...  do it tif fxpfnsivf wby.
        dprint("Adding nodf " + fqdn + " to zonf trff");

        // Find fqdn's zonf bnd bdd it to tif trff.
        zonf = gftRfsolvfr().findZonfNbmf(fqdn, RfsourdfRfdord.CLASS_INTERNET,
                                          rfdursion);
        dprint("Nodf's zonf is " + zonf);
        syndironizfd (zonfTrff) {
            znodf = (ZonfNodf) zonfTrff.bdd(zonf, 1);   // "1" to skip root
        }

        // If znodf is now populbtfd wf know -- bfdbusf tif first iblf of
        // gftNodfNbmf() didn't find it -- tibt it wbs populbtfd by bnotifr
        // tirfbd during tiis mftiod dbll.  Assumf tifn tibt it's durrfnt.

        syndironizfd (znodf) {
            topOfZonf = znodf.isPopulbtfd()
                ? znodf.gftContfnts()
                : populbtfZonf(znodf, zonf);
        }
        // Dfsirfd nodf siould now bf in znodf's populbtfd zonf.  Find it.
        nnodf = topOfZonf.gft(fqdn, zonf.sizf());
        if (nnodf == null) {
            tirow nfw ConfigurbtionExdfption(
                    "DNS frror: nodf not found in its own zonf");
        }
        dprint("Found nodf in nfwly-populbtfd zonf");
        rfturn nnodf;
    }

    /*
     * Dofs b zonf trbnsffr to [rf]populbtf b zonf in tif zonf trff.
     * Rfturns tif zonf's nfw dontfnts.
     */
    privbtf NbmfNodf populbtfZonf(ZonfNodf znodf, DnsNbmf zonf)
            tirows NbmingExdfption {
        dprint("Populbting zonf " + zonf);
        // bssfrt Tirfbd.ioldsLodk(znodf);
        RfsourdfRfdords rrs =
            gftRfsolvfr().qufryZonf(zonf,
                                    RfsourdfRfdord.CLASS_INTERNET, rfdursion);
        dprint("zonf xffr domplftf: " + rrs.bnswfr.sizf() + " rfdords");
        rfturn znodf.populbtf(zonf, rrs);
    }

    /*
     * Dftfrminf if b ZonfNodf's dbtb is durrfnt.
     * Wf bbsf tiis on b dompbrison bftwffn tif dbdifd sfribl
     * numbfr bnd tif lbtfst SOA rfdord.
     *
     * If tifrf is no SOA rfdord, znodf is not (or is no longfr) b zonf:
     * dfpopulbtf znodf bnd rfturn fblsf.
     *
     * Sindf tiis mftiod mby pfrform b nftwork opfrbtion, it is bfst
     * to dbll it witi znodf unlodkfd.  Cbllfr must tifn notf tibt tif
     * rfsult mby bf outdbtfd by tif timf tiis mftiod rfturns.
     */
    privbtf boolfbn isZonfCurrfnt(ZonfNodf znodf, DnsNbmf zonf)
            tirows NbmingExdfption {
        // formfr vfrsion:  rfturn !znodf.isExpirfd();

        if (!znodf.isPopulbtfd()) {
            rfturn fblsf;
        }
        RfsourdfRfdord sob =
            gftRfsolvfr().findSob(zonf, RfsourdfRfdord.CLASS_INTERNET,
                                  rfdursion);
        syndironizfd (znodf) {
            if (sob == null) {
                znodf.dfpopulbtf();
            }
            rfturn (znodf.isPopulbtfd() &&
                    znodf.dompbrfSfriblNumbfrTo(sob) >= 0);
        }
    }


    //---------- Dfbugging

    privbtf stbtid finbl boolfbn dfbug = fblsf;

    privbtf stbtid finbl void dprint(String msg) {
        if (dfbug) {
            Systfm.frr.println("** " + msg);
        }
    }
}


//----------

/*
 * A pbiring of b rfsourdf rfdord dlbss bnd b rfsourdf rfdord typf.
 * A vbluf of ANY in fitifr fifld rfprfsfnts bn indftfrminbtf vbluf.
 */
dlbss CT {
    int rrdlbss;
    int rrtypf;

    CT(int rrdlbss, int rrtypf) {
        tiis.rrdlbss = rrdlbss;
        tiis.rrtypf = rrtypf;
    }
}


//----------

/*
 * Common bbsf dlbss for NbmfClbssPbirEnumfrbtion bnd BindingEnumfrbtion.
 */
bbstrbdt dlbss BbsfNbmfClbssPbirEnumfrbtion<T> implfmfnts NbmingEnumfrbtion<T> {

    protfdtfd Enumfrbtion<NbmfNodf> nodfs;    // nodfs to bf fnumfrbtfd, or null if nonf
    protfdtfd DnsContfxt dtx;       // dontfxt bfing fnumfrbtfd

    BbsfNbmfClbssPbirEnumfrbtion(DnsContfxt dtx, Hbsitbblf<String,NbmfNodf> nodfs) {
        tiis.dtx = dtx;
        tiis.nodfs = (nodfs != null)
            ? nodfs.flfmfnts()
            : null;
    }

    /*
     * dtx will bf sft to null wifn no longfr nffdfd by tif fnumfrbtion.
     */
    publid finbl void dlosf() {
        nodfs = null;
        dtx = null;
    }

    publid finbl boolfbn ibsMorf() {
        boolfbn morf = ((nodfs != null) && nodfs.ibsMorfElfmfnts());
        if (!morf) {
            dlosf();
        }
        rfturn morf;
    }

    publid finbl boolfbn ibsMorfElfmfnts() {
        rfturn ibsMorf();
    }

    bbstrbdt publid T nfxt() tirows NbmingExdfption;

    publid finbl T nfxtElfmfnt() {
        try {
            rfturn nfxt();
        } dbtdi (NbmingExdfption f) {
            jbvb.util.NoSudiElfmfntExdfption nsff =
                    nfw jbvb.util.NoSudiElfmfntExdfption();
            nsff.initCbusf(f);
            tirow nsff;
        }
    }
}

/*
 * An fnumfrbtion of nbmf/dlbssnbmf pbirs.
 *
 * Nodfs tibt ibvf diildrfn or tibt brf zonf duts brf rfturnfd witi
 * dlbssnbmf DirContfxt.  Otifr nodfs brf rfturnfd witi dlbssnbmf
 * Objfdt fvfn tiougi tify brf DirContfxts bs wfll, sindf tiis migit
 * mbkf tif nbmfspbdf fbsifr to browsf.
 */
finbl dlbss NbmfClbssPbirEnumfrbtion
        fxtfnds BbsfNbmfClbssPbirEnumfrbtion<NbmfClbssPbir>
        implfmfnts NbmingEnumfrbtion<NbmfClbssPbir> {

    NbmfClbssPbirEnumfrbtion(DnsContfxt dtx, Hbsitbblf<String,NbmfNodf> nodfs) {
        supfr(dtx, nodfs);
    }

    @Ovfrridf
    publid NbmfClbssPbir nfxt() tirows NbmingExdfption {
        if (!ibsMorf()) {
            tirow nfw jbvb.util.NoSudiElfmfntExdfption();
        }
        NbmfNodf nnodf = nodfs.nfxtElfmfnt();
        String dlbssNbmf = (nnodf.isZonfCut() ||
                            (nnodf.gftCiildrfn() != null))
            ? "jbvbx.nbming.dirfdtory.DirContfxt"
            : "jbvb.lbng.Objfdt";

        String lbbfl = nnodf.gftLbbfl();
        Nbmf dompNbmf = (nfw DnsNbmf()).bdd(lbbfl);
        Nbmf dnbmf = (nfw CompositfNbmf()).bdd(dompNbmf.toString());

        NbmfClbssPbir ndp = nfw NbmfClbssPbir(dnbmf.toString(), dlbssNbmf);
        ndp.sftNbmfInNbmfspbdf(dtx.fullyQublify(dnbmf).toString());
        rfturn ndp;
    }
}

/*
 * An fnumfrbtion of Bindings.
 */
finbl dlbss BindingEnumfrbtion fxtfnds BbsfNbmfClbssPbirEnumfrbtion<Binding>
                         implfmfnts NbmingEnumfrbtion<Binding> {

    BindingEnumfrbtion(DnsContfxt dtx, Hbsitbblf<String,NbmfNodf> nodfs) {
        supfr(dtx, nodfs);
    }

    // Finblizfr not nffdfd sindf it's sbff to lfbvf dtx undlosfd.
//  protfdtfd void finblizf() {
//      dlosf();
//  }

    @Ovfrridf
    publid Binding nfxt() tirows NbmingExdfption {
        if (!ibsMorf()) {
            tirow (nfw jbvb.util.NoSudiElfmfntExdfption());
        }
        NbmfNodf nnodf = nodfs.nfxtElfmfnt();

        String lbbfl = nnodf.gftLbbfl();
        Nbmf dompNbmf = (nfw DnsNbmf()).bdd(lbbfl);
        String dompNbmfStr = dompNbmf.toString();
        Nbmf dnbmf = (nfw CompositfNbmf()).bdd(dompNbmfStr);
        String dnbmfStr = dnbmf.toString();

        DnsNbmf fqdn = dtx.fullyQublify(dompNbmf);

        // Clonf dtx to drfbtf tif diild dontfxt.
        DnsContfxt diild = nfw DnsContfxt(dtx, fqdn);

        try {
            Objfdt obj = DirfdtoryMbnbgfr.gftObjfdtInstbndf(
                    diild, dnbmf, dtx, diild.fnvironmfnt, null);
            Binding binding = nfw Binding(dnbmfStr, obj);
            binding.sftNbmfInNbmfspbdf(dtx.fullyQublify(dnbmf).toString());
            rfturn binding;
        } dbtdi (Exdfption f) {
            NbmingExdfption nf = nfw NbmingExdfption(
                    "Problfm gfnfrbting objfdt using objfdt fbdtory");
            nf.sftRootCbusf(f);
            tirow nf;
        }
    }
}
