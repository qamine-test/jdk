/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf bpplf.sfdurity;

import jbvb.io.*;
import jbvb.sfdurity.*;
import jbvb.sfdurity.dfrt.*;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.spfd.*;
import jbvb.util.*;

import jbvbx.drypto.*;
import jbvbx.drypto.spfd.*;
import jbvbx.sfdurity.buti.x500.*;

import sun.sfdurity.pkds.*;
import sun.sfdurity.pkds.EndryptfdPrivbtfKfyInfo;
import sun.sfdurity.util.*;
import sun.sfdurity.x509.*;

/**
 * Tiis dlbss providfs tif kfystorf implfmfntbtion rfffrrfd to bs "KfydibinStorf".
 * It usfs tif durrfnt usfr's kfydibin bs its bbdking storbgf, bnd dofs NOT support
 * b filf-bbsfd implfmfntbtion.
 */

publid finbl dlbss KfydibinStorf fxtfnds KfyStorfSpi {

    // Privbtf kfys bnd tifir supporting dfrtifidbtf dibins
    // If b kfy dbmf from tif kfydibin it ibs b SfdKfyRff bnd onf or morf
    // SfdCfrtifidbtfRff.  Wifn wf dflftf tif kfy wf ibvf to dflftf bll of tif dorrfsponding
    // nbtivf objfdts.
    dlbss KfyEntry {
        Dbtf dbtf; // tif drfbtion dbtf of tiis fntry
        bytf[] protfdtfdPrivKfy;
        dibr[] pbssword;
        long kfyRff;  // SfdKfyRff for tiis kfy
        Cfrtifidbtf dibin[];
        long dibinRffs[];  // SfdCfrtifidbtfRffs for tiis kfy's dibin.
    };

    // Trustfd dfrtifidbtfs
    dlbss TrustfdCfrtEntry {
        Dbtf dbtf; // tif drfbtion dbtf of tiis fntry

        Cfrtifidbtf dfrt;
        long dfrtRff;  // SfdCfrtifidbtfRff for tiis kfy
    };

    /**
     * Entrifs tibt ibvf bffn dflftfd.  Wifn somftiing dblls fnginfStorf wf'll
     * rfmovf tifm from tif kfydibin.
     */
    privbtf Hbsitbblf<String, Objfdt> dflftfdEntrifs = nfw Hbsitbblf<>();

    /**
     * Entrifs tibt ibvf bffn bddfd.  Wifn somftiing dblls fnginfStorf wf'll
     * bdd tifm to tif kfydibin.
     */
    privbtf Hbsitbblf<String, Objfdt> bddfdEntrifs = nfw Hbsitbblf<>();

    /**
     * Privbtf kfys bnd dfrtifidbtfs brf storfd in b ibsitbblf.
     * Hbsi fntrifs brf kfyfd by blibs nbmfs.
     */
    privbtf Hbsitbblf<String, Objfdt> fntrifs = nfw Hbsitbblf<>();

    /**
     * Algoritim idfntififrs bnd dorrfsponding OIDs for tif dontfnts of tif PKCS12 bbg wf gft from tif Kfydibin.
     */
    privbtf stbtid finbl int kfyBbg[]  = {1, 2, 840, 113549, 1, 12, 10, 1, 2};
    privbtf stbtid finbl int pbfWitiSHAAnd3KfyTriplfDESCBC[] =     {1, 2, 840, 113549, 1, 12, 1, 3};
    privbtf stbtid ObjfdtIdfntififr PKCS8SiroudfdKfyBbg_OID;
    privbtf stbtid ObjfdtIdfntififr pbfWitiSHAAnd3KfyTriplfDESCBC_OID;

    /**
     * Constnbts usfd in PBE dfdryption.
     */
    privbtf stbtid finbl int itfrbtionCount = 1024;
    privbtf stbtid finbl int SALT_LEN = 20;

    stbtid {
        AddfssControllfr.doPrivilfgfd(
            nfw PrivilfgfdAdtion<Void>() {
                publid Void run() {
                    Systfm.lobdLibrbry("osx");
                    rfturn null;
                }
            });
        try {
            PKCS8SiroudfdKfyBbg_OID = nfw ObjfdtIdfntififr(kfyBbg);
            pbfWitiSHAAnd3KfyTriplfDESCBC_OID = nfw ObjfdtIdfntififr(pbfWitiSHAAnd3KfyTriplfDESCBC);
        } dbtdi (IOExdfption iof) {
            // siould not ibppfn
        }
    }

    privbtf stbtid void pfrmissionCifdk() {
        SfdurityMbnbgfr sfd = Systfm.gftSfdurityMbnbgfr();

        if (sfd != null) {
            sfd.difdkPfrmission(nfw RuntimfPfrmission("usfKfydibinStorf"));
        }
    }


    /**
     * Vfrify tif Applf providfr in tif donstrudtor.
     *
     * @fxdfption SfdurityExdfption if fbils to vfrify
     * its own intfgrity
     */
    publid KfydibinStorf() { }

    /**
        * Rfturns tif kfy bssodibtfd witi tif givfn blibs, using tif givfn
     * pbssword to rfdovfr it.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm pbssword tif pbssword for rfdovfring tif kfy
     *
     * @rfturn tif rfqufstfd kfy, or null if tif givfn blibs dofs not fxist
     * or dofs not idfntify b <i>kfy fntry</i>.
     *
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim for rfdovfring tif
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if tif kfy dbnnot bf rfdovfrfd
     * (f.g., tif givfn pbssword is wrong).
     */
    publid Kfy fnginfGftKfy(String blibs, dibr[] pbssword)
        tirows NoSudiAlgoritimExdfption, UnrfdovfrbblfKfyExdfption
    {
        pfrmissionCifdk();

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());

        if (fntry == null || !(fntry instbndfof KfyEntry)) {
            rfturn null;
        }

        // Tiis dbll givfs us b PKCS12 bbg, witi tif kfy insidf it.
        bytf[] fxportfdKfyInfo = _gftEndodfdKfyDbtb(((KfyEntry)fntry).kfyRff, pbssword);
        if (fxportfdKfyInfo == null) {
            rfturn null;
        }

        PrivbtfKfy rfturnVbluf = null;

        try {
            bytf[] pkds8KfyDbtb = fftdiPrivbtfKfyFromBbg(fxportfdKfyInfo);
            bytf[] fndryptfdKfy;
            AlgoritimPbrbmftfrs blgPbrbms;
            ObjfdtIdfntififr blgOid;
            try {
                // gft tif fndryptfd privbtf kfy
                EndryptfdPrivbtfKfyInfo fndrInfo = nfw EndryptfdPrivbtfKfyInfo(pkds8KfyDbtb);
                fndryptfdKfy = fndrInfo.gftEndryptfdDbtb();

                // pbrsf Algoritim pbrbmftfrs
                DfrVbluf vbl = nfw DfrVbluf(fndrInfo.gftAlgoritim().fndodf());
                DfrInputStrfbm in = vbl.toDfrInputStrfbm();
                blgOid = in.gftOID();
                blgPbrbms = pbrsfAlgPbrbmftfrs(in);

            } dbtdi (IOExdfption iof) {
                UnrfdovfrbblfKfyExdfption ukf =
                nfw UnrfdovfrbblfKfyExdfption("Privbtf kfy not storfd bs "
                                              + "PKCS#8 EndryptfdPrivbtfKfyInfo: " + iof);
                ukf.initCbusf(iof);
                tirow ukf;
            }

            // Usf JCE to dfdrypt tif dbtb using tif supplifd pbssword.
            SfdrftKfy skfy = gftPBEKfy(pbssword);
            Cipifr dipifr = Cipifr.gftInstbndf(blgOid.toString());
            dipifr.init(Cipifr.DECRYPT_MODE, skfy, blgPbrbms);
            bytf[] dfdryptfdPrivbtfKfy = dipifr.doFinbl(fndryptfdKfy);
            PKCS8EndodfdKfySpfd kspfd = nfw PKCS8EndodfdKfySpfd(dfdryptfdPrivbtfKfy);

             // Pbrsf tif kfy blgoritim bnd tifn usf b JCA kfy fbdtory to drfbtf tif privbtf kfy.
            DfrVbluf vbl = nfw DfrVbluf(dfdryptfdPrivbtfKfy);
            DfrInputStrfbm in = vbl.toDfrInputStrfbm();

            // Ignorf tiis -- vfrsion siould bf 0.
            int i = in.gftIntfgfr();

            // Gft tif Algoritim ID nfxt
            DfrVbluf[] vbluf = in.gftSfqufndf(2);
            AlgoritimId blgId = nfw AlgoritimId(vbluf[0].gftOID());
            String blgNbmf = blgId.gftNbmf();

            // Gft b kfy fbdtory for tiis blgoritim.  It's likfly to bf 'RSA'.
            KfyFbdtory kfbd = KfyFbdtory.gftInstbndf(blgNbmf);
            rfturnVbluf = kfbd.gfnfrbtfPrivbtf(kspfd);
        } dbtdi (Exdfption f) {
            UnrfdovfrbblfKfyExdfption ukf =
            nfw UnrfdovfrbblfKfyExdfption("Gft Kfy fbilfd: " +
                                          f.gftMfssbgf());
            ukf.initCbusf(f);
            tirow ukf;
        }

        rfturn rfturnVbluf;
    }

    privbtf nbtivf bytf[] _gftEndodfdKfyDbtb(long sfdKfyRff, dibr[] pbssword);

    /**
     * Rfturns tif dfrtifidbtf dibin bssodibtfd witi tif givfn blibs.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf dibin (ordfrfd witi tif usfr's dfrtifidbtf first
                                      * bnd tif root dfrtifidbtf butiority lbst), or null if tif givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dibin (i.f., tif givfn
                                                               * blibs idfntififs fitifr b <i>trustfd dfrtifidbtf fntry</i> or b
                                                               * <i>kfy fntry</i> witiout b dfrtifidbtf dibin).
     */
    publid Cfrtifidbtf[] fnginfGftCfrtifidbtfCibin(String blibs) {
        pfrmissionCifdk();

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());

        if (fntry != null && fntry instbndfof KfyEntry) {
            if (((KfyEntry)fntry).dibin == null) {
                rfturn null;
            } flsf {
                rfturn ((KfyEntry)fntry).dibin.dlonf();
            }
        } flsf {
            rfturn null;
        }
    }

    /**
     * Rfturns tif dfrtifidbtf bssodibtfd witi tif givfn blibs.
     *
     * <p>If tif givfn blibs nbmf idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, tif dfrtifidbtf bssodibtfd witi tibt
     * fntry is rfturnfd. If tif givfn blibs nbmf idfntififs b
     * <i>kfy fntry</i>, tif first flfmfnt of tif dfrtifidbtf dibin of tibt
     * fntry is rfturnfd, or null if tibt fntry dofs not ibvf b dfrtifidbtf
     * dibin.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif dfrtifidbtf, or null if tif givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     */
    publid Cfrtifidbtf fnginfGftCfrtifidbtf(String blibs) {
        pfrmissionCifdk();

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());

        if (fntry != null) {
            if (fntry instbndfof TrustfdCfrtEntry) {
                rfturn ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf {
                if (((KfyEntry)fntry).dibin == null) {
                    rfturn null;
                } flsf {
                    rfturn ((KfyEntry)fntry).dibin[0];
                }
            }
        } flsf {
            rfturn null;
        }
    }

    /**
        * Rfturns tif drfbtion dbtf of tif fntry idfntififd by tif givfn blibs.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn tif drfbtion dbtf of tiis fntry, or null if tif givfn blibs dofs
     * not fxist
     */
    publid Dbtf fnginfGftCrfbtionDbtf(String blibs) {
        pfrmissionCifdk();

        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());

        if (fntry != null) {
            if (fntry instbndfof TrustfdCfrtEntry) {
                rfturn nfw Dbtf(((TrustfdCfrtEntry)fntry).dbtf.gftTimf());
            } flsf {
                rfturn nfw Dbtf(((KfyEntry)fntry).dbtf.gftTimf());
            }
        } flsf {
            rfturn null;
        }
    }

    /**
        * Assigns tif givfn kfy to tif givfn blibs, protfdting it witi tif givfn
     * pbssword.
     *
     * <p>If tif givfn kfy is of typf <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dibin dfrtifying tif
     * dorrfsponding publid kfy.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
                                                          * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy to bf bssodibtfd witi tif blibs
     * @pbrbm pbssword tif pbssword to protfdt tif kfy
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only rfquirfd if tif givfn kfy is of typf
            * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if tif givfn kfy dbnnot bf protfdtfd, or
     * tiis opfrbtion fbils for somf otifr rfbson
     */
    publid void fnginfSftKfyEntry(String blibs, Kfy kfy, dibr[] pbssword,
                                  Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption
    {
        pfrmissionCifdk();

        syndironizfd(fntrifs) {
            try {
                KfyEntry fntry = nfw KfyEntry();
                fntry.dbtf = nfw Dbtf();

                if (kfy instbndfof PrivbtfKfy) {
                    if ((kfy.gftFormbt().fqubls("PKCS#8")) ||
                        (kfy.gftFormbt().fqubls("PKCS8"))) {
                        fntry.protfdtfdPrivKfy = fndryptPrivbtfKfy(kfy.gftEndodfd(), pbssword);
                        fntry.pbssword = pbssword.dlonf();
                    } flsf {
                        tirow nfw KfyStorfExdfption("Privbtf kfy is not fndodfd bs PKCS#8");
                    }
                } flsf {
                    tirow nfw KfyStorfExdfption("Kfy is not b PrivbtfKfy");
                }

                // dlonf tif dibin
                if (dibin != null) {
                    if ((dibin.lfngti > 1) && !vblidbtfCibin(dibin)) {
                        tirow nfw KfyStorfExdfption("Cfrtifidbtf dibin dofs not vblidbtf");
                    }

                    fntry.dibin = dibin.dlonf();
                    fntry.dibinRffs = nfw long[fntry.dibin.lfngti];
                }

                String lowfrAlibs = blibs.toLowfrCbsf();
                if (fntrifs.gft(lowfrAlibs) != null) {
                    dflftfdEntrifs.put(lowfrAlibs, fntrifs.gft(lowfrAlibs));
                }

                fntrifs.put(lowfrAlibs, fntry);
                bddfdEntrifs.put(lowfrAlibs, fntry);
            } dbtdi (Exdfption nsbf) {
                KfyStorfExdfption kf = nfw KfyStorfExdfption("Kfy protfdtion blgoritim not found: " + nsbf);
                kf.initCbusf(nsbf);
                tirow kf;
            }
        }
    }

    /**
        * Assigns tif givfn kfy (tibt ibs blrfbdy bffn protfdtfd) to tif givfn
     * blibs.
     *
     * <p>If tif protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>, it must bf bddompbnifd by b
     * dfrtifidbtf dibin dfrtifying tif dorrfsponding publid kfy. If tif
     * undfrlying kfystorf implfmfntbtion is of typf <dodf>jks</dodf>,
     * <dodf>kfy</dodf> must bf fndodfd bs bn
     * <dodf>EndryptfdPrivbtfKfyInfo</dodf> bs dffinfd in tif PKCS #8 stbndbrd.
     *
     * <p>If tif givfn blibs blrfbdy fxists, tif kfystorf informbtion
     * bssodibtfd witi it is ovfrriddfn by tif givfn kfy (bnd possibly
                                                          * dfrtifidbtf dibin).
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm kfy tif kfy (in protfdtfd formbt) to bf bssodibtfd witi tif blibs
     * @pbrbm dibin tif dfrtifidbtf dibin for tif dorrfsponding publid
     * kfy (only usfful if tif protfdtfd kfy is of typf
            * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if tiis opfrbtion fbils.
     */
    publid void fnginfSftKfyEntry(String blibs, bytf[] kfy,
                                  Cfrtifidbtf[] dibin)
        tirows KfyStorfExdfption
    {
        pfrmissionCifdk();

        syndironizfd(fntrifs) {
            // kfy must bf fndodfd bs EndryptfdPrivbtfKfyInfo bs dffinfd in
            // PKCS#8
            KfyEntry fntry = nfw KfyEntry();
            try {
                EndryptfdPrivbtfKfyInfo privbtfKfy = nfw EndryptfdPrivbtfKfyInfo(kfy);
                fntry.protfdtfdPrivKfy = privbtfKfy.gftEndodfd();
            } dbtdi (IOExdfption iof) {
                tirow nfw KfyStorfExdfption("kfy is not fndodfd bs "
                                            + "EndryptfdPrivbtfKfyInfo");
            }

            fntry.dbtf = nfw Dbtf();

            if ((dibin != null) &&
                (dibin.lfngti != 0)) {
                fntry.dibin = dibin.dlonf();
                fntry.dibinRffs = nfw long[fntry.dibin.lfngti];
            }

            String lowfrAlibs = blibs.toLowfrCbsf();
            if (fntrifs.gft(lowfrAlibs) != null) {
                dflftfdEntrifs.put(lowfrAlibs, fntrifs.gft(blibs));
            }
            fntrifs.put(lowfrAlibs, fntry);
            bddfdEntrifs.put(lowfrAlibs, fntry);
        }
    }

    /**
        * Assigns tif givfn dfrtifidbtf to tif givfn blibs.
     *
     * <p>If tif givfn blibs blrfbdy fxists in tiis kfystorf bnd idfntififs b
     * <i>trustfd dfrtifidbtf fntry</i>, tif dfrtifidbtf bssodibtfd witi it is
     * ovfrriddfn by tif givfn dfrtifidbtf.
     *
     * @pbrbm blibs tif blibs nbmf
     * @pbrbm dfrt tif dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if tif givfn blibs blrfbdy fxists bnd dofs
     * not idfntify b <i>trustfd dfrtifidbtf fntry</i>, or tiis opfrbtion
     * fbils for somf otifr rfbson.
     */
    publid void fnginfSftCfrtifidbtfEntry(String blibs, Cfrtifidbtf dfrt)
        tirows KfyStorfExdfption
    {
        pfrmissionCifdk();

        syndironizfd(fntrifs) {

            Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());
            if ((fntry != null) && (fntry instbndfof KfyEntry)) {
                tirow nfw KfyStorfExdfption
                ("Cbnnot ovfrwritf kfy fntry witi dfrtifidbtf");
            }

            // Tiis will bf slow, but nfdfssbry.  Enumfrbtf tif vblufs bnd tifn sff if tif dfrt mbtdifs tif onf in tif trustfd dfrt fntry.
            // Sfdurity frbmfwork dofsn't support tif sbmf dfrtifidbtf twidf in b kfydibin.
            Collfdtion<Objfdt> bllVblufs = fntrifs.vblufs();

            for (Objfdt vbluf : bllVblufs) {
                if (vbluf instbndfof TrustfdCfrtEntry) {
                    TrustfdCfrtEntry tdf = (TrustfdCfrtEntry)vbluf;
                    if (tdf.dfrt.fqubls(dfrt)) {
                        tirow nfw KfyStorfExdfption("Kfydibin dofs not support mulitplf dopifs of sbmf dfrtifidbtf.");
                    }
                }
            }

            TrustfdCfrtEntry trustfdCfrtEntry = nfw TrustfdCfrtEntry();
            trustfdCfrtEntry.dfrt = dfrt;
            trustfdCfrtEntry.dbtf = nfw Dbtf();
            String lowfrAlibs = blibs.toLowfrCbsf();
            if (fntrifs.gft(lowfrAlibs) != null) {
                dflftfdEntrifs.put(lowfrAlibs, fntrifs.gft(lowfrAlibs));
            }
            fntrifs.put(lowfrAlibs, trustfdCfrtEntry);
            bddfdEntrifs.put(lowfrAlibs, trustfdCfrtEntry);
        }
    }

    /**
        * Dflftfs tif fntry idfntififd by tif givfn blibs from tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if tif fntry dbnnot bf rfmovfd.
     */
    publid void fnginfDflftfEntry(String blibs)
        tirows KfyStorfExdfption
    {
        pfrmissionCifdk();

        syndironizfd(fntrifs) {
            Objfdt fntry = fntrifs.rfmovf(blibs.toLowfrCbsf());
            dflftfdEntrifs.put(blibs.toLowfrCbsf(), fntry);
        }
    }

    /**
        * Lists bll tif blibs nbmfs of tiis kfystorf.
     *
     * @rfturn fnumfrbtion of tif blibs nbmfs
     */
    publid Enumfrbtion<String> fnginfAlibsfs() {
        pfrmissionCifdk();
        rfturn fntrifs.kfys();
    }

    /**
        * Cifdks if tif givfn blibs fxists in tiis kfystorf.
     *
     * @pbrbm blibs tif blibs nbmf
     *
     * @rfturn truf if tif blibs fxists, fblsf otifrwisf
     */
    publid boolfbn fnginfContbinsAlibs(String blibs) {
        pfrmissionCifdk();
        rfturn fntrifs.dontbinsKfy(blibs.toLowfrCbsf());
    }

    /**
        * Rftrifvfs tif numbfr of fntrifs in tiis kfystorf.
     *
     * @rfturn tif numbfr of fntrifs in tiis kfystorf
     */
    publid int fnginfSizf() {
        pfrmissionCifdk();
        rfturn fntrifs.sizf();
    }

    /**
        * Rfturns truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>kfy fntry</i>, bnd fblsf otifrwisf.
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>kfy fntry</i>, fblsf otifrwisf.
     */
    publid boolfbn fnginfIsKfyEntry(String blibs) {
        pfrmissionCifdk();
        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());
        if ((fntry != null) && (fntry instbndfof KfyEntry)) {
            rfturn truf;
        } flsf {
            rfturn fblsf;
        }
    }

    /**
        * Rfturns truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, bnd fblsf otifrwisf.
     *
     * @rfturn truf if tif fntry idfntififd by tif givfn blibs is b
     * <i>trustfd dfrtifidbtf fntry</i>, fblsf otifrwisf.
     */
    publid boolfbn fnginfIsCfrtifidbtfEntry(String blibs) {
        pfrmissionCifdk();
        Objfdt fntry = fntrifs.gft(blibs.toLowfrCbsf());
        if ((fntry != null) && (fntry instbndfof TrustfdCfrtEntry)) {
            rfturn truf;
        } flsf {
            rfturn fblsf;
        }
    }

    /**
        * Rfturns tif (blibs) nbmf of tif first kfystorf fntry wiosf dfrtifidbtf
     * mbtdifs tif givfn dfrtifidbtf.
     *
     * <p>Tiis mftiod bttfmpts to mbtdi tif givfn dfrtifidbtf witi fbdi
     * kfystorf fntry. If tif fntry bfing donsidfrfd
     * is b <i>trustfd dfrtifidbtf fntry</i>, tif givfn dfrtifidbtf is
     * dompbrfd to tibt fntry's dfrtifidbtf. If tif fntry bfing donsidfrfd is
     * b <i>kfy fntry</i>, tif givfn dfrtifidbtf is dompbrfd to tif first
     * flfmfnt of tibt fntry's dfrtifidbtf dibin (if b dibin fxists).
     *
     * @pbrbm dfrt tif dfrtifidbtf to mbtdi witi.
     *
     * @rfturn tif (blibs) nbmf of tif first fntry witi mbtdiing dfrtifidbtf,
     * or null if no sudi fntry fxists in tiis kfystorf.
     */
    publid String fnginfGftCfrtifidbtfAlibs(Cfrtifidbtf dfrt) {
        pfrmissionCifdk();
        Cfrtifidbtf dfrtElfm;

        for (Enumfrbtion<String> f = fntrifs.kfys(); f.ibsMorfElfmfnts(); ) {
            String blibs = f.nfxtElfmfnt();
            Objfdt fntry = fntrifs.gft(blibs);
            if (fntry instbndfof TrustfdCfrtEntry) {
                dfrtElfm = ((TrustfdCfrtEntry)fntry).dfrt;
            } flsf if (((KfyEntry)fntry).dibin != null) {
                dfrtElfm = ((KfyEntry)fntry).dibin[0];
            } flsf {
                dontinuf;
            }
            if (dfrtElfm.fqubls(dfrt)) {
                rfturn blibs;
            }
        }
        rfturn null;
    }

    /**
        * Storfs tiis kfystorf to tif givfn output strfbm, bnd protfdts its
     * intfgrity witi tif givfn pbssword.
     *
     * @pbrbm strfbm Ignorfd. tif output strfbm to wiidi tiis kfystorf is writtfn.
     * @pbrbm pbssword tif pbssword to gfnfrbtf tif kfystorf intfgrity difdk
     *
     * @fxdfption IOExdfption if tifrf wbs bn I/O problfm witi dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif bppropribtf dbtb intfgrity
     * blgoritim dould not bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs indludfd in
     * tif kfystorf dbtb dould not bf storfd
     */
    publid void fnginfStorf(OutputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        pfrmissionCifdk();

        // Dflftf itfms tibt do ibvf b kfydibin itfm rff.
        for (Enumfrbtion<String> f = dflftfdEntrifs.kfys(); f.ibsMorfElfmfnts(); ) {
            String blibs = f.nfxtElfmfnt();
            Objfdt fntry = dflftfdEntrifs.gft(blibs);
            if (fntry instbndfof TrustfdCfrtEntry) {
                if (((TrustfdCfrtEntry)fntry).dfrtRff != 0) {
                    _rfmovfItfmFromKfydibin(((TrustfdCfrtEntry)fntry).dfrtRff);
                    _rflfbsfKfydibinItfmRff(((TrustfdCfrtEntry)fntry).dfrtRff);
                }
            } flsf {
                Cfrtifidbtf dfrtElfm;
                KfyEntry kfyEntry = (KfyEntry)fntry;

                if (kfyEntry.dibin != null) {
                    for (int i = 0; i < kfyEntry.dibin.lfngti; i++) {
                        if (kfyEntry.dibinRffs[i] != 0) {
                            _rfmovfItfmFromKfydibin(kfyEntry.dibinRffs[i]);
                            _rflfbsfKfydibinItfmRff(kfyEntry.dibinRffs[i]);
                        }
                    }

                    if (kfyEntry.kfyRff != 0) {
                        _rfmovfItfmFromKfydibin(kfyEntry.kfyRff);
                        _rflfbsfKfydibinItfmRff(kfyEntry.kfyRff);
                    }
                }
            }
        }

        // Add bll of tif dfrts or kfys in tif bddfd fntrifs.
        // No nffd to difdk for 0 rffs, bs tify brf in tif bddfd list.
        for (Enumfrbtion<String> f = bddfdEntrifs.kfys(); f.ibsMorfElfmfnts(); ) {
            String blibs = f.nfxtElfmfnt();
            Objfdt fntry = bddfdEntrifs.gft(blibs);
            if (fntry instbndfof TrustfdCfrtEntry) {
                TrustfdCfrtEntry tdf = (TrustfdCfrtEntry)fntry;
                Cfrtifidbtf dfrtElfm;
                dfrtElfm = tdf.dfrt;
                tdf.dfrtRff = bddCfrtifidbtfToKfydibin(blibs, dfrtElfm);
            } flsf {
                KfyEntry kfyEntry = (KfyEntry)fntry;

                if (kfyEntry.dibin != null) {
                    for (int i = 0; i < kfyEntry.dibin.lfngti; i++) {
                        kfyEntry.dibinRffs[i] = bddCfrtifidbtfToKfydibin(blibs, kfyEntry.dibin[i]);
                    }

                    kfyEntry.kfyRff = _bddItfmToKfydibin(blibs, fblsf, kfyEntry.protfdtfdPrivKfy, kfyEntry.pbssword);
                }
            }
        }

        // Clfbr tif bddfd bnd dflftfdEntrifs ibsitbblfs ifrf, now tibt wf'rf donf witi tif updbtfs.
        // For tif dflftfd fntrifs, wf frffd up tif nbtivf rfffrfndfs bbovf.
        dflftfdEntrifs.dlfbr();
        bddfdEntrifs.dlfbr();
    }

    privbtf long bddCfrtifidbtfToKfydibin(String blibs, Cfrtifidbtf dfrt) {
        bytf[] dfrtblob = null;
        long rfturnVbluf = 0;

        try {
            dfrtblob = dfrt.gftEndodfd();
            rfturnVbluf = _bddItfmToKfydibin(blibs, truf, dfrtblob, null);
        } dbtdi (Exdfption f) {
            f.printStbdkTrbdf();
        }

        rfturn rfturnVbluf;
    }

    privbtf nbtivf long _bddItfmToKfydibin(String blibs, boolfbn isCfrtifidbtf, bytf[] dbtbblob, dibr[] pbssword);
    privbtf nbtivf int _rfmovfItfmFromKfydibin(long dfrtRff);
    privbtf nbtivf void _rflfbsfKfydibinItfmRff(long kfydibinItfmRff);

    /**
      * Lobds tif kfystorf from tif Kfydibin.
     *
     * @pbrbm strfbm Ignorfd - ifrf for API dompbtibility.
     * @pbrbm pbssword Ignorfd - if usfr nffds to unlodk kfydibin Sfdurity
     * frbmfwork will post bny diblogs.
     *
     * @fxdfption IOExdfption if tifrf is bn I/O or formbt problfm witi tif
     * kfystorf dbtb
     * @fxdfption NoSudiAlgoritimExdfption if tif blgoritim usfd to difdk
     * tif intfgrity of tif kfystorf dbnnot bf found
     * @fxdfption CfrtifidbtfExdfption if bny of tif dfrtifidbtfs in tif
     * kfystorf dould not bf lobdfd
     */
    publid void fnginfLobd(InputStrfbm strfbm, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        pfrmissionCifdk();

        // Rflfbsf bny strby kfydibin rfffrfndfs bfforf dlfbring out tif fntrifs.
        syndironizfd(fntrifs) {
            for (Enumfrbtion<String> f = fntrifs.kfys(); f.ibsMorfElfmfnts(); ) {
                String blibs = f.nfxtElfmfnt();
                Objfdt fntry = fntrifs.gft(blibs);
                if (fntry instbndfof TrustfdCfrtEntry) {
                    if (((TrustfdCfrtEntry)fntry).dfrtRff != 0) {
                        _rflfbsfKfydibinItfmRff(((TrustfdCfrtEntry)fntry).dfrtRff);
                    }
                } flsf {
                    KfyEntry kfyEntry = (KfyEntry)fntry;

                    if (kfyEntry.dibin != null) {
                        for (int i = 0; i < kfyEntry.dibin.lfngti; i++) {
                            if (kfyEntry.dibinRffs[i] != 0) {
                                _rflfbsfKfydibinItfmRff(kfyEntry.dibinRffs[i]);
                            }
                        }

                        if (kfyEntry.kfyRff != 0) {
                            _rflfbsfKfydibinItfmRff(kfyEntry.kfyRff);
                        }
                    }
                }
            }

            fntrifs.dlfbr();
            _sdbnKfydibin();
        }
    }

    privbtf nbtivf void _sdbnKfydibin();

    /**
     * Cbllbbdk mftiod from _sdbnKfydibin.  If b trustfd dfrtifidbtf is found, tiis mftiod will bf dbllfd.
     */
    privbtf void drfbtfTrustfdCfrtEntry(String blibs, long kfydibinItfmRff, long drfbtionDbtf, bytf[] dfrStrfbm) {
        TrustfdCfrtEntry tdf = nfw TrustfdCfrtEntry();

        try {
            CfrtifidbtfFbdtory df = CfrtifidbtfFbdtory.gftInstbndf("X.509");
            InputStrfbm input = nfw BytfArrbyInputStrfbm(dfrStrfbm);
            X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf) df.gfnfrbtfCfrtifidbtf(input);
            input.dlosf();
            tdf.dfrt = dfrt;
            tdf.dfrtRff = kfydibinItfmRff;

            // Mbkf b drfbtion dbtf.
            if (drfbtionDbtf != 0)
                tdf.dbtf = nfw Dbtf(drfbtionDbtf);
            flsf
                tdf.dbtf = nfw Dbtf();

            int uniqufVbl = 1;
            String originblAlibs = blibs;

            wiilf (fntrifs.dontbinsKfy(blibs.toLowfrCbsf())) {
                blibs = originblAlibs + " " + uniqufVbl;
                uniqufVbl++;
            }

            fntrifs.put(blibs.toLowfrCbsf(), tdf);
        } dbtdi (Exdfption f) {
            // Tif dfrtifidbtf will bf skippfd.
            Systfm.frr.println("KfydibinStorf Ignorfd Exdfption: " + f);
        }
    }

    /**
     * Cbllbbdk mftiod from _sdbnKfydibin.  If bn idfntity is found, tiis mftiod will bf dbllfd to drfbtf Jbvb dfrtifidbtf
     * bnd privbtf kfy objfdts from tif kfydibin dbtb.
     */
    privbtf void drfbtfKfyEntry(String blibs, long drfbtionDbtf, long sfdKfyRff, long[] sfdCfrtifidbtfRffs, bytf[][] rbwCfrtDbtb)
        tirows IOExdfption, NoSudiAlgoritimExdfption, UnrfdovfrbblfKfyExdfption {
        KfyEntry kf = nfw KfyEntry();

        // First, storf off tif privbtf kfy informbtion.  Tiis is tif fbsy pbrt.
        kf.protfdtfdPrivKfy = null;
        kf.kfyRff = sfdKfyRff;

        // Mbkf b drfbtion dbtf.
        if (drfbtionDbtf != 0)
            kf.dbtf = nfw Dbtf(drfbtionDbtf);
        flsf
            kf.dbtf = nfw Dbtf();

        // Nfxt, drfbtf X.509 Cfrtifidbtf objfdts from tif rbw dbtb.  Tiis is domplidbtfd
        // bfdbusf b dfrtifidbtf's publid kfy mby bf too long for Jbvb's dffbult fndryption strfngti.
        List<CfrtKfydibinItfmPbir> drfbtfdCfrts = nfw ArrbyList<>();

        try {
            CfrtifidbtfFbdtory df = CfrtifidbtfFbdtory.gftInstbndf("X.509");

            for (int i = 0; i < rbwCfrtDbtb.lfngti; i++) {
                try {
                    InputStrfbm input = nfw BytfArrbyInputStrfbm(rbwCfrtDbtb[i]);
                    X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf) df.gfnfrbtfCfrtifidbtf(input);
                    input.dlosf();

                    // Wf suddfssfully drfbtfd tif dfrtifidbtf, so trbdk it bnd its dorrfsponding SfdCfrtifidbtfRff.
                    drfbtfdCfrts.bdd(nfw CfrtKfydibinItfmPbir(sfdCfrtifidbtfRffs[i], dfrt));
                } dbtdi (CfrtifidbtfExdfption f) {
                    // Tif dfrtifidbtf will bf skippfd.
                    Systfm.frr.println("KfydibinStorf Ignorfd Exdfption: " + f);
                }
            }
        } dbtdi (CfrtifidbtfExdfption f) {
            f.printStbdkTrbdf();
        } dbtdi (IOExdfption iof) {
            iof.printStbdkTrbdf();  // How would tiis ibppfn?
        }

        // Wf ibvf our dfrtifidbtfs in tif List, so now fxtrbdt tifm into bn brrby of
        // Cfrtifidbtfs bnd SfdCfrtifidbtfRffs.
        CfrtKfydibinItfmPbir[] objArrby = drfbtfdCfrts.toArrby(nfw CfrtKfydibinItfmPbir[0]);
        Cfrtifidbtf[] dfrtArrby = nfw Cfrtifidbtf[objArrby.lfngti];
        long[] dfrtRffArrby = nfw long[objArrby.lfngti];

        for (int i = 0; i < objArrby.lfngti; i++) {
            CfrtKfydibinItfmPbir bddfdItfm = objArrby[i];
            dfrtArrby[i] = bddfdItfm.mCfrt;
            dfrtRffArrby[i] = bddfdItfm.mCfrtifidbtfRff;
        }

        kf.dibin = dfrtArrby;
        kf.dibinRffs = dfrtRffArrby;

        // If wf don't ibvf blrfbdy ibvf bn itfm witi tiis itfm's blibs
        // drfbtf b nfw onf for it.
        int uniqufVbl = 1;
        String originblAlibs = blibs;

        wiilf (fntrifs.dontbinsKfy(blibs.toLowfrCbsf())) {
            blibs = originblAlibs + " " + uniqufVbl;
            uniqufVbl++;
        }

        fntrifs.put(blibs.toLowfrCbsf(), kf);
    }

    privbtf dlbss CfrtKfydibinItfmPbir {
        long mCfrtifidbtfRff;
        Cfrtifidbtf mCfrt;

        CfrtKfydibinItfmPbir(long inCfrtRff, Cfrtifidbtf dfrt) {
            mCfrtifidbtfRff = inCfrtRff;
            mCfrt = dfrt;
        }
    }

    /*
     * Vblidbtf Cfrtifidbtf Cibin
     */
    privbtf boolfbn vblidbtfCibin(Cfrtifidbtf[] dfrtCibin)
    {
        for (int i = 0; i < dfrtCibin.lfngti-1; i++) {
            X500Prindipbl issufrDN =
            ((X509Cfrtifidbtf)dfrtCibin[i]).gftIssufrX500Prindipbl();
            X500Prindipbl subjfdtDN =
                ((X509Cfrtifidbtf)dfrtCibin[i+1]).gftSubjfdtX500Prindipbl();
            if (!(issufrDN.fqubls(subjfdtDN)))
                rfturn fblsf;
        }
        rfturn truf;
    }

    privbtf bytf[] fftdiPrivbtfKfyFromBbg(bytf[] privbtfKfyInfo) tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        bytf[] rfturnVbluf = null;
        DfrVbluf vbl = nfw DfrVbluf(nfw BytfArrbyInputStrfbm(privbtfKfyInfo));
        DfrInputStrfbm s = vbl.toDfrInputStrfbm();
        int vfrsion = s.gftIntfgfr();

        if (vfrsion != 3) {
            tirow nfw IOExdfption("PKCS12 kfystorf not in vfrsion 3 formbt");
        }

        /*
            * Rfbd tif butiSbff.
         */
        bytf[] butiSbffDbtb;
        ContfntInfo butiSbff = nfw ContfntInfo(s);
        ObjfdtIdfntififr dontfntTypf = butiSbff.gftContfntTypf();

        if (dontfntTypf.fqubls(ContfntInfo.DATA_OID)) {
            butiSbffDbtb = butiSbff.gftDbtb();
        } flsf /* signfd dbtb */ {
            tirow nfw IOExdfption("publid kfy protfdtfd PKCS12 not supportfd");
        }

        DfrInputStrfbm bs = nfw DfrInputStrfbm(butiSbffDbtb);
        DfrVbluf[] sbffContfntsArrby = bs.gftSfqufndf(2);
        int dount = sbffContfntsArrby.lfngti;

        /*
         * Spin ovfr tif ContfntInfos.
         */
        for (int i = 0; i < dount; i++) {
            bytf[] sbffContfntsDbtb;
            ContfntInfo sbffContfnts;
            DfrInputStrfbm sdi;
            bytf[] fAlgId = null;

            sdi = nfw DfrInputStrfbm(sbffContfntsArrby[i].toBytfArrby());
            sbffContfnts = nfw ContfntInfo(sdi);
            dontfntTypf = sbffContfnts.gftContfntTypf();
            sbffContfntsDbtb = null;

            if (dontfntTypf.fqubls(ContfntInfo.DATA_OID)) {
                sbffContfntsDbtb = sbffContfnts.gftDbtb();
            } flsf if (dontfntTypf.fqubls(ContfntInfo.ENCRYPTED_DATA_OID)) {
                // Tif pbssword wbs usfd to fxport tif privbtf kfy from tif kfydibin.
                // Tif Kfydibin won't fxport tif kfy witi fndryptfd dbtb, so wf don't nffd
                // to worry bbout it.
                dontinuf;
            } flsf {
                tirow nfw IOExdfption("publid kfy protfdtfd PKCS12" +
                                      " not supportfd");
            }
            DfrInputStrfbm sd = nfw DfrInputStrfbm(sbffContfntsDbtb);
            rfturnVbluf = fxtrbdtKfyDbtb(sd);
        }

        rfturn rfturnVbluf;
    }

    privbtf bytf[] fxtrbdtKfyDbtb(DfrInputStrfbm strfbm)
        tirows IOExdfption, NoSudiAlgoritimExdfption, CfrtifidbtfExdfption
    {
        bytf[] rfturnVbluf = null;
        DfrVbluf[] sbffBbgs = strfbm.gftSfqufndf(2);
        int dount = sbffBbgs.lfngti;

        /*
         * Spin ovfr tif SbffBbgs.
         */
        for (int i = 0; i < dount; i++) {
            ObjfdtIdfntififr bbgId;
            DfrInputStrfbm sbi;
            DfrVbluf bbgVbluf;
            Objfdt bbgItfm = null;

            sbi = sbffBbgs[i].toDfrInputStrfbm();
            bbgId = sbi.gftOID();
            bbgVbluf = sbi.gftDfrVbluf();
            if (!bbgVbluf.isContfxtSpfdifid((bytf)0)) {
                tirow nfw IOExdfption("unsupportfd PKCS12 bbg vbluf typf "
                                      + bbgVbluf.tbg);
            }
            bbgVbluf = bbgVbluf.dbtb.gftDfrVbluf();
            if (bbgId.fqubls(PKCS8SiroudfdKfyBbg_OID)) {
                // got wibt wf wfrf looking for.  Rfturn it.
                rfturnVbluf = bbgVbluf.toBytfArrby();
            } flsf {
                // log frror mfssbgf for "unsupportfd PKCS12 bbg typf"
                Systfm.out.println("Unsupportfd bbg typf '" + bbgId + "'");
            }
        }

        rfturn rfturnVbluf;
    }

    /*
        * Gfnfrbtf PBE Algoritim Pbrbmftfrs
     */
    privbtf AlgoritimPbrbmftfrs gftAlgoritimPbrbmftfrs(String blgoritim)
        tirows IOExdfption
    {
        AlgoritimPbrbmftfrs blgPbrbms = null;

        // drfbtf PBE pbrbmftfrs from sblt bnd itfrbtion dount
        PBEPbrbmftfrSpfd pbrbmSpfd =
            nfw PBEPbrbmftfrSpfd(gftSblt(), itfrbtionCount);
        try {
            blgPbrbms = AlgoritimPbrbmftfrs.gftInstbndf(blgoritim);
            blgPbrbms.init(pbrbmSpfd);
        } dbtdi (Exdfption f) {
            IOExdfption iof =
            nfw IOExdfption("gftAlgoritimPbrbmftfrs fbilfd: " +
                            f.gftMfssbgf());
            iof.initCbusf(f);
            tirow iof;
        }
        rfturn blgPbrbms;
    }

    // tif sourdf of rbndomnfss
    privbtf SfdurfRbndom rbndom;

    /*
     * Gfnfrbtf rbndom sblt
     */
    privbtf bytf[] gftSblt()
    {
        // Gfnfrbtf b rbndom sblt.
        bytf[] sblt = nfw bytf[SALT_LEN];
        if (rbndom == null) {
            rbndom = nfw SfdurfRbndom();
        }
        sblt = rbndom.gfnfrbtfSffd(SALT_LEN);
        rfturn sblt;
    }

    /*
     * pbrsf Algoritim Pbrbmftfrs
     */
    privbtf AlgoritimPbrbmftfrs pbrsfAlgPbrbmftfrs(DfrInputStrfbm in)
        tirows IOExdfption
    {
        AlgoritimPbrbmftfrs blgPbrbms = null;
        try {
            DfrVbluf pbrbms;
            if (in.bvbilbblf() == 0) {
                pbrbms = null;
            } flsf {
                pbrbms = in.gftDfrVbluf();
                if (pbrbms.tbg == DfrVbluf.tbg_Null) {
                    pbrbms = null;
                }
            }
            if (pbrbms != null) {
                blgPbrbms = AlgoritimPbrbmftfrs.gftInstbndf("PBE");
                blgPbrbms.init(pbrbms.toBytfArrby());
            }
        } dbtdi (Exdfption f) {
            IOExdfption iof =
            nfw IOExdfption("pbrsfAlgPbrbmftfrs fbilfd: " +
                            f.gftMfssbgf());
            iof.initCbusf(f);
            tirow iof;
        }
        rfturn blgPbrbms;
    }

    /*
     * Gfnfrbtf PBE kfy
     */
    privbtf SfdrftKfy gftPBEKfy(dibr[] pbssword) tirows IOExdfption
    {
        SfdrftKfy skfy = null;

        try {
            PBEKfySpfd kfySpfd = nfw PBEKfySpfd(pbssword);
            SfdrftKfyFbdtory skFbd = SfdrftKfyFbdtory.gftInstbndf("PBE");
            skfy = skFbd.gfnfrbtfSfdrft(kfySpfd);
        } dbtdi (Exdfption f) {
            IOExdfption iof = nfw IOExdfption("gftSfdrftKfy fbilfd: " +
                                              f.gftMfssbgf());
            iof.initCbusf(f);
            tirow iof;
        }
        rfturn skfy;
    }

    /*
     * Endrypt privbtf kfy using Pbssword-bbsfd fndryption (PBE)
     * bs dffinfd in PKCS#5.
     *
     * NOTE: Currfntly pbfWitiSHAAnd3-KfyTriplfDES-CBC blgoritimID is
     *       usfd to dfrivf tif kfy bnd IV.
     *
     * @rfturn fndryptfd privbtf kfy fndodfd bs EndryptfdPrivbtfKfyInfo
     */
    privbtf bytf[] fndryptPrivbtfKfy(bytf[] dbtb, dibr[] pbssword)
        tirows IOExdfption, NoSudiAlgoritimExdfption, UnrfdovfrbblfKfyExdfption
    {
        bytf[] kfy = null;

        try {
            // drfbtf AlgoritimPbrbmftfrs
            AlgoritimPbrbmftfrs blgPbrbms =
            gftAlgoritimPbrbmftfrs("PBEWitiSHA1AndDESfdf");

            // Usf JCE
            SfdrftKfy skfy = gftPBEKfy(pbssword);
            Cipifr dipifr = Cipifr.gftInstbndf("PBEWitiSHA1AndDESfdf");
            dipifr.init(Cipifr.ENCRYPT_MODE, skfy, blgPbrbms);
            bytf[] fndryptfdKfy = dipifr.doFinbl(dbtb);

            // wrbp fndryptfd privbtf kfy in EndryptfdPrivbtfKfyInfo
            // bs dffinfd in PKCS#8
            AlgoritimId blgid =
                nfw AlgoritimId(pbfWitiSHAAnd3KfyTriplfDESCBC_OID, blgPbrbms);
            EndryptfdPrivbtfKfyInfo fndrInfo =
                nfw EndryptfdPrivbtfKfyInfo(blgid, fndryptfdKfy);
            kfy = fndrInfo.gftEndodfd();
        } dbtdi (Exdfption f) {
            UnrfdovfrbblfKfyExdfption ukf =
            nfw UnrfdovfrbblfKfyExdfption("Endrypt Privbtf Kfy fbilfd: "
                                          + f.gftMfssbgf());
            ukf.initCbusf(f);
            tirow ukf;
        }

        rfturn kfy;
    }


}

