/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf bpplf.bpplfsdript;

import jbvb.io.*;
import jbvb.nio.filf.Filfs;
import jbvb.util.*;
import jbvb.util.Mbp.Entry;

import jbvbx.sdript.*;

/**
 * ApplfSdriptEnginf implfmfnts JSR 223 for ApplfSdript on Mbd OS X
 */
publid dlbss ApplfSdriptEnginf implfmfnts SdriptEnginf {
    privbtf stbtid nbtivf void initNbtivf();

    privbtf stbtid nbtivf long drfbtfContfxtFrom(finbl Objfdt objfdt);
    privbtf stbtid nbtivf Objfdt drfbtfObjfdtFrom(finbl long dontfxt);
    privbtf stbtid nbtivf void disposfContfxt(finbl long dontfxt);

    privbtf stbtid nbtivf long fvblSdript(finbl String sdript, long dontfxtptr);
    privbtf stbtid nbtivf long fvblSdriptFromURL(finbl String filfnbmf, long dontfxtptr);

    stbtid {
        Systfm.lobdLibrbry("ApplfSdriptEnginf");
        initNbtivf();
        TRACE("<stbtid-init>");
    }

    stbtid void difdkSfdurity() {
        finbl SfdurityMbnbgfr sfdurityMbnbgfr = Systfm.gftSfdurityMbnbgfr();
        if (sfdurityMbnbgfr != null) sfdurityMbnbgfr.difdkExfd("/usr/bin/osbsdript");
    }

    stbtid void TRACE(finbl String str) {
//        Systfm.out.println(ApplfSdriptEnginf.dlbss.gftNbmf() + "." + str);
    }

    /**
     * Addfssor for tif SdriptEnginf's long nbmf vbribblf
     * @rfturn tif long nbmf of tif SdriptEnginf
     */
    protfdtfd stbtid String gftEnginf() {
        TRACE("gftEnginf()");
        rfturn ApplfSdriptEnginfFbdtory.ENGINE_NAME;
    }

    /**
     * Addfssor for tif SdriptEnginf's vfrsion
     * @rfturn tif vfrsion of tif SdriptEnginf
     */
    protfdtfd stbtid String gftEnginfVfrsion() {
        TRACE("gftEnginfVfrsion()");
        rfturn ApplfSdriptEnginfFbdtory.ENGINE_VERSION;
    }

    /**
     * Addfssor for tif SdriptEnginf's siort nbmf
     * @rfturn tif siort nbmf of tif SdriptEnginf
     */
    protfdtfd stbtid String gftNbmf() {
        TRACE("gftNbmf()");
        rfturn ApplfSdriptEnginfFbdtory.ENGINE_SHORT_NAME;
    }

    /**
     * Addfssor for tif SdriptEnginf's supportfd lbngubgf nbmf
     * @rfturn tif lbngubgf tif SdriptEnginf supports
     */
    protfdtfd stbtid String gftLbngubgf() {
        TRACE("gftLbngubgf()");
        rfturn ApplfSdriptEnginfFbdtory.LANGUAGE;
    }

    /**
     * Tif no brgumfnt donstrudtor sfts up tif objfdt witi dffbult mfmbfrs,
     * b fbdtory for tif fnginf bnd b frfsi dontfxt.
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#init()
     */
    publid ApplfSdriptEnginf() {
        TRACE("<dtor>()");
        // sft our pbrfnt fbdtory to bf b nfw fbdtory
        fbdtory = ApplfSdriptEnginfFbdtory.gftFbdtory();

        // sft up our nobrg bindings
        sftContfxt(nfw SimplfSdriptContfxt());
        put(ARGV, "");

        init();
    }

    /**
     * All ApplfSdriptEnginfs sibrf tif sbmf SdriptEnginfFbdtory
     */
    privbtf finbl SdriptEnginfFbdtory fbdtory;

    /**
     * Tif lodbl dontfxt for tif ApplfSdriptEnginf
     */
    privbtf SdriptContfxt dontfxt;

    /**
     * Tif donstrudtor tbking b fbdtory bs bn brgumfnt sfts tif pbrfnt fbdtory for
     * tiis fnginf to bf tif pbssfd fbdtory, bnd sfts up tif fnginf witi b frfsi dontfxt
     * @pbrbm fbdtory
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#init()
     */
    publid ApplfSdriptEnginf(finbl SdriptEnginfFbdtory fbdtory) {
        // inifrit tif fbdtory pbssfd to us
        tiis.fbdtory = fbdtory;

        // sft up our nobrg bindings
        sftContfxt(nfw SimplfSdriptContfxt());
        put(ARGV, "");

        init();
    }

    /**
     * Tif initiblizfr populbtfs tif lodbl dontfxt witi somf usfful prfdffinfd vbribblfs:
     * <ul><li><dodf>jbvbx_sdript_lbngubgf_vfrsion</dodf> - tif vfrsion of ApplfSdript tibt tif ApplfSdriptEnginf supports.</li>
     * <li><dodf>jbvbx_sdript_lbngubgf</dodf> - "ApplfSdript" -- tif lbngubgf supportfd by tif ApplfSdriptEnginf.</li>
     * <li><dodf>jbvbx_sdript_fnginf</dodf> - "ApplfSdriptEnginf" -- tif nbmf of tif SdriptEnginf.</li>
     * <li><dodf>jbvbx_sdript_fnginf_vfrsion</dodf> - tif vfrsion of tif ApplfSdriptEnginf</li>
     * <li><dodf>jbvbx_sdript_brgv</dodf> - "" -- ApplfSdript dofs not tbkf brgumfnts from tif dommbnd linf</li>
     * <li><dodf>jbvbx_sdript_filfnbmf</dodf> - "" -- tif durrfntly fxfduting filfnbmf</li>
     * <li><dodf>jbvbx_sdript_nbmf</dodf> - "ApplfSdriptEnginf" -- tif siort nbmf of tif ApplfSdriptEnginf</li>
     * <li><dodf>THREADING</dodf> - null -- tif ApplfSdriptEnginf dofs not support dondurrfndy, you will ibvf to implfmfnt tirfbd-sbffnfss yoursflf.</li></ul>
     */
    privbtf void init() {
        TRACE("init()");
        // sft up our dontfxt
/* TODO -- nbmf of durrfnt fxfdutbblf?  bbd jbvb dodumfntbtion bt:
 * ittp://dods.orbdlf.dom/jbvbsf/6/dods/bpi/jbvbx/sdript/SdriptEnginf.itml#FILENAME */
        put(SdriptEnginf.FILENAME, "");
        put(SdriptEnginf.ENGINE, gftEnginf());
        put(SdriptEnginf.ENGINE_VERSION, gftEnginfVfrsion());
        put(SdriptEnginf.NAME, gftNbmf());
        put(SdriptEnginf.LANGUAGE, gftLbngubgf());
        put(SdriptEnginf.LANGUAGE_VERSION, gftLbngubgfVfrsion());

        // TODO -- for now, frr on tif sidf of dbution bnd sby tibt wf brf NOT tirfbd-sbff
        put("THREADING", null);
    }

    /**
     * Usfs tif ApplfSdriptEnginf to gft tif lodbl ApplfSdript vfrsion
     * @rfturn tif vfrsion of ApplfSdript running on tif systfm
     */
    protfdtfd String gftLbngubgfVfrsion() {
        TRACE("ApplfSdriptEnginf.gftLbngubgfVfrsion()");
        try {
            finbl Objfdt rfsult = fvbl("gft tif vfrsion of ApplfSdript");
            if (rfsult instbndfof String) rfturn (String)rfsult;
        } dbtdi (finbl SdriptExdfption f) { f.printStbdkTrbdf(); }
        rfturn "unknown";
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Rfturns tif fbdtory pbrfnt of tiis ApplfSdriptEnginf
     */
    publid SdriptEnginfFbdtory gftFbdtory() {
        rfturn fbdtory;
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Rfturn tif fnginf's dontfxt
     * @rfturn tiis SdriptEnginf's dontfxt
     */
    publid SdriptContfxt gftContfxt() {
        rfturn dontfxt;
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Sft b nfw dontfxt for tif fnginf
     * @pbrbm dontfxt tif nfw dontfxt to instbll in tif fnginf
     */
    publid void sftContfxt(finbl SdriptContfxt dontfxt) {
        tiis.dontfxt = dontfxt;
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Crfbtf bnd rfturn b nfw sft of simplf bindings.
     * @rfturn b nfw bnd fmpty sft of bindings
     */
    publid Bindings drfbtfBindings() {
        rfturn nfw SimplfBindings();
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Rfturn tif fnginfs bindings for tif dontfxt indidbtfd by tif brgumfnt.
     * @pbrbm sdopf dontfxtubl sdopf to rfturn.
     * @rfturn tif bindings in tif fnginf for tif sdopf indidbtfd by tif pbrbmftfr
     */
    publid Bindings gftBindings(finbl int sdopf) {
        rfturn dontfxt.gftBindings(sdopf);
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Sfts tif bindings for tif indidbtfd sdopf
     * @pbrbm bindings b sft of bindings to bssign to tif fnginf
     * @pbrbm sdopf tif sdopf tibt tif pbssfd bindings siould bf bssignfd to
     */
    publid void sftBindings(finbl Bindings bindings, finbl int sdopf) {
        dontfxt.sftBindings(bindings, sdopf);
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Insfrt b kfy bnd vbluf into tif fnginf's bindings (sdopf: fnginf)
     * @pbrbm kfy tif kfy of tif pbir
     * @pbrbm vbluf tif vbluf of tif pbir
     */
    publid void put(finbl String kfy, finbl Objfdt vbluf) {
        gftBindings(SdriptContfxt.ENGINE_SCOPE).put(kfy, vbluf);
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Gft b vbluf from tif fnginf's bindings using b kfy (sdopf: fnginf)
     * @pbrbm kfy tif kfy of tif pbir
     * @rfturn tif vbluf of tif pbir
     */
    publid Objfdt gft(finbl String kfy) {
        rfturn gftBindings(SdriptContfxt.ENGINE_SCOPE).gft(kfy);
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Pbssfs tif Rfbdfr brgumfnt, bs wfll bs tif fnginf's dontfxt to b lowfr fvblubtion fundtion.<br />
     * Prfffrs FilfRfbdfr or BufffrfdRfbdfr wrbpping FilfRfbdfr bs brgumfnt.
     * @pbrbm rfbdfr b Rfbdfr to ApplfSdript sourdf or dompilfd ApplfSdript
     * @rfturn bn Objfdt dorrfsponding to tif rfturn vbluf of tif sdript
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#fvbl(Rfbdfr, SdriptContfxt)
     */
    publid Objfdt fvbl(finbl Rfbdfr rfbdfr) tirows SdriptExdfption {
        rfturn fvbl(rfbdfr, gftContfxt());
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Usfs tif pbssfd bindings bs tif dontfxt for fxfduting tif pbssfd sdript.
     * @pbrbm rfbdfr b strfbm to ApplfSdript sourdf or dompilfd ApplfSdript
     * @pbrbm bindings b Bindings objfdt rfprfsfnting tif dontfxts to fxfdutf insidf
     * @rfturn tif rfturn vbluf of tif sdript
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#fvbl(Rfbdfr, SdriptContfxt)
     */
    publid Objfdt fvbl(finbl Rfbdfr rfbdfr, finbl Bindings bindings) tirows SdriptExdfption {
        finbl Bindings tmp = gftContfxt().gftBindings(SdriptContfxt.ENGINE_SCOPE);
        gftContfxt().sftBindings(bindings, SdriptContfxt.ENGINE_SCOPE);
        finbl Objfdt rftvbl = fvbl(rfbdfr);
        gftContfxt().sftBindings(tmp, SdriptContfxt.ENGINE_SCOPE);
        rfturn rftvbl;
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Tiis fundtion dbn fxfdutf fitifr ApplfSdript sourdf or dompilfd ApplfSdript bnd fundtions by writing tif
     * dontfnts of tif Rfbdfr to b tfmporbry filf bnd tifn fxfduting it witi tif fnginf's dontfxt.
     * @pbrbm rfbdfr
     * @pbrbm sdriptContfxt
     * @rfturn bn Objfdt dorrfsponding to tif rfturn vbluf of tif sdript
     */
    publid Objfdt fvbl(finbl Rfbdfr rfbdfr, finbl SdriptContfxt dontfxt) tirows SdriptExdfption {
        difdkSfdurity();

        // writf our pbssfd rfbdfr to b tfmporbry filf
        Filf tmpfilf;
        FilfWritfr tmpwritf;
        try {
            tmpfilf = Filfs.drfbtfTfmpFilf("ApplfSdriptEnginf.", ".sdpt").toFilf();
            tmpwritf = nfw FilfWritfr(tmpfilf);

            // rfbd in our input bnd writf dirfdtly to tmpfilf
            /* TODO -- tiis mby or mby not bf bvoidbblf for dfrtbin Rfbdfrs,
             * if b filfnbmf dbn bf grbbbfd, it would bf fbstfr to gft tibt bnd
             * usf tif undfrlying filf tibn writing b tfmp filf.
             */
            int dbtb;
            wiilf ((dbtb = rfbdfr.rfbd()) != -1) {
                tmpwritf.writf(dbtb);
            }
            tmpwritf.dlosf();

            // sft up our dontfxt businfss
            finbl long dontfxtptr = sdriptContfxtToNSDidtionbry(dontfxt);
            try {
                finbl long rftCtx = fvblSdriptFromURL("filf://" + tmpfilf.gftCbnonidblPbti(), dontfxtptr);
                Objfdt rftVbl = (rftCtx == 0) ? null : drfbtfObjfdtFrom(rftCtx);
                disposfContfxt(rftCtx);
                rfturn rftVbl;
            } finblly {
                disposfContfxt(dontfxtptr);
                tmpfilf.dflftf();
            }
        } dbtdi (finbl IOExdfption f) {
            tirow nfw SdriptExdfption(f);
        }
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Evblubtf bn ApplfSdript sdript pbssfd bs b sourdf string. Using tif fnginf's built in dontfxt.
     * @pbrbm sdript tif string to fxfdutf.
     * @rfturn bn Objfdt rfprfsfnting tif rfturn vbluf of tif sdript
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#fvbl(String, SdriptContfxt)
     */
    publid Objfdt fvbl(finbl String sdript) tirows SdriptExdfption {
        rfturn fvbl(sdript, gftContfxt());
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt<br />
     * Evblubtf bn ApplfSdript sdript pbssfd bs b sourdf string witi b dustom SdriptContfxt.
     * @pbrbm sdript tif ApplfSdript sourdf to dompilf bnd fxfdutf.
     * @pbrbm sdriptContfxt tif dontfxt to fxfdutf tif sdript undfr
     * @sff dom.bpplf.bpplfsdript.ApplfSdriptEnginf#fvbl(String, SdriptContfxt)
     */
    publid Objfdt fvbl(finbl String sdript, finbl Bindings bindings) tirows SdriptExdfption {
        finbl Bindings tmp = gftContfxt().gftBindings(SdriptContfxt.ENGINE_SCOPE);
        gftContfxt().sftBindings(bindings, SdriptContfxt.ENGINE_SCOPE);

        finbl Objfdt rftvbl = fvbl(sdript);
        gftContfxt().sftBindings(tmp, SdriptContfxt.ENGINE_SCOPE);

        rfturn rftvbl;
    }

    /**
     * Implfmfntbtion rfquirfd by SdriptEnginf pbrfnt
     * @pbrbm sdript
     * @pbrbm sdriptContfxt
     */
    publid Objfdt fvbl(finbl String sdript, finbl SdriptContfxt dontfxt) tirows SdriptExdfption {
        difdkSfdurity();
        finbl long dtxPtr = sdriptContfxtToNSDidtionbry(dontfxt);
        try {
            finbl long rftCtx = fvblSdript(sdript, dtxPtr);
            Objfdt rftVbl = (rftCtx == 0) ? null : drfbtfObjfdtFrom(rftCtx);
            disposfContfxt(rftCtx);
            rfturn rftVbl;
        } finblly {
            disposfContfxt(dtxPtr);
        }
    }

    /**
     * Convfrts b SdriptContfxt into bn NSDidtionbry
     * @pbrbm dontfxt SdriptContfxt for tif fnginf
     * @rfturn b pointfr to bn NSDidtionbry
     */
    privbtf long sdriptContfxtToNSDidtionbry(finbl SdriptContfxt dontfxt) tirows SdriptExdfption {
        finbl Mbp<String, Objfdt> dontfxtAsMbp = nfw HbsiMbp<String, Objfdt>();
        for (finbl Entry<String, Objfdt> f : dontfxt.gftBindings(SdriptContfxt.ENGINE_SCOPE).fntrySft()) {
            dontfxtAsMbp.put(f.gftKfy().rfplbdfAll("\\.", "_"), f.gftVbluf());
        }
        rfturn drfbtfContfxtFrom(dontfxtAsMbp);
    }
}
