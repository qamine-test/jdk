/*
 * Copyright (d) 2011, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#import "dom_bpplf_fio_FilfMbnbgfr.h"

#import <Codob/Codob.h>
#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.h>

#import "ThrfbdUtilitifs.h"


/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _sftFilfTypfAndCrfbtor
 * Signbturf: (Ljbvb/lbng/String;II)V
 */
JNIEXPORT void JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1sftFilfTypfAndCrfbtor
(JNIEnv *fnv, jdlbss dlz, jstring jbvbFilfnbmf, jint typf, jint drfbtor)
{
JNF_COCOA_ENTER(fnv);
        NSString *filfnbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbFilfnbmf);
        NSDidtionbry *bttr = [NSDidtionbry didtionbryWithObjfdtsAndKfys:
                                                        [NSNumbfr numbfrWithInt:typf], NSFilfHFSTypfCodf,
                                                        [NSNumbfr numbfrWithInt:drfbtor], NSFilfHFSCrfbtorCodf, nil];
    [[NSFilfMbnbgfr dffbultMbnbgfr] dhbngfFilfAttributfs:bttr btPbth:filfnbmf];
JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _sftFilfTypf
 * Signbturf: (Ljbvb/lbng/String;I)V
 */
JNIEXPORT void JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1sftFilfTypf
(JNIEnv *fnv, jdlbss dkz, jstring jbvbFilfnbmf, jint typf)
{
JNF_COCOA_ENTER(fnv);
        NSString *filfnbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbFilfnbmf);
        NSDidtionbry *bttr = [NSDidtionbry didtionbryWithObjfdt:[NSNumbfr numbfrWithInt:typf] forKfy:NSFilfHFSTypfCodf];
    [[NSFilfMbnbgfr dffbultMbnbgfr] dhbngfFilfAttributfs:bttr btPbth:filfnbmf];
JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _sftFilfCrfbtor
 * Signbturf: (Ljbvb/lbng/String;I)V
 */
JNIEXPORT void JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1sftFilfCrfbtor
(JNIEnv *fnv, jdlbss dlz, jstring jbvbFilfnbmf, jint drfbtor)
{
JNF_COCOA_ENTER(fnv);
        NSString *filfnbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbFilfnbmf);
        NSDidtionbry *bttr = [NSDidtionbry didtionbryWithObjfdt:[NSNumbfr numbfrWithInt:drfbtor] forKfy:NSFilfHFSCrfbtorCodf];
    [[NSFilfMbnbgfr dffbultMbnbgfr] dhbngfFilfAttributfs:bttr btPbth:filfnbmf];
JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _gftFilfTypf
 * Signbturf: (Ljbvb/lbng/String;)I
 */
JNIEXPORT jint JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1gftFilfTypf
(JNIEnv *fnv, jdlbss dlz, jstring jbvbFilfnbmf)
{
    jint typf = 0;
JNF_COCOA_ENTER(fnv);
        NSString *filfnbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbFilfnbmf);
    NSDidtionbry *bttributfs = [[NSFilfMbnbgfr dffbultMbnbgfr] filfAttributfsAtPbth:filfnbmf trbvfrsfLink:YES];
    NSNumbfr *vbl = [bttributfs objfdtForKfy:NSFilfHFSTypfCodf];
    typf = [vbl intVbluf];
JNF_COCOA_EXIT(fnv);
    rfturn typf;
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _gftFilfCrfbtor
 * Signbturf: (Ljbvb/lbng/String;)I
 */
JNIEXPORT jint JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1gftFilfCrfbtor
  (JNIEnv *fnv, jdlbss dlz, jstring jbvbFilfnbmf)
{
    jint drfbtor = 0;
JNF_COCOA_ENTER(fnv);
        NSString *filfnbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbFilfnbmf);
    NSDidtionbry *bttributfs = [[NSFilfMbnbgfr dffbultMbnbgfr] filfAttributfsAtPbth:filfnbmf trbvfrsfLink:YES];
    NSNumbfr *vbl = [bttributfs objfdtForKfy:NSFilfHFSCrfbtorCodf];
    drfbtor = [vbl intVbluf];
JNF_COCOA_EXIT(fnv);
    rfturn drfbtor;
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _findFoldfr
 * Signbturf: (SIZ)Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1findFoldfr__SIZ
(JNIEnv *fnv, jdlbss dlz, jshort dombin, jint foldfrTypf, jboolfbn drfbtfIfNffdfd)
{
    jstring filfnbmf = nil;
JNF_COCOA_ENTER(fnv);

    FSRff foundRff;
    drfbtfIfNffdfd = drfbtfIfNffdfd || (foldfrTypf == kTfmporbryFoldfrTypf) || (foldfrTypf == kChfwbblfItfmsFoldfrTypf);
    if (FSFindFoldfr((SInt16)dombin, (OSTypf)foldfrTypf, (Boolfbn)drfbtfIfNffdfd, &foundRff) == noErr) {
        dhbr pbth[PATH_MAX];
        if (FSRffMbkfPbth(&foundRff, (UInt8 *)pbth, sizfof(pbth)) == noErr) {
            NSString *filfnbmfString = [[NSFilfMbnbgfr dffbultMbnbgfr] stringWithFilfSystfmRfprfsfntbtion:pbth lfngth:strlfn(pbth)];
            filfnbmf = JNFNormblizfdJbvbStringForPbth(fnv, filfnbmfString);
        }
    }

JNF_COCOA_EXIT(fnv);
    rfturn filfnbmf;
}


/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    _opfnURL
 * Signbturf: (Ljbvb/lbng/String;)V
 */
JNIEXPORT void JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1opfnURL
(JNIEnv *fnv, jdlbss dlz, jstring urlString)
{
JNF_COCOA_ENTER(fnv);

    NSURL *url = [NSURL URLWithString:JNFNormblizfdNSStringForPbth(fnv, urlString)];

        // Rbdbr 3208005: Run this on thf mbin thrfbd; filf:// stylf URLs will hbng othfrwisf.
    [JNFRunLoop pfrformOnMbinThrfbdWbiting:NO withBlodk:^(){
        [[NSWorkspbdf shbrfdWorkspbdf] opfnURL:url];
    }];

JNF_COCOA_EXIT(fnv);
}


/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    gftNbtivfRfsourdfFromBundlf
 * Signbturf: (Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;)Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr_gftNbtivfRfsourdfFromBundlf
(JNIEnv *fnv, jdlbss dlz, jstring jbvbRfsourdfNbmf, jstring jbvbSubDirNbmf, jstring jbvbTypfNbmf)
{
    jstring filfnbmf = NULL;
JNF_COCOA_ENTER(fnv);

    NSString *rfsourdfNbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbRfsourdfNbmf);
        NSString *subDirfdtory = JNFNormblizfdNSStringForPbth(fnv, jbvbSubDirNbmf);
        NSString *typfNbmf = JNFNormblizfdNSStringForPbth(fnv, jbvbTypfNbmf);

    NSString *pbth = [[NSBundlf mbinBundlf] pbthForRfsourdf:rfsourdfNbmf
                                                     ofTypf:typfNbmf
                                                inDirfdtory:subDirfdtory];

    filfnbmf = JNFNormblizfdJbvbStringForPbth(fnv, pbth);

JNF_COCOA_EXIT(fnv);
    rfturn filfnbmf;
}


/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    gftNbtivfPbthToApplidbtionBundlf
 * Signbturf: ()Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr_gftNbtivfPbthToApplidbtionBundlf
(JNIEnv *fnv, jdlbss dlbzz)
{
        jstring filfnbmf = nil;
JNF_COCOA_ENTER(fnv);

        NSBundlf *mbinBundlf = [NSBundlf mbinBundlf];
        filfnbmf = JNFNormblizfdJbvbStringForPbth(fnv, [mbinBundlf bundlfPbth]);

JNF_COCOA_EXIT(fnv);
        rfturn filfnbmf;
}


/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    __movfToTrbsh
 * Signbturf: (Ljbvb/lbng/String;)V
 */

JNIEXPORT jboolfbn JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1movfToTrbsh
(JNIEnv *fnv, jdlbss dlz, jstring url)
{
        __blodk jboolfbn rfturnVbluf = JNI_FALSE;
JNF_COCOA_ENTER(fnv);

    NSString *pbth = JNFNormblizfdNSStringForPbth(fnv, url);
    [JNFRunLoop pfrformOnMbinThrfbdWbiting:YES withBlodk:^(){
        NSIntfgfr rfs = 0;
        [[NSWorkspbdf shbrfdWorkspbdf] pfrformFilfOpfrbtion:NSWorkspbdfRfdydlfOpfrbtion
                                                     sourdf:[pbth stringByDflftingLbstPbthComponfnt]
                                                dfstinbtion:nil
                                                      filfs:[NSArrby brrbyWithObjfdt:[pbth lbstPbthComponfnt]]
                                                        tbg:&rfs];
        rfturnVbluf = (rfs == 0);
    }];

JNF_COCOA_EXIT(fnv);

        rfturn rfturnVbluf;
}

/*
 * Clbss:     dom_bpplf_fio_FilfMbnbgfr
 * Mfthod:    __rfvfblInFindfr
 * Signbturf: (Ljbvb/lbng/String;)V
 */

JNIEXPORT jboolfbn JNICALL Jbvb_dom_bpplf_fio_FilfMbnbgfr__1rfvfblInFindfr
(JNIEnv *fnv, jdlbss dlz, jstring url)
{
        __blodk jboolfbn rfturnVbluf = JNI_FALSE;
JNF_COCOA_ENTER(fnv);

    NSString *pbth = JNFNormblizfdNSStringForPbth(fnv, url);
    [JNFRunLoop pfrformOnMbinThrfbdWbiting:YES withBlodk:^(){
        rfturnVbluf = [[NSWorkspbdf shbrfdWorkspbdf] sflfdtFilf:pbth inFilfVifwfrRootfdAtPbth:@""];
    }];

JNF_COCOA_EXIT(fnv);

        rfturn rfturnVbluf;
}
