/*
 * Copyrigit (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 */

/* Copyrigit  (d) 2002 Grbz Univfrsity of Tfdinology. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in  sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd  providfd tibt tif following donditions brf mft:
 *
 * 1. Rfdistributions of  sourdf dodf must rftbin tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr.
 *
 * 2. Rfdistributions in  binbry form must rfprodudf tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr in tif dodumfntbtion
 *    bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 * 3. Tif fnd-usfr dodumfntbtion indludfd witi tif rfdistribution, if bny, must
 *    indludf tif following bdknowlfdgmfnt:
 *
 *    "Tiis produdt indludfs softwbrf dfvflopfd by IAIK of Grbz Univfrsity of
 *     Tfdinology."
 *
 *    Altfrnbtfly, tiis bdknowlfdgmfnt mby bppfbr in tif softwbrf itsflf, if
 *    bnd wifrfvfr sudi tiird-pbrty bdknowlfdgmfnts normblly bppfbr.
 *
 * 4. Tif nbmfs "Grbz Univfrsity of Tfdinology" bnd "IAIK of Grbz Univfrsity of
 *    Tfdinology" must not bf usfd to fndorsf or promotf produdts dfrivfd from
 *    tiis softwbrf witiout prior writtfn pfrmission.
 *
 * 5. Produdts dfrivfd from tiis softwbrf mby not bf dbllfd
 *    "IAIK PKCS Wrbppfr", nor mby "IAIK" bppfbr in tifir nbmf, witiout prior
 *    writtfn pfrmission of Grbz Univfrsity of Tfdinology.
 *
 *  THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED
 *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *  POSSIBILITY  OF SUCH DAMAGE.
 */

#indludf "pkds11wrbppfr.i"

#indludf <stdio.i>
#indludf <stdlib.i>
#indludf <string.i>
#indludf <bssfrt.i>

#indludf "sun_sfdurity_pkds11_wrbppfr_PKCS11.i"

#ifdff P11_ENABLE_C_GENERATEKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_GfnfrbtfKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdt jMfdibnism          CK_MECHANISM_PTR pMfdibnism
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR piKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GfnfrbtfKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdibnism, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdibnism;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdibnismToCKMfdibnism(fnv, jMfdibnism, &dkMfdibnism);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn 0L ; }

    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    rv = (*dkpFundtions->C_GfnfrbtfKfy)(dkSfssionHbndlf, &dkMfdibnism, dkpAttributfs, dkAttributfsLfngti, &dkKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlf = dkULongToJLong(dkKfyHbndlf);

        /* difbdk, if wf must givf b initiblizbtion vfdtor bbdk to Jbvb */
        switdi (dkMfdibnism.mfdibnism) {
        dbsf CKM_PBE_MD2_DES_CBC:
        dbsf CKM_PBE_MD5_DES_CBC:
        dbsf CKM_PBE_MD5_CAST_CBC:
        dbsf CKM_PBE_MD5_CAST3_CBC:
        dbsf CKM_PBE_MD5_CAST128_CBC:
        /* dbsf CKM_PBE_MD5_CAST5_CBC:  tif sbmf bs CKM_PBE_MD5_CAST128_CBC */
        dbsf CKM_PBE_SHA1_CAST128_CBC:
        /* dbsf CKM_PBE_SHA1_CAST5_CBC: tif sbmf bs CKM_PBE_SHA1_CAST128_CBC */
            /* wf must dopy bbdk tif initiblizbtion vfdtor to tif jMfdibnism objfdt */
            dopyBbdkPBEInitiblizbtionVfdtor(fnv, &dkMfdibnism, jMfdibnism);
            brfbk;
        }
    }

    if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdibnism.pPbrbmftfr);
    }
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);

    rfturn jKfyHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_GENERATEKEYPAIR
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_GfnfrbtfKfyPbir
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)[J
 * Pbrbmftfrmbpping:                          *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf              CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdt jMfdibnism                CK_MECHANISM_PTR pMfdibnism
 * @pbrbm   jobjfdtArrby jPublidKfyTfmplbtf   CK_ATTRIBUTE_PTR pPublidKfyTfmplbtf
 *                                            CK_ULONG ulPublidKfyAttributfCount
 * @pbrbm   jobjfdtArrby jPrivbtfKfyTfmplbtf  CK_ATTRIBUTE_PTR pPrivbtfKfyTfmplbtf
 *                                            CK_ULONG ulPrivbtfKfyAttributfCount
 * @rfturn  jlongArrby jKfyHbndlfs            CK_OBJECT_HANDLE_PTR piPublidKfy
 *                                            CK_OBJECT_HANDLE_PTR piPublidKfy
 */
JNIEXPORT jlongArrby JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GfnfrbtfKfyPbir
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdibnism,
     jobjfdtArrby jPublidKfyTfmplbtf, jobjfdtArrby jPrivbtfKfyTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdibnism;
    CK_ATTRIBUTE_PTR dkpPublidKfyAttributfs = NULL_PTR;
    CK_ATTRIBUTE_PTR dkpPrivbtfKfyAttributfs = NULL_PTR;
    CK_ULONG dkPublidKfyAttributfsLfngti;
    CK_ULONG dkPrivbtfKfyAttributfsLfngti;
    CK_OBJECT_HANDLE_PTR dkpPublidKfyHbndlf;  /* pointfr to Publid Kfy */
    CK_OBJECT_HANDLE_PTR dkpPrivbtfKfyHbndlf; /* pointfr to Privbtf Kfy */
    CK_OBJECT_HANDLE_PTR dkpKfyHbndlfs;     /* pointfr to brrby witi Publid bnd Privbtf Kfy */
    jlongArrby jKfyHbndlfs = NULL;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn NULL; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdibnismToCKMfdibnism(fnv, jMfdibnism, &dkMfdibnism);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn NULL; }

    dkpKfyHbndlfs = (CK_OBJECT_HANDLE_PTR) mbllod(2 * sizfof(CK_OBJECT_HANDLE));
    if (dkpKfyHbndlfs == NULL) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        tirowOutOfMfmoryError(fnv, 0);
        rfturn NULL;
    }
    dkpPublidKfyHbndlf = dkpKfyHbndlfs;   /* first flfmfnt of brrby is Publid Kfy */
    dkpPrivbtfKfyHbndlf = (dkpKfyHbndlfs + 1);  /* sfdond flfmfnt of brrby is Privbtf Kfy */

    jAttributfArrbyToCKAttributfArrby(fnv, jPublidKfyTfmplbtf, &dkpPublidKfyAttributfs, &dkPublidKfyAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        frff(dkpKfyHbndlfs);
        rfturn NULL;
    }

    jAttributfArrbyToCKAttributfArrby(fnv, jPrivbtfKfyTfmplbtf, &dkpPrivbtfKfyAttributfs, &dkPrivbtfKfyAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        frff(dkpKfyHbndlfs);
        frffCKAttributfArrby(dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngti);
        rfturn NULL;
    }

    rv = (*dkpFundtions->C_GfnfrbtfKfyPbir)(dkSfssionHbndlf, &dkMfdibnism,
                     dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngti,
                     dkpPrivbtfKfyAttributfs, dkPrivbtfKfyAttributfsLfngti,
                     dkpPublidKfyHbndlf, dkpPrivbtfKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlfs = dkULongArrbyToJLongArrby(fnv, dkpKfyHbndlfs, 2);
    }

    if(dkMfdibnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdibnism.pPbrbmftfr);
    }
    frff(dkpKfyHbndlfs);
    frffCKAttributfArrby(dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngti);
    frffCKAttributfArrby(dkpPrivbtfKfyAttributfs, dkPrivbtfKfyAttributfsLfngti);

    rfturn jKfyHbndlfs ;
}
#fndif

#ifdff P11_ENABLE_C_WRAPKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_WrbpKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;JJ)[B
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdt jMfdibnism          CK_MECHANISM_PTR pMfdibnism
 * @pbrbm   jlong jWrbppingKfyHbndlf    CK_OBJECT_HANDLE iWrbppingKfy
 * @pbrbm   jlong jKfyHbndlf            CK_OBJECT_HANDLE iKfy
 * @rfturn  jbytfArrby jWrbppfdKfy      CK_BYTE_PTR pWrbppfdKfy
 *                                      CK_ULONG_PTR pulWrbppfdKfyLfn
 */
JNIEXPORT jbytfArrby JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1WrbpKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdibnism, jlong jWrbppingKfyHbndlf, jlong jKfyHbndlf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdibnism;
    CK_OBJECT_HANDLE dkWrbppingKfyHbndlf;
    CK_OBJECT_HANDLE dkKfyHbndlf;
    jbytfArrby jWrbppfdKfy = NULL;
    CK_RV rv;
    CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
    CK_BYTE_PTR dkpWrbppfdKfy = BUF;
    CK_ULONG dkWrbppfdKfyLfngti = MAX_STACK_BUFFER_LEN;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn NULL; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdibnismToCKMfdibnism(fnv, jMfdibnism, &dkMfdibnism);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn NULL; }

    dkWrbppingKfyHbndlf = jLongToCKULong(jWrbppingKfyHbndlf);
    dkKfyHbndlf = jLongToCKULong(jKfyHbndlf);

    rv = (*dkpFundtions->C_WrbpKfy)(dkSfssionHbndlf, &dkMfdibnism, dkWrbppingKfyHbndlf, dkKfyHbndlf, dkpWrbppfdKfy, &dkWrbppfdKfyLfngti);
    if (rv == CKR_BUFFER_TOO_SMALL) {
        dkpWrbppfdKfy = (CK_BYTE_PTR) mbllod(dkWrbppfdKfyLfngti);
        if (dkpWrbppfdKfy == NULL) {
            if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
                frff(dkMfdibnism.pPbrbmftfr);
            }
            tirowOutOfMfmoryError(fnv, 0);
            rfturn NULL;
        }

        rv = (*dkpFundtions->C_WrbpKfy)(dkSfssionHbndlf, &dkMfdibnism, dkWrbppingKfyHbndlf, dkKfyHbndlf, dkpWrbppfdKfy, &dkWrbppfdKfyLfngti);
    }
    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jWrbppfdKfy = dkBytfArrbyToJBytfArrby(fnv, dkpWrbppfdKfy, dkWrbppfdKfyLfngti);
    }

    if (dkpWrbppfdKfy != BUF) { frff(dkpWrbppfdKfy); }
    if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdibnism.pPbrbmftfr);
    }
    rfturn jWrbppfdKfy ;
}
#fndif

#ifdff P11_ENABLE_C_UNWRAPKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_UnwrbpKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;J[B[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdt jMfdibnism          CK_MECHANISM_PTR pMfdibnism
 * @pbrbm   jlong jUnwrbppingKfyHbndlf  CK_OBJECT_HANDLE iUnwrbppingKfy
 * @pbrbm   jbytfArrby jWrbppfdKfy      CK_BYTE_PTR pWrbppfdKfy
 *                                      CK_ULONG_PTR pulWrbppfdKfyLfn
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR piKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1UnwrbpKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdibnism, jlong jUnwrbppingKfyHbndlf,
     jbytfArrby jWrbppfdKfy, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdibnism;
    CK_OBJECT_HANDLE dkUnwrbppingKfyHbndlf;
    CK_BYTE_PTR dkpWrbppfdKfy = NULL_PTR;
    CK_ULONG dkWrbppfdKfyLfngti;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdibnismToCKMfdibnism(fnv, jMfdibnism, &dkMfdibnism);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn 0L; }

    dkUnwrbppingKfyHbndlf = jLongToCKULong(jUnwrbppingKfyHbndlf);
    jBytfArrbyToCKBytfArrby(fnv, jWrbppfdKfy, &dkpWrbppfdKfy, &dkWrbppfdKfyLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        frff(dkpWrbppfdKfy);
        rfturn 0L;
    }


    rv = (*dkpFundtions->C_UnwrbpKfy)(dkSfssionHbndlf, &dkMfdibnism, dkUnwrbppingKfyHbndlf,
                 dkpWrbppfdKfy, dkWrbppfdKfyLfngti,
                 dkpAttributfs, dkAttributfsLfngti, &dkKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlf = dkLongToJLong(dkKfyHbndlf);

#if 0
        /* difbdk, if wf must givf b initiblizbtion vfdtor bbdk to Jbvb */
        if (dkMfdibnism.mfdibnism == CKM_KEY_WRAP_SET_OAEP) {
            /* wf must dopy bbdk tif unwrbppfd kfy info to tif jMfdibnism objfdt */
            dopyBbdkSftUnwrbppfdKfy(fnv, &dkMfdibnism, jMfdibnism);
        }
#fndif
    }

    if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdibnism.pPbrbmftfr);
    }
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);
    frff(dkpWrbppfdKfy);

    rfturn jKfyHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_DERIVEKEY

void frffMbstfrKfyDfrivfPbrbms(CK_MECHANISM_PTR dkMfdibnism) {
    CK_SSL3_MASTER_KEY_DERIVE_PARAMS *pbrbms = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *) dkMfdibnism->pPbrbmftfr;
    if (pbrbms == NULL) {
        rfturn;
    }

    if (pbrbms->RbndomInfo.pClifntRbndom != NULL) {
        frff(pbrbms->RbndomInfo.pClifntRbndom);
    }
    if (pbrbms->RbndomInfo.pSfrvfrRbndom != NULL) {
        frff(pbrbms->RbndomInfo.pSfrvfrRbndom);
    }
    if (pbrbms->pVfrsion != NULL) {
        frff(pbrbms->pVfrsion);
    }
}

void frffEddi1DfrivfPbrbms(CK_MECHANISM_PTR dkMfdibnism) {
    CK_ECDH1_DERIVE_PARAMS *pbrbms = (CK_ECDH1_DERIVE_PARAMS *) dkMfdibnism->pPbrbmftfr;
    if (pbrbms == NULL) {
        rfturn;
    }

    if (pbrbms->pSibrfdDbtb != NULL) {
        frff(pbrbms->pSibrfdDbtb);
    }
    if (pbrbms->pPublidDbtb != NULL) {
        frff(pbrbms->pPublidDbtb);
    }
}

/*
 * Copy bbdk tif PRF output to Jbvb.
 */
void dopyBbdkTLSPrfPbrbms(JNIEnv *fnv, CK_MECHANISM *dkMfdibnism, jobjfdt jMfdibnism)
{
    jdlbss jMfdibnismClbss, jTLSPrfPbrbmsClbss;
    CK_TLS_PRF_PARAMS *dkTLSPrfPbrbms;
    jobjfdt jTLSPrfPbrbms;
    jfifldID fifldID;
    CK_MECHANISM_TYPE dkMfdibnismTypf;
    jlong jMfdibnismTypf;
    CK_BYTE_PTR output;
    jobjfdt jOutput;
    jint jLfngti;
    jbytf* jBytfs;
    int i;

    /* gft mfdibnism */
    jMfdibnismClbss = (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
    if (jMfdibnismClbss == NULL) { rfturn; }
    fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "mfdibnism", "J");
    if (fifldID == NULL) { rfturn; }
    jMfdibnismTypf = (*fnv)->GftLongFifld(fnv, jMfdibnism, fifldID);
    dkMfdibnismTypf = jLongToCKULong(jMfdibnismTypf);
    if (dkMfdibnismTypf != dkMfdibnism->mfdibnism) {
        /* wf do not ibvf mbdiing typfs, tiis siould not oddur */
        rfturn;
    }

    /* gft tif nbtivf CK_TLS_PRF_PARAMS */
    dkTLSPrfPbrbms = (CK_TLS_PRF_PARAMS *) dkMfdibnism->pPbrbmftfr;
    if (dkTLSPrfPbrbms != NULL_PTR) {
        /* gft tif Jbvb CK_TLS_PRF_PARAMS objfdt (pPbrbmftfr) */
        fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
        if (fifldID == NULL) { rfturn; }
        jTLSPrfPbrbms = (*fnv)->GftObjfdtFifld(fnv, jMfdibnism, fifldID);

        /* dopy bbdk tif dlifnt IV */
        jTLSPrfPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_TLS_PRF_PARAMS);
        if (jTLSPrfPbrbmsClbss == NULL) { rfturn; }
        fifldID = (*fnv)->GftFifldID(fnv, jTLSPrfPbrbmsClbss, "pOutput", "[B");
        if (fifldID == NULL) { rfturn; }
        jOutput = (*fnv)->GftObjfdtFifld(fnv, jTLSPrfPbrbms, fifldID);
        output = dkTLSPrfPbrbms->pOutput;

        // Notf: wf bssumf tibt tif tokfn rfturnfd fxbdtly bs mbny bytfs bs wf
        // rfqufstfd. Anytiing flsf would not mbkf sfnsf.
        if (jOutput != NULL) {
            jLfngti = (*fnv)->GftArrbyLfngti(fnv, jOutput);
            jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jOutput, NULL);
            if (jBytfs == NULL) { rfturn; }

            /* dopy tif bytfs to tif Jbvb bufffr */
            for (i=0; i < jLfngti; i++) {
                jBytfs[i] = dkBytfToJBytf(output[i]);
            }
            /* dopy bbdk tif Jbvb bufffr to tif objfdt */
            (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jOutput, jBytfs, 0);
        }

        // frff mbllod'd dbtb
        frff(dkTLSPrfPbrbms->pSffd);
        frff(dkTLSPrfPbrbms->pLbbfl);
        frff(dkTLSPrfPbrbms->pulOutputLfn);
        frff(dkTLSPrfPbrbms->pOutput);
    }
}

/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_DfrivfKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;J[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdt jMfdibnism          CK_MECHANISM_PTR pMfdibnism
 * @pbrbm   jlong jBbsfKfyHbndlf        CK_OBJECT_HANDLE iBbsfKfy
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR piKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1DfrivfKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdibnism, jlong jBbsfKfyHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdibnism;
    CK_OBJECT_HANDLE dkBbsfKfyHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;
    CK_OBJECT_HANDLE_PTR piKfy = &dkKfyHbndlf;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdibnismToCKMfdibnism(fnv, jMfdibnism, &dkMfdibnism);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn 0L; }

    dkBbsfKfyHbndlf = jLongToCKULong(jBbsfKfyHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) {
        if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdibnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    switdi (dkMfdibnism.mfdibnism) {
    dbsf CKM_SSL3_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_PRF:
        // tifsf mfdibnism do not rfturn b kfy ibndlf vib piKfy
        // sft to NULL in dbsf pfdbntid implfmfntbtions difdk for it
        piKfy = NULL;
        brfbk;
    dffbult:
        // fmpty
        brfbk;
    }

    rv = (*dkpFundtions->C_DfrivfKfy)(dkSfssionHbndlf, &dkMfdibnism, dkBbsfKfyHbndlf,
                 dkpAttributfs, dkAttributfsLfngti, piKfy);

    jKfyHbndlf = dkLongToJLong(dkKfyHbndlf);

    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);

    switdi (dkMfdibnism.mfdibnism) {
    dbsf CKM_SSL3_MASTER_KEY_DERIVE:
    dbsf CKM_TLS_MASTER_KEY_DERIVE:
        /* wf must dopy bbdk tif dlifnt vfrsion */
        dopyBbdkClifntVfrsion(fnv, &dkMfdibnism, jMfdibnism);
        frffMbstfrKfyDfrivfPbrbms(&dkMfdibnism);
        brfbk;
    dbsf CKM_SSL3_MASTER_KEY_DERIVE_DH:
    dbsf CKM_TLS_MASTER_KEY_DERIVE_DH:
        frffMbstfrKfyDfrivfPbrbms(&dkMfdibnism);
        brfbk;
    dbsf CKM_SSL3_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_KEY_AND_MAC_DERIVE:
        /* wf must dopy bbdk tif unwrbppfd kfy info to tif jMfdibnism objfdt */
        dopyBbdkSSLKfyMbtPbrbms(fnv, &dkMfdibnism, jMfdibnism);
        brfbk;
    dbsf CKM_TLS_PRF:
        dopyBbdkTLSPrfPbrbms(fnv, &dkMfdibnism, jMfdibnism);
        brfbk;
    dbsf CKM_ECDH1_DERIVE:
        frffEddi1DfrivfPbrbms(&dkMfdibnism);
        brfbk;
    dffbult:
        // fmpty
        brfbk;
    }

    if (dkMfdibnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdibnism.pPbrbmftfr);
    }
    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn 0L ; }

    rfturn jKfyHbndlf ;
}

/*
 * Copy bbdk tif dlifnt vfrsion informbtion from tif nbtivf
 * strudturf to tif Jbvb objfdt. Tiis is only usfd for tif
 * CKM_SSL3_MASTER_KEY_DERIVE mfdibnism wifn usfd for dfriving b kfy.
 *
 */
void dopyBbdkClifntVfrsion(JNIEnv *fnv, CK_MECHANISM *dkMfdibnism, jobjfdt jMfdibnism)
{
  jdlbss jMfdibnismClbss, jSSL3MbstfrKfyDfrivfPbrbmsClbss, jVfrsionClbss;
  CK_SSL3_MASTER_KEY_DERIVE_PARAMS *dkSSL3MbstfrKfyDfrivfPbrbms;
  CK_VERSION *dkVfrsion;
  jfifldID fifldID;
  CK_MECHANISM_TYPE dkMfdibnismTypf;
  jlong jMfdibnismTypf;
  jobjfdt jSSL3MbstfrKfyDfrivfPbrbms;
  jobjfdt jVfrsion;

  /* gft mfdibnism */
  jMfdibnismClbss = (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
  if (jMfdibnismClbss == NULL) { rfturn; }
  fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "mfdibnism", "J");
  if (fifldID == NULL) { rfturn; }
  jMfdibnismTypf = (*fnv)->GftLongFifld(fnv, jMfdibnism, fifldID);
  dkMfdibnismTypf = jLongToCKULong(jMfdibnismTypf);
  if (dkMfdibnismTypf != dkMfdibnism->mfdibnism) {
    /* wf do not ibvf mbdiing typfs, tiis siould not oddur */
    rfturn;
  }

  /* gft tif nbtivf CK_SSL3_MASTER_KEY_DERIVE_PARAMS */
  dkSSL3MbstfrKfyDfrivfPbrbms = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *) dkMfdibnism->pPbrbmftfr;
  if (dkSSL3MbstfrKfyDfrivfPbrbms != NULL_PTR) {
    /* gft tif nbtivf CK_VERSION */
    dkVfrsion = dkSSL3MbstfrKfyDfrivfPbrbms->pVfrsion;
    if (dkVfrsion != NULL_PTR) {
      /* gft tif Jbvb CK_SSL3_MASTER_KEY_DERIVE_PARAMS (pPbrbmftfr) */
      fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
      if (fifldID == NULL) { rfturn; }

      jSSL3MbstfrKfyDfrivfPbrbms = (*fnv)->GftObjfdtFifld(fnv, jMfdibnism, fifldID);

      /* gft tif Jbvb CK_VERSION */
      jSSL3MbstfrKfyDfrivfPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
      if (jSSL3MbstfrKfyDfrivfPbrbmsClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3MbstfrKfyDfrivfPbrbmsClbss, "pVfrsion", "L"CLASS_VERSION";");
      if (fifldID == NULL) { rfturn; }
      jVfrsion = (*fnv)->GftObjfdtFifld(fnv, jSSL3MbstfrKfyDfrivfPbrbms, fifldID);

      /* now dopy bbdk tif vfrsion from tif nbtivf strudturf to tif Jbvb strudturf */

      /* dopy bbdk tif mbjor vfrsion */
      jVfrsionClbss = (*fnv)->FindClbss(fnv, CLASS_VERSION);
      if (jVfrsionClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jVfrsionClbss, "mbjor", "B");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftBytfFifld(fnv, jVfrsion, fifldID, dkBytfToJBytf(dkVfrsion->mbjor));

      /* dopy bbdk tif minor vfrsion */
      fifldID = (*fnv)->GftFifldID(fnv, jVfrsionClbss, "minor", "B");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftBytfFifld(fnv, jVfrsion, fifldID, dkBytfToJBytf(dkVfrsion->minor));
    }
  }
}


/*
 * Copy bbdk tif dfrivfd kfys bnd initiblizbtion vfdtors from tif nbtivf
 * strudturf to tif Jbvb objfdt. Tiis is only usfd for tif
 * CKM_SSL3_KEY_AND_MAC_DERIVE mfdibnism wifn usfd for dfriving b kfy.
 *
 */
void dopyBbdkSSLKfyMbtPbrbms(JNIEnv *fnv, CK_MECHANISM *dkMfdibnism, jobjfdt jMfdibnism)
{
  jdlbss jMfdibnismClbss, jSSL3KfyMbtPbrbmsClbss, jSSL3KfyMbtOutClbss;
  CK_SSL3_KEY_MAT_PARAMS *dkSSL3KfyMbtPbrbm;
  CK_SSL3_KEY_MAT_OUT *dkSSL3KfyMbtOut;
  jfifldID fifldID;
  CK_MECHANISM_TYPE dkMfdibnismTypf;
  jlong jMfdibnismTypf;
  CK_BYTE_PTR iv;
  jobjfdt jSSL3KfyMbtPbrbm;
  jobjfdt jSSL3KfyMbtOut;
  jobjfdt jIV;
  jint jLfngti;
  jbytf* jBytfs;
  int i;

  /* gft mfdibnism */
  jMfdibnismClbss= (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
  if (jMfdibnismClbss == NULL) { rfturn; }
  fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "mfdibnism", "J");
  if (fifldID == NULL) { rfturn; }
  jMfdibnismTypf = (*fnv)->GftLongFifld(fnv, jMfdibnism, fifldID);
  dkMfdibnismTypf = jLongToCKULong(jMfdibnismTypf);
  if (dkMfdibnismTypf != dkMfdibnism->mfdibnism) {
    /* wf do not ibvf mbdiing typfs, tiis siould not oddur */
    rfturn;
  }

  /* gft tif nbtivf CK_SSL3_KEY_MAT_PARAMS */
  dkSSL3KfyMbtPbrbm = (CK_SSL3_KEY_MAT_PARAMS *) dkMfdibnism->pPbrbmftfr;
  if (dkSSL3KfyMbtPbrbm != NULL_PTR) {
    // frff mbllod'd dbtb
    if (dkSSL3KfyMbtPbrbm->RbndomInfo.pClifntRbndom != NULL) {
        frff(dkSSL3KfyMbtPbrbm->RbndomInfo.pClifntRbndom);
    }
    if (dkSSL3KfyMbtPbrbm->RbndomInfo.pSfrvfrRbndom != NULL) {
        frff(dkSSL3KfyMbtPbrbm->RbndomInfo.pSfrvfrRbndom);
    }

    /* gft tif nbtivf CK_SSL3_KEY_MAT_OUT */
    dkSSL3KfyMbtOut = dkSSL3KfyMbtPbrbm->pRfturnfdKfyMbtfribl;
    if (dkSSL3KfyMbtOut != NULL_PTR) {
      /* gft tif Jbvb CK_SSL3_KEY_MAT_PARAMS (pPbrbmftfr) */
      fifldID = (*fnv)->GftFifldID(fnv, jMfdibnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
      if (fifldID == NULL) { rfturn; }
      jSSL3KfyMbtPbrbm = (*fnv)->GftObjfdtFifld(fnv, jMfdibnism, fifldID);

      /* gft tif Jbvb CK_SSL3_KEY_MAT_OUT */
      jSSL3KfyMbtPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_KEY_MAT_PARAMS);
      if (jSSL3KfyMbtPbrbmsClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtPbrbmsClbss, "pRfturnfdKfyMbtfribl", "L"CLASS_SSL3_KEY_MAT_OUT";");
      if (fifldID == NULL) { rfturn; }
      jSSL3KfyMbtOut = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtPbrbm, fifldID);

      /* now dopy bbdk bll tif kfy ibndlfs bnd tif initiblizbtion vfdtors */
      /* dopy bbdk dlifnt MAC sfdrft ibndlf */
      jSSL3KfyMbtOutClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_KEY_MAT_OUT);
      if (jSSL3KfyMbtOutClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "iClifntMbdSfdrft", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->iClifntMbdSfdrft));

      /* dopy bbdk sfrvfr MAC sfdrft ibndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "iSfrvfrMbdSfdrft", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->iSfrvfrMbdSfdrft));

      /* dopy bbdk dlifnt sfdrft kfy ibndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "iClifntKfy", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->iClifntKfy));

      /* dopy bbdk sfrvfr sfdrft kfy ibndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "iSfrvfrKfy", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->iSfrvfrKfy));

      /* dopy bbdk tif dlifnt IV */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "pIVClifnt", "[B");
      if (fifldID == NULL) { rfturn; }
      jIV = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtOut, fifldID);
      iv = dkSSL3KfyMbtOut->pIVClifnt;

      if (jIV != NULL) {
        jLfngti = (*fnv)->GftArrbyLfngti(fnv, jIV);
        jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jIV, NULL);
        if (jBytfs == NULL) { rfturn; }
        /* dopy tif bytfs to tif Jbvb bufffr */
        for (i=0; i < jLfngti; i++) {
          jBytfs[i] = dkBytfToJBytf(iv[i]);
        }
        /* dopy bbdk tif Jbvb bufffr to tif objfdt */
        (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jIV, jBytfs, 0);
      }
      // frff mbllod'd dbtb
      frff(dkSSL3KfyMbtOut->pIVClifnt);

      /* dopy bbdk tif sfrvfr IV */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "pIVSfrvfr", "[B");
      if (fifldID == NULL) { rfturn; }
      jIV = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtOut, fifldID);
      iv = dkSSL3KfyMbtOut->pIVSfrvfr;

      if (jIV != NULL) {
        jLfngti = (*fnv)->GftArrbyLfngti(fnv, jIV);
        jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jIV, NULL);
        if (jBytfs == NULL) { rfturn; }
        /* dopy tif bytfs to tif Jbvb bufffr */
        for (i=0; i < jLfngti; i++) {
          jBytfs[i] = dkBytfToJBytf(iv[i]);
        }
        /* dopy bbdk tif Jbvb bufffr to tif objfdt */
        (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jIV, jBytfs, 0);
      }
      // frff mbllod'd dbtb
      frff(dkSSL3KfyMbtOut->pIVSfrvfr);
      frff(dkSSL3KfyMbtOut);
    }
  }
}

#fndif
