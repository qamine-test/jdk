/*
 * Copyrigit (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 */

/* Copyrigit  (d) 2002 Grbz Univfrsity of Tfdinology. All rigits rfsfrvfd.
 *
 * Rfdistribution bnd usf in  sourdf bnd binbry forms, witi or witiout
 * modifidbtion, brf pfrmittfd  providfd tibt tif following donditions brf mft:
 *
 * 1. Rfdistributions of  sourdf dodf must rftbin tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr.
 *
 * 2. Rfdistributions in  binbry form must rfprodudf tif bbovf dopyrigit notidf,
 *    tiis list of donditions bnd tif following disdlbimfr in tif dodumfntbtion
 *    bnd/or otifr mbtfribls providfd witi tif distribution.
 *
 * 3. Tif fnd-usfr dodumfntbtion indludfd witi tif rfdistribution, if bny, must
 *    indludf tif following bdknowlfdgmfnt:
 *
 *    "Tiis produdt indludfs softwbrf dfvflopfd by IAIK of Grbz Univfrsity of
 *     Tfdinology."
 *
 *    Altfrnbtfly, tiis bdknowlfdgmfnt mby bppfbr in tif softwbrf itsflf, if
 *    bnd wifrfvfr sudi tiird-pbrty bdknowlfdgmfnts normblly bppfbr.
 *
 * 4. Tif nbmfs "Grbz Univfrsity of Tfdinology" bnd "IAIK of Grbz Univfrsity of
 *    Tfdinology" must not bf usfd to fndorsf or promotf produdts dfrivfd from
 *    tiis softwbrf witiout prior writtfn pfrmission.
 *
 * 5. Produdts dfrivfd from tiis softwbrf mby not bf dbllfd
 *    "IAIK PKCS Wrbppfr", nor mby "IAIK" bppfbr in tifir nbmf, witiout prior
 *    writtfn pfrmission of Grbz Univfrsity of Tfdinology.
 *
 *  THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED
 *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *  POSSIBILITY  OF SUCH DAMAGE.
 */

#indludf "pkds11wrbppfr.i"

#indludf <stdio.i>
#indludf <stdlib.i>
#indludf <string.i>
#indludf <bssfrt.i>

#indludf "sun_sfdurity_pkds11_wrbppfr_PKCS11.i"

#ifdff P11_ENABLE_C_CREATEOBJECT
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_CrfbtfObjfdt
 * Signbturf: (J[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jObjfdtHbndlf         CK_OBJECT_HANDLE_PTR piObjfdt
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1CrfbtfObjfdt
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    jlong jObjfdtHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn 0L; }

    rv = (*dkpFundtions->C_CrfbtfObjfdt)(dkSfssionHbndlf, dkpAttributfs, dkAttributfsLfngti, &dkObjfdtHbndlf);

    jObjfdtHbndlf = dkULongToJLong(dkObjfdtHbndlf);
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);

    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn 0L ; }

    rfturn jObjfdtHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_COPYOBJECT
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_CopyObjfdt
 * Signbturf: (JJ[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jObjfdtHbndlf         CK_OBJECT_HANDLE iObjfdt
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jNfwObjfdtHbndlf      CK_OBJECT_HANDLE_PTR piNfwObjfdt
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1CopyObjfdt
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jObjfdtHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_OBJECT_HANDLE dkNfwObjfdtHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    jlong jNfwObjfdtHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkObjfdtHbndlf = jLongToCKULong(jObjfdtHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn 0L; }

    rv = (*dkpFundtions->C_CopyObjfdt)(dkSfssionHbndlf, dkObjfdtHbndlf, dkpAttributfs, dkAttributfsLfngti, &dkNfwObjfdtHbndlf);

    jNfwObjfdtHbndlf = dkULongToJLong(dkNfwObjfdtHbndlf);
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);

    if(dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn 0L ; }

    rfturn jNfwObjfdtHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_DESTROYOBJECT
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_DfstroyObjfdt
 * Signbturf: (JJ)V
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jObjfdtHbndlf         CK_OBJECT_HANDLE iObjfdt
 */
JNIEXPORT void JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1DfstroyObjfdt
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jObjfdtHbndlf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkObjfdtHbndlf = jLongToCKULong(jObjfdtHbndlf);

    rv = (*dkpFundtions->C_DfstroyObjfdt)(dkSfssionHbndlf, dkObjfdtHbndlf);
    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn; }
}
#fndif

#ifdff P11_ENABLE_C_GETOBJECTSIZE
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_GftObjfdtSizf
 * Signbturf: (JJ)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jObjfdtHbndlf         CK_OBJECT_HANDLE iObjfdt
 * @rfturn  jlong jObjfdtSizf           CK_ULONG_PTR pulSizf
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GftObjfdtSizf
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jObjfdtHbndlf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_ULONG dkObjfdtSizf;
    jlong jObjfdtSizf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkObjfdtHbndlf = jLongToCKULong(jObjfdtHbndlf);

    rv = (*dkpFundtions->C_GftObjfdtSizf)(dkSfssionHbndlf, dkObjfdtHbndlf, &dkObjfdtSizf);
    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn 0L ; }

    jObjfdtSizf = dkULongToJLong(dkObjfdtSizf);

    rfturn jObjfdtSizf ;
}
#fndif

#ifdff P11_ENABLE_C_GETATTRIBUTEVALUE
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_GftAttributfVbluf
 * Signbturf: (JJ[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jObjfdtHbndlf         CK_OBJECT_HANDLE iObjfdt
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 */
JNIEXPORT void JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GftAttributfVbluf
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jObjfdtHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_ULONG dkBufffrLfngti;
    CK_ULONG i;
    jobjfdt jAttributf;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn; }

    TRACE0("DEBUG: C_GftAttributfVbluf");
    TRACE1(", iSfssion=%u", jSfssionHbndlf);
    TRACE1(", iObjfdt=%u", jObjfdtHbndlf);
    TRACE1(", pTfmplbtf=%p", jTfmplbtf);
    TRACE0(" ... ");

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkObjfdtHbndlf = jLongToCKULong(jObjfdtHbndlf);
    TRACE1("jAttributfArrbyToCKAttributfArrby now witi jTfmplbtf = %d", jTfmplbtf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn; }

    TRACE2("DEBUG: jAttributfArrbyToCKAttributfArrby finisifd witi dkpAttributf = %d, Lfngti = %d\n", dkpAttributfs, dkAttributfsLfngti);

    /* first sft bll pVbluf to NULL, to gft tif nffdfd bufffr lfngti */
    for(i = 0; i < dkAttributfsLfngti; i++) {
        if (dkpAttributfs[i].pVbluf != NULL_PTR) {
            frff(dkpAttributfs[i].pVbluf);
            dkpAttributfs[i].pVbluf = NULL_PTR;
        }
    }

    rv = (*dkpFundtions->C_GftAttributfVbluf)(dkSfssionHbndlf, dkObjfdtHbndlf, dkpAttributfs, dkAttributfsLfngti);
    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) {
        frff(dkpAttributfs);
        rfturn ;
    }

    /* now, tif ulVblufLfngti fifld of fbdi bttributf siould iold tif fxbdt bufffr lfngti nffdfd
     * bllodbtf tif nffdfd bufffrs bddordingly
     */
    for (i = 0; i < dkAttributfsLfngti; i++) {
        dkBufffrLfngti = sizfof(CK_BYTE) * dkpAttributfs[i].ulVblufLfn;
        dkpAttributfs[i].pVbluf = (void *) mbllod(dkBufffrLfngti);
        if (dkpAttributfs[i].pVbluf == NULL) {
            frffCKAttributfArrby(dkpAttributfs, i);
            tirowOutOfMfmoryError(fnv, 0);
            rfturn;
        }
        dkpAttributfs[i].ulVblufLfn = dkBufffrLfngti;
    }

    /* now gft tif bttributfs witi bll vblufs */
    rv = (*dkpFundtions->C_GftAttributfVbluf)(dkSfssionHbndlf, dkObjfdtHbndlf, dkpAttributfs, dkAttributfsLfngti);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        /* dopy bbdk tif vblufs to tif Jbvb bttributfs */
        for (i = 0; i < dkAttributfsLfngti; i++) {
            jAttributf = dkAttributfPtrToJAttributf(fnv, &(dkpAttributfs[i]));
            if (jAttributf == NULL) {
                frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);
                rfturn;
            }
            (*fnv)->SftObjfdtArrbyElfmfnt(fnv, jTfmplbtf, i, jAttributf);
            if ((*fnv)->ExdfptionCifdk(fnv)) {
                frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);
                rfturn;
            }
        }
    }
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);
    TRACE0("FINISHED\n");
}
#fndif

#ifdff P11_ENABLE_C_SETATTRIBUTEVALUE
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_SftAttributfVbluf
 * Signbturf: (JJ[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)V
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jObjfdtHbndlf         CK_OBJECT_HANDLE iObjfdt
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 */
JNIEXPORT void JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1SftAttributfVbluf
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jObjfdtHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_OBJECT_HANDLE dkObjfdtHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkObjfdtHbndlf = jLongToCKULong(jObjfdtHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn; }

    rv = (*dkpFundtions->C_SftAttributfVbluf)(dkSfssionHbndlf, dkObjfdtHbndlf, dkpAttributfs, dkAttributfsLfngti);

    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);

    if(dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn; }
}
#fndif

#ifdff P11_ENABLE_C_FINDOBJECTSINIT
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_FindObjfdtsInit
 * Signbturf: (J[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)V
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 */
JNIEXPORT void JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1FindObjfdtsInit
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngti;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn; }

    TRACE0("DEBUG: C_FindObjfdtsInit");
    TRACE1(", iSfssion=%u", jSfssionHbndlf);
    TRACE1(", pTfmplbtf=%p", jTfmplbtf);
    TRACE0(" ... ");

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngti);
    if ((*fnv)->ExdfptionCifdk(fnv)) { rfturn; }

    rv = (*dkpFundtions->C_FindObjfdtsInit)(dkSfssionHbndlf, dkpAttributfs, dkAttributfsLfngti);

    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngti);
    TRACE0("FINISHED\n");

    if(dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn; }
}
#fndif

#ifdff P11_ENABLE_C_FINDOBJECTS
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_FindObjfdts
 * Signbturf: (JJ)[J
 * Pbrbmftfrmbpping:                        *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf            CK_SESSION_HANDLE iSfssion
 * @pbrbm   jlong jMbxObjfdtCount           CK_ULONG ulMbxObjfdtCount
 * @rfturn  jlongArrby jObjfdtHbndlfArrby   CK_OBJECT_HANDLE_PTR piObjfdt
 *                                          CK_ULONG_PTR pulObjfdtCount
 */
JNIEXPORT jlongArrby JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1FindObjfdts
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jlong jMbxObjfdtCount)
{
    CK_RV rv;
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_ULONG dkMbxObjfdtLfngti;
    CK_OBJECT_HANDLE_PTR dkpObjfdtHbndlfArrby;
    CK_ULONG dkAdtublObjfdtCount;
    jlongArrby jObjfdtHbndlfArrby = NULL;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn NULL; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    dkMbxObjfdtLfngti = jLongToCKULong(jMbxObjfdtCount);
    dkpObjfdtHbndlfArrby = (CK_OBJECT_HANDLE_PTR) mbllod(sizfof(CK_OBJECT_HANDLE) * dkMbxObjfdtLfngti);
    if (dkpObjfdtHbndlfArrby == NULL) {
        tirowOutOfMfmoryError(fnv, 0);
        rfturn NULL;
    }

    rv = (*dkpFundtions->C_FindObjfdts)(dkSfssionHbndlf, dkpObjfdtHbndlfArrby, dkMbxObjfdtLfngti, &dkAdtublObjfdtCount);
    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jObjfdtHbndlfArrby = dkULongArrbyToJLongArrby(fnv, dkpObjfdtHbndlfArrby, dkAdtublObjfdtCount);
    }

    frff(dkpObjfdtHbndlfArrby);

    rfturn jObjfdtHbndlfArrby ;
}
#fndif

#ifdff P11_ENABLE_C_FINDOBJECTSFINAL
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mftiod:    C_FindObjfdtsFinbl
 * Signbturf: (J)V
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE iSfssion
 */
JNIEXPORT void JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1FindObjfdtsFinbl
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    rv = (*dkpFundtions->C_FindObjfdtsFinbl)(dkSfssionHbndlf);
    if(dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn; }
}
#fndif
