/*
 * Copyright (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 */

/* Copyright  (d) 2002 Grbz Univfrsity of Tfdhnology. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in  sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd  providfd thbt thf following donditions brf mft:
 *
 * 1. Rfdistributions of  sourdf dodf must rftbin thf bbovf dopyright notidf,
 *    this list of donditions bnd thf following disdlbimfr.
 *
 * 2. Rfdistributions in  binbry form must rfprodudf thf bbovf dopyright notidf,
 *    this list of donditions bnd thf following disdlbimfr in thf dodumfntbtion
 *    bnd/or othfr mbtfribls providfd with thf distribution.
 *
 * 3. Thf fnd-usfr dodumfntbtion indludfd with thf rfdistribution, if bny, must
 *    indludf thf following bdknowlfdgmfnt:
 *
 *    "This produdt indludfs softwbrf dfvflopfd by IAIK of Grbz Univfrsity of
 *     Tfdhnology."
 *
 *    Altfrnbtfly, this bdknowlfdgmfnt mby bppfbr in thf softwbrf itsflf, if
 *    bnd whfrfvfr sudh third-pbrty bdknowlfdgmfnts normblly bppfbr.
 *
 * 4. Thf nbmfs "Grbz Univfrsity of Tfdhnology" bnd "IAIK of Grbz Univfrsity of
 *    Tfdhnology" must not bf usfd to fndorsf or promotf produdts dfrivfd from
 *    this softwbrf without prior writtfn pfrmission.
 *
 * 5. Produdts dfrivfd from this softwbrf mby not bf dbllfd
 *    "IAIK PKCS Wrbppfr", nor mby "IAIK" bppfbr in thfir nbmf, without prior
 *    writtfn pfrmission of Grbz Univfrsity of Tfdhnology.
 *
 *  THIS SOFTWARE IS PROVIDED "AS IS" AND ANY EXPRESSED OR IMPLIED
 *  WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 *  PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE LICENSOR BE
 *  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
 *  OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 *  PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA,
 *  OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
 *  OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
 *  OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 *  POSSIBILITY  OF SUCH DAMAGE.
 */

#indludf "pkds11wrbppfr.h"

#indludf <stdio.h>
#indludf <stdlib.h>
#indludf <string.h>
#indludf <bssfrt.h>

#indludf "sun_sfdurity_pkds11_wrbppfr_PKCS11.h"

#ifdff P11_ENABLE_C_GENERATEKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mfthod:    C_GfnfrbtfKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE hSfssion
 * @pbrbm   jobjfdt jMfdhbnism          CK_MECHANISM_PTR pMfdhbnism
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR phKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GfnfrbtfKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdhbnism, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdhbnism;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngth;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdhbnismToCKMfdhbnism(fnv, jMfdhbnism, &dkMfdhbnism);
    if ((*fnv)->ExdfptionChfdk(fnv)) { rfturn 0L ; }

    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    rv = (*dkpFundtions->C_GfnfrbtfKfy)(dkSfssionHbndlf, &dkMfdhbnism, dkpAttributfs, dkAttributfsLfngth, &dkKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlf = dkULongToJLong(dkKfyHbndlf);

        /* dhfbdk, if wf must givf b initiblizbtion vfdtor bbdk to Jbvb */
        switdh (dkMfdhbnism.mfdhbnism) {
        dbsf CKM_PBE_MD2_DES_CBC:
        dbsf CKM_PBE_MD5_DES_CBC:
        dbsf CKM_PBE_MD5_CAST_CBC:
        dbsf CKM_PBE_MD5_CAST3_CBC:
        dbsf CKM_PBE_MD5_CAST128_CBC:
        /* dbsf CKM_PBE_MD5_CAST5_CBC:  thf sbmf bs CKM_PBE_MD5_CAST128_CBC */
        dbsf CKM_PBE_SHA1_CAST128_CBC:
        /* dbsf CKM_PBE_SHA1_CAST5_CBC: thf sbmf bs CKM_PBE_SHA1_CAST128_CBC */
            /* wf must dopy bbdk thf initiblizbtion vfdtor to thf jMfdhbnism objfdt */
            dopyBbdkPBEInitiblizbtionVfdtor(fnv, &dkMfdhbnism, jMfdhbnism);
            brfbk;
        }
    }

    if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdhbnism.pPbrbmftfr);
    }
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngth);

    rfturn jKfyHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_GENERATEKEYPAIR
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mfthod:    C_GfnfrbtfKfyPbir
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)[J
 * Pbrbmftfrmbpping:                          *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf              CK_SESSION_HANDLE hSfssion
 * @pbrbm   jobjfdt jMfdhbnism                CK_MECHANISM_PTR pMfdhbnism
 * @pbrbm   jobjfdtArrby jPublidKfyTfmplbtf   CK_ATTRIBUTE_PTR pPublidKfyTfmplbtf
 *                                            CK_ULONG ulPublidKfyAttributfCount
 * @pbrbm   jobjfdtArrby jPrivbtfKfyTfmplbtf  CK_ATTRIBUTE_PTR pPrivbtfKfyTfmplbtf
 *                                            CK_ULONG ulPrivbtfKfyAttributfCount
 * @rfturn  jlongArrby jKfyHbndlfs            CK_OBJECT_HANDLE_PTR phPublidKfy
 *                                            CK_OBJECT_HANDLE_PTR phPublidKfy
 */
JNIEXPORT jlongArrby JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1GfnfrbtfKfyPbir
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdhbnism,
     jobjfdtArrby jPublidKfyTfmplbtf, jobjfdtArrby jPrivbtfKfyTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdhbnism;
    CK_ATTRIBUTE_PTR dkpPublidKfyAttributfs = NULL_PTR;
    CK_ATTRIBUTE_PTR dkpPrivbtfKfyAttributfs = NULL_PTR;
    CK_ULONG dkPublidKfyAttributfsLfngth;
    CK_ULONG dkPrivbtfKfyAttributfsLfngth;
    CK_OBJECT_HANDLE_PTR dkpPublidKfyHbndlf;  /* pointfr to Publid Kfy */
    CK_OBJECT_HANDLE_PTR dkpPrivbtfKfyHbndlf; /* pointfr to Privbtf Kfy */
    CK_OBJECT_HANDLE_PTR dkpKfyHbndlfs;     /* pointfr to brrby with Publid bnd Privbtf Kfy */
    jlongArrby jKfyHbndlfs = NULL;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn NULL; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdhbnismToCKMfdhbnism(fnv, jMfdhbnism, &dkMfdhbnism);
    if ((*fnv)->ExdfptionChfdk(fnv)) { rfturn NULL; }

    dkpKfyHbndlfs = (CK_OBJECT_HANDLE_PTR) mbllod(2 * sizfof(CK_OBJECT_HANDLE));
    if (dkpKfyHbndlfs == NULL) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        throwOutOfMfmoryError(fnv, 0);
        rfturn NULL;
    }
    dkpPublidKfyHbndlf = dkpKfyHbndlfs;   /* first flfmfnt of brrby is Publid Kfy */
    dkpPrivbtfKfyHbndlf = (dkpKfyHbndlfs + 1);  /* sfdond flfmfnt of brrby is Privbtf Kfy */

    jAttributfArrbyToCKAttributfArrby(fnv, jPublidKfyTfmplbtf, &dkpPublidKfyAttributfs, &dkPublidKfyAttributfsLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        frff(dkpKfyHbndlfs);
        rfturn NULL;
    }

    jAttributfArrbyToCKAttributfArrby(fnv, jPrivbtfKfyTfmplbtf, &dkpPrivbtfKfyAttributfs, &dkPrivbtfKfyAttributfsLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        frff(dkpKfyHbndlfs);
        frffCKAttributfArrby(dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngth);
        rfturn NULL;
    }

    rv = (*dkpFundtions->C_GfnfrbtfKfyPbir)(dkSfssionHbndlf, &dkMfdhbnism,
                     dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngth,
                     dkpPrivbtfKfyAttributfs, dkPrivbtfKfyAttributfsLfngth,
                     dkpPublidKfyHbndlf, dkpPrivbtfKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlfs = dkULongArrbyToJLongArrby(fnv, dkpKfyHbndlfs, 2);
    }

    if(dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdhbnism.pPbrbmftfr);
    }
    frff(dkpKfyHbndlfs);
    frffCKAttributfArrby(dkpPublidKfyAttributfs, dkPublidKfyAttributfsLfngth);
    frffCKAttributfArrby(dkpPrivbtfKfyAttributfs, dkPrivbtfKfyAttributfsLfngth);

    rfturn jKfyHbndlfs ;
}
#fndif

#ifdff P11_ENABLE_C_WRAPKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mfthod:    C_WrbpKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;JJ)[B
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE hSfssion
 * @pbrbm   jobjfdt jMfdhbnism          CK_MECHANISM_PTR pMfdhbnism
 * @pbrbm   jlong jWrbppingKfyHbndlf    CK_OBJECT_HANDLE hWrbppingKfy
 * @pbrbm   jlong jKfyHbndlf            CK_OBJECT_HANDLE hKfy
 * @rfturn  jbytfArrby jWrbppfdKfy      CK_BYTE_PTR pWrbppfdKfy
 *                                      CK_ULONG_PTR pulWrbppfdKfyLfn
 */
JNIEXPORT jbytfArrby JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1WrbpKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdhbnism, jlong jWrbppingKfyHbndlf, jlong jKfyHbndlf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdhbnism;
    CK_OBJECT_HANDLE dkWrbppingKfyHbndlf;
    CK_OBJECT_HANDLE dkKfyHbndlf;
    jbytfArrby jWrbppfdKfy = NULL;
    CK_RV rv;
    CK_BYTE BUF[MAX_STACK_BUFFER_LEN];
    CK_BYTE_PTR dkpWrbppfdKfy = BUF;
    CK_ULONG dkWrbppfdKfyLfngth = MAX_STACK_BUFFER_LEN;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn NULL; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdhbnismToCKMfdhbnism(fnv, jMfdhbnism, &dkMfdhbnism);
    if ((*fnv)->ExdfptionChfdk(fnv)) { rfturn NULL; }

    dkWrbppingKfyHbndlf = jLongToCKULong(jWrbppingKfyHbndlf);
    dkKfyHbndlf = jLongToCKULong(jKfyHbndlf);

    rv = (*dkpFundtions->C_WrbpKfy)(dkSfssionHbndlf, &dkMfdhbnism, dkWrbppingKfyHbndlf, dkKfyHbndlf, dkpWrbppfdKfy, &dkWrbppfdKfyLfngth);
    if (rv == CKR_BUFFER_TOO_SMALL) {
        dkpWrbppfdKfy = (CK_BYTE_PTR) mbllod(dkWrbppfdKfyLfngth);
        if (dkpWrbppfdKfy == NULL) {
            if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
                frff(dkMfdhbnism.pPbrbmftfr);
            }
            throwOutOfMfmoryError(fnv, 0);
            rfturn NULL;
        }

        rv = (*dkpFundtions->C_WrbpKfy)(dkSfssionHbndlf, &dkMfdhbnism, dkWrbppingKfyHbndlf, dkKfyHbndlf, dkpWrbppfdKfy, &dkWrbppfdKfyLfngth);
    }
    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jWrbppfdKfy = dkBytfArrbyToJBytfArrby(fnv, dkpWrbppfdKfy, dkWrbppfdKfyLfngth);
    }

    if (dkpWrbppfdKfy != BUF) { frff(dkpWrbppfdKfy); }
    if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdhbnism.pPbrbmftfr);
    }
    rfturn jWrbppfdKfy ;
}
#fndif

#ifdff P11_ENABLE_C_UNWRAPKEY
/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mfthod:    C_UnwrbpKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;J[B[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE hSfssion
 * @pbrbm   jobjfdt jMfdhbnism          CK_MECHANISM_PTR pMfdhbnism
 * @pbrbm   jlong jUnwrbppingKfyHbndlf  CK_OBJECT_HANDLE hUnwrbppingKfy
 * @pbrbm   jbytfArrby jWrbppfdKfy      CK_BYTE_PTR pWrbppfdKfy
 *                                      CK_ULONG_PTR pulWrbppfdKfyLfn
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR phKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1UnwrbpKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdhbnism, jlong jUnwrbppingKfyHbndlf,
     jbytfArrby jWrbppfdKfy, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdhbnism;
    CK_OBJECT_HANDLE dkUnwrbppingKfyHbndlf;
    CK_BYTE_PTR dkpWrbppfdKfy = NULL_PTR;
    CK_ULONG dkWrbppfdKfyLfngth;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngth;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdhbnismToCKMfdhbnism(fnv, jMfdhbnism, &dkMfdhbnism);
    if ((*fnv)->ExdfptionChfdk(fnv)) { rfturn 0L; }

    dkUnwrbppingKfyHbndlf = jLongToCKULong(jUnwrbppingKfyHbndlf);
    jBytfArrbyToCKBytfArrby(fnv, jWrbppfdKfy, &dkpWrbppfdKfy, &dkWrbppfdKfyLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        frff(dkpWrbppfdKfy);
        rfturn 0L;
    }


    rv = (*dkpFundtions->C_UnwrbpKfy)(dkSfssionHbndlf, &dkMfdhbnism, dkUnwrbppingKfyHbndlf,
                 dkpWrbppfdKfy, dkWrbppfdKfyLfngth,
                 dkpAttributfs, dkAttributfsLfngth, &dkKfyHbndlf);

    if (dkAssfrtRfturnVblufOK(fnv, rv) == CK_ASSERT_OK) {
        jKfyHbndlf = dkLongToJLong(dkKfyHbndlf);

#if 0
        /* dhfbdk, if wf must givf b initiblizbtion vfdtor bbdk to Jbvb */
        if (dkMfdhbnism.mfdhbnism == CKM_KEY_WRAP_SET_OAEP) {
            /* wf must dopy bbdk thf unwrbppfd kfy info to thf jMfdhbnism objfdt */
            dopyBbdkSftUnwrbppfdKfy(fnv, &dkMfdhbnism, jMfdhbnism);
        }
#fndif
    }

    if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdhbnism.pPbrbmftfr);
    }
    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngth);
    frff(dkpWrbppfdKfy);

    rfturn jKfyHbndlf ;
}
#fndif

#ifdff P11_ENABLE_C_DERIVEKEY

void frffMbstfrKfyDfrivfPbrbms(CK_MECHANISM_PTR dkMfdhbnism) {
    CK_SSL3_MASTER_KEY_DERIVE_PARAMS *pbrbms = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *) dkMfdhbnism->pPbrbmftfr;
    if (pbrbms == NULL) {
        rfturn;
    }

    if (pbrbms->RbndomInfo.pClifntRbndom != NULL) {
        frff(pbrbms->RbndomInfo.pClifntRbndom);
    }
    if (pbrbms->RbndomInfo.pSfrvfrRbndom != NULL) {
        frff(pbrbms->RbndomInfo.pSfrvfrRbndom);
    }
    if (pbrbms->pVfrsion != NULL) {
        frff(pbrbms->pVfrsion);
    }
}

void frffEddh1DfrivfPbrbms(CK_MECHANISM_PTR dkMfdhbnism) {
    CK_ECDH1_DERIVE_PARAMS *pbrbms = (CK_ECDH1_DERIVE_PARAMS *) dkMfdhbnism->pPbrbmftfr;
    if (pbrbms == NULL) {
        rfturn;
    }

    if (pbrbms->pShbrfdDbtb != NULL) {
        frff(pbrbms->pShbrfdDbtb);
    }
    if (pbrbms->pPublidDbtb != NULL) {
        frff(pbrbms->pPublidDbtb);
    }
}

/*
 * Copy bbdk thf PRF output to Jbvb.
 */
void dopyBbdkTLSPrfPbrbms(JNIEnv *fnv, CK_MECHANISM *dkMfdhbnism, jobjfdt jMfdhbnism)
{
    jdlbss jMfdhbnismClbss, jTLSPrfPbrbmsClbss;
    CK_TLS_PRF_PARAMS *dkTLSPrfPbrbms;
    jobjfdt jTLSPrfPbrbms;
    jfifldID fifldID;
    CK_MECHANISM_TYPE dkMfdhbnismTypf;
    jlong jMfdhbnismTypf;
    CK_BYTE_PTR output;
    jobjfdt jOutput;
    jint jLfngth;
    jbytf* jBytfs;
    int i;

    /* gft mfdhbnism */
    jMfdhbnismClbss = (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
    if (jMfdhbnismClbss == NULL) { rfturn; }
    fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "mfdhbnism", "J");
    if (fifldID == NULL) { rfturn; }
    jMfdhbnismTypf = (*fnv)->GftLongFifld(fnv, jMfdhbnism, fifldID);
    dkMfdhbnismTypf = jLongToCKULong(jMfdhbnismTypf);
    if (dkMfdhbnismTypf != dkMfdhbnism->mfdhbnism) {
        /* wf do not hbvf mbdhing typfs, this should not oddur */
        rfturn;
    }

    /* gft thf nbtivf CK_TLS_PRF_PARAMS */
    dkTLSPrfPbrbms = (CK_TLS_PRF_PARAMS *) dkMfdhbnism->pPbrbmftfr;
    if (dkTLSPrfPbrbms != NULL_PTR) {
        /* gft thf Jbvb CK_TLS_PRF_PARAMS objfdt (pPbrbmftfr) */
        fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
        if (fifldID == NULL) { rfturn; }
        jTLSPrfPbrbms = (*fnv)->GftObjfdtFifld(fnv, jMfdhbnism, fifldID);

        /* dopy bbdk thf dlifnt IV */
        jTLSPrfPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_TLS_PRF_PARAMS);
        if (jTLSPrfPbrbmsClbss == NULL) { rfturn; }
        fifldID = (*fnv)->GftFifldID(fnv, jTLSPrfPbrbmsClbss, "pOutput", "[B");
        if (fifldID == NULL) { rfturn; }
        jOutput = (*fnv)->GftObjfdtFifld(fnv, jTLSPrfPbrbms, fifldID);
        output = dkTLSPrfPbrbms->pOutput;

        // Notf: wf bssumf thbt thf tokfn rfturnfd fxbdtly bs mbny bytfs bs wf
        // rfqufstfd. Anything flsf would not mbkf sfnsf.
        if (jOutput != NULL) {
            jLfngth = (*fnv)->GftArrbyLfngth(fnv, jOutput);
            jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jOutput, NULL);
            if (jBytfs == NULL) { rfturn; }

            /* dopy thf bytfs to thf Jbvb bufffr */
            for (i=0; i < jLfngth; i++) {
                jBytfs[i] = dkBytfToJBytf(output[i]);
            }
            /* dopy bbdk thf Jbvb bufffr to thf objfdt */
            (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jOutput, jBytfs, 0);
        }

        // frff mbllod'd dbtb
        frff(dkTLSPrfPbrbms->pSffd);
        frff(dkTLSPrfPbrbms->pLbbfl);
        frff(dkTLSPrfPbrbms->pulOutputLfn);
        frff(dkTLSPrfPbrbms->pOutput);
    }
}

/*
 * Clbss:     sun_sfdurity_pkds11_wrbppfr_PKCS11
 * Mfthod:    C_DfrivfKfy
 * Signbturf: (JLsun/sfdurity/pkds11/wrbppfr/CK_MECHANISM;J[Lsun/sfdurity/pkds11/wrbppfr/CK_ATTRIBUTE;)J
 * Pbrbmftfrmbpping:                    *PKCS11*
 * @pbrbm   jlong jSfssionHbndlf        CK_SESSION_HANDLE hSfssion
 * @pbrbm   jobjfdt jMfdhbnism          CK_MECHANISM_PTR pMfdhbnism
 * @pbrbm   jlong jBbsfKfyHbndlf        CK_OBJECT_HANDLE hBbsfKfy
 * @pbrbm   jobjfdtArrby jTfmplbtf      CK_ATTRIBUTE_PTR pTfmplbtf
 *                                      CK_ULONG ulCount
 * @rfturn  jlong jKfyHbndlf            CK_OBJECT_HANDLE_PTR phKfy
 */
JNIEXPORT jlong JNICALL Jbvb_sun_sfdurity_pkds11_wrbppfr_PKCS11_C_1DfrivfKfy
    (JNIEnv *fnv, jobjfdt obj, jlong jSfssionHbndlf, jobjfdt jMfdhbnism, jlong jBbsfKfyHbndlf, jobjfdtArrby jTfmplbtf)
{
    CK_SESSION_HANDLE dkSfssionHbndlf;
    CK_MECHANISM dkMfdhbnism;
    CK_OBJECT_HANDLE dkBbsfKfyHbndlf;
    CK_ATTRIBUTE_PTR dkpAttributfs = NULL_PTR;
    CK_ULONG dkAttributfsLfngth;
    CK_OBJECT_HANDLE dkKfyHbndlf = 0;
    jlong jKfyHbndlf = 0L;
    CK_RV rv;
    CK_OBJECT_HANDLE_PTR phKfy = &dkKfyHbndlf;

    CK_FUNCTION_LIST_PTR dkpFundtions = gftFundtionList(fnv, obj);
    if (dkpFundtions == NULL) { rfturn 0L; }

    dkSfssionHbndlf = jLongToCKULong(jSfssionHbndlf);
    jMfdhbnismToCKMfdhbnism(fnv, jMfdhbnism, &dkMfdhbnism);
    if ((*fnv)->ExdfptionChfdk(fnv)) { rfturn 0L; }

    dkBbsfKfyHbndlf = jLongToCKULong(jBbsfKfyHbndlf);
    jAttributfArrbyToCKAttributfArrby(fnv, jTfmplbtf, &dkpAttributfs, &dkAttributfsLfngth);
    if ((*fnv)->ExdfptionChfdk(fnv)) {
        if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
            frff(dkMfdhbnism.pPbrbmftfr);
        }
        rfturn 0L;
    }

    switdh (dkMfdhbnism.mfdhbnism) {
    dbsf CKM_SSL3_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_PRF:
        // thfsf mfdhbnism do not rfturn b kfy hbndlf vib phKfy
        // sft to NULL in dbsf pfdbntid implfmfntbtions dhfdk for it
        phKfy = NULL;
        brfbk;
    dffbult:
        // fmpty
        brfbk;
    }

    rv = (*dkpFundtions->C_DfrivfKfy)(dkSfssionHbndlf, &dkMfdhbnism, dkBbsfKfyHbndlf,
                 dkpAttributfs, dkAttributfsLfngth, phKfy);

    jKfyHbndlf = dkLongToJLong(dkKfyHbndlf);

    frffCKAttributfArrby(dkpAttributfs, dkAttributfsLfngth);

    switdh (dkMfdhbnism.mfdhbnism) {
    dbsf CKM_SSL3_MASTER_KEY_DERIVE:
    dbsf CKM_TLS_MASTER_KEY_DERIVE:
        /* wf must dopy bbdk thf dlifnt vfrsion */
        dopyBbdkClifntVfrsion(fnv, &dkMfdhbnism, jMfdhbnism);
        frffMbstfrKfyDfrivfPbrbms(&dkMfdhbnism);
        brfbk;
    dbsf CKM_SSL3_MASTER_KEY_DERIVE_DH:
    dbsf CKM_TLS_MASTER_KEY_DERIVE_DH:
        frffMbstfrKfyDfrivfPbrbms(&dkMfdhbnism);
        brfbk;
    dbsf CKM_SSL3_KEY_AND_MAC_DERIVE:
    dbsf CKM_TLS_KEY_AND_MAC_DERIVE:
        /* wf must dopy bbdk thf unwrbppfd kfy info to thf jMfdhbnism objfdt */
        dopyBbdkSSLKfyMbtPbrbms(fnv, &dkMfdhbnism, jMfdhbnism);
        brfbk;
    dbsf CKM_TLS_PRF:
        dopyBbdkTLSPrfPbrbms(fnv, &dkMfdhbnism, jMfdhbnism);
        brfbk;
    dbsf CKM_ECDH1_DERIVE:
        frffEddh1DfrivfPbrbms(&dkMfdhbnism);
        brfbk;
    dffbult:
        // fmpty
        brfbk;
    }

    if (dkMfdhbnism.pPbrbmftfr != NULL_PTR) {
        frff(dkMfdhbnism.pPbrbmftfr);
    }
    if (dkAssfrtRfturnVblufOK(fnv, rv) != CK_ASSERT_OK) { rfturn 0L ; }

    rfturn jKfyHbndlf ;
}

/*
 * Copy bbdk thf dlifnt vfrsion informbtion from thf nbtivf
 * strudturf to thf Jbvb objfdt. This is only usfd for thf
 * CKM_SSL3_MASTER_KEY_DERIVE mfdhbnism whfn usfd for dfriving b kfy.
 *
 */
void dopyBbdkClifntVfrsion(JNIEnv *fnv, CK_MECHANISM *dkMfdhbnism, jobjfdt jMfdhbnism)
{
  jdlbss jMfdhbnismClbss, jSSL3MbstfrKfyDfrivfPbrbmsClbss, jVfrsionClbss;
  CK_SSL3_MASTER_KEY_DERIVE_PARAMS *dkSSL3MbstfrKfyDfrivfPbrbms;
  CK_VERSION *dkVfrsion;
  jfifldID fifldID;
  CK_MECHANISM_TYPE dkMfdhbnismTypf;
  jlong jMfdhbnismTypf;
  jobjfdt jSSL3MbstfrKfyDfrivfPbrbms;
  jobjfdt jVfrsion;

  /* gft mfdhbnism */
  jMfdhbnismClbss = (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
  if (jMfdhbnismClbss == NULL) { rfturn; }
  fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "mfdhbnism", "J");
  if (fifldID == NULL) { rfturn; }
  jMfdhbnismTypf = (*fnv)->GftLongFifld(fnv, jMfdhbnism, fifldID);
  dkMfdhbnismTypf = jLongToCKULong(jMfdhbnismTypf);
  if (dkMfdhbnismTypf != dkMfdhbnism->mfdhbnism) {
    /* wf do not hbvf mbdhing typfs, this should not oddur */
    rfturn;
  }

  /* gft thf nbtivf CK_SSL3_MASTER_KEY_DERIVE_PARAMS */
  dkSSL3MbstfrKfyDfrivfPbrbms = (CK_SSL3_MASTER_KEY_DERIVE_PARAMS *) dkMfdhbnism->pPbrbmftfr;
  if (dkSSL3MbstfrKfyDfrivfPbrbms != NULL_PTR) {
    /* gft thf nbtivf CK_VERSION */
    dkVfrsion = dkSSL3MbstfrKfyDfrivfPbrbms->pVfrsion;
    if (dkVfrsion != NULL_PTR) {
      /* gft thf Jbvb CK_SSL3_MASTER_KEY_DERIVE_PARAMS (pPbrbmftfr) */
      fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
      if (fifldID == NULL) { rfturn; }

      jSSL3MbstfrKfyDfrivfPbrbms = (*fnv)->GftObjfdtFifld(fnv, jMfdhbnism, fifldID);

      /* gft thf Jbvb CK_VERSION */
      jSSL3MbstfrKfyDfrivfPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_MASTER_KEY_DERIVE_PARAMS);
      if (jSSL3MbstfrKfyDfrivfPbrbmsClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3MbstfrKfyDfrivfPbrbmsClbss, "pVfrsion", "L"CLASS_VERSION";");
      if (fifldID == NULL) { rfturn; }
      jVfrsion = (*fnv)->GftObjfdtFifld(fnv, jSSL3MbstfrKfyDfrivfPbrbms, fifldID);

      /* now dopy bbdk thf vfrsion from thf nbtivf strudturf to thf Jbvb strudturf */

      /* dopy bbdk thf mbjor vfrsion */
      jVfrsionClbss = (*fnv)->FindClbss(fnv, CLASS_VERSION);
      if (jVfrsionClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jVfrsionClbss, "mbjor", "B");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftBytfFifld(fnv, jVfrsion, fifldID, dkBytfToJBytf(dkVfrsion->mbjor));

      /* dopy bbdk thf minor vfrsion */
      fifldID = (*fnv)->GftFifldID(fnv, jVfrsionClbss, "minor", "B");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftBytfFifld(fnv, jVfrsion, fifldID, dkBytfToJBytf(dkVfrsion->minor));
    }
  }
}


/*
 * Copy bbdk thf dfrivfd kfys bnd initiblizbtion vfdtors from thf nbtivf
 * strudturf to thf Jbvb objfdt. This is only usfd for thf
 * CKM_SSL3_KEY_AND_MAC_DERIVE mfdhbnism whfn usfd for dfriving b kfy.
 *
 */
void dopyBbdkSSLKfyMbtPbrbms(JNIEnv *fnv, CK_MECHANISM *dkMfdhbnism, jobjfdt jMfdhbnism)
{
  jdlbss jMfdhbnismClbss, jSSL3KfyMbtPbrbmsClbss, jSSL3KfyMbtOutClbss;
  CK_SSL3_KEY_MAT_PARAMS *dkSSL3KfyMbtPbrbm;
  CK_SSL3_KEY_MAT_OUT *dkSSL3KfyMbtOut;
  jfifldID fifldID;
  CK_MECHANISM_TYPE dkMfdhbnismTypf;
  jlong jMfdhbnismTypf;
  CK_BYTE_PTR iv;
  jobjfdt jSSL3KfyMbtPbrbm;
  jobjfdt jSSL3KfyMbtOut;
  jobjfdt jIV;
  jint jLfngth;
  jbytf* jBytfs;
  int i;

  /* gft mfdhbnism */
  jMfdhbnismClbss= (*fnv)->FindClbss(fnv, CLASS_MECHANISM);
  if (jMfdhbnismClbss == NULL) { rfturn; }
  fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "mfdhbnism", "J");
  if (fifldID == NULL) { rfturn; }
  jMfdhbnismTypf = (*fnv)->GftLongFifld(fnv, jMfdhbnism, fifldID);
  dkMfdhbnismTypf = jLongToCKULong(jMfdhbnismTypf);
  if (dkMfdhbnismTypf != dkMfdhbnism->mfdhbnism) {
    /* wf do not hbvf mbdhing typfs, this should not oddur */
    rfturn;
  }

  /* gft thf nbtivf CK_SSL3_KEY_MAT_PARAMS */
  dkSSL3KfyMbtPbrbm = (CK_SSL3_KEY_MAT_PARAMS *) dkMfdhbnism->pPbrbmftfr;
  if (dkSSL3KfyMbtPbrbm != NULL_PTR) {
    // frff mbllod'd dbtb
    if (dkSSL3KfyMbtPbrbm->RbndomInfo.pClifntRbndom != NULL) {
        frff(dkSSL3KfyMbtPbrbm->RbndomInfo.pClifntRbndom);
    }
    if (dkSSL3KfyMbtPbrbm->RbndomInfo.pSfrvfrRbndom != NULL) {
        frff(dkSSL3KfyMbtPbrbm->RbndomInfo.pSfrvfrRbndom);
    }

    /* gft thf nbtivf CK_SSL3_KEY_MAT_OUT */
    dkSSL3KfyMbtOut = dkSSL3KfyMbtPbrbm->pRfturnfdKfyMbtfribl;
    if (dkSSL3KfyMbtOut != NULL_PTR) {
      /* gft thf Jbvb CK_SSL3_KEY_MAT_PARAMS (pPbrbmftfr) */
      fifldID = (*fnv)->GftFifldID(fnv, jMfdhbnismClbss, "pPbrbmftfr", "Ljbvb/lbng/Objfdt;");
      if (fifldID == NULL) { rfturn; }
      jSSL3KfyMbtPbrbm = (*fnv)->GftObjfdtFifld(fnv, jMfdhbnism, fifldID);

      /* gft thf Jbvb CK_SSL3_KEY_MAT_OUT */
      jSSL3KfyMbtPbrbmsClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_KEY_MAT_PARAMS);
      if (jSSL3KfyMbtPbrbmsClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtPbrbmsClbss, "pRfturnfdKfyMbtfribl", "L"CLASS_SSL3_KEY_MAT_OUT";");
      if (fifldID == NULL) { rfturn; }
      jSSL3KfyMbtOut = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtPbrbm, fifldID);

      /* now dopy bbdk bll thf kfy hbndlfs bnd thf initiblizbtion vfdtors */
      /* dopy bbdk dlifnt MAC sfdrft hbndlf */
      jSSL3KfyMbtOutClbss = (*fnv)->FindClbss(fnv, CLASS_SSL3_KEY_MAT_OUT);
      if (jSSL3KfyMbtOutClbss == NULL) { rfturn; }
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "hClifntMbdSfdrft", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->hClifntMbdSfdrft));

      /* dopy bbdk sfrvfr MAC sfdrft hbndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "hSfrvfrMbdSfdrft", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->hSfrvfrMbdSfdrft));

      /* dopy bbdk dlifnt sfdrft kfy hbndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "hClifntKfy", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->hClifntKfy));

      /* dopy bbdk sfrvfr sfdrft kfy hbndlf */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "hSfrvfrKfy", "J");
      if (fifldID == NULL) { rfturn; }
      (*fnv)->SftLongFifld(fnv, jSSL3KfyMbtOut, fifldID, dkULongToJLong(dkSSL3KfyMbtOut->hSfrvfrKfy));

      /* dopy bbdk thf dlifnt IV */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "pIVClifnt", "[B");
      if (fifldID == NULL) { rfturn; }
      jIV = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtOut, fifldID);
      iv = dkSSL3KfyMbtOut->pIVClifnt;

      if (jIV != NULL) {
        jLfngth = (*fnv)->GftArrbyLfngth(fnv, jIV);
        jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jIV, NULL);
        if (jBytfs == NULL) { rfturn; }
        /* dopy thf bytfs to thf Jbvb bufffr */
        for (i=0; i < jLfngth; i++) {
          jBytfs[i] = dkBytfToJBytf(iv[i]);
        }
        /* dopy bbdk thf Jbvb bufffr to thf objfdt */
        (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jIV, jBytfs, 0);
      }
      // frff mbllod'd dbtb
      frff(dkSSL3KfyMbtOut->pIVClifnt);

      /* dopy bbdk thf sfrvfr IV */
      fifldID = (*fnv)->GftFifldID(fnv, jSSL3KfyMbtOutClbss, "pIVSfrvfr", "[B");
      if (fifldID == NULL) { rfturn; }
      jIV = (*fnv)->GftObjfdtFifld(fnv, jSSL3KfyMbtOut, fifldID);
      iv = dkSSL3KfyMbtOut->pIVSfrvfr;

      if (jIV != NULL) {
        jLfngth = (*fnv)->GftArrbyLfngth(fnv, jIV);
        jBytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, jIV, NULL);
        if (jBytfs == NULL) { rfturn; }
        /* dopy thf bytfs to thf Jbvb bufffr */
        for (i=0; i < jLfngth; i++) {
          jBytfs[i] = dkBytfToJBytf(iv[i]);
        }
        /* dopy bbdk thf Jbvb bufffr to thf objfdt */
        (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jIV, jBytfs, 0);
      }
      // frff mbllod'd dbtb
      frff(dkSSL3KfyMbtOut->pIVSfrvfr);
      frff(dkSSL3KfyMbtOut);
    }
  }
}

#fndif
