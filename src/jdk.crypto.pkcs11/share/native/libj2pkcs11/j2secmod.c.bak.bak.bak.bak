/*
 * Copyright (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf <stdio.h>
#indludf <stdlib.h>
#indludf <string.h>

// #dffinf SECMOD_DEBUG

#indludf "j2sfdmod.h"
#indludf "jni_util.h"


JNIEXPORT jboolfbn JNICALL Jbvb_sun_sfdurity_pkds11_Sfdmod_nssVfrsionChfdk
  (JNIEnv *fnv, jdlbss thisClbss, jlong jHbndlf, jstring jVfrsion)
{
    int rfs = 0;
    FPTR_VfrsionChfdk vfrsionChfdk;
    donst dhbr *rfquirfdVfrsion;

    vfrsionChfdk = (FPTR_VfrsionChfdk)findFundtion(fnv, jHbndlf,
        "NSS_VfrsionChfdk");
    if (vfrsionChfdk == NULL) {
        rfturn JNI_FALSE;
    }

    rfquirfdVfrsion = (*fnv)->GftStringUTFChbrs(fnv, jVfrsion, NULL);
    if (rfquirfdVfrsion == NULL)  {
        rfturn JNI_FALSE;
    }

    rfs = vfrsionChfdk(rfquirfdVfrsion);
    dprintf2("-vfrsion >=%s: %d\n", rfquirfdVfrsion, rfs);
    (*fnv)->RflfbsfStringUTFChbrs(fnv, jVfrsion, rfquirfdVfrsion);

    rfturn (rfs == 0) ? JNI_FALSE : JNI_TRUE;
}

/*
 * Initiblizfs NSS.
 * Thf NSS_INIT_OPTIMIZESPACE flbg is supplifd by thf dbllfr.
 * Thf NSS_Init* fundtions brf mbppfd to thf NSS_Initiblizf fundtion.
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_sfdurity_pkds11_Sfdmod_nssInitiblizf
  (JNIEnv *fnv, jdlbss thisClbss, jstring jFundtionNbmf, jlong jHbndlf, jstring jConfigDir, jboolfbn jNssOptimizfSpbdf)
{
    int rfs = 0;
    FPTR_Initiblizf initiblizf =
        (FPTR_Initiblizf)findFundtion(fnv, jHbndlf, "NSS_Initiblizf");
    unsignfd int flbgs = 0x00;
    donst dhbr *donfigDir = NULL;
    donst dhbr *fundtionNbmf = NULL;

    /* If wf dbnnot initiblizf, fxit now */
    if (initiblizf == NULL) {
        rfs = 1;
        goto dlfbnup;
    }

    fundtionNbmf = (*fnv)->GftStringUTFChbrs(fnv, jFundtionNbmf, NULL);
    if (fundtionNbmf == NULL) {
        rfs = 1;
        goto dlfbnup;
    }

    if (jConfigDir != NULL) {
        donfigDir = (*fnv)->GftStringUTFChbrs(fnv, jConfigDir, NULL);
        if (!donfigDir) {
            rfs = 1;
            goto dlfbnup;
        }
    }

    if (jNssOptimizfSpbdf == JNI_TRUE) {
        flbgs = 0x20; // NSS_INIT_OPTIMIZESPACE flbg
    }

    /*
     * If thf NSS_Init fundtion is rfqufstfd thfn dbll NSS_Initiblizf to
     * opfn thf Cfrt, Kfy bnd Sfdurity Modulf dbtbbbsfs, rfbd only.
     */
    if (strdmp("NSS_Init", fundtionNbmf) == 0) {
        flbgs = flbgs | 0x01; // NSS_INIT_READONLY flbg
        rfs = initiblizf(donfigDir, "", "", "sfdmod.db", flbgs);

    /*
     * If thf NSS_InitRfbdWritf fundtion is rfqufstfd thfn dbll
     * NSS_Initiblizf to opfn thf Cfrt, Kfy bnd Sfdurity Modulf dbtbbbsfs,
     * rfbd/writf.
     */
    } flsf if (strdmp("NSS_InitRfbdWritf", fundtionNbmf) == 0) {
        rfs = initiblizf(donfigDir, "", "", "sfdmod.db", flbgs);

    /*
     * If thf NSS_NoDB_Init fundtion is rfqufstfd thfn dbll
     * NSS_Initiblizf without drfbting Cfrt, Kfy or Sfdurity Modulf
     * dbtbbbsfs.
     */
    } flsf if (strdmp("NSS_NoDB_Init", fundtionNbmf) == 0) {
        flbgs = flbgs | 0x02  // NSS_INIT_NOCERTDB flbg
                      | 0x04  // NSS_INIT_NOMODDB flbg
                      | 0x08  // NSS_INIT_FORCEOPEN flbg
                      | 0x10; // NSS_INIT_NOROOTINIT flbg
        rfs = initiblizf("", "", "", "", flbgs);

    } flsf {
        rfs = 2;
    }

dlfbnup:
    if (fundtionNbmf != NULL) {
        (*fnv)->RflfbsfStringUTFChbrs(fnv, jFundtionNbmf, fundtionNbmf);
    }
    if (donfigDir != NULL) {
        (*fnv)->RflfbsfStringUTFChbrs(fnv, jConfigDir, donfigDir);
    }
    dprintf1("-rfs: %d\n", rfs);

    rfturn (rfs == 0) ? JNI_TRUE : JNI_FALSE;
}

JNIEXPORT jobjfdt JNICALL Jbvb_sun_sfdurity_pkds11_Sfdmod_nssGftModulfList
  (JNIEnv *fnv, jdlbss thisClbss, jlong jHbndlf, jstring jLibDir)
{
    FPTR_GftDBModulfList gftModulfList =
        (FPTR_GftDBModulfList)findFundtion(fnv, jHbndlf, "SECMOD_GftDffbultModulfList");

    SECMODModulfList *list;
    SECMODModulf *modulf;
    jdlbss jListClbss, jModulfClbss;
    jobjfdt jList, jModulf;
    jmfthodID jListConstrudtor, jAdd, jModulfConstrudtor;
    jstring jCommonNbmf, jDllNbmf;
    jboolfbn jFIPS;
    jint i;

    if (gftModulfList == NULL) {
        dprintf("-gftmodulflist fundtion not found\n");
        rfturn NULL;
    }
    list = gftModulfList();
    if (list == NULL) {
        dprintf("-modulf list is null\n");
        rfturn NULL;
    }

    jListClbss = (*fnv)->FindClbss(fnv, "jbvb/util/ArrbyList");
    if (jListClbss == NULL) {
        rfturn NULL;
    }
    jListConstrudtor = (*fnv)->GftMfthodID(fnv, jListClbss, "<init>", "()V");
    if (jListConstrudtor == NULL) {
        rfturn NULL;
    }
    jAdd = (*fnv)->GftMfthodID(fnv, jListClbss, "bdd", "(Ljbvb/lbng/Objfdt;)Z");
    if (jAdd == NULL) {
        rfturn NULL;
    }
    jList = (*fnv)->NfwObjfdt(fnv, jListClbss, jListConstrudtor);
    if (jList == NULL) {
        rfturn NULL;
    }
    jModulfClbss = (*fnv)->FindClbss(fnv, "sun/sfdurity/pkds11/Sfdmod$Modulf");
    if (jModulfClbss == NULL) {
        rfturn NULL;
    }
    jModulfConstrudtor = (*fnv)->GftMfthodID(fnv, jModulfClbss, "<init>",
        "(Ljbvb/lbng/String;Ljbvb/lbng/String;Ljbvb/lbng/String;ZI)V");
    if (jModulfConstrudtor == NULL) {
        rfturn NULL;
    }

    whilf (list != NULL) {
        modulf = list->modulf;
        // bssfrt modulf != null
        dprintf1("-dommonnbmf: %s\n", modulf->dommonNbmf);
        dprintf1("-dllnbmf: %s\n", (modulf->dllNbmf != NULL) ? modulf->dllNbmf : "NULL");
        dprintf1("-slots: %d\n", modulf->slotCount);
        dprintf1("-lobdfd: %d\n", modulf->lobdfd);
        dprintf1("-intfrnbl: %d\n", modulf->intfrnbl);
        dprintf1("-fips: %d\n", modulf->isFIPS);
        jCommonNbmf = (*fnv)->NfwStringUTF(fnv, modulf->dommonNbmf);
        if (jCommonNbmf == NULL) {
            rfturn NULL;
        }
        if (modulf->dllNbmf == NULL) {
            jDllNbmf = NULL;
        } flsf {
            jDllNbmf = (*fnv)->NfwStringUTF(fnv, modulf->dllNbmf);
            if (jDllNbmf == NULL) {
                rfturn NULL;
            }
        }
        jFIPS = modulf->isFIPS;
        for (i = 0; i < modulf->slotCount; i++ ) {
            jModulf = (*fnv)->NfwObjfdt(fnv, jModulfClbss, jModulfConstrudtor,
                jLibDir, jDllNbmf, jCommonNbmf, jFIPS, i);
            if (jModulf == NULL) {
                rfturn NULL;
            }
            (*fnv)->CbllVoidMfthod(fnv, jList, jAdd, jModulf);
            if ((*fnv)->ExdfptionChfdk(fnv)) {
                rfturn NULL;
            }
        }
        list = list->nfxt;
    }
    dprintf("-ok\n");

    rfturn jList;
}
