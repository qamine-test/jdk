/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.pkds11;

import jbvb.mbth.BigIntfgfr;

import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.UnsupportfdEndodingExdfption;

import jbvb.util.Arrbys;
import jbvb.util.Collfdtions;
import jbvb.util.Dbtf;
import jbvb.util.Enumfrbtion;
import jbvb.util.ArrbyList;
import jbvb.util.HbshSft;
import jbvb.util.HbshMbp;
import jbvb.util.Sft;

import jbvb.sfdurity.*;
import jbvb.sfdurity.KfyStorf.*;

import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;

import jbvb.sfdurity.intfrfbdfs.*;
import jbvb.sfdurity.spfd.*;

import jbvbx.drypto.SfdrftKfy;
import jbvbx.drypto.intfrfbdfs.*;

import jbvbx.sfdurity.buth.x500.X500Prindipbl;
import jbvbx.sfdurity.buth.login.LoginExdfption;
import jbvbx.sfdurity.buth.dbllbbdk.Cbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.PbsswordCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.CbllbbdkHbndlfr;
import jbvbx.sfdurity.buth.dbllbbdk.UnsupportfdCbllbbdkExdfption;

import sun.sfdurity.util.Dfbug;
import sun.sfdurity.util.DfrVbluf;
import sun.sfdurity.util.ECUtil;

import sun.sfdurity.pkds11.Sfdmod.*;
import stbtid sun.sfdurity.pkds11.P11Util.*;

import sun.sfdurity.pkds11.wrbppfr.*;
import stbtid sun.sfdurity.pkds11.wrbppfr.PKCS11Constbnts.*;

import sun.sfdurity.rsb.RSAKfyFbdtory;

finbl dlbss P11KfyStorf fxtfnds KfyStorfSpi {

    privbtf stbtid finbl CK_ATTRIBUTE ATTR_CLASS_CERT =
                        nfw CK_ATTRIBUTE(CKA_CLASS, CKO_CERTIFICATE);
    privbtf stbtid finbl CK_ATTRIBUTE ATTR_CLASS_PKEY =
                        nfw CK_ATTRIBUTE(CKA_CLASS, CKO_PRIVATE_KEY);
    privbtf stbtid finbl CK_ATTRIBUTE ATTR_CLASS_SKEY =
                        nfw CK_ATTRIBUTE(CKA_CLASS, CKO_SECRET_KEY);

    privbtf stbtid finbl CK_ATTRIBUTE ATTR_X509_CERT_TYPE =
                        nfw CK_ATTRIBUTE(CKA_CERTIFICATE_TYPE, CKC_X_509);

    privbtf stbtid finbl CK_ATTRIBUTE ATTR_TOKEN_TRUE =
                        nfw CK_ATTRIBUTE(CKA_TOKEN, truf);

    // XXX for tfsting purposfs only
    //  - NSS dofsn't support pfrsistfnt sfdrft kfys
    //    (kfy typf gfts mbnglfd if sfdrft kfy is b tokfn kfy)
    //  - if dfbug is turnfd on, thfn this is sft to fblsf
    privbtf stbtid CK_ATTRIBUTE ATTR_SKEY_TOKEN_TRUE = ATTR_TOKEN_TRUE;

    privbtf stbtid finbl CK_ATTRIBUTE ATTR_TRUSTED_TRUE =
                        nfw CK_ATTRIBUTE(CKA_TRUSTED, truf);
    privbtf stbtid finbl CK_ATTRIBUTE ATTR_PRIVATE_TRUE =
                        nfw CK_ATTRIBUTE(CKA_PRIVATE, truf);

    privbtf stbtid finbl long NO_HANDLE = -1;
    privbtf stbtid finbl long FINDOBJECTS_MAX = 100;
    privbtf stbtid finbl String ALIAS_SEP = "/";

    privbtf stbtid finbl boolfbn NSS_TEST = fblsf;
    privbtf stbtid finbl Dfbug dfbug =
                        Dfbug.gftInstbndf("pkds11kfystorf");
    privbtf stbtid boolfbn CKA_TRUSTED_SUPPORTED = truf;

    privbtf finbl Tokfn tokfn;

    // If multiplf dfrts brf found to shbrf thf sbmf CKA_LABEL
    // bt lobd timf (NSS-stylf kfystorf), thfn thf kfystorf is rfbd
    // bnd thf uniquf kfystorf blibsfs brf mbppfd to thf fntrifs.
    // Howfvfr, writf dbpbbilitifs brf disbblfd.
    privbtf boolfbn writfDisbblfd = fblsf;

    // Mbp of uniquf kfystorf blibsfs to fntrifs in thf tokfn
    privbtf HbshMbp<String, AlibsInfo> blibsMbp;

    // whfthfr to usf NSS Sfdmod info for trust bttributfs
    privbtf finbl boolfbn usfSfdmodTrust;

    // if usfSfdmodTrust == truf, whidh typf of trust wf brf intfrfstfd in
    privbtf Sfdmod.TrustTypf nssTrustTypf;

    /**
     * Thf undfrlying tokfn mby dontbin multiplf dfrts bflonging to thf
     * sbmf "pfrsonblity" (for fxbmplf, b signing dfrt bnd fndryption dfrt),
     * bll shbring thf sbmf CKA_LABEL.  Thfsf must bf rfsolvfd
     * into uniquf kfystorf blibsfs.
     *
     * In bddition, privbtf kfys bnd dfrts mby not hbvf b CKA_LABEL.
     * It is bssumfd thbt b privbtf kfy bnd dorrfsponding dfrtifidbtf
     * shbrf thf sbmf CKA_ID, bnd thbt thf CKA_ID is uniquf bdross thf tokfn.
     * Thf CKA_ID mby not bf humbn-rfbdbblf.
     * Thfsf pbirs must bf rfsolvfd into uniquf kfystorf blibsfs.
     *
     * Furthfrmorf, sfdrft kfys brf bssumfd to hbvf b CKA_LABEL
     * uniquf bdross thf fntirf tokfn.
     *
     * Whfn thf KfyStorf is lobdfd, instbndfs of this dlbss brf
     * drfbtfd to rfprfsfnt thf privbtf kfys/sfdrft kfys/dfrts
     * thbt rfsidf on thf tokfn.
     */
    privbtf stbtid dlbss AlibsInfo {

        // CKA_CLASS - fntry typf
        privbtf CK_ATTRIBUTE typf = null;

        // CKA_LABEL of dfrt bnd sfdrft kfy
        privbtf String lbbfl = null;

        // CKA_ID of thf privbtf kfy/dfrt pbir
        privbtf bytf[] id = null;

        // CKA_TRUSTED - truf if dfrt is trustfd
        privbtf boolfbn trustfd = fblsf;

        // fithfr fnd-fntity dfrt or trustfd dfrt dfpfnding on 'typf'
        privbtf X509Cfrtifidbtf dfrt = null;

        // dhbin
        privbtf X509Cfrtifidbtf dhbin[] = null;

        // truf if CKA_ID for privbtf kfy bnd dfrt mbtdh up
        privbtf boolfbn mbtdhfd = fblsf;

        // SfdrftKfyEntry
        publid AlibsInfo(String lbbfl) {
            this.typf = ATTR_CLASS_SKEY;
            this.lbbfl = lbbfl;
        }

        // PrivbtfKfyEntry
        publid AlibsInfo(String lbbfl,
                        bytf[] id,
                        boolfbn trustfd,
                        X509Cfrtifidbtf dfrt) {
            this.typf = ATTR_CLASS_PKEY;
            this.lbbfl = lbbfl;
            this.id = id;
            this.trustfd = trustfd;
            this.dfrt = dfrt;
        }

        publid String toString() {
            StringBuildfr sb = nfw StringBuildfr();
            if (typf == ATTR_CLASS_PKEY) {
                sb.bppfnd("\ttypf=[privbtf kfy]\n");
            } flsf if (typf == ATTR_CLASS_SKEY) {
                sb.bppfnd("\ttypf=[sfdrft kfy]\n");
            } flsf if (typf == ATTR_CLASS_CERT) {
                sb.bppfnd("\ttypf=[trustfd dfrt]\n");
            }
            sb.bppfnd("\tlbbfl=[" + lbbfl + "]\n");
            if (id == null) {
                sb.bppfnd("\tid=[null]\n");
            } flsf {
                sb.bppfnd("\tid=" + P11KfyStorf.gftID(id) + "\n");
            }
            sb.bppfnd("\ttrustfd=[" + trustfd + "]\n");
            sb.bppfnd("\tmbtdhfd=[" + mbtdhfd + "]\n");
            if (dfrt == null) {
                sb.bppfnd("\tdfrt=[null]\n");
            } flsf {
                sb.bppfnd("\tdfrt=[\tsubjfdt: " +
                        dfrt.gftSubjfdtX500Prindipbl() +
                        "\n\t\tissufr: " +
                        dfrt.gftIssufrX500Prindipbl() +
                        "\n\t\tsfriblNum: " +
                        dfrt.gftSfriblNumbfr().toString() +
                        "]");
            }
            rfturn sb.toString();
        }
    }

    /**
     * dbllbbdk hbndlfr for pbssing pbssword to Providfr.login mfthod
     */
    privbtf stbtid dlbss PbsswordCbllbbdkHbndlfr implfmfnts CbllbbdkHbndlfr {

        privbtf dhbr[] pbssword;

        privbtf PbsswordCbllbbdkHbndlfr(dhbr[] pbssword) {
            if (pbssword != null) {
                this.pbssword = pbssword.dlonf();
            }
        }

        publid void hbndlf(Cbllbbdk[] dbllbbdks)
                throws IOExdfption, UnsupportfdCbllbbdkExdfption {
            if (!(dbllbbdks[0] instbndfof PbsswordCbllbbdk)) {
                throw nfw UnsupportfdCbllbbdkExdfption(dbllbbdks[0]);
            }
            PbsswordCbllbbdk pd = (PbsswordCbllbbdk)dbllbbdks[0];
            pd.sftPbssword(pbssword);  // this dlonfs thf pbssword if not null
        }

        protfdtfd void finblizf() throws Throwbblf {
            if (pbssword != null) {
                Arrbys.fill(pbssword, ' ');
            }
            supfr.finblizf();
        }
    }

    /**
     * gftTokfnObjfdt rfturn vbluf.
     *
     * if objfdt is not found, typf is sft to null.
     * othfrwisf, typf is sft to thf rfqufstfd typf.
     */
    privbtf stbtid dlbss THbndlf {
        privbtf finbl long hbndlf;              // tokfn objfdt hbndlf
        privbtf finbl CK_ATTRIBUTE typf;        // CKA_CLASS

        privbtf THbndlf(long hbndlf, CK_ATTRIBUTE typf) {
            this.hbndlf = hbndlf;
            this.typf = typf;
        }
    }

    P11KfyStorf(Tokfn tokfn) {
        this.tokfn = tokfn;
        this.usfSfdmodTrust = tokfn.providfr.nssUsfSfdmodTrust;
    }

    /**
     * Rfturns thf kfy bssodibtfd with thf givfn blibs.
     * Thf kfy must hbvf bffn bssodibtfd with
     * thf blibs by b dbll to <dodf>sftKfyEntry</dodf>,
     * or by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>PrivbtfKfyEntry</dodf> or <dodf>SfdrftKfyEntry</dodf>.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm pbssword thf pbssword, whidh must bf <dodf>null</dodf>
     *
     * @rfturn thf rfqufstfd kfy, or null if thf givfn blibs dofs not fxist
     * or dofs not idfntify b kfy-rflbtfd fntry.
     *
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm for rfdovfring thf
     * kfy dbnnot bf found
     * @fxdfption UnrfdovfrbblfKfyExdfption if thf kfy dbnnot bf rfdovfrfd
     */
    publid syndhronizfd Kfy fnginfGftKfy(String blibs, dhbr[] pbssword)
                throws NoSudhAlgorithmExdfption, UnrfdovfrbblfKfyExdfption {

        tokfn.fnsurfVblid();
        if (pbssword != null && !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw NoSudhAlgorithmExdfption("pbssword must bf null");
        }

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null || blibsInfo.typf == ATTR_CLASS_CERT) {
            rfturn null;
        }

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            if (blibsInfo.typf == ATTR_CLASS_PKEY) {
                THbndlf h = gftTokfnObjfdt(sfssion,
                                        blibsInfo.typf,
                                        blibsInfo.id,
                                        null);
                if (h.typf == ATTR_CLASS_PKEY) {
                    rfturn lobdPkfy(sfssion, h.hbndlf);
                }
            } flsf {
                THbndlf h = gftTokfnObjfdt(sfssion,
                                        ATTR_CLASS_SKEY,
                                        null,
                                        blibs);
                if (h.typf == ATTR_CLASS_SKEY) {
                    rfturn lobdSkfy(sfssion, h.hbndlf);
                }
            }

            // did not find bnything
            rfturn null;
        } dbtdh (PKCS11Exdfption | KfyStorfExdfption f) {
            throw nfw ProvidfrExdfption(f);
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * Rfturns thf dfrtifidbtf dhbin bssodibtfd with thf givfn blibs.
     * Thf dfrtifidbtf dhbin must hbvf bffn bssodibtfd with thf blibs
     * by b dbll to <dodf>sftKfyEntry</dodf>,
     * or by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>PrivbtfKfyEntry</dodf>.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf dhbin (ordfrfd with thf usfr's dfrtifidbtf first
     * bnd thf root dfrtifidbtf buthority lbst), or null if thf givfn blibs
     * dofs not fxist or dofs not dontbin b dfrtifidbtf dhbin
     */
    publid syndhronizfd Cfrtifidbtf[] fnginfGftCfrtifidbtfChbin(String blibs) {

        tokfn.fnsurfVblid();

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null || blibsInfo.typf != ATTR_CLASS_PKEY) {
            rfturn null;
        }
        rfturn blibsInfo.dhbin;
    }

    /**
     * Rfturns thf dfrtifidbtf bssodibtfd with thf givfn blibs.
     *
     * <p> If thf givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to <dodf>sftCfrtifidbtfEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>TrustfdCfrtifidbtfEntry</dodf>,
     * thfn thf trustfd dfrtifidbtf dontbinfd in thbt fntry is rfturnfd.
     *
     * <p> If thf givfn blibs nbmf idfntififs bn fntry
     * drfbtfd by b dbll to <dodf>sftKfyEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>PrivbtfKfyEntry</dodf>,
     * thfn thf first flfmfnt of thf dfrtifidbtf dhbin in thbt fntry
     * (if b dhbin fxists) is rfturnfd.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf dfrtifidbtf, or null if thf givfn blibs dofs not fxist or
     * dofs not dontbin b dfrtifidbtf.
     */
    publid syndhronizfd Cfrtifidbtf fnginfGftCfrtifidbtf(String blibs) {
        tokfn.fnsurfVblid();

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null) {
            rfturn null;
        }
        rfturn blibsInfo.dfrt;
    }

    /**
     * Rfturns thf drfbtion dbtf of thf fntry idfntififd by thf givfn blibs.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn thf drfbtion dbtf of this fntry, or null if thf givfn blibs dofs
     * not fxist
     */
    publid Dbtf fnginfGftCrfbtionDbtf(String blibs) {
        tokfn.fnsurfVblid();
        throw nfw ProvidfrExdfption(nfw UnsupportfdOpfrbtionExdfption());
    }

    /**
     * Assigns thf givfn kfy to thf givfn blibs, protfdting it with thf givfn
     * pbssword.
     *
     * <p>If thf givfn kfy is of typf <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dhbin dfrtifying thf
     * dorrfsponding publid kfy.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy to bf bssodibtfd with thf blibs
     * @pbrbm pbssword thf pbssword to protfdt thf kfy
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     * kfy (only rfquirfd if thf givfn kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if thf givfn kfy dbnnot bf protfdtfd, or
     * this opfrbtion fbils for somf othfr rfbson
     */
    publid syndhronizfd void fnginfSftKfyEntry(String blibs, Kfy kfy,
                                   dhbr[] pbssword,
                                   Cfrtifidbtf[] dhbin)
                throws KfyStorfExdfption {

        tokfn.fnsurfVblid();
        dhfdkWritf();

        if (!(kfy instbndfof PrivbtfKfy) && !(kfy instbndfof SfdrftKfy)) {
            throw nfw KfyStorfExdfption("kfy must bf PrivbtfKfy or SfdrftKfy");
        } flsf if (kfy instbndfof PrivbtfKfy && dhbin == null) {
            throw nfw KfyStorfExdfption
                ("PrivbtfKfy must bf bddompbnifd by non-null dhbin");
        } flsf if (kfy instbndfof SfdrftKfy && dhbin != null) {
            throw nfw KfyStorfExdfption
                ("SfdrftKfy must bf bddompbnifd by null dhbin");
        } flsf if (pbssword != null &&
                    !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw KfyStorfExdfption("Pbssword must bf null");
        }

        KfyStorf.Entry fntry = null;
        try {
            if (kfy instbndfof PrivbtfKfy) {
                fntry = nfw KfyStorf.PrivbtfKfyEntry((PrivbtfKfy)kfy, dhbin);
            } flsf if (kfy instbndfof SfdrftKfy) {
                fntry = nfw KfyStorf.SfdrftKfyEntry((SfdrftKfy)kfy);
            }
        } dbtdh (NullPointfrExdfption | IllfgblArgumfntExdfption f) {
            throw nfw KfyStorfExdfption(f);
        }
        fnginfSftEntry(blibs, fntry, nfw KfyStorf.PbsswordProtfdtion(pbssword));
    }

    /**
     * Assigns thf givfn kfy (thbt hbs blrfbdy bffn protfdtfd) to thf givfn
     * blibs.
     *
     * <p>If thf protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>,
     * it must bf bddompbnifd by b dfrtifidbtf dhbin dfrtifying thf
     * dorrfsponding publid kfy.
     *
     * <p>If thf givfn blibs blrfbdy fxists, thf kfystorf informbtion
     * bssodibtfd with it is ovfrriddfn by thf givfn kfy (bnd possibly
     * dfrtifidbtf dhbin).
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm kfy thf kfy (in protfdtfd formbt) to bf bssodibtfd with thf blibs
     * @pbrbm dhbin thf dfrtifidbtf dhbin for thf dorrfsponding publid
     * kfy (only usfful if thf protfdtfd kfy is of typf
     * <dodf>jbvb.sfdurity.PrivbtfKfy</dodf>).
     *
     * @fxdfption KfyStorfExdfption if this opfrbtion fbils.
     */
    publid void fnginfSftKfyEntry(String blibs, bytf[] kfy, Cfrtifidbtf[] dhbin)
                throws KfyStorfExdfption {
        tokfn.fnsurfVblid();
        throw nfw ProvidfrExdfption(nfw UnsupportfdOpfrbtionExdfption());
    }

    /**
     * Assigns thf givfn dfrtifidbtf to thf givfn blibs.
     *
     * <p> If thf givfn blibs idfntififs bn fxisting fntry
     * drfbtfd by b dbll to <dodf>sftCfrtifidbtfEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>TrustfdCfrtifidbtfEntry</dodf>,
     * thf trustfd dfrtifidbtf in thf fxisting fntry
     * is ovfrriddfn by thf givfn dfrtifidbtf.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm dfrt thf dfrtifidbtf
     *
     * @fxdfption KfyStorfExdfption if thf givfn blibs blrfbdy fxists bnd dofs
     * not idfntify bn fntry dontbining b trustfd dfrtifidbtf,
     * or this opfrbtion fbils for somf othfr rfbson.
     */
    publid syndhronizfd void fnginfSftCfrtifidbtfEntry
        (String blibs, Cfrtifidbtf dfrt) throws KfyStorfExdfption {

        tokfn.fnsurfVblid();
        dhfdkWritf();

        if (dfrt == null) {
            throw nfw KfyStorfExdfption("invblid null dfrtifidbtf");
        }

        KfyStorf.Entry fntry = null;
        fntry = nfw KfyStorf.TrustfdCfrtifidbtfEntry(dfrt);
        fnginfSftEntry(blibs, fntry, null);
    }

    /**
     * Dflftfs thf fntry idfntififd by thf givfn blibs from this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @fxdfption KfyStorfExdfption if thf fntry dbnnot bf rfmovfd.
     */
    publid syndhronizfd void fnginfDflftfEntry(String blibs)
                throws KfyStorfExdfption {
        tokfn.fnsurfVblid();

        if (tokfn.isWritfProtfdtfd()) {
            throw nfw KfyStorfExdfption("tokfn writf-protfdtfd");
        }
        dhfdkWritf();
        dflftfEntry(blibs);
    }

    /**
     * XXX - not surf whfthfr to kffp this
     */
    privbtf boolfbn dflftfEntry(String blibs) throws KfyStorfExdfption {
        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo != null) {

            blibsMbp.rfmovf(blibs);

            try {
                if (blibsInfo.typf == ATTR_CLASS_CERT) {
                    // trustfd dfrtifidbtf fntry
                    rfturn dfstroyCfrt(blibsInfo.id);
                } flsf if (blibsInfo.typf == ATTR_CLASS_PKEY) {
                    // privbtf kfy fntry
                    rfturn dfstroyPkfy(blibsInfo.id) &&
                                dfstroyChbin(blibsInfo.id);
                } flsf if (blibsInfo.typf == ATTR_CLASS_SKEY) {
                    // sfdrft kfy fntry
                    rfturn dfstroySkfy(blibs);
                } flsf {
                    throw nfw KfyStorfExdfption("unfxpfdtfd fntry typf");
                }
            } dbtdh (PKCS11Exdfption | CfrtifidbtfExdfption f) {
                throw nfw KfyStorfExdfption(f);
            }
        }
        rfturn fblsf;
    }

    /**
     * Lists bll thf blibs nbmfs of this kfystorf.
     *
     * @rfturn fnumfrbtion of thf blibs nbmfs
     */
    publid syndhronizfd Enumfrbtion<String> fnginfAlibsfs() {
        tokfn.fnsurfVblid();

        // don't wbnt rfturnfd fnumfrbtion to itfrbtf off bdtubl kfySft -
        // othfrwisf bpplidbtions thbt itfrbtf bnd modify thf kfystorf
        // mby run into dondurrfnt modifidbtion problfms
        rfturn Collfdtions.fnumfrbtion(nfw HbshSft<String>(blibsMbp.kfySft()));
    }

    /**
     * Chfdks if thf givfn blibs fxists in this kfystorf.
     *
     * @pbrbm blibs thf blibs nbmf
     *
     * @rfturn truf if thf blibs fxists, fblsf othfrwisf
     */
    publid syndhronizfd boolfbn fnginfContbinsAlibs(String blibs) {
        tokfn.fnsurfVblid();
        rfturn blibsMbp.dontbinsKfy(blibs);
    }

    /**
     * Rftrifvfs thf numbfr of fntrifs in this kfystorf.
     *
     * @rfturn thf numbfr of fntrifs in this kfystorf
     */
    publid syndhronizfd int fnginfSizf() {
        tokfn.fnsurfVblid();
        rfturn blibsMbp.sizf();
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs
     * wbs drfbtfd by b dbll to <dodf>sftKfyEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>PrivbtfKfyEntry</dodf> or b <dodf>SfdrftKfyEntry</dodf>.
     *
     * @pbrbm blibs thf blibs for thf kfystorf fntry to bf dhfdkfd
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs is b
     * kfy-rflbtfd, fblsf othfrwisf.
     */
    publid syndhronizfd boolfbn fnginfIsKfyEntry(String blibs) {
        tokfn.fnsurfVblid();

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null || blibsInfo.typf == ATTR_CLASS_CERT) {
            rfturn fblsf;
        }
        rfturn truf;
    }

    /**
     * Rfturns truf if thf fntry idfntififd by thf givfn blibs
     * wbs drfbtfd by b dbll to <dodf>sftCfrtifidbtfEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>TrustfdCfrtifidbtfEntry</dodf>.
     *
     * @pbrbm blibs thf blibs for thf kfystorf fntry to bf dhfdkfd
     *
     * @rfturn truf if thf fntry idfntififd by thf givfn blibs dontbins b
     * trustfd dfrtifidbtf, fblsf othfrwisf.
     */
    publid syndhronizfd boolfbn fnginfIsCfrtifidbtfEntry(String blibs) {
        tokfn.fnsurfVblid();

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null || blibsInfo.typf != ATTR_CLASS_CERT) {
            rfturn fblsf;
        }
        rfturn truf;
    }

    /**
     * Rfturns thf (blibs) nbmf of thf first kfystorf fntry whosf dfrtifidbtf
     * mbtdhfs thf givfn dfrtifidbtf.
     *
     * <p>This mfthod bttfmpts to mbtdh thf givfn dfrtifidbtf with fbdh
     * kfystorf fntry. If thf fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to <dodf>sftCfrtifidbtfEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>TrustfdCfrtifidbtfEntry</dodf>,
     * thfn thf givfn dfrtifidbtf is dompbrfd to thbt fntry's dfrtifidbtf.
     *
     * <p> If thf fntry bfing donsidfrfd wbs
     * drfbtfd by b dbll to <dodf>sftKfyEntry</dodf>,
     * or drfbtfd by b dbll to <dodf>sftEntry</dodf> with b
     * <dodf>PrivbtfKfyEntry</dodf>,
     * thfn thf givfn dfrtifidbtf is dompbrfd to thf first
     * flfmfnt of thbt fntry's dfrtifidbtf dhbin.
     *
     * @pbrbm dfrt thf dfrtifidbtf to mbtdh with.
     *
     * @rfturn thf blibs nbmf of thf first fntry with mbtdhing dfrtifidbtf,
     * or null if no sudh fntry fxists in this kfystorf.
     */
    publid syndhronizfd String fnginfGftCfrtifidbtfAlibs(Cfrtifidbtf dfrt) {
        tokfn.fnsurfVblid();
        Enumfrbtion<String> f = fnginfAlibsfs();
        whilf (f.hbsMorfElfmfnts()) {
            String blibs = f.nfxtElfmfnt();
            Cfrtifidbtf tokfnCfrt = fnginfGftCfrtifidbtf(blibs);
            if (tokfnCfrt != null && tokfnCfrt.fqubls(dfrt)) {
                rfturn blibs;
            }
        }
        rfturn null;
    }

    /**
     * fnginfStorf durrfntly is b No-op.
     * Entrifs brf storfd to thf tokfn during fnginfSftEntry
     *
     * @pbrbm strfbm this must bf <dodf>null</dodf>
     * @pbrbm pbssword this must bf <dodf>null</dodf>
     */
    publid syndhronizfd void fnginfStorf(OutputStrfbm strfbm, dhbr[] pbssword)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption {
        tokfn.fnsurfVblid();
        if (strfbm != null && !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw IOExdfption("output strfbm must bf null");
        }

        if (pbssword != null && !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw IOExdfption("pbssword must bf null");
        }
    }

    /**
     * fnginfStorf durrfntly is b No-op.
     * Entrifs brf storfd to thf tokfn during fnginfSftEntry
     *
     * @pbrbm pbrbm this must bf <dodf>null</dodf>
     *
     * @fxdfption IllfgblArgumfntExdfption if thf givfn
     *          <dodf>KfyStorf.LobdStorfPbrbmftfr</dodf>
     *          input is not <dodf>null</dodf>
     */
    publid syndhronizfd void fnginfStorf(KfyStorf.LobdStorfPbrbmftfr pbrbm)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption {
        tokfn.fnsurfVblid();
        if (pbrbm != null) {
            throw nfw IllfgblArgumfntExdfption
                ("LobdStorfPbrbmftfr must bf null");
        }
    }

    /**
     * Lobds thf kfystorf.
     *
     * @pbrbm strfbm thf input strfbm, whidh must bf <dodf>null</dodf>
     * @pbrbm pbssword thf pbssword usfd to unlodk thf kfystorf,
     *          or <dodf>null</dodf> if thf tokfn supports b
     *          CKF_PROTECTED_AUTHENTICATION_PATH
     *
     * @fxdfption IOExdfption if thf givfn <dodf>strfbm</dodf> is not
     *          <dodf>null</dodf>, if thf tokfn supports b
     *          CKF_PROTECTED_AUTHENTICATION_PATH bnd b non-null
     *          pbssword is givfn, of if thf tokfn login opfrbtion fbilfd
     */
    publid syndhronizfd void fnginfLobd(InputStrfbm strfbm, dhbr[] pbssword)
        throws IOExdfption, NoSudhAlgorithmExdfption, CfrtifidbtfExdfption {

        tokfn.fnsurfVblid();

        if (NSS_TEST) {
            ATTR_SKEY_TOKEN_TRUE = nfw CK_ATTRIBUTE(CKA_TOKEN, fblsf);
        }

        if (strfbm != null && !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw IOExdfption("input strfbm must bf null");
        }

        if (usfSfdmodTrust) {
            nssTrustTypf = Sfdmod.TrustTypf.ALL;
        }

        try {
            if (pbssword == null) {
                login(null);
            } flsf {
                login(nfw PbsswordCbllbbdkHbndlfr(pbssword));
            }
            if (mbpLbbfls() == truf) {
                // CKA_LABELs brf shbrfd by multiplf dfrts
                writfDisbblfd = truf;
            }
            if (dfbug != null) {
                dumpTokfnMbp();
            }
        } dbtdh (LoginExdfption | KfyStorfExdfption | PKCS11Exdfption f) {
            throw nfw IOExdfption("lobd fbilfd", f);
        }
    }

    /**
     * Lobds thf kfystorf using thf givfn
     * <dodf>KfyStorf.LobdStorfPbrbmftfr</dodf>.
     *
     * <p> Thf <dodf>LobdStorfPbrbmftfr.gftProtfdtionPbrbmftfr()</dodf>
     * mfthod is fxpfdtfd to rfturn b <dodf>KfyStorf.PbsswordProtfdtion</dodf>
     * objfdt.  Thf pbssword is rftrifvfd from thbt objfdt bnd usfd
     * to unlodk thf PKCS#11 tokfn.
     *
     * <p> If thf tokfn supports b CKF_PROTECTED_AUTHENTICATION_PATH
     * thfn thf providfd pbssword must bf <dodf>null</dodf>.
     *
     * @pbrbm pbrbm thf <dodf>KfyStorf.LobdStorfPbrbmftfr</dodf>
     *
     * @fxdfption IllfgblArgumfntExdfption if thf givfn
     *          <dodf>KfyStorf.LobdStorfPbrbmftfr</dodf> is <dodf>null</dodf>,
     *          or if thbt pbrbmftfr rfturns b <dodf>null</dodf>
     *          <dodf>ProtfdtionPbrbmftfr</dodf> objfdt.
     *          input is not rfdognizfd
     * @fxdfption IOExdfption if thf tokfn supports b
     *          CKF_PROTECTED_AUTHENTICATION_PATH bnd thf providfd pbssword
     *          is non-null, or if thf tokfn login opfrbtion fbils
     */
    publid syndhronizfd void fnginfLobd(KfyStorf.LobdStorfPbrbmftfr pbrbm)
                throws IOExdfption, NoSudhAlgorithmExdfption,
                CfrtifidbtfExdfption {

        tokfn.fnsurfVblid();

        if (NSS_TEST) {
            ATTR_SKEY_TOKEN_TRUE = nfw CK_ATTRIBUTE(CKA_TOKEN, fblsf);
        }

        // if dbllfr wbnts to pbss b NULL pbssword,
        // fordf it to pbss b non-NULL PbsswordProtfdtion thbt rfturns
        // b NULL pbssword

        if (pbrbm == null) {
            throw nfw IllfgblArgumfntExdfption
                        ("invblid null LobdStorfPbrbmftfr");
        }
        if (usfSfdmodTrust) {
            if (pbrbm instbndfof Sfdmod.KfyStorfLobdPbrbmftfr) {
                nssTrustTypf = ((Sfdmod.KfyStorfLobdPbrbmftfr)pbrbm).gftTrustTypf();
            } flsf {
                nssTrustTypf = Sfdmod.TrustTypf.ALL;
            }
        }

        CbllbbdkHbndlfr hbndlfr;
        KfyStorf.ProtfdtionPbrbmftfr pp = pbrbm.gftProtfdtionPbrbmftfr();
        if (pp instbndfof PbsswordProtfdtion) {
            dhbr[] pbssword = ((PbsswordProtfdtion)pp).gftPbssword();
            if (pbssword == null) {
                hbndlfr = null;
            } flsf {
                hbndlfr = nfw PbsswordCbllbbdkHbndlfr(pbssword);
            }
        } flsf if (pp instbndfof CbllbbdkHbndlfrProtfdtion) {
            hbndlfr = ((CbllbbdkHbndlfrProtfdtion)pp).gftCbllbbdkHbndlfr();
        } flsf {
            throw nfw IllfgblArgumfntExdfption
                        ("ProtfdtionPbrbmftfr must bf fithfr " +
                        "PbsswordProtfdtion or CbllbbdkHbndlfrProtfdtion");
        }

        try {
            login(hbndlfr);
            if (mbpLbbfls() == truf) {
                // CKA_LABELs brf shbrfd by multiplf dfrts
                writfDisbblfd = truf;
            }
            if (dfbug != null) {
                dumpTokfnMbp();
            }
        } dbtdh (LoginExdfption | KfyStorfExdfption | PKCS11Exdfption f) {
            throw nfw IOExdfption("lobd fbilfd", f);
        }
    }

    privbtf void login(CbllbbdkHbndlfr hbndlfr) throws LoginExdfption {
        if ((tokfn.tokfnInfo.flbgs & CKF_PROTECTED_AUTHENTICATION_PATH) == 0) {
            tokfn.providfr.login(null, hbndlfr);
        } flsf {
            // tokfn supports protfdtfd buthfntidbtion pbth
            // (fxtfrnbl pin-pbd, for fxbmplf)
            if (hbndlfr != null &&
                !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
                throw nfw LoginExdfption("dbn not spfdify pbssword if tokfn " +
                                "supports protfdtfd buthfntidbtion pbth");
            }

            // must rfly on bpplidbtion-sft or dffbult hbndlfr
            // if onf is nfdfssbry
            tokfn.providfr.login(null, null);
        }
    }

    /**
     * Gft b <dodf>KfyStorf.Entry</dodf> for thf spfdififd blibs
     *
     * @pbrbm blibs gft thf <dodf>KfyStorf.Entry</dodf> for this blibs
     * @pbrbm protPbrbm this must bf <dodf>null</dodf>
     *
     * @rfturn thf <dodf>KfyStorf.Entry</dodf> for thf spfdififd blibs,
     *          or <dodf>null</dodf> if thfrf is no sudh fntry
     *
     * @fxdfption KfyStorfExdfption if thf opfrbtion fbilfd
     * @fxdfption NoSudhAlgorithmExdfption if thf blgorithm for rfdovfring thf
     *          fntry dbnnot bf found
     * @fxdfption UnrfdovfrbblfEntryExdfption if thf spfdififd
     *          <dodf>protPbrbm</dodf> wfrf insuffidifnt or invblid
     *
     * @sindf 1.5
     */
    publid syndhronizfd KfyStorf.Entry fnginfGftEntry(String blibs,
                        KfyStorf.ProtfdtionPbrbmftfr protPbrbm)
                throws KfyStorfExdfption, NoSudhAlgorithmExdfption,
                UnrfdovfrbblfEntryExdfption {

        tokfn.fnsurfVblid();

        if (protPbrbm != null &&
            protPbrbm instbndfof KfyStorf.PbsswordProtfdtion &&
            ((KfyStorf.PbsswordProtfdtion)protPbrbm).gftPbssword() != null &&
            !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw KfyStorfExdfption("ProtfdtionPbrbmftfr must bf null");
        }

        AlibsInfo blibsInfo = blibsMbp.gft(blibs);
        if (blibsInfo == null) {
            if (dfbug != null) {
                dfbug.println("fnginfGftEntry did not find blibs [" +
                        blibs +
                        "] in mbp");
            }
            rfturn null;
        }

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            if (blibsInfo.typf == ATTR_CLASS_CERT) {
                // trustfd dfrtifidbtf fntry
                if (dfbug != null) {
                    dfbug.println("fnginfGftEntry found trustfd dfrt fntry");
                }
                rfturn nfw KfyStorf.TrustfdCfrtifidbtfEntry(blibsInfo.dfrt);
            } flsf if (blibsInfo.typf == ATTR_CLASS_SKEY) {
                // sfdrft kfy fntry
                if (dfbug != null) {
                    dfbug.println("fnginfGftEntry found sfdrft kfy fntry");
                }

                THbndlf h = gftTokfnObjfdt
                        (sfssion, ATTR_CLASS_SKEY, null, blibsInfo.lbbfl);
                if (h.typf != ATTR_CLASS_SKEY) {
                    throw nfw KfyStorfExdfption
                        ("fxpfdtfd but dould not find sfdrft kfy");
                } flsf {
                    SfdrftKfy skfy = lobdSkfy(sfssion, h.hbndlf);
                    rfturn nfw KfyStorf.SfdrftKfyEntry(skfy);
                }
            } flsf {
                // privbtf kfy fntry
                if (dfbug != null) {
                    dfbug.println("fnginfGftEntry found privbtf kfy fntry");
                }

                THbndlf h = gftTokfnObjfdt
                        (sfssion, ATTR_CLASS_PKEY, blibsInfo.id, null);
                if (h.typf != ATTR_CLASS_PKEY) {
                    throw nfw KfyStorfExdfption
                        ("fxpfdtfd but dould not find privbtf kfy");
                } flsf {
                    PrivbtfKfy pkfy = lobdPkfy(sfssion, h.hbndlf);
                    Cfrtifidbtf[] dhbin = blibsInfo.dhbin;
                    if ((pkfy != null) && (dhbin != null)) {
                        rfturn nfw KfyStorf.PrivbtfKfyEntry(pkfy, dhbin);
                    } flsf {
                        if (dfbug != null) {
                            dfbug.println
                                ("fnginfGftEntry got null dfrt dhbin or privbtf kfy");
                        }
                    }
                }
            }
            rfturn null;
        } dbtdh (PKCS11Exdfption pf) {
            throw nfw KfyStorfExdfption(pf);
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * Sbvf b <dodf>KfyStorf.Entry</dodf> undfr thf spfdififd blibs.
     *
     * <p> If bn fntry blrfbdy fxists for thf spfdififd blibs,
     * it is ovfrriddfn.
     *
     * <p> This KfyStorf implfmfntbtion only supports thf stbndbrd
     * fntry typfs, bnd only supports X509Cfrtifidbtfs in
     * TrustfdCfrtifidbtfEntrifs.  Also, this implfmfntbtion dofs not support
     * protfdting fntrifs using b difffrfnt pbssword
     * from thf onf usfd for tokfn login.
     *
     * <p> Entrifs brf immfdibtfly storfd on thf tokfn.
     *
     * @pbrbm blibs sbvf thf <dodf>KfyStorf.Entry</dodf> undfr this blibs
     * @pbrbm fntry thf <dodf>Entry</dodf> to sbvf
     * @pbrbm protPbrbm this must bf <dodf>null</dodf>
     *
     * @fxdfption KfyStorfExdfption if this opfrbtion fbils
     *
     * @sindf 1.5
     */
    publid syndhronizfd void fnginfSftEntry(String blibs, KfyStorf.Entry fntry,
                        KfyStorf.ProtfdtionPbrbmftfr protPbrbm)
                throws KfyStorfExdfption {

        tokfn.fnsurfVblid();
        dhfdkWritf();

        if (protPbrbm != null &&
            protPbrbm instbndfof KfyStorf.PbsswordProtfdtion &&
            ((KfyStorf.PbsswordProtfdtion)protPbrbm).gftPbssword() != null &&
            !tokfn.donfig.gftKfyStorfCompbtibilityModf()) {
            throw nfw KfyStorfExdfption(nfw UnsupportfdOpfrbtionExdfption
                                ("ProtfdtionPbrbmftfr must bf null"));
        }

        if (tokfn.isWritfProtfdtfd()) {
            throw nfw KfyStorfExdfption("tokfn writf-protfdtfd");
        }

        if (fntry instbndfof KfyStorf.TrustfdCfrtifidbtfEntry) {

            if (usfSfdmodTrust == fblsf) {
                // PKCS #11 dofs not bllow bpp to modify trustfd dfrts -
                throw nfw KfyStorfExdfption(nfw UnsupportfdOpfrbtionExdfption
                                    ("trustfd dfrtifidbtfs mby only bf sft by " +
                                    "tokfn initiblizbtion bpplidbtion"));
            }
            Modulf modulf = tokfn.providfr.nssModulf;
            if ((modulf.typf != ModulfTypf.KEYSTORE) && (modulf.typf != ModulfTypf.FIPS)) {
                // XXX bllow TRUSTANCHOR modulf
                throw nfw KfyStorfExdfption("Trustfd dfrtifidbtfs dbn only bf "
                    + "bddfd to thf NSS KfyStorf modulf");
            }
            Cfrtifidbtf dfrt = ((TrustfdCfrtifidbtfEntry)fntry).gftTrustfdCfrtifidbtf();
            if (dfrt instbndfof X509Cfrtifidbtf == fblsf) {
                throw nfw KfyStorfExdfption("Cfrtifidbtf must bf bn X509Cfrtifidbtf");
            }
            X509Cfrtifidbtf xdfrt = (X509Cfrtifidbtf)dfrt;
            AlibsInfo info = blibsMbp.gft(blibs);
            if (info != null) {
                // XXX try to updbtf
                dflftfEntry(blibs);
            }
            try {
                storfCfrt(blibs, xdfrt);
                modulf.sftTrust(tokfn, xdfrt);
                mbpLbbfls();
            } dbtdh (PKCS11Exdfption | CfrtifidbtfExdfption f) {
                throw nfw KfyStorfExdfption(f);
            }

        } flsf {

            if (fntry instbndfof KfyStorf.PrivbtfKfyEntry) {

                PrivbtfKfy kfy =
                        ((KfyStorf.PrivbtfKfyEntry)fntry).gftPrivbtfKfy();
                if (!(kfy instbndfof P11Kfy) &&
                    !(kfy instbndfof RSAPrivbtfKfy) &&
                    !(kfy instbndfof DSAPrivbtfKfy) &&
                    !(kfy instbndfof DHPrivbtfKfy) &&
                    !(kfy instbndfof ECPrivbtfKfy)) {
                    throw nfw KfyStorfExdfption("unsupportfd kfy typf: " +
                                                kfy.gftClbss().gftNbmf());
                }

                // only support X509Cfrtifidbtf dhbins
                Cfrtifidbtf[] dhbin =
                    ((KfyStorf.PrivbtfKfyEntry)fntry).gftCfrtifidbtfChbin();
                if (!(dhbin instbndfof X509Cfrtifidbtf[])) {
                    throw nfw KfyStorfExdfption
                        (nfw UnsupportfdOpfrbtionExdfption
                                ("unsupportfd dfrtifidbtf brrby typf: " +
                                dhbin.gftClbss().gftNbmf()));
                }

                try {
                    boolfbn updbtfdAlibs = fblsf;
                    Sft<String> blibsfs = blibsMbp.kfySft();
                    for (String oldAlibs : blibsfs) {

                        // sff if thfrf's bn fxisting fntry with thf sbmf info

                        AlibsInfo blibsInfo = blibsMbp.gft(oldAlibs);
                        if (blibsInfo.typf == ATTR_CLASS_PKEY &&
                            blibsInfo.dfrt.gftPublidKfy().fqubls
                                        (dhbin[0].gftPublidKfy())) {

                            // found fxisting fntry -
                            // dbllfr is rfnbming fntry or updbting dfrt dhbin
                            //
                            // sft nfw CKA_LABEL/CKA_ID
                            // bnd updbtf dfrts if nfdfssbry

                            updbtfPkfy(blibs,
                                        blibsInfo.id,
                                        (X509Cfrtifidbtf[])dhbin,
                                        !blibsInfo.dfrt.fqubls(dhbin[0]));
                            updbtfdAlibs = truf;
                            brfbk;
                        }
                    }

                    if (!updbtfdAlibs) {
                        // dbllfr bdding nfw fntry
                        fnginfDflftfEntry(blibs);
                        storfPkfy(blibs, (KfyStorf.PrivbtfKfyEntry)fntry);
                    }

                } dbtdh (PKCS11Exdfption | CfrtifidbtfExdfption pf) {
                    throw nfw KfyStorfExdfption(pf);
                }

            } flsf if (fntry instbndfof KfyStorf.SfdrftKfyEntry) {

                KfyStorf.SfdrftKfyEntry skf = (KfyStorf.SfdrftKfyEntry)fntry;
                SfdrftKfy skfy = skf.gftSfdrftKfy();

                try {
                    // first dhfdk if thf kfy blrfbdy fxists
                    AlibsInfo blibsInfo = blibsMbp.gft(blibs);

                    if (blibsInfo != null) {
                        fnginfDflftfEntry(blibs);
                    }
                    storfSkfy(blibs, skf);

                } dbtdh (PKCS11Exdfption pf) {
                    throw nfw KfyStorfExdfption(pf);
                }

            } flsf {
                throw nfw KfyStorfExdfption(nfw UnsupportfdOpfrbtionExdfption
                    ("unsupportfd fntry typf: " + fntry.gftClbss().gftNbmf()));
            }

            try {

                // XXX  NSS dofs not writf out thf CKA_ID wf pbss to thfm
                //
                // thfrfforf wf must rf-mbp lbbfls
                // (dbn not simply updbtf blibsMbp)

                mbpLbbfls();
                if (dfbug != null) {
                    dumpTokfnMbp();
                }
            } dbtdh (PKCS11Exdfption | CfrtifidbtfExdfption pf) {
                throw nfw KfyStorfExdfption(pf);
            }
        }

        if (dfbug != null) {
            dfbug.println
                ("fnginfSftEntry bddfd nfw fntry for [" +
                blibs +
                "] to tokfn");
        }
    }

    /**
     * Dftfrminfs if thf kfystorf <dodf>Entry</dodf> for thf spfdififd
     * <dodf>blibs</dodf> is bn instbndf or subdlbss of thf spfdififd
     * <dodf>fntryClbss</dodf>.
     *
     * @pbrbm blibs thf blibs nbmf
     * @pbrbm fntryClbss thf fntry dlbss
     *
     * @rfturn truf if thf kfystorf <dodf>Entry</dodf> for thf spfdififd
     *          <dodf>blibs</dodf> is bn instbndf or subdlbss of thf
     *          spfdififd <dodf>fntryClbss</dodf>, fblsf othfrwisf
     */
    publid syndhronizfd boolfbn fnginfEntryInstbndfOf
                (String blibs, Clbss<? fxtfnds KfyStorf.Entry> fntryClbss) {
        tokfn.fnsurfVblid();
        rfturn supfr.fnginfEntryInstbndfOf(blibs, fntryClbss);
    }

    privbtf X509Cfrtifidbtf lobdCfrt(Sfssion sfssion, long oHbndlf)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[]
                        { nfw CK_ATTRIBUTE(CKA_VALUE) };
        tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);

        bytf[] bytfs = bttrs[0].gftBytfArrby();
        if (bytfs == null) {
            throw nfw CfrtifidbtfExdfption
                        ("unfxpfdtfdly rftrifvfd null bytf brrby");
        }
        CfrtifidbtfFbdtory df = CfrtifidbtfFbdtory.gftInstbndf("X.509");
        rfturn (X509Cfrtifidbtf)df.gfnfrbtfCfrtifidbtf
                        (nfw BytfArrbyInputStrfbm(bytfs));
    }

    privbtf X509Cfrtifidbtf[] lobdChbin(Sfssion sfssion,
                                        X509Cfrtifidbtf fndCfrt)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        ArrbyList<X509Cfrtifidbtf> lChbin = null;

        if (fndCfrt.gftSubjfdtX500Prindipbl().fqubls
            (fndCfrt.gftIssufrX500Prindipbl())) {
            // sflf signfd
            rfturn nfw X509Cfrtifidbtf[] { fndCfrt };
        } flsf {
            lChbin = nfw ArrbyList<X509Cfrtifidbtf>();
            lChbin.bdd(fndCfrt);
        }

        // try lobding rfmbining dfrts in dhbin by following
        // issufr->subjfdt links

        X509Cfrtifidbtf nfxt = fndCfrt;
        whilf (truf) {
            CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_TOKEN_TRUE,
                        ATTR_CLASS_CERT,
                        nfw CK_ATTRIBUTE(CKA_SUBJECT,
                                nfxt.gftIssufrX500Prindipbl().gftEndodfd()) };
            long[] dh = findObjfdts(sfssion, bttrs);

            if (dh == null || dh.lfngth == 0) {
                // donf
                brfbk;
            } flsf {
                // if morf thbn onf found, usf first
                if (dfbug != null && dh.lfngth > 1) {
                    dfbug.println("fnginfGftEntry found " +
                                dh.lfngth +
                                " dfrtifidbtf fntrifs for subjfdt [" +
                                nfxt.gftIssufrX500Prindipbl().toString() +
                                "] in tokfn - using first fntry");
                }

                nfxt = lobdCfrt(sfssion, dh[0]);
                lChbin.bdd(nfxt);
                if (nfxt.gftSubjfdtX500Prindipbl().fqubls
                    (nfxt.gftIssufrX500Prindipbl())) {
                    // sflf signfd
                    brfbk;
                }
            }
        }

        rfturn lChbin.toArrby(nfw X509Cfrtifidbtf[lChbin.sizf()]);
    }

    privbtf SfdrftKfy lobdSkfy(Sfssion sfssion, long oHbndlf)
                throws PKCS11Exdfption {

        CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        nfw CK_ATTRIBUTE(CKA_KEY_TYPE) };
        tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
        long kTypf = bttrs[0].gftLong();

        String kfyTypf = null;
        int kfyLfngth = -1;

        // XXX NSS mbnglfs thf storfd kfy typf for sfdrft kfy tokfn objfdts

        if (kTypf == CKK_DES || kTypf == CKK_DES3) {
            if (kTypf == CKK_DES) {
                kfyTypf = "DES";
                kfyLfngth = 64;
            } flsf if (kTypf == CKK_DES3) {
                kfyTypf = "DESfdf";
                kfyLfngth = 192;
            }
        } flsf {
            if (kTypf == CKK_AES) {
                kfyTypf = "AES";
            } flsf if (kTypf == CKK_BLOWFISH) {
                kfyTypf = "Blowfish";
            } flsf if (kTypf == CKK_RC4) {
                kfyTypf = "ARCFOUR";
            } flsf {
                if (dfbug != null) {
                    dfbug.println("unknown kfy typf [" +
                                kTypf +
                                "] - using 'Gfnfrid Sfdrft'");
                }
                kfyTypf = "Gfnfrid Sfdrft";
            }

            // XXX NSS problfm CKR_ATTRIBUTE_TYPE_INVALID?
            if (NSS_TEST) {
                kfyLfngth = 128;
            } flsf {
                bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_VALUE_LEN) };
                tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
                kfyLfngth = (int)bttrs[0].gftLong();
            }
        }

        rfturn P11Kfy.sfdrftKfy(sfssion, oHbndlf, kfyTypf, kfyLfngth, null);
    }

    privbtf PrivbtfKfy lobdPkfy(Sfssion sfssion, long oHbndlf)
        throws PKCS11Exdfption, KfyStorfExdfption {

        CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        nfw CK_ATTRIBUTE(CKA_KEY_TYPE) };
        tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
        long kTypf = bttrs[0].gftLong();
        String kfyTypf = null;
        int kfyLfngth = 0;

        if (kTypf == CKK_RSA) {

            kfyTypf = "RSA";

            bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_MODULUS) };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
            BigIntfgfr modulus = bttrs[0].gftBigIntfgfr();
            kfyLfngth = modulus.bitLfngth();

            // This dhfdk will dombinf our "don't dbrf" vblufs hfrf
            // with thf systfm-widf min/mbx vblufs.
            try {
                RSAKfyFbdtory.dhfdkKfyLfngths(kfyLfngth, null,
                    -1, Intfgfr.MAX_VALUE);
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw KfyStorfExdfption(f.gftMfssbgf());
            }

            rfturn P11Kfy.privbtfKfy(sfssion,
                                oHbndlf,
                                kfyTypf,
                                kfyLfngth,
                                null);

        } flsf if (kTypf == CKK_DSA) {

            kfyTypf = "DSA";

            bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_PRIME) };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
            BigIntfgfr primf = bttrs[0].gftBigIntfgfr();
            kfyLfngth = primf.bitLfngth();

            rfturn P11Kfy.privbtfKfy(sfssion,
                                oHbndlf,
                                kfyTypf,
                                kfyLfngth,
                                null);

        } flsf if (kTypf == CKK_DH) {

            kfyTypf = "DH";

            bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_PRIME) };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
            BigIntfgfr primf = bttrs[0].gftBigIntfgfr();
            kfyLfngth = primf.bitLfngth();

            rfturn P11Kfy.privbtfKfy(sfssion,
                                oHbndlf,
                                kfyTypf,
                                kfyLfngth,
                                null);

        } flsf if (kTypf == CKK_EC) {

            bttrs = nfw CK_ATTRIBUTE[] {
                nfw CK_ATTRIBUTE(CKA_EC_PARAMS),
            };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), oHbndlf, bttrs);
            bytf[] fndodfdPbrbms = bttrs[0].gftBytfArrby();
            try {
                ECPbrbmftfrSpfd pbrbms =
                    ECUtil.gftECPbrbmftfrSpfd(null, fndodfdPbrbms);
                kfyLfngth = pbrbms.gftCurvf().gftFifld().gftFifldSizf();
            } dbtdh (IOExdfption f) {
                // wf do not wbnt to bddfpt kfy with unsupportfd pbrbmftfrs
                throw nfw KfyStorfExdfption("Unsupportfd pbrbmftfrs", f);
            }

            rfturn P11Kfy.privbtfKfy(sfssion, oHbndlf, "EC", kfyLfngth, null);

        } flsf {
            if (dfbug != null) {
                dfbug.println("unknown kfy typf [" + kTypf + "]");
            }
            throw nfw KfyStorfExdfption("unknown kfy typf");
        }
    }


    /**
     * XXX  On ibutton, whfn you C_SftAttributf(CKA_ID) for b privbtf kfy
     *      it not only dhbngfs thf CKA_ID of thf privbtf kfy,
     *      it dhbngfs thf CKA_ID of thf dorrfsponding dfrt too.
     *      And vidf vfrsb.
     *
     * XXX  On ibutton, CKR_DEVICE_ERROR if you C_SftAttributf(CKA_ID)
     *      for b privbtf kfy, bnd thfn try to dflftf thf dorrfsponding dfrt.
     *      So this dodf rfvfrsfs thf ordfr.
     *      Aftfr thf dfrt is first dfstroyfd (if nfdfssbry),
     *      thfn thf CKA_ID of thf privbtf kfy dbn bf dhbngfd suddfssfully.
     *
     * @pbrbm rfplbdfCfrt if truf, thfn dbllfr is updbting blibs info for
     *                  fxisting dfrt (only updbtf CKA_ID/CKA_LABEL).
     *                  if fblsf, thfn dbllfr is updbting dfrt dhbin
     *                  (dflftf old fnd dfrt bnd bdd nfw dhbin).
     */
    privbtf void updbtfPkfy(String blibs,
                        bytf[] dkb_id,
                        X509Cfrtifidbtf[] dhbin,
                        boolfbn rfplbdfCfrt) throws
                KfyStorfExdfption, CfrtifidbtfExdfption, PKCS11Exdfption {

        // XXX
        //
        // blwbys sft rfplbdfCfrt to truf
        //
        // NSS dofs not bllow rfsftting of CKA_LABEL on bn fxisting dfrt
        // (C_SftAttributf dbll suddffds, but is ignorfd)

        rfplbdfCfrt = truf;

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            // first gft privbtf kfy objfdt hbndlf bnd hbng onto it

            THbndlf h = gftTokfnObjfdt(sfssion, ATTR_CLASS_PKEY, dkb_id, null);
            long pKfyHbndlf;
            if (h.typf == ATTR_CLASS_PKEY) {
                pKfyHbndlf = h.hbndlf;
            } flsf {
                throw nfw KfyStorfExdfption
                        ("fxpfdtfd but dould not find privbtf kfy " +
                        "with CKA_ID " +
                        gftID(dkb_id));
            }

            // nfxt find fxisting fnd fntity dfrt

            h = gftTokfnObjfdt(sfssion, ATTR_CLASS_CERT, dkb_id, null);
            if (h.typf != ATTR_CLASS_CERT) {
                throw nfw KfyStorfExdfption
                        ("fxpfdtfd but dould not find dfrtifidbtf " +
                        "with CKA_ID " +
                        gftID(dkb_id));
            } flsf {
                if (rfplbdfCfrt) {
                    // rfplbding fxisting dfrt bnd dhbin
                    dfstroyChbin(dkb_id);
                } flsf {
                    // rfnbming blibs for fxisting dfrt
                    CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        nfw CK_ATTRIBUTE(CKA_LABEL, blibs),
                        nfw CK_ATTRIBUTE(CKA_ID, blibs) };
                    tokfn.p11.C_SftAttributfVbluf
                        (sfssion.id(), h.hbndlf, bttrs);
                }
            }

            // bdd nfw dhbin

            if (rfplbdfCfrt) {
                // bdd bll dfrts in dhbin
                storfChbin(blibs, dhbin);
            } flsf {
                // blrfbdy updbtfd blibs info for fxisting fnd dfrt -
                // just updbtf CA dfrts
                storfCbCfrts(dhbin, 1);
            }

            // finblly updbtf CKA_ID for privbtf kfy
            //
            // ibutton mby hbvf blrfbdy donf this (thbt is ok)

            CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                                nfw CK_ATTRIBUTE(CKA_ID, blibs) };
            tokfn.p11.C_SftAttributfVbluf(sfssion.id(), pKfyHbndlf, bttrs);

            if (dfbug != null) {
                dfbug.println("updbtfPkfy sft nfw blibs [" +
                                blibs +
                                "] for privbtf kfy fntry");
            }
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    privbtf void updbtfP11Pkfy(String blibs, CK_ATTRIBUTE bttributf, P11Kfy kfy)
                throws PKCS11Exdfption {

        // if tokfn kfy, updbtf blibs.
        // if sfssion kfy, donvfrt to tokfn kfy.

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();
            if (kfy.tokfnObjfdt == truf) {

                // tokfn kfy - sft nfw CKA_ID

                CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                                nfw CK_ATTRIBUTE(CKA_ID, blibs) };
                tokfn.p11.C_SftAttributfVbluf
                                (sfssion.id(), kfy.kfyID, bttrs);
                if (dfbug != null) {
                    dfbug.println("updbtfP11Pkfy sft nfw blibs [" +
                                blibs +
                                "] for kfy fntry");
                }
            } flsf {

                // sfssion kfy - donvfrt to tokfn kfy bnd sft CKA_ID

                CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                    ATTR_TOKEN_TRUE,
                    nfw CK_ATTRIBUTE(CKA_ID, blibs),
                };
                if (bttributf != null) {
                    bttrs = bddAttributf(bttrs, bttributf);
                }
                tokfn.p11.C_CopyObjfdt(sfssion.id(), kfy.kfyID, bttrs);
                if (dfbug != null) {
                    dfbug.println("updbtfP11Pkfy dopifd privbtf sfssion kfy " +
                                "for [" +
                                blibs +
                                "] to tokfn fntry");
                }
            }
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    privbtf void storfCfrt(String blibs, X509Cfrtifidbtf dfrt)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        ArrbyList<CK_ATTRIBUTE> bttrList = nfw ArrbyList<CK_ATTRIBUTE>();
        bttrList.bdd(ATTR_TOKEN_TRUE);
        bttrList.bdd(ATTR_CLASS_CERT);
        bttrList.bdd(ATTR_X509_CERT_TYPE);
        bttrList.bdd(nfw CK_ATTRIBUTE(CKA_SUBJECT,
                                dfrt.gftSubjfdtX500Prindipbl().gftEndodfd()));
        bttrList.bdd(nfw CK_ATTRIBUTE(CKA_ISSUER,
                                dfrt.gftIssufrX500Prindipbl().gftEndodfd()));
        bttrList.bdd(nfw CK_ATTRIBUTE(CKA_SERIAL_NUMBER,
                                dfrt.gftSfriblNumbfr().toBytfArrby()));
        bttrList.bdd(nfw CK_ATTRIBUTE(CKA_VALUE, dfrt.gftEndodfd()));

        if (blibs != null) {
            bttrList.bdd(nfw CK_ATTRIBUTE(CKA_LABEL, blibs));
            bttrList.bdd(nfw CK_ATTRIBUTE(CKA_ID, blibs));
        } flsf {
            // ibutton rfquirfs somfthing to bf sft
            // - blibs must bf uniquf
            bttrList.bdd(nfw CK_ATTRIBUTE(CKA_ID,
                        gftID(dfrt.gftSubjfdtX500Prindipbl().gftNbmf
                                        (X500Prindipbl.CANONICAL), dfrt)));
        }

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();
            tokfn.p11.C_CrfbtfObjfdt(sfssion.id(),
                        bttrList.toArrby(nfw CK_ATTRIBUTE[bttrList.sizf()]));
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    privbtf void storfChbin(String blibs, X509Cfrtifidbtf[] dhbin)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        // bdd nfw dhbin
        //
        // fnd dfrt hbs CKA_LABEL bnd CKA_ID sft to blibs.
        // othfr dfrts in dhbin hbvf nfithfr sft.

        storfCfrt(blibs, dhbin[0]);
        storfCbCfrts(dhbin, 1);
    }

    privbtf void storfCbCfrts(X509Cfrtifidbtf[] dhbin, int stbrt)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        // do not bdd duplidbtf CA dfrt if blrfbdy in tokfn
        //
        // XXX   ibutton storfs duplidbtf CA dfrts, NSS dofs not

        Sfssion sfssion = null;
        HbshSft<X509Cfrtifidbtf> dbdfrts = nfw HbshSft<X509Cfrtifidbtf>();
        try {
            sfssion = tokfn.gftOpSfssion();
            CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_TOKEN_TRUE,
                        ATTR_CLASS_CERT };
            long[] hbndlfs = findObjfdts(sfssion, bttrs);

            // lobd dfrts durrfntly on thf tokfn
            for (long hbndlf : hbndlfs) {
                dbdfrts.bdd(lobdCfrt(sfssion, hbndlf));
            }
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }

        for (int i = stbrt; i < dhbin.lfngth; i++) {
            if (!dbdfrts.dontbins(dhbin[i])) {
                storfCfrt(null, dhbin[i]);
            } flsf if (dfbug != null) {
                dfbug.println("ignoring duplidbtf CA dfrt for [" +
                        dhbin[i].gftSubjfdtX500Prindipbl() +
                        "]");
            }
        }
    }

    privbtf void storfSkfy(String blibs, KfyStorf.SfdrftKfyEntry skf)
                throws PKCS11Exdfption, KfyStorfExdfption {

        SfdrftKfy skfy = skf.gftSfdrftKfy();
        // No nffd to spfdify CKA_CLASS, CKA_KEY_TYPE, CKA_VALUE sindf
        // thfy brf hbndlfd in P11SfdrftKfyFbdtory.drfbtfKfy() mfthod.
        CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
            ATTR_SKEY_TOKEN_TRUE,
            ATTR_PRIVATE_TRUE,
            nfw CK_ATTRIBUTE(CKA_LABEL, blibs),
        };
        try {
            P11SfdrftKfyFbdtory.donvfrtKfy(tokfn, skfy, null, bttrs);
        } dbtdh (InvblidKfyExdfption ikf) {
            // rf-throw KfyStorfExdfption to mbtdh jbvbdod
            throw nfw KfyStorfExdfption("Cbnnot donvfrt to PKCS11 kfys", ikf);
        }

        // updbtf globbl blibs mbp
        blibsMbp.put(blibs, nfw AlibsInfo(blibs));

        if (dfbug != null) {
            dfbug.println("storfSkfy drfbtfd tokfn sfdrft kfy for [" +
                          blibs + "]");
        }
    }

    privbtf stbtid CK_ATTRIBUTE[] bddAttributf(CK_ATTRIBUTE[] bttrs, CK_ATTRIBUTE bttr) {
        int n = bttrs.lfngth;
        CK_ATTRIBUTE[] nfwAttrs = nfw CK_ATTRIBUTE[n + 1];
        Systfm.brrbydopy(bttrs, 0, nfwAttrs, 0, n);
        nfwAttrs[n] = bttr;
        rfturn nfwAttrs;
    }

    privbtf void storfPkfy(String blibs, KfyStorf.PrivbtfKfyEntry pkf)
        throws PKCS11Exdfption, CfrtifidbtfExdfption, KfyStorfExdfption  {

        PrivbtfKfy kfy = pkf.gftPrivbtfKfy();
        CK_ATTRIBUTE[] bttrs = null;

        // If thf kfy is b tokfn objfdt on this tokfn, updbtf it instfbd
        // of drfbting b duplidbtf kfy objfdt.
        // Othfrwisf, trfbt b P11Kfy likf bny othfr kfy, if is is fxtrbdtbblf.
        if (kfy instbndfof P11Kfy) {
            P11Kfy p11Kfy = (P11Kfy)kfy;
            if (p11Kfy.tokfnObjfdt && (p11Kfy.tokfn == this.tokfn)) {
                updbtfP11Pkfy(blibs, null, p11Kfy);
                storfChbin(blibs, (X509Cfrtifidbtf[])pkf.gftCfrtifidbtfChbin());
                rfturn;
            }
        }

        boolfbn usfNDB = tokfn.donfig.gftNssNftsdbpfDbWorkbround();
        PublidKfy publidKfy = pkf.gftCfrtifidbtf().gftPublidKfy();

        if (kfy instbndfof RSAPrivbtfKfy) {

            X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf)pkf.gftCfrtifidbtf();
            bttrs = gftRsbPrivKfyAttrs
                (blibs, (RSAPrivbtfKfy)kfy, dfrt.gftSubjfdtX500Prindipbl());

        } flsf if (kfy instbndfof DSAPrivbtfKfy) {

            DSAPrivbtfKfy dsbKfy = (DSAPrivbtfKfy)kfy;

            CK_ATTRIBUTE[] idAttrs = gftIdAttributfs(kfy, publidKfy, fblsf, usfNDB);
            if (idAttrs[0] == null) {
                idAttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, blibs);
            }

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
                ATTR_PRIVATE_TRUE,
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_DSA),
                idAttrs[0],
                nfw CK_ATTRIBUTE(CKA_PRIME, dsbKfy.gftPbrbms().gftP()),
                nfw CK_ATTRIBUTE(CKA_SUBPRIME, dsbKfy.gftPbrbms().gftQ()),
                nfw CK_ATTRIBUTE(CKA_BASE, dsbKfy.gftPbrbms().gftG()),
                nfw CK_ATTRIBUTE(CKA_VALUE, dsbKfy.gftX()),
            };
            if (idAttrs[1] != null) {
                bttrs = bddAttributf(bttrs, idAttrs[1]);
            }

            bttrs = tokfn.gftAttributfs
                (TfmplbtfMbnbgfr.O_IMPORT, CKO_PRIVATE_KEY, CKK_DSA, bttrs);

            if (dfbug != null) {
                dfbug.println("storfPkfy drfbtfd DSA tfmplbtf");
            }

        } flsf if (kfy instbndfof DHPrivbtfKfy) {

            DHPrivbtfKfy dhKfy = (DHPrivbtfKfy)kfy;

            CK_ATTRIBUTE[] idAttrs = gftIdAttributfs(kfy, publidKfy, fblsf, usfNDB);
            if (idAttrs[0] == null) {
                idAttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, blibs);
            }

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
                ATTR_PRIVATE_TRUE,
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_DH),
                idAttrs[0],
                nfw CK_ATTRIBUTE(CKA_PRIME, dhKfy.gftPbrbms().gftP()),
                nfw CK_ATTRIBUTE(CKA_BASE, dhKfy.gftPbrbms().gftG()),
                nfw CK_ATTRIBUTE(CKA_VALUE, dhKfy.gftX()),
            };
            if (idAttrs[1] != null) {
                bttrs = bddAttributf(bttrs, idAttrs[1]);
            }

            bttrs = tokfn.gftAttributfs
                (TfmplbtfMbnbgfr.O_IMPORT, CKO_PRIVATE_KEY, CKK_DH, bttrs);

        } flsf if (kfy instbndfof ECPrivbtfKfy) {

            ECPrivbtfKfy fdKfy = (ECPrivbtfKfy)kfy;

            CK_ATTRIBUTE[] idAttrs = gftIdAttributfs(kfy, publidKfy, fblsf, usfNDB);
            if (idAttrs[0] == null) {
                idAttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, blibs);
            }

            bytf[] fndodfdPbrbms =
                ECUtil.fndodfECPbrbmftfrSpfd(null, fdKfy.gftPbrbms());
            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
                ATTR_PRIVATE_TRUE,
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_EC),
                idAttrs[0],
                nfw CK_ATTRIBUTE(CKA_VALUE, fdKfy.gftS()),
                nfw CK_ATTRIBUTE(CKA_EC_PARAMS, fndodfdPbrbms),
            };
            if (idAttrs[1] != null) {
                bttrs = bddAttributf(bttrs, idAttrs[1]);
            }

            bttrs = tokfn.gftAttributfs
                (TfmplbtfMbnbgfr.O_IMPORT, CKO_PRIVATE_KEY, CKK_EC, bttrs);

            if (dfbug != null) {
                dfbug.println("storfPkfy drfbtfd EC tfmplbtf");
            }

        } flsf if (kfy instbndfof P11Kfy) {
            // sfnsitivf/non-fxtrbdtbblf P11Kfy
            P11Kfy p11Kfy = (P11Kfy)kfy;
            if (p11Kfy.tokfn != this.tokfn) {
                throw nfw KfyStorfExdfption
                    ("Cbnnot movf sfnsitivf kfys bdross tokfns");
            }
            CK_ATTRIBUTE nftsdbpfDB = null;
            if (usfNDB) {
                // Notf thbt this durrfntly fbils duf to bn NSS bug.
                // Thfy do not bllow thf CKA_NETSCAPE_DB bttributf to bf
                // spfdififd during C_CopyObjfdt() bnd fbil with
                // CKR_ATTRIBUTE_READ_ONLY.
                // But if wf did not spfdify it, thfy would fbil with
                // CKA_TEMPLATE_INCOMPLETE, so lfbvf this dodf in hfrf.
                CK_ATTRIBUTE[] idAttrs = gftIdAttributfs(kfy, publidKfy, fblsf, truf);
                nftsdbpfDB = idAttrs[1];
            }
            // Updbtf thf kfy objfdt.
            updbtfP11Pkfy(blibs, nftsdbpfDB, p11Kfy);
            storfChbin(blibs, (X509Cfrtifidbtf[])pkf.gftCfrtifidbtfChbin());
            rfturn;

        } flsf {
            throw nfw KfyStorfExdfption("unsupportfd kfy typf: " + kfy);
        }

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            // drfbtf privbtf kfy fntry
            tokfn.p11.C_CrfbtfObjfdt(sfssion.id(), bttrs);
            if (dfbug != null) {
                dfbug.println("storfPkfy drfbtfd tokfn kfy for [" +
                                blibs +
                                "]");
            }
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }

        storfChbin(blibs, (X509Cfrtifidbtf[])pkf.gftCfrtifidbtfChbin());
    }

    privbtf CK_ATTRIBUTE[] gftRsbPrivKfyAttrs(String blibs,
                                RSAPrivbtfKfy kfy,
                                X500Prindipbl subjfdt) throws PKCS11Exdfption {

        // subjfdt is durrfntly ignorfd - dould bf usfd to sft CKA_SUBJECT

        CK_ATTRIBUTE[] bttrs = null;
        if (kfy instbndfof RSAPrivbtfCrtKfy) {

            if (dfbug != null) {
                dfbug.println("drfbting RSAPrivbtfCrtKfy bttrs");
            }

            RSAPrivbtfCrtKfy rsbKfy = (RSAPrivbtfCrtKfy)kfy;

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
                ATTR_PRIVATE_TRUE,
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_RSA),
                nfw CK_ATTRIBUTE(CKA_ID, blibs),
                nfw CK_ATTRIBUTE(CKA_MODULUS,
                                rsbKfy.gftModulus()),
                nfw CK_ATTRIBUTE(CKA_PRIVATE_EXPONENT,
                                rsbKfy.gftPrivbtfExponfnt()),
                nfw CK_ATTRIBUTE(CKA_PUBLIC_EXPONENT,
                                rsbKfy.gftPublidExponfnt()),
                nfw CK_ATTRIBUTE(CKA_PRIME_1,
                                rsbKfy.gftPrimfP()),
                nfw CK_ATTRIBUTE(CKA_PRIME_2,
                                rsbKfy.gftPrimfQ()),
                nfw CK_ATTRIBUTE(CKA_EXPONENT_1,
                                rsbKfy.gftPrimfExponfntP()),
                nfw CK_ATTRIBUTE(CKA_EXPONENT_2,
                                rsbKfy.gftPrimfExponfntQ()),
                nfw CK_ATTRIBUTE(CKA_COEFFICIENT,
                                rsbKfy.gftCrtCofffidifnt()) };
            bttrs = tokfn.gftAttributfs
                (TfmplbtfMbnbgfr.O_IMPORT, CKO_PRIVATE_KEY, CKK_RSA, bttrs);

        } flsf {

            if (dfbug != null) {
                dfbug.println("drfbting RSAPrivbtfKfy bttrs");
            }

            RSAPrivbtfKfy rsbKfy = kfy;

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
                ATTR_PRIVATE_TRUE,
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_RSA),
                nfw CK_ATTRIBUTE(CKA_ID, blibs),
                nfw CK_ATTRIBUTE(CKA_MODULUS,
                                rsbKfy.gftModulus()),
                nfw CK_ATTRIBUTE(CKA_PRIVATE_EXPONENT,
                                rsbKfy.gftPrivbtfExponfnt()) };
            bttrs = tokfn.gftAttributfs
                (TfmplbtfMbnbgfr.O_IMPORT, CKO_PRIVATE_KEY, CKK_RSA, bttrs);
        }

        rfturn bttrs;
    }

    /**
     * Computf thf CKA_ID bnd/or CKA_NETSCAPE_DB bttributfs thbt should bf
     * usfd for this privbtf kfy. It usfs thf sbmf blgorithm to dbldulbtf thf
     * vblufs bs NSS. Thf publid bnd privbtf kfys MUST mbtdh for thf rfsult to
     * bf dorrfdt.
     *
     * It rfturns b 2 flfmfnt brrby with CKA_ID bt indfx 0 bnd CKA_NETSCAPE_DB
     * bt indfx 1. Thf boolfbn flbgs dftfrminf whbt is to bf dbldulbtfd.
     * If fblsf or if wf dould not dbldulbtf thf vbluf, thbt flfmfnt is null.
     *
     * NOTE thbt wf durrfntly do not usf thf CKA_ID vbluf dbldulbtfd by this
     * mfthod.
     */
    privbtf CK_ATTRIBUTE[] gftIdAttributfs(PrivbtfKfy privbtfKfy,
            PublidKfy publidKfy, boolfbn id, boolfbn nftsdbpfDb) {
        CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[2];
        if ((id || nftsdbpfDb) == fblsf) {
            rfturn bttrs;
        }
        String blg = privbtfKfy.gftAlgorithm();
        if (id && blg.fqubls("RSA") && (publidKfy instbndfof RSAPublidKfy)) {
            // CKA_NETSCAPE_DB not nffdfd for RSA publid kfys
            BigIntfgfr n = ((RSAPublidKfy)publidKfy).gftModulus();
            bttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, shb1(gftMbgnitudf(n)));
        } flsf if (blg.fqubls("DSA") && (publidKfy instbndfof DSAPublidKfy)) {
            BigIntfgfr y = ((DSAPublidKfy)publidKfy).gftY();
            if (id) {
                bttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, shb1(gftMbgnitudf(y)));
            }
            if (nftsdbpfDb) {
                bttrs[1] = nfw CK_ATTRIBUTE(CKA_NETSCAPE_DB, y);
            }
        } flsf if (blg.fqubls("DH") && (publidKfy instbndfof DHPublidKfy)) {
            BigIntfgfr y = ((DHPublidKfy)publidKfy).gftY();
            if (id) {
                bttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, shb1(gftMbgnitudf(y)));
            }
            if (nftsdbpfDb) {
                bttrs[1] = nfw CK_ATTRIBUTE(CKA_NETSCAPE_DB, y);
            }
        } flsf if (blg.fqubls("EC") && (publidKfy instbndfof ECPublidKfy)) {
            ECPublidKfy fdPub = (ECPublidKfy)publidKfy;
            ECPoint point = fdPub.gftW();
            ECPbrbmftfrSpfd pbrbms = fdPub.gftPbrbms();
            bytf[] fndodfdPoint = ECUtil.fndodfPoint(point, pbrbms.gftCurvf());
            if (id) {
                bttrs[0] = nfw CK_ATTRIBUTE(CKA_ID, shb1(fndodfdPoint));
            }
            if (nftsdbpfDb) {
                bttrs[1] = nfw CK_ATTRIBUTE(CKA_NETSCAPE_DB, fndodfdPoint);
            }
        } flsf {
            throw nfw RuntimfExdfption("Unknown kfy blgorithm " + blg);
        }
        rfturn bttrs;
    }

    /**
     * rfturn truf if dfrt dfstroyfd
     */
    privbtf boolfbn dfstroyCfrt(bytf[] dkb_id)
                throws PKCS11Exdfption, KfyStorfExdfption {
        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();
            THbndlf h = gftTokfnObjfdt(sfssion, ATTR_CLASS_CERT, dkb_id, null);
            if (h.typf != ATTR_CLASS_CERT) {
                rfturn fblsf;
            }

            tokfn.p11.C_DfstroyObjfdt(sfssion.id(), h.hbndlf);
            if (dfbug != null) {
                dfbug.println("dfstroyCfrt dfstroyfd dfrt with CKA_ID [" +
                                                gftID(dkb_id) +
                                                "]");
            }
            rfturn truf;
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * rfturn truf if dhbin dfstroyfd
     */
    privbtf boolfbn dfstroyChbin(bytf[] dkb_id)
        throws PKCS11Exdfption, CfrtifidbtfExdfption, KfyStorfExdfption {

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            THbndlf h = gftTokfnObjfdt(sfssion, ATTR_CLASS_CERT, dkb_id, null);
            if (h.typf != ATTR_CLASS_CERT) {
                if (dfbug != null) {
                    dfbug.println("dfstroyChbin dould not find " +
                        "fnd fntity dfrt with CKA_ID [0x" +
                        Fundtions.toHfxString(dkb_id) +
                        "]");
                }
                rfturn fblsf;
            }

            X509Cfrtifidbtf fndCfrt = lobdCfrt(sfssion, h.hbndlf);
            tokfn.p11.C_DfstroyObjfdt(sfssion.id(), h.hbndlf);
            if (dfbug != null) {
                dfbug.println("dfstroyChbin dfstroyfd fnd fntity dfrt " +
                        "with CKA_ID [" +
                        gftID(dkb_id) +
                        "]");
            }

            // build dhbin following issufr->subjfdt links

            X509Cfrtifidbtf nfxt = fndCfrt;
            whilf (truf) {

                if (nfxt.gftSubjfdtX500Prindipbl().fqubls
                    (nfxt.gftIssufrX500Prindipbl())) {
                    // sflf signfd - donf
                    brfbk;
                }

                CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_TOKEN_TRUE,
                        ATTR_CLASS_CERT,
                        nfw CK_ATTRIBUTE(CKA_SUBJECT,
                                  nfxt.gftIssufrX500Prindipbl().gftEndodfd()) };
                long[] dh = findObjfdts(sfssion, bttrs);

                if (dh == null || dh.lfngth == 0) {
                    // donf
                    brfbk;
                } flsf {
                    // if morf thbn onf found, usf first
                    if (dfbug != null && dh.lfngth > 1) {
                        dfbug.println("dfstroyChbin found " +
                                dh.lfngth +
                                " dfrtifidbtf fntrifs for subjfdt [" +
                                nfxt.gftIssufrX500Prindipbl() +
                                "] in tokfn - using first fntry");
                    }

                    nfxt = lobdCfrt(sfssion, dh[0]);

                    // only dflftf if not pbrt of bny othfr dhbin

                    bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_TOKEN_TRUE,
                        ATTR_CLASS_CERT,
                        nfw CK_ATTRIBUTE(CKA_ISSUER,
                                nfxt.gftSubjfdtX500Prindipbl().gftEndodfd()) };
                    long[] issufrs = findObjfdts(sfssion, bttrs);

                    boolfbn dfstroyIt = fblsf;
                    if (issufrs == null || issufrs.lfngth == 0) {
                        // no othfr dfrts with this issufr -
                        // dfstroy it
                        dfstroyIt = truf;
                    } flsf if (issufrs.lfngth == 1) {
                        X509Cfrtifidbtf iCfrt = lobdCfrt(sfssion, issufrs[0]);
                        if (nfxt.fqubls(iCfrt)) {
                            // only dfrt with issufr is itsflf (sflf-signfd) -
                            // dfstroy it
                            dfstroyIt = truf;
                        }
                    }

                    if (dfstroyIt) {
                        tokfn.p11.C_DfstroyObjfdt(sfssion.id(), dh[0]);
                        if (dfbug != null) {
                            dfbug.println
                                ("dfstroyChbin dfstroyfd dfrt in dhbin " +
                                "with subjfdt [" +
                                nfxt.gftSubjfdtX500Prindipbl() + "]");
                        }
                    } flsf {
                        if (dfbug != null) {
                            dfbug.println("dfstroyChbin did not dfstroy " +
                                "shbrfd dfrt in dhbin with subjfdt [" +
                                nfxt.gftSubjfdtX500Prindipbl() + "]");
                        }
                    }
                }
            }

            rfturn truf;

        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * rfturn truf if sfdrft kfy dfstroyfd
     */
    privbtf boolfbn dfstroySkfy(String blibs)
                throws PKCS11Exdfption, KfyStorfExdfption {
        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            THbndlf h = gftTokfnObjfdt(sfssion, ATTR_CLASS_SKEY, null, blibs);
            if (h.typf != ATTR_CLASS_SKEY) {
                if (dfbug != null) {
                    dfbug.println("dfstroySkfy did not find sfdrft kfy " +
                        "with CKA_LABEL [" +
                        blibs +
                        "]");
                }
                rfturn fblsf;
            }
            tokfn.p11.C_DfstroyObjfdt(sfssion.id(), h.hbndlf);
            rfturn truf;
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * rfturn truf if privbtf kfy dfstroyfd
     */
    privbtf boolfbn dfstroyPkfy(bytf[] dkb_id)
                throws PKCS11Exdfption, KfyStorfExdfption {
        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            THbndlf h = gftTokfnObjfdt(sfssion, ATTR_CLASS_PKEY, dkb_id, null);
            if (h.typf != ATTR_CLASS_PKEY) {
                if (dfbug != null) {
                    dfbug.println
                        ("dfstroyPkfy did not find privbtf kfy with CKA_ID [" +
                        gftID(dkb_id) +
                        "]");
                }
                rfturn fblsf;
            }
            tokfn.p11.C_DfstroyObjfdt(sfssion.id(), h.hbndlf);
            rfturn truf;
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * build [blibs + issufr + sfriblNumbfr] string from b dfrt
     */
    privbtf String gftID(String blibs, X509Cfrtifidbtf dfrt) {
        X500Prindipbl issufr = dfrt.gftIssufrX500Prindipbl();
        BigIntfgfr sfriblNum = dfrt.gftSfriblNumbfr();

        rfturn blibs +
                ALIAS_SEP +
                issufr.gftNbmf(X500Prindipbl.CANONICAL) +
                ALIAS_SEP +
                sfriblNum.toString();
    }

    /**
     * build CKA_ID string from bytfs
     */
    privbtf stbtid String gftID(bytf[] bytfs) {
        boolfbn printbblf = truf;
        for (int i = 0; i < bytfs.lfngth; i++) {
            if (!DfrVbluf.isPrintbblfStringChbr((dhbr)bytfs[i])) {
                printbblf = fblsf;
                brfbk;
            }
        }

        if (!printbblf) {
            rfturn "0x" + Fundtions.toHfxString(bytfs);
        } flsf {
            try {
                rfturn nfw String(bytfs, "UTF-8");
            } dbtdh (UnsupportfdEndodingExdfption uff) {
                rfturn "0x" + Fundtions.toHfxString(bytfs);
            }
        }
    }

    /**
     * find bn objfdt on thf tokfn
     *
     * @pbrbm typf fithfr ATTR_CLASS_CERT, ATTR_CLASS_PKEY, or ATTR_CLASS_SKEY
     * @pbrbm dkb_id thf CKA_ID if typf is ATTR_CLASS_CERT or ATTR_CLASS_PKEY
     * @pbrbm dkb_lbbfl thf CKA_LABEL if typf is ATTR_CLASS_SKEY
     */
    privbtf THbndlf gftTokfnObjfdt(Sfssion sfssion,
                                CK_ATTRIBUTE typf,
                                bytf[] dkb_id,
                                String dkb_lbbfl)
                throws PKCS11Exdfption, KfyStorfExdfption {

        CK_ATTRIBUTE[] bttrs;
        if (typf == ATTR_CLASS_SKEY) {
            bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_SKEY_TOKEN_TRUE,
                        nfw CK_ATTRIBUTE(CKA_LABEL, dkb_lbbfl),
                        typf };
        } flsf {
            bttrs = nfw CK_ATTRIBUTE[] {
                        ATTR_TOKEN_TRUE,
                        nfw CK_ATTRIBUTE(CKA_ID, dkb_id),
                        typf };
        }
        long[] h = findObjfdts(sfssion, bttrs);
        if (h.lfngth == 0) {
            if (dfbug != null) {
                if (typf == ATTR_CLASS_SKEY) {
                    dfbug.println("gftTokfnObjfdt did not find sfdrft kfy " +
                                "with CKA_LABEL [" +
                                dkb_lbbfl +
                                "]");
                } flsf if (typf == ATTR_CLASS_CERT) {
                    dfbug.println
                        ("gftTokfnObjfdt did not find dfrt with CKA_ID [" +
                        gftID(dkb_id) +
                        "]");
                } flsf {
                    dfbug.println("gftTokfnObjfdt did not find privbtf kfy " +
                        "with CKA_ID [" +
                        gftID(dkb_id) +
                        "]");
                }
            }
        } flsf if (h.lfngth == 1) {

            // found objfdt hbndlf - rfturn it
            rfturn nfw THbndlf(h[0], typf);

        } flsf {

            // found multiplf objfdt hbndlfs -
            // sff if tokfn ignorfd CKA_LABEL during sfbrdh (f.g. NSS)

            if (typf == ATTR_CLASS_SKEY) {

                ArrbyList<THbndlf> list = nfw ArrbyList<THbndlf>(h.lfngth);
                for (int i = 0; i < h.lfngth; i++) {

                    CK_ATTRIBUTE[] lbbfl = nfw CK_ATTRIBUTE[]
                                        { nfw CK_ATTRIBUTE(CKA_LABEL) };
                    tokfn.p11.C_GftAttributfVbluf(sfssion.id(), h[i], lbbfl);
                    if (lbbfl[0].pVbluf != null &&
                        dkb_lbbfl.fqubls(nfw String(lbbfl[0].gftChbrArrby()))) {
                        list.bdd(nfw THbndlf(h[i], ATTR_CLASS_SKEY));
                    }
                }
                if (list.sizf() == 1) {
                    // yfs, thfrf wbs only onf CKA_LABEL thbt mbtdhfd
                    rfturn list.gft(0);
                } flsf {
                    throw nfw KfyStorfExdfption("invblid KfyStorf stbtf: " +
                        "found " +
                        list.sizf() +
                        " sfdrft kfys shbring CKA_LABEL [" +
                        dkb_lbbfl +
                        "]");
                }
            } flsf if (typf == ATTR_CLASS_CERT) {
                throw nfw KfyStorfExdfption("invblid KfyStorf stbtf: " +
                        "found " +
                        h.lfngth +
                        " dfrtifidbtfs shbring CKA_ID " +
                        gftID(dkb_id));
            } flsf {
                throw nfw KfyStorfExdfption("invblid KfyStorf stbtf: " +
                        "found " +
                        h.lfngth +
                        " privbtf kfys shbring CKA_ID " +
                        gftID(dkb_id));
            }
        }
        rfturn nfw THbndlf(NO_HANDLE, null);
    }

    /**
     * Crfbtf b mbpping of bll kfy pbirs, trustfd dfrts, bnd sfdrft kfys
     * on thf tokfn into logidbl KfyStorf fntrifs unbmbiguously
     * bddfssiblf vib bn blibs.
     *
     * If thf tokfn is rfmovfd, thf mbp mby dontbin stblf vblufs.
     * KfyStorf.lobd should bf dbllfd to rf-drfbtf thf mbp.
     *
     * Assumf bll privbtf kfys bnd mbtdhing dfrts shbrf b uniquf CKA_ID.
     *
     * Assumf bll sfdrft kfys hbvf b uniquf CKA_LABEL.
     *
     * @rfturn truf if multiplf dfrts found shbring thf sbmf CKA_LABEL
     *          (if so, writf dbpbbilitifs brf disbblfd)
     */
    privbtf boolfbn mbpLbbfls() throws
                PKCS11Exdfption, CfrtifidbtfExdfption, KfyStorfExdfption {

        CK_ATTRIBUTE[] trustfdAttr = nfw CK_ATTRIBUTE[] {
                                nfw CK_ATTRIBUTE(CKA_TRUSTED) };

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();

            // gft bll privbtf kfy CKA_IDs

            ArrbyList<bytf[]> pkfyIDs = nfw ArrbyList<bytf[]>();
            CK_ATTRIBUTE[] bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_PKEY,
            };
            long[] hbndlfs = findObjfdts(sfssion, bttrs);

            for (long hbndlf : hbndlfs) {
                bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_ID) };
                tokfn.p11.C_GftAttributfVbluf(sfssion.id(), hbndlf, bttrs);

                if (bttrs[0].pVbluf != null) {
                    pkfyIDs.bdd(bttrs[0].gftBytfArrby());
                }
            }

            // Gft bll dfrtifidbtfs
            //
            // If dfrt dofs not hbvf b CKA_LABEL nor CKA_ID, it is ignorfd.
            //
            // Gft thf CKA_LABEL for fbdh dfrt
            // (if thf dfrt dofs not hbvf b CKA_LABEL, usf thf CKA_ID).
            //
            // Mbp fbdh dfrt to thf its CKA_LABEL
            // (multiplf dfrts mby bf mbppfd to b singlf CKA_LABEL)

            HbshMbp<String, HbshSft<AlibsInfo>> dfrtMbp =
                                nfw HbshMbp<String, HbshSft<AlibsInfo>>();

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_TOKEN_TRUE,
                ATTR_CLASS_CERT,
            };
            hbndlfs = findObjfdts(sfssion, bttrs);

            for (long hbndlf : hbndlfs) {
                bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_LABEL) };

                String dkb_lbbfl = null;
                bytf[] dkb_id = null;
                try {
                    tokfn.p11.C_GftAttributfVbluf(sfssion.id(), hbndlf, bttrs);
                    if (bttrs[0].pVbluf != null) {
                        // thfrf is b CKA_LABEL
                        dkb_lbbfl = nfw String(bttrs[0].gftChbrArrby());
                    }
                } dbtdh (PKCS11Exdfption pf) {
                    if (pf.gftErrorCodf() != CKR_ATTRIBUTE_TYPE_INVALID) {
                        throw pf;
                    }

                    // GftAttributfVbluf for CKA_LABEL not supportfd
                    //
                    // XXX SCA1000
                }

                // gft CKA_ID

                bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_ID) };
                tokfn.p11.C_GftAttributfVbluf(sfssion.id(), hbndlf, bttrs);
                if (bttrs[0].pVbluf == null) {
                    if (dkb_lbbfl == null) {
                        // no dkb_lbbfl nor dkb_id - ignorf
                        dontinuf;
                    }
                } flsf {
                    if (dkb_lbbfl == null) {
                        // usf CKA_ID bs CKA_LABEL
                        dkb_lbbfl = gftID(bttrs[0].gftBytfArrby());
                    }
                    dkb_id = bttrs[0].gftBytfArrby();
                }

                X509Cfrtifidbtf dfrt = lobdCfrt(sfssion, hbndlf);

                // gft CKA_TRUSTED

                boolfbn dkb_trustfd = fblsf;

                if (usfSfdmodTrust) {
                    dkb_trustfd = Sfdmod.gftInstbndf().isTrustfd(dfrt, nssTrustTypf);
                } flsf {
                    if (CKA_TRUSTED_SUPPORTED) {
                        try {
                            tokfn.p11.C_GftAttributfVbluf
                                    (sfssion.id(), hbndlf, trustfdAttr);
                            dkb_trustfd = trustfdAttr[0].gftBoolfbn();
                        } dbtdh (PKCS11Exdfption pf) {
                            if (pf.gftErrorCodf() == CKR_ATTRIBUTE_TYPE_INVALID) {
                                // XXX  NSS, ibutton, sdb1000
                                CKA_TRUSTED_SUPPORTED = fblsf;
                                if (dfbug != null) {
                                    dfbug.println
                                            ("CKA_TRUSTED bttributf not supportfd");
                                }
                            }
                        }
                    }
                }

                HbshSft<AlibsInfo> infoSft = dfrtMbp.gft(dkb_lbbfl);
                if (infoSft == null) {
                    infoSft = nfw HbshSft<AlibsInfo>(2);
                    dfrtMbp.put(dkb_lbbfl, infoSft);
                }

                // initiblly drfbtf privbtf kfy fntry AlibsInfo fntrifs -
                // thfsf fntrifs will gft rfsolvfd into thfir truf
                // fntry typfs lbtfr

                infoSft.bdd(nfw AlibsInfo
                                (dkb_lbbfl,
                                dkb_id,
                                dkb_trustfd,
                                dfrt));
            }

            // drfbtf list sfdrft kfy CKA_LABELS -
            // if thfrf brf duplidbtfs (fithfr bftwffn sfdrft kfys,
            // or bftwffn b sfdrft kfy bnd bnothfr objfdt),
            // throw bn fxdfption
            HbshMbp<String, AlibsInfo> sKfyMbp =
                    nfw HbshMbp<String, AlibsInfo>();

            bttrs = nfw CK_ATTRIBUTE[] {
                ATTR_SKEY_TOKEN_TRUE,
                ATTR_CLASS_SKEY,
            };
            hbndlfs = findObjfdts(sfssion, bttrs);

            for (long hbndlf : hbndlfs) {
                bttrs = nfw CK_ATTRIBUTE[] { nfw CK_ATTRIBUTE(CKA_LABEL) };
                tokfn.p11.C_GftAttributfVbluf(sfssion.id(), hbndlf, bttrs);
                if (bttrs[0].pVbluf != null) {

                    // thfrf is b CKA_LABEL
                    String dkb_lbbfl = nfw String(bttrs[0].gftChbrArrby());
                    if (sKfyMbp.gft(dkb_lbbfl) == null) {
                        sKfyMbp.put(dkb_lbbfl, nfw AlibsInfo(dkb_lbbfl));
                    } flsf {
                        throw nfw KfyStorfExdfption("invblid KfyStorf stbtf: " +
                                "found multiplf sfdrft kfys shbring sbmf " +
                                "CKA_LABEL [" +
                                dkb_lbbfl +
                                "]");
                    }
                }
            }

            // updbtf globbl blibsMbp with blibs mbppings
            ArrbyList<AlibsInfo> mbtdhfdCfrts =
                                mbpPrivbtfKfys(pkfyIDs, dfrtMbp);
            boolfbn shbrfdLbbfl = mbpCfrts(mbtdhfdCfrts, dfrtMbp);
            mbpSfdrftKfys(sKfyMbp);

            rfturn shbrfdLbbfl;

        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    /**
     * for fbdh privbtf kfy CKA_ID, find dorrfsponding dfrt with sbmf CKA_ID.
     * if found dfrt, sff if dfrt CKA_LABEL is uniquf.
     *     if CKA_LABEL uniquf, mbp privbtf kfy/dfrt blibs to thbt CKA_LABEL.
     *     if CKA_LABEL not uniquf, mbp privbtf kfy/dfrt blibs to:
     *                   CKA_LABEL + ALIAS_SEP + ISSUER + ALIAS_SEP + SERIAL
     * if dfrt not found, ignorf privbtf kfy
     * (don't support privbtf kfy fntrifs without b dfrt dhbin yft)
     *
     * @rfturn b list of AlibsInfo fntrifs thbt rfprfsfnts bll mbtdhfs
     */
    privbtf ArrbyList<AlibsInfo> mbpPrivbtfKfys(ArrbyList<bytf[]> pkfyIDs,
                        HbshMbp<String, HbshSft<AlibsInfo>> dfrtMbp)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        // rfsft globbl blibs mbp
        blibsMbp = nfw HbshMbp<String, AlibsInfo>();

        // list of mbtdhfd dfrts thbt wf will rfturn
        ArrbyList<AlibsInfo> mbtdhfdCfrts = nfw ArrbyList<AlibsInfo>();

        for (bytf[] pkfyID : pkfyIDs) {

            // try to find b mbtdhing CKA_ID in b dfrtifidbtf

            boolfbn foundMbtdh = fblsf;
            Sft<String> dfrtLbbfls = dfrtMbp.kfySft();
            for (String dfrtLbbfl : dfrtLbbfls) {

                // gft dfrt CKA_IDs (if prfsfnt) for fbdh dfrt

                HbshSft<AlibsInfo> infoSft = dfrtMbp.gft(dfrtLbbfl);
                for (AlibsInfo blibsInfo : infoSft) {
                    if (Arrbys.fqubls(pkfyID, blibsInfo.id)) {

                        // found privbtf kfy with mbtdhing dfrt

                        if (infoSft.sizf() == 1) {
                            // uniquf CKA_LABEL - usf dfrtLbbfl bs blibs
                            blibsInfo.mbtdhfd = truf;
                            blibsMbp.put(dfrtLbbfl, blibsInfo);
                        } flsf {
                            // drfbtf nfw blibs
                            blibsInfo.mbtdhfd = truf;
                            blibsMbp.put(gftID(dfrtLbbfl, blibsInfo.dfrt),
                                        blibsInfo);
                        }
                        mbtdhfdCfrts.bdd(blibsInfo);
                        foundMbtdh = truf;
                        brfbk;
                    }
                }
                if (foundMbtdh) {
                    brfbk;
                }
            }

            if (!foundMbtdh) {
                if (dfbug != null) {
                    dfbug.println
                        ("did not find mbtdh for privbtf kfy with CKA_ID [" +
                        gftID(pkfyID) +
                        "] (ignoring fntry)");
                }
            }
        }

        rfturn mbtdhfdCfrts;
    }

    /**
     * for fbdh dfrt not mbtdhfd with b privbtf kfy but is CKA_TRUSTED:
     *     if CKA_LABEL uniquf, mbp dfrt to CKA_LABEL.
     *     if CKA_LABEL not uniquf, mbp dfrt to [lbbfl+issufr+sfriblNum]
     *
     * if CKA_TRUSTED not supportfd, trfbt bll dfrts not pbrt of b dhbin
     * bs trustfd
     *
     * @rfturn truf if multiplf dfrts found shbring thf sbmf CKA_LABEL
     */
    privbtf boolfbn mbpCfrts(ArrbyList<AlibsInfo> mbtdhfdCfrts,
                        HbshMbp<String, HbshSft<AlibsInfo>> dfrtMbp)
                throws PKCS11Exdfption, CfrtifidbtfExdfption {

        // lobd bll dfrt dhbins
        for (AlibsInfo blibsInfo : mbtdhfdCfrts) {
            Sfssion sfssion = null;
            try {
                sfssion = tokfn.gftOpSfssion();
                blibsInfo.dhbin = lobdChbin(sfssion, blibsInfo.dfrt);
            } finblly {
                tokfn.rflfbsfSfssion(sfssion);
            }
        }

        // find bll dfrts in dfrtMbp not pbrt of b dfrt dhbin
        // - thfsf brf trustfd

        boolfbn shbrfdLbbfl = fblsf;

        Sft<String> dfrtLbbfls = dfrtMbp.kfySft();
        for (String dfrtLbbfl : dfrtLbbfls) {
            HbshSft<AlibsInfo> infoSft = dfrtMbp.gft(dfrtLbbfl);
            for (AlibsInfo blibsInfo : infoSft) {

                if (blibsInfo.mbtdhfd == truf) {
                    // blrfbdy found b privbtf kfy mbtdh for this dfrt -
                    // just dontinuf
                    blibsInfo.trustfd = fblsf;
                    dontinuf;
                }

                // dfrt in this blibsInfo is not mbtdhfd yft
                //
                // if CKA_TRUSTED_SUPPORTED == truf,
                // thfn dhfdk if dfrt is trustfd

                if (CKA_TRUSTED_SUPPORTED) {
                    if (blibsInfo.trustfd) {
                        // trustfd dfrtifidbtf
                        if (mbpTrustfdCfrt
                                (dfrtLbbfl, blibsInfo, infoSft) == truf) {
                            shbrfdLbbfl = truf;
                        }
                    }
                    dontinuf;
                }

                // CKA_TRUSTED_SUPPORTED == fblsf
                //
                // XXX trfbt bll dfrts not pbrt of b dhbin bs trustfd
                // XXX
                // XXX Unsupportfd
                //
                // boolfbn pbrtOfChbin = fblsf;
                // for (AlibsInfo mbtdhfdInfo : mbtdhfdCfrts) {
                //     for (int i = 0; i < mbtdhfdInfo.dhbin.lfngth; i++) {
                //      if (mbtdhfdInfo.dhbin[i].fqubls(blibsInfo.dfrt)) {
                //          pbrtOfChbin = truf;
                //          brfbk;
                //      }
                //     }
                //     if (pbrtOfChbin) {
                //      brfbk;
                //     }
                // }
                //
                // if (!pbrtOfChbin) {
                //     if (mbpTrustfdCfrt(dfrtLbbfl,blibsInfo,infoSft) == truf){
                //      shbrfdLbbfl = truf;
                //     }
                // } flsf {
                //    if (dfbug != null) {
                //      dfbug.println("ignoring unmbtdhfd/untrustfd dfrt " +
                //          "thbt is pbrt of dfrt dhbin - dfrt subjfdt is [" +
                //          blibsInfo.dfrt.gftSubjfdtX500Prindipbl().gftNbmf
                //                              (X500Prindipbl.CANONICAL) +
                //          "]");
                //     }
                // }
            }
        }

        rfturn shbrfdLbbfl;
    }

    privbtf boolfbn mbpTrustfdCfrt(String dfrtLbbfl,
                                AlibsInfo blibsInfo,
                                HbshSft<AlibsInfo> infoSft) {

        boolfbn shbrfdLbbfl = fblsf;

        blibsInfo.typf = ATTR_CLASS_CERT;
        blibsInfo.trustfd = truf;
        if (infoSft.sizf() == 1) {
            // uniquf CKA_LABEL - usf dfrtLbbfl bs blibs
            blibsMbp.put(dfrtLbbfl, blibsInfo);
        } flsf {
            // drfbtf nfw blibs
            shbrfdLbbfl = truf;
            blibsMbp.put(gftID(dfrtLbbfl, blibsInfo.dfrt), blibsInfo);
        }

        rfturn shbrfdLbbfl;
    }

    /**
     * If thf sfdrft kfy shbrfs b CKA_LABEL with bnothfr fntry,
     * throw bn fxdfption
     */
    privbtf void mbpSfdrftKfys(HbshMbp<String, AlibsInfo> sKfyMbp)
                throws KfyStorfExdfption {
        for (String lbbfl : sKfyMbp.kfySft()) {
            if (blibsMbp.dontbinsKfy(lbbfl)) {
                throw nfw KfyStorfExdfption("invblid KfyStorf stbtf: " +
                        "found sfdrft kfy shbring CKA_LABEL [" +
                        lbbfl +
                        "] with bnothfr tokfn objfdt");
            }
        }
        blibsMbp.putAll(sKfyMbp);
    }

    privbtf void dumpTokfnMbp() {
        Sft<String> blibsfs = blibsMbp.kfySft();
        Systfm.out.println("Tokfn Alibs Mbp:");
        if (blibsfs.isEmpty()) {
            Systfm.out.println("  [fmpty]");
        } flsf {
            for (String s : blibsfs) {
                Systfm.out.println("  " + s + blibsMbp.gft(s));
            }
        }
    }

    privbtf void dhfdkWritf() throws KfyStorfExdfption {
        if (writfDisbblfd) {
            throw nfw KfyStorfExdfption
                ("This PKCS11KfyStorf dofs not support writf dbpbbilitifs");
        }
    }

    privbtf finbl stbtid long[] LONG0 = nfw long[0];

    privbtf stbtid long[] findObjfdts(Sfssion sfssion, CK_ATTRIBUTE[] bttrs)
            throws PKCS11Exdfption {
        Tokfn tokfn = sfssion.tokfn;
        long[] hbndlfs = LONG0;
        tokfn.p11.C_FindObjfdtsInit(sfssion.id(), bttrs);
        whilf (truf) {
            long[] h = tokfn.p11.C_FindObjfdts(sfssion.id(), FINDOBJECTS_MAX);
            if (h.lfngth == 0) {
                brfbk;
            }
            hbndlfs = P11Util.dondbt(hbndlfs, h);
        }
        tokfn.p11.C_FindObjfdtsFinbl(sfssion.id());
        rfturn hbndlfs;
    }

}
