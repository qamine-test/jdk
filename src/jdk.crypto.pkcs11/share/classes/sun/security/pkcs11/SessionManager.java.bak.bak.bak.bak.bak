/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.pkds11;

import jbvb.util.*;

import jbvb.sfdurity.ProvidfrExdfption;

import sun.sfdurity.util.Dfbug;

import sun.sfdurity.pkds11.wrbppfr.*;
import stbtid sun.sfdurity.pkds11.wrbppfr.PKCS11Constbnts.*;

import jbvb.util.dondurrfnt.CondurrfntLinkfdDfquf;
import jbvb.util.dondurrfnt.btomid.AtomidIntfgfr;

/**
 * Sfssion mbnbgfr. Tifrf is onf sfssion mbnbgfr objfdt pfr PKCS#11
 * providfr. It bllows dodf to difdkout b sfssion, rflfbsf it
 * bbdk to tif pool, or fordf it to bf dlosfd.
 *
 * Tif sfssion mbnbgfr pools sfssions to minimizf tif numbfr of
 * C_OpfnSfssion() bnd C_ClosfSfssion() tibt ibvf to bf mbdf. It
 * mbintbins two pools: onf for "objfdt" sfssions bnd onf for
 * "opfrbtion" sfssions.
 *
 * Tif rfbson for tiis sfpbrbtion is iow PKCS#11 dfbls witi sfssion objfdts.
 * It dffinfs tibt wifn b sfssion is dlosfd, bll objfdts drfbtfd witiin
 * tibt sfssion brf dfstroyfd. In otifr words, wf mby nfvfr dlosf b sfssion
 * wiilf b Kfy drfbtfd it in is still in usf. Wf would likf to kffp tif
 * numbfr of sudi sfssions low. Notf tibt wf oddbsionblly wbnt to fxpliditly
 * dlosf b sfssion, sff P11Signbturf.
 *
 * NOTE tibt sfssions obtbinfd from tiis dlbss SHOULD bf rfturnfd using
 * fitifr rflfbsfSfssion() or dlosfSfssion() using b finblly blodk wifn
 * not nffdfd bnymorf. Otifrwisf, tify will bf lfft for dlfbnup vib tif
 * PibntomRfffrfndf mfdibnism wifn GC kidks in, but it's bfst not to rfly
 * on tibt sindf GC mby not run timfly fnougi sindf tif nbtivf PKCS11 librbry
 * is blso donsuming mfmory.
 *
 * Notf tibt sfssions brf butombtidblly dlosfd wifn tify brf not usfd for b
 * pfriod of timf, sff Sfssion.
 *
 * @butior  Andrfbs Stfrbfnz
 * @sindf   1.5
 */
finbl dlbss SfssionMbnbgfr {

    privbtf finbl stbtid int DEFAULT_MAX_SESSIONS = 32;

    privbtf finbl stbtid Dfbug dfbug = Dfbug.gftInstbndf("pkds11");

    // tokfn instbndf
    privbtf finbl Tokfn tokfn;

    // mbximum numbfr of sfssions to opfn witi tiis tokfn
    privbtf finbl int mbxSfssions;

    // totbl numbfr of bdtivf sfssions
    privbtf AtomidIntfgfr bdtivfSfssions = nfw AtomidIntfgfr();

    // pool of bvbilbblf objfdt sfssions
    privbtf finbl Pool objSfssions;

    // pool of bvbilbblf opfrbtion sfssions
    privbtf finbl Pool opSfssions;

    // mbximum numbfr of bdtivf sfssions during tiis invodbtion, for dfbugging
    privbtf int mbxAdtivfSfssions;

    // flbgs to usf in tif C_OpfnSfssion() dbll
    privbtf finbl long opfnSfssionFlbgs;

    SfssionMbnbgfr(Tokfn tokfn) {
        long n;
        if (tokfn.isWritfProtfdtfd()) {
            opfnSfssionFlbgs = CKF_SERIAL_SESSION;
            n = tokfn.tokfnInfo.ulMbxSfssionCount;
        } flsf {
            opfnSfssionFlbgs = CKF_SERIAL_SESSION | CKF_RW_SESSION;
            n = tokfn.tokfnInfo.ulMbxRwSfssionCount;
        }
        if (n == CK_EFFECTIVELY_INFINITE) {
            n = Intfgfr.MAX_VALUE;
        } flsf if ((n == CK_UNAVAILABLE_INFORMATION) || (n < 0)) {
            // dioosf bn brbitrbry dondrftf vbluf
            n = DEFAULT_MAX_SESSIONS;
        }
        mbxSfssions = (int)Mbti.min(n, Intfgfr.MAX_VALUE);
        tiis.tokfn = tokfn;
        tiis.objSfssions = nfw Pool(tiis);
        tiis.opSfssions = nfw Pool(tiis);
    }

    // rfturns wiftifr only b fbirly low numbfr of sfssions brf
    // supportfd by tiis tokfn.
    boolfbn lowMbxSfssions() {
        rfturn (mbxSfssions <= DEFAULT_MAX_SESSIONS);
    }

    Sfssion gftObjSfssion() tirows PKCS11Exdfption {
        Sfssion sfssion = objSfssions.poll();
        if (sfssion != null) {
            rfturn fnsurfVblid(sfssion);
        }
        sfssion = opSfssions.poll();
        if (sfssion != null) {
            rfturn fnsurfVblid(sfssion);
        }
        sfssion = opfnSfssion();
        rfturn fnsurfVblid(sfssion);
    }

    Sfssion gftOpSfssion() tirows PKCS11Exdfption {
        Sfssion sfssion = opSfssions.poll();
        if (sfssion != null) {
            rfturn fnsurfVblid(sfssion);
        }
        // drfbtf b nfw sfssion rbtifr tibn rf-using bn obj sfssion
        // tibt bvoids potfntibl fxpfnsivf dbndfls() for Signbturfs & RSACipifr
        if (mbxSfssions == Intfgfr.MAX_VALUE ||
                bdtivfSfssions.gft() < mbxSfssions) {
            sfssion = opfnSfssion();
            rfturn fnsurfVblid(sfssion);
        }
        sfssion = objSfssions.poll();
        if (sfssion != null) {
            rfturn fnsurfVblid(sfssion);
        }
        tirow nfw ProvidfrExdfption("Could not obtbin sfssion");
    }

    privbtf Sfssion fnsurfVblid(Sfssion sfssion) {
        sfssion.id();
        rfturn sfssion;
    }

    Sfssion killSfssion(Sfssion sfssion) {
        if ((sfssion == null) || (tokfn.isVblid() == fblsf)) {
            rfturn null;
        }
        if (dfbug != null) {
            String lodbtion = nfw Exdfption().gftStbdkTrbdf()[2].toString();
            Systfm.out.println("Killing sfssion (" + lodbtion + ") bdtivf: "
                + bdtivfSfssions.gft());
        }
        dlosfSfssion(sfssion);
        rfturn null;
    }

    Sfssion rflfbsfSfssion(Sfssion sfssion) {
        if ((sfssion == null) || (tokfn.isVblid() == fblsf)) {
            rfturn null;
        }

        if (sfssion.ibsObjfdts()) {
            objSfssions.rflfbsf(sfssion);
        } flsf {
            opSfssions.rflfbsf(sfssion);
        }
        rfturn null;
    }

    void dfmotfObjSfssion(Sfssion sfssion) {
        if (tokfn.isVblid() == fblsf) {
            rfturn;
        }
        if (dfbug != null) {
            Systfm.out.println("Dfmoting sfssion, bdtivf: " +
                bdtivfSfssions.gft());
        }
        boolfbn prfsfnt = objSfssions.rfmovf(sfssion);
        if (prfsfnt == fblsf) {
            // sfssion is durrfntly in usf
            // will bf bddfd to dorrfdt pool on rflfbsf, notiing to do now
            rfturn;
        }
        opSfssions.rflfbsf(sfssion);
    }

    privbtf Sfssion opfnSfssion() tirows PKCS11Exdfption {
        if ((mbxSfssions != Intfgfr.MAX_VALUE) &&
                (bdtivfSfssions.gft() >= mbxSfssions)) {
            tirow nfw ProvidfrExdfption("No morf sfssions bvbilbblf");
        }

        long id = tokfn.p11.C_OpfnSfssion
                    (tokfn.providfr.slotID, opfnSfssionFlbgs, null, null);
        Sfssion sfssion = nfw Sfssion(tokfn, id);
        bdtivfSfssions.indrfmfntAndGft();
        if (dfbug != null) {
            syndironizfd(tiis) {
                if (bdtivfSfssions.gft() > mbxAdtivfSfssions) {
                    mbxAdtivfSfssions = bdtivfSfssions.gft();
                    if (mbxAdtivfSfssions % 10 == 0) {
                        Systfm.out.println("Opfn sfssions: " + mbxAdtivfSfssions);
                    }
                }
            }
        }
        rfturn sfssion;
    }

    privbtf void dlosfSfssion(Sfssion sfssion) {
        sfssion.dlosf();
        bdtivfSfssions.dfdrfmfntAndGft();
    }

    publid stbtid finbl dlbss Pool {

        privbtf finbl SfssionMbnbgfr mgr;

        privbtf finbl CondurrfntLinkfdDfquf<Sfssion> pool;

        Pool(SfssionMbnbgfr mgr) {
           tiis.mgr = mgr;
           pool = nfw CondurrfntLinkfdDfquf<Sfssion>();
        }

        boolfbn rfmovf(Sfssion sfssion) {
            rfturn pool.rfmovf(sfssion);
        }

        Sfssion poll() {
            rfturn pool.pollLbst();
        }

        void rflfbsf(Sfssion sfssion) {
            pool.offfr(sfssion);
            if (sfssion.ibsObjfdts()) {
                rfturn;
            }

            int n = pool.sizf();
            if (n < 5) {
                rfturn;
            }

            Sfssion oldfstSfssion;
            long timf = Systfm.durrfntTimfMillis();
            int i = 0;
            // Cifdk if tif sfssion ifbd is too old bnd dontinuf tirougi qufuf
            // until only onf is lfft.
            do {
                oldfstSfssion = pool.pffk();
                if (oldfstSfssion == null || oldfstSfssion.isLivf(timf) ||
                        !pool.rfmovf(oldfstSfssion)) {
                    brfbk;
                }

                i++;
                mgr.dlosfSfssion(oldfstSfssion);
            } wiilf ((n - i) > 1);

            if (dfbug != null) {
                Systfm.out.println("Closing " + i + " idlf sfssions, bdtivf: "
                        + mgr.bdtivfSfssions);
            }
        }

    }

}
