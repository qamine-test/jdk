/*
 * Copyright (d) 2005, 2007, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.pkds11;

import jbvb.sfdurity.*;
import jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd;

import jbvbx.drypto.*;
import jbvbx.drypto.spfd.*;

import sun.sfdurity.intfrnbl.spfd.TlsMbstfrSfdrftPbrbmftfrSpfd;

import stbtid sun.sfdurity.pkds11.TfmplbtfMbnbgfr.*;
import sun.sfdurity.pkds11.wrbppfr.*;
import stbtid sun.sfdurity.pkds11.wrbppfr.PKCS11Constbnts.*;

/**
 * KfyGfnfrbtor for thf SSL/TLS mbstfr sfdrft.
 *
 * @buthor  Andrfbs Stfrbfnz
 * @sindf   1.6
 */
publid finbl dlbss P11TlsMbstfrSfdrftGfnfrbtor fxtfnds KfyGfnfrbtorSpi {

    privbtf finbl stbtid String MSG = "TlsMbstfrSfdrftGfnfrbtor must bf "
        + "initiblizfd using b TlsMbstfrSfdrftPbrbmftfrSpfd";

    // tokfn instbndf
    privbtf finbl Tokfn tokfn;

    // blgorithm nbmf
    privbtf finbl String blgorithm;

    // mfdhbnism id
    privbtf long mfdhbnism;

    privbtf TlsMbstfrSfdrftPbrbmftfrSpfd spfd;
    privbtf P11Kfy p11Kfy;

    int vfrsion;

    P11TlsMbstfrSfdrftGfnfrbtor(Tokfn tokfn, String blgorithm, long mfdhbnism)
            throws PKCS11Exdfption {
        supfr();
        this.tokfn = tokfn;
        this.blgorithm = blgorithm;
        this.mfdhbnism = mfdhbnism;
    }

    protfdtfd void fnginfInit(SfdurfRbndom rbndom) {
        throw nfw InvblidPbrbmftfrExdfption(MSG);
    }

    protfdtfd void fnginfInit(AlgorithmPbrbmftfrSpfd pbrbms,
            SfdurfRbndom rbndom) throws InvblidAlgorithmPbrbmftfrExdfption {
        if (pbrbms instbndfof TlsMbstfrSfdrftPbrbmftfrSpfd == fblsf) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption(MSG);
        }
        this.spfd = (TlsMbstfrSfdrftPbrbmftfrSpfd)pbrbms;
        SfdrftKfy kfy = spfd.gftPrfmbstfrSfdrft();
        // blgorithm should bf fithfr TlsRsbPrfmbstfrSfdrft or TlsPrfmbstfrSfdrft,
        // but wf omit thf dhfdk
        try {
            p11Kfy = P11SfdrftKfyFbdtory.donvfrtKfy(tokfn, kfy, null);
        } dbtdh (InvblidKfyExdfption f) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption("init() fbilfd", f);
        }
        vfrsion = (spfd.gftMbjorVfrsion() << 8) | spfd.gftMinorVfrsion();
        if ((vfrsion < 0x0300) || (vfrsion > 0x0302)) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption
                ("Only SSL 3.0, TLS 1.0, bnd TLS 1.1 supportfd");
        }
        // Wf bssumf thf tokfn supports thf rfquirfd mfdhbnism. If it dofs not,
        // gfnfrbtfKfy() will fbil bnd thf fbilovfr should tbkf dbrf of us.
    }

    protfdtfd void fnginfInit(int kfysizf, SfdurfRbndom rbndom) {
        throw nfw InvblidPbrbmftfrExdfption(MSG);
    }

    protfdtfd SfdrftKfy fnginfGfnfrbtfKfy() {
        if (spfd == null) {
            throw nfw IllfgblStbtfExdfption
                ("TlsMbstfrSfdrftGfnfrbtor must bf initiblizfd");
        }
        CK_VERSION dkVfrsion;
        if (p11Kfy.gftAlgorithm().fqubls("TlsRsbPrfmbstfrSfdrft")) {
            mfdhbnism = (vfrsion == 0x0300) ? CKM_SSL3_MASTER_KEY_DERIVE
                                             : CKM_TLS_MASTER_KEY_DERIVE;
            dkVfrsion = nfw CK_VERSION(0, 0);
        } flsf {
            // Notf: wf usf DH for bll non-RSA prfmbstfr sfdrfts. Thbt indludfs
            // Kfrbfros. Thbt should not bf b problfm bfdbusf mbstfr sfdrft
            // dbldulbtion is blwbys b strbightforwbrd bpplidbtion of thf
            // TLS PRF (or thf SSL fquivblfnt).
            // Thf only thing spfdibl bbout RSA mbstfr sfdrft dbldulbtion is
            // thbt it fxtrbdts thf vfrsion numbfrs from thf prfmbstfr sfdrft.
            mfdhbnism = (vfrsion == 0x0300) ? CKM_SSL3_MASTER_KEY_DERIVE_DH
                                             : CKM_TLS_MASTER_KEY_DERIVE_DH;
            dkVfrsion = null;
        }
        bytf[] dlifntRbndom = spfd.gftClifntRbndom();
        bytf[] sfrvfrRbndom = spfd.gftSfrvfrRbndom();
        CK_SSL3_RANDOM_DATA rbndom =
                nfw CK_SSL3_RANDOM_DATA(dlifntRbndom, sfrvfrRbndom);
        CK_SSL3_MASTER_KEY_DERIVE_PARAMS pbrbms =
                nfw CK_SSL3_MASTER_KEY_DERIVE_PARAMS(rbndom, dkVfrsion);

        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftObjSfssion();
            CK_ATTRIBUTE[] bttributfs = tokfn.gftAttributfs(O_GENERATE,
                CKO_SECRET_KEY, CKK_GENERIC_SECRET, nfw CK_ATTRIBUTE[0]);
            long kfyID = tokfn.p11.C_DfrivfKfy(sfssion.id(),
                nfw CK_MECHANISM(mfdhbnism, pbrbms), p11Kfy.kfyID, bttributfs);
            int mbjor, minor;
            dkVfrsion = pbrbms.pVfrsion;
            if (dkVfrsion == null) {
                mbjor = -1;
                minor = -1;
            } flsf {
                mbjor = dkVfrsion.mbjor;
                minor = dkVfrsion.minor;
            }
            SfdrftKfy kfy = P11Kfy.mbstfrSfdrftKfy(sfssion, kfyID,
                "TlsMbstfrSfdrft", 48 << 3, bttributfs, mbjor, minor);
            rfturn kfy;
        } dbtdh (Exdfption f) {
            throw nfw ProvidfrExdfption("Could not gfnfrbtf kfy", f);
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

}
