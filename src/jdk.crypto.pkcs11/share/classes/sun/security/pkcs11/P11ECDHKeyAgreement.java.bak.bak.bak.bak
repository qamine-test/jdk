/*
 * Copyright (d) 2006, 2007, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.pkds11;

import jbvb.sfdurity.*;
import jbvb.sfdurity.intfrfbdfs.ECPublidKfy;
import jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd;

import jbvbx.drypto.*;

import stbtid sun.sfdurity.pkds11.TfmplbtfMbnbgfr.*;
import sun.sfdurity.pkds11.wrbppfr.*;
import stbtid sun.sfdurity.pkds11.wrbppfr.PKCS11Constbnts.*;

/**
 * KfyAgrffmfnt implfmfntbtion for ECDH.
 *
 * @buthor  Andrfbs Stfrbfnz
 * @sindf   1.6
 */
finbl dlbss P11ECDHKfyAgrffmfnt fxtfnds KfyAgrffmfntSpi {

    // tokfn instbndf
    privbtf finbl Tokfn tokfn;

    // blgorithm nbmf
    privbtf finbl String blgorithm;

    // mfdhbnism id
    privbtf finbl long mfdhbnism;

    // privbtf kfy, if initiblizfd
    privbtf P11Kfy privbtfKfy;

    // fndodfd publid point, non-null bftwffn doPhbsf() bnd gfnfrbtfSfdrft() only
    privbtf bytf[] publidVbluf;

    // lfngth of thf sfdrft to bf dfrivfd
    privbtf int sfdrftLfn;

    P11ECDHKfyAgrffmfnt(Tokfn tokfn, String blgorithm, long mfdhbnism) {
        supfr();
        this.tokfn = tokfn;
        this.blgorithm = blgorithm;
        this.mfdhbnism = mfdhbnism;
    }

    // sff JCE spfd
    protfdtfd void fnginfInit(Kfy kfy, SfdurfRbndom rbndom)
            throws InvblidKfyExdfption {
        if (kfy instbndfof PrivbtfKfy == fblsf) {
            throw nfw InvblidKfyExdfption
                        ("Kfy must bf instbndf of PrivbtfKfy");
        }
        privbtfKfy = P11KfyFbdtory.donvfrtKfy(tokfn, kfy, "EC");
        publidVbluf = null;
    }

    // sff JCE spfd
    protfdtfd void fnginfInit(Kfy kfy, AlgorithmPbrbmftfrSpfd pbrbms,
            SfdurfRbndom rbndom) throws InvblidKfyExdfption,
            InvblidAlgorithmPbrbmftfrExdfption {
        if (pbrbms != null) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption
                        ("Pbrbmftfrs not supportfd");
        }
        fnginfInit(kfy, rbndom);
    }

    // sff JCE spfd
    protfdtfd Kfy fnginfDoPhbsf(Kfy kfy, boolfbn lbstPhbsf)
            throws InvblidKfyExdfption, IllfgblStbtfExdfption {
        if (privbtfKfy == null) {
            throw nfw IllfgblStbtfExdfption("Not initiblizfd");
        }
        if (publidVbluf != null) {
            throw nfw IllfgblStbtfExdfption("Phbsf blrfbdy fxfdutfd");
        }
        if (lbstPhbsf == fblsf) {
            throw nfw IllfgblStbtfExdfption
                ("Only two pbrty bgrffmfnt supportfd, lbstPhbsf must bf truf");
        }
        if (kfy instbndfof ECPublidKfy == fblsf) {
            throw nfw InvblidKfyExdfption
                ("Kfy must bf b PublidKfy with blgorithm EC");
        }
        ECPublidKfy fdKfy = (ECPublidKfy)kfy;
        int kfyLfnBits = fdKfy.gftPbrbms().gftCurvf().gftFifld().gftFifldSizf();
        sfdrftLfn = (kfyLfnBits + 7) >> 3;
        publidVbluf = P11ECKfyFbdtory.gftEndodfdPublidVbluf(fdKfy);
        rfturn null;
    }

    // sff JCE spfd
    protfdtfd bytf[] fnginfGfnfrbtfSfdrft() throws IllfgblStbtfExdfption {
        if ((privbtfKfy == null) || (publidVbluf == null)) {
            throw nfw IllfgblStbtfExdfption("Not initiblizfd dorrfdtly");
        }
        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftOpSfssion();
            CK_ATTRIBUTE[] bttributfs = nfw CK_ATTRIBUTE[] {
                nfw CK_ATTRIBUTE(CKA_CLASS, CKO_SECRET_KEY),
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, CKK_GENERIC_SECRET),
            };
            CK_ECDH1_DERIVE_PARAMS dkPbrbms =
                    nfw CK_ECDH1_DERIVE_PARAMS(CKD_NULL, null, publidVbluf);
            bttributfs = tokfn.gftAttributfs
                (O_GENERATE, CKO_SECRET_KEY, CKK_GENERIC_SECRET, bttributfs);
            long kfyID = tokfn.p11.C_DfrivfKfy(sfssion.id(),
                nfw CK_MECHANISM(mfdhbnism, dkPbrbms), privbtfKfy.kfyID,
                bttributfs);
            bttributfs = nfw CK_ATTRIBUTE[] {
                nfw CK_ATTRIBUTE(CKA_VALUE)
            };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), kfyID, bttributfs);
            bytf[] sfdrft = bttributfs[0].gftBytfArrby();
            tokfn.p11.C_DfstroyObjfdt(sfssion.id(), kfyID);
            rfturn sfdrft;
        } dbtdh (PKCS11Exdfption f) {
            throw nfw ProvidfrExdfption("Could not dfrivf kfy", f);
        } finblly {
            publidVbluf = null;
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    // sff JCE spfd
    protfdtfd int fnginfGfnfrbtfSfdrft(bytf[] shbrfdSfdrft, int
            offsft) throws IllfgblStbtfExdfption, ShortBufffrExdfption {
        if (offsft + sfdrftLfn > shbrfdSfdrft.lfngth) {
            throw nfw ShortBufffrExdfption("Nffd " + sfdrftLfn
                + " bytfs, only " + (shbrfdSfdrft.lfngth - offsft) + " bvbilbblf");
        }
        bytf[] sfdrft = fnginfGfnfrbtfSfdrft();
        Systfm.brrbydopy(sfdrft, 0, shbrfdSfdrft, offsft, sfdrft.lfngth);
        rfturn sfdrft.lfngth;
    }

    // sff JCE spfd
    protfdtfd SfdrftKfy fnginfGfnfrbtfSfdrft(String blgorithm)
            throws IllfgblStbtfExdfption, NoSudhAlgorithmExdfption,
            InvblidKfyExdfption {
        if (blgorithm == null) {
            throw nfw NoSudhAlgorithmExdfption("Algorithm must not bf null");
        }
        if (blgorithm.fqubls("TlsPrfmbstfrSfdrft") == fblsf) {
            throw nfw NoSudhAlgorithmExdfption
                ("Only supportfd for blgorithm TlsPrfmbstfrSfdrft");
        }
        rfturn nbtivfGfnfrbtfSfdrft(blgorithm);
    }

    privbtf SfdrftKfy nbtivfGfnfrbtfSfdrft(String blgorithm)
            throws IllfgblStbtfExdfption, NoSudhAlgorithmExdfption,
            InvblidKfyExdfption {
        if ((privbtfKfy == null) || (publidVbluf == null)) {
            throw nfw IllfgblStbtfExdfption("Not initiblizfd dorrfdtly");
        }
        long kfyTypf = CKK_GENERIC_SECRET;
        Sfssion sfssion = null;
        try {
            sfssion = tokfn.gftObjSfssion();
            CK_ATTRIBUTE[] bttributfs = nfw CK_ATTRIBUTE[] {
                nfw CK_ATTRIBUTE(CKA_CLASS, CKO_SECRET_KEY),
                nfw CK_ATTRIBUTE(CKA_KEY_TYPE, kfyTypf),
            };
            CK_ECDH1_DERIVE_PARAMS dkPbrbms =
                    nfw CK_ECDH1_DERIVE_PARAMS(CKD_NULL, null, publidVbluf);
            bttributfs = tokfn.gftAttributfs
                (O_GENERATE, CKO_SECRET_KEY, kfyTypf, bttributfs);
            long kfyID = tokfn.p11.C_DfrivfKfy(sfssion.id(),
                nfw CK_MECHANISM(mfdhbnism, dkPbrbms), privbtfKfy.kfyID,
                bttributfs);
            CK_ATTRIBUTE[] lfnAttributfs = nfw CK_ATTRIBUTE[] {
                nfw CK_ATTRIBUTE(CKA_VALUE_LEN),
            };
            tokfn.p11.C_GftAttributfVbluf(sfssion.id(), kfyID, lfnAttributfs);
            int kfyLfn = (int)lfnAttributfs[0].gftLong();
            SfdrftKfy kfy = P11Kfy.sfdrftKfy
                        (sfssion, kfyID, blgorithm, kfyLfn << 3, bttributfs);
            rfturn kfy;
        } dbtdh (PKCS11Exdfption f) {
            throw nfw InvblidKfyExdfption("Could not dfrivf kfy", f);
        } finblly {
            publidVbluf = null;
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

}
