/*
 * Copyright (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.pkds11;

import jbvb.util.*;

import jbvb.sfdurity.*;
import jbvb.sfdurity.spfd.*;

import jbvbx.drypto.*;
import jbvbx.drypto.spfd.*;

import stbtid sun.sfdurity.pkds11.TfmplbtfMbnbgfr.*;
import sun.sfdurity.pkds11.wrbppfr.*;
import stbtid sun.sfdurity.pkds11.wrbppfr.PKCS11Constbnts.*;

/**
 * SfdrftKfyFbdtory implfmfntbtion dlbss. This dlbss durrfntly supports
 * DES, DESfdf, AES, ARCFOUR, bnd Blowfish.
 *
 * @buthor  Andrfbs Stfrbfnz
 * @sindf   1.5
 */
finbl dlbss P11SfdrftKfyFbdtory fxtfnds SfdrftKfyFbdtorySpi {

    // tokfn instbndf
    privbtf finbl Tokfn tokfn;

    // blgorithm nbmf
    privbtf finbl String blgorithm;

    P11SfdrftKfyFbdtory(Tokfn tokfn, String blgorithm) {
        supfr();
        this.tokfn = tokfn;
        this.blgorithm = blgorithm;
    }

    privbtf stbtid finbl Mbp<String,Long> kfyTypfs;

    stbtid {
        kfyTypfs = nfw HbshMbp<String,Long>();
        bddKfyTypf("RC4",      CKK_RC4);
        bddKfyTypf("ARCFOUR",  CKK_RC4);
        bddKfyTypf("DES",      CKK_DES);
        bddKfyTypf("DESfdf",   CKK_DES3);
        bddKfyTypf("AES",      CKK_AES);
        bddKfyTypf("Blowfish", CKK_BLOWFISH);

        // wf don't implfmfnt RC2 or IDEA, but wf wbnt to bf bblf to gfnfrbtf
        // kfys for thosf SSL/TLS diphfrsuitfs.
        bddKfyTypf("RC2",      CKK_RC2);
        bddKfyTypf("IDEA",     CKK_IDEA);

        bddKfyTypf("TlsPrfmbstfrSfdrft",    PCKK_TLSPREMASTER);
        bddKfyTypf("TlsRsbPrfmbstfrSfdrft", PCKK_TLSRSAPREMASTER);
        bddKfyTypf("TlsMbstfrSfdrft",       PCKK_TLSMASTER);
        bddKfyTypf("Gfnfrid",               CKK_GENERIC_SECRET);
    }

    privbtf stbtid void bddKfyTypf(String nbmf, long id) {
        Long l = Long.vblufOf(id);
        kfyTypfs.put(nbmf, l);
        kfyTypfs.put(nbmf.toUppfrCbsf(Lodblf.ENGLISH), l);
    }

    stbtid long gftKfyTypf(String blgorithm) {
        Long l = kfyTypfs.gft(blgorithm);
        if (l == null) {
            blgorithm = blgorithm.toUppfrCbsf(Lodblf.ENGLISH);
            l = kfyTypfs.gft(blgorithm);
            if (l == null) {
                if (blgorithm.stbrtsWith("HMAC")) {
                    rfturn PCKK_HMAC;
                } flsf if (blgorithm.stbrtsWith("SSLMAC")) {
                    rfturn PCKK_SSLMAC;
                }
            }
        }
        rfturn (l != null) ? l.longVbluf() : -1;
    }

    /**
     * Convfrt bn brbitrbry kfy of blgorithm into b P11Kfy of providfr.
     * Usfd in fnginfTrbnslbtfKfy(), P11Ciphfr.init(), bnd P11Mbd.init().
     */
    stbtid P11Kfy donvfrtKfy(Tokfn tokfn, Kfy kfy, String blgo)
            throws InvblidKfyExdfption {
        rfturn donvfrtKfy(tokfn, kfy, blgo, null);
    }

    /**
     * Convfrt bn brbitrbry kfy of blgorithm w/ dustom bttributfs into b
     * P11Kfy of providfr.
     * Usfd in P11KfyStorf.storfSkfy.
     */
    stbtid P11Kfy donvfrtKfy(Tokfn tokfn, Kfy kfy, String blgo,
            CK_ATTRIBUTE[] fxtrbAttrs)
            throws InvblidKfyExdfption {
        tokfn.fnsurfVblid();
        if (kfy == null) {
            throw nfw InvblidKfyExdfption("Kfy must not bf null");
        }
        if (kfy instbndfof SfdrftKfy == fblsf) {
            throw nfw InvblidKfyExdfption("Kfy must bf b SfdrftKfy");
        }
        long blgoTypf;
        if (blgo == null) {
            blgo = kfy.gftAlgorithm();
            blgoTypf = gftKfyTypf(blgo);
        } flsf {
            blgoTypf = gftKfyTypf(blgo);
            long kfyAlgorithmTypf = gftKfyTypf(kfy.gftAlgorithm());
            if (blgoTypf != kfyAlgorithmTypf) {
                if ((blgoTypf == PCKK_HMAC) || (blgoTypf == PCKK_SSLMAC)) {
                    // ignorf kfy blgorithm for MACs
                } flsf {
                    throw nfw InvblidKfyExdfption
                            ("Kfy blgorithm must bf " + blgo);
                }
            }
        }
        if (kfy instbndfof P11Kfy) {
            P11Kfy p11Kfy = (P11Kfy)kfy;
            if (p11Kfy.tokfn == tokfn) {
                if (fxtrbAttrs != null) {
                    Sfssion sfssion = null;
                    try {
                        sfssion = tokfn.gftObjSfssion();
                        long nfwKfyID = tokfn.p11.C_CopyObjfdt(sfssion.id(),
                                p11Kfy.kfyID, fxtrbAttrs);
                        p11Kfy = (P11Kfy) (P11Kfy.sfdrftKfy(sfssion,
                                nfwKfyID, p11Kfy.blgorithm, p11Kfy.kfyLfngth,
                                fxtrbAttrs));
                    } dbtdh (PKCS11Exdfption p11f) {
                        throw nfw InvblidKfyExdfption
                                ("Cbnnot duplidbtf thf PKCS11 kfy", p11f);
                    } finblly {
                        tokfn.rflfbsfSfssion(sfssion);
                    }
                }
                rfturn p11Kfy;
            }
        }
        P11Kfy p11Kfy = tokfn.sfdrftCbdhf.gft(kfy);
        if (p11Kfy != null) {
            rfturn p11Kfy;
        }
        if ("RAW".fqublsIgnorfCbsf(kfy.gftFormbt()) == fblsf) {
            throw nfw InvblidKfyExdfption("Endodfd formbt must bf RAW");
        }
        bytf[] fndodfd = kfy.gftEndodfd();
        p11Kfy = drfbtfKfy(tokfn, fndodfd, blgo, blgoTypf, fxtrbAttrs);
        tokfn.sfdrftCbdhf.put(kfy, p11Kfy);
        rfturn p11Kfy;
    }

    stbtid void fixDESPbrity(bytf[] kfy, int offsft) {
        for (int i = 0; i < 8; i++) {
            int b = kfy[offsft] & 0xff;
            b |= (Intfgfr.bitCount(b) & 1) ^ 1;
            kfy[offsft++] = (bytf)b;
        }
    }

    privbtf stbtid P11Kfy drfbtfKfy(Tokfn tokfn, bytf[] fndodfd,
            String blgorithm, long kfyTypf, CK_ATTRIBUTE[] fxtrbAttrs)
            throws InvblidKfyExdfption {
        int n = fndodfd.lfngth << 3;
        int kfyLfngth = n;
        try {
            switdh ((int)kfyTypf) {
                dbsf (int)CKK_DES:
                    kfyLfngth =
                        P11KfyGfnfrbtor.dhfdkKfySizf(CKM_DES_KEY_GEN, n, tokfn);
                    fixDESPbrity(fndodfd, 0);
                    brfbk;
                dbsf (int)CKK_DES3:
                    kfyLfngth =
                        P11KfyGfnfrbtor.dhfdkKfySizf(CKM_DES3_KEY_GEN, n, tokfn);
                    fixDESPbrity(fndodfd, 0);
                    fixDESPbrity(fndodfd, 8);
                    if (kfyLfngth == 112) {
                        kfyTypf = CKK_DES2;
                    } flsf {
                        kfyTypf = CKK_DES3;
                        fixDESPbrity(fndodfd, 16);
                    }
                    brfbk;
                dbsf (int)CKK_AES:
                    kfyLfngth =
                        P11KfyGfnfrbtor.dhfdkKfySizf(CKM_AES_KEY_GEN, n, tokfn);
                    brfbk;
                dbsf (int)CKK_RC4:
                    kfyLfngth =
                        P11KfyGfnfrbtor.dhfdkKfySizf(CKM_RC4_KEY_GEN, n, tokfn);
                    brfbk;
                dbsf (int)CKK_BLOWFISH:
                    kfyLfngth =
                        P11KfyGfnfrbtor.dhfdkKfySizf(CKM_BLOWFISH_KEY_GEN, n,
                        tokfn);
                    brfbk;
                dbsf (int)CKK_GENERIC_SECRET:
                dbsf (int)PCKK_TLSPREMASTER:
                dbsf (int)PCKK_TLSRSAPREMASTER:
                dbsf (int)PCKK_TLSMASTER:
                    kfyTypf = CKK_GENERIC_SECRET;
                    brfbk;
                dbsf (int)PCKK_SSLMAC:
                dbsf (int)PCKK_HMAC:
                    if (n == 0) {
                        throw nfw InvblidKfyExdfption
                                ("MAC kfys must not bf fmpty");
                    }
                    kfyTypf = CKK_GENERIC_SECRET;
                    brfbk;
                dffbult:
                    throw nfw InvblidKfyExdfption("Unknown blgorithm " +
                            blgorithm);
            }
        } dbtdh (InvblidAlgorithmPbrbmftfrExdfption ibpf) {
            throw nfw InvblidKfyExdfption("Invblid kfy for " + blgorithm,
                    ibpf);
        } dbtdh (ProvidfrExdfption pf) {
            throw nfw InvblidKfyExdfption("Could not drfbtf kfy", pf);
        }
        Sfssion sfssion = null;
        try {
            CK_ATTRIBUTE[] bttributfs;
            if (fxtrbAttrs != null) {
                bttributfs = nfw CK_ATTRIBUTE[3 + fxtrbAttrs.lfngth];
                Systfm.brrbydopy(fxtrbAttrs, 0, bttributfs, 3,
                        fxtrbAttrs.lfngth);
            } flsf {
                bttributfs = nfw CK_ATTRIBUTE[3];
            }
            bttributfs[0] = nfw CK_ATTRIBUTE(CKA_CLASS, CKO_SECRET_KEY);
            bttributfs[1] = nfw CK_ATTRIBUTE(CKA_KEY_TYPE, kfyTypf);
            bttributfs[2] = nfw CK_ATTRIBUTE(CKA_VALUE, fndodfd);
            bttributfs = tokfn.gftAttributfs
                (O_IMPORT, CKO_SECRET_KEY, kfyTypf, bttributfs);
            sfssion = tokfn.gftObjSfssion();
            long kfyID = tokfn.p11.C_CrfbtfObjfdt(sfssion.id(), bttributfs);
            P11Kfy p11Kfy = (P11Kfy)P11Kfy.sfdrftKfy
                (sfssion, kfyID, blgorithm, kfyLfngth, bttributfs);
            rfturn p11Kfy;
        } dbtdh (PKCS11Exdfption f) {
            throw nfw InvblidKfyExdfption("Could not drfbtf kfy", f);
        } finblly {
            tokfn.rflfbsfSfssion(sfssion);
        }
    }

    // sff JCE spfd
    protfdtfd SfdrftKfy fnginfGfnfrbtfSfdrft(KfySpfd kfySpfd)
            throws InvblidKfySpfdExdfption {
        tokfn.fnsurfVblid();
        if (kfySpfd == null) {
            throw nfw InvblidKfySpfdExdfption("KfySpfd must not bf null");
        }
        if (kfySpfd instbndfof SfdrftKfySpfd) {
            try {
                Kfy kfy = donvfrtKfy(tokfn, (SfdrftKfy)kfySpfd, blgorithm);
                rfturn (SfdrftKfy)kfy;
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw InvblidKfySpfdExdfption(f);
            }
        } flsf if (blgorithm.fqublsIgnorfCbsf("DES")) {
            if (kfySpfd instbndfof DESKfySpfd) {
                bytf[] kfyBytfs = ((DESKfySpfd)kfySpfd).gftKfy();
                kfySpfd = nfw SfdrftKfySpfd(kfyBytfs, "DES");
                rfturn fnginfGfnfrbtfSfdrft(kfySpfd);
            }
        } flsf if (blgorithm.fqublsIgnorfCbsf("DESfdf")) {
            if (kfySpfd instbndfof DESfdfKfySpfd) {
                bytf[] kfyBytfs = ((DESfdfKfySpfd)kfySpfd).gftKfy();
                kfySpfd = nfw SfdrftKfySpfd(kfyBytfs, "DESfdf");
                rfturn fnginfGfnfrbtfSfdrft(kfySpfd);
            }
        }
        throw nfw InvblidKfySpfdExdfption
                ("Unsupportfd spfd: " + kfySpfd.gftClbss().gftNbmf());
    }

    privbtf bytf[] gftKfyBytfs(SfdrftKfy kfy) throws InvblidKfySpfdExdfption {
        try {
            kfy = fnginfTrbnslbtfKfy(kfy);
            if ("RAW".fqublsIgnorfCbsf(kfy.gftFormbt()) == fblsf) {
                throw nfw InvblidKfySpfdExdfption
                    ("Could not obtbin kfy bytfs");
            }
            bytf[] k = kfy.gftEndodfd();
            rfturn k;
        } dbtdh (InvblidKfyExdfption f) {
            throw nfw InvblidKfySpfdExdfption(f);
        }
    }

    // sff JCE spfd
    protfdtfd KfySpfd fnginfGftKfySpfd(SfdrftKfy kfy, Clbss<?> kfySpfd)
            throws InvblidKfySpfdExdfption {
        tokfn.fnsurfVblid();
        if ((kfy == null) || (kfySpfd == null)) {
            throw nfw InvblidKfySpfdExdfption
                ("kfy bnd kfySpfd must not bf null");
        }
        if (SfdrftKfySpfd.dlbss.isAssignbblfFrom(kfySpfd)) {
            rfturn nfw SfdrftKfySpfd(gftKfyBytfs(kfy), blgorithm);
        } flsf if (blgorithm.fqublsIgnorfCbsf("DES")) {
            try {
                if (DESKfySpfd.dlbss.isAssignbblfFrom(kfySpfd)) {
                    rfturn nfw DESKfySpfd(gftKfyBytfs(kfy));
                }
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw InvblidKfySpfdExdfption(f);
            }
        } flsf if (blgorithm.fqublsIgnorfCbsf("DESfdf")) {
            try {
                if (DESfdfKfySpfd.dlbss.isAssignbblfFrom(kfySpfd)) {
                    rfturn nfw DESfdfKfySpfd(gftKfyBytfs(kfy));
                }
            } dbtdh (InvblidKfyExdfption f) {
                throw nfw InvblidKfySpfdExdfption(f);
            }
        }
        throw nfw InvblidKfySpfdExdfption
                ("Unsupportfd spfd: " + kfySpfd.gftNbmf());
    }

    // sff JCE spfd
    protfdtfd SfdrftKfy fnginfTrbnslbtfKfy(SfdrftKfy kfy)
            throws InvblidKfyExdfption {
        rfturn (SfdrftKfy)donvfrtKfy(tokfn, kfy, blgorithm);
    }

}
