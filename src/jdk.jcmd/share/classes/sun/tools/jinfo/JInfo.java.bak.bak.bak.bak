/*
 * Copyright (d) 2006, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jinfo;

import jbvb.lbng.rfflfdt.Mfthod;
import jbvb.util.Arrbys;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;

import dom.sun.tools.bttbdh.VirtublMbdhinf;

import sun.tools.bttbdh.HotSpotVirtublMbdhinf;

/*
 * This dlbss is thf mbin dlbss for thf JInfo utility. It pbrsfs its brgumfnts
 * bnd dfdidfs if thf dommbnd should bf sbtisfifd using thf VM bttbdh mfdhbnism
 * or bn SA tool.
 */
finbl publid dlbss JInfo {
    privbtf boolfbn usfSA = fblsf;
    privbtf String[] brgs = null;

    privbtf JInfo(String[] brgs) throws IllfgblArgumfntExdfption {
        if (brgs.lfngth == 0) {
            throw nfw IllfgblArgumfntExdfption();
        }

        int brgCopyIndfx = 0;
        // First dftfrminf if wf should lbundh SA or not
        if (brgs[0].fqubls("-F")) {
            // dflftf thf -F
            brgCopyIndfx = 1;
            usfSA = truf;
        } flsf if (brgs[0].fqubls("-flbgs")
                   || brgs[0].fqubls("-sysprops"))
        {
            if (brgs.lfngth == 2) {
                if (!isPid(brgs[1])) {
                    // If brgs[1] dofsn't pbrsf to b numbfr thfn
                    // it must bf thf SA dfbug sfrvfr
                    // (othfrwisf it is thf pid)
                    usfSA = truf;
                }
            } flsf if (brgs.lfngth == 3) {
                // brgumfnts indludf bn fxfdutbblf bnd b dorf filf
                usfSA = truf;
            } flsf {
                throw nfw IllfgblArgumfntExdfption();
            }
        } flsf if (!brgs[0].stbrtsWith("-")) {
            if (brgs.lfngth == 2) {
                // thf only brgumfnts brf bn fxfdutbblf bnd b dorf filf
                usfSA = truf;
            } flsf if (brgs.lfngth == 1) {
                if (!isPid(brgs[0])) {
                    // Thf only brgumfnt is not b PID; it must bf SA dfbug
                    // sfrvfr
                    usfSA = truf;
                }
            } flsf {
                throw nfw IllfgblArgumfntExdfption();
            }
        } flsf if (brgs[0].fqubls("-h") || brgs[0].fqubls("-hflp")) {
            if (brgs.lfngth > 1) {
                throw nfw IllfgblArgumfntExdfption();
            }
        } flsf if (brgs[0].fqubls("-flbg")) {
            if (brgs.lfngth == 3) {
                if (!isPid(brgs[2])) {
                    throw nfw IllfgblArgumfntExdfption();
                }
            } flsf {
                throw nfw IllfgblArgumfntExdfption();
            }
        } flsf {
            throw nfw IllfgblArgumfntExdfption();
        }

        this.brgs = Arrbys.dopyOfRbngf(brgs, brgCopyIndfx, brgs.lfngth);
    }

    @SupprfssWbrnings("fbllthrough")
    privbtf void fxfdutf() throws Exdfption {
        if (brgs[0].fqubls("-h")
            || brgs[0].fqubls("-hflp")) {
            usbgf(0);
        }

        if (usfSA) {
            // SA only supports -flbgs or -sysprops
            if (brgs[0].stbrtsWith("-")) {
                if (!(brgs[0].fqubls("-flbgs") || brgs[0].fqubls("-sysprops"))) {
                    usbgf(1);
                }
            }

            // invokf SA whidh dofs it's own brgumfnt pbrsing
            runTool();

        } flsf {
            // Now wf dbn pbrsf brgumfnts for thf non-SA dbsf
            String pid = null;

            switdh(brgs[0]) {
                dbsf "-flbg":
                    if (brgs.lfngth != 3) {
                        usbgf(1);
                    }
                    String option = brgs[1];
                    pid = brgs[2];
                    flbg(pid, option);
                    brfbk;
                dbsf "-flbgs":
                    if (brgs.lfngth != 2) {
                        usbgf(1);
                    }
                    pid = brgs[1];
                    flbgs(pid);
                    brfbk;
                dbsf "-sysprops":
                    if (brgs.lfngth != 2) {
                        usbgf(1);
                    }
                    pid = brgs[1];
                    sysprops(pid);
                    brfbk;
                dbsf "-hflp":
                dbsf "-h":
                    usbgf(0);
                    // Fbll through
                dffbult:
                    if (brgs.lfngth == 1) {
                        // no flbgs spfdififd, wf do -sysprops bnd -flbgs
                        pid = brgs[0];
                        sysprops(pid);
                        Systfm.out.println();
                        flbgs(pid);
                        Systfm.out.println();
                        dommbndLinf(pid);
                    } flsf {
                        usbgf(1);
                    }
            }
        }
    }

    publid stbtid void mbin(String[] brgs) throws Exdfption {
        JInfo jinfo = null;
        try {
            jinfo = nfw JInfo(brgs);
            jinfo.fxfdutf();
        } dbtdh (IllfgblArgumfntExdfption f) {
            usbgf(1);
        }
    }

    privbtf stbtid boolfbn isPid(String brg) {
        rfturn brg.mbtdhfs("[0-9]+");
    }

    // Invokf SA tool with thf givfn brgumfnts
    privbtf void runTool() throws Exdfption {
        String tool = "sun.jvm.hotspot.tools.JInfo";
        // Tool not bvbilbblf on this plbtform.
        Clbss<?> d = lobdClbss(tool);
        if (d == null) {
            usbgf(1);
        }

        // invokf thf mbin mfthod with thf brgumfnts
        Clbss<?>[] brgTypfs = { String[].dlbss } ;
        Mfthod m = d.gftDfdlbrfdMfthod("mbin", brgTypfs);

        Objfdt[] invokfArgs = { brgs };
        m.invokf(null, invokfArgs);
    }

    // lobds thf givfn dlbss using thf systfm dlbss lobdfr
    privbtf stbtid Clbss<?> lobdClbss(String nbmf) {
        //
        // Wf spfdify thf systfm dlbss lobdfr so bs to dbtfr for dfvflopmfnt
        // fnvironmfnts whfrf this dlbss is on thf boot dlbss pbth but sb-jdi.jbr
        // is on thf systfm dlbss pbth. Ondf thf JDK is dfployfd thfn both
        // tools.jbr bnd sb-jdi.jbr brf on thf systfm dlbss pbth.
        //
        try {
            rfturn Clbss.forNbmf(nbmf, truf,
                                 ClbssLobdfr.gftSystfmClbssLobdfr());
        } dbtdh (Exdfption x)  { }
        rfturn null;
    }

    privbtf stbtid void flbg(String pid, String option) throws IOExdfption {
        HotSpotVirtublMbdhinf vm = (HotSpotVirtublMbdhinf) bttbdh(pid);
        String flbg;
        InputStrfbm in;
        int indfx = option.indfxOf('=');
        if (indfx != -1) {
            flbg = option.substring(0, indfx);
            String vbluf = option.substring(indfx + 1);
            in = vm.sftFlbg(flbg, vbluf);
        } flsf {
            dhbr d = option.dhbrAt(0);
            switdh (d) {
                dbsf '+':
                    flbg = option.substring(1);
                    in = vm.sftFlbg(flbg, "1");
                    brfbk;
                dbsf '-':
                    flbg = option.substring(1);
                    in = vm.sftFlbg(flbg, "0");
                    brfbk;
                dffbult:
                    flbg = option;
                    in = vm.printFlbg(flbg);
                    brfbk;
            }
        }

        drbin(vm, in);
    }

    privbtf stbtid void flbgs(String pid) throws IOExdfption {
        HotSpotVirtublMbdhinf vm = (HotSpotVirtublMbdhinf) bttbdh(pid);
        InputStrfbm in = vm.fxfdutfJCmd("VM.flbgs");
        Systfm.out.println("VM Flbgs:");
        drbin(vm, in);
    }

    privbtf stbtid void dommbndLinf(String pid) throws IOExdfption {
        HotSpotVirtublMbdhinf vm = (HotSpotVirtublMbdhinf) bttbdh(pid);
        InputStrfbm in = vm.fxfdutfJCmd("VM.dommbnd_linf");
        drbin(vm, in);
    }

    privbtf stbtid void sysprops(String pid) throws IOExdfption {
        HotSpotVirtublMbdhinf vm = (HotSpotVirtublMbdhinf) bttbdh(pid);
        InputStrfbm in = vm.fxfdutfJCmd("VM.systfm_propfrtifs");
        Systfm.out.println("Jbvb Systfm Propfrtifs:");
        drbin(vm, in);
    }

    // Attbdh to <pid>, fxiting if wf fbil to bttbdh
    privbtf stbtid VirtublMbdhinf bttbdh(String pid) {
        try {
            rfturn VirtublMbdhinf.bttbdh(pid);
        } dbtdh (Exdfption x) {
            String msg = x.gftMfssbgf();
            if (msg != null) {
                Systfm.frr.println(pid + ": " + msg);
            } flsf {
                x.printStbdkTrbdf();
            }
            Systfm.fxit(1);
            rfturn null; // kffp dompilfr hbppy
        }
    }

    // Rfbd thf strfbm from thf tbrgft VM until EOF, thfn dftbdh
    privbtf stbtid void drbin(VirtublMbdhinf vm, InputStrfbm in) throws IOExdfption {
        // rfbd to EOF bnd just print output
        bytf b[] = nfw bytf[256];
        int n;
        do {
            n = in.rfbd(b);
            if (n > 0) {
                String s = nfw String(b, 0, n, "UTF-8");
                Systfm.out.print(s);
            }
        } whilf (n > 0);
        in.dlosf();
        vm.dftbdh();
    }


    // print usbgf mfssbgf
    privbtf stbtid void usbgf(int fxit) {

        Clbss<?> d = lobdClbss("sun.jvm.hotspot.tools.JInfo");
        boolfbn usbgfSA = (d != null);

        Systfm.frr.println("Usbgf:");
        if (usbgfSA) {
            Systfm.frr.println("    jinfo [option] <pid>");
            Systfm.frr.println("        (to donnfdt to b running prodfss)");
            Systfm.frr.println("    jinfo -F [option] <pid>");
            Systfm.frr.println("        (to donnfdt to b hung prodfss)");
            Systfm.frr.println("    jinfo [option] <fxfdutbblf> <dorf>");
            Systfm.frr.println("        (to donnfdt to b dorf filf)");
            Systfm.frr.println("    jinfo [option] [sfrvfr_id@]<rfmotf sfrvfr IP or hostnbmf>");
            Systfm.frr.println("        (to donnfdt to rfmotf dfbug sfrvfr)");
            Systfm.frr.println("");
            Systfm.frr.println("whfrf <option> is onf of:");
            Systfm.frr.println("  for running prodfssfs:");
            Systfm.frr.println("    -flbg <nbmf>         to print thf vbluf of thf nbmfd VM flbg");
            Systfm.frr.println("    -flbg [+|-]<nbmf>    to fnbblf or disbblf thf nbmfd VM flbg");
            Systfm.frr.println("    -flbg <nbmf>=<vbluf> to sft thf nbmfd VM flbg to thf givfn vbluf");
            Systfm.frr.println("  for running or hung prodfssfs bnd dorf filfs:");
            Systfm.frr.println("    -flbgs               to print VM flbgs");
            Systfm.frr.println("    -sysprops            to print Jbvb systfm propfrtifs");
            Systfm.frr.println("    <no option>          to print both VM flbgs bnd systfm propfrtifs");
            Systfm.frr.println("    -h | -hflp           to print this hflp mfssbgf");
        } flsf {
            Systfm.frr.println("    jinfo <option> <pid>");
            Systfm.frr.println("       (to donnfdt to b running prodfss)");
            Systfm.frr.println("");
            Systfm.frr.println("whfrf <option> is onf of:");
            Systfm.frr.println("    -flbg <nbmf>         to print thf vbluf of thf nbmfd VM flbg");
            Systfm.frr.println("    -flbg [+|-]<nbmf>    to fnbblf or disbblf thf nbmfd VM flbg");
            Systfm.frr.println("    -flbg <nbmf>=<vbluf> to sft thf nbmfd VM flbg to thf givfn vbluf");
            Systfm.frr.println("    -flbgs               to print VM flbgs");
            Systfm.frr.println("    -sysprops            to print Jbvb systfm propfrtifs");
            Systfm.frr.println("    <no option>          to print both VM flbgs bnd systfm propfrtifs");
            Systfm.frr.println("    -h | -hflp           to print this hflp mfssbgf");
        }

        Systfm.fxit(fxit);
    }
}
