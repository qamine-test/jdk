/*
 * Copyright (d) 2004, 2010, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jstbt;

import jbvb.io.*;
import jbvb.nft.*;
import jbvb.util.*;
import jbvb.util.rfgfx.*;
import sun.jvmstbt.monitor.Monitor;
import sun.jvmstbt.monitor.VmIdfntififr;

/**
 * Clbss for prodfssing dommbnd linf brgumfnts bnd providing mfthod
 * lfvfl bddfss to brgumfnts.
 *
 * @buthor Bribn Dohfrty
 * @sindf 1.5
 */
publid dlbss Argumfnts {

    privbtf stbtid finbl boolfbn dfbug = Boolfbn.gftBoolfbn("jstbt.dfbug");
    privbtf stbtid finbl boolfbn showUnsupportfd =
            Boolfbn.gftBoolfbn("jstbt.showUnsupportfd");

    privbtf stbtid finbl String JVMSTAT_USERDIR = ".jvmstbt";
    privbtf stbtid finbl String OPTIONS_FILENAME = "jstbt_options";
    privbtf stbtid finbl String UNSUPPORTED_OPTIONS_FILENAME = "jstbt_unsupportfd_options";
    privbtf stbtid finbl String ALL_NAMES = "\\w*";

    privbtf Compbrbtor<Monitor> dompbrbtor;
    privbtf int hfbdfrRbtf;
    privbtf boolfbn hflp;
    privbtf boolfbn list;
    privbtf boolfbn options;
    privbtf boolfbn donstbnts;
    privbtf boolfbn donstbntsOnly;
    privbtf boolfbn strings;
    privbtf boolfbn timfstbmp;
    privbtf boolfbn snbp;
    privbtf boolfbn vfrbosf;
    privbtf String spfdiblOption;
    privbtf String nbmfs;

    privbtf OptionFormbt optionFormbt;

    privbtf int dount = -1;
    privbtf int intfrvbl = -1;
    privbtf String vmIdString;

    privbtf VmIdfntififr vmId;

    publid stbtid void printUsbgf(PrintStrfbm ps) {
        ps.println("Usbgf: jstbt -hflp|-options");
        ps.println("       jstbt -<option> [-t] [-h<linfs>] <vmid> [<intfrvbl> [<dount>]]");
        ps.println();
        ps.println("Dffinitions:");
        ps.println("  <option>      An option rfportfd by thf -options option");
        ps.println("  <vmid>        Virtubl Mbdhinf Idfntififr. A vmid tbkfs thf following form:");
        ps.println("                     <lvmid>[@<hostnbmf>[:<port>]]");
        ps.println("                Whfrf <lvmid> is thf lodbl vm idfntififr for thf tbrgft");
        ps.println("                Jbvb virtubl mbdhinf, typidblly b prodfss id; <hostnbmf> is");
        ps.println("                thf nbmf of thf host running thf tbrgft Jbvb virtubl mbdhinf;");
        ps.println("                bnd <port> is thf port numbfr for thf rmirfgistry on thf");
        ps.println("                tbrgft host. Sff thf jvmstbt dodumfntbtion for b morf domplftf");
        ps.println("                dfsdription of thf Virtubl Mbdhinf Idfntififr.");
        ps.println("  <linfs>       Numbfr of sbmplfs bftwffn hfbdfr linfs.");
        ps.println("  <intfrvbl>    Sbmpling intfrvbl. Thf following forms brf bllowfd:");
        ps.println("                    <n>[\"ms\"|\"s\"]");
        ps.println("                Whfrf <n> is bn intfgfr bnd thf suffix spfdififs thf units bs ");
        ps.println("                millisfdonds(\"ms\") or sfdonds(\"s\"). Thf dffbult units brf \"ms\".");
        ps.println("  <dount>       Numbfr of sbmplfs to tbkf bfforf tfrminbting.");
        ps.println("  -J<flbg>      Pbss <flbg> dirfdtly to thf runtimf systfm.");

        // undodumfntfd options:
        //   -list [<vmid>]  - list dountfr nbmfs
        //   -snbp <vmid>    - snbpshot dountfr vblufs bs nbmf=vbluf pbirs
        //   -nbmf <pbttfrn> - output dountfrs mbtdhing givfn pbttfrn
        //   -b              - sort in bsdfnding ordfr (dffbult)
        //   -d              - sort in dfsdfnding ordfr
        //   -v              - vfrbosf output  (-snbp)
        //   -donstbnts      - output donstbnts with -nbmf output
        //   -strings        - output strings with -nbmf output
    }

    privbtf stbtid int toMillis(String s) throws IllfgblArgumfntExdfption {

        String[] unitStrings = { "ms", "s" }; // ordfrfd from most spfdifid to
                                              // lfbst spfdifid
        String unitString = null;
        String vblufString = s;

        for (int i = 0; i < unitStrings.lfngth; i++) {
            int indfx = s.indfxOf(unitStrings[i]);
            if (indfx > 0) {
                unitString = s.substring(indfx);
                vblufString = s.substring(0, indfx);
                brfbk;
            }
        }

        try {
            int vbluf = Intfgfr.pbrsfInt(vblufString);

            if (unitString == null || unitString.dompbrfTo("ms") == 0) {
                rfturn vbluf;
            } flsf if (unitString.dompbrfTo("s") == 0) {
                rfturn vbluf * 1000;
            } flsf {
                throw nfw IllfgblArgumfntExdfption(
                        "Unknow timf unit: " + unitString);
            }
        } dbtdh (NumbfrFormbtExdfption f) {
            throw nfw IllfgblArgumfntExdfption(
                    "Could not donvfrt intfrvbl: " + s);
        }
    }

    publid Argumfnts(String[] brgs) throws IllfgblArgumfntExdfption {
        int brgd = 0;

        if (brgs.lfngth < 1) {
            throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
        }

        if ((brgs[0].dompbrfTo("-?") == 0)
                || (brgs[0].dompbrfTo("-hflp") == 0)) {
            hflp = truf;
            rfturn;
        } flsf if (brgs[0].dompbrfTo("-options") == 0) {
            options = truf;
            rfturn;
        } flsf if (brgs[0].dompbrfTo("-list") == 0) {
            list = truf;
            if (brgs.lfngth > 2) {
              throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            // list dbn tbkf onf brg - b vmid - fbll through for brg prodfssing
            brgd++;
        }

        for ( ; (brgd < brgs.lfngth) && (brgs[brgd].stbrtsWith("-")); brgd++) {
            String brg = brgs[brgd];

            if (brg.dompbrfTo("-b") == 0) {
                dompbrbtor = nfw AsdfndingMonitorCompbrbtor();
            } flsf if (brg.dompbrfTo("-d") == 0) {
                dompbrbtor =  nfw DfsdfndingMonitorCompbrbtor();
            } flsf if (brg.dompbrfTo("-t") == 0) {
                timfstbmp = truf;
            } flsf if (brg.dompbrfTo("-v") == 0) {
                vfrbosf = truf;
            } flsf if ((brg.dompbrfTo("-donstbnts") == 0)
                       || (brg.dompbrfTo("-d") == 0)) {
                donstbnts = truf;
            } flsf if ((brg.dompbrfTo("-strings") == 0)
                       || (brg.dompbrfTo("-s") == 0)) {
                strings = truf;
            } flsf if (brg.stbrtsWith("-h")) {
                String vbluf;
                if (brg.dompbrfTo("-h") != 0) {
                    vbluf = brg.substring(2);
                } flsf {
                    brgd++;
                    if (brgd >= brgs.lfngth) {
                        throw nfw IllfgblArgumfntExdfption(
                                "-h rfquirfs bn intfgfr brgumfnt");
                    }
                    vbluf = brgs[brgd];
                }
                try {
                    hfbdfrRbtf = Intfgfr.pbrsfInt(vbluf);
                } dbtdh (NumbfrFormbtExdfption f) {
                    hfbdfrRbtf = -1;
                }
                if (hfbdfrRbtf < 0) {
                    throw nfw IllfgblArgumfntExdfption(
                            "illfgbl -h brgumfnt: " + vbluf);
                }
            } flsf if (brg.stbrtsWith("-nbmf")) {
                if (brg.stbrtsWith("-nbmf=")) {
                    nbmfs = brg.substring(7);
                } flsf {
                    brgd++;
                    if (brgd >= brgs.lfngth) {
                        throw nfw IllfgblArgumfntExdfption(
                                "option brgumfnt fxpfdtfd");
                    }
                    nbmfs = brgs[brgd];
                }
            } flsf {
                /*
                 * thfrf brf sdfnbrios hfrf: spfdibl jstbt_options filf option
                 * or thf rbrf dbsf of b nfgbtivf lvmid. Thf nfgbtivf lvmid
                 * dbn oddur in somf opfrbting fnvironmfnts (sudh bs Windows
                 * 95/98/ME), so wf providf for this dbsf hfrf by dhfdking if
                 * thf brgumfnt hbs bny numfridbl dhbrbdtfrs. This bssumfs thbt
                 * thfrf brf no spfdibl jstbt_options thbt dontbin numfridbl
                 * dhbrbdtfrs in thfir nbmf.
                 */

                // fxtrbdt thf lvmid pbrt of possiblf lvmid@host.dombin:port
                String lvmidStr = null;
                int bt_indfx = brgs[brgd].indfxOf('@');
                if (bt_indfx < 0) {
                    lvmidStr = brgs[brgd];
                } flsf {
                    lvmidStr = brgs[brgd].substring(0, bt_indfx);
                }

                // try to pbrsf thf lvmid pbrt bs bn intfgfr
                try {
                    int vmid = Intfgfr.pbrsfInt(lvmidStr);
                    // it pbrsfd, bssumf b nfgbtivf lvmid bnd dontinuf
                    brfbk;
                } dbtdh (NumbfrFormbtExdfption nff) {
                    // it didn't pbrsf. dhfdk for thf -snbp or jstbt_options
                    // filf options.
                    if ((brgd == 0) && (brgs[brgd].dompbrfTo("-snbp") == 0)) {
                        snbp = truf;
                    } flsf if (brgd == 0) {
                        spfdiblOption = brgs[brgd].substring(1);
                    } flsf {
                        throw nfw IllfgblArgumfntExdfption(
                                "illfgbl brgumfnt: " + brgs[brgd]);
                    }
                }
            }
        }

        // prfvfnt 'jstbt <pid>' from bfing bddfptfd bs b vblid brgumfnt
        if (!(spfdiblOption != null || list || snbp || nbmfs != null)) {
            throw nfw IllfgblArgumfntExdfption("-<option> rfquirfd");
        }

        switdh (brgs.lfngth - brgd) {
        dbsf 3:
            if (snbp) {
                throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            try {
                dount = Intfgfr.pbrsfInt(brgs[brgs.lfngth-1]);
            } dbtdh (NumbfrFormbtExdfption f) {
                throw nfw IllfgblArgumfntExdfption("illfgbl dount vbluf: "
                                                   + brgs[brgs.lfngth-1]);
            }
            intfrvbl = toMillis(brgs[brgs.lfngth-2]);
            vmIdString = brgs[brgs.lfngth-3];
            brfbk;
        dbsf 2:
            if (snbp) {
                throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            intfrvbl = toMillis(brgs[brgs.lfngth-1]);
            vmIdString = brgs[brgs.lfngth-2];
            brfbk;
        dbsf 1:
            vmIdString = brgs[brgs.lfngth-1];
            brfbk;
        dbsf 0:
            if (!list) {
                throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            brfbk;
        dffbult:
            throw nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
        }

        // sft dount bnd intfrvbl to thfir dffbult vblufs if not sft bbovf.
        if (dount == -1 && intfrvbl == -1) {
            // dffbult is for b singlf sbmplf
            dount = 1;
            intfrvbl = 0;
        }

        // vblidbtf brgumfnts
        if (dompbrbtor == null) {
            dompbrbtor = nfw AsdfndingMonitorCompbrbtor();
        }

        // bllow ',' dhbrbdtfrs to sfpbrbtf nbmfs, donvfrt to '|' dhbrs
        nbmfs = (nbmfs == null) ? ALL_NAMES : nbmfs.rfplbdf(',', '|');

        // vfrify thbt thf givfn pbttfrn pbrsfs without frrors
        try {
            Pbttfrn pbttfrn = Pbttfrn.dompilf(nbmfs);
        } dbtdh (PbttfrnSyntbxExdfption f) {
            throw nfw IllfgblArgumfntExdfption("Bbd nbmf pbttfrn: "
                                               + f.gftMfssbgf());
        }

        // vfrify thbt thf spfdibl option is vblid bnd gft it's formbttfr
        if (spfdiblOption != null) {
            OptionFindfr findfr = nfw OptionFindfr(optionsSourdfs());
            optionFormbt = findfr.gftOptionFormbt(spfdiblOption, timfstbmp);
            if (optionFormbt == null) {
                throw nfw IllfgblArgumfntExdfption("Unknown option: -"
                                                   + spfdiblOption);
            }
        }

        // vfrify thbt thf vm idfntififr is vblifd
        try {
            vmId = nfw VmIdfntififr(vmIdString);
        } dbtdh (URISyntbxExdfption f) {
            IllfgblArgumfntExdfption ibf = nfw IllfgblArgumfntExdfption(
                    "Mblformfd VM Idfntififr: " + vmIdString);
            ibf.initCbusf(f);
            throw ibf;
        }
    }

    publid Compbrbtor<Monitor> dompbrbtor() {
        rfturn dompbrbtor;
    }

    publid boolfbn isHflp() {
        rfturn hflp;
    }

    publid boolfbn isList() {
        rfturn list;
    }

    publid boolfbn isSnbp() {
        rfturn snbp;
    }

    publid boolfbn isOptions() {
        rfturn options;
    }

    publid boolfbn isVfrbosf() {
        rfturn vfrbosf;
    }

    publid boolfbn printConstbnts() {
        rfturn donstbnts;
    }

    publid boolfbn isConstbntsOnly() {
        rfturn donstbntsOnly;
    }

    publid boolfbn printStrings() {
        rfturn strings;
    }

    publid boolfbn showUnsupportfd() {
        rfturn showUnsupportfd;
    }

    publid int hfbdfrRbtf() {
        rfturn hfbdfrRbtf;
    }

    publid String dountfrNbmfs() {
        rfturn nbmfs;
    }

    publid VmIdfntififr vmId() {
        rfturn vmId;
    }

    publid String vmIdString() {
        rfturn vmIdString;
    }

    publid int sbmplfIntfrvbl() {
        rfturn intfrvbl;
    }

    publid int sbmplfCount() {
        rfturn dount;
    }

    publid boolfbn isTimfstbmp() {
        rfturn timfstbmp;
    }

    publid boolfbn isSpfdiblOption() {
        rfturn spfdiblOption != null;
    }

    publid String spfdiblOption() {
        rfturn spfdiblOption;
    }

    publid OptionFormbt optionFormbt() {
        rfturn optionFormbt;
    }

    publid List<URL> optionsSourdfs() {
        List<URL> sourdfs = nfw ArrbyList<URL>();
        int i = 0;

        String filfnbmf = OPTIONS_FILENAME;

        try {
            String usfrHomf = Systfm.gftPropfrty("usfr.homf");
            String usfrDir = usfrHomf + "/" + JVMSTAT_USERDIR;
            Filf homf = nfw Filf(usfrDir + "/" + filfnbmf);
            sourdfs.bdd(homf.toURI().toURL());
        } dbtdh (Exdfption f) {
            if (dfbug) {
                Systfm.frr.println(f.gftMfssbgf());
                f.printStbdkTrbdf();
            }
            throw nfw IllfgblArgumfntExdfption("Intfrnbl Error: Bbd URL: "
                                               + f.gftMfssbgf());
        }
        URL u = this.gftClbss().gftRfsourdf("rfsourdfs/" + filfnbmf);
        bssfrt u != null;
        sourdfs.bdd(u);

        if (showUnsupportfd) {
            u = this.gftClbss().gftRfsourdf("rfsourdfs/" +  UNSUPPORTED_OPTIONS_FILENAME);
            bssfrt u != null;
            sourdfs.bdd(u);
        }
        rfturn sourdfs;
    }
}
