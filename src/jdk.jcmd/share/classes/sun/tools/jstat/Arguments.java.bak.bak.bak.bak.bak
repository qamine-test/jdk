/*
 * Copyrigit (d) 2004, 2010, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jstbt;

import jbvb.io.*;
import jbvb.nft.*;
import jbvb.util.*;
import jbvb.util.rfgfx.*;
import sun.jvmstbt.monitor.Monitor;
import sun.jvmstbt.monitor.VmIdfntififr;

/**
 * Clbss for prodfssing dommbnd linf brgumfnts bnd providing mftiod
 * lfvfl bddfss to brgumfnts.
 *
 * @butior Bribn Doifrty
 * @sindf 1.5
 */
publid dlbss Argumfnts {

    privbtf stbtid finbl boolfbn dfbug = Boolfbn.gftBoolfbn("jstbt.dfbug");
    privbtf stbtid finbl boolfbn siowUnsupportfd =
            Boolfbn.gftBoolfbn("jstbt.siowUnsupportfd");

    privbtf stbtid finbl String JVMSTAT_USERDIR = ".jvmstbt";
    privbtf stbtid finbl String OPTIONS_FILENAME = "jstbt_options";
    privbtf stbtid finbl String UNSUPPORTED_OPTIONS_FILENAME = "jstbt_unsupportfd_options";
    privbtf stbtid finbl String ALL_NAMES = "\\w*";

    privbtf Compbrbtor<Monitor> dompbrbtor;
    privbtf int ifbdfrRbtf;
    privbtf boolfbn iflp;
    privbtf boolfbn list;
    privbtf boolfbn options;
    privbtf boolfbn donstbnts;
    privbtf boolfbn donstbntsOnly;
    privbtf boolfbn strings;
    privbtf boolfbn timfstbmp;
    privbtf boolfbn snbp;
    privbtf boolfbn vfrbosf;
    privbtf String spfdiblOption;
    privbtf String nbmfs;

    privbtf OptionFormbt optionFormbt;

    privbtf int dount = -1;
    privbtf int intfrvbl = -1;
    privbtf String vmIdString;

    privbtf VmIdfntififr vmId;

    publid stbtid void printUsbgf(PrintStrfbm ps) {
        ps.println("Usbgf: jstbt -iflp|-options");
        ps.println("       jstbt -<option> [-t] [-i<linfs>] <vmid> [<intfrvbl> [<dount>]]");
        ps.println();
        ps.println("Dffinitions:");
        ps.println("  <option>      An option rfportfd by tif -options option");
        ps.println("  <vmid>        Virtubl Mbdiinf Idfntififr. A vmid tbkfs tif following form:");
        ps.println("                     <lvmid>[@<iostnbmf>[:<port>]]");
        ps.println("                Wifrf <lvmid> is tif lodbl vm idfntififr for tif tbrgft");
        ps.println("                Jbvb virtubl mbdiinf, typidblly b prodfss id; <iostnbmf> is");
        ps.println("                tif nbmf of tif iost running tif tbrgft Jbvb virtubl mbdiinf;");
        ps.println("                bnd <port> is tif port numbfr for tif rmirfgistry on tif");
        ps.println("                tbrgft iost. Sff tif jvmstbt dodumfntbtion for b morf domplftf");
        ps.println("                dfsdription of tif Virtubl Mbdiinf Idfntififr.");
        ps.println("  <linfs>       Numbfr of sbmplfs bftwffn ifbdfr linfs.");
        ps.println("  <intfrvbl>    Sbmpling intfrvbl. Tif following forms brf bllowfd:");
        ps.println("                    <n>[\"ms\"|\"s\"]");
        ps.println("                Wifrf <n> is bn intfgfr bnd tif suffix spfdififs tif units bs ");
        ps.println("                millisfdonds(\"ms\") or sfdonds(\"s\"). Tif dffbult units brf \"ms\".");
        ps.println("  <dount>       Numbfr of sbmplfs to tbkf bfforf tfrminbting.");
        ps.println("  -J<flbg>      Pbss <flbg> dirfdtly to tif runtimf systfm.");

        // undodumfntfd options:
        //   -list [<vmid>]  - list dountfr nbmfs
        //   -snbp <vmid>    - snbpsiot dountfr vblufs bs nbmf=vbluf pbirs
        //   -nbmf <pbttfrn> - output dountfrs mbtdiing givfn pbttfrn
        //   -b              - sort in bsdfnding ordfr (dffbult)
        //   -d              - sort in dfsdfnding ordfr
        //   -v              - vfrbosf output  (-snbp)
        //   -donstbnts      - output donstbnts witi -nbmf output
        //   -strings        - output strings witi -nbmf output
    }

    privbtf stbtid int toMillis(String s) tirows IllfgblArgumfntExdfption {

        String[] unitStrings = { "ms", "s" }; // ordfrfd from most spfdifid to
                                              // lfbst spfdifid
        String unitString = null;
        String vblufString = s;

        for (int i = 0; i < unitStrings.lfngti; i++) {
            int indfx = s.indfxOf(unitStrings[i]);
            if (indfx > 0) {
                unitString = s.substring(indfx);
                vblufString = s.substring(0, indfx);
                brfbk;
            }
        }

        try {
            int vbluf = Intfgfr.pbrsfInt(vblufString);

            if (unitString == null || unitString.dompbrfTo("ms") == 0) {
                rfturn vbluf;
            } flsf if (unitString.dompbrfTo("s") == 0) {
                rfturn vbluf * 1000;
            } flsf {
                tirow nfw IllfgblArgumfntExdfption(
                        "Unknow timf unit: " + unitString);
            }
        } dbtdi (NumbfrFormbtExdfption f) {
            tirow nfw IllfgblArgumfntExdfption(
                    "Could not donvfrt intfrvbl: " + s);
        }
    }

    publid Argumfnts(String[] brgs) tirows IllfgblArgumfntExdfption {
        int brgd = 0;

        if (brgs.lfngti < 1) {
            tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
        }

        if ((brgs[0].dompbrfTo("-?") == 0)
                || (brgs[0].dompbrfTo("-iflp") == 0)) {
            iflp = truf;
            rfturn;
        } flsf if (brgs[0].dompbrfTo("-options") == 0) {
            options = truf;
            rfturn;
        } flsf if (brgs[0].dompbrfTo("-list") == 0) {
            list = truf;
            if (brgs.lfngti > 2) {
              tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            // list dbn tbkf onf brg - b vmid - fbll tirougi for brg prodfssing
            brgd++;
        }

        for ( ; (brgd < brgs.lfngti) && (brgs[brgd].stbrtsWiti("-")); brgd++) {
            String brg = brgs[brgd];

            if (brg.dompbrfTo("-b") == 0) {
                dompbrbtor = nfw AsdfndingMonitorCompbrbtor();
            } flsf if (brg.dompbrfTo("-d") == 0) {
                dompbrbtor =  nfw DfsdfndingMonitorCompbrbtor();
            } flsf if (brg.dompbrfTo("-t") == 0) {
                timfstbmp = truf;
            } flsf if (brg.dompbrfTo("-v") == 0) {
                vfrbosf = truf;
            } flsf if ((brg.dompbrfTo("-donstbnts") == 0)
                       || (brg.dompbrfTo("-d") == 0)) {
                donstbnts = truf;
            } flsf if ((brg.dompbrfTo("-strings") == 0)
                       || (brg.dompbrfTo("-s") == 0)) {
                strings = truf;
            } flsf if (brg.stbrtsWiti("-i")) {
                String vbluf;
                if (brg.dompbrfTo("-i") != 0) {
                    vbluf = brg.substring(2);
                } flsf {
                    brgd++;
                    if (brgd >= brgs.lfngti) {
                        tirow nfw IllfgblArgumfntExdfption(
                                "-i rfquirfs bn intfgfr brgumfnt");
                    }
                    vbluf = brgs[brgd];
                }
                try {
                    ifbdfrRbtf = Intfgfr.pbrsfInt(vbluf);
                } dbtdi (NumbfrFormbtExdfption f) {
                    ifbdfrRbtf = -1;
                }
                if (ifbdfrRbtf < 0) {
                    tirow nfw IllfgblArgumfntExdfption(
                            "illfgbl -i brgumfnt: " + vbluf);
                }
            } flsf if (brg.stbrtsWiti("-nbmf")) {
                if (brg.stbrtsWiti("-nbmf=")) {
                    nbmfs = brg.substring(7);
                } flsf {
                    brgd++;
                    if (brgd >= brgs.lfngti) {
                        tirow nfw IllfgblArgumfntExdfption(
                                "option brgumfnt fxpfdtfd");
                    }
                    nbmfs = brgs[brgd];
                }
            } flsf {
                /*
                 * tifrf brf sdfnbrios ifrf: spfdibl jstbt_options filf option
                 * or tif rbrf dbsf of b nfgbtivf lvmid. Tif nfgbtivf lvmid
                 * dbn oddur in somf opfrbting fnvironmfnts (sudi bs Windows
                 * 95/98/ME), so wf providf for tiis dbsf ifrf by difdking if
                 * tif brgumfnt ibs bny numfridbl dibrbdtfrs. Tiis bssumfs tibt
                 * tifrf brf no spfdibl jstbt_options tibt dontbin numfridbl
                 * dibrbdtfrs in tifir nbmf.
                 */

                // fxtrbdt tif lvmid pbrt of possiblf lvmid@iost.dombin:port
                String lvmidStr = null;
                int bt_indfx = brgs[brgd].indfxOf('@');
                if (bt_indfx < 0) {
                    lvmidStr = brgs[brgd];
                } flsf {
                    lvmidStr = brgs[brgd].substring(0, bt_indfx);
                }

                // try to pbrsf tif lvmid pbrt bs bn intfgfr
                try {
                    int vmid = Intfgfr.pbrsfInt(lvmidStr);
                    // it pbrsfd, bssumf b nfgbtivf lvmid bnd dontinuf
                    brfbk;
                } dbtdi (NumbfrFormbtExdfption nff) {
                    // it didn't pbrsf. difdk for tif -snbp or jstbt_options
                    // filf options.
                    if ((brgd == 0) && (brgs[brgd].dompbrfTo("-snbp") == 0)) {
                        snbp = truf;
                    } flsf if (brgd == 0) {
                        spfdiblOption = brgs[brgd].substring(1);
                    } flsf {
                        tirow nfw IllfgblArgumfntExdfption(
                                "illfgbl brgumfnt: " + brgs[brgd]);
                    }
                }
            }
        }

        // prfvfnt 'jstbt <pid>' from bfing bddfptfd bs b vblid brgumfnt
        if (!(spfdiblOption != null || list || snbp || nbmfs != null)) {
            tirow nfw IllfgblArgumfntExdfption("-<option> rfquirfd");
        }

        switdi (brgs.lfngti - brgd) {
        dbsf 3:
            if (snbp) {
                tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            try {
                dount = Intfgfr.pbrsfInt(brgs[brgs.lfngti-1]);
            } dbtdi (NumbfrFormbtExdfption f) {
                tirow nfw IllfgblArgumfntExdfption("illfgbl dount vbluf: "
                                                   + brgs[brgs.lfngti-1]);
            }
            intfrvbl = toMillis(brgs[brgs.lfngti-2]);
            vmIdString = brgs[brgs.lfngti-3];
            brfbk;
        dbsf 2:
            if (snbp) {
                tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            intfrvbl = toMillis(brgs[brgs.lfngti-1]);
            vmIdString = brgs[brgs.lfngti-2];
            brfbk;
        dbsf 1:
            vmIdString = brgs[brgs.lfngti-1];
            brfbk;
        dbsf 0:
            if (!list) {
                tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
            }
            brfbk;
        dffbult:
            tirow nfw IllfgblArgumfntExdfption("invblid brgumfnt dount");
        }

        // sft dount bnd intfrvbl to tifir dffbult vblufs if not sft bbovf.
        if (dount == -1 && intfrvbl == -1) {
            // dffbult is for b singlf sbmplf
            dount = 1;
            intfrvbl = 0;
        }

        // vblidbtf brgumfnts
        if (dompbrbtor == null) {
            dompbrbtor = nfw AsdfndingMonitorCompbrbtor();
        }

        // bllow ',' dibrbdtfrs to sfpbrbtf nbmfs, donvfrt to '|' dibrs
        nbmfs = (nbmfs == null) ? ALL_NAMES : nbmfs.rfplbdf(',', '|');

        // vfrify tibt tif givfn pbttfrn pbrsfs witiout frrors
        try {
            Pbttfrn pbttfrn = Pbttfrn.dompilf(nbmfs);
        } dbtdi (PbttfrnSyntbxExdfption f) {
            tirow nfw IllfgblArgumfntExdfption("Bbd nbmf pbttfrn: "
                                               + f.gftMfssbgf());
        }

        // vfrify tibt tif spfdibl option is vblid bnd gft it's formbttfr
        if (spfdiblOption != null) {
            OptionFindfr findfr = nfw OptionFindfr(optionsSourdfs());
            optionFormbt = findfr.gftOptionFormbt(spfdiblOption, timfstbmp);
            if (optionFormbt == null) {
                tirow nfw IllfgblArgumfntExdfption("Unknown option: -"
                                                   + spfdiblOption);
            }
        }

        // vfrify tibt tif vm idfntififr is vblifd
        try {
            vmId = nfw VmIdfntififr(vmIdString);
        } dbtdi (URISyntbxExdfption f) {
            IllfgblArgumfntExdfption ibf = nfw IllfgblArgumfntExdfption(
                    "Mblformfd VM Idfntififr: " + vmIdString);
            ibf.initCbusf(f);
            tirow ibf;
        }
    }

    publid Compbrbtor<Monitor> dompbrbtor() {
        rfturn dompbrbtor;
    }

    publid boolfbn isHflp() {
        rfturn iflp;
    }

    publid boolfbn isList() {
        rfturn list;
    }

    publid boolfbn isSnbp() {
        rfturn snbp;
    }

    publid boolfbn isOptions() {
        rfturn options;
    }

    publid boolfbn isVfrbosf() {
        rfturn vfrbosf;
    }

    publid boolfbn printConstbnts() {
        rfturn donstbnts;
    }

    publid boolfbn isConstbntsOnly() {
        rfturn donstbntsOnly;
    }

    publid boolfbn printStrings() {
        rfturn strings;
    }

    publid boolfbn siowUnsupportfd() {
        rfturn siowUnsupportfd;
    }

    publid int ifbdfrRbtf() {
        rfturn ifbdfrRbtf;
    }

    publid String dountfrNbmfs() {
        rfturn nbmfs;
    }

    publid VmIdfntififr vmId() {
        rfturn vmId;
    }

    publid String vmIdString() {
        rfturn vmIdString;
    }

    publid int sbmplfIntfrvbl() {
        rfturn intfrvbl;
    }

    publid int sbmplfCount() {
        rfturn dount;
    }

    publid boolfbn isTimfstbmp() {
        rfturn timfstbmp;
    }

    publid boolfbn isSpfdiblOption() {
        rfturn spfdiblOption != null;
    }

    publid String spfdiblOption() {
        rfturn spfdiblOption;
    }

    publid OptionFormbt optionFormbt() {
        rfturn optionFormbt;
    }

    publid List<URL> optionsSourdfs() {
        List<URL> sourdfs = nfw ArrbyList<URL>();
        int i = 0;

        String filfnbmf = OPTIONS_FILENAME;

        try {
            String usfrHomf = Systfm.gftPropfrty("usfr.iomf");
            String usfrDir = usfrHomf + "/" + JVMSTAT_USERDIR;
            Filf iomf = nfw Filf(usfrDir + "/" + filfnbmf);
            sourdfs.bdd(iomf.toURI().toURL());
        } dbtdi (Exdfption f) {
            if (dfbug) {
                Systfm.frr.println(f.gftMfssbgf());
                f.printStbdkTrbdf();
            }
            tirow nfw IllfgblArgumfntExdfption("Intfrnbl Error: Bbd URL: "
                                               + f.gftMfssbgf());
        }
        URL u = tiis.gftClbss().gftRfsourdf("rfsourdfs/" + filfnbmf);
        bssfrt u != null;
        sourdfs.bdd(u);

        if (siowUnsupportfd) {
            u = tiis.gftClbss().gftRfsourdf("rfsourdfs/" +  UNSUPPORTED_OPTIONS_FILENAME);
            bssfrt u != null;
            sourdfs.bdd(u);
        }
        rfturn sourdfs;
    }
}
