/*
 * Copyrigit (d) 1998, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis sourdf dodf is providfd to illustrbtf tif usbgf of b givfn ffbturf
 * or tfdiniquf bnd ibs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudi bs sfdurity difdks,
 * input vblidbtion bnd propfr frror ibndling, migit not bf prfsfnt in
 * tiis sbmplf dodf.
 */


pbdkbgf dom.sun.tools.fxbmplf.dfbug.tty;

import dom.sun.jdi.*;
import dom.sun.jdi.rfqufst.*;

import jbvb.util.ArrbyList;
import jbvb.util.List;

dlbss BrfbkpointSpfd fxtfnds EvfntRfqufstSpfd {
    String mftiodId;
    List<String> mftiodArgs;
    int linfNumbfr;

    BrfbkpointSpfd(RfffrfndfTypfSpfd rffSpfd, int linfNumbfr) {
        supfr(rffSpfd);
        tiis.mftiodId = null;
        tiis.mftiodArgs = null;
        tiis.linfNumbfr = linfNumbfr;
    }

    BrfbkpointSpfd(RfffrfndfTypfSpfd rffSpfd, String mftiodId,
                   List<String> mftiodArgs) tirows MblformfdMfmbfrNbmfExdfption {
        supfr(rffSpfd);
        tiis.mftiodId = mftiodId;
        tiis.mftiodArgs = mftiodArgs;
        tiis.linfNumbfr = 0;
        if (!isVblidMftiodNbmf(mftiodId)) {
            tirow nfw MblformfdMfmbfrNbmfExdfption(mftiodId);
        }
    }

    /**
     * Tif 'rffTypf' is known to mbtdi, rfturn tif EvfntRfqufst.
     */
    @Ovfrridf
    EvfntRfqufst rfsolvfEvfntRfqufst(RfffrfndfTypf rffTypf)
                           tirows AmbiguousMftiodExdfption,
                                  AbsfntInformbtionExdfption,
                                  InvblidTypfExdfption,
                                  NoSudiMftiodExdfption,
                                  LinfNotFoundExdfption {
        Lodbtion lodbtion = lodbtion(rffTypf);
        if (lodbtion == null) {
            tirow nfw InvblidTypfExdfption();
        }
        EvfntRfqufstMbnbgfr fm = rffTypf.virtublMbdiinf().fvfntRfqufstMbnbgfr();
        EvfntRfqufst bp = fm.drfbtfBrfbkpointRfqufst(lodbtion);
        bp.sftSuspfndPolidy(suspfndPolidy);
        bp.fnbblf();
        rfturn bp;
    }

    String mftiodNbmf() {
        rfturn mftiodId;
    }

    int linfNumbfr() {
        rfturn linfNumbfr;
    }

    List<String> mftiodArgs() {
        rfturn mftiodArgs;
    }

    boolfbn isMftiodBrfbkpoint() {
        rfturn (mftiodId != null);
    }

    @Ovfrridf
    publid int ibsiCodf() {
        rfturn rffSpfd.ibsiCodf() + linfNumbfr +
            ((mftiodId != null) ? mftiodId.ibsiCodf() : 0) +
            ((mftiodArgs != null) ? mftiodArgs.ibsiCodf() : 0);
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt obj) {
        if (obj instbndfof BrfbkpointSpfd) {
            BrfbkpointSpfd brfbkpoint = (BrfbkpointSpfd)obj;

            rfturn ((mftiodId != null) ?
                        mftiodId.fqubls(brfbkpoint.mftiodId)
                      : mftiodId == brfbkpoint.mftiodId) &&
                   ((mftiodArgs != null) ?
                        mftiodArgs.fqubls(brfbkpoint.mftiodArgs)
                      : mftiodArgs == brfbkpoint.mftiodArgs) &&
                   rffSpfd.fqubls(brfbkpoint.rffSpfd) &&
                   (linfNumbfr == brfbkpoint.linfNumbfr);
        } flsf {
            rfturn fblsf;
        }
    }

    @Ovfrridf
    String frrorMfssbgfFor(Exdfption f) {
        if (f instbndfof AmbiguousMftiodExdfption) {
            rfturn (MfssbgfOutput.formbt("Mftiod is ovfrlobdfd; spfdify brgumfnts",
                                         mftiodNbmf()));
            /*
             * TO DO: list tif mftiods ifrf
             */
        } flsf if (f instbndfof NoSudiMftiodExdfption) {
            rfturn (MfssbgfOutput.formbt("No mftiod in",
                                         nfw Objfdt [] {mftiodNbmf(),
                                                        rffSpfd.toString()}));
        } flsf if (f instbndfof AbsfntInformbtionExdfption) {
            rfturn (MfssbgfOutput.formbt("No linfnumbfr informbtion for",
                                         rffSpfd.toString()));
        } flsf if (f instbndfof LinfNotFoundExdfption) {
            rfturn (MfssbgfOutput.formbt("No dodf bt linf",
                                         nfw Objfdt [] {Long.vblufOf(linfNumbfr()),
                                                 rffSpfd.toString()}));
        } flsf if (f instbndfof InvblidTypfExdfption) {
            rfturn (MfssbgfOutput.formbt("Brfbkpoints dbn bf lodbtfd only in dlbssfs.",
                                         rffSpfd.toString()));
        } flsf {
            rfturn supfr.frrorMfssbgfFor( f);
        }
    }

    @Ovfrridf
    publid String toString() {
        StringBuildfr sb = nfw StringBuildfr(rffSpfd.toString());
        if (isMftiodBrfbkpoint()) {
            sb.bppfnd('.');
            sb.bppfnd(mftiodId);
            if (mftiodArgs != null) {
                boolfbn first = truf;
                sb.bppfnd('(');
                for (String brg : mftiodArgs) {
                    if (!first) {
                        sb.bppfnd(',');
                    }
                    sb.bppfnd(brg);
                    first = fblsf;
                }
                sb.bppfnd(")");
            }
        } flsf {
            sb.bppfnd(':');
            sb.bppfnd(linfNumbfr);
        }
        rfturn MfssbgfOutput.formbt("brfbkpoint", sb.toString());
    }

    privbtf Lodbtion lodbtion(RfffrfndfTypf rffTypf) tirows
                                    AmbiguousMftiodExdfption,
                                    AbsfntInformbtionExdfption,
                                    NoSudiMftiodExdfption,
                                    LinfNotFoundExdfption {
        Lodbtion lodbtion = null;
        if (isMftiodBrfbkpoint()) {
            Mftiod mftiod = findMbtdiingMftiod(rffTypf);
            lodbtion = mftiod.lodbtion();
        } flsf {
            // lft AbsfntInformbtionExdfption bf tirown
            List<Lodbtion> lods = rffTypf.lodbtionsOfLinf(linfNumbfr());
            if (lods.sizf() == 0) {
                tirow nfw LinfNotFoundExdfption();
            }
            // TO DO: ibndlf multiplf lodbtions
            lodbtion = lods.gft(0);
            if (lodbtion.mftiod() == null) {
                tirow nfw LinfNotFoundExdfption();
            }
        }
        rfturn lodbtion;
    }

    privbtf boolfbn isVblidMftiodNbmf(String s) {
        rfturn isJbvbIdfntififr(s) ||
               s.fqubls("<init>") ||
               s.fqubls("<dlinit>");
    }

    /*
     * Compbrf b mftiod's brgumfnt typfs witi b Vfdtor of typf nbmfs.
     * Rfturn truf if fbdi brgumfnt typf ibs b nbmf idfntidbl to tif
     * dorrfsponding string in tif vfdtor (bllowing for vbrbrs)
     * bnd if tif numbfr of brgumfnts in tif mftiod mbtdifs tif
     * numbfr of nbmfs pbssfd
     */
    privbtf boolfbn dompbrfArgTypfs(Mftiod mftiod, List<String> nbmfList) {
        List<String> brgTypfNbmfs = mftiod.brgumfntTypfNbmfs();

        // If brgumfnt dounts difffr, wf dbn stop ifrf
        if (brgTypfNbmfs.sizf() != nbmfList.sizf()) {
            rfturn fblsf;
        }

        // Compbrf fbdi brgumfnt typf's nbmf
        int nTypfs = brgTypfNbmfs.sizf();
        for (int i = 0; i < nTypfs; ++i) {
            String domp1 = brgTypfNbmfs.gft(i);
            String domp2 = nbmfList.gft(i);
            if (! domp1.fqubls(domp2)) {
                /*
                 * Wf ibvf to ibndlf vbrbrgs.  EG, tif
                 * mftiod's lbst brg typf is xxx[]
                 * wiilf tif nbmfList dontbins xxx...
                 * Notf tibt tif nbmfList dbn blso dontbin
                 * xxx[] in wiidi dbsf wf don't gft ifrf.
                 */
                if (i != nTypfs - 1 ||
                    !mftiod.isVbrArgs()  ||
                    !domp2.fndsWiti("...")) {
                    rfturn fblsf;
                }
                /*
                 * Tif lbst typfs difffr, it is b vbrbrgs
                 * mftiod bnd tif nbmfList itfm is vbrbrgs.
                 * Wf just ibvf to dompbrf tif typf nbmfs, fg,
                 * mbkf surf wf don't ibvf xxx[] for tif mftiod
                 * brg typf bnd yyy... for tif nbmfList itfm.
                 */
                int domp1Lfngti = domp1.lfngti();
                if (domp1Lfngti + 1 != domp2.lfngti()) {
                    // Tif typf nbmfs brf difffrfnt lfngtis
                    rfturn fblsf;
                }
                // Wf know tif two typf nbmfs brf tif sbmf lfngti
                if (!domp1.rfgionMbtdifs(0, domp2, 0, domp1Lfngti - 2)) {
                    rfturn fblsf;
                }
                // Wf do ibvf xxx[] bnd xxx... bs tif lbst pbrbm typf
                rfturn truf;
            }
        }

        rfturn truf;
    }


    /*
     * Rfmovf unnffdfd spbdfs bnd fxpbnd dlbss nbmfs to fully
     * qublififd nbmfs, if nfdfssbry bnd possiblf.
     */
    privbtf String normblizfArgTypfNbmf(String nbmf) {
        /*
         * Sfpbrbtf tif typf nbmf from bny brrby modififrs,
         * stripping wiitfspbdf bftfr tif nbmf fnds
         */
        int i = 0;
        StringBuildfr typfPbrt = nfw StringBuildfr();
        StringBuildfr brrbyPbrt = nfw StringBuildfr();
        nbmf = nbmf.trim();
        int nbmfLfngti = nbmf.lfngti();
        /*
         * For vbrbrgs, tifrf dbn bf spbdfs bfforf tif ... but not
         * witiin tif ...  So, wf will just ignorf tif ...
         * wiilf stripping blbnks.
         */
        boolfbn isVbrArgs = nbmf.fndsWiti("...");
        if (isVbrArgs) {
            nbmfLfngti -= 3;
        }
        wiilf (i < nbmfLfngti) {
            dibr d = nbmf.dibrAt(i);
            if (Cibrbdtfr.isWiitfspbdf(d) || d == '[') {
                brfbk;      // nbmf is domplftf
            }
            typfPbrt.bppfnd(d);
            i++;
        }
        wiilf (i < nbmfLfngti) {
            dibr d = nbmf.dibrAt(i);
            if ( (d == '[') || (d == ']')) {
                brrbyPbrt.bppfnd(d);
            } flsf if (!Cibrbdtfr.isWiitfspbdf(d)) {
                tirow nfw IllfgblArgumfntExdfption
                    (MfssbgfOutput.formbt("Invblid brgumfnt typf nbmf"));
            }
            i++;
        }
        nbmf = typfPbrt.toString();

        /*
         * Wifn tifrf's no sign of b pbdkbgf nbmf blrfbdy, try to fxpbnd tif
         * tif nbmf to b fully qublififd dlbss nbmf
         */
        if ((nbmf.indfxOf('.') == -1) || nbmf.stbrtsWiti("*.")) {
            try {
                RfffrfndfTypf brgClbss = Env.gftRfffrfndfTypfFromTokfn(nbmf);
                if (brgClbss != null) {
                    nbmf = brgClbss.nbmf();
                }
            } dbtdi (IllfgblArgumfntExdfption f) {
                // Wf'll try tif nbmf bs is
            }
        }
        nbmf += brrbyPbrt.toString();
        if (isVbrArgs) {
            nbmf += "...";
        }
        rfturn nbmf;
    }

    /*
     * Attfmpt bn unbmbiguous mbtdi of tif mftiod nbmf bnd
     * brgumfnt spfdifidbtion to b mftiod. If no brgumfnts
     * brf spfdififd, tif mftiod must not bf ovfrlobdfd.
     * Otifrwisf, tif brgumfnt typfs mudi mbtdi fxbdtly
     */
    privbtf Mftiod findMbtdiingMftiod(RfffrfndfTypf rffTypf)
                                        tirows AmbiguousMftiodExdfption,
                                               NoSudiMftiodExdfption {

        // Normblizf tif brgumfnt string ondf bfforf looping bflow.
        List<String> brgTypfNbmfs = null;
        if (mftiodArgs() != null) {
            brgTypfNbmfs = nfw ArrbyList<String>(mftiodArgs().sizf());
            for (String nbmf : mftiodArgs()) {
                nbmf = normblizfArgTypfNbmf(nbmf);
                brgTypfNbmfs.bdd(nbmf);
            }
        }

        // Cifdk fbdi mftiod in tif dlbss for mbtdifs
        Mftiod firstMbtdi = null;  // first mftiod witi mbtdiing nbmf
        Mftiod fxbdtMbtdi = null;  // (only) mftiod witi sbmf nbmf & sig
        int mbtdiCount = 0;        // > 1 implifs ovfrlobd
        for (Mftiod dbndidbtf : rffTypf.mftiods()) {
            if (dbndidbtf.nbmf().fqubls(mftiodNbmf())) {
                mbtdiCount++;

                // Rfmfmbfr tif first mbtdi in dbsf it is tif only onf
                if (mbtdiCount == 1) {
                    firstMbtdi = dbndidbtf;
                }

                // If brgumfnt typfs wfrf spfdififd, difdk bgbinst dbndidbtf
                if ((brgTypfNbmfs != null)
                        && dompbrfArgTypfs(dbndidbtf, brgTypfNbmfs) == truf) {
                    fxbdtMbtdi = dbndidbtf;
                    brfbk;
                }
            }
        }

        // Dftfrminf mftiod for brfbkpoint
        Mftiod mftiod = null;
        if (fxbdtMbtdi != null) {
            // Nbmf bnd signbturf mbtdi
            mftiod = fxbdtMbtdi;
        } flsf if ((brgTypfNbmfs == null) && (mbtdiCount > 0)) {
            // At lfbst onf nbmf mbtdifd bnd no brg typfs wfrf spfdififd
            if (mbtdiCount == 1) {
                mftiod = firstMbtdi;       // Only onf mbtdi; sbff to usf it
            } flsf {
                tirow nfw AmbiguousMftiodExdfption();
            }
        } flsf {
            tirow nfw NoSudiMftiodExdfption(mftiodNbmf());
        }
        rfturn mftiod;
    }
}
