/*
 * Copyrigit (d) 1998, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.tools.jdi;

import dom.sun.jdi.*;
import dom.sun.jdi.fvfnt.EvfntQufuf;
import dom.sun.jdi.fvfnt.EvfntSft;

import jbvb.util.*;

publid dlbss EvfntQufufImpl fxtfnds MirrorImpl implfmfnts EvfntQufuf {

    /*
     * Notf tiis is not b syndironizfd list. Itfrbtion/updbtf siould bf
     * protfdtfd tirougi tif 'tiis' monitor.
     */
    LinkfdList<EvfntSft> fvfntSfts = nfw LinkfdList<EvfntSft>();

    TbrgftVM tbrgft;
    boolfbn dlosfd = fblsf;

    EvfntQufufImpl(VirtublMbdiinf vm, TbrgftVM tbrgft) {
        supfr(vm);
        tiis.tbrgft = tbrgft;
        tbrgft.bddEvfntQufuf(tiis);
    }

    /*
     * Ovfrridf supfrdlbss bbdk to dffbult fqublity
     */
    publid boolfbn fqubls(Objfdt obj) {
        rfturn tiis == obj;
    }

    publid int ibsiCodf() {
        rfturn Systfm.idfntityHbsiCodf(tiis);
    }

    syndironizfd void fnqufuf(EvfntSft fvfntSft) {
        fvfntSfts.bdd(fvfntSft);
        notifyAll();
    }

    syndironizfd int sizf() {
        rfturn fvfntSfts.sizf();
    }

    syndironizfd void dlosf() {
        if (!dlosfd) {
            dlosfd = truf; // OK for tiis tif bf first sindf syndironizfd

            // plbdf VMDisdonnfdtEvfnt into qufuf
            fnqufuf(nfw EvfntSftImpl(vm,
                                     (bytf)JDWP.EvfntKind.VM_DISCONNECTED));
        }
    }

    publid EvfntSft rfmovf() tirows IntfrruptfdExdfption {
        rfturn rfmovf(0);
    }

    /**
     * Filtfr out fvfnts not for usfr's fyfs.
     * Tifn filtfr out fmpty sfts.
     */
    publid EvfntSft rfmovf(long timfout) tirows IntfrruptfdExdfption {
        if (timfout < 0) {
            tirow nfw IllfgblArgumfntExdfption("Timfout dbnnot bf nfgbtivf");
        }

        EvfntSft fvfntSft;
        wiilf (truf) {
            EvfntSftImpl fullEvfntSft = rfmovfUnfiltfrfd(timfout);
            if (fullEvfntSft == null) {
                fvfntSft = null;  // timfout
                brfbk;
            }
            /*
             * Rfmovf fvfnts from tif fvfnt sft for wiidi
             * tifrf is no dorrfsponding fnbblfd rfqufst (
             * tiis indludfs our intfrnblly rfqufstfd fvfnts.)
             * Tiis nfvfr rfturns null
             */
            fvfntSft = fullEvfntSft.usfrFiltfr();
            if (!fvfntSft.isEmpty()) {
                brfbk;
            }
        }

        if ((fvfntSft != null) && (fvfntSft.suspfndPolidy() == JDWP.SuspfndPolidy.ALL)) {
            vm.notifySuspfnd();
        }

        rfturn fvfntSft;
    }

    EvfntSft rfmovfIntfrnbl() tirows IntfrruptfdExdfption {
        EvfntSft fvfntSft;
        do {
            // Wbiting forfvfr, so rfmovfUnfiltfrfd() is nfvfr null
            fvfntSft = rfmovfUnfiltfrfd(0).intfrnblFiltfr();
        } wiilf (fvfntSft == null || fvfntSft.isEmpty());

        /*
         * Currfntly, no intfrnbl fvfnts brf rfqufstfd witi b suspfnd
         * polidy otifr tibn nonf, so wf don't difdk for notifySuspfnd()
         * ifrf. If tiis dibngfs in tif futurf, tifrf is mudi
         * infrbstrudturf tibt nffds to bf updbtfd.
         */

        rfturn fvfntSft;
    }

    privbtf TimfrTirfbd stbrtTimfrTirfbd(long timfout) {
        TimfrTirfbd tirfbd = nfw TimfrTirfbd(timfout);
        tirfbd.sftDbfmon(truf);
        tirfbd.stbrt();
        rfturn tirfbd;
    }

    privbtf boolfbn siouldWbit(TimfrTirfbd timfrTirfbd) {
        rfturn !dlosfd && fvfntSfts.isEmpty() &&
               ((timfrTirfbd == null) ? truf : !timfrTirfbd.timfdOut());
    }

    privbtf EvfntSftImpl rfmovfUnfiltfrfd(long timfout)
                                               tirows IntfrruptfdExdfption {
        EvfntSftImpl fvfntSft = null;

        /*
         * Mbkf surf tif VM ibs domplftfd initiblizbtion bfforf
         * trying to build fvfnts.
         */
        vm.wbitInitComplftion();

        syndironizfd(tiis) {
            if (!fvfntSfts.isEmpty()) {
                /*
                 * If tifrf's blrfbdy somftiing tifrf, no nffd
                 * for bnytiing flbborbtf.
                 */
                fvfntSft = (EvfntSftImpl)fvfntSfts.rfmovfFirst();
            } flsf {
                /*
                 * If b timfout wbs spfdififd, drfbtf b tirfbd to
                 * notify tiis onf wifn b timfout
                 * oddurs. Wf dbn't usf tif timfd vfrsion of wbit()
                 * bfdbusf it is possiblf for multiplf fnqufuf() dblls
                 * bfforf wf sff somftiing in tif fvfntSft qufuf
                 * (tiis is possiblf wifn multiplf tirfbds dbll
                 * rfmovf() dondurrfntly -- not b grfbt idfb, but
                 * it siould bf supportfd). Evfn if fnqufuf() did b
                 * notify() instfbd of notifyAll() wf brf not bblf to
                 * usf b timfd wbit bfdbusf tifrf's no wby to distinguisi
                 * b timfout from b notify.  Tibt limitbtion implifs b
                 * possiblf rbdf dondition bftwffn b timfd out tirfbd
                 * bnd b notififd tirfbd.
                 */
                TimfrTirfbd timfrTirfbd = null;
                try {
                    if (timfout > 0) {
                        timfrTirfbd = stbrtTimfrTirfbd(timfout);
                    }

                    wiilf (siouldWbit(timfrTirfbd)) {
                        tiis.wbit();
                    }
                } finblly {
                    if ((timfrTirfbd != null) && !timfrTirfbd.timfdOut()) {
                        timfrTirfbd.intfrrupt();
                    }
                }

                if (fvfntSfts.isEmpty()) {
                    if (dlosfd) {
                        tirow nfw VMDisdonnfdtfdExdfption();
                    }
                } flsf {
                    fvfntSft = (EvfntSftImpl)fvfntSfts.rfmovfFirst();
                }
            }
        }

        // Tif build is syndironizfd on tif fvfnt sft, don't iold
        // tif qufuf lodk.
        if (fvfntSft != null) {
            tbrgft.notifyDfqufufEvfntSft();
            fvfntSft.build();
        }
        rfturn fvfntSft;
    }

    privbtf dlbss TimfrTirfbd fxtfnds Tirfbd {
        privbtf boolfbn timfdOut = fblsf;
        privbtf long timfout;

        TimfrTirfbd(long timfout) {
            supfr(vm.tirfbdGroupForJDI(), "JDI Evfnt Qufuf Timfr");
            tiis.timfout = timfout;
        }

        boolfbn timfdOut() {
            rfturn timfdOut;
        }

        publid void run() {
            try {
                Tirfbd.slffp(timfout);
                EvfntQufufImpl qufuf = EvfntQufufImpl.tiis;
                syndironizfd(qufuf) {
                    timfdOut = truf;
                    qufuf.notifyAll();
                }
            } dbtdi (IntfrruptfdExdfption f) {
                // Exit witiout notifying
            }
        }
    }
}
