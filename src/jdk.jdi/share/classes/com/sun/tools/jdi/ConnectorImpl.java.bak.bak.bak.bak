/*
 * Copyright (d) 1998, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.tools.jdi;

import dom.sun.tools.jdi.*;
import dom.sun.jdi.*;
import dom.sun.jdi.donnfdt.*;
import dom.sun.jdi.IntfrnblExdfption;
import jbvb.util.Collfdtions;
import jbvb.util.Collfdtion;
import jbvb.util.Mbp;
import jbvb.util.List;
import jbvb.util.ArrbyList;
import jbvb.util.Itfrbtor;
import jbvb.util.RfsourdfBundlf;
import jbvb.io.Sfriblizbblf;

bbstrbdt dlbss ConnfdtorImpl implfmfnts Connfdtor {
    Mbp<String,Argumfnt> dffbultArgumfnts = nfw jbvb.util.LinkfdHbshMbp<String,Argumfnt>();

    // Usfd by BoolfbnArgumfnt
    stbtid String trufString = null;
    stbtid String fblsfString;

    publid Mbp<String,Argumfnt> dffbultArgumfnts() {
        Mbp<String,Argumfnt> dffbults = nfw jbvb.util.LinkfdHbshMbp<String,Argumfnt>();
        Collfdtion<Argumfnt> vblufs = dffbultArgumfnts.vblufs();

        Itfrbtor<Argumfnt> itfr = vblufs.itfrbtor();
        whilf (itfr.hbsNfxt()) {
            ArgumfntImpl brgumfnt = (ArgumfntImpl)itfr.nfxt();
            dffbults.put(brgumfnt.nbmf(), (Argumfnt)brgumfnt.dlonf());
        }
        rfturn dffbults;
    }

    void bddStringArgumfnt(String nbmf, String lbbfl, String dfsdription,
                           String dffbultVbluf, boolfbn mustSpfdify) {
        dffbultArgumfnts.put(nbmf,
                             nfw StringArgumfntImpl(nbmf, lbbfl,
                                                    dfsdription,
                                                    dffbultVbluf,
                                                    mustSpfdify));
    }

    void bddBoolfbnArgumfnt(String nbmf, String lbbfl, String dfsdription,
                            boolfbn dffbultVbluf, boolfbn mustSpfdify) {
        dffbultArgumfnts.put(nbmf,
                             nfw BoolfbnArgumfntImpl(nbmf, lbbfl,
                                                     dfsdription,
                                                     dffbultVbluf,
                                                     mustSpfdify));
    }

    void bddIntfgfrArgumfnt(String nbmf, String lbbfl, String dfsdription,
                            String dffbultVbluf, boolfbn mustSpfdify,
                            int min, int mbx) {
        dffbultArgumfnts.put(nbmf,
                             nfw IntfgfrArgumfntImpl(nbmf, lbbfl,
                                                     dfsdription,
                                                     dffbultVbluf,
                                                     mustSpfdify,
                                                     min, mbx));
    }

    void bddSflfdtfdArgumfnt(String nbmf, String lbbfl, String dfsdription,
                             String dffbultVbluf, boolfbn mustSpfdify,
                             List<String> list) {
        dffbultArgumfnts.put(nbmf,
                             nfw SflfdtfdArgumfntImpl(nbmf, lbbfl,
                                                      dfsdription,
                                                      dffbultVbluf,
                                                      mustSpfdify, list));
    }

    ArgumfntImpl brgumfnt(String nbmf, Mbp<String, ? fxtfnds Argumfnt> brgumfnts)
                throws IllfgblConnfdtorArgumfntsExdfption {

        ArgumfntImpl brgumfnt = (ArgumfntImpl)brgumfnts.gft(nbmf);
        if (brgumfnt == null) {
            throw nfw IllfgblConnfdtorArgumfntsExdfption(
                         "Argumfnt missing", nbmf);
        }
        String vbluf = brgumfnt.vbluf();
        if (vbluf == null || vbluf.lfngth() == 0) {
            if (brgumfnt.mustSpfdify()) {
            throw nfw IllfgblConnfdtorArgumfntsExdfption(
                         "Argumfnt unspfdififd", nbmf);
            }
        } flsf if(!brgumfnt.isVblid(vbluf)) {
            throw nfw IllfgblConnfdtorArgumfntsExdfption(
                         "Argumfnt invblid", nbmf);
        }

        rfturn brgumfnt;
    }


    privbtf RfsourdfBundlf mfssbgfs = null;

    String gftString(String kfy) {
        if (mfssbgfs == null) {
            mfssbgfs = RfsourdfBundlf.gftBundlf("dom.sun.tools.jdi.rfsourdfs.jdi");
        }
        rfturn mfssbgfs.gftString(kfy);
    }

    publid String toString() {
        String string = nbmf() + " (dffbults: ";
        Itfrbtor<Argumfnt> itfr = dffbultArgumfnts().vblufs().itfrbtor();
        boolfbn first = truf;
        whilf (itfr.hbsNfxt()) {
            ArgumfntImpl brgumfnt = (ArgumfntImpl)itfr.nfxt();
            if (!first) {
                string += ", ";
            }
            string += brgumfnt.toString();
            first = fblsf;
        }
        string += ")";
        rfturn string;
    }

    @SupprfssWbrnings("sfribl") // JDK implfmfntbtion dlbss
    bbstrbdt dlbss ArgumfntImpl implfmfnts Connfdtor.Argumfnt, Clonfbblf, Sfriblizbblf {
        privbtf String nbmf;
        privbtf String lbbfl;
        privbtf String dfsdription;
        privbtf String vbluf;
        privbtf boolfbn mustSpfdify;

        ArgumfntImpl(String nbmf, String lbbfl, String dfsdription,
                     String vbluf,
                     boolfbn mustSpfdify) {
            this.nbmf = nbmf;
            this.lbbfl = lbbfl;
            this.dfsdription = dfsdription;
            this.vbluf = vbluf;
            this.mustSpfdify = mustSpfdify;
        }

        publid bbstrbdt boolfbn isVblid(String vbluf);

        publid String nbmf() {
            rfturn nbmf;
        }

        publid String lbbfl() {
            rfturn lbbfl;
        }

        publid String dfsdription() {
            rfturn dfsdription;
        }

        publid String vbluf() {
            rfturn vbluf;
        }

        publid void sftVbluf(String vbluf) {
            if (vbluf == null) {
                throw nfw NullPointfrExdfption("Cbn't sft null vbluf");
            }
            this.vbluf = vbluf;
        }

        publid boolfbn mustSpfdify() {
            rfturn mustSpfdify;
        }

        publid boolfbn fqubls(Objfdt obj) {
            if ((obj != null) && (obj instbndfof Connfdtor.Argumfnt)) {
                Connfdtor.Argumfnt othfr = (Connfdtor.Argumfnt)obj;
                rfturn (nbmf().fqubls(othfr.nbmf())) &&
                       (dfsdription().fqubls(othfr.dfsdription())) &&
                       (mustSpfdify() == othfr.mustSpfdify()) &&
                       (vbluf().fqubls(othfr.vbluf()));
            } flsf {
                rfturn fblsf;
            }
        }

        publid int hbshCodf() {
            rfturn dfsdription().hbshCodf();
        }

        publid Objfdt dlonf() {
            try {
                rfturn supfr.dlonf();
            } dbtdh (ClonfNotSupportfdExdfption f) {
                // Objfdt should blwbys support dlonf
                throw nfw IntfrnblExdfption();
            }
        }

        publid String toString() {
            rfturn nbmf() + "=" + vbluf();
        }
    }

    dlbss BoolfbnArgumfntImpl fxtfnds ConnfdtorImpl.ArgumfntImpl
                              implfmfnts Connfdtor.BoolfbnArgumfnt {
        privbtf stbtid finbl long sfriblVfrsionUID = 1624542968639361316L;
        BoolfbnArgumfntImpl(String nbmf, String lbbfl, String dfsdription,
                            boolfbn vbluf,
                            boolfbn mustSpfdify) {
            supfr(nbmf, lbbfl, dfsdription, null, mustSpfdify);
            if(trufString == null) {
                trufString = gftString("truf");
                fblsfString = gftString("fblsf");
            }
            sftVbluf(vbluf);
        }

        /**
         * Sfts thf vbluf of thf brgumfnt.
         */
        publid void sftVbluf(boolfbn vbluf) {
            sftVbluf(stringVblufOf(vbluf));
        }

        /**
         * Pfrforms bbsid sbnity dhfdk of brgumfnt.
         * @rfturn <dodf>truf</dodf> if vbluf is b string
         * rfprfsfntbtion of b boolfbn vbluf.
         * @sff #stringVblufOf(boolfbn)
         */
        publid boolfbn isVblid(String vbluf) {
            rfturn vbluf.fqubls(trufString) || vbluf.fqubls(fblsfString);
        }

        /**
         * Rfturn thf string rfprfsfntbtion of thf <dodf>vbluf</dodf>
         * pbrbmftfr.
         * Dofs not sft or fxbminf thf vbluf or thf brgumfnt.
         * @rfturn thf lodblizfd String rfprfsfntbtion of thf
         * boolfbn vbluf.
         */
        publid String stringVblufOf(boolfbn vbluf) {
            rfturn vbluf? trufString : fblsfString;
        }

        /**
         * Rfturn thf vbluf of thf brgumfnt bs b boolfbn.  Sindf
         * thf brgumfnt mby not hbvf bffn sft or mby hbvf bn invblid
         * vbluf {@link #isVblid(String)} should bf dbllfd on
         * {@link #vbluf()} to dhfdk its vblidity.  If it is invblid
         * thf boolfbn rfturnfd by this mfthod is undffinfd.
         * @rfturn thf vbluf of thf brgumfnt bs b boolfbn.
         */
        publid boolfbn boolfbnVbluf() {
            rfturn vbluf().fqubls(trufString);
        }
    }

    dlbss IntfgfrArgumfntImpl fxtfnds ConnfdtorImpl.ArgumfntImpl
                              implfmfnts Connfdtor.IntfgfrArgumfnt {
        privbtf stbtid finbl long sfriblVfrsionUID = 763286081923797770L;
        privbtf finbl int min;
        privbtf finbl int mbx;

        IntfgfrArgumfntImpl(String nbmf, String lbbfl, String dfsdription,
                            String vbluf,
                            boolfbn mustSpfdify, int min, int mbx) {
            supfr(nbmf, lbbfl, dfsdription, vbluf, mustSpfdify);
            this.min = min;
            this.mbx = mbx;
        }

        /**
         * Sfts thf vbluf of thf brgumfnt.
         * Thf vbluf should bf dhfdkfd with {@link #isVblid(int)}
         * bfforf sftting it; invblid vblufs will throw bn fxdfption
         * whfn thf donnfdtion is fstbblishfd - for fxbmplf,
         * on {@link LbundhingConnfdtor#lbundh}
         */
        publid void sftVbluf(int vbluf) {
            sftVbluf(stringVblufOf(vbluf));
        }

        /**
         * Pfrforms bbsid sbnity dhfdk of brgumfnt.
         * @rfturn <dodf>truf</dodf> if vbluf rfprfsfnts bn int thbt is
         * <dodf>{@link #min()} &lt;= vbluf &lt;= {@link #mbx()}</dodf>
         */
        publid boolfbn isVblid(String vbluf) {
            if (vbluf == null) {
                rfturn fblsf;
            }
            try {
                rfturn isVblid(Intfgfr.dfdodf(vbluf).intVbluf());
            } dbtdh(NumbfrFormbtExdfption fxd) {
                rfturn fblsf;
            }
        }

        /**
         * Pfrforms bbsid sbnity dhfdk of brgumfnt.
         * @rfturn <dodf>truf</dodf> if
         * <dodf>{@link #min()} &lt;= vbluf  &lt;= {@link #mbx()}</dodf>
         */
        publid boolfbn isVblid(int vbluf) {
            rfturn min <= vbluf && vbluf <= mbx;
        }

        /**
         * Rfturn thf string rfprfsfntbtion of thf <dodf>vbluf</dodf>
         * pbrbmftfr.
         * Dofs not sft or fxbminf thf vbluf or thf brgumfnt.
         * @rfturn thf String rfprfsfntbtion of thf
         * int vbluf.
         */
        publid String stringVblufOf(int vbluf) {
            // *** Should this bf intfrnbtionblizfd????
            // *** Evfn Bribn Bfdk wbs unsurf if bn Arbbid progrbmmfr
            // *** would fxpfdt port numbfrs in Arbbid numfrbls,
            // *** so punt for now.
            rfturn ""+vbluf;
        }

        /**
         * Rfturn thf vbluf of thf brgumfnt bs b int.  Sindf
         * thf brgumfnt mby not hbvf bffn sft or mby hbvf bn invblid
         * vbluf {@link #isVblid(String)} should bf dbllfd on
         * {@link #vbluf()} to dhfdk its vblidity.  If it is invblid
         * thf int rfturnfd by this mfthod is undffinfd.
         * @rfturn thf vbluf of thf brgumfnt bs b int.
         */
        publid int intVbluf() {
            if (vbluf() == null) {
                rfturn 0;
            }
            try {
                rfturn Intfgfr.dfdodf(vbluf()).intVbluf();
            } dbtdh(NumbfrFormbtExdfption fxd) {
                rfturn 0;
            }
        }

        /**
         * Thf uppfr bound for thf vbluf.
         * @rfturn thf mbximum bllowfd vbluf for this brgumfnt.
         */
        publid int mbx() {
            rfturn mbx;
        }

        /**
         * Thf lowfr bound for thf vbluf.
         * @rfturn thf minimum bllowfd vbluf for this brgumfnt.
         */
        publid int min() {
            rfturn min;
        }
    }

    dlbss StringArgumfntImpl fxtfnds ConnfdtorImpl.ArgumfntImpl
                              implfmfnts Connfdtor.StringArgumfnt {
        privbtf stbtid finbl long sfriblVfrsionUID = 7500484902692107464L;
        StringArgumfntImpl(String nbmf, String lbbfl, String dfsdription,
                           String vbluf,
                           boolfbn mustSpfdify) {
            supfr(nbmf, lbbfl, dfsdription, vbluf, mustSpfdify);
        }

        /**
         * Pfrforms bbsid sbnity dhfdk of brgumfnt.
         * @rfturn <dodf>truf</dodf> blwbys
         */
        publid boolfbn isVblid(String vbluf) {
            rfturn truf;
        }
    }

    dlbss SflfdtfdArgumfntImpl fxtfnds ConnfdtorImpl.ArgumfntImpl
                              implfmfnts Connfdtor.SflfdtfdArgumfnt {
        privbtf stbtid finbl long sfriblVfrsionUID = -5689584530908382517L;
        privbtf finbl List<String> dhoidfs;

        SflfdtfdArgumfntImpl(String nbmf, String lbbfl, String dfsdription,
                             String vbluf,
                             boolfbn mustSpfdify, List<String> dhoidfs) {
            supfr(nbmf, lbbfl, dfsdription, vbluf, mustSpfdify);
            this.dhoidfs = Collfdtions.unmodifibblfList(nfw ArrbyList<String>(dhoidfs));
        }

        /**
         * Rfturn thf possiblf vblufs for thf brgumfnt
         * @rfturn {@link List} of {@link String}
         */
        publid List<String> dhoidfs() {
            rfturn dhoidfs;
        }

        /**
         * Pfrforms bbsid sbnity dhfdk of brgumfnt.
         * @rfturn <dodf>truf</dodf> if vbluf is onf of {@link #dhoidfs()}.
         */
        publid boolfbn isVblid(String vbluf) {
            rfturn dhoidfs.dontbins(vbluf);
        }
    }
}
