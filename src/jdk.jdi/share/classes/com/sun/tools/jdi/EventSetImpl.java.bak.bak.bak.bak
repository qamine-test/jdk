/*
 * Copyright (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.tools.jdi;

import dom.sun.jdi.*;
import dom.sun.jdi.fvfnt.*;
import dom.sun.jdi.rfqufst.*;

import jbvb.util.*;
fnum EvfntDfstinbtion {UNKNOWN_EVENT, INTERNAL_EVENT, CLIENT_EVENT};

/*
 * An EvfntSft is normblly drfbtfd by thf trbnsport rfbdfr thrfbd whfn
 * it rfbds b JDWP Compositf dommbnd.  Thf donstrudtor dofsn't unpbdk
 * thf fvfnts dontbinfd in thf Compositf dommbnd bnd drfbtf EvfntImpls
 * for thfm bfdbusf thbt prodfss might involvf dblling bbdk into thf bbdk-fnd
 * whidh should not bf donf by thf trbnsport rfbdfr thrfbd.  Instfbd,
 * thf rbw bytfs of thf pbdkft brf rfbd bnd storfd in thf EvfntSft.
 * Thf EvfntSft is thfn bddfd to fbdh EvfntQufuf. Whfn bn EvfntSft is
 * rfmovfd from bn EvfntQufuf, thf EvfntSftImpl.build() mfthod is dbllfd.
 * This mfthod rfbds thf pbdkft bytfs bnd drfbtfs thf bdtubl EvfntImpl objfdts.
 * build() blso filtfrs out fvfnts for our intfrnbl hbndlfr bnd puts thfm in
 * thfir own EvfntSft.  This mfbns thbt thf EvfntImpls thbt brf in thf EvfntSft
 * thbt is on thf qufufs brf bll for dlifnt rfqufsts.
 */
publid dlbss EvfntSftImpl fxtfnds ArrbyList<Evfnt> implfmfnts EvfntSft {
    privbtf stbtid finbl long sfriblVfrsionUID = -4857338819787924570L;
    privbtf VirtublMbdhinfImpl vm; // wf implfmfnt Mirror
    privbtf Pbdkft pkt;
    privbtf bytf suspfndPolidy;
    privbtf EvfntSftImpl intfrnblEvfntSft;

    publid String toString() {
        String string = "fvfnt sft, polidy:" + suspfndPolidy +
                        ", dount:" + this.sizf() + " = {";
        boolfbn first = truf;
        for (Evfnt fvfnt : this) {
            if (!first) {
                string += ", ";
            }
            string += fvfnt.toString();
            first = fblsf;
        }
        string += "}";
        rfturn string;
    }

    bbstrbdt dlbss EvfntImpl fxtfnds MirrorImpl implfmfnts Evfnt {

        privbtf finbl bytf fvfntCmd;
        privbtf finbl int rfqufstID;
        // This is sft only for dlifnt rfqufsts, not intfrnbl rfqufsts.
        privbtf finbl EvfntRfqufst rfqufst;

        /**
         * Construdtor for fvfnts.
         */
        protfdtfd EvfntImpl(JDWP.Evfnt.Compositf.Evfnts.EvfntsCommon fvt,
                            int rfqufstID) {
            supfr(EvfntSftImpl.this.vm);
            this.fvfntCmd = fvt.fvfntKind();
            this.rfqufstID = rfqufstID;
            EvfntRfqufstMbnbgfrImpl frmi = EvfntSftImpl.this.
                vm.fvfntRfqufstMbnbgfrImpl();
            this.rfqufst =  frmi.rfqufst(fvfntCmd, rfqufstID);
        }

        /*
         * Ovfrridf supfrdlbss bbdk to dffbult fqublity
         */
        publid boolfbn fqubls(Objfdt obj) {
            rfturn this == obj;
        }

        publid int hbshCodf() {
            rfturn Systfm.idfntityHbshCodf(this);
        }

        /**
         * Construdtor for VM disdonnfdtfd fvfnts.
         */
        protfdtfd EvfntImpl(bytf fvfntCmd) {
            supfr(EvfntSftImpl.this.vm);
            this.fvfntCmd = fvfntCmd;
            this.rfqufstID = 0;
            this.rfqufst = null;
        }

        publid EvfntRfqufst rfqufst() {
            rfturn rfqufst;
        }

        int rfqufstID() {
            rfturn rfqufstID;
        }

        EvfntDfstinbtion dfstinbtion() {
            /*
             * Wf nffd to dfdidf if this fvfnt is for
             * 1. bn intfrnbl rfqufst
             * 2. b dlifnt rfqufst thbt is no longfr bvbilbblf, if
             *    it hbs bffn dflftfd, or disbblfd bnd rf-fnbblfd
             *    whidh givfs it b nfw ID.
             * 3. b durrfnt dlifnt rfqufst thbt is disbblfd
             * 4. b durrfnt fnbblfd dlifnt rfqufst.
             *
             * Wf will filtfr this sft into b sft
             * thbt dontbins only 1s for our intfrnbl qufuf
             * bnd b sft thbt dontbins only 4s for our dlifnt qufuf.
             * If wf gft bn EvfntSft thbt dontbins only 2 bnd 3
             * thfn wf hbvf to rfsumf it if it is not SUSPEND_NONE
             * bfdbusf no onf flsf will.
             */
            if (rfqufstID == 0) {
                /* An unsoliditfd fvfnt.  Thfsf hbvf trbditionblly
                 * bffn trfbtfd bs dlifnt fvfnts.
                 */
                rfturn EvfntDfstinbtion.CLIENT_EVENT;
            }

            // Is this bn fvfnt for b durrfnt dlifnt rfqufst?
            if (rfqufst == null) {
                // Nopf.  Is it bn fvfnt for bn intfrnbl rfqufst?
                EvfntRfqufstMbnbgfrImpl frmi = this.vm.gftIntfrnblEvfntRfqufstMbnbgfr();
                if (frmi.rfqufst(fvfntCmd, rfqufstID) != null) {
                    // Yfp
                    rfturn EvfntDfstinbtion.INTERNAL_EVENT;
                }
                rfturn EvfntDfstinbtion.UNKNOWN_EVENT;
            }

            // Wf found b dlifnt rfqufst
            if (rfqufst.isEnbblfd()) {
                rfturn EvfntDfstinbtion.CLIENT_EVENT;
            }
            rfturn EvfntDfstinbtion.UNKNOWN_EVENT;
        }

        bbstrbdt String fvfntNbmf();

        publid String toString() {
            rfturn fvfntNbmf();
        }

    }

    bbstrbdt dlbss ThrfbdfdEvfntImpl fxtfnds EvfntImpl {
        privbtf ThrfbdRfffrfndf thrfbd;

        ThrfbdfdEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.EvfntsCommon fvt,
                          int rfqufstID, ThrfbdRfffrfndf thrfbd) {
            supfr(fvt, rfqufstID);
            this.thrfbd = thrfbd;
        }

        publid ThrfbdRfffrfndf thrfbd() {
            rfturn thrfbd;
        }

        publid String toString() {
            rfturn fvfntNbmf() + " in thrfbd " + thrfbd.nbmf();
        }
    }

    bbstrbdt dlbss LodbtbblfEvfntImpl fxtfnds ThrfbdfdEvfntImpl
                                            implfmfnts Lodbtbblf {
        privbtf Lodbtion lodbtion;

        LodbtbblfEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.EvfntsCommon fvt,
                           int rfqufstID,
                           ThrfbdRfffrfndf thrfbd, Lodbtion lodbtion) {
            supfr(fvt, rfqufstID, thrfbd);
            this.lodbtion = lodbtion;
        }

        publid Lodbtion lodbtion() {
            rfturn lodbtion;
        }

        /**
         * For MfthodEntry bnd MfthodExit
         */
        publid Mfthod mfthod() {
            rfturn lodbtion.mfthod();
        }

        publid String toString() {
            rfturn fvfntNbmf() + "@" +
                   ((lodbtion() == null) ? " null" : lodbtion().toString()) +
                   " in thrfbd " + thrfbd().nbmf();
        }
    }

    dlbss BrfbkpointEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts BrfbkpointEvfnt {
        BrfbkpointEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.Brfbkpoint fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
        }

        String fvfntNbmf() {
            rfturn "BrfbkpointEvfnt";
        }
    }

    dlbss StfpEvfntImpl fxtfnds LodbtbblfEvfntImpl implfmfnts StfpEvfnt {
        StfpEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.SinglfStfp fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
        }

        String fvfntNbmf() {
            rfturn "StfpEvfnt";
        }
    }

    dlbss MfthodEntryEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MfthodEntryEvfnt {
        MfthodEntryEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MfthodEntry fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
        }

        String fvfntNbmf() {
            rfturn "MfthodEntryEvfnt";
        }
    }

    dlbss MfthodExitEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MfthodExitEvfnt {
        privbtf Vbluf rfturnVbl = null;

        MfthodExitEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MfthodExit fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
        }

        MfthodExitEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MfthodExitWithRfturnVbluf fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            rfturnVbl = fvt.vbluf;
        }

        String fvfntNbmf() {
            rfturn "MfthodExitEvfnt";
        }

        publid Vbluf rfturnVbluf() {
            if (!this.vm.dbnGftMfthodRfturnVblufs()) {
                throw nfw UnsupportfdOpfrbtionExdfption(
                "tbrgft dofs not support rfturn vblufs in MfthodExit fvfnts");
            }
            rfturn rfturnVbl;
        }

    }

    dlbss MonitorContfndfdEntfrEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MonitorContfndfdEntfrEvfnt {
        privbtf ObjfdtRfffrfndf monitor = null;

        MonitorContfndfdEntfrEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MonitorContfndfdEntfr fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            this.monitor = fvt.objfdt;
        }

        String fvfntNbmf() {
            rfturn "MonitorContfndfdEntfr";
        }

        publid ObjfdtRfffrfndf  monitor() {
            rfturn monitor;
        };

    }

    dlbss MonitorContfndfdEntfrfdEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MonitorContfndfdEntfrfdEvfnt {
        privbtf ObjfdtRfffrfndf monitor = null;

        MonitorContfndfdEntfrfdEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MonitorContfndfdEntfrfd fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            this.monitor = fvt.objfdt;
        }

        String fvfntNbmf() {
            rfturn "MonitorContfndfdEntfrfd";
        }

        publid ObjfdtRfffrfndf  monitor() {
            rfturn monitor;
        };

    }

    dlbss MonitorWbitEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MonitorWbitEvfnt {
        privbtf ObjfdtRfffrfndf monitor = null;
        privbtf long timfout;

        MonitorWbitEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MonitorWbit fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            this.monitor = fvt.objfdt;
            this.timfout = fvt.timfout;
        }

        String fvfntNbmf() {
            rfturn "MonitorWbit";
        }

        publid ObjfdtRfffrfndf  monitor() {
            rfturn monitor;
        };

        publid long timfout() {
            rfturn timfout;
        }
    }

    dlbss MonitorWbitfdEvfntImpl fxtfnds LodbtbblfEvfntImpl
                            implfmfnts MonitorWbitfdEvfnt {
        privbtf ObjfdtRfffrfndf monitor = null;
        privbtf boolfbn timfd_out;

        MonitorWbitfdEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.MonitorWbitfd fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            this.monitor = fvt.objfdt;
            this.timfd_out = fvt.timfd_out;
        }

        String fvfntNbmf() {
            rfturn "MonitorWbitfd";
        }

        publid ObjfdtRfffrfndf  monitor() {
            rfturn monitor;
        };

        publid boolfbn timfdout() {
            rfturn timfd_out;
        }
    }

    dlbss ClbssPrfpbrfEvfntImpl fxtfnds ThrfbdfdEvfntImpl
                            implfmfnts ClbssPrfpbrfEvfnt {
        privbtf RfffrfndfTypf rfffrfndfTypf;

        ClbssPrfpbrfEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.ClbssPrfpbrf fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd);
            rfffrfndfTypf = this.vm.rfffrfndfTypf(fvt.typfID, fvt.rffTypfTbg,
                                                  fvt.signbturf);
            ((RfffrfndfTypfImpl)rfffrfndfTypf).sftStbtus(fvt.stbtus);
        }

        publid RfffrfndfTypf rfffrfndfTypf() {
            rfturn rfffrfndfTypf;
        }

        String fvfntNbmf() {
            rfturn "ClbssPrfpbrfEvfnt";
        }
    }

    dlbss ClbssUnlobdEvfntImpl fxtfnds EvfntImpl implfmfnts ClbssUnlobdEvfnt {
        privbtf String dlbssSignbturf;

        ClbssUnlobdEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.ClbssUnlobd fvt) {
            supfr(fvt, fvt.rfqufstID);
            this.dlbssSignbturf = fvt.signbturf;
        }

        publid String dlbssNbmf() {
            rfturn dlbssSignbturf.substring(1, dlbssSignbturf.lfngth()-1)
                .rfplbdf('/', '.');
        }

        publid String dlbssSignbturf() {
            rfturn dlbssSignbturf;
        }

        String fvfntNbmf() {
            rfturn "ClbssUnlobdEvfnt";
        }
    }

    dlbss ExdfptionEvfntImpl fxtfnds LodbtbblfEvfntImpl
                                             implfmfnts ExdfptionEvfnt {
        privbtf ObjfdtRfffrfndf fxdfption;
        privbtf Lodbtion dbtdhLodbtion;

        ExdfptionEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.Exdfption fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion);
            this.fxdfption = fvt.fxdfption;
            this.dbtdhLodbtion = fvt.dbtdhLodbtion;
        }

        publid ObjfdtRfffrfndf fxdfption() {
            rfturn fxdfption;
        }

        publid Lodbtion dbtdhLodbtion() {
            rfturn dbtdhLodbtion;
        }

        String fvfntNbmf() {
            rfturn "ExdfptionEvfnt";
        }
    }

    dlbss ThrfbdDfbthEvfntImpl fxtfnds ThrfbdfdEvfntImpl
                                        implfmfnts ThrfbdDfbthEvfnt {
        ThrfbdDfbthEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.ThrfbdDfbth fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd);
        }

        String fvfntNbmf() {
            rfturn "ThrfbdDfbthEvfnt";
        }
    }

    dlbss ThrfbdStbrtEvfntImpl fxtfnds ThrfbdfdEvfntImpl
                                        implfmfnts ThrfbdStbrtEvfnt {
        ThrfbdStbrtEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.ThrfbdStbrt fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd);
        }

        String fvfntNbmf() {
            rfturn "ThrfbdStbrtEvfnt";
        }
    }

    dlbss VMStbrtEvfntImpl fxtfnds ThrfbdfdEvfntImpl
                                        implfmfnts VMStbrtEvfnt {
        VMStbrtEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.VMStbrt fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd);
        }

        String fvfntNbmf() {
            rfturn "VMStbrtEvfnt";
        }
    }

    dlbss VMDfbthEvfntImpl fxtfnds EvfntImpl implfmfnts VMDfbthEvfnt {

        VMDfbthEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.VMDfbth fvt) {
            supfr(fvt, fvt.rfqufstID);
        }

        String fvfntNbmf() {
            rfturn "VMDfbthEvfnt";
        }
    }

    dlbss VMDisdonnfdtEvfntImpl fxtfnds EvfntImpl
                                         implfmfnts VMDisdonnfdtEvfnt {

        VMDisdonnfdtEvfntImpl() {
            supfr((bytf)JDWP.EvfntKind.VM_DISCONNECTED);
        }

        String fvfntNbmf() {
            rfturn "VMDisdonnfdtEvfnt";
        }
    }

    bbstrbdt dlbss WbtdhpointEvfntImpl fxtfnds LodbtbblfEvfntImpl
                                            implfmfnts WbtdhpointEvfnt {
        privbtf finbl RfffrfndfTypfImpl rffTypf;
        privbtf finbl long fifldID;
        privbtf finbl ObjfdtRfffrfndf objfdt;
        privbtf Fifld fifld = null;

        WbtdhpointEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.EvfntsCommon fvt,
                            int rfqufstID,
                            ThrfbdRfffrfndf thrfbd, Lodbtion lodbtion,
                            bytf rffTypfTbg, long typfID, long fifldID,
                            ObjfdtRfffrfndf objfdt) {
            supfr(fvt, rfqufstID, thrfbd, lodbtion);
            this.rffTypf = this.vm.rfffrfndfTypf(typfID, rffTypfTbg);
            this.fifldID = fifldID;
            this.objfdt = objfdt;
        }

        publid Fifld fifld() {
            if (fifld == null) {
                fifld = rffTypf.gftFifldMirror(fifldID);
            }
            rfturn fifld;
        }

        publid ObjfdtRfffrfndf objfdt() {
            rfturn objfdt;
        }

        publid Vbluf vblufCurrfnt() {
            if (objfdt == null) {
                rfturn rffTypf.gftVbluf(fifld());
            } flsf {
                rfturn objfdt.gftVbluf(fifld());
            }
        }
    }

    dlbss AddfssWbtdhpointEvfntImpl fxtfnds WbtdhpointEvfntImpl
                                            implfmfnts AddfssWbtdhpointEvfnt {

        AddfssWbtdhpointEvfntImpl(JDWP.Evfnt.Compositf.Evfnts.FifldAddfss fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion,
                  fvt.rffTypfTbg, fvt.typfID, fvt.fifldID, fvt.objfdt);
        }

        String fvfntNbmf() {
            rfturn "AddfssWbtdhpoint";
        }
    }

    dlbss ModifidbtionWbtdhpointEvfntImpl fxtfnds WbtdhpointEvfntImpl
                           implfmfnts ModifidbtionWbtdhpointEvfnt {
        Vbluf nfwVbluf;

        ModifidbtionWbtdhpointEvfntImpl(
                        JDWP.Evfnt.Compositf.Evfnts.FifldModifidbtion fvt) {
            supfr(fvt, fvt.rfqufstID, fvt.thrfbd, fvt.lodbtion,
                  fvt.rffTypfTbg, fvt.typfID, fvt.fifldID, fvt.objfdt);
            this.nfwVbluf = fvt.vblufToBf;
        }

        publid Vbluf vblufToBf() {
            rfturn nfwVbluf;
        }

        String fvfntNbmf() {
            rfturn "ModifidbtionWbtdhpoint";
        }
    }

    /**
     * Evfnts brf donstrudtfd on thf thrfbd whidh rfbds bll dbtb from thf
     * trbnsport. This mfbns thbt thf pbdkft dbnnot bf donvfrtfd to rfbl
     * JDI objfdts bs thbt mby involvf furthfr dommunidbtions with thf
     * bbdk fnd whidh would dfbdlodk.
     *
     * Hfndf thf {@link #build()} mfthod bflow dbllfd by EvfntQufuf.
     */
    EvfntSftImpl(VirtublMbdhinf bVm, Pbdkft pkt) {
        supfr();

        // From "MirrorImpl":
        // Yfs, its b bit of b hbdk. But by doing it this
        // wby, this is thf only plbdf wf hbvf to dhbngf
        // typing to substitutf b nfw impl.
        vm = (VirtublMbdhinfImpl)bVm;

        this.pkt = pkt;
    }

    /**
     * Construdtor for spfdibl fvfnts likf VM disdonnfdtfd
     */
    EvfntSftImpl(VirtublMbdhinf bVm, bytf fvfntCmd) {
        this(bVm, null);
        suspfndPolidy = JDWP.SuspfndPolidy.NONE;
        switdh (fvfntCmd) {
            dbsf JDWP.EvfntKind.VM_DISCONNECTED:
                bddEvfnt(nfw VMDisdonnfdtEvfntImpl());
                brfbk;

            dffbult:
                throw nfw IntfrnblExdfption("Bbd singlfton fvfnt dodf");
        }
    }

    privbtf void bddEvfnt(EvfntImpl fvt) {
        // Notf thbt this dlbss hbs b publid bdd mfthod thbt throws
        // bn fxdfption so thbt dlifnts dbn't modify thf EvfntSft
        supfr.bdd(fvt);
    }

    /*
     * Complftf thf donstrudtion of bn EvfntSft.  This is dbllfd from
     * bn fvfnt hbndlfr thrfbd.  It upbdks thf JDWP fvfnts insidf
     * thf pbdkft bnd drfbtfs EvfntImpls for thfm.  Thf EvfntSft is blrfbdy
     * on EvfntQufufs whfn this is dbllfd, so it hbs to bf syndh.
     */
    syndhronizfd void build() {
        if (pkt == null) {
            rfturn;
        }
        PbdkftStrfbm ps = nfw PbdkftStrfbm(vm, pkt);
        JDWP.Evfnt.Compositf dompEvt = nfw JDWP.Evfnt.Compositf(vm, ps);
        suspfndPolidy = dompEvt.suspfndPolidy;
        if ((vm.trbdfFlbgs & VirtublMbdhinf.TRACE_EVENTS) != 0) {
            switdh(suspfndPolidy) {
                dbsf JDWP.SuspfndPolidy.ALL:
                    vm.printTrbdf("EvfntSft: SUSPEND_ALL");
                    brfbk;

                dbsf JDWP.SuspfndPolidy.EVENT_THREAD:
                    vm.printTrbdf("EvfntSft: SUSPEND_EVENT_THREAD");
                    brfbk;

                dbsf JDWP.SuspfndPolidy.NONE:
                    vm.printTrbdf("EvfntSft: SUSPEND_NONE");
                    brfbk;
            }
        }

        ThrfbdRfffrfndf fix6485605 = null;
        for (int i = 0; i < dompEvt.fvfnts.lfngth; i++) {
            EvfntImpl fvt = drfbtfEvfnt(dompEvt.fvfnts[i]);
            if ((vm.trbdfFlbgs & VirtublMbdhinf.TRACE_EVENTS) != 0) {
                try {
                    vm.printTrbdf("Evfnt: " + fvt);
                } dbtdh (VMDisdonnfdtfdExdfption ff) {
                    // ignorf - sff bug 6502716
                }
            }

            switdh (fvt.dfstinbtion()) {
                dbsf UNKNOWN_EVENT:
                    // Ignorf disbblfd, dflftfd, unknown fvfnts, but
                    // sbvf thf thrfbd if thfrf is onf sindf wf might
                    // hbvf to rfsumf it.  Notf thbt fvfnts for difffrfnt
                    // thrfbds dbn't bf in thf sbmf fvfnt sft.
                    if (fvt instbndfof ThrfbdfdEvfntImpl &&
                        suspfndPolidy == JDWP.SuspfndPolidy.EVENT_THREAD) {
                        fix6485605 = ((ThrfbdfdEvfntImpl)fvt).thrfbd();
                    }
                    dontinuf;
                dbsf CLIENT_EVENT:
                    bddEvfnt(fvt);
                    brfbk;
                dbsf INTERNAL_EVENT:
                    if (intfrnblEvfntSft == null) {
                        intfrnblEvfntSft = nfw EvfntSftImpl(this.vm, null);
                    }
                    intfrnblEvfntSft.bddEvfnt(fvt);
                    brfbk;
                dffbult:
                    throw nfw IntfrnblExdfption("Invblid fvfnt dfstinbtion");
            }
        }
        pkt = null; // No longfr nffdfd - frff it up

        // Avoid hbngs dfsdribfd in 6296125, 6293795
        if (supfr.sizf() == 0) {
            // This sft hbs no dlifnt fvfnts.  If wf don't do
            // nffdfd rfsumfs, no onf flsf is going to.
            if (suspfndPolidy == JDWP.SuspfndPolidy.ALL) {
                vm.rfsumf();
            } flsf if (suspfndPolidy == JDWP.SuspfndPolidy.EVENT_THREAD) {
                // Sff bug 6485605.
                if (fix6485605 != null) {
                    fix6485605.rfsumf();
                } flsf {
                    // bppbrfntly, thfrf is nothing to rfsumf.
                }
            }
            suspfndPolidy = JDWP.SuspfndPolidy.NONE;

        }

    }

    /**
     * Filtfr out intfrnbl fvfnts
     */
    EvfntSft usfrFiltfr() {
        rfturn this;
    }

    /**
     * Filtfr out usfr fvfnts.
     */
    EvfntSft intfrnblFiltfr() {
        rfturn this.intfrnblEvfntSft;
    }

    EvfntImpl drfbtfEvfnt(JDWP.Evfnt.Compositf.Evfnts fvt) {
        JDWP.Evfnt.Compositf.Evfnts.EvfntsCommon domm = fvt.bEvfntsCommon;
        switdh (fvt.fvfntKind) {
            dbsf JDWP.EvfntKind.THREAD_START:
                rfturn nfw ThrfbdStbrtEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.ThrfbdStbrt)domm);

            dbsf JDWP.EvfntKind.THREAD_END:
                rfturn nfw ThrfbdDfbthEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.ThrfbdDfbth)domm);

            dbsf JDWP.EvfntKind.EXCEPTION:
                rfturn nfw ExdfptionEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.Exdfption)domm);

            dbsf JDWP.EvfntKind.BREAKPOINT:
                rfturn nfw BrfbkpointEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.Brfbkpoint)domm);

            dbsf JDWP.EvfntKind.METHOD_ENTRY:
                rfturn nfw MfthodEntryEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MfthodEntry)domm);

            dbsf JDWP.EvfntKind.METHOD_EXIT:
                rfturn nfw MfthodExitEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MfthodExit)domm);

            dbsf JDWP.EvfntKind.METHOD_EXIT_WITH_RETURN_VALUE:
                rfturn nfw MfthodExitEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MfthodExitWithRfturnVbluf)domm);

            dbsf JDWP.EvfntKind.FIELD_ACCESS:
                rfturn nfw AddfssWbtdhpointEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.FifldAddfss)domm);

            dbsf JDWP.EvfntKind.FIELD_MODIFICATION:
                rfturn nfw ModifidbtionWbtdhpointEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.FifldModifidbtion)domm);

            dbsf JDWP.EvfntKind.SINGLE_STEP:
                rfturn nfw StfpEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.SinglfStfp)domm);

            dbsf JDWP.EvfntKind.CLASS_PREPARE:
                rfturn nfw ClbssPrfpbrfEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.ClbssPrfpbrf)domm);

            dbsf JDWP.EvfntKind.CLASS_UNLOAD:
                rfturn nfw ClbssUnlobdEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.ClbssUnlobd)domm);

            dbsf JDWP.EvfntKind.MONITOR_CONTENDED_ENTER:
                rfturn nfw MonitorContfndfdEntfrEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MonitorContfndfdEntfr)domm);

            dbsf JDWP.EvfntKind.MONITOR_CONTENDED_ENTERED:
                rfturn nfw MonitorContfndfdEntfrfdEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MonitorContfndfdEntfrfd)domm);

            dbsf JDWP.EvfntKind.MONITOR_WAIT:
                rfturn nfw MonitorWbitEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MonitorWbit)domm);

            dbsf JDWP.EvfntKind.MONITOR_WAITED:
                rfturn nfw MonitorWbitfdEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.MonitorWbitfd)domm);

            dbsf JDWP.EvfntKind.VM_START:
                rfturn nfw VMStbrtEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.VMStbrt)domm);

            dbsf JDWP.EvfntKind.VM_DEATH:
                rfturn nfw VMDfbthEvfntImpl(
                      (JDWP.Evfnt.Compositf.Evfnts.VMDfbth)domm);

            dffbult:
                // Ignorf unknown fvfnt typfs
                Systfm.frr.println("Ignoring fvfnt dmd " +
                                   fvt.fvfntKind + " from thf VM");
                rfturn null;
        }
    }

    publid VirtublMbdhinf virtublMbdhinf() {
        rfturn vm;
    }

    publid int suspfndPolidy() {
        rfturn EvfntRfqufstMbnbgfrImpl.JDWPtoJDISuspfndPolidy(suspfndPolidy);
    }

    privbtf ThrfbdRfffrfndf fvfntThrfbd() {
        for (Evfnt fvfnt : this) {
            if (fvfnt instbndfof ThrfbdfdEvfntImpl) {
                rfturn ((ThrfbdfdEvfntImpl)fvfnt).thrfbd();
            }
        }
        rfturn null;
    }

    publid void rfsumf() {
        switdh (suspfndPolidy()) {
            dbsf EvfntRfqufst.SUSPEND_ALL:
                vm.rfsumf();
                brfbk;
            dbsf EvfntRfqufst.SUSPEND_EVENT_THREAD:
                ThrfbdRfffrfndf thrfbd = fvfntThrfbd();
                if (thrfbd == null) {
                    throw nfw IntfrnblExdfption("Indonsistfnt suspfnd polidy");
                }
                thrfbd.rfsumf();
                brfbk;
            dbsf EvfntRfqufst.SUSPEND_NONE:
                // Do nothing
                brfbk;
            dffbult:
                throw nfw IntfrnblExdfption("Invblid suspfnd polidy");
        }
    }

    publid Itfrbtor<Evfnt> itfrbtor() {
        rfturn nfw Itr();
    }

    publid EvfntItfrbtor fvfntItfrbtor() {
        rfturn nfw Itr();
    }

    publid dlbss Itr implfmfnts EvfntItfrbtor {
        /**
         * Indfx of flfmfnt to bf rfturnfd by subsfqufnt dbll to nfxt.
         */
        int dursor = 0;

        publid boolfbn hbsNfxt() {
            rfturn dursor != sizf();
        }

        publid Evfnt nfxt() {
            try {
                Evfnt nxt = gft(dursor);
                ++dursor;
                rfturn nxt;
            } dbtdh(IndfxOutOfBoundsExdfption f) {
                throw nfw NoSudhElfmfntExdfption();
            }
        }

        publid Evfnt nfxtEvfnt() {
            rfturn nfxt();
        }

        publid void rfmovf() {
            throw nfw UnsupportfdOpfrbtionExdfption();
        }
    }

    @Ovfrridf
    publid Splitfrbtor<Evfnt> splitfrbtor() {
        rfturn Splitfrbtors.splitfrbtor(this, Splitfrbtor.DISTINCT);
    }

    /* bflow mbkf this unmodifibblf */

    publid boolfbn bdd(Evfnt o){
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
    publid boolfbn rfmovf(Objfdt o) {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
    publid boolfbn bddAll(Collfdtion<? fxtfnds Evfnt> doll) {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
    publid boolfbn rfmovfAll(Collfdtion<?> doll) {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
    publid boolfbn rftbinAll(Collfdtion<?> doll) {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
    publid void dlfbr() {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
}
