/*
 * Copyrigit (d) 1998, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.tools.jdi;

import dom.sun.jdi.*;
import dom.sun.jdi.donnfdt.spi.Connfdtion;
import dom.sun.jdi.rfqufst.EvfntRfqufstMbnbgfr;
import dom.sun.jdi.rfqufst.EvfntRfqufst;
import dom.sun.jdi.rfqufst.BrfbkpointRfqufst;
import dom.sun.jdi.fvfnt.EvfntQufuf;

import jbvb.util.*;
import jbvb.tfxt.MfssbgfFormbt;
import jbvb.lbng.rff.RfffrfndfQufuf;
import jbvb.lbng.rff.Rfffrfndf;
import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.lbng.rff.WfbkRfffrfndf;

dlbss VirtublMbdiinfImpl fxtfnds MirrorImpl
             implfmfnts PbtiSfbrdiingVirtublMbdiinf, TirfbdListfnfr {
    // VM Lfvfl fxportfd vbribblfs, tifsf
    // brf uniquf to b givfn vm
    publid finbl int sizfofFifldRff;
    publid finbl int sizfofMftiodRff;
    publid finbl int sizfofObjfdtRff;
    publid finbl int sizfofClbssRff;
    publid finbl int sizfofFrbmfRff;

    finbl int sfqufndfNumbfr;

    privbtf finbl TbrgftVM tbrgft;
    privbtf finbl EvfntQufufImpl fvfntQufuf;
    privbtf finbl EvfntRfqufstMbnbgfrImpl intfrnblEvfntRfqufstMbnbgfr;
    privbtf finbl EvfntRfqufstMbnbgfrImpl fvfntRfqufstMbnbgfr;
    finbl VirtublMbdiinfMbnbgfrImpl vmMbnbgfr;
    privbtf finbl TirfbdGroup tirfbdGroupForJDI;

    // Allow dirfdt bddfss to tiis fifld so tibt tibt trbding dodf slows down
    // JDI bs littlf bs possiblf wifn not fnbblfd.
    int trbdfFlbgs = TRACE_NONE;

    stbtid int TRACE_RAW_SENDS     = 0x01000000;
    stbtid int TRACE_RAW_RECEIVES  = 0x02000000;

    boolfbn trbdfRfdfivfs = fblsf;   // prf-domputf bfdbusf of frfqufndy

    // RfffrfndfTypf bddfss - updbtfd witi dlbss prfpbrf bnd unlobd fvfnts
    // Protfdtfd by "syndironizfd(tiis)". "rftrifvfdAllTypfs" mby bf
    // tfstfd unsyndironizfd (sindf ondf truf, it stbys truf), but must
    // bf sft syndironously
    privbtf Mbp<Long, RfffrfndfTypf> typfsByID;
    privbtf TrffSft<RfffrfndfTypf> typfsBySignbturf;
    privbtf boolfbn rftrifvfdAllTypfs = fblsf;

    // For otifr lbngubgfs support
    privbtf String dffbultStrbtum = null;

    // ObjfdtRfffrfndf dbdif
    // "objfdtsByID" protfdtfd by "syndironizfd(tiis)".
    privbtf finbl Mbp<Long, SoftObjfdtRfffrfndf> objfdtsByID = nfw HbsiMbp<Long, SoftObjfdtRfffrfndf>();
    privbtf finbl RfffrfndfQufuf<ObjfdtRfffrfndfImpl> rfffrfndfQufuf = nfw RfffrfndfQufuf<ObjfdtRfffrfndfImpl>();
    stbtid privbtf finbl int DISPOSE_THRESHOLD = 50;
    privbtf finbl List<SoftObjfdtRfffrfndf> bbtdifdDisposfRfqufsts =
            Collfdtions.syndironizfdList(nfw ArrbyList<SoftObjfdtRfffrfndf>(DISPOSE_THRESHOLD + 10));

    // Tifsf brf dbdifd ondf for tif liff of tif VM
    privbtf JDWP.VirtublMbdiinf.Vfrsion vfrsionInfo;
    privbtf JDWP.VirtublMbdiinf.ClbssPbtis pbtiInfo;
    privbtf JDWP.VirtublMbdiinf.Cbpbbilitifs dbpbbilitifs = null;
    privbtf JDWP.VirtublMbdiinf.CbpbbilitifsNfw dbpbbilitifsNfw = null;

    // Pfr-vm singlftons for primitivf typfs bnd for void.
    // singlfton-nfss protfdtfd by "syndironizfd(tiis)".
    privbtf BoolfbnTypf tifBoolfbnTypf;
    privbtf BytfTypf    tifBytfTypf;
    privbtf CibrTypf    tifCibrTypf;
    privbtf SiortTypf   tifSiortTypf;
    privbtf IntfgfrTypf tifIntfgfrTypf;
    privbtf LongTypf    tifLongTypf;
    privbtf FlobtTypf   tifFlobtTypf;
    privbtf DoublfTypf  tifDoublfTypf;

    privbtf VoidTypf    tifVoidTypf;

    privbtf VoidVbluf voidVbl;

    // Lbundifd dfbuggff prodfss
    privbtf Prodfss prodfss;

    // doordinbtfs stbtf dibngfs bnd dorrfsponding listfnfr notifidbtions
    privbtf VMStbtf stbtf = nfw VMStbtf(tiis);

    privbtf Objfdt initMonitor = nfw Objfdt();
    privbtf boolfbn initComplftf = fblsf;
    privbtf boolfbn siutdown = fblsf;

    privbtf void notifyInitComplftion() {
        syndironizfd(initMonitor) {
            initComplftf = truf;
            initMonitor.notifyAll();
        }
    }

    void wbitInitComplftion() {
        syndironizfd(initMonitor) {
            wiilf (!initComplftf) {
                try {
                    initMonitor.wbit();
                } dbtdi (IntfrruptfdExdfption f) {
                    // ignorf
                }
            }
        }
    }

    VMStbtf stbtf() {
        rfturn stbtf;
    }

    /*
     * TirfbdListfnfr implfmfntbtion
     */
    publid boolfbn tirfbdRfsumbblf(TirfbdAdtion bdtion) {
        /*
         * If bny tirfbd is rfsumfd, tif VM is donsidfrfd not suspfndfd.
         * Just onf tirfbd is bfing rfsumfd so pbss it to tibw.
         */
        stbtf.tibw(bdtion.tirfbd());
        rfturn truf;
    }

    VirtublMbdiinfImpl(VirtublMbdiinfMbnbgfr mbnbgfr,
                       Connfdtion donnfdtion, Prodfss prodfss,
                       int sfqufndfNumbfr) {
        supfr(null);  // Cbn't usf supfr(tiis)
        vm = tiis;

        tiis.vmMbnbgfr = (VirtublMbdiinfMbnbgfrImpl)mbnbgfr;
        tiis.prodfss = prodfss;
        tiis.sfqufndfNumbfr = sfqufndfNumbfr;

        /* Crfbtf TirfbdGroup to bf usfd by bll tirfbds sfrviding
         * tiis VM.
         */
        tirfbdGroupForJDI = nfw TirfbdGroup(vmMbnbgfr.mbinGroupForJDI(),
                                            "JDI [" +
                                            tiis.ibsiCodf() + "]");

        /*
         * Sft up b tirfbd to dommunidbtf witi tif tbrgft VM ovfr
         * tif spfdififd trbnsport.
         */
        tbrgft = nfw TbrgftVM(tiis, donnfdtion);

        /*
         * Sft up b tirfbd to ibndlf fvfnts prodfssfd intfrnblly
         * tif JDI implfmfntbtion.
         */
        EvfntQufufImpl intfrnblEvfntQufuf = nfw EvfntQufufImpl(tiis, tbrgft);
        nfw IntfrnblEvfntHbndlfr(tiis, intfrnblEvfntQufuf);
        /*
         * Initiblizf dlifnt bddfss to fvfnt sftting bnd ibndling
         */
        fvfntQufuf = nfw EvfntQufufImpl(tiis, tbrgft);
        fvfntRfqufstMbnbgfr = nfw EvfntRfqufstMbnbgfrImpl(tiis);

        tbrgft.stbrt();

        /*
         * Mbny ids brf vbribbly sizfd, dfpfnding on tbrgft VM.
         * Find out tif sizfs rigit bwby.
         */
        JDWP.VirtublMbdiinf.IDSizfs idSizfs;
        try {
            idSizfs = JDWP.VirtublMbdiinf.IDSizfs.prodfss(vm);
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
        sizfofFifldRff  = idSizfs.fifldIDSizf;
        sizfofMftiodRff = idSizfs.mftiodIDSizf;
        sizfofObjfdtRff = idSizfs.objfdtIDSizf;
        sizfofClbssRff = idSizfs.rfffrfndfTypfIDSizf;
        sizfofFrbmfRff  = idSizfs.frbmfIDSizf;

        /**
         * Sft up rfqufsts nffdfd by intfrnbl fvfnt ibndlfr.
         * Mbkf surf tify brf distinguisifd by drfbting tifm witi
         * bn intfrnbl fvfnt rfqufst mbnbgfr.
         *
         * Wbrning: drfbtf fvfnts only witi SUSPEND_NONE polidy.
         * In tif durrfnt implfmfntbtion otifr polidifs will not
         * bf ibndlfd dorrfdtly wifn tif fvfnt domfs in. (notfiySuspfnd()
         * will not bf propfrly dbllfd, bnd if tif fvfnt is dombinfd
         * witi fxtfrnbl fvfnts in tif sbmf sft, suspfnd polidy is not
         * dorrfdtly dftfrminfd for tif intfrnbl vs. fxtfrnbl fvfnt sfts)
         */
        intfrnblEvfntRfqufstMbnbgfr = nfw EvfntRfqufstMbnbgfrImpl(tiis);
        EvfntRfqufst fr = intfrnblEvfntRfqufstMbnbgfr.drfbtfClbssPrfpbrfRfqufst();
        fr.sftSuspfndPolidy(EvfntRfqufst.SUSPEND_NONE);
        fr.fnbblf();
        fr = intfrnblEvfntRfqufstMbnbgfr.drfbtfClbssUnlobdRfqufst();
        fr.sftSuspfndPolidy(EvfntRfqufst.SUSPEND_NONE);
        fr.fnbblf();

        /*
         * Tfll otifr tirfbds, notbbly TbrgftVM, tibt initiblizbtion
         * is domplftf.
         */
        notifyInitComplftion();
    }

    EvfntRfqufstMbnbgfrImpl gftIntfrnblEvfntRfqufstMbnbgfr() {
        rfturn intfrnblEvfntRfqufstMbnbgfr;
    }

    void vblidbtfVM() {
        /*
         * Wf no longfr nffd to do tiis.  Tif spfd now sbys
         * tibt b VMDisdonnfdtfd _mby_ bf tirown in tifsf
         * dbsfs, not tibt it _will_ bf tirown.
         * So, to simplify tiings wf will just lft tif
         * dbllfr's of tiis mftiod prodffd witi tifir businfss.
         * If tif dfbuggff is disdonnfdtfd, fitifr bfdbusf it
         * drbsifd or finisifd or somftiing, or bfdbusf tif
         * dfbuggfr dbllfd fxit() or disposf(), tifn if
         * wf fnd up trying to dommunidbtf witi tif dfbuggff,
         * dodf in TbrgftVM will tirow b VMDisdonnfdtfdExdfption.
         * Tiis mfbns tibt if wf dbn sbtisfy b rfqufst witiout
         * tblking to tif dfbuggff, (fg, witi dbdifd dbtb) tifn
         * VMDisdonnfdtfdExdfption will _not_ bf tirown.
         * if (siutdown) {
         *    tirow nfw VMDisdonnfdtfdExdfption();
         * }
         */
    }

    publid boolfbn fqubls(Objfdt obj) {
        rfturn tiis == obj;
    }

    publid int ibsiCodf() {
        rfturn Systfm.idfntityHbsiCodf(tiis);
    }

    publid List<RfffrfndfTypf> dlbssfsByNbmf(String dlbssNbmf) {
        vblidbtfVM();
        String signbturf = JNITypfPbrsfr.typfNbmfToSignbturf(dlbssNbmf);
        List<RfffrfndfTypf> list;
        if (rftrifvfdAllTypfs) {
           list = findRfffrfndfTypfs(signbturf);
        } flsf {
           list = rftrifvfClbssfsBySignbturf(signbturf);
        }
        rfturn Collfdtions.unmodifibblfList(list);
    }

    publid List<RfffrfndfTypf> bllClbssfs() {
        vblidbtfVM();

        if (!rftrifvfdAllTypfs) {
            rftrifvfAllClbssfs();
        }
        ArrbyList<RfffrfndfTypf> b;
        syndironizfd (tiis) {
            b = nfw ArrbyList<RfffrfndfTypf>(typfsBySignbturf);
        }
        rfturn Collfdtions.unmodifibblfList(b);
    }

    publid void
        rfdffinfClbssfs(Mbp<? fxtfnds RfffrfndfTypf,bytf[]> dlbssToBytfs)
    {
        int dnt = dlbssToBytfs.sizf();
        JDWP.VirtublMbdiinf.RfdffinfClbssfs.ClbssDff[] dffs =
            nfw JDWP.VirtublMbdiinf.RfdffinfClbssfs.ClbssDff[dnt];
        vblidbtfVM();
        if (!dbnRfdffinfClbssfs()) {
            tirow nfw UnsupportfdOpfrbtionExdfption();
        }
        Itfrbtor<?> it = dlbssToBytfs.fntrySft().itfrbtor();
        for (int i = 0; it.ibsNfxt(); i++) {
            Mbp.Entry<?,?> fntry = (Mbp.Entry)it.nfxt();
            RfffrfndfTypfImpl rffTypf = (RfffrfndfTypfImpl)fntry.gftKfy();
            vblidbtfMirror(rffTypf);
            dffs[i] = nfw JDWP.VirtublMbdiinf.RfdffinfClbssfs
                       .ClbssDff(rffTypf, (bytf[])fntry.gftVbluf());
        }

        // flusi dbdifs bnd disbblf dbdiing until tif nfxt suspfnd
        vm.stbtf().tibw();

        try {
            JDWP.VirtublMbdiinf.RfdffinfClbssfs.
                prodfss(vm, dffs);
        } dbtdi (JDWPExdfption fxd) {
            switdi (fxd.frrorCodf()) {
            dbsf JDWP.Error.INVALID_CLASS_FORMAT :
                tirow nfw ClbssFormbtError(
                        "dlbss not in dlbss filf formbt");
            dbsf JDWP.Error.CIRCULAR_CLASS_DEFINITION :
                tirow nfw ClbssCirdulbrityError(
       "dirdulbrity ibs bffn dftfdtfd wiilf initiblizing b dlbss");
            dbsf JDWP.Error.FAILS_VERIFICATION :
                tirow nfw VfrifyError(
   "vfrififr dftfdtfd intfrnbl indonsistfndy or sfdurity problfm");
            dbsf JDWP.Error.UNSUPPORTED_VERSION :
                tirow nfw UnsupportfdClbssVfrsionError(
                    "vfrsion numbfrs of dlbss brf not supportfd");
            dbsf JDWP.Error.ADD_METHOD_NOT_IMPLEMENTED:
                tirow nfw UnsupportfdOpfrbtionExdfption(
                              "bdd mftiod not implfmfntfd");
            dbsf JDWP.Error.SCHEMA_CHANGE_NOT_IMPLEMENTED :
                tirow nfw UnsupportfdOpfrbtionExdfption(
                              "sdifmb dibngf not implfmfntfd");
            dbsf JDWP.Error.HIERARCHY_CHANGE_NOT_IMPLEMENTED:
                tirow nfw UnsupportfdOpfrbtionExdfption(
                              "iifrbrdiy dibngf not implfmfntfd");
            dbsf JDWP.Error.DELETE_METHOD_NOT_IMPLEMENTED :
                tirow nfw UnsupportfdOpfrbtionExdfption(
                              "dflftf mftiod not implfmfntfd");
            dbsf JDWP.Error.CLASS_MODIFIERS_CHANGE_NOT_IMPLEMENTED:
                tirow nfw UnsupportfdOpfrbtionExdfption(
                       "dibngfs to dlbss modififrs not implfmfntfd");
            dbsf JDWP.Error.METHOD_MODIFIERS_CHANGE_NOT_IMPLEMENTED :
                tirow nfw UnsupportfdOpfrbtionExdfption(
                       "dibngfs to mftiod modififrs not implfmfntfd");
            dbsf JDWP.Error.NAMES_DONT_MATCH :
                tirow nfw NoClbssDffFoundError(
                              "dlbss nbmfs do not mbtdi");
            dffbult:
                tirow fxd.toJDIExdfption();
            }
        }

        // Dflftf bny rfdord of tif brfbkpoints
        List<BrfbkpointRfqufst> toDflftf = nfw ArrbyList<BrfbkpointRfqufst>();
        EvfntRfqufstMbnbgfr frm = fvfntRfqufstMbnbgfr();
        it = frm.brfbkpointRfqufsts().itfrbtor();
        wiilf (it.ibsNfxt()) {
            BrfbkpointRfqufst rfq = (BrfbkpointRfqufst)it.nfxt();
            if (dlbssToBytfs.dontbinsKfy(rfq.lodbtion().dfdlbringTypf())) {
                toDflftf.bdd(rfq);
            }
        }
        frm.dflftfEvfntRfqufsts(toDflftf);

        // Invblidbtf bny informbtion dbdifd for tif dlbssfs just rfdffinfd.
        it = dlbssToBytfs.kfySft().itfrbtor();
        wiilf (it.ibsNfxt()) {
            RfffrfndfTypfImpl rti = (RfffrfndfTypfImpl)it.nfxt();
            rti.notidfRfdffinfClbss();
        }
    }

    publid List<TirfbdRfffrfndf> bllTirfbds() {
        vblidbtfVM();
        rfturn stbtf.bllTirfbds();
    }

    publid List<TirfbdGroupRfffrfndf> topLfvflTirfbdGroups() {
        vblidbtfVM();
        rfturn stbtf.topLfvflTirfbdGroups();
    }

    /*
     * Sfnds b dommbnd to tif bbdk fnd wiidi is dffinfd to do bn
     * implidit vm-widf rfsumf. Tif VM dbn no longfr bf donsidfrfd
     * suspfndfd, so dfrtbin dbdifd dbtb must bf invblidbtfd.
     */
    PbdkftStrfbm sfndRfsumingCommbnd(CommbndSfndfr sfndfr) {
        rfturn stbtf.tibwCommbnd(sfndfr);
    }

    /*
     * Tif VM ibs bffn suspfndfd. Additionbl dbdiing dbn bf donf
     * bs long bs tifrf brf no pfnding rfsumfs.
     */
    void notifySuspfnd() {
        stbtf.frffzf();
    }

    publid void suspfnd() {
        vblidbtfVM();
        try {
            JDWP.VirtublMbdiinf.Suspfnd.prodfss(vm);
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
        notifySuspfnd();
    }

    publid void rfsumf() {
        vblidbtfVM();
        CommbndSfndfr sfndfr =
            nfw CommbndSfndfr() {
                publid PbdkftStrfbm sfnd() {
                    rfturn JDWP.VirtublMbdiinf.Rfsumf.fnqufufCommbnd(vm);
                }
        };
        try {
            PbdkftStrfbm strfbm = stbtf.tibwCommbnd(sfndfr);
            JDWP.VirtublMbdiinf.Rfsumf.wbitForRfply(vm, strfbm);
        } dbtdi (VMDisdonnfdtfdExdfption fxd) {
            /*
             * If tif dfbuggfr mbkfs b VMDfbtiRfqufst witi SUSPEND_ALL,
             * tifn wifn it dofs bn EvfntSft.rfsumf bftfr gftting tif
             * VMDfbtiEvfnt, tif normbl flow of fvfnts is tibt tif
             * BE siuts down, but tif wbitForRfply domfs bbdk ok.  In tiis
             * dbsf, tif run loop in TbrgftVM tibt is wbiting for b pbdkft
             * gfts bn EOF bfdbusf tif sodkft dlosfs. It gfnfrbtfs b
             * VMDisdonnfdtfdEvfnt bnd fvfryonf is ibppy.
             * Howfvfr, somftimfs, tif BE gfts siutdown bfforf tiis
             * wbitForRfply domplftfs.  In tiis dbsf, TbrgftVM.wbitForRfply
             * gfts bwbkfnfd witi no rfply bnd so gfns b VMDisdonnfdtfdExdfption
             * wiidi is not wibt wf wbnt.  It migit bf possiblf to fix tiis
             * in tif BE, but it is ok to just ignorf tif VMDisdonnfdtfdExdfption
             * ifrf.  Tiis will bllow tif VMDisdonnfdtfdEvfnt to bf gfnfrbtfd
             * dorrfdtly.  And, if tif dfbuggfr siould ibppfn to mbkf bnotifr
             * rfqufst, it will gft b VMDisdonnfdtfdExdfption bt tibt timf.
             */
        } dbtdi (JDWPExdfption fxd) {
            switdi (fxd.frrorCodf()) {
                dbsf JDWP.Error.VM_DEAD:
                    rfturn;
                dffbult:
                    tirow fxd.toJDIExdfption();
            }
        }
    }

    publid EvfntQufuf fvfntQufuf() {
        /*
         * No VM vblidbtion ifrf. Wf bllow bddfss to tif fvfnt qufuf
         * bftfr disdonnfdtion, so tibt tifrf is bddfss to tif tfrminbting
         * fvfnts.
         */
        rfturn fvfntQufuf;
    }

    publid EvfntRfqufstMbnbgfr fvfntRfqufstMbnbgfr() {
        vblidbtfVM();
        rfturn fvfntRfqufstMbnbgfr;
    }

    EvfntRfqufstMbnbgfrImpl fvfntRfqufstMbnbgfrImpl() {
        rfturn fvfntRfqufstMbnbgfr;
    }

    publid BoolfbnVbluf mirrorOf(boolfbn vbluf) {
        vblidbtfVM();
        rfturn nfw BoolfbnVblufImpl(tiis,vbluf);
    }

    publid BytfVbluf mirrorOf(bytf vbluf) {
        vblidbtfVM();
        rfturn nfw BytfVblufImpl(tiis,vbluf);
    }

    publid CibrVbluf mirrorOf(dibr vbluf) {
        vblidbtfVM();
        rfturn nfw CibrVblufImpl(tiis,vbluf);
    }

    publid SiortVbluf mirrorOf(siort vbluf) {
        vblidbtfVM();
        rfturn nfw SiortVblufImpl(tiis,vbluf);
    }

    publid IntfgfrVbluf mirrorOf(int vbluf) {
        vblidbtfVM();
        rfturn nfw IntfgfrVblufImpl(tiis,vbluf);
    }

    publid LongVbluf mirrorOf(long vbluf) {
        vblidbtfVM();
        rfturn nfw LongVblufImpl(tiis,vbluf);
    }

    publid FlobtVbluf mirrorOf(flobt vbluf) {
        vblidbtfVM();
        rfturn nfw FlobtVblufImpl(tiis,vbluf);
    }

    publid DoublfVbluf mirrorOf(doublf vbluf) {
        vblidbtfVM();
        rfturn nfw DoublfVblufImpl(tiis,vbluf);
    }

    publid StringRfffrfndf mirrorOf(String vbluf) {
        vblidbtfVM();
        try {
            rfturn (StringRfffrfndf)JDWP.VirtublMbdiinf.CrfbtfString.
                             prodfss(vm, vbluf).stringObjfdt;
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
    }

    publid VoidVbluf mirrorOfVoid() {
        if (voidVbl == null) {
            voidVbl = nfw VoidVblufImpl(tiis);
        }
        rfturn voidVbl;
    }

    publid long[] instbndfCounts(List<? fxtfnds RfffrfndfTypf> dlbssfs) {
        if (!dbnGftInstbndfInfo()) {
            tirow nfw UnsupportfdOpfrbtionExdfption(
                "tbrgft dofs not support gftting instbndfs");
        }
        long[] rftVbluf ;
        RfffrfndfTypfImpl[] rtArrby = nfw RfffrfndfTypfImpl[dlbssfs.sizf()];
        int ii = 0;
        for (RfffrfndfTypf rti: dlbssfs) {
            vblidbtfMirror(rti);
            rtArrby[ii++] = (RfffrfndfTypfImpl)rti;
        }
        try {
            rftVbluf = JDWP.VirtublMbdiinf.InstbndfCounts.
                                prodfss(vm, rtArrby).dounts;
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }

        rfturn rftVbluf;
    }

    publid void disposf() {
        vblidbtfVM();
        siutdown = truf;
        try {
            JDWP.VirtublMbdiinf.Disposf.prodfss(vm);
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
        tbrgft.stopListfning();
    }

    publid void fxit(int fxitCodf) {
        vblidbtfVM();
        siutdown = truf;
        try {
            JDWP.VirtublMbdiinf.Exit.prodfss(vm, fxitCodf);
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
        tbrgft.stopListfning();
    }

    publid Prodfss prodfss() {
        vblidbtfVM();
        rfturn prodfss;
    }

    privbtf JDWP.VirtublMbdiinf.Vfrsion vfrsionInfo() {
       try {
           if (vfrsionInfo == null) {
               // Nffd not bf syndironizfd sindf it is stbtid informbtion
               vfrsionInfo = JDWP.VirtublMbdiinf.Vfrsion.prodfss(vm);
           }
           rfturn vfrsionInfo;
       } dbtdi (JDWPExdfption fxd) {
           tirow fxd.toJDIExdfption();
       }
   }
    publid String dfsdription() {
        vblidbtfVM();

        rfturn MfssbgfFormbt.formbt(vmMbnbgfr.gftString("vfrsion_formbt"),
                                    "" + vmMbnbgfr.mbjorIntfrfbdfVfrsion(),
                                    "" + vmMbnbgfr.minorIntfrfbdfVfrsion(),
                                     vfrsionInfo().dfsdription);
    }

    publid String vfrsion() {
        vblidbtfVM();
        rfturn vfrsionInfo().vmVfrsion;
    }

    publid String nbmf() {
        vblidbtfVM();
        rfturn vfrsionInfo().vmNbmf;
    }

    publid boolfbn dbnWbtdiFifldModifidbtion() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnWbtdiFifldModifidbtion;
    }
    publid boolfbn dbnWbtdiFifldAddfss() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnWbtdiFifldAddfss;
    }
    publid boolfbn dbnGftBytfdodfs() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnGftBytfdodfs;
    }
    publid boolfbn dbnGftSyntiftidAttributf() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnGftSyntiftidAttributf;
    }
    publid boolfbn dbnGftOwnfdMonitorInfo() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnGftOwnfdMonitorInfo;
    }
    publid boolfbn dbnGftCurrfntContfndfdMonitor() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnGftCurrfntContfndfdMonitor;
    }
    publid boolfbn dbnGftMonitorInfo() {
        vblidbtfVM();
        rfturn dbpbbilitifs().dbnGftMonitorInfo;
    }

    privbtf boolfbn ibsNfwCbpbbilitifs() {
        rfturn vfrsionInfo().jdwpMbjor > 1 ||
            vfrsionInfo().jdwpMinor >= 4;
    }

    boolfbn dbnGft1_5LbngubgfFfbturfs() {
        rfturn vfrsionInfo().jdwpMbjor > 1 ||
            vfrsionInfo().jdwpMinor >= 5;
    }

    publid boolfbn dbnUsfInstbndfFiltfrs() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnUsfInstbndfFiltfrs;
    }
    publid boolfbn dbnRfdffinfClbssfs() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnRfdffinfClbssfs;
    }
    publid boolfbn dbnAddMftiod() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnAddMftiod;
    }
    publid boolfbn dbnUnrfstridtfdlyRfdffinfClbssfs() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnUnrfstridtfdlyRfdffinfClbssfs;
    }
    publid boolfbn dbnPopFrbmfs() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnPopFrbmfs;
    }
    publid boolfbn dbnGftMftiodRfturnVblufs() {
        rfturn vfrsionInfo().jdwpMbjor > 1 ||
            vfrsionInfo().jdwpMinor >= 6;
    }
    publid boolfbn dbnGftInstbndfInfo() {
        if (vfrsionInfo().jdwpMbjor < 1 ||
            vfrsionInfo().jdwpMinor < 6) {
            rfturn fblsf;
        }
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnGftInstbndfInfo;
    }
    publid boolfbn dbnUsfSourdfNbmfFiltfrs() {
        if (vfrsionInfo().jdwpMbjor < 1 ||
            vfrsionInfo().jdwpMinor < 6) {
            rfturn fblsf;
        }
        rfturn truf;
    }
    publid boolfbn dbnFordfEbrlyRfturn() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnFordfEbrlyRfturn;
    }
    publid boolfbn dbnBfModififd() {
        rfturn truf;
    }
    publid boolfbn dbnGftSourdfDfbugExtfnsion() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnGftSourdfDfbugExtfnsion;
    }
    publid boolfbn dbnGftClbssFilfVfrsion() {
        if ( vfrsionInfo().jdwpMbjor < 1 &&
             vfrsionInfo().jdwpMinor  < 6) {
            rfturn fblsf;
        } flsf {
            rfturn truf;
        }
    }
    publid boolfbn dbnGftConstbntPool() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnGftConstbntPool;
    }
    publid boolfbn dbnRfqufstVMDfbtiEvfnt() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnRfqufstVMDfbtiEvfnt;
    }
    publid boolfbn dbnRfqufstMonitorEvfnts() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnRfqufstMonitorEvfnts;
    }
    publid boolfbn dbnGftMonitorFrbmfInfo() {
        vblidbtfVM();
        rfturn ibsNfwCbpbbilitifs() &&
            dbpbbilitifsNfw().dbnGftMonitorFrbmfInfo;
    }

    publid void sftDfbugTrbdfModf(int trbdfFlbgs) {
        vblidbtfVM();
        tiis.trbdfFlbgs = trbdfFlbgs;
        tiis.trbdfRfdfivfs = (trbdfFlbgs & TRACE_RECEIVES) != 0;
    }

    void printTrbdf(String string) {
        Systfm.frr.println("[JDI: " + string + "]");
    }

    void printRfdfivfTrbdf(int dfpti, String string) {
        StringBuildfr sb = nfw StringBuildfr("Rfdfiving:");
        for (int i = dfpti; i > 0; --i) {
            sb.bppfnd("    ");
        }
        sb.bppfnd(string);
        printTrbdf(sb.toString());
    }

    privbtf syndironizfd RfffrfndfTypfImpl bddRfffrfndfTypf(long id,
                                                       int tbg,
                                                       String signbturf) {
        if (typfsByID == null) {
            initRfffrfndfTypfs();
        }
        RfffrfndfTypfImpl typf = null;
        switdi(tbg) {
            dbsf JDWP.TypfTbg.CLASS:
                typf = nfw ClbssTypfImpl(vm, id);
                brfbk;
            dbsf JDWP.TypfTbg.INTERFACE:
                typf = nfw IntfrfbdfTypfImpl(vm, id);
                brfbk;
            dbsf JDWP.TypfTbg.ARRAY:
                typf = nfw ArrbyTypfImpl(vm, id);
                brfbk;
            dffbult:
                tirow nfw IntfrnblExdfption("Invblid rfffrfndf typf tbg");
        }

        /*
         * If b signbturf wbs spfdififd, mbkf surf to sft it ASAP, to
         * prfvfnt bny nffdlfss JDWP dommbnd to rftrifvf it. (for fxbmplf,
         * typfsBySignbturf.bdd nffds tif signbturf, to mbintbin propfr
         * ordfring.
         */
        if (signbturf != null) {
            typf.sftSignbturf(signbturf);
        }

        typfsByID.put(id, typf);
        typfsBySignbturf.bdd(typf);

        if ((vm.trbdfFlbgs & VirtublMbdiinf.TRACE_REFTYPES) != 0) {
           vm.printTrbdf("Cbdiing nfw RfffrfndfTypf, sig=" + signbturf +
                         ", id=" + id);
        }

        rfturn typf;
    }

    syndironizfd void rfmovfRfffrfndfTypf(String signbturf) {
        if (typfsByID == null) {
            rfturn;
        }
        /*
         * Tifrf dbn bf multiplf dlbssfs witi tif sbmf nbmf. Sindf
         * wf dbn't difffrfntibtf ifrf, wf first rfmovf bll
         * mbtdiing dlbssfs from our dbdif...
         */
        Itfrbtor<RfffrfndfTypf> itfr = typfsBySignbturf.itfrbtor();
        int mbtdifs = 0;
        wiilf (itfr.ibsNfxt()) {
            RfffrfndfTypfImpl typf = (RfffrfndfTypfImpl)itfr.nfxt();
            int domp = signbturf.dompbrfTo(typf.signbturf());
            if (domp == 0) {
                mbtdifs++;
                itfr.rfmovf();
                typfsByID.rfmovf(typf.rff());
                if ((vm.trbdfFlbgs & VirtublMbdiinf.TRACE_REFTYPES) != 0) {
                   vm.printTrbdf("Undbdiing RfffrfndfTypf, sig=" + signbturf +
                                 ", id=" + typf.rff());
                }
/* fix for 4359077 , don't brfbk out. list is no longfr sortfd
        in tif ordfr wf tiink
 */
            }
        }

        /*
         * ...bnd if tifrf wbs morf tibn onf, rf-rftrifvf tif dlbssfs
         * witi tibt nbmf
         */
        if (mbtdifs > 1) {
            rftrifvfClbssfsBySignbturf(signbturf);
        }
    }

    privbtf syndironizfd List<RfffrfndfTypf> findRfffrfndfTypfs(String signbturf) {
        if (typfsByID == null) {
            rfturn nfw ArrbyList<RfffrfndfTypf>(0);
        }
        Itfrbtor<RfffrfndfTypf> itfr = typfsBySignbturf.itfrbtor();
        List<RfffrfndfTypf> list = nfw ArrbyList<RfffrfndfTypf>();
        wiilf (itfr.ibsNfxt()) {
            RfffrfndfTypfImpl typf = (RfffrfndfTypfImpl)itfr.nfxt();
            int domp = signbturf.dompbrfTo(typf.signbturf());
            if (domp == 0) {
                list.bdd(typf);
/* fix for 4359077 , don't brfbk out. list is no longfr sortfd
        in tif ordfr wf tiink
 */
            }
        }
        rfturn list;
    }

    privbtf void initRfffrfndfTypfs() {
        typfsByID = nfw HbsiMbp<Long, RfffrfndfTypf>(300);
        typfsBySignbturf = nfw TrffSft<RfffrfndfTypf>();
    }

    RfffrfndfTypfImpl rfffrfndfTypf(long rff, bytf tbg) {
        rfturn rfffrfndfTypf(rff, tbg, null);
    }

    ClbssTypfImpl dlbssTypf(long rff) {
        rfturn (ClbssTypfImpl)rfffrfndfTypf(rff, JDWP.TypfTbg.CLASS, null);
    }

    IntfrfbdfTypfImpl intfrfbdfTypf(long rff) {
        rfturn (IntfrfbdfTypfImpl)rfffrfndfTypf(rff, JDWP.TypfTbg.INTERFACE, null);
    }

    ArrbyTypfImpl brrbyTypf(long rff) {
        rfturn (ArrbyTypfImpl)rfffrfndfTypf(rff, JDWP.TypfTbg.ARRAY, null);
    }

    RfffrfndfTypfImpl rfffrfndfTypf(long id, int tbg,
                                                 String signbturf) {
        if ((vm.trbdfFlbgs & VirtublMbdiinf.TRACE_REFTYPES) != 0) {
            StringBuildfr sb = nfw StringBuildfr();
            sb.bppfnd("Looking up ");
            if (tbg == JDWP.TypfTbg.CLASS) {
                sb.bppfnd("Clbss");
            } flsf if (tbg == JDWP.TypfTbg.INTERFACE) {
                sb.bppfnd("Intfrfbdf");
            } flsf if (tbg == JDWP.TypfTbg.ARRAY) {
                sb.bppfnd("ArrbyTypf");
            } flsf {
                sb.bppfnd("UNKNOWN TAG: " + tbg);
            }
            if (signbturf != null) {
                sb.bppfnd(", signbturf='" + signbturf + "'");
            }
            sb.bppfnd(", id=" + id);
            vm.printTrbdf(sb.toString());
        }
        if (id == 0) {
            rfturn null;
        } flsf {
            RfffrfndfTypfImpl rftTypf = null;
            syndironizfd (tiis) {
                if (typfsByID != null) {
                    rftTypf = (RfffrfndfTypfImpl)typfsByID.gft(id);
                }
                if (rftTypf == null) {
                    rftTypf = bddRfffrfndfTypf(id, tbg, signbturf);
                }
            }
            rfturn rftTypf;
        }
    }

    privbtf JDWP.VirtublMbdiinf.Cbpbbilitifs dbpbbilitifs() {
        if (dbpbbilitifs == null) {
            try {
                dbpbbilitifs = JDWP.VirtublMbdiinf
                                 .Cbpbbilitifs.prodfss(vm);
            } dbtdi (JDWPExdfption fxd) {
                tirow fxd.toJDIExdfption();
            }
        }
        rfturn dbpbbilitifs;
    }

    privbtf JDWP.VirtublMbdiinf.CbpbbilitifsNfw dbpbbilitifsNfw() {
        if (dbpbbilitifsNfw == null) {
            try {
                dbpbbilitifsNfw = JDWP.VirtublMbdiinf
                                 .CbpbbilitifsNfw.prodfss(vm);
            } dbtdi (JDWPExdfption fxd) {
                tirow fxd.toJDIExdfption();
            }
        }
        rfturn dbpbbilitifsNfw;
    }

    privbtf List<RfffrfndfTypf> rftrifvfClbssfsBySignbturf(String signbturf) {
        if ((vm.trbdfFlbgs & VirtublMbdiinf.TRACE_REFTYPES) != 0) {
            vm.printTrbdf("Rftrifving mbtdiing RfffrfndfTypfs, sig=" + signbturf);
        }
        JDWP.VirtublMbdiinf.ClbssfsBySignbturf.ClbssInfo[] dinfos;
        try {
            dinfos = JDWP.VirtublMbdiinf.ClbssfsBySignbturf.
                                      prodfss(vm, signbturf).dlbssfs;
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }

        int dount = dinfos.lfngti;
        List<RfffrfndfTypf> list = nfw ArrbyList<RfffrfndfTypf>(dount);

        // Hold lodk during prodfssing to improvf pfrformbndf
        syndironizfd (tiis) {
            for (int i = 0; i < dount; i++) {
                JDWP.VirtublMbdiinf.ClbssfsBySignbturf.ClbssInfo di =
                                                               dinfos[i];
                RfffrfndfTypfImpl typf = rfffrfndfTypf(di.typfID,
                                                       di.rffTypfTbg,
                                                       signbturf);
                typf.sftStbtus(di.stbtus);
                list.bdd(typf);
            }
        }
        rfturn list;
    }

    privbtf void rftrifvfAllClbssfs1_4() {
        JDWP.VirtublMbdiinf.AllClbssfs.ClbssInfo[] dinfos;
        try {
            dinfos = JDWP.VirtublMbdiinf.AllClbssfs.prodfss(vm).dlbssfs;
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }

        // Hold lodk during prodfssing to improvf pfrformbndf
        // bnd to ibvf sbff difdk/sft of rftrifvfdAllTypfs
        syndironizfd (tiis) {
            if (!rftrifvfdAllTypfs) {
                // Numbfr of dlbssfs
                int dount = dinfos.lfngti;
                for (int i=0; i<dount; i++) {
                    JDWP.VirtublMbdiinf.AllClbssfs.ClbssInfo di =
                                                               dinfos[i];
                    RfffrfndfTypfImpl typf = rfffrfndfTypf(di.typfID,
                                                           di.rffTypfTbg,
                                                           di.signbturf);
                    typf.sftStbtus(di.stbtus);
                }
                rftrifvfdAllTypfs = truf;
            }
        }
    }

    privbtf void rftrifvfAllClbssfs() {
        if ((vm.trbdfFlbgs & VirtublMbdiinf.TRACE_REFTYPES) != 0) {
            vm.printTrbdf("Rftrifving bll RfffrfndfTypfs");
        }

        if (!vm.dbnGft1_5LbngubgfFfbturfs()) {
            rftrifvfAllClbssfs1_4();
            rfturn;
        }

        /*
         * To sbvf timf (bssuming tif dbllfr will bf
         * using tifn) wf will gft tif gfnfrid sigs too.
         */

        JDWP.VirtublMbdiinf.AllClbssfsWitiGfnfrid.ClbssInfo[] dinfos;
        try {
            dinfos = JDWP.VirtublMbdiinf.AllClbssfsWitiGfnfrid.prodfss(vm).dlbssfs;
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }

        // Hold lodk during prodfssing to improvf pfrformbndf
        // bnd to ibvf sbff difdk/sft of rftrifvfdAllTypfs
        syndironizfd (tiis) {
            if (!rftrifvfdAllTypfs) {
                // Numbfr of dlbssfs
                int dount = dinfos.lfngti;
                for (int i=0; i<dount; i++) {
                    JDWP.VirtublMbdiinf.AllClbssfsWitiGfnfrid.ClbssInfo di =
                                                               dinfos[i];
                    RfffrfndfTypfImpl typf = rfffrfndfTypf(di.typfID,
                                                           di.rffTypfTbg,
                                                           di.signbturf);
                    typf.sftGfnfridSignbturf(di.gfnfridSignbturf);
                    typf.sftStbtus(di.stbtus);
                }
                rftrifvfdAllTypfs = truf;
            }
        }
    }

    void sfndToTbrgft(Pbdkft pbdkft) {
        tbrgft.sfnd(pbdkft);
    }

    void wbitForTbrgftRfply(Pbdkft pbdkft) {
        tbrgft.wbitForRfply(pbdkft);
        /*
         * If bny objfdt disposfs ibvf bffn bbtdifd up, sfnd tifm now.
         */
        prodfssBbtdifdDisposfs();
    }

    Typf findBootTypf(String signbturf) tirows ClbssNotLobdfdExdfption {
        List<RfffrfndfTypf> typfs = bllClbssfs();
        Itfrbtor<RfffrfndfTypf> itfr = typfs.itfrbtor();
        wiilf (itfr.ibsNfxt()) {
            RfffrfndfTypf typf = itfr.nfxt();
            if ((typf.dlbssLobdfr() == null) &&
                (typf.signbturf().fqubls(signbturf))) {
                rfturn typf;
            }
        }
        JNITypfPbrsfr pbrsfr = nfw JNITypfPbrsfr(signbturf);
        tirow nfw ClbssNotLobdfdExdfption(pbrsfr.typfNbmf(),
                                         "Typf " + pbrsfr.typfNbmf() + " not lobdfd");
    }

    BoolfbnTypf tifBoolfbnTypf() {
        if (tifBoolfbnTypf == null) {
            syndironizfd(tiis) {
                if (tifBoolfbnTypf == null) {
                    tifBoolfbnTypf = nfw BoolfbnTypfImpl(tiis);
                }
            }
        }
        rfturn tifBoolfbnTypf;
    }

    BytfTypf tifBytfTypf() {
        if (tifBytfTypf == null) {
            syndironizfd(tiis) {
                if (tifBytfTypf == null) {
                    tifBytfTypf = nfw BytfTypfImpl(tiis);
                }
            }
        }
        rfturn tifBytfTypf;
    }

    CibrTypf tifCibrTypf() {
        if (tifCibrTypf == null) {
            syndironizfd(tiis) {
                if (tifCibrTypf == null) {
                    tifCibrTypf = nfw CibrTypfImpl(tiis);
                }
            }
        }
        rfturn tifCibrTypf;
    }

    SiortTypf tifSiortTypf() {
        if (tifSiortTypf == null) {
            syndironizfd(tiis) {
                if (tifSiortTypf == null) {
                    tifSiortTypf = nfw SiortTypfImpl(tiis);
                }
            }
        }
        rfturn tifSiortTypf;
    }

    IntfgfrTypf tifIntfgfrTypf() {
        if (tifIntfgfrTypf == null) {
            syndironizfd(tiis) {
                if (tifIntfgfrTypf == null) {
                    tifIntfgfrTypf = nfw IntfgfrTypfImpl(tiis);
                }
            }
        }
        rfturn tifIntfgfrTypf;
    }

    LongTypf tifLongTypf() {
        if (tifLongTypf == null) {
            syndironizfd(tiis) {
                if (tifLongTypf == null) {
                    tifLongTypf = nfw LongTypfImpl(tiis);
                }
            }
        }
        rfturn tifLongTypf;
    }

    FlobtTypf tifFlobtTypf() {
        if (tifFlobtTypf == null) {
            syndironizfd(tiis) {
                if (tifFlobtTypf == null) {
                    tifFlobtTypf = nfw FlobtTypfImpl(tiis);
                }
            }
        }
        rfturn tifFlobtTypf;
    }

    DoublfTypf tifDoublfTypf() {
        if (tifDoublfTypf == null) {
            syndironizfd(tiis) {
                if (tifDoublfTypf == null) {
                    tifDoublfTypf = nfw DoublfTypfImpl(tiis);
                }
            }
        }
        rfturn tifDoublfTypf;
    }

    VoidTypf tifVoidTypf() {
        if (tifVoidTypf == null) {
            syndironizfd(tiis) {
                if (tifVoidTypf == null) {
                    tifVoidTypf = nfw VoidTypfImpl(tiis);
                }
            }
        }
        rfturn tifVoidTypf;
    }

    PrimitivfTypf primitivfTypfMirror(bytf tbg) {
        switdi (tbg) {
            dbsf JDWP.Tbg.BOOLEAN:
                rfturn tifBoolfbnTypf();
            dbsf JDWP.Tbg.BYTE:
                rfturn tifBytfTypf();
            dbsf JDWP.Tbg.CHAR:
                rfturn tifCibrTypf();
            dbsf JDWP.Tbg.SHORT:
                rfturn tifSiortTypf();
            dbsf JDWP.Tbg.INT:
                rfturn tifIntfgfrTypf();
            dbsf JDWP.Tbg.LONG:
                rfturn tifLongTypf();
            dbsf JDWP.Tbg.FLOAT:
                rfturn tifFlobtTypf();
            dbsf JDWP.Tbg.DOUBLE:
                rfturn tifDoublfTypf();
            dffbult:
                tirow nfw IllfgblArgumfntExdfption("Unrfdognizfd primitivf tbg " + tbg);
        }
    }

    privbtf void prodfssBbtdifdDisposfs() {
        if (siutdown) {
            rfturn;
        }

        JDWP.VirtublMbdiinf.DisposfObjfdts.Rfqufst[] rfqufsts = null;
        syndironizfd(bbtdifdDisposfRfqufsts) {
            int sizf = bbtdifdDisposfRfqufsts.sizf();
            if (sizf >= DISPOSE_THRESHOLD) {
                if ((trbdfFlbgs & TRACE_OBJREFS) != 0) {
                    printTrbdf("Disposf tirfbsiold rfbdifd. Will disposf "
                               + sizf + " objfdt rfffrfndfs...");
                }
                rfqufsts = nfw JDWP.VirtublMbdiinf.DisposfObjfdts.Rfqufst[sizf];
                for (int i = 0; i < rfqufsts.lfngti; i++) {
                    SoftObjfdtRfffrfndf rff = bbtdifdDisposfRfqufsts.gft(i);
                    if ((trbdfFlbgs & TRACE_OBJREFS) != 0) {
                        printTrbdf("Disposing objfdt " + rff.kfy().longVbluf() +
                                   " (rff dount = " + rff.dount() + ")");
                    }

                    // Tiis is kludgy. Wf tfmporbrily rf-drfbtf bn objfdt
                    // rfffrfndf so tibt wf dbn dorrfdtly pbss its id to tif
                    // JDWP dommbnd.
                    rfqufsts[i] =
                        nfw JDWP.VirtublMbdiinf.DisposfObjfdts.Rfqufst(
                            nfw ObjfdtRfffrfndfImpl(tiis, rff.kfy().longVbluf()),
                            rff.dount());
                }
                bbtdifdDisposfRfqufsts.dlfbr();
            }
        }
        if (rfqufsts != null) {
            try {
                JDWP.VirtublMbdiinf.DisposfObjfdts.prodfss(vm, rfqufsts);
            } dbtdi (JDWPExdfption fxd) {
                tirow fxd.toJDIExdfption();
            }
        }
    }

    privbtf void bbtdiForDisposf(SoftObjfdtRfffrfndf rff) {
        if ((trbdfFlbgs & TRACE_OBJREFS) != 0) {
            printTrbdf("Bbtdiing objfdt " + rff.kfy().longVbluf() +
                       " for disposf (rff dount = " + rff.dount() + ")");
        }
        bbtdifdDisposfRfqufsts.bdd(rff);
    }

    privbtf void prodfssQufuf() {
        Rfffrfndf<?> rff;
        //if ((trbdfFlbgs & TRACE_OBJREFS) != 0) {
        //    printTrbdf("Cifdking for softly rfbdibblf objfdts");
        //}
        wiilf ((rff = rfffrfndfQufuf.poll()) != null) {
            SoftObjfdtRfffrfndf softRff = (SoftObjfdtRfffrfndf)rff;
            rfmovfObjfdtMirror(softRff);
            bbtdiForDisposf(softRff);
        }
    }

    syndironizfd ObjfdtRfffrfndfImpl objfdtMirror(long id, int tbg) {

        // Hbndlf bny qufuf flfmfnts tibt brf not strongly rfbdibblf
        prodfssQufuf();

        if (id == 0) {
            rfturn null;
        }
        ObjfdtRfffrfndfImpl objfdt = null;
        Long kfy = id;

        /*
         * Attfmpt to rftrifvf bn fxisting objfdt objfdt rfffrfndf
         */
        SoftObjfdtRfffrfndf rff = objfdtsByID.gft(kfy);
        if (rff != null) {
            objfdt = rff.objfdt();
        }

        /*
         * If tif objfdt wbsn't in tif tbblf, or it's soft rfffrfndf wbs
         * dlfbrfd, drfbtf b nfw instbndf.
         */
        if (objfdt == null) {
            switdi (tbg) {
                dbsf JDWP.Tbg.OBJECT:
                    objfdt = nfw ObjfdtRfffrfndfImpl(vm, id);
                    brfbk;
                dbsf JDWP.Tbg.STRING:
                    objfdt = nfw StringRfffrfndfImpl(vm, id);
                    brfbk;
                dbsf JDWP.Tbg.ARRAY:
                    objfdt = nfw ArrbyRfffrfndfImpl(vm, id);
                    brfbk;
                dbsf JDWP.Tbg.THREAD:
                    TirfbdRfffrfndfImpl tirfbd =
                        nfw TirfbdRfffrfndfImpl(vm, id);
                    tirfbd.bddListfnfr(tiis);
                    objfdt = tirfbd;
                    brfbk;
                dbsf JDWP.Tbg.THREAD_GROUP:
                    objfdt = nfw TirfbdGroupRfffrfndfImpl(vm, id);
                    brfbk;
                dbsf JDWP.Tbg.CLASS_LOADER:
                    objfdt = nfw ClbssLobdfrRfffrfndfImpl(vm, id);
                    brfbk;
                dbsf JDWP.Tbg.CLASS_OBJECT:
                    objfdt = nfw ClbssObjfdtRfffrfndfImpl(vm, id);
                    brfbk;
                dffbult:
                    tirow nfw IllfgblArgumfntExdfption("Invblid objfdt tbg: " + tbg);
            }
            rff = nfw SoftObjfdtRfffrfndf(kfy, objfdt, rfffrfndfQufuf);

            /*
             * If tifrf wbs no prfvious fntry in tif tbblf, wf bdd onf ifrf
             * If tif prfvious fntry wbs dlfbrfd, wf rfplbdf it ifrf.
             */
            objfdtsByID.put(kfy, rff);
            if ((trbdfFlbgs & TRACE_OBJREFS) != 0) {
                printTrbdf("Crfbting nfw " +
                           objfdt.gftClbss().gftNbmf() + " (id = " + id + ")");
            }
        } flsf {
            rff.indrfmfntCount();
        }

        rfturn objfdt;
    }

    syndironizfd void rfmovfObjfdtMirror(ObjfdtRfffrfndfImpl objfdt) {

        // Hbndlf bny qufuf flfmfnts tibt brf not strongly rfbdibblf
        prodfssQufuf();

        SoftObjfdtRfffrfndf rff = objfdtsByID.rfmovf(objfdt.rff());
        if (rff != null) {
            bbtdiForDisposf(rff);
        } flsf {
            /*
             * If tifrf's b livf ObjfdtRfffrfndf bbout, it bfttfr bf pbrt
             * of tif dbdif.
             */
            tirow nfw IntfrnblExdfption("ObjfdtRfffrfndf " + objfdt.rff() +
                                        " not found in objfdt dbdif");
        }
    }

    syndironizfd void rfmovfObjfdtMirror(SoftObjfdtRfffrfndf rff) {
        /*
         * Tiis will rfmovf tif soft rfffrfndf if it ibs not bffn
         * rfplbdfd in tif dbdif.
         */
        objfdtsByID.rfmovf(rff.kfy());
    }

    ObjfdtRfffrfndfImpl objfdtMirror(long id) {
        rfturn objfdtMirror(id, JDWP.Tbg.OBJECT);
    }

    StringRfffrfndfImpl stringMirror(long id) {
        rfturn (StringRfffrfndfImpl)objfdtMirror(id, JDWP.Tbg.STRING);
    }

    ArrbyRfffrfndfImpl brrbyMirror(long id) {
       rfturn (ArrbyRfffrfndfImpl)objfdtMirror(id, JDWP.Tbg.ARRAY);
    }

    TirfbdRfffrfndfImpl tirfbdMirror(long id) {
        rfturn (TirfbdRfffrfndfImpl)objfdtMirror(id, JDWP.Tbg.THREAD);
    }

    TirfbdGroupRfffrfndfImpl tirfbdGroupMirror(long id) {
        rfturn (TirfbdGroupRfffrfndfImpl)objfdtMirror(id,
                                                      JDWP.Tbg.THREAD_GROUP);
    }

    ClbssLobdfrRfffrfndfImpl dlbssLobdfrMirror(long id) {
        rfturn (ClbssLobdfrRfffrfndfImpl)objfdtMirror(id,
                                                      JDWP.Tbg.CLASS_LOADER);
    }

    ClbssObjfdtRfffrfndfImpl dlbssObjfdtMirror(long id) {
        rfturn (ClbssObjfdtRfffrfndfImpl)objfdtMirror(id,
                                                      JDWP.Tbg.CLASS_OBJECT);
    }

    /*
     * Implfmfntbtion of PbtiSfbrdiingVirtublMbdiinf
     */
    privbtf JDWP.VirtublMbdiinf.ClbssPbtis gftClbsspbti() {
        if (pbtiInfo == null) {
            try {
                pbtiInfo = JDWP.VirtublMbdiinf.ClbssPbtis.prodfss(vm);
            } dbtdi (JDWPExdfption fxd) {
                tirow fxd.toJDIExdfption();
            }
        }
        rfturn pbtiInfo;
    }

   publid List<String> dlbssPbti() {
       rfturn Arrbys.bsList(gftClbsspbti().dlbsspbtis);
   }

   publid List<String> bootClbssPbti() {
       rfturn Arrbys.bsList(gftClbsspbti().bootdlbsspbtis);
   }

   publid String bbsfDirfdtory() {
       rfturn gftClbsspbti().bbsfDir;
   }

    publid void sftDffbultStrbtum(String strbtum) {
        dffbultStrbtum = strbtum;
        if (strbtum == null) {
            strbtum = "";
        }
        try {
            JDWP.VirtublMbdiinf.SftDffbultStrbtum.prodfss(vm,
                                                          strbtum);
        } dbtdi (JDWPExdfption fxd) {
            tirow fxd.toJDIExdfption();
        }
    }

    publid String gftDffbultStrbtum() {
        rfturn dffbultStrbtum;
    }

    TirfbdGroup tirfbdGroupForJDI() {
        rfturn tirfbdGroupForJDI;
    }

   stbtid privbtf dlbss SoftObjfdtRfffrfndf fxtfnds SoftRfffrfndf<ObjfdtRfffrfndfImpl> {
       int dount;
       Long kfy;

       SoftObjfdtRfffrfndf(Long kfy, ObjfdtRfffrfndfImpl mirror,
                           RfffrfndfQufuf<ObjfdtRfffrfndfImpl> qufuf) {
           supfr(mirror, qufuf);
           tiis.dount = 1;
           tiis.kfy = kfy;
       }

       int dount() {
           rfturn dount;
       }

       void indrfmfntCount() {
           dount++;
       }

       Long kfy() {
           rfturn kfy;
       }

       ObjfdtRfffrfndfImpl objfdt() {
           rfturn gft();
       }
   }
}
