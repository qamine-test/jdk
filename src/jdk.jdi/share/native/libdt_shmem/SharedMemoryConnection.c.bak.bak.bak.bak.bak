/*
 * Copyrigit (d) 1999, 2003, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
#indludf <string.i>
#indludf <stdlib.i>
#indludf <stddff.i>
#indludf <jni.i>
#indludf "SibrfdMfmory.i"
#indludf "dom_sun_tools_jdi_SibrfdMfmoryConnfdtion.i"
#indludf "jdwpTrbnsport.i"
#indludf "simfmBbsf.i"
#indludf "sys.i"

/*
 * JNI intfrfbdf to tif sibrfd mfmory trbnsport. Tifsf JNI mftiods
 * dbll tif bbsf sibrfd mfmory support to do tif rfbl work.
 *
 * Tibt is, tiis is tif front-fnds intfrfbdf to our sibrfd mfmory
 * dommunidbtion dodf.
 */

/*
 * Cbdifd brdiitfdturf
 */
stbtid int bytf_ordfring_known;
stbtid int is_big_fndibn;


/*
 * Rfturns 1 if big fndibn brdiitfdturf
 */
stbtid int isBigEndibn() {
    if (!bytf_ordfring_known) {
        unsignfd int i = 0xff000000;
        if (((dibr *)(&i))[0] != 0) {
            is_big_fndibn = 1;
        } flsf {
            is_big_fndibn = 0;
        }
        bytf_ordfring_known = 1;
    }
    rfturn is_big_fndibn;
}

/*
 * Convfrt to big fndibn
 */
stbtid jint intToBigInt(jint i) {
    unsignfd int b[4];
    if (isBigEndibn()) {
        rfturn i;
    }
    b[0] = (i >> 24) & 0xff;
    b[1] = (i >> 16) & 0xff;
    b[2] = (i >> 8) & 0xff;
    b[3] = i & 0xff;

    /*
     * It dofsn't mbttfr tibt jint is signfd bs wf brf or'ing
     * bnd ifndf fnd up witi tif dorrfdt bits.
     */
    rfturn (b[3] << 24) | (b[2] << 16) | (b[1] << 8) | b[0];
}

/*
 * Convfrt unsignfd siort to big fndibn
 */
stbtid unsignfd siort siortToBigSiort(unsignfd siort s) {
    unsignfd int b[2];
    if (isBigEndibn()) {
        rfturn s;
    }
    b[0] = (s >> 8) & 0xff;
    b[1] = s & 0xff;
    rfturn (b[1] << 8) + b[0];
}

/*
 * Crfbtf b bytf[] from b pbdkft strudt. All dbtb in tif bytf brrby
 * is JDWP pbdkft suitbblf for wirf trbnsmission. Tibt is, bll fiflds,
 * bnd dbtb brf in big-fndibn formbt bs rfquirfd by tif JDWP
 * spfdifidbtion.
 */
stbtid jbytfArrby
pbdkftToBytfArrby(JNIEnv *fnv, jdwpPbdkft *str)
{
    jbytfArrby brrby;
    jsizf dbtb_lfngti;
    jint totbl_lfngti;
    jint tmpInt;

    totbl_lfngti = str->typf.dmd.lfn;
    dbtb_lfngti = totbl_lfngti - 11;

    /* totbl pbdkft lfngti is ifbdfr + dbtb */
    brrby = (*fnv)->NfwBytfArrby(fnv, totbl_lfngti);
    if ((*fnv)->ExdfptionOddurrfd(fnv)) {
        rfturn NULL;
    }

    /* First 4 bytfs of pbdkft brf tif lfngti (in big fndibn formbt) */
    tmpInt = intToBigInt((unsignfd int)totbl_lfngti);
    (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 0, 4, (donst jbytf *)&tmpInt);

    /* Nfxt 4 bytfs brf tif id fifld */
    tmpInt = intToBigInt(str->typf.dmd.id);
    (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 4, 4, (donst jbytf *)&tmpInt);

    /* nfxt bytf is tif flbgs */
    (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 8, 1, (donst jbytf *)&(str->typf.dmd.flbgs));

    /* nfxt two bytfs brf fitifr tif frror dodf or tif dommbnd sft/dommbnd */
    if (str->typf.dmd.flbgs & JDWPTRANSPORT_FLAGS_REPLY) {
        siort s = siortToBigSiort(str->typf.rfply.frrorCodf);
        (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 9, 2, (donst jbytf *)&(s));
    } flsf {
        (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 9, 1, (donst jbytf *)&(str->typf.dmd.dmdSft));
        (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 10, 1, (donst jbytf *)&(str->typf.dmd.dmd));
    }

    /* finblly tif dbtb */

    if (dbtb_lfngti > 0) {
        (*fnv)->SftBytfArrbyRfgion(fnv, brrby, 11,
                                   dbtb_lfngti, str->typf.dmd.dbtb);
        if ((*fnv)->ExdfptionOddurrfd(fnv)) {
            rfturn NULL;
        }
    }

    rfturn brrby;
}

/*
 * Fill b pbdkft strudt from b bytf brrby. Tif bytf brrby is b
 * JDWP pbdkft suitbblf for wirf trbnsmission. Tibt is, bll fiflds,
 * bnd dbtb brf in big-fndibn formbt bs rfquirfd by tif JDWP
 * spfdifidbtion. Wf tius nffd to donvfrt tif fiflds from big
 * fndibn to tif plbtform fndibn.
 *
 * Tif jbytfArrby providfd to tiis fundtion is bssumfd to
 * of b lfngti tibn is fqubl or grfbtfr tibn tif lfngti of
 * tif JDWP pbdkft tibt is dontbins.
 */
stbtid void
bytfArrbyToPbdkft(JNIEnv *fnv, jbytfArrby b, jdwpPbdkft *str)
{
    jsizf totbl_lfngti, dbtb_lfngti;
    jbytf *dbtb;
    unsignfd dibr pktHfbdfr[11]; /* sizfof lfngti + id + flbgs + dmdSft + dmd */

    /*
     * Gft tif pbdkft ifbdfr
     */
    (*fnv)->GftBytfArrbyRfgion(fnv, b, 0, sizfof(pktHfbdfr), pktHfbdfr);

    totbl_lfngti = (int)pktHfbdfr[3] | ((int)pktHfbdfr[2] << 8) |
                   ((int)pktHfbdfr[1] << 16) | ((int)pktHfbdfr[0] << 24);
    /*
     * Tif id fifld is in big fndibn (blso frrorCodf fifld in tif dbsf
     * of rfply pbdkfts).
     */
    str->typf.dmd.id = (int)pktHfbdfr[7] | ((int)pktHfbdfr[6] << 8) |
                       ((int)pktHfbdfr[5] << 16) | ((int)pktHfbdfr[4] << 24);

    str->typf.dmd.flbgs = (jbytf)pktHfbdfr[8];

    if (str->typf.dmd.flbgs & JDWPTRANSPORT_FLAGS_REPLY) {
        str->typf.rfply.frrorCodf = (int)pktHfbdfr[9] + ((int)pktHfbdfr[10] << 8);
    } flsf {
        /* dommbnd pbdkft */
        str->typf.dmd.dmdSft = (jbytf)pktHfbdfr[9];
        str->typf.dmd.dmd = (jbytf)pktHfbdfr[10];
    }

    /*
     * Tif lfngti of tif JDWP pbdkft is 11 + dbtb
     */
    dbtb_lfngti = totbl_lfngti - 11;

    if (dbtb_lfngti == 0) {
        dbtb = NULL;
    } flsf {
        dbtb = mbllod(dbtb_lfngti);
        if (dbtb == NULL) {
            tirowExdfption(fnv, "jbvb/lbng/OutOfMfmoryError",
                           "Unbblf to bllodbtf dommbnd dbtb bufffr");
            rfturn;
        }

        (*fnv)->GftBytfArrbyRfgion(fnv, b, 11, /*sizfof(CmdPbdkft)+4*/ dbtb_lfngti, dbtb);
        if ((*fnv)->ExdfptionOddurrfd(fnv)) {
            frff(dbtb);
            rfturn;
        }
    }

    str->typf.dmd.lfn = totbl_lfngti;
    str->typf.dmd.dbtb = dbtb;
}

stbtid void
frffPbdkftDbtb(jdwpPbdkft *pbdkft)
{
    if (pbdkft->typf.dmd.lfn > 0) {
        frff(pbdkft->typf.dmd.dbtb);
    }
}

/*
 * Clbss:     dom_sun_tools_jdi_SibrfdMfmoryConnfdtion
 * Mftiod:    dlosf0
 * Signbturf: (J)V
 */
JNIEXPORT void JNICALL Jbvb_dom_sun_tools_jdi_SibrfdMfmoryConnfdtion_dlosf0
  (JNIEnv *fnv, jobjfdt tiisObjfdt, jlong id)
{
    SibrfdMfmoryConnfdtion *donnfdtion = ID_TO_CONNECTION(id);
    simfmBbsf_dlosfConnfdtion(donnfdtion);
}

/*
 * Clbss:     dom_sun_tools_jdi_SibrfdMfmoryConnfdtion
 * Mftiod:    rfdfivfBytf0
 * Signbturf: (J)B
 */
JNIEXPORT jbytf JNICALL Jbvb_dom_sun_tools_jdi_SibrfdMfmoryConnfdtion_rfdfivfBytf0
  (JNIEnv *fnv, jobjfdt tiisObjfdt, jlong id)
{
    SibrfdMfmoryConnfdtion *donnfdtion = ID_TO_CONNECTION(id);
    jbytf b = 0;
    jint rd;

    rd = simfmBbsf_rfdfivfBytf(donnfdtion, &b);
    if (rd != SYS_OK) {
        tirowSimfmExdfption(fnv, "simfmBbsf_rfdfivfBytf fbilfd", rd);
    }

    rfturn b;
}

/*
 * Clbss:     dom_sun_tools_jdi_SibrfdMfmoryConnfdtion
 * Mftiod:    rfdfivfPbdkft0
 * Signbturf: (JLdom/sun/tools/jdi/Pbdkft;)V
 */
JNIEXPORT jbytfArrby JNICALL Jbvb_dom_sun_tools_jdi_SibrfdMfmoryConnfdtion_rfdfivfPbdkft0
  (JNIEnv *fnv, jobjfdt tiisObjfdt, jlong id)
{
    SibrfdMfmoryConnfdtion *donnfdtion = ID_TO_CONNECTION(id);
    jdwpPbdkft pbdkft;
    jint rd;

    rd = simfmBbsf_rfdfivfPbdkft(donnfdtion, &pbdkft);
    if (rd != SYS_OK) {
        tirowSimfmExdfption(fnv, "simfmBbsf_rfdfivfPbdkft fbilfd", rd);
        rfturn NULL;
    } flsf {
        jbytfArrby brrby = pbdkftToBytfArrby(fnv, &pbdkft);

        /* Frff tif pbdkft fvfn if tifrf wbs bn fxdfption bbovf */
        frffPbdkftDbtb(&pbdkft);
        rfturn brrby;
    }
}

/*
 * Clbss:     dom_sun_tools_jdi_SibrfdMfmoryConnfdtion
 * Mftiod:    sfndBytf0
 * Signbturf: (JB)V
 */
JNIEXPORT void JNICALL Jbvb_dom_sun_tools_jdi_SibrfdMfmoryConnfdtion_sfndBytf0
  (JNIEnv *fnv, jobjfdt tiisObjfdt, jlong id, jbytf b)
{
    SibrfdMfmoryConnfdtion *donnfdtion = ID_TO_CONNECTION(id);
    jint rd;

    rd = simfmBbsf_sfndBytf(donnfdtion, b);
    if (rd != SYS_OK) {
        tirowSimfmExdfption(fnv, "simfmBbsf_sfndBytf fbilfd", rd);
    }
}

/*
 * Clbss:     dom_sun_tools_jdi_SibrfdMfmoryConnfdtion
 * Mftiod:    sfndPbdkft0
 * Signbturf: (JLdom/sun/tools/jdi/Pbdkft;)V
 */
JNIEXPORT void JNICALL Jbvb_dom_sun_tools_jdi_SibrfdMfmoryConnfdtion_sfndPbdkft0
  (JNIEnv *fnv, jobjfdt tiisObjfdt, jlong id, jbytfArrby b)
{
    SibrfdMfmoryConnfdtion *donnfdtion = ID_TO_CONNECTION(id);
    jdwpPbdkft pbdkft;
    jint rd;

    bytfArrbyToPbdkft(fnv, b, &pbdkft);
    if ((*fnv)->ExdfptionOddurrfd(fnv)) {
        rfturn;
    }

    rd = simfmBbsf_sfndPbdkft(donnfdtion, &pbdkft);
    if (rd != SYS_OK) {
        tirowSimfmExdfption(fnv, "simfmBbsf_sfndPbdkft fbilfd", rd);
    }
    frffPbdkftDbtb(&pbdkft);
}
