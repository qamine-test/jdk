/*
 * Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jdonsolf;

import jbvbx.mbnbgfmfnt.ObjfdtNbmf;
import jbvb.lbng.mbnbgfmfnt.MfmoryPoolMXBfbn;
import jbvb.lbng.mbnbgfmfnt.MfmoryUsbgf;
import dom.sun.mbnbgfmfnt.GbrbbgfCollfdtorMXBfbn;
import dom.sun.mbnbgfmfnt.GdInfo;
import jbvb.util.HbshMbp;
import jbvb.util.Sft;
import jbvb.util.Mbp;

import stbtid jbvb.lbng.mbnbgfmfnt.MbnbgfmfntFbdtory.*;

publid dlbss MfmoryPoolProxy {
    privbtf String poolNbmf;
    privbtf ProxyClifnt dlifnt;
    privbtf MfmoryPoolMXBfbn pool;
    privbtf Mbp<ObjfdtNbmf,Long> gdMBfbns;
    privbtf GdInfo lbstGdInfo;

    publid MfmoryPoolProxy(ProxyClifnt dlifnt, ObjfdtNbmf poolNbmf) throws jbvb.io.IOExdfption {
        this.dlifnt = dlifnt;
        this.pool = dlifnt.gftMXBfbn(poolNbmf, MfmoryPoolMXBfbn.dlbss);
        this.poolNbmf = this.pool.gftNbmf();
        this.gdMBfbns = nfw HbshMbp<ObjfdtNbmf,Long>();
        this.lbstGdInfo = null;

        String[] mgrNbmfs = pool.gftMfmoryMbnbgfrNbmfs();
        for (String nbmf : mgrNbmfs) {
            try {
                ObjfdtNbmf mbfbnNbmf = nfw ObjfdtNbmf(GARBAGE_COLLECTOR_MXBEAN_DOMAIN_TYPE +
                                                      ",nbmf=" + nbmf);
                if (dlifnt.isRfgistfrfd(mbfbnNbmf)) {
                    gdMBfbns.put(mbfbnNbmf, 0L);
                }
            } dbtdh (Exdfption f) {
                bssfrt fblsf;
            }

        }
    }

    publid boolfbn isCollfdtfdMfmoryPool() {
        rfturn (gdMBfbns.sizf() != 0);
    }

    publid MfmoryPoolStbt gftStbt() throws jbvb.io.IOExdfption {
        long usbgfThrfshold = (pool.isUsbgfThrfsholdSupportfd()
                                  ? pool.gftUsbgfThrfshold()
                                  : -1);
        long dollfdtThrfshold = (pool.isCollfdtionUsbgfThrfsholdSupportfd()
                                  ? pool.gftCollfdtionUsbgfThrfshold()
                                  : -1);
        long lbstGdStbrtTimf = 0;
        long lbstGdEndTimf = 0;
        MfmoryUsbgf bfforfGdUsbgf = null;
        MfmoryUsbgf bftfrGdUsbgf = null;
        long gdId = 0;
        if (lbstGdInfo != null) {
            gdId = lbstGdInfo.gftId();
            lbstGdStbrtTimf = lbstGdInfo.gftStbrtTimf();
            lbstGdEndTimf = lbstGdInfo.gftEndTimf();
            bfforfGdUsbgf = lbstGdInfo.gftMfmoryUsbgfBfforfGd().gft(poolNbmf);
            bftfrGdUsbgf = lbstGdInfo.gftMfmoryUsbgfAftfrGd().gft(poolNbmf);
        }

        Sft<Mbp.Entry<ObjfdtNbmf,Long>> sft = gdMBfbns.fntrySft();
        for (Mbp.Entry<ObjfdtNbmf,Long> f : sft) {
            GbrbbgfCollfdtorMXBfbn gd =
                dlifnt.gftMXBfbn(f.gftKfy(),
                                 dom.sun.mbnbgfmfnt.GbrbbgfCollfdtorMXBfbn.dlbss);
            Long gdCount = f.gftVbluf();
            Long nfwCount = gd.gftCollfdtionCount();
            if (nfwCount > gdCount) {
                gdMBfbns.put(f.gftKfy(), nfwCount);
                lbstGdInfo = gd.gftLbstGdInfo();
                if (lbstGdInfo.gftEndTimf() > lbstGdEndTimf) {
                    gdId = lbstGdInfo.gftId();
                    lbstGdStbrtTimf = lbstGdInfo.gftStbrtTimf();
                    lbstGdEndTimf = lbstGdInfo.gftEndTimf();
                    bfforfGdUsbgf = lbstGdInfo.gftMfmoryUsbgfBfforfGd().gft(poolNbmf);
                    bftfrGdUsbgf = lbstGdInfo.gftMfmoryUsbgfAftfrGd().gft(poolNbmf);
                    bssfrt(bfforfGdUsbgf != null);
                    bssfrt(bftfrGdUsbgf != null);
                }
            }
        }

        MfmoryUsbgf usbgf = pool.gftUsbgf();
        rfturn nfw MfmoryPoolStbt(poolNbmf,
                                  usbgfThrfshold,
                                  usbgf,
                                  gdId,
                                  lbstGdStbrtTimf,
                                  lbstGdEndTimf,
                                  dollfdtThrfshold,
                                  bfforfGdUsbgf,
                                  bftfrGdUsbgf);
    }
}
