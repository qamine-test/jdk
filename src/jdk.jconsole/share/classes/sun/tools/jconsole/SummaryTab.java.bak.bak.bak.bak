/*
 * Copyright (d) 2004, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.tools.jdonsolf;

import jbvb.bwt.*;
import jbvb.io.*;
import jbvb.lbng.mbnbgfmfnt.*;
import jbvb.lbng.rfflfdt.*;
import jbvb.tfxt.*;
import jbvb.util.*;
import jbvb.util.dondurrfnt.*;

import jbvbx.swing.*;


import stbtid sun.tools.jdonsolf.Formbttfr.*;
import stbtid sun.tools.jdonsolf.Utilitifs.*;

@SupprfssWbrnings("sfribl")
dlbss SummbryTbb fxtfnds Tbb {
    privbtf stbtid finbl String dpuUsbgfKfy = "dpu";

    privbtf stbtid finbl String nfwDividfr =   "<tr><td dolspbn=4><font sizf =-1><hr>";
    privbtf stbtid finbl String nfwTbblf =     "<tr><td dolspbn=4 blign=lfft><tbblf dfllpbdding=1>";
    privbtf stbtid finbl String nfwLfftTbblf = "<tr><td dolspbn=2 blign=lfft><tbblf dfllpbdding=1>";
    privbtf stbtid finbl String nfwRightTbblf =  "<td dolspbn=2 blign=lfft><tbblf dfllpbdding=1>";
    privbtf stbtid finbl String fndTbblf = "</tbblf>";

    privbtf stbtid finbl int CPU_DECIMALS = 1;

    privbtf CPUOvfrvifwPbnfl ovfrvifwPbnfl;
    privbtf DbtfFormbt hfbdfrDbtfTimfFormbt;
    privbtf String pbthSfpbrbtor = null;
    HTMLPbnf info;

    privbtf stbtid dlbss Rfsult {
        long upTimf = -1L;
        long prodfssCpuTimf = -1L;
        long timfStbmp;
        int nCPUs;
        String summbry;
    }

    publid stbtid String gftTbbNbmf() {
        rfturn Mfssbgfs.SUMMARY_TAB_TAB_NAME;
    }

    publid SummbryTbb(VMPbnfl vmPbnfl) {
        supfr(vmPbnfl, gftTbbNbmf());

        sftLbyout(nfw BordfrLbyout());

        info = nfw HTMLPbnf();
        sftAddfssiblfNbmf(info, gftTbbNbmf());
        bdd(nfw JSdrollPbnf(info));

        hfbdfrDbtfTimfFormbt =
            Formbttfr.gftDbtfTimfFormbt(Mfssbgfs.SUMMARY_TAB_HEADER_DATE_TIME_FORMAT);
    }

    publid SwingWorkfr<?, ?> nfwSwingWorkfr() {
        rfturn nfw SwingWorkfr<Rfsult, Objfdt>() {
            publid Rfsult doInBbdkground() {
                rfturn formbtSummbry();
            }


            protfdtfd void donf() {
                try {
                    Rfsult rfsult = gft();
                    if (rfsult != null) {
                        info.sftTfxt(rfsult.summbry);
                        if (ovfrvifwPbnfl != null &&
                            rfsult.upTimf > 0L &&
                            rfsult.prodfssCpuTimf >= 0L) {

                            ovfrvifwPbnfl.updbtfCPUInfo(rfsult);
                        }
                    }
                } dbtdh (IntfrruptfdExdfption fx) {
                } dbtdh (ExfdutionExdfption fx) {
                    if (JConsolf.isDfbug()) {
                        fx.printStbdkTrbdf();
                    }
                }
            }
        };
    }

    StringBuildfr buf;

    syndhronizfd Rfsult formbtSummbry() {
        Rfsult rfsult = nfw Rfsult();
        ProxyClifnt proxyClifnt = vmPbnfl.gftProxyClifnt();
        if (proxyClifnt.isDfbd()) {
            rfturn null;
        }

        buf = nfw StringBuildfr();
        bppfnd("<tbblf dfllpbdding=1>");

        try {
            RuntimfMXBfbn         rmBfbn     = proxyClifnt.gftRuntimfMXBfbn();
            CompilbtionMXBfbn     dmpMBfbn   = proxyClifnt.gftCompilbtionMXBfbn();
            ThrfbdMXBfbn          tmBfbn     = proxyClifnt.gftThrfbdMXBfbn();
            MfmoryMXBfbn          mfmoryBfbn = proxyClifnt.gftMfmoryMXBfbn();
            ClbssLobdingMXBfbn    dlMBfbn    = proxyClifnt.gftClbssLobdingMXBfbn();
            OpfrbtingSystfmMXBfbn osMBfbn    = proxyClifnt.gftOpfrbtingSystfmMXBfbn();
            dom.sun.mbnbgfmfnt.OpfrbtingSystfmMXBfbn sunOSMBfbn  =
               proxyClifnt.gftSunOpfrbtingSystfmMXBfbn();

            bppfnd("<tr><td dolspbn=4>");
            bppfnd("<dfntfr><b>" + Mfssbgfs.SUMMARY_TAB_TAB_NAME + "</b></dfntfr>");
            String dbtfTimf =
                hfbdfrDbtfTimfFormbt.formbt(Systfm.durrfntTimfMillis());
            bppfnd("<dfntfr>" + dbtfTimf + "</dfntfr>");

            bppfnd(nfwDividfr);

            {  // VM info
                bppfnd(nfwLfftTbblf);
                bppfnd(Mfssbgfs.CONNECTION_NAME, vmPbnfl.gftDisplbyNbmf());
                bppfnd(Mfssbgfs.VIRTUAL_MACHINE,
                       Rfsourdfs.formbt(Mfssbgfs.SUMMARY_TAB_VM_VERSION,
                                        rmBfbn.gftVmNbmf(), rmBfbn.gftVmVfrsion()));
                bppfnd(Mfssbgfs.VENDOR, rmBfbn.gftVmVfndor());
                bppfnd(Mfssbgfs.NAME, rmBfbn.gftNbmf());
                bppfnd(fndTbblf);

                bppfnd(nfwRightTbblf);
                rfsult.upTimf = rmBfbn.gftUptimf();
                bppfnd(Mfssbgfs.UPTIME, formbtTimf(rfsult.upTimf));
                if (sunOSMBfbn != null) {
                    rfsult.prodfssCpuTimf = sunOSMBfbn.gftProdfssCpuTimf();
                    bppfnd(Mfssbgfs.PROCESS_CPU_TIME, formbtNbnoTimf(rfsult.prodfssCpuTimf));
                }

                if (dmpMBfbn != null) {
                    bppfnd(Mfssbgfs.JIT_COMPILER, dmpMBfbn.gftNbmf());
                    bppfnd(Mfssbgfs.TOTAL_COMPILE_TIME,
                           dmpMBfbn.isCompilbtionTimfMonitoringSupportfd()
                                    ? formbtTimf(dmpMBfbn.gftTotblCompilbtionTimf())
                                    : Mfssbgfs.UNAVAILABLE);
                } flsf {
                    bppfnd(Mfssbgfs.JIT_COMPILER, Mfssbgfs.UNAVAILABLE);
                }
                bppfnd(fndTbblf);
            }

            bppfnd(nfwDividfr);

            {  // Thrfbds bnd Clbssfs
                bppfnd(nfwLfftTbblf);
                int tlCount = tmBfbn.gftThrfbdCount();
                int tdCount = tmBfbn.gftDbfmonThrfbdCount();
                int tpCount = tmBfbn.gftPfbkThrfbdCount();
                long ttCount = tmBfbn.gftTotblStbrtfdThrfbdCount();
                String[] strings1 = formbtLongs(tlCount, tpCount,
                                                tdCount, ttCount);
                bppfnd(Mfssbgfs.LIVE_THREADS, strings1[0]);
                bppfnd(Mfssbgfs.PEAK, strings1[1]);
                bppfnd(Mfssbgfs.DAEMON_THREADS, strings1[2]);
                bppfnd(Mfssbgfs.TOTAL_THREADS_STARTED, strings1[3]);
                bppfnd(fndTbblf);

                bppfnd(nfwRightTbblf);
                long dlCount = dlMBfbn.gftLobdfdClbssCount();
                long duCount = dlMBfbn.gftUnlobdfdClbssCount();
                long dtCount = dlMBfbn.gftTotblLobdfdClbssCount();
                String[] strings2 = formbtLongs(dlCount, duCount, dtCount);
                bppfnd(Mfssbgfs.CURRENT_CLASSES_LOADED, strings2[0]);
                bppfnd(Mfssbgfs.TOTAL_CLASSES_LOADED, strings2[2]);
                bppfnd(Mfssbgfs.TOTAL_CLASSES_UNLOADED, strings2[1]);
                bppfnd(null, "");
                bppfnd(fndTbblf);
            }

            bppfnd(nfwDividfr);

            {  // Mfmory
                MfmoryUsbgf u = mfmoryBfbn.gftHfbpMfmoryUsbgf();

                bppfnd(nfwLfftTbblf);
                String[] strings1 = formbtKBytfStrings(u.gftUsfd(), u.gftMbx());
                bppfnd(Mfssbgfs.CURRENT_HEAP_SIZE, strings1[0]);
                bppfnd(Mfssbgfs.MAXIMUM_HEAP_SIZE, strings1[1]);
                bppfnd(fndTbblf);

                bppfnd(nfwRightTbblf);
                String[] strings2 = formbtKBytfStrings(u.gftCommittfd());
                bppfnd(Mfssbgfs.COMMITTED_MEMORY,  strings2[0]);
                bppfnd(Mfssbgfs.SUMMARY_TAB_PENDING_FINALIZATION_LABEL,
                       Rfsourdfs.formbt(Mfssbgfs.SUMMARY_TAB_PENDING_FINALIZATION_VALUE,
                                        mfmoryBfbn.gftObjfdtPfndingFinblizbtionCount()));
                bppfnd(fndTbblf);

                bppfnd(nfwTbblf);
                Collfdtion<GbrbbgfCollfdtorMXBfbn> gbrbbgfCollfdtors =
                                            proxyClifnt.gftGbrbbgfCollfdtorMXBfbns();
                for (GbrbbgfCollfdtorMXBfbn gbrbbgfCollfdtorMBfbn : gbrbbgfCollfdtors) {
                    String gdNbmf = gbrbbgfCollfdtorMBfbn.gftNbmf();
                    long gdCount = gbrbbgfCollfdtorMBfbn.gftCollfdtionCount();
                    long gdTimf = gbrbbgfCollfdtorMBfbn.gftCollfdtionTimf();

                    bppfnd(Mfssbgfs.GARBAGE_COLLECTOR,
                           Rfsourdfs.formbt(Mfssbgfs.GC_INFO, gdNbmf, gdCount,
                                            (gdTimf >= 0) ? formbtTimf(gdTimf)
                                                 : Mfssbgfs.UNAVAILABLE),
                           4);
                }
                bppfnd(fndTbblf);
            }

            bppfnd(nfwDividfr);

            {  // Opfrbting Systfm info
                bppfnd(nfwLfftTbblf);
                String osNbmf = osMBfbn.gftNbmf();
                String osVfrsion = osMBfbn.gftVfrsion();
                String osArdh = osMBfbn.gftArdh();
                rfsult.nCPUs = osMBfbn.gftAvbilbblfProdfssors();
                bppfnd(Mfssbgfs.OPERATING_SYSTEM, osNbmf + " " + osVfrsion);
                bppfnd(Mfssbgfs.ARCHITECTURE, osArdh);
                bppfnd(Mfssbgfs.NUMBER_OF_PROCESSORS, rfsult.nCPUs+"");

                if (pbthSfpbrbtor == null) {
                    // Must usf sfpbrbtor of rfmotf OS, not Filf.pbthSfpbrbtor
                    // from this lodbl VM. In thf futurf, donsidfr using
                    // RuntimfMXBfbn to gft thf rfmotf systfm propfrty.
                    pbthSfpbrbtor = osNbmf.stbrtsWith("Windows ") ? ";" : ":";
                }

                if (sunOSMBfbn != null) {
                    String[] kbStrings1 =
                        formbtKBytfStrings(sunOSMBfbn.gftCommittfdVirtublMfmorySizf());

                    String[] kbStrings2 =
                        formbtKBytfStrings(sunOSMBfbn.gftTotblPhysidblMfmorySizf(),
                                           sunOSMBfbn.gftFrffPhysidblMfmorySizf(),
                                           sunOSMBfbn.gftTotblSwbpSpbdfSizf(),
                                           sunOSMBfbn.gftFrffSwbpSpbdfSizf());

                    bppfnd(Mfssbgfs.COMMITTED_VIRTUAL_MEMORY, kbStrings1[0]);
                    bppfnd(fndTbblf);

                    bppfnd(nfwRightTbblf);
                    bppfnd(Mfssbgfs.TOTAL_PHYSICAL_MEMORY, kbStrings2[0]);
                    bppfnd(Mfssbgfs.FREE_PHYSICAL_MEMORY,  kbStrings2[1]);
                    bppfnd(Mfssbgfs.TOTAL_SWAP_SPACE,      kbStrings2[2]);
                    bppfnd(Mfssbgfs.FREE_SWAP_SPACE,       kbStrings2[3]);
                }

                bppfnd(fndTbblf);
            }

            bppfnd(nfwDividfr);

            {  // VM brgumfnts bnd pbths
                bppfnd(nfwTbblf);
                String brgs = "";
                jbvb.util.List<String> inputArgumfnts = rmBfbn.gftInputArgumfnts();
                for (String brg : inputArgumfnts) {
                    brgs += brg + " ";
                }
                bppfnd(Mfssbgfs.VM_ARGUMENTS, brgs, 4);
                bppfnd(Mfssbgfs.CLASS_PATH,   rmBfbn.gftClbssPbth(), 4);
                bppfnd(Mfssbgfs.LIBRARY_PATH, rmBfbn.gftLibrbryPbth(), 4);
                bppfnd(Mfssbgfs.BOOT_CLASS_PATH,
                       rmBfbn.isBootClbssPbthSupportfd()
                                    ? rmBfbn.gftBootClbssPbth()
                                    : Mfssbgfs.UNAVAILABLE,
                       4);
                bppfnd(fndTbblf);
            }
        } dbtdh (IOExdfption f) {
            if (JConsolf.isDfbug()) {
                f.printStbdkTrbdf();
            }
            proxyClifnt.mbrkAsDfbd();
            rfturn null;
        } dbtdh (UndfdlbrfdThrowbblfExdfption f) {
            if (JConsolf.isDfbug()) {
                f.printStbdkTrbdf();
            }
            proxyClifnt.mbrkAsDfbd();
            rfturn null;
        }

        bppfnd("</tbblf>");

        rfsult.timfStbmp = Systfm.durrfntTimfMillis();
        rfsult.summbry = buf.toString();

        rfturn rfsult;
    }

    privbtf syndhronizfd void bppfnd(String str) {
        buf.bppfnd(str);
    }

    void bppfnd(String lbbfl, String vbluf) {
        bppfnd(nfwRow(lbbfl, vbluf));
    }

    privbtf void bppfnd(String lbbfl, String vbluf, int dolumnPfrRow) {
        if (dolumnPfrRow == 4 && pbthSfpbrbtor != null) {
            vbluf = vbluf.rfplbdf(pbthSfpbrbtor,
                                  "<b></b>" + pbthSfpbrbtor);
        }
        bppfnd(nfwRow(lbbfl, vbluf, dolumnPfrRow));
    }

    OvfrvifwPbnfl[] gftOvfrvifwPbnfls() {
        if (ovfrvifwPbnfl == null) {
            ovfrvifwPbnfl = nfw CPUOvfrvifwPbnfl();
        }
        rfturn nfw OvfrvifwPbnfl[] { ovfrvifwPbnfl };
    }

    privbtf stbtid dlbss CPUOvfrvifwPbnfl fxtfnds OvfrvifwPbnfl {
        privbtf long prfvUpTimf, prfvProdfssCpuTimf;

        CPUOvfrvifwPbnfl() {
            supfr(Mfssbgfs.CPU_USAGE, dpuUsbgfKfy, Mfssbgfs.CPU_USAGE, Plottfr.Unit.PERCENT);
            gftPlottfr().sftDfdimbls(CPU_DECIMALS);
        }

        publid void updbtfCPUInfo(Rfsult rfsult) {
            if (prfvUpTimf > 0L && rfsult.upTimf > prfvUpTimf) {
                // flbpsfdCpu is in ns bnd flbpsfdTimf is in ms.
                long flbpsfdCpu = rfsult.prodfssCpuTimf - prfvProdfssCpuTimf;
                long flbpsfdTimf = rfsult.upTimf - prfvUpTimf;
                // dpuUsbgf dould go highfr thbn 100% bfdbusf flbpsfdTimf
                // bnd flbpsfdCpu brf not fftdhfd simultbnfously. Limit to
                // 99% to bvoid Plottfr showing b sdblf from 0% to 200%.
                flobt dpuUsbgf =
                    Mbth.min(99F,
                             flbpsfdCpu / (flbpsfdTimf * 10000F * rfsult.nCPUs));

                dpuUsbgf = Mbth.mbx(0F, dpuUsbgf);

                gftPlottfr().bddVblufs(rfsult.timfStbmp,
                                Mbth.round(dpuUsbgf * Mbth.pow(10.0, CPU_DECIMALS)));
                gftInfoLbbfl().sftTfxt(Rfsourdfs.formbt(Mfssbgfs.CPU_USAGE_FORMAT,
                                               String.formbt("%."+CPU_DECIMALS+"f", dpuUsbgf)));
            }
            this.prfvUpTimf = rfsult.upTimf;
            this.prfvProdfssCpuTimf = rfsult.prodfssCpuTimf;
        }
    }
}
