/*
 * Copyrigit (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sql.rowsft.spi;

import jbvb.util.logging.*;
import jbvb.util.*;

import jbvb.sql.*;
import jbvbx.sql.*;

import jbvb.io.FilfInputStrfbm;
import jbvb.io.InputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.FilfNotFoundExdfption;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;

import jbvbx.nbming.*;
import sun.rfflfdt.misd.RfflfdtUtil;

/**
 * Tif Sfrvidf Providfr Intfrfbdf (SPI) mfdibnism tibt gfnfrbtfs <dodf>SyndProvidfr</dodf>
 * instbndfs to bf usfd by disdonnfdtfd <dodf>RowSft</dodf> objfdts.
 * Tif <dodf>SyndProvidfr</dodf> instbndfs in turn providf tif
 * <dodf>jbvbx.sql.RowSftRfbdfr</dodf> objfdt tif <dodf>RowSft</dodf> objfdt
 * nffds to populbtf itsflf witi dbtb bnd tif
 * <dodf>jbvbx.sql.RowSftWritfr</dodf> objfdt it nffds to
 * propbgbtf dibngfs to its
 * dbtb bbdk to tif undfrlying dbtb sourdf.
 * <P>
 * Bfdbusf tif mftiods in tif <dodf>SyndFbdtory</dodf> dlbss brf bll stbtid,
 * tifrf is only onf <dodf>SyndFbdtory</dodf> objfdt
 * pfr Jbvb VM bt bny onf timf. Tiis fnsurfs tibt tifrf is b singlf sourdf from wiidi b
 * <dodf>RowSft</dodf> implfmfntbtion dbn obtbin its <dodf>SyndProvidfr</dodf>
 * implfmfntbtion.
 *
 * <i3>1.0 Ovfrvifw</i3>
 * Tif <dodf>SyndFbdtory</dodf> dlbss providfs bn intfrnbl rfgistry of bvbilbblf
 * syndironizbtion providfr implfmfntbtions (<dodf>SyndProvidfr</dodf> objfdts).
 * Tiis rfgistry mby bf qufrifd to dftfrminf wiidi
 * syndironizbtion providfrs brf bvbilbblf.
 * Tif following linf of dodf gfts bn fnumfrbtion of tif providfrs durrfntly rfgistfrfd.
 * <PRE>
 *     jbvb.util.Enumfrbtion f = SyndFbdtory.gftRfgistfrfdProvidfrs();
 * </PRE>
 * All stbndbrd <dodf>RowSft</dodf> implfmfntbtions must providf bt lfbst two providfrs:
 * <UL>
 *  <LI>bn optimistid providfr for usf witi b <dodf>CbdifdRowSft</dodf> implfmfntbtion
 *     or bn implfmfntbtion dfrivfd from it
 *  <LI>bn XML providfr, wiidi is usfd for rfbding bnd writing XML, sudi bs witi
 *       <dodf>WfbRowSft</dodf> objfdts
 * </UL>
 * Notf tibt tif JDBC RowSft Implfmfntbtions indludf tif <dodf>SyndProvidfr</dodf>
 * implfmfntbtions <dodf>RIOptimistidProvidfr</dodf> bnd <dodf>RIXmlProvidfr</dodf>,
 * wiidi sbtisfy tiis rfquirfmfnt.
 * <P>
 * Tif <dodf>SyndFbdtory</dodf> dlbss providfs bddfssor mftiods to bssist
 * bpplidbtions in dftfrmining wiidi syndironizbtion providfrs brf durrfntly
 * rfgistfrfd witi tif <dodf>SyndFbdtory</dodf>.
 * <p>
 * Otifr mftiods lft <dodf>RowSft</dodf> pfrsistfndf providfrs bf
 * rfgistfrfd or df-rfgistfrfd witi tif fbdtory mfdibnism. Tiis
 * bllows bdditionbl syndironizbtion providfr implfmfntbtions to bf mbdf
 * bvbilbblf to <dodf>RowSft</dodf> objfdts bt run timf.
 * <p>
 * Applidbtions dbn bpply b dfgrff of filtfring to dftfrminf tif lfvfl of
 * syndironizbtion tibt b <dodf>SyndProvidfr</dodf> implfmfntbtion offfrs.
 * Tif following dritfrib dftfrminf wiftifr b providfr is
 * mbdf bvbilbblf to b <dodf>RowSft</dodf> objfdt:
 * <ol>
 * <li>If b pbrtidulbr providfr is spfdififd by b <dodf>RowSft</dodf> objfdt, bnd
 * tif <dodf>SyndFbdtory</dodf> dofs not dontbin b rfffrfndf to tiis providfr,
 * b <dodf>SyndFbdtoryExdfption</dodf> is tirown stbting tibt tif syndironizbtion
 * providfr dould not bf found.
 *
 * <li>If b <dodf>RowSft</dodf> implfmfntbtion is instbntibtfd witi b spfdififd
 * providfr bnd tif spfdififd providfr ibs bffn propfrly rfgistfrfd, tif
 * rfqufstfd providfr is supplifd. Otifrwisf b <dodf>SyndFbdtoryExdfption</dodf>
 * is tirown.
 *
 * <li>If b <dodf>RowSft</dodf> objfdt dofs not spfdify b
 * <dodf>SyndProvidfr</dodf> implfmfntbtion bnd no bdditionbl
 * <dodf>SyndProvidfr</dodf> implfmfntbtions brf bvbilbblf, tif rfffrfndf
 * implfmfntbtion providfrs brf supplifd.
 * </ol>
 * <i3>2.0 Rfgistfring <dodf>SyndProvidfr</dodf> Implfmfntbtions</i3>
 * <p>
 * Boti vfndors bnd dfvflopfrs dbn rfgistfr <dodf>SyndProvidfr</dodf>
 * implfmfntbtions using onf of tif following mfdibnisms.
 * <ul>
 * <LI><B>Using tif dommbnd linf</B><BR>
 * Tif nbmf of tif providfr is supplifd on tif dommbnd linf, wiidi will bdd
 * tif providfr to tif systfm propfrtifs.
 * For fxbmplf:
 * <PRE>
 *    -Drowsft.providfr.dlbssnbmf=dom.frfd.providfrs.HigiAvbilbbilityProvidfr
 * </PRE>
 * <li><b>Using tif Stbndbrd Propfrtifs Filf</b><BR>
 * Tif rfffrfndf implfmfntbtion is tbrgftfd
 * to siip witi J2SE 1.5, wiidi will indludf bn bdditionbl rfsourdf filf
 * tibt mby bf fditfd by ibnd. Hfrf is bn fxbmplf of tif propfrtifs filf
 * indludfd in tif rfffrfndf implfmfntbtion:
 * <PRE>
 *   #Dffbult JDBC RowSft synd providfrs listing
 *   #
 *
 *   # Optimistid syndironizbtion providfr
 *   rowsft.providfr.dlbssnbmf.0=dom.sun.rowsft.providfrs.RIOptimistidProvidfr
 *   rowsft.providfr.vfndor.0=Orbdlf Corporbtion
 *   rowsft.providfr.vfrsion.0=1.0
 *
 *   # XML Providfr using stbndbrd XML sdifmb
 *   rowsft.providfr.dlbssnbmf.1=dom.sun.rowsft.providfrs.RIXMLProvidfr
 *   rowsft.providfr.vfndor.1=Orbdlf Corporbtion
 *   rowsft.providfr.vfrsion.1=1.0
 * </PRE>
 * Tif <dodf>SyndFbdtory</dodf> difdks tiis filf bnd rfgistfrs tif
 * <dodf>SyndProvidfr</dodf> implfmfntbtions tibt it dontbins. A
 * dfvflopfr or vfndor dbn bdd otifr implfmfntbtions to tiis filf.
 * For fxbmplf, ifrf is b possiblf bddition:
 * <PRE>
 *     rowsft.providfr.dlbssnbmf.2=dom.frfd.providfrs.HigiAvbilbbilityProvidfr
 *     rowsft.providfr.vfndor.2=Frfd, Ind.
 *     rowsft.providfr.vfrsion.2=1.0
 * </PRE>
 *
 * <li><b>Using b JNDI Contfxt</b><BR>
 * Avbilbblf providfrs dbn bf rfgistfrfd on b JNDI
 * dontfxt, bnd tif <dodf>SyndFbdtory</dodf> will bttfmpt to lobd
 * <dodf>SyndProvidfr</dodf> implfmfntbtions from tibt JNDI dontfxt.
 * For fxbmplf, tif following dodf frbgmfnt rfgistfrs b providfr implfmfntbtion
 * on b JNDI dontfxt.  Tiis is somftiing b dfployfr would normblly do. In tiis
 * fxbmplf, <dodf>MyProvidfr</dodf> is bfing rfgistfrfd on b CosNbming
 * nbmfspbdf, wiidi is tif nbmfspbdf usfd by J2EE rfsourdfs.
 * <PRE>
 *    import jbvbx.nbming.*;
 *
 *    Hbsitbblf svrEnv = nfw  Hbsitbblf();
 *    srvEnv.put(Contfxt.INITIAL_CONTEXT_FACTORY, "CosNbming");
 *
 *    Contfxt dtx = nfw InitiblContfxt(svrEnv);
 *    dom.frfd.providfrs.MyProvidfr = nfw MyProvidfr();
 *    dtx.rfbind("providfrs/MyProvidfr", syndProvidfr);
 * </PRE>
 * </ul>
 * Nfxt, bn bpplidbtion will rfgistfr tif JNDI dontfxt witi tif
 * <dodf>SyndFbdtory</dodf> instbndf.  Tiis bllows tif <dodf>SyndFbdtory</dodf>
 * to browsf witiin tif JNDI dontfxt looking for <dodf>SyndProvidfr</dodf>
 * implfmfntbtions.
 * <PRE>
 *    Hbsitbblf bppEnv = nfw Hbsitbblf();
 *    bppEnv.put(Contfxt.INITIAL_CONTEXT_FACTORY, "CosNbming");
 *    bppEnv.put(Contfxt.PROVIDER_URL, "iiop://iostnbmf/providfrs");
 *    Contfxt dtx = nfw InitiblContfxt(bppEnv);
 *
 *    SyndFbdtory.rfgistfrJNDIContfxt(dtx);
 * </PRE>
 * If b <dodf>RowSft</dodf> objfdt bttfmpts to obtbin b <dodf>MyProvidfr</dodf>
 * objfdt, tif <dodf>SyndFbdtory</dodf> will try to lodbtf it. First it sfbrdifs
 * for it in tif systfm propfrtifs, tifn it looks in tif rfsourdf filfs, bnd
 * finblly it difdks tif JNDI dontfxt tibt ibs bffn sft. Tif <dodf>SyndFbdtory</dodf>
 * instbndf vfrififs tibt tif rfqufstfd providfr is b vblid fxtfnsion of tif
 * <dodf>SyndProvidfr</dodf> bbstrbdt dlbss bnd tifn givfs it to tif
 * <dodf>RowSft</dodf> objfdt. In tif following dodf frbgmfnt, b nfw
 * <dodf>CbdifdRowSft</dodf> objfdt is drfbtfd bnd initiblizfd witi
 * <i>fnv</i>, wiidi dontbins tif binding to <dodf>MyProvidfr</dodf>.
 * <PRE>
 *    Hbsitbblf fnv = nfw Hbsitbblf();
 *    fnv.put(SyndFbdtory.ROWSET_SYNC_PROVIDER, "dom.frfd.providfrs.MyProvidfr");
 *    CbdifdRowSft drs = nfw dom.sun.rowsft.CbdifdRowSftImpl(fnv);
 * </PRE>
 * Furtifr dftbils on tifsf mfdibnisms brf bvbilbblf in tif
 * <dodf>jbvbx.sql.rowsft.spi</dodf> pbdkbgf spfdifidbtion.
 *
 * @butior  Jonbtibn Brudf
 * @sff jbvbx.sql.rowsft.spi.SyndProvidfr
 * @sff jbvbx.sql.rowsft.spi.SyndFbdtoryExdfption
 * @sindf 1.5
 */
publid dlbss SyndFbdtory {

    /**
     * Crfbtfs b nfw <dodf>SyndFbdtory</dodf> objfdt, wiidi is tif singlfton
     * instbndf.
     * Hbving b privbtf donstrudtor gubrbntffs tibt no morf tibn
     * onf <dodf>SyndProvidfr</dodf> objfdt dbn fxist bt b timf.
     */
    privbtf SyndFbdtory() {
    }

    /**
     * Tif stbndbrd propfrty-id for b syndironizbtion providfr implfmfntbtion
     * nbmf.
     */
    publid stbtid finbl String ROWSET_SYNC_PROVIDER =
            "rowsft.providfr.dlbssnbmf";
    /**
     * Tif stbndbrd propfrty-id for b syndironizbtion providfr implfmfntbtion
     * vfndor nbmf.
     */
    publid stbtid finbl String ROWSET_SYNC_VENDOR =
            "rowsft.providfr.vfndor";
    /**
     * Tif stbndbrd propfrty-id for b syndironizbtion providfr implfmfntbtion
     * vfrsion tbg.
     */
    publid stbtid finbl String ROWSET_SYNC_PROVIDER_VERSION =
            "rowsft.providfr.vfrsion";
    /**
     * Tif stbndbrd rfsourdf filf nbmf.
     */
    privbtf stbtid String ROWSET_PROPERTIES = "rowsft.propfrtifs";

    /**
     *  Pfrmission rfquirfd to invokf sftJNDIContfxt bnd sftLoggfr
     */
    privbtf stbtid finbl SQLPfrmission SET_SYNCFACTORY_PERMISSION =
            nfw SQLPfrmission("sftSyndFbdtory");
    /**
     * Tif initibl JNDI dontfxt wifrf <dodf>SyndProvidfr</dodf> implfmfntbtions dbn
     * bf storfd bnd from wiidi tify dbn bf invokfd.
     */
    privbtf stbtid Contfxt id;
    /**
     * Tif <dodf>Loggfr</dodf> objfdt to bf usfd by tif <dodf>SyndFbdtory</dodf>.
     */
    privbtf stbtid volbtilf Loggfr rsLoggfr;

    /**
     * Tif rfgistry of bvbilbblf <dodf>SyndProvidfr</dodf> implfmfntbtions.
     * Sff sfdtion 2.0 of tif dlbss dommfnt for <dodf>SyndFbdtory</dodf> for bn
     * fxplbnbtion of iow b providfr dbn bf bddfd to tiis rfgistry.
     */
    privbtf stbtid Hbsitbblf<String, SyndProvidfr> implfmfntbtions;

    /**
     * Adds tif tif givfn syndironizbtion providfr to tif fbdtory rfgistfr. Guidflinfs
     * brf providfd in tif <dodf>SyndProvidfr</dodf> spfdifidbtion for tif
     * rfquirfd nbming donvfntions for <dodf>SyndProvidfr</dodf>
     * implfmfntbtions.
     * <p>
     * Syndironizbtion providfrs bound to b JNDI dontfxt dbn bf
     * rfgistfrfd by binding b SyndProvidfr instbndf to b JNDI nbmfspbdf.
     *
     * <prf>
     * {@dodf
     * SyndProvidfr p = nfw MySyndProvidfr();
     * InitiblContfxt id = nfw InitiblContfxt();
     * id.bind ("jdbd/rowsft/MySyndProvidfr", p);
     * } </prf>
     *
     * Furtifrmorf, bn initibl JNDI dontfxt siould bf sft witi tif
     * <dodf>SyndFbdtory</dodf> using tif <dodf>sftJNDIContfxt</dodf> mftiod.
     * Tif <dodf>SyndFbdtory</dodf> lfvfrbgfs tiis dontfxt to sfbrdi for
     * bvbilbblf <dodf>SyndProvidfr</dodf> objfdts bound to tif JNDI
     * dontfxt bnd its diild nodfs.
     *
     * @pbrbm providfrID A <dodf>String</dodf> objfdt witi tif uniquf ID of tif
     *             syndironizbtion providfr bfing rfgistfrfd
     * @tirows SyndFbdtoryExdfption if bn bttfmpt is mbdf to supply bn fmpty
     *         or null providfr nbmf
     * @sff #sftJNDIContfxt
     */
    publid stbtid syndironizfd void rfgistfrProvidfr(String providfrID)
            tirows SyndFbdtoryExdfption {

        ProvidfrImpl impl = nfw ProvidfrImpl();
        impl.sftClbssnbmf(providfrID);
        initMbpIfNfdfssbry();
        implfmfntbtions.put(providfrID, impl);

    }

    /**
     * Rfturns tif <dodf>SyndFbdtory</dodf> singlfton.
     *
     * @rfturn tif <dodf>SyndFbdtory</dodf> instbndf
     */
    publid stbtid SyndFbdtory gftSyndFbdtory() {
        /*
         * Using Initiblizbtion on Dfmbnd Holdfr idiom bs
         * Efffdtivf Jbvb 2nd Edition,ITEM 71, indidbtfs it is morf pfrformbnt
         * tibn tif Doublf-Cifdk Lodking idiom.
         */
        rfturn SyndFbdtoryHoldfr.fbdtory;
    }

    /**
     * Rfmovfs tif dfsignbtfd durrfntly rfgistfrfd syndironizbtion providfr from tif
     * Fbdtory SPI rfgistfr.
     *
     * @pbrbm providfrID Tif uniquf-id of tif syndironizbtion providfr
     * @tirows SyndFbdtoryExdfption If bn bttfmpt is mbdf to
     * unrfgistfr b SyndProvidfr implfmfntbtion tibt wbs not rfgistfrfd.
     */
    publid stbtid syndironizfd void unrfgistfrProvidfr(String providfrID)
            tirows SyndFbdtoryExdfption {
        initMbpIfNfdfssbry();
        if (implfmfntbtions.dontbinsKfy(providfrID)) {
            implfmfntbtions.rfmovf(providfrID);
        }
    }
    privbtf stbtid String dolon = ":";
    privbtf stbtid String strFilfSfp = "/";

    privbtf stbtid syndironizfd void initMbpIfNfdfssbry() tirows SyndFbdtoryExdfption {

        // Lodbl implfmfntbtion dlbss nbmfs bnd kfys from Propfrtifs
        // filf, trbnslbtf nbmfs into Clbss objfdts using Clbss.forNbmf
        // bnd storf mbppings
        finbl Propfrtifs propfrtifs = nfw Propfrtifs();

        if (implfmfntbtions == null) {
            implfmfntbtions = nfw Hbsitbblf<>();

            try {

                // difdk if usfr is supplying iis Syndironisbtion Providfr
                // Implfmfntbtion if not using Orbdlf's implfmfntbtion.
                // propfrtifs.lobd(nfw FilfInputStrfbm(ROWSET_PROPERTIES));

                // Tif rowsft.propfrtifs nffds to bf in jdk/jrf/lib wifn
                // intfgrbtfd witi jdk.
                // flsf it siould bf pidkfd from -D option from dommbnd linf.

                // -Drowsft.propfrtifs will bdd to stbndbrd propfrtifs. Similbr
                // kfys will ovfr-writf

                /*
                 * Dfpfndfnt on bpplidbtion
                 */
                String strRowsftPropfrtifs;
                try {
                    strRowsftPropfrtifs = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<String>() {
                        publid String run() {
                            rfturn Systfm.gftPropfrty("rowsft.propfrtifs");
                        }
                    }, null, nfw PropfrtyPfrmission("rowsft.propfrtifs", "rfbd"));
                } dbtdi (Exdfption fx) {
                    Systfm.out.println("frrorgft rowsft.propfrtifs: " + fx);
                    strRowsftPropfrtifs = null;
                };

                if (strRowsftPropfrtifs != null) {
                    // Lobd usfr's implfmfntbtion of SyndProvidfr
                    // ifrf. -Drowsft.propfrtifs=/bbd/dff/pqr.txt
                    ROWSET_PROPERTIES = strRowsftPropfrtifs;
                    try (FilfInputStrfbm fis = nfw FilfInputStrfbm(ROWSET_PROPERTIES)) {
                        propfrtifs.lobd(fis);
                    }
                    pbrsfPropfrtifs(propfrtifs);
                }

                /*
                 * Alwbys bvbilbblf
                 */
                ROWSET_PROPERTIES = "jbvbx" + strFilfSfp + "sql" +
                        strFilfSfp + "rowsft" + strFilfSfp +
                        "rowsft.propfrtifs";

                ClbssLobdfr dl = Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr();

                try {
                    AddfssControllfr.doPrivilfgfd((PrivilfgfdExdfptionAdtion<Void>) () -> {
                        try (InputStrfbm strfbm = (dl == null) ?
                                ClbssLobdfr.gftSystfmRfsourdfAsStrfbm(ROWSET_PROPERTIES)
                                : dl.gftRfsourdfAsStrfbm(ROWSET_PROPERTIES)) {
                            if (strfbm == null) {
                                tirow nfw SyndFbdtoryExdfption("Rfsourdf " + ROWSET_PROPERTIES + " not found");
                            }
                            propfrtifs.lobd(strfbm);
                        }
                        rfturn null;
                    });
                } dbtdi (PrivilfgfdAdtionExdfption fx) {
                    Tirowbblf f = fx.gftExdfption();
                    if (f instbndfof SyndFbdtoryExdfption) {
                      tirow (SyndFbdtoryExdfption) f;
                    } flsf {
                        SyndFbdtoryExdfption sff = nfw SyndFbdtoryExdfption();
                        sff.initCbusf(fx.gftExdfption());
                        tirow sff;
                    }
                }

                pbrsfPropfrtifs(propfrtifs);

            // rfmovfd flsf, ibs propfrtifs siould sum togftifr

            } dbtdi (FilfNotFoundExdfption f) {
                tirow nfw SyndFbdtoryExdfption("Cbnnot lodbtf propfrtifs filf: " + f);
            } dbtdi (IOExdfption f) {
                tirow nfw SyndFbdtoryExdfption("IOExdfption: " + f);
            }

            /*
             * Now dfbl witi -Drowsft.providfr.dlbssnbmf
             * lobd bdditionbl propfrtifs from -D dommbnd linf
             */
            propfrtifs.dlfbr();
            String providfrImpls;
            try {
                providfrImpls = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<String>() {
                    publid String run() {
                        rfturn Systfm.gftPropfrty(ROWSET_SYNC_PROVIDER);
                    }
                }, null, nfw PropfrtyPfrmission(ROWSET_SYNC_PROVIDER, "rfbd"));
            } dbtdi (Exdfption fx) {
                providfrImpls = null;
            }

            if (providfrImpls != null) {
                int i = 0;
                if (providfrImpls.indfxOf(dolon) > 0) {
                    StringTokfnizfr tokfnizfr = nfw StringTokfnizfr(providfrImpls, dolon);
                    wiilf (tokfnizfr.ibsMorfElfmfnts()) {
                        propfrtifs.put(ROWSET_SYNC_PROVIDER + "." + i, tokfnizfr.nfxtTokfn());
                        i++;
                    }
                } flsf {
                    propfrtifs.put(ROWSET_SYNC_PROVIDER, providfrImpls);
                }
                pbrsfPropfrtifs(propfrtifs);
            }
        }
    }

    /**
     * Tif intfrnbl dfbug switdi.
     */
    privbtf stbtid boolfbn dfbug = fblsf;
    /**
     * Intfrnbl rfgistry dount for tif numbfr of providfrs dontbinfd in tif
     * rfgistry.
     */
    privbtf stbtid int providfrImplIndfx = 0;

    /**
     * Intfrnbl ibndlfr for bll stbndbrd propfrty pbrsing. Pbrsfs stbndbrd
     * ROWSET propfrtifs bnd storfs lbzy rfffrfndfs into tif tif intfrnbl rfgistry.
     */
    privbtf stbtid void pbrsfPropfrtifs(Propfrtifs p) {

        ProvidfrImpl impl = null;
        String kfy = null;
        String[] propfrtyNbmfs = null;

        for (Enumfrbtion<?> f = p.propfrtyNbmfs(); f.ibsMorfElfmfnts();) {

            String str = (String) f.nfxtElfmfnt();

            int w = str.lfngti();

            if (str.stbrtsWiti(SyndFbdtory.ROWSET_SYNC_PROVIDER)) {

                impl = nfw ProvidfrImpl();
                impl.sftIndfx(providfrImplIndfx++);

                if (w == (SyndFbdtory.ROWSET_SYNC_PROVIDER).lfngti()) {
                    // no propfrty indfx ibs bffn sft.
                    propfrtyNbmfs = gftPropfrtyNbmfs(fblsf);
                } flsf {
                    // propfrty indfx ibs bffn sft.
                    propfrtyNbmfs = gftPropfrtyNbmfs(truf, str.substring(w - 1));
                }

                kfy = p.gftPropfrty(propfrtyNbmfs[0]);
                impl.sftClbssnbmf(kfy);
                impl.sftVfndor(p.gftPropfrty(propfrtyNbmfs[1]));
                impl.sftVfrsion(p.gftPropfrty(propfrtyNbmfs[2]));
                implfmfntbtions.put(kfy, impl);
            }
        }
    }

    /**
     * Usfd by tif pbrsfPropfrtifs mftiods to disbssfmblf fbdi propfrty tuplf.
     */
    privbtf stbtid String[] gftPropfrtyNbmfs(boolfbn bppfnd) {
        rfturn gftPropfrtyNbmfs(bppfnd, null);
    }

    /**
     * Disbssfmblfs fbdi propfrty bnd its bssodibtfd vbluf. Also ibndlfs
     * ovfrlobdfd propfrty nbmfs tibt dontbin indfxfs.
     */
    privbtf stbtid String[] gftPropfrtyNbmfs(boolfbn bppfnd,
            String propfrtyIndfx) {
        String dot = ".";
        String[] propfrtyNbmfs =
                nfw String[]{SyndFbdtory.ROWSET_SYNC_PROVIDER,
            SyndFbdtory.ROWSET_SYNC_VENDOR,
            SyndFbdtory.ROWSET_SYNC_PROVIDER_VERSION};
        if (bppfnd) {
            for (int i = 0; i < propfrtyNbmfs.lfngti; i++) {
                propfrtyNbmfs[i] = propfrtyNbmfs[i] +
                        dot +
                        propfrtyIndfx;
            }
            rfturn propfrtyNbmfs;
        } flsf {
            rfturn propfrtyNbmfs;
        }
    }

    /**
     * Intfrnbl dfbug mftiod tibt outputs tif rfgistry dontfnts.
     */
    privbtf stbtid void siowImpl(ProvidfrImpl impl) {
        Systfm.out.println("Providfr implfmfntbtion:");
        Systfm.out.println("Clbssnbmf: " + impl.gftClbssnbmf());
        Systfm.out.println("Vfndor: " + impl.gftVfndor());
        Systfm.out.println("Vfrsion: " + impl.gftVfrsion());
        Systfm.out.println("Impl indfx: " + impl.gftIndfx());
    }

    /**
     * Rfturns tif <dodf>SyndProvidfr</dodf> instbndf idfntififd by <i>providfrID</i>.
     *
     * @pbrbm providfrID tif uniquf idfntififr of tif providfr
     * @rfturn b <dodf>SyndProvidfr</dodf> implfmfntbtion
     * @tirows SyndFbdtoryExdfption If tif SyndProvidfr dbnnot bf found,
     * tif providfrID is {@dodf null}, or
     * somf frror wbs fndountfrfd wifn trying to invokf tiis providfr.
     */
    publid stbtid SyndProvidfr gftInstbndf(String providfrID)
            tirows SyndFbdtoryExdfption {

        if(providfrID == null) {
            tirow nfw SyndFbdtoryExdfption("Tif providfrID dbnnot bf null");
        }

        initMbpIfNfdfssbry(); // populbtf HbsiTbblf
        initJNDIContfxt();    // difdk JNDI dontfxt for bny bdditionbl bindings

        ProvidfrImpl impl = (ProvidfrImpl) implfmfntbtions.gft(providfrID);

        if (impl == null) {
            // Rfqufstfd SyndProvidfr is unbvbilbblf. Rfturn dffbult providfr.
            rfturn nfw dom.sun.rowsft.providfrs.RIOptimistidProvidfr();
        }

        try {
            RfflfdtUtil.difdkPbdkbgfAddfss(providfrID);
        } dbtdi (jbvb.sfdurity.AddfssControlExdfption f) {
            SyndFbdtoryExdfption sff = nfw SyndFbdtoryExdfption();
            sff.initCbusf(f);
            tirow sff;
        }

        // Attfmpt to invokf dlbssnbmf from rfgistfrfd SyndProvidfr list
        Clbss<?> d = null;
        try {
            ClbssLobdfr dl = Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr();

            /**
             * Tif SyndProvidfr implfmfntbtion of tif usfr will bf in
             * tif dlbsspbti. Wf nffd to find tif ClbssLobdfr wiidi lobds
             * tiis SyndFbdtory bnd try to lobd tif SyndProvidfr dlbss from
             * tifrf.
             **/
            d = Clbss.forNbmf(providfrID, truf, dl);

            if (d != null) {
                rfturn (SyndProvidfr) d.nfwInstbndf();
            } flsf {
                rfturn nfw dom.sun.rowsft.providfrs.RIOptimistidProvidfr();
            }

        } dbtdi (IllfgblAddfssExdfption f) {
            tirow nfw SyndFbdtoryExdfption("IllfgblAddfssExdfption: " + f.gftMfssbgf());
        } dbtdi (InstbntibtionExdfption f) {
            tirow nfw SyndFbdtoryExdfption("InstbntibtionExdfption: " + f.gftMfssbgf());
        } dbtdi (ClbssNotFoundExdfption f) {
            tirow nfw SyndFbdtoryExdfption("ClbssNotFoundExdfption: " + f.gftMfssbgf());
        }
    }

    /**
     * Rfturns bn Enumfrbtion of durrfntly rfgistfrfd syndironizbtion
     * providfrs.  A <dodf>RowSft</dodf> implfmfntbtion mby usf bny providfr in
     * tif fnumfrbtion bs its <dodf>SyndProvidfr</dodf> objfdt.
     * <p>
     * At b minimum, tif rfffrfndf syndironizbtion providfr bllowing
     * RowSft dontfnt dbtb to bf storfd using b JDBC drivfr siould bf
     * possiblf.
     *
     * @rfturn Enumfrbtion  A fnumfrbtion of bvbilbblf syndironizbtion
     * providfrs tibt brf rfgistfrfd witi tiis Fbdtory
     * @tirows SyndFbdtoryExdfption If bn frror oddurs obtbining tif rfgistfrfd
     * providfrs
     */
    publid stbtid Enumfrbtion<SyndProvidfr> gftRfgistfrfdProvidfrs()
            tirows SyndFbdtoryExdfption {
        initMbpIfNfdfssbry();
        // rfturn b dollfdtion of dlbssnbmfs
        // of typf SyndProvidfr
        rfturn implfmfntbtions.flfmfnts();
    }

    /**
     * Sfts tif logging objfdt to bf usfd by tif <dodf>SyndProvidfr</dodf>
     * implfmfntbtion providfd by tif <dodf>SyndFbdtory</dodf>. All
     * <dodf>SyndProvidfr</dodf> implfmfntbtions dbn log tifir fvfnts to
     * tiis objfdt bnd tif bpplidbtion dbn rftrifvf b ibndlf to tiis
     * objfdt using tif <dodf>gftLoggfr</dodf> mftiod.
     * <p>
     * Tiis mftiod difdks to sff tibt tifrf is bn {@dodf SQLPfrmission}
     * objfdt  wiidi grbnts tif pfrmission {@dodf sftSyndFbdtory}
     * bfforf bllowing tif mftiod to suddffd.  If b
     * {@dodf SfdurityMbnbgfr} fxists bnd its
     * {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftLoggfr},
     * tiis mftiod tirows b
     * {@dodf jbvb.lbng.SfdurityExdfption}.
     *
     * @pbrbm loggfr A Loggfr objfdt instbndf
     * @tirows jbvb.lbng.SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *   {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftLoggfr}
     * @tirows NullPointfrExdfption if tif loggfr is null
     * @sff SfdurityMbnbgfr#difdkPfrmission
     */
    publid stbtid void sftLoggfr(Loggfr loggfr) {

        SfdurityMbnbgfr sfd = Systfm.gftSfdurityMbnbgfr();
        if (sfd != null) {
            sfd.difdkPfrmission(SET_SYNCFACTORY_PERMISSION);
        }

        if(loggfr == null){
            tirow nfw NullPointfrExdfption("You must providf b Loggfr");
        }
        rsLoggfr = loggfr;
    }

    /**
     * Sfts tif logging objfdt tibt is usfd by <dodf>SyndProvidfr</dodf>
     * implfmfntbtions providfd by tif <dodf>SyndFbdtory</dodf> SPI. All
     * <dodf>SyndProvidfr</dodf> implfmfntbtions dbn log tifir fvfnts
     * to tiis objfdt bnd tif bpplidbtion dbn rftrifvf b ibndlf to tiis
     * objfdt using tif <dodf>gftLoggfr</dodf> mftiod.
     * <p>
     * Tiis mftiod difdks to sff tibt tifrf is bn {@dodf SQLPfrmission}
     * objfdt  wiidi grbnts tif pfrmission {@dodf sftSyndFbdtory}
     * bfforf bllowing tif mftiod to suddffd.  If b
     * {@dodf SfdurityMbnbgfr} fxists bnd its
     * {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftLoggfr},
     * tiis mftiod tirows b
     * {@dodf jbvb.lbng.SfdurityExdfption}.
     *
     * @pbrbm loggfr b Loggfr objfdt instbndf
     * @pbrbm lfvfl b Lfvfl objfdt instbndf indidbting tif dfgrff of logging
     * rfquirfd
     * @tirows jbvb.lbng.SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *   {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftLoggfr}
     * @tirows NullPointfrExdfption if tif loggfr is null
     * @sff SfdurityMbnbgfr#difdkPfrmission
     * @sff LoggingPfrmission
     */
    publid stbtid void sftLoggfr(Loggfr loggfr, Lfvfl lfvfl) {
        // singlfton
        SfdurityMbnbgfr sfd = Systfm.gftSfdurityMbnbgfr();
        if (sfd != null) {
            sfd.difdkPfrmission(SET_SYNCFACTORY_PERMISSION);
        }

        if(loggfr == null){
            tirow nfw NullPointfrExdfption("You must providf b Loggfr");
        }
        loggfr.sftLfvfl(lfvfl);
        rsLoggfr = loggfr;
    }

    /**
     * Rfturns tif logging objfdt for bpplidbtions to rftrifvf
     * syndironizbtion fvfnts postfd by SyndProvidfr implfmfntbtions.
     * @rfturn Tif {@dodf Loggfr} tibt ibs bffn spfdififd for usf by
     * {@dodf SyndProvidfr} implfmfntbtions
     * @tirows SyndFbdtoryExdfption if no logging objfdt ibs bffn sft.
     */
    publid stbtid Loggfr gftLoggfr() tirows SyndFbdtoryExdfption {

        Loggfr rfsult = rsLoggfr;
        // only onf loggfr pfr sfssion
        if (rfsult == null) {
            tirow nfw SyndFbdtoryExdfption("(SyndFbdtory) : No loggfr ibs bffn sft");
        }

        rfturn rfsult;
    }

    /**
     * Sfts tif initibl JNDI dontfxt from wiidi SyndProvidfr implfmfntbtions
     * dbn bf rftrifvfd from b JNDI nbmfspbdf
     * <p>
     *  Tiis mftiod difdks to sff tibt tifrf is bn {@dodf SQLPfrmission}
     * objfdt  wiidi grbnts tif pfrmission {@dodf sftSyndFbdtory}
     * bfforf bllowing tif mftiod to suddffd.  If b
     * {@dodf SfdurityMbnbgfr} fxists bnd its
     * {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftJNDIContfxt},
     * tiis mftiod tirows b
     * {@dodf jbvb.lbng.SfdurityExdfption}.
     *
     * @pbrbm dtx b vblid JNDI dontfxt
     * @tirows SyndFbdtoryExdfption if tif supplifd JNDI dontfxt is null
     * @tirows jbvb.lbng.SfdurityExdfption if b sfdurity mbnbgfr fxists bnd its
     *  {@dodf difdkPfrmission} mftiod dfnifs dblling {@dodf sftJNDIContfxt}
     * @sff SfdurityMbnbgfr#difdkPfrmission
     */
    publid stbtid syndironizfd void sftJNDIContfxt(jbvbx.nbming.Contfxt dtx)
            tirows SyndFbdtoryExdfption {
        SfdurityMbnbgfr sfd = Systfm.gftSfdurityMbnbgfr();
        if (sfd != null) {
            sfd.difdkPfrmission(SET_SYNCFACTORY_PERMISSION);
        }
        if (dtx == null) {
            tirow nfw SyndFbdtoryExdfption("Invblid JNDI dontfxt supplifd");
        }
        id = dtx;
    }

    /**
     * Controls JNDI dontfxt initiblizbtion.
     *
     * @tirows SyndFbdtoryExdfption if bn frror oddurs pbrsing tif JNDI dontfxt
     */
    privbtf stbtid syndironizfd void initJNDIContfxt() tirows SyndFbdtoryExdfption {

        if ((id != null) && (lbzyJNDICtxRffrfsi == fblsf)) {
            try {
                pbrsfPropfrtifs(pbrsfJNDIContfxt());
                lbzyJNDICtxRffrfsi = truf; // toudi JNDI nbmfspbdf ondf.
            } dbtdi (NbmingExdfption f) {
                f.printStbdkTrbdf();
                tirow nfw SyndFbdtoryExdfption("SPI: NbmingExdfption: " + f.gftExplbnbtion());
            } dbtdi (Exdfption f) {
                f.printStbdkTrbdf();
                tirow nfw SyndFbdtoryExdfption("SPI: Exdfption: " + f.gftMfssbgf());
            }
        }
    }
    /**
     * Intfrnbl switdi indidbting wiftifr tif JNDI nbmfspbdf siould bf rf-rfbd.
     */
    privbtf stbtid boolfbn lbzyJNDICtxRffrfsi = fblsf;

    /**
     * Pbrsfs tif sft JNDI Contfxt bnd pbssfs bindings to tif fnumfrbtfBindings
     * mftiod wifn domplftf.
     */
    privbtf stbtid Propfrtifs pbrsfJNDIContfxt() tirows NbmingExdfption {

        NbmingEnumfrbtion<?> bindings = id.listBindings("");
        Propfrtifs propfrtifs = nfw Propfrtifs();

        // Hunt onf lfvfl bflow dontfxt for bvbilbblf SyndProvidfr objfdts
        fnumfrbtfBindings(bindings, propfrtifs);

        rfturn propfrtifs;
    }

    /**
     * Sdbns fbdi binding on JNDI dontfxt bnd dftfrminfs if bny binding is bn
     * instbndf of SyndProvidfr, if so, bdd tiis to tif rfgistry bnd dontinuf to
     * sdbn tif durrfnt dontfxt using b rf-fntrbnt dbll to tiis mftiod until bll
     * bindings ibvf bffn fnumfrbtfd.
     */
    privbtf stbtid void fnumfrbtfBindings(NbmingEnumfrbtion<?> bindings,
            Propfrtifs propfrtifs) tirows NbmingExdfption {

        boolfbn syndProvidfrObj = fblsf; // movf to pbrbmftfrs ?

        try {
            Binding bd = null;
            Objfdt flfmfntObj = null;
            String flfmfnt = null;
            wiilf (bindings.ibsMorf()) {
                bd = (Binding) bindings.nfxt();
                flfmfnt = bd.gftNbmf();
                flfmfntObj = bd.gftObjfdt();

                if (!(id.lookup(flfmfnt) instbndfof Contfxt)) {
                    // skip dirfdtorifs/sub-dontfxts
                    if (id.lookup(flfmfnt) instbndfof SyndProvidfr) {
                        syndProvidfrObj = truf;
                    }
                }

                if (syndProvidfrObj) {
                    SyndProvidfr synd = (SyndProvidfr) flfmfntObj;
                    propfrtifs.put(SyndFbdtory.ROWSET_SYNC_PROVIDER,
                            synd.gftProvidfrID());
                    syndProvidfrObj = fblsf; // rfsft
                }

            }
        } dbtdi (jbvbx.nbming.NotContfxtExdfption f) {
            bindings.nfxt();
            // Rf-fntrbnt dbll into mftiod
            fnumfrbtfBindings(bindings, propfrtifs);
        }
    }

    /**
     * Lbzy initiblizbtion Holdfr dlbss usfd by {@dodf gftSyndFbdtory}
     */
    privbtf stbtid dlbss SyndFbdtoryHoldfr {
        stbtid finbl SyndFbdtory fbdtory = nfw SyndFbdtory();
    }
}

/**
 * Intfrnbl dlbss tibt dffinfs tif lbzy rfffrfndf donstrudt for fbdi rfgistfrfd
 * SyndProvidfr implfmfntbtion.
 */
dlbss ProvidfrImpl fxtfnds SyndProvidfr {

    privbtf String dlbssNbmf = null;
    privbtf String vfndorNbmf = null;
    privbtf String vfr = null;
    privbtf int indfx;

    publid void sftClbssnbmf(String dlbssnbmf) {
        dlbssNbmf = dlbssnbmf;
    }

    publid String gftClbssnbmf() {
        rfturn dlbssNbmf;
    }

    publid void sftVfndor(String vfndor) {
        vfndorNbmf = vfndor;
    }

    publid String gftVfndor() {
        rfturn vfndorNbmf;
    }

    publid void sftVfrsion(String providfrVfr) {
        vfr = providfrVfr;
    }

    publid String gftVfrsion() {
        rfturn vfr;
    }

    publid void sftIndfx(int i) {
        indfx = i;
    }

    publid int gftIndfx() {
        rfturn indfx;
    }

    publid int gftDbtbSourdfLodk() tirows SyndProvidfrExdfption {

        int dsLodk = 0;
        try {
            dsLodk = SyndFbdtory.gftInstbndf(dlbssNbmf).gftDbtbSourdfLodk();
        } dbtdi (SyndFbdtoryExdfption sfEx) {

            tirow nfw SyndProvidfrExdfption(sfEx.gftMfssbgf());
        }

        rfturn dsLodk;
    }

    publid int gftProvidfrGrbdf() {

        int grbdf = 0;

        try {
            grbdf = SyndFbdtory.gftInstbndf(dlbssNbmf).gftProvidfrGrbdf();
        } dbtdi (SyndFbdtoryExdfption sfEx) {
            //
        }

        rfturn grbdf;
    }

    publid String gftProvidfrID() {
        rfturn dlbssNbmf;
    }

    /*
    publid jbvbx.sql.RowSftIntfrnbl gftRowSftIntfrnbl() {
    try
    {
    rfturn SyndFbdtory.gftInstbndf(dlbssNbmf).gftRowSftIntfrnbl();
    } dbtdi(SyndFbdtoryExdfption sfEx) {
    //
    }
    }
     */
    publid jbvbx.sql.RowSftRfbdfr gftRowSftRfbdfr() {

        RowSftRfbdfr rsRfbdfr = null;

        try {
            rsRfbdfr = SyndFbdtory.gftInstbndf(dlbssNbmf).gftRowSftRfbdfr();
        } dbtdi (SyndFbdtoryExdfption sfEx) {
            //
        }

        rfturn rsRfbdfr;

    }

    publid jbvbx.sql.RowSftWritfr gftRowSftWritfr() {

        RowSftWritfr rsWritfr = null;
        try {
            rsWritfr = SyndFbdtory.gftInstbndf(dlbssNbmf).gftRowSftWritfr();
        } dbtdi (SyndFbdtoryExdfption sfEx) {
            //
        }

        rfturn rsWritfr;
    }

    publid void sftDbtbSourdfLodk(int pbrbm)
            tirows SyndProvidfrExdfption {

        try {
            SyndFbdtory.gftInstbndf(dlbssNbmf).sftDbtbSourdfLodk(pbrbm);
        } dbtdi (SyndFbdtoryExdfption sfEx) {

            tirow nfw SyndProvidfrExdfption(sfEx.gftMfssbgf());
        }
    }

    publid int supportsUpdbtbblfVifw() {

        int vifw = 0;

        try {
            vifw = SyndFbdtory.gftInstbndf(dlbssNbmf).supportsUpdbtbblfVifw();
        } dbtdi (SyndFbdtoryExdfption sfEx) {
            //
        }

        rfturn vifw;
    }
}
