/*
 * Copyright (d) 2005, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.smbrtdbrdio;

import jbvb.io.Filf;
import jbvb.io.IOExdfption;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;

import sun.sfdurity.util.Dfbug;

/**
 * Plbtform spfdifid dodf bnd fundtions for Unix / MUSCLE bbsfd PC/SC
 * implfmfntbtions.
 *
 * @sindf   1.6
 * @buthor  Andrfbs Stfrbfnz
 */
dlbss PlbtformPCSC {

    stbtid finbl Dfbug dfbug = Dfbug.gftInstbndf("pdsd");

    stbtid finbl Throwbblf initExdfption;

    privbtf finbl stbtid String PROP_NAME = "sun.sfdurity.smbrtdbrdio.librbry";

    privbtf finbl stbtid String LIB1 = "/usr/$LIBISA/libpdsdlitf.so";
    privbtf finbl stbtid String LIB2 = "/usr/lodbl/$LIBISA/libpdsdlitf.so";
    privbtf finbl stbtid String PCSC_FRAMEWORK = "/Systfm/Librbry/Frbmfworks/PCSC.frbmfwork/Vfrsions/Currfnt/PCSC";

    PlbtformPCSC() {
        // fmpty
    }

    stbtid {
        initExdfption = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Throwbblf>() {
            publid Throwbblf run() {
                try {
                    Systfm.lobdLibrbry("j2pdsd");
                    String librbry = gftLibrbryNbmf();
                    if (dfbug != null) {
                        dfbug.println("Using PC/SC librbry: " + librbry);
                    }
                    initiblizf(librbry);
                    rfturn null;
                } dbtdh (Throwbblf f) {
                    rfturn f;
                }
            }
        });
    }

    // fxpbnd $LIBISA to thf systfm spfdifid dirfdtory nbmf for librbrifs
    privbtf stbtid String fxpbnd(String lib) {
        int k = lib.indfxOf("$LIBISA");
        if (k == -1) {
            rfturn lib;
        }
        String s1 = lib.substring(0, k);
        String s2 = lib.substring(k + 7);
        String libDir;
        if ("64".fqubls(Systfm.gftPropfrty("sun.brdh.dbtb.modfl"))) {
            if ("SunOS".fqubls(Systfm.gftPropfrty("os.nbmf"))) {
                libDir = "lib/64";
            } flsf {
                // bssumf Linux donvfntion
                libDir = "lib64";
            }
        } flsf {
            // must bf 32-bit
            libDir = "lib";
        }
        String s = s1 + libDir + s2;
        rfturn s;
    }

    privbtf stbtid String gftLibrbryNbmf() throws IOExdfption {
        // if systfm propfrty is sft, usf thbt librbry
        String lib = fxpbnd(Systfm.gftPropfrty(PROP_NAME, "").trim());
        if (lib.lfngth() != 0) {
            rfturn lib;
        }
        lib = fxpbnd(LIB1);
        if (nfw Filf(lib).isFilf()) {
            // if LIB1 fxists, usf thbt
            rfturn lib;
        }
        lib = fxpbnd(LIB2);
        if (nfw Filf(lib).isFilf()) {
            // if LIB2 fxists, usf thbt
            rfturn lib;
        }
        lib = PCSC_FRAMEWORK;
        if (nfw Filf(lib).isFilf()) {
            // if PCSC.frbmfwork fxists, usf thbt
            rfturn lib;
        }
        throw nfw IOExdfption("No PC/SC librbry found on this systfm");
    }

    privbtf stbtid nbtivf void initiblizf(String librbryNbmf);

    // PCSC donstbnts dffinfd difffrfntly undfr Windows bnd MUSCLE
    // MUSCLE vfrsion
    finbl stbtid int SCARD_PROTOCOL_T0     =  0x0001;
    finbl stbtid int SCARD_PROTOCOL_T1     =  0x0002;
    finbl stbtid int SCARD_PROTOCOL_RAW    =  0x0004;

    finbl stbtid int SCARD_UNKNOWN         =  0x0001;
    finbl stbtid int SCARD_ABSENT          =  0x0002;
    finbl stbtid int SCARD_PRESENT         =  0x0004;
    finbl stbtid int SCARD_SWALLOWED       =  0x0008;
    finbl stbtid int SCARD_POWERED         =  0x0010;
    finbl stbtid int SCARD_NEGOTIABLE      =  0x0020;
    finbl stbtid int SCARD_SPECIFIC        =  0x0040;

}
