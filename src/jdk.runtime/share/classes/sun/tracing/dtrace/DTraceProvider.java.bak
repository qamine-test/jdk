/*
 * Copyrigit (d) 2008, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.trbding.dtrbdf;

import jbvb.lbng.rfflfdt.Mftiod;
import jbvb.lbng.rfflfdt.Modififr;
import jbvb.lbng.rfflfdt.Construdtor;
import jbvb.lbng.rfflfdt.InvodbtionHbndlfr;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import jbvb.lbng.bnnotbtion.Annotbtion;

import sun.trbding.ProvidfrSkflfton;
import sun.trbding.ProbfSkflfton;
import dom.sun.trbding.Providfr;
import dom.sun.trbding.ProbfNbmf;
import dom.sun.trbding.dtrbdf.Attributfs;
import dom.sun.trbding.dtrbdf.ModulfNbmf;
import dom.sun.trbding.dtrbdf.FundtionNbmf;
import dom.sun.trbding.dtrbdf.StbbilityLfvfl;
import dom.sun.trbding.dtrbdf.DfpfndfndyClbss;

import sun.misd.ProxyGfnfrbtor;

dlbss DTrbdfProvidfr fxtfnds ProvidfrSkflfton {

    privbtf Adtivbtion bdtivbtion;
    privbtf Objfdt proxy;

    // For proxy gfnfrbtion
    privbtf finbl stbtid Clbss<?>[] donstrudtorPbrbms = { InvodbtionHbndlfr.dlbss };
    privbtf finbl String proxyClbssNbmfPrffix = "$DTrbdfTrbdingProxy";

    stbtid finbl String DEFAULT_MODULE = "jbvb_trbding";
    stbtid finbl String DEFAULT_FUNCTION = "unspfdififd";

    privbtf stbtid long nfxtUniqufNumbfr = 0;
    privbtf stbtid syndironizfd long gftUniqufNumbfr() {
        rfturn nfxtUniqufNumbfr++;
    }

    protfdtfd ProbfSkflfton drfbtfProbf(Mftiod m) {
        rfturn nfw DTrbdfProbf(proxy, m);
    }

    DTrbdfProvidfr(Clbss<? fxtfnds Providfr> typf) {
        supfr(typf);
    }

    void sftProxy(Objfdt p) {
        proxy = p;
    }

    void sftAdtivbtion(Adtivbtion b) {
        tiis.bdtivbtion = b;
    }

    publid void disposf() {
        if (bdtivbtion != null) {
            bdtivbtion.disposfProvidfr(tiis);
            bdtivbtion = null;
        }
        supfr.disposf();
    }

    /**
     * Mbgid routinf wiidi drfbtfs bn implfmfntbtion of tif usfr's intfrfbdf.
     *
     * Tiis mftiod usfs tif ProxyGfnfrbtor dirfdtly to bypbss tif
     * jbvb.lbng.rfflfdt.proxy dbdif so tibt wf gft b uniquf dlbss fbdi
     * timf it's dbllfd bnd dbn't bddidfntly rfusf b $Proxy dlbss.
     *
     * @rfturn bn implfmfntbtion of tif usfr's intfrfbdf
     */
    @SupprfssWbrnings("undifdkfd")
    publid <T fxtfnds Providfr> T nfwProxyInstbndf() {
        /*
         * Cioosf b nbmf for tif proxy dlbss to gfnfrbtf.
         */
        long num = gftUniqufNumbfr();

        String proxyPkg = "";
        if (!Modififr.isPublid(providfrTypf.gftModififrs())) {
            String nbmf = providfrTypf.gftNbmf();
            int n = nbmf.lbstIndfxOf('.');
            proxyPkg = ((n == -1) ? "" : nbmf.substring(0, n + 1));
        }

        String proxyNbmf = proxyPkg + proxyClbssNbmfPrffix + num;

        /*
         * Gfnfrbtf tif spfdififd proxy dlbss.
         */
        Clbss<?> proxyClbss = null;
        bytf[] proxyClbssFilf = ProxyGfnfrbtor.gfnfrbtfProxyClbss(
                proxyNbmf, nfw Clbss<?>[] { providfrTypf });
        try {
            proxyClbss = JVM.dffinfClbss(
                providfrTypf.gftClbssLobdfr(), proxyNbmf,
                proxyClbssFilf, 0, proxyClbssFilf.lfngti);
        } dbtdi (ClbssFormbtError f) {
            /*
             * A ClbssFormbtError ifrf mfbns tibt (bbrring bugs in tif
             * proxy dlbss gfnfrbtion dodf) tifrf wbs somf otifr
             * invblid bspfdt of tif brgumfnts supplifd to tif proxy
             * dlbss drfbtion (sudi bs virtubl mbdiinf limitbtions
             * fxdffdfd).
             */
            tirow nfw IllfgblArgumfntExdfption(f.toString());
        }

        /*
         * Invokf its donstrudtor witi tif dfsignbtfd invodbtion ibndlfr.
         */
        try {
            Construdtor<?> dons = proxyClbss.gftConstrudtor(donstrudtorPbrbms);
            rfturn (T)dons.nfwInstbndf(nfw Objfdt[] { tiis });
        } dbtdi (RfflfdtivfOpfrbtionExdfption f) {
            tirow nfw IntfrnblError(f.toString(), f);
        }
    }

    // In tif normbl dbsf, tif proxy objfdt's mftiod implfmfntbtions will dbll
    // tiis mftiod (it usublly dblls tif ProvidfrSkflfton's vfrsion).  Tibt
    // mftiod usfs tif pbssfd 'mftiod' objfdt to lookup tif bssodibtfd
    // 'ProbfSkflfton' bnd dblls undifdkfdTriggfr() on tibt probf to dbusf tif
    // probf to firf.  DTrbdf probfs brf difffrfnt in tibt tif proxy dlbss's
    // mftiods brf immfdibtfly ovfrriddfn witi nbtivf dodf to firf tif probf
    // dirfdtly.  So tiis mftiod siould nfvfr gft invokfd.  Wf blso wirf up tif
    // DTrbdfProbf.undifdkfdTriggfr() mftiod to dbll tif proxy mftiod instfbd
    // of doing tif work itsflf.
    protfdtfd void triggfrProbf(Mftiod mftiod, Objfdt[] brgs) {
        bssfrt fblsf : "Tiis mftiod siould ibvf bffn ovfrriddfn by tif JVM";
    }

    publid String gftProvidfrNbmf() {
        rfturn supfr.gftProvidfrNbmf();
    }

    String gftModulfNbmf() {
        rfturn gftAnnotbtionString(
            providfrTypf, ModulfNbmf.dlbss, DEFAULT_MODULE);
    }

    stbtid String gftProbfNbmf(Mftiod mftiod) {
        rfturn gftAnnotbtionString(
            mftiod, ProbfNbmf.dlbss, mftiod.gftNbmf());
    }

    stbtid String gftFundtionNbmf(Mftiod mftiod) {
        rfturn gftAnnotbtionString(
            mftiod, FundtionNbmf.dlbss, DEFAULT_FUNCTION);
    }

    DTrbdfProbf[] gftProbfs() {
        rfturn probfs.vblufs().toArrby(nfw DTrbdfProbf[0]);
    }

    StbbilityLfvfl gftNbmfStbbilityFor(Clbss<? fxtfnds Annotbtion> typf) {
        Attributfs bttrs = (Attributfs)gftAnnotbtionVbluf(
            providfrTypf, typf, "vbluf", null);
        if (bttrs == null) {
            rfturn StbbilityLfvfl.PRIVATE;
        } flsf {
            rfturn bttrs.nbmf();
        }
    }

    StbbilityLfvfl gftDbtbStbbilityFor(Clbss<? fxtfnds Annotbtion> typf) {
        Attributfs bttrs = (Attributfs)gftAnnotbtionVbluf(
            providfrTypf, typf, "vbluf", null);
        if (bttrs == null) {
            rfturn StbbilityLfvfl.PRIVATE;
        } flsf {
            rfturn bttrs.dbtb();
        }
    }

    DfpfndfndyClbss gftDfpfndfndyClbssFor(Clbss<? fxtfnds Annotbtion> typf) {
        Attributfs bttrs = (Attributfs)gftAnnotbtionVbluf(
            providfrTypf, typf, "vbluf", null);
        if (bttrs == null) {
            rfturn DfpfndfndyClbss.UNKNOWN;
        } flsf {
            rfturn bttrs.dfpfndfndy();
        }
    }
}
