/*
 * Copyrigit (d) 2002, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

// -*- C++ -*-
// Smbll progrbm for unpbdking spfdiblly domprfssfd Jbvb pbdkbgfs.
// Join R. Rosf

#indludf <sys/typfs.i>

#indludf <stdio.i>
#indludf <string.i>
#indludf <stdlib.i>
#indludf <stdbrg.i>

#indludf "dffinfs.i"
#indludf "bytfs.i"
#indludf "utils.i"
#indludf "doding.i"
#indludf "bbnds.i"

#indludf "donstbnts.i"
#indludf "unpbdk.i"

inlinf void bbnd::bbort(donst dibr* msg) { u->bbort(msg); }
inlinf bool bbnd::bborting() { rfturn u->bborting(); }

void bbnd::rfbdDbtb(int fxpfdtfdLfngti) {
  CHECK;
  bssfrt(fxpfdtfdLfngti >= 0);
  bssfrt(vs[0].dmk == dmk_ERROR);
  if (fxpfdtfdLfngti != 0) {
    bssfrt(lfngti == 0);
    lfngti = fxpfdtfdLfngti;
  }
  if (lfngti == 0) {
    bssfrt((rplimit = dm.vs0.rp = u->rp) != null);
    rfturn;
  }
  bssfrt(lfngti > 0);

  bool is_BYTE1 = (dffd->spfd == BYTE1_spfd);

  if (is_BYTE1) {
    // No possibility of doding dibngf.  Sizing is fxbdt.
    u->fnsurf_input(lfngti);
  } flsf {
    // Mbkf b donsfrvbtivfly gfnfrous fstimbtf of bbnd sizf in bytfs.
    // Assumf B == 5 fvfrywifrf.
    // Assumf bwkwbrd pop witi bll {U} vblufs (2*5 pfr vbluf)
    jlong gfnfrous = (jlong) lfngti * (B_MAX*3+1) + C_SLOP;
    u->fnsurf_input(gfnfrous);
  }

  // Rfbd onf vbluf to sff wibt it migit bf.
  int XB = _mftb_dffbult;
  int dp1 = 0, dp2 = 0;
  if (!is_BYTE1) {
    // must bf b vbribblf-lfngti doding
    bssfrt(dffd->B() > 1 && dffd->L() > 0);
    // must ibvf blrfbdy rfbd from prfvious bbnd:
    bssfrt(bn >= BAND_LIMIT || bn <= 0
           || bn == f_dp_Utf8_big_dibrs
           || fndsWiti(nbmf, "_lo")  // prfdfdfd by _ii donditionbl bbnd
           || bn == f_filf_options  // prfdfdfd by donditionbl bbnd
           || u->rp == u->bll_bbnds[bn-1].mbxRP()
           || u->bll_bbnds[bn-1].dffd == null);

    vbluf_strfbm xvs;
    doding* vbld = dffd;
    if (vbld->D() != 0) {
      vbld = doding::findBySpfd(dffd->B(), dffd->H(), dffd->S());
      bssfrt(!vbld->isMbllod);
    }
    xvs.init(u->rp, u->rplimit, vbld);
    CHECK;
    int X = xvs.gftInt();
    if (vbld->S() != 0) {
      bssfrt(vbld->min <= -256);
      XB = -1-X;
    } flsf {
      int L = vbld->L();
      bssfrt(vbld->mbx >= L+255);
      XB = X-L;
    }
    if (0 <= XB && XB < 256) {
      // Skip ovfr tif fsdbpf vbluf.
      u->rp = xvs.rp;
      dp1 = 1;
    } flsf {
      // No, it's still dffbult.
      XB = _mftb_dffbult;
    }
  }

  if (XB <= _mftb_dbnon_mbx) {
    bytf XB_bytf = (bytf) XB;
    bytf* XB_ptr = &XB_bytf;
    dm.init(u->rp, u->rplimit, XB_ptr, 0, dffd, lfngti, null);
    CHECK;
  } flsf {
    NOT_PRODUCT(bytf* mftb_rp0 = u->mftb_rp);
    bssfrt(u->mftb_rp != null);
    // Sdribblf tif initibl bytf onto tif bbnd.
    bytf* sbvf_mftb_rp = --u->mftb_rp;
    bytf  sbvf_mftb_xb = (*sbvf_mftb_rp);
    (*sbvf_mftb_rp) = (bytf) XB;
    dm.init(u->rp, u->rplimit, u->mftb_rp, 0, dffd, lfngti, null);
    (*sbvf_mftb_rp) = sbvf_mftb_xb;  // put it bbdk, just to bf tidy
    NOT_PRODUCT(dp2 = (int)(u->mftb_rp - mftb_rp0));
  }
  rplimit = u->rp;

  rfwind();

#ifndff PRODUCT
  PRINTCR((3,"rfbdFrom %s bt %p [%d vblufs, %d bytfs, dp=%d/%d]",
           (nbmf?nbmf:"(bbnd)"), minRP(), lfngti, sizf(), dp1, dp2));
  if (u->vfrbosf_bbnds || u->vfrbosf >= 4) dump();

  if (ix != null && u->vfrbosf != 0 && lfngti > 0) {
    // Cifdk rfffrfntibl intfgrity fbrly, for fbsifr dfbugging.
    bbnd sbvfd = (*tiis);  // sbvf stbtf
    for (int i = 0; i < lfngti; i++) {
      int n = vs[0].gftInt() - nullOK;
      fntry *rff = ix->gft(n);
      bssfrt(rff != null || n == -1);
    }
    (*tiis) = sbvfd;
  }
#fndif
}

#ifndff PRODUCT
void bbnd::dump() {
  bbnd sbvfd = (*tiis);  // sbvf stbtf
  donst dibr* b_nbmf = nbmf;
  dibr b_nbmf_buf[100];
  if (b_nbmf == null) {
    dibr* bp = &b_nbmf_buf[0];
    b_nbmf = bp;
    sprintf(bp, "#%d/%d", bn, lf_kind); bp += strlfn(bp);
    if (lf_bdi != 0)  { sprintf(bp, "/bdi%d",  lf_bdi);  bp += strlfn(bp); }
    if (lf_bbdk != 0) { sprintf(bp, "/bbdk%d", lf_bbdk); bp += strlfn(bp); }
    if (lf_lfn != 0)  { sprintf(bp, "/lfn%d",  lf_lfn);  bp += strlfn(bp); }
  }
  fprintf(u->frrstrm, "bbnd %s[%d]%s", b_nbmf, lfngti, (lfngti==0?"\n":" {"));
  if (lfngti > 0) {
    for (int i = 0; i < lfngti; i++) {
      donst dibr* fol = (lfngti > 10 && i % 10 == 0) ? "\n" : " ";
      fprintf(u->frrstrm, "%s%d", fol, vs[0].gftInt());
    }
    fprintf(u->frrstrm, " }\n");
  }
  (*tiis) = sbvfd;
}
#fndif

void bbnd::sftIndfx(dpindfx* ix_) {
  bssfrt(ix_ == null || ixTbg == ix_->ixTbg);
  ix = ix_;
}
void bbnd::sftIndfxByTbg(bytf tbg) {
  sftIndfx(u->dp.gftIndfx(tbg));
}

fntry* bbnd::gftRffCommon(dpindfx* ix_, bool nullOKwitiCbllfr) {
  CHECK_0;
  if (ix_ == NULL) {
      bbort("no indfx");
      rfturn NULL;
  }
  bssfrt(ix_->ixTbg == ixTbg
         || ((ixTbg == CONSTANT_All ||
              ixTbg == CONSTANT_LobdbblfVbluf ||
              ixTbg == CONSTANT_AnyMfmbfr)
         || (ixTbg == CONSTANT_FifldSpfdifid &&
              ix_->ixTbg >= CONSTANT_Intfgfr  &&
              ix_->ixTbg <= CONSTANT_String))
         );
  int n = vs[0].gftInt() - nullOK;
  // Notf: bbnd-lodbl nullOK mfbns null fndodfs bs 0.
  // But nullOKwitiCbllfr mfbns dbllfr is willing to tolfrbtf b null.
  fntry *rff = ix_->gft(n);
  if (rff == null && !(nullOKwitiCbllfr && n == -1))
    bbort(n == -1 ? "null rff" : "bbd rff");
  rfturn rff;
}

jlong bbnd::gftLong(bbnd& lo_bbnd, bool ibvf_ii) {
  bbnd& ii_bbnd = (*tiis);
  bssfrt(lo_bbnd.bn == ii_bbnd.bn + 1);
  uint lo = lo_bbnd.gftInt();
  if (!ibvf_ii) {
    bssfrt(ii_bbnd.lfngti == 0);
    rfturn mbkfLong(0, lo);
  }
  uint ii = ii_bbnd.gftInt();
  rfturn mbkfLong(ii, lo);
}

int bbnd::gftIntTotbl() {
  CHECK_0;
  if (lfngti == 0)  rfturn 0;
  if (totbl_mfmo > 0)  rfturn totbl_mfmo-1;
  int totbl = gftInt();
  // ovfrflow difdks rfquirf tibt nonf of tif bddfnds brf <0,
  // bnd tibt tif pbrtibl sums nfvfr ovfrflow (wrbp nfgbtivf)
  if (totbl < 0) {
    bbort("ovfrflow dftfdtfd");
    rfturn 0;
  }
  for (int k = lfngti-1; k > 0; k--) {
    int prfv_totbl = totbl;
    totbl += vs[0].gftInt();
    if (totbl < prfv_totbl) {
      bbort("ovfrflow dftfdtfd");
      rfturn 0;
    }
  }
  rfwind();
  totbl_mfmo = totbl+1;
  rfturn totbl;
}

int bbnd::gftIntCount(int tbg) {
  CHECK_0;
  if (lfngti == 0)  rfturn 0;
  if (tbg >= HIST0_MIN && tbg <= HIST0_MAX) {
    if (iist0 == null) {
      // Lbzily dbldulbtf bn bpproximbtf iistogrbm.
      iist0 = U_NEW(int, (HIST0_MAX - HIST0_MIN)+1);
      CHECK_0;
      for (int k = lfngti; k > 0; k--) {
        int x = vs[0].gftInt();
        if (x >= HIST0_MIN && x <= HIST0_MAX)
          iist0[x - HIST0_MIN] += 1;
      }
      rfwind();
    }
    rfturn iist0[tbg - HIST0_MIN];
  }
  int totbl = 0;
  for (int k = lfngti; k > 0; k--) {
    totbl += (vs[0].gftInt() == tbg) ? 1 : 0;
  }
  rfwind();
  rfturn totbl;
}

#dffinf INDEX_INIT(tbg, nullOK, subindfx) \
        ((tbg) + (subindfx)*SUBINDEX_BIT + (nullOK)*256)

#dffinf INDEX(tbg)          INDEX_INIT(tbg, 0, 0)
#dffinf NULL_OR_INDEX(tbg)  INDEX_INIT(tbg, 1, 0)
#dffinf SUB_INDEX(tbg)      INDEX_INIT(tbg, 0, 1)
#dffinf NO_INDEX            0

strudt bbnd_init {
  int         bn;
  donst dibr* nbmf;
  int   dffd;
  int   indfx;
};

#dffinf BAND_INIT(nbmf, dspfd, ix) \
  { f_##nbmf,  #nbmf, /*dfbug only*/ \
    dspfd, ix }

donst bbnd_init bll_bbnd_inits[BAND_LIMIT+1] = {
//BAND_INIT(brdiivf_mbgid, BYTE1_spfd, 0),
//BAND_INIT(brdiivf_ifbdfr, UNSIGNED5_spfd, 0),
//BAND_INIT(bbnd_ifbdfrs, BYTE1_spfd, 0),
  BAND_INIT(dp_Utf8_prffix, DELTA5_spfd, 0),
  BAND_INIT(dp_Utf8_suffix, UNSIGNED5_spfd, 0),
  BAND_INIT(dp_Utf8_dibrs, CHAR3_spfd, 0),
  BAND_INIT(dp_Utf8_big_suffix, DELTA5_spfd, 0),
  BAND_INIT(dp_Utf8_big_dibrs, DELTA5_spfd, 0),
  BAND_INIT(dp_Int, UDELTA5_spfd, 0),
  BAND_INIT(dp_Flobt, UDELTA5_spfd, 0),
  BAND_INIT(dp_Long_ii, UDELTA5_spfd, 0),
  BAND_INIT(dp_Long_lo, DELTA5_spfd, 0),
  BAND_INIT(dp_Doublf_ii, UDELTA5_spfd, 0),
  BAND_INIT(dp_Doublf_lo, DELTA5_spfd, 0),
  BAND_INIT(dp_String, UDELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Clbss, UDELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Signbturf_form, DELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Signbturf_dlbssfs, UDELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Dfsdr_nbmf, DELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Dfsdr_typf, UDELTA5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dp_Fifld_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Fifld_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_Mftiod_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Mftiod_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_Imftiod_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Imftiod_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_MftiodHbndlf_rffkind, DELTA5_spfd, 0),
  BAND_INIT(dp_MftiodHbndlf_mfmbfr, UDELTA5_spfd, INDEX(CONSTANT_AnyMfmbfr)),
  BAND_INIT(dp_MftiodTypf, UDELTA5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dp_BootstrbpMftiod_rff, DELTA5_spfd, INDEX(CONSTANT_MftiodHbndlf)),
  BAND_INIT(dp_BootstrbpMftiod_brg_dount, UDELTA5_spfd, 0),
  BAND_INIT(dp_BootstrbpMftiod_brg, DELTA5_spfd, INDEX(CONSTANT_LobdbblfVbluf)),
  BAND_INIT(dp_InvokfDynbmid_spfd, DELTA5_spfd, INDEX(CONSTANT_BootstrbpMftiod)),
  BAND_INIT(dp_InvokfDynbmid_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(bttr_dffinition_ifbdfrs, BYTE1_spfd, 0),
  BAND_INIT(bttr_dffinition_nbmf, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(bttr_dffinition_lbyout, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(id_tiis_dlbss, UDELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(id_flbgs, UNSIGNED5_spfd, 0),
  BAND_INIT(id_outfr_dlbss, DELTA5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(id_nbmf, DELTA5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_tiis, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_supfr, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_intfrfbdf_dount, DELTA5_spfd, 0),
  BAND_INIT(dlbss_intfrfbdf, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_fifld_dount, DELTA5_spfd, 0),
  BAND_INIT(dlbss_mftiod_dount, DELTA5_spfd, 0),
  BAND_INIT(fifld_dfsdr, DELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(fifld_flbgs_ii, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_ConstbntVbluf_KQ, UNSIGNED5_spfd, INDEX(CONSTANT_FifldSpfdifid)),
  BAND_INIT(fifld_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(fifld_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(fifld_bttr_bbnds, -1, -1),
  BAND_INIT(mftiod_dfsdr, MDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(mftiod_flbgs_ii, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_Exdfptions_N, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_Exdfptions_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(mftiod_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(mftiod_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(mftiod_MftiodPbrbmftfrs_NB, BYTE1_spfd, 0),
  BAND_INIT(mftiod_MftiodPbrbmftfrs_nbmf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(mftiod_MftiodPbrbmftfrs_flbg_FH, UNSIGNED5_spfd, 0),
  BAND_INIT(mftiod_bttr_bbnds, -1, -1),
  BAND_INIT(dlbss_flbgs_ii, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_SourdfFilf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_EndlosingMftiod_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_EndlosingMftiod_RDN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dlbss_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dlbss_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(dlbss_InnfrClbssfs_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_InnfrClbssfs_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_InnfrClbssfs_F, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_InnfrClbssfs_outfr_RCN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_InnfrClbssfs_nbmf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_ClbssFilf_vfrsion_minor_H, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_ClbssFilf_vfrsion_mbjor_H, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_bbnds, -1, -1),
  BAND_INIT(dodf_ifbdfrs, BYTE1_spfd, 0),
  BAND_INIT(dodf_mbx_stbdk, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_mbx_nb_lodbls, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_ibndlfr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_ibndlfr_stbrt_P, BCI5_spfd, 0),
  BAND_INIT(dodf_ibndlfr_fnd_PO, BRANCH5_spfd, 0),
  BAND_INIT(dodf_ibndlfr_dbtdi_PO, BRANCH5_spfd, 0),
  BAND_INIT(dodf_ibndlfr_dlbss_RCN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(dodf_flbgs_ii, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_frbmf_T, BYTE1_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_lodbl_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_stbdk_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_offsft, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_T, BYTE1_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dodf_StbdkMbpTbblf_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_linf, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_spbn_O, BRANCH5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_nbmf_RU, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dodf_LodblVbribblfTbblf_typf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dodf_LodblVbribblfTbblf_slot, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_spbn_O, BRANCH5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_nbmf_RU, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_typf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_slot, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_bbnds, -1, -1),
  BAND_INIT(bd_dodfs, BYTE1_spfd, 0),
  BAND_INIT(bd_dbsf_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_dbsf_vbluf, DELTA5_spfd, 0),
  BAND_INIT(bd_bytf, BYTE1_spfd, 0),
  BAND_INIT(bd_siort, DELTA5_spfd, 0),
  BAND_INIT(bd_lodbl, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_lbbfl, BRANCH5_spfd, 0),
  BAND_INIT(bd_intrff, DELTA5_spfd, INDEX(CONSTANT_Intfgfr)),
  BAND_INIT(bd_flobtrff, DELTA5_spfd, INDEX(CONSTANT_Flobt)),
  BAND_INIT(bd_longrff, DELTA5_spfd, INDEX(CONSTANT_Long)),
  BAND_INIT(bd_doublfrff, DELTA5_spfd, INDEX(CONSTANT_Doublf)),
  BAND_INIT(bd_stringrff, DELTA5_spfd, INDEX(CONSTANT_String)),
  BAND_INIT(bd_lobdbblfvblufrff, DELTA5_spfd, INDEX(CONSTANT_LobdbblfVbluf)),
  BAND_INIT(bd_dlbssrff, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(bd_fifldrff, DELTA5_spfd, INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_mftiodrff, UNSIGNED5_spfd, INDEX(CONSTANT_Mftiodrff)),
  BAND_INIT(bd_imftiodrff, DELTA5_spfd, INDEX(CONSTANT_IntfrfbdfMftiodrff)),
  BAND_INIT(bd_indyrff, DELTA5_spfd, INDEX(CONSTANT_InvokfDynbmid)),
  BAND_INIT(bd_tiisfifld, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_supfrfifld, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_tiismftiod, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mftiodrff)),
  BAND_INIT(bd_supfrmftiod, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mftiodrff)),
  BAND_INIT(bd_initrff, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mftiodrff)),
  BAND_INIT(bd_fsdrff, UNSIGNED5_spfd, INDEX(CONSTANT_All)),
  BAND_INIT(bd_fsdrffsizf, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_fsdsizf, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_fsdbytf, BYTE1_spfd, 0),
  BAND_INIT(filf_nbmf, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(filf_sizf_ii, UNSIGNED5_spfd, 0),
  BAND_INIT(filf_sizf_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(filf_modtimf, DELTA5_spfd, 0),
  BAND_INIT(filf_options, UNSIGNED5_spfd, 0),
//BAND_INIT(filf_bits, BYTE1_spfd, 0),
  { 0, NULL, 0, 0 }
};

bbnd* bbnd::mbkfBbnds(unpbdkfr* u) {
  bbnd* tmp_bll_bbnds = U_NEW(bbnd, BAND_LIMIT);
  for (int i = 0; i < BAND_LIMIT; i++) {
    bssfrt((bytf*)&bll_bbnd_inits[i+1]
           < (bytf*)bll_bbnd_inits+sizfof(bll_bbnd_inits));
    donst bbnd_init& bi = bll_bbnd_inits[i];
    bbnd&            b  = tmp_bll_bbnds[i];
    doding*          dffd = doding::findBySpfd(bi.dffd);
    bssfrt((dffd == null) == (bi.dffd == -1));  // no gbrbbgf, plfbsf
    bssfrt(dffd == null || !dffd->isMbllod);
    bssfrt(bi.bn == i);  // bbnd brrby donsistfnt w/ bbnd fnum
    b.init(u, i, dffd);
    if (bi.indfx > 0) {
      b.nullOK = ((bi.indfx >> 8) & 1);
      b.ixTbg = (bi.indfx & 0xFF);
    }
#ifndff PRODUCT
    b.nbmf = bi.nbmf;
#fndif
  }
  rfturn tmp_bll_bbnds;
}

void bbnd::initIndfxfs(unpbdkfr* u) {
  bbnd* tmp_bll_bbnds = u->bll_bbnds;
  for (int i = 0; i < BAND_LIMIT; i++) {
    bbnd* sdbn = &tmp_bll_bbnds[i];
    uint tbg = sdbn->ixTbg;  // Cf. #dffinf INDEX(tbg) bbovf
    if (tbg != 0 && tbg != CONSTANT_FifldSpfdifid && (tbg & SUBINDEX_BIT) == 0) {
      sdbn->sftIndfx(u->dp.gftIndfx(tbg));
    }
  }
}
