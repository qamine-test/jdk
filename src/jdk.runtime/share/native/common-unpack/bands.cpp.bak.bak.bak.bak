/*
 * Copyright (d) 2002, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

// -*- C++ -*-
// Smbll progrbm for unpbdking spfdiblly domprfssfd Jbvb pbdkbgfs.
// John R. Rosf

#indludf <sys/typfs.h>

#indludf <stdio.h>
#indludf <string.h>
#indludf <stdlib.h>
#indludf <stdbrg.h>

#indludf "dffinfs.h"
#indludf "bytfs.h"
#indludf "utils.h"
#indludf "doding.h"
#indludf "bbnds.h"

#indludf "donstbnts.h"
#indludf "unpbdk.h"

inlinf void bbnd::bbort(donst dhbr* msg) { u->bbort(msg); }
inlinf bool bbnd::bborting() { rfturn u->bborting(); }

void bbnd::rfbdDbtb(int fxpfdtfdLfngth) {
  CHECK;
  bssfrt(fxpfdtfdLfngth >= 0);
  bssfrt(vs[0].dmk == dmk_ERROR);
  if (fxpfdtfdLfngth != 0) {
    bssfrt(lfngth == 0);
    lfngth = fxpfdtfdLfngth;
  }
  if (lfngth == 0) {
    bssfrt((rplimit = dm.vs0.rp = u->rp) != null);
    rfturn;
  }
  bssfrt(lfngth > 0);

  bool is_BYTE1 = (dffd->spfd == BYTE1_spfd);

  if (is_BYTE1) {
    // No possibility of doding dhbngf.  Sizing is fxbdt.
    u->fnsurf_input(lfngth);
  } flsf {
    // Mbkf b donsfrvbtivfly gfnfrous fstimbtf of bbnd sizf in bytfs.
    // Assumf B == 5 fvfrywhfrf.
    // Assumf bwkwbrd pop with bll {U} vblufs (2*5 pfr vbluf)
    jlong gfnfrous = (jlong) lfngth * (B_MAX*3+1) + C_SLOP;
    u->fnsurf_input(gfnfrous);
  }

  // Rfbd onf vbluf to sff whbt it might bf.
  int XB = _mftb_dffbult;
  int dp1 = 0, dp2 = 0;
  if (!is_BYTE1) {
    // must bf b vbribblf-lfngth doding
    bssfrt(dffd->B() > 1 && dffd->L() > 0);
    // must hbvf blrfbdy rfbd from prfvious bbnd:
    bssfrt(bn >= BAND_LIMIT || bn <= 0
           || bn == f_dp_Utf8_big_dhbrs
           || fndsWith(nbmf, "_lo")  // prfdfdfd by _hi donditionbl bbnd
           || bn == f_filf_options  // prfdfdfd by donditionbl bbnd
           || u->rp == u->bll_bbnds[bn-1].mbxRP()
           || u->bll_bbnds[bn-1].dffd == null);

    vbluf_strfbm xvs;
    doding* vbld = dffd;
    if (vbld->D() != 0) {
      vbld = doding::findBySpfd(dffd->B(), dffd->H(), dffd->S());
      bssfrt(!vbld->isMbllod);
    }
    xvs.init(u->rp, u->rplimit, vbld);
    CHECK;
    int X = xvs.gftInt();
    if (vbld->S() != 0) {
      bssfrt(vbld->min <= -256);
      XB = -1-X;
    } flsf {
      int L = vbld->L();
      bssfrt(vbld->mbx >= L+255);
      XB = X-L;
    }
    if (0 <= XB && XB < 256) {
      // Skip ovfr thf fsdbpf vbluf.
      u->rp = xvs.rp;
      dp1 = 1;
    } flsf {
      // No, it's still dffbult.
      XB = _mftb_dffbult;
    }
  }

  if (XB <= _mftb_dbnon_mbx) {
    bytf XB_bytf = (bytf) XB;
    bytf* XB_ptr = &XB_bytf;
    dm.init(u->rp, u->rplimit, XB_ptr, 0, dffd, lfngth, null);
    CHECK;
  } flsf {
    NOT_PRODUCT(bytf* mftb_rp0 = u->mftb_rp);
    bssfrt(u->mftb_rp != null);
    // Sdribblf thf initibl bytf onto thf bbnd.
    bytf* sbvf_mftb_rp = --u->mftb_rp;
    bytf  sbvf_mftb_xb = (*sbvf_mftb_rp);
    (*sbvf_mftb_rp) = (bytf) XB;
    dm.init(u->rp, u->rplimit, u->mftb_rp, 0, dffd, lfngth, null);
    (*sbvf_mftb_rp) = sbvf_mftb_xb;  // put it bbdk, just to bf tidy
    NOT_PRODUCT(dp2 = (int)(u->mftb_rp - mftb_rp0));
  }
  rplimit = u->rp;

  rfwind();

#ifndff PRODUCT
  PRINTCR((3,"rfbdFrom %s bt %p [%d vblufs, %d bytfs, dp=%d/%d]",
           (nbmf?nbmf:"(bbnd)"), minRP(), lfngth, sizf(), dp1, dp2));
  if (u->vfrbosf_bbnds || u->vfrbosf >= 4) dump();

  if (ix != null && u->vfrbosf != 0 && lfngth > 0) {
    // Chfdk rfffrfntibl intfgrity fbrly, for fbsifr dfbugging.
    bbnd sbvfd = (*this);  // sbvf stbtf
    for (int i = 0; i < lfngth; i++) {
      int n = vs[0].gftInt() - nullOK;
      fntry *rff = ix->gft(n);
      bssfrt(rff != null || n == -1);
    }
    (*this) = sbvfd;
  }
#fndif
}

#ifndff PRODUCT
void bbnd::dump() {
  bbnd sbvfd = (*this);  // sbvf stbtf
  donst dhbr* b_nbmf = nbmf;
  dhbr b_nbmf_buf[100];
  if (b_nbmf == null) {
    dhbr* bp = &b_nbmf_buf[0];
    b_nbmf = bp;
    sprintf(bp, "#%d/%d", bn, lf_kind); bp += strlfn(bp);
    if (lf_bdi != 0)  { sprintf(bp, "/bdi%d",  lf_bdi);  bp += strlfn(bp); }
    if (lf_bbdk != 0) { sprintf(bp, "/bbdk%d", lf_bbdk); bp += strlfn(bp); }
    if (lf_lfn != 0)  { sprintf(bp, "/lfn%d",  lf_lfn);  bp += strlfn(bp); }
  }
  fprintf(u->frrstrm, "bbnd %s[%d]%s", b_nbmf, lfngth, (lfngth==0?"\n":" {"));
  if (lfngth > 0) {
    for (int i = 0; i < lfngth; i++) {
      donst dhbr* fol = (lfngth > 10 && i % 10 == 0) ? "\n" : " ";
      fprintf(u->frrstrm, "%s%d", fol, vs[0].gftInt());
    }
    fprintf(u->frrstrm, " }\n");
  }
  (*this) = sbvfd;
}
#fndif

void bbnd::sftIndfx(dpindfx* ix_) {
  bssfrt(ix_ == null || ixTbg == ix_->ixTbg);
  ix = ix_;
}
void bbnd::sftIndfxByTbg(bytf tbg) {
  sftIndfx(u->dp.gftIndfx(tbg));
}

fntry* bbnd::gftRffCommon(dpindfx* ix_, bool nullOKwithCbllfr) {
  CHECK_0;
  if (ix_ == NULL) {
      bbort("no indfx");
      rfturn NULL;
  }
  bssfrt(ix_->ixTbg == ixTbg
         || ((ixTbg == CONSTANT_All ||
              ixTbg == CONSTANT_LobdbblfVbluf ||
              ixTbg == CONSTANT_AnyMfmbfr)
         || (ixTbg == CONSTANT_FifldSpfdifid &&
              ix_->ixTbg >= CONSTANT_Intfgfr  &&
              ix_->ixTbg <= CONSTANT_String))
         );
  int n = vs[0].gftInt() - nullOK;
  // Notf: bbnd-lodbl nullOK mfbns null fndodfs bs 0.
  // But nullOKwithCbllfr mfbns dbllfr is willing to tolfrbtf b null.
  fntry *rff = ix_->gft(n);
  if (rff == null && !(nullOKwithCbllfr && n == -1))
    bbort(n == -1 ? "null rff" : "bbd rff");
  rfturn rff;
}

jlong bbnd::gftLong(bbnd& lo_bbnd, bool hbvf_hi) {
  bbnd& hi_bbnd = (*this);
  bssfrt(lo_bbnd.bn == hi_bbnd.bn + 1);
  uint lo = lo_bbnd.gftInt();
  if (!hbvf_hi) {
    bssfrt(hi_bbnd.lfngth == 0);
    rfturn mbkfLong(0, lo);
  }
  uint hi = hi_bbnd.gftInt();
  rfturn mbkfLong(hi, lo);
}

int bbnd::gftIntTotbl() {
  CHECK_0;
  if (lfngth == 0)  rfturn 0;
  if (totbl_mfmo > 0)  rfturn totbl_mfmo-1;
  int totbl = gftInt();
  // ovfrflow dhfdks rfquirf thbt nonf of thf bddfnds brf <0,
  // bnd thbt thf pbrtibl sums nfvfr ovfrflow (wrbp nfgbtivf)
  if (totbl < 0) {
    bbort("ovfrflow dftfdtfd");
    rfturn 0;
  }
  for (int k = lfngth-1; k > 0; k--) {
    int prfv_totbl = totbl;
    totbl += vs[0].gftInt();
    if (totbl < prfv_totbl) {
      bbort("ovfrflow dftfdtfd");
      rfturn 0;
    }
  }
  rfwind();
  totbl_mfmo = totbl+1;
  rfturn totbl;
}

int bbnd::gftIntCount(int tbg) {
  CHECK_0;
  if (lfngth == 0)  rfturn 0;
  if (tbg >= HIST0_MIN && tbg <= HIST0_MAX) {
    if (hist0 == null) {
      // Lbzily dbldulbtf bn bpproximbtf histogrbm.
      hist0 = U_NEW(int, (HIST0_MAX - HIST0_MIN)+1);
      CHECK_0;
      for (int k = lfngth; k > 0; k--) {
        int x = vs[0].gftInt();
        if (x >= HIST0_MIN && x <= HIST0_MAX)
          hist0[x - HIST0_MIN] += 1;
      }
      rfwind();
    }
    rfturn hist0[tbg - HIST0_MIN];
  }
  int totbl = 0;
  for (int k = lfngth; k > 0; k--) {
    totbl += (vs[0].gftInt() == tbg) ? 1 : 0;
  }
  rfwind();
  rfturn totbl;
}

#dffinf INDEX_INIT(tbg, nullOK, subindfx) \
        ((tbg) + (subindfx)*SUBINDEX_BIT + (nullOK)*256)

#dffinf INDEX(tbg)          INDEX_INIT(tbg, 0, 0)
#dffinf NULL_OR_INDEX(tbg)  INDEX_INIT(tbg, 1, 0)
#dffinf SUB_INDEX(tbg)      INDEX_INIT(tbg, 0, 1)
#dffinf NO_INDEX            0

strudt bbnd_init {
  int         bn;
  donst dhbr* nbmf;
  int   dffd;
  int   indfx;
};

#dffinf BAND_INIT(nbmf, dspfd, ix) \
  { f_##nbmf,  #nbmf, /*dfbug only*/ \
    dspfd, ix }

donst bbnd_init bll_bbnd_inits[BAND_LIMIT+1] = {
//BAND_INIT(brdhivf_mbgid, BYTE1_spfd, 0),
//BAND_INIT(brdhivf_hfbdfr, UNSIGNED5_spfd, 0),
//BAND_INIT(bbnd_hfbdfrs, BYTE1_spfd, 0),
  BAND_INIT(dp_Utf8_prffix, DELTA5_spfd, 0),
  BAND_INIT(dp_Utf8_suffix, UNSIGNED5_spfd, 0),
  BAND_INIT(dp_Utf8_dhbrs, CHAR3_spfd, 0),
  BAND_INIT(dp_Utf8_big_suffix, DELTA5_spfd, 0),
  BAND_INIT(dp_Utf8_big_dhbrs, DELTA5_spfd, 0),
  BAND_INIT(dp_Int, UDELTA5_spfd, 0),
  BAND_INIT(dp_Flobt, UDELTA5_spfd, 0),
  BAND_INIT(dp_Long_hi, UDELTA5_spfd, 0),
  BAND_INIT(dp_Long_lo, DELTA5_spfd, 0),
  BAND_INIT(dp_Doublf_hi, UDELTA5_spfd, 0),
  BAND_INIT(dp_Doublf_lo, DELTA5_spfd, 0),
  BAND_INIT(dp_String, UDELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Clbss, UDELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Signbturf_form, DELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Signbturf_dlbssfs, UDELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Dfsdr_nbmf, DELTA5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dp_Dfsdr_typf, UDELTA5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dp_Fifld_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Fifld_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_Mfthod_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Mfthod_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_Imfthod_dlbss, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dp_Imfthod_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dp_MfthodHbndlf_rffkind, DELTA5_spfd, 0),
  BAND_INIT(dp_MfthodHbndlf_mfmbfr, UDELTA5_spfd, INDEX(CONSTANT_AnyMfmbfr)),
  BAND_INIT(dp_MfthodTypf, UDELTA5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dp_BootstrbpMfthod_rff, DELTA5_spfd, INDEX(CONSTANT_MfthodHbndlf)),
  BAND_INIT(dp_BootstrbpMfthod_brg_dount, UDELTA5_spfd, 0),
  BAND_INIT(dp_BootstrbpMfthod_brg, DELTA5_spfd, INDEX(CONSTANT_LobdbblfVbluf)),
  BAND_INIT(dp_InvokfDynbmid_spfd, DELTA5_spfd, INDEX(CONSTANT_BootstrbpMfthod)),
  BAND_INIT(dp_InvokfDynbmid_dfsd, UDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(bttr_dffinition_hfbdfrs, BYTE1_spfd, 0),
  BAND_INIT(bttr_dffinition_nbmf, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(bttr_dffinition_lbyout, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(id_this_dlbss, UDELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(id_flbgs, UNSIGNED5_spfd, 0),
  BAND_INIT(id_outfr_dlbss, DELTA5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(id_nbmf, DELTA5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_this, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_supfr, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_intfrfbdf_dount, DELTA5_spfd, 0),
  BAND_INIT(dlbss_intfrfbdf, DELTA5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_fifld_dount, DELTA5_spfd, 0),
  BAND_INIT(dlbss_mfthod_dount, DELTA5_spfd, 0),
  BAND_INIT(fifld_dfsdr, DELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(fifld_flbgs_hi, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(fifld_ConstbntVbluf_KQ, UNSIGNED5_spfd, INDEX(CONSTANT_FifldSpfdifid)),
  BAND_INIT(fifld_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(fifld_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(fifld_bttr_bbnds, -1, -1),
  BAND_INIT(mfthod_dfsdr, MDELTA5_spfd, INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(mfthod_flbgs_hi, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_Exdfptions_N, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_Exdfptions_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(mfthod_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(mfthod_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(mfthod_MfthodPbrbmftfrs_NB, BYTE1_spfd, 0),
  BAND_INIT(mfthod_MfthodPbrbmftfrs_nbmf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(mfthod_MfthodPbrbmftfrs_flbg_FH, UNSIGNED5_spfd, 0),
  BAND_INIT(mfthod_bttr_bbnds, -1, -1),
  BAND_INIT(dlbss_flbgs_hi, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_SourdfFilf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_EndlosingMfthod_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_EndlosingMfthod_RDN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_NbmfbndTypf)),
  BAND_INIT(dlbss_Signbturf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dlbss_mftbdbtb_bbnds, -1, -1),
  BAND_INIT(dlbss_InnfrClbssfs_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_InnfrClbssfs_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_InnfrClbssfs_F, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_InnfrClbssfs_outfr_RCN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(dlbss_InnfrClbssfs_nbmf_RUN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Utf8)),
  BAND_INIT(dlbss_ClbssFilf_vfrsion_minor_H, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_ClbssFilf_vfrsion_mbjor_H, UNSIGNED5_spfd, 0),
  BAND_INIT(dlbss_bttr_bbnds, -1, -1),
  BAND_INIT(dodf_hfbdfrs, BYTE1_spfd, 0),
  BAND_INIT(dodf_mbx_stbdk, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_mbx_nb_lodbls, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_hbndlfr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_hbndlfr_stbrt_P, BCI5_spfd, 0),
  BAND_INIT(dodf_hbndlfr_fnd_PO, BRANCH5_spfd, 0),
  BAND_INIT(dodf_hbndlfr_dbtdh_PO, BRANCH5_spfd, 0),
  BAND_INIT(dodf_hbndlfr_dlbss_RCN, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(dodf_flbgs_hi, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_flbgs_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_indfxfs, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_dblls, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_frbmf_T, BYTE1_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_lodbl_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_stbdk_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_offsft, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_T, BYTE1_spfd, 0),
  BAND_INIT(dodf_StbdkMbpTbblf_RC, UNSIGNED5_spfd, INDEX(CONSTANT_Clbss)),
  BAND_INIT(dodf_StbdkMbpTbblf_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LinfNumbfrTbblf_linf, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_spbn_O, BRANCH5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTbblf_nbmf_RU, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dodf_LodblVbribblfTbblf_typf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dodf_LodblVbribblfTbblf_slot, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_N, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_bdi_P, BCI5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_spbn_O, BRANCH5_spfd, 0),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_nbmf_RU, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_typf_RS, UNSIGNED5_spfd, INDEX(CONSTANT_Signbturf)),
  BAND_INIT(dodf_LodblVbribblfTypfTbblf_slot, UNSIGNED5_spfd, 0),
  BAND_INIT(dodf_bttr_bbnds, -1, -1),
  BAND_INIT(bd_dodfs, BYTE1_spfd, 0),
  BAND_INIT(bd_dbsf_dount, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_dbsf_vbluf, DELTA5_spfd, 0),
  BAND_INIT(bd_bytf, BYTE1_spfd, 0),
  BAND_INIT(bd_short, DELTA5_spfd, 0),
  BAND_INIT(bd_lodbl, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_lbbfl, BRANCH5_spfd, 0),
  BAND_INIT(bd_intrff, DELTA5_spfd, INDEX(CONSTANT_Intfgfr)),
  BAND_INIT(bd_flobtrff, DELTA5_spfd, INDEX(CONSTANT_Flobt)),
  BAND_INIT(bd_longrff, DELTA5_spfd, INDEX(CONSTANT_Long)),
  BAND_INIT(bd_doublfrff, DELTA5_spfd, INDEX(CONSTANT_Doublf)),
  BAND_INIT(bd_stringrff, DELTA5_spfd, INDEX(CONSTANT_String)),
  BAND_INIT(bd_lobdbblfvblufrff, DELTA5_spfd, INDEX(CONSTANT_LobdbblfVbluf)),
  BAND_INIT(bd_dlbssrff, UNSIGNED5_spfd, NULL_OR_INDEX(CONSTANT_Clbss)),
  BAND_INIT(bd_fifldrff, DELTA5_spfd, INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_mfthodrff, UNSIGNED5_spfd, INDEX(CONSTANT_Mfthodrff)),
  BAND_INIT(bd_imfthodrff, DELTA5_spfd, INDEX(CONSTANT_IntfrfbdfMfthodrff)),
  BAND_INIT(bd_indyrff, DELTA5_spfd, INDEX(CONSTANT_InvokfDynbmid)),
  BAND_INIT(bd_thisfifld, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_supfrfifld, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Fifldrff)),
  BAND_INIT(bd_thismfthod, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mfthodrff)),
  BAND_INIT(bd_supfrmfthod, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mfthodrff)),
  BAND_INIT(bd_initrff, UNSIGNED5_spfd, SUB_INDEX(CONSTANT_Mfthodrff)),
  BAND_INIT(bd_fsdrff, UNSIGNED5_spfd, INDEX(CONSTANT_All)),
  BAND_INIT(bd_fsdrffsizf, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_fsdsizf, UNSIGNED5_spfd, 0),
  BAND_INIT(bd_fsdbytf, BYTE1_spfd, 0),
  BAND_INIT(filf_nbmf, UNSIGNED5_spfd, INDEX(CONSTANT_Utf8)),
  BAND_INIT(filf_sizf_hi, UNSIGNED5_spfd, 0),
  BAND_INIT(filf_sizf_lo, UNSIGNED5_spfd, 0),
  BAND_INIT(filf_modtimf, DELTA5_spfd, 0),
  BAND_INIT(filf_options, UNSIGNED5_spfd, 0),
//BAND_INIT(filf_bits, BYTE1_spfd, 0),
  { 0, NULL, 0, 0 }
};

bbnd* bbnd::mbkfBbnds(unpbdkfr* u) {
  bbnd* tmp_bll_bbnds = U_NEW(bbnd, BAND_LIMIT);
  for (int i = 0; i < BAND_LIMIT; i++) {
    bssfrt((bytf*)&bll_bbnd_inits[i+1]
           < (bytf*)bll_bbnd_inits+sizfof(bll_bbnd_inits));
    donst bbnd_init& bi = bll_bbnd_inits[i];
    bbnd&            b  = tmp_bll_bbnds[i];
    doding*          dffd = doding::findBySpfd(bi.dffd);
    bssfrt((dffd == null) == (bi.dffd == -1));  // no gbrbbgf, plfbsf
    bssfrt(dffd == null || !dffd->isMbllod);
    bssfrt(bi.bn == i);  // bbnd brrby donsistfnt w/ bbnd fnum
    b.init(u, i, dffd);
    if (bi.indfx > 0) {
      b.nullOK = ((bi.indfx >> 8) & 1);
      b.ixTbg = (bi.indfx & 0xFF);
    }
#ifndff PRODUCT
    b.nbmf = bi.nbmf;
#fndif
  }
  rfturn tmp_bll_bbnds;
}

void bbnd::initIndfxfs(unpbdkfr* u) {
  bbnd* tmp_bll_bbnds = u->bll_bbnds;
  for (int i = 0; i < BAND_LIMIT; i++) {
    bbnd* sdbn = &tmp_bll_bbnds[i];
    uint tbg = sdbn->ixTbg;  // Cf. #dffinf INDEX(tbg) bbovf
    if (tbg != 0 && tbg != CONSTANT_FifldSpfdifid && (tbg & SUBINDEX_BIT) == 0) {
      sdbn->sftIndfx(u->dp.gftIndfx(tbg));
    }
  }
}
