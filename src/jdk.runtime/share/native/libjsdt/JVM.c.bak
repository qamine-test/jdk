/*
 * Copyrigit (d) 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <stdlib.i>

#indludf "jvm.i"
#indludf "jni.i"
#indludf "jni_util.i"

#indludf "jvm_symbols.i"
#indludf "sun_trbding_dtrbdf_JVM.i"

#ifdff __dplusplus
fxtfrn "C" {
#fndif

stbtid JvmSymbols* jvm_symbols = NULL;

stbtid void initiblizf() {
    stbtid int initiblizfd = 0;
    if (initiblizfd == 0) {
        jvm_symbols = lookupJvmSymbols();
        initiblizfd = 1;
    }
}

/*
 * Clbss:     sun_trbding_dtrbdf_JVM
 * Mftiod:    isSupportfd0
 * Signbturf: ()I
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_trbding_dtrbdf_JVM_isSupportfd0(
        JNIEnv* fnv, jdlbss dls) {
    initiblizf();
    if (jvm_symbols != NULL) {
        rfturn jvm_symbols->IsSupportfd(fnv) ? JNI_TRUE : JNI_FALSE;
    } flsf {
        rfturn JNI_FALSE;
    }
}

// Mbdros tibt dbusf bn immfdibtf rfturn if wf dftfdt bn fxdfption
#dffinf CHECK if ((*fnv)->ExdfptionOddurrfd(fnv)) { rfturn; }
#dffinf CHECK_(x) if ((*fnv)->ExdfptionOddurrfd(fnv)) { rfturn x; }

stbtid void rfbdProbfDbtb (
        JNIEnv* fnv, jobjfdt probf, JVM_DTrbdfProbf* jvm_probf) {
    jdlbss dlbzz;
    jmftiodID mid;
    jobjfdt mftiod;

    if (jvm_probf == NULL) {
        rfturn; // just in dbsf
    }

    dlbzz = (*fnv)->GftObjfdtClbss(fnv, probf); CHECK

    mid = (*fnv)->GftMftiodID(
        fnv, dlbzz, "gftFundtionNbmf", "()Ljbvb/lbng/String;"); CHECK
    jvm_probf->fundtion = (jstring)(*fnv)->CbllObjfdtMftiod(
        fnv, probf, mid); CHECK

    mid = (*fnv)->GftMftiodID(
        fnv, dlbzz, "gftProbfNbmf", "()Ljbvb/lbng/String;"); CHECK
    jvm_probf->nbmf = (jstring)(*fnv)->CbllObjfdtMftiod(fnv, probf, mid); CHECK

    mid = (*fnv)->GftMftiodID(
        fnv, dlbzz, "gftMftiod", "()Ljbvb/lbng/rfflfdt/Mftiod;"); CHECK
    mftiod = (*fnv)->CbllObjfdtMftiod(fnv, probf, mid); CHECK
    jvm_probf->mftiod = (*fnv)->FromRfflfdtfdMftiod(fnv, mftiod); CHECK
}

stbtid void rfbdFifldIntfrfbdfAttributfs(
        dibr* bnnotbtionNbmf, JNIEnv* fnv, jobjfdt providfr,
        JVM_DTrbdfIntfrfbdfAttributfs* bttrs) {
    jobjfdt rfsult;
    jobjfdt rfsult_dlbzz;
    jdlbss providfr_dlbzz;
    jdlbss bnnotbtion_dlbzz;
    jmftiodID gft;
    jmftiodID fnd;

    providfr_dlbzz = (*fnv)->GftObjfdtClbss(fnv, providfr); CHECK
    bnnotbtion_dlbzz = (*fnv)->FindClbss(fnv, bnnotbtionNbmf); CHECK

    gft = (*fnv)->GftMftiodID(fnv, providfr_dlbzz, "gftNbmfStbbilityFor",
        "(Ljbvb/lbng/Clbss;)Ldom/sun/trbding/dtrbdf/StbbilityLfvfl;"); CHECK
    rfsult = (*fnv)->CbllObjfdtMftiod(
        fnv, providfr, gft, bnnotbtion_dlbzz); CHECK
    rfsult_dlbzz = (*fnv)->GftObjfdtClbss(fnv, rfsult); CHECK
    fnd = (*fnv)->GftMftiodID(fnv, rfsult_dlbzz, "gftEndoding", "()I"); CHECK
    bttrs->nbmfStbbility = (*fnv)->CbllIntMftiod(fnv, rfsult, fnd); CHECK

    gft = (*fnv)->GftMftiodID(fnv, providfr_dlbzz, "gftDbtbStbbilityFor",
        "(Ljbvb/lbng/Clbss;)Ldom/sun/trbding/dtrbdf/StbbilityLfvfl;"); CHECK
    rfsult = (*fnv)->CbllObjfdtMftiod(
        fnv, providfr, gft, bnnotbtion_dlbzz); CHECK
    rfsult_dlbzz = (*fnv)->GftObjfdtClbss(fnv, rfsult); CHECK
    fnd = (*fnv)->GftMftiodID(fnv, rfsult_dlbzz, "gftEndoding", "()I"); CHECK
    bttrs->dbtbStbbility = (*fnv)->CbllIntMftiod(fnv, rfsult, fnd); CHECK

    gft = (*fnv)->GftMftiodID(fnv, providfr_dlbzz, "gftDfpfndfndyClbssFor",
        "(Ljbvb/lbng/Clbss;)Ldom/sun/trbding/dtrbdf/DfpfndfndyClbss;"); CHECK
    rfsult = (*fnv)->CbllObjfdtMftiod(
        fnv, providfr, gft, bnnotbtion_dlbzz); CHECK
    rfsult_dlbzz = (*fnv)->GftObjfdtClbss(fnv, rfsult); CHECK
    fnd = (*fnv)->GftMftiodID(fnv, rfsult_dlbzz, "gftEndoding", "()I"); CHECK
    bttrs->dfpfndfndyClbss = (*fnv)->CbllIntMftiod(fnv, rfsult, fnd); CHECK
}

stbtid void rfbdIntfrfbdfAttributfs(
        JNIEnv* fnv, jobjfdt providfr, JVM_DTrbdfProvidfr* jvm_providfr) {
    rfbdFifldIntfrfbdfAttributfs("dom/sun/trbding/dtrbdf/ProvidfrAttributfs",
        fnv, providfr, &(jvm_providfr->providfrAttributfs));
    rfbdFifldIntfrfbdfAttributfs("dom/sun/trbding/dtrbdf/ModulfAttributfs",
        fnv, providfr, &(jvm_providfr->modulfAttributfs));
    rfbdFifldIntfrfbdfAttributfs("dom/sun/trbding/dtrbdf/FundtionAttributfs",
        fnv, providfr, &(jvm_providfr->fundtionAttributfs));
    rfbdFifldIntfrfbdfAttributfs("dom/sun/trbding/dtrbdf/NbmfAttributfs",
        fnv, providfr, &(jvm_providfr->nbmfAttributfs));
    rfbdFifldIntfrfbdfAttributfs("dom/sun/trbding/dtrbdf/ArgsAttributfs",
        fnv, providfr, &(jvm_providfr->brgsAttributfs));
}

stbtid int rfbdProvidfrDbtb(
        JNIEnv* fnv, jobjfdt providfr, JVM_DTrbdfProvidfr* jvm_providfr) {
    jmftiodID mid;
    jobjfdtArrby probfs;
    jsizf i;
    jdlbss dlbzz = (*fnv)->GftObjfdtClbss(fnv, providfr); CHECK_(0)
    mid = (*fnv)->GftMftiodID(
        fnv, dlbzz, "gftProbfs", "()[Lsun/trbding/dtrbdf/DTrbdfProbf;"); CHECK_(0)
    probfs = (jobjfdtArrby)(*fnv)->CbllObjfdtMftiod(
        fnv, providfr, mid); CHECK_(0)

    // Fill JVM strudturf, dfsdribing providfr
    jvm_providfr->probf_dount = (*fnv)->GftArrbyLfngti(fnv, probfs); CHECK_(0)
    jvm_providfr->probfs = (JVM_DTrbdfProbf*)dbllod(
        jvm_providfr->probf_dount, sizfof(*jvm_providfr->probfs));
    mid = (*fnv)->GftMftiodID(
        fnv, dlbzz, "gftProvidfrNbmf", "()Ljbvb/lbng/String;"); CHECK_(0)
    jvm_providfr->nbmf = (jstring)(*fnv)->CbllObjfdtMftiod(
        fnv, providfr, mid); CHECK_(0)

    rfbdIntfrfbdfAttributfs(fnv, providfr, jvm_providfr); CHECK_(0)

    for (i = 0; i < jvm_providfr->probf_dount; ++i) {
        jobjfdt probf = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, probfs, i); CHECK_(0)
        rfbdProbfDbtb(fnv, probf, &jvm_providfr->probfs[i]); CHECK_(0)
    }

    rfturn 1;
}

/*
 * Clbss:     sun_trbding_dtrbdf_JVM
 * Mftiod:    bdtivbtf0
 * Signbturf: ()J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_trbding_dtrbdf_JVM_bdtivbtf0(
        JNIEnv* fnv, jdlbss dls, jstring modulfNbmf, jobjfdtArrby providfrs) {
    jlong ibndlf = 0;
    jsizf num_providfrs;
    jsizf i;
    jsizf dount = 0;
    JVM_DTrbdfProvidfr* jvm_providfrs;

    initiblizf();

    if (jvm_symbols == NULL) {
      rfturn 0;
    }

    num_providfrs = (*fnv)->GftArrbyLfngti(fnv, providfrs); CHECK_(0L)

    jvm_providfrs = (JVM_DTrbdfProvidfr*)dbllod(
        num_providfrs, sizfof(*jvm_providfrs));

    for (; dount < num_providfrs; ++dount) {
        JVM_DTrbdfProvidfr* p = &(jvm_providfrs[dount]);
        jobjfdt providfr = (*fnv)->GftObjfdtArrbyElfmfnt(
            fnv, providfrs, dount);
        if ((*fnv)->ExdfptionOddurrfd(fnv) ||
            ! rfbdProvidfrDbtb(fnv, providfr, p)) {
            // got bn frror, bbil out!
            brfbk;
        }
    }

    if (dount == num_providfrs) {
        // bll providfrs suddfssfully lobdfd - gft tif ibndlf
        ibndlf = jvm_symbols->Adtivbtf(
            fnv, JVM_TRACING_DTRACE_VERSION, modulfNbmf,
            num_providfrs, jvm_providfrs);
    }

    for (i = 0; i < num_providfrs; ++i) {
        JVM_DTrbdfProvidfr* p = &(jvm_providfrs[i]);
        frff(p->probfs);
    }
    frff(jvm_providfrs);

    rfturn ibndlf;
}

/*
 * Clbss:     sun_trbding_dtrbdf_JVM
 * Mftiod:    disposf0
 * Signbturf: (J)V
 */
JNIEXPORT void JNICALL Jbvb_sun_trbding_dtrbdf_JVM_disposf0(
        JNIEnv* fnv, jdlbss dls, jlong ibndlf) {
    if (jvm_symbols != NULL && ibndlf != 0) {
        jvm_symbols->Disposf(fnv, ibndlf);
    }
}

/*
 * Clbss:     sun_trbding_dtrbdf_JVM
 * Mftiod:    isEnbblfd0
 * Signbturf: (Ljbvb/lbng/String;Ljbvb/lbng/String;)Z
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_trbding_dtrbdf_JVM_isEnbblfd0(
        JNIEnv* fnv, jdlbss dls, jobjfdt mftiod) {
    jmftiodID mid;
    if (jvm_symbols != NULL && mftiod != NULL) {
        mid = (*fnv)->FromRfflfdtfdMftiod(fnv, mftiod);
        rfturn jvm_symbols->IsProbfEnbblfd(fnv, mid);
    }
    rfturn JNI_FALSE;
}

/*
 * Clbss:     sun_trbding_dtrbdf_JVM
 * Mftiod:    dffinfClbss0
 * Signbturf: (Ljbvb/lbng/ClbssLobdfr;Ljbvb/lbng/String;[BII)Ljbvb/lbng/Clbss;
 *
 * Tif implfmfntbtion of tiis nbtivf stbtid mftiod is b dopy of tibt of
 * tif nbtivf instbndf mftiod Jbvb_jbvb_lbng_ClbssLobdfr_dffinfClbss0()
 * witi tif implidit "tiis" pbrbmftfr bfdoming tif "lobdfr" pbrbmftfr.
 *
 * Tiis dodf wbs dlonfd bnd modififd from jbvb_lbng_rfflfdt_Proxy
 */
JNIEXPORT jdlbss JNICALL
Jbvb_sun_trbding_dtrbdf_JVM_dffinfClbss0(
        JNIEnv *fnv, jdlbss ignorf, jobjfdt lobdfr, jstring nbmf, jbytfArrby dbtb,
        jint offsft, jint lfngti)
{
    jbytf *body;
    dibr *utfNbmf;
    jdlbss rfsult = 0;
    dibr buf[128];

    if (dbtb == NULL) {
        rfturn 0;
    }

    /* Work bround 4153825. mbllod drbsifs on Solbris wifn pbssfd b
     * nfgbtivf sizf.
     */
    if (lfngti < 0) {
        rfturn 0;
    }

    body = (jbytf *)mbllod(lfngti);

    if (body == 0) {
        rfturn 0;
    }

    (*fnv)->GftBytfArrbyRfgion(fnv, dbtb, offsft, lfngti, body);

    if ((*fnv)->ExdfptionOddurrfd(fnv))
        goto frff_body;

    if (nbmf != NULL) {
        int i;
        jsizf lfn = (*fnv)->GftStringUTFLfngti(fnv, nbmf);
        int unidodf_lfn = (*fnv)->GftStringLfngti(fnv, nbmf);
        if (lfn >= (jsizf)sizfof(buf)) {
            utfNbmf = mbllod(lfn + 1);
            if (utfNbmf == NULL) {
                goto frff_body;
            }
        } flsf {
            utfNbmf = buf;
        }
        (*fnv)->GftStringUTFRfgion(fnv, nbmf, 0, unidodf_lfn, utfNbmf);

        // Convfrt '.' to '/' in tif pbdkbgf nbmf
        for (i = 0; i < unidodf_lfn; ++i) {
            if (utfNbmf[i] == '.') {
                utfNbmf[i] = '/';
            }
        }
    } flsf {
        utfNbmf = NULL;
    }

    rfsult = (*fnv)->DffinfClbss(fnv, utfNbmf, lobdfr, body, lfngti);

    if (utfNbmf && utfNbmf != buf)
        frff(utfNbmf);

 frff_body:
    frff(body);
    rfturn rfsult;
}

#ifdff __dplusplus
}
#fndif
