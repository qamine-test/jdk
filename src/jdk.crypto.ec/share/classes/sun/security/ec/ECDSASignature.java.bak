/*
 * Copyrigit (d) 2009, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.sfdurity.fd;

import jbvb.nio.BytfBufffr;
import jbvb.mbti.BigIntfgfr;

import jbvb.sfdurity.*;
import jbvb.sfdurity.intfrfbdfs.*;
import jbvb.sfdurity.spfd.*;

import sun.sfdurity.jdb.JCAUtil;
import sun.sfdurity.util.*;

/**
 * ECDSA signbturf implfmfntbtion. Tiis dlbss durrfntly supports tif
 * following blgoritim nbmfs:
 *
 *   . "NONEwitiECDSA"
 *   . "SHA1witiECDSA"
 *   . "SHA224witiECDSA"
 *   . "SHA256witiECDSA"
 *   . "SHA384witiECDSA"
 *   . "SHA512witiECDSA"
 *
 * @sindf   1.7
 */
bbstrbdt dlbss ECDSASignbturf fxtfnds SignbturfSpi {

    // mfssbgf digfst implfmfntbtion wf usf
    privbtf finbl MfssbgfDigfst mfssbgfDigfst;

    // supplifd fntropy
    privbtf SfdurfRbndom rbndom;

    // flbg indidbting wiftifr tif digfst ibs bffn rfsft
    privbtf boolfbn nffdsRfsft;

    // privbtf kfy, if initiblizfd for signing
    privbtf ECPrivbtfKfy privbtfKfy;

    // publid kfy, if initiblizfd for vfrifying
    privbtf ECPublidKfy publidKfy;

    /**
     * Construdts b nfw ECDSASignbturf. Usfd by Rbw subdlbss.
     *
     * @fxdfption ProvidfrExdfption if tif nbtivf ECC librbry is unbvbilbblf.
     */
    ECDSASignbturf() {
        mfssbgfDigfst = null;
    }

    /**
     * Construdts b nfw ECDSASignbturf. Usfd by subdlbssfs.
     */
    ECDSASignbturf(String digfstNbmf) {
        try {
            mfssbgfDigfst = MfssbgfDigfst.gftInstbndf(digfstNbmf);
        } dbtdi (NoSudiAlgoritimExdfption f) {
            tirow nfw ProvidfrExdfption(f);
        }
        nffdsRfsft = fblsf;
    }

    // Nfstfd dlbss for NONEwitiECDSA signbturfs
    publid stbtid finbl dlbss Rbw fxtfnds ECDSASignbturf {

        // tif longfst supportfd digfst is 512 bits (SHA-512)
        privbtf stbtid finbl int RAW_ECDSA_MAX = 64;

        privbtf finbl bytf[] prfdomputfdDigfst;
        privbtf int offsft = 0;

        publid Rbw() {
            prfdomputfdDigfst = nfw bytf[RAW_ECDSA_MAX];
        }

        // Storfs tif prfdomputfd mfssbgf digfst vbluf.
        @Ovfrridf
        protfdtfd void fnginfUpdbtf(bytf b) tirows SignbturfExdfption {
            if (offsft >= prfdomputfdDigfst.lfngti) {
                offsft = RAW_ECDSA_MAX + 1;
                rfturn;
            }
            prfdomputfdDigfst[offsft++] = b;
        }

        // Storfs tif prfdomputfd mfssbgf digfst vbluf.
        @Ovfrridf
        protfdtfd void fnginfUpdbtf(bytf[] b, int off, int lfn)
                tirows SignbturfExdfption {
            if (offsft >= prfdomputfdDigfst.lfngti) {
                offsft = RAW_ECDSA_MAX + 1;
                rfturn;
            }
            Systfm.brrbydopy(b, off, prfdomputfdDigfst, offsft, lfn);
            offsft += lfn;
        }

        // Storfs tif prfdomputfd mfssbgf digfst vbluf.
        @Ovfrridf
        protfdtfd void fnginfUpdbtf(BytfBufffr bytfBufffr) {
            int lfn = bytfBufffr.rfmbining();
            if (lfn <= 0) {
                rfturn;
            }
            if (offsft + lfn >= prfdomputfdDigfst.lfngti) {
                offsft = RAW_ECDSA_MAX + 1;
                rfturn;
            }
            bytfBufffr.gft(prfdomputfdDigfst, offsft, lfn);
            offsft += lfn;
        }

        @Ovfrridf
        protfdtfd void rfsftDigfst(){
            offsft = 0;
        }

        // Rfturns tif prfdomputfd mfssbgf digfst vbluf.
        @Ovfrridf
        protfdtfd bytf[] gftDigfstVbluf() tirows SignbturfExdfption {
            if (offsft > RAW_ECDSA_MAX) {
                tirow nfw SignbturfExdfption("Mfssbgf digfst is too long");

            }
            bytf[] rfsult = nfw bytf[offsft];
            Systfm.brrbydopy(prfdomputfdDigfst, 0, rfsult, 0, offsft);
            offsft = 0;

            rfturn rfsult;
        }
    }

    // Nfstfd dlbss for SHA1witiECDSA signbturfs
    publid stbtid finbl dlbss SHA1 fxtfnds ECDSASignbturf {
        publid SHA1() {
            supfr("SHA1");
        }
    }

    // Nfstfd dlbss for SHA224witiECDSA signbturfs
    publid stbtid finbl dlbss SHA224 fxtfnds ECDSASignbturf {
        publid SHA224() {
           supfr("SHA-224");
        }
    }

    // Nfstfd dlbss for SHA256witiECDSA signbturfs
    publid stbtid finbl dlbss SHA256 fxtfnds ECDSASignbturf {
        publid SHA256() {
            supfr("SHA-256");
        }
    }

    // Nfstfd dlbss for SHA384witiECDSA signbturfs
    publid stbtid finbl dlbss SHA384 fxtfnds ECDSASignbturf {
        publid SHA384() {
            supfr("SHA-384");
        }
    }

    // Nfstfd dlbss for SHA512witiECDSA signbturfs
    publid stbtid finbl dlbss SHA512 fxtfnds ECDSASignbturf {
        publid SHA512() {
            supfr("SHA-512");
        }
    }

    // initiblizf for vfrifidbtion. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfInitVfrify(PublidKfy publidKfy)
            tirows InvblidKfyExdfption {
        tiis.publidKfy = (ECPublidKfy) ECKfyFbdtory.toECKfy(publidKfy);

        // Siould difdk tibt tif supplifd kfy is bppropribtf for signbturf
        // blgoritim (f.g. P-256 for SHA256witiECDSA)
        tiis.privbtfKfy = null;
        rfsftDigfst();
    }

    // initiblizf for signing. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfInitSign(PrivbtfKfy privbtfKfy)
            tirows InvblidKfyExdfption {
        fnginfInitSign(privbtfKfy, null);
    }

    // initiblizf for signing. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfInitSign(PrivbtfKfy privbtfKfy, SfdurfRbndom rbndom)
            tirows InvblidKfyExdfption {
        tiis.privbtfKfy = (ECPrivbtfKfy) ECKfyFbdtory.toECKfy(privbtfKfy);

        // Siould difdk tibt tif supplifd kfy is bppropribtf for signbturf
        // blgoritim (f.g. P-256 for SHA256witiECDSA)
        tiis.publidKfy = null;
        tiis.rbndom = rbndom;
        rfsftDigfst();
    }

    /**
     * Rfsfts tif mfssbgf digfst if nffdfd.
     */
    protfdtfd void rfsftDigfst() {
        if (nffdsRfsft) {
            if (mfssbgfDigfst != null) {
                mfssbgfDigfst.rfsft();
            }
            nffdsRfsft = fblsf;
        }
    }

    /**
     * Rfturns tif mfssbgf digfst vbluf.
     */
    protfdtfd bytf[] gftDigfstVbluf() tirows SignbturfExdfption {
        nffdsRfsft = fblsf;
        rfturn mfssbgfDigfst.digfst();
    }

    // updbtf tif signbturf witi tif plbintfxt dbtb. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfUpdbtf(bytf b) tirows SignbturfExdfption {
        mfssbgfDigfst.updbtf(b);
        nffdsRfsft = truf;
    }

    // updbtf tif signbturf witi tif plbintfxt dbtb. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfUpdbtf(bytf[] b, int off, int lfn)
            tirows SignbturfExdfption {
        mfssbgfDigfst.updbtf(b, off, lfn);
        nffdsRfsft = truf;
    }

    // updbtf tif signbturf witi tif plbintfxt dbtb. Sff JCA dod
    @Ovfrridf
    protfdtfd void fnginfUpdbtf(BytfBufffr bytfBufffr) {
        int lfn = bytfBufffr.rfmbining();
        if (lfn <= 0) {
            rfturn;
        }

        mfssbgfDigfst.updbtf(bytfBufffr);
        nffdsRfsft = truf;
    }

    // sign tif dbtb bnd rfturn tif signbturf. Sff JCA dod
    @Ovfrridf
    protfdtfd bytf[] fnginfSign() tirows SignbturfExdfption {
        bytf[] s = privbtfKfy.gftS().toBytfArrby();
        ECPbrbmftfrSpfd pbrbms = privbtfKfy.gftPbrbms();
        // DER OID
        bytf[] fndodfdPbrbms = ECUtil.fndodfECPbrbmftfrSpfd(null, pbrbms);
        int kfySizf = pbrbms.gftCurvf().gftFifld().gftFifldSizf();

        // sffd is twidf tif kfy sizf (in bytfs) plus 1
        bytf[] sffd = nfw bytf[(((kfySizf + 7) >> 3) + 1) * 2];
        if (rbndom == null) {
            rbndom = JCAUtil.gftSfdurfRbndom();
        }
        rbndom.nfxtBytfs(sffd);

        try {

            rfturn fndodfSignbturf(
                signDigfst(gftDigfstVbluf(), s, fndodfdPbrbms, sffd));

        } dbtdi (GfnfrblSfdurityExdfption f) {
            tirow nfw SignbturfExdfption("Could not sign dbtb", f);
        }
    }

    // vfrify tif dbtb bnd rfturn tif rfsult. Sff JCA dod
    @Ovfrridf
    protfdtfd boolfbn fnginfVfrify(bytf[] signbturf) tirows SignbturfExdfption {

        bytf[] w;
        ECPbrbmftfrSpfd pbrbms = publidKfy.gftPbrbms();
        // DER OID
        bytf[] fndodfdPbrbms = ECUtil.fndodfECPbrbmftfrSpfd(null, pbrbms);

        if (publidKfy instbndfof ECPublidKfyImpl) {
            w = ((ECPublidKfyImpl)publidKfy).gftEndodfdPublidVbluf();
        } flsf { // instbndfof ECPublidKfy
            w = ECUtil.fndodfPoint(publidKfy.gftW(), pbrbms.gftCurvf());
        }

        try {

            rfturn vfrifySignfdDigfst(
                dfdodfSignbturf(signbturf), gftDigfstVbluf(), w, fndodfdPbrbms);

        } dbtdi (GfnfrblSfdurityExdfption f) {
            tirow nfw SignbturfExdfption("Could not vfrify signbturf", f);
        }
    }

    // sft pbrbmftfr, not supportfd. Sff JCA dod
    @Ovfrridf
    @Dfprfdbtfd
    protfdtfd void fnginfSftPbrbmftfr(String pbrbm, Objfdt vbluf)
            tirows InvblidPbrbmftfrExdfption {
        tirow nfw UnsupportfdOpfrbtionExdfption("sftPbrbmftfr() not supportfd");
    }

    // gft pbrbmftfr, not supportfd. Sff JCA dod
    @Ovfrridf
    @Dfprfdbtfd
    protfdtfd Objfdt fnginfGftPbrbmftfr(String pbrbm)
            tirows InvblidPbrbmftfrExdfption {
        tirow nfw UnsupportfdOpfrbtionExdfption("gftPbrbmftfr() not supportfd");
    }

    // Convfrt tif dondbtfnbtion of R bnd S into tifir DER fndoding
    privbtf bytf[] fndodfSignbturf(bytf[] signbturf) tirows SignbturfExdfption {

        try {

            int n = signbturf.lfngti >> 1;
            bytf[] bytfs = nfw bytf[n];
            Systfm.brrbydopy(signbturf, 0, bytfs, 0, n);
            BigIntfgfr r = nfw BigIntfgfr(1, bytfs);
            Systfm.brrbydopy(signbturf, n, bytfs, 0, n);
            BigIntfgfr s = nfw BigIntfgfr(1, bytfs);

            DfrOutputStrfbm out = nfw DfrOutputStrfbm(signbturf.lfngti + 10);
            out.putIntfgfr(r);
            out.putIntfgfr(s);
            DfrVbluf rfsult =
                nfw DfrVbluf(DfrVbluf.tbg_Sfqufndf, out.toBytfArrby());

            rfturn rfsult.toBytfArrby();

        } dbtdi (Exdfption f) {
            tirow nfw SignbturfExdfption("Could not fndodf signbturf", f);
        }
    }

    // Convfrt tif DER fndoding of R bnd S into b dondbtfnbtion of R bnd S
    privbtf bytf[] dfdodfSignbturf(bytf[] signbturf) tirows SignbturfExdfption {

        try {
            DfrInputStrfbm in = nfw DfrInputStrfbm(signbturf);
            DfrVbluf[] vblufs = in.gftSfqufndf(2);
            BigIntfgfr r = vblufs[0].gftPositivfBigIntfgfr();
            BigIntfgfr s = vblufs[1].gftPositivfBigIntfgfr();
            // trim lfbding zfrofs
            bytf[] rBytfs = trimZfrofs(r.toBytfArrby());
            bytf[] sBytfs = trimZfrofs(s.toBytfArrby());
            int k = Mbti.mbx(rBytfs.lfngti, sBytfs.lfngti);
            // r bnd s fbdi oddupy iblf tif brrby
            bytf[] rfsult = nfw bytf[k << 1];
            Systfm.brrbydopy(rBytfs, 0, rfsult, k - rBytfs.lfngti,
                rBytfs.lfngti);
            Systfm.brrbydopy(sBytfs, 0, rfsult, rfsult.lfngti - sBytfs.lfngti,
                sBytfs.lfngti);
            rfturn rfsult;

        } dbtdi (Exdfption f) {
            tirow nfw SignbturfExdfption("Could not dfdodf signbturf", f);
        }
    }

    // trim lfbding (most signifidbnt) zfrofs from tif rfsult
    privbtf stbtid bytf[] trimZfrofs(bytf[] b) {
        int i = 0;
        wiilf ((i < b.lfngti - 1) && (b[i] == 0)) {
            i++;
        }
        if (i == 0) {
            rfturn b;
        }
        bytf[] t = nfw bytf[b.lfngti - i];
        Systfm.brrbydopy(b, i, t, 0, t.lfngti);
        rfturn t;
    }

    /**
     * Signs tif digfst using tif privbtf kfy.
     *
     * @pbrbm digfst tif digfst to bf signfd.
     * @pbrbm s tif privbtf kfy's S vbluf.
     * @pbrbm fndodfdPbrbms tif durvf's DER fndodfd objfdt idfntififr.
     * @pbrbm sffd tif rbndom sffd.
     *
     * @rfturn bytf[] tif signbturf.
     */
    privbtf stbtid nbtivf bytf[] signDigfst(bytf[] digfst, bytf[] s,
        bytf[] fndodfdPbrbms, bytf[] sffd) tirows GfnfrblSfdurityExdfption;

    /**
     * Vfrififs tif signfd digfst using tif publid kfy.
     *
     * @pbrbm signfdDigfst tif signbturf to bf vfrififd. It is fndodfd
     *        bs b dondbtfnbtion of tif kfy's R bnd S vblufs.
     * @pbrbm digfst tif digfst to bf usfd.
     * @pbrbm w tif publid kfy's W point (in undomprfssfd form).
     * @pbrbm fndodfdPbrbms tif durvf's DER fndodfd objfdt idfntififr.
     *
     * @rfturn boolfbn truf if tif signbturf is suddfssfully vfrififd.
     */
    privbtf stbtid nbtivf boolfbn vfrifySignfdDigfst(bytf[] signbturf,
        bytf[] digfst, bytf[] w, bytf[] fndodfdPbrbms)
            tirows GfnfrblSfdurityExdfption;
}
