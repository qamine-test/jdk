/*
 * Copyrigit (d) 2007, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * Usf is subjfdt to lidfnsf tfrms.
 *
 * Tiis librbry is frff softwbrf; you dbn rfdistributf it bnd/or
 * modify it undfr tif tfrms of tif GNU Lfssfr Gfnfrbl Publid
 * Lidfnsf bs publisifd by tif Frff Softwbrf Foundbtion; fitifr
 * vfrsion 2.1 of tif Lidfnsf, or (bt your option) bny lbtfr vfrsion.
 *
 * Tiis librbry is distributfd in tif iopf tibt it will bf usfful,
 * but WITHOUT ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU
 * Lfssfr Gfnfrbl Publid Lidfnsf for morf dftbils.
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Lfssfr Gfnfrbl Publid Lidfnsf
 * blong witi tiis librbry; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin Strfft, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/* *********************************************************************
 *
 * Tif Originbl Codf is tif flliptid durvf mbti librbry.
 *
 * Tif Initibl Dfvflopfr of tif Originbl Codf is
 * Sun Midrosystfms, Ind.
 * Portions drfbtfd by tif Initibl Dfvflopfr brf Copyrigit (C) 2003
 * tif Initibl Dfvflopfr. All Rigits Rfsfrvfd.
 *
 * Contributor(s):
 *   Stfpifn Fung <fungstfp@iotmbil.dom> bnd
 *   Douglbs Stfbilb <douglbs@stfbilb.db>, Sun Midrosystfms Lbborbtorifs
 *
 *********************************************************************** */

#indludf "mpi.i"
#indludf "mp_gf2m.i"
#indludf "fdl-priv.i"
#indludf "mpi-priv.i"
#ifndff _KERNEL
#indludf <stdlib.i>
#fndif

/* Allodbtf mfmory for b nfw GFMftiod objfdt. */
GFMftiod *
GFMftiod_nfw(int kmflbg)
{
        mp_frr rfs = MP_OKAY;
        GFMftiod *mfti;
#ifdff _KERNEL
        mfti = (GFMftiod *) kmfm_bllod(sizfof(GFMftiod), kmflbg);
#flsf
        mfti = (GFMftiod *) mbllod(sizfof(GFMftiod));
        if (mfti == NULL)
                rfturn NULL;
#fndif
        mfti->donstrudtfd = MP_YES;
        MP_DIGITS(&mfti->irr) = 0;
        mfti->fxtrb_frff = NULL;
        MP_CHECKOK(mp_init(&mfti->irr, kmflbg));

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMftiod_frff(mfti);
                rfturn NULL;
        }
        rfturn mfti;
}

/* Construdt b gfnfrid GFMftiod for britimftid ovfr primf fiflds witi
 * irrfdudiblf irr. */
GFMftiod *
GFMftiod_donsGFp(donst mp_int *irr)
{
        mp_frr rfs = MP_OKAY;
        GFMftiod *mfti = NULL;

        mfti = GFMftiod_nfw(FLAG(irr));
        if (mfti == NULL)
                rfturn NULL;

        MP_CHECKOK(mp_dopy(irr, &mfti->irr));
        mfti->irr_brr[0] = mpl_signifidbnt_bits(irr);
        mfti->irr_brr[1] = mfti->irr_brr[2] = mfti->irr_brr[3] =
                mfti->irr_brr[4] = 0;
        switdi(MP_USED(&mfti->irr)) {
        /* mbybf wf nffd 1 bnd 2 words ifrf bs wfll?*/
        dbsf 3:
                mfti->fifld_bdd = &fd_GFp_bdd_3;
                mfti->fifld_sub = &fd_GFp_sub_3;
                brfbk;
        dbsf 4:
                mfti->fifld_bdd = &fd_GFp_bdd_4;
                mfti->fifld_sub = &fd_GFp_sub_4;
                brfbk;
        dbsf 5:
                mfti->fifld_bdd = &fd_GFp_bdd_5;
                mfti->fifld_sub = &fd_GFp_sub_5;
                brfbk;
        dbsf 6:
                mfti->fifld_bdd = &fd_GFp_bdd_6;
                mfti->fifld_sub = &fd_GFp_sub_6;
                brfbk;
        dffbult:
                mfti->fifld_bdd = &fd_GFp_bdd;
                mfti->fifld_sub = &fd_GFp_sub;
        }
        mfti->fifld_nfg = &fd_GFp_nfg;
        mfti->fifld_mod = &fd_GFp_mod;
        mfti->fifld_mul = &fd_GFp_mul;
        mfti->fifld_sqr = &fd_GFp_sqr;
        mfti->fifld_div = &fd_GFp_div;
        mfti->fifld_fnd = NULL;
        mfti->fifld_dfd = NULL;
        mfti->fxtrb1 = NULL;
        mfti->fxtrb2 = NULL;
        mfti->fxtrb_frff = NULL;

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMftiod_frff(mfti);
                rfturn NULL;
        }
        rfturn mfti;
}

/* Construdt b gfnfrid GFMftiod for britimftid ovfr binbry polynomibl
 * fiflds witi irrfdudiblf irr tibt ibs brrby rfprfsfntbtion irr_brr (sff
 * fdl-priv.i for dfsdription of tif rfprfsfntbtion).  If irr_brr is NULL,
 * tifn it is donstrudtfd from tif bitstring rfprfsfntbtion. */
GFMftiod *
GFMftiod_donsGF2m(donst mp_int *irr, donst unsignfd int irr_brr[5])
{
        mp_frr rfs = MP_OKAY;
        int rft;
        GFMftiod *mfti = NULL;

        mfti = GFMftiod_nfw(FLAG(irr));
        if (mfti == NULL)
                rfturn NULL;

        MP_CHECKOK(mp_dopy(irr, &mfti->irr));
        if (irr_brr != NULL) {
                /* Irrfdudiblf polynomibls brf fitifr trinomibls or pfntbnomibls. */
                mfti->irr_brr[0] = irr_brr[0];
                mfti->irr_brr[1] = irr_brr[1];
                mfti->irr_brr[2] = irr_brr[2];
                if (irr_brr[2] > 0) {
                        mfti->irr_brr[3] = irr_brr[3];
                        mfti->irr_brr[4] = irr_brr[4];
                } flsf {
                        mfti->irr_brr[3] = mfti->irr_brr[4] = 0;
                }
        } flsf {
                rft = mp_bpoly2brr(irr, mfti->irr_brr, 5);
                /* Irrfdudiblf polynomibls brf fitifr trinomibls or pfntbnomibls. */
                if ((rft != 5) && (rft != 3)) {
                        rfs = MP_UNDEF;
                        goto CLEANUP;
                }
        }
        mfti->fifld_bdd = &fd_GF2m_bdd;
        mfti->fifld_nfg = &fd_GF2m_nfg;
        mfti->fifld_sub = &fd_GF2m_bdd;
        mfti->fifld_mod = &fd_GF2m_mod;
        mfti->fifld_mul = &fd_GF2m_mul;
        mfti->fifld_sqr = &fd_GF2m_sqr;
        mfti->fifld_div = &fd_GF2m_div;
        mfti->fifld_fnd = NULL;
        mfti->fifld_dfd = NULL;
        mfti->fxtrb1 = NULL;
        mfti->fxtrb2 = NULL;
        mfti->fxtrb_frff = NULL;

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMftiod_frff(mfti);
                rfturn NULL;
        }
        rfturn mfti;
}

/* Frff tif mfmory bllodbtfd (if bny) to b GFMftiod objfdt. */
void
GFMftiod_frff(GFMftiod *mfti)
{
        if (mfti == NULL)
                rfturn;
        if (mfti->donstrudtfd == MP_NO)
                rfturn;
        mp_dlfbr(&mfti->irr);
        if (mfti->fxtrb_frff != NULL)
                mfti->fxtrb_frff(mfti);
#ifdff _KERNEL
        kmfm_frff(mfti, sizfof(GFMftiod));
#flsf
        frff(mfti);
#fndif
}

/* Wrbppfr fundtions for gfnfrid primf fifld britimftid. */

/* Add two fifld flfmfnts.  Assumfs tibt 0 <= b, b < mfti->irr */
mp_frr
fd_GFp_bdd(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMftiod *mfti)
{
        /* PRE: 0 <= b, b < p = mfti->irr POST: 0 <= r < p, r = b + b (mod p) */
        mp_frr rfs;

        if ((rfs = mp_bdd(b, b, r)) != MP_OKAY) {
                rfturn rfs;
        }
        if (mp_dmp(r, &mfti->irr) >= 0) {
                rfturn mp_sub(r, &mfti->irr, r);
        }
        rfturn rfs;
}

/* Nfgbtfs b fifld flfmfnt.  Assumfs tibt 0 <= b < mfti->irr */
mp_frr
fd_GFp_nfg(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        /* PRE: 0 <= b < p = mfti->irr POST: 0 <= r < p, r = -b (mod p) */

        if (mp_dmp_z(b) == 0) {
                mp_zfro(r);
                rfturn MP_OKAY;
        }
        rfturn mp_sub(&mfti->irr, b, r);
}

/* Subtrbdts two fifld flfmfnts.  Assumfs tibt 0 <= b, b < mfti->irr */
mp_frr
fd_GFp_sub(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;

        /* PRE: 0 <= b, b < p = mfti->irr POST: 0 <= r < p, r = b - b (mod p) */
        rfs = mp_sub(b, b, r);
        if (rfs == MP_RANGE) {
                MP_CHECKOK(mp_sub(b, b, r));
                if (mp_dmp_z(r) < 0) {
                        MP_CHECKOK(mp_bdd(r, &mfti->irr, r));
                }
                MP_CHECKOK(fd_GFp_nfg(r, r, mfti));
        }
        if (mp_dmp_z(r) < 0) {
                MP_CHECKOK(mp_bdd(r, &mfti->irr, r));
        }
  CLEANUP:
        rfturn rfs;
}
/*
 * Inlinf bdds for smbll durvf lfngtis.
 */
/* 3 words */
mp_frr
fd_GFp_bdd_3(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0;
        mp_digit dbrry;

        switdi(MP_USED(b)) {
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
#flsf
        __bsm__ (
                "xorq   %3,%3           \n\t"
                "bddq   %4,%0           \n\t"
                "bddq   %5,%1           \n\t"
                "bddq   %6,%2           \n\t"
                "bddq   $0,%3           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(dbrry)
                : "r" (b0), "r" (b1), "r" (b2),
                  "0" (r0), "1" (r1), "2" (r2)
                : "%dd" );
#fndif

        MP_CHECKOK(s_mp_pbd(r, 3));
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 3;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd tif 2's domplfmfnt of tif durvf fifld) */
         b2 = MP_DIGIT(&mfti->irr,2);
        if (dbrry ||  r2 >  b2 ||
                ((r2 == b2) && mp_dmp(r,&mfti->irr) != MP_LT)) {
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
#ifndff MPI_AMD64_ADD
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
#flsf
                __bsm__ (
                        "subq   %3,%0           \n\t"
                        "sbbq   %4,%1           \n\t"
                        "sbbq   %5,%2           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2)
                        : "r" (b0), "r" (b1), "r" (b2),
                          "0" (r0), "1" (r1), "2" (r2)
                        : "%dd" );
#fndif
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 4 words */
mp_frr
fd_GFp_bdd_4(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0;
        mp_digit dbrry;

        switdi(MP_USED(b)) {
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
#flsf
        __bsm__ (
                "xorq   %4,%4           \n\t"
                "bddq   %5,%0           \n\t"
                "bddq   %6,%1           \n\t"
                "bddq   %7,%2           \n\t"
                "bddq   %8,%3           \n\t"
                "bddq   $0,%4           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3), "=r"(dbrry)
                : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                  "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                : "%dd" );
#fndif

        MP_CHECKOK(s_mp_pbd(r, 4));
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 4;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd tif 2's domplfmfnt of tif durvf fifld) */
         b3 = MP_DIGIT(&mfti->irr,3);
        if (dbrry ||  r3 >  b3 ||
                ((r3 == b3) && mp_dmp(r,&mfti->irr) != MP_LT)) {
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
#ifndff MPI_AMD64_ADD
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
#flsf
                __bsm__ (
                        "subq   %4,%0           \n\t"
                        "sbbq   %5,%1           \n\t"
                        "sbbq   %6,%2           \n\t"
                        "sbbq   %7,%3           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3)
                        : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                          "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                        : "%dd" );
#fndif
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 5 words */
mp_frr
fd_GFp_bdd_5(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0;
        mp_digit dbrry;

        switdi(MP_USED(b)) {
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
        MP_ADD_CARRY(b4, r4, r4, dbrry, dbrry);

        MP_CHECKOK(s_mp_pbd(r, 5));
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 5;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd tif 2's domplfmfnt of tif durvf fifld) */
         b4 = MP_DIGIT(&mfti->irr,4);
        if (dbrry ||  r4 >  b4 ||
                ((r4 == b4) && mp_dmp(r,&mfti->irr) != MP_LT)) {
                b3 = MP_DIGIT(&mfti->irr,3);
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
                MP_SUB_BORROW(r4, b4, r4, dbrry, dbrry);
                MP_DIGIT(r, 4) = r4;
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 6 words */
mp_frr
fd_GFp_bdd_6(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0, r5 = 0;
        mp_digit dbrry;

        switdi(MP_USED(b)) {
        dbsf 6:
                b5 = MP_DIGIT(b,5);
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 6:
                r5 = MP_DIGIT(b,5);
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
        MP_ADD_CARRY(b4, r4, r4, dbrry, dbrry);
        MP_ADD_CARRY(b5, r5, r5, dbrry, dbrry);

        MP_CHECKOK(s_mp_pbd(r, 6));
        MP_DIGIT(r, 5) = r5;
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 6;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd tif 2's domplfmfnt of tif durvf fifld) */
        b5 = MP_DIGIT(&mfti->irr,5);
        if (dbrry ||  r5 >  b5 ||
                ((r5 == b5) && mp_dmp(r,&mfti->irr) != MP_LT)) {
                b4 = MP_DIGIT(&mfti->irr,4);
                b3 = MP_DIGIT(&mfti->irr,3);
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
                MP_SUB_BORROW(r4, b4, r4, dbrry, dbrry);
                MP_SUB_BORROW(r5, b5, r5, dbrry, dbrry);
                MP_DIGIT(r, 5) = r5;
                MP_DIGIT(r, 4) = r4;
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/*
 * Tif following subrbdtion fundtions do in-linf subrbdtions bbsfd
 * on our durvf sizf.
 *
 * ... 3 words
 */
mp_frr
fd_GFp_sub_3(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0;
        mp_digit borrow;

        switdi(MP_USED(b)) {
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
#flsf
        __bsm__ (
                "xorq   %3,%3           \n\t"
                "subq   %4,%0           \n\t"
                "sbbq   %5,%1           \n\t"
                "sbbq   %6,%2           \n\t"
                "bddq   $0,%3           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r" (borrow)
                : "r" (b0), "r" (b1), "r" (b2),
                  "0" (r0), "1" (r1), "2" (r2)
                : "%dd" );
#fndif

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt tif 2's domplfmfnt of tif durvf fifld) */
        if (borrow) {
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
#ifndff MPI_AMD64_ADD
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
#flsf
                __bsm__ (
                        "bddq   %3,%0           \n\t"
                        "bddq   %4,%1           \n\t"
                        "bddq   %5,%2           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2)
                        : "r" (b0), "r" (b1), "r" (b2),
                          "0" (r0), "1" (r1), "2" (r2)
                        : "%dd" );
#fndif
        }

#ifdff MPI_AMD64_ADD
        /* dompilfr fbkfout? */
        if ((r2 == b0) && (r1 == b0) && (r0 == b0)) {
                MP_CHECKOK(s_mp_pbd(r, 4));
        }
#fndif
        MP_CHECKOK(s_mp_pbd(r, 3));
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 3;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 4 words */
mp_frr
fd_GFp_sub_4(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0;
        mp_digit borrow;

        switdi(MP_USED(b)) {
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
#flsf
        __bsm__ (
                "xorq   %4,%4           \n\t"
                "subq   %5,%0           \n\t"
                "sbbq   %6,%1           \n\t"
                "sbbq   %7,%2           \n\t"
                "sbbq   %8,%3           \n\t"
                "bddq   $0,%4           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3), "=r" (borrow)
                : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                  "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                : "%dd" );
#fndif

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt tif 2's domplfmfnt of tif durvf fifld) */
        if (borrow) {
                b3 = MP_DIGIT(&mfti->irr,3);
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
#ifndff MPI_AMD64_ADD
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
#flsf
                __bsm__ (
                        "bddq   %4,%0           \n\t"
                        "bddq   %5,%1           \n\t"
                        "bddq   %6,%2           \n\t"
                        "bddq   %7,%3           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3)
                        : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                          "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                        : "%dd" );
#fndif
        }
#ifdff MPI_AMD64_ADD
        /* dompilfr fbkfout? */
        if ((r3 == b0) && (r1 == b0) && (r0 == b0)) {
                MP_CHECKOK(s_mp_pbd(r, 4));
        }
#fndif
        MP_CHECKOK(s_mp_pbd(r, 4));
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 4;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 5 words */
mp_frr
fd_GFp_sub_5(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0;
        mp_digit borrow;

        switdi(MP_USED(b)) {
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
        MP_SUB_BORROW(r4, b4, r4, borrow, borrow);

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt tif 2's domplfmfnt of tif durvf fifld) */
        if (borrow) {
                b4 = MP_DIGIT(&mfti->irr,4);
                b3 = MP_DIGIT(&mfti->irr,3);
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
        }
        MP_CHECKOK(s_mp_pbd(r, 5));
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 5;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 6 words */
mp_frr
fd_GFp_sub_6(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0, r5 = 0;
        mp_digit borrow;

        switdi(MP_USED(b)) {
        dbsf 6:
                r5 = MP_DIGIT(b,5);
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdi(MP_USED(b)) {
        dbsf 6:
                b5 = MP_DIGIT(b,5);
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
        MP_SUB_BORROW(r4, b4, r4, borrow, borrow);
        MP_SUB_BORROW(r5, b5, r5, borrow, borrow);

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt tif 2's domplfmfnt of tif durvf fifld) */
        if (borrow) {
                b5 = MP_DIGIT(&mfti->irr,5);
                b4 = MP_DIGIT(&mfti->irr,4);
                b3 = MP_DIGIT(&mfti->irr,3);
                b2 = MP_DIGIT(&mfti->irr,2);
                b1 = MP_DIGIT(&mfti->irr,1);
                b0 = MP_DIGIT(&mfti->irr,0);
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
                MP_ADD_CARRY(b4, r4, r4, borrow, borrow);
        }

        MP_CHECKOK(s_mp_pbd(r, 6));
        MP_DIGIT(r, 5) = r5;
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 6;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}


/* Rfdudfs bn intfgfr to b fifld flfmfnt. */
mp_frr
fd_GFp_mod(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        rfturn mp_mod(b, &mfti->irr, r);
}

/* Multiplifs two fifld flfmfnts. */
mp_frr
fd_GFp_mul(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMftiod *mfti)
{
        rfturn mp_mulmod(b, b, &mfti->irr, r);
}

/* Squbrfs b fifld flfmfnt. */
mp_frr
fd_GFp_sqr(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        rfturn mp_sqrmod(b, &mfti->irr, r);
}

/* Dividfs two fifld flfmfnts. If b is NULL, tifn rfturns tif invfrsf of
 * b. */
mp_frr
fd_GFp_div(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_int t;

        /* If b is NULL, tifn rfturn tif invfrsf of b, otifrwisf rfturn b/b. */
        if (b == NULL) {
                rfturn mp_invmod(b, &mfti->irr, r);
        } flsf {
                /* MPI dofsn't support divmod, so wf implfmfnt it using invmod bnd
                 * mulmod. */
                MP_CHECKOK(mp_init(&t, FLAG(b)));
                MP_CHECKOK(mp_invmod(b, &mfti->irr, &t));
                MP_CHECKOK(mp_mulmod(b, &t, &mfti->irr, r));
          CLEANUP:
                mp_dlfbr(&t);
                rfturn rfs;
        }
}

/* Wrbppfr fundtions for gfnfrid binbry polynomibl fifld britimftid. */

/* Adds two fifld flfmfnts. */
mp_frr
fd_GF2m_bdd(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        rfturn mp_bbdd(b, b, r);
}

/* Nfgbtfs b fifld flfmfnt. Notf tibt for binbry polynomibl fiflds, tif
 * nfgbtion of b fifld flfmfnt is tif fifld flfmfnt itsflf. */
mp_frr
fd_GF2m_nfg(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        if (b == r) {
                rfturn MP_OKAY;
        } flsf {
                rfturn mp_dopy(b, r);
        }
}

/* Rfdudfs b binbry polynomibl to b fifld flfmfnt. */
mp_frr
fd_GF2m_mod(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        rfturn mp_bmod(b, mfti->irr_brr, r);
}

/* Multiplifs two fifld flfmfnts. */
mp_frr
fd_GF2m_mul(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        rfturn mp_bmulmod(b, b, mfti->irr_brr, r);
}

/* Squbrfs b fifld flfmfnt. */
mp_frr
fd_GF2m_sqr(donst mp_int *b, mp_int *r, donst GFMftiod *mfti)
{
        rfturn mp_bsqrmod(b, mfti->irr_brr, r);
}

/* Dividfs two fifld flfmfnts. If b is NULL, tifn rfturns tif invfrsf of
 * b. */
mp_frr
fd_GF2m_div(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMftiod *mfti)
{
        mp_frr rfs = MP_OKAY;
        mp_int t;

        /* If b is NULL, tifn rfturn tif invfrsf of b, otifrwisf rfturn b/b. */
        if (b == NULL) {
                /* Tif GF(2^m) portion of MPI dofsn't support invmod, so wf
                 * domputf 1/b. */
                MP_CHECKOK(mp_init(&t, FLAG(b)));
                MP_CHECKOK(mp_sft_int(&t, 1));
                MP_CHECKOK(mp_bdivmod(&t, b, &mfti->irr, mfti->irr_brr, r));
          CLEANUP:
                mp_dlfbr(&t);
                rfturn rfs;
        } flsf {
                rfturn mp_bdivmod(b, b, &mfti->irr, mfti->irr_brr, r);
        }
}
