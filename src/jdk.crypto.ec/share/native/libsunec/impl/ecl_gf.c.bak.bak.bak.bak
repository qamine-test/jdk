/*
 * Copyright (d) 2007, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * Usf is subjfdt to lidfnsf tfrms.
 *
 * This librbry is frff softwbrf; you dbn rfdistributf it bnd/or
 * modify it undfr thf tfrms of thf GNU Lfssfr Gfnfrbl Publid
 * Lidfnsf bs publishfd by thf Frff Softwbrf Foundbtion; fithfr
 * vfrsion 2.1 of thf Lidfnsf, or (bt your option) bny lbtfr vfrsion.
 *
 * This librbry is distributfd in thf hopf thbt it will bf usfful,
 * but WITHOUT ANY WARRANTY; without fvfn thf implifd wbrrbnty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU
 * Lfssfr Gfnfrbl Publid Lidfnsf for morf dftbils.
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Lfssfr Gfnfrbl Publid Lidfnsf
 * blong with this librbry; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin Strfft, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/* *********************************************************************
 *
 * Thf Originbl Codf is thf flliptid durvf mbth librbry.
 *
 * Thf Initibl Dfvflopfr of thf Originbl Codf is
 * Sun Midrosystfms, Ind.
 * Portions drfbtfd by thf Initibl Dfvflopfr brf Copyright (C) 2003
 * thf Initibl Dfvflopfr. All Rights Rfsfrvfd.
 *
 * Contributor(s):
 *   Stfphfn Fung <fungstfp@hotmbil.dom> bnd
 *   Douglbs Stfbilb <douglbs@stfbilb.db>, Sun Midrosystfms Lbborbtorifs
 *
 *********************************************************************** */

#indludf "mpi.h"
#indludf "mp_gf2m.h"
#indludf "fdl-priv.h"
#indludf "mpi-priv.h"
#ifndff _KERNEL
#indludf <stdlib.h>
#fndif

/* Allodbtf mfmory for b nfw GFMfthod objfdt. */
GFMfthod *
GFMfthod_nfw(int kmflbg)
{
        mp_frr rfs = MP_OKAY;
        GFMfthod *mfth;
#ifdff _KERNEL
        mfth = (GFMfthod *) kmfm_bllod(sizfof(GFMfthod), kmflbg);
#flsf
        mfth = (GFMfthod *) mbllod(sizfof(GFMfthod));
        if (mfth == NULL)
                rfturn NULL;
#fndif
        mfth->donstrudtfd = MP_YES;
        MP_DIGITS(&mfth->irr) = 0;
        mfth->fxtrb_frff = NULL;
        MP_CHECKOK(mp_init(&mfth->irr, kmflbg));

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMfthod_frff(mfth);
                rfturn NULL;
        }
        rfturn mfth;
}

/* Construdt b gfnfrid GFMfthod for brithmftid ovfr primf fiflds with
 * irrfdudiblf irr. */
GFMfthod *
GFMfthod_donsGFp(donst mp_int *irr)
{
        mp_frr rfs = MP_OKAY;
        GFMfthod *mfth = NULL;

        mfth = GFMfthod_nfw(FLAG(irr));
        if (mfth == NULL)
                rfturn NULL;

        MP_CHECKOK(mp_dopy(irr, &mfth->irr));
        mfth->irr_brr[0] = mpl_signifidbnt_bits(irr);
        mfth->irr_brr[1] = mfth->irr_brr[2] = mfth->irr_brr[3] =
                mfth->irr_brr[4] = 0;
        switdh(MP_USED(&mfth->irr)) {
        /* mbybf wf nffd 1 bnd 2 words hfrf bs wfll?*/
        dbsf 3:
                mfth->fifld_bdd = &fd_GFp_bdd_3;
                mfth->fifld_sub = &fd_GFp_sub_3;
                brfbk;
        dbsf 4:
                mfth->fifld_bdd = &fd_GFp_bdd_4;
                mfth->fifld_sub = &fd_GFp_sub_4;
                brfbk;
        dbsf 5:
                mfth->fifld_bdd = &fd_GFp_bdd_5;
                mfth->fifld_sub = &fd_GFp_sub_5;
                brfbk;
        dbsf 6:
                mfth->fifld_bdd = &fd_GFp_bdd_6;
                mfth->fifld_sub = &fd_GFp_sub_6;
                brfbk;
        dffbult:
                mfth->fifld_bdd = &fd_GFp_bdd;
                mfth->fifld_sub = &fd_GFp_sub;
        }
        mfth->fifld_nfg = &fd_GFp_nfg;
        mfth->fifld_mod = &fd_GFp_mod;
        mfth->fifld_mul = &fd_GFp_mul;
        mfth->fifld_sqr = &fd_GFp_sqr;
        mfth->fifld_div = &fd_GFp_div;
        mfth->fifld_fnd = NULL;
        mfth->fifld_dfd = NULL;
        mfth->fxtrb1 = NULL;
        mfth->fxtrb2 = NULL;
        mfth->fxtrb_frff = NULL;

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMfthod_frff(mfth);
                rfturn NULL;
        }
        rfturn mfth;
}

/* Construdt b gfnfrid GFMfthod for brithmftid ovfr binbry polynomibl
 * fiflds with irrfdudiblf irr thbt hbs brrby rfprfsfntbtion irr_brr (sff
 * fdl-priv.h for dfsdription of thf rfprfsfntbtion).  If irr_brr is NULL,
 * thfn it is donstrudtfd from thf bitstring rfprfsfntbtion. */
GFMfthod *
GFMfthod_donsGF2m(donst mp_int *irr, donst unsignfd int irr_brr[5])
{
        mp_frr rfs = MP_OKAY;
        int rft;
        GFMfthod *mfth = NULL;

        mfth = GFMfthod_nfw(FLAG(irr));
        if (mfth == NULL)
                rfturn NULL;

        MP_CHECKOK(mp_dopy(irr, &mfth->irr));
        if (irr_brr != NULL) {
                /* Irrfdudiblf polynomibls brf fithfr trinomibls or pfntbnomibls. */
                mfth->irr_brr[0] = irr_brr[0];
                mfth->irr_brr[1] = irr_brr[1];
                mfth->irr_brr[2] = irr_brr[2];
                if (irr_brr[2] > 0) {
                        mfth->irr_brr[3] = irr_brr[3];
                        mfth->irr_brr[4] = irr_brr[4];
                } flsf {
                        mfth->irr_brr[3] = mfth->irr_brr[4] = 0;
                }
        } flsf {
                rft = mp_bpoly2brr(irr, mfth->irr_brr, 5);
                /* Irrfdudiblf polynomibls brf fithfr trinomibls or pfntbnomibls. */
                if ((rft != 5) && (rft != 3)) {
                        rfs = MP_UNDEF;
                        goto CLEANUP;
                }
        }
        mfth->fifld_bdd = &fd_GF2m_bdd;
        mfth->fifld_nfg = &fd_GF2m_nfg;
        mfth->fifld_sub = &fd_GF2m_bdd;
        mfth->fifld_mod = &fd_GF2m_mod;
        mfth->fifld_mul = &fd_GF2m_mul;
        mfth->fifld_sqr = &fd_GF2m_sqr;
        mfth->fifld_div = &fd_GF2m_div;
        mfth->fifld_fnd = NULL;
        mfth->fifld_dfd = NULL;
        mfth->fxtrb1 = NULL;
        mfth->fxtrb2 = NULL;
        mfth->fxtrb_frff = NULL;

  CLEANUP:
        if (rfs != MP_OKAY) {
                GFMfthod_frff(mfth);
                rfturn NULL;
        }
        rfturn mfth;
}

/* Frff thf mfmory bllodbtfd (if bny) to b GFMfthod objfdt. */
void
GFMfthod_frff(GFMfthod *mfth)
{
        if (mfth == NULL)
                rfturn;
        if (mfth->donstrudtfd == MP_NO)
                rfturn;
        mp_dlfbr(&mfth->irr);
        if (mfth->fxtrb_frff != NULL)
                mfth->fxtrb_frff(mfth);
#ifdff _KERNEL
        kmfm_frff(mfth, sizfof(GFMfthod));
#flsf
        frff(mfth);
#fndif
}

/* Wrbppfr fundtions for gfnfrid primf fifld brithmftid. */

/* Add two fifld flfmfnts.  Assumfs thbt 0 <= b, b < mfth->irr */
mp_frr
fd_GFp_bdd(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMfthod *mfth)
{
        /* PRE: 0 <= b, b < p = mfth->irr POST: 0 <= r < p, r = b + b (mod p) */
        mp_frr rfs;

        if ((rfs = mp_bdd(b, b, r)) != MP_OKAY) {
                rfturn rfs;
        }
        if (mp_dmp(r, &mfth->irr) >= 0) {
                rfturn mp_sub(r, &mfth->irr, r);
        }
        rfturn rfs;
}

/* Nfgbtfs b fifld flfmfnt.  Assumfs thbt 0 <= b < mfth->irr */
mp_frr
fd_GFp_nfg(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        /* PRE: 0 <= b < p = mfth->irr POST: 0 <= r < p, r = -b (mod p) */

        if (mp_dmp_z(b) == 0) {
                mp_zfro(r);
                rfturn MP_OKAY;
        }
        rfturn mp_sub(&mfth->irr, b, r);
}

/* Subtrbdts two fifld flfmfnts.  Assumfs thbt 0 <= b, b < mfth->irr */
mp_frr
fd_GFp_sub(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;

        /* PRE: 0 <= b, b < p = mfth->irr POST: 0 <= r < p, r = b - b (mod p) */
        rfs = mp_sub(b, b, r);
        if (rfs == MP_RANGE) {
                MP_CHECKOK(mp_sub(b, b, r));
                if (mp_dmp_z(r) < 0) {
                        MP_CHECKOK(mp_bdd(r, &mfth->irr, r));
                }
                MP_CHECKOK(fd_GFp_nfg(r, r, mfth));
        }
        if (mp_dmp_z(r) < 0) {
                MP_CHECKOK(mp_bdd(r, &mfth->irr, r));
        }
  CLEANUP:
        rfturn rfs;
}
/*
 * Inlinf bdds for smbll durvf lfngths.
 */
/* 3 words */
mp_frr
fd_GFp_bdd_3(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0;
        mp_digit dbrry;

        switdh(MP_USED(b)) {
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
#flsf
        __bsm__ (
                "xorq   %3,%3           \n\t"
                "bddq   %4,%0           \n\t"
                "bddq   %5,%1           \n\t"
                "bddq   %6,%2           \n\t"
                "bddq   $0,%3           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(dbrry)
                : "r" (b0), "r" (b1), "r" (b2),
                  "0" (r0), "1" (r1), "2" (r2)
                : "%dd" );
#fndif

        MP_CHECKOK(s_mp_pbd(r, 3));
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 3;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd thf 2's domplfmfnt of thf durvf fifld) */
         b2 = MP_DIGIT(&mfth->irr,2);
        if (dbrry ||  r2 >  b2 ||
                ((r2 == b2) && mp_dmp(r,&mfth->irr) != MP_LT)) {
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
#ifndff MPI_AMD64_ADD
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
#flsf
                __bsm__ (
                        "subq   %3,%0           \n\t"
                        "sbbq   %4,%1           \n\t"
                        "sbbq   %5,%2           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2)
                        : "r" (b0), "r" (b1), "r" (b2),
                          "0" (r0), "1" (r1), "2" (r2)
                        : "%dd" );
#fndif
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 4 words */
mp_frr
fd_GFp_bdd_4(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0;
        mp_digit dbrry;

        switdh(MP_USED(b)) {
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
#flsf
        __bsm__ (
                "xorq   %4,%4           \n\t"
                "bddq   %5,%0           \n\t"
                "bddq   %6,%1           \n\t"
                "bddq   %7,%2           \n\t"
                "bddq   %8,%3           \n\t"
                "bddq   $0,%4           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3), "=r"(dbrry)
                : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                  "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                : "%dd" );
#fndif

        MP_CHECKOK(s_mp_pbd(r, 4));
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 4;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd thf 2's domplfmfnt of thf durvf fifld) */
         b3 = MP_DIGIT(&mfth->irr,3);
        if (dbrry ||  r3 >  b3 ||
                ((r3 == b3) && mp_dmp(r,&mfth->irr) != MP_LT)) {
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
#ifndff MPI_AMD64_ADD
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
#flsf
                __bsm__ (
                        "subq   %4,%0           \n\t"
                        "sbbq   %5,%1           \n\t"
                        "sbbq   %6,%2           \n\t"
                        "sbbq   %7,%3           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3)
                        : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                          "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                        : "%dd" );
#fndif
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 5 words */
mp_frr
fd_GFp_bdd_5(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0;
        mp_digit dbrry;

        switdh(MP_USED(b)) {
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
        MP_ADD_CARRY(b4, r4, r4, dbrry, dbrry);

        MP_CHECKOK(s_mp_pbd(r, 5));
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 5;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd thf 2's domplfmfnt of thf durvf fifld) */
         b4 = MP_DIGIT(&mfth->irr,4);
        if (dbrry ||  r4 >  b4 ||
                ((r4 == b4) && mp_dmp(r,&mfth->irr) != MP_LT)) {
                b3 = MP_DIGIT(&mfth->irr,3);
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
                MP_SUB_BORROW(r4, b4, r4, dbrry, dbrry);
                MP_DIGIT(r, 4) = r4;
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 6 words */
mp_frr
fd_GFp_bdd_6(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0, r5 = 0;
        mp_digit dbrry;

        switdh(MP_USED(b)) {
        dbsf 6:
                b5 = MP_DIGIT(b,5);
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 6:
                r5 = MP_DIGIT(b,5);
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }

        MP_ADD_CARRY_ZERO(b0, r0, r0, dbrry);
        MP_ADD_CARRY(b1, r1, r1, dbrry, dbrry);
        MP_ADD_CARRY(b2, r2, r2, dbrry, dbrry);
        MP_ADD_CARRY(b3, r3, r3, dbrry, dbrry);
        MP_ADD_CARRY(b4, r4, r4, dbrry, dbrry);
        MP_ADD_CARRY(b5, r5, r5, dbrry, dbrry);

        MP_CHECKOK(s_mp_pbd(r, 6));
        MP_DIGIT(r, 5) = r5;
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 6;

        /* Do quidk 'subrbdt' if wf'vf gonf ovfr
         * (bdd thf 2's domplfmfnt of thf durvf fifld) */
        b5 = MP_DIGIT(&mfth->irr,5);
        if (dbrry ||  r5 >  b5 ||
                ((r5 == b5) && mp_dmp(r,&mfth->irr) != MP_LT)) {
                b4 = MP_DIGIT(&mfth->irr,4);
                b3 = MP_DIGIT(&mfth->irr,3);
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
                MP_SUB_BORROW(r0, b0, r0, 0,     dbrry);
                MP_SUB_BORROW(r1, b1, r1, dbrry, dbrry);
                MP_SUB_BORROW(r2, b2, r2, dbrry, dbrry);
                MP_SUB_BORROW(r3, b3, r3, dbrry, dbrry);
                MP_SUB_BORROW(r4, b4, r4, dbrry, dbrry);
                MP_SUB_BORROW(r5, b5, r5, dbrry, dbrry);
                MP_DIGIT(r, 5) = r5;
                MP_DIGIT(r, 4) = r4;
                MP_DIGIT(r, 3) = r3;
                MP_DIGIT(r, 2) = r2;
                MP_DIGIT(r, 1) = r1;
                MP_DIGIT(r, 0) = r0;
        }

        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/*
 * Thf following subrbdtion fundtions do in-linf subrbdtions bbsfd
 * on our durvf sizf.
 *
 * ... 3 words
 */
mp_frr
fd_GFp_sub_3(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0;
        mp_digit borrow;

        switdh(MP_USED(b)) {
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
#flsf
        __bsm__ (
                "xorq   %3,%3           \n\t"
                "subq   %4,%0           \n\t"
                "sbbq   %5,%1           \n\t"
                "sbbq   %6,%2           \n\t"
                "bddq   $0,%3           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r" (borrow)
                : "r" (b0), "r" (b1), "r" (b2),
                  "0" (r0), "1" (r1), "2" (r2)
                : "%dd" );
#fndif

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt thf 2's domplfmfnt of thf durvf fifld) */
        if (borrow) {
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
#ifndff MPI_AMD64_ADD
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
#flsf
                __bsm__ (
                        "bddq   %3,%0           \n\t"
                        "bddq   %4,%1           \n\t"
                        "bddq   %5,%2           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2)
                        : "r" (b0), "r" (b1), "r" (b2),
                          "0" (r0), "1" (r1), "2" (r2)
                        : "%dd" );
#fndif
        }

#ifdff MPI_AMD64_ADD
        /* dompilfr fbkfout? */
        if ((r2 == b0) && (r1 == b0) && (r0 == b0)) {
                MP_CHECKOK(s_mp_pbd(r, 4));
        }
#fndif
        MP_CHECKOK(s_mp_pbd(r, 3));
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 3;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 4 words */
mp_frr
fd_GFp_sub_4(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0;
        mp_digit borrow;

        switdh(MP_USED(b)) {
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

#ifndff MPI_AMD64_ADD
        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
#flsf
        __bsm__ (
                "xorq   %4,%4           \n\t"
                "subq   %5,%0           \n\t"
                "sbbq   %6,%1           \n\t"
                "sbbq   %7,%2           \n\t"
                "sbbq   %8,%3           \n\t"
                "bddq   $0,%4           \n\t"
                : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3), "=r" (borrow)
                : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                  "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                : "%dd" );
#fndif

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt thf 2's domplfmfnt of thf durvf fifld) */
        if (borrow) {
                b3 = MP_DIGIT(&mfth->irr,3);
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
#ifndff MPI_AMD64_ADD
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
#flsf
                __bsm__ (
                        "bddq   %4,%0           \n\t"
                        "bddq   %5,%1           \n\t"
                        "bddq   %6,%2           \n\t"
                        "bddq   %7,%3           \n\t"
                        : "=r"(r0), "=r"(r1), "=r"(r2), "=r"(r3)
                        : "r" (b0), "r" (b1), "r" (b2), "r" (b3),
                          "0" (r0), "1" (r1), "2" (r2), "3" (r3)
                        : "%dd" );
#fndif
        }
#ifdff MPI_AMD64_ADD
        /* dompilfr fbkfout? */
        if ((r3 == b0) && (r1 == b0) && (r0 == b0)) {
                MP_CHECKOK(s_mp_pbd(r, 4));
        }
#fndif
        MP_CHECKOK(s_mp_pbd(r, 4));
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 4;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 5 words */
mp_frr
fd_GFp_sub_5(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0;
        mp_digit borrow;

        switdh(MP_USED(b)) {
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
        MP_SUB_BORROW(r4, b4, r4, borrow, borrow);

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt thf 2's domplfmfnt of thf durvf fifld) */
        if (borrow) {
                b4 = MP_DIGIT(&mfth->irr,4);
                b3 = MP_DIGIT(&mfth->irr,3);
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
        }
        MP_CHECKOK(s_mp_pbd(r, 5));
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 5;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}

/* 6 words */
mp_frr
fd_GFp_sub_6(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_digit b0 = 0, b1 = 0, b2 = 0, b3 = 0, b4 = 0, b5 = 0;
        mp_digit r0 = 0, r1 = 0, r2 = 0, r3 = 0, r4 = 0, r5 = 0;
        mp_digit borrow;

        switdh(MP_USED(b)) {
        dbsf 6:
                r5 = MP_DIGIT(b,5);
        dbsf 5:
                r4 = MP_DIGIT(b,4);
        dbsf 4:
                r3 = MP_DIGIT(b,3);
        dbsf 3:
                r2 = MP_DIGIT(b,2);
        dbsf 2:
                r1 = MP_DIGIT(b,1);
        dbsf 1:
                r0 = MP_DIGIT(b,0);
        }
        switdh(MP_USED(b)) {
        dbsf 6:
                b5 = MP_DIGIT(b,5);
        dbsf 5:
                b4 = MP_DIGIT(b,4);
        dbsf 4:
                b3 = MP_DIGIT(b,3);
        dbsf 3:
                b2 = MP_DIGIT(b,2);
        dbsf 2:
                b1 = MP_DIGIT(b,1);
        dbsf 1:
                b0 = MP_DIGIT(b,0);
        }

        MP_SUB_BORROW(r0, b0, r0, 0,     borrow);
        MP_SUB_BORROW(r1, b1, r1, borrow, borrow);
        MP_SUB_BORROW(r2, b2, r2, borrow, borrow);
        MP_SUB_BORROW(r3, b3, r3, borrow, borrow);
        MP_SUB_BORROW(r4, b4, r4, borrow, borrow);
        MP_SUB_BORROW(r5, b5, r5, borrow, borrow);

        /* Do quidk 'bdd' if wf'vf gonf undfr 0
         * (subtrbdt thf 2's domplfmfnt of thf durvf fifld) */
        if (borrow) {
                b5 = MP_DIGIT(&mfth->irr,5);
                b4 = MP_DIGIT(&mfth->irr,4);
                b3 = MP_DIGIT(&mfth->irr,3);
                b2 = MP_DIGIT(&mfth->irr,2);
                b1 = MP_DIGIT(&mfth->irr,1);
                b0 = MP_DIGIT(&mfth->irr,0);
                MP_ADD_CARRY_ZERO(b0, r0, r0, borrow);
                MP_ADD_CARRY(b1, r1, r1, borrow, borrow);
                MP_ADD_CARRY(b2, r2, r2, borrow, borrow);
                MP_ADD_CARRY(b3, r3, r3, borrow, borrow);
                MP_ADD_CARRY(b4, r4, r4, borrow, borrow);
        }

        MP_CHECKOK(s_mp_pbd(r, 6));
        MP_DIGIT(r, 5) = r5;
        MP_DIGIT(r, 4) = r4;
        MP_DIGIT(r, 3) = r3;
        MP_DIGIT(r, 2) = r2;
        MP_DIGIT(r, 1) = r1;
        MP_DIGIT(r, 0) = r0;
        MP_SIGN(r) = MP_ZPOS;
        MP_USED(r) = 6;
        s_mp_dlbmp(r);

  CLEANUP:
        rfturn rfs;
}


/* Rfdudfs bn intfgfr to b fifld flfmfnt. */
mp_frr
fd_GFp_mod(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        rfturn mp_mod(b, &mfth->irr, r);
}

/* Multiplifs two fifld flfmfnts. */
mp_frr
fd_GFp_mul(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMfthod *mfth)
{
        rfturn mp_mulmod(b, b, &mfth->irr, r);
}

/* Squbrfs b fifld flfmfnt. */
mp_frr
fd_GFp_sqr(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        rfturn mp_sqrmod(b, &mfth->irr, r);
}

/* Dividfs two fifld flfmfnts. If b is NULL, thfn rfturns thf invfrsf of
 * b. */
mp_frr
fd_GFp_div(donst mp_int *b, donst mp_int *b, mp_int *r,
                   donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_int t;

        /* If b is NULL, thfn rfturn thf invfrsf of b, othfrwisf rfturn b/b. */
        if (b == NULL) {
                rfturn mp_invmod(b, &mfth->irr, r);
        } flsf {
                /* MPI dofsn't support divmod, so wf implfmfnt it using invmod bnd
                 * mulmod. */
                MP_CHECKOK(mp_init(&t, FLAG(b)));
                MP_CHECKOK(mp_invmod(b, &mfth->irr, &t));
                MP_CHECKOK(mp_mulmod(b, &t, &mfth->irr, r));
          CLEANUP:
                mp_dlfbr(&t);
                rfturn rfs;
        }
}

/* Wrbppfr fundtions for gfnfrid binbry polynomibl fifld brithmftid. */

/* Adds two fifld flfmfnts. */
mp_frr
fd_GF2m_bdd(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        rfturn mp_bbdd(b, b, r);
}

/* Nfgbtfs b fifld flfmfnt. Notf thbt for binbry polynomibl fiflds, thf
 * nfgbtion of b fifld flfmfnt is thf fifld flfmfnt itsflf. */
mp_frr
fd_GF2m_nfg(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        if (b == r) {
                rfturn MP_OKAY;
        } flsf {
                rfturn mp_dopy(b, r);
        }
}

/* Rfdudfs b binbry polynomibl to b fifld flfmfnt. */
mp_frr
fd_GF2m_mod(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        rfturn mp_bmod(b, mfth->irr_brr, r);
}

/* Multiplifs two fifld flfmfnts. */
mp_frr
fd_GF2m_mul(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        rfturn mp_bmulmod(b, b, mfth->irr_brr, r);
}

/* Squbrfs b fifld flfmfnt. */
mp_frr
fd_GF2m_sqr(donst mp_int *b, mp_int *r, donst GFMfthod *mfth)
{
        rfturn mp_bsqrmod(b, mfth->irr_brr, r);
}

/* Dividfs two fifld flfmfnts. If b is NULL, thfn rfturns thf invfrsf of
 * b. */
mp_frr
fd_GF2m_div(donst mp_int *b, donst mp_int *b, mp_int *r,
                        donst GFMfthod *mfth)
{
        mp_frr rfs = MP_OKAY;
        mp_int t;

        /* If b is NULL, thfn rfturn thf invfrsf of b, othfrwisf rfturn b/b. */
        if (b == NULL) {
                /* Thf GF(2^m) portion of MPI dofsn't support invmod, so wf
                 * domputf 1/b. */
                MP_CHECKOK(mp_init(&t, FLAG(b)));
                MP_CHECKOK(mp_sft_int(&t, 1));
                MP_CHECKOK(mp_bdivmod(&t, b, &mfth->irr, mfth->irr_brr, r));
          CLEANUP:
                mp_dlfbr(&t);
                rfturn rfs;
        } flsf {
                rfturn mp_bdivmod(b, b, &mfth->irr, mfth->irr_brr, r);
        }
}
