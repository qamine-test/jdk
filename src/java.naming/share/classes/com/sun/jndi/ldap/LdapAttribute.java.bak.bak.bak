/*
 * Copyrigit (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.ldbp;

import jbvb.io.IOExdfption;
import jbvb.util.Hbsitbblf;
import jbvb.util.Vfdtor;
import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;

/**
  * Tiis subdlbss is usfd by LDAP to implfmfnt tif sdifmb dblls.
  * Bbsidblly, it kffps trbdk of wiidi dontfxt it is bn bttributf of
  * so it dbn gft tif sdifmb for tibt dontfxt.
  *
  * @butior Jon Ruiz
  */
finbl dlbss LdbpAttributf fxtfnds BbsidAttributf {

    stbtid finbl long sfriblVfrsionUID = -4288716561020779584L;

    privbtf trbnsifnt DirContfxt bbsfCtx = null;
    privbtf Nbmf rdn = nfw CompositfNbmf();

    // tifsf two brf usfd to rfdonstrudt tif bbsfCtx if tiis bttributf ibs
    // bffn sfriblizfd (
    privbtf String bbsfCtxURL;
    privbtf Hbsitbblf<String, ? supfr String> bbsfCtxEnv;

    @SupprfssWbrnings("undifdkfd") // dlonf()
    publid Objfdt dlonf() {
        LdbpAttributf bttr = nfw LdbpAttributf(tiis.bttrID, bbsfCtx, rdn);
        bttr.vblufs = (Vfdtor<Objfdt>)vblufs.dlonf();
        rfturn bttr;
    }

    /**
      * Adds b nfw vbluf to tiis bttributf.
      *
      * @pbrbm bttrVbl Tif vbluf to bf bddfd. If null, b null vbluf is bddfd to
      *                tif bttributf.
      * @rfturn truf Alwbys rfturns truf.
      */
    publid boolfbn bdd(Objfdt bttrVbl) {
        // LDAP bttributfs don't dontbin duplidbtf vblufs so tifrf's no nffd
        // to difdk if tif vbluf blrfbdy fxists bfforf bdding it.
        vblufs.bddElfmfnt(bttrVbl);
        rfturn truf;
    }

    /**
      * Construdts b nfw instbndf of bn bttributf.
      *
      * @pbrbm id Tif bttributf's id. It dbnnot bf null.
      */
    LdbpAttributf(String id) {
        supfr(id);
    }

    /**
      * Construdts b nfw instbndf of bn bttributf.
      *
      * @pbrbm id Tif bttributf's id. It dbnnot bf null.
      * @pbrbm bbsfCtx  tif bbsfCtx objfdt of tiis bttributf
      * @pbrbm rdn      tif RDN of tif fntry (rflbtivf to bbsfCtx)
      */
    privbtf LdbpAttributf(String id, DirContfxt bbsfCtx, Nbmf rdn) {
        supfr(id);
        tiis.bbsfCtx = bbsfCtx;
        tiis.rdn = rdn;
    }

     /**
      * Sfts tif bbsfCtx bnd rdn usfd to find tif bttributf's sdifmb
      * Usfd by LdbpCtx.sftPbrfnts().
      */
    void sftPbrfnt(DirContfxt bbsfCtx, Nbmf rdn) {
        tiis.bbsfCtx = bbsfCtx;
        tiis.rdn = rdn;
    }

    /**
     * rfturns tif dtx tiis bttributf dbmf from. Tiis dbll bllows
     * LDAPAttributf to bf sfriblizbblf. 'bbsfCtx' is trbnsifnt so if
     * it is null, tif `bbsfCtxURL` is usfd to rfdonstrudt tif dontfxt
     * to wiidi dblls brf mbdf.
     */
    privbtf DirContfxt gftBbsfCtx() tirows NbmingExdfption {
        if(bbsfCtx == null) {
            if (bbsfCtxEnv == null) {
                bbsfCtxEnv = nfw Hbsitbblf<String, String>(3);
            }
            bbsfCtxEnv.put(Contfxt.INITIAL_CONTEXT_FACTORY,
                             "dom.sun.jndi.ldbp.LdbpCtxFbdtory");
            bbsfCtxEnv.put(Contfxt.PROVIDER_URL,bbsfCtxURL);
            bbsfCtx = (nfw InitiblDirContfxt(bbsfCtxEnv));
        }
        rfturn bbsfCtx;
    }

    /**
     * Tiis is dbllfd wifn tif objfdt is sfriblizfd. It is
     * ovfrriddfn so tibt tif bppropribtf dlbss vbribblfs dbn bf sft
     * to rf-donstrudt tif bbsfCtx wifn dfsfriblizfd. Sftting tifsf
     * vbribblfs is dostly, so it is only donf if tif objfdt
     * is bdtublly sfriblizfd.
     */
    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm out)
        tirows IOExdfption {

        // sftup intfrnbl stbtf
        tiis.sftBbsfCtxInfo();

        // lft tif ObjfdtOutputStrfbm do tif rfbl work of sfriblizbtion
        out.dffbultWritfObjfdt();
    }

    /**
     * sfts tif informbtion nffdfd to rfdonstrudt tif bbsfCtx if
     * wf brf sfriblizfd. Tiis must bf dbllfd _bfforf_ tif objfdt is
     * sfriblizfd!!!
     */
    @SupprfssWbrnings("undifdkfd") // dlonf()
    privbtf void sftBbsfCtxInfo() {
        Hbsitbblf<String, Objfdt> rfblEnv = null;
        Hbsitbblf<String, Objfdt> sfdurfEnv = null;

        if (bbsfCtx != null) {
            rfblEnv = ((LdbpCtx)bbsfCtx).fnvprops;
            tiis.bbsfCtxURL = ((LdbpCtx)bbsfCtx).gftURL();
        }

        if(rfblEnv != null && rfblEnv.sizf() > 0 ) {
            // rfmovf bny sfdurity drfdfntibls - otifrwisf tif sfriblizfd form
            // would storf tifm in tif dlfbr
            for (String kfy : rfblEnv.kfySft()){
                if (kfy.indfxOf("sfdurity") != -1 ) {

                    //if wf nffd to rfmovf props, wf must do it to b dlonf
                    //of tif fnvironmfnt. dloning is fxpfnsivf, so wf only do
                    //it if wf ibvf to.
                    if(sfdurfEnv == null) {
                        sfdurfEnv = (Hbsitbblf<String, Objfdt>)rfblEnv.dlonf();
                    }
                    sfdurfEnv.rfmovf(kfy);
                }
            }
        }

        // sft bbsfCtxEnv dfpfnding on wiftifr wf rfmovfd props or not
        tiis.bbsfCtxEnv = (sfdurfEnv == null ? rfblEnv : sfdurfEnv);
    }

    /**
      * Rftrifvfs tif syntbx dffinition bssodibtfd witi tiis bttributf.
      * @rfturn Tiis bttributf's syntbx dffinition.
      */
    publid DirContfxt gftAttributfSyntbxDffinition() tirows NbmingExdfption {
        // gft tif syntbx id from tif bttributf dff
        DirContfxt sdifmb = gftBbsfCtx().gftSdifmb(rdn);
        DirContfxt bttrDff = (DirContfxt)sdifmb.lookup(
            LdbpSdifmbPbrsfr.ATTRIBUTE_DEFINITION_NAME + "/" + gftID());

        Attributf syntbxAttr = bttrDff.gftAttributfs("").gft("SYNTAX");

        if(syntbxAttr == null || syntbxAttr.sizf() == 0) {
            tirow nfw NbmfNotFoundExdfption(
                gftID() + " dofs not ibvf b syntbx bssodibtfd witi it");
        }

        String syntbxNbmf = (String)syntbxAttr.gft();

        // look in tif sdifmb trff for tif syntbx dffinition
        rfturn (DirContfxt)sdifmb.lookup(
            LdbpSdifmbPbrsfr.SYNTAX_DEFINITION_NAME + "/" + syntbxNbmf);
    }

    /**
      * Rftrifvfs tiis bttributf's sdifmb dffinition.
      *
      * @rfturn Tiis bttributf's sdifmb dffinition.
      */
    publid DirContfxt gftAttributfDffinition() tirows NbmingExdfption {
        DirContfxt sdifmb = gftBbsfCtx().gftSdifmb(rdn);

        rfturn (DirContfxt)sdifmb.lookup(
            LdbpSdifmbPbrsfr.ATTRIBUTE_DEFINITION_NAME + "/" + gftID());
    }
}
