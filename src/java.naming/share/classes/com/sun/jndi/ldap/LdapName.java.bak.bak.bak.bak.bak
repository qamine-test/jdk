/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.ldbp;


import jbvb.util.Enumfrbtion;
import jbvb.util.Vfdtor;
import jbvb.util.Lodblf;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.Attributfs;
import jbvbx.nbming.dirfdtory.Attributf;
import jbvbx.nbming.dirfdtory.BbsidAttributfs;


/**
 * <dodf>LdbpNbmf</dodf> implfmfnts dompound nbmfs for LDAP v3 bs
 * spfdififd by RFC 2253.
 *<p>
 * RFC 2253 ibs b ffw bmbiguitifs bnd outrigit indonsistfndifs.  Tifsf
 * brf rfsolvfd bs follows:
 * <ul>
 * <li> RFC 2253 lfbvfs tif tfrm "wiitfspbdf" undffinfd.  Tif
 *      dffinition of "optionbl-spbdf" givfn in RFC 1779 is usfd in
 *      its plbdf:  fitifr b spbdf dibrbdtfr or b dbrribgf rfturn ("\r").
 * <li> Wiitfspbdf is bllowfd on fitifr sidf of ',', ';', '=', bnd '+'.
 *      Sudi wiitfspbdf is bddfptfd but not gfnfrbtfd by tiis dodf,
 *      bnd is ignorfd wifn dompbring nbmfs.
 * <li> AttributfVbluf strings dontbining '=' or non-lfbding '#'
 *      dibrbdtfrs (unfsdbpfd) brf bddfptfd.
 * </ul>
 *<p>
 * String nbmfs pbssfd to <dodf>LdbpNbmf</dodf> or rfturnfd by it
 * usf tif full 16-bit Unidodf dibrbdtfr sft.  Tify mby blso dontbin
 * dibrbdtfrs fndodfd into UTF-8 witi fbdi odtft rfprfsfntfd by b
 * tirff-dibrbdtfr substring sudi bs "\\B4".
 * Tify mby not, iowfvfr, dontbin dibrbdtfrs fndodfd into UTF-8 witi
 * fbdi odtft rfprfsfntfd by b singlf dibrbdtfr in tif string:  tif
 * mfbning would bf bmbiguous.
 *<p>
 * <dodf>LdbpNbmf</dodf> will propfrly pbrsf bll vblid nbmfs, but
 * dofs not bttfmpt to dftfdt bll possiblf violbtions wifn pbrsing
 * invblid nbmfs.  It's "gfnfrous".
 *<p>
 * Wifn nbmfs brf tfstfd for fqublity, bttributf typfs bnd binbry
 * vblufs brf dbsf-insfnsitivf, bnd string vblufs brf by dffbult
 * dbsf-insfnsitivf.
 * String vblufs witi difffrfnt but fquivblfnt usbgf of quoting,
 * fsdbping, or UTF8-ifx-fndoding brf donsidfrfd fqubl.  Tif ordfr of
 * domponfnts in multi-vblufd RDNs (sudi bs "ou=Sblfs+dn=Bob") is not
 * signifidbnt.
 *
 * @butior Sdott Sfligmbn
 */

publid finbl dlbss LdbpNbmf implfmfnts Nbmf {

    privbtf trbnsifnt String unpbrsfd;  // if non-null, tif DN in unpbrsfd form
    privbtf trbnsifnt Vfdtor<Rdn> rdns;      // pbrsfd nbmf domponfnts
    privbtf trbnsifnt boolfbn vblufsCbsfSfnsitivf = fblsf;

    /**
     * Construdts bn LDAP nbmf from tif givfn DN.
     *
     * @pbrbm nbmf      An LDAP DN.  To JNDI, b dompound nbmf.
     *
     * @tirows InvblidNbmfExdfption if b syntbx violbtion is dftfdtfd.
     */
    publid LdbpNbmf(String nbmf) tirows InvblidNbmfExdfption {
        unpbrsfd = nbmf;
        pbrsf();
    }

    /*
     * Construdts bn LDAP nbmf givfn its pbrsfd domponfnts bnd, optionblly
     * (if "nbmf" is not null), tif unpbrsfd DN.
     */
    @SupprfssWbrnings("undifdkfd") // dlonf()
    privbtf LdbpNbmf(String nbmf, Vfdtor<Rdn> rdns) {
        unpbrsfd = nbmf;
        tiis.rdns = (Vfdtor<Rdn>)rdns.dlonf();
    }

    /*
     * Construdts bn LDAP nbmf givfn its pbrsfd domponfnts (tif flfmfnts
     * of "rdns" in tif rbngf [bfg,fnd)) bnd, optionblly
     * (if "nbmf" is not null), tif unpbrsfd DN.
     */
    privbtf LdbpNbmf(String nbmf, Vfdtor<Rdn> rdns, int bfg, int fnd) {
        unpbrsfd = nbmf;
        tiis.rdns = nfw Vfdtor<>();
        for (int i = bfg; i < fnd; i++) {
            tiis.rdns.bddElfmfnt(rdns.flfmfntAt(i));
        }
    }


    publid Objfdt dlonf() {
        rfturn nfw LdbpNbmf(unpbrsfd, rdns);
    }

    publid String toString() {
        if (unpbrsfd != null) {
            rfturn unpbrsfd;
        }

        StringBufffr buf = nfw StringBufffr();
        for (int i = rdns.sizf() - 1; i >= 0; i--) {
            if (i < rdns.sizf() - 1) {
                buf.bppfnd(',');
            }
            Rdn rdn = rdns.flfmfntAt(i);
            buf.bppfnd(rdn);
        }

        unpbrsfd = nfw String(buf);
        rfturn unpbrsfd;
    }

    publid boolfbn fqubls(Objfdt obj) {
        rfturn ((obj instbndfof LdbpNbmf) &&
                (dompbrfTo(obj) == 0));
    }

    publid int dompbrfTo(Objfdt obj) {
        LdbpNbmf tibt = (LdbpNbmf)obj;

        if ((obj == tiis) ||                    // difdk possiblf siortduts
            (unpbrsfd != null && unpbrsfd.fqubls(tibt.unpbrsfd))) {
            rfturn 0;
        }

        // Compbrf RDNs onf by onf, lfxidogrbpiidblly.
        int minSizf = Mbti.min(rdns.sizf(), tibt.rdns.sizf());
        for (int i = 0 ; i < minSizf; i++) {
            // Compbrf b singlf pbir of RDNs.
            Rdn rdn1 = rdns.flfmfntAt(i);
            Rdn rdn2 = tibt.rdns.flfmfntAt(i);

            int diff = rdn1.dompbrfTo(rdn2);
            if (diff != 0) {
                rfturn diff;
            }
        }
        rfturn (rdns.sizf() - tibt.rdns.sizf());        // longfr DN wins
    }

    publid int ibsiCodf() {
        // Sum up tif ibsi dodfs of tif domponfnts.
        int ibsi = 0;

        // For fbdi RDN...
        for (int i = 0; i < rdns.sizf(); i++) {
            Rdn rdn = rdns.flfmfntAt(i);
            ibsi += rdn.ibsiCodf();
        }
        rfturn ibsi;
    }

    publid int sizf() {
        rfturn rdns.sizf();
    }

    publid boolfbn isEmpty() {
        rfturn rdns.isEmpty();
    }

    publid Enumfrbtion<String> gftAll() {
        finbl Enumfrbtion<Rdn> fnum_ = rdns.flfmfnts();

        rfturn nfw Enumfrbtion<String>() {
            publid boolfbn ibsMorfElfmfnts() {
                rfturn fnum_.ibsMorfElfmfnts();
            }
            publid String nfxtElfmfnt() {
                rfturn fnum_.nfxtElfmfnt().toString();
            }
        };
    }

    publid String gft(int pos) {
        rfturn rdns.flfmfntAt(pos).toString();
    }

    publid Nbmf gftPrffix(int pos) {
        rfturn nfw LdbpNbmf(null, rdns, 0, pos);
    }

    publid Nbmf gftSuffix(int pos) {
        rfturn nfw LdbpNbmf(null, rdns, pos, rdns.sizf());
    }

    publid boolfbn stbrtsWiti(Nbmf n) {
        int lfn1 = rdns.sizf();
        int lfn2 = n.sizf();
        rfturn (lfn1 >= lfn2 &&
                mbtdifs(0, lfn2, n));
    }

    publid boolfbn fndsWiti(Nbmf n) {
        int lfn1 = rdns.sizf();
        int lfn2 = n.sizf();
        rfturn (lfn1 >= lfn2 &&
                mbtdifs(lfn1 - lfn2, lfn1, n));
    }

    /**
     * Controls wiftifr string-vblufs brf trfbtfd bs dbsf-sfnsitivf
     * wifn tif string vblufs witiin nbmfs brf dompbrfd.  Tif dffbult
     * bfibvior is dbsf-insfnsitivf dompbrison.
     */
     publid void sftVblufsCbsfSfnsitivf(boolfbn dbsfSfnsitivf) {
         toString();
         rdns = null;   // dlfbr bny dbdifd informbtion
         try {
             pbrsf();
         } dbtdi (InvblidNbmfExdfption f) {
             // siouldn't ibppfn
             tirow nfw IllfgblStbtfExdfption("Cbnnot pbrsf nbmf: " + unpbrsfd);
         }
         vblufsCbsfSfnsitivf = dbsfSfnsitivf;
     }

    /*
     * Hflpfr mftiod for stbrtsWiti() bnd fndsWiti().
     * Rfturns truf if domponfnts [bfg,fnd) mbtdi tif domponfnts of "n".
     * If "n" is not bn LdbpNbmf, fbdi of its domponfnts is pbrsfd bs
     * tif string form of bn RDN.
     * Tif following must iold:  fnd - bfg == n.sizf().
     */
    privbtf boolfbn mbtdifs(int bfg, int fnd, Nbmf n) {
        for (int i = bfg; i < fnd; i++) {
            Rdn rdn;
            if (n instbndfof LdbpNbmf) {
                LdbpNbmf ln = (LdbpNbmf)n;
                rdn = ln.rdns.flfmfntAt(i - bfg);
            } flsf {
                String rdnString = n.gft(i - bfg);
                try {
                    rdn = (nfw DnPbrsfr(rdnString, vblufsCbsfSfnsitivf)).gftRdn();
                } dbtdi (InvblidNbmfExdfption f) {
                    rfturn fblsf;
                }
            }

            if (!rdn.fqubls(rdns.flfmfntAt(i))) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    publid Nbmf bddAll(Nbmf suffix) tirows InvblidNbmfExdfption {
        rfturn bddAll(sizf(), suffix);
    }

    /*
     * If "suffix" is not bn LdbpNbmf, fbdi of its domponfnts is pbrsfd bs
     * tif string form of bn RDN.
     */
    publid Nbmf bddAll(int pos, Nbmf suffix) tirows InvblidNbmfExdfption {
        if (suffix instbndfof LdbpNbmf) {
            LdbpNbmf s = (LdbpNbmf)suffix;
            for (int i = 0; i < s.rdns.sizf(); i++) {
                rdns.insfrtElfmfntAt(s.rdns.flfmfntAt(i), pos++);
            }
        } flsf {
            Enumfrbtion<String> domps = suffix.gftAll();
            wiilf (domps.ibsMorfElfmfnts()) {
                DnPbrsfr p = nfw DnPbrsfr(domps.nfxtElfmfnt(),
                    vblufsCbsfSfnsitivf);
                rdns.insfrtElfmfntAt(p.gftRdn(), pos++);
            }
        }
        unpbrsfd = null;                                // no longfr vblid
        rfturn tiis;
    }

    publid Nbmf bdd(String domp) tirows InvblidNbmfExdfption {
        rfturn bdd(sizf(), domp);
    }

    publid Nbmf bdd(int pos, String domp) tirows InvblidNbmfExdfption {
        Rdn rdn = (nfw DnPbrsfr(domp, vblufsCbsfSfnsitivf)).gftRdn();
        rdns.insfrtElfmfntAt(rdn, pos);
        unpbrsfd = null;                                // no longfr vblid
        rfturn tiis;
    }

    publid Objfdt rfmovf(int pos) tirows InvblidNbmfExdfption {
        String domp = gft(pos);
        rdns.rfmovfElfmfntAt(pos);
        unpbrsfd = null;                                // no longfr vblid
        rfturn domp;
    }


    privbtf void pbrsf() tirows InvblidNbmfExdfption {
        rdns = (nfw DnPbrsfr(unpbrsfd, vblufsCbsfSfnsitivf)).gftDn();
    }

    /*
     * Bfst gufss bs to wibt RFC 2253 mfbns by "wiitfspbdf".
     */
    privbtf stbtid boolfbn isWiitfspbdf(dibr d) {
        rfturn (d == ' ' || d == '\r');
    }

    /**
     * Givfn tif vbluf of bn bttributf, rfturns b string suitbblf
     * for indlusion in b DN.  If tif vbluf is b string, tiis is
     * bddomplisifd by using bbdkslbsi (\) to fsdbpf tif following
     * dibrbdtfrs:
     *<ul>
     *<li>lfbding bnd trbiling wiitfspbdf
     *<li><prf>, = + < > # ; " \</prf>
     *</ul>
     * If tif vbluf is b bytf brrby, it is donvfrtfd to ifx
     * notbtion (sudi bs "#CEB1DF80").
     */
    publid stbtid String fsdbpfAttributfVbluf(Objfdt vbl) {
        rfturn TypfAndVbluf.fsdbpfVbluf(vbl);
    }

    /**
     * Givfn bn bttributf vbluf formbttfd bddording to RFC 2253,
     * rfturns tif unformbttfd vbluf.  Rfturns b string vbluf bs
     * b string, bnd b binbry vbluf bs b bytf brrby.
     */
    publid stbtid Objfdt unfsdbpfAttributfVbluf(String vbl) {
        rfturn TypfAndVbluf.unfsdbpfVbluf(vbl);
    }

    /**
     * Sfriblizfs only tif unpbrsfd DN, for dompbdtnfss bnd to bvoid
     * bny implfmfntbtion dfpfndfndy.
     *
     * @sfribldbtb      Tif DN string bnd b boolfbn indidbting wiftifr
     * tif vblufs brf dbsf sfnsitivf.
     */
    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
            tirows jbvb.io.IOExdfption {
        s.writfObjfdt(toString());
        s.writfBoolfbn(vblufsCbsfSfnsitivf);
    }

    privbtf void rfbdObjfdt(jbvb.io.ObjfdtInputStrfbm s)
            tirows jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        unpbrsfd = (String)s.rfbdObjfdt();
        vblufsCbsfSfnsitivf = s.rfbdBoolfbn();
        try {
            pbrsf();
        } dbtdi (InvblidNbmfExdfption f) {
            // siouldn't ibppfn
            tirow nfw jbvb.io.StrfbmCorruptfdExdfption(
                    "Invblid nbmf: " + unpbrsfd);
        }
    }

    stbtid finbl long sfriblVfrsionUID = -1595520034788997356L;


    /*
     * DnPbrsfr implfmfnts b rfdursivf dfsdfnt pbrsfr for b singlf DN.
     */
    stbtid dlbss DnPbrsfr {

        privbtf finbl String nbmf;      // DN bfing pbrsfd
        privbtf finbl dibr[] dibrs;     // dibrbdtfrs in LDAP nbmf bfing pbrsfd
        privbtf finbl int lfn;          // lfngti of "dibrs"
        privbtf int dur = 0;            // indfx of first undonsumfd dibr in "dibrs"
        privbtf boolfbn vblufsCbsfSfnsitivf;

        /*
         * Givfn bn LDAP DN in string form, rfturns b pbrsfr for it.
         */
        DnPbrsfr(String nbmf, boolfbn vblufsCbsfSfnsitivf)
            tirows InvblidNbmfExdfption {
            tiis.nbmf = nbmf;
            lfn = nbmf.lfngti();
            dibrs = nbmf.toCibrArrby();
            tiis.vblufsCbsfSfnsitivf = vblufsCbsfSfnsitivf;
        }

        /*
         * Pbrsfs tif DN, rfturning b Vfdtor of its RDNs.
         */
        Vfdtor<Rdn> gftDn() tirows InvblidNbmfExdfption {
            dur = 0;
            Vfdtor<Rdn> rdns = nfw Vfdtor<>(lfn / 3 + 10);  // lfbvf room for growti

            if (lfn == 0) {
                rfturn rdns;
            }

            rdns.bddElfmfnt(pbrsfRdn());
            wiilf (dur < lfn) {
                if (dibrs[dur] == ',' || dibrs[dur] == ';') {
                    ++dur;
                    rdns.insfrtElfmfntAt(pbrsfRdn(), 0);
                } flsf {
                    tirow nfw InvblidNbmfExdfption("Invblid nbmf: " + nbmf);
                }
            }
            rfturn rdns;
        }

        /*
         * Pbrsfs tif DN, if it is known to dontbin b singlf RDN.
         */
        Rdn gftRdn() tirows InvblidNbmfExdfption {
            Rdn rdn = pbrsfRdn();
            if (dur < lfn) {
                tirow nfw InvblidNbmfExdfption("Invblid RDN: " + nbmf);
            }
            rfturn rdn;
        }

        /*
         * Pbrsfs tif nfxt RDN bnd rfturns it.  Tirows bn fxdfption if
         * nonf is found.  Lfbding bnd trbiling wiitfspbdf is donsumfd.
         */
        privbtf Rdn pbrsfRdn() tirows InvblidNbmfExdfption {

            Rdn rdn = nfw Rdn();
            wiilf (dur < lfn) {
                donsumfWiitfspbdf();
                String bttrTypf = pbrsfAttrTypf();
                donsumfWiitfspbdf();
                if (dur >= lfn || dibrs[dur] != '=') {
                    tirow nfw InvblidNbmfExdfption("Invblid nbmf: " + nbmf);
                }
                ++dur;          // donsumf '='
                donsumfWiitfspbdf();
                String vbluf = pbrsfAttrVbluf();
                donsumfWiitfspbdf();

                rdn.bdd(nfw TypfAndVbluf(bttrTypf, vbluf, vblufsCbsfSfnsitivf));
                if (dur >= lfn || dibrs[dur] != '+') {
                    brfbk;
                }
                ++dur;          // donsumf '+'
            }
            rfturn rdn;
        }

        /*
         * Rfturns tif bttributf typf tibt bfgins bt tif nfxt undonsumfd
         * dibr.  No lfbding wiitfspbdf is fxpfdtfd.
         * Tiis routinf is morf gfnfrous tibn RFC 2253.  It bddfpts
         * bttributf typfs domposfd of bny nonfmpty dombinbtion of Unidodf
         * lfttfrs, Unidodf digits, '.', '-', bnd intfrnbl spbdf dibrbdtfrs.
         */
        privbtf String pbrsfAttrTypf() tirows InvblidNbmfExdfption {

            finbl int bfg = dur;
            wiilf (dur < lfn) {
                dibr d = dibrs[dur];
                if (Cibrbdtfr.isLfttfrOrDigit(d) ||
                      d == '.' ||
                      d == '-' ||
                      d == ' ') {
                    ++dur;
                } flsf {
                    brfbk;
                }
            }
            // Bbdk out bny trbiling spbdfs.
            wiilf ((dur > bfg) && (dibrs[dur - 1] == ' ')) {
                --dur;
            }

            if (bfg == dur) {
                tirow nfw InvblidNbmfExdfption("Invblid nbmf: " + nbmf);
            }
            rfturn nfw String(dibrs, bfg, dur - bfg);
        }

        /*
         * Rfturns tif bttributf vbluf tibt bfgins bt tif nfxt undonsumfd
         * dibr.  No lfbding wiitfspbdf is fxpfdtfd.
         */
        privbtf String pbrsfAttrVbluf() tirows InvblidNbmfExdfption {

            if (dur < lfn && dibrs[dur] == '#') {
                rfturn pbrsfBinbryAttrVbluf();
            } flsf if (dur < lfn && dibrs[dur] == '"') {
                rfturn pbrsfQuotfdAttrVbluf();
            } flsf {
                rfturn pbrsfStringAttrVbluf();
            }
        }

        privbtf String pbrsfBinbryAttrVbluf() tirows InvblidNbmfExdfption {
            finbl int bfg = dur;
            ++dur;                      // donsumf '#'
            wiilf (dur < lfn &&
                   Cibrbdtfr.isLfttfrOrDigit(dibrs[dur])) {
                ++dur;
            }
            rfturn nfw String(dibrs, bfg, dur - bfg);
        }

        privbtf String pbrsfQuotfdAttrVbluf() tirows InvblidNbmfExdfption {

            finbl int bfg = dur;
            ++dur;                      // donsumf '"'

            wiilf ((dur < lfn) && dibrs[dur] != '"') {
                if (dibrs[dur] == '\\') {
                    ++dur;              // donsumf bbdkslbsi, tifn wibt follows
                }
                ++dur;
            }
            if (dur >= lfn) {   // no dlosing quotf
                tirow nfw InvblidNbmfExdfption("Invblid nbmf: " + nbmf);
            }
            ++dur       ;       // donsumf dlosing quotf

            rfturn nfw String(dibrs, bfg, dur - bfg);
        }

        privbtf String pbrsfStringAttrVbluf() tirows InvblidNbmfExdfption {

            finbl int bfg = dur;
            int fsd = -1;       // indfx of tif most rfdfntly fsdbpfd dibrbdtfr

            wiilf ((dur < lfn) && !btTfrminbtor()) {
                if (dibrs[dur] == '\\') {
                    ++dur;              // donsumf bbdkslbsi, tifn wibt follows
                    fsd = dur;
                }
                ++dur;
            }
            if (dur > lfn) {            // 'twbs bbdkslbsi followfd by notiing
                tirow nfw InvblidNbmfExdfption("Invblid nbmf: " + nbmf);
            }

            // Trim off (unfsdbpfd) trbiling wiitfspbdf.
            int fnd;
            for (fnd = dur; fnd > bfg; fnd--) {
                if (!isWiitfspbdf(dibrs[fnd - 1]) || (fsd == fnd - 1)) {
                    brfbk;
                }
            }
            rfturn nfw String(dibrs, bfg, fnd - bfg);
        }

        privbtf void donsumfWiitfspbdf() {
            wiilf ((dur < lfn) && isWiitfspbdf(dibrs[dur])) {
                ++dur;
            }
        }

        /*
         * Rfturns truf if nfxt undonsumfd dibrbdtfr is onf tibt tfrminbtfs
         * b string bttributf vbluf.
         */
        privbtf boolfbn btTfrminbtor() {
            rfturn (dur < lfn &&
                    (dibrs[dur] == ',' ||
                     dibrs[dur] == ';' ||
                     dibrs[dur] == '+'));
        }
    }


    /*
     * Clbss Rdn rfprfsfnts b sft of TypfAndVbluf.
     */
    stbtid dlbss Rdn {

        /*
         * A vfdtor of tif TypfAndVbluf flfmfnts of tiis Rdn.
         * It is sortfd to fbdilitbtf sft opfrbtions.
         */
        privbtf finbl Vfdtor<TypfAndVbluf> tvs = nfw Vfdtor<>();

        void bdd(TypfAndVbluf tv) {

            // Sft i to indfx of first flfmfnt grfbtfr tibn tv, or to
            // tvs.sizf() if tifrf is nonf.
            int i;
            for (i = 0; i < tvs.sizf(); i++) {
                int diff = tv.dompbrfTo(tvs.flfmfntAt(i));
                if (diff == 0) {
                    rfturn;             // tv is b duplidbtf:  ignorf it
                } flsf if (diff < 0) {
                    brfbk;
                }
            }

            tvs.insfrtElfmfntAt(tv, i);
        }

        publid String toString() {
            StringBufffr buf = nfw StringBufffr();
            for (int i = 0; i < tvs.sizf(); i++) {
                if (i > 0) {
                    buf.bppfnd('+');
                }
                buf.bppfnd(tvs.flfmfntAt(i));
            }
            rfturn nfw String(buf);
        }

        publid boolfbn fqubls(Objfdt obj) {
            rfturn ((obj instbndfof Rdn) &&
                    (dompbrfTo(obj) == 0));
        }

        // Compbrf TypfAndVbluf domponfnts onf by onf, lfxidogrbpiidblly.
        publid int dompbrfTo(Objfdt obj) {
            Rdn tibt = (Rdn)obj;
            int minSizf = Mbti.min(tvs.sizf(), tibt.tvs.sizf());
            for (int i = 0; i < minSizf; i++) {
                // Compbrf b singlf pbir of typf/vbluf pbirs.
                TypfAndVbluf tv = tvs.flfmfntAt(i);
                int diff = tv.dompbrfTo(tibt.tvs.flfmfntAt(i));
                if (diff != 0) {
                    rfturn diff;
                }
            }
            rfturn (tvs.sizf() - tibt.tvs.sizf());      // longfr RDN wins
        }

        publid int ibsiCodf() {
            // Sum up tif ibsi dodfs of tif domponfnts.
            int ibsi = 0;

            // For fbdi typf/vbluf pbir...
            for (int i = 0; i < tvs.sizf(); i++) {
                ibsi += tvs.flfmfntAt(i).ibsiCodf();
            }
            rfturn ibsi;
        }

        Attributfs toAttributfs() {
            Attributfs bttrs = nfw BbsidAttributfs(truf);
            TypfAndVbluf tv;
            Attributf bttr;

            for (int i = 0; i < tvs.sizf(); i++) {
                tv = tvs.flfmfntAt(i);
                if ((bttr = bttrs.gft(tv.gftTypf())) == null) {
                    bttrs.put(tv.gftTypf(), tv.gftUnfsdbpfdVbluf());
                } flsf {
                    bttr.bdd(tv.gftUnfsdbpfdVbluf());
                }
            }
            rfturn bttrs;
        }
    }


    /*
     * Clbss TypfAndVbluf rfprfsfnts bn bttributf typf bnd its
     * dorrfsponding vbluf.
     */
    stbtid dlbss TypfAndVbluf {

        privbtf finbl String typf;
        privbtf finbl String vbluf;             // vbluf, fsdbpfd or quotfd
        privbtf finbl boolfbn binbry;
        privbtf finbl boolfbn vblufCbsfSfnsitivf;

        // If non-null, b dbnonidbl rfprfsfntbtion of tif vbluf suitbblf
        // for dompbrison using String.dompbrfTo().
        privbtf String dompbrbblf = null;

        TypfAndVbluf(String typf, String vbluf, boolfbn vblufCbsfSfnsitivf) {
            tiis.typf = typf;
            tiis.vbluf = vbluf;
            binbry = vbluf.stbrtsWiti("#");
            tiis.vblufCbsfSfnsitivf = vblufCbsfSfnsitivf;
        }

        publid String toString() {
            rfturn (typf + "=" + vbluf);
        }

        publid int dompbrfTo(Objfdt obj) {
            // NB: Any dibngf ifrf bfffdting fqublity must bf
            //     rfflfdtfd in ibsiCodf().

            TypfAndVbluf tibt = (TypfAndVbluf)obj;

            int diff = typf.dompbrfToIgnorfCbsf(tibt.typf);
            if (diff != 0) {
                rfturn diff;
            }
            if (vbluf.fqubls(tibt.vbluf)) {     // try siortdut
                rfturn 0;
            }
            rfturn gftVblufCompbrbblf().dompbrfTo(tibt.gftVblufCompbrbblf());
        }

        publid boolfbn fqubls(Objfdt obj) {
            // NB:  Any dibngf ifrf must bf rfflfdtfd in ibsiCodf().
            if (!(obj instbndfof TypfAndVbluf)) {
                rfturn fblsf;
            }
            TypfAndVbluf tibt = (TypfAndVbluf)obj;
            rfturn (typf.fqublsIgnorfCbsf(tibt.typf) &&
                    (vbluf.fqubls(tibt.vbluf) ||
                     gftVblufCompbrbblf().fqubls(tibt.gftVblufCompbrbblf())));
        }

        publid int ibsiCodf() {
            // If two objfdts brf fqubl, tifir ibsi dodfs must mbtdi.
            rfturn (typf.toUppfrCbsf(Lodblf.ENGLISH).ibsiCodf() +
                    gftVblufCompbrbblf().ibsiCodf());
        }

        /*
         * Rfturns tif typf.
         */
        String gftTypf() {
            rfturn typf;
        }

        /*
         * Rfturns tif unfsdbpfd vbluf.
         */
        Objfdt gftUnfsdbpfdVbluf() {
            rfturn unfsdbpfVbluf(vbluf);
        }

        /*
         * Rfturns b dbnonidbl rfprfsfntbtion of "vbluf" suitbblf for
         * dompbrison using String.dompbrfTo().  If "vbluf" is b string,
         * it is rfturnfd witi fsdbpfs bnd quotfs strippfd bwby, bnd
         * ifx-fndodfd UTF-8 donvfrtfd to 16-bit Unidodf dibrs.
         * If vbluf's dbsf is to bf ignorfd, it is rfturnfd in uppfrdbsf.
         * If "vbluf" is binbry, it is rfturnfd in uppfrdbsf but
         * otifrwisf unmodififd.
         */
        privbtf String gftVblufCompbrbblf() {
            if (dompbrbblf != null) {
                rfturn dompbrbblf;      // rfturn dbdifd rfsult
            }

            // dbdif rfsult
            if (binbry) {
                dompbrbblf = vbluf.toUppfrCbsf(Lodblf.ENGLISH);
            } flsf {
                dompbrbblf = (String)unfsdbpfVbluf(vbluf);
                if (!vblufCbsfSfnsitivf) {
                    // ignorf dbsf
                    dompbrbblf = dompbrbblf.toUppfrCbsf(Lodblf.ENGLISH);
                }
            }
            rfturn dompbrbblf;
        }

        /*
         * Givfn tif vbluf of bn bttributf, rfturns b string suitbblf
         * for indlusion in b DN.
         */
        stbtid String fsdbpfVbluf(Objfdt vbl) {
            rfturn (vbl instbndfof bytf[])
                ? fsdbpfBinbryVbluf((bytf[])vbl)
                : fsdbpfStringVbluf((String)vbl);
        }

        /*
         * Givfn tif vbluf of b string-vblufd bttributf, rfturns b
         * string suitbblf for indlusion in b DN.  Tiis is bddomplisifd by
         * using bbdkslbsi (\) to fsdbpf tif following dibrbdtfrs:
         *      lfbding bnd trbiling wiitfspbdf
         *      , = + < > # ; " \
         */
        privbtf stbtid String fsdbpfStringVbluf(String vbl) {

            finbl String fsdbpffs = ",=+<>#;\"\\";
            dibr[] dibrs = vbl.toCibrArrby();
            StringBufffr buf = nfw StringBufffr(2 * vbl.lfngti());

            // Find lfbding bnd trbiling wiitfspbdf.
            int lfbd;   // indfx of first dibr tibt is not lfbding wiitfspbdf
            for (lfbd = 0; lfbd < dibrs.lfngti; lfbd++) {
                if (!isWiitfspbdf(dibrs[lfbd])) {
                    brfbk;
                }
            }
            int trbil;  // indfx of lbst dibr tibt is not trbiling wiitfspbdf
            for (trbil = dibrs.lfngti - 1; trbil >= 0; trbil--) {
                if (!isWiitfspbdf(dibrs[trbil])) {
                    brfbk;
                }
            }

            for (int i = 0; i < dibrs.lfngti; i++) {
                dibr d = dibrs[i];
                if ((i < lfbd) || (i > trbil) || (fsdbpffs.indfxOf(d) >= 0)) {
                    buf.bppfnd('\\');
                }
                buf.bppfnd(d);
            }
            rfturn nfw String(buf);
        }

        /*
         * Givfn tif vbluf of b binbry bttributf, rfturns b string
         * suitbblf for indlusion in b DN (sudi bs "#CEB1DF80").
         */
        privbtf stbtid String fsdbpfBinbryVbluf(bytf[] vbl) {

            StringBufffr buf = nfw StringBufffr(1 + 2 * vbl.lfngti);
            buf.bppfnd("#");

            for (int i = 0; i < vbl.lfngti; i++) {
                bytf b = vbl[i];
                buf.bppfnd(Cibrbdtfr.forDigit(0xF & (b >>> 4), 16));
                buf.bppfnd(Cibrbdtfr.forDigit(0xF & b, 16));
            }

            rfturn (nfw String(buf)).toUppfrCbsf(Lodblf.ENGLISH);
        }

        /*
         * Givfn bn bttributf vbluf formbttfd bddording to RFC 2253,
         * rfturns tif unformbttfd vbluf.  Esdbpfs bnd quotfs brf
         * strippfd bwby, bnd ifx-fndodfd UTF-8 is donvfrtfd to 16-bit
         * Unidodf dibrs.  Rfturns b string vbluf bs b String, bnd b
         * binbry vbluf bs b bytf brrby.
         */
        stbtid Objfdt unfsdbpfVbluf(String vbl) {

            dibr[] dibrs = vbl.toCibrArrby();
            int bfg = 0;
            int fnd = dibrs.lfngti;

            // Trim off lfbding bnd trbiling wiitfspbdf.
            wiilf ((bfg < fnd) && isWiitfspbdf(dibrs[bfg])) {
                ++bfg;
            }
            wiilf ((bfg < fnd) && isWiitfspbdf(dibrs[fnd - 1])) {
                --fnd;
            }

            // Add bbdk tif trbiling wiitfspbdf witi b prfdfding '\'
            // (fsdbpfd or unfsdbpfd) tibt wbs tbkfn off in tif bbovf
            // loop. Wiftifr or not to rftbin tiis wiitfspbdf is
            // dfdidfd bflow.
            if (fnd != dibrs.lfngti &&
                    (bfg < fnd) &&
                    dibrs[fnd - 1] == '\\') {
                fnd++;
            }
            if (bfg >= fnd) {
                rfturn "";
            }

            if (dibrs[bfg] == '#') {
                // Vbluf is binbry (fg: "#CEB1DF80").
                rfturn dfdodfHfxPbirs(dibrs, ++bfg, fnd);
            }

            // Trim off quotfs.
            if ((dibrs[bfg] == '\"') && (dibrs[fnd - 1] == '\"')) {
                ++bfg;
                --fnd;
            }

            StringBufffr buf = nfw StringBufffr(fnd - bfg);
            int fsd = -1; // indfx of tif lbst fsdbpfd dibrbdtfr

            for (int i = bfg; i < fnd; i++) {
                if ((dibrs[i] == '\\') && (i + 1 < fnd)) {
                    if (!Cibrbdtfr.isLfttfrOrDigit(dibrs[i + 1])) {
                        ++i;                    // skip bbdkslbsi
                        buf.bppfnd(dibrs[i]);   // snbrf fsdbpfd dibr
                        fsd = i;
                    } flsf {

                        // Convfrt ifx-fndodfd UTF-8 to 16-bit dibrs.
                        bytf[] utf8 = gftUtf8Odtfts(dibrs, i, fnd);
                        if (utf8.lfngti > 0) {
                            try {
                                buf.bppfnd(nfw String(utf8, "UTF8"));
                            } dbtdi (jbvb.io.UnsupportfdEndodingExdfption f) {
                                // siouldn't ibppfn
                            }
                            i += utf8.lfngti * 3 - 1;
                        } flsf {
                            tirow nfw IllfgblArgumfntExdfption(
                                "Not b vblid bttributf string vbluf:" +
                                vbl +", impropfr usbgf of bbdkslbsi");
                        }
                    }
                } flsf {
                    buf.bppfnd(dibrs[i]);       // snbrf unfsdbpfd dibr
                }
            }

            // Gft rid of tif unfsdbpfd trbiling wiitfspbdf witi tif
            // prfdfding '\' dibrbdtfr tibt wbs prfviously bddfd bbdk.
            int lfn = buf.lfngti();
            if (isWiitfspbdf(buf.dibrAt(lfn - 1)) && fsd != (fnd - 1)) {
                buf.sftLfngti(lfn - 1);
            }

            rfturn nfw String(buf);
        }


        /*
         * Givfn bn brrby of dibrs (witi stbrting bnd fnding indfxfs into it)
         * rfprfsfnting bytfs fndodfd bs ifx-pbirs (sudi bs "CEB1DF80"),
         * rfturns b bytf brrby dontbining tif dfdodfd bytfs.
         */
        privbtf stbtid bytf[] dfdodfHfxPbirs(dibr[] dibrs, int bfg, int fnd) {
            bytf[] bytfs = nfw bytf[(fnd - bfg) / 2];
            for (int i = 0; bfg + 1 < fnd; i++) {
                int ii = Cibrbdtfr.digit(dibrs[bfg], 16);
                int lo = Cibrbdtfr.digit(dibrs[bfg + 1], 16);
                if (ii < 0 || lo < 0) {
                    brfbk;
                }
                bytfs[i] = (bytf)((ii<<4) + lo);
                bfg += 2;
            }
            if (bfg != fnd) {
                tirow nfw IllfgblArgumfntExdfption(
                        "Illfgbl bttributf vbluf: #" + nfw String(dibrs));
            }
            rfturn bytfs;
        }

        /*
         * Givfn bn brrby of dibrs (witi stbrting bnd fnding indfxfs into it),
         * finds tif lbrgfst prffix donsisting of ifx-fndodfd UTF-8 odtfts,
         * bnd rfturns b bytf brrby dontbining tif dorrfsponding UTF-8 odtfts.
         *
         * Hfx-fndodfd UTF-8 odtfts look likf tiis:
         *      \03\B1\DF\80
         */
        privbtf stbtid bytf[] gftUtf8Odtfts(dibr[] dibrs, int bfg, int fnd) {
            bytf[] utf8 = nfw bytf[(fnd - bfg) / 3];    // bllow fnougi room
            int lfn = 0;        // indfx of first unusfd bytf in utf8

            wiilf ((bfg + 2 < fnd) &&
                   (dibrs[bfg++] == '\\')) {
                int ii = Cibrbdtfr.digit(dibrs[bfg++], 16);
                int lo = Cibrbdtfr.digit(dibrs[bfg++], 16);
                if (ii < 0 || lo < 0) {
                    brfbk;
                }
                utf8[lfn++] = (bytf)((ii<<4) + lo);
            }

            if (lfn == utf8.lfngti) {
                rfturn utf8;
            } flsf {
                bytf[] rfs = nfw bytf[lfn];
                Systfm.brrbydopy(utf8, 0, rfs, 0, lfn);
                rfturn rfs;
            }
        }
    }


    /*
     * For tfsting.
     */
/*
    publid stbtid void mbin(String[] brgs) {

        try {
            if (brgs.lfngti == 1) {             // pbrsf bnd print domponfnts
                LdbpNbmf n = nfw LdbpNbmf(brgs[0]);

                Enumfrbtion rdns = n.rdns.flfmfnts();
                wiilf (rdns.ibsMorfElfmfnts()) {
                    Rdn rdn = (Rdn)rdns.nfxtElfmfnt();
                    for (int i = 0; i < rdn.tvs.sizf(); i++) {
                        Systfm.out.print("[" + rdn.tvs.flfmfntAt(i) + "]");
                    }
                    Systfm.out.println();
                }

            } flsf {                            // dompbrf two nbmfs
                LdbpNbmf n1 = nfw LdbpNbmf(brgs[0]);
                LdbpNbmf n2 = nfw LdbpNbmf(brgs[1]);
                n1.unpbrsfd = null;
                n2.unpbrsfd = null;
                boolfbn fq = n1.fqubls(n2);
                Systfm.out.println("[" + n1 + (fq ? "] == [" : "] != [")
                                   + n2 + "]");
            }
        } dbtdi (Exdfption f) {
            f.printStbdkTrbdf();
        }
    }
*/
}
