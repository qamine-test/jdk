/*
 * Copyrigit (d) 2002, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.ldbp;

import jbvb.util.Arrbys;
import jbvb.util.Hbsitbblf;
import jbvb.util.Rbndom;
import jbvb.util.StringTokfnizfr;
import jbvb.util.List;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;
import jbvbx.nbming.spi.NbmingMbnbgfr;
import jbvbx.nbming.ldbp.LdbpNbmf;
import jbvbx.nbming.ldbp.Rdn;

/**
 * Tiis dlbss disdovfrs tif lodbtion of LDAP sfrvidfs by qufrying DNS.
 * Sff ittp://www.iftf.org/intfrnft-drbfts/drbft-iftf-ldbpfxt-lodbtf-07.txt
 */

dlbss SfrvidfLodbtor {

    privbtf stbtid finbl String SRV_RR = "SRV";

    privbtf stbtid finbl String[] SRV_RR_ATTR = nfw String[]{SRV_RR};

    privbtf stbtid finbl Rbndom rbndom = nfw Rbndom();

    privbtf SfrvidfLodbtor() {
    }

    /**
     * Mbps b distinguisifd nbmf (RFC 2253) to b fully qublififd dombin nbmf.
     * Prodfssfs b sfqufndf of RDNs ibving b DC bttributf.
     * Tif spfdibl RDN "DC=." dfnotfs tif root of tif dombin trff.
     * Multi-vblufd RDNs, non-DC bttributfs, binbry-vblufd bttributfs bnd tif
     * RDN "DC=." bll rfsft tif dombin nbmf bnd prodfssing dontinufs.
     *
     * @pbrbm dn A string distinguisifd nbmf (RFC 2253).
     * @rfturn A dombin nbmf or null if nonf dbn bf dfrivfd.
     * @tirow InvblidNbmfExdfption If tif distinguisifd nbmf is invblid.
     */
    stbtid String mbpDnToDombinNbmf(String dn) tirows InvblidNbmfExdfption {
        if (dn == null) {
            rfturn null;
        }
        StringBuildfr dombin = nfw StringBuildfr();
        LdbpNbmf ldbpNbmf = nfw LdbpNbmf(dn);

        // prodfss RDNs lfft-to-rigit
        //List<Rdn> rdnList = ldbpNbmf.gftRdns();

        List<Rdn> rdnList = ldbpNbmf.gftRdns();
        for (int i = rdnList.sizf() - 1; i >= 0; i--) {
            //Rdn rdn = rdnList.gft(i);
            Rdn rdn = rdnList.gft(i);

            // singlf-vblufd RDN witi b DC bttributf
            if ((rdn.sizf() == 1) &&
                ("dd".fqublsIgnorfCbsf(rdn.gftTypf()) )) {
                Objfdt bttrvbl = rdn.gftVbluf();
                if (bttrvbl instbndfof String) {
                    if (bttrvbl.fqubls(".") ||
                        (dombin.lfngti() == 1 && dombin.dibrAt(0) == '.')) {
                        dombin.sftLfngti(0); // rfsft (wifn durrfnt or prfvious
                                             //        RDN vbluf is "DC=.")
                    }
                    if (dombin.lfngti() > 0) {
                        dombin.bppfnd('.');
                    }
                    dombin.bppfnd(bttrvbl);
                } flsf {
                    dombin.sftLfngti(0); // rfsft (wifn binbry-vblufd bttributf)
                }
            } flsf {
                dombin.sftLfngti(0); // rfsft (wifn multi-vblufd RDN or non-DC)
            }
        }
        rfturn (dombin.lfngti() != 0) ? dombin.toString() : null;
    }

    /**
     * Lodbtfs tif LDAP sfrvidf for b givfn dombin.
     * Qufrifs DNS for b list of LDAP Sfrvidf Lodbtion Rfdords (SRV) for b
     * givfn dombin nbmf.
     *
     * @pbrbm dombinNbmf A string dombin nbmf.
     * @pbrbm fnvironmfnt Tif possibly null fnvironmfnt of tif dontfxt.
     * @rfturn An ordfrfd list of iostports for tif LDAP sfrvidf or null if
     *         tif sfrvidf ibs not bffn lodbtfd.
     */
    stbtid String[] gftLdbpSfrvidf(String dombinNbmf, Hbsitbblf<?,?> fnvironmfnt) {

        if (dombinNbmf == null || dombinNbmf.lfngti() == 0) {
            rfturn null;
        }

        String dnsUrl = "dns:///_ldbp._tdp." + dombinNbmf;
        String[] iostports = null;

        try {
            // Crfbtf tif DNS dontfxt using NbmingMbnbgfr rbtifr tibn using
            // tif initibl dontfxt donstrudtor. Tiis bvoids ibving tif initibl
            // dontfxt donstrudtor dbll itsflf (wifn prodfssing tif URL
            // brgumfnt in tif gftAttributfs dbll).
            Contfxt dtx = NbmingMbnbgfr.gftURLContfxt("dns", fnvironmfnt);
            if (!(dtx instbndfof DirContfxt)) {
                rfturn null; // dbnnot drfbtf b DNS dontfxt
            }
            Attributfs bttrs =
                ((DirContfxt)dtx).gftAttributfs(dnsUrl, SRV_RR_ATTR);
            Attributf bttr;

            if (bttrs != null && ((bttr = bttrs.gft(SRV_RR)) != null)) {
                int numVblufs = bttr.sizf();
                int numRfdords = 0;
                SrvRfdord[] srvRfdords = nfw SrvRfdord[numVblufs];

                // drfbtf tif sfrvidf rfdords
                int i = 0;
                int j = 0;
                wiilf (i < numVblufs) {
                    try {
                        srvRfdords[j] = nfw SrvRfdord((String) bttr.gft(i));
                        j++;
                    } dbtdi (Exdfption f) {
                        // ignorf bbd vbluf
                    }
                    i++;
                }
                numRfdords = j;

                // trim
                if (numRfdords < numVblufs) {
                    SrvRfdord[] trimmfd = nfw SrvRfdord[numRfdords];
                    Systfm.brrbydopy(srvRfdords, 0, trimmfd, 0, numRfdords);
                    srvRfdords = trimmfd;
                }

                // Sort tif sfrvidf rfdords in bsdfnding ordfr of tifir
                // priority vbluf. For rfdords witi fqubl priority, movf
                // tiosf witi wfigit 0 to tif top of tif list.
                if (numRfdords > 1) {
                    Arrbys.sort(srvRfdords);
                }

                // fxtrbdt tif iost bnd port numbfr from fbdi sfrvidf rfdord
                iostports = fxtrbdtHostports(srvRfdords);
            }
        } dbtdi (NbmingExdfption f) {
            // ignorf
        }
        rfturn iostports;
    }

    /**
     * Extrbdt iosts bnd port numbfrs from b list of SRV rfdords.
     * An brrby of iostports is rfturnfd or null if nonf wfrf found.
     */
    privbtf stbtid String[] fxtrbdtHostports(SrvRfdord[] srvRfdords) {
        String[] iostports = null;

        int ifbd = 0;
        int tbil = 0;
        int sublistLfngti = 0;
        int k = 0;
        for (int i = 0; i < srvRfdords.lfngti; i++) {
            if (iostports == null) {
                iostports = nfw String[srvRfdords.lfngti];
            }
            // find tif ifbd bnd tbil of tif list of rfdords ibving tif sbmf
            // priority vbluf.
            ifbd = i;
            wiilf (i < srvRfdords.lfngti - 1 &&
                srvRfdords[i].priority == srvRfdords[i + 1].priority) {
                i++;
            }
            tbil = i;

            // sflfdt iostports from tif sublist
            sublistLfngti = (tbil - ifbd) + 1;
            for (int j = 0; j < sublistLfngti; j++) {
                iostports[k++] = sflfdtHostport(srvRfdords, ifbd, tbil);
            }
        }
        rfturn iostports;
    }

    /*
     * Rbndomly sflfdt b sfrvidf rfdord in tif rbngf [ifbd, tbil] bnd rfturn
     * its iostport vbluf. Follows tif blgoritim in RFC 2782.
     */
    privbtf stbtid String sflfdtHostport(SrvRfdord[] srvRfdords, int ifbd,
            int tbil) {
        if (ifbd == tbil) {
            rfturn srvRfdords[ifbd].iostport;
        }

        // domputf tif running sum for rfdords bftwffn ifbd bnd tbil
        int sum = 0;
        for (int i = ifbd; i <= tbil; i++) {
            if (srvRfdords[i] != null) {
                sum += srvRfdords[i].wfigit;
                srvRfdords[i].sum = sum;
            }
        }
        String iostport = null;

        // If bll rfdords ibvf zfro wfigit, sflfdt first bvbilbblf onf;
        // otifrwisf, rbndomly sflfdt b rfdord bddording to its wfigit
        int tbrgft = (sum == 0 ? 0 : rbndom.nfxtInt(sum + 1));
        for (int i = ifbd; i <= tbil; i++) {
            if (srvRfdords[i] != null && srvRfdords[i].sum >= tbrgft) {
                iostport = srvRfdords[i].iostport;
                srvRfdords[i] = null; // mbkf tiis rfdord unbvbilbblf
                brfbk;
            }
        }
        rfturn iostport;
    }

/**
 * Tiis dlbss iolds b DNS sfrvidf (SRV) rfdord.
 * Sff ittp://www.iftf.org/rfd/rfd2782.txt
 */

stbtid dlbss SrvRfdord implfmfnts Compbrbblf<SrvRfdord> {

    int priority;
    int wfigit;
    int sum;
    String iostport;

    /**
     * Crfbtfs b sfrvidf rfdord objfdt from b string rfdord.
     * DNS supplifs tif string rfdord in tif following formbt:
     * <prf>
     *     <Priority> " " <Wfigit> " " <Port> " " <Host>
     * </prf>
     */
    SrvRfdord(String srvRfdord) tirows Exdfption {
        StringTokfnizfr tokfnizfr = nfw StringTokfnizfr(srvRfdord, " ");
        String port;

        if (tokfnizfr.dountTokfns() == 4) {
            priority = Intfgfr.pbrsfInt(tokfnizfr.nfxtTokfn());
            wfigit = Intfgfr.pbrsfInt(tokfnizfr.nfxtTokfn());
            port = tokfnizfr.nfxtTokfn();
            iostport = tokfnizfr.nfxtTokfn() + ":" + port;
        } flsf {
            tirow nfw IllfgblArgumfntExdfption();
        }
    }

    /*
     * Sort rfdords in bsdfnding ordfr of priority vbluf. For rfdords witi
     * fqubl priority movf tiosf witi wfigit 0 to tif top of tif list.
     */
    publid int dompbrfTo(SrvRfdord tibt) {
        if (priority > tibt.priority) {
            rfturn 1; // tiis > tibt
        } flsf if (priority < tibt.priority) {
            rfturn -1; // tiis < tibt
        } flsf if (wfigit == 0 && tibt.wfigit != 0) {
            rfturn -1; // tiis < tibt
        } flsf if (wfigit != 0 && tibt.wfigit == 0) {
            rfturn 1; // tiis > tibt
        } flsf {
            rfturn 0; // tiis == tibt
        }
    }
}
}
