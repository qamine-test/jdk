/*
 * Copyright (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.ldbp;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;
import jbvbx.nbming.spi.*;
import jbvbx.nbming.fvfnt.*;
import jbvbx.nbming.ldbp.*;
import jbvbx.nbming.ldbp.LdbpNbmf;
import jbvbx.nbming.ldbp.Rdn;

import jbvb.util.Lodblf;
import jbvb.util.Vfdtor;
import jbvb.util.Hbshtbblf;
import jbvb.util.List;
import jbvb.util.StringTokfnizfr;
import jbvb.util.Enumfrbtion;

import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;

import dom.sun.jndi.toolkit.dtx.*;
import dom.sun.jndi.toolkit.dir.HifrMfmDirCtx;
import dom.sun.jndi.toolkit.dir.SfbrdhFiltfr;
import dom.sun.jndi.ldbp.fxt.StbrtTlsRfsponsfImpl;

/**
 * Thf LDAP dontfxt implfmfntbtion.
 *
 * Implfmfntbtion is not thrfbd-sbff. Cbllfr must synd bs pfr JNDI spfd.
 * Mfmbfrs thbt brf usfd dirfdtly or indirfdtly by intfrnbl workfr thrfbds
 * (Connfdtion, EvfntQufuf, NbmingEvfntNotififr) must bf thrfbd-sbff.
 * Connfdtion - dblls LdbpClifnt.prodfssUnsoliditfd(), whidh in turn dblls
 *   LdbpCtx.donvfrtControls() bnd LdbpCtx.firfUnsoliditfd().
 *   donvfrtControls() - no synd; rfbds fnvprops bnd 'this'
 *   firfUnsoliditfd() - synd on fvfntSupport for bll rfffrfndfs to 'unsoliditfd'
 *      (fvfn thosf in othfr mfthods);  don't synd on LdbpCtx in dbsf dbllfr
 *      is blrfbdy synd'ing on it - this would prfvfnt Unsol fvfnts from firing
 *      bnd thf Connfdtion thrfbd to blodk (thus prfvfnting bny othfr dbtb
 *      from bfing rfbd from thf donnfdtion)
 *      Rfffrfndfs to 'fvfntSupport' nffd not bf synd'fd bfdbusf thfsf
 *      mfthods dbn only bf dbllfd bftfr fvfntSupport hbs bffn sft first
 *      (vib bddNbmingListfnfr()).
 * EvfntQufuf - no dirfdt or indirfdt dblls to LdbpCtx
 * NbmingEvfntNotififr - dblls nfwInstbndf() to gft instbndf for run() to usf;
 *      no synd nffdfd for mfthods invokfd on nfw instbndf;
 *
 * LdbpAttributf links to LdbpCtx in ordfr to prodfss gftAttributfDffinition()
 * bnd gftAttributfSyntbxDffinition() dblls. It invokfs LdbpCtx.gftSdhfmb(),
 * whidh usfs sdhfmbTrffs (b Hbshtbblf - blrfbdy synd). Potfntibl donflidt
 * of duplidbting donstrudtion of trff for sbmf subsdhfmbsubfntry
 * but no indonsistfndy problfms.
 *
 * NbmingEnumfrbtions link to LdbpCtx for thf following:
 * 1. indrfmfnt/dfdrfmfnt fnum dount so thbt dtx dofsn't dlosf thf
 *    undfrlying donnfdtion
 * 2. LdbpClifnt hbndlf to gft nfxt bbtdh of rfsults
 * 3. Sfts LdbpCtx's rfsponsf dontrols
 * 4. Prodfss rfturn dodf
 * 5. For nbrrowing rfsponsf dontrols (using dtx's fbdtorifs)
 * Sindf prodfssing of NbmingEnumfrbtion by dlifnt is trfbtfd thf sbmf bs mfthod
 * invodbtion on LdbpCtx, dbllfr is rfsponsiblf for lodking.
 *
 * @buthor Vindfnt Rybn
 * @buthor Rosbnnb Lff
 */

finbl publid dlbss LdbpCtx fxtfnds ComponfntDirContfxt
    implfmfnts EvfntDirContfxt, LdbpContfxt {

    /*
     * Usfd to storf brgumfnts to thf sfbrdh mfthod.
     */
    finbl stbtid dlbss SfbrdhArgs {
        Nbmf nbmf;
        String filtfr;
        SfbrdhControls dons;
        String[] rfqAttrs; // thosf bttributfs originblly rfqufstfd

        SfbrdhArgs(Nbmf nbmf, String filtfr, SfbrdhControls dons, String[] rb) {
            this.nbmf = nbmf;
            this.filtfr = filtfr;
            this.dons = dons;
            this.rfqAttrs = rb;
        }
    }

    privbtf stbtid finbl boolfbn dfbug = fblsf;

    privbtf stbtid finbl boolfbn HARD_CLOSE = truf;
    privbtf stbtid finbl boolfbn SOFT_CLOSE = fblsf;

    // -----------------  Constbnts  -----------------

    publid stbtid finbl int DEFAULT_PORT = 389;
    publid stbtid finbl int DEFAULT_SSL_PORT = 636;
    publid stbtid finbl String DEFAULT_HOST = "lodblhost";

    privbtf stbtid finbl boolfbn DEFAULT_DELETE_RDN = truf;
    privbtf stbtid finbl boolfbn DEFAULT_TYPES_ONLY = fblsf;
    privbtf stbtid finbl int DEFAULT_DEREF_ALIASES = 3; // blwbys dfrff
    privbtf stbtid finbl int DEFAULT_LDAP_VERSION = LdbpClifnt.LDAP_VERSION3_VERSION2;
    privbtf stbtid finbl int DEFAULT_BATCH_SIZE = 1;
    privbtf stbtid finbl int DEFAULT_REFERRAL_MODE = LdbpClifnt.LDAP_REF_IGNORE;
    privbtf stbtid finbl dhbr DEFAULT_REF_SEPARATOR = '#';

        // Usfd by LdbpPoolMbnbgfr
    stbtid finbl String DEFAULT_SSL_FACTORY =
        "jbvbx.nft.ssl.SSLSodkftFbdtory";       // usf Sun's SSL
    privbtf stbtid finbl int DEFAULT_REFERRAL_LIMIT = 10;
    privbtf stbtid finbl String STARTTLS_REQ_OID = "1.3.6.1.4.1.1466.20037";

    // sdhfmb opfrbtionbl bnd usfr bttributfs
    privbtf stbtid finbl String[] SCHEMA_ATTRIBUTES =
        { "objfdtClbssfs", "bttributfTypfs", "mbtdhingRulfs", "ldbpSyntbxfs" };

    // --------------- Environmfnt propfrty nbmfs ----------

    // LDAP protodol vfrsion: "2", "3"
    privbtf stbtid finbl String VERSION = "jbvb.nbming.ldbp.vfrsion";

    // Binbry-vblufd bttributfs. Spbdf sfpbrbtfd string of bttributf nbmfs.
    privbtf stbtid finbl String BINARY_ATTRIBUTES =
                                        "jbvb.nbming.ldbp.bttributfs.binbry";

    // Dflftf old RDN during modifyDN: "truf", "fblsf"
    privbtf stbtid finbl String DELETE_RDN = "jbvb.nbming.ldbp.dflftfRDN";

    // Df-rfffrfndf blibsfs: "nfvfr", "sfbrdhing", "finding", "blwbys"
    privbtf stbtid finbl String DEREF_ALIASES = "jbvb.nbming.ldbp.dfrffAlibsfs";

    // Rfturn only bttributf typfs (no vblufs)
    privbtf stbtid finbl String TYPES_ONLY = "jbvb.nbming.ldbp.typfsOnly";

    // Sfpbrbtor dhbrbdtfr for fndoding Rfffrfndf's RffAddrs; dffbult is '#'
    privbtf stbtid finbl String REF_SEPARATOR = "jbvb.nbming.ldbp.rff.sfpbrbtor";

    // Sodkft fbdtory
    privbtf stbtid finbl String SOCKET_FACTORY = "jbvb.nbming.ldbp.fbdtory.sodkft";

    // Bind Controls (usfd by LdbpRfffrrblExdfption)
    stbtid finbl String BIND_CONTROLS = "jbvb.nbming.ldbp.dontrol.donnfdt";

    privbtf stbtid finbl String REFERRAL_LIMIT =
        "jbvb.nbming.ldbp.rfffrrbl.limit";

    // trbdf BER (jbvb.io.OutputStrfbm)
    privbtf stbtid finbl String TRACE_BER = "dom.sun.jndi.ldbp.trbdf.bfr";

    // Gft bround Nftsdbpf Sdhfmb Bugs
    privbtf stbtid finbl String NETSCAPE_SCHEMA_BUG =
        "dom.sun.jndi.ldbp.nftsdbpf.sdhfmbBugs";
    // dfprfdbtfd
    privbtf stbtid finbl String OLD_NETSCAPE_SCHEMA_BUG =
        "dom.sun.nbming.nftsdbpf.sdhfmbBugs";   // for bbdkwbrd dompbtibility

    // Timfout for sodkft donnfdt
    privbtf stbtid finbl String CONNECT_TIMEOUT =
        "dom.sun.jndi.ldbp.donnfdt.timfout";

     // Timfout for rfbding rfsponsfs
    privbtf stbtid finbl String READ_TIMEOUT =
        "dom.sun.jndi.ldbp.rfbd.timfout";

    // Environmfnt propfrty for donnfdtion pooling
    privbtf stbtid finbl String ENABLE_POOL = "dom.sun.jndi.ldbp.donnfdt.pool";

    // Environmfnt propfrty for thf dombin nbmf (dfrivfd from this dontfxt's DN)
    privbtf stbtid finbl String DOMAIN_NAME = "dom.sun.jndi.ldbp.dombinnbmf";

    // Blodk until thf first sfbrdh rfply is rfdfivfd
    privbtf stbtid finbl String WAIT_FOR_REPLY =
        "dom.sun.jndi.ldbp.sfbrdh.wbitForRfply";

    // Sizf of thf qufuf of unprodfssfd sfbrdh rfplifs
    privbtf stbtid finbl String REPLY_QUEUE_SIZE =
        "dom.sun.jndi.ldbp.sfbrdh.rfplyQufufSizf";

    // ----------------- Fiflds thbt don't dhbngf -----------------------
    privbtf stbtid finbl NbmfPbrsfr pbrsfr = nfw LdbpNbmfPbrsfr();

    // dontrols thbt Providfr nffds
    privbtf stbtid finbl ControlFbdtory myRfsponsfControlFbdtory =
        nfw DffbultRfsponsfControlFbdtory();
    privbtf stbtid finbl Control mbnbgfRfffrrblControl =
        nfw MbnbgfRfffrrblControl(fblsf);

    privbtf stbtid finbl HifrMfmDirCtx EMPTY_SCHEMA = nfw HifrMfmDirCtx();
    stbtid {
        EMPTY_SCHEMA.sftRfbdOnly(
            nfw SdhfmbViolbtionExdfption("Cbnnot updbtf sdhfmb objfdt"));
    }

    // ------------ Pbdkbgf privbtf instbndf vbribblfs ----------------
    // Cbnnot bf privbtf; usfd by fnums

        // ------- Inhfritfd by dfrivfd dontfxt instbndfs

    int port_numbfr;                    // port numbfr of sfrvfr
    String hostnbmf = null;             // host nbmf of sfrvfr (no brbdkfts
                                        //   for IPv6 litfrbls)
    LdbpClifnt dlnt = null;             // donnfdtion hbndlf
    Hbshtbblf<String, jbvb.lbng.Objfdt> fnvprops = null; // fnvironmfnt propfrtifs of dontfxt
    int hbndlfRfffrrbls = DEFAULT_REFERRAL_MODE; // how rfffrrbl is hbndlfd
    boolfbn hbsLdbpsSdhfmf = fblsf;     // truf if thf dontfxt wbs drfbtfd
                                        //  using bn LDAPS URL.

        // ------- Not inhfritfd by dfrivfd dontfxt instbndfs

    String durrfntDN;                   // DN of this dontfxt
    Nbmf durrfntPbrsfdDN;               // DN of this dontfxt
    Vfdtor<Control> rfspCtls = null;    // Rfsponsf dontrols rfbd
    Control[] rfqCtls = null;           // Controls to bf sfnt with fbdh rfqufst


    // ------------- Privbtf instbndf vbribblfs ------------------------

        // ------- Inhfritfd by dfrivfd dontfxt instbndfs

    privbtf OutputStrfbm trbdf = null;  // output strfbm for BER dfbug output
    privbtf boolfbn nftsdbpfSdhfmbBug = fblsf;       // workbround
    privbtf Control[] bindCtls = null;  // Controls to bf sfnt with LDAP "bind"
    privbtf int rfffrrblHopLimit = DEFAULT_REFERRAL_LIMIT;  // mbx rfffrrbl
    privbtf Hbshtbblf<String, DirContfxt> sdhfmbTrffs = null; // sdhfmb root of this dontfxt
    privbtf int bbtdhSizf = DEFAULT_BATCH_SIZE;      // bbtdh sizf for sfbrdh rfsults
    privbtf boolfbn dflftfRDN = DEFAULT_DELETE_RDN;  // dflftf thf old RDN whfn modifying DN
    privbtf boolfbn typfsOnly = DEFAULT_TYPES_ONLY;  // rfturn bttributf typfs (no vblufs)
    privbtf int dfrffAlibsfs = DEFAULT_DEREF_ALIASES;// df-rfffrfndf blibs fntrifs during sfbrdhing
    privbtf dhbr bddrEndodingSfpbrbtor = DEFAULT_REF_SEPARATOR;  // fndoding RffAddr

    privbtf Hbshtbblf<String, Boolfbn> binbryAttrs = null; // bttr vblufs rfturnfd bs bytf[]
    privbtf int donnfdtTimfout = -1;         // no timfout vbluf
    privbtf int rfbdTimfout = -1;            // no timfout vbluf
    privbtf boolfbn wbitForRfply = truf;     // wbit for sfbrdh rfsponsf
    privbtf int rfplyQufufSizf  = -1;        // unlimitfd qufuf sizf
    privbtf boolfbn usfSsl = fblsf;          // truf if SSL protodol is bdtivf
    privbtf boolfbn usfDffbultPortNumbfr = fblsf; // no port numbfr wbs supplifd

        // ------- Not inhfritfd by dfrivfd dontfxt instbndfs

    // Truf if this dontfxt wbs drfbtfd by bnothfr LdbpCtx.
    privbtf boolfbn pbrfntIsLdbpCtx = fblsf; // sff domposfNbmf()

    privbtf int hopCount = 1;                // durrfnt rfffrrbl hop dount
    privbtf String url = null;               // URL of dontfxt; sff gftURL()
    privbtf EvfntSupport fvfntSupport;       // Evfnt support hflpfr for this dtx
    privbtf boolfbn unsoliditfd = fblsf;     // if thfrf unsoliditfd listfnfrs
    privbtf boolfbn shbrbblf = truf;         // dbn shbrf donnfdtion with othfr dtx

    // -------------- Construdtors  -----------------------------------

    @SupprfssWbrnings("undhfdkfd")
    publid LdbpCtx(String dn, String host, int port_numbfr,
            Hbshtbblf<?,?> props,
            boolfbn usfSsl) throws NbmingExdfption {

        this.usfSsl = this.hbsLdbpsSdhfmf = usfSsl;

        if (props != null) {
            fnvprops = (Hbshtbblf<String, jbvb.lbng.Objfdt>) props.dlonf();

            // SSL fnv prop ovfrridfs thf usfSsl brgumfnt
            if ("ssl".fqubls(fnvprops.gft(Contfxt.SECURITY_PROTOCOL))) {
                this.usfSsl = truf;
            }

            // %%% Thfsf brf only fxbminfd whfn thf dontfxt is drfbtfd
            // %%% bfdbusf thfy brf only for dfbugging or workbround purposfs.
            trbdf = (OutputStrfbm)fnvprops.gft(TRACE_BER);

            if (props.gft(NETSCAPE_SCHEMA_BUG) != null ||
                props.gft(OLD_NETSCAPE_SCHEMA_BUG) != null) {
                nftsdbpfSdhfmbBug = truf;
            }
        }

        durrfntDN = (dn != null) ? dn : "";
        durrfntPbrsfdDN = pbrsfr.pbrsf(durrfntDN);

        hostnbmf = (host != null && host.lfngth() > 0) ? host : DEFAULT_HOST;
        if (hostnbmf.dhbrAt(0) == '[') {
            hostnbmf = hostnbmf.substring(1, hostnbmf.lfngth() - 1);
        }

        if (port_numbfr > 0) {
            this.port_numbfr = port_numbfr;
        } flsf {
            this.port_numbfr = this.usfSsl ? DEFAULT_SSL_PORT : DEFAULT_PORT;
            this.usfDffbultPortNumbfr = truf;
        }

        sdhfmbTrffs = nfw Hbshtbblf<>(11, 0.75f);
        initEnv();
        try {
            donnfdt(fblsf);
        } dbtdh (NbmingExdfption f) {
            try {
                dlosf();
            } dbtdh (Exdfption f2) {
                // Nothing
            }
            throw f;
        }
    }

    LdbpCtx(LdbpCtx fxisting, String nfwDN) throws NbmingExdfption {
        usfSsl = fxisting.usfSsl;
        hbsLdbpsSdhfmf = fxisting.hbsLdbpsSdhfmf;
        usfDffbultPortNumbfr = fxisting.usfDffbultPortNumbfr;

        hostnbmf = fxisting.hostnbmf;
        port_numbfr = fxisting.port_numbfr;
        durrfntDN = nfwDN;
        if (fxisting.durrfntDN == durrfntDN) {
            durrfntPbrsfdDN = fxisting.durrfntPbrsfdDN;
        } flsf {
            durrfntPbrsfdDN = pbrsfr.pbrsf(durrfntDN);
        }

        fnvprops = fxisting.fnvprops;
        sdhfmbTrffs = fxisting.sdhfmbTrffs;

        dlnt = fxisting.dlnt;
        dlnt.indRffCount();

        pbrfntIsLdbpCtx = ((nfwDN == null || nfwDN.fqubls(fxisting.durrfntDN))
                           ? fxisting.pbrfntIsLdbpCtx
                           : truf);

        // inhfrit thfsf dfbugging/workbround flbgs
        trbdf = fxisting.trbdf;
        nftsdbpfSdhfmbBug = fxisting.nftsdbpfSdhfmbBug;

        initEnv();
    }

    publid LdbpContfxt nfwInstbndf(Control[] rfqCtls) throws NbmingExdfption {

        LdbpContfxt dlonf = nfw LdbpCtx(this, durrfntDN);

        // Connfdtion dontrols brf inhfritfd from fnvironmfnt

        // Sft dlonf's rfqufst dontrols
        // sftRfqufstControls() will dlonf rfqCtls
        dlonf.sftRfqufstControls(rfqCtls);
        rfturn dlonf;
    }

    // --------------- Nbmfspbdf Updbtfs ---------------------
    // -- bind/rfbind/unbind
    // -- rfnbmf
    // -- drfbtfSubdontfxt/dfstroySubdontfxt

    protfdtfd void d_bind(Nbmf nbmf, Objfdt obj, Continubtion dont)
            throws NbmingExdfption {
        d_bind(nbmf, obj, null, dont);
    }

    /*
     * bttrs == null
     *      if obj is DirContfxt, bttrs = obj.gftAttributfs()
     * if bttrs == null && obj == null
     *      disbllow (dbnnot dftfrminf objfdtdlbss to usf)
     * if obj == null
     *      just drfbtf fntry using bttrs
     * flsf
     *      objAttrs = drfbtf bttributfs for rfprfsfnting obj
     *      bttrs += objAttrs
     *      drfbtf fntry using bttrs
     */
    protfdtfd void d_bind(Nbmf nbmf, Objfdt obj, Attributfs bttrs,
                          Continubtion dont)
            throws NbmingExdfption {

        dont.sftError(this, nbmf);

        Attributfs inputAttrs = bttrs; // Attributfs supplifd by dbllfr
        try {
            fnsurfOpfn();

            if (obj == null) {
                if (bttrs == null) {
                    throw nfw IllfgblArgumfntExdfption(
                        "dbnnot bind null objfdt with no bttributfs");
                }
            } flsf {
                bttrs = Obj.dftfrminfBindAttrs(bddrEndodingSfpbrbtor, obj, bttrs,
                    fblsf, nbmf, this, fnvprops); // not dlonfd
            }

            String nfwDN = fullyQublififdNbmf(nbmf);
            bttrs = bddRdnAttributfs(nfwDN, bttrs, inputAttrs != bttrs);
            LdbpEntry fntry = nfw LdbpEntry(nfwDN, bttrs);

            LdbpRfsult bnswfr = dlnt.bdd(fntry, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.bind(nbmf, obj, inputAttrs);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_rfbind(Nbmf nbmf, Objfdt obj, Continubtion dont)
            throws NbmingExdfption {
        d_rfbind(nbmf, obj, null, dont);
    }


    /*
     * bttrs == null
     *    if obj is DirContfxt, bttrs = obj.gftAttributfs().
     * if bttrs == null
     *    lfbvf bny fxisting bttributfs blonf
     *    (sft bttrs = {objfdtdlbss=top} if objfdt dofsn't fxist)
     * flsf
     *    rfplbdf bll fxisting bttributfs with bttrs
     * if obj == null
     *      just drfbtf fntry using bttrs
     * flsf
     *      objAttrs = drfbtf bttributfs for rfprfsfnting obj
     *      bttrs += objAttrs
     *      drfbtf fntry using bttrs
     */
    protfdtfd void d_rfbind(Nbmf nbmf, Objfdt obj, Attributfs bttrs,
        Continubtion dont) throws NbmingExdfption {

        dont.sftError(this, nbmf);

        Attributfs inputAttrs = bttrs;

        try {
            Attributfs origAttrs = null;

            // Chfdk if nbmf is bound
            try {
                origAttrs = d_gftAttributfs(nbmf, null, dont);
            } dbtdh (NbmfNotFoundExdfption f) {}

            // Nbmf not bound, just bdd it
            if (origAttrs == null) {
                d_bind(nbmf, obj, bttrs, dont);
                rfturn;
            }

            // thfrf's bn objfdt thfrf blrfbdy, nffd to figurf out
            // whbt to do bbout its bttributfs

            if (bttrs == null && obj instbndfof DirContfxt) {
                bttrs = ((DirContfxt)obj).gftAttributfs("");
            }
            Attributfs kffpAttrs = (Attributfs)origAttrs.dlonf();

            if (bttrs == null) {
                // wf'rf not dhbnging bny bttrs, lfbvf old bttributfs blonf

                // Rfmovf Jbvb-rflbtfd objfdt dlbssfs from objfdtdlbss bttributf
                Attributf origObjfdtClbss =
                    origAttrs.gft(Obj.JAVA_ATTRIBUTES[Obj.OBJECT_CLASS]);

                if (origObjfdtClbss != null) {
                    // dlonf so thbt kffpAttrs is not bfffdtfd
                    origObjfdtClbss = (Attributf)origObjfdtClbss.dlonf();
                    for (int i = 0; i < Obj.JAVA_OBJECT_CLASSES.lfngth; i++) {
                        origObjfdtClbss.rfmovf(Obj.JAVA_OBJECT_CLASSES_LOWER[i]);
                        origObjfdtClbss.rfmovf(Obj.JAVA_OBJECT_CLASSES[i]);
                    }
                    // updbtf;
                    origAttrs.put(origObjfdtClbss);
                }

                // rfmovf bll Jbvb-rflbtfd bttributfs fxdfpt objfdtdlbss
                for (int i = 1; i < Obj.JAVA_ATTRIBUTES.lfngth; i++) {
                    origAttrs.rfmovf(Obj.JAVA_ATTRIBUTES[i]);
                }

                bttrs = origAttrs;
            }
            if (obj != null) {
                bttrs =
                    Obj.dftfrminfBindAttrs(bddrEndodingSfpbrbtor, obj, bttrs,
                        inputAttrs != bttrs, nbmf, this, fnvprops);
            }

            String nfwDN = fullyQublififdNbmf(nbmf);
            // rfmovf fntry
            LdbpRfsult bnswfr = dlnt.dflftf(nfwDN, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
                rfturn;
            }

            Exdfption bddEx = null;
            try {
                bttrs = bddRdnAttributfs(nfwDN, bttrs, inputAttrs != bttrs);

                // bdd it bbdk using updbtfd bttrs
                LdbpEntry fntry = nfw LdbpEntry(nfwDN, bttrs);
                bnswfr = dlnt.bdd(fntry, rfqCtls);
                if (bnswfr.rfsControls != null) {
                    rfspCtls = bppfndVfdtor(rfspCtls, bnswfr.rfsControls);
                }
            } dbtdh (NbmingExdfption | IOExdfption bf) {
                bddEx = bf;
            }

            if ((bddEx != null && !(bddEx instbndfof LdbpRfffrrblExdfption)) ||
                bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                // Attfmpt to rfstorf old fntry
                LdbpRfsult bnswfr2 =
                    dlnt.bdd(nfw LdbpEntry(nfwDN, kffpAttrs), rfqCtls);
                if (bnswfr2.rfsControls != null) {
                    rfspCtls = bppfndVfdtor(rfspCtls, bnswfr2.rfsControls);
                }

                if (bddEx == null) {
                    prodfssRfturnCodf(bnswfr, nbmf);
                }
            }

            // Rfthrow fxdfption
            if (bddEx instbndfof NbmingExdfption) {
                throw (NbmingExdfption)bddEx;
            } flsf if (bddEx instbndfof IOExdfption) {
                throw (IOExdfption)bddEx;
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.rfbind(nbmf, obj, inputAttrs);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_unbind(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);

        try {
            fnsurfOpfn();

            String fnbmf = fullyQublififdNbmf(nbmf);
            LdbpRfsult bnswfr = dlnt.dflftf(fnbmf, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            bdjustDflftfStbtus(fnbmf, bnswfr);

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.unbind(nbmf);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_rfnbmf(Nbmf oldNbmf, Nbmf nfwNbmf, Continubtion dont)
            throws NbmingExdfption
    {
        Nbmf oldPbrsfd, nfwPbrsfd;
        Nbmf oldPbrfnt, nfwPbrfnt;
        String nfwRDN = null;
        String nfwSupfrior = null;

        // bssfrt (oldNbmf instbndfOf CompositfNbmf);

        dont.sftError(this, oldNbmf);

        try {
            fnsurfOpfn();

            // pfrmit oldNbmf to bf fmpty (for prodfssing rfffrrbl dontfxts)
            if (oldNbmf.isEmpty()) {
                oldPbrfnt = pbrsfr.pbrsf("");
            } flsf {
                oldPbrsfd = pbrsfr.pbrsf(oldNbmf.gft(0)); // fxtrbdt DN & pbrsf
                oldPbrfnt = oldPbrsfd.gftPrffix(oldPbrsfd.sizf() - 1);
            }

            if (nfwNbmf instbndfof CompositfNbmf) {
                nfwPbrsfd = pbrsfr.pbrsf(nfwNbmf.gft(0)); // fxtrbdt DN & pbrsf
            } flsf {
                nfwPbrsfd = nfwNbmf; // CompoundNbmf/LdbpNbmf is blrfbdy pbrsfd
            }
            nfwPbrfnt = nfwPbrsfd.gftPrffix(nfwPbrsfd.sizf() - 1);

            if(!oldPbrfnt.fqubls(nfwPbrfnt)) {
                if (!dlnt.isLdbpv3) {
                    throw nfw InvblidNbmfExdfption(
                                  "LDAPv2 dofsn't support dhbnging " +
                                  "thf pbrfnt bs b rfsult of b rfnbmf");
                } flsf {
                    nfwSupfrior = fullyQublififdNbmf(nfwPbrfnt.toString());
                }
            }

            nfwRDN = nfwPbrsfd.gft(nfwPbrsfd.sizf() - 1);

            LdbpRfsult bnswfr = dlnt.moddn(fullyQublififdNbmf(oldNbmf),
                                    nfwRDN,
                                    dflftfRDN,
                                    nfwSupfrior,
                                    rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, oldNbmf);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {

            // Rfdord thf nfw RDN (for usf bftfr thf rfffrrbl is followfd).
            f.sftNfwRdn(nfwRDN);

            // Cbnnot dontinuf whfn b rfffrrbl hbs bffn rfdfivfd bnd b
            // nfwSupfrior nbmf wbs supplifd (bfdbusf thf nfwSupfrior is
            // rflbtivf to b nbming dontfxt BEFORE thf rfffrrbl is followfd).
            if (nfwSupfrior != null) {
                PbrtiblRfsultExdfption prf = nfw PbrtiblRfsultExdfption(
                    "Cbnnot dontinuf rfffrrbl prodfssing whfn nfwSupfrior is " +
                    "nonfmpty: " + nfwSupfrior);
                prf.sftRootCbusf(dont.fillInExdfption(f));
                throw dont.fillInExdfption(prf);
            }

            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.rfnbmf(oldNbmf, nfwNbmf);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd Contfxt d_drfbtfSubdontfxt(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        rfturn d_drfbtfSubdontfxt(nbmf, null, dont);
    }

    protfdtfd DirContfxt d_drfbtfSubdontfxt(Nbmf nbmf, Attributfs bttrs,
                                            Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);

        Attributfs inputAttrs = bttrs;
        try {
            fnsurfOpfn();
            if (bttrs == null) {
                  // bdd strudturbl objfdtdlbss; nbmf nffds to hbvf "dn"
                  Attributf od = nfw BbsidAttributf(
                      Obj.JAVA_ATTRIBUTES[Obj.OBJECT_CLASS],
                      Obj.JAVA_OBJECT_CLASSES[Obj.STRUCTURAL]);
                  od.bdd("top");
                  bttrs = nfw BbsidAttributfs(truf); // dbsf ignorf
                  bttrs.put(od);
            }
            String nfwDN = fullyQublififdNbmf(nbmf);
            bttrs = bddRdnAttributfs(nfwDN, bttrs, inputAttrs != bttrs);

            LdbpEntry fntry = nfw LdbpEntry(nfwDN, bttrs);

            LdbpRfsult bnswfr = dlnt.bdd(fntry, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
                rfturn null;
            }

            // drfbtion suddfssful, gft bbdk livf objfdt
            rfturn nfw LdbpCtx(this, nfwDN);

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.drfbtfSubdontfxt(nbmf, inputAttrs);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_dfstroySubdontfxt(Nbmf nbmf, Continubtion dont)
        throws NbmingExdfption {
        dont.sftError(this, nbmf);

        try {
            fnsurfOpfn();

            String fnbmf = fullyQublififdNbmf(nbmf);
            LdbpRfsult bnswfr = dlnt.dflftf(fnbmf, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            bdjustDflftfStbtus(fnbmf, bnswfr);

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.dfstroySubdontfxt(nbmf);
                    rfturn;
                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;
                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }
        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);
        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    /**
     * Adds bttributfs from RDN to bttrs if not blrfbdy prfsfnt.
     * Notf thbt if bttrs blrfbdy dontbins bn bttributf by thf sbmf nbmf,
     * or if thf distinguishfd nbmf is fmpty, thfn lfbvf bttrs undhbngfd.
     *
     * @pbrbm dn Thf non-null DN of thf fntry to bdd
     * @pbrbm bttrs Thf non-null bttributfs of fntry to bdd
     * @pbrbm dirfdtUpdbtf Whfthfr bttrs dbn bf updbtfd dirfdtly
     * @rfturns Non-null bttributfs with bttributfs from thf RDN bddfd
     */
    privbtf stbtid Attributfs bddRdnAttributfs(String dn, Attributfs bttrs,
        boolfbn dirfdtUpdbtf) throws NbmingExdfption {

            // Hbndlf thf fmpty nbmf
            if (dn.fqubls("")) {
                rfturn bttrs;
            }

            // Pbrsf string nbmf into list of RDNs
            List<Rdn> rdnList = (nfw LdbpNbmf(dn)).gftRdns();

            // Gft lfbf RDN
            Rdn rdn = rdnList.gft(rdnList.sizf() - 1);
            Attributfs nbmfAttrs = rdn.toAttributfs();

            // Add bttributfs of RDN to bttrs if not blrfbdy thfrf
            NbmingEnumfrbtion<? fxtfnds Attributf> fnum_ = nbmfAttrs.gftAll();
            Attributf nbmfAttr;
            whilf (fnum_.hbsMorf()) {
                nbmfAttr = fnum_.nfxt();

                // If bttrs blrfbdy hbs thf bttributf, don't dhbngf or bdd to it
                if (bttrs.gft(nbmfAttr.gftID()) ==  null) {

                    /**
                     * Whfn bttrs.isCbsfIgnorfd() is fblsf, bttrs.gft() will
                     * rfturn null whfn thf dbsf mis-mbtdhfs for othfrwisf
                     * fqubl bttrIDs.
                     * As thf bttrIDs' dbsf is irrflfvbnt for LDAP, ignorf
                     * thf dbsf of bttrIDs fvfn whfn bttrs.isCbsfIgnorfd() is
                     * fblsf. This is donf by fxpliditly dompbring thf flfmfnts in
                     * thf fnumfrbtion of IDs with thfir dbsf ignorfd.
                     */
                    if (!bttrs.isCbsfIgnorfd() &&
                            dontbinsIgnorfCbsf(bttrs.gftIDs(), nbmfAttr.gftID())) {
                        dontinuf;
                    }

                    if (!dirfdtUpdbtf) {
                        bttrs = (Attributfs)bttrs.dlonf();
                        dirfdtUpdbtf = truf;
                    }
                    bttrs.put(nbmfAttr);
                }
            }

            rfturn bttrs;
    }


    privbtf stbtid boolfbn dontbinsIgnorfCbsf(NbmingEnumfrbtion<String> fnumStr,
                                String str) throws NbmingExdfption {
        String strEntry;

        whilf (fnumStr.hbsMorf()) {
             strEntry = fnumStr.nfxt();
             if (strEntry.fqublsIgnorfCbsf(str)) {
                rfturn truf;
             }
        }
        rfturn fblsf;
    }


    privbtf void bdjustDflftfStbtus(String fnbmf, LdbpRfsult bnswfr) {
        if (bnswfr.stbtus == LdbpClifnt.LDAP_NO_SUCH_OBJECT &&
            bnswfr.mbtdhfdDN != null) {
            try {
                // %%% RL: brf thfrf bny implidbtions for rfffrrbls?

                Nbmf orig = pbrsfr.pbrsf(fnbmf);
                Nbmf mbtdhfd = pbrsfr.pbrsf(bnswfr.mbtdhfdDN);
                if ((orig.sizf() - mbtdhfd.sizf()) == 1)
                    bnswfr.stbtus = LdbpClifnt.LDAP_SUCCESS;
            } dbtdh (NbmingExdfption f) {}
        }
    }

    /*
     * Appfnd thf thf sfdond Vfdtor onto thf first Vfdtor
     * (v2 must bf non-null)
     */
    privbtf stbtid <T> Vfdtor<T> bppfndVfdtor(Vfdtor<T> v1, Vfdtor<T> v2) {
        if (v1 == null) {
            v1 = v2;
        } flsf {
            for (int i = 0; i < v2.sizf(); i++) {
                v1.bddElfmfnt(v2.flfmfntAt(i));
            }
        }
        rfturn v1;
    }

    // ------------- Lookups bnd Browsing -------------------------
    // lookup/lookupLink
    // list/listBindings

    protfdtfd Objfdt d_lookupLink(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        rfturn d_lookup(nbmf, dont);
    }

    protfdtfd Objfdt d_lookup(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);
        Objfdt obj = null;
        Attributfs bttrs;

        try {
            SfbrdhControls dons = nfw SfbrdhControls();
            dons.sftSfbrdhSdopf(SfbrdhControls.OBJECT_SCOPE);
            dons.sftRfturningAttributfs(null); // bsk for bll bttributfs
            dons.sftRfturningObjFlbg(truf); // nffd vblufs to donstrudt obj

            LdbpRfsult bnswfr = doSfbrdhOndf(nbmf, "(objfdtClbss=*)", dons, truf);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            // should gft bbdk 1 SfbrdhRfsponsf bnd 1 SfbrdhRfsult

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

            if (bnswfr.fntrifs == null || bnswfr.fntrifs.sizf() != 1) {
                // found it but got no bttributfs
                bttrs = nfw BbsidAttributfs(LdbpClifnt.dbsfIgnorf);
            } flsf {
                LdbpEntry fntry = bnswfr.fntrifs.flfmfntAt(0);
                bttrs = fntry.bttributfs;

                Vfdtor<Control> fntryCtls = fntry.rfspCtls; // rftrifvf fntry dontrols
                if (fntryCtls != null) {
                    bppfndVfdtor(rfspCtls, fntryCtls); // dondbtfnbtf dontrols
                }
            }

            if (bttrs.gft(Obj.JAVA_ATTRIBUTES[Obj.CLASSNAME]) != null) {
                // sfriblizfd objfdt or objfdt rfffrfndf
                obj = Obj.dfdodfObjfdt(bttrs);
            }
            if (obj == null) {
                obj = nfw LdbpCtx(this, fullyQublififdNbmf(nbmf));
            }
        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);
                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.lookup(nbmf);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }

        try {
            rfturn DirfdtoryMbnbgfr.gftObjfdtInstbndf(obj, nbmf,
                this, fnvprops, bttrs);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);

        } dbtdh (Exdfption f) {
            NbmingExdfption f2 = nfw NbmingExdfption(
                    "problfm gfnfrbting objfdt using objfdt fbdtory");
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);
        }
    }

    protfdtfd NbmingEnumfrbtion<NbmfClbssPbir> d_list(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        SfbrdhControls dons = nfw SfbrdhControls();
        String[] dlbssAttrs = nfw String[2];

        dlbssAttrs[0] = Obj.JAVA_ATTRIBUTES[Obj.OBJECT_CLASS];
        dlbssAttrs[1] = Obj.JAVA_ATTRIBUTES[Obj.CLASSNAME];
        dons.sftRfturningAttributfs(dlbssAttrs);

        // sft this flbg to ovfrridf thf typfsOnly flbg
        dons.sftRfturningObjFlbg(truf);

        dont.sftError(this, nbmf);

        LdbpRfsult bnswfr = null;

        try {
            bnswfr = doSfbrdh(nbmf, "(objfdtClbss=*)", dons, truf, truf);

            // list rfsult mby dontbin dontinubtion rfffrfndfs
            if ((bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) ||
                (bnswfr.rfffrrbls != null)) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

            rfturn nfw LdbpNbmingEnumfrbtion(this, bnswfr, nbmf, dont);

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.list(nbmf);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (LimitExdffdfdExdfption f) {
            LdbpNbmingEnumfrbtion rfs =
                nfw LdbpNbmingEnumfrbtion(this, bnswfr, nbmf, dont);

            rfs.sftNbmingExdfption(
                    (LimitExdffdfdExdfption)dont.fillInExdfption(f));
            rfturn rfs;

        } dbtdh (PbrtiblRfsultExdfption f) {
            LdbpNbmingEnumfrbtion rfs =
                nfw LdbpNbmingEnumfrbtion(this, bnswfr, nbmf, dont);

            rfs.sftNbmingExdfption(
                    (PbrtiblRfsultExdfption)dont.fillInExdfption(f));
            rfturn rfs;

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd NbmingEnumfrbtion<Binding> d_listBindings(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {

        SfbrdhControls dons = nfw SfbrdhControls();
        dons.sftRfturningAttributfs(null); // bsk for bll bttributfs
        dons.sftRfturningObjFlbg(truf); // nffd vblufs to donstrudt obj

        dont.sftError(this, nbmf);

        LdbpRfsult bnswfr = null;

        try {
            bnswfr = doSfbrdh(nbmf, "(objfdtClbss=*)", dons, truf, truf);

            // listBindings rfsult mby dontbin dontinubtion rfffrfndfs
            if ((bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) ||
                (bnswfr.rfffrrbls != null)) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

            rfturn nfw LdbpBindingEnumfrbtion(this, bnswfr, nbmf, dont);

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {
                @SupprfssWbrnings("undhfdkfd")
                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.listBindings(nbmf);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }
        } dbtdh (LimitExdffdfdExdfption f) {
            LdbpBindingEnumfrbtion rfs =
                nfw LdbpBindingEnumfrbtion(this, bnswfr, nbmf, dont);

            rfs.sftNbmingExdfption(dont.fillInExdfption(f));
            rfturn rfs;

        } dbtdh (PbrtiblRfsultExdfption f) {
            LdbpBindingEnumfrbtion rfs =
                nfw LdbpBindingEnumfrbtion(this, bnswfr, nbmf, dont);

            rfs.sftNbmingExdfption(dont.fillInExdfption(f));
            rfturn rfs;

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    // --------------- Nbmf-rflbtfd Mfthods -----------------------
    // -- gftNbmfPbrsfr/gftNbmfInNbmfspbdf/domposfNbmf

    protfdtfd NbmfPbrsfr d_gftNbmfPbrsfr(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption
    {
        // ignorf nbmf, blwbys rfturn sbmf pbrsfr
        dont.sftSuddfss();
        rfturn pbrsfr;
    }

    publid String gftNbmfInNbmfspbdf() {
        rfturn durrfntDN;
    }

    publid Nbmf domposfNbmf(Nbmf nbmf, Nbmf prffix)
        throws NbmingExdfption
    {
        Nbmf rfsult;

        // Hbndlf dompound nbmfs.  A pbir of LdbpNbmfs is bn fbsy dbsf.
        if ((nbmf instbndfof LdbpNbmf) && (prffix instbndfof LdbpNbmf)) {
            rfsult = (Nbmf)(prffix.dlonf());
            rfsult.bddAll(nbmf);
            rfturn nfw CompositfNbmf().bdd(rfsult.toString());
        }
        if (!(nbmf instbndfof CompositfNbmf)) {
            nbmf = nfw CompositfNbmf().bdd(nbmf.toString());
        }
        if (!(prffix instbndfof CompositfNbmf)) {
            prffix = nfw CompositfNbmf().bdd(prffix.toString());
        }

        int prffixLbst = prffix.sizf() - 1;

        if (nbmf.isEmpty() || prffix.isEmpty() ||
                nbmf.gft(0).fqubls("") || prffix.gft(prffixLbst).fqubls("")) {
            rfturn supfr.domposfNbmf(nbmf, prffix);
        }

        rfsult = (Nbmf)(prffix.dlonf());
        rfsult.bddAll(nbmf);

        if (pbrfntIsLdbpCtx) {
            String ldbpComp = dondbtNbmfs(rfsult.gft(prffixLbst + 1),
                                          rfsult.gft(prffixLbst));
            rfsult.rfmovf(prffixLbst + 1);
            rfsult.rfmovf(prffixLbst);
            rfsult.bdd(prffixLbst, ldbpComp);
        }
        rfturn rfsult;
    }

    privbtf String fullyQublififdNbmf(Nbmf rfl) {
        rfturn rfl.isEmpty()
                ? durrfntDN
                : fullyQublififdNbmf(rfl.gft(0));
    }

    privbtf String fullyQublififdNbmf(String rfl) {
        rfturn (dondbtNbmfs(rfl, durrfntDN));
    }

    // usfd by LdbpSfbrdhEnumfrbtion
    privbtf stbtid String dondbtNbmfs(String lfssfr, String grfbtfr) {
        if (lfssfr == null || lfssfr.fqubls("")) {
            rfturn grfbtfr;
        } flsf if (grfbtfr == null || grfbtfr.fqubls("")) {
            rfturn lfssfr;
        } flsf {
            rfturn (lfssfr + "," + grfbtfr);
        }
    }

   // --------------- Rfbding bnd Updbting Attributfs
   // gftAttributfs/modifyAttributfs

    protfdtfd Attributfs d_gftAttributfs(Nbmf nbmf, String[] bttrIds,
                                      Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);

        SfbrdhControls dons = nfw SfbrdhControls();
        dons.sftSfbrdhSdopf(SfbrdhControls.OBJECT_SCOPE);
        dons.sftRfturningAttributfs(bttrIds);

        try {
            LdbpRfsult bnswfr =
                doSfbrdhOndf(nbmf, "(objfdtClbss=*)", dons, truf);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

            if (bnswfr.fntrifs == null || bnswfr.fntrifs.sizf() != 1) {
                rfturn nfw BbsidAttributfs(LdbpClifnt.dbsfIgnorf);
            }

            // gft bttributfs from rfsult
            LdbpEntry fntry = bnswfr.fntrifs.flfmfntAt(0);

            Vfdtor<Control> fntryCtls = fntry.rfspCtls; // rftrifvf fntry dontrols
            if (fntryCtls != null) {
                bppfndVfdtor(rfspCtls, fntryCtls); // dondbtfnbtf dontrols
            }

            // do this so bttributfs dbn find thfir sdhfmb
            sftPbrfnts(fntry.bttributfs, (Nbmf) nbmf.dlonf());

            rfturn (fntry.bttributfs);

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.gftAttributfs(nbmf, bttrIds);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_modifyAttributfs(Nbmf nbmf, int mod_op, Attributfs bttrs,
                                      Continubtion dont)
            throws NbmingExdfption {

        dont.sftError(this, nbmf);

        try {
            fnsurfOpfn();

            if (bttrs == null || bttrs.sizf() == 0) {
                rfturn; // nothing to do
            }
            String nfwDN = fullyQublififdNbmf(nbmf);
            int jmod_op = donvfrtToLdbpModCodf(mod_op);

            // donstrudt mod list
            int[] jmods = nfw int[bttrs.sizf()];
            Attributf[] jbttrs = nfw Attributf[bttrs.sizf()];

            NbmingEnumfrbtion<? fxtfnds Attributf> bf = bttrs.gftAll();
            for(int i = 0; i < jmods.lfngth && bf.hbsMorf(); i++) {
                jmods[i] = jmod_op;
                jbttrs[i] = bf.nfxt();
            }

            LdbpRfsult bnswfr = dlnt.modify(nfwDN, jmods, jbttrs, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
                rfturn;
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.modifyAttributfs(nbmf, mod_op, bttrs);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd void d_modifyAttributfs(Nbmf nbmf, ModifidbtionItfm[] mods,
                                      Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);

        try {
            fnsurfOpfn();

            if (mods == null || mods.lfngth == 0) {
                rfturn; // nothing to do
            }
            String nfwDN = fullyQublififdNbmf(nbmf);

            // donstrudt mod list
            int[] jmods = nfw int[mods.lfngth];
            Attributf[] jbttrs = nfw Attributf[mods.lfngth];
            ModifidbtionItfm mod;
            for (int i = 0; i < jmods.lfngth; i++) {
                mod = mods[i];
                jmods[i] = donvfrtToLdbpModCodf(mod.gftModifidbtionOp());
                jbttrs[i] = mod.gftAttributf();
            }

            LdbpRfsult bnswfr = dlnt.modify(nfwDN, jmods, jbttrs, rfqCtls);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nbmf);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rffCtx.modifyAttributfs(nbmf, mods);
                    rfturn;

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    privbtf stbtid int donvfrtToLdbpModCodf(int mod_op) {
        switdh (mod_op) {
        dbsf DirContfxt.ADD_ATTRIBUTE:
            rfturn(LdbpClifnt.ADD);

        dbsf DirContfxt.REPLACE_ATTRIBUTE:
            rfturn (LdbpClifnt.REPLACE);

        dbsf DirContfxt.REMOVE_ATTRIBUTE:
            rfturn (LdbpClifnt.DELETE);

        dffbult:
            throw nfw IllfgblArgumfntExdfption("Invblid modifidbtion dodf");
        }
    }

   // ------------------- Sdhfmb -----------------------

    protfdtfd DirContfxt d_gftSdhfmb(Nbmf nbmf, Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);
        try {
            rfturn gftSdhfmbTrff(nbmf);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    protfdtfd DirContfxt d_gftSdhfmbClbssDffinition(Nbmf nbmf,
                                                    Continubtion dont)
            throws NbmingExdfption {
        dont.sftError(this, nbmf);

        try {
            // rftrifvf thf objfdtClbss bttributf from LDAP
            Attributf objfdtClbssAttr = d_gftAttributfs(nbmf,
                nfw String[]{"objfdtdlbss"}, dont).gft("objfdtdlbss");
            if (objfdtClbssAttr == null || objfdtClbssAttr.sizf() == 0) {
                rfturn EMPTY_SCHEMA;
            }

            // rftrifvf thf root of thf ObjfdtClbss sdhfmb trff
            Contfxt odSdhfmb = (Contfxt) d_gftSdhfmb(nbmf, dont).lookup(
                LdbpSdhfmbPbrsfr.OBJECTCLASS_DEFINITION_NAME);

            // drfbtf b dontfxt to hold thf sdhfmb objfdts rfprfsfnting thf objfdt
            // dlbssfs
            HifrMfmDirCtx objfdtClbssCtx = nfw HifrMfmDirCtx();
            DirContfxt objfdtClbssDff;
            String objfdtClbssNbmf;
            for (Enumfrbtion<?> objfdtClbssfs = objfdtClbssAttr.gftAll();
                objfdtClbssfs.hbsMorfElfmfnts(); ) {
                objfdtClbssNbmf = (String)objfdtClbssfs.nfxtElfmfnt();
                // %%% Should wf fbil if not found, or just dontinuf?
                objfdtClbssDff = (DirContfxt)odSdhfmb.lookup(objfdtClbssNbmf);
                objfdtClbssCtx.bind(objfdtClbssNbmf, objfdtClbssDff);
            }

            // Mbkf dontfxt rfbd-only
            objfdtClbssCtx.sftRfbdOnly(
                nfw SdhfmbViolbtionExdfption("Cbnnot updbtf sdhfmb objfdt"));
            rfturn (DirContfxt)objfdtClbssCtx;

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }

    /*
     * gftSdhfmbTrff first looks to sff if wf hbvf blrfbdy built b
     * sdhfmb trff for thf givfn fntry. If not, it builds b nfw onf bnd
     * storfs it in our privbtf hbsh tbblf
     */
    privbtf DirContfxt gftSdhfmbTrff(Nbmf nbmf) throws NbmingExdfption {
        String subsdhfmbsubfntry = gftSdhfmbEntry(nbmf, truf);

        DirContfxt sdhfmbTrff = sdhfmbTrffs.gft(subsdhfmbsubfntry);

        if(sdhfmbTrff==null) {
            if(dfbug){Systfm.frr.println("LdbpCtx: building nfw sdhfmb trff " + this);}
            sdhfmbTrff = buildSdhfmbTrff(subsdhfmbsubfntry);
            sdhfmbTrffs.put(subsdhfmbsubfntry, sdhfmbTrff);
        }

        rfturn sdhfmbTrff;
    }

    /*
     * buildSdhfmbTrff builds thf sdhfmb trff dorrfsponding to thf
     * givfn subsdhfmbsubfntrff
     */
    privbtf DirContfxt buildSdhfmbTrff(String subsdhfmbsubfntry)
        throws NbmingExdfption {

        // gft thf sdhfmb fntry itsflf
        // DO bsk for rfturn objfdt hfrf bfdbusf wf nffd it to
        // drfbtf dontfxt. Sindf bsking for bll bttrs, wf won't
        // bf trbnsmitting bny spfdifid bttrIDs (likf Jbvb-spfdifid onfs).
        SfbrdhControls donstrbints = nfw
            SfbrdhControls(SfbrdhControls.OBJECT_SCOPE,
                0, 0, /* dount bnd timf limits */
                SCHEMA_ATTRIBUTES /* rfturn sdhfmb bttrs */,
                truf /* rfturn obj */,
                fblsf /*dfrff link */ );

        Nbmf ssf = (nfw CompositfNbmf()).bdd(subsdhfmbsubfntry);
        NbmingEnumfrbtion<SfbrdhRfsult> rfsults =
            sfbrdhAux(ssf, "(objfdtClbss=subsdhfmb)", donstrbints,
            fblsf, truf, nfw Continubtion());

        if(!rfsults.hbsMorf()) {
            throw nfw OpfrbtionNotSupportfdExdfption(
                "Cbnnot gft rfbd subsdhfmbsubfntry: " + subsdhfmbsubfntry);
        }
        SfbrdhRfsult rfsult = rfsults.nfxt();
        rfsults.dlosf();

        Objfdt obj = rfsult.gftObjfdt();
        if(!(obj instbndfof LdbpCtx)) {
            throw nfw NbmingExdfption(
                "Cbnnot gft sdhfmb objfdt bs DirContfxt: " + subsdhfmbsubfntry);
        }

        rfturn LdbpSdhfmbCtx.drfbtfSdhfmbTrff(fnvprops, subsdhfmbsubfntry,
            (LdbpCtx)obj /* sdhfmb fntry */,
            rfsult.gftAttributfs() /* sdhfmb bttributfs */,
            nftsdbpfSdhfmbBug);
   }

    /*
     * gftSdhfmbEntrff rfturns thf DN of thf subsdhfmbsubfntrff for thf
     * givfn fntrff. It first looks to sff if thf givfn fntry hbs
     * b subsdhfmb difffrfnt from thbt of thf root DIT (by looking for
     * b "subsdhfmbsubfntry" bttributf). If it dofsn't find onf, it rfturns
     * thf onf for thf root of thf DIT (by looking for thf root's
     * "subsdhfmbsubfntry" bttributf).
     *
     * This fundtion is dbllfd rfgbrdlfss of thf sfrvfr's vfrsion, sindf
     * bn bdministrbtor mby hbvf sftup thf sfrvfr to support dlifnt sdhfmb
     * qufrifs. If this fundtion trifs b sfbrdh on b v2 sfrvfr thbt
     * dofsn't support sdhfmb, onf of thfsf two things will hbppfn:
     * 1) It will gft bn fxdfption whfn qufrying thf root DSE
     * 2) It will not find b subsdhfmbsubfntry on thf root DSE
     * If fithfr of thfsf things oddur bnd thf sfrvfr is not v3, wf
     * throw OpfrbtionNotSupportfd.
     *
     * thf rflbtivf flbg tflls whfthfr thf givfn nbmf is rflbtivf to this
     * dontfxt.
     */
    privbtf String gftSdhfmbEntry(Nbmf nbmf, boolfbn rflbtivf)
        throws NbmingExdfption {

        // Asks for opfrbtionbl bttributf "subsdhfmbsubfntry"
        SfbrdhControls donstrbints = nfw SfbrdhControls(SfbrdhControls.OBJECT_SCOPE,
            0, 0, /* dount bnd timf limits */
            nfw String[]{"subsdhfmbsubfntry"} /* bttr to rfturn */,
            fblsf /* rfturning obj */,
            fblsf /* dfrff link */);

        NbmingEnumfrbtion<SfbrdhRfsult> rfsults;
        try {
            rfsults = sfbrdhAux(nbmf, "objfdtdlbss=*", donstrbints, rflbtivf,
                truf, nfw Continubtion());

        } dbtdh (NbmingExdfption nf) {
            if (!dlnt.isLdbpv3 && durrfntDN.lfngth() == 0 && nbmf.isEmpty()) {
                // wf got bn frror looking for b root fntry on bn ldbpv2
                // sfrvfr. Thf sfrvfr must not support sdhfmb.
                throw nfw OpfrbtionNotSupportfdExdfption(
                    "Cbnnot gft sdhfmb informbtion from sfrvfr");
            } flsf {
                throw nf;
            }
        }

        if (!rfsults.hbsMorfElfmfnts()) {
            throw nfw ConfigurbtionExdfption(
                "Rfqufsting sdhfmb of nonfxistfnt fntry: " + nbmf);
        }

        SfbrdhRfsult rfsult = rfsults.nfxt();
        rfsults.dlosf();

        Attributf sdhfmbEntryAttr =
            rfsult.gftAttributfs().gft("subsdhfmbsubfntry");
        //Systfm.frr.println("sdhfmb fntry bttrs: " + sdhfmbEntryAttr);

        if (sdhfmbEntryAttr == null || sdhfmbEntryAttr.sizf() < 0) {
            if (durrfntDN.lfngth() == 0 && nbmf.isEmpty()) {
                // thf sfrvfr dofsn't hbvf b subsdhfmbsubfntry in its root DSE.
                // thfrfforf, it dofsn't support sdhfmb.
                throw nfw OpfrbtionNotSupportfdExdfption(
                    "Cbnnot rfbd subsdhfmbsubfntry of root DSE");
            } flsf {
                rfturn gftSdhfmbEntry(nfw CompositfNbmf(), fblsf);
            }
        }

        rfturn (String)(sdhfmbEntryAttr.gft()); // rfturn sdhfmb fntry nbmf
    }

    // pbdkbgf-privbtf; usfd by sfbrdh fnum.
    // Sft bttributfs to point to this dontfxt in dbsf somf onf
    // bskfd for thfir sdhfmb
    void sftPbrfnts(Attributfs bttrs, Nbmf nbmf) throws NbmingExdfption {
        NbmingEnumfrbtion<? fxtfnds Attributf> bf = bttrs.gftAll();
        whilf(bf.hbsMorf()) {
            ((LdbpAttributf) bf.nfxt()).sftPbrfnt(this, nbmf);
        }
    }

    /*
     * Rfturns thf URL bssodibtfd with this dontfxt; usfd by LdbpAttributf
     * bftfr dfsfriblizbtion to gft pointfr to this dontfxt.
     */
    String gftURL() {
        if (url == null) {
            url = LdbpURL.toUrlString(hostnbmf, port_numbfr, durrfntDN,
                hbsLdbpsSdhfmf);
        }

        rfturn url;
    }

   // --------------------- Sfbrdhfs -----------------------------
    protfdtfd NbmingEnumfrbtion<SfbrdhRfsult> d_sfbrdh(Nbmf nbmf,
                                         Attributfs mbtdhingAttributfs,
                                         Continubtion dont)
            throws NbmingExdfption {
        rfturn d_sfbrdh(nbmf, mbtdhingAttributfs, null, dont);
    }

    protfdtfd NbmingEnumfrbtion<SfbrdhRfsult> d_sfbrdh(Nbmf nbmf,
                                         Attributfs mbtdhingAttributfs,
                                         String[] bttributfsToRfturn,
                                         Continubtion dont)
            throws NbmingExdfption {
        SfbrdhControls dons = nfw SfbrdhControls();
        dons.sftRfturningAttributfs(bttributfsToRfturn);
        String filtfr;
        try {
            filtfr = SfbrdhFiltfr.formbt(mbtdhingAttributfs);
        } dbtdh (NbmingExdfption f) {
            dont.sftError(this, nbmf);
            throw dont.fillInExdfption(f);
        }
        rfturn d_sfbrdh(nbmf, filtfr, dons, dont);
    }

    protfdtfd NbmingEnumfrbtion<SfbrdhRfsult> d_sfbrdh(Nbmf nbmf,
                                         String filtfr,
                                         SfbrdhControls dons,
                                         Continubtion dont)
            throws NbmingExdfption {
        rfturn sfbrdhAux(nbmf, filtfr, dlonfSfbrdhControls(dons), truf,
                 wbitForRfply, dont);
    }

    protfdtfd NbmingEnumfrbtion<SfbrdhRfsult> d_sfbrdh(Nbmf nbmf,
                                         String filtfrExpr,
                                         Objfdt[] filtfrArgs,
                                         SfbrdhControls dons,
                                         Continubtion dont)
            throws NbmingExdfption {
        String strfiltfr;
        try {
            strfiltfr = SfbrdhFiltfr.formbt(filtfrExpr, filtfrArgs);
        } dbtdh (NbmingExdfption f) {
            dont.sftError(this, nbmf);
            throw dont.fillInExdfption(f);
        }
        rfturn d_sfbrdh(nbmf, strfiltfr, dons, dont);
    }

        // Usfd by NbmingNotififr
    NbmingEnumfrbtion<SfbrdhRfsult> sfbrdhAux(Nbmf nbmf,
        String filtfr,
        SfbrdhControls dons,
        boolfbn rflbtivf,
        boolfbn wbitForRfply, Continubtion dont) throws NbmingExdfption {

        LdbpRfsult bnswfr = null;
        String[] tokfns = nfw String[2];    // storfs ldbp dompbrf op. vblufs
        String[] rfqAttrs;                  // rfmfmbfr whbt wbs bskfd

        if (dons == null) {
            dons = nfw SfbrdhControls();
        }
        rfqAttrs = dons.gftRfturningAttributfs();

        // if objfdts brf rfqufstfd thfn rfqufst thf Jbvb bttributfs too
        // so thbt thf objfdts dbn bf donstrudtfd
        if (dons.gftRfturningObjFlbg()) {
            if (rfqAttrs != null) {

                // dhfdk for prfsfndf of "*" (usfr bttributfs wilddbrd)
                boolfbn hbsWilddbrd = fblsf;
                for (int i = rfqAttrs.lfngth - 1; i >= 0; i--) {
                    if (rfqAttrs[i].fqubls("*")) {
                        hbsWilddbrd = truf;
                        brfbk;
                    }
                }
                if (! hbsWilddbrd) {
                    String[] totblAttrs =
                        nfw String[rfqAttrs.lfngth +Obj.JAVA_ATTRIBUTES.lfngth];
                    Systfm.brrbydopy(rfqAttrs, 0, totblAttrs, 0,
                        rfqAttrs.lfngth);
                    Systfm.brrbydopy(Obj.JAVA_ATTRIBUTES, 0, totblAttrs,
                        rfqAttrs.lfngth, Obj.JAVA_ATTRIBUTES.lfngth);

                    dons.sftRfturningAttributfs(totblAttrs);
                }
            }
        }

        LdbpCtx.SfbrdhArgs brgs =
            nfw LdbpCtx.SfbrdhArgs(nbmf, filtfr, dons, rfqAttrs);

        dont.sftError(this, nbmf);
        try {
            // sff if this dbn bf donf bs b dompbrf, othfrwisf do b sfbrdh
            if (sfbrdhToCompbrf(filtfr, dons, tokfns)){
                //Systfm.frr.println("dompbrf triggfrfd");
                bnswfr = dompbrf(nbmf, tokfns[0], tokfns[1]);
                if (! (bnswfr.dompbrfToSfbrdhRfsult(fullyQublififdNbmf(nbmf)))){
                    prodfssRfturnCodf(bnswfr, nbmf);
                }
            } flsf {
                bnswfr = doSfbrdh(nbmf, filtfr, dons, rflbtivf, wbitForRfply);
                // sfbrdh rfsult mby dontbin rfffrrbls
                prodfssRfturnCodf(bnswfr, nbmf);
            }
            rfturn nfw LdbpSfbrdhEnumfrbtion(this, bnswfr,
                                             fullyQublififdNbmf(nbmf),
                                             brgs, dont);

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw dont.fillInExdfption(f);

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                @SupprfssWbrnings("undhfdkfd")
                LdbpRfffrrblContfxt rffCtx = (LdbpRfffrrblContfxt)
                        f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.sfbrdh(nbmf, filtfr, dons);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (LimitExdffdfdExdfption f) {
            LdbpSfbrdhEnumfrbtion rfs =
                nfw LdbpSfbrdhEnumfrbtion(this, bnswfr, fullyQublififdNbmf(nbmf),
                                          brgs, dont);
            rfs.sftNbmingExdfption(f);
            rfturn rfs;

        } dbtdh (PbrtiblRfsultExdfption f) {
            LdbpSfbrdhEnumfrbtion rfs =
                nfw LdbpSfbrdhEnumfrbtion(this, bnswfr, fullyQublififdNbmf(nbmf),
                                          brgs, dont);

            rfs.sftNbmingExdfption(f);
            rfturn rfs;

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw dont.fillInExdfption(f2);

        } dbtdh (NbmingExdfption f) {
            throw dont.fillInExdfption(f);
        }
    }


    LdbpRfsult gftSfbrdhRfply(LdbpClifnt fClnt, LdbpRfsult rfs)
            throws NbmingExdfption {
        // fnsurfOpfn() won't work hfrf bfdbusf
        // sfssion wbs bssodibtfd with prfvious donnfdtion

        // %%% RL: wf dbn bdtublly bllow thf fnumfrbtion to dontinuf
        // using thf old hbndlf but othfr wfird things might hbppfn
        // whfn wf hit b rfffrrbl
        if (dlnt != fClnt) {
            throw nfw CommunidbtionExdfption(
                "Contfxt's donnfdtion dhbngfd; unbblf to dontinuf fnumfrbtion");
        }

        try {
            rfturn fClnt.gftSfbrdhRfply(bbtdhSizf, rfs, binbryAttrs);
        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw f2;
        }
    }

    // Pfrform b sfbrdh. Expfdt 1 SfbrdhRfsultEntry bnd thf SfbrdhRfsultDonf.
    privbtf LdbpRfsult doSfbrdhOndf(Nbmf nbmf, String filtfr,
        SfbrdhControls dons, boolfbn rflbtivf) throws NbmingExdfption {

        int sbvfdBbtdhSizf = bbtdhSizf;
        bbtdhSizf = 2; // 2 protodol flfmfnts

        LdbpRfsult bnswfr = doSfbrdh(nbmf, filtfr, dons, rflbtivf, truf);

        bbtdhSizf = sbvfdBbtdhSizf;
        rfturn bnswfr;
    }

    privbtf LdbpRfsult doSfbrdh(Nbmf nbmf, String filtfr, SfbrdhControls dons,
        boolfbn rflbtivf, boolfbn wbitForRfply) throws NbmingExdfption {
            fnsurfOpfn();
            try {
                int sdopf;

                switdh (dons.gftSfbrdhSdopf()) {
                dbsf SfbrdhControls.OBJECT_SCOPE:
                    sdopf = LdbpClifnt.SCOPE_BASE_OBJECT;
                    brfbk;
                dffbult:
                dbsf SfbrdhControls.ONELEVEL_SCOPE:
                    sdopf = LdbpClifnt.SCOPE_ONE_LEVEL;
                    brfbk;
                dbsf SfbrdhControls.SUBTREE_SCOPE:
                    sdopf = LdbpClifnt.SCOPE_SUBTREE;
                    brfbk;
                }

                // If dons.gftRfturningObjFlbg() thfn dbllfr should blrfbdy
                // hbvf mbkf surf to rfqufst thf bppropribtf bttrs

                String[] rftbttrs = dons.gftRfturningAttributfs();
                if (rftbttrs != null && rftbttrs.lfngth == 0) {
                    // Ldbp trfbts null bnd fmpty brrby thf sbmf
                    // nffd to rfplbdf with singlf flfmfnt brrby
                    rftbttrs = nfw String[1];
                    rftbttrs[0] = "1.1";
                }

                String nm = (rflbtivf
                             ? fullyQublififdNbmf(nbmf)
                             : (nbmf.isEmpty()
                                ? ""
                                : nbmf.gft(0)));

                // JNDI unit is millisfdonds, LDAP unit is sfdonds.
                // Zfro mfbns no limit.
                int msfdLimit = dons.gftTimfLimit();
                int sfdLimit = 0;

                if (msfdLimit > 0) {
                    sfdLimit = (msfdLimit / 1000) + 1;
                }

                LdbpRfsult bnswfr =
                    dlnt.sfbrdh(nm,
                        sdopf,
                        dfrffAlibsfs,
                        (int)dons.gftCountLimit(),
                        sfdLimit,
                        dons.gftRfturningObjFlbg() ? fblsf : typfsOnly,
                        rftbttrs,
                        filtfr,
                        bbtdhSizf,
                        rfqCtls,
                        binbryAttrs,
                        wbitForRfply,
                        rfplyQufufSizf);
                rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols
                rfturn bnswfr;

            } dbtdh (IOExdfption f) {
                NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
                f2.sftRootCbusf(f);
                throw f2;
            }
    }


    /*
     * Cfrtbin simplf JNDI sfbrdhfs brf butombtidblly donvfrtfd to
     * LDAP dompbrf opfrbtions by thf LDAP sfrvidf providfr. A sfbrdh
     * is donvfrtfd to b dompbrf iff:
     *
     *    - thf sdopf is sft to OBJECT_SCOPE
     *    - thf filtfr string dontbins b simplf bssfrtion: "<typf>=<vbluf>"
     *    - thf rfturning bttributfs list is prfsfnt but fmpty
     */

    // rfturns truf if b sfbrdh dbn bf dbrrifd out bs b dompbrf, bnd sfts
    // tokfns[0] bnd tokfns[1] to thf typf bnd vbluf rfspfdtivfly.
    // f.g. filtfr "dn=Jon Ruiz" bfdomfs, typf "dn" bnd vbluf "Jon Ruiz"
    // This fundtion usfs thf dodumfnts JNDI Compbrf fxbmplf bs b modfl
    // for whfn to turn b sfbrdh into b dompbrf.

    privbtf stbtid boolfbn sfbrdhToCompbrf(
                                    String filtfr,
                                    SfbrdhControls dons,
                                    String tokfns[]) {

        // if sdopf is not objfdt-sdopf, it's rfblly b sfbrdh
        if (dons.gftSfbrdhSdopf() != SfbrdhControls.OBJECT_SCOPE) {
            rfturn fblsf;
        }

        // if bttributfs brf to bf rfturnfd, it's rfblly b sfbrdh
        String[] bttrs = dons.gftRfturningAttributfs();
        if (bttrs == null || bttrs.lfngth != 0) {
            rfturn fblsf;
        }

        // if thf filtfr not b simplf bssfrtion, it's rfblly b sfbrdh
        if (! filtfrToAssfrtion(filtfr, tokfns)) {
            rfturn fblsf;
        }

        // it dbn bf donvfrtfd to b dompbrf
        rfturn truf;
    }

    // If thf supplifd filtfr is b simplf bssfrtion i.f. "<typf>=<vbluf>"
    // (fndlosing pbrfnthfsfs brf pfrmittfd) thfn
    // filtfrToAssfrtion will rfturn truf bnd pbss thf typf bnd vbluf bs
    // thf first bnd sfdond flfmfnts of tokfns rfspfdtivfly.
    // prfdondition: tokfns[] must bf initiblizfd bnd bf bt lfbst of sizf 2.

    privbtf stbtid boolfbn filtfrToAssfrtion(String filtfr, String tokfns[]) {

        // find thf lfft bnd right hblf of thf bssfrtion
        StringTokfnizfr bssfrtionTokfnizfr = nfw StringTokfnizfr(filtfr, "=");

        if (bssfrtionTokfnizfr.dountTokfns() != 2) {
            rfturn fblsf;
        }

        tokfns[0] = bssfrtionTokfnizfr.nfxtTokfn();
        tokfns[1] = bssfrtionTokfnizfr.nfxtTokfn();

        // mbkf surf thf vbluf dofs not dontbin b wilddbrd
        if (tokfns[1].indfxOf('*') != -1) {
            rfturn fblsf;
        }

        // tfst for fndlosing pbrfnthfsis
        boolfbn hbsPbrfns = fblsf;
        int lfn = tokfns[1].lfngth();

        if ((tokfns[0].dhbrAt(0) == '(') &&
            (tokfns[1].dhbrAt(lfn - 1) == ')')) {
            hbsPbrfns = truf;

        } flsf if ((tokfns[0].dhbrAt(0) == '(') ||
            (tokfns[1].dhbrAt(lfn - 1) == ')')) {
            rfturn fblsf; // unbblbndfd
        }

        // mbkf surf thf lfft bnd right hblf brf not fxprfssions thfmsflvfs
        StringTokfnizfr illfgblChbrsTokfnizfr =
            nfw StringTokfnizfr(tokfns[0], "()&|!=~><*", truf);

        if (illfgblChbrsTokfnizfr.dountTokfns() != (hbsPbrfns ? 2 : 1)) {
            rfturn fblsf;
        }

        illfgblChbrsTokfnizfr =
            nfw StringTokfnizfr(tokfns[1], "()&|!=~><*", truf);

        if (illfgblChbrsTokfnizfr.dountTokfns() != (hbsPbrfns ? 2 : 1)) {
            rfturn fblsf;
        }

        // strip off fndlosing pbrfnthfsis, if prfsfnt
        if (hbsPbrfns) {
            tokfns[0] = tokfns[0].substring(1);
            tokfns[1] = tokfns[1].substring(0, lfn - 1);
        }

        rfturn truf;
    }

    privbtf LdbpRfsult dompbrf(Nbmf nbmf, String typf, String vbluf)
        throws IOExdfption, NbmingExdfption {

        fnsurfOpfn();
        String nm = fullyQublififdNbmf(nbmf);

        LdbpRfsult bnswfr = dlnt.dompbrf(nm, typf, vbluf, rfqCtls);
        rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

        rfturn bnswfr;
    }

    privbtf stbtid SfbrdhControls dlonfSfbrdhControls(SfbrdhControls dons) {
        if (dons == null) {
            rfturn null;
        }
        String[] rftAttrs = dons.gftRfturningAttributfs();
        if (rftAttrs != null) {
            String[] bttrs = nfw String[rftAttrs.lfngth];
            Systfm.brrbydopy(rftAttrs, 0, bttrs, 0, rftAttrs.lfngth);
            rftAttrs = bttrs;
        }
        rfturn nfw SfbrdhControls(dons.gftSfbrdhSdopf(),
                                  dons.gftCountLimit(),
                                  dons.gftTimfLimit(),
                                  rftAttrs,
                                  dons.gftRfturningObjFlbg(),
                                  dons.gftDfrffLinkFlbg());
    }

   // -------------- Environmfnt Propfrtifs ------------------

    /**
     * Ovfrridf with nondloning vfrsion.
     */
    protfdtfd Hbshtbblf<String, Objfdt> p_gftEnvironmfnt() {
        rfturn fnvprops;
    }

    @SupprfssWbrnings("undhfdkfd") // dlonf()
    publid Hbshtbblf<String, Objfdt> gftEnvironmfnt() throws NbmingExdfption {
        rfturn (fnvprops == null
                ? nfw Hbshtbblf<String, Objfdt>(5, 0.75f)
                : (Hbshtbblf<String, Objfdt>)fnvprops.dlonf());
    }

    @SupprfssWbrnings("undhfdkfd") // dlonf()
    publid Objfdt rfmovfFromEnvironmfnt(String propNbmf)
        throws NbmingExdfption {

        // not thfrf; just rfturn
        if (fnvprops == null || fnvprops.gft(propNbmf) == null) {
            rfturn null;
        }
        switdh (propNbmf) {
            dbsf REF_SEPARATOR:
                bddrEndodingSfpbrbtor = DEFAULT_REF_SEPARATOR;
                brfbk;
            dbsf TYPES_ONLY:
                typfsOnly = DEFAULT_TYPES_ONLY;
                brfbk;
            dbsf DELETE_RDN:
                dflftfRDN = DEFAULT_DELETE_RDN;
                brfbk;
            dbsf DEREF_ALIASES:
                dfrffAlibsfs = DEFAULT_DEREF_ALIASES;
                brfbk;
            dbsf Contfxt.BATCHSIZE:
                bbtdhSizf = DEFAULT_BATCH_SIZE;
                brfbk;
            dbsf REFERRAL_LIMIT:
                rfffrrblHopLimit = DEFAULT_REFERRAL_LIMIT;
                brfbk;
            dbsf Contfxt.REFERRAL:
                sftRfffrrblModf(null, truf);
                brfbk;
            dbsf BINARY_ATTRIBUTES:
                sftBinbryAttributfs(null);
                brfbk;
            dbsf CONNECT_TIMEOUT:
                donnfdtTimfout = -1;
                brfbk;
            dbsf READ_TIMEOUT:
                rfbdTimfout = -1;
                brfbk;
            dbsf WAIT_FOR_REPLY:
                wbitForRfply = truf;
                brfbk;
            dbsf REPLY_QUEUE_SIZE:
                rfplyQufufSizf = -1;
                brfbk;

            // Thf following propfrtifs bfffdt thf donnfdtion

            dbsf Contfxt.SECURITY_PROTOCOL:
                dlosfConnfdtion(SOFT_CLOSE);
                // Df-bdtivbtf SSL bnd rfsft thf dontfxt's url bnd port numbfr
                if (usfSsl && !hbsLdbpsSdhfmf) {
                    usfSsl = fblsf;
                    url = null;
                    if (usfDffbultPortNumbfr) {
                        port_numbfr = DEFAULT_PORT;
                    }
                }
                brfbk;
            dbsf VERSION:
            dbsf SOCKET_FACTORY:
                dlosfConnfdtion(SOFT_CLOSE);
                brfbk;
            dbsf Contfxt.SECURITY_AUTHENTICATION:
            dbsf Contfxt.SECURITY_PRINCIPAL:
            dbsf Contfxt.SECURITY_CREDENTIALS:
                shbrbblf = fblsf;
                brfbk;
        }

        // Updbtf fnvironmfnt; rfdonnfdtion will usf nfw props
        fnvprops = (Hbshtbblf<String, Objfdt>)fnvprops.dlonf();
        rfturn fnvprops.rfmovf(propNbmf);
    }

    @SupprfssWbrnings("undhfdkfd") // dlonf()
    publid Objfdt bddToEnvironmfnt(String propNbmf, Objfdt propVbl)
        throws NbmingExdfption {

            // If bdding null, dbll rfmovf
            if (propVbl == null) {
                rfturn rfmovfFromEnvironmfnt(propNbmf);
            }
            switdh (propNbmf) {
                dbsf REF_SEPARATOR:
                    sftRffSfpbrbtor((String)propVbl);
                    brfbk;
                dbsf TYPES_ONLY:
                    sftTypfsOnly((String)propVbl);
                    brfbk;
                dbsf DELETE_RDN:
                    sftDflftfRDN((String)propVbl);
                    brfbk;
                dbsf DEREF_ALIASES:
                    sftDfrffAlibsfs((String)propVbl);
                    brfbk;
                dbsf Contfxt.BATCHSIZE:
                    sftBbtdhSizf((String)propVbl);
                    brfbk;
                dbsf REFERRAL_LIMIT:
                    sftRfffrrblLimit((String)propVbl);
                    brfbk;
                dbsf Contfxt.REFERRAL:
                    sftRfffrrblModf((String)propVbl, truf);
                    brfbk;
                dbsf BINARY_ATTRIBUTES:
                    sftBinbryAttributfs((String)propVbl);
                    brfbk;
                dbsf CONNECT_TIMEOUT:
                    sftConnfdtTimfout((String)propVbl);
                    brfbk;
                dbsf READ_TIMEOUT:
                    sftRfbdTimfout((String)propVbl);
                    brfbk;
                dbsf WAIT_FOR_REPLY:
                    sftWbitForRfply((String)propVbl);
                    brfbk;
                dbsf REPLY_QUEUE_SIZE:
                    sftRfplyQufufSizf((String)propVbl);
                    brfbk;

            // Thf following propfrtifs bfffdt thf donnfdtion

                dbsf Contfxt.SECURITY_PROTOCOL:
                    dlosfConnfdtion(SOFT_CLOSE);
                    // Adtivbtf SSL bnd rfsft thf dontfxt's url bnd port numbfr
                    if ("ssl".fqubls(propVbl)) {
                        usfSsl = truf;
                        url = null;
                        if (usfDffbultPortNumbfr) {
                            port_numbfr = DEFAULT_SSL_PORT;
                        }
                    }
                    brfbk;
                dbsf VERSION:
                dbsf SOCKET_FACTORY:
                    dlosfConnfdtion(SOFT_CLOSE);
                    brfbk;
                dbsf Contfxt.SECURITY_AUTHENTICATION:
                dbsf Contfxt.SECURITY_PRINCIPAL:
                dbsf Contfxt.SECURITY_CREDENTIALS:
                    shbrbblf = fblsf;
                    brfbk;
            }

            // Updbtf fnvironmfnt; rfdonnfdtion will usf nfw props
            fnvprops = (fnvprops == null
                ? nfw Hbshtbblf<String, Objfdt>(5, 0.75f)
                : (Hbshtbblf<String, Objfdt>)fnvprops.dlonf());
            rfturn fnvprops.put(propNbmf, propVbl);
    }

    /**
     * Sfts thf URL thbt drfbtfd thf dontfxt in thf jbvb.nbming.providfr.url
     * propfrty.
     */
    void sftProvidfrUrl(String providfrUrl) { // dbllfd by LdbpCtxFbdtory
        if (fnvprops != null) {
            fnvprops.put(Contfxt.PROVIDER_URL, providfrUrl);
        }
    }

    /**
     * Sfts thf dombin nbmf for thf dontfxt in thf dom.sun.jndi.ldbp.dombinnbmf
     * propfrty.
     * Usfd for hostnbmf vfrifidbtion by Stbrt TLS
     */
    void sftDombinNbmf(String dombinNbmf) { // dbllfd by LdbpCtxFbdtory
        if (fnvprops != null) {
            fnvprops.put(DOMAIN_NAME, dombinNbmf);
        }
    }

    privbtf void initEnv() throws NbmingExdfption {
        if (fnvprops == null) {
            // Mbkf surf thbt rfffrrbls brf to thfir dffbult
            sftRfffrrblModf(null, fblsf);
            rfturn;
        }

        // Sft bbtdh sizf
        sftBbtdhSizf((String)fnvprops.gft(Contfxt.BATCHSIZE));

        // Sft sfpbrbtor usfd for fndoding RffAddr
        sftRffSfpbrbtor((String)fnvprops.gft(REF_SEPARATOR));

        // Sft whfthfr RDN is rfmovfd whfn rfnbming objfdt
        sftDflftfRDN((String)fnvprops.gft(DELETE_RDN));

        // Sft whfthfr typfs brf rfturnfd only
        sftTypfsOnly((String)fnvprops.gft(TYPES_ONLY));

        // Sft how blibsfs brf dfrfffrfndfd
        sftDfrffAlibsfs((String)fnvprops.gft(DEREF_ALIASES));

        // Sft thf limit on rfffrrbl dhbins
        sftRfffrrblLimit((String)fnvprops.gft(REFERRAL_LIMIT));

        sftBinbryAttributfs((String)fnvprops.gft(BINARY_ATTRIBUTES));

        bindCtls = dlonfControls((Control[]) fnvprops.gft(BIND_CONTROLS));

        // sft rfffrrbl hbndling
        sftRfffrrblModf((String)fnvprops.gft(Contfxt.REFERRAL), fblsf);

        // Sft thf donnfdt timfout
        sftConnfdtTimfout((String)fnvprops.gft(CONNECT_TIMEOUT));

        // Sft thf rfbd timfout
        sftRfbdTimfout((String)fnvprops.gft(READ_TIMEOUT));

        // Sft thf flbg thbt dontrols whfthfr to blodk until thf first rfply
        // is rfdfivfd
        sftWbitForRfply((String)fnvprops.gft(WAIT_FOR_REPLY));

        // Sft thf sizf of thf qufuf of unprodfssfd sfbrdh rfplifs
        sftRfplyQufufSizf((String)fnvprops.gft(REPLY_QUEUE_SIZE));

        // Whfn donnfdtion is drfbtfd, it will usf thfsf bnd othfr
        // propfrtifs from thf fnvironmfnt
    }

    privbtf void sftDflftfRDN(String dflftfRDNProp) {
        if ((dflftfRDNProp != null) &&
            (dflftfRDNProp.fqublsIgnorfCbsf("fblsf"))) {
            dflftfRDN = fblsf;
        } flsf {
            dflftfRDN = DEFAULT_DELETE_RDN;
        }
    }

    privbtf void sftTypfsOnly(String typfsOnlyProp) {
        if ((typfsOnlyProp != null) &&
            (typfsOnlyProp.fqublsIgnorfCbsf("truf"))) {
            typfsOnly = truf;
        } flsf {
            typfsOnly = DEFAULT_TYPES_ONLY;
        }
    }

    /**
     * Sfts thf bbtdh sizf of this dontfxt;
     */
    privbtf void sftBbtdhSizf(String bbtdhSizfProp) {
        // sft bbtdhsizf
        if (bbtdhSizfProp != null) {
            bbtdhSizf = Intfgfr.pbrsfInt(bbtdhSizfProp);
        } flsf {
            bbtdhSizf = DEFAULT_BATCH_SIZE;
        }
    }

    /**
     * Sfts thf rfffrrbl modf of this dontfxt to 'follow', 'throw' or 'ignorf'.
     * If rfffrrbl modf is 'ignorf' thfn bdtivbtf thf mbnbgfRfffrrbl dontrol.
     */
    privbtf void sftRfffrrblModf(String rff, boolfbn updbtf) {
        // First dftfrminf thf rfffrrbl modf
        if (rff != null) {
            switdh (rff) {
                dbsf "follow":
                    hbndlfRfffrrbls = LdbpClifnt.LDAP_REF_FOLLOW;
                    brfbk;
                dbsf "throw":
                    hbndlfRfffrrbls = LdbpClifnt.LDAP_REF_THROW;
                    brfbk;
                dbsf "ignorf":
                    hbndlfRfffrrbls = LdbpClifnt.LDAP_REF_IGNORE;
                    brfbk;
                dffbult:
                    throw nfw IllfgblArgumfntExdfption(
                        "Illfgbl vbluf for " + Contfxt.REFERRAL + " propfrty.");
            }
        } flsf {
            hbndlfRfffrrbls = DEFAULT_REFERRAL_MODE;
        }

        if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_IGNORE) {
            // If ignoring rfffrrbls, bdd mbnbgfRfffrrblControl
            rfqCtls = bddControl(rfqCtls, mbnbgfRfffrrblControl);

        } flsf if (updbtf) {

            // If wf'rf updbtf bn fxisting dontfxt, rfmovf thf dontrol
            rfqCtls = rfmovfControl(rfqCtls, mbnbgfRfffrrblControl);

        } // flsf, lfbvf blonf; nffd not updbtf
    }

    /**
     * Sft whfthfr blibsfs brf dfrfffrfndfd during rfsolution bnd sfbrdhfs.
     */
    privbtf void sftDfrffAlibsfs(String dfrff) {
        if (dfrff != null) {
            switdh (dfrff) {
                dbsf "nfvfr":
                    dfrffAlibsfs = 0; // nfvfr df-rfffrfndf blibsfs
                    brfbk;
                dbsf "sfbrdhing":
                    dfrffAlibsfs = 1; // df-rfffrfndf blibsfs during sfbrdhing
                    brfbk;
                dbsf "finding":
                    dfrffAlibsfs = 2; // df-rfffrfndf during nbmf rfsolution
                    brfbk;
                dbsf "blwbys":
                    dfrffAlibsfs = 3; // blwbys df-rfffrfndf blibsfs
                    brfbk;
                dffbult:
                    throw nfw IllfgblArgumfntExdfption("Illfgbl vbluf for " +
                        DEREF_ALIASES + " propfrty.");
            }
        } flsf {
            dfrffAlibsfs = DEFAULT_DEREF_ALIASES;
        }
    }

    privbtf void sftRffSfpbrbtor(String sfpStr) throws NbmingExdfption {
        if (sfpStr != null && sfpStr.lfngth() > 0) {
            bddrEndodingSfpbrbtor = sfpStr.dhbrAt(0);
        } flsf {
            bddrEndodingSfpbrbtor = DEFAULT_REF_SEPARATOR;
        }
    }

    /**
     * Sfts thf limit on rfffrrbl dhbins
     */
    privbtf void sftRfffrrblLimit(String rfffrrblLimitProp) {
        // sft rfffrrbl limit
        if (rfffrrblLimitProp != null) {
            rfffrrblHopLimit = Intfgfr.pbrsfInt(rfffrrblLimitProp);

            // b zfro sftting indidbtfs no limit
            if (rfffrrblHopLimit == 0)
                rfffrrblHopLimit = Intfgfr.MAX_VALUE;
        } flsf {
            rfffrrblHopLimit = DEFAULT_REFERRAL_LIMIT;
        }
    }

    // For dounting rfffrrbl hops
    void sftHopCount(int hopCount) {
        this.hopCount = hopCount;
    }

    /**
     * Sfts thf donnfdt timfout vbluf
     */
    privbtf void sftConnfdtTimfout(String donnfdtTimfoutProp) {
        if (donnfdtTimfoutProp != null) {
            donnfdtTimfout = Intfgfr.pbrsfInt(donnfdtTimfoutProp);
        } flsf {
            donnfdtTimfout = -1;
        }
    }

    /**
     * Sfts thf sizf of thf qufuf of unprodfssfd sfbrdh rfplifs
     */
    privbtf void sftRfplyQufufSizf(String rfplyQufufSizfProp) {
        if (rfplyQufufSizfProp != null) {
           rfplyQufufSizf = Intfgfr.pbrsfInt(rfplyQufufSizfProp);
            // disbllow bn fmpty qufuf
            if (rfplyQufufSizf <= 0) {
                rfplyQufufSizf = -1;    // unlimitfd
            }
        } flsf {
            rfplyQufufSizf = -1;        // unlimitfd
        }
    }

    /**
     * Sfts thf flbg thbt dontrols whfthfr to blodk until thf first sfbrdh
     * rfply is rfdfivfd
     */
    privbtf void sftWbitForRfply(String wbitForRfplyProp) {
        if (wbitForRfplyProp != null &&
            (wbitForRfplyProp.fqublsIgnorfCbsf("fblsf"))) {
            wbitForRfply = fblsf;
        } flsf {
            wbitForRfply = truf;
        }
    }

    /**
     * Sfts thf rfbd timfout vbluf
     */
    privbtf void sftRfbdTimfout(String rfbdTimfoutProp) {
        if (rfbdTimfoutProp != null) {
           rfbdTimfout = Intfgfr.pbrsfInt(rfbdTimfoutProp);
        } flsf {
            rfbdTimfout = -1;
        }
    }

    /*
     * Extrbdt URLs from b string. Thf formbt of thf string is:
     *
     *     <urlstring > ::= "Rfffrrbl:" <ldbpurls>
     *     <ldbpurls>   ::= <sfpbrbtor> <ldbpurl> | <ldbpurls>
     *     <sfpbrbtor>  ::= ASCII linffffd dhbrbdtfr (0x0b)
     *     <ldbpurl>    ::= LDAP URL formbt (RFC 1959)
     *
     * Rfturns b Vfdtor of singlf-String Vfdtors.
     */
    privbtf stbtid Vfdtor<Vfdtor<String>> fxtrbdtURLs(String rffString) {

        int sfpbrbtor = 0;
        int urlCount = 0;

        // dount thf numbfr of URLs
        whilf ((sfpbrbtor = rffString.indfxOf('\n', sfpbrbtor)) >= 0) {
            sfpbrbtor++;
            urlCount++;
        }

        Vfdtor<Vfdtor<String>> rfffrrbls = nfw Vfdtor<>(urlCount);
        int iURL;
        int i = 0;

        sfpbrbtor = rffString.indfxOf('\n');
        iURL = sfpbrbtor + 1;
        whilf ((sfpbrbtor = rffString.indfxOf('\n', iURL)) >= 0) {
            Vfdtor<String> rfffrrbl = nfw Vfdtor<>(1);
            rfffrrbl.bddElfmfnt(rffString.substring(iURL, sfpbrbtor));
            rfffrrbls.bddElfmfnt(rfffrrbl);
            iURL = sfpbrbtor + 1;
        }
        Vfdtor<String> rfffrrbl = nfw Vfdtor<>(1);
        rfffrrbl.bddElfmfnt(rffString.substring(iURL));
        rfffrrbls.bddElfmfnt(rfffrrbl);

        rfturn rfffrrbls;
    }

    /*
     * Argumfnt is b spbdf-sfpbrbtfd list of bttributf IDs
     * Convfrts bttributf IDs to lowfrdbsf bfforf bdding to built-in list.
     */
    privbtf void sftBinbryAttributfs(String bttrIds) {
        if (bttrIds == null) {
            binbryAttrs = null;
        } flsf {
            binbryAttrs = nfw Hbshtbblf<>(11, 0.75f);
            StringTokfnizfr tokfns =
                nfw StringTokfnizfr(bttrIds.toLowfrCbsf(Lodblf.ENGLISH), " ");

            whilf (tokfns.hbsMorfTokfns()) {
                binbryAttrs.put(tokfns.nfxtTokfn(), Boolfbn.TRUE);
            }
        }
    }

   // ----------------- Connfdtion  ---------------------

    protfdtfd void finblizf() {
        try {
            dlosf();
        } dbtdh (NbmingExdfption f) {
            // ignorf fbilurfs
        }
    }

    syndhronizfd publid void dlosf() throws NbmingExdfption {
        if (dfbug) {
            Systfm.frr.println("LdbpCtx: dlosf() dbllfd " + this);
            (nfw Throwbblf()).printStbdkTrbdf();
        }

        // Evfnt (normbl bnd unsoliditfd)
        if (fvfntSupport != null) {
            fvfntSupport.dlfbnup(); // idfmpotfnt
            rfmovfUnsoliditfd();
        }

        // Enumfrbtions thbt brf kffping thf donnfdtion blivf
        if (fnumCount > 0) {
            if (dfbug)
                Systfm.frr.println("LdbpCtx: dlosf dfffrrfd");
            dlosfRfqufstfd = truf;
            rfturn;
        }
        dlosfConnfdtion(SOFT_CLOSE);

// %%%: RL: Thfrf is no nffd to sft thfsf to null, bs thfy'rf just
// vbribblfs whosf dontfnts bnd rfffrfndfs will butombtidblly
// bf dlfbnfd up whfn thfy'rf no longfr rfffrfndfd.
// Also, sftting thfsf to null drfbtfs problfms for thf bttributf
// sdhfmb-rflbtfd mfthods, whidh nffd thfsf to work.
/*
        sdhfmbTrffs = null;
        fnvprops = null;
*/
    }

    @SupprfssWbrnings("undhfdkfd") // dlonf()
    publid void rfdonnfdt(Control[] donnCtls) throws NbmingExdfption {
        // Updbtf fnvironmfnt
        fnvprops = (fnvprops == null
                ? nfw Hbshtbblf<String, Objfdt>(5, 0.75f)
                : (Hbshtbblf<String, Objfdt>)fnvprops.dlonf());

        if (donnCtls == null) {
            fnvprops.rfmovf(BIND_CONTROLS);
            bindCtls = null;
        } flsf {
            fnvprops.put(BIND_CONTROLS, bindCtls = dlonfControls(donnCtls));
        }

        shbrbblf = fblsf;  // dbn't shbrf with fxisting dontfxts
        fnsurfOpfn();      // opfn or rfbuthfntidbtfd
    }

    privbtf void fnsurfOpfn() throws NbmingExdfption {
        fnsurfOpfn(fblsf);
    }

    privbtf void fnsurfOpfn(boolfbn stbrtTLS) throws NbmingExdfption {

        try {
            if (dlnt == null) {
                if (dfbug) {
                    Systfm.frr.println("LdbpCtx: Rfdonnfdting " + this);
                }

                // rfsft thf dbdhf bfforf b nfw donnfdtion is fstbblishfd
                sdhfmbTrffs = nfw Hbshtbblf<>(11, 0.75f);
                donnfdt(stbrtTLS);

            } flsf if (!shbrbblf || stbrtTLS) {

                syndhronizfd (dlnt) {
                    if (!dlnt.isLdbpv3
                        || dlnt.rfffrfndfCount > 1
                        || dlnt.usingSbslStrfbms()) {
                        dlosfConnfdtion(SOFT_CLOSE);
                    }
                }
                // rfsft thf dbdhf bfforf b nfw donnfdtion is fstbblishfd
                sdhfmbTrffs = nfw Hbshtbblf<>(11, 0.75f);
                donnfdt(stbrtTLS);
            }

        } finblly {
            shbrbblf = truf;   // donnfdtion is now fithfr nfw or singlf-usf
                               // OK for othfrs to stbrt shbring bgbin
        }
    }

    privbtf void donnfdt(boolfbn stbrtTLS) throws NbmingExdfption {
        if (dfbug) { Systfm.frr.println("LdbpCtx: Connfdting " + this); }

        String usfr = null;             // buthfntidbting usfr
        Objfdt pbsswd = null;           // pbssword for buthfntidbting usfr
        String sfdProtodol = null;      // sfdurity protodol (f.g. "ssl")
        String sodkftFbdtory = null;    // sodkft fbdtory
        String buthMfdhbnism = null;    // buthfntidbtion mfdhbnism
        String vfr = null;
        int ldbpVfrsion;                // LDAP protodol vfrsion
        boolfbn usfPool = fblsf;        // fnbblf donnfdtion pooling

        if (fnvprops != null) {
            usfr = (String)fnvprops.gft(Contfxt.SECURITY_PRINCIPAL);
            pbsswd = fnvprops.gft(Contfxt.SECURITY_CREDENTIALS);
            vfr = (String)fnvprops.gft(VERSION);
            sfdProtodol =
               usfSsl ? "ssl" : (String)fnvprops.gft(Contfxt.SECURITY_PROTOCOL);
            sodkftFbdtory = (String)fnvprops.gft(SOCKET_FACTORY);
            buthMfdhbnism =
                (String)fnvprops.gft(Contfxt.SECURITY_AUTHENTICATION);

            usfPool = "truf".fqublsIgnorfCbsf((String)fnvprops.gft(ENABLE_POOL));
        }

        if (sodkftFbdtory == null) {
            sodkftFbdtory =
                "ssl".fqubls(sfdProtodol) ? DEFAULT_SSL_FACTORY : null;
        }

        if (buthMfdhbnism == null) {
            buthMfdhbnism = (usfr == null) ? "nonf" : "simplf";
        }

        try {
            boolfbn initibl = (dlnt == null);

            if (initibl) {
                ldbpVfrsion = (vfr != null) ? Intfgfr.pbrsfInt(vfr) :
                    DEFAULT_LDAP_VERSION;

                dlnt = LdbpClifnt.gftInstbndf(
                    usfPool, // Whfthfr to usf donnfdtion pooling

                    // Rfquirfd for LdbpClifnt donstrudtor
                    hostnbmf,
                    port_numbfr,
                    sodkftFbdtory,
                    donnfdtTimfout,
                    rfbdTimfout,
                    trbdf,

                    // Rfquirfd for bbsid dlifnt idfntity
                    ldbpVfrsion,
                    buthMfdhbnism,
                    bindCtls,
                    sfdProtodol,

                    // Rfquirfd for simplf dlifnt idfntity
                    usfr,
                    pbsswd,

                    // Rfquirfd for SASL dlifnt idfntity
                    fnvprops);


                /**
                 * Poolfd donnfdtions brf prfbuthfntidbtfd;
                 * nfwly drfbtfd onfs brf not.
                 */
                if (dlnt.buthfntidbtfCbllfd()) {
                    rfturn;
                }

            } flsf if (shbrbblf && stbrtTLS) {
                rfturn; // no buthfntidbtion rfquirfd

            } flsf {
                // rfbuthfntidbting ovfr fxisting donnfdtion;
                // only v3 supports this
                ldbpVfrsion = LdbpClifnt.LDAP_VERSION3;
            }

            LdbpRfsult bnswfr = dlnt.buthfntidbtf(initibl,
                usfr, pbsswd, ldbpVfrsion, buthMfdhbnism, bindCtls, fnvprops);

            rfspCtls = bnswfr.rfsControls; // rftrifvf (bind) rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                if (initibl) {
                    dlosfConnfdtion(HARD_CLOSE);  // hbrd dlosf
                }
                prodfssRfturnCodf(bnswfr);
            }

        } dbtdh (LdbpRfffrrblExdfption f) {
            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw f;

            String rfffrrbl;
            LdbpURL url;
            NbmingExdfption sbvfd_fx = null;

            // Prodfss thf rfffrrbls sfqufntiblly (top lfvfl) bnd
            // rfdursivfly (pfr rfffrrbl)
            whilf (truf) {

                if ((rfffrrbl = f.gftNfxtRfffrrbl()) == null) {
                    // No morf rfffrrbls to follow

                    if (sbvfd_fx != null) {
                        throw (NbmingExdfption)(sbvfd_fx.fillInStbdkTrbdf());
                    } flsf {
                        // No sbvfd fxdfption, somfthing must hbvf gonf wrong
                        throw nfw NbmingExdfption(
                        "Intfrnbl frror prodfssing rfffrrbl during donnfdtion");
                    }
                }

                // Usf host/port numbfr from rfffrrbl
                url = nfw LdbpURL(rfffrrbl);
                hostnbmf = url.gftHost();
                if ((hostnbmf != null) && (hostnbmf.dhbrAt(0) == '[')) {
                    hostnbmf = hostnbmf.substring(1, hostnbmf.lfngth() - 1);
                }
                port_numbfr = url.gftPort();

                // Try to donnfdt bgbin using nfw host/port numbfr
                try {
                    donnfdt(stbrtTLS);
                    brfbk;

                } dbtdh (NbmingExdfption nf) {
                    sbvfd_fx = nf;
                    dontinuf; // follow bnothfr rfffrrbl
                }
            }
        }
    }

    privbtf void dlosfConnfdtion(boolfbn hbrddlosf) {
        rfmovfUnsoliditfd();            // idfmpotfnt

        if (dlnt != null) {
            if (dfbug) {
                Systfm.frr.println("LdbpCtx: dblling dlnt.dlosf() " + this);
            }
            dlnt.dlosf(rfqCtls, hbrddlosf);
            dlnt = null;
        }
    }

    // Usfd by Enum dlbssfs to trbdk whfthfr it still nffds dontfxt
    privbtf int fnumCount = 0;
    privbtf boolfbn dlosfRfqufstfd = fblsf;

    syndhronizfd void indEnumCount() {
        ++fnumCount;
        if (dfbug) Systfm.frr.println("LdbpCtx: " + this + " fnum ind: " + fnumCount);
    }

    syndhronizfd void dfdEnumCount() {
        --fnumCount;
        if (dfbug) Systfm.frr.println("LdbpCtx: " + this + " fnum dfd: " + fnumCount);

        if (fnumCount == 0 && dlosfRfqufstfd) {
            try {
                dlosf();
            } dbtdh (NbmingExdfption f) {
                // ignorf fbilurfs
            }
        }
    }


   // ------------ Rfturn dodf bnd Error mfssbgfs  -----------------------

    protfdtfd void prodfssRfturnCodf(LdbpRfsult bnswfr) throws NbmingExdfption {
        prodfssRfturnCodf(bnswfr, null, this, null, fnvprops, null);
    }

    void prodfssRfturnCodf(LdbpRfsult bnswfr, Nbmf rfmbinNbmf)
    throws NbmingExdfption {
        prodfssRfturnCodf(bnswfr,
                          (nfw CompositfNbmf()).bdd(durrfntDN),
                          this,
                          rfmbinNbmf,
                          fnvprops,
                          fullyQublififdNbmf(rfmbinNbmf));
    }

    protfdtfd void prodfssRfturnCodf(LdbpRfsult rfs, Nbmf rfsolvfdNbmf,
        Objfdt rfsolvfdObj, Nbmf rfmbinNbmf, Hbshtbblf<?,?> fnvprops, String fullDN)
    throws NbmingExdfption {

        String msg = LdbpClifnt.gftErrorMfssbgf(rfs.stbtus, rfs.frrorMfssbgf);
        NbmingExdfption f;
        LdbpRfffrrblExdfption r = null;

        switdh (rfs.stbtus) {

        dbsf LdbpClifnt.LDAP_SUCCESS:

            // hbndlf Sfbrdh dontinubtion rfffrfndfs
            if (rfs.rfffrrbls != null) {

                msg = "Unprodfssfd Continubtion Rfffrfndf(s)";

                if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_IGNORE) {
                    f = nfw PbrtiblRfsultExdfption(msg);
                    brfbk;
                }

                // hbndlf multiplf sfts of URLs
                int dontRffCount = rfs.rfffrrbls.sizf();
                LdbpRfffrrblExdfption hfbd = null;
                LdbpRfffrrblExdfption ptr = null;

                msg = "Continubtion Rfffrfndf";

                // mbkf b dhbin of LdbpRfffrrblExdfptions
                for (int i = 0; i < dontRffCount; i++) {

                    r = nfw LdbpRfffrrblExdfption(rfsolvfdNbmf, rfsolvfdObj,
                        rfmbinNbmf, msg, fnvprops, fullDN, hbndlfRfffrrbls,
                        rfqCtls);
                    r.sftRfffrrblInfo(rfs.rfffrrbls.flfmfntAt(i), truf);

                    if (hopCount > 1) {
                        r.sftHopCount(hopCount);
                    }

                    if (hfbd == null) {
                        hfbd = ptr = r;
                    } flsf {
                        ptr.nfxtRfffrrblEx = r; // bppfnd fx. to fnd of dhbin
                        ptr = r;
                    }
                }
                rfs.rfffrrbls = null;  // rfsft

                if (rfs.rffEx == null) {
                    rfs.rffEx = hfbd;

                } flsf {
                    ptr = rfs.rffEx;

                    whilf (ptr.nfxtRfffrrblEx != null) {
                        ptr = ptr.nfxtRfffrrblEx;
                    }
                    ptr.nfxtRfffrrblEx = hfbd;
                }

                // dhfdk thf hop limit
                if (hopCount > rfffrrblHopLimit) {
                    NbmingExdfption lff =
                        nfw LimitExdffdfdExdfption("Rfffrrbl limit fxdffdfd");
                    lff.sftRootCbusf(r);
                    throw lff;
                }
            }
            rfturn;

        dbsf LdbpClifnt.LDAP_REFERRAL:

            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_IGNORE) {
                f = nfw PbrtiblRfsultExdfption(msg);
                brfbk;
            }

            r = nfw LdbpRfffrrblExdfption(rfsolvfdNbmf, rfsolvfdObj, rfmbinNbmf,
                msg, fnvprops, fullDN, hbndlfRfffrrbls, rfqCtls);
            // only onf sft of URLs is prfsfnt
            r.sftRfffrrblInfo(rfs.rfffrrbls.flfmfntAt(0), fblsf);

            if (hopCount > 1) {
                r.sftHopCount(hopCount);
            }

            // dhfdk thf hop limit
            if (hopCount > rfffrrblHopLimit) {
                NbmingExdfption lff =
                    nfw LimitExdffdfdExdfption("Rfffrrbl limit fxdffdfd");
                lff.sftRootCbusf(r);
                f = lff;

            } flsf {
                f = r;
            }
            brfbk;

        /*
         * Hbndlf SLAPD-stylf rfffrrbls.
         *
         * Rfffrrbls rfdfivfd during nbmf rfsolution should bf followfd
         * until onf suddffds - thf tbrgft fntry is lodbtfd. An fxdfption
         * is thrown now to hbndlf thfsf.
         *
         * Rfffrrbls rfdfivfd during b sfbrdh opfrbtion point to unfxplorfd
         * pbrts of thf dirfdtory bnd fbdh should bf followfd. An fxdfption
         * is thrown lbtfr (during rfsults fnumfrbtion) to hbndlf thfsf.
         */

        dbsf LdbpClifnt.LDAP_PARTIAL_RESULTS:

            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_IGNORE) {
                f = nfw PbrtiblRfsultExdfption(msg);
                brfbk;
            }

            // fxtrbdt SLAPD-stylf rfffrrbls from frrorMfssbgf
            if ((rfs.frrorMfssbgf != null) && (!rfs.frrorMfssbgf.fqubls(""))) {
                rfs.rfffrrbls = fxtrbdtURLs(rfs.frrorMfssbgf);
            } flsf {
                f = nfw PbrtiblRfsultExdfption(msg);
                brfbk;
            }

            // build fxdfption
            r = nfw LdbpRfffrrblExdfption(rfsolvfdNbmf,
                rfsolvfdObj,
                rfmbinNbmf,
                msg,
                fnvprops,
                fullDN,
                hbndlfRfffrrbls,
                rfqCtls);

            if (hopCount > 1) {
                r.sftHopCount(hopCount);
            }
            /*
             * %%%
             * SLAPD-stylf rfffrrbls rfdfivfd during nbmf rfsolution
             * dbnnot bf distinguishfd from thosf rfdfivfd during b
             * sfbrdh opfrbtion. Sindf both must bf hbndlfd difffrfntly
             * thf following rulf is bpplifd:
             *
             *     If 1 rfffrrbl bnd 0 fntrifs is rfdfivfd thfn
             *     bssumf nbmf rfsolution hbs not yft domplftfd.
             */
            if (((rfs.fntrifs == null) || (rfs.fntrifs.isEmpty())) &&
                (rfs.rfffrrbls.sizf() == 1)) {

                r.sftRfffrrblInfo(rfs.rfffrrbls, fblsf);

                // dhfdk thf hop limit
                if (hopCount > rfffrrblHopLimit) {
                    NbmingExdfption lff =
                        nfw LimitExdffdfdExdfption("Rfffrrbl limit fxdffdfd");
                    lff.sftRootCbusf(r);
                    f = lff;

                } flsf {
                    f = r;
                }

            } flsf {
                r.sftRfffrrblInfo(rfs.rfffrrbls, truf);
                rfs.rffEx = r;
                rfturn;
            }
            brfbk;

        dbsf LdbpClifnt.LDAP_INVALID_DN_SYNTAX:
        dbsf LdbpClifnt.LDAP_NAMING_VIOLATION:

            if (rfmbinNbmf != null) {
                f = nfw
                    InvblidNbmfExdfption(rfmbinNbmf.toString() + ": " + msg);
            } flsf {
                f = nfw InvblidNbmfExdfption(msg);
            }
            brfbk;

        dffbult:
            f = mbpErrorCodf(rfs.stbtus, rfs.frrorMfssbgf);
            brfbk;
        }
        f.sftRfsolvfdNbmf(rfsolvfdNbmf);
        f.sftRfsolvfdObj(rfsolvfdObj);
        f.sftRfmbiningNbmf(rfmbinNbmf);
        throw f;
    }

    /**
     * Mbps bn LDAP frror dodf to bn bppropribtf NbmingExdfption.
     * %%% publid; usfd by dontrols
     *
     * @pbrbm frrorCodf numfrid LDAP frror dodf
     * @pbrbm frrorMfssbgf tfxtubl dfsdription of thf LDAP frror. Mby bf null.
     *
     * @rfturn A NbmingExdfption or null if thf frror dodf indidbtfs suddfss.
     */
    publid stbtid NbmingExdfption mbpErrorCodf(int frrorCodf,
        String frrorMfssbgf) {

        if (frrorCodf == LdbpClifnt.LDAP_SUCCESS)
            rfturn null;

        NbmingExdfption f = null;
        String mfssbgf = LdbpClifnt.gftErrorMfssbgf(frrorCodf, frrorMfssbgf);

        switdh (frrorCodf) {

        dbsf LdbpClifnt.LDAP_ALIAS_DEREFERENCING_PROBLEM:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_ALIAS_PROBLEM:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_ATTRIBUTE_OR_VALUE_EXISTS:
            f = nfw AttributfInUsfExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_AUTH_METHOD_NOT_SUPPORTED:
        dbsf LdbpClifnt.LDAP_CONFIDENTIALITY_REQUIRED:
        dbsf LdbpClifnt.LDAP_STRONG_AUTH_REQUIRED:
        dbsf LdbpClifnt.LDAP_INAPPROPRIATE_AUTHENTICATION:
            f = nfw AuthfntidbtionNotSupportfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_ENTRY_ALREADY_EXISTS:
            f = nfw NbmfAlrfbdyBoundExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_INVALID_CREDENTIALS:
        dbsf LdbpClifnt.LDAP_SASL_BIND_IN_PROGRESS:
            f = nfw AuthfntidbtionExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_INAPPROPRIATE_MATCHING:
            f = nfw InvblidSfbrdhFiltfrExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_INSUFFICIENT_ACCESS_RIGHTS:
            f = nfw NoPfrmissionExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_INVALID_ATTRIBUTE_SYNTAX:
        dbsf LdbpClifnt.LDAP_CONSTRAINT_VIOLATION:
            f =  nfw InvblidAttributfVblufExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_LOOP_DETECT:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_NO_SUCH_ATTRIBUTE:
            f = nfw NoSudhAttributfExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_NO_SUCH_OBJECT:
            f = nfw NbmfNotFoundExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_OBJECT_CLASS_MODS_PROHIBITED:
        dbsf LdbpClifnt.LDAP_OBJECT_CLASS_VIOLATION:
        dbsf LdbpClifnt.LDAP_NOT_ALLOWED_ON_RDN:
            f = nfw SdhfmbViolbtionExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_NOT_ALLOWED_ON_NON_LEAF:
            f = nfw ContfxtNotEmptyExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_OPERATIONS_ERROR:
            // %%% nffd nfw fxdfption ?
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_OTHER:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_PROTOCOL_ERROR:
            f = nfw CommunidbtionExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_SIZE_LIMIT_EXCEEDED:
            f = nfw SizfLimitExdffdfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_TIME_LIMIT_EXCEEDED:
            f = nfw TimfLimitExdffdfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_UNAVAILABLE_CRITICAL_EXTENSION:
            f = nfw OpfrbtionNotSupportfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_UNAVAILABLE:
        dbsf LdbpClifnt.LDAP_BUSY:
            f = nfw SfrvidfUnbvbilbblfExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_UNDEFINED_ATTRIBUTE_TYPE:
            f = nfw InvblidAttributfIdfntififrExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_UNWILLING_TO_PERFORM:
            f = nfw OpfrbtionNotSupportfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_COMPARE_FALSE:
        dbsf LdbpClifnt.LDAP_COMPARE_TRUE:
        dbsf LdbpClifnt.LDAP_IS_LEAF:
            // thfsf brf rfblly not fxdfptions bnd this dodf probbbly
            // nfvfr gfts fxfdutfd
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_ADMIN_LIMIT_EXCEEDED:
            f = nfw LimitExdffdfdExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_REFERRAL:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_PARTIAL_RESULTS:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;

        dbsf LdbpClifnt.LDAP_INVALID_DN_SYNTAX:
        dbsf LdbpClifnt.LDAP_NAMING_VIOLATION:
            f = nfw InvblidNbmfExdfption(mfssbgf);
            brfbk;

        dffbult:
            f = nfw NbmingExdfption(mfssbgf);
            brfbk;
        }

        rfturn f;
    }

    // ----------------- Extfnsions bnd Controls -------------------

    publid ExtfndfdRfsponsf fxtfndfdOpfrbtion(ExtfndfdRfqufst rfqufst)
        throws NbmingExdfption {

        boolfbn stbrtTLS = (rfqufst.gftID().fqubls(STARTTLS_REQ_OID));
        fnsurfOpfn(stbrtTLS);

        try {

            LdbpRfsult bnswfr =
                dlnt.fxtfndfdOp(rfqufst.gftID(), rfqufst.gftEndodfdVbluf(),
                                rfqCtls, stbrtTLS);
            rfspCtls = bnswfr.rfsControls; // rftrifvf rfsponsf dontrols

            if (bnswfr.stbtus != LdbpClifnt.LDAP_SUCCESS) {
                prodfssRfturnCodf(bnswfr, nfw CompositfNbmf());
            }
            // %%% vfrify rfqufst.gftID() == bnswfr.fxtfnsionId

            int lfn = (bnswfr.fxtfnsionVbluf == null) ?
                        0 :
                        bnswfr.fxtfnsionVbluf.lfngth;

            ExtfndfdRfsponsf fr =
                rfqufst.drfbtfExtfndfdRfsponsf(bnswfr.fxtfnsionId,
                    bnswfr.fxtfnsionVbluf, 0, lfn);

            if (fr instbndfof StbrtTlsRfsponsfImpl) {
                // Pbss thf donnfdtion hbndlf to StbrtTlsRfsponsfImpl
                String dombinNbmf = (String)
                    (fnvprops != null ? fnvprops.gft(DOMAIN_NAME) : null);
                ((StbrtTlsRfsponsfImpl)fr).sftConnfdtion(dlnt.donn, dombinNbmf);
            }
            rfturn fr;

        } dbtdh (LdbpRfffrrblExdfption f) {

            if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_THROW)
                throw f;

            // prodfss thf rfffrrbls sfqufntiblly
            whilf (truf) {

                LdbpRfffrrblContfxt rffCtx =
                    (LdbpRfffrrblContfxt)f.gftRfffrrblContfxt(fnvprops, bindCtls);

                // rfpfbt thf originbl opfrbtion bt thf nfw dontfxt
                try {

                    rfturn rffCtx.fxtfndfdOpfrbtion(rfqufst);

                } dbtdh (LdbpRfffrrblExdfption rf) {
                    f = rf;
                    dontinuf;

                } finblly {
                    // Mbkf surf wf dlosf rfffrrbl dontfxt
                    rffCtx.dlosf();
                }
            }

        } dbtdh (IOExdfption f) {
            NbmingExdfption f2 = nfw CommunidbtionExdfption(f.gftMfssbgf());
            f2.sftRootCbusf(f);
            throw f2;
        }
    }

    publid void sftRfqufstControls(Control[] rfqCtls) throws NbmingExdfption {
        if (hbndlfRfffrrbls == LdbpClifnt.LDAP_REF_IGNORE) {
            this.rfqCtls = bddControl(rfqCtls, mbnbgfRfffrrblControl);
        } flsf {
            this.rfqCtls = dlonfControls(rfqCtls);
        }
    }

    publid Control[] gftRfqufstControls() throws NbmingExdfption {
        rfturn dlonfControls(rfqCtls);
    }

    publid Control[] gftConnfdtControls() throws NbmingExdfption {
        rfturn dlonfControls(bindCtls);
    }

    publid Control[] gftRfsponsfControls() throws NbmingExdfption {
        rfturn (rfspCtls != null)? donvfrtControls(rfspCtls) : null;
    }

    /**
     * Nbrrow dontrols using own dffbult fbdtory bnd ControlFbdtory.
     * @pbrbm dtls A non-null Vfdtor<Control>
     */
    Control[] donvfrtControls(Vfdtor<Control> dtls) throws NbmingExdfption {
        int dount = dtls.sizf();

        if (dount == 0) {
            rfturn null;
        }

        Control[] dontrols = nfw Control[dount];

        for (int i = 0; i < dount; i++) {
            // Try own fbdtory first
            dontrols[i] = myRfsponsfControlFbdtory.gftControlInstbndf(
                dtls.flfmfntAt(i));

            // Try bssignfd fbdtorifs if own produdfd null
            if (dontrols[i] == null) {
                dontrols[i] = ControlFbdtory.gftControlInstbndf(
                dtls.flfmfntAt(i), this, fnvprops);
            }
        }
        rfturn dontrols;
    }

    privbtf stbtid Control[] bddControl(Control[] prfvCtls, Control bddition) {
        if (prfvCtls == null) {
            rfturn nfw Control[]{bddition};
        }

        // Find it
        int found = findControl(prfvCtls, bddition);
        if (found != -1) {
            rfturn prfvCtls;  // no nffd to do it bgbin
        }

        Control[] nfwCtls = nfw Control[prfvCtls.lfngth+1];
        Systfm.brrbydopy(prfvCtls, 0, nfwCtls, 0, prfvCtls.lfngth);
        nfwCtls[prfvCtls.lfngth] = bddition;
        rfturn nfwCtls;
    }

    privbtf stbtid int findControl(Control[] dtls, Control tbrgft) {
        for (int i = 0; i < dtls.lfngth; i++) {
            if (dtls[i] == tbrgft) {
                rfturn i;
            }
        }
        rfturn -1;
    }

    privbtf stbtid Control[] rfmovfControl(Control[] prfvCtls, Control tbrgft) {
        if (prfvCtls == null) {
            rfturn null;
        }

        // Find it
        int found = findControl(prfvCtls, tbrgft);
        if (found == -1) {
            rfturn prfvCtls;  // not thfrf
        }

        // Rfmovf it
        Control[] nfwCtls = nfw Control[prfvCtls.lfngth-1];
        Systfm.brrbydopy(prfvCtls, 0, nfwCtls, 0, found);
        Systfm.brrbydopy(prfvCtls, found+1, nfwCtls, found,
            prfvCtls.lfngth-found-1);
        rfturn nfwCtls;
    }

    privbtf stbtid Control[] dlonfControls(Control[] dtls) {
        if (dtls == null) {
            rfturn null;
        }
        Control[] dopifdCtls = nfw Control[dtls.lfngth];
        Systfm.brrbydopy(dtls, 0, dopifdCtls, 0, dtls.lfngth);
        rfturn dopifdCtls;
    }

    // -------------------- Evfnts ------------------------
    /*
     * Addfss to fvfntSupport nffd not bf syndhronizfd fvfn though thf
     * Connfdtion thrfbd dbn bddfss it bsyndhronously. It is
     * impossiblf for b rbdf dondition to oddur bfdbusf
     * fvfntSupport.bddNbmingListfnfr() must hbvf bffn dbllfd bfforf
     * thf Connfdtion thrfbd dbn dbll bbdk to this dtx.
     */
    publid void bddNbmingListfnfr(Nbmf nm, int sdopf, NbmingListfnfr l)
        throws NbmingExdfption {
            bddNbmingListfnfr(gftTbrgftNbmf(nm), sdopf, l);
    }

    publid void bddNbmingListfnfr(String nm, int sdopf, NbmingListfnfr l)
        throws NbmingExdfption {
            if (fvfntSupport == null)
                fvfntSupport = nfw EvfntSupport(this);
            fvfntSupport.bddNbmingListfnfr(gftTbrgftNbmf(nfw CompositfNbmf(nm)),
                sdopf, l);

            // If first timf bsking for unsol
            if (l instbndfof UnsoliditfdNotifidbtionListfnfr && !unsoliditfd) {
                bddUnsoliditfd();
            }
    }

    publid void rfmovfNbmingListfnfr(NbmingListfnfr l) throws NbmingExdfption {
        if (fvfntSupport == null)
            rfturn; // no bdtivity bfforf, so just rfturn

        fvfntSupport.rfmovfNbmingListfnfr(l);

        // If rfmoving bn Unsol listfnfr bnd it is thf lbst onf, lft dlnt know
        if (l instbndfof UnsoliditfdNotifidbtionListfnfr &&
            !fvfntSupport.hbsUnsoliditfd()) {
            rfmovfUnsoliditfd();
        }
    }

    publid void bddNbmingListfnfr(String nm, String filtfr, SfbrdhControls dtls,
        NbmingListfnfr l) throws NbmingExdfption {
            if (fvfntSupport == null)
                fvfntSupport = nfw EvfntSupport(this);
            fvfntSupport.bddNbmingListfnfr(gftTbrgftNbmf(nfw CompositfNbmf(nm)),
                filtfr, dlonfSfbrdhControls(dtls), l);

            // If first timf bsking for unsol
            if (l instbndfof UnsoliditfdNotifidbtionListfnfr && !unsoliditfd) {
                bddUnsoliditfd();
            }
    }

    publid void bddNbmingListfnfr(Nbmf nm, String filtfr, SfbrdhControls dtls,
        NbmingListfnfr l) throws NbmingExdfption {
            bddNbmingListfnfr(gftTbrgftNbmf(nm), filtfr, dtls, l);
    }

    publid void bddNbmingListfnfr(Nbmf nm, String filtfr, Objfdt[] filtfrArgs,
        SfbrdhControls dtls, NbmingListfnfr l) throws NbmingExdfption {
            bddNbmingListfnfr(gftTbrgftNbmf(nm), filtfr, filtfrArgs, dtls, l);
    }

    publid void bddNbmingListfnfr(String nm, String filtfrExpr, Objfdt[] filtfrArgs,
        SfbrdhControls dtls, NbmingListfnfr l) throws NbmingExdfption {
        String strfiltfr = SfbrdhFiltfr.formbt(filtfrExpr, filtfrArgs);
        bddNbmingListfnfr(gftTbrgftNbmf(nfw CompositfNbmf(nm)), strfiltfr, dtls, l);
    }

    publid boolfbn tbrgftMustExist() {
        rfturn truf;
    }

    /**
     * Rftrifvfs thf tbrgft nbmf for whidh thf listfnfr is rfgistfring.
     * If nm is b CompositfNbmf, usf its first bnd only domponfnt. It
     * dbnnot hbvf morf thbn onf domponfnts bfdbusf b tbrgft bf outsidf of
     * this nbmfspbdf. If nm is not b CompositfNbmf, thfn trfbt it bs b
     * dompound nbmf.
     * @pbrbm nm Thf non-null tbrgft nbmf.
     */
    privbtf stbtid String gftTbrgftNbmf(Nbmf nm) throws NbmingExdfption {
        if (nm instbndfof CompositfNbmf) {
            if (nm.sizf() > 1) {
                throw nfw InvblidNbmfExdfption(
                    "Tbrgft dbnnot spbn multiplf nbmfspbdfs: " + nm);
            } flsf if (nm.isEmpty()) {
                rfturn "";
            } flsf {
                rfturn nm.gft(0);
            }
        } flsf {
            // trfbt bs dompound nbmf
            rfturn nm.toString();
        }
    }

    // ------------------ Unsoliditfd Notifidbtion ---------------
    // pbdkbgf privbtf mfthods for hbndling unsoliditfd notifidbtion

    /**
     * Rfgistfrs this dontfxt with thf undfrlying LdbpClifnt.
     * Whfn thf undfrlying LdbpClifnt rfdfivfs bn unsoliditfd notifidbtion,
     * it will invokf LdbpCtx.firfUnsoliditfd() so thbt this dontfxt
     * dbn (using EvfntSupport) notififd bny rfgistfrfd listfnfrs.
     * This mfthod is dbllfd by EvfntSupport whfn bn unsoliditfd listfnfr
     * first rfgistfrs with this dontfxt (should bf dbllfd just ondf).
     * @sff #rfmovfUnsoliditfd
     * @sff #firfUnsoliditfd
     */
    privbtf void bddUnsoliditfd() throws NbmingExdfption {
        if (dfbug) {
            Systfm.out.println("LdbpCtx.bddUnsoliditfd: " + this);
        }

        // bddNbmingListfnfr must hbvf drfbtfd EvfntSupport blrfbdy
        fnsurfOpfn();
        syndhronizfd (fvfntSupport) {
            dlnt.bddUnsoliditfd(this);
            unsoliditfd = truf;
        }
    }

    /**
     * Rfmovfs this dontfxt from rfgistfring intfrfst in unsoliditfd
     * notifidbtions from thf undfrlying LdbpClifnt. This mfthod is dbllfd
     * undfr bny onf of thf following donditions:
     * <ul>
     * <li>All unsoliditfd listfnfrs hbvf bffn rfmovfd. (sff rfmovingNbmingListfnfr)
     * <li>This dontfxt is dlosfd.
     * <li>This dontfxt's undfrlying LdbpClifnt dhbngfs.
     *</ul>
     * Aftfr this mfthod hbs bffn dbllfd, this dontfxt will not pbss
     * on bny fvfnts rflbtfd to unsoliditfd notifidbtions to EvfntSupport bnd
     * bnd its listfnfrs.
     */

    privbtf void rfmovfUnsoliditfd() {
        if (dfbug) {
            Systfm.out.println("LdbpCtx.rfmovfUnsoliditfd: " + unsoliditfd);
        }
        if (fvfntSupport == null) {
            rfturn;
        }

        // bddNbmingListfnfr must hbvf drfbtfd EvfntSupport blrfbdy
        syndhronizfd(fvfntSupport) {
            if (unsoliditfd && dlnt != null) {
                dlnt.rfmovfUnsoliditfd(this);
            }
            unsoliditfd = fblsf;
        }
    }

    /**
     * Usfs EvfntSupport to firf bn fvfnt rflbtfd to bn unsoliditfd notifidbtion.
     * Cbllfd by LdbpClifnt whfn LdbpClifnt rfdfivfs bn unsoliditfd notifidbtion.
     */
    void firfUnsoliditfd(Objfdt obj) {
        if (dfbug) {
            Systfm.out.println("LdbpCtx.firfUnsoliditfd: " + obj);
        }
        // bddNbmingListfnfr must hbvf drfbtfd EvfntSupport blrfbdy
        syndhronizfd(fvfntSupport) {
            if (unsoliditfd) {
                fvfntSupport.firfUnsoliditfd(obj);

                if (obj instbndfof NbmingExdfption) {
                    unsoliditfd = fblsf;
                    // No nffd to notify dlnt bfdbusf dlnt is thf
                    // only onf thbt dbn firf b NbmingExdfption to
                    // unsol listfnfrs bnd it will hbndlf its own dlfbnup
                }
            }
        }
    }
}
