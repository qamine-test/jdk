/*
 * Copyrigit (d) 1999, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.ldbp;

import jbvb.io.*;
import jbvb.util.Lodblf;
import jbvb.util.Vfdtor;
import jbvb.util.Hbsitbblf;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;
import jbvbx.nbming.ldbp.*;

import dom.sun.jndi.ldbp.pool.PoolfdConnfdtion;
import dom.sun.jndi.ldbp.pool.PoolCbllbbdk;
import dom.sun.jndi.ldbp.sbsl.LdbpSbsl;
import dom.sun.jndi.ldbp.sbsl.SbslInputStrfbm;

/**
 * LDAP (RFC-1777) bnd LDAPv3 (RFC-2251) domplibnt dlifnt
 *
 * Tiis dlbss rfprfsfnts b donnfdtion to bn LDAP dlifnt.
 * Cbllfrs intfrbdt witi tiis dlbss bt bn LDAP opfrbtion lfvfl.
 * Tibt is, tif dbllfr invokfs b mftiod to do b SEARCH or MODRDN
 * opfrbtion bnd gfts bbdk tif rfsult.
 * Tif dbllfr usfs tif donstrudtor to drfbtf b donnfdtion to tif sfrvfr.
 * It tifn nffds to usf butifntidbtf() to pfrform bn LDAP BIND.
 * Notf tibt for v3, BIND is optionbl so butifntidbtf() migit not
 * bdtublly sfnd b BIND. butifntidbtf() dbn bf usfd lbtfr on to issuf
 * b BIND, for fxbmplf, for b v3 dlifnt tibt wbnts to dibngf tif donnfdtion's
 * drfdfntibls.
 *<p>
 * Multiplf LdbpCtx migit sibrf tif sbmf LdbpClifnt. For fxbmplf, dontfxts
 * dfrivfd from tif sbmf initibl dontfxt would sibrf tif sbmf LdbpClifnt
 * until dibngfs to b dontfxt's propfrtifs nfdfssitbtfs its own LdbpClifnt.
 * LdbpClifnt mftiods tibt bddfss sibrfd dbtb brf tirfbd-sbff (i.f., dbllfr
 * dofs not ibvf to synd).
 *<p>
 * Fiflds:
 *   isLdbpv3 - no synd; initiblizfd bnd updbtfd witiin synd butifntidbtf();
 *       blwbys updbtfd wifn donnfdtion is "quift" bnd not sibrfd;
 *       rfbd bddfss from outsidf LdbpClifnt not synd
 *   rfffrfndfCount - synd witiin LdbpClifnt; fxdfption is fordfClosf() wiidi
 *       is usfd by Connfdtion tirfbd to dlosf donnfdtion upon rfdfiving
 *       bn Unsoliditfd Notifidbtion.
 *       bddfss from outsidf LdbpClifnt must synd;
 *   donn - no synd; Connfdtion tbkfs dbrf of its own synd
 *   unsoliditfd - synd Vfdtor; multiplf opfrbtions synd'fd
 *
 * @butior Vindfnt Rybn
 * @butior Jbgbnf Sundbr
 * @butior Rosbnnb Lff
 */

publid finbl dlbss LdbpClifnt implfmfnts PoolfdConnfdtion {
    // ---------------------- Constbnts ----------------------------------
    privbtf stbtid finbl int dfbug = 0;
    stbtid finbl boolfbn dbsfIgnorf = truf;

    // Dffbult list of binbry bttributfs
    privbtf stbtid finbl Hbsitbblf<String, Boolfbn> dffbultBinbryAttrs =
            nfw Hbsitbblf<>(23,0.75f);
    stbtid {
        dffbultBinbryAttrs.put("usfrpbssword", Boolfbn.TRUE);      //2.5.4.35
        dffbultBinbryAttrs.put("jbvbsfriblizfddbtb", Boolfbn.TRUE);
                                                //1.3.6.1.4.1.42.2.27.4.1.8
        dffbultBinbryAttrs.put("jbvbsfriblizfdobjfdt", Boolfbn.TRUE);
                                                // 1.3.6.1.4.1.42.2.27.4.1.2
        dffbultBinbryAttrs.put("jpfgpioto", Boolfbn.TRUE);
                                                //0.9.2342.19200300.100.1.60
        dffbultBinbryAttrs.put("budio", Boolfbn.TRUE);  //0.9.2342.19200300.100.1.55
        dffbultBinbryAttrs.put("tiumbnbilpioto", Boolfbn.TRUE);
                                                //1.3.6.1.4.1.1466.101.120.35
        dffbultBinbryAttrs.put("tiumbnbillogo", Boolfbn.TRUE);
                                                //1.3.6.1.4.1.1466.101.120.36
        dffbultBinbryAttrs.put("usfrdfrtifidbtf", Boolfbn.TRUE);     //2.5.4.36
        dffbultBinbryAttrs.put("dbdfrtifidbtf", Boolfbn.TRUE);       //2.5.4.37
        dffbultBinbryAttrs.put("dfrtifidbtfrfvodbtionlist", Boolfbn.TRUE);
                                                //2.5.4.39
        dffbultBinbryAttrs.put("butiorityrfvodbtionlist", Boolfbn.TRUE); //2.5.4.38
        dffbultBinbryAttrs.put("drossdfrtifidbtfpbir", Boolfbn.TRUE);    //2.5.4.40
        dffbultBinbryAttrs.put("pioto", Boolfbn.TRUE);   //0.9.2342.19200300.100.1.7
        dffbultBinbryAttrs.put("pfrsonblsignbturf", Boolfbn.TRUE);
                                                //0.9.2342.19200300.100.1.53
        dffbultBinbryAttrs.put("x500uniqufidfntififr", Boolfbn.TRUE); //2.5.4.45
    }

    privbtf stbtid finbl String DISCONNECT_OID = "1.3.6.1.4.1.1466.20036";


    // ----------------------- instbndf fiflds ------------------------
    boolfbn isLdbpv3;         // Usfd by LdbpCtx
    int rfffrfndfCount = 1;   // Usfd by LdbpCtx for difdk for sibring

    Connfdtion donn;  // Connfdtion to sfrvfr; ibs rfbdfr tirfbd
                      // usfd by LdbpCtx for StbrtTLS

    finbl privbtf PoolCbllbbdk pdb;
    finbl privbtf boolfbn poolfd;
    privbtf boolfbn butifntidbtfCbllfd = fblsf;

    ////////////////////////////////////////////////////////////////////////////
    //
    // donstrudtor: Crfbtf bn butifntidbtfd donnfdtion to sfrvfr
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpClifnt(String iost, int port, String sodkftFbdtory,
        int donnfdtTimfout, int rfbdTimfout, OutputStrfbm trbdf, PoolCbllbbdk pdb)
        tirows NbmingExdfption {

        if (dfbug > 0)
            Systfm.frr.println("LdbpClifnt: donstrudtor dbllfd " + iost + ":" + port );
        donn = nfw Connfdtion(tiis, iost, port, sodkftFbdtory, donnfdtTimfout, rfbdTimfout,
            trbdf);

        tiis.pdb = pdb;
        poolfd = (pdb != null);
    }

    syndironizfd boolfbn butifntidbtfCbllfd() {
        rfturn butifntidbtfCbllfd;
    }

    syndironizfd LdbpRfsult
    butifntidbtf(boolfbn initibl, String nbmf, Objfdt pw, int vfrsion,
        String butiMfdibnism, Control[] dtls,  Hbsitbblf<?,?> fnv)
        tirows NbmingExdfption {

        int rfbdTimfout = donn.rfbdTimfout;
        donn.rfbdTimfout = donn.donnfdtTimfout;
        LdbpRfsult rfs = null;

        try {
            butifntidbtfCbllfd = truf;

            try {
                fnsurfOpfn();
            } dbtdi (IOExdfption f) {
                NbmingExdfption nf = nfw CommunidbtionExdfption();
                nf.sftRootCbusf(f);
                tirow nf;
            }

            switdi (vfrsion) {
            dbsf LDAP_VERSION3_VERSION2:
            dbsf LDAP_VERSION3:
                isLdbpv3 = truf;
                brfbk;
            dbsf LDAP_VERSION2:
                isLdbpv3 = fblsf;
                brfbk;
            dffbult:
                tirow nfw CommunidbtionExdfption("Protodol vfrsion " + vfrsion +
                    " not supportfd");
            }

            if (butiMfdibnism.fqublsIgnorfCbsf("nonf") ||
                butiMfdibnism.fqublsIgnorfCbsf("bnonymous")) {

                // Pfrform LDAP bind if wf brf rfbutifntidbting, using LDAPv2,
                // supporting fbilovfr to LDAPv2, or dontrols ibvf bffn supplifd.
                if (!initibl ||
                    (vfrsion == LDAP_VERSION2) ||
                    (vfrsion == LDAP_VERSION3_VERSION2) ||
                    ((dtls != null) && (dtls.lfngti > 0))) {
                    try {
                        // bnonymous bind; updbtf nbmf/pw for LDAPv2 rftry
                        rfs = ldbpBind(nbmf=null, (bytf[])(pw=null), dtls, null,
                            fblsf);
                        if (rfs.stbtus == LdbpClifnt.LDAP_SUCCESS) {
                            donn.sftBound();
                        }
                    } dbtdi (IOExdfption f) {
                        NbmingExdfption nf =
                            nfw CommunidbtionExdfption("bnonymous bind fbilfd: " +
                            donn.iost + ":" + donn.port);
                        nf.sftRootCbusf(f);
                        tirow nf;
                    }
                } flsf {
                    // Skip LDAP bind for LDAPv3 bnonymous bind
                    rfs = nfw LdbpRfsult();
                    rfs.stbtus = LdbpClifnt.LDAP_SUCCESS;
                }
            } flsf if (butiMfdibnism.fqublsIgnorfCbsf("simplf")) {
                // simplf butifntidbtion
                bytf[] fndodfdPw = null;
                try {
                    fndodfdPw = fndodfPbssword(pw, isLdbpv3);
                    rfs = ldbpBind(nbmf, fndodfdPw, dtls, null, fblsf);
                    if (rfs.stbtus == LdbpClifnt.LDAP_SUCCESS) {
                        donn.sftBound();
                    }
                } dbtdi (IOExdfption f) {
                    NbmingExdfption nf =
                        nfw CommunidbtionExdfption("simplf bind fbilfd: " +
                            donn.iost + ":" + donn.port);
                    nf.sftRootCbusf(f);
                    tirow nf;
                } finblly {
                    // If pw wbs dopifd to b nfw brrby, dlfbr tibt brrby bs
                    // b sfdurity prfdbution.
                    if (fndodfdPw != pw && fndodfdPw != null) {
                        for (int i = 0; i < fndodfdPw.lfngti; i++) {
                            fndodfdPw[i] = 0;
                        }
                    }
                }
            } flsf if (isLdbpv3) {
                // SASL butifntidbtion
                try {
                    rfs = LdbpSbsl.sbslBind(tiis, donn, donn.iost, nbmf, pw,
                        butiMfdibnism, fnv, dtls);
                    if (rfs.stbtus == LdbpClifnt.LDAP_SUCCESS) {
                        donn.sftBound();
                    }
                } dbtdi (IOExdfption f) {
                    NbmingExdfption nf =
                        nfw CommunidbtionExdfption("SASL bind fbilfd: " +
                        donn.iost + ":" + donn.port);
                    nf.sftRootCbusf(f);
                    tirow nf;
                }
            } flsf {
                tirow nfw AutifntidbtionNotSupportfdExdfption(butiMfdibnism);
            }

            //
            // rf-try login using v2 if fbiling ovfr
            //
            if (initibl &&
                (rfs.stbtus == LdbpClifnt.LDAP_PROTOCOL_ERROR) &&
                (vfrsion == LdbpClifnt.LDAP_VERSION3_VERSION2) &&
                (butiMfdibnism.fqublsIgnorfCbsf("nonf") ||
                    butiMfdibnism.fqublsIgnorfCbsf("bnonymous") ||
                    butiMfdibnism.fqublsIgnorfCbsf("simplf"))) {

                bytf[] fndodfdPw = null;
                try {
                    isLdbpv3 = fblsf;
                    fndodfdPw = fndodfPbssword(pw, fblsf);
                    rfs = ldbpBind(nbmf, fndodfdPw, dtls, null, fblsf);
                    if (rfs.stbtus == LdbpClifnt.LDAP_SUCCESS) {
                        donn.sftBound();
                    }
                } dbtdi (IOExdfption f) {
                    NbmingExdfption nf =
                        nfw CommunidbtionExdfption(butiMfdibnism + ":" +
                            donn.iost +     ":" + donn.port);
                    nf.sftRootCbusf(f);
                    tirow nf;
                } finblly {
                    // If pw wbs dopifd to b nfw brrby, dlfbr tibt brrby bs
                    // b sfdurity prfdbution.
                    if (fndodfdPw != pw && fndodfdPw != null) {
                        for (int i = 0; i < fndodfdPw.lfngti; i++) {
                            fndodfdPw[i] = 0;
                        }
                    }
                }
            }

            // prindipbl nbmf not found
            // (mbp NbmfNotFoundExdfption to AutifntidbtionExdfption)
            // %%% Tiis is b workbround for Nftsdbpf sfrvfrs rfturning
            // %%% no sudi objfdt wifn tif prindipbl nbmf is not found
            // %%% Notf tibt wifn tiis workbround is bpplifd, it dofs not bllow
            // %%% rfsponsf dontrols to bf rfdordfd by tif dblling dontfxt
            if (rfs.stbtus == LdbpClifnt.LDAP_NO_SUCH_OBJECT) {
                tirow nfw AutifntidbtionExdfption(
                    gftErrorMfssbgf(rfs.stbtus, rfs.frrorMfssbgf));
            }
            donn.sftV3(isLdbpv3);
            rfturn rfs;
        } finblly {
            donn.rfbdTimfout = rfbdTimfout;
        }
    }

    /**
     * Sfnds bn LDAP Bind rfqufst.
     * Cbnnot bf privbtf; dbllfd by LdbpSbsl
     * @pbrbm dn Tif possibly null DN to usf in tif BIND rfqufst. null if bnonymous.
     * @pbrbm toSfrvfr Tif possibly null brrby of bytfs to sfnd to tif sfrvfr.
     * @pbrbm buti Tif butifntidbtion mfdibnism
     *
     */
    syndironizfd publid LdbpRfsult ldbpBind(String dn, bytf[]toSfrvfr,
        Control[] bindCtls, String buti, boolfbn pbusfAftfrRfdfipt)
        tirows jbvb.io.IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        // flusi outstbnding rfqufsts
        donn.bbbndonOutstbndingRfqs(null);

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();
        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        //
        // build tif bind rfqufst.
        //
        bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
            bfr.fndodfInt(durMsgId);
            bfr.bfginSfq(LdbpClifnt.LDAP_REQ_BIND);
                bfr.fndodfInt(isLdbpv3 ? LDAP_VERSION3 : LDAP_VERSION2);
                bfr.fndodfString(dn, isLdbpv3);

                // if butifntidbtion mfdibnism spfdififd, it is SASL
                if (buti != null) {
                    bfr.bfginSfq(Bfr.ASN_CONTEXT | Bfr.ASN_CONSTRUCTOR | 3);
                        bfr.fndodfString(buti, isLdbpv3);    // SASL mfdibnism
                        if (toSfrvfr != null) {
                            bfr.fndodfOdtftString(toSfrvfr,
                                Bfr.ASN_OCTET_STR);
                        }
                    bfr.fndSfq();
                } flsf {
                    if (toSfrvfr != null) {
                        bfr.fndodfOdtftString(toSfrvfr, Bfr.ASN_CONTEXT);
                    } flsf {
                        bfr.fndodfOdtftString(null, Bfr.ASN_CONTEXT, 0, 0);
                    }
                }
            bfr.fndSfq();

            // Endodf dontrols
            if (isLdbpv3) {
                fndodfControls(bfr, bindCtls);
            }
        bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId, pbusfAftfrRfdfipt);
        if (toSfrvfr != null) {
            bfr.rfsft();        // dlfbr intfrnblly-storfd pbssword
        }

        // Rfbd rfply
        BfrDfdodfr rbfr = donn.rfbdRfply(rfq);

        rbfr.pbrsfSfq(null);    // init sfq
        rbfr.pbrsfInt();        // msg id
        if (rbfr.pbrsfBytf() !=  LDAP_REP_BIND) {
            rfturn rfs;
        }

        rbfr.pbrsfLfngti();
        pbrsfRfsult(rbfr, rfs, isLdbpv3);

        // ibndlf sfrvfr's drfdfntibls (if prfsfnt)
        if (isLdbpv3 &&
            (rbfr.bytfsLfft() > 0) &&
            (rbfr.pffkBytf() == (Bfr.ASN_CONTEXT | 7))) {
            rfs.sfrvfrCrfds = rbfr.pbrsfOdtftString((Bfr.ASN_CONTEXT | 7), null);
        }

        rfs.rfsControls = isLdbpv3 ? pbrsfControls(rbfr) : null;

        donn.rfmovfRfqufst(rfq);
        rfturn rfs;
    }

    /**
     * Dftfrminfs wiftifr SASL fndryption/intfgrity is in progrfss.
     * Tiis difdk is mbdf prior to rfbutifntidbtion. You dbnnot rfbutifntidbtf
     * ovfr bn fndryptfd/intfgrity-protfdtfd SASL dibnnfl. You must
     * dlosf tif dibnnfl bnd opfn b nfw onf.
     */
    boolfbn usingSbslStrfbms() {
        rfturn (donn.inStrfbm instbndfof SbslInputStrfbm);
    }

    syndironizfd void indRffCount() {
        ++rfffrfndfCount;
        if (dfbug > 1) {
            Systfm.frr.println("LdbpClifnt.indRffCount: " + rfffrfndfCount + " " + tiis);
        }

    }

    /**
     * Rfturns tif fndodfd pbssword.
     */
    privbtf stbtid bytf[] fndodfPbssword(Objfdt pw, boolfbn v3) tirows IOExdfption {

        if (pw instbndfof dibr[]) {
            pw = nfw String((dibr[])pw);
        }

        if (pw instbndfof String) {
            if (v3) {
                rfturn ((String)pw).gftBytfs("UTF8");
            } flsf {
                rfturn ((String)pw).gftBytfs("8859_1");
            }
        } flsf {
            rfturn (bytf[])pw;
        }
    }

    syndironizfd void dlosf(Control[] rfqCtls, boolfbn ibrdClosf) {
        --rfffrfndfCount;

        if (dfbug > 1) {
            Systfm.frr.println("LdbpClifnt: " + tiis);
            Systfm.frr.println("LdbpClifnt: dlosf() dbllfd: " + rfffrfndfCount);
            (nfw Tirowbblf()).printStbdkTrbdf();
        }

        if (rfffrfndfCount <= 0 && donn != null) {
            if (dfbug > 0) Systfm.frr.println("LdbpClifnt: dlosfd donnfdtion " + tiis);
            if (!poolfd) {
                // Not bfing poolfd; dontinuf witi dlosing
                donn.dlfbnup(rfqCtls, fblsf);
                donn = null;
            } flsf {
                // Poolfd

                // Is tiis b rfbl dlosf or b rfqufst to rfturn donn to pool
                if (ibrdClosf) {
                    donn.dlfbnup(rfqCtls, fblsf);
                    donn = null;
                    pdb.rfmovfPoolfdConnfdtion(tiis);
                } flsf {
                    pdb.rflfbsfPoolfdConnfdtion(tiis);
                }
            }
        }
    }

    // NOTE: Siould NOT bf syndironizfd otifrwisf won't bf bblf to dlosf
    privbtf void fordfClosf(boolfbn dlfbnPool) {
        rfffrfndfCount = 0; // fordf dlosing of donnfdtion

        if (dfbug > 1) {
            Systfm.frr.println("LdbpClifnt: fordfClosf() of " + tiis);
        }

        if (donn != null) {
            if (dfbug > 0) Systfm.frr.println(
                "LdbpClifnt: fordfd dlosf of donnfdtion " + tiis);
            donn.dlfbnup(null, fblsf);
            donn = null;

            if (dlfbnPool) {
                pdb.rfmovfPoolfdConnfdtion(tiis);
            }
        }
    }

    protfdtfd void finblizf() {
        if (dfbug > 0) Systfm.frr.println("LdbpClifnt: finblizf " + tiis);
        fordfClosf(poolfd);
    }

    /*
     * Usfd by donnfdtion pooling to dlosf piysidbl donnfdtion.
     */
    syndironizfd publid void dlosfConnfdtion() {
        fordfClosf(fblsf); // tiis is b pool dbllbbdk so no nffd to dlfbn pool
    }

    /**
     * Cbllfd by Connfdtion.dlfbnup(). LdbpClifnt siould
     * notify bny unsoliditfd listfnfrs bnd rfmoving itsflf from bny pool.
     * Tiis is blmost likf fordfClosf(), fxdfpt it dofsn't dbll
     * Connfdtion.dlfbnup() (bfdbusf tiis is dbllfd from dlfbnup()).
     */
    void prodfssConnfdtionClosurf() {
        // Notify listfnfrs
        syndironizfd (unsoliditfd) {
            if (unsoliditfd.sizf() > 0) {
                String msg;
                if (donn != null) {
                    msg = donn.iost + ":" + donn.port + " donnfdtion dlosfd";
                } flsf {
                    msg = "Connfdtion dlosfd";
                }
                notifyUnsoliditfd(nfw CommunidbtionExdfption(msg));
            }
        }

        // Rfmovf from pool
        if (poolfd) {
            pdb.rfmovfPoolfdConnfdtion(tiis);
        }
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP sfbrdi. blso indludfs mftiods to fndodf rfd 1558 domplibnt filtfrs
    //
    ////////////////////////////////////////////////////////////////////////////

    stbtid finbl int SCOPE_BASE_OBJECT = 0;
    stbtid finbl int SCOPE_ONE_LEVEL = 1;
    stbtid finbl int SCOPE_SUBTREE = 2;

    LdbpRfsult sfbrdi(String dn, int sdopf, int dfrff, int sizfLimit,
                      int timfLimit, boolfbn bttrsOnly, String bttrs[],
                      String filtfr, int bbtdiSizf, Control[] rfqCtls,
                      Hbsitbblf<String, Boolfbn> binbryAttrs,
                      boolfbn wbitFirstRfply, int rfplyQufufCbpbdity)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.bfginSfq(LDAP_REQ_SEARCH);
                    bfr.fndodfString(dn == null ? "" : dn, isLdbpv3);
                    bfr.fndodfInt(sdopf, LBER_ENUMERATED);
                    bfr.fndodfInt(dfrff, LBER_ENUMERATED);
                    bfr.fndodfInt(sizfLimit);
                    bfr.fndodfInt(timfLimit);
                    bfr.fndodfBoolfbn(bttrsOnly);
                    Filtfr.fndodfFiltfrString(bfr, filtfr, isLdbpv3);
                    bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                        bfr.fndodfStringArrby(bttrs, isLdbpv3);
                    bfr.fndSfq();
                bfr.fndSfq();
                if (isLdbpv3) fndodfControls(bfr, rfqCtls);
            bfr.fndSfq();

         LdbpRfqufst rfq =
                donn.writfRfqufst(bfr, durMsgId, fblsf, rfplyQufufCbpbdity);

         rfs.msgId = durMsgId;
         rfs.stbtus = LdbpClifnt.LDAP_SUCCESS; //optimistid
         if (wbitFirstRfply) {
             // gft first rfply
             rfs = gftSfbrdiRfply(rfq, bbtdiSizf, rfs, binbryAttrs);
         }
         rfturn rfs;
    }

    /*
     * Abbndon tif sfbrdi opfrbtion bnd rfmovf it from tif mfssbgf qufuf.
     */
    void dlfbrSfbrdiRfply(LdbpRfsult rfs, Control[] dtls) {
        if (rfs != null && donn != null) {

            // Only sfnd bn LDAP bbbndon opfrbtion wifn dlfbring tif sfbrdi
            // rfply from b onf-lfvfl or subtrff sfbrdi.
            LdbpRfqufst rfq = donn.findRfqufst(rfs.msgId);
            if (rfq == null) {
                rfturn;
            }

            // OK if rfq got rfmovfd bftfr difdk; doublf rfmovbl bttfmpt
            // but otifrwisf no ibrm donf

            // Sfnd bn LDAP bbbndon only if tif sfbrdi opfrbtion ibs not yft
            // domplftfd.
            if (rfq.ibsSfbrdiComplftfd()) {
                donn.rfmovfRfqufst(rfq);
            } flsf {
                donn.bbbndonRfqufst(rfq, dtls);
            }
        }
    }

    /*
     * Rftrifvf tif nfxt bbtdi of fntrifs bnd/or rfffrrbls.
     */
    LdbpRfsult gftSfbrdiRfply(int bbtdiSizf, LdbpRfsult rfs,
        Hbsitbblf<String, Boolfbn> binbryAttrs) tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfqufst rfq;

        if ((rfq = donn.findRfqufst(rfs.msgId)) == null) {
            rfturn null;
        }

        rfturn gftSfbrdiRfply(rfq, bbtdiSizf, rfs, binbryAttrs);
    }

    privbtf LdbpRfsult gftSfbrdiRfply(LdbpRfqufst rfq,
        int bbtdiSizf, LdbpRfsult rfs, Hbsitbblf<String, Boolfbn> binbryAttrs)
        tirows IOExdfption, NbmingExdfption {

        if (bbtdiSizf == 0)
            bbtdiSizf = Intfgfr.MAX_VALUE;

        if (rfs.fntrifs != null) {
            rfs.fntrifs.sftSizf(0); // dlfbr tif (prfvious) sft of fntrifs
        } flsf {
            rfs.fntrifs =
                nfw Vfdtor<>(bbtdiSizf == Intfgfr.MAX_VALUE ? 32 : bbtdiSizf);
        }

        if (rfs.rfffrrbls != null) {
            rfs.rfffrrbls.sftSizf(0); // dlfbr tif (prfvious) sft of rfffrrbls
        }

        BfrDfdodfr rfplyBfr;    // Dfdodfr for rfsponsf
        int sfq;                // Rfqufst id

        Attributfs lbttrs;      // Attributf sft rfbd from rfsponsf
        Attributf lb;           // Attributf rfbd from rfsponsf
        String DN;              // DN rfbd from rfsponsf
        LdbpEntry lf;           // LDAP fntry rfprfsfnting rfsponsf
        int[] sfqlfn;           // Holdfr for rfsponsf lfngti
        int fndsfq;             // Position of fnd of rfsponsf

        for (int i = 0; i < bbtdiSizf;) {
            rfplyBfr = donn.rfbdRfply(rfq);

            //
            // prodfss sfbrdi rfply
            //
            rfplyBfr.pbrsfSfq(null);                    // init sfq
            rfplyBfr.pbrsfInt();                        // rfq id
            sfq = rfplyBfr.pbrsfSfq(null);

            if (sfq == LDAP_REP_SEARCH) {

                // ibndlf LDAPv3 sfbrdi fntrifs
                lbttrs = nfw BbsidAttributfs(dbsfIgnorf);
                DN = rfplyBfr.pbrsfString(isLdbpv3);
                lf = nfw LdbpEntry(DN, lbttrs);
                sfqlfn = nfw int[1];

                rfplyBfr.pbrsfSfq(sfqlfn);
                fndsfq = rfplyBfr.gftPbrsfPosition() + sfqlfn[0];
                wiilf ((rfplyBfr.gftPbrsfPosition() < fndsfq) &&
                    (rfplyBfr.bytfsLfft() > 0)) {
                    lb = pbrsfAttributf(rfplyBfr, binbryAttrs);
                    lbttrs.put(lb);
                }
                lf.rfspCtls = isLdbpv3 ? pbrsfControls(rfplyBfr) : null;

                rfs.fntrifs.bddElfmfnt(lf);
                i++;

            } flsf if ((sfq == LDAP_REP_SEARCH_REF) && isLdbpv3) {

                // ibndlf LDAPv3 sfbrdi rfffrfndf
                Vfdtor<String> URLs = nfw Vfdtor<>(4);

                // %%% Altiougi not stridtly dorrfdt, somf LDAP sfrvfrs
                //     fndodf tif SEQUENCE OF tbg in tif SfbrdiRfsultRff
                if (rfplyBfr.pffkBytf() ==
                    (Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR)) {
                    rfplyBfr.pbrsfSfq(null);
                }

                wiilf ((rfplyBfr.bytfsLfft() > 0) &&
                    (rfplyBfr.pffkBytf() == Bfr.ASN_OCTET_STR)) {

                    URLs.bddElfmfnt(rfplyBfr.pbrsfString(isLdbpv3));
                }

                if (rfs.rfffrrbls == null) {
                    rfs.rfffrrbls = nfw Vfdtor<>(4);
                }
                rfs.rfffrrbls.bddElfmfnt(URLs);
                rfs.rfsControls = isLdbpv3 ? pbrsfControls(rfplyBfr) : null;

                // Sbvf rfffrrbl bnd dontinuf to gft nfxt sfbrdi rfsult

            } flsf if (sfq == LDAP_REP_EXTENSION) {

                pbrsfExtRfsponsf(rfplyBfr, rfs); //%%% ignorf for now

            } flsf if (sfq == LDAP_REP_RESULT) {

                pbrsfRfsult(rfplyBfr, rfs, isLdbpv3);
                rfs.rfsControls = isLdbpv3 ? pbrsfControls(rfplyBfr) : null;

                donn.rfmovfRfqufst(rfq);
                rfturn rfs;     // Donf witi sfbrdi
            }
        }

        rfturn rfs;
    }

    privbtf Attributf pbrsfAttributf(BfrDfdodfr bfr,
                                     Hbsitbblf<String, Boolfbn> binbryAttrs)
        tirows IOExdfption {

        int lfn[] = nfw int[1];
        int sfq = bfr.pbrsfSfq(null);
        String bttrid = bfr.pbrsfString(isLdbpv3);
        boolfbn ibsBinbryVblufs = isBinbryVblufd(bttrid, binbryAttrs);
        Attributf lb = nfw LdbpAttributf(bttrid);

        if ((sfq = bfr.pbrsfSfq(lfn)) == LBER_SET) {
            int bttrlfn = lfn[0];
            wiilf (bfr.bytfsLfft() > 0 && bttrlfn > 0) {
                try {
                    bttrlfn -= pbrsfAttributfVbluf(bfr, lb, ibsBinbryVblufs);
                } dbtdi (IOExdfption fx) {
                    bfr.sffk(bttrlfn);
                    brfbk;
                }
            }
        } flsf {
            // Skip tif rfst of tif sfqufndf bfdbusf it is not wibt wf wbnt
            bfr.sffk(lfn[0]);
        }
        rfturn lb;
    }

    //
    // rfturns numbfr of bytfs tibt wfrf pbrsfd. Adds tif vblufs to bttr
    //
    privbtf int pbrsfAttributfVbluf(BfrDfdodfr bfr, Attributf lb,
        boolfbn ibsBinbryVblufs) tirows IOExdfption {

        int lfn[] = nfw int[1];

        if (ibsBinbryVblufs) {
            lb.bdd(bfr.pbrsfOdtftString(bfr.pffkBytf(), lfn));
        } flsf {
            lb.bdd(bfr.pbrsfStringWitiTbg(
                                    Bfr.ASN_SIMPLE_STRING, isLdbpv3, lfn));
        }
        rfturn lfn[0];
    }

    privbtf boolfbn isBinbryVblufd(String bttrid,
                                   Hbsitbblf<String, Boolfbn> binbryAttrs) {
        String id = bttrid.toLowfrCbsf(Lodblf.ENGLISH);

        rfturn ((id.indfxOf(";binbry") != -1) ||
            dffbultBinbryAttrs.dontbinsKfy(id) ||
            ((binbryAttrs != null) && (binbryAttrs.dontbinsKfy(id))));
    }

    // pbdkbgf fntry point; usfd by Connfdtion
    stbtid void pbrsfRfsult(BfrDfdodfr rfplyBfr, LdbpRfsult rfs,
            boolfbn isLdbpv3) tirows IOExdfption {

        rfs.stbtus = rfplyBfr.pbrsfEnumfrbtion();
        rfs.mbtdifdDN = rfplyBfr.pbrsfString(isLdbpv3);
        rfs.frrorMfssbgf = rfplyBfr.pbrsfString(isLdbpv3);

        // ibndlf LDAPv3 rfffrrbls (if prfsfnt)
        if (isLdbpv3 &&
            (rfplyBfr.bytfsLfft() > 0) &&
            (rfplyBfr.pffkBytf() == LDAP_REP_REFERRAL)) {

            Vfdtor<String> URLs = nfw Vfdtor<>(4);
            int[] sfqlfn = nfw int[1];

            rfplyBfr.pbrsfSfq(sfqlfn);
            int fndsfq = rfplyBfr.gftPbrsfPosition() + sfqlfn[0];
            wiilf ((rfplyBfr.gftPbrsfPosition() < fndsfq) &&
                (rfplyBfr.bytfsLfft() > 0)) {

                URLs.bddElfmfnt(rfplyBfr.pbrsfString(isLdbpv3));
            }

            if (rfs.rfffrrbls == null) {
                rfs.rfffrrbls = nfw Vfdtor<>(4);
            }
            rfs.rfffrrbls.bddElfmfnt(URLs);
        }
    }

    // pbdkbgf fntry point; usfd by Connfdtion
    stbtid Vfdtor<Control> pbrsfControls(BfrDfdodfr rfplyBfr) tirows IOExdfption {

        // ibndlf LDAPv3 dontrols (if prfsfnt)
        if ((rfplyBfr.bytfsLfft() > 0) && (rfplyBfr.pffkBytf() == LDAP_CONTROLS)) {
            Vfdtor<Control> dtls = nfw Vfdtor<>(4);
            String dontrolOID;
            boolfbn dritidblity = fblsf; // dffbult
            bytf[] dontrolVbluf = null;  // optionbl
            int[] sfqlfn = nfw int[1];

            rfplyBfr.pbrsfSfq(sfqlfn);
            int fndsfq = rfplyBfr.gftPbrsfPosition() + sfqlfn[0];
            wiilf ((rfplyBfr.gftPbrsfPosition() < fndsfq) &&
                (rfplyBfr.bytfsLfft() > 0)) {

                rfplyBfr.pbrsfSfq(null);
                dontrolOID = rfplyBfr.pbrsfString(truf);

                if ((rfplyBfr.bytfsLfft() > 0) &&
                    (rfplyBfr.pffkBytf() == Bfr.ASN_BOOLEAN)) {
                    dritidblity = rfplyBfr.pbrsfBoolfbn();
                }
                if ((rfplyBfr.bytfsLfft() > 0) &&
                    (rfplyBfr.pffkBytf() == Bfr.ASN_OCTET_STR)) {
                    dontrolVbluf =
                        rfplyBfr.pbrsfOdtftString(Bfr.ASN_OCTET_STR, null);
                }
                if (dontrolOID != null) {
                    dtls.bddElfmfnt(
                        nfw BbsidControl(dontrolOID, dritidblity, dontrolVbluf));
                }
            }
            rfturn dtls;
        } flsf {
            rfturn null;
        }
    }

    privbtf void pbrsfExtRfsponsf(BfrDfdodfr rfplyBfr, LdbpRfsult rfs)
        tirows IOExdfption {

        pbrsfRfsult(rfplyBfr, rfs, isLdbpv3);

        if ((rfplyBfr.bytfsLfft() > 0) &&
            (rfplyBfr.pffkBytf() == LDAP_REP_EXT_OID)) {
            rfs.fxtfnsionId =
                rfplyBfr.pbrsfStringWitiTbg(LDAP_REP_EXT_OID, isLdbpv3, null);
        }
        if ((rfplyBfr.bytfsLfft() > 0) &&
            (rfplyBfr.pffkBytf() == LDAP_REP_EXT_VAL)) {
            rfs.fxtfnsionVbluf =
                rfplyBfr.pbrsfOdtftString(LDAP_REP_EXT_VAL, null);
        }

        rfs.rfsControls = pbrsfControls(rfplyBfr);
    }

    //
    // Endodf LDAPv3 dontrols
    //
    stbtid void fndodfControls(BfrEndodfr bfr, Control[] rfqCtls)
        tirows IOExdfption {

        if ((rfqCtls == null) || (rfqCtls.lfngti == 0)) {
            rfturn;
        }

        bytf[] dontrolVbl;

        bfr.bfginSfq(LdbpClifnt.LDAP_CONTROLS);

            for (int i = 0; i < rfqCtls.lfngti; i++) {
                bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                    bfr.fndodfString(rfqCtls[i].gftID(), truf); // dontrol OID
                    if (rfqCtls[i].isCritidbl()) {
                        bfr.fndodfBoolfbn(truf); // dritidbl dontrol
                    }
                    if ((dontrolVbl = rfqCtls[i].gftEndodfdVbluf()) != null) {
                        bfr.fndodfOdtftString(dontrolVbl, Bfr.ASN_OCTET_STR);
                    }
                bfr.fndSfq();
            }
        bfr.fndSfq();
    }

    /**
     * Rfbds tif nfxt rfply dorrfsponding to msgId, outstbnding on rfqufstBfr.
     * Prodfssfs tif rfsult bnd bny dontrols.
     */
    privbtf LdbpRfsult prodfssRfply(LdbpRfqufst rfq,
        LdbpRfsult rfs, int rfsponsfTypf) tirows IOExdfption, NbmingExdfption {

        BfrDfdodfr rbfr = donn.rfbdRfply(rfq);

        rbfr.pbrsfSfq(null);    // init sfq
        rbfr.pbrsfInt();        // msg id
        if (rbfr.pbrsfBytf() !=  rfsponsfTypf) {
            rfturn rfs;
        }

        rbfr.pbrsfLfngti();
        pbrsfRfsult(rbfr, rfs, isLdbpv3);
        rfs.rfsControls = isLdbpv3 ? pbrsfControls(rbfr) : null;

        donn.rfmovfRfqufst(rfq);

        rfturn rfs;     // Donf witi opfrbtion
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP modify:
    //  Modify tif DN dn witi tif opfrbtions on bttributfs bttrs.
    //  if, opfrbtions[0] is tif opfrbtion to bf pfrformfd on
    //  bttrs[0];
    //          dn - DN to modify
    //          opfrbtions - bdd, dflftf or rfplbdf
    //          bttrs - brrby of Attributf
    //          rfqCtls - brrby of rfqufst dontrols
    //
    ////////////////////////////////////////////////////////////////////////////

    stbtid finbl int ADD = 0;
    stbtid finbl int DELETE = 1;
    stbtid finbl int REPLACE = 2;

    LdbpRfsult modify(String dn, int opfrbtions[], Attributf bttrs[],
                      Control[] rfqCtls)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (dn == null || opfrbtions.lfngti != bttrs.lfngti)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

        bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
            bfr.fndodfInt(durMsgId);
            bfr.bfginSfq(LDAP_REQ_MODIFY);
                bfr.fndodfString(dn, isLdbpv3);
                bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                    for (int i = 0; i < opfrbtions.lfngti; i++) {
                        bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                            bfr.fndodfInt(opfrbtions[i], LBER_ENUMERATED);

                            // zfro vblufs is not pfrmittfd for tif bdd op.
                            if ((opfrbtions[i] == ADD) && ibsNoVbluf(bttrs[i])) {
                                tirow nfw InvblidAttributfVblufExdfption(
                                    "'" + bttrs[i].gftID() + "' ibs no vblufs.");
                            } flsf {
                                fndodfAttributf(bfr, bttrs[i]);
                            }
                        bfr.fndSfq();
                    }
                bfr.fndSfq();
            bfr.fndSfq();
            if (isLdbpv3) fndodfControls(bfr, rfqCtls);
        bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId);

        rfturn prodfssRfply(rfq, rfs, LDAP_REP_MODIFY);
    }

    privbtf void fndodfAttributf(BfrEndodfr bfr, Attributf bttr)
        tirows IOExdfption, NbmingExdfption {

        bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
            bfr.fndodfString(bttr.gftID(), isLdbpv3);
            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR | 1);
                NbmingEnumfrbtion<?> fnum_ = bttr.gftAll();
                Objfdt vbl;
                wiilf (fnum_.ibsMorf()) {
                    vbl = fnum_.nfxt();
                    if (vbl instbndfof String) {
                        bfr.fndodfString((String)vbl, isLdbpv3);
                    } flsf if (vbl instbndfof bytf[]) {
                        bfr.fndodfOdtftString((bytf[])vbl, Bfr.ASN_OCTET_STR);
                    } flsf if (vbl == null) {
                        // no bttributf vbluf
                    } flsf {
                        tirow nfw InvblidAttributfVblufExdfption(
                            "Mblformfd '" + bttr.gftID() + "' bttributf vbluf");
                    }
                }
            bfr.fndSfq();
        bfr.fndSfq();
    }

    privbtf stbtid boolfbn ibsNoVbluf(Attributf bttr) tirows NbmingExdfption {
        rfturn bttr.sizf() == 0 || (bttr.sizf() == 1 && bttr.gft() == null);
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP bdd
    //          Adds fntry to tif Dirfdtory
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpRfsult bdd(LdbpEntry fntry, Control[] rfqCtls)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (fntry == null || fntry.DN == null)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();
        Attributf bttr;

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.bfginSfq(LDAP_REQ_ADD);
                    bfr.fndodfString(fntry.DN, isLdbpv3);
                    bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                        NbmingEnumfrbtion<? fxtfnds Attributf> fnum_ =
                                fntry.bttributfs.gftAll();
                        wiilf (fnum_.ibsMorf()) {
                            bttr = fnum_.nfxt();

                            // zfro vblufs is not pfrmittfd
                            if (ibsNoVbluf(bttr)) {
                                tirow nfw InvblidAttributfVblufExdfption(
                                    "'" + bttr.gftID() + "' ibs no vblufs.");
                            } flsf {
                                fndodfAttributf(bfr, bttr);
                            }
                        }
                    bfr.fndSfq();
                bfr.fndSfq();
                if (isLdbpv3) fndodfControls(bfr, rfqCtls);
            bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId);
        rfturn prodfssRfply(rfq, rfs, LDAP_REP_ADD);
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP dflftf
    //          dflftfs fntry from tif Dirfdtory
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpRfsult dflftf(String DN, Control[] rfqCtls)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (DN == null)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.fndodfString(DN, LDAP_REQ_DELETE, isLdbpv3);
                if (isLdbpv3) fndodfControls(bfr, rfqCtls);
            bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId);

        rfturn prodfssRfply(rfq, rfs, LDAP_REP_DELETE);
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP modrdn
    //  Cibngfs tif lbst flfmfnt of DN to nfwrdn
    //          dn - DN to dibngf
    //          nfwrdn - nfw RDN to rfnbmf to
    //          dflftfoldrdn - boolfbn wiftifr to dflftf old bttrs or not
    //          nfwSupfrior - nfw plbdf to put tif fntry in tif trff
    //                        (ignorfd if sfrvfr is LDAPv2)
    //          rfqCtls - brrby of rfqufst dontrols
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpRfsult moddn(String DN, String nfwrdn, boolfbn dflftfOldRdn,
                     String nfwSupfrior, Control[] rfqCtls)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        boolfbn dibngfSupfrior = (nfwSupfrior != null &&
                                  nfwSupfrior.lfngti() > 0);

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (DN == null || nfwrdn == null)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.bfginSfq(LDAP_REQ_MODRDN);
                    bfr.fndodfString(DN, isLdbpv3);
                    bfr.fndodfString(nfwrdn, isLdbpv3);
                    bfr.fndodfBoolfbn(dflftfOldRdn);
                    if(isLdbpv3 && dibngfSupfrior) {
                        //Systfm.frr.println("dibngin supfrior");
                        bfr.fndodfString(nfwSupfrior, LDAP_SUPERIOR_DN, isLdbpv3);
                    }
                bfr.fndSfq();
                if (isLdbpv3) fndodfControls(bfr, rfqCtls);
            bfr.fndSfq();


        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId);

        rfturn prodfssRfply(rfq, rfs, LDAP_REP_MODRDN);
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP dompbrf
    //  Compbrf bttributf->vbluf pbirs in dn
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpRfsult dompbrf(String DN, String typf, String vbluf, Control[] rfqCtls)
        tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (DN == null || typf == null || vbluf == null)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.bfginSfq(LDAP_REQ_COMPARE);
                    bfr.fndodfString(DN, isLdbpv3);
                    bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                        bfr.fndodfString(typf, isLdbpv3);

                        // rfplbdf bny fsdbpfd dibrbdtfrs in tif vbluf
                        bytf[] vbl = isLdbpv3 ?
                            vbluf.gftBytfs("UTF8") : vbluf.gftBytfs("8859_1");
                        bfr.fndodfOdtftString(
                            Filtfr.unfsdbpfFiltfrVbluf(vbl, 0, vbl.lfngti),
                            Bfr.ASN_OCTET_STR);

                    bfr.fndSfq();
                bfr.fndSfq();
                if (isLdbpv3) fndodfControls(bfr, rfqCtls);
            bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId);

        rfturn prodfssRfply(rfq, rfs, LDAP_REP_COMPARE);
    }

    ////////////////////////////////////////////////////////////////////////////
    //
    // LDAP fxtfndfd opfrbtion
    //
    ////////////////////////////////////////////////////////////////////////////

    LdbpRfsult fxtfndfdOp(String id, bytf[] rfqufst, Control[] rfqCtls,
        boolfbn pbusfAftfrRfdfipt) tirows IOExdfption, NbmingExdfption {

        fnsurfOpfn();

        LdbpRfsult rfs = nfw LdbpRfsult();
        rfs.stbtus = LDAP_OPERATIONS_ERROR;

        if (id == null)
            rfturn rfs;

        BfrEndodfr bfr = nfw BfrEndodfr();
        int durMsgId = donn.gftMsgId();

            bfr.bfginSfq(Bfr.ASN_SEQUENCE | Bfr.ASN_CONSTRUCTOR);
                bfr.fndodfInt(durMsgId);
                bfr.bfginSfq(LDAP_REQ_EXTENSION);
                    bfr.fndodfString(id,
                        Bfr.ASN_CONTEXT | 0, isLdbpv3);//[0]
                    if (rfqufst != null) {
                        bfr.fndodfOdtftString(rfqufst,
                            Bfr.ASN_CONTEXT | 1);//[1]
                    }
                bfr.fndSfq();
                fndodfControls(bfr, rfqCtls); // blwbys v3
            bfr.fndSfq();

        LdbpRfqufst rfq = donn.writfRfqufst(bfr, durMsgId, pbusfAftfrRfdfipt);

        BfrDfdodfr rbfr = donn.rfbdRfply(rfq);

        rbfr.pbrsfSfq(null);    // init sfq
        rbfr.pbrsfInt();        // msg id
        if (rbfr.pbrsfBytf() !=  LDAP_REP_EXTENSION) {
            rfturn rfs;
        }

        rbfr.pbrsfLfngti();
        pbrsfExtRfsponsf(rbfr, rfs);
        donn.rfmovfRfqufst(rfq);

        rfturn rfs;     // Donf witi opfrbtion
    }



    ////////////////////////////////////////////////////////////////////////////
    //
    // Somf BER dffinitions donvfnifnt for LDAP
    //
    ////////////////////////////////////////////////////////////////////////////

    stbtid finbl int LDAP_VERSION3_VERSION2 = 32;
    stbtid finbl int LDAP_VERSION2 = 0x02;
    stbtid finbl int LDAP_VERSION3 = 0x03;              // LDAPv3
    stbtid finbl int LDAP_VERSION = LDAP_VERSION3;

    stbtid finbl int LDAP_REF_FOLLOW = 0x01;            // follow rfffrrbls
    stbtid finbl int LDAP_REF_THROW = 0x02;             // tirow rfffrrbl fx.
    stbtid finbl int LDAP_REF_IGNORE = 0x03;            // ignorf rfffrrbls

    stbtid finbl String LDAP_URL = "ldbp://";           // LDAPv3
    stbtid finbl String LDAPS_URL = "ldbps://";         // LDAPv3

    stbtid finbl int LBER_BOOLEAN = 0x01;
    stbtid finbl int LBER_INTEGER = 0x02;
    stbtid finbl int LBER_BITSTRING = 0x03;
    stbtid finbl int LBER_OCTETSTRING = 0x04;
    stbtid finbl int LBER_NULL = 0x05;
    stbtid finbl int LBER_ENUMERATED = 0x0b;
    stbtid finbl int LBER_SEQUENCE = 0x30;
    stbtid finbl int LBER_SET = 0x31;

    stbtid finbl int LDAP_SUPERIOR_DN = 0x80;

    stbtid finbl int LDAP_REQ_BIND = 0x60;      // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_UNBIND = 0x42;    // bpp + primitivf
    stbtid finbl int LDAP_REQ_SEARCH = 0x63;    // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_MODIFY = 0x66;    // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_ADD = 0x68;       // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_DELETE = 0x4b;    // bpp + primitivf
    stbtid finbl int LDAP_REQ_MODRDN = 0x6d;    // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_COMPARE = 0x6f;   // bpp + donstrudtfd
    stbtid finbl int LDAP_REQ_ABANDON = 0x50;   // bpp + primitivf
    stbtid finbl int LDAP_REQ_EXTENSION = 0x77; // bpp + donstrudtfd    (LDAPv3)

    stbtid finbl int LDAP_REP_BIND = 0x61;      // bpp + donstrudtfd | 1
    stbtid finbl int LDAP_REP_SEARCH = 0x64;    // bpp + donstrudtfd | 4
    stbtid finbl int LDAP_REP_SEARCH_REF = 0x73;// bpp + donstrudtfd    (LDAPv3)
    stbtid finbl int LDAP_REP_RESULT = 0x65;    // bpp + donstrudtfd | 5
    stbtid finbl int LDAP_REP_MODIFY = 0x67;    // bpp + donstrudtfd | 7
    stbtid finbl int LDAP_REP_ADD = 0x69;       // bpp + donstrudtfd | 9
    stbtid finbl int LDAP_REP_DELETE = 0x6b;    // bpp + primitivf | b
    stbtid finbl int LDAP_REP_MODRDN = 0x6d;    // bpp + primitivf | d
    stbtid finbl int LDAP_REP_COMPARE = 0x6f;   // bpp + primitivf | f
    stbtid finbl int LDAP_REP_EXTENSION = 0x78; // bpp + donstrudtfd    (LDAPv3)

    stbtid finbl int LDAP_REP_REFERRAL = 0xb3;  // dtx + donstrudtfd    (LDAPv3)
    stbtid finbl int LDAP_REP_EXT_OID = 0x8b;   // dtx + primitivf      (LDAPv3)
    stbtid finbl int LDAP_REP_EXT_VAL = 0x8b;   // dtx + primitivf      (LDAPv3)

    // LDAPv3 Controls

    stbtid finbl int LDAP_CONTROLS = 0xb0;      // dtx + donstrudtfd    (LDAPv3)
    stbtid finbl String LDAP_CONTROL_MANAGE_DSA_IT = "2.16.840.1.113730.3.4.2";
    stbtid finbl String LDAP_CONTROL_PREFERRED_LANG = "1.3.6.1.4.1.1466.20035";
    stbtid finbl String LDAP_CONTROL_PAGED_RESULTS = "1.2.840.113556.1.4.319";
    stbtid finbl String LDAP_CONTROL_SERVER_SORT_REQ = "1.2.840.113556.1.4.473";
    stbtid finbl String LDAP_CONTROL_SERVER_SORT_RES = "1.2.840.113556.1.4.474";

    ////////////////////////////////////////////////////////////////////////////
    //
    // rfturn dodfs
    //
    ////////////////////////////////////////////////////////////////////////////

    stbtid finbl int LDAP_SUCCESS = 0;
    stbtid finbl int LDAP_OPERATIONS_ERROR = 1;
    stbtid finbl int LDAP_PROTOCOL_ERROR = 2;
    stbtid finbl int LDAP_TIME_LIMIT_EXCEEDED = 3;
    stbtid finbl int LDAP_SIZE_LIMIT_EXCEEDED = 4;
    stbtid finbl int LDAP_COMPARE_FALSE = 5;
    stbtid finbl int LDAP_COMPARE_TRUE = 6;
    stbtid finbl int LDAP_AUTH_METHOD_NOT_SUPPORTED = 7;
    stbtid finbl int LDAP_STRONG_AUTH_REQUIRED = 8;
    stbtid finbl int LDAP_PARTIAL_RESULTS = 9;                  // Slbpd
    stbtid finbl int LDAP_REFERRAL = 10;                        // LDAPv3
    stbtid finbl int LDAP_ADMIN_LIMIT_EXCEEDED = 11;            // LDAPv3
    stbtid finbl int LDAP_UNAVAILABLE_CRITICAL_EXTENSION = 12;  // LDAPv3
    stbtid finbl int LDAP_CONFIDENTIALITY_REQUIRED = 13;        // LDAPv3
    stbtid finbl int LDAP_SASL_BIND_IN_PROGRESS = 14;           // LDAPv3
    stbtid finbl int LDAP_NO_SUCH_ATTRIBUTE = 16;
    stbtid finbl int LDAP_UNDEFINED_ATTRIBUTE_TYPE = 17;
    stbtid finbl int LDAP_INAPPROPRIATE_MATCHING = 18;
    stbtid finbl int LDAP_CONSTRAINT_VIOLATION = 19;
    stbtid finbl int LDAP_ATTRIBUTE_OR_VALUE_EXISTS = 20;
    stbtid finbl int LDAP_INVALID_ATTRIBUTE_SYNTAX = 21;
    stbtid finbl int LDAP_NO_SUCH_OBJECT = 32;
    stbtid finbl int LDAP_ALIAS_PROBLEM = 33;
    stbtid finbl int LDAP_INVALID_DN_SYNTAX = 34;
    stbtid finbl int LDAP_IS_LEAF = 35;
    stbtid finbl int LDAP_ALIAS_DEREFERENCING_PROBLEM = 36;
    stbtid finbl int LDAP_INAPPROPRIATE_AUTHENTICATION = 48;
    stbtid finbl int LDAP_INVALID_CREDENTIALS = 49;
    stbtid finbl int LDAP_INSUFFICIENT_ACCESS_RIGHTS = 50;
    stbtid finbl int LDAP_BUSY = 51;
    stbtid finbl int LDAP_UNAVAILABLE = 52;
    stbtid finbl int LDAP_UNWILLING_TO_PERFORM = 53;
    stbtid finbl int LDAP_LOOP_DETECT = 54;
    stbtid finbl int LDAP_NAMING_VIOLATION = 64;
    stbtid finbl int LDAP_OBJECT_CLASS_VIOLATION = 65;
    stbtid finbl int LDAP_NOT_ALLOWED_ON_NON_LEAF = 66;
    stbtid finbl int LDAP_NOT_ALLOWED_ON_RDN = 67;
    stbtid finbl int LDAP_ENTRY_ALREADY_EXISTS = 68;
    stbtid finbl int LDAP_OBJECT_CLASS_MODS_PROHIBITED = 69;
    stbtid finbl int LDAP_AFFECTS_MULTIPLE_DSAS = 71;           // LDAPv3
    stbtid finbl int LDAP_OTHER = 80;

    stbtid finbl String[] ldbp_frror_mfssbgf = {
        "Suddfss",                                      // 0
        "Opfrbtions Error",                             // 1
        "Protodol Error",                               // 2
        "Timflimit Exdffdfd",                           // 3
        "Sizflimit Exdffdfd",                           // 4
        "Compbrf Fblsf",                                // 5
        "Compbrf Truf",                                 // 6
        "Autifntidbtion Mftiod Not Supportfd",          // 7
        "Strong Autifntidbtion Rfquirfd",               // 8
        null,
        "Rfffrrbl",                                     // 10
        "Administrbtivf Limit Exdffdfd",                // 11
        "Unbvbilbblf Critidbl Extfnsion",               // 12
        "Confidfntiblity Rfquirfd",                     // 13
        "SASL Bind In Progrfss",                        // 14
        null,
        "No Sudi Attributf",                            // 16
        "Undffinfd Attributf Typf",                     // 17
        "Inbppropribtf Mbtdiing",                       // 18
        "Constrbint Violbtion",                         // 19
        "Attributf Or Vbluf Exists",                    // 20
        "Invblid Attributf Syntbx",                     // 21
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        "No Sudi Objfdt",                               // 32
        "Alibs Problfm",                                // 33
        "Invblid DN Syntbx",                            // 34
        null,
        "Alibs Dfrfffrfnding Problfm",                  // 36
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        "Inbppropribtf Autifntidbtion",                 // 48
        "Invblid Crfdfntibls",                          // 49
        "Insuffidifnt Addfss Rigits",                   // 50
        "Busy",                                         // 51
        "Unbvbilbblf",                                  // 52
        "Unwilling To Pfrform",                         // 53
        "Loop Dftfdt",                                  // 54
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        "Nbming Violbtion",                             // 64
        "Objfdt Clbss Violbtion",                       // 65
        "Not Allowfd On Non-lfbf",                      // 66
        "Not Allowfd On RDN",                           // 67
        "Entry Alrfbdy Exists",                         // 68
        "Objfdt Clbss Modifidbtions Proiibitfd",        // 69
        null,
        "Afffdts Multiplf DSAs",                        // 71
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        "Otifr",                                        // 80
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null,
        null
    };


    /*
     * Gfnfrbtf bn frror mfssbgf from tif LDAP frror dodf bnd frror dibgnostid.
     * Tif mfssbgf formbt is:
     *
     *     "[LDAP: frror dodf <frrorCodf> - <frrorMfssbgf>]"
     *
     * wifrf <frrorCodf> is b numfrid frror dodf
     * bnd <frrorMfssbgf> is b tfxtubl dfsdription of tif frror (if bvbilbblf)
     *
     */
    stbtid String gftErrorMfssbgf(int frrorCodf, String frrorMfssbgf) {

        String mfssbgf = "[LDAP: frror dodf " + frrorCodf;

        if ((frrorMfssbgf != null) && (frrorMfssbgf.lfngti() != 0)) {

            // bppfnd frror mfssbgf from tif sfrvfr
            mfssbgf = mfssbgf + " - " + frrorMfssbgf + "]";

        } flsf {

            // bppfnd built-in frror mfssbgf
            try {
                if (ldbp_frror_mfssbgf[frrorCodf] != null) {
                    mfssbgf = mfssbgf + " - " + ldbp_frror_mfssbgf[frrorCodf] +
                                "]";
                }
            } dbtdi (ArrbyIndfxOutOfBoundsExdfption fx) {
                mfssbgf = mfssbgf + "]";
            }
        }
        rfturn mfssbgf;
    }


    ////////////////////////////////////////////////////////////////////////////
    //
    // Unsoliditfd notifidbtion support.
    //
    // An LdbpClifnt mbintbins b list of LdbpCtx tibt ibvf rfgistfrfd
    // for UnsoliditfdNotifidbtions. Tiis is b list bfdbusf b singlf
    // LdbpClifnt migit bf sibrfd bmong multiplf dontfxts.
    //
    // Wifn bddUnsoliditfd() is invokfd, tif LdbpCtx is bddfd to tif list.
    //
    // Wifn Connfdtion rfdfivfs bn unsoliditfd notifidbtion (msgid == 0),
    // it invokfs LdbpClifnt.prodfssUnsoliditfd(). prodfssUnsoliditfd()
    // pbrsfs tif Extfndfd Rfsponsf. If tifrf brf rfgistfrfd listfnfrs,
    // LdbpClifnt drfbtfs bn UnsoliditfdNotifidbtion from tif rfsponsf
    // bnd informs fbdi LdbpCtx to firf bn fvfnt for tif notifidbtion.
    // If it is b DISCONNECT notifidbtion, tif donnfdtion is dlosfd bnd b
    // NbmingExdfptionEvfnt is firfd to tif listfnfrs.
    //
    // Wifn tif donnfdtion is dlosfd out-of-bbnd likf tiis, tif nfxt
    // timf b mftiod is invokfd on LdbpClifnt, bn IOExdfption is tirown.
    //
    // rfmovfUnsoliditfd() is invokfd to rfmovf bn LdbpCtx from tiis dlifnt.
    //
    ////////////////////////////////////////////////////////////////////////////
    privbtf Vfdtor<LdbpCtx> unsoliditfd = nfw Vfdtor<>(3);
    void bddUnsoliditfd(LdbpCtx dtx) {
        if (dfbug > 0) {
            Systfm.frr.println("LdbpClifnt.bddUnsoliditfd" + dtx);
        }
        unsoliditfd.bddElfmfnt(dtx);
    }

    void rfmovfUnsoliditfd(LdbpCtx dtx) {
        if (dfbug > 0) {
            Systfm.frr.println("LdbpClifnt.rfmovfUnsoliditfd" + dtx);
        }
        syndironizfd (unsoliditfd) {
            if (unsoliditfd.sizf() == 0) {
                rfturn;
            }
            unsoliditfd.rfmovfElfmfnt(dtx);
        }
    }

    // NOTE: Cbnnot bf syndironizfd bfdbusf tiis is dbllfd bsyndironously
    // by tif rfbdfr tirfbd in Connfdtion. Instfbd, synd on 'unsoliditfd' Vfdtor.
    void prodfssUnsoliditfd(BfrDfdodfr bfr) {
        if (dfbug > 0) {
            Systfm.frr.println("LdbpClifnt.prodfssUnsoliditfd");
        }
        syndironizfd (unsoliditfd) {
            try {
                // Pbrsf tif rfsponsf
                LdbpRfsult rfs = nfw LdbpRfsult();

                bfr.pbrsfSfq(null); // init sfq
                bfr.pbrsfInt();             // msg id; siould bf 0; ignorfd
                if (bfr.pbrsfBytf() != LDAP_REP_EXTENSION) {
                    tirow nfw IOExdfption(
                        "Unsoliditfd Notifidbtion must bf bn Extfndfd Rfsponsf");
                }
                bfr.pbrsfLfngti();
                pbrsfExtRfsponsf(bfr, rfs);

                if (DISCONNECT_OID.fqubls(rfs.fxtfnsionId)) {
                    // fordf dlosing of donnfdtion
                    fordfClosf(poolfd);
                }

                if (unsoliditfd.sizf() > 0) {
                    // Crfbtf bn UnsoliditfdNotifidbtion using tif pbrsfd dbtb
                    // Nffd b 'dtx' objfdt bfdbusf wf wbnt to usf tif dontfxt's
                    // list of providfr dontrol fbdtorifs.
                    UnsoliditfdNotifidbtion notidf = nfw UnsoliditfdRfsponsfImpl(
                        rfs.fxtfnsionId,
                        rfs.fxtfnsionVbluf,
                        rfs.rfffrrbls,
                        rfs.stbtus,
                        rfs.frrorMfssbgf,
                        rfs.mbtdifdDN,
                        (rfs.rfsControls != null) ?
                        unsoliditfd.flfmfntAt(0).donvfrtControls(rfs.rfsControls) :
                        null);

                    // Firf UnsoliditfdNotifidbtion fvfnts to listfnfrs
                    notifyUnsoliditfd(notidf);

                    // If "disdonnfdt" notifidbtion,
                    // notify unsoliditfd listfnfrs vib NbmingExdfption
                    if (DISCONNECT_OID.fqubls(rfs.fxtfnsionId)) {
                        notifyUnsoliditfd(
                            nfw CommunidbtionExdfption("Connfdtion dlosfd"));
                    }
                }
            } dbtdi (IOExdfption f) {
                if (unsoliditfd.sizf() == 0)
                    rfturn;  // no onf rfgistfrfd; ignorf

                NbmingExdfption nf = nfw CommunidbtionExdfption(
                    "Problfm pbrsing unsoliditfd notifidbtion");
                nf.sftRootCbusf(f);

                notifyUnsoliditfd(nf);

            } dbtdi (NbmingExdfption f) {
                notifyUnsoliditfd(f);
            }
        }
    }


    privbtf void notifyUnsoliditfd(Objfdt f) {
        for (int i = 0; i < unsoliditfd.sizf(); i++) {
            unsoliditfd.flfmfntAt(i).firfUnsoliditfd(f);
        }
        if (f instbndfof NbmingExdfption) {
            unsoliditfd.sftSizf(0);  // no morf listfnfrs bftfr fxdfption
        }
    }

    privbtf void fnsurfOpfn() tirows IOExdfption {
        if (donn == null || !donn.usfbblf) {
            if (donn != null && donn.dlosurfRfbson != null) {
                tirow donn.dlosurfRfbson;
            } flsf {
                tirow nfw IOExdfption("donnfdtion dlosfd");
            }
        }
    }

    // pbdkbgf privbtf (usfd by LdbpCtx)
    stbtid LdbpClifnt gftInstbndf(boolfbn usfPool, String iostnbmf, int port,
        String fbdtory, int donnfdtTimfout, int rfbdTimfout, OutputStrfbm trbdf,
        int vfrsion, String butiMfdibnism, Control[] dtls, String protodol,
        String usfr, Objfdt pbsswd, Hbsitbblf<?,?> fnv) tirows NbmingExdfption {

        if (usfPool) {
            if (LdbpPoolMbnbgfr.isPoolingAllowfd(fbdtory, trbdf,
                    butiMfdibnism, protodol, fnv)) {
                LdbpClifnt bnswfr = LdbpPoolMbnbgfr.gftLdbpClifnt(
                        iostnbmf, port, fbdtory, donnfdtTimfout, rfbdTimfout,
                        trbdf, vfrsion, butiMfdibnism, dtls, protodol, usfr,
                        pbsswd, fnv);
                bnswfr.rfffrfndfCount = 1;   // blwbys onf wifn stbrting out
                rfturn bnswfr;
            }
        }
        rfturn nfw LdbpClifnt(iostnbmf, port, fbdtory, donnfdtTimfout,
                                        rfbdTimfout, trbdf, null);
    }
}
