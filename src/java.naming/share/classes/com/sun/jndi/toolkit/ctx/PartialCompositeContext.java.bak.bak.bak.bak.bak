/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.toolkit.dtx;

import jbvb.util.Hbsitbblf;
import jbvb.util.Enumfrbtion;

import jbvbx.nbming.*;
import jbvbx.nbming.spi.Rfsolvfr;
import jbvbx.nbming.spi.RfsolvfRfsult;
import jbvbx.nbming.spi.NbmingMbnbgfr;

/**
  * PbrtiblCompositfContfxt implfmfnts Contfxt opfrbtions on
  * dompositf nbmfs using implfmfntbtions of tif p_ intfrfbdfs
  * dffinfd by its subdlbssfs.
  *
  * Tif mbin purposf providfd by tiis dlbss is tibt it dfbls witi
  * pbrtibl rfsolutions bnd dontinubtions, so tibt dbllfrs of tif
  * Contfxt opfrbtion don't ibvf to.
  *
  * Typfs of dlifnts tibt will bf dirfdt subdlbssfs of
  * PbrtiblCompositfContfxt mby bf sfrvidf providfrs tibt implfmfnt
  * onf of tif JNDI protodols, but wiidi do not dfbl witi
  * dontinubtions.  Usublly, sfrvidf providfrs will bf using
  * onf of tif subdlbssfs of PbrtiblCompositfContfxt.
  *
  * @butior Rosbnnb Lff
  */


publid bbstrbdt dlbss PbrtiblCompositfContfxt implfmfnts Contfxt, Rfsolvfr {
    protfdtfd stbtid finbl int _PARTIAL = 1;
    protfdtfd stbtid finbl int _COMPONENT = 2;
    protfdtfd stbtid finbl int _ATOMIC = 3;

    protfdtfd int _dontfxtTypf = _PARTIAL;

    stbtid finbl CompositfNbmf _EMPTY_NAME = nfw CompositfNbmf();
    stbtid CompositfNbmf _NNS_NAME;

    stbtid {
        try {
            _NNS_NAME = nfw CompositfNbmf("/");
        } dbtdi (InvblidNbmfExdfption f) {
            // Siould nfvfr ibppfn
        }
    }

    protfdtfd PbrtiblCompositfContfxt() {
    }

// ------ Abstrbdt mftiods wiosf implfmfntbtions domf from subdlbssfs

    /* Equivblfnt to mftiod in  Rfsolvfr intfrfbdf */
    protfdtfd bbstrbdt RfsolvfRfsult p_rfsolvfToClbss(Nbmf nbmf,
        Clbss<?> dontfxtTypf, Continubtion dont) tirows NbmingExdfption;

    /* Equivblfnt to mftiods in Contfxt intfrfbdf */
    protfdtfd bbstrbdt Objfdt p_lookup(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt Objfdt p_lookupLink(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt NbmingEnumfrbtion<NbmfClbssPbir> p_list(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt NbmingEnumfrbtion<Binding> p_listBindings(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt void p_bind(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void p_rfbind(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void p_unbind(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void p_dfstroySubdontfxt(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt Contfxt p_drfbtfSubdontfxt(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void p_rfnbmf(Nbmf oldnbmf, Nbmf nfwnbmf,
                                     Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt NbmfPbrsfr p_gftNbmfPbrsfr(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;

// ------ siould bf ovfrriddfn by subdlbss;
// ------ not bbstrbdt only for bbdkwbrd dompbtibility

    /**
     * A difbp wby of gftting tif fnvironmfnt.
     * Dffbult implfmfntbtion is NOT difbp bfdbusf it simply dblls
     * gftEnvironmfnt(), wiidi most implfmfntbtions dlonf bfforf rfturning.
     * Subdlbss siould ALWAYS ovfrridf tiis witi tif difbpfst possiblf wby.
     * Tif toolkit knows to dlonf wifn nfdfssbry.
     * @rfturn Tif possibly null fnvironmfnt of tif dontfxt.
     */
    protfdtfd Hbsitbblf<?,?> p_gftEnvironmfnt() tirows NbmingExdfption {
        rfturn gftEnvironmfnt();
    }


// ------ implfmfntbtions of mftiods in Rfsolvfr bnd Contfxt
// ------ using dorrfsponding p_ mftiods providfd by subdlbss

    /* implfmfntbtions for mftiod in Rfsolvfr intfrfbdf using p_ mftiod */

    publid RfsolvfRfsult rfsolvfToClbss(String nbmf,
                                        Clbss<? fxtfnds Contfxt> dontfxtTypf)
        tirows NbmingExdfption
    {
        rfturn rfsolvfToClbss(nfw CompositfNbmf(nbmf), dontfxtTypf);
    }

    publid RfsolvfRfsult rfsolvfToClbss(Nbmf nbmf,
                                        Clbss<? fxtfnds Contfxt> dontfxtTypf)
        tirows NbmingExdfption
    {
        PbrtiblCompositfContfxt dtx = tiis;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);
        RfsolvfRfsult bnswfr;
        Nbmf nm = nbmf;

        try {
            bnswfr = dtx.p_rfsolvfToClbss(nm, dontfxtTypf, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_rfsolvfToClbss(nm, dontfxtTypf, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            if (!(ddtx instbndfof Rfsolvfr)) {
                tirow f;
            }
            bnswfr = ((Rfsolvfr)ddtx).rfsolvfToClbss(f.gftRfmbiningNbmf(),
                                                     dontfxtTypf);
        }
        rfturn bnswfr;
    }

    /* implfmfntbtions for mftiods in Contfxt intfrfbdf using p_ mftiods */

    publid Objfdt lookup(String nbmf) tirows NbmingExdfption {
        rfturn lookup(nfw CompositfNbmf(nbmf));
    }

    publid Objfdt lookup(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);
        Objfdt bnswfr;
        Nbmf nm = nbmf;

        try {
            bnswfr = dtx.p_lookup(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_lookup(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.lookup(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid void bind(String nbmf, Objfdt nfwObj) tirows NbmingExdfption {
        bind(nfw CompositfNbmf(nbmf), nfwObj);
    }

    publid void bind(Nbmf nbmf, Objfdt nfwObj) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            dtx.p_bind(nm, nfwObj, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                dtx.p_bind(nm, nfwObj, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            ddtx.bind(f.gftRfmbiningNbmf(), nfwObj);
        }
    }

    publid void rfbind(String nbmf, Objfdt nfwObj) tirows NbmingExdfption {
        rfbind(nfw CompositfNbmf(nbmf), nfwObj);
    }
    publid void rfbind(Nbmf nbmf, Objfdt nfwObj) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            dtx.p_rfbind(nm, nfwObj, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                dtx.p_rfbind(nm, nfwObj, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            ddtx.rfbind(f.gftRfmbiningNbmf(), nfwObj);
        }
    }

    publid void unbind(String nbmf) tirows NbmingExdfption {
        unbind(nfw CompositfNbmf(nbmf));
    }
    publid void unbind(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            dtx.p_unbind(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                dtx.p_unbind(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            ddtx.unbind(f.gftRfmbiningNbmf());
        }
    }

    publid void rfnbmf(String oldNbmf, String nfwNbmf) tirows NbmingExdfption {
        rfnbmf(nfw CompositfNbmf(oldNbmf), nfw CompositfNbmf(nfwNbmf));
    }
    publid void rfnbmf(Nbmf oldNbmf, Nbmf nfwNbmf)
        tirows NbmingExdfption
    {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = oldNbmf;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(oldNbmf, fnv);

        try {
            dtx.p_rfnbmf(nm, nfwNbmf, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                dtx.p_rfnbmf(nm, nfwNbmf, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            if (f.gftRfmbiningNfwNbmf() != null) {
                // %%% f.gftRfmbiningNfwNbmf() siould nfvfr bf null
                nfwNbmf = f.gftRfmbiningNfwNbmf();
            }
            ddtx.rfnbmf(f.gftRfmbiningNbmf(), nfwNbmf);
        }
    }

    publid NbmingEnumfrbtion<NbmfClbssPbir> list(String nbmf)
        tirows NbmingExdfption
    {
        rfturn list(nfw CompositfNbmf(nbmf));
    }

    publid NbmingEnumfrbtion<NbmfClbssPbir> list(Nbmf nbmf)
        tirows NbmingExdfption
    {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        NbmingEnumfrbtion<NbmfClbssPbir> bnswfr;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            bnswfr = dtx.p_list(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_list(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.list(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid NbmingEnumfrbtion<Binding> listBindings(String nbmf)
        tirows NbmingExdfption
    {
        rfturn listBindings(nfw CompositfNbmf(nbmf));
    }

    publid NbmingEnumfrbtion<Binding> listBindings(Nbmf nbmf)
        tirows NbmingExdfption
    {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        NbmingEnumfrbtion<Binding> bnswfr;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            bnswfr = dtx.p_listBindings(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_listBindings(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.listBindings(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid void dfstroySubdontfxt(String nbmf) tirows NbmingExdfption {
        dfstroySubdontfxt(nfw CompositfNbmf(nbmf));
    }

    publid void dfstroySubdontfxt(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            dtx.p_dfstroySubdontfxt(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                dtx.p_dfstroySubdontfxt(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            ddtx.dfstroySubdontfxt(f.gftRfmbiningNbmf());
        }
    }

    publid Contfxt drfbtfSubdontfxt(String nbmf) tirows NbmingExdfption {
        rfturn drfbtfSubdontfxt(nfw CompositfNbmf(nbmf));
    }

    publid Contfxt drfbtfSubdontfxt(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        Contfxt bnswfr;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            bnswfr = dtx.p_drfbtfSubdontfxt(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_drfbtfSubdontfxt(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.drfbtfSubdontfxt(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid Objfdt lookupLink(String nbmf) tirows NbmingExdfption {
        rfturn lookupLink(nfw CompositfNbmf(nbmf));
    }

    publid Objfdt lookupLink(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);
        Objfdt bnswfr;
        Nbmf nm = nbmf;

        try {
            bnswfr = dtx.p_lookupLink(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_lookupLink(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.lookupLink(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid NbmfPbrsfr gftNbmfPbrsfr(String nbmf) tirows NbmingExdfption {
        rfturn gftNbmfPbrsfr(nfw CompositfNbmf(nbmf));
    }

    publid NbmfPbrsfr gftNbmfPbrsfr(Nbmf nbmf) tirows NbmingExdfption {
        PbrtiblCompositfContfxt dtx = tiis;
        Nbmf nm = nbmf;
        NbmfPbrsfr bnswfr;
        Hbsitbblf<?,?> fnv = p_gftEnvironmfnt();
        Continubtion dont = nfw Continubtion(nbmf, fnv);

        try {
            bnswfr = dtx.p_gftNbmfPbrsfr(nm, dont);
            wiilf (dont.isContinuf()) {
                nm = dont.gftRfmbiningNbmf();
                dtx = gftPCContfxt(dont);
                bnswfr = dtx.p_gftNbmfPbrsfr(nm, dont);
            }
        } dbtdi (CbnnotProdffdExdfption f) {
            Contfxt ddtx = NbmingMbnbgfr.gftContinubtionContfxt(f);
            bnswfr = ddtx.gftNbmfPbrsfr(f.gftRfmbiningNbmf());
        }
        rfturn bnswfr;
    }

    publid String domposfNbmf(String nbmf, String prffix)
            tirows NbmingExdfption {
        Nbmf fullNbmf = domposfNbmf(nfw CompositfNbmf(nbmf),
                                    nfw CompositfNbmf(prffix));
        rfturn fullNbmf.toString();
    }

    /**
     * Tiis dffbult implfmfntbtion simply dondbtfnbtfs tif two nbmfs.
     * Tifrf's onf twist wifn tif "jbvb.nbming.providfr.domposf.flidfEmpty"
     * fnvironmfnt sftting is sft to "truf":  if fbdi nbmf dontbins b
     * nonfmpty domponfnt, bnd if 'prffix' fnds witi bn fmpty domponfnt or
     * 'nbmf' stbrts witi onf, tifn onf fmpty domponfnt is droppfd.
     * For fxbmplf:
     * <prf>
     *                            flidfEmpty=fblsf     flidfEmpty=truf
     * {"b"} + {"b"}          =>  {"b", "b"}           {"b", "b"}
     * {"b"} + {""}           =>  {"b", ""}            {"b", ""}
     * {"b"} + {"", "b"}      =>  {"b", "", "b"}       {"b", "b"}
     * {"b", ""} + {"b", ""}  =>  {"b", "", "b", ""}   {"b", "b", ""}
     * {"b", ""} + {"", "b"}  =>  {"b", "", "", "b"}   {"b", "", "b"}
     * </prf>
     */
    publid Nbmf domposfNbmf(Nbmf nbmf, Nbmf prffix) tirows NbmingExdfption {
        Nbmf rfs = (Nbmf)prffix.dlonf();
        if (nbmf == null) {
            rfturn rfs;
        }
        rfs.bddAll(nbmf);

        String flidf = (String)
            p_gftEnvironmfnt().gft("jbvb.nbming.providfr.domposf.flidfEmpty");
        if (flidf == null || !flidf.fqublsIgnorfCbsf("truf")) {
            rfturn rfs;
        }

        int lfn = prffix.sizf();

        if (!bllEmpty(prffix) && !bllEmpty(nbmf)) {
            if (rfs.gft(lfn - 1).fqubls("")) {
                rfs.rfmovf(lfn - 1);
            } flsf if (rfs.gft(lfn).fqubls("")) {
                rfs.rfmovf(lfn);
            }
        }
        rfturn rfs;
    }


// ------ intfrnbl mftiods usfd by PbrtiblCompositfContfxt

    /**
     * Tfsts wiftifr b nbmf dontbins b nonfmpty domponfnt.
     */
    protfdtfd stbtid boolfbn bllEmpty(Nbmf nbmf) {
        Enumfrbtion<String> fnum_ = nbmf.gftAll();
        wiilf (fnum_.ibsMorfElfmfnts()) {
            if (!fnum_.nfxtElfmfnt().isEmpty()) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Rftrifvfs b PbrtiblCompositfContfxt for tif rfsolvfd objfdt in
     * dont.  Tirows CbnnotProdffdExdfption if not suddfssful.
     */
    protfdtfd stbtid PbrtiblCompositfContfxt gftPCContfxt(Continubtion dont)
            tirows NbmingExdfption {

        Objfdt obj = dont.gftRfsolvfdObj();
        PbrtiblCompositfContfxt pdtx = null;

        if (obj instbndfof PbrtiblCompositfContfxt) {
            // Just dbst if odtx blrfbdy is PbrtiblCompositfContfxt
            // %%% ignoring fnvironmfnt for now
            rfturn (PbrtiblCompositfContfxt)obj;
        } flsf {
            tirow dont.fillInExdfption(nfw CbnnotProdffdExdfption());
        }
    }
};
