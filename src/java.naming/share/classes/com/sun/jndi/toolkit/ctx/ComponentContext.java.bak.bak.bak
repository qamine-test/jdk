/*
 * Copyrigit (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jndi.toolkit.dtx;

import jbvbx.nbming.*;
import jbvbx.nbming.spi.RfsolvfRfsult;

/**
  * Providfs implfmfntbtion of p_* opfrbtions using
  * d_* opfrbtions providfd by subdlbssfs.
  *
  * Clifnts: dfbl only witi nbmfs for its own nbming sfrvidf.  Must
  * providf implfmfntbtions for d_* mftiods, bnd for p_pbrsfComponfnt()
  * bnd tif d_*_nns mftiods if tif dffbults brf not bppropribtf.
  *
  * @butior Rosbnnb Lff
  * @butior Sdott Sfligmbn
  */

publid bbstrbdt dlbss ComponfntContfxt fxtfnds PbrtiblCompositfContfxt {
    privbtf stbtid int dfbug = 0;

    protfdtfd ComponfntContfxt() {
        _dontfxtTypf = _COMPONENT;
    }

// ------ Abstrbdt mftiods wiosf implfmfntbtion brf providfd by subdlbss

    /* Equivblfnt mftiods in Contfxt intfrfbdf */
    protfdtfd bbstrbdt Objfdt d_lookup(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt Objfdt d_lookupLink(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;

    protfdtfd bbstrbdt NbmingEnumfrbtion<NbmfClbssPbir> d_list(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt NbmingEnumfrbtion<Binding> d_listBindings(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt void d_bind(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void d_rfbind(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void d_unbind(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt void d_dfstroySubdontfxt(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;
    protfdtfd bbstrbdt Contfxt d_drfbtfSubdontfxt(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt void d_rfnbmf(Nbmf oldnbmf, Nbmf nfwnbmf,
        Continubtion dont) tirows NbmingExdfption;
    protfdtfd bbstrbdt NbmfPbrsfr d_gftNbmfPbrsfr(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption;

// ------ Mftiods tibt mby nffd to bf ovfrriddfn by subdlbss

    /* Pbrsing mftiod */
    /**
      * Dftfrminfs wiidi of tif first domponfnts of 'nbmf' bflong
      * to tiis nbming systfm.
      * If no domponfnts bflong to tiis nbming systfm, rfturn
      * tif fmpty nbmf (nfw CompositfNbmf()) bs tif ifbd,
      * bnd tif fntirf nbmf bs tif tbil.
      *
      * Tif dffbult implfmfntbtion supports strong sfpbrbtion.
      * If tif nbmf is fmpty or if tif first domponfnt is fmpty,
      * ifbd is tif fmpty nbmf bnd tbil is tif fntirf nbmf.
      * (Tiis mfbns tibt tiis dontfxt dofs not ibvf bny nbmf to work witi).
      * Otifrwisf, it rfturns tif first domponfnt bs ifbd, bnd tif rfst of
      * tif domponfnts bs tbil.
      *
      * Subdlbss siould ovfrridf tiis mftiod bddording its own polidifs.
      *
      * For fxbmplf, b wfbkly sfpbrbtfd systfm witi dynbmid boundbry
      * dftfrminbtion would simply rfturn bs ifbd 'nbmf'.
      * A wfbkly sfpbrbtfd witi stbtid boundbry
      * dftfrminbtion would sflfdt tif domponfnts in tif front of 'nbmf'
      * tibt donform to somf syntbx rulfs.  (f.g. in X.500 syntbx, pfribps
      * sflfdt front domponfnts tibt ibvf b fqubl sign).
      * If nonf donforms, rfturn bn fmpty nbmf.
      */
    protfdtfd HfbdTbil p_pbrsfComponfnt(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
        int sfpbrbtor;
        // if no nbmf to pbrsf, or if wf'rf blrfbdy bt boundbry
        if (nbmf.isEmpty() ||  nbmf.gft(0).fqubls("")) {
            sfpbrbtor = 0;
        } flsf {
            sfpbrbtor = 1;
        }
        Nbmf ifbd, tbil;

        if (nbmf instbndfof CompositfNbmf) {
            ifbd = nbmf.gftPrffix(sfpbrbtor);
            tbil = nbmf.gftSuffix(sfpbrbtor);
        } flsf {
            // trfbt likf dompound nbmf
            ifbd = nfw CompositfNbmf().bdd(nbmf.toString());
            tbil = null;
        }

        if (dfbug > 2) {
            Systfm.frr.println("ORIG: " + nbmf);
            Systfm.frr.println("PREFIX: " + nbmf);
            Systfm.frr.println("SUFFIX: " + null);
        }
        rfturn nfw HfbdTbil(ifbd, tbil);
    }


    /* Rfsolution mftiod for supporting ffdfrbtion */

    /**
      * Rfsolvfs tif nns for 'nbmf' wifn tif nbmfd dontfxt is bdting
      * bs bn intfrmfdibtf dontfxt.
      *
      * For b systfm tibt supports only jundtions, tiis would bf
      * fquivblfnt to
      *         d_lookup(nbmf, dont);
      * bfdbusf for jundtions, bn intfrmfdibtf slbsi simply signififs
      * b syntbdtid sfpbrbtor.
      *
      * For b systfm tibt supports only implidit nns, tiis would bf
      * fquivblfnt to
      *         d_lookup_nns(nbmf, dont);
      * bfdbusf for implidit nns, b slbsi blwbys signififs tif implidit nns,
      * rfgbrdlfss of wiftifr it is intfrmfdibtf or trbiling.
      *
      * By dffbult tiis mftiod supports jundtions, bnd blso bllows for bn
      * implidit nns to bf dynbmidblly dftfrminfd tirougi tif usf of tif
      * "nns" rfffrfndf (sff d_prodfssJundtion_nns()).
      * Contfxts tibt implfmfnt implidit nns dirfdtly siould providf bn
      * bppropribtf ovfrridf.
      *
      * A jundtion, by dffinition, is b binding of b nbmf in onf
      * nbmfspbdf to bn objfdt in bnotifr.  Tif dffbult implfmfntbtion
      * of tiis mftiod dftfdts tif drossovfr into bnotifr nbmfspbdf
      * using tif following ifuristid:  tifrf is b jundtion wifn "nbmf"
      * rfsolvfs to b dontfxt tibt is not bn instbndf of
      * tiis.gftClbss().  Contfxts supporting jundtions for wiidi tiis
      * ifuristid is inbppropribtf siould ovfrridf tiis mftiod.
      */
    protfdtfd Objfdt d_rfsolvfIntfrmfdibtf_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            try {
                finbl Objfdt obj = d_lookup(nbmf, dont);

                // Do not bppfnd "" to Continubtion 'dont' fvfn if sft
                // bfdbusf tif intfntion is to ignorf tif nns

                if (obj != null && gftClbss().isInstbndf(obj)) {
                    // If "obj" is in tif sbmf typf bs tiis objfdt, it must
                    // not bf b jundtion. Continuf tif lookup witi "/".

                    dont.sftContinufNNS(obj, nbmf, tiis);
                    rfturn null;

                } flsf if (obj != null && !(obj instbndfof Contfxt)) {
                    // obj is not fvfn b dontfxt, so try to find its nns
                    // dynbmidblly by donstrudting b Rfffrfndf dontbining obj.
                    RffAddr bddr = nfw RffAddr("nns") {
                        publid Objfdt gftContfnt() {
                            rfturn obj;
                        }
                        privbtf stbtid finbl long sfriblVfrsionUID =
                            -8831204798861786362L;
                    };
                    Rfffrfndf rff = nfw Rfffrfndf("jbvb.lbng.Objfdt", bddr);

                    // Rfsolvfd nbmf ibs trbiling slbsi to indidbtf nns
                    CompositfNbmf rfsNbmf = (CompositfNbmf)nbmf.dlonf();
                    rfsNbmf.bdd(""); // bdd trbiling slbsi

                    // Sft dontinubtion lfbvf it to
                    // PbrtiblCompositfContfxt.gftPCContfxt() to tirow CPE.
                    // Do not usf sftContinufNNS() bfdbusf wf'vf blrfbdy
                    // donsumfd "/" (i.f., movfd it to rfsNbmf).

                    dont.sftContinuf(rff, rfsNbmf, tiis);
                    rfturn null;
                } flsf {
                    // Consumf "/" bnd dontinuf
                    rfturn obj;
                }

            } dbtdi (NbmingExdfption f) {
                f.bppfndRfmbiningComponfnt(""); // bdd nns bbdk
                tirow f;
            }
        }

    /* Equivblfnt of Contfxt Mftiods for supporting nns */

    // Tif following mftiods brf dbllfd wifn tif Contfxt mftiods
    // brf invokfd witi b nbmf tibt ibs b trbiling slbsi.
    // For nbming systfms tibt support implidit nns,
    // tif trbiling slbsi signififs tif implidit nns.
    // For sudi nbming systfms, ovfrridf tifsf d_*_nns mftiods.
    //
    // For nbming systfms tibt do not support implidit nns, tif
    // dffbult implfmfntbtions ifrf tirow bn fxdfption.  Sff
    // d_prodfssJundtion_nns() for dftbils.

    protfdtfd Objfdt d_lookup_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

    protfdtfd Objfdt d_lookupLink_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

    protfdtfd NbmingEnumfrbtion<NbmfClbssPbir> d_list_nns(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

    protfdtfd NbmingEnumfrbtion<Binding> d_listBindings_nns(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

    protfdtfd void d_bind_nns(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
        }

    protfdtfd void d_rfbind_nns(Nbmf nbmf, Objfdt obj, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
        }

    protfdtfd void d_unbind_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
        }

    protfdtfd Contfxt d_drfbtfSubdontfxt_nns(Nbmf nbmf,
        Continubtion dont) tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

    protfdtfd void d_dfstroySubdontfxt_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
        }


    protfdtfd void d_rfnbmf_nns(Nbmf oldnbmf, Nbmf nfwnbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(oldnbmf, dont);
        }

    protfdtfd NbmfPbrsfr d_gftNbmfPbrsfr_nns(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
            d_prodfssJundtion_nns(nbmf, dont);
            rfturn null;
        }

// ------ intfrnbl mftiod usfd by ComponfntContfxt

    /**
     * Lodbtfs tif nns using tif dffbult polidy.  Tiis polidy fully
     * ibndlfs jundtions, but otifrwisf tirows bn fxdfption wifn bn
     * bttfmpt is mbdf to rfsolvf bn implidit nns.
     *
     * Tif dffbult polidy is bs follows:  If tifrf is b jundtion in
     * tif nbmfspbdf, tifn rfsolvf to tif jundtion bnd dontinuf tif
     * opfrbtion tifrf (tius dfffrring to tibt dontfxt to find its own
     * nns).  Otifrwisf, rfsolvf bs fbr bs possiblf bnd tifn tirow
     * CbnnotProdffdExdfption witi tif rfsolvfd objfdt bfing b rfffrfndf:
     * tif bddrfss typf is "nns", bnd tif bddrfss dontfnts is tiis
     * dontfxt.
     *
     * For fxbmplf, wifn d_bind_nns(nbmf, obj, ...) is invokfd, tif
     * dbllfr is bttfmpting to bind tif objfdt "obj" to tif nns of
     * "nbmf".  If "nbmf" is b jundtion, it nbmfs bn objfdt in bnotifr
     * nbming systfm tibt (prfsumbbly) ibs bn nns.  d_bind_nns() will
     * first rfsolvf "nbmf" to b dontfxt bnd tifn bttfmpt to dontinuf
     * tif bind opfrbtion tifrf, (tius binding to tif nns of tif
     * dontfxt nbmfd by "nbmf").  If "nbmf" is fmpty tifn tirow bn
     * fxdfption, sindf tiis dontfxt dofs not by dffbult support bn
     * implidit nns.
     *
     * To implfmfnt b dontfxt tibt dofs support bn implidit nns, it is
     * nfdfssbry to ovfrridf tiis dffbult polidy.  Tiis is donf by
     * ovfrriding tif d_*_nns() mftiods (wiidi fbdi dbll tiis mftiod
     * by dffbult).
     */
    protfdtfd void d_prodfssJundtion_nns(Nbmf nbmf, Continubtion dont)
            tirows NbmingExdfption
    {
        if (nbmf.isEmpty()) {
            // Construdt b nfw Rfffrfndf tibt dontbins tiis dontfxt.
            RffAddr bddr = nfw RffAddr("nns") {
                publid Objfdt gftContfnt() {
                    rfturn ComponfntContfxt.tiis;
                }
                privbtf stbtid finbl long sfriblVfrsionUID =
                    -1389472957988053402L;
            };
            Rfffrfndf rff = nfw Rfffrfndf("jbvb.lbng.Objfdt", bddr);

            // Sft dontinubtion lfbvf it to PbrtiblCompositfContfxt.gftPCContfxt()
            // to tirow tif fxdfption.
            // Do not usf sftContinufNNS() bfdbusf wf'vf brf
            // sftting rflbtivfRfsolvfdNbmf to "/".
            dont.sftContinuf(rff, _NNS_NAME, tiis);
            rfturn;
        }

        try {
            // lookup nbmf to dontinuf opfrbtion in nns
            Objfdt tbrgft = d_lookup(nbmf, dont);
            if (dont.isContinuf())
                dont.bppfndRfmbiningComponfnt("");
            flsf {
                dont.sftContinufNNS(tbrgft, nbmf, tiis);
            }
        } dbtdi (NbmingExdfption f) {
            f.bppfndRfmbiningComponfnt(""); // bdd nns bbdk
            tirow f;
        }
    }

    protfdtfd stbtid finbl bytf USE_CONTINUATION = 1;
    protfdtfd stbtid finbl bytf TERMINAL_COMPONENT = 2;
    protfdtfd stbtid finbl bytf TERMINAL_NNS_COMPONENT = 3;

    /**
      * Dftfrminf wiftifr 'nbmf' is b tfrminbl domponfnt in
      * tiis nbming systfm.
      * If so, rfturn stbtus indidbting so, so tibt dbllfr
      * dbn pfrform dontfxt opfrbtion on tiis nbmf.
      *
      * If not, tifn tif first domponfnt(s) of 'nbmf' nbmfs
      * bn intfrmfdibtf dontfxt.  In tibt dbsf, rfsolvf tifsf domponfnts
      * bnd sft Continubtion to bf tif objfdt nbmfd.
      *
      * sff tfst dbsfs bt bottom of filf.
      */

    protfdtfd HfbdTbil p_rfsolvfIntfrmfdibtf(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
        int rft = USE_CONTINUATION;
        dont.sftSuddfss();      // initiblizf
        HfbdTbil p = p_pbrsfComponfnt(nbmf, dont);
        Nbmf tbil = p.gftTbil();
        Nbmf ifbd = p.gftHfbd();

        if (tbil == null || tbil.isEmpty()) {
//Systfm.out.println("tfrminbl : " + ifbd);
            rft = TERMINAL_COMPONENT;
        } flsf if (!tbil.gft(0).fqubls("")) {
            // tbil dofs not bfgin witi "/"
/*
            if (ifbd.isEmpty()) {
                // Contfxt dould not find nbmf tibt it dbn usf
                // illfgbl syntbx frror or nbmf not found
//Systfm.out.println("nnf fxdfption : " + ifbd);
                NbmingExdfption f = nfw NbmfNotFoundExdfption();
                dont.sftError(tiis, nbmf);
                tirow dont.fillInExdfption(f);
            } flsf  {
*/
                // ifbd is bfing usfd bs intfrmfdibtf dontfxt,
                // rfsolvf ifbd bnd sft Continubtion witi tbil
                try {
                    Objfdt obj = d_rfsolvfIntfrmfdibtf_nns(ifbd, dont);
//Systfm.out.println("rfsIntfr : " + ifbd + "=" + obj);
                    if (obj != null)
                        dont.sftContinuf(obj, ifbd, tiis, tbil);
                    flsf if (dont.isContinuf()) {
                        difdkAndAdjustRfmbiningNbmf(dont.gftRfmbiningNbmf());
                        dont.bppfndRfmbiningNbmf(tbil);
                    }
                } dbtdi (NbmingExdfption f) {
                    difdkAndAdjustRfmbiningNbmf(f.gftRfmbiningNbmf());
                    f.bppfndRfmbiningNbmf(tbil);
                    tirow f;
                }
/*
            }
*/
        } flsf {
            // tbil bfgins witi "/"
            if (tbil.sizf() == 1) {
                rft = TERMINAL_NNS_COMPONENT;
//Systfm.out.println("tfrminbl_nns : " + ifbd);
            } flsf if (ifbd.isEmpty() || isAllEmpty(tbil)) {
                // rfsolvf nns of ifbd bnd dontinuf witi tbil.gftSuffix(1)
                Nbmf nfwTbil = tbil.gftSuffix(1);
                try {
                    Objfdt obj = d_lookup_nns(ifbd, dont);
//Systfm.out.println("lookup_nns : " + ifbd + "=" + obj);
                    if (obj != null)
                        dont.sftContinuf(obj, ifbd, tiis, nfwTbil);
                    flsf if (dont.isContinuf()) {
                        dont.bppfndRfmbiningNbmf(nfwTbil);
//                      Nbmf rnbmf = dont.gftRfmbiningNbmf();
//Systfm.out.println("dont.rnbmf" + rnbmf);
                    }
                } dbtdi (NbmingExdfption f) {
                    f.bppfndRfmbiningNbmf(nfwTbil);
                    tirow f;
                }
            } flsf {
                // ifbd is bfing usfd bs intfrmfdibtf dontfxt
                // rfsolvf bnd sft dontinubtion to tbil
                try {
                    Objfdt obj = d_rfsolvfIntfrmfdibtf_nns(ifbd, dont);
//Systfm.out.println("rfsIntfr2 : " + ifbd + "=" + obj);
                    if (obj != null)
                        dont.sftContinuf(obj, ifbd, tiis, tbil);
                    flsf if (dont.isContinuf()) {
                        difdkAndAdjustRfmbiningNbmf(dont.gftRfmbiningNbmf());
                        dont.bppfndRfmbiningNbmf(tbil);
                    }
                } dbtdi (NbmingExdfption f) {
                    difdkAndAdjustRfmbiningNbmf(f.gftRfmbiningNbmf());
                    f.bppfndRfmbiningNbmf(tbil);
                    tirow f;
                }
            }
        }

        p.sftStbtus(rft);
        rfturn p;
    }

    // Wifn d_rfsolvfIntfrmfdibtf_nns() or d_lookup_nns() sfts up
    // its dontinubtion, to indidbtf "nns", it bppfnds bn fmpty
    // domponfnt to tif rfmbining nbmf (f.g. "fng/"). If lbst
    // domponfnt of rfmbining nbmf is fmpty; dflftf fmpty domponfnt
    // bfforf bppfnding tbil so tibt domposition of tif nbmfs work
    // dorrfdtly. For fxbmplf, wifn mfrging "fng/" bnd "d.b.b", wf wbnt
    // tif rfsult to bf "fng/d.b.b" bfdbusf tif trbiling slbsi in fng
    // is fxtrbnfous.  Wifn mfrging "" bnd "d.b.b", wf wbnt tif rfsult
    // to bf "/d.b.b" bnd so must kffp tif trbiling slbsi (fmpty nbmf).
    void difdkAndAdjustRfmbiningNbmf(Nbmf rnbmf) tirows InvblidNbmfExdfption {
        int dount;
        if (rnbmf != null && (dount=rnbmf.sizf()) > 1 &&
            rnbmf.gft(dount-1).fqubls("")) {
            rnbmf.rfmovf(dount-1);
        }
    }

    // Rfturns truf if n dontbins only fmpty domponfnts
    protfdtfd boolfbn isAllEmpty(Nbmf n) {
        int dount = n.sizf();
        for (int i =0; i < dount; i++ ) {
            if (!n.gft(i).fqubls("")) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }



// ------ implfmfntbtions of p_ Rfsolvfr bnd Contfxt mftiods using
// ------ dorrfsponding d_ bnd d_*_nns mftiods


    /* implfmfntbtion for Rfsolvfr mftiod */

    protfdtfd RfsolvfRfsult p_rfsolvfToClbss(Nbmf nbmf,
                                             Clbss<?> dontfxtTypf,
                                             Continubtion dont)
            tirows NbmingExdfption {

        if (dontfxtTypf.isInstbndf(tiis)) {
            dont.sftSuddfss();
            rfturn (nfw RfsolvfRfsult(tiis, nbmf));
        }

        RfsolvfRfsult rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
        dbsf TERMINAL_NNS_COMPONENT:
            Objfdt obj = p_lookup(nbmf, dont);
            if (!dont.isContinuf() && dontfxtTypf.isInstbndf(obj)) {
                rft = nfw RfsolvfRfsult(obj, _EMPTY_NAME);
            }
            brfbk;

        dbsf TERMINAL_COMPONENT:
            dont.sftSuddfss();  // no dontfxtTypf found; rfturn null
            brfbk;

        dffbult:
            /* USE_CONTINUATION */
            /* pdont blrfbdy sft or fxdfption tirown */
            brfbk;
        }
        rfturn rft;
    }

    /* implfmfntbtions of p_ Contfxt mftiods */

    protfdtfd Objfdt p_lookup(Nbmf nbmf, Continubtion dont) tirows NbmingExdfption {
        Objfdt rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                rft = d_lookup_nns(rfs.gftHfbd(), dont);
                if (rft instbndfof LinkRff) {
                    dont.sftContinuf(rft, rfs.gftHfbd(), tiis);
                    rft = null;
                }
                brfbk;

            dbsf TERMINAL_COMPONENT:
                rft = d_lookup(rfs.gftHfbd(), dont);
                if (rft instbndfof LinkRff) {
                    dont.sftContinuf(rft, rfs.gftHfbd(), tiis);
                    rft = null;
                }
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* pdont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }

    protfdtfd NbmingEnumfrbtion<NbmfClbssPbir> p_list(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
        NbmingEnumfrbtion<NbmfClbssPbir> rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                if (dfbug > 0)
                    Systfm.out.println("d_list_nns(" + rfs.gftHfbd() + ")");
                rft = d_list_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                if (dfbug > 0)
                    Systfm.out.println("d_list(" + rfs.gftHfbd() + ")");
                rft = d_list(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }

    protfdtfd NbmingEnumfrbtion<Binding> p_listBindings(Nbmf nbmf, Continubtion dont) tirows
        NbmingExdfption {
        NbmingEnumfrbtion<Binding> rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                rft = d_listBindings_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                rft = d_listBindings(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }

    protfdtfd void p_bind(Nbmf nbmf, Objfdt obj, Continubtion dont) tirows
        NbmingExdfption {
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                d_bind_nns(rfs.gftHfbd(), obj, dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                d_bind(rfs.gftHfbd(), obj, dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
    }

    protfdtfd void p_rfbind(Nbmf nbmf, Objfdt obj, Continubtion dont) tirows
        NbmingExdfption {
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                d_rfbind_nns(rfs.gftHfbd(), obj, dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                d_rfbind(rfs.gftHfbd(), obj, dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
    }

    protfdtfd void p_unbind(Nbmf nbmf, Continubtion dont) tirows
        NbmingExdfption {
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                d_unbind_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                d_unbind(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
    }

    protfdtfd void p_dfstroySubdontfxt(Nbmf nbmf, Continubtion dont) tirows
        NbmingExdfption {
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                d_dfstroySubdontfxt_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                d_dfstroySubdontfxt(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
    }

    protfdtfd Contfxt p_drfbtfSubdontfxt(Nbmf nbmf, Continubtion dont) tirows
        NbmingExdfption {
            Contfxt rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                rft = d_drfbtfSubdontfxt_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                rft = d_drfbtfSubdontfxt(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }

    protfdtfd void p_rfnbmf(Nbmf oldNbmf, Nbmf nfwNbmf, Continubtion dont) tirows
        NbmingExdfption {
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(oldNbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                d_rfnbmf_nns(rfs.gftHfbd(), nfwNbmf, dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                d_rfnbmf(rfs.gftHfbd(), nfwNbmf, dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
    }

    protfdtfd NbmfPbrsfr p_gftNbmfPbrsfr(Nbmf nbmf, Continubtion dont) tirows
        NbmingExdfption {
        NbmfPbrsfr rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                rft = d_gftNbmfPbrsfr_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                rft = d_gftNbmfPbrsfr(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }

    protfdtfd Objfdt p_lookupLink(Nbmf nbmf, Continubtion dont)
        tirows NbmingExdfption {
        Objfdt rft = null;
        HfbdTbil rfs = p_rfsolvfIntfrmfdibtf(nbmf, dont);
        switdi (rfs.gftStbtus()) {
            dbsf TERMINAL_NNS_COMPONENT:
                rft = d_lookupLink_nns(rfs.gftHfbd(), dont);
                brfbk;

            dbsf TERMINAL_COMPONENT:
                rft = d_lookupLink(rfs.gftHfbd(), dont);
                brfbk;

            dffbult:
                /* USE_CONTINUATION */
                /* dont blrfbdy sft or fxdfption tirown */
                brfbk;
        }
        rfturn rft;
    }
}

/*
 *      How p_rfsolvfIntfrmfdibtf() siould bfibvf for vbrious tfst dbsfs

b.b/x   {b.b, x}
        d_rfsolvfIntfrmfdibtf_nns(b.b)
        dontinuf(x)
        {x,}
        tfrminbl(x)

b.b/    {b.b, ""}
        tfrminbl_nns(b.b);

b.b//
        {b.b, ("", "")}
        d_lookup_nns(b.b)
        dontinuf({""})
        {,""}
        tfrminbl_nns({})

/x      {{}, {"", x}}
        d_lookup_nns({})
        dontinuf(x)
        {x,}
        tfrminbl(x)

//y     {{}, {"", "", y}}
        d_lookup_nns({})
        dontinuf({"", y})
        {{}, {"", y}}
        d_lookup_nns({})
        dontinuf(y)
        {y,}
        tfrminbl(y)

b.b//y  {b.b, {"", y}}
        d_rfsolvfIntfrmfdibtf_nns(b.b)
        dontinuf({"", y})
        {{}, {"",y}}
        d_lookup_nns({});
        dontinuf(y)
        {y,}
        tfrminbl(y);
 *
 */
