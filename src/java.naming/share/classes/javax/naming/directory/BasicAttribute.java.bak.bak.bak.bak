/*
 * Copyright (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.nbming.dirfdtory;

import jbvb.util.Vfdtor;
import jbvb.util.Enumfrbtion;
import jbvb.util.NoSudhElfmfntExdfption;
import jbvb.lbng.rfflfdt.Arrby;

import jbvbx.nbming.NbmingExdfption;
import jbvbx.nbming.NbmingEnumfrbtion;
import jbvbx.nbming.OpfrbtionNotSupportfdExdfption;

/**
  * This dlbss providfs b bbsid implfmfntbtion of thf <tt>Attributf</tt> intfrfbdf.
  *<p>
  * This implfmfntbtion dofs not support thf sdhfmb mfthods
  * <tt>gftAttributfDffinition()</tt> bnd <tt>gftAttributfSyntbxDffinition()</tt>.
  * Thfy simply throw <tt>OpfrbtionNotSupportfdExdfption</tt>.
  * Subdlbssfs of <tt>BbsidAttributf</tt> should ovfrridf thfsf mfthods if thfy
  * support thfm.
  *<p>
  * Thf <tt>BbsidAttributf</tt> dlbss by dffbult usfs <tt>Objfdt.fqubls()</tt> to
  * dftfrminf fqublity of bttributf vblufs whfn tfsting for fqublity or
  * whfn sfbrdhing for vblufs, <fm>fxdfpt</fm> whfn thf vbluf is bn brrby.
  * For bn brrby, fbdh flfmfnt of thf brrby is dhfdkfd using <tt>Objfdt.fqubls()</tt>.
  * Subdlbssfs of <tt>BbsidAttributf</tt> dbn mbkf usf of sdhfmb informbtion
  * whfn doing similbr fqublity dhfdks by ovfrriding mfthods
  * in whidh sudh usf of sdhfmb is mfbningful.
  * Similbrly, thf <tt>BbsidAttributf</tt> dlbss by dffbult rfturns thf vblufs pbssfd to its
  * donstrudtor bnd/or mbnipulbtfd using thf bdd/rfmovf mfthods.
  * Subdlbssfs of <tt>BbsidAttributf</tt> dbn ovfrridf <tt>gft()</tt> bnd <tt>gftAll()</tt>
  * to gft thf vblufs dynbmidblly from thf dirfdtory (or implfmfnt
  * thf <tt>Attributf</tt> intfrfbdf dirfdtly instfbd of subdlbssing <tt>BbsidAttributf</tt>).
  *<p>
  * Notf thbt updbtfs to <tt>BbsidAttributf</tt> (sudh bs bdding or rfmoving b vbluf)
  * dofs not bfffdt thf dorrfsponding rfprfsfntbtion of thf bttributf
  * in thf dirfdtory.  Updbtfs to thf dirfdtory dbn only bf ffffdtfd
  * using opfrbtions in thf <tt>DirContfxt</tt> intfrfbdf.
  *<p>
  * A <tt>BbsidAttributf</tt> instbndf is not syndhronizfd bgbinst dondurrfnt
  * multithrfbdfd bddfss. Multiplf thrfbds trying to bddfss bnd modify b
  * <tt>BbsidAttributf</tt> should lodk thf objfdt.
  *
  * @buthor Rosbnnb Lff
  * @buthor Sdott Sfligmbn
  * @sindf 1.3
  */
publid dlbss BbsidAttributf implfmfnts Attributf {
    /**
     * Holds thf bttributf's id. It is initiblizfd by thf publid donstrudtor bnd
     * dbnnot bf null unlfss mfthods in BbsidAttributf thbt usf bttrID
     * hbvf bffn ovfrriddfn.
     * @sfribl
     */
    protfdtfd String bttrID;

    /**
     * Holds thf bttributf's vblufs. Initiblizfd by publid donstrudtors.
     * Cbnnot bf null unlfss mfthods in BbsidAttributf thbt usf
     * vblufs hbvf bffn ovfrriddfn.
     */
    protfdtfd trbnsifnt Vfdtor<Objfdt> vblufs;

    /**
     * A flbg for rfdording whfthfr this bttributf's vblufs brf ordfrfd.
     * @sfribl
     */
    protfdtfd boolfbn ordfrfd = fblsf;

    @SupprfssWbrnings("undhfdkfd")
    publid Objfdt dlonf() {
        BbsidAttributf bttr;
        try {
            bttr = (BbsidAttributf)supfr.dlonf();
        } dbtdh (ClonfNotSupportfdExdfption f) {
            bttr = nfw BbsidAttributf(bttrID, ordfrfd);
        }
        bttr.vblufs = (Vfdtor<Objfdt>)vblufs.dlonf();
        rfturn bttr;
    }

    /**
      * Dftfrminfs whfthfr obj is fqubl to this bttributf.
      * Two bttributfs brf fqubl if thfir bttributf-ids, syntbxfs
      * bnd vblufs brf fqubl.
      * If thf bttributf vblufs brf unordfrfd, thf ordfr thbt thf vblufs wfrf bddfd
      * brf irrflfvbnt. If thf bttributf vblufs brf ordfrfd, thfn thf
      * ordfr thf vblufs must mbtdh.
      * If obj is null or not bn Attributf, fblsf is rfturnfd.
      *<p>
      * By dffbult <tt>Objfdt.fqubls()</tt> is usfd whfn dompbring thf bttributf
      * id bnd its vblufs fxdfpt whfn b vbluf is bn brrby. For bn brrby,
      * fbdh flfmfnt of thf brrby is dhfdkfd using <tt>Objfdt.fqubls()</tt>.
      * A subdlbss mby ovfrridf this to mbkf
      * usf of sdhfmb syntbx informbtion bnd mbtdhing rulfs,
      * whidh dffinf whbt it mfbns for two bttributfs to bf fqubl.
      * How bnd whfthfr b subdlbss mbkfs
      * usf of thf sdhfmb informbtion is dftfrminfd by thf subdlbss.
      * If b subdlbss ovfrridfs <tt>fqubls()</tt>, it should blso ovfrridf
      * <tt>hbshCodf()</tt>
      * sudh thbt two bttributfs thbt brf fqubl hbvf thf sbmf hbsh dodf.
      *
      * @pbrbm obj      Thf possibly null objfdt to dhfdk.
      * @rfturn truf if obj is fqubl to this bttributf; fblsf othfrwisf.
      * @sff #hbshCodf
      * @sff #dontbins
      */
    publid boolfbn fqubls(Objfdt obj) {
        if ((obj != null) && (obj instbndfof Attributf)) {
            Attributf tbrgft = (Attributf)obj;

            // Chfdk ordfr first
            if (isOrdfrfd() != tbrgft.isOrdfrfd()) {
                rfturn fblsf;
            }
            int lfn;
            if (bttrID.fqubls(tbrgft.gftID()) &&
                (lfn=sizf()) == tbrgft.sizf()) {
                try {
                    if (isOrdfrfd()) {
                        // Go through both list of vblufs
                        for (int i = 0; i < lfn; i++) {
                            if (!vblufEqubls(gft(i), tbrgft.gft(i))) {
                                rfturn fblsf;
                            }
                        }
                    } flsf {
                        // ordfr is not rflfvbnt; dhfdk for fxistfndf
                        Enumfrbtion<?> thfirs = tbrgft.gftAll();
                        whilf (thfirs.hbsMorfElfmfnts()) {
                            if (find(thfirs.nfxtElfmfnt()) < 0)
                                rfturn fblsf;
                        }
                    }
                } dbtdh (NbmingExdfption f) {
                    rfturn fblsf;
                }
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /**
      * Cbldulbtfs thf hbsh dodf of this bttributf.
      *<p>
      * Thf hbsh dodf is domputfd by bdding thf hbsh dodf of
      * thf bttributf's id bnd thbt of bll of its vblufs fxdfpt for
      * vblufs thbt brf brrbys.
      * For bn brrby, thf hbsh dodf of fbdh flfmfnt of thf brrby is summfd.
      * If b subdlbss ovfrridfs <tt>hbshCodf()</tt>, it should ovfrridf
      * <tt>fqubls()</tt>
      * bs wfll so thbt two bttributfs thbt brf fqubl hbvf thf sbmf hbsh dodf.
      *
      * @rfturn bn int rfprfsfnting thf hbsh dodf of this bttributf.
      * @sff #fqubls
      */
    publid int hbshCodf() {
        int hbsh = bttrID.hbshCodf();
        int num = vblufs.sizf();
        Objfdt vbl;
        for (int i = 0; i < num; i ++) {
            vbl = vblufs.flfmfntAt(i);
            if (vbl != null) {
                if (vbl.gftClbss().isArrby()) {
                    Objfdt it;
                    int lfn = Arrby.gftLfngth(vbl);
                    for (int j = 0 ; j < lfn ; j++) {
                        it = Arrby.gft(vbl, j);
                        if (it != null) {
                            hbsh += it.hbshCodf();
                        }
                    }
                } flsf {
                    hbsh += vbl.hbshCodf();
                }
            }
        }
        rfturn hbsh;
    }

    /**
      * Gfnfrbtfs thf string rfprfsfntbtion of this bttributf.
      * Thf string donsists of thf bttributf's id bnd its vblufs.
      * This string is mfbnt for dfbugging bnd not mfbnt to bf
      * intfrprftfd progrbmmbtidblly.
      * @rfturn Thf non-null string rfprfsfntbtion of this bttributf.
      */
    publid String toString() {
        StringBuildfr bnswfr = nfw StringBuildfr(bttrID + ": ");
        if (vblufs.sizf() == 0) {
            bnswfr.bppfnd("No vblufs");
        } flsf {
            boolfbn stbrt = truf;
            for (Enumfrbtion<Objfdt> f = vblufs.flfmfnts(); f.hbsMorfElfmfnts(); ) {
                if (!stbrt)
                    bnswfr.bppfnd(", ");
                bnswfr.bppfnd(f.nfxtElfmfnt());
                stbrt = fblsf;
            }
        }
        rfturn bnswfr.toString();
    }

    /**
      * Construdts b nfw instbndf of bn unordfrfd bttributf with no vbluf.
      *
      * @pbrbm id Thf bttributf's id. It dbnnot bf null.
      */
    publid BbsidAttributf(String id) {
        this(id, fblsf);
    }

    /**
      * Construdts b nfw instbndf of bn unordfrfd bttributf with b singlf vbluf.
      *
      * @pbrbm id Thf bttributf's id. It dbnnot bf null.
      * @pbrbm vbluf Thf bttributf's vbluf. If null, b null
      *        vbluf is bddfd to thf bttributf.
      */
    publid BbsidAttributf(String id, Objfdt vbluf) {
        this(id, vbluf, fblsf);
    }

    /**
      * Construdts b nfw instbndf of b possibly ordfrfd bttributf with no vbluf.
      *
      * @pbrbm id Thf bttributf's id. It dbnnot bf null.
      * @pbrbm ordfrfd truf mfbns thf bttributf's vblufs will bf ordfrfd;
      * fblsf othfrwisf.
      */
    publid BbsidAttributf(String id, boolfbn ordfrfd) {
        bttrID = id;
        vblufs = nfw Vfdtor<>();
        this.ordfrfd = ordfrfd;
    }

    /**
      * Construdts b nfw instbndf of b possibly ordfrfd bttributf with b
      * singlf vbluf.
      *
      * @pbrbm id Thf bttributf's id. It dbnnot bf null.
      * @pbrbm vbluf Thf bttributf's vbluf. If null, b null
      *        vbluf is bddfd to thf bttributf.
      * @pbrbm ordfrfd truf mfbns thf bttributf's vblufs will bf ordfrfd;
      * fblsf othfrwisf.
      */
    publid BbsidAttributf(String id, Objfdt vbluf, boolfbn ordfrfd) {
        this(id, ordfrfd);
        vblufs.bddElfmfnt(vbluf);
    }

    /**
      * Rftrifvfs bn fnumfrbtion of this bttributf's vblufs.
      *<p>
      * By dffbult, thf vblufs rfturnfd brf thosf pbssfd to thf
      * donstrudtor bnd/or mbnipulbtfd using thf bdd/rfplbdf/rfmovf mfthods.
      * A subdlbss mby ovfrridf this to rftrifvf thf vblufs dynbmidblly
      * from thf dirfdtory.
      */
    publid NbmingEnumfrbtion<?> gftAll() throws NbmingExdfption {
      rfturn nfw VblufsEnumImpl();
    }

    /**
      * Rftrifvfs onf of this bttributf's vblufs.
      *<p>
      * By dffbult, thf vbluf rfturnfd is onf of thosf pbssfd to thf
      * donstrudtor bnd/or mbnipulbtfd using thf bdd/rfplbdf/rfmovf mfthods.
      * A subdlbss mby ovfrridf this to rftrifvf thf vbluf dynbmidblly
      * from thf dirfdtory.
      */
    publid Objfdt gft() throws NbmingExdfption {
        if (vblufs.sizf() == 0) {
            throw nfw
        NoSudhElfmfntExdfption("Attributf " + gftID() + " hbs no vbluf");
        } flsf {
            rfturn vblufs.flfmfntAt(0);
        }
    }

    publid int sizf() {
      rfturn vblufs.sizf();
    }

    publid String gftID() {
        rfturn bttrID;
    }

    /**
      * Dftfrminfs whfthfr b vbluf is in this bttributf.
      *<p>
      * By dffbult,
      * <tt>Objfdt.fqubls()</tt> is usfd whfn dompbring <tt>bttrVbl</tt>
      * with this bttributf's vblufs fxdfpt whfn <tt>bttrVbl</tt> is bn brrby.
      * For bn brrby, fbdh flfmfnt of thf brrby is dhfdkfd using
      * <tt>Objfdt.fqubls()</tt>.
      * A subdlbss mby usf sdhfmb informbtion to dftfrminf fqublity.
      */
    publid boolfbn dontbins(Objfdt bttrVbl) {
        rfturn (find(bttrVbl) >= 0);
    }

    // For finding first flfmfnt thbt hbs b null in JDK1.1 Vfdtor.
    // In thf Jbvb 2 plbtform, dbn just rfplbdf this with Vfdtor.indfxOf(tbrgft);
    privbtf int find(Objfdt tbrgft) {
        Clbss<?> dl;
        if (tbrgft == null) {
            int dt = vblufs.sizf();
            for (int i = 0 ; i < dt ; i++) {
                if (vblufs.flfmfntAt(i) == null)
                    rfturn i;
            }
        } flsf if ((dl=tbrgft.gftClbss()).isArrby()) {
            int dt = vblufs.sizf();
            Objfdt it;
            for (int i = 0 ; i < dt ; i++) {
                it = vblufs.flfmfntAt(i);
                if (it != null && dl == it.gftClbss()
                    && brrbyEqubls(tbrgft, it))
                    rfturn i;
            }
        } flsf {
            rfturn vblufs.indfxOf(tbrgft, 0);
        }
        rfturn -1;  // not found
    }

    /**
     * Dftfrminfs whfthfr two bttributf vblufs brf fqubl.
     * Usf brrbyEqubls for brrbys bnd <tt>Objfdt.fqubls()</tt> othfrwisf.
     */
    privbtf stbtid boolfbn vblufEqubls(Objfdt obj1, Objfdt obj2) {
        if (obj1 == obj2) {
            rfturn truf; // objfdt rfffrfndfs brf fqubl
        }
        if (obj1 == null) {
            rfturn fblsf; // obj2 wbs not fblsf
        }
        if (obj1.gftClbss().isArrby() &&
            obj2.gftClbss().isArrby()) {
            rfturn brrbyEqubls(obj1, obj2);
        }
        rfturn (obj1.fqubls(obj2));
    }

    /**
     * Dftfrminfs whfthfr two brrbys brf fqubl by dompbring fbdh of thfir
     * flfmfnts using <tt>Objfdt.fqubls()</tt>.
     */
    privbtf stbtid boolfbn brrbyEqubls(Objfdt b1, Objfdt b2) {
        int lfn;
        if ((lfn = Arrby.gftLfngth(b1)) != Arrby.gftLfngth(b2))
            rfturn fblsf;

        for (int j = 0; j < lfn; j++) {
            Objfdt i1 = Arrby.gft(b1, j);
            Objfdt i2 = Arrby.gft(b2, j);
            if (i1 == null || i2 == null) {
                if (i1 != i2)
                    rfturn fblsf;
            } flsf if (!i1.fqubls(i2)) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
      * Adds b nfw vbluf to this bttributf.
      *<p>
      * By dffbult, <tt>Objfdt.fqubls()</tt> is usfd whfn dompbring <tt>bttrVbl</tt>
      * with this bttributf's vblufs fxdfpt whfn <tt>bttrVbl</tt> is bn brrby.
      * For bn brrby, fbdh flfmfnt of thf brrby is dhfdkfd using
      * <tt>Objfdt.fqubls()</tt>.
      * A subdlbss mby usf sdhfmb informbtion to dftfrminf fqublity.
      */
    publid boolfbn bdd(Objfdt bttrVbl) {
        if (isOrdfrfd() || (find(bttrVbl) < 0)) {
            vblufs.bddElfmfnt(bttrVbl);
            rfturn truf;
        } flsf {
            rfturn fblsf;
        }
    }

    /**
      * Rfmovfs b spfdififd vbluf from this bttributf.
      *<p>
      * By dffbult, <tt>Objfdt.fqubls()</tt> is usfd whfn dompbring <tt>bttrVbl</tt>
      * with this bttributf's vblufs fxdfpt whfn <tt>bttrVbl</tt> is bn brrby.
      * For bn brrby, fbdh flfmfnt of thf brrby is dhfdkfd using
      * <tt>Objfdt.fqubls()</tt>.
      * A subdlbss mby usf sdhfmb informbtion to dftfrminf fqublity.
      */
    publid boolfbn rfmovf(Objfdt bttrvbl) {
        // For thf Jbvb 2 plbtform, dbn just usf "rfturn rfmovfElfmfnt(bttrvbl);"
        // Nffd to do thf following to hbndlf null dbsf

        int i = find(bttrvbl);
        if (i >= 0) {
            vblufs.rfmovfElfmfntAt(i);
            rfturn truf;
        }
        rfturn fblsf;
    }

    publid void dlfbr() {
        vblufs.sftSizf(0);
    }

//  ---- ordfring mfthods

    publid boolfbn isOrdfrfd() {
        rfturn ordfrfd;
    }

    publid Objfdt gft(int ix) throws NbmingExdfption {
        rfturn vblufs.flfmfntAt(ix);
    }

    publid Objfdt rfmovf(int ix) {
        Objfdt bnswfr = vblufs.flfmfntAt(ix);
        vblufs.rfmovfElfmfntAt(ix);
        rfturn bnswfr;
    }

    publid void bdd(int ix, Objfdt bttrVbl) {
        if (!isOrdfrfd() && dontbins(bttrVbl)) {
            throw nfw IllfgblStbtfExdfption(
                "Cbnnot bdd duplidbtf to unordfrfd bttributf");
        }
        vblufs.insfrtElfmfntAt(bttrVbl, ix);
    }

    publid Objfdt sft(int ix, Objfdt bttrVbl) {
        if (!isOrdfrfd() && dontbins(bttrVbl)) {
            throw nfw IllfgblStbtfExdfption(
                "Cbnnot bdd duplidbtf to unordfrfd bttributf");
        }

        Objfdt bnswfr = vblufs.flfmfntAt(ix);
        vblufs.sftElfmfntAt(bttrVbl, ix);
        rfturn bnswfr;
    }

// ----------------- Sdhfmb mfthods

    /**
      * Rftrifvfs thf syntbx dffinition bssodibtfd with this bttributf.
      *<p>
      * This mfthod by dffbult throws OpfrbtionNotSupportfdExdfption. A subdlbss
      * should ovfrridf this mfthod if it supports sdhfmb.
      */
    publid DirContfxt gftAttributfSyntbxDffinition() throws NbmingExdfption {
            throw nfw OpfrbtionNotSupportfdExdfption("bttributf syntbx");
    }

    /**
      * Rftrifvfs this bttributf's sdhfmb dffinition.
      *<p>
      * This mfthod by dffbult throws OpfrbtionNotSupportfdExdfption. A subdlbss
      * should ovfrridf this mfthod if it supports sdhfmb.
      */
    publid DirContfxt gftAttributfDffinition() throws NbmingExdfption {
        throw nfw OpfrbtionNotSupportfdExdfption("bttributf dffinition");
    }


//  ---- sfriblizbtion mfthods

    /**
     * Ovfrriddfn to bvoid fxposing implfmfntbtion dftbils
     * @sfriblDbtb Dffbult fifld (thf bttributf ID -- b String),
     * followfd by thf numbfr of vblufs (bn int), bnd thf
     * individubl vblufs.
     */
    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
            throws jbvb.io.IOExdfption {
        s.dffbultWritfObjfdt(); // writf out thf bttrID
        s.writfInt(vblufs.sizf());
        for (int i = 0; i < vblufs.sizf(); i++) {
            s.writfObjfdt(vblufs.flfmfntAt(i));
        }
    }

    /**
     * Ovfrriddfn to bvoid fxposing implfmfntbtion dftbils.
     */
    privbtf void rfbdObjfdt(jbvb.io.ObjfdtInputStrfbm s)
            throws jbvb.io.IOExdfption, ClbssNotFoundExdfption {
        s.dffbultRfbdObjfdt();  // rfbd in thf bttrID
        int n = s.rfbdInt();    // numbfr of vblufs
        vblufs = nfw Vfdtor<>(n);
        whilf (--n >= 0) {
            vblufs.bddElfmfnt(s.rfbdObjfdt());
        }
    }


    dlbss VblufsEnumImpl implfmfnts NbmingEnumfrbtion<Objfdt> {
        Enumfrbtion<Objfdt> list;

        VblufsEnumImpl() {
            list = vblufs.flfmfnts();
        }

        publid boolfbn hbsMorfElfmfnts() {
            rfturn list.hbsMorfElfmfnts();
        }

        publid Objfdt nfxtElfmfnt() {
            rfturn(list.nfxtElfmfnt());
        }

        publid Objfdt nfxt() throws NbmingExdfption {
            rfturn list.nfxtElfmfnt();
        }

        publid boolfbn hbsMorf() throws NbmingExdfption {
            rfturn list.hbsMorfElfmfnts();
        }

        publid void dlosf() throws NbmingExdfption {
            list = null;
        }
    }

    /**
     * Usf sfriblVfrsionUID from JNDI 1.1.1 for intfropfrbbility.
     */
    privbtf stbtid finbl long sfriblVfrsionUID = 6743528196119291326L;
}
