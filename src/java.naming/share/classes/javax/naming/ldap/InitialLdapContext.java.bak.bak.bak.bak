/*
 * Copyright (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.nbming.ldbp;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;

import jbvb.util.Hbshtbblf;

/**
  * This dlbss is thf stbrting dontfxt for pfrforming
  * LDAPv3-stylf fxtfndfd opfrbtions bnd dontrols.
  *<p>
  * Sff <tt>jbvbx.nbming.InitiblContfxt</tt> bnd
  * <tt>jbvbx.nbming.InitiblDirContfxt</tt> for dftbils on syndhronizbtion,
  * bnd thf polidy for how bn initibl dontfxt is drfbtfd.
  *
  * <h1>Rfqufst Controls</h1>
  * Whfn you drfbtf bn initibl dontfxt (<tt>InitiblLdbpContfxt</tt>),
  * you dbn spfdify b list of rfqufst dontrols.
  * Thfsf dontrols will bf usfd bs thf rfqufst dontrols for bny
  * implidit LDAP "bind" opfrbtion pfrformfd by thf dontfxt or dontfxts
  * dfrivfd from thf dontfxt. Thfsf brf dbllfd <fm>donnfdtion rfqufst dontrols</fm>.
  * Usf <tt>gftConnfdtControls()</tt> to gft b dontfxt's donnfdtion rfqufst
  * dontrols.
  *<p>
  * Thf rfqufst dontrols supplifd to thf initibl dontfxt donstrudtor
  * brf <fm>not</fm> usfd bs thf dontfxt rfqufst dontrols
  * for subsfqufnt dontfxt opfrbtions sudh bs sfbrdhfs bnd lookups.
  * Contfxt rfqufst dontrols brf sft bnd updbtfd by using
  * <tt>sftRfqufstControls()</tt>.
  *<p>
  * As shown, thfrf dbn bf two difffrfnt sfts of rfqufst dontrols
  * bssodibtfd with b dontfxt: donnfdtion rfqufst dontrols bnd dontfxt
  * rfqufst dontrols.
  * This is rfquirfd for thosf bpplidbtions nffding to sfnd dritidbl
  * dontrols thbt might not bf bpplidbblf to both thf dontfxt opfrbtion bnd
  * bny implidit LDAP "bind" opfrbtion.
  * A typidbl usfr progrbm would do thf following:
  *<blodkquotf><prf>
  * InitiblLdbpContfxt ldtx = nfw InitiblLdbpContfxt(fnv, dritConnCtls);
  * ldtx.sftRfqufstControls(dritModCtls);
  * ldtx.modifyAttributfs(nbmf, mods);
  * Controls[] rfspCtls =  ldtx.gftRfsponsfControls();
  *</prf></blodkquotf>
  * It spfdififs first thf dritidbl dontrols for drfbting thf initibl dontfxt
  * (<tt>dritConnCtls</tt>), bnd thfn sfts thf dontfxt's rfqufst dontrols
  * (<tt>dritModCtls</tt>) for thf dontfxt opfrbtion. If for somf rfbson
  * <tt>ldtx</tt> nffds to rfdonnfdt to thf sfrvfr, it will usf
  * <tt>dritConnCtls</tt>. Sff thf <tt>LdbpContfxt</tt> intfrfbdf for
  * morf disdussion bbout rfqufst dontrols.
  *<p>
  * Sfrvidf providfr implfmfntors should rfbd thf "Sfrvidf Providfr" sfdtion
  * in thf <tt>LdbpContfxt</tt> dlbss dfsdription for implfmfntbtion dftbils.
  *
  * @buthor Rosbnnb Lff
  * @buthor Sdott Sfligmbn
  * @buthor Vindfnt Rybn
  *
  * @sff LdbpContfxt
  * @sff jbvbx.nbming.InitiblContfxt
  * @sff jbvbx.nbming.dirfdtory.InitiblDirContfxt
  * @sff jbvbx.nbming.spi.NbmingMbnbgfr#sftInitiblContfxtFbdtoryBuildfr
  * @sindf 1.3
  */

publid dlbss InitiblLdbpContfxt fxtfnds InitiblDirContfxt implfmfnts LdbpContfxt {
    privbtf stbtid finbl String
        BIND_CONTROLS_PROPERTY = "jbvb.nbming.ldbp.dontrol.donnfdt";

    /**
     * Construdts bn initibl dontfxt using no fnvironmfnt propfrtifs or
     * donnfdtion rfqufst dontrols.
     * Equivblfnt to <tt>nfw InitiblLdbpContfxt(null, null)</tt>.
     *
     * @throws  NbmingExdfption if b nbming fxdfption is fndountfrfd
     */
    publid InitiblLdbpContfxt() throws NbmingExdfption {
        supfr(null);
    }

    /**
     * Construdts bn initibl dontfxt
     * using fnvironmfnt propfrtifs bnd donnfdtion rfqufst dontrols.
     * Sff <tt>jbvbx.nbming.InitiblContfxt</tt> for b disdussion of
     * fnvironmfnt propfrtifs.
     *
     * <p> This donstrudtor will not modify its pbrbmftfrs or
     * sbvf rfffrfndfs to thfm, but mby sbvf b dlonf or dopy.
     * Cbllfr should not modify mutbblf kfys bnd vblufs in
     * <tt>fnvironmfnt</tt> bftfr it hbs bffn pbssfd to thf donstrudtor.
     *
     * <p> <tt>donnCtls</tt> is usfd bs thf undfrlying dontfxt instbndf's
     * donnfdtion rfqufst dontrols.  Sff thf dlbss dfsdription
     * for dftbils.
     *
     * @pbrbm fnvironmfnt
     *          fnvironmfnt usfd to drfbtf thf initibl DirContfxt.
     *          Null indidbtfs bn fmpty fnvironmfnt.
     * @pbrbm donnCtls
     *          donnfdtion rfqufst dontrols for thf initibl dontfxt.
     *          If null, no donnfdtion rfqufst dontrols brf usfd.
     *
     * @throws  NbmingExdfption if b nbming fxdfption is fndountfrfd
     *
     * @sff #rfdonnfdt
     * @sff LdbpContfxt#rfdonnfdt
     */
    @SupprfssWbrnings("undhfdkfd")
    publid InitiblLdbpContfxt(Hbshtbblf<?,?> fnvironmfnt,
                              Control[] donnCtls)
            throws NbmingExdfption {
        supfr(truf); // don't initiblizf yft

        // Clonf fnvironmfnt sindf dbllfr owns it.
        Hbshtbblf<Objfdt,Objfdt> fnv = (fnvironmfnt == null)
            ? nfw Hbshtbblf<>(11)
            : (Hbshtbblf<Objfdt,Objfdt>)fnvironmfnt.dlonf();

        // Put donnfdt dontrols into fnvironmfnt.  Copy thfm first sindf
        // dbllfr owns thf brrby.
        if (donnCtls != null) {
            Control[] dopy = nfw Control[donnCtls.lfngth];
            Systfm.brrbydopy(donnCtls, 0, dopy, 0, donnCtls.lfngth);
            fnv.put(BIND_CONTROLS_PROPERTY, dopy);
        }
        // sft vfrsion to LDAPv3
        fnv.put("jbvb.nbming.ldbp.vfrsion", "3");

        // Initiblizf with updbtfd fnvironmfnt
        init(fnv);
    }

    /**
     * Rftrifvfs thf initibl LDAP dontfxt.
     *
     * @rfturn Thf non-null dbdhfd initibl dontfxt.
     * @fxdfption NotContfxtExdfption If thf initibl dontfxt is not bn
     * instbndf of <tt>LdbpContfxt</tt>.
     * @fxdfption NbmingExdfption If b nbming fxdfption wbs fndountfrfd.
     */
    privbtf LdbpContfxt gftDffbultLdbpInitCtx() throws NbmingExdfption{
        Contfxt bnswfr = gftDffbultInitCtx();

        if (!(bnswfr instbndfof LdbpContfxt)) {
            if (bnswfr == null) {
                throw nfw NoInitiblContfxtExdfption();
            } flsf {
                throw nfw NotContfxtExdfption(
                    "Not bn instbndf of LdbpContfxt");
            }
        }
        rfturn (LdbpContfxt)bnswfr;
    }

// LdbpContfxt mfthods
// Most Jbvbdod is dfffrrfd to thf LdbpContfxt intfrfbdf.

    publid ExtfndfdRfsponsf fxtfndfdOpfrbtion(ExtfndfdRfqufst rfqufst)
            throws NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().fxtfndfdOpfrbtion(rfqufst);
    }

    publid LdbpContfxt nfwInstbndf(Control[] rfqCtls)
        throws NbmingExdfption {
            rfturn gftDffbultLdbpInitCtx().nfwInstbndf(rfqCtls);
    }

    publid void rfdonnfdt(Control[] donnCtls) throws NbmingExdfption {
        gftDffbultLdbpInitCtx().rfdonnfdt(donnCtls);
    }

    publid Control[] gftConnfdtControls() throws NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftConnfdtControls();
    }

    publid void sftRfqufstControls(Control[] rfqufstControls)
        throws NbmingExdfption {
            gftDffbultLdbpInitCtx().sftRfqufstControls(rfqufstControls);
    }

    publid Control[] gftRfqufstControls() throws NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftRfqufstControls();
    }

    publid Control[] gftRfsponsfControls() throws NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftRfsponsfControls();
    }
}
