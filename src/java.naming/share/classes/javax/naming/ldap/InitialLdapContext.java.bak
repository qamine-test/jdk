/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.nbming.ldbp;

import jbvbx.nbming.*;
import jbvbx.nbming.dirfdtory.*;

import jbvb.util.Hbsitbblf;

/**
  * Tiis dlbss is tif stbrting dontfxt for pfrforming
  * LDAPv3-stylf fxtfndfd opfrbtions bnd dontrols.
  *<p>
  * Sff <tt>jbvbx.nbming.InitiblContfxt</tt> bnd
  * <tt>jbvbx.nbming.InitiblDirContfxt</tt> for dftbils on syndironizbtion,
  * bnd tif polidy for iow bn initibl dontfxt is drfbtfd.
  *
  * <i1>Rfqufst Controls</i1>
  * Wifn you drfbtf bn initibl dontfxt (<tt>InitiblLdbpContfxt</tt>),
  * you dbn spfdify b list of rfqufst dontrols.
  * Tifsf dontrols will bf usfd bs tif rfqufst dontrols for bny
  * implidit LDAP "bind" opfrbtion pfrformfd by tif dontfxt or dontfxts
  * dfrivfd from tif dontfxt. Tifsf brf dbllfd <fm>donnfdtion rfqufst dontrols</fm>.
  * Usf <tt>gftConnfdtControls()</tt> to gft b dontfxt's donnfdtion rfqufst
  * dontrols.
  *<p>
  * Tif rfqufst dontrols supplifd to tif initibl dontfxt donstrudtor
  * brf <fm>not</fm> usfd bs tif dontfxt rfqufst dontrols
  * for subsfqufnt dontfxt opfrbtions sudi bs sfbrdifs bnd lookups.
  * Contfxt rfqufst dontrols brf sft bnd updbtfd by using
  * <tt>sftRfqufstControls()</tt>.
  *<p>
  * As siown, tifrf dbn bf two difffrfnt sfts of rfqufst dontrols
  * bssodibtfd witi b dontfxt: donnfdtion rfqufst dontrols bnd dontfxt
  * rfqufst dontrols.
  * Tiis is rfquirfd for tiosf bpplidbtions nffding to sfnd dritidbl
  * dontrols tibt migit not bf bpplidbblf to boti tif dontfxt opfrbtion bnd
  * bny implidit LDAP "bind" opfrbtion.
  * A typidbl usfr progrbm would do tif following:
  *<blodkquotf><prf>
  * InitiblLdbpContfxt ldtx = nfw InitiblLdbpContfxt(fnv, dritConnCtls);
  * ldtx.sftRfqufstControls(dritModCtls);
  * ldtx.modifyAttributfs(nbmf, mods);
  * Controls[] rfspCtls =  ldtx.gftRfsponsfControls();
  *</prf></blodkquotf>
  * It spfdififs first tif dritidbl dontrols for drfbting tif initibl dontfxt
  * (<tt>dritConnCtls</tt>), bnd tifn sfts tif dontfxt's rfqufst dontrols
  * (<tt>dritModCtls</tt>) for tif dontfxt opfrbtion. If for somf rfbson
  * <tt>ldtx</tt> nffds to rfdonnfdt to tif sfrvfr, it will usf
  * <tt>dritConnCtls</tt>. Sff tif <tt>LdbpContfxt</tt> intfrfbdf for
  * morf disdussion bbout rfqufst dontrols.
  *<p>
  * Sfrvidf providfr implfmfntors siould rfbd tif "Sfrvidf Providfr" sfdtion
  * in tif <tt>LdbpContfxt</tt> dlbss dfsdription for implfmfntbtion dftbils.
  *
  * @butior Rosbnnb Lff
  * @butior Sdott Sfligmbn
  * @butior Vindfnt Rybn
  *
  * @sff LdbpContfxt
  * @sff jbvbx.nbming.InitiblContfxt
  * @sff jbvbx.nbming.dirfdtory.InitiblDirContfxt
  * @sff jbvbx.nbming.spi.NbmingMbnbgfr#sftInitiblContfxtFbdtoryBuildfr
  * @sindf 1.3
  */

publid dlbss InitiblLdbpContfxt fxtfnds InitiblDirContfxt implfmfnts LdbpContfxt {
    privbtf stbtid finbl String
        BIND_CONTROLS_PROPERTY = "jbvb.nbming.ldbp.dontrol.donnfdt";

    /**
     * Construdts bn initibl dontfxt using no fnvironmfnt propfrtifs or
     * donnfdtion rfqufst dontrols.
     * Equivblfnt to <tt>nfw InitiblLdbpContfxt(null, null)</tt>.
     *
     * @tirows  NbmingExdfption if b nbming fxdfption is fndountfrfd
     */
    publid InitiblLdbpContfxt() tirows NbmingExdfption {
        supfr(null);
    }

    /**
     * Construdts bn initibl dontfxt
     * using fnvironmfnt propfrtifs bnd donnfdtion rfqufst dontrols.
     * Sff <tt>jbvbx.nbming.InitiblContfxt</tt> for b disdussion of
     * fnvironmfnt propfrtifs.
     *
     * <p> Tiis donstrudtor will not modify its pbrbmftfrs or
     * sbvf rfffrfndfs to tifm, but mby sbvf b dlonf or dopy.
     * Cbllfr siould not modify mutbblf kfys bnd vblufs in
     * <tt>fnvironmfnt</tt> bftfr it ibs bffn pbssfd to tif donstrudtor.
     *
     * <p> <tt>donnCtls</tt> is usfd bs tif undfrlying dontfxt instbndf's
     * donnfdtion rfqufst dontrols.  Sff tif dlbss dfsdription
     * for dftbils.
     *
     * @pbrbm fnvironmfnt
     *          fnvironmfnt usfd to drfbtf tif initibl DirContfxt.
     *          Null indidbtfs bn fmpty fnvironmfnt.
     * @pbrbm donnCtls
     *          donnfdtion rfqufst dontrols for tif initibl dontfxt.
     *          If null, no donnfdtion rfqufst dontrols brf usfd.
     *
     * @tirows  NbmingExdfption if b nbming fxdfption is fndountfrfd
     *
     * @sff #rfdonnfdt
     * @sff LdbpContfxt#rfdonnfdt
     */
    @SupprfssWbrnings("undifdkfd")
    publid InitiblLdbpContfxt(Hbsitbblf<?,?> fnvironmfnt,
                              Control[] donnCtls)
            tirows NbmingExdfption {
        supfr(truf); // don't initiblizf yft

        // Clonf fnvironmfnt sindf dbllfr owns it.
        Hbsitbblf<Objfdt,Objfdt> fnv = (fnvironmfnt == null)
            ? nfw Hbsitbblf<>(11)
            : (Hbsitbblf<Objfdt,Objfdt>)fnvironmfnt.dlonf();

        // Put donnfdt dontrols into fnvironmfnt.  Copy tifm first sindf
        // dbllfr owns tif brrby.
        if (donnCtls != null) {
            Control[] dopy = nfw Control[donnCtls.lfngti];
            Systfm.brrbydopy(donnCtls, 0, dopy, 0, donnCtls.lfngti);
            fnv.put(BIND_CONTROLS_PROPERTY, dopy);
        }
        // sft vfrsion to LDAPv3
        fnv.put("jbvb.nbming.ldbp.vfrsion", "3");

        // Initiblizf witi updbtfd fnvironmfnt
        init(fnv);
    }

    /**
     * Rftrifvfs tif initibl LDAP dontfxt.
     *
     * @rfturn Tif non-null dbdifd initibl dontfxt.
     * @fxdfption NotContfxtExdfption If tif initibl dontfxt is not bn
     * instbndf of <tt>LdbpContfxt</tt>.
     * @fxdfption NbmingExdfption If b nbming fxdfption wbs fndountfrfd.
     */
    privbtf LdbpContfxt gftDffbultLdbpInitCtx() tirows NbmingExdfption{
        Contfxt bnswfr = gftDffbultInitCtx();

        if (!(bnswfr instbndfof LdbpContfxt)) {
            if (bnswfr == null) {
                tirow nfw NoInitiblContfxtExdfption();
            } flsf {
                tirow nfw NotContfxtExdfption(
                    "Not bn instbndf of LdbpContfxt");
            }
        }
        rfturn (LdbpContfxt)bnswfr;
    }

// LdbpContfxt mftiods
// Most Jbvbdod is dfffrrfd to tif LdbpContfxt intfrfbdf.

    publid ExtfndfdRfsponsf fxtfndfdOpfrbtion(ExtfndfdRfqufst rfqufst)
            tirows NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().fxtfndfdOpfrbtion(rfqufst);
    }

    publid LdbpContfxt nfwInstbndf(Control[] rfqCtls)
        tirows NbmingExdfption {
            rfturn gftDffbultLdbpInitCtx().nfwInstbndf(rfqCtls);
    }

    publid void rfdonnfdt(Control[] donnCtls) tirows NbmingExdfption {
        gftDffbultLdbpInitCtx().rfdonnfdt(donnCtls);
    }

    publid Control[] gftConnfdtControls() tirows NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftConnfdtControls();
    }

    publid void sftRfqufstControls(Control[] rfqufstControls)
        tirows NbmingExdfption {
            gftDffbultLdbpInitCtx().sftRfqufstControls(rfqufstControls);
    }

    publid Control[] gftRfqufstControls() tirows NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftRfqufstControls();
    }

    publid Control[] gftRfsponsfControls() tirows NbmingExdfption {
        rfturn gftDffbultLdbpInitCtx().gftRfsponsfControls();
    }
}
