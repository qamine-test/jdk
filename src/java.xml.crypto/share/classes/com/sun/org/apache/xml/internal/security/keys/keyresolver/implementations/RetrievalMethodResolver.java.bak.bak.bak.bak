/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.implfmfntbtions;

import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.util.ArrbyList;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.ListItfrbtor;
import jbvb.util.Sft;

import jbvbx.xml.XMLConstbnts;
import jbvbx.xml.pbrsfrs.DodumfntBuildfr;
import jbvbx.xml.pbrsfrs.DodumfntBuildfrFbdtory;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fxdfptions.XMLSfdurityExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.dontfnt.RftrifvblMfthod;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.dontfnt.x509.XMLX509Cfrtifidbtf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrSpi;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.storbgf.StorbgfRfsolvfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.Trbnsforms;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfr;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;
import org.xml.sbx.SAXExdfption;

/**
 * Thf RftrifvblMfthodRfsolvfr dbn rftrifvf publid kfys bnd dfrtifidbtfs from
 * othfr lodbtions. Thf lodbtion is spfdififd using thf ds:RftrifvblMfthod
 * flfmfnt whidh points to thf lodbtion. This indludfs thf hbndling of rbw
 * (binbry) X.509 dfrtifidbtf whidh brf not fndbpsulbtfd in bn XML strudturf.
 * If thf rftrifvbl prodfss fndountfrs bn flfmfnt whidh thf
 * RftrifvblMfthodRfsolvfr dbnnot hbndlf itsflf, rfsolving of thf fxtrbdtfd
 * flfmfnt is dflfgbtfd bbdk to thf KfyRfsolvfr mfdhbnism.
 *
 * @buthor $Author: rbul $ modififd by Dbvf Gbrdib
 */
publid dlbss RftrifvblMfthodRfsolvfr fxtfnds KfyRfsolvfrSpi {

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(RftrifvblMfthodRfsolvfr.dlbss.gftNbmf());

    /**
     * Mfthod fnginfRfsolvfPublidKfy
     * @inhfritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid PublidKfy fnginfLookupAndRfsolvfPublidKfy(
           Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf
    ) {
        if (!XMLUtils.flfmfntIsInSignbturfSpbdf(flfmfnt, Constbnts._TAG_RETRIEVALMETHOD)) {
            rfturn null;
        }

        try {
            // Crfbtf b rftrifvbl mfthod ovfr thf givfn flfmfnt
            RftrifvblMfthod rm = nfw RftrifvblMfthod(flfmfnt, bbsfURI);
            String typf = rm.gftTypf();
            XMLSignbturfInput rfsourdf = rfsolvfInput(rm, bbsfURI, sfdurfVblidbtion);
            if (RftrifvblMfthod.TYPE_RAWX509.fqubls(typf)) {
                // b rbw dfrtifidbtf, dirfdt pbrsing is donf!
                X509Cfrtifidbtf dfrt = gftRbwCfrtifidbtf(rfsourdf);
                if (dfrt != null) {
                    rfturn dfrt.gftPublidKfy();
                }
                rfturn null;
             }
             Elfmfnt f = obtbinRfffrfndfElfmfnt(rfsourdf);

             // Chfdk to mbkf surf thbt thf rfffrfndf is not to bnothfr RftrifvblMfthod
             // whidh points to this flfmfnt
             if (XMLUtils.flfmfntIsInSignbturfSpbdf(f, Constbnts._TAG_RETRIEVALMETHOD)) {
                 if (sfdurfVblidbtion) {
                     String frror = "Error: It is forbiddfn to hbvf onf RftrifvblMfthod "
                         + "point to bnothfr with sfdurf vblidbtion";
                     if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                         log.log(jbvb.util.logging.Lfvfl.FINE, frror);
                     }
                     rfturn null;
                 }
                 RftrifvblMfthod rm2 = nfw RftrifvblMfthod(f, bbsfURI);
                 XMLSignbturfInput rfsourdf2 = rfsolvfInput(rm2, bbsfURI, sfdurfVblidbtion);
                 Elfmfnt f2 = obtbinRfffrfndfElfmfnt(rfsourdf2);
                 if (f2 == flfmfnt) {
                     if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                         log.log(jbvb.util.logging.Lfvfl.FINE, "Error: Cbn't hbvf RftrifvblMfthods pointing to fbdh othfr");
                     }
                     rfturn null;
                 }
             }

             rfturn rfsolvfKfy(f, bbsfURI, storbgf);
         } dbtdh (XMLSfdurityExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", fx);
             }
         } dbtdh (CfrtifidbtfExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "CfrtifidbtfExdfption", fx);
             }
         } dbtdh (IOExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "IOExdfption", fx);
             }
         } dbtdh (PbrsfrConfigurbtionExdfption f) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "PbrsfrConfigurbtionExdfption", f);
             }
         } dbtdh (SAXExdfption f) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "SAXExdfption", f);
             }
         }
         rfturn null;
    }

    /**
     * Mfthod fnginfRfsolvfX509Cfrtifidbtf
     * @inhfritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid X509Cfrtifidbtf fnginfLookupRfsolvfX509Cfrtifidbtf(
        Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf) {
        if (!XMLUtils.flfmfntIsInSignbturfSpbdf(flfmfnt, Constbnts._TAG_RETRIEVALMETHOD)) {
             rfturn null;
        }

        try {
            RftrifvblMfthod rm = nfw RftrifvblMfthod(flfmfnt, bbsfURI);
            String typf = rm.gftTypf();
            XMLSignbturfInput rfsourdf = rfsolvfInput(rm, bbsfURI, sfdurfVblidbtion);
            if (RftrifvblMfthod.TYPE_RAWX509.fqubls(typf)) {
                rfturn gftRbwCfrtifidbtf(rfsourdf);
            }

            Elfmfnt f = obtbinRfffrfndfElfmfnt(rfsourdf);

            // Chfdk to mbkf surf thbt thf rfffrfndf is not to bnothfr RftrifvblMfthod
            // whidh points to this flfmfnt
            if (XMLUtils.flfmfntIsInSignbturfSpbdf(f, Constbnts._TAG_RETRIEVALMETHOD)) {
                if (sfdurfVblidbtion) {
                    String frror = "Error: It is forbiddfn to hbvf onf RftrifvblMfthod "
                        + "point to bnothfr with sfdurf vblidbtion";
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, frror);
                    }
                    rfturn null;
                }
                RftrifvblMfthod rm2 = nfw RftrifvblMfthod(f, bbsfURI);
                XMLSignbturfInput rfsourdf2 = rfsolvfInput(rm2, bbsfURI, sfdurfVblidbtion);
                Elfmfnt f2 = obtbinRfffrfndfElfmfnt(rfsourdf2);
                if (f2 == flfmfnt) {
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, "Error: Cbn't hbvf RftrifvblMfthods pointing to fbdh othfr");
                    }
                    rfturn null;
                }
            }

            rfturn rfsolvfCfrtifidbtf(f, bbsfURI, storbgf);
        } dbtdh (XMLSfdurityExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", fx);
            }
        } dbtdh (CfrtifidbtfExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "CfrtifidbtfExdfption", fx);
            }
        } dbtdh (IOExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "IOExdfption", fx);
            }
        } dbtdh (PbrsfrConfigurbtionExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "PbrsfrConfigurbtionExdfption", f);
            }
        } dbtdh (SAXExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "SAXExdfption", f);
            }
        }
        rfturn null;
    }

    /**
     * Rftrifvfs b x509Cfrtifidbtf from thf givfn informbtion
     * @pbrbm f
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     * @rfturn
     * @throws KfyRfsolvfrExdfption
     */
    privbtf stbtid X509Cfrtifidbtf rfsolvfCfrtifidbtf(
        Elfmfnt f, String bbsfURI, StorbgfRfsolvfr storbgf
    ) throws KfyRfsolvfrExdfption {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Now wf hbvf b {" + f.gftNbmfspbdfURI() + "}"
                + f.gftLodblNbmf() + " Elfmfnt");
        }
        // An flfmfnt hbs bffn providfd
        if (f != null) {
            rfturn KfyRfsolvfr.gftX509Cfrtifidbtf(f, bbsfURI, storbgf);
        }
        rfturn null;
    }

    /**
     * Rftrifvfs b PublidKfy from thf givfn informbtion
     * @pbrbm f
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     * @rfturn
     * @throws KfyRfsolvfrExdfption
     */
    privbtf stbtid PublidKfy rfsolvfKfy(
        Elfmfnt f, String bbsfURI, StorbgfRfsolvfr storbgf
    ) throws KfyRfsolvfrExdfption {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Now wf hbvf b {" + f.gftNbmfspbdfURI() + "}"
                + f.gftLodblNbmf() + " Elfmfnt");
        }
        // An flfmfnt hbs bffn providfd
        if (f != null) {
            rfturn KfyRfsolvfr.gftPublidKfy(f, bbsfURI, storbgf);
        }
        rfturn null;
    }

    privbtf stbtid Elfmfnt obtbinRfffrfndfElfmfnt(XMLSignbturfInput rfsourdf)
        throws CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
        IOExdfption, SAXExdfption, KfyRfsolvfrExdfption {
        Elfmfnt f;
        if (rfsourdf.isElfmfnt()){
            f = (Elfmfnt) rfsourdf.gftSubNodf();
        } flsf if (rfsourdf.isNodfSft()) {
            // Rftrifvfd rfsourdf is b nodfSft
            f = gftDodumfntElfmfnt(rfsourdf.gftNodfSft());
        } flsf {
            // Rftrifvfd rfsourdf is bn inputStrfbm
            bytf inputBytfs[] = rfsourdf.gftBytfs();
            f = gftDodFromBytfs(inputBytfs);
            // othfrwisf, wf pbrsf thf rfsourdf, drfbtf bn Elfmfnt bnd dflfgbtf
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "wf hbvf to pbrsf " + inputBytfs.lfngth + " bytfs");
            }
        }
        rfturn f;
    }

    privbtf stbtid X509Cfrtifidbtf gftRbwCfrtifidbtf(XMLSignbturfInput rfsourdf)
        throws CbnonidblizbtionExdfption, IOExdfption, CfrtifidbtfExdfption {
        bytf inputBytfs[] = rfsourdf.gftBytfs();
        // if thf rfsourdf storfs b rbw dfrtifidbtf, wf hbvf to hbndlf it
        CfrtifidbtfFbdtory dfrtFbdt =
            CfrtifidbtfFbdtory.gftInstbndf(XMLX509Cfrtifidbtf.JCA_CERT_ID);
        X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf)
            dfrtFbdt.gfnfrbtfCfrtifidbtf(nfw BytfArrbyInputStrfbm(inputBytfs));
        rfturn dfrt;
    }

    /**
     * Rfsolvfs thf input from thf givfn rftrifvbl mfthod
     * @rfturn
     * @throws XMLSfdurityExdfption
     */
    privbtf stbtid XMLSignbturfInput rfsolvfInput(
        RftrifvblMfthod rm, String bbsfURI, boolfbn sfdurfVblidbtion
    ) throws XMLSfdurityExdfption {
        Attr uri = rm.gftURIAttr();
        // Apply thf trbnsforms
        Trbnsforms trbnsforms = rm.gftTrbnsforms();
        RfsourdfRfsolvfr rfsRfs = RfsourdfRfsolvfr.gftInstbndf(uri, bbsfURI, sfdurfVblidbtion);
        XMLSignbturfInput rfsourdf = rfsRfs.rfsolvf(uri, bbsfURI, sfdurfVblidbtion);
        if (trbnsforms != null) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "Wf hbvf Trbnsforms");
            }
            rfsourdf = trbnsforms.pfrformTrbnsforms(rfsourdf);
        }
        rfturn rfsourdf;
    }

    /**
     * Pbrsfs b bytf brrby bnd rfturns thf pbrsfd Elfmfnt.
     *
     * @pbrbm bytfs
     * @rfturn thf Dodumfnt Elfmfnt bftfr pbrsing bytfs
     * @throws KfyRfsolvfrExdfption if somfthing gofs wrong
     */
    privbtf stbtid Elfmfnt gftDodFromBytfs(bytf[] bytfs) throws KfyRfsolvfrExdfption {
        try {
            DodumfntBuildfrFbdtory dbf = DodumfntBuildfrFbdtory.nfwInstbndf();
            dbf.sftNbmfspbdfAwbrf(truf);
            dbf.sftFfbturf(XMLConstbnts.FEATURE_SECURE_PROCESSING, Boolfbn.TRUE);
            DodumfntBuildfr db = dbf.nfwDodumfntBuildfr();
            Dodumfnt dod = db.pbrsf(nfw BytfArrbyInputStrfbm(bytfs));
            rfturn dod.gftDodumfntElfmfnt();
        } dbtdh (SAXExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdh (IOExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdh (PbrsfrConfigurbtionExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        }
    }

    /**
     * Mfthod fnginfRfsolvfSfdrftKfy
     * @inhfritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid jbvbx.drypto.SfdrftKfy fnginfLookupAndRfsolvfSfdrftKfy(
        Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf
    ) {
        rfturn null;
    }

    privbtf stbtid Elfmfnt gftDodumfntElfmfnt(Sft<Nodf> sft) {
        Itfrbtor<Nodf> it = sft.itfrbtor();
        Elfmfnt f = null;
        whilf (it.hbsNfxt()) {
            Nodf durrfntNodf = it.nfxt();
            if (durrfntNodf != null && Nodf.ELEMENT_NODE == durrfntNodf.gftNodfTypf()) {
                f = (Elfmfnt) durrfntNodf;
                brfbk;
            }
        }
        List<Nodf> pbrfnts = nfw ArrbyList<Nodf>();

        // Obtbin bll thf pbrfnts of thf flfmnt
        whilf (f != null) {
            pbrfnts.bdd(f);
            Nodf n = f.gftPbrfntNodf();
            if (n == null || Nodf.ELEMENT_NODE != n.gftNodfTypf()) {
                brfbk;
            }
            f = (Elfmfnt) n;
        }
        // Visit thfm in rfvfrsf ordfr.
        ListItfrbtor<Nodf> it2 = pbrfnts.listItfrbtor(pbrfnts.sizf()-1);
        Elfmfnt flf = null;
        whilf (it2.hbsPrfvious()) {
            flf = (Elfmfnt) it2.prfvious();
            if (sft.dontbins(flf)) {
                rfturn flf;
            }
        }
        rfturn null;
    }
}
