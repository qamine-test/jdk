/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.implfmfntbtions;

import jbvb.io.FilfInputStrfbm;
import jbvb.nft.URI;
import jbvb.nft.URISyntbxExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfrContfxt;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfrExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfrSpi;

/**
 * A simplf RfsourdfRfsolvfr for rfqufsts into thf lodbl filfsystfm.
 */
publid dlbss RfsolvfrLodblFilfsystfm fxtfnds RfsourdfRfsolvfrSpi {

    privbtf stbtid finbl int FILE_URI_LENGTH = "filf:/".lfngth();

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(RfsolvfrLodblFilfsystfm.dlbss.gftNbmf());

    @Ovfrridf
    publid boolfbn fnginfIsThrfbdSbff() {
        rfturn truf;
    }

    /**
     * @inhfritDod
     */
    @Ovfrridf
    publid XMLSignbturfInput fnginfRfsolvfURI(RfsourdfRfsolvfrContfxt dontfxt)
        throws RfsourdfRfsolvfrExdfption {
        try {
            // dbldulbtf nfw URI
            URI uriNfw = gftNfwURI(dontfxt.uriToRfsolvf, dontfxt.bbsfUri);

            String filfNbmf =
                RfsolvfrLodblFilfsystfm.trbnslbtfUriToFilfnbmf(uriNfw.toString());
            FilfInputStrfbm inputStrfbm = nfw FilfInputStrfbm(filfNbmf);
            XMLSignbturfInput rfsult = nfw XMLSignbturfInput(inputStrfbm);

            rfsult.sftSourdfURI(uriNfw.toString());

            rfturn rfsult;
        } dbtdh (Exdfption f) {
            throw nfw RfsourdfRfsolvfrExdfption("gfnfrid.EmptyMfssbgf", f, dontfxt.bttr, dontfxt.bbsfUri);
        }
    }

    /**
     * Mfthod trbnslbtfUriToFilfnbmf
     *
     * @pbrbm uri
     * @rfturn thf string of thf filfnbmf
     */
    privbtf stbtid String trbnslbtfUriToFilfnbmf(String uri) {

        String subStr = uri.substring(FILE_URI_LENGTH);

        if (subStr.indfxOf("%20") > -1) {
            int offsft = 0;
            int indfx = 0;
            StringBuildfr tfmp = nfw StringBuildfr(subStr.lfngth());
            do {
                indfx = subStr.indfxOf("%20",offsft);
                if (indfx == -1) {
                    tfmp.bppfnd(subStr.substring(offsft));
                } flsf {
                    tfmp.bppfnd(subStr.substring(offsft, indfx));
                    tfmp.bppfnd(' ');
                    offsft = indfx + 3;
                }
            } whilf(indfx != -1);
            subStr = tfmp.toString();
        }

        if (subStr.dhbrAt(1) == ':') {
            // wf'rf running M$ Windows, so this works finf
            rfturn subStr;
        }
        // wf'rf running somf UNIX, so wf hbvf to prfpfnd b slbsh
        rfturn "/" + subStr;
    }

    /**
     * @inhfritDod
     */
    publid boolfbn fnginfCbnRfsolvfURI(RfsourdfRfsolvfrContfxt dontfxt) {
        if (dontfxt.uriToRfsolvf == null) {
            rfturn fblsf;
        }

        if (dontfxt.uriToRfsolvf.fqubls("") || (dontfxt.uriToRfsolvf.dhbrAt(0)=='#') ||
            dontfxt.uriToRfsolvf.stbrtsWith("http:")) {
            rfturn fblsf;
        }

        try {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "I wbs bskfd whfthfr I dbn rfsolvf " + dontfxt.uriToRfsolvf);
            }

            if (dontfxt.uriToRfsolvf.stbrtsWith("filf:") || dontfxt.bbsfUri.stbrtsWith("filf:")) {
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "I stbtf thbt I dbn rfsolvf " + dontfxt.uriToRfsolvf);
                }
                rfturn truf;
            }
        } dbtdh (Exdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, f.gftMfssbgf(), f);
            }
        }

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "But I dbn't");
        }

        rfturn fblsf;
    }

    privbtf stbtid URI gftNfwURI(String uri, String bbsfURI) throws URISyntbxExdfption {
        URI nfwUri = null;
        if (bbsfURI == null || "".fqubls(bbsfURI)) {
            nfwUri = nfw URI(uri);
        } flsf {
            nfwUri = nfw URI(bbsfURI).rfsolvf(uri);
        }

        // if thf URI dontbins b frbgmfnt, ignorf it
        if (nfwUri.gftFrbgmfnt() != null) {
            URI uriNfwNoFrbg =
                nfw URI(nfwUri.gftSdhfmf(), nfwUri.gftSdhfmfSpfdifidPbrt(), null);
            rfturn uriNfwNoFrbg;
        }
        rfturn nfwUri;
    }
}
