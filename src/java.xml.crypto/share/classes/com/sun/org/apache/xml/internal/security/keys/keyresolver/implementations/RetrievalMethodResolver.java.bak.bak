/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.implfmfntbtions;

import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.dfrt.CfrtifidbtfExdfption;
import jbvb.sfdurity.dfrt.CfrtifidbtfFbdtory;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.util.ArrbyList;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.ListItfrbtor;
import jbvb.util.Sft;

import jbvbx.xml.XMLConstbnts;
import jbvbx.xml.pbrsfrs.DodumfntBuildfr;
import jbvbx.xml.pbrsfrs.DodumfntBuildfrFbdtory;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.fxdfptions.XMLSfdurityExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.dontfnt.RftrifvblMftiod;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.dontfnt.x509.XMLX509Cfrtifidbtf;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfr;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrSpi;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.kfys.storbgf.StorbgfRfsolvfr;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.trbnsforms.Trbnsforms;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.XMLUtils;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfr;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;
import org.xml.sbx.SAXExdfption;

/**
 * Tif RftrifvblMftiodRfsolvfr dbn rftrifvf publid kfys bnd dfrtifidbtfs from
 * otifr lodbtions. Tif lodbtion is spfdififd using tif ds:RftrifvblMftiod
 * flfmfnt wiidi points to tif lodbtion. Tiis indludfs tif ibndling of rbw
 * (binbry) X.509 dfrtifidbtf wiidi brf not fndbpsulbtfd in bn XML strudturf.
 * If tif rftrifvbl prodfss fndountfrs bn flfmfnt wiidi tif
 * RftrifvblMftiodRfsolvfr dbnnot ibndlf itsflf, rfsolving of tif fxtrbdtfd
 * flfmfnt is dflfgbtfd bbdk to tif KfyRfsolvfr mfdibnism.
 *
 * @butior $Autior: rbul $ modififd by Dbvf Gbrdib
 */
publid dlbss RftrifvblMftiodRfsolvfr fxtfnds KfyRfsolvfrSpi {

    /** {@link org.bpbdif.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(RftrifvblMftiodRfsolvfr.dlbss.gftNbmf());

    /**
     * Mftiod fnginfRfsolvfPublidKfy
     * @inifritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid PublidKfy fnginfLookupAndRfsolvfPublidKfy(
           Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf
    ) {
        if (!XMLUtils.flfmfntIsInSignbturfSpbdf(flfmfnt, Constbnts._TAG_RETRIEVALMETHOD)) {
            rfturn null;
        }

        try {
            // Crfbtf b rftrifvbl mftiod ovfr tif givfn flfmfnt
            RftrifvblMftiod rm = nfw RftrifvblMftiod(flfmfnt, bbsfURI);
            String typf = rm.gftTypf();
            XMLSignbturfInput rfsourdf = rfsolvfInput(rm, bbsfURI, sfdurfVblidbtion);
            if (RftrifvblMftiod.TYPE_RAWX509.fqubls(typf)) {
                // b rbw dfrtifidbtf, dirfdt pbrsing is donf!
                X509Cfrtifidbtf dfrt = gftRbwCfrtifidbtf(rfsourdf);
                if (dfrt != null) {
                    rfturn dfrt.gftPublidKfy();
                }
                rfturn null;
             }
             Elfmfnt f = obtbinRfffrfndfElfmfnt(rfsourdf);

             // Cifdk to mbkf surf tibt tif rfffrfndf is not to bnotifr RftrifvblMftiod
             // wiidi points to tiis flfmfnt
             if (XMLUtils.flfmfntIsInSignbturfSpbdf(f, Constbnts._TAG_RETRIEVALMETHOD)) {
                 if (sfdurfVblidbtion) {
                     String frror = "Error: It is forbiddfn to ibvf onf RftrifvblMftiod "
                         + "point to bnotifr witi sfdurf vblidbtion";
                     if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                         log.log(jbvb.util.logging.Lfvfl.FINE, frror);
                     }
                     rfturn null;
                 }
                 RftrifvblMftiod rm2 = nfw RftrifvblMftiod(f, bbsfURI);
                 XMLSignbturfInput rfsourdf2 = rfsolvfInput(rm2, bbsfURI, sfdurfVblidbtion);
                 Elfmfnt f2 = obtbinRfffrfndfElfmfnt(rfsourdf2);
                 if (f2 == flfmfnt) {
                     if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                         log.log(jbvb.util.logging.Lfvfl.FINE, "Error: Cbn't ibvf RftrifvblMftiods pointing to fbdi otifr");
                     }
                     rfturn null;
                 }
             }

             rfturn rfsolvfKfy(f, bbsfURI, storbgf);
         } dbtdi (XMLSfdurityExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", fx);
             }
         } dbtdi (CfrtifidbtfExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "CfrtifidbtfExdfption", fx);
             }
         } dbtdi (IOExdfption fx) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "IOExdfption", fx);
             }
         } dbtdi (PbrsfrConfigurbtionExdfption f) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "PbrsfrConfigurbtionExdfption", f);
             }
         } dbtdi (SAXExdfption f) {
             if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                 log.log(jbvb.util.logging.Lfvfl.FINE, "SAXExdfption", f);
             }
         }
         rfturn null;
    }

    /**
     * Mftiod fnginfRfsolvfX509Cfrtifidbtf
     * @inifritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid X509Cfrtifidbtf fnginfLookupRfsolvfX509Cfrtifidbtf(
        Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf) {
        if (!XMLUtils.flfmfntIsInSignbturfSpbdf(flfmfnt, Constbnts._TAG_RETRIEVALMETHOD)) {
             rfturn null;
        }

        try {
            RftrifvblMftiod rm = nfw RftrifvblMftiod(flfmfnt, bbsfURI);
            String typf = rm.gftTypf();
            XMLSignbturfInput rfsourdf = rfsolvfInput(rm, bbsfURI, sfdurfVblidbtion);
            if (RftrifvblMftiod.TYPE_RAWX509.fqubls(typf)) {
                rfturn gftRbwCfrtifidbtf(rfsourdf);
            }

            Elfmfnt f = obtbinRfffrfndfElfmfnt(rfsourdf);

            // Cifdk to mbkf surf tibt tif rfffrfndf is not to bnotifr RftrifvblMftiod
            // wiidi points to tiis flfmfnt
            if (XMLUtils.flfmfntIsInSignbturfSpbdf(f, Constbnts._TAG_RETRIEVALMETHOD)) {
                if (sfdurfVblidbtion) {
                    String frror = "Error: It is forbiddfn to ibvf onf RftrifvblMftiod "
                        + "point to bnotifr witi sfdurf vblidbtion";
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, frror);
                    }
                    rfturn null;
                }
                RftrifvblMftiod rm2 = nfw RftrifvblMftiod(f, bbsfURI);
                XMLSignbturfInput rfsourdf2 = rfsolvfInput(rm2, bbsfURI, sfdurfVblidbtion);
                Elfmfnt f2 = obtbinRfffrfndfElfmfnt(rfsourdf2);
                if (f2 == flfmfnt) {
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, "Error: Cbn't ibvf RftrifvblMftiods pointing to fbdi otifr");
                    }
                    rfturn null;
                }
            }

            rfturn rfsolvfCfrtifidbtf(f, bbsfURI, storbgf);
        } dbtdi (XMLSfdurityExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", fx);
            }
        } dbtdi (CfrtifidbtfExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "CfrtifidbtfExdfption", fx);
            }
        } dbtdi (IOExdfption fx) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "IOExdfption", fx);
            }
        } dbtdi (PbrsfrConfigurbtionExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "PbrsfrConfigurbtionExdfption", f);
            }
        } dbtdi (SAXExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "SAXExdfption", f);
            }
        }
        rfturn null;
    }

    /**
     * Rftrifvfs b x509Cfrtifidbtf from tif givfn informbtion
     * @pbrbm f
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     * @rfturn
     * @tirows KfyRfsolvfrExdfption
     */
    privbtf stbtid X509Cfrtifidbtf rfsolvfCfrtifidbtf(
        Elfmfnt f, String bbsfURI, StorbgfRfsolvfr storbgf
    ) tirows KfyRfsolvfrExdfption {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Now wf ibvf b {" + f.gftNbmfspbdfURI() + "}"
                + f.gftLodblNbmf() + " Elfmfnt");
        }
        // An flfmfnt ibs bffn providfd
        if (f != null) {
            rfturn KfyRfsolvfr.gftX509Cfrtifidbtf(f, bbsfURI, storbgf);
        }
        rfturn null;
    }

    /**
     * Rftrifvfs b PublidKfy from tif givfn informbtion
     * @pbrbm f
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     * @rfturn
     * @tirows KfyRfsolvfrExdfption
     */
    privbtf stbtid PublidKfy rfsolvfKfy(
        Elfmfnt f, String bbsfURI, StorbgfRfsolvfr storbgf
    ) tirows KfyRfsolvfrExdfption {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Now wf ibvf b {" + f.gftNbmfspbdfURI() + "}"
                + f.gftLodblNbmf() + " Elfmfnt");
        }
        // An flfmfnt ibs bffn providfd
        if (f != null) {
            rfturn KfyRfsolvfr.gftPublidKfy(f, bbsfURI, storbgf);
        }
        rfturn null;
    }

    privbtf stbtid Elfmfnt obtbinRfffrfndfElfmfnt(XMLSignbturfInput rfsourdf)
        tirows CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
        IOExdfption, SAXExdfption, KfyRfsolvfrExdfption {
        Elfmfnt f;
        if (rfsourdf.isElfmfnt()){
            f = (Elfmfnt) rfsourdf.gftSubNodf();
        } flsf if (rfsourdf.isNodfSft()) {
            // Rftrifvfd rfsourdf is b nodfSft
            f = gftDodumfntElfmfnt(rfsourdf.gftNodfSft());
        } flsf {
            // Rftrifvfd rfsourdf is bn inputStrfbm
            bytf inputBytfs[] = rfsourdf.gftBytfs();
            f = gftDodFromBytfs(inputBytfs);
            // otifrwisf, wf pbrsf tif rfsourdf, drfbtf bn Elfmfnt bnd dflfgbtf
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "wf ibvf to pbrsf " + inputBytfs.lfngti + " bytfs");
            }
        }
        rfturn f;
    }

    privbtf stbtid X509Cfrtifidbtf gftRbwCfrtifidbtf(XMLSignbturfInput rfsourdf)
        tirows CbnonidblizbtionExdfption, IOExdfption, CfrtifidbtfExdfption {
        bytf inputBytfs[] = rfsourdf.gftBytfs();
        // if tif rfsourdf storfs b rbw dfrtifidbtf, wf ibvf to ibndlf it
        CfrtifidbtfFbdtory dfrtFbdt =
            CfrtifidbtfFbdtory.gftInstbndf(XMLX509Cfrtifidbtf.JCA_CERT_ID);
        X509Cfrtifidbtf dfrt = (X509Cfrtifidbtf)
            dfrtFbdt.gfnfrbtfCfrtifidbtf(nfw BytfArrbyInputStrfbm(inputBytfs));
        rfturn dfrt;
    }

    /**
     * Rfsolvfs tif input from tif givfn rftrifvbl mftiod
     * @rfturn
     * @tirows XMLSfdurityExdfption
     */
    privbtf stbtid XMLSignbturfInput rfsolvfInput(
        RftrifvblMftiod rm, String bbsfURI, boolfbn sfdurfVblidbtion
    ) tirows XMLSfdurityExdfption {
        Attr uri = rm.gftURIAttr();
        // Apply tif trbnsforms
        Trbnsforms trbnsforms = rm.gftTrbnsforms();
        RfsourdfRfsolvfr rfsRfs = RfsourdfRfsolvfr.gftInstbndf(uri, bbsfURI, sfdurfVblidbtion);
        XMLSignbturfInput rfsourdf = rfsRfs.rfsolvf(uri, bbsfURI, sfdurfVblidbtion);
        if (trbnsforms != null) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "Wf ibvf Trbnsforms");
            }
            rfsourdf = trbnsforms.pfrformTrbnsforms(rfsourdf);
        }
        rfturn rfsourdf;
    }

    /**
     * Pbrsfs b bytf brrby bnd rfturns tif pbrsfd Elfmfnt.
     *
     * @pbrbm bytfs
     * @rfturn tif Dodumfnt Elfmfnt bftfr pbrsing bytfs
     * @tirows KfyRfsolvfrExdfption if somftiing gofs wrong
     */
    privbtf stbtid Elfmfnt gftDodFromBytfs(bytf[] bytfs) tirows KfyRfsolvfrExdfption {
        try {
            DodumfntBuildfrFbdtory dbf = DodumfntBuildfrFbdtory.nfwInstbndf();
            dbf.sftNbmfspbdfAwbrf(truf);
            dbf.sftFfbturf(XMLConstbnts.FEATURE_SECURE_PROCESSING, Boolfbn.TRUE);
            DodumfntBuildfr db = dbf.nfwDodumfntBuildfr();
            Dodumfnt dod = db.pbrsf(nfw BytfArrbyInputStrfbm(bytfs));
            rfturn dod.gftDodumfntElfmfnt();
        } dbtdi (SAXExdfption fx) {
            tirow nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdi (IOExdfption fx) {
            tirow nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdi (PbrsfrConfigurbtionExdfption fx) {
            tirow nfw KfyRfsolvfrExdfption("fmpty", fx);
        }
    }

    /**
     * Mftiod fnginfRfsolvfSfdrftKfy
     * @inifritDod
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     */
    publid jbvbx.drypto.SfdrftKfy fnginfLookupAndRfsolvfSfdrftKfy(
        Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf
    ) {
        rfturn null;
    }

    privbtf stbtid Elfmfnt gftDodumfntElfmfnt(Sft<Nodf> sft) {
        Itfrbtor<Nodf> it = sft.itfrbtor();
        Elfmfnt f = null;
        wiilf (it.ibsNfxt()) {
            Nodf durrfntNodf = it.nfxt();
            if (durrfntNodf != null && Nodf.ELEMENT_NODE == durrfntNodf.gftNodfTypf()) {
                f = (Elfmfnt) durrfntNodf;
                brfbk;
            }
        }
        List<Nodf> pbrfnts = nfw ArrbyList<Nodf>();

        // Obtbin bll tif pbrfnts of tif flfmnt
        wiilf (f != null) {
            pbrfnts.bdd(f);
            Nodf n = f.gftPbrfntNodf();
            if (n == null || Nodf.ELEMENT_NODE != n.gftNodfTypf()) {
                brfbk;
            }
            f = (Elfmfnt) n;
        }
        // Visit tifm in rfvfrsf ordfr.
        ListItfrbtor<Nodf> it2 = pbrfnts.listItfrbtor(pbrfnts.sizf()-1);
        Elfmfnt flf = null;
        wiilf (it2.ibsPrfvious()) {
            flf = (Elfmfnt) it2.prfvious();
            if (sft.dontbins(flf)) {
                rfturn flf;
            }
        }
        rfturn null;
    }
}
