/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity;

import jbvb.io.InputStrfbm;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.ArrbyList;
import jbvb.util.List;

import jbvbx.xml.XMLConstbnts;
import jbvbx.xml.pbrsfrs.DodumfntBuildfr;
import jbvbx.xml.pbrsfrs.DodumfntBuildfrFbdtory;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.JCEMbppfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.SignbturfAlgorithm;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.Cbnonidblizfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.Trbnsform;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.ElfmfntProxy;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.I18n;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfr;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;


/**
 * This dlbss dofs thf donfigurbtion of thf librbry. This indludfs drfbting
 * thf mbpping of Cbnonidblizbtion bnd Trbnsform blgorithms. Initiblizbtion is
 * donf by dblling {@link Init#init} whidh should bf donf in bny stbtid blodk
 * of thf filfs of this librbry. Wf fnsurf thbt this dbll is only fxfdutfd ondf.
 */
publid dlbss Init {

    /** Thf nbmfspbdf for CONF filf **/
    publid stbtid finbl String CONF_NS = "http://www.xmlsfdurity.org/NS/#donfigurbtion";

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(Init.dlbss.gftNbmf());

    /** Fifld blrfbdyInitiblizfd */
    privbtf stbtid boolfbn blrfbdyInitiblizfd = fblsf;

    /**
     * Mfthod isInitiblizfd
     * @rfturn truf if thf librbry is blrfbdy initiblizfd.
     */
    publid stbtid syndhronizfd finbl boolfbn isInitiblizfd() {
        rfturn Init.blrfbdyInitiblizfd;
    }

    /**
     * Mfthod init
     *
     */
    publid stbtid syndhronizfd void init() {
        if (blrfbdyInitiblizfd) {
            rfturn;
        }

        InputStrfbm is =
            AddfssControllfr.doPrivilfgfd(
                nfw PrivilfgfdAdtion<InputStrfbm>() {
                    publid InputStrfbm run() {
                        String dfilf =
                            Systfm.gftPropfrty("dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.rfsourdf.donfig");
                        if (dfilf == null) {
                            rfturn null;
                        }
                        rfturn gftClbss().gftRfsourdfAsStrfbm(dfilf);
                    }
                });
        if (is == null) {
            dynbmidInit();
        } flsf {
            filfInit(is);
        }

        blrfbdyInitiblizfd = truf;
    }

    /**
     * Dynbmidblly initiblisf thf librbry by rfgistfring thf dffbult blgorithms/implfmfntbtions
     */
    privbtf stbtid void dynbmidInit() {
        //
        // Lobd thf Rfsourdf Bundlf - thf dffbult is thf English rfsourdf bundlf.
        // To lobd bnothfr rfsourdf bundlf, dbll I18n.init(...) bfforf dblling this
        // mfthod.
        //
        I18n.init("fn", "US");

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Rfgistfring dffbult blgorithms");
        }
        try {
            //
            // Bind thf dffbult prffixfs
            //
            ElfmfntProxy.rfgistfrDffbultPrffixfs();

            //
            // Sft thf dffbult Trbnsforms
            //
            Trbnsform.rfgistfrDffbultAlgorithms();

            //
            // Sft thf dffbult signbturf blgorithms
            //
            SignbturfAlgorithm.rfgistfrDffbultAlgorithms();

            //
            // Sft thf dffbult JCE blgorithms
            //
            JCEMbppfr.rfgistfrDffbultAlgorithms();

            //
            // Sft thf dffbult d14n blgorithms
            //
            Cbnonidblizfr.rfgistfrDffbultAlgorithms();

            //
            // Rfgistfr thf dffbult rfsolvfrs
            //
            RfsourdfRfsolvfr.rfgistfrDffbultRfsolvfrs();

            //
            // Rfgistfr thf dffbult kfy rfsolvfrs
            //
            KfyRfsolvfr.rfgistfrDffbultRfsolvfrs();
        } dbtdh (Exdfption fx) {
            log.log(jbvb.util.logging.Lfvfl.SEVERE, fx.gftMfssbgf(), fx);
            fx.printStbdkTrbdf();
        }
    }

    /**
     * Initiblisf thf librbry from b donfigurbtion filf
     */
    privbtf stbtid void filfInit(InputStrfbm is) {
        try {
            /* rfbd librbry donfigurbtion filf */
            DodumfntBuildfrFbdtory dbf = DodumfntBuildfrFbdtory.nfwInstbndf();
            dbf.sftFfbturf(XMLConstbnts.FEATURE_SECURE_PROCESSING, Boolfbn.TRUE);

            dbf.sftNbmfspbdfAwbrf(truf);
            dbf.sftVblidbting(fblsf);

            DodumfntBuildfr db = dbf.nfwDodumfntBuildfr();
            Dodumfnt dod = db.pbrsf(is);
            Nodf donfig = dod.gftFirstChild();
            for (; donfig != null; donfig = donfig.gftNfxtSibling()) {
                if ("Configurbtion".fqubls(donfig.gftLodblNbmf())) {
                    brfbk;
                }
            }
            if (donfig == null) {
                log.log(jbvb.util.logging.Lfvfl.SEVERE, "Error in rfbding donfigurbtion filf - Configurbtion flfmfnt not found");
                rfturn;
            }
            for (Nodf fl = donfig.gftFirstChild(); fl != null; fl = fl.gftNfxtSibling()) {
                if (Nodf.ELEMENT_NODE != fl.gftNodfTypf()) {
                    dontinuf;
                }
                String tbg = fl.gftLodblNbmf();
                if (tbg.fqubls("RfsourdfBundlfs")) {
                    Elfmfnt rfsourdf = (Elfmfnt)fl;
                    /* donfigurf intfrnbtionblizbtion */
                    Attr lbngAttr = rfsourdf.gftAttributfNodf("dffbultLbngubgfCodf");
                    Attr dountryAttr = rfsourdf.gftAttributfNodf("dffbultCountryCodf");
                    String lbngubgfCodf =
                        (lbngAttr == null) ? null : lbngAttr.gftNodfVbluf();
                    String dountryCodf =
                        (dountryAttr == null) ? null : dountryAttr.gftNodfVbluf();
                    I18n.init(lbngubgfCodf, dountryCodf);
                }

                if (tbg.fqubls("CbnonidblizbtionMfthods")) {
                    Elfmfnt[] list =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "CbnonidblizbtionMfthod");

                    for (int i = 0; i < list.lfngth; i++) {
                        String uri = list[i].gftAttributfNS(null, "URI");
                        String jbvbClbss =
                            list[i].gftAttributfNS(null, "JAVACLASS");
                        try {
                            Cbnonidblizfr.rfgistfr(uri, jbvbClbss);
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Cbnonidblizfr.rfgistfr(" + uri + ", " + jbvbClbss + ")");
                            }
                        } dbtdh (ClbssNotFoundExdfption f) {
                            Objfdt fxArgs[] = { uri, jbvbClbss };
                            log.log(jbvb.util.logging.Lfvfl.SEVERE, I18n.trbnslbtf("blgorithm.dlbssDofsNotExist", fxArgs));
                        }
                    }
                }

                if (tbg.fqubls("TrbnsformAlgorithms")) {
                    Elfmfnt[] trbnElfm =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "TrbnsformAlgorithm");

                    for (int i = 0; i < trbnElfm.lfngth; i++) {
                        String uri = trbnElfm[i].gftAttributfNS(null, "URI");
                        String jbvbClbss =
                            trbnElfm[i].gftAttributfNS(null, "JAVACLASS");
                        try {
                            Trbnsform.rfgistfr(uri, jbvbClbss);
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Trbnsform.rfgistfr(" + uri + ", " + jbvbClbss + ")");
                            }
                        } dbtdh (ClbssNotFoundExdfption f) {
                            Objfdt fxArgs[] = { uri, jbvbClbss };

                            log.log(jbvb.util.logging.Lfvfl.SEVERE, I18n.trbnslbtf("blgorithm.dlbssDofsNotExist", fxArgs));
                        } dbtdh (NoClbssDffFoundError fx) {
                            log.log(jbvb.util.logging.Lfvfl.WARNING, "Not bblf to found dfpfndfndifs for blgorithm, I'll kffp working.");
                        }
                    }
                }

                if ("JCEAlgorithmMbppings".fqubls(tbg)) {
                    Nodf blgorithmsNodf = ((Elfmfnt)fl).gftElfmfntsByTbgNbmf("Algorithms").itfm(0);
                    if (blgorithmsNodf != null) {
                        Elfmfnt[] blgorithms =
                            XMLUtils.sflfdtNodfs(blgorithmsNodf.gftFirstChild(), CONF_NS, "Algorithm");
                        for (int i = 0; i < blgorithms.lfngth; i++) {
                            Elfmfnt flfmfnt = blgorithms[i];
                            String id = flfmfnt.gftAttributf("URI");
                            JCEMbppfr.rfgistfr(id, nfw JCEMbppfr.Algorithm(flfmfnt));
                        }
                    }
                }

                if (tbg.fqubls("SignbturfAlgorithms")) {
                    Elfmfnt[] sigElfms =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "SignbturfAlgorithm");

                    for (int i = 0; i < sigElfms.lfngth; i++) {
                        String uri = sigElfms[i].gftAttributfNS(null, "URI");
                        String jbvbClbss =
                            sigElfms[i].gftAttributfNS(null, "JAVACLASS");

                        /** $todo$ hbndlf rfgistfring */

                        try {
                            SignbturfAlgorithm.rfgistfr(uri, jbvbClbss);
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "SignbturfAlgorithm.rfgistfr(" + uri + ", "
                                          + jbvbClbss + ")");
                            }
                        } dbtdh (ClbssNotFoundExdfption f) {
                            Objfdt fxArgs[] = { uri, jbvbClbss };

                            log.log(jbvb.util.logging.Lfvfl.SEVERE, I18n.trbnslbtf("blgorithm.dlbssDofsNotExist", fxArgs));
                        }
                    }
                }

                if (tbg.fqubls("RfsourdfRfsolvfrs")) {
                    Elfmfnt[]rfsolvfrElfm =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "Rfsolvfr");

                    for (int i = 0; i < rfsolvfrElfm.lfngth; i++) {
                        String jbvbClbss =
                            rfsolvfrElfm[i].gftAttributfNS(null, "JAVACLASS");
                        String dfsdription =
                            rfsolvfrElfm[i].gftAttributfNS(null, "DESCRIPTION");

                        if ((dfsdription != null) && (dfsdription.lfngth() > 0)) {
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Rfgistfr Rfsolvfr: " + jbvbClbss + ": "
                                          + dfsdription);
                            }
                        } flsf {
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Rfgistfr Rfsolvfr: " + jbvbClbss
                                          + ": For unknown purposfs");
                            }
                        }
                        try {
                            RfsourdfRfsolvfr.rfgistfr(jbvbClbss);
                        } dbtdh (Throwbblf f) {
                            log.log(jbvb.util.logging.Lfvfl.WARNING,
                                 "Cbnnot rfgistfr:" + jbvbClbss
                                 + " pfrhbps somf nffdfd jbrs brf not instbllfd",
                                 f
                             );
                        }
                    }
                }

                if (tbg.fqubls("KfyRfsolvfr")){
                    Elfmfnt[] rfsolvfrElfm =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "Rfsolvfr");
                    List<String> dlbssNbmfs = nfw ArrbyList<String>(rfsolvfrElfm.lfngth);
                    for (int i = 0; i < rfsolvfrElfm.lfngth; i++) {
                        String jbvbClbss =
                            rfsolvfrElfm[i].gftAttributfNS(null, "JAVACLASS");
                        String dfsdription =
                            rfsolvfrElfm[i].gftAttributfNS(null, "DESCRIPTION");

                        if ((dfsdription != null) && (dfsdription.lfngth() > 0)) {
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Rfgistfr Rfsolvfr: " + jbvbClbss + ": "
                                          + dfsdription);
                            }
                        } flsf {
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, "Rfgistfr Rfsolvfr: " + jbvbClbss
                                          + ": For unknown purposfs");
                            }
                        }
                        dlbssNbmfs.bdd(jbvbClbss);
                    }
                    KfyRfsolvfr.rfgistfrClbssNbmfs(dlbssNbmfs);
                }


                if (tbg.fqubls("PrffixMbppings")){
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, "Now I try to bind prffixfs:");
                    }

                    Elfmfnt[] nl =
                        XMLUtils.sflfdtNodfs(fl.gftFirstChild(), CONF_NS, "PrffixMbpping");

                    for (int i = 0; i < nl.lfngth; i++) {
                        String nbmfspbdf = nl[i].gftAttributfNS(null, "nbmfspbdf");
                        String prffix = nl[i].gftAttributfNS(null, "prffix");
                        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                            log.log(jbvb.util.logging.Lfvfl.FINE, "Now I try to bind " + prffix + " to " + nbmfspbdf);
                        }
                        ElfmfntProxy.sftDffbultPrffix(nbmfspbdf, prffix);
                    }
                }
            }
        } dbtdh (Exdfption f) {
            log.log(jbvb.util.logging.Lfvfl.SEVERE, "Bbd: ", f);
            f.printStbdkTrbdf();
        }
    }

}

