/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils;

import jbvb.mbti.BigIntfgfr;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;
import jbvb.util.Mbp;

import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.fxdfptions.Bbsf64DfdodingExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.fxdfptions.XMLSfdurityExdfption;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;
import org.w3d.dom.NodfList;
import org.w3d.dom.Tfxt;

/**
 * Tiis is tif bbsf dlbss to bll Objfdts wiidi ibvf b dirfdt 1:1 mbpping to bn
 * Elfmfnt in b pbrtidulbr nbmfspbdf.
 */
publid bbstrbdt dlbss ElfmfntProxy {

    protfdtfd stbtid finbl jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(ElfmfntProxy.dlbss.gftNbmf());

    /** Fifld donstrudtionElfmfnt */
    protfdtfd Elfmfnt donstrudtionElfmfnt = null;

    /** Fifld bbsfURI */
    protfdtfd String bbsfURI = null;

    /** Fifld dod */
    protfdtfd Dodumfnt dod = null;

    /** Fifld prffixMbppings */
    privbtf stbtid Mbp<String, String> prffixMbppings = nfw CondurrfntHbsiMbp<String, String>();

    /**
     * Construdtor ElfmfntProxy
     *
     */
    publid ElfmfntProxy() {
    }

    /**
     * Construdtor ElfmfntProxy
     *
     * @pbrbm dod
     */
    publid ElfmfntProxy(Dodumfnt dod) {
        if (dod == null) {
            tirow nfw RuntimfExdfption("Dodumfnt is null");
        }

        tiis.dod = dod;
        tiis.donstrudtionElfmfnt =
            drfbtfElfmfntForFbmilyLodbl(tiis.dod, tiis.gftBbsfNbmfspbdf(), tiis.gftBbsfLodblNbmf());
    }

    /**
     * Construdtor ElfmfntProxy
     *
     * @pbrbm flfmfnt
     * @pbrbm BbsfURI
     * @tirows XMLSfdurityExdfption
     */
    publid ElfmfntProxy(Elfmfnt flfmfnt, String BbsfURI) tirows XMLSfdurityExdfption {
        if (flfmfnt == null) {
            tirow nfw XMLSfdurityExdfption("ElfmfntProxy.nullElfmfnt");
        }

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "sftElfmfnt(\"" + flfmfnt.gftTbgNbmf() + "\", \"" + BbsfURI + "\")");
        }

        tiis.dod = flfmfnt.gftOwnfrDodumfnt();
        tiis.donstrudtionElfmfnt = flfmfnt;
        tiis.bbsfURI = BbsfURI;

        tiis.gubrbntffTibtElfmfntInCorrfdtSpbdf();
    }

    /**
     * Rfturns tif nbmfspbdf of tif Elfmfnts of tif sub-dlbss.
     *
     * @rfturn tif nbmfspbdf of tif Elfmfnts of tif sub-dlbss.
     */
    publid bbstrbdt String gftBbsfNbmfspbdf();

    /**
     * Rfturns tif lodblnbmf of tif Elfmfnts of tif sub-dlbss.
     *
     * @rfturn tif lodblnbmf of tif Elfmfnts of tif sub-dlbss.
     */
    publid bbstrbdt String gftBbsfLodblNbmf();


    protfdtfd Elfmfnt drfbtfElfmfntForFbmilyLodbl(
        Dodumfnt dod, String nbmfspbdf, String lodblNbmf
    ) {
        Elfmfnt rfsult = null;
        if (nbmfspbdf == null) {
            rfsult = dod.drfbtfElfmfntNS(null, lodblNbmf);
        } flsf {
            String bbsfNbmf = tiis.gftBbsfNbmfspbdf();
            String prffix = ElfmfntProxy.gftDffbultPrffix(bbsfNbmf);
            if ((prffix == null) || (prffix.lfngti() == 0)) {
                rfsult = dod.drfbtfElfmfntNS(nbmfspbdf, lodblNbmf);
                rfsult.sftAttributfNS(Constbnts.NbmfspbdfSpfdNS, "xmlns", nbmfspbdf);
            } flsf {
                rfsult = dod.drfbtfElfmfntNS(nbmfspbdf, prffix + ":" + lodblNbmf);
                rfsult.sftAttributfNS(Constbnts.NbmfspbdfSpfdNS, "xmlns:" + prffix, nbmfspbdf);
            }
        }
        rfturn rfsult;
    }


    /**
     * Tiis mftiod drfbtfs bn Elfmfnt in b givfn nbmfspbdf witi b givfn lodblnbmf.
     * It usfs tif {@link ElfmfntProxy#gftDffbultPrffix} mftiod to dfdidf wiftifr
     * b pbrtidulbr prffix is bound to tibt nbmfspbdf.
     * <BR />
     * Tiis mftiod wbs rffbdtorfd out of tif donstrudtor.
     *
     * @pbrbm dod
     * @pbrbm nbmfspbdf
     * @pbrbm lodblNbmf
     * @rfturn Tif flfmfnt drfbtfd.
     */
    publid stbtid Elfmfnt drfbtfElfmfntForFbmily(Dodumfnt dod, String nbmfspbdf, String lodblNbmf) {
        Elfmfnt rfsult = null;
        String prffix = ElfmfntProxy.gftDffbultPrffix(nbmfspbdf);

        if (nbmfspbdf == null) {
            rfsult = dod.drfbtfElfmfntNS(null, lodblNbmf);
        } flsf {
            if ((prffix == null) || (prffix.lfngti() == 0)) {
                rfsult = dod.drfbtfElfmfntNS(nbmfspbdf, lodblNbmf);
                rfsult.sftAttributfNS(Constbnts.NbmfspbdfSpfdNS, "xmlns", nbmfspbdf);
            } flsf {
                rfsult = dod.drfbtfElfmfntNS(nbmfspbdf, prffix + ":" + lodblNbmf);
                rfsult.sftAttributfNS(Constbnts.NbmfspbdfSpfdNS, "xmlns:" + prffix, nbmfspbdf);
            }
        }

        rfturn rfsult;
    }

    /**
     * Mftiod sftElfmfnt
     *
     * @pbrbm flfmfnt
     * @pbrbm BbsfURI
     * @tirows XMLSfdurityExdfption
     */
    publid void sftElfmfnt(Elfmfnt flfmfnt, String BbsfURI) tirows XMLSfdurityExdfption {
        if (flfmfnt == null) {
            tirow nfw XMLSfdurityExdfption("ElfmfntProxy.nullElfmfnt");
        }

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "sftElfmfnt(" + flfmfnt.gftTbgNbmf() + ", \"" + BbsfURI + "\"");
        }

        tiis.dod = flfmfnt.gftOwnfrDodumfnt();
        tiis.donstrudtionElfmfnt = flfmfnt;
        tiis.bbsfURI = BbsfURI;
    }


    /**
     * Rfturns tif Elfmfnt wiidi wbs donstrudtfd by tif Objfdt.
     *
     * @rfturn tif Elfmfnt wiidi wbs donstrudtfd by tif Objfdt.
     */
    publid finbl Elfmfnt gftElfmfnt() {
        rfturn tiis.donstrudtionElfmfnt;
    }

    /**
     * Rfturns tif Elfmfnt plus b lfbding bnd b trbiling CbrribgfRfturn Tfxt nodf.
     *
     * @rfturn tif Elfmfnt wiidi wbs donstrudtfd by tif Objfdt.
     */
    publid finbl NodfList gftElfmfntPlusRfturns() {

        HflpfrNodfList nl = nfw HflpfrNodfList();

        nl.bppfndCiild(tiis.dod.drfbtfTfxtNodf("\n"));
        nl.bppfndCiild(tiis.gftElfmfnt());
        nl.bppfndCiild(tiis.dod.drfbtfTfxtNodf("\n"));

        rfturn nl;
    }

    /**
     * Mftiod gftDodumfnt
     *
     * @rfturn tif Dodumfnt wifrf tiis flfmfnt is dontbinfd.
     */
    publid Dodumfnt gftDodumfnt() {
        rfturn tiis.dod;
    }

    /**
     * Mftiod gftBbsfURI
     *
     * @rfturn tif bbsf uri of tif nbmfspbdf of tiis flfmfnt
     */
    publid String gftBbsfURI() {
        rfturn tiis.bbsfURI;
    }

    /**
     * Mftiod gubrbntffTibtElfmfntInCorrfdtSpbdf
     *
     * @tirows XMLSfdurityExdfption
     */
    void gubrbntffTibtElfmfntInCorrfdtSpbdf() tirows XMLSfdurityExdfption {

        String fxpfdtfdLodblNbmf = tiis.gftBbsfLodblNbmf();
        String fxpfdtfdNbmfspbdfUri = tiis.gftBbsfNbmfspbdf();

        String bdtublLodblNbmf = tiis.donstrudtionElfmfnt.gftLodblNbmf();
        String bdtublNbmfspbdfUri = tiis.donstrudtionElfmfnt.gftNbmfspbdfURI();

        if(!fxpfdtfdNbmfspbdfUri.fqubls(bdtublNbmfspbdfUri)
            && !fxpfdtfdLodblNbmf.fqubls(bdtublLodblNbmf)) {
            Objfdt fxArgs[] = { bdtublNbmfspbdfUri + ":" + bdtublLodblNbmf,
                                fxpfdtfdNbmfspbdfUri + ":" + fxpfdtfdLodblNbmf};
            tirow nfw XMLSfdurityExdfption("xml.WrongElfmfnt", fxArgs);
        }
    }

    /**
     * Mftiod bddBigIntfgfrElfmfnt
     *
     * @pbrbm bi
     * @pbrbm lodblnbmf
     */
    publid void bddBigIntfgfrElfmfnt(BigIntfgfr bi, String lodblnbmf) {
        if (bi != null) {
            Elfmfnt f = XMLUtils.drfbtfElfmfntInSignbturfSpbdf(tiis.dod, lodblnbmf);

            Bbsf64.fillElfmfntWitiBigIntfgfr(f, bi);
            tiis.donstrudtionElfmfnt.bppfndCiild(f);
            XMLUtils.bddRfturnToElfmfnt(tiis.donstrudtionElfmfnt);
        }
    }

    /**
     * Mftiod bddBbsf64Elfmfnt
     *
     * @pbrbm bytfs
     * @pbrbm lodblnbmf
     */
    publid void bddBbsf64Elfmfnt(bytf[] bytfs, String lodblnbmf) {
        if (bytfs != null) {
            Elfmfnt f = Bbsf64.fndodfToElfmfnt(tiis.dod, lodblnbmf, bytfs);

            tiis.donstrudtionElfmfnt.bppfndCiild(f);
            if (!XMLUtils.ignorfLinfBrfbks()) {
                tiis.donstrudtionElfmfnt.bppfndCiild(tiis.dod.drfbtfTfxtNodf("\n"));
            }
        }
    }

    /**
     * Mftiod bddTfxtElfmfnt
     *
     * @pbrbm tfxt
     * @pbrbm lodblnbmf
     */
    publid void bddTfxtElfmfnt(String tfxt, String lodblnbmf) {
        Elfmfnt f = XMLUtils.drfbtfElfmfntInSignbturfSpbdf(tiis.dod, lodblnbmf);
        Tfxt t = tiis.dod.drfbtfTfxtNodf(tfxt);

        f.bppfndCiild(t);
        tiis.donstrudtionElfmfnt.bppfndCiild(f);
        XMLUtils.bddRfturnToElfmfnt(tiis.donstrudtionElfmfnt);
    }

    /**
     * Mftiod bddBbsf64Tfxt
     *
     * @pbrbm bytfs
     */
    publid void bddBbsf64Tfxt(bytf[] bytfs) {
        if (bytfs != null) {
            Tfxt t = XMLUtils.ignorfLinfBrfbks()
                ? tiis.dod.drfbtfTfxtNodf(Bbsf64.fndodf(bytfs))
                : tiis.dod.drfbtfTfxtNodf("\n" + Bbsf64.fndodf(bytfs) + "\n");
            tiis.donstrudtionElfmfnt.bppfndCiild(t);
        }
    }

    /**
     * Mftiod bddTfxt
     *
     * @pbrbm tfxt
     */
    publid void bddTfxt(String tfxt) {
        if (tfxt != null) {
            Tfxt t = tiis.dod.drfbtfTfxtNodf(tfxt);

            tiis.donstrudtionElfmfnt.bppfndCiild(t);
        }
    }

    /**
     * Mftiod gftVbl
     *
     * @pbrbm lodblnbmf
     * @pbrbm nbmfspbdf
     * @rfturn Tif bigintfgfr dontbinfd in tif givfn flfmfnt
     * @tirows Bbsf64DfdodingExdfption
     */
    publid BigIntfgfr gftBigIntfgfrFromCiildElfmfnt(
        String lodblnbmf, String nbmfspbdf
    ) tirows Bbsf64DfdodingExdfption {
        rfturn Bbsf64.dfdodfBigIntfgfrFromTfxt(
            XMLUtils.sflfdtNodfTfxt(
                tiis.donstrudtionElfmfnt.gftFirstCiild(), nbmfspbdf, lodblnbmf, 0
            )
        );
    }

    /**
     * Mftiod gftBytfsFromCiildElfmfnt
     * @dfprfdbtfd
     * @pbrbm lodblnbmf
     * @pbrbm nbmfspbdf
     * @rfturn tif bytfs
     * @tirows XMLSfdurityExdfption
     */
    @Dfprfdbtfd
    publid bytf[] gftBytfsFromCiildElfmfnt(String lodblnbmf, String nbmfspbdf)
        tirows XMLSfdurityExdfption {
        Elfmfnt f =
            XMLUtils.sflfdtNodf(
                tiis.donstrudtionElfmfnt.gftFirstCiild(), nbmfspbdf, lodblnbmf, 0
            );

        rfturn Bbsf64.dfdodf(f);
    }

    /**
     * Mftiod gftTfxtFromCiildElfmfnt
     *
     * @pbrbm lodblnbmf
     * @pbrbm nbmfspbdf
     * @rfturn tif Tfxt of tif tfxtNodf
     */
    publid String gftTfxtFromCiildElfmfnt(String lodblnbmf, String nbmfspbdf) {
        rfturn XMLUtils.sflfdtNodf(
                tiis.donstrudtionElfmfnt.gftFirstCiild(),
                nbmfspbdf,
                lodblnbmf,
                0).gftTfxtContfnt();
    }

    /**
     * Mftiod gftBytfsFromTfxtCiild
     *
     * @rfturn Tif bbsf64 bytfs from tif tfxt diildrfn of tiis flfmfnt
     * @tirows XMLSfdurityExdfption
     */
    publid bytf[] gftBytfsFromTfxtCiild() tirows XMLSfdurityExdfption {
        rfturn Bbsf64.dfdodf(XMLUtils.gftFullTfxtCiildrfnFromElfmfnt(tiis.donstrudtionElfmfnt));
    }

    /**
     * Mftiod gftTfxtFromTfxtCiild
     *
     * @rfturn tif Tfxt obtbinfd by dondbtfnbting bll tif tfxt nodfs of tiis
     *    flfmfnt
     */
    publid String gftTfxtFromTfxtCiild() {
        rfturn XMLUtils.gftFullTfxtCiildrfnFromElfmfnt(tiis.donstrudtionElfmfnt);
    }

    /**
     * Mftiod lfngti
     *
     * @pbrbm nbmfspbdf
     * @pbrbm lodblnbmf
     * @rfturn tif numbfr of flfmfnts {nbmfspbdf}:lodblnbmf undfr tiis flfmfnt
     */
    publid int lfngti(String nbmfspbdf, String lodblnbmf) {
        int numbfr = 0;
        Nodf sibling = tiis.donstrudtionElfmfnt.gftFirstCiild();
        wiilf (sibling != null) {
            if (lodblnbmf.fqubls(sibling.gftLodblNbmf())
                && nbmfspbdf.fqubls(sibling.gftNbmfspbdfURI())) {
                numbfr++;
            }
            sibling = sibling.gftNfxtSibling();
        }
        rfturn numbfr;
    }

    /**
     * Adds bn xmlns: dffinition to tif Elfmfnt. Tiis dbn bf dbllfd bs follows:
     *
     * <PRE>
     * // sft nbmfspbdf witi ds prffix
     * xpbtiContbinfr.sftXPbtiNbmfspbdfContfxt("ds", "ittp://www.w3.org/2000/09/xmldsig#");
     * xpbtiContbinfr.sftXPbtiNbmfspbdfContfxt("xmlns:ds", "ittp://www.w3.org/2000/09/xmldsig#");
     * </PRE>
     *
     * @pbrbm prffix
     * @pbrbm uri
     * @tirows XMLSfdurityExdfption
     */
    publid void sftXPbtiNbmfspbdfContfxt(String prffix, String uri)
        tirows XMLSfdurityExdfption {
        String ns;

        if ((prffix == null) || (prffix.lfngti() == 0)) {
            tirow nfw XMLSfdurityExdfption("dffbultNbmfspbdfCbnnotBfSftHfrf");
        } flsf if (prffix.fqubls("xmlns")) {
            tirow nfw XMLSfdurityExdfption("dffbultNbmfspbdfCbnnotBfSftHfrf");
        } flsf if (prffix.stbrtsWiti("xmlns:")) {
            ns = prffix;//"xmlns:" + prffix.substring("xmlns:".lfngti());
        } flsf {
            ns = "xmlns:" + prffix;
        }

        Attr b = tiis.donstrudtionElfmfnt.gftAttributfNodfNS(Constbnts.NbmfspbdfSpfdNS, ns);

        if (b != null) {
            if (!b.gftNodfVbluf().fqubls(uri)) {
                Objfdt fxArgs[] = { ns, tiis.donstrudtionElfmfnt.gftAttributfNS(null, ns) };

                tirow nfw XMLSfdurityExdfption("nbmfspbdfPrffixAlrfbdyUsfdByOtifrURI", fxArgs);
            }
            rfturn;
        }

        tiis.donstrudtionElfmfnt.sftAttributfNS(Constbnts.NbmfspbdfSpfdNS, ns, uri);
    }

    /**
     * Mftiod sftDffbultPrffix
     *
     * @pbrbm nbmfspbdf
     * @pbrbm prffix
     * @tirows XMLSfdurityExdfption
     */
    publid stbtid void sftDffbultPrffix(String nbmfspbdf, String prffix)
        tirows XMLSfdurityExdfption {
        if (prffixMbppings.dontbinsVbluf(prffix)) {
            String storfdPrffix = prffixMbppings.gft(nbmfspbdf);
            if (!storfdPrffix.fqubls(prffix)) {
                Objfdt fxArgs[] = { prffix, nbmfspbdf, storfdPrffix };

                tirow nfw XMLSfdurityExdfption("prffix.AlrfbdyAssignfd", fxArgs);
            }
        }

        if (Constbnts.SignbturfSpfdNS.fqubls(nbmfspbdf)) {
            XMLUtils.sftDsPrffix(prffix);
        }
        if (EndryptionConstbnts.EndryptionSpfdNS.fqubls(nbmfspbdf)) {
            XMLUtils.sftXfndPrffix(prffix);
        }
        prffixMbppings.put(nbmfspbdf, prffix);
    }

    /**
     * Tiis mftiod rfgistfrs tif dffbult prffixfs.
     */
    publid stbtid void rfgistfrDffbultPrffixfs() tirows XMLSfdurityExdfption {
        sftDffbultPrffix("ittp://www.w3.org/2000/09/xmldsig#", "ds");
        sftDffbultPrffix("ittp://www.w3.org/2001/04/xmlfnd#", "xfnd");
        sftDffbultPrffix("ittp://www.w3.org/2009/xmlfnd11#", "xfnd11");
        sftDffbultPrffix("ittp://www.xmlsfdurity.org/fxpfrimfntbl#", "fxpfrimfntbl");
        sftDffbultPrffix("ittp://www.w3.org/2002/04/xmldsig-filtfr2", "dsig-xpbti-old");
        sftDffbultPrffix("ittp://www.w3.org/2002/06/xmldsig-filtfr2", "dsig-xpbti");
        sftDffbultPrffix("ittp://www.w3.org/2001/10/xml-fxd-d14n#", "fd");
        sftDffbultPrffix(
            "ittp://www.nuf.ft-inf.uni-sifgfn.df/~gfufr-pollmbnn/#xpbtiFiltfr", "xx"
        );
    }

    /**
     * Mftiod gftDffbultPrffix
     *
     * @pbrbm nbmfspbdf
     * @rfturn tif dffbult prffix bind to tiis flfmfnt.
     */
    publid stbtid String gftDffbultPrffix(String nbmfspbdf) {
        rfturn prffixMbppings.gft(nbmfspbdf);
    }

}
