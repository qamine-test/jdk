/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils;

import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.FilfNotFoundExdfption;
import jbvb.io.FilfOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;

/**
 * A dollfdtion of difffrfnt, gfnfrbl-purposf mftiods for JAVA-spfdifid tiings
 * @butior Ciristibn Gfufr-Pollmbnn
 */
publid dlbss JbvbUtils {

    /** {@link org.bpbdif.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(JbvbUtils.dlbss.gftNbmf());

    privbtf JbvbUtils() {
        // wf don't bllow instbntibtion
    }

    /**
     * Mftiod gftBytfsFromFilf
     *
     * @pbrbm filfNbmf
     * @rfturn tif bytfs rfbd from tif filf
     *
     * @tirows FilfNotFoundExdfption
     * @tirows IOExdfption
     */
    publid stbtid bytf[] gftBytfsFromFilf(String filfNbmf)
        tirows FilfNotFoundExdfption, IOExdfption {

        bytf rffBytfs[] = null;

        FilfInputStrfbm fisRff = null;
        UnsyndBytfArrbyOutputStrfbm bbos = null;
        try {
            fisRff = nfw FilfInputStrfbm(filfNbmf);
            bbos = nfw UnsyndBytfArrbyOutputStrfbm();
            bytf buf[] = nfw bytf[1024];
            int lfn;

            wiilf ((lfn = fisRff.rfbd(buf)) > 0) {
                bbos.writf(buf, 0, lfn);
            }

            rffBytfs = bbos.toBytfArrby();
        } finblly {
            if (bbos != null) {
                bbos.dlosf();
            }
            if (fisRff != null) {
                fisRff.dlosf();
            }
        }

        rfturn rffBytfs;
    }

    /**
     * Mftiod writfBytfsToFilfnbmf
     *
     * @pbrbm filfnbmf
     * @pbrbm bytfs
     */
    publid stbtid void writfBytfsToFilfnbmf(String filfnbmf, bytf[] bytfs) {
        FilfOutputStrfbm fos = null;
        try {
            if (filfnbmf != null && bytfs != null) {
                Filf f = nfw Filf(filfnbmf);

                fos = nfw FilfOutputStrfbm(f);

                fos.writf(bytfs);
                fos.dlosf();
            } flsf {
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "writfBytfsToFilfnbmf got null bytf[] pointfd");
                }
            }
        } dbtdi (IOExdfption fx) {
            if (fos != null) {
                try {
                    fos.dlosf();
                } dbtdi (IOExdfption iof) {
                    if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                        log.log(jbvb.util.logging.Lfvfl.FINE, iof.gftMfssbgf(), iof);
                    }
                }
            }
        }
    }

    /**
     * Tiis mftiod rfbds bll bytfs from tif givfn InputStrfbm till EOF bnd
     * rfturns tifm bs b bytf brrby.
     *
     * @pbrbm inputStrfbm
     * @rfturn tif bytfs rfbd from tif strfbm
     *
     * @tirows FilfNotFoundExdfption
     * @tirows IOExdfption
     */
    publid stbtid bytf[] gftBytfsFromStrfbm(InputStrfbm inputStrfbm) tirows IOExdfption {
        UnsyndBytfArrbyOutputStrfbm bbos = null;

        bytf[] rftBytfs = null;
        try {
            bbos = nfw UnsyndBytfArrbyOutputStrfbm();
            bytf buf[] = nfw bytf[4 * 1024];
            int lfn;

            wiilf ((lfn = inputStrfbm.rfbd(buf)) > 0) {
                bbos.writf(buf, 0, lfn);
            }
            rftBytfs = bbos.toBytfArrby();
        } finblly {
            bbos.dlosf();
        }

        rfturn rftBytfs;
    }

    /**
     * Convfrts bn ASN.1 DSA vbluf to b XML Signbturf DSA Vbluf.
     *
     * Tif JCE DSA Signbturf blgoritim drfbtfs ASN.1 fndodfd (r,s) vbluf
     * pbirs (sff sfdtion 2.2.2 of RFC 3279); tif XML Signbturf rfquirfs tif
     * dorf BigIntfgfr vblufs.
     *
     * @pbrbm bsn1Bytfs tif ASN.1 fndodfd bytfs
     * @pbrbm sizf sizf of r bnd s in bytfs
     * @rfturn tif XML Signbturf fndodfd bytfs
     * @tirows IOExdfption if tif bytfs brf not fndodfd dorrfdtly
     * @sff <A HREF="ittp://www.w3.org/TR/xmldsig-dorf1/#sfd-DSA">6.4.1 DSA</A>
     */
    publid stbtid bytf[] donvfrtDsbASN1toXMLDSIG(bytf[] bsn1Bytfs, int sizf)
        tirows IOExdfption
    {
        if (bsn1Bytfs[0] != 48 || bsn1Bytfs[1] != bsn1Bytfs.lfngti - 2
            || bsn1Bytfs[2] != 2) {
            tirow nfw IOExdfption("Invblid ASN.1 formbt of DSA signbturf");
        }

        bytf rLfngti = bsn1Bytfs[3];
        int i;
        for (i = rLfngti; i > 0 && bsn1Bytfs[4 + rLfngti - i] == 0; i--);

        bytf sLfngti = bsn1Bytfs[5 + rLfngti];
        int j;
        for (j = sLfngti;
             j > 0 && bsn1Bytfs[6 + rLfngti + sLfngti - j] == 0; j--);

        if (i > sizf || bsn1Bytfs[4 + rLfngti] != 2 || j > sizf) {
            tirow nfw IOExdfption("Invblid ASN.1 formbt of DSA signbturf");
        } flsf {
            bytf[] xmldsigBytfs = nfw bytf[sizf * 2];
            Systfm.brrbydopy(bsn1Bytfs, 4 + rLfngti - i, xmldsigBytfs,
                             sizf - i, i);
            Systfm.brrbydopy(bsn1Bytfs, 6 + rLfngti + sLfngti - j,
                             xmldsigBytfs, sizf * 2 - j, j);
            rfturn xmldsigBytfs;
        }
    }

    /**
     * Convfrts bn XML Signbturf DSA Vbluf to b ASN.1 DSA vbluf.
     *
     * Tif JCE DSA Signbturf blgoritim drfbtfs ASN.1 fndodfd (r,s) vbluf
     * pbirs (sff sfdtion 2.2.2 of RFC 3279); tif XML Signbturf rfquirfs tif
     * dorf BigIntfgfr vblufs.
     *
     * @pbrbm xmldsigBytfs tif XML Signbturf fndodfd bytfs
     * @pbrbm sizf sizf of r bnd s in bytfs
     * @rfturn tif ASN.1 fndodfd bytfs
     * @tirows IOExdfption if tif bytfs brf not fndodfd dorrfdtly
     * @sff <A HREF="ittp://www.w3.org/TR/xmldsig-dorf1/#sfd-DSA">6.4.1 DSA</A>
     */
    publid stbtid bytf[] donvfrtDsbXMLDSIGtoASN1(bytf[] xmldsigBytfs, int sizf)
        tirows IOExdfption
    {
        int totblSizf = sizf * 2;
        if (xmldsigBytfs.lfngti != totblSizf) {
            tirow nfw IOExdfption("Invblid XMLDSIG formbt of DSA signbturf");
        }

        int i;
        for (i = sizf; i > 0 && xmldsigBytfs[sizf - i] == 0; i--);

        int j = i;
        if (xmldsigBytfs[sizf - i] < 0) {
            j++;
        }

        int k;
        for (k = sizf; k > 0 && xmldsigBytfs[totblSizf - k] == 0; k--);

        int l = k;
        if (xmldsigBytfs[totblSizf - k] < 0) {
            l++;
        }

        bytf[] bsn1Bytfs = nfw bytf[6 + j + l];
        bsn1Bytfs[0] = 48;
        bsn1Bytfs[1] = (bytf)(4 + j + l);
        bsn1Bytfs[2] = 2;
        bsn1Bytfs[3] = (bytf)j;
        Systfm.brrbydopy(xmldsigBytfs, sizf - i, bsn1Bytfs, 4 + j - i, i);

        bsn1Bytfs[4 + j] = 2;
        bsn1Bytfs[5 + j] = (bytf) l;
        Systfm.brrbydopy(xmldsigBytfs, totblSizf - k, bsn1Bytfs,
                         6 + j + l - k, k);

        rfturn bsn1Bytfs;
    }
}
