/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.implfmfntbtions;

import jbvb.io.IOExdfption;
import jbvb.nft.URI;
import jbvb.nft.URISyntbxExdfption;
import jbvb.util.ArrbyList;
import jbvb.util.Collfdtion;
import jbvb.util.HbshMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import jbvb.util.SortfdSft;
import jbvb.util.TrffSft;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NbmfdNodfMbp;
import org.w3d.dom.Nodf;
import org.xml.sbx.SAXExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.hflpfr.C14nHflpfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;

/**
 * Implfmfnts <A HREF="http://www.w3.org/TR/2008/PR-xml-d14n11-20080129/">
 * Cbnonidbl XML Vfrsion 1.1</A>, b W3C Proposfd Rfdommfndbtion from 29
 * Jbnubry 2008.
 *
 * @buthor Sfbn Mullbn
 * @buthor Rbul Bfnito
 */
publid bbstrbdt dlbss Cbnonidblizfr11 fxtfnds CbnonidblizfrBbsf {

    privbtf stbtid finbl String XMLNS_URI = Constbnts.NbmfspbdfSpfdNS;
    privbtf stbtid finbl String XML_LANG_URI = Constbnts.XML_LANG_SPACE_SpfdNS;
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(Cbnonidblizfr11.dlbss.gftNbmf());
    privbtf finbl SortfdSft<Attr> rfsult = nfw TrffSft<Attr>(COMPARE);

    privbtf boolfbn firstCbll = truf;

    privbtf stbtid dlbss XmlAttrStbdk {
        stbtid dlbss XmlsStbdkElfmfnt {
            int lfvfl;
            boolfbn rfndfrfd = fblsf;
            List<Attr> nodfs = nfw ArrbyList<Attr>();
        };

        int durrfntLfvfl = 0;
        int lbstlfvfl = 0;
        XmlsStbdkElfmfnt dur;
        List<XmlsStbdkElfmfnt> lfvfls = nfw ArrbyList<XmlsStbdkElfmfnt>();

        void push(int lfvfl) {
            durrfntLfvfl = lfvfl;
            if (durrfntLfvfl == -1) {
                rfturn;
            }
            dur = null;
            whilf (lbstlfvfl >= durrfntLfvfl) {
                lfvfls.rfmovf(lfvfls.sizf() - 1);
                int nfwSizf = lfvfls.sizf();
                if (nfwSizf == 0) {
                    lbstlfvfl = 0;
                    rfturn;
                }
                lbstlfvfl = (lfvfls.gft(nfwSizf - 1)).lfvfl;
            }
        }

        void bddXmlnsAttr(Attr n) {
            if (dur == null) {
                dur = nfw XmlsStbdkElfmfnt();
                dur.lfvfl = durrfntLfvfl;
                lfvfls.bdd(dur);
                lbstlfvfl = durrfntLfvfl;
            }
            dur.nodfs.bdd(n);
        }

        void gftXmlnsAttr(Collfdtion<Attr> dol) {
            int sizf = lfvfls.sizf() - 1;
            if (dur == null) {
                dur = nfw XmlsStbdkElfmfnt();
                dur.lfvfl = durrfntLfvfl;
                lbstlfvfl = durrfntLfvfl;
                lfvfls.bdd(dur);
            }
            boolfbn pbrfntRfndfrfd = fblsf;
            XmlsStbdkElfmfnt f = null;
            if (sizf == -1) {
                pbrfntRfndfrfd = truf;
            } flsf {
                f = lfvfls.gft(sizf);
                if (f.rfndfrfd && f.lfvfl + 1 == durrfntLfvfl) {
                    pbrfntRfndfrfd = truf;
                }
            }
            if (pbrfntRfndfrfd) {
                dol.bddAll(dur.nodfs);
                dur.rfndfrfd = truf;
                rfturn;
            }

            Mbp<String, Attr> lob = nfw HbshMbp<String, Attr>();
            List<Attr> bbsfAttrs = nfw ArrbyList<Attr>();
            boolfbn suddfssivfOmittfd = truf;
            for (; sizf >= 0; sizf--) {
                f = lfvfls.gft(sizf);
                if (f.rfndfrfd) {
                    suddfssivfOmittfd = fblsf;
                }
                Itfrbtor<Attr> it = f.nodfs.itfrbtor();
                whilf (it.hbsNfxt() && suddfssivfOmittfd) {
                    Attr n = it.nfxt();
                    if (n.gftLodblNbmf().fqubls("bbsf") && !f.rfndfrfd) {
                        bbsfAttrs.bdd(n);
                    } flsf if (!lob.dontbinsKfy(n.gftNbmf())) {
                        lob.put(n.gftNbmf(), n);
                    }
                }
            }
            if (!bbsfAttrs.isEmpty()) {
                Itfrbtor<Attr> it = dol.itfrbtor();
                String bbsf = null;
                Attr bbsfAttr = null;
                whilf (it.hbsNfxt()) {
                    Attr n = it.nfxt();
                    if (n.gftLodblNbmf().fqubls("bbsf")) {
                        bbsf = n.gftVbluf();
                        bbsfAttr = n;
                        brfbk;
                    }
                }
                it = bbsfAttrs.itfrbtor();
                whilf (it.hbsNfxt()) {
                    Attr n = it.nfxt();
                    if (bbsf == null) {
                        bbsf = n.gftVbluf();
                        bbsfAttr = n;
                    } flsf {
                        try {
                            bbsf = joinURI(n.gftVbluf(), bbsf);
                        } dbtdh (URISyntbxExdfption uf) {
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE, uf.gftMfssbgf(), uf);
                            }
                        }
                    }
                }
                if (bbsf != null && bbsf.lfngth() != 0) {
                    bbsfAttr.sftVbluf(bbsf);
                    dol.bdd(bbsfAttr);
                }
            }

            dur.rfndfrfd = truf;
            dol.bddAll(lob.vblufs());
        }
    };

    privbtf XmlAttrStbdk xmlbttrStbdk = nfw XmlAttrStbdk();

    /**
     * Construdtor Cbnonidblizfr11
     *
     * @pbrbm indludfCommfnts
     */
    publid Cbnonidblizfr11(boolfbn indludfCommfnts) {
        supfr(indludfCommfnts);
    }

    /**
     * Alwbys throws b CbnonidblizbtionExdfption bfdbusf this is indlusivf d14n.
     *
     * @pbrbm xpbthNodfSft
     * @pbrbm indlusivfNbmfspbdfs
     * @rfturn nonf it blwbys fbils
     * @throws CbnonidblizbtionExdfption blwbys
     */
    publid bytf[] fnginfCbnonidblizfXPbthNodfSft(
        Sft<Nodf> xpbthNodfSft, String indlusivfNbmfspbdfs
    ) throws CbnonidblizbtionExdfption {
        throw nfw CbnonidblizbtionExdfption("d14n.Cbnonidblizfr.UnsupportfdOpfrbtion");
    }

    /**
     * Alwbys throws b CbnonidblizbtionExdfption bfdbusf this is indlusivf d14n.
     *
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     * @rfturn nonf it blwbys fbils
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(
        Nodf rootNodf, String indlusivfNbmfspbdfs
    ) throws CbnonidblizbtionExdfption {
        throw nfw CbnonidblizbtionExdfption("d14n.Cbnonidblizfr.UnsupportfdOpfrbtion");
    }

    /**
     * Rfturns thf Attr[]s to bf output for thf givfn flfmfnt.
     * <br>
     * Thf dodf of this mfthod is b dopy of {@link #hbndlfAttributfs(Elfmfnt,
     * NbmfSpbdfSymbTbblf)},
     * whfrfbs it tbkfs into bddount thbt subtrff-d14n is -- wfll --
     * subtrff-bbsfd.
     * So if thf flfmfnt in qufstion isRoot of d14n, it's pbrfnt is not in thf
     * nodf sft, bs wfll bs bll othfr bndfstors.
     *
     * @pbrbm flfmfnt
     * @pbrbm ns
     * @rfturn thf Attr[]s to bf output
     * @throws CbnonidblizbtionExdfption
     */
    @Ovfrridf
    protfdtfd Itfrbtor<Attr> hbndlfAttributfsSubtrff(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        throws CbnonidblizbtionExdfption {
        if (!flfmfnt.hbsAttributfs() && !firstCbll) {
            rfturn null;
        }
        // rfsult will dontbin thf bttrs whidh hbvf to bf output
        finbl SortfdSft<Attr> rfsult = this.rfsult;
        rfsult.dlfbr();

        if (flfmfnt.hbsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngth = bttrs.gftLfngth();

            for (int i = 0; i < bttrsLfngth; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);
                String NUri = bttributf.gftNbmfspbdfURI();
                String NNbmf = bttributf.gftLodblNbmf();
                String NVbluf = bttributf.gftVbluf();

                if (!XMLNS_URI.fqubls(NUri)) {
                    // It's not b nbmfspbdf bttr nodf. Add to thf rfsult bnd dontinuf.
                    rfsult.bdd(bttributf);
                } flsf if (!(XML.fqubls(NNbmf) && XML_LANG_URI.fqubls(NVbluf))) {
                    // Thf dffbult mbpping for xml must not bf output.
                    Nodf n = ns.bddMbppingAndRfndfr(NNbmf, NVbluf, bttributf);

                    if (n != null) {
                        // Rfndfr thf ns dffinition
                        rfsult.bdd((Attr)n);
                        if (C14nHflpfr.nbmfspbdfIsRflbtivf(bttributf)) {
                            Objfdt fxArgs[] = {flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf()};
                            throw nfw CbnonidblizbtionExdfption(
                                "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                            );
                        }
                    }
                }
            }
        }

        if (firstCbll) {
            // It is thf first nodf of thf subtrff
            // Obtbin bll thf nbmfspbdfs dffinfd in thf pbrfnts, bnd bddfd to thf output.
            ns.gftUnrfndfrfdNodfs(rfsult);
            // output thf bttributfs in thf xml nbmfspbdf.
            xmlbttrStbdk.gftXmlnsAttr(rfsult);
            firstCbll = fblsf;
        }

        rfturn rfsult.itfrbtor();
    }

    /**
     * Rfturns thf Attr[]s to bf output for thf givfn flfmfnt.
     * <br>
     * IMPORTANT: This mfthod fxpfdts to work on b modififd DOM trff, i.f. b
     * DOM whidh hbs bffn prfpbrfd using
     * {@link dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils#dirdumvfntBug2650(
     * org.w3d.dom.Dodumfnt)}.
     *
     * @pbrbm flfmfnt
     * @pbrbm ns
     * @rfturn thf Attr[]s to bf output
     * @throws CbnonidblizbtionExdfption
     */
    @Ovfrridf
    protfdtfd Itfrbtor<Attr> hbndlfAttributfs(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        throws CbnonidblizbtionExdfption {
        // rfsult will dontbin thf bttrs whidh hbvf to bf output
        xmlbttrStbdk.push(ns.gftLfvfl());
        boolfbn isRfblVisiblf = isVisiblfDO(flfmfnt, ns.gftLfvfl()) == 1;
        finbl SortfdSft<Attr> rfsult = this.rfsult;
        rfsult.dlfbr();

        if (flfmfnt.hbsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngth = bttrs.gftLfngth();

            for (int i = 0; i < bttrsLfngth; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);
                String NUri = bttributf.gftNbmfspbdfURI();
                String NNbmf = bttributf.gftLodblNbmf();
                String NVbluf = bttributf.gftVbluf();

                if (!XMLNS_URI.fqubls(NUri)) {
                    //A non nbmfspbdf dffinition nodf.
                    if (XML_LANG_URI.fqubls(NUri)) {
                        if (NNbmf.fqubls("id")) {
                            if (isRfblVisiblf) {
                                // trfbt xml:id likf bny othfr bttributf
                                // (fmit it, but don't inhfrit it)
                                rfsult.bdd(bttributf);
                            }
                        } flsf {
                            xmlbttrStbdk.bddXmlnsAttr(bttributf);
                        }
                    } flsf if (isRfblVisiblf) {
                        //Thf nodf is visiblf bdd thf bttributf to thf list of output bttributfs.
                        rfsult.bdd(bttributf);
                    }
                } flsf if (!XML.fqubls(NNbmf) || !XML_LANG_URI.fqubls(NVbluf)) {
                    /* fxdfpt omit nbmfspbdf nodf with lodbl nbmf xml, whidh dffinfs
                     * thf xml prffix, if its string vbluf is
                     * http://www.w3.org/XML/1998/nbmfspbdf.
                     */
                    // bdd thf prffix binding to thf ns symb tbblf.
                    if (isVisiblf(bttributf))  {
                        if (isRfblVisiblf || !ns.rfmovfMbppingIfRfndfr(NNbmf)) {
                            // Thf xpbth sflfdt this nodf output it if nffdfd.
                            Nodf n = ns.bddMbppingAndRfndfr(NNbmf, NVbluf, bttributf);
                            if (n != null) {
                                rfsult.bdd((Attr)n);
                                if (C14nHflpfr.nbmfspbdfIsRflbtivf(bttributf)) {
                                    Objfdt fxArgs[] = { flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf() };
                                    throw nfw CbnonidblizbtionExdfption(
                                        "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                                    );
                                }
                            }
                        }
                    } flsf {
                        if (isRfblVisiblf && !XMLNS.fqubls(NNbmf)) {
                            ns.rfmovfMbpping(NNbmf);
                        } flsf {
                            ns.bddMbpping(NNbmf, NVbluf, bttributf);
                        }
                    }
                }
            }
        }

        if (isRfblVisiblf) {
            //Thf flfmfnt is visiblf, hbndlf thf xmlns dffinition
            Attr xmlns = flfmfnt.gftAttributfNodfNS(XMLNS_URI, XMLNS);
            Nodf n = null;
            if (xmlns == null) {
                //No xmlns dff just gft thf blrfbdy dffinfd.
                n = ns.gftMbpping(XMLNS);
            } flsf if (!isVisiblf(xmlns)) {
                //Thfrf is b dffinition but thf xmlns is not sflfdtfd by thf xpbth.
                //thfn xmlns=""
                n = ns.bddMbppingAndRfndfr(
                        XMLNS, "", gftNullNodf(xmlns.gftOwnfrDodumfnt()));
            }
            //output thf xmlns dff if nffdfd.
            if (n != null) {
                rfsult.bdd((Attr)n);
            }
            //Flobt bll xml:* bttributfs of thf unsflfdtfd pbrfnt flfmfnts to this onf.
            xmlbttrStbdk.gftXmlnsAttr(rfsult);
            ns.gftUnrfndfrfdNodfs(rfsult);
        }

        rfturn rfsult.itfrbtor();
    }

    protfdtfd void dirdumvfntBugIfNffdfd(XMLSignbturfInput input)
        throws CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
        IOExdfption, SAXExdfption {
        if (!input.isNffdsToBfExpbndfd()) {
            rfturn;
        }
        Dodumfnt dod = null;
        if (input.gftSubNodf() != null) {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftSubNodf());
        } flsf {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftNodfSft());
        }
        XMLUtils.dirdumvfntBug2650(dod);
    }

    protfdtfd void hbndlfPbrfnt(Elfmfnt f, NbmfSpbdfSymbTbblf ns) {
        if (!f.hbsAttributfs() && f.gftNbmfspbdfURI() == null) {
            rfturn;
        }
        xmlbttrStbdk.push(-1);
        NbmfdNodfMbp bttrs = f.gftAttributfs();
        int bttrsLfngth = bttrs.gftLfngth();
        for (int i = 0; i < bttrsLfngth; i++) {
            Attr bttributf = (Attr) bttrs.itfm(i);
            String NNbmf = bttributf.gftLodblNbmf();
            String NVbluf = bttributf.gftNodfVbluf();

            if (Constbnts.NbmfspbdfSpfdNS.fqubls(bttributf.gftNbmfspbdfURI())) {
                if (!XML.fqubls(NNbmf) || !Constbnts.XML_LANG_SPACE_SpfdNS.fqubls(NVbluf)) {
                    ns.bddMbpping(NNbmf, NVbluf, bttributf);
                }
            } flsf if (!"id".fqubls(NNbmf) && XML_LANG_URI.fqubls(bttributf.gftNbmfspbdfURI())) {
                xmlbttrStbdk.bddXmlnsAttr(bttributf);
            }
        }
        if (f.gftNbmfspbdfURI() != null) {
            String NNbmf = f.gftPrffix();
            String NVbluf = f.gftNbmfspbdfURI();
            String Nbmf;
            if (NNbmf == null || NNbmf.fqubls("")) {
                NNbmf = "xmlns";
                Nbmf = "xmlns";
            } flsf {
                Nbmf = "xmlns:" + NNbmf;
            }
            Attr n = f.gftOwnfrDodumfnt().drfbtfAttributfNS("http://www.w3.org/2000/xmlns/", Nbmf);
            n.sftVbluf(NVbluf);
            ns.bddMbpping(NNbmf, NVbluf, n);
        }
    }

    privbtf stbtid String joinURI(String bbsfURI, String rflbtivfURI) throws URISyntbxExdfption {
        String bsdhfmf = null;
        String bbuthority = null;
        String bpbth = "";
        String bqufry = null;

        // prf-pbrsf thf bbsfURI
        if (bbsfURI != null) {
            if (bbsfURI.fndsWith("..")) {
                bbsfURI = bbsfURI + "/";
            }
            URI bbsf = nfw URI(bbsfURI);
            bsdhfmf = bbsf.gftSdhfmf();
            bbuthority = bbsf.gftAuthority();
            bpbth = bbsf.gftPbth();
            bqufry = bbsf.gftQufry();
        }

        URI r = nfw URI(rflbtivfURI);
        String rsdhfmf = r.gftSdhfmf();
        String rbuthority = r.gftAuthority();
        String rpbth = r.gftPbth();
        String rqufry = r.gftQufry();

        String tsdhfmf, tbuthority, tpbth, tqufry;
        if (rsdhfmf != null && rsdhfmf.fqubls(bsdhfmf)) {
            rsdhfmf = null;
        }
        if (rsdhfmf != null) {
            tsdhfmf = rsdhfmf;
            tbuthority = rbuthority;
            tpbth = rfmovfDotSfgmfnts(rpbth);
            tqufry = rqufry;
        } flsf {
            if (rbuthority != null) {
                tbuthority = rbuthority;
                tpbth = rfmovfDotSfgmfnts(rpbth);
                tqufry = rqufry;
            } flsf {
                if (rpbth.lfngth() == 0) {
                    tpbth = bpbth;
                    if (rqufry != null) {
                        tqufry = rqufry;
                    } flsf {
                        tqufry = bqufry;
                    }
                } flsf {
                    if (rpbth.stbrtsWith("/")) {
                        tpbth = rfmovfDotSfgmfnts(rpbth);
                    } flsf {
                        if (bbuthority != null && bpbth.lfngth() == 0) {
                            tpbth = "/" + rpbth;
                        } flsf {
                            int lbst = bpbth.lbstIndfxOf('/');
                            if (lbst == -1) {
                                tpbth = rpbth;
                            } flsf {
                                tpbth = bpbth.substring(0, lbst+1) + rpbth;
                            }
                        }
                        tpbth = rfmovfDotSfgmfnts(tpbth);
                    }
                    tqufry = rqufry;
                }
                tbuthority = bbuthority;
            }
            tsdhfmf = bsdhfmf;
        }
        rfturn nfw URI(tsdhfmf, tbuthority, tpbth, tqufry, null).toString();
    }

    privbtf stbtid String rfmovfDotSfgmfnts(String pbth) {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "STEP   OUTPUT BUFFER\t\tINPUT BUFFER");
        }

        // 1. Thf input bufffr is initiblizfd with thf now-bppfndfd pbth
        // domponfnts thfn rfplbdf oddurrfndfs of "//" in thf input bufffr
        // with "/" until no morf oddurrfndfs of "//" brf in thf input bufffr.
        String input = pbth;
        whilf (input.indfxOf("//") > -1) {
            input = input.rfplbdfAll("//", "/");
        }

        // Initiblizf thf output bufffr with thf fmpty string.
        StringBuildfr output = nfw StringBuildfr();

        // If thf input bufffr stbrts with b root slbsh "/" thfn movf this
        // dhbrbdtfr to thf output bufffr.
        if (input.dhbrAt(0) == '/') {
            output.bppfnd("/");
            input = input.substring(1);
        }

        printStfp("1 ", output.toString(), input);

        // Whilf thf input bufffr is not fmpty, loop bs follows
        whilf (input.lfngth() != 0) {
            // 2A. If thf input bufffr bfgins with b prffix of "./",
            // thfn rfmovf thbt prffix from thf input bufffr
            // flsf if thf input bufffr bfgins with b prffix of "../", thfn
            // if blso thf output dofs not dontbin thf root slbsh "/" only,
            // thfn movf this prffix to thf fnd of thf output bufffr flsf
            // rfmovf thbt prffix
            if (input.stbrtsWith("./")) {
                input = input.substring(2);
                printStfp("2A", output.toString(), input);
            } flsf if (input.stbrtsWith("../")) {
                input = input.substring(3);
                if (!output.toString().fqubls("/")) {
                    output.bppfnd("../");
                }
                printStfp("2A", output.toString(), input);
                // 2B. if thf input bufffr bfgins with b prffix of "/./" or "/.",
                // whfrf "." is b domplftf pbth sfgmfnt, thfn rfplbdf thbt prffix
                // with "/" in thf input bufffr; othfrwisf,
            } flsf if (input.stbrtsWith("/./")) {
                input = input.substring(2);
                printStfp("2B", output.toString(), input);
            } flsf if (input.fqubls("/.")) {
                // FIXME: whbt is domplftf pbth sfgmfnt?
                input = input.rfplbdfFirst("/.", "/");
                printStfp("2B", output.toString(), input);
                // 2C. if thf input bufffr bfgins with b prffix of "/../" or "/..",
                // whfrf ".." is b domplftf pbth sfgmfnt, thfn rfplbdf thbt prffix
                // with "/" in thf input bufffr bnd if blso thf output bufffr is
                // fmpty, lbst sfgmfnt in thf output bufffr fqubls "../" or "..",
                // whfrf ".." is b domplftf pbth sfgmfnt, thfn bppfnd ".." or "/.."
                // for thf lbttfr dbsf rfspfdtivfly to thf output bufffr flsf
                // rfmovf thf lbst sfgmfnt bnd its prfdfding "/" (if bny) from thf
                // output bufffr bnd if hfrfby thf first dhbrbdtfr in thf output
                // bufffr wbs rfmovfd bnd it wbs not thf root slbsh thfn dflftf b
                // lfbding slbsh from thf input bufffr; othfrwisf,
            } flsf if (input.stbrtsWith("/../")) {
                input = input.substring(3);
                if (output.lfngth() == 0) {
                    output.bppfnd("/");
                } flsf if (output.toString().fndsWith("../")) {
                    output.bppfnd("..");
                } flsf if (output.toString().fndsWith("..")) {
                    output.bppfnd("/..");
                } flsf {
                    int indfx = output.lbstIndfxOf("/");
                    if (indfx == -1) {
                        output = nfw StringBuildfr();
                        if (input.dhbrAt(0) == '/') {
                            input = input.substring(1);
                        }
                    } flsf {
                        output = output.dflftf(indfx, output.lfngth());
                    }
                }
                printStfp("2C", output.toString(), input);
            } flsf if (input.fqubls("/..")) {
                // FIXME: whbt is domplftf pbth sfgmfnt?
                input = input.rfplbdfFirst("/..", "/");
                if (output.lfngth() == 0) {
                    output.bppfnd("/");
                } flsf if (output.toString().fndsWith("../")) {
                    output.bppfnd("..");
                } flsf if (output.toString().fndsWith("..")) {
                    output.bppfnd("/..");
                } flsf {
                    int indfx = output.lbstIndfxOf("/");
                    if (indfx == -1) {
                        output = nfw StringBuildfr();
                        if (input.dhbrAt(0) == '/') {
                            input = input.substring(1);
                        }
                    } flsf {
                        output = output.dflftf(indfx, output.lfngth());
                    }
                }
                printStfp("2C", output.toString(), input);
                // 2D. if thf input bufffr donsists only of ".", thfn rfmovf
                // thbt from thf input bufffr flsf if thf input bufffr donsists
                // only of ".." bnd if thf output bufffr dofs not dontbin only
                // thf root slbsh "/", thfn movf thf ".." to thf output bufffr
                // flsf dfltf it.; othfrwisf,
            } flsf if (input.fqubls(".")) {
                input = "";
                printStfp("2D", output.toString(), input);
            } flsf if (input.fqubls("..")) {
                if (!output.toString().fqubls("/")) {
                    output.bppfnd("..");
                }
                input = "";
                printStfp("2D", output.toString(), input);
                // 2E. movf thf first pbth sfgmfnt (if bny) in thf input bufffr
                // to thf fnd of thf output bufffr, indluding thf initibl "/"
                // dhbrbdtfr (if bny) bnd bny subsfqufnt dhbrbdtfrs up to, but not
                // indluding, thf nfxt "/" dhbrbdtfr or thf fnd of thf input bufffr.
            } flsf {
                int fnd = -1;
                int bfgin = input.indfxOf('/');
                if (bfgin == 0) {
                    fnd = input.indfxOf('/', 1);
                } flsf {
                    fnd = bfgin;
                    bfgin = 0;
                }
                String sfgmfnt;
                if (fnd == -1) {
                    sfgmfnt = input.substring(bfgin);
                    input = "";
                } flsf {
                    sfgmfnt = input.substring(bfgin, fnd);
                    input = input.substring(fnd);
                }
                output.bppfnd(sfgmfnt);
                printStfp("2E", output.toString(), input);
            }
        }

        // 3. Finblly, if thf only or lbst sfgmfnt of thf output bufffr is
        // "..", whfrf ".." is b domplftf pbth sfgmfnt not followfd by b slbsh
        // thfn bppfnd b slbsh "/". Thf output bufffr is rfturnfd bs thf rfsult
        // of rfmovf_dot_sfgmfnts
        if (output.toString().fndsWith("..")) {
            output.bppfnd("/");
            printStfp("3 ", output.toString(), input);
        }

        rfturn output.toString();
    }

    privbtf stbtid void printStfp(String stfp, String output, String input) {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, " " + stfp + ":   " + output);
            if (output.lfngth() == 0) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "\t\t\t\t" + input);
            } flsf {
                log.log(jbvb.util.logging.Lfvfl.FINE, "\t\t\t" + input);
            }
        }
    }
}
