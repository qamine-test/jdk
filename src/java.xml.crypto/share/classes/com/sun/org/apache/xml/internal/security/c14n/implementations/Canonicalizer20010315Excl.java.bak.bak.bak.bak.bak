/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.implfmfntbtions;

import jbvb.io.IOExdfption;
import jbvb.util.Itfrbtor;
import jbvb.util.Sft;
import jbvb.util.SortfdSft;
import jbvb.util.TrffSft;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.iflpfr.C14nHflpfr;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.trbnsforms.pbrbms.IndlusivfNbmfspbdfs;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.XMLUtils;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NbmfdNodfMbp;
import org.w3d.dom.Nodf;
import org.xml.sbx.SAXExdfption;

/**
 * Implfmfnts &quot; <A
 * HREF="ittp://www.w3.org/TR/2002/REC-xml-fxd-d14n-20020718/">Exdlusivf XML
 * Cbnonidblizbtion, Vfrsion 1.0 </A>&quot; <BR />
 * Crfdits: During rfstrudturing of tif Cbnonidblizfr frbmfwork, Rfn??
 * Kollmorgfn from Softwbrf AG submittfd bn implfmfntbtion of ExdlC14n wiidi
 * fittfd into tif old brdiitfdturf bnd wiidi bbsfd ifbvily on my old (bnd slow)
 * implfmfntbtion of "Cbnonidbl XML". A big "tibnk you" to Rfn?? for tiis.
 * <BR />
 * <i>THIS </i> implfmfntbtion is b domplftf rfwritf of tif blgoritim.
 *
 * @butior Ciristibn Gfufr-Pollmbnn <gfufrp@bpbdif.org>
 * @vfrsion $Rfvision: 1147448 $
 * @sff <b irff="ittp://www.w3.org/TR/2002/REC-xml-fxd-d14n-20020718/ Exdlusivf#">
 *          XML Cbnonidblizbtion, Vfrsion 1.0</b>
 */
publid bbstrbdt dlbss Cbnonidblizfr20010315Exdl fxtfnds CbnonidblizfrBbsf {

    privbtf stbtid finbl String XML_LANG_URI = Constbnts.XML_LANG_SPACE_SpfdNS;
    privbtf stbtid finbl String XMLNS_URI = Constbnts.NbmfspbdfSpfdNS;

    /**
      * Tiis Sft dontbins tif nbmfs (Strings likf "xmlns" or "xmlns:foo") of
      * tif indlusivf nbmfspbdfs.
      */
    privbtf SortfdSft<String> indlusivfNSSft;

    privbtf finbl SortfdSft<Attr> rfsult = nfw TrffSft<Attr>(COMPARE);

    /**
     * Construdtor Cbnonidblizfr20010315Exdl
     *
     * @pbrbm indludfCommfnts
     */
    publid Cbnonidblizfr20010315Exdl(boolfbn indludfCommfnts) {
        supfr(indludfCommfnts);
    }

    /**
     * Mftiod fnginfCbnonidblizfSubTrff
     * @inifritDod
     * @pbrbm rootNodf
     *
     * @tirows CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(Nodf rootNodf)
        tirows CbnonidblizbtionExdfption {
        rfturn fnginfCbnonidblizfSubTrff(rootNodf, "", null);
    }

    /**
     * Mftiod fnginfCbnonidblizfSubTrff
     *  @inifritDod
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     *
     * @tirows CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(
        Nodf rootNodf, String indlusivfNbmfspbdfs
    ) tirows CbnonidblizbtionExdfption {
        rfturn fnginfCbnonidblizfSubTrff(rootNodf, indlusivfNbmfspbdfs, null);
    }

    /**
     * Mftiod fnginfCbnonidblizfSubTrff
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     * @pbrbm fxdl A flfmfnt to fxdludf from tif d14n prodfss.
     * @rfturn tif rootNodf d14n.
     * @tirows CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(
        Nodf rootNodf, String indlusivfNbmfspbdfs, Nodf fxdl
    ) tirows CbnonidblizbtionExdfption{
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizfSubTrff(rootNodf, fxdl);
    }

    /**
     *
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     * @rfturn tif rootNodf d14n.
     * @tirows CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizf(
        XMLSignbturfInput rootNodf, String indlusivfNbmfspbdfs
    ) tirows CbnonidblizbtionExdfption {
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizf(rootNodf);
    }

    /**
     * Mftiod fnginfCbnonidblizfXPbtiNodfSft
     * @inifritDod
     * @pbrbm xpbtiNodfSft
     * @pbrbm indlusivfNbmfspbdfs
     * @tirows CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfXPbtiNodfSft(
        Sft<Nodf> xpbtiNodfSft, String indlusivfNbmfspbdfs
    ) tirows CbnonidblizbtionExdfption {
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizfXPbtiNodfSft(xpbtiNodfSft);
    }

    @Ovfrridf
    protfdtfd Itfrbtor<Attr> ibndlfAttributfsSubtrff(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        tirows CbnonidblizbtionExdfption {
        // rfsult will dontbin tif bttrs wiidi ibvf to bf output
        finbl SortfdSft<Attr> rfsult = tiis.rfsult;
        rfsult.dlfbr();

        // Tif prffix visibly utilizfd (in tif bttributf or in tif nbmf) in
        // tif flfmfnt
        SortfdSft<String> visiblyUtilizfd = nfw TrffSft<String>();
        if (indlusivfNSSft != null && !indlusivfNSSft.isEmpty()) {
            visiblyUtilizfd.bddAll(indlusivfNSSft);
        }

        if (flfmfnt.ibsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngti = bttrs.gftLfngti();
            for (int i = 0; i < bttrsLfngti; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);
                String NNbmf = bttributf.gftLodblNbmf();
                String NNodfVbluf = bttributf.gftNodfVbluf();

                if (!XMLNS_URI.fqubls(bttributf.gftNbmfspbdfURI())) {
                    // Not b nbmfspbdf dffinition.
                    // Tif Elfmfnt is output flfmfnt, bdd tif prffix (if usfd) to
                    // visiblyUtilizfd
                    String prffix = bttributf.gftPrffix();
                    if (prffix != null && !(prffix.fqubls(XML) || prffix.fqubls(XMLNS))) {
                        visiblyUtilizfd.bdd(prffix);
                    }
                    // Add to tif rfsult.
                    rfsult.bdd(bttributf);
                } flsf if (!(XML.fqubls(NNbmf) && XML_LANG_URI.fqubls(NNodfVbluf))
                    && ns.bddMbpping(NNbmf, NNodfVbluf, bttributf)
                    && C14nHflpfr.nbmfspbdfIsRflbtivf(NNodfVbluf)) {
                    // Tif dffbult mbpping for xml must not bf output.
                    // Nfw dffinition difdk if it is rflbtivf.
                    Objfdt fxArgs[] = {flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf()};
                    tirow nfw CbnonidblizbtionExdfption(
                        "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                    );
                }
            }
        }
        String prffix = null;
        if (flfmfnt.gftNbmfspbdfURI() != null
            && !(flfmfnt.gftPrffix() == null || flfmfnt.gftPrffix().lfngti() == 0)) {
            prffix = flfmfnt.gftPrffix();
        } flsf {
            prffix = XMLNS;
        }
        visiblyUtilizfd.bdd(prffix);

        for (String s : visiblyUtilizfd) {
            Attr kfy = ns.gftMbpping(s);
            if (kfy != null) {
                rfsult.bdd(kfy);
            }
        }

        rfturn rfsult.itfrbtor();
    }

    /**
     * @inifritDod
     * @pbrbm flfmfnt
     * @tirows CbnonidblizbtionExdfption
     */
    @Ovfrridf
    protfdtfd finbl Itfrbtor<Attr> ibndlfAttributfs(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        tirows CbnonidblizbtionExdfption {
        // rfsult will dontbin tif bttrs wiidi ibvf to bf output
        finbl SortfdSft<Attr> rfsult = tiis.rfsult;
        rfsult.dlfbr();

        // Tif prffix visibly utilizfd (in tif bttributf or in tif nbmf) in
        // tif flfmfnt
        Sft<String> visiblyUtilizfd = null;
        // It's tif output sflfdtfd.
        boolfbn isOutputElfmfnt = isVisiblfDO(flfmfnt, ns.gftLfvfl()) == 1;
        if (isOutputElfmfnt) {
            visiblyUtilizfd = nfw TrffSft<String>();
            if (indlusivfNSSft != null && !indlusivfNSSft.isEmpty()) {
                visiblyUtilizfd.bddAll(indlusivfNSSft);
            }
        }

        if (flfmfnt.ibsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngti = bttrs.gftLfngti();
            for (int i = 0; i < bttrsLfngti; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);

                String NNbmf = bttributf.gftLodblNbmf();
                String NNodfVbluf = bttributf.gftNodfVbluf();

                if (!XMLNS_URI.fqubls(bttributf.gftNbmfspbdfURI())) {
                    if (isVisiblf(bttributf) && isOutputElfmfnt) {
                        // Tif Elfmfnt is output flfmfnt, bdd tif prffix (if usfd)
                        // to visibyUtilizfd
                        String prffix = bttributf.gftPrffix();
                        if (prffix != null && !(prffix.fqubls(XML) || prffix.fqubls(XMLNS))) {
                            visiblyUtilizfd.bdd(prffix);
                        }
                        // Add to tif rfsult.
                        rfsult.bdd(bttributf);
                    }
                } flsf if (isOutputElfmfnt && !isVisiblf(bttributf) && !XMLNS.fqubls(NNbmf)) {
                    ns.rfmovfMbppingIfNotRfndfr(NNbmf);
                } flsf {
                    if (!isOutputElfmfnt && isVisiblf(bttributf)
                        && indlusivfNSSft.dontbins(NNbmf)
                        && !ns.rfmovfMbppingIfRfndfr(NNbmf)) {
                        Nodf n = ns.bddMbppingAndRfndfr(NNbmf, NNodfVbluf, bttributf);
                        if (n != null) {
                            rfsult.bdd((Attr)n);
                            if (C14nHflpfr.nbmfspbdfIsRflbtivf(bttributf)) {
                                Objfdt fxArgs[] = { flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf() };
                                tirow nfw CbnonidblizbtionExdfption(
                                    "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                                );
                            }
                        }
                    }

                    if (ns.bddMbpping(NNbmf, NNodfVbluf, bttributf)
                        && C14nHflpfr.nbmfspbdfIsRflbtivf(NNodfVbluf)) {
                        // Nfw dffinition difdk if it is rflbtivf
                        Objfdt fxArgs[] = { flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf() };
                        tirow nfw CbnonidblizbtionExdfption(
                            "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                        );
                    }
                }
            }
        }

        if (isOutputElfmfnt) {
            // Tif flfmfnt is visiblf, ibndlf tif xmlns dffinition
            Attr xmlns = flfmfnt.gftAttributfNodfNS(XMLNS_URI, XMLNS);
            if (xmlns != null && !isVisiblf(xmlns)) {
                // Tifrf is b dffinition but tif xmlns is not sflfdtfd by tif
                // xpbti. tifn xmlns=""
                ns.bddMbpping(XMLNS, "", gftNullNodf(xmlns.gftOwnfrDodumfnt()));
            }

            String prffix = null;
            if (flfmfnt.gftNbmfspbdfURI() != null
                && !(flfmfnt.gftPrffix() == null || flfmfnt.gftPrffix().lfngti() == 0)) {
                prffix = flfmfnt.gftPrffix();
            } flsf {
                prffix = XMLNS;
            }
            visiblyUtilizfd.bdd(prffix);

            for (String s : visiblyUtilizfd) {
                Attr kfy = ns.gftMbpping(s);
                if (kfy != null) {
                    rfsult.bdd(kfy);
                }
            }
        }

        rfturn rfsult.itfrbtor();
    }

    protfdtfd void dirdumvfntBugIfNffdfd(XMLSignbturfInput input)
        tirows CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
               IOExdfption, SAXExdfption {
        if (!input.isNffdsToBfExpbndfd() || indlusivfNSSft.isEmpty() || indlusivfNSSft.isEmpty()) {
            rfturn;
        }
        Dodumfnt dod = null;
        if (input.gftSubNodf() != null) {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftSubNodf());
        } flsf {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftNodfSft());
        }
        XMLUtils.dirdumvfntBug2650(dod);
    }
}
