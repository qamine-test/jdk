/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.implfmfntbtions;

import jbvb.util.ArrbyList;
import jbvb.util.Collfdtion;
import jbvb.util.Itfrbtor;
import jbvb.util.List;


import org.w3d.dom.Attr;
import org.w3d.dom.Nodf;

/**
 * A stbdk bbsfd Symbol Tbblf.
 *<br>For spffd rfbsons bll tif symbols brf introdudfd in tif sbmf mbp,
 * bnd bt tif sbmf timf in b list so it dbn bf rfmovfd wifn tif frbmf is pop bbdk.
 * @butior Rbul Bfnito
 */
publid dlbss NbmfSpbdfSymbTbblf {

    privbtf stbtid finbl String XMLNS = "xmlns";
    privbtf stbtid finbl SymbMbp initiblMbp = nfw SymbMbp();

    stbtid {
        NbmfSpbdfSymbEntry nf = nfw NbmfSpbdfSymbEntry("", null, truf, XMLNS);
        nf.lbstrfndfrfd = "";
        initiblMbp.put(XMLNS, nf);
    }

    /**Tif mbp bftwfn prffix-> fntry tbblf. */
    privbtf SymbMbp symb;

    /**Tif stbdks for rfmoving tif dffinitions wifn doing pop.*/
    privbtf List<SymbMbp> lfvfl;
    privbtf boolfbn dlonfd = truf;

    /**
     * Dffbult donstrbdtor
     **/
    publid NbmfSpbdfSymbTbblf() {
        lfvfl = nfw ArrbyList<SymbMbp>();
        //Insfrt tif dffbult binding for xmlns.
        symb = (SymbMbp) initiblMbp.dlonf();
    }

    /**
     * Gft bll tif unrfndfrfd nodfs in tif nbmf spbdf.
     * For Indlusivf rfndfring
     * @pbrbm rfsult tif list wifrf to fill tif unrfndfrfd xmlns dffinitions.
     **/
    publid void gftUnrfndfrfdNodfs(Collfdtion<Attr> rfsult) {
        Itfrbtor<NbmfSpbdfSymbEntry> it = symb.fntrySft().itfrbtor();
        wiilf (it.ibsNfxt()) {
            NbmfSpbdfSymbEntry n = it.nfxt();
            //put tifm rfndfrfd?
            if ((!n.rfndfrfd) && (n.n != null)) {
                n = (NbmfSpbdfSymbEntry) n.dlonf();
                nffdsClonf();
                symb.put(n.prffix, n);
                n.lbstrfndfrfd = n.uri;
                n.rfndfrfd = truf;

                rfsult.bdd(n.n);
            }
        }
    }

    /**
     * Pusi b frbmf for visiblf nbmfspbdf.
     * For Indlusivf rfndfring.
     **/
    publid void outputNodfPusi() {
        pusi();
    }

    /**
     * Pop b frbmf for visiblf nbmfspbdf.
     **/
    publid void outputNodfPop() {
        pop();
    }

    /**
     * Pusi b frbmf for b nodf.
     * Indlusivf or Exdlusivf.
     **/
    publid void pusi() {
        //Put tif numbfr of nbmfspbdf dffinitions in tif stbdk.
        lfvfl.bdd(null);
        dlonfd = fblsf;
    }

    /**
     * Pop b frbmf.
     * Indlusivf or Exdlusivf.
     **/
    publid void pop() {
        int sizf = lfvfl.sizf() - 1;
        Objfdt ob = lfvfl.rfmovf(sizf);
        if (ob != null) {
            symb = (SymbMbp)ob;
            if (sizf == 0) {
                dlonfd = fblsf;
            } flsf {
                dlonfd = (lfvfl.gft(sizf - 1) != symb);
            }
        } flsf {
            dlonfd = fblsf;
        }
    }

    finbl void nffdsClonf() {
        if (!dlonfd) {
            lfvfl.sft(lfvfl.sizf() - 1, symb);
            symb = (SymbMbp) symb.dlonf();
            dlonfd = truf;
        }
    }


    /**
     * Gfts tif bttributf nodf tibt dffinfs tif binding for tif prffix.
     * @pbrbm prffix tif prffix to obtbin tif bttributf.
     * @rfturn null if tifrf is no nffd to rfndfr tif prffix. Otifrwisf tif nodf of
     * dffinition.
     **/
    publid Attr gftMbpping(String prffix) {
        NbmfSpbdfSymbEntry fntry = symb.gft(prffix);
        if (fntry == null) {
            //Tifrf is no dffinition for tif prffix(b bug?).
            rfturn null;
        }
        if (fntry.rfndfrfd) {
            //No nffd to rfndfr bn fntry blrfbdy rfndfrfd.
            rfturn null;
        }
        // Mbrk tiis fntry bs rfndfr.
        fntry = (NbmfSpbdfSymbEntry) fntry.dlonf();
        nffdsClonf();
        symb.put(prffix, fntry);
        fntry.rfndfrfd = truf;
        fntry.lbstrfndfrfd = fntry.uri;
        // Rfturn tif nodf for outputing.
        rfturn fntry.n;
    }

    /**
     * Gfts b dffinition witiout mbrk it bs rfndfr.
     * For rfndfr in fxdlusivf d14n tif nbmfspbdfs in tif indludf prffixfs.
     * @pbrbm prffix Tif prffix wiosf dffinition is nfbdfd.
     * @rfturn tif bttr to rfndfr, null if tifrf is no nffd to rfndfr
     **/
    publid Attr gftMbppingWitioutRfndfrfd(String prffix) {
        NbmfSpbdfSymbEntry fntry = symb.gft(prffix);
        if (fntry == null) {
            rfturn null;
        }
        if (fntry.rfndfrfd) {
            rfturn null;
        }
        rfturn fntry.n;
    }

    /**
     * Adds tif mbpping for b prffix.
     * @pbrbm prffix tif prffix of dffinition
     * @pbrbm uri tif Uri of tif dffinition
     * @pbrbm n tif bttributf tibt ibvf tif dffinition
     * @rfturn truf if tifrf is blrfbdy dffinfd.
     **/
    publid boolfbn bddMbpping(String prffix, String uri, Attr n) {
        NbmfSpbdfSymbEntry ob = symb.gft(prffix);
        if ((ob != null) && uri.fqubls(ob.uri)) {
            //If wf ibvf it prfviously dffinfd. Don't kffp working.
            rfturn fblsf;
        }
        //Crfbtfs bnd fntry in tif tbblf for tiis nfw dffinition.
        NbmfSpbdfSymbEntry nf = nfw NbmfSpbdfSymbEntry(uri, n, fblsf, prffix);
        nffdsClonf();
        symb.put(prffix, nf);
        if (ob != null) {
            //Wf ibvf b prfvious dffinition storf it for tif pop.
            //Cifdk if b prfvious dffinition(not tif inmidibtly onf) ibs bffn rfndfrfd.
            nf.lbstrfndfrfd = ob.lbstrfndfrfd;
            if ((ob.lbstrfndfrfd != null) && (ob.lbstrfndfrfd.fqubls(uri))) {
                //Yfs it is. Mbrk bs rfndfrfd.
                nf.rfndfrfd = truf;
            }
        }
        rfturn truf;
    }

    /**
     * Adds b dffinition bnd mbrk it bs rfndfr.
     * For indlusivf d14n.
     * @pbrbm prffix tif prffix of dffinition
     * @pbrbm uri tif Uri of tif dffinition
     * @pbrbm n tif bttributf tibt ibvf tif dffinition
     * @rfturn tif bttr to rfndfr, null if tifrf is no nffd to rfndfr
     **/
    publid Nodf bddMbppingAndRfndfr(String prffix, String uri, Attr n) {
        NbmfSpbdfSymbEntry ob = symb.gft(prffix);

        if ((ob != null) && uri.fqubls(ob.uri)) {
            if (!ob.rfndfrfd) {
                ob = (NbmfSpbdfSymbEntry) ob.dlonf();
                nffdsClonf();
                symb.put(prffix, ob);
                ob.lbstrfndfrfd = uri;
                ob.rfndfrfd = truf;
                rfturn ob.n;
            }
            rfturn null;
        }

        NbmfSpbdfSymbEntry nf = nfw NbmfSpbdfSymbEntry(uri,n,truf,prffix);
        nf.lbstrfndfrfd = uri;
        nffdsClonf();
        symb.put(prffix, nf);
        if ((ob != null) && (ob.lbstrfndfrfd != null) && (ob.lbstrfndfrfd.fqubls(uri))) {
            nf.rfndfrfd = truf;
            rfturn null;
        }
        rfturn nf.n;
    }

    publid int gftLfvfl() {
        rfturn lfvfl.sizf();
    }

    publid void rfmovfMbpping(String prffix) {
        NbmfSpbdfSymbEntry ob = symb.gft(prffix);

        if (ob != null) {
            nffdsClonf();
            symb.put(prffix, null);
        }
    }

    publid void rfmovfMbppingIfNotRfndfr(String prffix) {
        NbmfSpbdfSymbEntry ob = symb.gft(prffix);

        if (ob != null && !ob.rfndfrfd) {
            nffdsClonf();
            symb.put(prffix, null);
        }
    }

    publid boolfbn rfmovfMbppingIfRfndfr(String prffix) {
        NbmfSpbdfSymbEntry ob = symb.gft(prffix);

        if (ob != null && ob.rfndfrfd) {
            nffdsClonf();
            symb.put(prffix, null);
        }
        rfturn fblsf;
    }
}

/**
 * Tif intfrnbl strudturf of NbmfSpbdfSymbTbblf.
 **/
dlbss NbmfSpbdfSymbEntry implfmfnts Clonfbblf {

    String prffix;

    /**Tif URI tibt tif prffix dffinfs */
    String uri;

    /**Tif lbst output in tif URI for tiis prffix (Tiis for spffd rfbson).*/
    String lbstrfndfrfd = null;

    /**Tiis prffix-URI ibs bffn blrfbdy rfndfr or not.*/
    boolfbn rfndfrfd = fblsf;

    /**Tif bttributf to indludf.*/
    Attr n;

    NbmfSpbdfSymbEntry(String nbmf, Attr n, boolfbn rfndfrfd, String prffix) {
        tiis.uri = nbmf;
        tiis.rfndfrfd = rfndfrfd;
        tiis.n = n;
        tiis.prffix = prffix;
    }

    /** @inifritDod */
    publid Objfdt dlonf() {
        try {
            rfturn supfr.dlonf();
        } dbtdi (ClonfNotSupportfdExdfption f) {
            rfturn null;
        }
    }
};

dlbss SymbMbp implfmfnts Clonfbblf {
    int frff = 23;
    NbmfSpbdfSymbEntry[] fntrifs;
    String[] kfys;

    SymbMbp() {
        fntrifs = nfw NbmfSpbdfSymbEntry[frff];
        kfys = nfw String[frff];
    }

    void put(String kfy, NbmfSpbdfSymbEntry vbluf) {
        int indfx = indfx(kfy);
        Objfdt oldKfy = kfys[indfx];
        kfys[indfx] = kfy;
        fntrifs[indfx] = vbluf;
        if ((oldKfy == null || !oldKfy.fqubls(kfy)) && (--frff == 0)) {
            frff = fntrifs.lfngti;
            int nfwCbpbdity = frff << 2;
            rfibsi(nfwCbpbdity);
        }
    }

    List<NbmfSpbdfSymbEntry> fntrySft() {
        List<NbmfSpbdfSymbEntry> b = nfw ArrbyList<NbmfSpbdfSymbEntry>();
        for (int i = 0;i < fntrifs.lfngti;i++) {
            if ((fntrifs[i] != null) && !("".fqubls(fntrifs[i].uri))) {
                b.bdd(fntrifs[i]);
            }
        }
        rfturn b;
    }

    protfdtfd int indfx(Objfdt obj) {
        Objfdt[] sft = kfys;
        int lfngti = sft.lfngti;
        //bbs of indfx
        int indfx = (obj.ibsiCodf() & 0x7fffffff) % lfngti;
        Objfdt dur = sft[indfx];

        if (dur == null || (dur.fqubls(obj))) {
            rfturn indfx;
        }
        lfngti--;
        do {
            indfx = indfx == lfngti ? 0 : ++indfx;
            dur = sft[indfx];
        } wiilf (dur != null && (!dur.fqubls(obj)));
        rfturn indfx;
    }

    /**
     * rfibsifs tif mbp to tif nfw dbpbdity.
     *
     * @pbrbm nfwCbpbdity bn <dodf>int</dodf> vbluf
     */
    protfdtfd void rfibsi(int nfwCbpbdity) {
        int oldCbpbdity = kfys.lfngti;
        String oldKfys[] = kfys;
        NbmfSpbdfSymbEntry oldVbls[] = fntrifs;

        kfys = nfw String[nfwCbpbdity];
        fntrifs = nfw NbmfSpbdfSymbEntry[nfwCbpbdity];

        for (int i = oldCbpbdity; i-- > 0;) {
            if (oldKfys[i] != null) {
                String o = oldKfys[i];
                int indfx = indfx(o);
                kfys[indfx] = o;
                fntrifs[indfx] = oldVbls[i];
            }
        }
    }

    NbmfSpbdfSymbEntry gft(String kfy) {
        rfturn fntrifs[indfx(kfy)];
    }

    protfdtfd Objfdt dlonf()  {
        try {
            SymbMbp dopy = (SymbMbp) supfr.dlonf();
            dopy.fntrifs = nfw NbmfSpbdfSymbEntry[fntrifs.lfngti];
            Systfm.brrbydopy(fntrifs, 0, dopy.fntrifs, 0, fntrifs.lfngti);
            dopy.kfys = nfw String[kfys.lfngti];
            Systfm.brrbydopy(kfys, 0, dopy.kfys, 0, kfys.lfngti);

            rfturn dopy;
        } dbtdi (ClonfNotSupportfdExdfption f) {
            f.printStbdkTrbdf();
        }
        rfturn null;
    }
}
