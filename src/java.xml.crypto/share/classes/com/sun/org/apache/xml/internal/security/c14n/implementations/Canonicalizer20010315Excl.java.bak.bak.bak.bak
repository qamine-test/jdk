/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.implfmfntbtions;

import jbvb.io.IOExdfption;
import jbvb.util.Itfrbtor;
import jbvb.util.Sft;
import jbvb.util.SortfdSft;
import jbvb.util.TrffSft;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.hflpfr.C14nHflpfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.pbrbms.IndlusivfNbmfspbdfs;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NbmfdNodfMbp;
import org.w3d.dom.Nodf;
import org.xml.sbx.SAXExdfption;

/**
 * Implfmfnts &quot; <A
 * HREF="http://www.w3.org/TR/2002/REC-xml-fxd-d14n-20020718/">Exdlusivf XML
 * Cbnonidblizbtion, Vfrsion 1.0 </A>&quot; <BR />
 * Crfdits: During rfstrudturing of thf Cbnonidblizfr frbmfwork, Rfn??
 * Kollmorgfn from Softwbrf AG submittfd bn implfmfntbtion of ExdlC14n whidh
 * fittfd into thf old brdhitfdturf bnd whidh bbsfd hfbvily on my old (bnd slow)
 * implfmfntbtion of "Cbnonidbl XML". A big "thbnk you" to Rfn?? for this.
 * <BR />
 * <i>THIS </i> implfmfntbtion is b domplftf rfwritf of thf blgorithm.
 *
 * @buthor Christibn Gfufr-Pollmbnn <gfufrp@bpbdhf.org>
 * @vfrsion $Rfvision: 1147448 $
 * @sff <b hrff="http://www.w3.org/TR/2002/REC-xml-fxd-d14n-20020718/ Exdlusivf#">
 *          XML Cbnonidblizbtion, Vfrsion 1.0</b>
 */
publid bbstrbdt dlbss Cbnonidblizfr20010315Exdl fxtfnds CbnonidblizfrBbsf {

    privbtf stbtid finbl String XML_LANG_URI = Constbnts.XML_LANG_SPACE_SpfdNS;
    privbtf stbtid finbl String XMLNS_URI = Constbnts.NbmfspbdfSpfdNS;

    /**
      * This Sft dontbins thf nbmfs (Strings likf "xmlns" or "xmlns:foo") of
      * thf indlusivf nbmfspbdfs.
      */
    privbtf SortfdSft<String> indlusivfNSSft;

    privbtf finbl SortfdSft<Attr> rfsult = nfw TrffSft<Attr>(COMPARE);

    /**
     * Construdtor Cbnonidblizfr20010315Exdl
     *
     * @pbrbm indludfCommfnts
     */
    publid Cbnonidblizfr20010315Exdl(boolfbn indludfCommfnts) {
        supfr(indludfCommfnts);
    }

    /**
     * Mfthod fnginfCbnonidblizfSubTrff
     * @inhfritDod
     * @pbrbm rootNodf
     *
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(Nodf rootNodf)
        throws CbnonidblizbtionExdfption {
        rfturn fnginfCbnonidblizfSubTrff(rootNodf, "", null);
    }

    /**
     * Mfthod fnginfCbnonidblizfSubTrff
     *  @inhfritDod
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     *
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(
        Nodf rootNodf, String indlusivfNbmfspbdfs
    ) throws CbnonidblizbtionExdfption {
        rfturn fnginfCbnonidblizfSubTrff(rootNodf, indlusivfNbmfspbdfs, null);
    }

    /**
     * Mfthod fnginfCbnonidblizfSubTrff
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     * @pbrbm fxdl A flfmfnt to fxdludf from thf d14n prodfss.
     * @rfturn thf rootNodf d14n.
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfSubTrff(
        Nodf rootNodf, String indlusivfNbmfspbdfs, Nodf fxdl
    ) throws CbnonidblizbtionExdfption{
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizfSubTrff(rootNodf, fxdl);
    }

    /**
     *
     * @pbrbm rootNodf
     * @pbrbm indlusivfNbmfspbdfs
     * @rfturn thf rootNodf d14n.
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizf(
        XMLSignbturfInput rootNodf, String indlusivfNbmfspbdfs
    ) throws CbnonidblizbtionExdfption {
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizf(rootNodf);
    }

    /**
     * Mfthod fnginfCbnonidblizfXPbthNodfSft
     * @inhfritDod
     * @pbrbm xpbthNodfSft
     * @pbrbm indlusivfNbmfspbdfs
     * @throws CbnonidblizbtionExdfption
     */
    publid bytf[] fnginfCbnonidblizfXPbthNodfSft(
        Sft<Nodf> xpbthNodfSft, String indlusivfNbmfspbdfs
    ) throws CbnonidblizbtionExdfption {
        indlusivfNSSft = IndlusivfNbmfspbdfs.prffixStr2Sft(indlusivfNbmfspbdfs);
        rfturn supfr.fnginfCbnonidblizfXPbthNodfSft(xpbthNodfSft);
    }

    @Ovfrridf
    protfdtfd Itfrbtor<Attr> hbndlfAttributfsSubtrff(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        throws CbnonidblizbtionExdfption {
        // rfsult will dontbin thf bttrs whidh hbvf to bf output
        finbl SortfdSft<Attr> rfsult = this.rfsult;
        rfsult.dlfbr();

        // Thf prffix visibly utilizfd (in thf bttributf or in thf nbmf) in
        // thf flfmfnt
        SortfdSft<String> visiblyUtilizfd = nfw TrffSft<String>();
        if (indlusivfNSSft != null && !indlusivfNSSft.isEmpty()) {
            visiblyUtilizfd.bddAll(indlusivfNSSft);
        }

        if (flfmfnt.hbsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngth = bttrs.gftLfngth();
            for (int i = 0; i < bttrsLfngth; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);
                String NNbmf = bttributf.gftLodblNbmf();
                String NNodfVbluf = bttributf.gftNodfVbluf();

                if (!XMLNS_URI.fqubls(bttributf.gftNbmfspbdfURI())) {
                    // Not b nbmfspbdf dffinition.
                    // Thf Elfmfnt is output flfmfnt, bdd thf prffix (if usfd) to
                    // visiblyUtilizfd
                    String prffix = bttributf.gftPrffix();
                    if (prffix != null && !(prffix.fqubls(XML) || prffix.fqubls(XMLNS))) {
                        visiblyUtilizfd.bdd(prffix);
                    }
                    // Add to thf rfsult.
                    rfsult.bdd(bttributf);
                } flsf if (!(XML.fqubls(NNbmf) && XML_LANG_URI.fqubls(NNodfVbluf))
                    && ns.bddMbpping(NNbmf, NNodfVbluf, bttributf)
                    && C14nHflpfr.nbmfspbdfIsRflbtivf(NNodfVbluf)) {
                    // Thf dffbult mbpping for xml must not bf output.
                    // Nfw dffinition dhfdk if it is rflbtivf.
                    Objfdt fxArgs[] = {flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf()};
                    throw nfw CbnonidblizbtionExdfption(
                        "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                    );
                }
            }
        }
        String prffix = null;
        if (flfmfnt.gftNbmfspbdfURI() != null
            && !(flfmfnt.gftPrffix() == null || flfmfnt.gftPrffix().lfngth() == 0)) {
            prffix = flfmfnt.gftPrffix();
        } flsf {
            prffix = XMLNS;
        }
        visiblyUtilizfd.bdd(prffix);

        for (String s : visiblyUtilizfd) {
            Attr kfy = ns.gftMbpping(s);
            if (kfy != null) {
                rfsult.bdd(kfy);
            }
        }

        rfturn rfsult.itfrbtor();
    }

    /**
     * @inhfritDod
     * @pbrbm flfmfnt
     * @throws CbnonidblizbtionExdfption
     */
    @Ovfrridf
    protfdtfd finbl Itfrbtor<Attr> hbndlfAttributfs(Elfmfnt flfmfnt, NbmfSpbdfSymbTbblf ns)
        throws CbnonidblizbtionExdfption {
        // rfsult will dontbin thf bttrs whidh hbvf to bf output
        finbl SortfdSft<Attr> rfsult = this.rfsult;
        rfsult.dlfbr();

        // Thf prffix visibly utilizfd (in thf bttributf or in thf nbmf) in
        // thf flfmfnt
        Sft<String> visiblyUtilizfd = null;
        // It's thf output sflfdtfd.
        boolfbn isOutputElfmfnt = isVisiblfDO(flfmfnt, ns.gftLfvfl()) == 1;
        if (isOutputElfmfnt) {
            visiblyUtilizfd = nfw TrffSft<String>();
            if (indlusivfNSSft != null && !indlusivfNSSft.isEmpty()) {
                visiblyUtilizfd.bddAll(indlusivfNSSft);
            }
        }

        if (flfmfnt.hbsAttributfs()) {
            NbmfdNodfMbp bttrs = flfmfnt.gftAttributfs();
            int bttrsLfngth = bttrs.gftLfngth();
            for (int i = 0; i < bttrsLfngth; i++) {
                Attr bttributf = (Attr) bttrs.itfm(i);

                String NNbmf = bttributf.gftLodblNbmf();
                String NNodfVbluf = bttributf.gftNodfVbluf();

                if (!XMLNS_URI.fqubls(bttributf.gftNbmfspbdfURI())) {
                    if (isVisiblf(bttributf) && isOutputElfmfnt) {
                        // Thf Elfmfnt is output flfmfnt, bdd thf prffix (if usfd)
                        // to visibyUtilizfd
                        String prffix = bttributf.gftPrffix();
                        if (prffix != null && !(prffix.fqubls(XML) || prffix.fqubls(XMLNS))) {
                            visiblyUtilizfd.bdd(prffix);
                        }
                        // Add to thf rfsult.
                        rfsult.bdd(bttributf);
                    }
                } flsf if (isOutputElfmfnt && !isVisiblf(bttributf) && !XMLNS.fqubls(NNbmf)) {
                    ns.rfmovfMbppingIfNotRfndfr(NNbmf);
                } flsf {
                    if (!isOutputElfmfnt && isVisiblf(bttributf)
                        && indlusivfNSSft.dontbins(NNbmf)
                        && !ns.rfmovfMbppingIfRfndfr(NNbmf)) {
                        Nodf n = ns.bddMbppingAndRfndfr(NNbmf, NNodfVbluf, bttributf);
                        if (n != null) {
                            rfsult.bdd((Attr)n);
                            if (C14nHflpfr.nbmfspbdfIsRflbtivf(bttributf)) {
                                Objfdt fxArgs[] = { flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf() };
                                throw nfw CbnonidblizbtionExdfption(
                                    "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                                );
                            }
                        }
                    }

                    if (ns.bddMbpping(NNbmf, NNodfVbluf, bttributf)
                        && C14nHflpfr.nbmfspbdfIsRflbtivf(NNodfVbluf)) {
                        // Nfw dffinition dhfdk if it is rflbtivf
                        Objfdt fxArgs[] = { flfmfnt.gftTbgNbmf(), NNbmf, bttributf.gftNodfVbluf() };
                        throw nfw CbnonidblizbtionExdfption(
                            "d14n.Cbnonidblizfr.RflbtivfNbmfspbdf", fxArgs
                        );
                    }
                }
            }
        }

        if (isOutputElfmfnt) {
            // Thf flfmfnt is visiblf, hbndlf thf xmlns dffinition
            Attr xmlns = flfmfnt.gftAttributfNodfNS(XMLNS_URI, XMLNS);
            if (xmlns != null && !isVisiblf(xmlns)) {
                // Thfrf is b dffinition but thf xmlns is not sflfdtfd by thf
                // xpbth. thfn xmlns=""
                ns.bddMbpping(XMLNS, "", gftNullNodf(xmlns.gftOwnfrDodumfnt()));
            }

            String prffix = null;
            if (flfmfnt.gftNbmfspbdfURI() != null
                && !(flfmfnt.gftPrffix() == null || flfmfnt.gftPrffix().lfngth() == 0)) {
                prffix = flfmfnt.gftPrffix();
            } flsf {
                prffix = XMLNS;
            }
            visiblyUtilizfd.bdd(prffix);

            for (String s : visiblyUtilizfd) {
                Attr kfy = ns.gftMbpping(s);
                if (kfy != null) {
                    rfsult.bdd(kfy);
                }
            }
        }

        rfturn rfsult.itfrbtor();
    }

    protfdtfd void dirdumvfntBugIfNffdfd(XMLSignbturfInput input)
        throws CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
               IOExdfption, SAXExdfption {
        if (!input.isNffdsToBfExpbndfd() || indlusivfNSSft.isEmpty() || indlusivfNSSft.isEmpty()) {
            rfturn;
        }
        Dodumfnt dod = null;
        if (input.gftSubNodf() != null) {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftSubNodf());
        } flsf {
            dod = XMLUtils.gftOwnfrDodumfnt(input.gftNodfSft());
        }
        XMLUtils.dirdumvfntBug2650(dod);
    }
}
