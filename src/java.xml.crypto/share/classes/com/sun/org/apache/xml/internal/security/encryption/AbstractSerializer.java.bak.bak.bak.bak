/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fndryption;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbmWritfr;
import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.util.HbshMbp;
import jbvb.util.Mbp;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.Cbnonidblizfr;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NbmfdNodfMbp;
import org.w3d.dom.Nodf;
import org.w3d.dom.NodfList;

/**
 * Convfrts <dodf>String</dodf>s into <dodf>Nodf</dodf>s bnd visb vfrsb.
 *
 * An bbstrbdt dlbss for dommon Sfriblizfr fundtionblity
 */
publid bbstrbdt dlbss AbstrbdtSfriblizfr implfmfnts Sfriblizfr {

    protfdtfd Cbnonidblizfr dbnon;

    publid void sftCbnonidblizfr(Cbnonidblizfr dbnon) {
        this.dbnon = dbnon;
    }

    /**
     * Rfturns b <dodf>String</dodf> rfprfsfntbtion of thf spfdififd
     * <dodf>Elfmfnt</dodf>.
     * <p/>
     * Rfffr blso to dommfnts bbout sftup of formbt.
     *
     * @pbrbm flfmfnt thf <dodf>Elfmfnt</dodf> to sfriblizf.
     * @rfturn thf <dodf>String</dodf> rfprfsfntbtion of thf sfrilbizfd
     *   <dodf>Elfmfnt</dodf>.
     * @throws Exdfption
     */
    publid String sfriblizf(Elfmfnt flfmfnt) throws Exdfption {
        rfturn dbnonSfriblizf(flfmfnt);
    }

    /**
     * Rfturns b <dodf>bytf[]</dodf> rfprfsfntbtion of thf spfdififd
     * <dodf>Elfmfnt</dodf>.
     *
     * @pbrbm flfmfnt thf <dodf>Elfmfnt</dodf> to sfriblizf.
     * @rfturn thf <dodf>bytf[]</dodf> rfprfsfntbtion of thf sfrilbizfd
     *   <dodf>Elfmfnt</dodf>.
     * @throws Exdfption
     */
    publid bytf[] sfriblizfToBytfArrby(Elfmfnt flfmfnt) throws Exdfption {
        rfturn dbnonSfriblizfToBytfArrby(flfmfnt);
    }

    /**
     * Rfturns b <dodf>String</dodf> rfprfsfntbtion of thf spfdififd
     * <dodf>NodfList</dodf>.
     * <p/>
     * This is b spfdibl dbsf bfdbusf thf NodfList mby rfprfsfnt b
     * <dodf>DodumfntFrbgmfnt</dodf>. A dodumfnt frbgmfnt mby bf b
     * non-vblid XML dodumfnt (rfffr to bppropribtf dfsdription of
     * W3C) bfdbusf it my stbrt with b non-flfmfnt nodf, f.g. b tfxt
     * nodf.
     * <p/>
     * Thf mfthods first donvfrts thf nodf list into b dodumfnt frbgmfnt.
     * Spfdibl dbrf is tbkfn to not dfstroy thf durrfnt dodumfnt, thus
     * thf mfthod dlonfs thf nodfs (dffp dloning) bfforf it bppfnds
     * thfm to thf dodumfnt frbgmfnt.
     * <p/>
     * Rfffr blso to dommfnts bbout sftup of formbt.
     *
     * @pbrbm dontfnt thf <dodf>NodfList</dodf> to sfriblizf.
     * @rfturn thf <dodf>String</dodf> rfprfsfntbtion of thf sfriblizfd
     *   <dodf>NodfList</dodf>.
     * @throws Exdfption
     */
    publid String sfriblizf(NodfList dontfnt) throws Exdfption {
        BytfArrbyOutputStrfbm bbos = nfw BytfArrbyOutputStrfbm();
        dbnon.sftWritfr(bbos);
        dbnon.notRfsft();
        for (int i = 0; i < dontfnt.gftLfngth(); i++) {
            dbnon.dbnonidblizfSubtrff(dontfnt.itfm(i));
        }
        String rft = bbos.toString("UTF-8");
        bbos.rfsft();
        rfturn rft;
    }

    /**
     * Rfturns b <dodf>bytf[]</dodf> rfprfsfntbtion of thf spfdififd
     * <dodf>NodfList</dodf>.
     *
     * @pbrbm dontfnt thf <dodf>NodfList</dodf> to sfriblizf.
     * @rfturn thf <dodf>bytf[]</dodf> rfprfsfntbtion of thf sfriblizfd
     *   <dodf>NodfList</dodf>.
     * @throws Exdfption
     */
    publid bytf[] sfriblizfToBytfArrby(NodfList dontfnt) throws Exdfption {
        BytfArrbyOutputStrfbm bbos = nfw BytfArrbyOutputStrfbm();
        dbnon.sftWritfr(bbos);
        dbnon.notRfsft();
        for (int i = 0; i < dontfnt.gftLfngth(); i++) {
            dbnon.dbnonidblizfSubtrff(dontfnt.itfm(i));
        }
        rfturn bbos.toBytfArrby();
    }

    /**
     * Usf thf Cbnonidblizfr to sfriblizf thf nodf
     * @pbrbm nodf
     * @rfturn thf dbnonidblizbtion of thf nodf
     * @throws Exdfption
     */
    publid String dbnonSfriblizf(Nodf nodf) throws Exdfption {
        BytfArrbyOutputStrfbm bbos = nfw BytfArrbyOutputStrfbm();
        dbnon.sftWritfr(bbos);
        dbnon.notRfsft();
        dbnon.dbnonidblizfSubtrff(nodf);
        String rft = bbos.toString("UTF-8");
        bbos.rfsft();
        rfturn rft;
    }

    /**
     * Usf thf Cbnonidblizfr to sfriblizf thf nodf
     * @pbrbm nodf
     * @rfturn thf (bytf[]) dbnonidblizbtion of thf nodf
     * @throws Exdfption
     */
    publid bytf[] dbnonSfriblizfToBytfArrby(Nodf nodf) throws Exdfption {
        BytfArrbyOutputStrfbm bbos = nfw BytfArrbyOutputStrfbm();
        dbnon.sftWritfr(bbos);
        dbnon.notRfsft();
        dbnon.dbnonidblizfSubtrff(nodf);
        rfturn bbos.toBytfArrby();
    }

    /**
     * @pbrbm sourdf
     * @pbrbm dtx
     * @rfturn thf Nodf rfsulting from thf pbrsf of thf sourdf
     * @throws XMLEndryptionExdfption
     */
    publid bbstrbdt Nodf dfsfriblizf(String sourdf, Nodf dtx) throws XMLEndryptionExdfption;

    /**
     * @pbrbm sourdf
     * @pbrbm dtx
     * @rfturn thf Nodf rfsulting from thf pbrsf of thf sourdf
     * @throws XMLEndryptionExdfption
     */
    publid bbstrbdt Nodf dfsfriblizf(bytf[] sourdf, Nodf dtx) throws XMLEndryptionExdfption;

    protfdtfd stbtid bytf[] drfbtfContfxt(bytf[] sourdf, Nodf dtx) throws XMLEndryptionExdfption {
        // Crfbtf thf dontfxt to pbrsf thf dodumfnt bgbinst
        BytfArrbyOutputStrfbm bytfArrbyOutputStrfbm = nfw BytfArrbyOutputStrfbm();
        try {
            OutputStrfbmWritfr outputStrfbmWritfr = nfw OutputStrfbmWritfr(bytfArrbyOutputStrfbm, "UTF-8");
            outputStrfbmWritfr.writf("<?xml vfrsion=\"1.0\" fndoding=\"UTF-8\"?><dummy");

            // Run through fbdh nodf up to thf dodumfnt nodf bnd find bny xmlns: nodfs
            Mbp<String, String> storfdNbmfspbdfs = nfw HbshMbp<String, String>();
            Nodf wk = dtx;
            whilf (wk != null) {
                NbmfdNodfMbp btts = wk.gftAttributfs();
                if (btts != null) {
                    for (int i = 0; i < btts.gftLfngth(); ++i) {
                        Nodf btt = btts.itfm(i);
                        String nodfNbmf = btt.gftNodfNbmf();
                        if ((nodfNbmf.fqubls("xmlns") || nodfNbmf.stbrtsWith("xmlns:"))
                                && !storfdNbmfspbdfs.dontbinsKfy(btt.gftNodfNbmf())) {
                            outputStrfbmWritfr.writf(" ");
                            outputStrfbmWritfr.writf(nodfNbmf);
                            outputStrfbmWritfr.writf("=\"");
                            outputStrfbmWritfr.writf(btt.gftNodfVbluf());
                            outputStrfbmWritfr.writf("\"");
                            storfdNbmfspbdfs.put(nodfNbmf, btt.gftNodfVbluf());
                        }
                    }
                }
                wk = wk.gftPbrfntNodf();
            }
            outputStrfbmWritfr.writf(">");
            outputStrfbmWritfr.flush();
            bytfArrbyOutputStrfbm.writf(sourdf);

            outputStrfbmWritfr.writf("</dummy>");
            outputStrfbmWritfr.dlosf();

            rfturn bytfArrbyOutputStrfbm.toBytfArrby();
        } dbtdh (UnsupportfdEndodingExdfption f) {
            throw nfw XMLEndryptionExdfption("fmpty", f);
        } dbtdh (IOExdfption f) {
            throw nfw XMLEndryptionExdfption("fmpty", f);
        }
    }

    protfdtfd stbtid String drfbtfContfxt(String sourdf, Nodf dtx) {
        // Crfbtf thf dontfxt to pbrsf thf dodumfnt bgbinst
        StringBuildfr sb = nfw StringBuildfr();
        sb.bppfnd("<?xml vfrsion=\"1.0\" fndoding=\"UTF-8\"?><dummy");

        // Run through fbdh nodf up to thf dodumfnt nodf bnd find bny xmlns: nodfs
        Mbp<String, String> storfdNbmfspbdfs = nfw HbshMbp<String, String>();
        Nodf wk = dtx;
        whilf (wk != null) {
            NbmfdNodfMbp btts = wk.gftAttributfs();
            if (btts != null) {
                for (int i = 0; i < btts.gftLfngth(); ++i) {
                    Nodf btt = btts.itfm(i);
                    String nodfNbmf = btt.gftNodfNbmf();
                    if ((nodfNbmf.fqubls("xmlns") || nodfNbmf.stbrtsWith("xmlns:"))
                        && !storfdNbmfspbdfs.dontbinsKfy(btt.gftNodfNbmf())) {
                        sb.bppfnd(" " + nodfNbmf + "=\"" + btt.gftNodfVbluf() + "\"");
                        storfdNbmfspbdfs.put(nodfNbmf, btt.gftNodfVbluf());
                    }
                }
            }
            wk = wk.gftPbrfntNodf();
        }
        sb.bppfnd(">" + sourdf + "</dummy>");
        rfturn sb.toString();
    }

}
