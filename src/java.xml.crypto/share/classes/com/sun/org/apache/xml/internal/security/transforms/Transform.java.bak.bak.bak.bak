/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms;

import jbvb.io.IOExdfption;
import jbvb.io.OutputStrfbm;
import jbvb.util.dondurrfnt.CondurrfntHbshMbp;
import jbvb.util.Mbp;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.InvblidCbnonidblizfrExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fxdfptions.AlgorithmAlrfbdyRfgistfrfdExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fxdfptions.XMLSfdurityExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformBbsf64Dfdodf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14N;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14N11;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14N11_WithCommfnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14NExdlusivf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14NExdlusivfWithCommfnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformC14NWithCommfnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformEnvflopfdSignbturf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformXPbth;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformXPbth2Filtfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.implfmfntbtions.TrbnsformXSLT;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.HflpfrNodfList;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.SignbturfElfmfntProxy;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NodfList;
import org.xml.sbx.SAXExdfption;

/**
 * Implfmfnts thf bfhbviour of thf <dodf>ds:Trbnsform</dodf> flfmfnt.
 *
 * This <dodf>Trbnsform</dodf>(Fbdtory) dlbss bdts bs thf Fbdtory bnd Proxy of
 * thf implfmfnting dlbss thbt supports thf fundtionblity of <b
 * hrff=http://www.w3.org/TR/xmldsig-dorf/#sfd-TrbnsformAlg>b Trbnsform
 * blgorithm</b>.
 * Implfmfnts thf Fbdtory bnd Proxy pbttfrn for ds:Trbnsform blgorithms.
 *
 * @buthor Christibn Gfufr-Pollmbnn
 * @sff Trbnsforms
 * @sff TrbnsformSpi
 */
publid finbl dlbss Trbnsform fxtfnds SignbturfElfmfntProxy {

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(Trbnsform.dlbss.gftNbmf());

    /** All bvbilbblf Trbnsform dlbssfs brf rfgistfrfd hfrf */
    privbtf stbtid Mbp<String, Clbss<? fxtfnds TrbnsformSpi>> trbnsformSpiHbsh =
        nfw CondurrfntHbshMbp<String, Clbss<? fxtfnds TrbnsformSpi>>();

    privbtf finbl TrbnsformSpi trbnsformSpi;

    /**
     * Gfnfrbtfs b Trbnsform objfdt thbt implfmfnts thf spfdififd
     * <dodf>Trbnsform blgorithm</dodf> URI.
     *
     * @pbrbm dod thf proxy {@link Dodumfnt}
     * @pbrbm blgorithmURI <dodf>Trbnsform blgorithm</dodf> URI rfprfsfntbtion,
     * sudh bs spfdififd in
     * <b hrff=http://www.w3.org/TR/xmldsig-dorf/#sfd-TrbnsformAlg>Trbnsform blgorithm </b>
     * @throws InvblidTrbnsformExdfption
     */
    publid Trbnsform(Dodumfnt dod, String blgorithmURI) throws InvblidTrbnsformExdfption {
        this(dod, blgorithmURI, (NodfList)null);
    }

    /**
     * Gfnfrbtfs b Trbnsform objfdt thbt implfmfnts thf spfdififd
     * <dodf>Trbnsform blgorithm</dodf> URI.
     *
     * @pbrbm blgorithmURI <dodf>Trbnsform blgorithm</dodf> URI rfprfsfntbtion,
     * sudh bs spfdififd in
     * <b hrff=http://www.w3.org/TR/xmldsig-dorf/#sfd-TrbnsformAlg>Trbnsform blgorithm </b>
     * @pbrbm dontfxtChild thf dhild flfmfnt of <dodf>Trbnsform</dodf> flfmfnt
     * @pbrbm dod thf proxy {@link Dodumfnt}
     * @throws InvblidTrbnsformExdfption
     */
    publid Trbnsform(Dodumfnt dod, String blgorithmURI, Elfmfnt dontfxtChild)
        throws InvblidTrbnsformExdfption {
        supfr(dod);
        HflpfrNodfList dontfxtNodfs = null;

        if (dontfxtChild != null) {
            dontfxtNodfs = nfw HflpfrNodfList();

            XMLUtils.bddRfturnToElfmfnt(dod, dontfxtNodfs);
            dontfxtNodfs.bppfndChild(dontfxtChild);
            XMLUtils.bddRfturnToElfmfnt(dod, dontfxtNodfs);
        }

        trbnsformSpi = initiblizfTrbnsform(blgorithmURI, dontfxtNodfs);
    }

    /**
     * Construdts {@link Trbnsform}
     *
     * @pbrbm dod thf {@link Dodumfnt} in whidh <dodf>Trbnsform</dodf> will bf
     * plbdfd
     * @pbrbm blgorithmURI URI rfprfsfntbtion of <dodf>Trbnsform blgorithm</dodf>
     * @pbrbm dontfxtNodfs thf dhild nodf list of <dodf>Trbnsform</dodf> flfmfnt
     * @throws InvblidTrbnsformExdfption
     */
    publid Trbnsform(Dodumfnt dod, String blgorithmURI, NodfList dontfxtNodfs)
        throws InvblidTrbnsformExdfption {
        supfr(dod);
        trbnsformSpi = initiblizfTrbnsform(blgorithmURI, dontfxtNodfs);
    }

    /**
     * @pbrbm flfmfnt <dodf>ds:Trbnsform</dodf> flfmfnt
     * @pbrbm BbsfURI thf URI of thf rfsourdf whfrf thf XML instbndf wbs storfd
     * @throws InvblidTrbnsformExdfption
     * @throws TrbnsformbtionExdfption
     * @throws XMLSfdurityExdfption
     */
    publid Trbnsform(Elfmfnt flfmfnt, String BbsfURI)
        throws InvblidTrbnsformExdfption, TrbnsformbtionExdfption, XMLSfdurityExdfption {
        supfr(flfmfnt, BbsfURI);

        // rftrifvf Algorithm Attributf from ds:Trbnsform
        String blgorithmURI = flfmfnt.gftAttributfNS(null, Constbnts._ATT_ALGORITHM);

        if (blgorithmURI == null || blgorithmURI.lfngth() == 0) {
            Objfdt fxArgs[] = { Constbnts._ATT_ALGORITHM, Constbnts._TAG_TRANSFORM };
            throw nfw TrbnsformbtionExdfption("xml.WrongContfnt", fxArgs);
        }

        Clbss<? fxtfnds TrbnsformSpi> trbnsformSpiClbss = trbnsformSpiHbsh.gft(blgorithmURI);
        if (trbnsformSpiClbss == null) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption("signbturf.Trbnsform.UnknownTrbnsform", fxArgs);
        }
        try {
            trbnsformSpi = trbnsformSpiClbss.nfwInstbndf();
        } dbtdh (InstbntibtionExdfption fx) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption(
                "signbturf.Trbnsform.UnknownTrbnsform", fxArgs, fx
            );
        } dbtdh (IllfgblAddfssExdfption fx) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption(
                "signbturf.Trbnsform.UnknownTrbnsform", fxArgs, fx
            );
        }
    }

    /**
     * Rfgistfrs implfmfnting dlbss of thf Trbnsform blgorithm with blgorithmURI
     *
     * @pbrbm blgorithmURI blgorithmURI URI rfprfsfntbtion of <dodf>Trbnsform blgorithm</dodf>
     * @pbrbm implfmfntingClbss <dodf>implfmfntingClbss</dodf> thf implfmfnting
     * dlbss of {@link TrbnsformSpi}
     * @throws AlgorithmAlrfbdyRfgistfrfdExdfption if spfdififd blgorithmURI
     * is blrfbdy rfgistfrfd
     */
    @SupprfssWbrnings("undhfdkfd")
    publid stbtid void rfgistfr(String blgorithmURI, String implfmfntingClbss)
        throws AlgorithmAlrfbdyRfgistfrfdExdfption, ClbssNotFoundExdfption,
            InvblidTrbnsformExdfption {
        // brf wf blrfbdy rfgistfrfd?
        Clbss<? fxtfnds TrbnsformSpi> trbnsformSpi = trbnsformSpiHbsh.gft(blgorithmURI);
        if (trbnsformSpi != null) {
            Objfdt fxArgs[] = { blgorithmURI, trbnsformSpi };
            throw nfw AlgorithmAlrfbdyRfgistfrfdExdfption("blgorithm.blrfbdyRfgistfrfd", fxArgs);
        }
        Clbss<? fxtfnds TrbnsformSpi> trbnsformSpiClbss =
            (Clbss<? fxtfnds TrbnsformSpi>)
                ClbssLobdfrUtils.lobdClbss(implfmfntingClbss, Trbnsform.dlbss);
        trbnsformSpiHbsh.put(blgorithmURI, trbnsformSpiClbss);
    }

    /**
     * Rfgistfrs implfmfnting dlbss of thf Trbnsform blgorithm with blgorithmURI
     *
     * @pbrbm blgorithmURI blgorithmURI URI rfprfsfntbtion of <dodf>Trbnsform blgorithm</dodf>
     * @pbrbm implfmfntingClbss <dodf>implfmfntingClbss</dodf> thf implfmfnting
     * dlbss of {@link TrbnsformSpi}
     * @throws AlgorithmAlrfbdyRfgistfrfdExdfption if spfdififd blgorithmURI
     * is blrfbdy rfgistfrfd
     */
    publid stbtid void rfgistfr(String blgorithmURI, Clbss<? fxtfnds TrbnsformSpi> implfmfntingClbss)
        throws AlgorithmAlrfbdyRfgistfrfdExdfption {
        // brf wf blrfbdy rfgistfrfd?
        Clbss<? fxtfnds TrbnsformSpi> trbnsformSpi = trbnsformSpiHbsh.gft(blgorithmURI);
        if (trbnsformSpi != null) {
            Objfdt fxArgs[] = { blgorithmURI, trbnsformSpi };
            throw nfw AlgorithmAlrfbdyRfgistfrfdExdfption("blgorithm.blrfbdyRfgistfrfd", fxArgs);
        }
        trbnsformSpiHbsh.put(blgorithmURI, implfmfntingClbss);
    }

    /**
     * This mfthod rfgistfrs thf dffbult blgorithms.
     */
    publid stbtid void rfgistfrDffbultAlgorithms() {
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_BASE64_DECODE, TrbnsformBbsf64Dfdodf.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N_OMIT_COMMENTS, TrbnsformC14N.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N_WITH_COMMENTS, TrbnsformC14NWithCommfnts.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N11_OMIT_COMMENTS, TrbnsformC14N11.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N11_WITH_COMMENTS, TrbnsformC14N11_WithCommfnts.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N_EXCL_OMIT_COMMENTS, TrbnsformC14NExdlusivf.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_C14N_EXCL_WITH_COMMENTS, TrbnsformC14NExdlusivfWithCommfnts.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_XPATH, TrbnsformXPbth.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_ENVELOPED_SIGNATURE, TrbnsformEnvflopfdSignbturf.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_XSLT, TrbnsformXSLT.dlbss
        );
        trbnsformSpiHbsh.put(
            Trbnsforms.TRANSFORM_XPATH2FILTER, TrbnsformXPbth2Filtfr.dlbss
        );
    }

    /**
     * Rfturns thf URI rfprfsfntbtion of Trbnsformbtion blgorithm
     *
     * @rfturn thf URI rfprfsfntbtion of Trbnsformbtion blgorithm
     */
    publid String gftURI() {
        rfturn this.donstrudtionElfmfnt.gftAttributfNS(null, Constbnts._ATT_ALGORITHM);
    }

    /**
     * Trbnsforms thf input, bnd gfnfrbtfs {@link XMLSignbturfInput} bs output.
     *
     * @pbrbm input input {@link XMLSignbturfInput} whidh dbn supplifd Odtft
     * Strfbm bnd NodfSft bs Input of Trbnsformbtion
     * @rfturn thf {@link XMLSignbturfInput} dlbss bs thf rfsult of
     * trbnsformbtion
     * @throws CbnonidblizbtionExdfption
     * @throws IOExdfption
     * @throws InvblidCbnonidblizfrExdfption
     * @throws TrbnsformbtionExdfption
     */
    publid XMLSignbturfInput pfrformTrbnsform(XMLSignbturfInput input)
        throws IOExdfption, CbnonidblizbtionExdfption,
               InvblidCbnonidblizfrExdfption, TrbnsformbtionExdfption {
        rfturn pfrformTrbnsform(input, null);
    }

    /**
     * Trbnsforms thf input, bnd gfnfrbtfs {@link XMLSignbturfInput} bs output.
     *
     * @pbrbm input input {@link XMLSignbturfInput} whidh dbn supplifd Odtfdt
     * Strfbm bnd NodfSft bs Input of Trbnsformbtion
     * @pbrbm os whfrf to output thf rfsult of thf lbst trbnsformbtion
     * @rfturn thf {@link XMLSignbturfInput} dlbss bs thf rfsult of
     * trbnsformbtion
     * @throws CbnonidblizbtionExdfption
     * @throws IOExdfption
     * @throws InvblidCbnonidblizfrExdfption
     * @throws TrbnsformbtionExdfption
     */
    publid XMLSignbturfInput pfrformTrbnsform(
        XMLSignbturfInput input, OutputStrfbm os
    ) throws IOExdfption, CbnonidblizbtionExdfption,
        InvblidCbnonidblizfrExdfption, TrbnsformbtionExdfption {
        XMLSignbturfInput rfsult = null;

        try {
            rfsult = trbnsformSpi.fnginfPfrformTrbnsform(input, os, this);
        } dbtdh (PbrsfrConfigurbtionExdfption fx) {
            Objfdt fxArgs[] = { this.gftURI(), "PbrsfrConfigurbtionExdfption" };
            throw nfw CbnonidblizbtionExdfption(
                "signbturf.Trbnsform.ErrorDuringTrbnsform", fxArgs, fx);
        } dbtdh (SAXExdfption fx) {
            Objfdt fxArgs[] = { this.gftURI(), "SAXExdfption" };
            throw nfw CbnonidblizbtionExdfption(
                "signbturf.Trbnsform.ErrorDuringTrbnsform", fxArgs, fx);
        }

        rfturn rfsult;
    }

    /** @inhfritDod */
    publid String gftBbsfLodblNbmf() {
        rfturn Constbnts._TAG_TRANSFORM;
    }

    /**
     * Initiblizf thf trbnsform objfdt.
     */
    privbtf TrbnsformSpi initiblizfTrbnsform(String blgorithmURI, NodfList dontfxtNodfs)
        throws InvblidTrbnsformExdfption {

        this.donstrudtionElfmfnt.sftAttributfNS(null, Constbnts._ATT_ALGORITHM, blgorithmURI);

        Clbss<? fxtfnds TrbnsformSpi> trbnsformSpiClbss = trbnsformSpiHbsh.gft(blgorithmURI);
        if (trbnsformSpiClbss == null) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption("signbturf.Trbnsform.UnknownTrbnsform", fxArgs);
        }
        TrbnsformSpi nfwTrbnsformSpi = null;
        try {
            nfwTrbnsformSpi = trbnsformSpiClbss.nfwInstbndf();
        } dbtdh (InstbntibtionExdfption fx) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption(
                "signbturf.Trbnsform.UnknownTrbnsform", fxArgs, fx
            );
        } dbtdh (IllfgblAddfssExdfption fx) {
            Objfdt fxArgs[] = { blgorithmURI };
            throw nfw InvblidTrbnsformExdfption(
                "signbturf.Trbnsform.UnknownTrbnsform", fxArgs, fx
            );
        }

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Crfbtf URI \"" + blgorithmURI + "\" dlbss \""
                      + nfwTrbnsformSpi.gftClbss() + "\"");
            log.log(jbvb.util.logging.Lfvfl.FINE, "Thf NodfList is " + dontfxtNodfs);
        }

        // givf it to thf durrfnt dodumfnt
        if (dontfxtNodfs != null) {
            for (int i = 0; i < dontfxtNodfs.gftLfngth(); i++) {
                this.donstrudtionElfmfnt.bppfndChild(dontfxtNodfs.itfm(i).dlonfNodf(truf));
            }
        }
        rfturn nfwTrbnsformSpi;
    }

}
