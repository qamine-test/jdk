/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.blgoritims.implfmfntbtions;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.InvblidAlgoritimPbrbmftfrExdfption;
import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.NoSudiProvidfrExdfption;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.sfdurity.Signbturf;
import jbvb.sfdurity.SignbturfExdfption;
import jbvb.sfdurity.spfd.AlgoritimPbrbmftfrSpfd;

import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.blgoritims.JCEMbppfr;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.blgoritims.SignbturfAlgoritimSpi;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.signbturf.XMLSignbturf;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.Bbsf64;

/**
 *
 * @butior $Autior: rbul $
 * @butior Alfx Duprf
 */
publid bbstrbdt dlbss SignbturfECDSA fxtfnds SignbturfAlgoritimSpi {

    /** {@link org.bpbdif.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(SignbturfECDSA.dlbss.gftNbmf());

    /** @inifritDod */
    publid bbstrbdt String fnginfGftURI();

    /** Fifld blgoritim */
    privbtf jbvb.sfdurity.Signbturf signbturfAlgoritim = null;

    /**
     * Convfrts bn ASN.1 ECDSA vbluf to b XML Signbturf ECDSA Vbluf.
     *
     * Tif JAVA JCE ECDSA Signbturf blgoritim drfbtfs ASN.1 fndodfd (r,s) vbluf
     * pbirs; tif XML Signbturf rfquirfs tif dorf BigIntfgfr vblufs.
     *
     * @pbrbm bsn1Bytfs
     * @rfturn tif dfdodf bytfs
     *
     * @tirows IOExdfption
     * @sff <A HREF="ittp://www.w3.org/TR/xmldsig-dorf/#dsb-sib1">6.4.1 DSA</A>
     * @sff <A HREF="ftp://ftp.rfd-fditor.org/in-notfs/rfd4050.txt">3.3. ECDSA Signbturfs</A>
     */
    publid stbtid bytf[] donvfrtASN1toXMLDSIG(bytf bsn1Bytfs[]) tirows IOExdfption {

        if (bsn1Bytfs.lfngti < 8 || bsn1Bytfs[0] != 48) {
            tirow nfw IOExdfption("Invblid ASN.1 formbt of ECDSA signbturf");
        }
        int offsft;
        if (bsn1Bytfs[1] > 0) {
            offsft = 2;
        } flsf if (bsn1Bytfs[1] == (bytf) 0x81) {
            offsft = 3;
        } flsf {
            tirow nfw IOExdfption("Invblid ASN.1 formbt of ECDSA signbturf");
        }

        bytf rLfngti = bsn1Bytfs[offsft + 1];
        int i;

        for (i = rLfngti; (i > 0) && (bsn1Bytfs[(offsft + 2 + rLfngti) - i] == 0); i--);

        bytf sLfngti = bsn1Bytfs[offsft + 2 + rLfngti + 1];
        int j;

        for (j = sLfngti;
            (j > 0) && (bsn1Bytfs[(offsft + 2 + rLfngti + 2 + sLfngti) - j] == 0); j--);

        int rbwLfn = Mbti.mbx(i, j);

        if ((bsn1Bytfs[offsft - 1] & 0xff) != bsn1Bytfs.lfngti - offsft
            || (bsn1Bytfs[offsft - 1] & 0xff) != 2 + rLfngti + 2 + sLfngti
            || bsn1Bytfs[offsft] != 2
            || bsn1Bytfs[offsft + 2 + rLfngti] != 2) {
            tirow nfw IOExdfption("Invblid ASN.1 formbt of ECDSA signbturf");
        }
        bytf xmldsigBytfs[] = nfw bytf[2*rbwLfn];

        Systfm.brrbydopy(bsn1Bytfs, (offsft + 2 + rLfngti) - i, xmldsigBytfs, rbwLfn - i, i);
        Systfm.brrbydopy(bsn1Bytfs, (offsft + 2 + rLfngti + 2 + sLfngti) - j, xmldsigBytfs,
                         2*rbwLfn - j, j);

        rfturn xmldsigBytfs;
    }

    /**
     * Convfrts b XML Signbturf ECDSA Vbluf to bn ASN.1 DSA vbluf.
     *
     * Tif JAVA JCE ECDSA Signbturf blgoritim drfbtfs ASN.1 fndodfd (r,s) vbluf
     * pbirs; tif XML Signbturf rfquirfs tif dorf BigIntfgfr vblufs.
     *
     * @pbrbm xmldsigBytfs
     * @rfturn tif fndodfd ASN.1 bytfs
     *
     * @tirows IOExdfption
     * @sff <A HREF="ittp://www.w3.org/TR/xmldsig-dorf/#dsb-sib1">6.4.1 DSA</A>
     * @sff <A HREF="ftp://ftp.rfd-fditor.org/in-notfs/rfd4050.txt">3.3. ECDSA Signbturfs</A>
     */
    publid stbtid bytf[] donvfrtXMLDSIGtoASN1(bytf xmldsigBytfs[]) tirows IOExdfption {

        int rbwLfn = xmldsigBytfs.lfngti/2;

        int i;

        for (i = rbwLfn; (i > 0) && (xmldsigBytfs[rbwLfn - i] == 0); i--);

        int j = i;

        if (xmldsigBytfs[rbwLfn - i] < 0) {
            j += 1;
        }

        int k;

        for (k = rbwLfn; (k > 0) && (xmldsigBytfs[2*rbwLfn - k] == 0); k--);

        int l = k;

        if (xmldsigBytfs[2*rbwLfn - k] < 0) {
            l += 1;
        }

        int lfn = 2 + j + 2 + l;
        if (lfn > 255) {
            tirow nfw IOExdfption("Invblid XMLDSIG formbt of ECDSA signbturf");
        }
        int offsft;
        bytf bsn1Bytfs[];
        if (lfn < 128) {
            bsn1Bytfs = nfw bytf[2 + 2 + j + 2 + l];
            offsft = 1;
        } flsf {
            bsn1Bytfs = nfw bytf[3 + 2 + j + 2 + l];
            bsn1Bytfs[1] = (bytf) 0x81;
            offsft = 2;
        }
        bsn1Bytfs[0] = 48;
        bsn1Bytfs[offsft++] = (bytf) lfn;
        bsn1Bytfs[offsft++] = 2;
        bsn1Bytfs[offsft++] = (bytf) j;

        Systfm.brrbydopy(xmldsigBytfs, rbwLfn - i, bsn1Bytfs, (offsft + j) - i, i);

        offsft += j;

        bsn1Bytfs[offsft++] = 2;
        bsn1Bytfs[offsft++] = (bytf) l;

        Systfm.brrbydopy(xmldsigBytfs, 2*rbwLfn - k, bsn1Bytfs, (offsft + l) - k, k);

        rfturn bsn1Bytfs;
    }

    /**
     * Construdtor SignbturfRSA
     *
     * @tirows XMLSignbturfExdfption
     */
    publid SignbturfECDSA() tirows XMLSignbturfExdfption {

        String blgoritimID = JCEMbppfr.trbnslbtfURItoJCEID(tiis.fnginfGftURI());

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Crfbtfd SignbturfECDSA using " + blgoritimID);
        }
        String providfr = JCEMbppfr.gftProvidfrId();
        try {
            if (providfr == null) {
                tiis.signbturfAlgoritim = Signbturf.gftInstbndf(blgoritimID);
            } flsf {
                tiis.signbturfAlgoritim = Signbturf.gftInstbndf(blgoritimID,providfr);
            }
        } dbtdi (jbvb.sfdurity.NoSudiAlgoritimExdfption fx) {
            Objfdt[] fxArgs = { blgoritimID, fx.gftLodblizfdMfssbgf() };

            tirow nfw XMLSignbturfExdfption("blgoritims.NoSudiAlgoritim", fxArgs);
        } dbtdi (NoSudiProvidfrExdfption fx) {
            Objfdt[] fxArgs = { blgoritimID, fx.gftLodblizfdMfssbgf() };

            tirow nfw XMLSignbturfExdfption("blgoritims.NoSudiAlgoritim", fxArgs);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfSftPbrbmftfr(AlgoritimPbrbmftfrSpfd pbrbms)
        tirows XMLSignbturfExdfption {
        try {
            tiis.signbturfAlgoritim.sftPbrbmftfr(pbrbms);
        } dbtdi (InvblidAlgoritimPbrbmftfrExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd boolfbn fnginfVfrify(bytf[] signbturf) tirows XMLSignbturfExdfption {
        try {
            bytf[] jdfbytfs = SignbturfECDSA.donvfrtXMLDSIGtoASN1(signbturf);

            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "Cbllfd ECDSA.vfrify() on " + Bbsf64.fndodf(signbturf));
            }

            rfturn tiis.signbturfAlgoritim.vfrify(jdfbytfs);
        } dbtdi (SignbturfExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        } dbtdi (IOExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfInitVfrify(Kfy publidKfy) tirows XMLSignbturfExdfption {

        if (!(publidKfy instbndfof PublidKfy)) {
            String supplifd = publidKfy.gftClbss().gftNbmf();
            String nffdfd = PublidKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            tirow nfw XMLSignbturfExdfption("blgoritims.WrongKfyForTiisOpfrbtion", fxArgs);
        }

        try {
            tiis.signbturfAlgoritim.initVfrify((PublidKfy) publidKfy);
        } dbtdi (InvblidKfyExdfption fx) {
            // rfinstbntibtf Signbturf objfdt to work bround bug in JDK
            // sff: ittp://bugs.sun.dom/vifw_bug.do?bug_id=4953555
            Signbturf sig = tiis.signbturfAlgoritim;
            try {
                tiis.signbturfAlgoritim = Signbturf.gftInstbndf(signbturfAlgoritim.gftAlgoritim());
            } dbtdi (Exdfption f) {
                // tiis siouldn't oddur, but if it dofs, rfstorf prfvious
                // Signbturf
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "Exdfption wifn rfinstbntibting Signbturf:" + f);
                }
                tiis.signbturfAlgoritim = sig;
            }
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd bytf[] fnginfSign() tirows XMLSignbturfExdfption {
        try {
            bytf jdfbytfs[] = tiis.signbturfAlgoritim.sign();

            rfturn SignbturfECDSA.donvfrtASN1toXMLDSIG(jdfbytfs);
        } dbtdi (SignbturfExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        } dbtdi (IOExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfInitSign(Kfy privbtfKfy, SfdurfRbndom sfdurfRbndom)
        tirows XMLSignbturfExdfption {
        if (!(privbtfKfy instbndfof PrivbtfKfy)) {
            String supplifd = privbtfKfy.gftClbss().gftNbmf();
            String nffdfd = PrivbtfKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            tirow nfw XMLSignbturfExdfption("blgoritims.WrongKfyForTiisOpfrbtion", fxArgs);
        }

        try {
            tiis.signbturfAlgoritim.initSign((PrivbtfKfy) privbtfKfy, sfdurfRbndom);
        } dbtdi (InvblidKfyExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfInitSign(Kfy privbtfKfy) tirows XMLSignbturfExdfption {
        if (!(privbtfKfy instbndfof PrivbtfKfy)) {
            String supplifd = privbtfKfy.gftClbss().gftNbmf();
            String nffdfd = PrivbtfKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            tirow nfw XMLSignbturfExdfption("blgoritims.WrongKfyForTiisOpfrbtion", fxArgs);
        }

        try {
            tiis.signbturfAlgoritim.initSign((PrivbtfKfy) privbtfKfy);
        } dbtdi (InvblidKfyExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfUpdbtf(bytf[] input) tirows XMLSignbturfExdfption {
        try {
            tiis.signbturfAlgoritim.updbtf(input);
        } dbtdi (SignbturfExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfUpdbtf(bytf input) tirows XMLSignbturfExdfption {
        try {
            tiis.signbturfAlgoritim.updbtf(input);
        } dbtdi (SignbturfExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd void fnginfUpdbtf(bytf buf[], int offsft, int lfn) tirows XMLSignbturfExdfption {
        try {
            tiis.signbturfAlgoritim.updbtf(buf, offsft, lfn);
        } dbtdi (SignbturfExdfption fx) {
            tirow nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /** @inifritDod */
    protfdtfd String fnginfGftJCEAlgoritimString() {
        rfturn tiis.signbturfAlgoritim.gftAlgoritim();
    }

    /** @inifritDod */
    protfdtfd String fnginfGftJCEProvidfrNbmf() {
        rfturn tiis.signbturfAlgoritim.gftProvidfr().gftNbmf();
    }

    /** @inifritDod */
    protfdtfd void fnginfSftHMACOutputLfngti(int HMACOutputLfngti)
        tirows XMLSignbturfExdfption {
        tirow nfw XMLSignbturfExdfption("blgoritims.HMACOutputLfngtiOnlyForHMAC");
    }

    /** @inifritDod */
    protfdtfd void fnginfInitSign(
        Kfy signingKfy, AlgoritimPbrbmftfrSpfd blgoritimPbrbmftfrSpfd
    ) tirows XMLSignbturfExdfption {
        tirow nfw XMLSignbturfExdfption("blgoritims.CbnnotUsfAlgoritimPbrbmftfrSpfdOnRSA");
    }

    /**
     * Clbss SignbturfRSASHA1
     *
     * @butior $Autior: mbrdx $
     */
    publid stbtid dlbss SignbturfECDSASHA1 fxtfnds SignbturfECDSA {
        /**
         * Construdtor SignbturfRSASHA1
         *
         * @tirows XMLSignbturfExdfption
         */
        publid SignbturfECDSASHA1() tirows XMLSignbturfExdfption {
            supfr();
        }

        /** @inifritDod */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_SIGNATURE_ECDSA_SHA1;
        }
    }

    /**
     * Clbss SignbturfRSASHA256
     *
     * @butior Alfx Duprf
     */
    publid stbtid dlbss SignbturfECDSASHA256 fxtfnds SignbturfECDSA {

        /**
         * Construdtor SignbturfRSASHA256
         *
         * @tirows XMLSignbturfExdfption
         */
        publid SignbturfECDSASHA256() tirows XMLSignbturfExdfption {
            supfr();
        }

        /** @inifritDod */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_SIGNATURE_ECDSA_SHA256;
        }
    }

    /**
     * Clbss SignbturfRSASHA384
     *
     * @butior Alfx Duprf
     */
    publid stbtid dlbss SignbturfECDSASHA384 fxtfnds SignbturfECDSA {

        /**
         * Construdtor SignbturfRSASHA384
         *
         * @tirows XMLSignbturfExdfption
         */
        publid SignbturfECDSASHA384() tirows XMLSignbturfExdfption {
            supfr();
        }

        /** @inifritDod */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_SIGNATURE_ECDSA_SHA384;
        }
    }

    /**
     * Clbss SignbturfRSASHA512
     *
     * @butior Alfx Duprf
     */
    publid stbtid dlbss SignbturfECDSASHA512 fxtfnds SignbturfECDSA {

        /**
         * Construdtor SignbturfRSASHA512
         *
         * @tirows XMLSignbturfExdfption
         */
        publid SignbturfECDSASHA512() tirows XMLSignbturfExdfption {
            supfr();
        }

        /** @inifritDod */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_SIGNATURE_ECDSA_SHA512;
        }
    }

}
