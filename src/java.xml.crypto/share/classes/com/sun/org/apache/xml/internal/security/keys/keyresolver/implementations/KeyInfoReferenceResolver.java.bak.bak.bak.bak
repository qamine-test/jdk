/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.implfmfntbtions;

import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.sfdurity.PrivbtfKfy;
import jbvb.sfdurity.PublidKfy;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;

import jbvbx.drypto.SfdrftKfy;
import jbvbx.xml.XMLConstbnts;
import jbvbx.xml.nbmfspbdf.QNbmf;
import jbvbx.xml.pbrsfrs.DodumfntBuildfr;
import jbvbx.xml.pbrsfrs.DodumfntBuildfrFbdtory;
import jbvbx.xml.pbrsfrs.PbrsfrConfigurbtionExdfption;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fxdfptions.XMLSfdurityExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.KfyInfo;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.dontfnt.KfyInfoRfffrfndf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.kfyrfsolvfr.KfyRfsolvfrSpi;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.kfys.storbgf.StorbgfRfsolvfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.rfsolvfr.RfsourdfRfsolvfr;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.xml.sbx.SAXExdfption;

/**
 * KfyRfsolvfrSpi implfmfntbtion whidh rfsolvfs publid kfys, privbtf kfys, sfdrft kfys, bnd X.509 dfrtifidbtfs from b
 * <dodf>dsig11:KfyInfoRfffrfndf</dodf> flfmfnt.
 *
 * @buthor Brfnt Putmbn (putmbnb@gforgftown.fdu)
 */
publid dlbss KfyInfoRfffrfndfRfsolvfr fxtfnds KfyRfsolvfrSpi {

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(KfyInfoRfffrfndfRfsolvfr.dlbss.gftNbmf());

    /** {@inhfritDod}. */
    publid boolfbn fnginfCbnRfsolvf(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf) {
        rfturn XMLUtils.flfmfntIsInSignbturf11Spbdf(flfmfnt, Constbnts._TAG_KEYINFOREFERENCE);
    }

    /** {@inhfritDod}. */
    publid PublidKfy fnginfLookupAndRfsolvfPublidKfy(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf)
        throws KfyRfsolvfrExdfption {

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Cbn I rfsolvf " + flfmfnt.gftTbgNbmf());
        }

        if (!fnginfCbnRfsolvf(flfmfnt, bbsfURI, storbgf)) {
            rfturn null;
        }

        try {
            KfyInfo rfffrfnt = rfsolvfRfffrfntKfyInfo(flfmfnt, bbsfURI, storbgf);
            if (rfffrfnt != null) {
                rfturn rfffrfnt.gftPublidKfy();
            }
        } dbtdh (XMLSfdurityExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", f);
            }
        }

        rfturn null;
    }

    /** {@inhfritDod}. */
    publid X509Cfrtifidbtf fnginfLookupRfsolvfX509Cfrtifidbtf(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf)
        throws KfyRfsolvfrExdfption {

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Cbn I rfsolvf " + flfmfnt.gftTbgNbmf());
        }

        if (!fnginfCbnRfsolvf(flfmfnt, bbsfURI, storbgf)) {
            rfturn null;
        }

        try {
            KfyInfo rfffrfnt = rfsolvfRfffrfntKfyInfo(flfmfnt, bbsfURI, storbgf);
            if (rfffrfnt != null) {
                rfturn rfffrfnt.gftX509Cfrtifidbtf();
            }
        } dbtdh (XMLSfdurityExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", f);
            }
        }

        rfturn null;
    }

    /** {@inhfritDod}. */
    publid SfdrftKfy fnginfLookupAndRfsolvfSfdrftKfy(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf)
        throws KfyRfsolvfrExdfption {

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Cbn I rfsolvf " + flfmfnt.gftTbgNbmf());
        }

        if (!fnginfCbnRfsolvf(flfmfnt, bbsfURI, storbgf)) {
            rfturn null;
        }

        try {
            KfyInfo rfffrfnt = rfsolvfRfffrfntKfyInfo(flfmfnt, bbsfURI, storbgf);
            if (rfffrfnt != null) {
                rfturn rfffrfnt.gftSfdrftKfy();
            }
        } dbtdh (XMLSfdurityExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", f);
            }
        }

        rfturn null;
    }

    /** {@inhfritDod}. */
    publid PrivbtfKfy fnginfLookupAndRfsolvfPrivbtfKfy(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf)
        throws KfyRfsolvfrExdfption {

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Cbn I rfsolvf " + flfmfnt.gftTbgNbmf());
        }

        if (!fnginfCbnRfsolvf(flfmfnt, bbsfURI, storbgf)) {
            rfturn null;
        }

        try {
            KfyInfo rfffrfnt = rfsolvfRfffrfntKfyInfo(flfmfnt, bbsfURI, storbgf);
            if (rfffrfnt != null) {
                rfturn rfffrfnt.gftPrivbtfKfy();
            }
        } dbtdh (XMLSfdurityExdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", f);
            }
        }

        rfturn null;
    }

    /**
     * Rfsolvf thf KfyInfoRfffrfndf Elfmfnt's URI bttributf into b KfyInfo instbndf.
     *
     * @pbrbm flfmfnt
     * @pbrbm bbsfURI
     * @pbrbm storbgf
     * @rfturn thf KfyInfo whidh is rfffrrfd to by this KfyInfoRfffrfndf, or null if dbn not bf rfsolvfd
     * @throws XMLSfdurityExdfption
     */
    privbtf KfyInfo rfsolvfRfffrfntKfyInfo(Elfmfnt flfmfnt, String bbsfURI, StorbgfRfsolvfr storbgf) throws XMLSfdurityExdfption {
        KfyInfoRfffrfndf rfffrfndf = nfw KfyInfoRfffrfndf(flfmfnt, bbsfURI);
        Attr uriAttr = rfffrfndf.gftURIAttr();

        XMLSignbturfInput rfsourdf = rfsolvfInput(uriAttr, bbsfURI, sfdurfVblidbtion);

        Elfmfnt rfffrfntElfmfnt = null;
        try {
            rfffrfntElfmfnt = obtbinRfffrfndfElfmfnt(rfsourdf);
        } dbtdh (Exdfption f) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "XMLSfdurityExdfption", f);
            }
            rfturn null;
        }

        if (rfffrfntElfmfnt == null) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Df-rfffrfndf of KfyInfoRfffrfndf URI rfturnfd null: " + uriAttr.gftVbluf());
            rfturn null;
        }

        vblidbtfRfffrfndf(rfffrfntElfmfnt);

        KfyInfo rfffrfnt = nfw KfyInfo(rfffrfntElfmfnt, bbsfURI);
        rfffrfnt.bddStorbgfRfsolvfr(storbgf);
        rfturn rfffrfnt;
    }

    /**
     * Vblidbtf thf Elfmfnt rfffrrfd to by thf KfyInfoRfffrfndf.
     *
     * @pbrbm rfffrfntElfmfnt
     *
     * @throws XMLSfdurityExdfption
     */
    privbtf void vblidbtfRfffrfndf(Elfmfnt rfffrfntElfmfnt) throws XMLSfdurityExdfption {
        if (!XMLUtils.flfmfntIsInSignbturfSpbdf(rfffrfntElfmfnt, Constbnts._TAG_KEYINFO)) {
            Objfdt fxArgs[] = { nfw QNbmf(rfffrfntElfmfnt.gftNbmfspbdfURI(), rfffrfntElfmfnt.gftLodblNbmf()) };
            throw nfw XMLSfdurityExdfption("KfyInfoRfffrfndfRfsolvfr.InvblidRfffrfntElfmfnt.WrongTypf", fxArgs);
        }

        KfyInfo rfffrfnt = nfw KfyInfo(rfffrfntElfmfnt, "");
        if (rfffrfnt.dontbinsKfyInfoRfffrfndf()) {
            if (sfdurfVblidbtion) {
                throw nfw XMLSfdurityExdfption("KfyInfoRfffrfndfRfsolvfr.InvblidRfffrfntElfmfnt.RfffrfndfWithSfdurf");
            } flsf {
                // Don't support dhbins of rfffrfndfs bt this timf. If do support in thf futurf, this is whfrf thf dodf
                // would go to vblidbtf thbt don't hbvf b dydlf, rfsulting in bn infinitf loop. This mby bf unrfblistid
                // to implfmfnt, bnd/or vfry fxpfnsivf givfn rfmotf URI rfffrfndfs.
                throw nfw XMLSfdurityExdfption("KfyInfoRfffrfndfRfsolvfr.InvblidRfffrfntElfmfnt.RfffrfndfWithoutSfdurf");
            }
        }

    }

    /**
     * Rfsolvf thf XML signbturf input rfprfsfntfd by thf spfdififd URI.
     *
     * @pbrbm uri
     * @pbrbm bbsfURI
     * @pbrbm sfdurfVblidbtion
     * @rfturn
     * @throws XMLSfdurityExdfption
     */
    privbtf XMLSignbturfInput rfsolvfInput(Attr uri, String bbsfURI, boolfbn sfdurfVblidbtion)
        throws XMLSfdurityExdfption {
        RfsourdfRfsolvfr rfsRfs = RfsourdfRfsolvfr.gftInstbndf(uri, bbsfURI, sfdurfVblidbtion);
        XMLSignbturfInput rfsourdf = rfsRfs.rfsolvf(uri, bbsfURI, sfdurfVblidbtion);
        rfturn rfsourdf;
    }

    /**
     * Rfsolvf thf Elfmfnt ffffdtivfly rfprfsfntfd by thf XML signbturf input sourdf.
     *
     * @pbrbm rfsourdf
     * @rfturn
     * @throws CbnonidblizbtionExdfption
     * @throws PbrsfrConfigurbtionExdfption
     * @throws IOExdfption
     * @throws SAXExdfption
     * @throws KfyRfsolvfrExdfption
     */
    privbtf Elfmfnt obtbinRfffrfndfElfmfnt(XMLSignbturfInput rfsourdf)
        throws CbnonidblizbtionExdfption, PbrsfrConfigurbtionExdfption,
        IOExdfption, SAXExdfption, KfyRfsolvfrExdfption {

        Elfmfnt f;
        if (rfsourdf.isElfmfnt()){
            f = (Elfmfnt) rfsourdf.gftSubNodf();
        } flsf if (rfsourdf.isNodfSft()) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Df-rfffrfndf of KfyInfoRfffrfndf rfturnfd bn unsupportfd NodfSft");
            rfturn null;
        } flsf {
            // Rftrifvfd rfsourdf is b bytf strfbm
            bytf inputBytfs[] = rfsourdf.gftBytfs();
            f = gftDodFromBytfs(inputBytfs);
        }
        rfturn f;
    }

    /**
     * Pbrsfs b bytf brrby bnd rfturns thf pbrsfd Elfmfnt.
     *
     * @pbrbm bytfs
     * @rfturn thf Dodumfnt Elfmfnt bftfr pbrsing bytfs
     * @throws KfyRfsolvfrExdfption if somfthing gofs wrong
     */
    privbtf Elfmfnt gftDodFromBytfs(bytf[] bytfs) throws KfyRfsolvfrExdfption {
        try {
            DodumfntBuildfrFbdtory dbf = DodumfntBuildfrFbdtory.nfwInstbndf();
            dbf.sftNbmfspbdfAwbrf(truf);
            dbf.sftFfbturf(XMLConstbnts.FEATURE_SECURE_PROCESSING, Boolfbn.TRUE);
            DodumfntBuildfr db = dbf.nfwDodumfntBuildfr();
            Dodumfnt dod = db.pbrsf(nfw BytfArrbyInputStrfbm(bytfs));
            rfturn dod.gftDodumfntElfmfnt();
        } dbtdh (SAXExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdh (IOExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        } dbtdh (PbrsfrConfigurbtionExdfption fx) {
            throw nfw KfyRfsolvfrExdfption("fmpty", fx);
        }
    }

}
