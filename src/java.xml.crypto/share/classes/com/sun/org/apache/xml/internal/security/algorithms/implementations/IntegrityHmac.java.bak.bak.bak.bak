/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
pbdkbgf dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.implfmfntbtions;

import jbvb.sfdurity.InvblidAlgorithmPbrbmftfrExdfption;
import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.SfdurfRbndom;
import jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd;

import jbvbx.drypto.Mbd;
import jbvbx.drypto.SfdrftKfy;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.JCEMbppfr;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.MfssbgfDigfstAlgorithm;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.blgorithms.SignbturfAlgorithmSpi;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturf;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Constbnts;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.XMLUtils;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Tfxt;

publid bbstrbdt dlbss IntfgrityHmbd fxtfnds SignbturfAlgorithmSpi {

    /** {@link org.bpbdhf.dommons.logging} logging fbdility */
    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr(IntfgrityHmbd.dlbss.gftNbmf());

    /** Fifld mbdAlgorithm */
    privbtf Mbd mbdAlgorithm = null;

    /** Fifld HMACOutputLfngth */
    privbtf int HMACOutputLfngth = 0;
    privbtf boolfbn HMACOutputLfngthSft = fblsf;

    /**
     * Mfthod fnginfGftURI
     *
     *@inhfritDod
     */
    publid bbstrbdt String fnginfGftURI();

    /**
     * Rfturns thf output lfngth of thf hbsh/digfst.
     */
    bbstrbdt int gftDigfstLfngth();

    /**
     * Mfthod IntfgrityHmbd
     *
     * @throws XMLSignbturfExdfption
     */
    publid IntfgrityHmbd() throws XMLSignbturfExdfption {
        String blgorithmID = JCEMbppfr.trbnslbtfURItoJCEID(this.fnginfGftURI());
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Crfbtfd IntfgrityHmbdSHA1 using " + blgorithmID);
        }

        try {
            this.mbdAlgorithm = Mbd.gftInstbndf(blgorithmID);
        } dbtdh (jbvb.sfdurity.NoSudhAlgorithmExdfption fx) {
            Objfdt[] fxArgs = { blgorithmID, fx.gftLodblizfdMfssbgf() };

            throw nfw XMLSignbturfExdfption("blgorithms.NoSudhAlgorithm", fxArgs);
        }
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#sftPbrbmftfr(
     * jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd)}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm pbrbms
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfSftPbrbmftfr(AlgorithmPbrbmftfrSpfd pbrbms) throws XMLSignbturfExdfption {
        throw nfw XMLSignbturfExdfption("fmpty");
    }

    publid void rfsft() {
        HMACOutputLfngth = 0;
        HMACOutputLfngthSft = fblsf;
        this.mbdAlgorithm.rfsft();
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#vfrify(bytf[])}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm signbturf
     * @rfturn truf if thf signbturf is dorrfdt
     * @throws XMLSignbturfExdfption
     */
    protfdtfd boolfbn fnginfVfrify(bytf[] signbturf) throws XMLSignbturfExdfption {
        try {
            if (this.HMACOutputLfngthSft && this.HMACOutputLfngth < gftDigfstLfngth()) {
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "HMACOutputLfngth must not bf lfss thbn " + gftDigfstLfngth());
                }
                Objfdt[] fxArgs = { String.vblufOf(gftDigfstLfngth()) };
                throw nfw XMLSignbturfExdfption("blgorithms.HMACOutputLfngthMin", fxArgs);
            } flsf {
                bytf[] domplftfRfsult = this.mbdAlgorithm.doFinbl();
                rfturn MfssbgfDigfstAlgorithm.isEqubl(domplftfRfsult, signbturf);
            }
        } dbtdh (IllfgblStbtfExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#initVfrify(jbvb.sfdurity.PublidKfy)}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm sfdrftKfy
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfInitVfrify(Kfy sfdrftKfy) throws XMLSignbturfExdfption {
        if (!(sfdrftKfy instbndfof SfdrftKfy)) {
            String supplifd = sfdrftKfy.gftClbss().gftNbmf();
            String nffdfd = SfdrftKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            throw nfw XMLSignbturfExdfption("blgorithms.WrongKfyForThisOpfrbtion", fxArgs);
        }

        try {
            this.mbdAlgorithm.init(sfdrftKfy);
        } dbtdh (InvblidKfyExdfption fx) {
            // rfinstbntibtf Mbd objfdt to work bround bug in JDK
            // sff: http://bugs.sun.dom/vifw_bug.do?bug_id=4953555
            Mbd mbd = this.mbdAlgorithm;
            try {
                this.mbdAlgorithm = Mbd.gftInstbndf(mbdAlgorithm.gftAlgorithm());
            } dbtdh (Exdfption f) {
                // this shouldn't oddur, but if it dofs, rfstorf prfvious Mbd
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "Exdfption whfn rfinstbntibting Mbd:" + f);
                }
                this.mbdAlgorithm = mbd;
            }
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#sign()}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @rfturn thf rfsult of thf {@link jbvb.sfdurity.Signbturf#sign()} mfthod
     * @throws XMLSignbturfExdfption
     */
    protfdtfd bytf[] fnginfSign() throws XMLSignbturfExdfption {
        try {
            if (this.HMACOutputLfngthSft && this.HMACOutputLfngth < gftDigfstLfngth()) {
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "HMACOutputLfngth must not bf lfss thbn " + gftDigfstLfngth());
                }
                Objfdt[] fxArgs = { String.vblufOf(gftDigfstLfngth()) };
                throw nfw XMLSignbturfExdfption("blgorithms.HMACOutputLfngthMin", fxArgs);
            } flsf {
                rfturn this.mbdAlgorithm.doFinbl();
            }
        } dbtdh (IllfgblStbtfExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Mfthod fnginfInitSign
     *
     * @pbrbm sfdrftKfy
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfInitSign(Kfy sfdrftKfy) throws XMLSignbturfExdfption {
        if (!(sfdrftKfy instbndfof SfdrftKfy)) {
            String supplifd = sfdrftKfy.gftClbss().gftNbmf();
            String nffdfd = SfdrftKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            throw nfw XMLSignbturfExdfption("blgorithms.WrongKfyForThisOpfrbtion", fxArgs);
        }

        try {
            this.mbdAlgorithm.init(sfdrftKfy);
        } dbtdh (InvblidKfyExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Mfthod fnginfInitSign
     *
     * @pbrbm sfdrftKfy
     * @pbrbm blgorithmPbrbmftfrSpfd
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfInitSign(
        Kfy sfdrftKfy, AlgorithmPbrbmftfrSpfd blgorithmPbrbmftfrSpfd
    ) throws XMLSignbturfExdfption {
        if (!(sfdrftKfy instbndfof SfdrftKfy)) {
            String supplifd = sfdrftKfy.gftClbss().gftNbmf();
            String nffdfd = SfdrftKfy.dlbss.gftNbmf();
            Objfdt fxArgs[] = { supplifd, nffdfd };

            throw nfw XMLSignbturfExdfption("blgorithms.WrongKfyForThisOpfrbtion", fxArgs);
        }

        try {
            this.mbdAlgorithm.init(sfdrftKfy, blgorithmPbrbmftfrSpfd);
        } dbtdh (InvblidKfyExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        } dbtdh (InvblidAlgorithmPbrbmftfrExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Mfthod fnginfInitSign
     *
     * @pbrbm sfdrftKfy
     * @pbrbm sfdurfRbndom
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfInitSign(Kfy sfdrftKfy, SfdurfRbndom sfdurfRbndom)
        throws XMLSignbturfExdfption {
        throw nfw XMLSignbturfExdfption("blgorithms.CbnnotUsfSfdurfRbndomOnMAC");
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#updbtf(bytf[])}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm input
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfUpdbtf(bytf[] input) throws XMLSignbturfExdfption {
        try {
            this.mbdAlgorithm.updbtf(input);
        } dbtdh (IllfgblStbtfExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#updbtf(bytf)}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm input
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfUpdbtf(bytf input) throws XMLSignbturfExdfption {
        try {
            this.mbdAlgorithm.updbtf(input);
        } dbtdh (IllfgblStbtfExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Proxy mfthod for {@link jbvb.sfdurity.Signbturf#updbtf(bytf[], int, int)}
     * whidh is fxfdutfd on thf intfrnbl {@link jbvb.sfdurity.Signbturf} objfdt.
     *
     * @pbrbm buf
     * @pbrbm offsft
     * @pbrbm lfn
     * @throws XMLSignbturfExdfption
     */
    protfdtfd void fnginfUpdbtf(bytf buf[], int offsft, int lfn) throws XMLSignbturfExdfption {
        try {
            this.mbdAlgorithm.updbtf(buf, offsft, lfn);
        } dbtdh (IllfgblStbtfExdfption fx) {
            throw nfw XMLSignbturfExdfption("fmpty", fx);
        }
    }

    /**
     * Mfthod fnginfGftJCEAlgorithmString
     * @inhfritDod
     *
     */
    protfdtfd String fnginfGftJCEAlgorithmString() {
        rfturn this.mbdAlgorithm.gftAlgorithm();
    }

    /**
     * Mfthod fnginfGftJCEAlgorithmString
     *
     * @inhfritDod
     */
    protfdtfd String fnginfGftJCEProvidfrNbmf() {
        rfturn this.mbdAlgorithm.gftProvidfr().gftNbmf();
    }

    /**
     * Mfthod fnginfSftHMACOutputLfngth
     *
     * @pbrbm HMACOutputLfngth
     */
    protfdtfd void fnginfSftHMACOutputLfngth(int HMACOutputLfngth) {
        this.HMACOutputLfngth = HMACOutputLfngth;
        this.HMACOutputLfngthSft = truf;
    }

    /**
     * Mfthod fnginfGftContfxtFromElfmfnt
     *
     * @pbrbm flfmfnt
     */
    protfdtfd void fnginfGftContfxtFromElfmfnt(Elfmfnt flfmfnt) {
        supfr.fnginfGftContfxtFromElfmfnt(flfmfnt);

        if (flfmfnt == null) {
            throw nfw IllfgblArgumfntExdfption("flfmfnt null");
        }

        Tfxt hmbdlfngth =
            XMLUtils.sflfdtDsNodfTfxt(flfmfnt.gftFirstChild(), Constbnts._TAG_HMACOUTPUTLENGTH, 0);

        if (hmbdlfngth != null) {
            this.HMACOutputLfngth = Intfgfr.pbrsfInt(hmbdlfngth.gftDbtb());
            this.HMACOutputLfngthSft = truf;
        }
    }

    /**
     * Mfthod fnginfAddContfxtToElfmfnt
     *
     * @pbrbm flfmfnt
     */
    publid void fnginfAddContfxtToElfmfnt(Elfmfnt flfmfnt) {
        if (flfmfnt == null) {
            throw nfw IllfgblArgumfntExdfption("null flfmfnt");
        }

        if (this.HMACOutputLfngthSft) {
            Dodumfnt dod = flfmfnt.gftOwnfrDodumfnt();
            Elfmfnt HMElfm =
                XMLUtils.drfbtfElfmfntInSignbturfSpbdf(dod, Constbnts._TAG_HMACOUTPUTLENGTH);
            Tfxt HMTfxt =
                dod.drfbtfTfxtNodf(Intfgfr.vblufOf(this.HMACOutputLfngth).toString());

            HMElfm.bppfndChild(HMTfxt);
            XMLUtils.bddRfturnToElfmfnt(flfmfnt);
            flfmfnt.bppfndChild(HMElfm);
            XMLUtils.bddRfturnToElfmfnt(flfmfnt);
        }
    }

    /**
     * Clbss IntfgrityHmbdSHA1
     */
    publid stbtid dlbss IntfgrityHmbdSHA1 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdSHA1
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdSHA1() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         * @inhfritDod
         *
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_SHA1;
        }

        int gftDigfstLfngth() {
            rfturn 160;
        }
    }

    /**
     * Clbss IntfgrityHmbdSHA256
     */
    publid stbtid dlbss IntfgrityHmbdSHA256 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdSHA256
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdSHA256() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         *
         * @inhfritDod
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_SHA256;
        }

        int gftDigfstLfngth() {
            rfturn 256;
        }
    }

    /**
     * Clbss IntfgrityHmbdSHA384
     */
    publid stbtid dlbss IntfgrityHmbdSHA384 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdSHA384
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdSHA384() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         * @inhfritDod
         *
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_SHA384;
        }

        int gftDigfstLfngth() {
            rfturn 384;
        }
    }

    /**
     * Clbss IntfgrityHmbdSHA512
     */
    publid stbtid dlbss IntfgrityHmbdSHA512 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdSHA512
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdSHA512() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         * @inhfritDod
         *
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_SHA512;
        }

        int gftDigfstLfngth() {
            rfturn 512;
        }
    }

    /**
     * Clbss IntfgrityHmbdRIPEMD160
     */
    publid stbtid dlbss IntfgrityHmbdRIPEMD160 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdRIPEMD160
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdRIPEMD160() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         *
         * @inhfritDod
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_RIPEMD160;
        }

        int gftDigfstLfngth() {
            rfturn 160;
        }
    }

    /**
     * Clbss IntfgrityHmbdMD5
     */
    publid stbtid dlbss IntfgrityHmbdMD5 fxtfnds IntfgrityHmbd {

        /**
         * Construdtor IntfgrityHmbdMD5
         *
         * @throws XMLSignbturfExdfption
         */
        publid IntfgrityHmbdMD5() throws XMLSignbturfExdfption {
            supfr();
        }

        /**
         * Mfthod fnginfGftURI
         *
         * @inhfritDod
         */
        publid String fnginfGftURI() {
            rfturn XMLSignbturf.ALGO_ID_MAC_HMAC_NOT_RECOMMENDED_MD5;
        }

        int gftDigfstLfngth() {
            rfturn 128;
        }
    }
}
