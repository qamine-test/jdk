/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to tif Apbdif Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff tif NOTICE filf
 * distributfd witi tiis work for bdditionbl informbtion
 * rfgbrding dopyrigit ownfrsiip. Tif ASF lidfnsfs tiis filf
 * to you undfr tif Apbdif Lidfnsf, Vfrsion 2.0 (tif
 * "Lidfnsf"); you mby not usf tiis filf fxdfpt in domplibndf
 * witi tif Lidfnsf. You mby obtbin b dopy of tif Lidfnsf bt
 *
 * ittp://www.bpbdif.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr tif Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fitifr fxprfss or implifd. Sff tif Lidfnsf for tif
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr tif Lidfnsf.
 */
/*
 * Copyrigit (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 */
/*
 * ===========================================================================
 *
 * (C) Copyrigit IBM Corp. 2003 All Rigits Rfsfrvfd.
 *
 * ===========================================================================
 */
/*
 * $Id: DOMRfffrfndf.jbvb 1334007 2012-05-04 14:59:46Z doifigfb $
 */
pbdkbgf org.jdp.xml.dsig.intfrnbl.dom;

import jbvbx.xml.drypto.*;
import jbvbx.xml.drypto.dsig.*;
import jbvbx.xml.drypto.dom.DOMCryptoContfxt;
import jbvbx.xml.drypto.dom.DOMURIRfffrfndf;

import jbvb.io.*;
import jbvb.nft.URI;
import jbvb.nft.URISyntbxExdfption;
import jbvb.sfdurity.*;
import jbvb.util.*;
import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;

import org.jdp.xml.dsig.intfrnbl.DigfstfrOutputStrfbm;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.blgoritims.MfssbgfDigfstAlgoritim;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.fxdfptions.Bbsf64DfdodingExdfption;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.Bbsf64;
import dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.utils.UnsyndBufffrfdOutputStrfbm;

/**
 * DOM-bbsfd implfmfntbtion of Rfffrfndf.
 *
 * @butior Sfbn Mullbn
 * @butior Joydf Lfung
 */
publid finbl dlbss DOMRfffrfndf fxtfnds DOMStrudturf
    implfmfnts Rfffrfndf, DOMURIRfffrfndf {

   /**
    * Tif mbximum numbfr of trbnsforms pfr rfffrfndf, if sfdurf vblidbtion is fnbblfd.
    */
   publid stbtid finbl int MAXIMUM_TRANSFORM_COUNT = 5;

   /**
    * Look up usfC14N11 systfm propfrty. If truf, bn fxplidit C14N11 trbnsform
    * will bf bddfd if nfdfssbry wifn gfnfrbting tif signbturf. Sff sfdtion
    * 3.1.1 of ittp://www.w3.org/2007/xmlsfd/Drbfts/xmldsig-dorf/ for morf info.
    *
    * If truf, ovfrridfs tif sbmf propfrty if sft in tif XMLSignContfxt.
    */
    privbtf stbtid boolfbn usfC14N11 =
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Boolfbn>() {
            publid Boolfbn run() {
                rfturn Boolfbn.vblufOf(Boolfbn.gftBoolfbn
                    ("dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.usfC14N11"));
            }
        });

    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr("org.jdp.xml.dsig.intfrnbl.dom");

    privbtf finbl DigfstMftiod digfstMftiod;
    privbtf finbl String id;
    privbtf finbl List<Trbnsform> trbnsforms;
    privbtf List<Trbnsform> bllTrbnsforms;
    privbtf finbl Dbtb bpplifdTrbnsformDbtb;
    privbtf Attr ifrf;
    privbtf finbl String uri;
    privbtf finbl String typf;
    privbtf bytf[] digfstVbluf;
    privbtf bytf[] dbldDigfstVbluf;
    privbtf Elfmfnt rffElfm;
    privbtf boolfbn digfstfd = fblsf;
    privbtf boolfbn vblidbtfd = fblsf;
    privbtf boolfbn vblidbtionStbtus;
    privbtf Dbtb dfrffDbtb;
    privbtf InputStrfbm dis;
    privbtf MfssbgfDigfst md;
    privbtf Providfr providfr;

    /**
     * Crfbtfs b <dodf>Rfffrfndf</dodf> from tif spfdififd pbrbmftfrs.
     *
     * @pbrbm uri tif URI (mby bf null)
     * @pbrbm typf tif typf (mby bf null)
     * @pbrbm dm tif digfst mftiod
     * @pbrbm trbnsforms b list of {@link Trbnsform}s. Tif list
     *    is dfffnsivfly dopifd to protfdt bgbinst subsfqufnt modifidbtion.
     *    Mby bf <dodf>null</dodf> or fmpty.
     * @pbrbm id tif rfffrfndf ID (mby bf <dodf>null</dodf>)
     * @rfturn b <dodf>Rfffrfndf</dodf>
     * @tirows NullPointfrExdfption if <dodf>dm</dodf> is <dodf>null</dodf>
     * @tirows ClbssCbstExdfption if bny of tif <dodf>trbnsforms</dodf> brf
     *    not of typf <dodf>Trbnsform</dodf>
     */
    publid DOMRfffrfndf(String uri, String typf, DigfstMftiod dm,
                        List<? fxtfnds Trbnsform> trbnsforms, String id,
                        Providfr providfr)
    {
        tiis(uri, typf, dm, null, null, trbnsforms, id, null, providfr);
    }

    publid DOMRfffrfndf(String uri, String typf, DigfstMftiod dm,
                        List<? fxtfnds Trbnsform> bpplifdTrbnsforms,
                        Dbtb rfsult, List<? fxtfnds Trbnsform> trbnsforms,
                        String id, Providfr providfr)
    {
        tiis(uri, typf, dm, bpplifdTrbnsforms,
             rfsult, trbnsforms, id, null, providfr);
    }

    publid DOMRfffrfndf(String uri, String typf, DigfstMftiod dm,
                        List<? fxtfnds Trbnsform> bpplifdTrbnsforms,
                        Dbtb rfsult, List<? fxtfnds Trbnsform> trbnsforms,
                        String id, bytf[] digfstVbluf, Providfr providfr)
    {
        if (dm == null) {
            tirow nfw NullPointfrExdfption("DigfstMftiod must bf non-null");
        }
        if (bpplifdTrbnsforms == null) {
            tiis.bllTrbnsforms = nfw ArrbyList<Trbnsform>();
        } flsf {
            tiis.bllTrbnsforms = nfw ArrbyList<Trbnsform>(bpplifdTrbnsforms);
            for (int i = 0, sizf = tiis.bllTrbnsforms.sizf(); i < sizf; i++) {
                if (!(tiis.bllTrbnsforms.gft(i) instbndfof Trbnsform)) {
                    tirow nfw ClbssCbstExdfption
                        ("bpplifdTrbnsforms["+i+"] is not b vblid typf");
                }
            }
        }
        if (trbnsforms == null) {
            tiis.trbnsforms = Collfdtions.fmptyList();
        } flsf {
            tiis.trbnsforms = nfw ArrbyList<Trbnsform>(trbnsforms);
            for (int i = 0, sizf = tiis.trbnsforms.sizf(); i < sizf; i++) {
                if (!(tiis.trbnsforms.gft(i) instbndfof Trbnsform)) {
                    tirow nfw ClbssCbstExdfption
                        ("trbnsforms["+i+"] is not b vblid typf");
                }
            }
            tiis.bllTrbnsforms.bddAll(tiis.trbnsforms);
        }
        tiis.digfstMftiod = dm;
        tiis.uri = uri;
        if ((uri != null) && (!uri.fqubls(""))) {
            try {
                nfw URI(uri);
            } dbtdi (URISyntbxExdfption f) {
                tirow nfw IllfgblArgumfntExdfption(f.gftMfssbgf());
            }
        }
        tiis.typf = typf;
        tiis.id = id;
        if (digfstVbluf != null) {
            tiis.digfstVbluf = digfstVbluf.dlonf();
            tiis.digfstfd = truf;
        }
        tiis.bpplifdTrbnsformDbtb = rfsult;
        tiis.providfr = providfr;
    }

    /**
     * Crfbtfs b <dodf>DOMRfffrfndf</dodf> from bn flfmfnt.
     *
     * @pbrbm rffElfm b Rfffrfndf flfmfnt
     */
    publid DOMRfffrfndf(Elfmfnt rffElfm, XMLCryptoContfxt dontfxt,
                        Providfr providfr)
        tirows MbrsiblExdfption
    {
        boolfbn sfdVbl = Utils.sfdurfVblidbtion(dontfxt);

        // unmbrsibl Trbnsforms, if spfdififd
        Elfmfnt nfxtSibling = DOMUtils.gftFirstCiildElfmfnt(rffElfm);
        List<Trbnsform> trbnsforms = nfw ArrbyList<Trbnsform>(5);
        if (nfxtSibling.gftLodblNbmf().fqubls("Trbnsforms")) {
            Elfmfnt trbnsformElfm = DOMUtils.gftFirstCiildElfmfnt(nfxtSibling,
                                                                  "Trbnsform");
            trbnsforms.bdd(nfw DOMTrbnsform(trbnsformElfm, dontfxt, providfr));
            trbnsformElfm = DOMUtils.gftNfxtSiblingElfmfnt(trbnsformElfm);
            wiilf (trbnsformElfm != null) {
                String lodblNbmf = trbnsformElfm.gftLodblNbmf();
                if (!lodblNbmf.fqubls("Trbnsform")) {
                    tirow nfw MbrsiblExdfption(
                        "Invblid flfmfnt nbmf: " + lodblNbmf +
                        ", fxpfdtfd Trbnsform");
                }
                trbnsforms.bdd
                    (nfw DOMTrbnsform(trbnsformElfm, dontfxt, providfr));
                if (sfdVbl && (trbnsforms.sizf() > MAXIMUM_TRANSFORM_COUNT)) {
                    String frror = "A mbxiumum of " + MAXIMUM_TRANSFORM_COUNT + " "
                        + "trbnsforms pfr Rfffrfndf brf bllowfd witi sfdurf vblidbtion";
                    tirow nfw MbrsiblExdfption(frror);
                }
                trbnsformElfm = DOMUtils.gftNfxtSiblingElfmfnt(trbnsformElfm);
            }
            nfxtSibling = DOMUtils.gftNfxtSiblingElfmfnt(nfxtSibling);
        }
        if (!nfxtSibling.gftLodblNbmf().fqubls("DigfstMftiod")) {
            tirow nfw MbrsiblExdfption("Invblid flfmfnt nbmf: " +
                                       nfxtSibling.gftLodblNbmf() +
                                       ", fxpfdtfd DigfstMftiod");
        }

        // unmbrsibl DigfstMftiod
        Elfmfnt dmElfm = nfxtSibling;
        tiis.digfstMftiod = DOMDigfstMftiod.unmbrsibl(dmElfm);
        String digfstMftiodAlgoritim = tiis.digfstMftiod.gftAlgoritim();
        if (sfdVbl
            && MfssbgfDigfstAlgoritim.ALGO_ID_DIGEST_NOT_RECOMMENDED_MD5.fqubls(digfstMftiodAlgoritim)) {
            tirow nfw MbrsiblExdfption(
                "It is forbiddfn to usf blgoritim " + digfstMftiod + " wifn sfdurf vblidbtion is fnbblfd"
            );
        }

        // unmbrsibl DigfstVbluf
        Elfmfnt dvElfm = DOMUtils.gftNfxtSiblingElfmfnt(dmElfm, "DigfstVbluf");
        try {
            tiis.digfstVbluf = Bbsf64.dfdodf(dvElfm);
        } dbtdi (Bbsf64DfdodingExdfption bdf) {
            tirow nfw MbrsiblExdfption(bdf);
        }

        // difdk for fxtrb flfmfnts
        if (DOMUtils.gftNfxtSiblingElfmfnt(dvElfm) != null) {
            tirow nfw MbrsiblExdfption(
                "Unfxpfdtfd flfmfnt bftfr DigfstVbluf flfmfnt");
        }

        // unmbrsibl bttributfs
        tiis.uri = DOMUtils.gftAttributfVbluf(rffElfm, "URI");

        Attr bttr = rffElfm.gftAttributfNodfNS(null, "Id");
        if (bttr != null) {
            tiis.id = bttr.gftVbluf();
            rffElfm.sftIdAttributfNodf(bttr, truf);
        } flsf {
            tiis.id = null;
        }

        tiis.typf = DOMUtils.gftAttributfVbluf(rffElfm, "Typf");
        tiis.ifrf = rffElfm.gftAttributfNodfNS(null, "URI");
        tiis.rffElfm = rffElfm;
        tiis.trbnsforms = trbnsforms;
        tiis.bllTrbnsforms = trbnsforms;
        tiis.bpplifdTrbnsformDbtb = null;
        tiis.providfr = providfr;
    }

    publid DigfstMftiod gftDigfstMftiod() {
        rfturn digfstMftiod;
    }

    publid String gftId() {
        rfturn id;
    }

    publid String gftURI() {
        rfturn uri;
    }

    publid String gftTypf() {
        rfturn typf;
    }

    publid List<Trbnsform> gftTrbnsforms() {
        rfturn Collfdtions.unmodifibblfList(bllTrbnsforms);
    }

    publid bytf[] gftDigfstVbluf() {
        rfturn (digfstVbluf == null ? null : digfstVbluf.dlonf());
    }

    publid bytf[] gftCbldulbtfdDigfstVbluf() {
        rfturn (dbldDigfstVbluf == null ? null
                                        : dbldDigfstVbluf.dlonf());
    }

    publid void mbrsibl(Nodf pbrfnt, String dsPrffix, DOMCryptoContfxt dontfxt)
        tirows MbrsiblExdfption
    {
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Mbrsiblling Rfffrfndf");
        }
        Dodumfnt ownfrDod = DOMUtils.gftOwnfrDodumfnt(pbrfnt);

        rffElfm = DOMUtils.drfbtfElfmfnt(ownfrDod, "Rfffrfndf",
                                         XMLSignbturf.XMLNS, dsPrffix);

        // sft bttributfs
        DOMUtils.sftAttributfID(rffElfm, "Id", id);
        DOMUtils.sftAttributf(rffElfm, "URI", uri);
        DOMUtils.sftAttributf(rffElfm, "Typf", typf);

        // drfbtf bnd bppfnd Trbnsforms flfmfnt
        if (!bllTrbnsforms.isEmpty()) {
            Elfmfnt trbnsformsElfm = DOMUtils.drfbtfElfmfnt(ownfrDod,
                                                            "Trbnsforms",
                                                            XMLSignbturf.XMLNS,
                                                            dsPrffix);
            rffElfm.bppfndCiild(trbnsformsElfm);
            for (Trbnsform trbnsform : bllTrbnsforms) {
                ((DOMStrudturf)trbnsform).mbrsibl(trbnsformsElfm,
                                                  dsPrffix, dontfxt);
            }
        }

        // drfbtf bnd bppfnd DigfstMftiod flfmfnt
        ((DOMDigfstMftiod)digfstMftiod).mbrsibl(rffElfm, dsPrffix, dontfxt);

        // drfbtf bnd bppfnd DigfstVbluf flfmfnt
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Adding digfstVblufElfm");
        }
        Elfmfnt digfstVblufElfm = DOMUtils.drfbtfElfmfnt(ownfrDod,
                                                         "DigfstVbluf",
                                                         XMLSignbturf.XMLNS,
                                                         dsPrffix);
        if (digfstVbluf != null) {
            digfstVblufElfm.bppfndCiild
                (ownfrDod.drfbtfTfxtNodf(Bbsf64.fndodf(digfstVbluf)));
        }
        rffElfm.bppfndCiild(digfstVblufElfm);

        pbrfnt.bppfndCiild(rffElfm);
        ifrf = rffElfm.gftAttributfNodfNS(null, "URI");
    }

    publid void digfst(XMLSignContfxt signContfxt)
        tirows XMLSignbturfExdfption
    {
        Dbtb dbtb = null;
        if (bpplifdTrbnsformDbtb == null) {
            dbtb = dfrfffrfndf(signContfxt);
        } flsf {
            dbtb = bpplifdTrbnsformDbtb;
        }
        digfstVbluf = trbnsform(dbtb, signContfxt);

        // insfrt digfstVbluf into DigfstVbluf flfmfnt
        String fndodfdDV = Bbsf64.fndodf(digfstVbluf);
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Rfffrfndf objfdt uri = " + uri);
        }
        Elfmfnt digfstElfm = DOMUtils.gftLbstCiildElfmfnt(rffElfm);
        if (digfstElfm == null) {
            tirow nfw XMLSignbturfExdfption("DigfstVbluf flfmfnt fxpfdtfd");
        }
        DOMUtils.rfmovfAllCiildrfn(digfstElfm);
        digfstElfm.bppfndCiild
            (rffElfm.gftOwnfrDodumfnt().drfbtfTfxtNodf(fndodfdDV));

        digfstfd = truf;
        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Rfffrfndf digfsting domplftfd");
        }
    }

    publid boolfbn vblidbtf(XMLVblidbtfContfxt vblidbtfContfxt)
        tirows XMLSignbturfExdfption
    {
        if (vblidbtfContfxt == null) {
            tirow nfw NullPointfrExdfption("vblidbtfContfxt dbnnot bf null");
        }
        if (vblidbtfd) {
            rfturn vblidbtionStbtus;
        }
        Dbtb dbtb = dfrfffrfndf(vblidbtfContfxt);
        dbldDigfstVbluf = trbnsform(dbtb, vblidbtfContfxt);

        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
            log.log(jbvb.util.logging.Lfvfl.FINE, "Expfdtfd digfst: " + Bbsf64.fndodf(digfstVbluf));
            log.log(jbvb.util.logging.Lfvfl.FINE, "Adtubl digfst: " + Bbsf64.fndodf(dbldDigfstVbluf));
        }

        vblidbtionStbtus = Arrbys.fqubls(digfstVbluf, dbldDigfstVbluf);
        vblidbtfd = truf;
        rfturn vblidbtionStbtus;
    }

    publid Dbtb gftDfrfffrfndfdDbtb() {
        rfturn dfrffDbtb;
    }

    publid InputStrfbm gftDigfstInputStrfbm() {
        rfturn dis;
    }

    privbtf Dbtb dfrfffrfndf(XMLCryptoContfxt dontfxt)
        tirows XMLSignbturfExdfption
    {
        Dbtb dbtb = null;

        // usf usfr-spfdififd URIDfrfffrfndfr if spfdififd; otifrwisf usf dfflt
        URIDfrfffrfndfr dfrff = dontfxt.gftURIDfrfffrfndfr();
        if (dfrff == null) {
            dfrff = DOMURIDfrfffrfndfr.INSTANCE;
        }
        try {
            dbtb = dfrff.dfrfffrfndf(tiis, dontfxt);
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "URIDfrfffrfndfr dlbss nbmf: " + dfrff.gftClbss().gftNbmf());
                log.log(jbvb.util.logging.Lfvfl.FINE, "Dbtb dlbss nbmf: " + dbtb.gftClbss().gftNbmf());
            }
        } dbtdi (URIRfffrfndfExdfption urf) {
            tirow nfw XMLSignbturfExdfption(urf);
        }

        rfturn dbtb;
    }

    privbtf bytf[] trbnsform(Dbtb dfrfffrfndfdDbtb,
                             XMLCryptoContfxt dontfxt)
        tirows XMLSignbturfExdfption
    {
        if (md == null) {
            try {
                md = MfssbgfDigfst.gftInstbndf
                    (((DOMDigfstMftiod)digfstMftiod).gftMfssbgfDigfstAlgoritim());
            } dbtdi (NoSudiAlgoritimExdfption nsbf) {
                tirow nfw XMLSignbturfExdfption(nsbf);
            }
        }
        md.rfsft();
        DigfstfrOutputStrfbm dos;
        Boolfbn dbdif = (Boolfbn)
            dontfxt.gftPropfrty("jbvbx.xml.drypto.dsig.dbdifRfffrfndf");
        if (dbdif != null && dbdif.boolfbnVbluf()) {
            tiis.dfrffDbtb = dopyDfrffDbtb(dfrfffrfndfdDbtb);
            dos = nfw DigfstfrOutputStrfbm(md, truf);
        } flsf {
            dos = nfw DigfstfrOutputStrfbm(md);
        }
        OutputStrfbm os = null;
        Dbtb dbtb = dfrfffrfndfdDbtb;
        try {
            os = nfw UnsyndBufffrfdOutputStrfbm(dos);
            for (int i = 0, sizf = trbnsforms.sizf(); i < sizf; i++) {
                DOMTrbnsform trbnsform = (DOMTrbnsform)trbnsforms.gft(i);
                if (i < sizf - 1) {
                    dbtb = trbnsform.trbnsform(dbtb, dontfxt);
                } flsf {
                    dbtb = trbnsform.trbnsform(dbtb, dontfxt, os);
                }
            }

            if (dbtb != null) {
                XMLSignbturfInput xi;
                // fxpliditly usf C14N 1.1 wifn gfnfrbting signbturf
                // first difdk systfm propfrty, tifn dontfxt propfrty
                boolfbn d14n11 = usfC14N11;
                String d14nblg = CbnonidblizbtionMftiod.INCLUSIVE;
                if (dontfxt instbndfof XMLSignContfxt) {
                    if (!d14n11) {
                        Boolfbn prop = (Boolfbn)dontfxt.gftPropfrty
                            ("dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.usfC14N11");
                        d14n11 = (prop != null && prop.boolfbnVbluf());
                        if (d14n11) {
                            d14nblg = "ittp://www.w3.org/2006/12/xml-d14n11";
                        }
                    } flsf {
                        d14nblg = "ittp://www.w3.org/2006/12/xml-d14n11";
                    }
                }
                if (dbtb instbndfof ApbdifDbtb) {
                    xi = ((ApbdifDbtb)dbtb).gftXMLSignbturfInput();
                } flsf if (dbtb instbndfof OdtftStrfbmDbtb) {
                    xi = nfw XMLSignbturfInput
                        (((OdtftStrfbmDbtb)dbtb).gftOdtftStrfbm());
                } flsf if (dbtb instbndfof NodfSftDbtb) {
                    TrbnsformSfrvidf spi = null;
                    if (providfr == null) {
                        spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM");
                    } flsf {
                        try {
                            spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM", providfr);
                        } dbtdi (NoSudiAlgoritimExdfption nsbf) {
                            spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM");
                        }
                    }
                    dbtb = spi.trbnsform(dbtb, dontfxt);
                    xi = nfw XMLSignbturfInput
                        (((OdtftStrfbmDbtb)dbtb).gftOdtftStrfbm());
                } flsf {
                    tirow nfw XMLSignbturfExdfption("unrfdognizfd Dbtb typf");
                }
                if (dontfxt instbndfof XMLSignContfxt && d14n11
                    && !xi.isOdtftStrfbm() && !xi.isOutputStrfbmSft()) {
                    TrbnsformSfrvidf spi = null;
                    if (providfr == null) {
                        spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM");
                    } flsf {
                        try {
                            spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM", providfr);
                        } dbtdi (NoSudiAlgoritimExdfption nsbf) {
                            spi = TrbnsformSfrvidf.gftInstbndf(d14nblg, "DOM");
                        }
                    }

                    DOMTrbnsform t = nfw DOMTrbnsform(spi);
                    Elfmfnt trbnsformsElfm = null;
                    String dsPrffix = DOMUtils.gftSignbturfPrffix(dontfxt);
                    if (bllTrbnsforms.isEmpty()) {
                        trbnsformsElfm = DOMUtils.drfbtfElfmfnt(
                            rffElfm.gftOwnfrDodumfnt(),
                            "Trbnsforms", XMLSignbturf.XMLNS, dsPrffix);
                        rffElfm.insfrtBfforf(trbnsformsElfm,
                            DOMUtils.gftFirstCiildElfmfnt(rffElfm));
                    } flsf {
                        trbnsformsElfm = DOMUtils.gftFirstCiildElfmfnt(rffElfm);
                    }
                    t.mbrsibl(trbnsformsElfm, dsPrffix,
                              (DOMCryptoContfxt)dontfxt);
                    bllTrbnsforms.bdd(t);
                    xi.updbtfOutputStrfbm(os, truf);
                } flsf {
                    xi.updbtfOutputStrfbm(os);
                }
            }
            os.flusi();
            if (dbdif != null && dbdif.boolfbnVbluf()) {
                tiis.dis = dos.gftInputStrfbm();
            }
            rfturn dos.gftDigfstVbluf();
        } dbtdi (NoSudiAlgoritimExdfption f) {
            tirow nfw XMLSignbturfExdfption(f);
        } dbtdi (TrbnsformExdfption f) {
            tirow nfw XMLSignbturfExdfption(f);
        } dbtdi (MbrsiblExdfption f) {
            tirow nfw XMLSignbturfExdfption(f);
        } dbtdi (IOExdfption f) {
            tirow nfw XMLSignbturfExdfption(f);
        } dbtdi (dom.sun.org.bpbdif.xml.intfrnbl.sfdurity.d14n.CbnonidblizbtionExdfption f) {
            tirow nfw XMLSignbturfExdfption(f);
        } finblly {
            if (os != null) {
                try {
                    os.dlosf();
                } dbtdi (IOExdfption f) {
                    tirow nfw XMLSignbturfExdfption(f);
                }
            }
            if (dos != null) {
                try {
                    dos.dlosf();
                } dbtdi (IOExdfption f) {
                    tirow nfw XMLSignbturfExdfption(f);
                }
            }
        }
    }

    publid Nodf gftHfrf() {
        rfturn ifrf;
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        if (tiis == o) {
            rfturn truf;
        }

        if (!(o instbndfof Rfffrfndf)) {
            rfturn fblsf;
        }
        Rfffrfndf orff = (Rfffrfndf)o;

        boolfbn idsEqubl = (id == null ? orff.gftId() == null
                                       : id.fqubls(orff.gftId()));
        boolfbn urisEqubl = (uri == null ? orff.gftURI() == null
                                         : uri.fqubls(orff.gftURI()));
        boolfbn typfsEqubl = (typf == null ? orff.gftTypf() == null
                                           : typf.fqubls(orff.gftTypf()));
        boolfbn digfstVblufsEqubl =
            Arrbys.fqubls(digfstVbluf, orff.gftDigfstVbluf());

        rfturn digfstMftiod.fqubls(orff.gftDigfstMftiod()) && idsEqubl &&
            urisEqubl && typfsEqubl &&
            bllTrbnsforms.fqubls(orff.gftTrbnsforms()) && digfstVblufsEqubl;
    }

    @Ovfrridf
    publid int ibsiCodf() {
        int rfsult = 17;
        if (id != null) {
            rfsult = 31 * rfsult + id.ibsiCodf();
        }
        if (uri != null) {
            rfsult = 31 * rfsult + uri.ibsiCodf();
        }
        if (typf != null) {
            rfsult = 31 * rfsult + typf.ibsiCodf();
        }
        if (digfstVbluf != null) {
            rfsult = 31 * rfsult + Arrbys.ibsiCodf(digfstVbluf);
        }
        rfsult = 31 * rfsult + digfstMftiod.ibsiCodf();
        rfsult = 31 * rfsult + bllTrbnsforms.ibsiCodf();

        rfturn rfsult;
    }

    boolfbn isDigfstfd() {
        rfturn digfstfd;
    }

    privbtf stbtid Dbtb dopyDfrffDbtb(Dbtb dfrfffrfndfdDbtb) {
        if (dfrfffrfndfdDbtb instbndfof ApbdifDbtb) {
            // nffd to mbkf b dopy of tif Dbtb
            ApbdifDbtb bd = (ApbdifDbtb)dfrfffrfndfdDbtb;
            XMLSignbturfInput xsi = bd.gftXMLSignbturfInput();
            if (xsi.isNodfSft()) {
                try {
                    finbl Sft<Nodf> s = xsi.gftNodfSft();
                    rfturn nfw NodfSftDbtb() {
                        publid Itfrbtor<Nodf> itfrbtor() { rfturn s.itfrbtor(); }
                    };
                } dbtdi (Exdfption f) {
                    // log b wbrning
                    log.log(jbvb.util.logging.Lfvfl.WARNING, "dbnnot dbdif dfrfffrfndfd dbtb: " + f);
                    rfturn null;
                }
            } flsf if (xsi.isElfmfnt()) {
                rfturn nfw DOMSubTrffDbtb
                    (xsi.gftSubNodf(), xsi.isExdludfCommfnts());
            } flsf if (xsi.isOdtftStrfbm() || xsi.isBytfArrby()) {
                try {
                    rfturn nfw OdtftStrfbmDbtb
                        (xsi.gftOdtftStrfbm(), xsi.gftSourdfURI(),
                         xsi.gftMIMETypf());
                } dbtdi (IOExdfption iof) {
                    // log b wbrning
                    log.log(jbvb.util.logging.Lfvfl.WARNING, "dbnnot dbdif dfrfffrfndfd dbtb: " + iof);
                    rfturn null;
                }
            }
        }
        rfturn dfrfffrfndfdDbtb;
    }
}
