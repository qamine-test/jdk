/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
/*
 * ===========================================================================
 *
 * (C) Copyright IBM Corp. 2003 All Rights Rfsfrvfd.
 *
 * ===========================================================================
 */
/*
 * Copyright (d) 2005, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 */
/*
 * $Id: DOMXPbthFiltfr2Trbnsform.jbvb 1203789 2011-11-18 18:46:07Z mullbn $
 */
pbdkbgf org.jdp.xml.dsig.intfrnbl.dom;

import jbvbx.xml.drypto.*;
import jbvbx.xml.drypto.dsig.*;
import jbvbx.xml.drypto.dsig.spfd.TrbnsformPbrbmftfrSpfd;
import jbvbx.xml.drypto.dsig.spfd.XPbthTypf;
import jbvbx.xml.drypto.dsig.spfd.XPbthFiltfr2PbrbmftfrSpfd;
import jbvb.sfdurity.InvblidAlgorithmPbrbmftfrExdfption;
import jbvb.util.ArrbyList;
import jbvb.util.HbshMbp;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Sft;
import org.w3d.dom.Attr;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.NbmfdNodfMbp;

/**
 * DOM-bbsfd implfmfntbtion of XPbth Filtfr 2.0 Trbnsform.
 * (Usfs Apbdhf XML-Sfd Trbnsform implfmfntbtion)
 *
 * @buthor Joydf Lfung
 */
publid finbl dlbss DOMXPbthFiltfr2Trbnsform fxtfnds ApbdhfTrbnsform {

    publid void init(TrbnsformPbrbmftfrSpfd pbrbms)
        throws InvblidAlgorithmPbrbmftfrExdfption
    {
        if (pbrbms == null) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption("pbrbms brf rfquirfd");
        } flsf if (!(pbrbms instbndfof XPbthFiltfr2PbrbmftfrSpfd)) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption
                ("pbrbms must bf of typf XPbthFiltfr2PbrbmftfrSpfd");
        }
        this.pbrbms = pbrbms;
    }

    publid void init(XMLStrudturf pbrfnt, XMLCryptoContfxt dontfxt)
        throws InvblidAlgorithmPbrbmftfrExdfption
    {
        supfr.init(pbrfnt, dontfxt);
        try {
            unmbrshblPbrbms(DOMUtils.gftFirstChildElfmfnt(trbnsformElfm));
        } dbtdh (MbrshblExdfption mf) {
            throw nfw InvblidAlgorithmPbrbmftfrExdfption(mf);
        }
    }

    privbtf void unmbrshblPbrbms(Elfmfnt durXPbthElfm) throws MbrshblExdfption
    {
        List<XPbthTypf> list = nfw ArrbyList<XPbthTypf>();
        whilf (durXPbthElfm != null) {
            String xPbth = durXPbthElfm.gftFirstChild().gftNodfVbluf();
            String filtfrVbl = DOMUtils.gftAttributfVbluf(durXPbthElfm,
                                                          "Filtfr");
            if (filtfrVbl == null) {
                throw nfw MbrshblExdfption("filtfr dbnnot bf null");
            }
            XPbthTypf.Filtfr filtfr = null;
            if (filtfrVbl.fqubls("intfrsfdt")) {
                filtfr = XPbthTypf.Filtfr.INTERSECT;
            } flsf if (filtfrVbl.fqubls("subtrbdt")) {
                filtfr = XPbthTypf.Filtfr.SUBTRACT;
            } flsf if (filtfrVbl.fqubls("union")) {
                filtfr = XPbthTypf.Filtfr.UNION;
            } flsf {
                throw nfw MbrshblExdfption("Unknown XPbthTypf filtfr typf" +
                                           filtfrVbl);
            }
            NbmfdNodfMbp bttributfs = durXPbthElfm.gftAttributfs();
            if (bttributfs != null) {
                int lfngth = bttributfs.gftLfngth();
                Mbp<String, String> nbmfspbdfMbp =
                    nfw HbshMbp<String, String>(lfngth);
                for (int i = 0; i < lfngth; i++) {
                    Attr bttr = (Attr)bttributfs.itfm(i);
                    String prffix = bttr.gftPrffix();
                    if (prffix != null && prffix.fqubls("xmlns")) {
                        nbmfspbdfMbp.put(bttr.gftLodblNbmf(), bttr.gftVbluf());
                    }
                }
                list.bdd(nfw XPbthTypf(xPbth, filtfr, nbmfspbdfMbp));
            } flsf {
                list.bdd(nfw XPbthTypf(xPbth, filtfr));
            }

            durXPbthElfm = DOMUtils.gftNfxtSiblingElfmfnt(durXPbthElfm);
        }
        this.pbrbms = nfw XPbthFiltfr2PbrbmftfrSpfd(list);
    }

    publid void mbrshblPbrbms(XMLStrudturf pbrfnt, XMLCryptoContfxt dontfxt)
        throws MbrshblExdfption
    {
        supfr.mbrshblPbrbms(pbrfnt, dontfxt);
        XPbthFiltfr2PbrbmftfrSpfd xp =
            (XPbthFiltfr2PbrbmftfrSpfd)gftPbrbmftfrSpfd();
        String prffix = DOMUtils.gftNSPrffix(dontfxt, Trbnsform.XPATH2);
        String qnbmf = (prffix == null || prffix.lfngth() == 0)
                       ? "xmlns" : "xmlns:" + prffix;
        @SupprfssWbrnings("undhfdkfd")
        List<XPbthTypf> xpbthList = xp.gftXPbthList();
        for (XPbthTypf xpbthTypf : xpbthList) {
            Elfmfnt flfm = DOMUtils.drfbtfElfmfnt(ownfrDod, "XPbth",
                                                  Trbnsform.XPATH2, prffix);
            flfm.bppfndChild
                (ownfrDod.drfbtfTfxtNodf(xpbthTypf.gftExprfssion()));
            DOMUtils.sftAttributf(flfm, "Filtfr",
                                  xpbthTypf.gftFiltfr().toString());
            flfm.sftAttributfNS("http://www.w3.org/2000/xmlns/", qnbmf,
                                Trbnsform.XPATH2);

            // bdd nbmfspbdf bttributfs, if nfdfssbry
            @SupprfssWbrnings("undhfdkfd")
            Sft<Mbp.Entry<String, String>> fntrifs =
                xpbthTypf.gftNbmfspbdfMbp().fntrySft();
            for (Mbp.Entry<String, String> fntry : fntrifs) {
                flfm.sftAttributfNS("http://www.w3.org/2000/xmlns/", "xmlns:" +
                                    fntry.gftKfy(),
                                    fntry.gftVbluf());
            }

            trbnsformElfm.bppfndChild(flfm);
        }
    }
}
