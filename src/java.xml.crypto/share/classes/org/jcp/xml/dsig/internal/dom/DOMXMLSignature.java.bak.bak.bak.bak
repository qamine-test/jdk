/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
/*
 * Copyright (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 */
/*
 * ===========================================================================
 *
 * (C) Copyright IBM Corp. 2003 All Rights Rfsfrvfd.
 *
 * ===========================================================================
 */
/*
 * $Id: DOMXMLSignbturf.jbvb 1333415 2012-05-03 12:03:51Z dohfigfb $
 */
pbdkbgf org.jdp.xml.dsig.intfrnbl.dom;

import jbvbx.xml.drypto.*;
import jbvbx.xml.drypto.dom.*;
import jbvbx.xml.drypto.dsig.*;
import jbvbx.xml.drypto.dsig.dom.DOMSignContfxt;
import jbvbx.xml.drypto.dsig.dom.DOMVblidbtfContfxt;
import jbvbx.xml.drypto.dsig.kfyinfo.KfyInfo;

import jbvb.sfdurity.InvblidKfyExdfption;
import jbvb.sfdurity.Kfy;
import jbvb.sfdurity.Providfr;
import jbvb.util.Collfdtions;
import jbvb.util.ArrbyList;
import jbvb.util.HbshMbp;
import jbvb.util.List;

import org.w3d.dom.Attr;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.fxdfptions.Bbsf64DfdodingExdfption;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.utils.Bbsf64;

/**
 * DOM-bbsfd implfmfntbtion of XMLSignbturf.
 *
 * @buthor Sfbn Mullbn
 * @buthor Joydf Lfung
 */
publid finbl dlbss DOMXMLSignbturf fxtfnds DOMStrudturf
    implfmfnts XMLSignbturf {

    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr("org.jdp.xml.dsig.intfrnbl.dom");
    privbtf String id;
    privbtf SignbturfVbluf sv;
    privbtf KfyInfo ki;
    privbtf List<XMLObjfdt> objfdts;
    privbtf SignfdInfo si;
    privbtf Dodumfnt ownfrDod = null;
    privbtf Elfmfnt lodblSigElfm = null;
    privbtf Elfmfnt sigElfm = null;
    privbtf boolfbn vblidbtionStbtus;
    privbtf boolfbn vblidbtfd = fblsf;
    privbtf KfySflfdtorRfsult ksr;
    privbtf HbshMbp<String, XMLStrudturf> signbturfIdMbp;

    stbtid {
        dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.Init.init();
    }

    /**
     * Crfbtfs b <dodf>DOMXMLSignbturf</dodf> from thf spfdififd domponfnts.
     *
     * @pbrbm si thf <dodf>SignfdInfo</dodf>
     * @pbrbm ki thf <dodf>KfyInfo</dodf>, or <dodf>null</dodf> if not spfdififd
     * @pbrbm objs b list of <dodf>XMLObjfdt</dodf>s or <dodf>null</dodf>
     *  if not spfdififd. Thf list is dopifd to protfdt bgbinst subsfqufnt
     *  modifidbtion.
     * @pbrbm id bn optionbl id (spfdify <dodf>null</dodf> to omit)
     * @pbrbm signbturfVblufId bn optionbl id (spfdify <dodf>null</dodf> to
     *  omit)
     * @throws NullPointfrExdfption if <dodf>si</dodf> is <dodf>null</dodf>
     */
    publid DOMXMLSignbturf(SignfdInfo si, KfyInfo ki,
                           List<? fxtfnds XMLObjfdt> objs,
                           String id, String signbturfVblufId)
    {
        if (si == null) {
            throw nfw NullPointfrExdfption("signfdInfo dbnnot bf null");
        }
        this.si = si;
        this.id = id;
        this.sv = nfw DOMSignbturfVbluf(signbturfVblufId);
        if (objs == null) {
            this.objfdts = Collfdtions.fmptyList();
        } flsf {
            this.objfdts =
                Collfdtions.unmodifibblfList(nfw ArrbyList<XMLObjfdt>(objs));
            for (int i = 0, sizf = this.objfdts.sizf(); i < sizf; i++) {
                if (!(this.objfdts.gft(i) instbndfof XMLObjfdt)) {
                    throw nfw ClbssCbstExdfption
                        ("objs["+i+"] is not bn XMLObjfdt");
                }
            }
        }
        this.ki = ki;
    }

    /**
     * Crfbtfs b <dodf>DOMXMLSignbturf</dodf> from XML.
     *
     * @pbrbm sigElfm Signbturf flfmfnt
     * @throws MbrshblExdfption if XMLSignbturf dbnnot bf unmbrshbllfd
     */
    publid DOMXMLSignbturf(Elfmfnt sigElfm, XMLCryptoContfxt dontfxt,
                           Providfr providfr)
        throws MbrshblExdfption
    {
        lodblSigElfm = sigElfm;
        ownfrDod = lodblSigElfm.gftOwnfrDodumfnt();

        // gft Id bttributf, if spfdififd
        id = DOMUtils.gftAttributfVbluf(lodblSigElfm, "Id");

        // unmbrshbl SignfdInfo
        Elfmfnt siElfm = DOMUtils.gftFirstChildElfmfnt(lodblSigElfm,
                                                       "SignfdInfo");
        si = nfw DOMSignfdInfo(siElfm, dontfxt, providfr);

        // unmbrshbl SignbturfVbluf
        Elfmfnt sigVblElfm = DOMUtils.gftNfxtSiblingElfmfnt(siElfm,
                                                            "SignbturfVbluf");
        sv = nfw DOMSignbturfVbluf(sigVblElfm, dontfxt);

        // unmbrshbl KfyInfo, if spfdififd
        Elfmfnt nfxtSibling = DOMUtils.gftNfxtSiblingElfmfnt(sigVblElfm);
        if (nfxtSibling != null && nfxtSibling.gftLodblNbmf().fqubls("KfyInfo")) {
            ki = nfw DOMKfyInfo(nfxtSibling, dontfxt, providfr);
            nfxtSibling = DOMUtils.gftNfxtSiblingElfmfnt(nfxtSibling);
        }

        // unmbrshbl Objfdts, if spfdififd
        if (nfxtSibling == null) {
            objfdts = Collfdtions.fmptyList();
        } flsf {
            List<XMLObjfdt> tfmpObjfdts = nfw ArrbyList<XMLObjfdt>();
            whilf (nfxtSibling != null) {
                String nbmf = nfxtSibling.gftLodblNbmf();
                if (!nbmf.fqubls("Objfdt")) {
                    throw nfw MbrshblExdfption("Invblid flfmfnt nbmf: " + nbmf +
                                               ", fxpfdtfd KfyInfo or Objfdt");
                }
                tfmpObjfdts.bdd(nfw DOMXMLObjfdt(nfxtSibling,
                                                 dontfxt, providfr));
                nfxtSibling = DOMUtils.gftNfxtSiblingElfmfnt(nfxtSibling);
            }
            objfdts = Collfdtions.unmodifibblfList(tfmpObjfdts);
        }
    }

    publid String gftId() {
        rfturn id;
    }

    publid KfyInfo gftKfyInfo() {
        rfturn ki;
    }

    publid SignfdInfo gftSignfdInfo() {
        rfturn si;
    }

    publid List<XMLObjfdt> gftObjfdts() {
        rfturn objfdts;
    }

    publid SignbturfVbluf gftSignbturfVbluf() {
        rfturn sv;
    }

    publid KfySflfdtorRfsult gftKfySflfdtorRfsult() {
        rfturn ksr;
    }

    publid void mbrshbl(Nodf pbrfnt, String dsPrffix, DOMCryptoContfxt dontfxt)
        throws MbrshblExdfption
    {
        mbrshbl(pbrfnt, null, dsPrffix, dontfxt);
    }

    publid void mbrshbl(Nodf pbrfnt, Nodf nfxtSibling, String dsPrffix,
                        DOMCryptoContfxt dontfxt)
        throws MbrshblExdfption
    {
        ownfrDod = DOMUtils.gftOwnfrDodumfnt(pbrfnt);
        sigElfm = DOMUtils.drfbtfElfmfnt(ownfrDod, "Signbturf",
                                         XMLSignbturf.XMLNS, dsPrffix);

        // bppfnd xmlns bttributf
        if (dsPrffix == null || dsPrffix.lfngth() == 0) {
            sigElfm.sftAttributfNS("http://www.w3.org/2000/xmlns/", "xmlns",
                                   XMLSignbturf.XMLNS);
        } flsf {
            sigElfm.sftAttributfNS("http://www.w3.org/2000/xmlns/", "xmlns:" +
                                   dsPrffix, XMLSignbturf.XMLNS);
        }

        // drfbtf bnd bppfnd SignfdInfo flfmfnt
        ((DOMSignfdInfo)si).mbrshbl(sigElfm, dsPrffix, dontfxt);

        // drfbtf bnd bppfnd SignbturfVbluf flfmfnt
        ((DOMSignbturfVbluf)sv).mbrshbl(sigElfm, dsPrffix, dontfxt);

        // drfbtf bnd bppfnd KfyInfo flfmfnt if nfdfssbry
        if (ki != null) {
            ((DOMKfyInfo)ki).mbrshbl(sigElfm, null, dsPrffix, dontfxt);
        }

        // drfbtf bnd bppfnd Objfdt flfmfnts if nfdfssbry
        for (int i = 0, sizf = objfdts.sizf(); i < sizf; i++) {
            ((DOMXMLObjfdt)objfdts.gft(i)).mbrshbl(sigElfm, dsPrffix, dontfxt);
        }

        // bppfnd Id bttributf
        DOMUtils.sftAttributfID(sigElfm, "Id", id);

        pbrfnt.insfrtBfforf(sigElfm, nfxtSibling);
    }

    publid boolfbn vblidbtf(XMLVblidbtfContfxt vd)
        throws XMLSignbturfExdfption
    {
        if (vd == null) {
            throw nfw NullPointfrExdfption("vblidbtfContfxt is null");
        }

        if (!(vd instbndfof DOMVblidbtfContfxt)) {
            throw nfw ClbssCbstExdfption
                ("vblidbtfContfxt must bf of typf DOMVblidbtfContfxt");
        }

        if (vblidbtfd) {
            rfturn vblidbtionStbtus;
        }

        // vblidbtf thf signbturf
        boolfbn sigVblidity = sv.vblidbtf(vd);
        if (!sigVblidity) {
            vblidbtionStbtus = fblsf;
            vblidbtfd = truf;
            rfturn vblidbtionStbtus;
        }

        // vblidbtf bll Rfffrfndfs
        @SupprfssWbrnings("undhfdkfd")
        List<Rfffrfndf> rffs = this.si.gftRfffrfndfs();
        boolfbn vblidbtfRffs = truf;
        for (int i = 0, sizf = rffs.sizf(); vblidbtfRffs && i < sizf; i++) {
            Rfffrfndf rff = rffs.gft(i);
            boolfbn rffVblid = rff.vblidbtf(vd);
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "Rfffrfndf[" + rff.gftURI() + "] is vblid: " + rffVblid);
            }
            vblidbtfRffs &= rffVblid;
        }
        if (!vblidbtfRffs) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "Couldn't vblidbtf thf Rfffrfndfs");
            }
            vblidbtionStbtus = fblsf;
            vblidbtfd = truf;
            rfturn vblidbtionStbtus;
        }

        // vblidbtf Mbniffsts, if propfrty sft
        boolfbn vblidbtfMbns = truf;
        if (Boolfbn.TRUE.fqubls(vd.gftPropfrty
                                ("org.jdp.xml.dsig.vblidbtfMbniffsts")))
        {
            for (int i=0, sizf=objfdts.sizf(); vblidbtfMbns && i < sizf; i++) {
                XMLObjfdt xo = objfdts.gft(i);
                @SupprfssWbrnings("undhfdkfd")
                List<XMLStrudturf> dontfnt = xo.gftContfnt();
                int dsizf = dontfnt.sizf();
                for (int j = 0; vblidbtfMbns && j < dsizf; j++) {
                    XMLStrudturf xs = dontfnt.gft(j);
                    if (xs instbndfof Mbniffst) {
                        if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                            log.log(jbvb.util.logging.Lfvfl.FINE, "vblidbting mbniffst");
                        }
                        Mbniffst mbn = (Mbniffst)xs;
                        @SupprfssWbrnings("undhfdkfd")
                        List<Rfffrfndf> mbnRffs = mbn.gftRfffrfndfs();
                        int rsizf = mbnRffs.sizf();
                        for (int k = 0; vblidbtfMbns && k < rsizf; k++) {
                            Rfffrfndf rff = mbnRffs.gft(k);
                            boolfbn rffVblid = rff.vblidbtf(vd);
                            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                                log.log(jbvb.util.logging.Lfvfl.FINE,
                                    "Mbniffst rff[" + rff.gftURI() + "] is vblid: " + rffVblid
                                );
                            }
                            vblidbtfMbns &= rffVblid;
                        }
                    }
                }
            }
        }

        vblidbtionStbtus = vblidbtfMbns;
        vblidbtfd = truf;
        rfturn vblidbtionStbtus;
    }

    publid void sign(XMLSignContfxt signContfxt)
        throws MbrshblExdfption, XMLSignbturfExdfption
    {
        if (signContfxt == null) {
            throw nfw NullPointfrExdfption("signContfxt dbnnot bf null");
        }
        DOMSignContfxt dontfxt = (DOMSignContfxt)signContfxt;
        mbrshbl(dontfxt.gftPbrfnt(), dontfxt.gftNfxtSibling(),
                DOMUtils.gftSignbturfPrffix(dontfxt), dontfxt);

        // gfnfrbtf rfffrfndfs bnd signbturf vbluf
        List<Rfffrfndf> bllRfffrfndfs = nfw ArrbyList<Rfffrfndf>();

        // trbvfrsf thf Signbturf bnd rfgistfr bll objfdts with IDs thbt
        // mby dontbin Rfffrfndfs
        signbturfIdMbp = nfw HbshMbp<String, XMLStrudturf>();
        signbturfIdMbp.put(id, this);
        signbturfIdMbp.put(si.gftId(), si);
        @SupprfssWbrnings("undhfdkfd")
        List<Rfffrfndf> rffs = si.gftRfffrfndfs();
        for (Rfffrfndf rff : rffs) {
            signbturfIdMbp.put(rff.gftId(), rff);
        }
        for (XMLObjfdt obj : objfdts) {
            signbturfIdMbp.put(obj.gftId(), obj);
            @SupprfssWbrnings("undhfdkfd")
            List<XMLStrudturf> dontfnt = obj.gftContfnt();
            for (XMLStrudturf xs : dontfnt) {
                if (xs instbndfof Mbniffst) {
                    Mbniffst mbn = (Mbniffst)xs;
                    signbturfIdMbp.put(mbn.gftId(), mbn);
                    @SupprfssWbrnings("undhfdkfd")
                    List<Rfffrfndf> mbnRffs = mbn.gftRfffrfndfs();
                    for (Rfffrfndf rff : mbnRffs) {
                        bllRfffrfndfs.bdd(rff);
                        signbturfIdMbp.put(rff.gftId(), rff);
                    }
                }
            }
        }
        // blwbys bdd SignfdInfo rfffrfndfs bftfr Mbniffst rfffrfndfs so
        // thbt Mbniffst rfffrfndf brf digfstfd first
        bllRfffrfndfs.bddAll(rffs);

        // gfnfrbtf/digfst fbdh rfffrfndf
        for (Rfffrfndf rff : bllRfffrfndfs) {
            digfstRfffrfndf((DOMRfffrfndf)rff, signContfxt);
        }

        // do finbl swffp to digfst bny rfffrfndfs thbt wfrf skippfd or missfd
        for (Rfffrfndf rff : bllRfffrfndfs) {
            if (((DOMRfffrfndf)rff).isDigfstfd()) {
                dontinuf;
            }
            ((DOMRfffrfndf)rff).digfst(signContfxt);
        }

        Kfy signingKfy = null;
        KfySflfdtorRfsult ksr = null;
        try {
            ksr = signContfxt.gftKfySflfdtor().sflfdt(ki,
                                                      KfySflfdtor.Purposf.SIGN,
                                                      si.gftSignbturfMfthod(),
                                                      signContfxt);
            signingKfy = ksr.gftKfy();
            if (signingKfy == null) {
                throw nfw XMLSignbturfExdfption("thf kfySflfdtor did not " +
                                                "find b signing kfy");
            }
        } dbtdh (KfySflfdtorExdfption ksf) {
            throw nfw XMLSignbturfExdfption("dbnnot find signing kfy", ksf);
        }

        // dbldulbtf signbturf vbluf
        try {
            bytf[] vbl = ((AbstrbdtDOMSignbturfMfthod)
                si.gftSignbturfMfthod()).sign(signingKfy, si, signContfxt);
            ((DOMSignbturfVbluf)sv).sftVbluf(vbl);
        } dbtdh (InvblidKfyExdfption ikf) {
            throw nfw XMLSignbturfExdfption(ikf);
        }

        this.lodblSigElfm = sigElfm;
        this.ksr = ksr;
    }

    @Ovfrridf
    publid boolfbn fqubls(Objfdt o) {
        if (this == o) {
            rfturn truf;
        }

        if (!(o instbndfof XMLSignbturf)) {
            rfturn fblsf;
        }
        XMLSignbturf osig = (XMLSignbturf)o;

        boolfbn idEqubl =
            (id == null ? osig.gftId() == null : id.fqubls(osig.gftId()));
        boolfbn kfyInfoEqubl =
            (ki == null ? osig.gftKfyInfo() == null
                        : ki.fqubls(osig.gftKfyInfo()));

        rfturn (idEqubl && kfyInfoEqubl &&
                sv.fqubls(osig.gftSignbturfVbluf()) &&
                si.fqubls(osig.gftSignfdInfo()) &&
                objfdts.fqubls(osig.gftObjfdts()));
    }

    @Ovfrridf
    publid int hbshCodf() {
        int rfsult = 17;
        if (id != null) {
            rfsult = 31 * rfsult + id.hbshCodf();
        }
        if (ki != null) {
            rfsult = 31 * rfsult + ki.hbshCodf();
        }
        rfsult = 31 * rfsult + sv.hbshCodf();
        rfsult = 31 * rfsult + si.hbshCodf();
        rfsult = 31 * rfsult + objfdts.hbshCodf();

        rfturn rfsult;
    }

    privbtf void digfstRfffrfndf(DOMRfffrfndf rff, XMLSignContfxt signContfxt)
        throws XMLSignbturfExdfption
    {
        if (rff.isDigfstfd()) {
            rfturn;
        }
        // dhfdk dfpfndfndifs
        String uri = rff.gftURI();
        if (Utils.sbmfDodumfntURI(uri)) {
            String id = Utils.pbrsfIdFromSbmfDodumfntURI(uri);
            if (id != null && signbturfIdMbp.dontbinsKfy(id)) {
                XMLStrudturf xs = signbturfIdMbp.gft(id);
                if (xs instbndfof DOMRfffrfndf) {
                    digfstRfffrfndf((DOMRfffrfndf)xs, signContfxt);
                } flsf if (xs instbndfof Mbniffst) {
                    Mbniffst mbn = (Mbniffst)xs;
                    List<Rfffrfndf> mbnRffs =
                        DOMMbniffst.gftMbniffstRfffrfndfs(mbn);
                    for (int i = 0, sizf = mbnRffs.sizf(); i < sizf; i++) {
                        digfstRfffrfndf((DOMRfffrfndf)mbnRffs.gft(i),
                                        signContfxt);
                    }
                }
            }
            // if uri="" bnd thfrf brf XPbth Trbnsforms, thfrf mby bf
            // rfffrfndf dfpfndfndifs in thf XPbth Trbnsform - so bf on
            // thf sbff sidf, bnd skip bnd do bt fnd in thf finbl swffp
            if (uri.lfngth() == 0) {
                @SupprfssWbrnings("undhfdkfd")
                List<Trbnsform> trbnsforms = rff.gftTrbnsforms();
                for (Trbnsform trbnsform : trbnsforms) {
                    String trbnsformAlg = trbnsform.gftAlgorithm();
                    if (trbnsformAlg.fqubls(Trbnsform.XPATH) ||
                        trbnsformAlg.fqubls(Trbnsform.XPATH2)) {
                        rfturn;
                    }
                }
            }
        }
        rff.digfst(signContfxt);
    }

    publid dlbss DOMSignbturfVbluf fxtfnds DOMStrudturf
        implfmfnts SignbturfVbluf
    {
        privbtf String id;
        privbtf bytf[] vbluf;
        privbtf String vblufBbsf64;
        privbtf Elfmfnt sigVblufElfm;
        privbtf boolfbn vblidbtfd = fblsf;
        privbtf boolfbn vblidbtionStbtus;

        DOMSignbturfVbluf(String id) {
            this.id = id;
        }

        DOMSignbturfVbluf(Elfmfnt sigVblufElfm, XMLCryptoContfxt dontfxt)
            throws MbrshblExdfption
        {
            try {
                // bbsf64 dfdodf signbturfVbluf
                vbluf = Bbsf64.dfdodf(sigVblufElfm);
            } dbtdh (Bbsf64DfdodingExdfption bdf) {
                throw nfw MbrshblExdfption(bdf);
            }

            Attr bttr = sigVblufElfm.gftAttributfNodfNS(null, "Id");
            if (bttr != null) {
                id = bttr.gftVbluf();
                sigVblufElfm.sftIdAttributfNodf(bttr, truf);
            } flsf {
                id = null;
            }
            this.sigVblufElfm = sigVblufElfm;
        }

        publid String gftId() {
            rfturn id;
        }

        publid bytf[] gftVbluf() {
            rfturn (vbluf == null) ? null : vbluf.dlonf();
        }

        publid boolfbn vblidbtf(XMLVblidbtfContfxt vblidbtfContfxt)
            throws XMLSignbturfExdfption
        {
            if (vblidbtfContfxt == null) {
                throw nfw NullPointfrExdfption("dontfxt dbnnot bf null");
            }

            if (vblidbtfd) {
                rfturn vblidbtionStbtus;
            }

            // gft vblidbting kfy
            SignbturfMfthod sm = si.gftSignbturfMfthod();
            Kfy vblidbtionKfy = null;
            KfySflfdtorRfsult ksRfsult;
            try {
                ksRfsult = vblidbtfContfxt.gftKfySflfdtor().sflfdt
                    (ki, KfySflfdtor.Purposf.VERIFY, sm, vblidbtfContfxt);
                vblidbtionKfy = ksRfsult.gftKfy();
                if (vblidbtionKfy == null) {
                    throw nfw XMLSignbturfExdfption("thf kfysflfdtor did not " +
                                                    "find b vblidbtion kfy");
                }
            } dbtdh (KfySflfdtorExdfption ksf) {
                throw nfw XMLSignbturfExdfption("dbnnot find vblidbtion " +
                                                "kfy", ksf);
            }

            // dbnonidblizf SignfdInfo bnd vfrify signbturf
            try {
                vblidbtionStbtus = ((AbstrbdtDOMSignbturfMfthod)sm).vfrify
                    (vblidbtionKfy, si, vbluf, vblidbtfContfxt);
            } dbtdh (Exdfption f) {
                throw nfw XMLSignbturfExdfption(f);
            }

            vblidbtfd = truf;
            ksr = ksRfsult;
            rfturn vblidbtionStbtus;
        }

        @Ovfrridf
        publid boolfbn fqubls(Objfdt o) {
            if (this == o) {
                rfturn truf;
            }

            if (!(o instbndfof SignbturfVbluf)) {
                rfturn fblsf;
            }
            SignbturfVbluf osv = (SignbturfVbluf)o;

            boolfbn idEqubl =
                (id == null ? osv.gftId() == null : id.fqubls(osv.gftId()));

            //XXX dompbrf signbturf vblufs?
            rfturn idEqubl;
        }

        @Ovfrridf
        publid int hbshCodf() {
            int rfsult = 17;
            if (id != null) {
                rfsult = 31 * rfsult + id.hbshCodf();
            }

            rfturn rfsult;
        }

        publid void mbrshbl(Nodf pbrfnt, String dsPrffix,
                            DOMCryptoContfxt dontfxt)
            throws MbrshblExdfption
        {
            // drfbtf SignbturfVbluf flfmfnt
            sigVblufElfm = DOMUtils.drfbtfElfmfnt(ownfrDod, "SignbturfVbluf",
                                                  XMLSignbturf.XMLNS, dsPrffix);
            if (vblufBbsf64 != null) {
                sigVblufElfm.bppfndChild(ownfrDod.drfbtfTfxtNodf(vblufBbsf64));
            }

            // bppfnd Id bttributf, if spfdififd
            DOMUtils.sftAttributfID(sigVblufElfm, "Id", id);
            pbrfnt.bppfndChild(sigVblufElfm);
        }

        void sftVbluf(bytf[] vbluf) {
            this.vbluf = vbluf;
            vblufBbsf64 = Bbsf64.fndodf(vbluf);
            sigVblufElfm.bppfndChild(ownfrDod.drfbtfTfxtNodf(vblufBbsf64));
        }
    }
}
