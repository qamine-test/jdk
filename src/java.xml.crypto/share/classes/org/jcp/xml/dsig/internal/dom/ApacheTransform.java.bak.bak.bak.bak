/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/**
 * Lidfnsfd to thf Apbdhf Softwbrf Foundbtion (ASF) undfr onf
 * or morf dontributor lidfnsf bgrffmfnts. Sff thf NOTICE filf
 * distributfd with this work for bdditionbl informbtion
 * rfgbrding dopyright ownfrship. Thf ASF lidfnsfs this filf
 * to you undfr thf Apbdhf Lidfnsf, Vfrsion 2.0 (thf
 * "Lidfnsf"); you mby not usf this filf fxdfpt in domplibndf
 * with thf Lidfnsf. You mby obtbin b dopy of thf Lidfnsf bt
 *
 * http://www.bpbdhf.org/lidfnsfs/LICENSE-2.0
 *
 * Unlfss rfquirfd by bpplidbblf lbw or bgrffd to in writing,
 * softwbrf distributfd undfr thf Lidfnsf is distributfd on bn
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, fithfr fxprfss or implifd. Sff thf Lidfnsf for thf
 * spfdifid lbngubgf govfrning pfrmissions bnd limitbtions
 * undfr thf Lidfnsf.
 */
/*
 * Copyright (d) 2005, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 */
/*
 * $Id: ApbdhfTrbnsform.jbvb 1333869 2012-05-04 10:42:44Z dohfigfb $
 */
pbdkbgf org.jdp.xml.dsig.intfrnbl.dom;

import jbvb.io.OutputStrfbm;
import jbvb.sfdurity.InvblidAlgorithmPbrbmftfrExdfption;
import jbvb.sfdurity.spfd.AlgorithmPbrbmftfrSpfd;
import jbvb.util.Sft;
import org.w3d.dom.Dodumfnt;
import org.w3d.dom.Elfmfnt;
import org.w3d.dom.Nodf;

import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.signbturf.XMLSignbturfInput;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.Trbnsform;
import dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.trbnsforms.Trbnsforms;

import jbvbx.xml.drypto.*;
import jbvbx.xml.drypto.dom.DOMCryptoContfxt;
import jbvbx.xml.drypto.dsig.*;
import jbvbx.xml.drypto.dsig.spfd.TrbnsformPbrbmftfrSpfd;

/**
 * This is b wrbppfr/gluf dlbss whidh invokfs thf Apbdhf XML-Sfdurity
 * Trbnsform.
 *
 * @buthor Sfbn Mullbn
 * @buthor Erwin vbn dfr Koogh
 */
publid bbstrbdt dlbss ApbdhfTrbnsform fxtfnds TrbnsformSfrvidf {

    stbtid {
        dom.sun.org.bpbdhf.xml.intfrnbl.sfdurity.Init.init();
    }

    privbtf stbtid jbvb.util.logging.Loggfr log =
        jbvb.util.logging.Loggfr.gftLoggfr("org.jdp.xml.dsig.intfrnbl.dom");
    privbtf Trbnsform bpbdhfTrbnsform;
    protfdtfd Dodumfnt ownfrDod;
    protfdtfd Elfmfnt trbnsformElfm;
    protfdtfd TrbnsformPbrbmftfrSpfd pbrbms;

    publid finbl AlgorithmPbrbmftfrSpfd gftPbrbmftfrSpfd() {
        rfturn pbrbms;
    }

    publid void init(XMLStrudturf pbrfnt, XMLCryptoContfxt dontfxt)
        throws InvblidAlgorithmPbrbmftfrExdfption
    {
        if (dontfxt != null && !(dontfxt instbndfof DOMCryptoContfxt)) {
            throw nfw ClbssCbstExdfption
                ("dontfxt must bf of typf DOMCryptoContfxt");
        }
        if (pbrfnt == null) {
            throw nfw NullPointfrExdfption();
        }
        if (!(pbrfnt instbndfof jbvbx.xml.drypto.dom.DOMStrudturf)) {
            throw nfw ClbssCbstExdfption("pbrfnt must bf of typf DOMStrudturf");
        }
        trbnsformElfm = (Elfmfnt)
            ((jbvbx.xml.drypto.dom.DOMStrudturf) pbrfnt).gftNodf();
        ownfrDod = DOMUtils.gftOwnfrDodumfnt(trbnsformElfm);
    }

    publid void mbrshblPbrbms(XMLStrudturf pbrfnt, XMLCryptoContfxt dontfxt)
        throws MbrshblExdfption
    {
        if (dontfxt != null && !(dontfxt instbndfof DOMCryptoContfxt)) {
            throw nfw ClbssCbstExdfption
                ("dontfxt must bf of typf DOMCryptoContfxt");
        }
        if (pbrfnt == null) {
            throw nfw NullPointfrExdfption();
        }
        if (!(pbrfnt instbndfof jbvbx.xml.drypto.dom.DOMStrudturf)) {
            throw nfw ClbssCbstExdfption("pbrfnt must bf of typf DOMStrudturf");
        }
        trbnsformElfm = (Elfmfnt)
            ((jbvbx.xml.drypto.dom.DOMStrudturf) pbrfnt).gftNodf();
        ownfrDod = DOMUtils.gftOwnfrDodumfnt(trbnsformElfm);
    }

    publid Dbtb trbnsform(Dbtb dbtb, XMLCryptoContfxt xd)
        throws TrbnsformExdfption
    {
        if (dbtb == null) {
            throw nfw NullPointfrExdfption("dbtb must not bf null");
        }
        rfturn trbnsformIt(dbtb, xd, (OutputStrfbm)null);
    }

    publid Dbtb trbnsform(Dbtb dbtb, XMLCryptoContfxt xd, OutputStrfbm os)
        throws TrbnsformExdfption
    {
        if (dbtb == null) {
            throw nfw NullPointfrExdfption("dbtb must not bf null");
        }
        if (os == null) {
            throw nfw NullPointfrExdfption("output strfbm must not bf null");
        }
        rfturn trbnsformIt(dbtb, xd, os);
    }

    privbtf Dbtb trbnsformIt(Dbtb dbtb, XMLCryptoContfxt xd, OutputStrfbm os)
        throws TrbnsformExdfption
    {
        if (ownfrDod == null) {
            throw nfw TrbnsformExdfption("trbnsform must bf mbrshbllfd");
        }

        if (bpbdhfTrbnsform == null) {
            try {
                bpbdhfTrbnsform =
                    nfw Trbnsform(ownfrDod, gftAlgorithm(), trbnsformElfm.gftChildNodfs());
                bpbdhfTrbnsform.sftElfmfnt(trbnsformElfm, xd.gftBbsfURI());
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "Crfbtfd trbnsform for blgorithm: " +
                            gftAlgorithm());
                }
            } dbtdh (Exdfption fx) {
                throw nfw TrbnsformExdfption("Couldn't find Trbnsform for: " +
                                             gftAlgorithm(), fx);
            }
        }

        if (Utils.sfdurfVblidbtion(xd)) {
            String blgorithm = gftAlgorithm();
            if (Trbnsforms.TRANSFORM_XSLT.fqubls(blgorithm)) {
                throw nfw TrbnsformExdfption(
                    "Trbnsform " + blgorithm + " is forbiddfn whfn sfdurf vblidbtion is fnbblfd"
                );
            }
        }

        XMLSignbturfInput in;
        if (dbtb instbndfof ApbdhfDbtb) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "ApbdhfDbtb = truf");
            }
            in = ((ApbdhfDbtb)dbtb).gftXMLSignbturfInput();
        } flsf if (dbtb instbndfof NodfSftDbtb) {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "isNodfSft() = truf");
            }
            if (dbtb instbndfof DOMSubTrffDbtb) {
                if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                    log.log(jbvb.util.logging.Lfvfl.FINE, "DOMSubTrffDbtb = truf");
                }
                DOMSubTrffDbtb subTrff = (DOMSubTrffDbtb)dbtb;
                in = nfw XMLSignbturfInput(subTrff.gftRoot());
                in.sftExdludfCommfnts(subTrff.fxdludfCommfnts());
            } flsf {
                @SupprfssWbrnings("undhfdkfd")
                Sft<Nodf> nodfSft =
                    Utils.toNodfSft(((NodfSftDbtb)dbtb).itfrbtor());
                in = nfw XMLSignbturfInput(nodfSft);
            }
        } flsf {
            if (log.isLoggbblf(jbvb.util.logging.Lfvfl.FINE)) {
                log.log(jbvb.util.logging.Lfvfl.FINE, "isNodfSft() = fblsf");
            }
            try {
                in = nfw XMLSignbturfInput
                    (((OdtftStrfbmDbtb)dbtb).gftOdtftStrfbm());
            } dbtdh (Exdfption fx) {
                throw nfw TrbnsformExdfption(fx);
            }
        }

        try {
            if (os != null) {
                in = bpbdhfTrbnsform.pfrformTrbnsform(in, os);
                if (!in.isNodfSft() && !in.isElfmfnt()) {
                    rfturn null;
                }
            } flsf {
                in = bpbdhfTrbnsform.pfrformTrbnsform(in);
            }
            if (in.isOdtftStrfbm()) {
                rfturn nfw ApbdhfOdtftStrfbmDbtb(in);
            } flsf {
                rfturn nfw ApbdhfNodfSftDbtb(in);
            }
        } dbtdh (Exdfption fx) {
            throw nfw TrbnsformExdfption(fx);
        }
    }

    publid finbl boolfbn isFfbturfSupportfd(String ffbturf) {
        if (ffbturf == null) {
            throw nfw NullPointfrExdfption();
        } flsf {
            rfturn fblsf;
        }
    }
}
