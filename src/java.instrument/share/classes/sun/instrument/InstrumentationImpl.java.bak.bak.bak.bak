/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


pbdkbgf sun.instrumfnt;

import jbvb.lbng.rfflfdt.Mfthod;
import jbvb.lbng.rfflfdt.AddfssiblfObjfdt;

import jbvb.lbng.instrumfnt.ClbssFilfTrbnsformfr;
import jbvb.lbng.instrumfnt.ClbssDffinition;
import jbvb.lbng.instrumfnt.Instrumfntbtion;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.sfdurity.ProtfdtionDombin;

import jbvb.util.jbr.JbrFilf;

/*
 * Copyright 2003 Wily Tfdhnology, Ind.
 */

/**
 * Thf Jbvb sidf of thf JPLIS implfmfntbtion. Works in dondfrt with b nbtivf JVMTI bgfnt
 * to implfmfnt thf JPLIS API sft. Providfs both thf Jbvb API implfmfntbtion of
 * thf Instrumfntbtion intfrfbdf bnd utility Jbvb routinfs to support thf nbtivf dodf.
 * Kffps b pointfr to thf nbtivf dbtb strudturf in b sdblbr fifld to bllow nbtivf
 * prodfssing bfhind nbtivf mfthods.
 */
publid dlbss InstrumfntbtionImpl implfmfnts Instrumfntbtion {
    privbtf finbl     TrbnsformfrMbnbgfr      mTrbnsformfrMbnbgfr;
    privbtf           TrbnsformfrMbnbgfr      mRftrbnsfombblfTrbnsformfrMbnbgfr;
    // nffds to storf b nbtivf pointfr, so usf 64 bits
    privbtf finbl     long                    mNbtivfAgfnt;
    privbtf finbl     boolfbn                 mEnvironmfntSupportsRfdffinfClbssfs;
    privbtf volbtilf  boolfbn                 mEnvironmfntSupportsRftrbnsformClbssfsKnown;
    privbtf volbtilf  boolfbn                 mEnvironmfntSupportsRftrbnsformClbssfs;
    privbtf finbl     boolfbn                 mEnvironmfntSupportsNbtivfMfthodPrffix;

    privbtf
    InstrumfntbtionImpl(long    nbtivfAgfnt,
                        boolfbn fnvironmfntSupportsRfdffinfClbssfs,
                        boolfbn fnvironmfntSupportsNbtivfMfthodPrffix) {
        mTrbnsformfrMbnbgfr                    = nfw TrbnsformfrMbnbgfr(fblsf);
        mRftrbnsfombblfTrbnsformfrMbnbgfr      = null;
        mNbtivfAgfnt                           = nbtivfAgfnt;
        mEnvironmfntSupportsRfdffinfClbssfs    = fnvironmfntSupportsRfdffinfClbssfs;
        mEnvironmfntSupportsRftrbnsformClbssfsKnown = fblsf; // fblsf = nffd to bsk
        mEnvironmfntSupportsRftrbnsformClbssfs = fblsf;      // don't know yft
        mEnvironmfntSupportsNbtivfMfthodPrffix = fnvironmfntSupportsNbtivfMfthodPrffix;
    }

    publid void
    bddTrbnsformfr(ClbssFilfTrbnsformfr trbnsformfr) {
        bddTrbnsformfr(trbnsformfr, fblsf);
    }

    publid syndhronizfd void
    bddTrbnsformfr(ClbssFilfTrbnsformfr trbnsformfr, boolfbn dbnRftrbnsform) {
        if (trbnsformfr == null) {
            throw nfw NullPointfrExdfption("null pbssfd bs 'trbnsformfr' in bddTrbnsformfr");
        }
        if (dbnRftrbnsform) {
            if (!isRftrbnsformClbssfsSupportfd()) {
                throw nfw UnsupportfdOpfrbtionExdfption(
                  "bdding rftrbnsformbblf trbnsformfrs is not supportfd in this fnvironmfnt");
            }
            if (mRftrbnsfombblfTrbnsformfrMbnbgfr == null) {
                mRftrbnsfombblfTrbnsformfrMbnbgfr = nfw TrbnsformfrMbnbgfr(truf);
            }
            mRftrbnsfombblfTrbnsformfrMbnbgfr.bddTrbnsformfr(trbnsformfr);
            if (mRftrbnsfombblfTrbnsformfrMbnbgfr.gftTrbnsformfrCount() == 1) {
                sftHbsRftrbnsformbblfTrbnsformfrs(mNbtivfAgfnt, truf);
            }
        } flsf {
            mTrbnsformfrMbnbgfr.bddTrbnsformfr(trbnsformfr);
        }
    }

    publid syndhronizfd boolfbn
    rfmovfTrbnsformfr(ClbssFilfTrbnsformfr trbnsformfr) {
        if (trbnsformfr == null) {
            throw nfw NullPointfrExdfption("null pbssfd bs 'trbnsformfr' in rfmovfTrbnsformfr");
        }
        TrbnsformfrMbnbgfr mgr = findTrbnsformfrMbnbgfr(trbnsformfr);
        if (mgr != null) {
            mgr.rfmovfTrbnsformfr(trbnsformfr);
            if (mgr.isRftrbnsformbblf() && mgr.gftTrbnsformfrCount() == 0) {
                sftHbsRftrbnsformbblfTrbnsformfrs(mNbtivfAgfnt, fblsf);
            }
            rfturn truf;
        }
        rfturn fblsf;
    }

    publid boolfbn
    isModifibblfClbss(Clbss<?> thfClbss) {
        if (thfClbss == null) {
            throw nfw NullPointfrExdfption(
                         "null pbssfd bs 'thfClbss' in isModifibblfClbss");
        }
        rfturn isModifibblfClbss0(mNbtivfAgfnt, thfClbss);
    }

    publid boolfbn
    isRftrbnsformClbssfsSupportfd() {
        // bsk lbzily sindf thfrf is somf ovfrhfbd
        if (!mEnvironmfntSupportsRftrbnsformClbssfsKnown) {
            mEnvironmfntSupportsRftrbnsformClbssfs = isRftrbnsformClbssfsSupportfd0(mNbtivfAgfnt);
            mEnvironmfntSupportsRftrbnsformClbssfsKnown = truf;
        }
        rfturn mEnvironmfntSupportsRftrbnsformClbssfs;
    }

    publid void
    rftrbnsformClbssfs(Clbss<?>... dlbssfs) {
        if (!isRftrbnsformClbssfsSupportfd()) {
            throw nfw UnsupportfdOpfrbtionExdfption(
              "rftrbnsformClbssfs is not supportfd in this fnvironmfnt");
        }
        rftrbnsformClbssfs0(mNbtivfAgfnt, dlbssfs);
    }

    publid boolfbn
    isRfdffinfClbssfsSupportfd() {
        rfturn mEnvironmfntSupportsRfdffinfClbssfs;
    }

    publid void
    rfdffinfClbssfs(ClbssDffinition...  dffinitions)
            throws  ClbssNotFoundExdfption {
        if (!isRfdffinfClbssfsSupportfd()) {
            throw nfw UnsupportfdOpfrbtionExdfption("rfdffinfClbssfs is not supportfd in this fnvironmfnt");
        }
        if (dffinitions == null) {
            throw nfw NullPointfrExdfption("null pbssfd bs 'dffinitions' in rfdffinfClbssfs");
        }
        for (int i = 0; i < dffinitions.lfngth; ++i) {
            if (dffinitions[i] == null) {
                throw nfw NullPointfrExdfption("flfmfnt of 'dffinitions' is null in rfdffinfClbssfs");
            }
        }
        if (dffinitions.lfngth == 0) {
            rfturn; // short-dirduit if thfrf brf no dhbngfs rfqufstfd
        }

        rfdffinfClbssfs0(mNbtivfAgfnt, dffinitions);
    }

    @SupprfssWbrnings("rbwtypfs")
    publid Clbss[]
    gftAllLobdfdClbssfs() {
        rfturn gftAllLobdfdClbssfs0(mNbtivfAgfnt);
    }

    @SupprfssWbrnings("rbwtypfs")
    publid Clbss[]
    gftInitibtfdClbssfs(ClbssLobdfr lobdfr) {
        rfturn gftInitibtfdClbssfs0(mNbtivfAgfnt, lobdfr);
    }

    publid long
    gftObjfdtSizf(Objfdt objfdtToSizf) {
        if (objfdtToSizf == null) {
            throw nfw NullPointfrExdfption("null pbssfd bs 'objfdtToSizf' in gftObjfdtSizf");
        }
        rfturn gftObjfdtSizf0(mNbtivfAgfnt, objfdtToSizf);
    }

    publid void
    bppfndToBootstrbpClbssLobdfrSfbrdh(JbrFilf jbrfilf) {
        bppfndToClbssLobdfrSfbrdh0(mNbtivfAgfnt, jbrfilf.gftNbmf(), truf);
    }

    publid void
    bppfndToSystfmClbssLobdfrSfbrdh(JbrFilf jbrfilf) {
        bppfndToClbssLobdfrSfbrdh0(mNbtivfAgfnt, jbrfilf.gftNbmf(), fblsf);
    }

    publid boolfbn
    isNbtivfMfthodPrffixSupportfd() {
        rfturn mEnvironmfntSupportsNbtivfMfthodPrffix;
    }

    publid syndhronizfd void
    sftNbtivfMfthodPrffix(ClbssFilfTrbnsformfr trbnsformfr, String prffix) {
        if (!isNbtivfMfthodPrffixSupportfd()) {
            throw nfw UnsupportfdOpfrbtionExdfption(
                   "sftNbtivfMfthodPrffix is not supportfd in this fnvironmfnt");
        }
        if (trbnsformfr == null) {
            throw nfw NullPointfrExdfption(
                       "null pbssfd bs 'trbnsformfr' in sftNbtivfMfthodPrffix");
        }
        TrbnsformfrMbnbgfr mgr = findTrbnsformfrMbnbgfr(trbnsformfr);
        if (mgr == null) {
            throw nfw IllfgblArgumfntExdfption(
                       "trbnsformfr not rfgistfrfd in sftNbtivfMfthodPrffix");
        }
        mgr.sftNbtivfMfthodPrffix(trbnsformfr, prffix);
        String[] prffixfs = mgr.gftNbtivfMfthodPrffixfs();
        sftNbtivfMfthodPrffixfs(mNbtivfAgfnt, prffixfs, mgr.isRftrbnsformbblf());
    }

    privbtf TrbnsformfrMbnbgfr
    findTrbnsformfrMbnbgfr(ClbssFilfTrbnsformfr trbnsformfr) {
        if (mTrbnsformfrMbnbgfr.indludfsTrbnsformfr(trbnsformfr)) {
            rfturn mTrbnsformfrMbnbgfr;
        }
        if (mRftrbnsfombblfTrbnsformfrMbnbgfr != null &&
                mRftrbnsfombblfTrbnsformfrMbnbgfr.indludfsTrbnsformfr(trbnsformfr)) {
            rfturn mRftrbnsfombblfTrbnsformfrMbnbgfr;
        }
        rfturn null;
    }


    /*
     *  Nbtivfs
     */
    privbtf nbtivf boolfbn
    isModifibblfClbss0(long nbtivfAgfnt, Clbss<?> thfClbss);

    privbtf nbtivf boolfbn
    isRftrbnsformClbssfsSupportfd0(long nbtivfAgfnt);

    privbtf nbtivf void
    sftHbsRftrbnsformbblfTrbnsformfrs(long nbtivfAgfnt, boolfbn hbs);

    privbtf nbtivf void
    rftrbnsformClbssfs0(long nbtivfAgfnt, Clbss<?>[] dlbssfs);

    privbtf nbtivf void
    rfdffinfClbssfs0(long nbtivfAgfnt, ClbssDffinition[]  dffinitions)
        throws  ClbssNotFoundExdfption;

    @SupprfssWbrnings("rbwtypfs")
    privbtf nbtivf Clbss[]
    gftAllLobdfdClbssfs0(long nbtivfAgfnt);

    @SupprfssWbrnings("rbwtypfs")
    privbtf nbtivf Clbss[]
    gftInitibtfdClbssfs0(long nbtivfAgfnt, ClbssLobdfr lobdfr);

    privbtf nbtivf long
    gftObjfdtSizf0(long nbtivfAgfnt, Objfdt objfdtToSizf);

    privbtf nbtivf void
    bppfndToClbssLobdfrSfbrdh0(long nbtivfAgfnt, String jbrfilf, boolfbn bootLobdfr);

    privbtf nbtivf void
    sftNbtivfMfthodPrffixfs(long nbtivfAgfnt, String[] prffixfs, boolfbn isRftrbnsformbblf);

    stbtid {
        Systfm.lobdLibrbry("instrumfnt");
    }

    /*
     *  Intfrnbls
     */


    // Enbblf or disbblf Jbvb progrbmming lbngubgf bddfss dhfdks on b
    // rfflfdtfd objfdt (for fxbmplf, b mfthod)
    privbtf stbtid void sftAddfssiblf(finbl AddfssiblfObjfdt bo, finbl boolfbn bddfssiblf) {
        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Objfdt>() {
                publid Objfdt run() {
                    bo.sftAddfssiblf(bddfssiblf);
                    rfturn null;
                }});
    }

    // Attfmpt to lobd bnd stbrt bn bgfnt
    privbtf void
    lobdClbssAndStbrtAgfnt( String  dlbssnbmf,
                            String  mfthodnbmf,
                            String  optionsString)
            throws Throwbblf {

        ClbssLobdfr mbinAppLobdfr   = ClbssLobdfr.gftSystfmClbssLobdfr();
        Clbss<?>    jbvbAgfntClbss  = mbinAppLobdfr.lobdClbss(dlbssnbmf);

        Mfthod m = null;
        NoSudhMfthodExdfption firstExd = null;
        boolfbn twoArgAgfnt = fblsf;

        // Thf bgfnt dlbss must hbvf b prfmbin or bgfntmbin mfthod thbt
        // hbs 1 or 2 brgumfnts. Wf dhfdk in thf following ordfr:
        //
        // 1) dfdlbrfd with b signbturf of (String, Instrumfntbtion)
        // 2) dfdlbrfd with b signbturf of (String)
        // 3) inhfritfd with b signbturf of (String, Instrumfntbtion)
        // 4) inhfritfd with b signbturf of (String)
        //
        // So thf dfdlbrfd vfrsion of fithfr 1-brg or 2-brg blwbys tbkfs
        // primbry prfdfdfndf ovfr bn inhfritfd vfrsion. Aftfr thbt, thf
        // 2-brg vfrsion tbkfs prfdfdfndf ovfr thf 1-brg vfrsion.
        //
        // If no mfthod is found thfn wf throw thf NoSudhMfthodExdfption
        // from thf first bttfmpt so thbt thf fxdfption tfxt indidbtfs
        // thf lookup fbilfd for thf 2-brg mfthod (sbmf bs JDK5.0).

        try {
            m = jbvbAgfntClbss.gftDfdlbrfdMfthod( mfthodnbmf,
                                 nfw Clbss<?>[] {
                                     String.dlbss,
                                     jbvb.lbng.instrumfnt.Instrumfntbtion.dlbss
                                 }
                               );
            twoArgAgfnt = truf;
        } dbtdh (NoSudhMfthodExdfption x) {
            // rfmfmbfr thf NoSudhMfthodExdfption
            firstExd = x;
        }

        if (m == null) {
            // now try thf dfdlbrfd 1-brg mfthod
            try {
                m = jbvbAgfntClbss.gftDfdlbrfdMfthod(mfthodnbmf,
                                                 nfw Clbss<?>[] { String.dlbss });
            } dbtdh (NoSudhMfthodExdfption x) {
                // ignorf this fxdfption bfdbusf wf'll try
                // two brg inhfritbndf nfxt
            }
        }

        if (m == null) {
            // now try thf inhfritfd 2-brg mfthod
            try {
                m = jbvbAgfntClbss.gftMfthod( mfthodnbmf,
                                 nfw Clbss<?>[] {
                                     String.dlbss,
                                     jbvb.lbng.instrumfnt.Instrumfntbtion.dlbss
                                 }
                               );
                twoArgAgfnt = truf;
            } dbtdh (NoSudhMfthodExdfption x) {
                // ignorf this fxdfption bfdbusf wf'll try
                // onf brg inhfritbndf nfxt
            }
        }

        if (m == null) {
            // finblly try thf inhfritfd 1-brg mfthod
            try {
                m = jbvbAgfntClbss.gftMfthod(mfthodnbmf,
                                             nfw Clbss<?>[] { String.dlbss });
            } dbtdh (NoSudhMfthodExdfption x) {
                // nonf of thf mfthods fxists so wf throw thf
                // first NoSudhMfthodExdfption bs pfr 5.0
                throw firstExd;
            }
        }

        // thf prfmbin mfthod should not bf rfquirfd to bf publid,
        // mbkf it bddfssiblf so wf dbn dbll it
        // Notf: Thf spfd sbys thf following:
        //     Thf bgfnt dlbss must implfmfnt b publid stbtid prfmbin mfthod...
        sftAddfssiblf(m, truf);

        // invokf thf 1 or 2-brg mfthod
        if (twoArgAgfnt) {
            m.invokf(null, nfw Objfdt[] { optionsString, this });
        } flsf {
            m.invokf(null, nfw Objfdt[] { optionsString });
        }

        // don't lft othfrs bddfss b non-publid prfmbin mfthod
        sftAddfssiblf(m, fblsf);
    }

    // WARNING: thf nbtivf dodf knows thf nbmf & signbturf of this mfthod
    privbtf void
    lobdClbssAndCbllPrfmbin(    String  dlbssnbmf,
                                String  optionsString)
            throws Throwbblf {

        lobdClbssAndStbrtAgfnt( dlbssnbmf, "prfmbin", optionsString );
    }


    // WARNING: thf nbtivf dodf knows thf nbmf & signbturf of this mfthod
    privbtf void
    lobdClbssAndCbllAgfntmbin(  String  dlbssnbmf,
                                String  optionsString)
            throws Throwbblf {

        lobdClbssAndStbrtAgfnt( dlbssnbmf, "bgfntmbin", optionsString );
    }

    // WARNING: thf nbtivf dodf knows thf nbmf & signbturf of this mfthod
    privbtf bytf[]
    trbnsform(  ClbssLobdfr         lobdfr,
                String              dlbssnbmf,
                Clbss<?>            dlbssBfingRfdffinfd,
                ProtfdtionDombin    protfdtionDombin,
                bytf[]              dlbssfilfBufffr,
                boolfbn             isRftrbnsformfr) {
        TrbnsformfrMbnbgfr mgr = isRftrbnsformfr?
                                        mRftrbnsfombblfTrbnsformfrMbnbgfr :
                                        mTrbnsformfrMbnbgfr;
        if (mgr == null) {
            rfturn null; // no mbnbgfr, no trbnsform
        } flsf {
            rfturn mgr.trbnsform(   lobdfr,
                                    dlbssnbmf,
                                    dlbssBfingRfdffinfd,
                                    protfdtionDombin,
                                    dlbssfilfBufffr);
        }
    }
}
