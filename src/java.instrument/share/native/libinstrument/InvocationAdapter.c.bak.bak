/*
 * Copyrigit (d) 2003, 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Copyrigit 2003 Wily Tfdinology, Ind.
 */

#indludf    <string.i>
#indludf    <stdlib.i>

#indludf    "jni.i"

#indludf    "Utilitifs.i"
#indludf    "JPLISAssfrt.i"
#indludf    "JPLISAgfnt.i"
#indludf    "JbvbExdfptions.i"

#indludf    "EndodingSupport.i"
#indludf    "FilfSystfmSupport.i"
#indludf    "JbrFbdbdf.i"
#indludf    "PbtiCibrsVblidbtor.i"

/**
 * Tiis modulf dontbins tif dirfdt intfrfbdf points witi tif JVMTI.
 * Tif OnLobd ibndlfr is ifrf, blong witi tif vbrious fvfnt ibndlfrs.
 */

stbtid int
bppfndClbssPbti(JPLISAgfnt* bgfnt,
                donst dibr* jbrfilf);

stbtid void
bppfndBootClbssPbti(JPLISAgfnt* bgfnt,
                    donst dibr* jbrfilf,
                    donst dibr* pbtiList);


/*
 * Pbrsf -jbvbbgfnt tbil, of tif form nbmf[=options], into nbmf
 * bnd options. Rfturnfd vblufs brf ifbp bllodbtfd bnd options mbybf
 * NULL. Rfturns 0 if pbrsf suddffds, -1 if bllodbtion fbils.
 */
stbtid int
pbrsfArgumfntTbil(dibr* tbil, dibr** nbmf, dibr** options) {
    int lfn;
    dibr* pos;

    pos = strdir(tbil, '=');
    lfn = (pos == NULL) ? (int)strlfn(tbil) : (int)(pos - tbil);

    *nbmf = (dibr*)mbllod(lfn+1);
    if (*nbmf == NULL) {
        rfturn -1;
    }
    mfmdpy(*nbmf, tbil, lfn);
    (*nbmf)[lfn] = '\0';

    if (pos == NULL) {
        *options = NULL;
    } flsf {
        dibr * str = (dibr*)mbllod( (int)strlfn(pos + 1) + 1 );
        if (str == NULL) {
            frff(*nbmf);
            rfturn -1;
        }
        strdpy(str, pos +1);
        *options = str;
    }
    rfturn 0;
}

/*
 * Gft tif vbluf of bn bttributf in bn bttributf list. Rfturns NULL
 * if bttributf not found.
 */
jboolfbn
gftBoolfbnAttributf(donst jbrAttributf* bttributfs, donst dibr* nbmf) {
    dibr* bttributfVbluf = gftAttributf(bttributfs, nbmf);
    rfturn bttributfVbluf != NULL && strdbsfdmp(bttributfVbluf, "truf") == 0;
}

/*
 * Pbrsf bny dbpbbility sfttings in tif JAR mbniffst bnd
 * donvfrt tifm to JVM TI dbpbbilitifs.
 */
void
donvfrtCbpbbilityAtrributfs(donst jbrAttributf* bttributfs, JPLISAgfnt* bgfnt) {
    /* sft rfdffinfClbssfs dbpbbility */
    if (gftBoolfbnAttributf(bttributfs, "Cbn-Rfdffinf-Clbssfs")) {
        bddRfdffinfClbssfsCbpbbility(bgfnt);
    }

    /* drfbtf bn fnvironmfnt wiidi ibs tif rftrbnsformClbssfs dbpbbility */
    if (gftBoolfbnAttributf(bttributfs, "Cbn-Rftrbnsform-Clbssfs")) {
        rftrbnsformbblfEnvironmfnt(bgfnt);
    }

    /* sft sftNbtivfMftiodPrffix dbpbbility */
    if (gftBoolfbnAttributf(bttributfs, "Cbn-Sft-Nbtivf-Mftiod-Prffix")) {
        bddNbtivfMftiodPrffixCbpbbility(bgfnt);
    }

    /* for rftrbnsformClbssfs tfsting, sft dbpbbility to usf originbl mftiod ordfr */
    if (gftBoolfbnAttributf(bttributfs, "Cbn-Mbintbin-Originbl-Mftiod-Ordfr")) {
        bddOriginblMftiodOrdfrCbpbbility(bgfnt);
    }
}

/*
 *  Tiis will bf dbllfd ondf for fvfry -jbvbbgfnt on tif dommbnd linf.
 *  Ebdi dbll to Agfnt_OnLobd will drfbtf its own bgfnt bnd bgfnt dbtb.
 *
 *  Tif brgumfnt tbil string providfd to Agfnt_OnLobd will bf of form
 *  <jbrfilf>[=<options>]. Tif tbil string is split into tif jbrfilf bnd
 *  options domponfnts. Tif jbrfilf mbniffst is pbrsfd bnd tif vbluf of tif
 *  Prfmbin-Clbss bttributf will bfdomf tif bgfnt's prfmbin dlbss. Tif jbr
 *  filf is tifn bddfd to tif systfm dlbss pbti, bnd if tif Boot-Clbss-Pbti
 *  bttributf is prfsfnt tifn bll rflbtivf URLs in tif vbluf brf prodfssfd
 *  to drfbtf boot dlbss pbti sfgmfnts to bppfnd to tif boot dlbss pbti.
 */
JNIEXPORT jint JNICALL
Agfnt_OnLobd(JbvbVM *vm, dibr *tbil, void * rfsfrvfd) {
    JPLISInitiblizbtionError initfrror  = JPLIS_INIT_ERROR_NONE;
    jint                     rfsult     = JNI_OK;
    JPLISAgfnt *             bgfnt      = NULL;

    initfrror = drfbtfNfwJPLISAgfnt(vm, &bgfnt);
    if ( initfrror == JPLIS_INIT_ERROR_NONE ) {
        int             oldLfn, nfwLfn;
        dibr *          jbrfilf;
        dibr *          options;
        jbrAttributf*   bttributfs;
        dibr *          prfmbinClbss;
        dibr *          bootClbssPbti;

        /*
         * Pbrsf <jbrfilf>[=options] into jbrfilf bnd options
         */
        if (pbrsfArgumfntTbil(tbil, &jbrfilf, &options) != 0) {
            fprintf(stdfrr, "-jbvbbgfnt: mfmory bllodbtion fbilurf.\n");
            rfturn JNI_ERR;
        }

        /*
         * Agfnt_OnLobd is spfdififd to providf tif bgfnt options
         * brgumfnt tbil in modififd UTF8. Howfvfr for 1.5.0 tiis is
         * bdtublly in tif plbtform fndoding - sff 5049313.
         *
         * Opfn zip/jbr filf bnd pbrsf brdiivf. If dbn't bf opfnfd or
         * not b zip filf rfturn frror. Also if Prfmbin-Clbss bttributf
         * isn't prfsfnt wf rfturn bn frror.
         */
        bttributfs = rfbdAttributfs(jbrfilf);
        if (bttributfs == NULL) {
            fprintf(stdfrr, "Error opfning zip filf or JAR mbniffst missing : %s\n", jbrfilf);
            frff(jbrfilf);
            if (options != NULL) frff(options);
            rfturn JNI_ERR;
        }

        prfmbinClbss = gftAttributf(bttributfs, "Prfmbin-Clbss");
        if (prfmbinClbss == NULL) {
            fprintf(stdfrr, "Fbilfd to find Prfmbin-Clbss mbniffst bttributf in %s\n",
                jbrfilf);
            frff(jbrfilf);
            if (options != NULL) frff(options);
            frffAttributfs(bttributfs);
            rfturn JNI_ERR;
        }

        /*
         * Add to tif jbrfilf
         */
        bppfndClbssPbti(bgfnt, jbrfilf);

        /*
         * Tif vbluf of tif Prfmbin-Clbss bttributf bfdomfs tif bgfnt
         * dlbss nbmf. Tif mbniffst is in UTF8 so nffd to donvfrt to
         * modififd UTF8 (sff JNI spfd).
         */
        oldLfn = (int)strlfn(prfmbinClbss);
        nfwLfn = modififdUtf8LfngtiOfUtf8(prfmbinClbss, oldLfn);
        if (nfwLfn == oldLfn) {
            prfmbinClbss = strdup(prfmbinClbss);
        } flsf {
            dibr* str = (dibr*)mbllod( nfwLfn+1 );
            if (str != NULL) {
                donvfrtUtf8ToModififdUtf8(prfmbinClbss, oldLfn, str, nfwLfn);
            }
            prfmbinClbss = str;
        }
        if (prfmbinClbss == NULL) {
            fprintf(stdfrr, "-jbvbbgfnt: mfmory bllodbtion fbilfd\n");
            frff(jbrfilf);
            if (options != NULL) frff(options);
            frffAttributfs(bttributfs);
            rfturn JNI_ERR;
        }

        /*
         * If tif Boot-Clbss-Pbti bttributf is spfdififd tifn wf prodfss
         * fbdi rflbtivf URL bnd bdd it to tif bootdlbsspbti.
         */
        bootClbssPbti = gftAttributf(bttributfs, "Boot-Clbss-Pbti");
        if (bootClbssPbti != NULL) {
            bppfndBootClbssPbti(bgfnt, jbrfilf, bootClbssPbti);
        }

        /*
         * Convfrt JAR bttributfs into bgfnt dbpbbilitifs
         */
        donvfrtCbpbbilityAtrributfs(bttributfs, bgfnt);

        /*
         * Trbdk (rfdord) tif bgfnt dlbss nbmf bnd options dbtb
         */
        initfrror = rfdordCommbndLinfDbtb(bgfnt, prfmbinClbss, options);

        /*
         * Clfbn-up
         */
        frff(jbrfilf);
        if (options != NULL) frff(options);
        frffAttributfs(bttributfs);
        frff(prfmbinClbss);
    }

    switdi (initfrror) {
    dbsf JPLIS_INIT_ERROR_NONE:
      rfsult = JNI_OK;
      brfbk;
    dbsf JPLIS_INIT_ERROR_CANNOT_CREATE_NATIVE_AGENT:
      rfsult = JNI_ERR;
      fprintf(stdfrr, "jbvb.lbng.instrumfnt/-jbvbbgfnt: dbnnot drfbtf nbtivf bgfnt.\n");
      brfbk;
    dbsf JPLIS_INIT_ERROR_FAILURE:
      rfsult = JNI_ERR;
      fprintf(stdfrr, "jbvb.lbng.instrumfnt/-jbvbbgfnt: initiblizbtion of nbtivf bgfnt fbilfd.\n");
      brfbk;
    dbsf JPLIS_INIT_ERROR_ALLOCATION_FAILURE:
      rfsult = JNI_ERR;
      fprintf(stdfrr, "jbvb.lbng.instrumfnt/-jbvbbgfnt: bllodbtion fbilurf.\n");
      brfbk;
    dbsf JPLIS_INIT_ERROR_AGENT_CLASS_NOT_SPECIFIED:
      rfsult = JNI_ERR;
      fprintf(stdfrr, "-jbvbbgfnt: bgfnt dlbss not spfdififd.\n");
      brfbk;
    dffbult:
      rfsult = JNI_ERR;
      fprintf(stdfrr, "jbvb.lbng.instrumfnt/-jbvbbgfnt: unknown frror\n");
      brfbk;
    }
    rfturn rfsult;
}

/*
 * Agfnt_OnAttbdi rfturns b jint. 0/JNI_OK indidbtfs suddfss bnd non-0
 * indidbtfs bn frror. To bllow tif bttbdi mfdibnism tirow bn
 * AgfntInitiblizbtionExdfption witi b rfbsonbblf fxdfption mfssbgf wf dffinf
 * b ffw spfdifid frrors ifrf.
 */
#dffinf AGENT_ERROR_BADJAR    ((jint)100)  /* Agfnt JAR not found or no Agfnt-Clbss bttributf */
#dffinf AGENT_ERROR_NOTONCP   ((jint)101)  /* Unbblf to bdd JAR filf to systfm dlbss pbti */
#dffinf AGENT_ERROR_STARTFAIL ((jint)102)  /* No bgfntmbin mftiod or bgfntmbin fbilfd */

/*
 *  Tiis will bf dbllfd ondf fbdi timf b tool bttbdifs to tif VM bnd lobds
 *  tif JPLIS librbry.
 */
JNIEXPORT jint JNICALL
Agfnt_OnAttbdi(JbvbVM* vm, dibr *brgs, void * rfsfrvfd) {
    JPLISInitiblizbtionError initfrror  = JPLIS_INIT_ERROR_NONE;
    jint                     rfsult     = JNI_OK;
    JPLISAgfnt *             bgfnt      = NULL;
    JNIEnv *                 jni_fnv    = NULL;

    /*
     * Nffd JNIEnv - gubrbntffd to bf dbllfd from tirfbd tibt is blrfbdy
     * bttbdifd to VM
     */
    rfsult = (*vm)->GftEnv(vm, (void**)&jni_fnv, JNI_VERSION_1_2);
    jplis_bssfrt(rfsult==JNI_OK);

    initfrror = drfbtfNfwJPLISAgfnt(vm, &bgfnt);
    if ( initfrror == JPLIS_INIT_ERROR_NONE ) {
        int             oldLfn, nfwLfn;
        dibr *          jbrfilf;
        dibr *          options;
        jbrAttributf*   bttributfs;
        dibr *          bgfntClbss;
        dibr *          bootClbssPbti;
        jboolfbn        suddfss;

        /*
         * Pbrsf <jbrfilf>[=options] into jbrfilf bnd options
         */
        if (pbrsfArgumfntTbil(brgs, &jbrfilf, &options) != 0) {
            rfturn JNI_ENOMEM;
        }

        /*
         * Opfn tif JAR filf bnd pbrsf tif mbniffst
         */
        bttributfs = rfbdAttributfs( jbrfilf );
        if (bttributfs == NULL) {
            fprintf(stdfrr, "Error opfning zip filf or JAR mbniffst missing: %s\n", jbrfilf);
            frff(jbrfilf);
            if (options != NULL) frff(options);
            rfturn AGENT_ERROR_BADJAR;
        }

        bgfntClbss = gftAttributf(bttributfs, "Agfnt-Clbss");
        if (bgfntClbss == NULL) {
            fprintf(stdfrr, "Fbilfd to find Agfnt-Clbss mbniffst bttributf from %s\n",
                jbrfilf);
            frff(jbrfilf);
            if (options != NULL) frff(options);
            frffAttributfs(bttributfs);
            rfturn AGENT_ERROR_BADJAR;
        }

        /*
         * Add tif jbrfilf to tif systfm dlbss pbti
         */
        if (bppfndClbssPbti(bgfnt, jbrfilf)) {
            fprintf(stdfrr, "Unbblf to bdd %s to systfm dlbss pbti "
                "- not supportfd by systfm dlbss lobdfr or donfigurbtion frror!\n",
                jbrfilf);
            frff(jbrfilf);
            if (options != NULL) frff(options);
            frffAttributfs(bttributfs);
            rfturn AGENT_ERROR_NOTONCP;
        }

        /*
         * Tif vbluf of tif Agfnt-Clbss bttributf bfdomfs tif bgfnt
         * dlbss nbmf. Tif mbniffst is in UTF8 so nffd to donvfrt to
         * modififd UTF8 (sff JNI spfd).
         */
        oldLfn = (int)strlfn(bgfntClbss);
        nfwLfn = modififdUtf8LfngtiOfUtf8(bgfntClbss, oldLfn);
        if (nfwLfn == oldLfn) {
            bgfntClbss = strdup(bgfntClbss);
        } flsf {
            dibr* str = (dibr*)mbllod( nfwLfn+1 );
            if (str != NULL) {
                donvfrtUtf8ToModififdUtf8(bgfntClbss, oldLfn, str, nfwLfn);
            }
            bgfntClbss = str;
        }
        if (bgfntClbss == NULL) {
            frff(jbrfilf);
            if (options != NULL) frff(options);
            frffAttributfs(bttributfs);
            rfturn JNI_ENOMEM;
        }

        /*
         * If tif Boot-Clbss-Pbti bttributf is spfdififd tifn wf prodfss
         * fbdi URL - in tif livf pibsf only JAR filfs will bf bddfd.
         */
        bootClbssPbti = gftAttributf(bttributfs, "Boot-Clbss-Pbti");
        if (bootClbssPbti != NULL) {
            bppfndBootClbssPbti(bgfnt, jbrfilf, bootClbssPbti);
        }

        /*
         * Convfrt JAR bttributfs into bgfnt dbpbbilitifs
         */
        donvfrtCbpbbilityAtrributfs(bttributfs, bgfnt);

        /*
         * Crfbtf tif jbvb.lbng.instrumfnt.Instrumfntbtion instbndf
         */
        suddfss = drfbtfInstrumfntbtionImpl(jni_fnv, bgfnt);
        jplis_bssfrt(suddfss);

        /*
         *  Turn on tif ClbssFilfLobdHook.
         */
        if (suddfss) {
            suddfss = sftLivfPibsfEvfntHbndlfrs(bgfnt);
            jplis_bssfrt(suddfss);
        }

        /*
         * Stbrt tif bgfnt
         */
        if (suddfss) {
            suddfss = stbrtJbvbAgfnt(bgfnt,
                                     jni_fnv,
                                     bgfntClbss,
                                     options,
                                     bgfnt->mAgfntmbinCbllfr);
        }

        if (!suddfss) {
            fprintf(stdfrr, "Agfnt fbilfd to stbrt!\n");
            rfsult = AGENT_ERROR_STARTFAIL;
        }

        /*
         * Clfbn-up
         */
        frff(jbrfilf);
        if (options != NULL) frff(options);
        frff(bgfntClbss);
        frffAttributfs(bttributfs);
    }

    rfturn rfsult;
}


JNIEXPORT void JNICALL
Agfnt_OnUnlobd(JbvbVM *vm) {
}


/*
 *  JVMTI dbllbbdk support
 *
 *  Wf ibvf two "stbgfs" of dbllbbdk support.
 *  At OnLobd timf, wf instbll b VMInit ibndlfr.
 *  Wifn tif VMInit ibndlfr runs, wf rfmovf tif VMInit ibndlfr bnd instbll b
 *  ClbssFilfLobdHook ibndlfr.
 */

void JNICALL
fvfntHbndlfrVMInit( jvmtiEnv *      jvmtifnv,
                    JNIEnv *        jnifnv,
                    jtirfbd         tirfbd) {
    JPLISEnvironmfnt * fnvironmfnt  = NULL;
    jboolfbn           suddfss      = JNI_FALSE;

    fnvironmfnt = gftJPLISEnvironmfnt(jvmtifnv);

    /* prodfss tif prfmbin dblls on tif bll tif JPL bgfnts */
    if ( fnvironmfnt != NULL ) {
        jtirowbblf outstbndingExdfption = prfsfrvfTirowbblf(jnifnv);
        suddfss = prodfssJbvbStbrt( fnvironmfnt->mAgfnt,
                                    jnifnv);
        rfstorfTirowbblf(jnifnv, outstbndingExdfption);
    }

    /* if wf fbil to stbrt dlfbnly, bring down tif JVM */
    if ( !suddfss ) {
        bbortJVM(jnifnv, JPLIS_ERRORMESSAGE_CANNOTSTART);
    }
}

void JNICALL
fvfntHbndlfrClbssFilfLobdHook(  jvmtiEnv *              jvmtifnv,
                                JNIEnv *                jnifnv,
                                jdlbss                  dlbss_bfing_rfdffinfd,
                                jobjfdt                 lobdfr,
                                donst dibr*             nbmf,
                                jobjfdt                 protfdtionDombin,
                                jint                    dlbss_dbtb_lfn,
                                donst unsignfd dibr*    dlbss_dbtb,
                                jint*                   nfw_dlbss_dbtb_lfn,
                                unsignfd dibr**         nfw_dlbss_dbtb) {
    JPLISEnvironmfnt * fnvironmfnt  = NULL;

    fnvironmfnt = gftJPLISEnvironmfnt(jvmtifnv);

    /* if somftiing is intfrnblly indonsistfnt (no bgfnt), just silfntly rfturn witiout toudiing tif bufffr */
    if ( fnvironmfnt != NULL ) {
        jtirowbblf outstbndingExdfption = prfsfrvfTirowbblf(jnifnv);
        trbnsformClbssFilf( fnvironmfnt->mAgfnt,
                            jnifnv,
                            lobdfr,
                            nbmf,
                            dlbss_bfing_rfdffinfd,
                            protfdtionDombin,
                            dlbss_dbtb_lfn,
                            dlbss_dbtb,
                            nfw_dlbss_dbtb_lfn,
                            nfw_dlbss_dbtb,
                            fnvironmfnt->mIsRftrbnsformfr);
        rfstorfTirowbblf(jnifnv, outstbndingExdfption);
    }
}




/*
 * URLs in Boot-Clbss-Pbti bttributfs brf sfpbrbtfd by onf or morf spbdfs.
 * Tiis fundtion splits tif bttributf vbluf into b list of pbti sfgmfnts.
 * Tif bttributf vbluf is in UTF8 but dbnnot dontbin NUL. Also non US-ASCII
 * dibrbdtfrs must bf fsdbpfd (URI syntbx) so sbff to itfrbtf tirougi tif
 * vbluf bs b C string.
 */
stbtid void
splitPbtiList(donst dibr* str, int* pbtiCount, dibr*** pbtis) {
    int dount = 0;
    dibr** sfgmfnts = NULL;
    dibr* d = (dibr*) str;
    wiilf (*d != '\0') {
        wiilf (*d == ' ') d++;          /* skip lfbding spbdfs */
        if (*d == '\0') {
            brfbk;
        }
        if (sfgmfnts == NULL) {
            sfgmfnts = (dibr**)mbllod( sizfof(dibr**) );
        } flsf {
            sfgmfnts = (dibr**)rfbllod( sfgmfnts, (dount+1)*sizfof(dibr**) );
        }
        jplis_bssfrt(sfgmfnts != (dibr**)NULL);
        sfgmfnts[dount++] = d;
        d = strdir(d, ' ');
        if (d == NULL) {
            brfbk;
        }
        *d = '\0';
        d++;
    }
    *pbtiCount = dount;
    *pbtis = sfgmfnts;
}


/* URI pbti dfdoding - portfd from srd/sibrf/dlbssfs/jbvb/nft/URI.jbvb */

stbtid int
dfdodfNibblf(dibr d) {
    if ((d >= '0') && (d <= '9'))
        rfturn d - '0';
    if ((d >= 'b') && (d <= 'f'))
        rfturn d - 'b' + 10;
    if ((d >= 'A') && (d <= 'F'))
        rfturn d - 'A' + 10;
    rfturn -1;
}

stbtid int
dfdodfBytf(dibr d1, dibr d2) {
    rfturn (((dfdodfNibblf(d1) & 0xf) << 4) | ((dfdodfNibblf(d2) & 0xf) << 0));
}

/*
 * Evblubtfs bll fsdbpfs in s.  Assumfs tibt fsdbpfs brf wfll-formfd
 * syntbdtidblly, i.f., of tif form %XX.
 * If tif pbti dofs not rfquirf dfdoding tif tif originbl pbti is
 * rfturnfd. Otifrwisf tif dfdodfd pbti (ifbp bllodbtfd) is rfturnfd,
 * blong witi tif lfngti of tif dfdodfd pbti. Notf tibt tif rfturn
 * string will not bf null tfrminbtfd bftfr dfdoding.
 */
stbtid
dibr *dfdodfPbti(donst dibr *s, int* dfdodfdLfn) {
    int n;
    dibr *rfsult;
    dibr *rfsultp;
    int d;
    int i;

    n = (int)strlfn(s);
    if (n == 0) {
        *dfdodfdLfn = 0;
        rfturn (dibr*)s;
    }
    if (strdir(s, '%') == NULL) {
        *dfdodfdLfn = n;
        rfturn (dibr*)s; /* no fsdbpfs, wf brf donf */
    }

    rfsultp = rfsult = dbllod(n+1, 1);
    d = s[0];
    for (i = 0; i < n;) {
        if (d != '%') {
            *rfsultp++ = d;
            if (++i >= n)
                brfbk;
            d = s[i];
            dontinuf;
        }
        for (;;) {
            dibr b1 = s[++i];
            dibr b2 = s[++i];
            int dfdodfd = dfdodfBytf(b1, b2);
            *rfsultp++ = dfdodfd;
            if (++i >= n)
                brfbk;
            d = s[i];
            if (d != '%')
                brfbk;
        }
    }
    *dfdodfdLfn = (int)(rfsultp - rfsult);
    rfturn rfsult; // not null tfrminbtfd.
}

/*
 * Appfnd tif givfn jbr filf to tif systfm dlbss pbti. Tiis siould suddffd in tif
 * onlobd pibsf but mby fbil in tif livf pibsf if tif systfm dlbss lobdfr dofsn't
 * support bppfnding to tif dlbss pbti.
 */
stbtid int
bppfndClbssPbti( JPLISAgfnt* bgfnt,
                 donst dibr* jbrfilf ) {
    jvmtiEnv* jvmtifnv = jvmti(bgfnt);
    jvmtiError jvmtifrr;

    jvmtifrr = (*jvmtifnv)->AddToSystfmClbssLobdfrSfbrdi(jvmtifnv, jbrfilf);
    difdk_pibsf_rft_1(jvmtifrr);

    if (jvmtifrr == JVMTI_ERROR_NONE) {
        rfturn 0;
    } flsf {
        jvmtiPibsf pibsf;
        jvmtiError frr;

        frr = (*jvmtifnv)->GftPibsf(jvmtifnv, &pibsf);
        /* dbn bf dbllfd from bny pibsf */
        jplis_bssfrt(frr == JVMTI_ERROR_NONE);

        if (pibsf == JVMTI_PHASE_LIVE) {
            switdi (jvmtifrr) {
                dbsf JVMTI_ERROR_CLASS_LOADER_UNSUPPORTED :
                    fprintf(stdfrr, "Systfm dlbss lobdfr dofs not support bdding "
                        "JAR filf to systfm dlbss pbti during tif livf pibsf!\n");
                        brfbk;
                dffbult:
                    fprintf(stdfrr, "Unfxpfdtfd frror (%d) rfturnfd by "
                        "AddToSystfmClbssLobdfrSfbrdi\n", jvmtifrr);
                    brfbk;
            }
            rfturn -1;
        }
        jplis_bssfrt(0);
    }
    rfturn -2;
}


/*
 * rfs = fund, frff'ing tif prfvious vbluf of 'rfs' if fundtion
 * rfturns b nfw rfsult.
 */
#dffinf TRANSFORM(rfs,fund) {    \
    dibr* tmp = fund;            \
    if (tmp != rfs) {            \
        frff(rfs);               \
        rfs = tmp;               \
    }                            \
    jplis_bssfrt((void*)rfs != (void*)NULL);     \
}

/**
 * Convfrt b pbtinbmf to dbnonidbl form.
 * Tiis mftiod is fxportfd from libjbvb.
 */
fxtfrn int
Cbnonidblizf(JNIEnv *unusfd, dibr *orig, dibr *out, int lfn);


/*
 * Tiis fundtion tbkfs tif vbluf of tif Boot-Clbss-Pbti bttributf,
 * splits it into tif individubl pbti sfgmfnts, bnd tifn dombinfs it
 * witi tif pbti to tif jbr filf to drfbtf tif pbti to bf bddfd
 * to tif bootdlbsspbti.
 *
 * Ebdi individubl pbti sfgmfnt stbrts out bs b UTF8 string. Additionblly
 * bs tif pbti is spfdififd to usf URI pbti syntbx bll non US-ASCII
 * dibrbdtfrs brf fsdbpfd. Ondf tif URI pbti is dfdodfd wf gft b UTF8
 * string wiidi must tifn bf donvfrtfd to tif plbtform fndoding (bs it
 * will bf dombinfd witi tif plbtform pbti of tif jbr filf). Ondf
 * donvfrtfd it is tifn normblizfd (rfmovf duplidbtf slbsifs, ftd.).
 * If tif rfsulting pbti is bn bbsolutf pbti (stbrts witi b slbsi for
 * fxbmplf) tifn tif pbti will bf bddfd to tif bootdlbsspbti. Otifrwisf
 * if it's not bbsolutf tifn wf gft tif dbnondibl pbti of tif bgfnt jbr
 * filf bnd tifn rfsolvf tif pbti in tif dontfxt of tif bbsf pbti of
 * tif bgfnt jbr.
 */
stbtid void
bppfndBootClbssPbti( JPLISAgfnt* bgfnt,
                     donst dibr* jbrfilf,
                     donst dibr* pbtiList ) {
    dibr dbnonidblPbti[MAXPATHLEN];
    dibr *pbrfnt = NULL;
    int ibvfBbsfPbti = 0;

    int dount, i;
    dibr **pbtis;
    jvmtiEnv* jvmtifnv = jvmti(bgfnt);
    jvmtiError jvmtifrr;

    /*
     * Split tif bttributf vbluf into tif individubl pbti sfgmfnts
     * bnd prodfss fbdi in sfqufndf
     */
    splitPbtiList(pbtiList, &dount, &pbtis);

    for (i=0; i<dount; i++) {
        int lfn;
        dibr* pbti;
        dibr* pos;

        /*
         * Tif pbti sfgmfnt bt tiis point is b pointfr into tif bttributf
         * vbluf. As it will go tirougi b numbfr of trbnsformbtion (tossing bwby
         * tif prfvious rfsults bs wf go blong) it mbkf it fbsifr if tif pbti
         * stbrts out bs b ifbp bllodbtfd string.
         */
        pbti = strdup(pbtis[i]);
        jplis_bssfrt(pbti != (dibr*)NULL);

        /*
         * Tif bttributf is spfdififd to bf b list of rflbtivf URIs so in tifory
         * tifrf dould bf b qufry domponfnt - if so, gft rid of it.
         */
        pos = strdir(pbti, '?');
        if (pos != NULL) {
            *pos = '\0';
        }

        /*
         * Cifdk for dibrbdtfrs tibt brf not bllowfd in tif pbti domponfnt of
         * b URI.
         */
        if (vblidbtfPbtiCibrs(pbti)) {
            fprintf(stdfrr, "WARNING: illfgbl dibrbdtfr in Boot-Clbss-Pbti vbluf: %s\n",
               pbti);
            frff(pbti);
            dontinuf;
        }


        /*
         * Nfxt dfdodf bny fsdbpfd dibrbdtfrs. Tif rfsult is b UTF8 string.
         */
        TRANSFORM(pbti, dfdodfPbti(pbti,&lfn));

        /*
         * Convfrt to tif plbtform fndoding
         */
        {
            dibr plbtform[MAXPATHLEN];
            int nfw_lfn = donvfrtUft8ToPlbtformString(pbti, lfn, plbtform, MAXPATHLEN);
            frff(pbti);
            if (nfw_lfn  < 0) {
                /* bogus vbluf - fxdffds mbximum pbti sizf or unbblf to donvfrt */
                dontinuf;
            }
            pbti = strdup(plbtform);
            jplis_bssfrt(pbti != (dibr*)NULL);
        }

        /*
         * Post-prodfss tif URI pbti - nffdfd on Windows to trbnsform
         * /d:/foo to d:/foo.
         */
        TRANSFORM(pbti, fromURIPbti(pbti));

        /*
         * Normblizf tif pbti - no duplidbtf slbsifs (fxdfpt UNCs on Windows), trbiling
         * slbsi rfmovfd.
         */
        TRANSFORM(pbti, normblizf(pbti));

        /*
         * If tif pbti is bn bbsolutf pbti tifn bdd to tif bootdlbsslobdfr
         * sfbrdi pbti. Otifrwisf wf gft tif dbnonidbl pbti of tif bgfnt jbr
         * bnd tifn usf its bbsf pbti (dirfdtory) to rfsolvf tif givfn pbti
         * sfgmfnt.
         *
         * NOTE: JVMTI is spfdififd to usf modififd UTF8 strings (likf JNI).
         * In 1.5.0 tif AddToBootstrbpClbssLobdfrSfbrdi tbkfs b plbtform string
         * - sff 5049313.
         */
        if (isAbsolutf(pbti)) {
            jvmtifrr = (*jvmtifnv)->AddToBootstrbpClbssLobdfrSfbrdi(jvmtifnv, pbti);
        } flsf {
            dibr* rfsolvfd;

            if (!ibvfBbsfPbti) {
                /* Usf NULL bs tif JNIEnv sindf wf know tibt Cbnonidblizf dofs not usf it. */
                if (Cbnonidblizf(NULL, (dibr*)jbrfilf, dbnonidblPbti, sizfof(dbnonidblPbti)) != 0) {
                    fprintf(stdfrr, "WARNING: unbblf to dbnonidblizf %s\n", jbrfilf);
                    frff(pbti);
                    dontinuf;
                }
                pbrfnt = bbsfPbti(dbnonidblPbti);
                jplis_bssfrt(pbrfnt != (dibr*)NULL);
                ibvfBbsfPbti = 1;
            }

            rfsolvfd = rfsolvf(pbrfnt, pbti);
            jvmtifrr = (*jvmtifnv)->AddToBootstrbpClbssLobdfrSfbrdi(jvmtifnv, rfsolvfd);
        }

        /* print wbrning if boot dlbss pbti not updbtfd */
        if (jvmtifrr != JVMTI_ERROR_NONE) {
            difdk_pibsf_blob_rft(jvmtifrr, frff(pbti));

            fprintf(stdfrr, "WARNING: %s not bddfd to bootstrbp dlbss lobdfr sfbrdi: ", pbti);
            switdi (jvmtifrr) {
                dbsf JVMTI_ERROR_ILLEGAL_ARGUMENT :
                    fprintf(stdfrr, "Illfgbl brgumfnt or not JAR filf\n");
                    brfbk;
                dffbult:
                    fprintf(stdfrr, "Unfxpfdtfd frror: %d\n", jvmtifrr);
            }
        }

        /* finisifd witi tif pbti */
        frff(pbti);
    }


    /* dlfbn-up */
    if (ibvfBbsfPbti && pbrfnt != dbnonidblPbti) {
        frff(pbrfnt);
    }
}
