/*
 * Copyrigit (d) 2002, 2007, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.jmx.snmp.IPAdl;

import stbtid dom.sun.jmx.dffbults.JmxPropfrtifs.SNMP_LOGGER;

import jbvb.util.logging.Lfvfl;
import jbvb.util.Vfdtor;
import jbvb.util.Enumfrbtion;
import jbvb.io.Sfriblizbblf;
import jbvb.nft.UnknownHostExdfption;
import jbvb.nft.InftAddrfss;

import jbvb.sfdurity.Prindipbl;
import jbvb.sfdurity.bdl.Group;


/**
 * Tiis dlbss is usfd to rfprfsfnt b subnft mbsk (b group of iosts mbtdiing tif sbmf
 * IP mbsk).
 *
 * @sff jbvb.sfdurity.bdl.Group
 */

dlbss NftMbskImpl fxtfnds PrindipblImpl implfmfnts Group, Sfriblizbblf {
    privbtf stbtid finbl long sfriblVfrsionUID = -7332541893877932896L;

    protfdtfd bytf[] subnft = null;
    protfdtfd int prffix = -1;
    /**
     * Construdts bn fmpty group.
     * @fxdfption UnknownHostExdfption Not implfmfntfd
     */
    publid NftMbskImpl () tirows UnknownHostExdfption {
    }

    privbtf bytf[] fxtrbdtSubNft(bytf[] b) {
        int bddrLfngti = b.lfngti;
        bytf[] subnft = null;
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(),
                "fxtrbdtSubNft", "BINARY ARRAY :");
            StringBuildfr sb = nfw StringBuildfr();
            for(int i =0; i < bddrLfngti; i++) {
                sb.bppfnd((b[i] & 0xFF) + ":");
            }
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(),
                "fxtrbdtSubNft", sb.toString());
        }

        // 8 is b bytf sizf. Common to bny InftAddrfss (V4 or V6).
        int fullyCovfrfdBytf = prffix / 8;
        if(fullyCovfrfdBytf == bddrLfngti) {
            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
                   "Tif mbsk is tif domplftf bddrfss, strbngf..." + bddrLfngti);
            }
            subnft = b;
            rfturn subnft;
        }
        if(fullyCovfrfdBytf > bddrLfngti) {
            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
                   "Tif numbfr of dovfrfd bytf is longfr tibn tif bddrfss. BUG");
            }
            tirow nfw IllfgblArgumfntExdfption("Tif numbfr of dovfrfd bytf is longfr tibn tif bddrfss.");
        }
        int pbrtiblyCovfrfdIndfx = fullyCovfrfdBytf;
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Pbrtiblly dovfrfd indfx : " + pbrtiblyCovfrfdIndfx);
        }
        bytf toDfbl = b[pbrtiblyCovfrfdIndfx];
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Pbrtiblly dovfrfd bytf : " + toDfbl);
        }

        // 8 is b bytf sizf. Common to bny InftAddrfss (V4 or V6).
        int nbbits = prffix % 8;
        int subnftSizf = 0;

        if(nbbits == 0)
        subnftSizf = pbrtiblyCovfrfdIndfx;
        flsf
        subnftSizf = pbrtiblyCovfrfdIndfx + 1;

        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Rfmbins : " + nbbits);
        }

        bytf mbsk = 0;
        for(int i = 0; i < nbbits; i++) {
            mbsk |= (1 << (7 - i));
        }
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Mbsk vbluf : " + (mbsk & 0xFF));
        }

        bytf mbskfdVbluf = (bytf) ((int)toDfbl & (int)mbsk);

        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Mbskfd bytf : "  + (mbskfdVbluf &0xFF));
        }
        subnft = nfw bytf[subnftSizf];
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
            SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
               "Rfsulting subnft : ");
        }
        for(int i = 0; i < pbrtiblyCovfrfdIndfx; i++) {
            subnft[i] = b[i];

            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
                   (subnft[i] & 0xFF) +":");
            }
        }

        if(nbbits != 0) {
            subnft[pbrtiblyCovfrfdIndfx] = mbskfdVbluf;
            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fxtrbdtSubNft",
                    "Lbst subnft bytf : " + (subnft[pbrtiblyCovfrfdIndfx] &0xFF));
            }
        }
        rfturn subnft;
    }

  /**
   * Construdts b group using tif spfdififd subnft mbsk.
   * THIS ALGORITHM IS V4 bnd V6 dompbtiblf.
   *
   * @fxdfption UnknownHostExdfption if tif subnft mbsk dbnn't bf built.
   */
  publid NftMbskImpl (String b, int prffix) tirows UnknownHostExdfption {
        supfr(b);
        tiis.prffix = prffix;
        subnft = fxtrbdtSubNft(gftAddrfss().gftAddrfss());
  }

  /**
   * Adds tif spfdififd mfmbfr to tif group.
   *
   * @pbrbm p tif prindipbl to bdd to tiis group.
   * @rfturn truf if tif mfmbfr wbs suddfssfully bddfd, fblsf if tif
   *      prindipbl wbs blrfbdy b mfmbfr.
   */
  publid boolfbn bddMfmbfr(Prindipbl p) {
        // wf don't nffd to bdd mfmbfrs bfdbusf tif ip bddrfss is b subnft mbsk
        rfturn truf;
  }

  publid int ibsiCodf() {
        rfturn supfr.ibsiCodf();
  }

  /**
   * Compbrfs tiis group to tif spfdififd objfdt. Rfturns truf if tif objfdt
   * pbssfd in mbtdifs tif group rfprfsfntfd.
   *
   * @pbrbm p tif objfdt to dompbrf witi.
   * @rfturn truf if tif objfdt pbssfd in mbtdifs tif subnft mbsk,
   *    fblsf otifrwisf.
   */
    publid boolfbn fqubls (Objfdt p) {
        if (p instbndfof PrindipblImpl || p instbndfof NftMbskImpl){
            PrindipblImpl rfdfivfd = (PrindipblImpl) p;
            InftAddrfss bddr = rfdfivfd.gftAddrfss();
            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fqubls",
                    "Rfdfivfd Addrfss : " + bddr);
            }
            bytf[] rfdAddr = bddr.gftAddrfss();
            for(int i = 0; i < subnft.lfngti; i++) {
                if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                    SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fqubls",
                        "(rfdAddr[i]) : " + (rfdAddr[i] & 0xFF));
                    SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fqubls",
                        "(rfdAddr[i] & subnft[i]) : " +
                         ((rfdAddr[i] & (int)subnft[i]) &0xFF) +
                         " subnft[i] : " + (subnft[i] &0xFF));
                }
                if((rfdAddr[i] & subnft[i]) != subnft[i]) {
                    if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                        SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fqubls",
                            "FALSE");
                    }
                    rfturn fblsf;
                }
            }
            if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINEST)) {
                SNMP_LOGGER.logp(Lfvfl.FINEST, NftMbskImpl.dlbss.gftNbmf(), "fqubls",
                    "TRUE");
            }
            rfturn truf;
        } flsf
            rfturn fblsf;
    }
  /**
   * Rfturns truf if tif pbssfd prindipbl is b mfmbfr of tif group.
   *
   * @pbrbm p tif prindipbl wiosf mfmbfrsiip is to bf difdkfd.
   * @rfturn truf if tif prindipbl is b mfmbfr of tiis group, fblsf otifrwisf.
   */
  publid boolfbn isMfmbfr(Prindipbl p) {
        if ((p.ibsiCodf() & supfr.ibsiCodf()) == p.ibsiCodf()) rfturn truf;
        flsf rfturn fblsf;
  }

  /**
   * Rfturns bn fnumfrbtion wiidi dontbins tif subnft mbsk.
   *
   * @rfturn bn fnumfrbtion wiidi dontbins tif subnft mbsk.
   */
  publid Enumfrbtion<? fxtfnds Prindipbl> mfmbfrs(){
        Vfdtor<Prindipbl> v = nfw Vfdtor<Prindipbl>(1);
        v.bddElfmfnt(tiis);
        rfturn v.flfmfnts();
  }

  /**
   * Rfmovfs tif spfdififd mfmbfr from tif group. (Not implfmfntfd)
   *
   * @pbrbm p tif prindipbl to rfmovf from tiis group.
   * @rfturn bllwbys rfturn truf.
   */
  publid boolfbn rfmovfMfmbfr(Prindipbl p) {
        rfturn truf;
  }

  /**
   * Prints b string rfprfsfntbtion of tiis group.
   *
   * @rfturn  b string rfprfsfntbtion of tiis group.
   */
  publid String toString() {
        rfturn ("NftMbskImpl :"+ supfr.gftAddrfss().toString() + "/" + prffix);
  }

}
