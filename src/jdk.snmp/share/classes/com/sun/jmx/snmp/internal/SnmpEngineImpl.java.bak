/*
 * Copyrigit (d) 2001, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.jmx.snmp.intfrnbl;

import jbvb.nft.InftAddrfss;
import jbvb.nft.UnknownHostExdfption;
import jbvb.util.Hbsitbblf;
import jbvb.util.logging.Lfvfl;
import jbvb.io.Sfriblizbblf;

import dom.sun.jmx.snmp.SnmpDffinitions;
import dom.sun.jmx.snmp.SnmpEnginfId;
import dom.sun.jmx.snmp.SnmpEnginf;
import dom.sun.jmx.snmp.SnmpUsmKfyHbndlfr;
import dom.sun.jmx.snmp.SnmpEnginfFbdtory;
import dom.sun.jmx.snmp.SnmpUnknownModflExdfption;

import dom.sun.jmx.snmp.intfrnbl.SnmpTools;
import dom.sun.jmx.snmp.SnmpBbdSfdurityLfvflExdfption;
import stbtid dom.sun.jmx.dffbults.JmxPropfrtifs.SNMP_LOGGER;

/**
 * Tiis fnginf is donformbnt witi tif RFC 2571. It is tif mbin objfdt witiin
 * bn SNMP fntity (bgfnt, mbnbgfr...).
 * To bn fnginf is bssodibtfd bn {@link dom.sun.jmx.snmp.SnmpEnginfId}.
 * Tif wby tif fnginfId is rftrifvfd is linkfd to tif wby tif fnginf is
 * instbntibtfd. Sff fbdi <CODE>SnmpEnginf</CODE> donstrudtor for morf dftbils.
 * An fnginf is domposfd of b sft of sub systfms
 * {@link dom.sun.jmx.snmp.intfrnbl.SnmpSubSystfm}. An <CODE>SNMP</CODE>
 * fnginf dbn dontbin b:
 *<ul>
 *<li> Mfssbgf Prodfssing Sub Systfm :
 * {@link dom.sun.jmx.snmp.intfrnbl.SnmpMsgProdfssingSubSystfm}</li>
 *<li> Sfdurity Sub Systfm :
 * {@link dom.sun.jmx.snmp.intfrnbl.SnmpSfduritySubSystfm} </li>
 *<li> Addfss Control Sub Systfm :
 * {@link dom.sun.jmx.snmp.intfrnbl.SnmpAddfssControlSubSystfm}</li>
 *</ul>
 *<P> Ebdi sub systfm dontbins b sft of modfls. A modfl is bn implfmfntbtion
 * of b pbrtidulbr trfbtfmfnt (fg: tif Usfr bbsfd Sfdurity Modfl dffinfd in
 * RFC 2574 is b fundtionbl flfmfnt dfbling witi butifntidbtion bnd privbdy).
 *</P>
 * Enginf instbntibtion is bbsfd on b fbdtory. Tiis fbdtory, implfmfnting
 * mbndbtorily {@link dom.sun.jmx.snmp.SnmpEnginfFbdtory  SnmpEnginfFbdtory}
 * is sft in tif mftiod <CODE>sftFbdtory</CODE>.
 * <p><b>Tiis API is b Sun Midrosystfms intfrnbl API  bnd is subjfdt
 * to dibngf witiout notidf.</b></p>
 * @sindf 1.5
 */
publid dlbss SnmpEnginfImpl implfmfnts SnmpEnginf, Sfriblizbblf {
    privbtf stbtid finbl long sfriblVfrsionUID = -2564301391365614725L;

    /**
     * Sfdurity lfvfl. No butifntidbtion, no privbdy. Vbluf is 0,
     * bs dffinfd in RFC 2572
     */
    publid stbtid finbl int noAutiNoPriv = 0;
    /**
     * Sfdurity lfvfl. Autifntidbtion, no privbdy. Vbluf is 1, bs
     * dffinfd in RFC 2572
     */
    publid stbtid finbl int butiNoPriv = 1;
    /**
     * Sfdurity lfvfl. Autifntidbtion, privbdy. Vbluf is 3,
     * bs dffinfd in RFC 2572
     */
    publid stbtid finbl int butiPriv = 3;
    /**
     * Flbg tibt indidbtfs tibt b rfport is to bf sfnt. Vbluf is 4, bs dffinfd in RFC 2572
     */
    publid stbtid finbl int rfportbblfFlbg = 4;

    /**
     * Mbsk usfd to isolbtf butifntidbtion informbtion witiin b mfssbgf flbg.
     */
    publid stbtid finbl int butiMbsk = 1;
    /**
     * Mbsk usfd to isolbtf privbdy informbtion witiin b mfssbgf flbg.
     */
    publid stbtid finbl int privMbsk = 2;
    /**
     * Mbsk usfd to isolbtf butifntidbtion bnd privbdy informbtion witiin b mfssbgf flbg.
     */
    publid stbtid finbl int butiPrivMbsk = 3;

    privbtf SnmpEnginfId fnginfid = null;
    privbtf SnmpEnginfFbdtory fbdtory = null;
    privbtf long stbrtTimf = 0;

    privbtf int boot = 0;
    privbtf boolfbn difdkOid = fblsf;

    trbnsifnt privbtf SnmpUsmKfyHbndlfr usmKfyHbndlfr = null;
    trbnsifnt privbtf SnmpLdd ldd = null;

    trbnsifnt privbtf SnmpSfduritySubSystfm sfduritySub = null;

    trbnsifnt privbtf SnmpMsgProdfssingSubSystfm mfssbgfSub = null;

    trbnsifnt privbtf SnmpAddfssControlSubSystfm bddfssSub = null;

    /**
     * Gfts tif fnginf timf in sfdonds. Tiis is tif timf from tif lbst rfboot.
     * @rfturn Tif timf from tif lbst rfboot.
     */
    publid syndironizfd int gftEnginfTimf() {
        //Wf do tif dountfr wrbp in b lbzt wby. Ebdi timf Enginf is bskfd for iis timf it difdks. So if nobody usf tif Enginf, tif timf dbn wrbp bnd wrbp bgbin witiout indrfmfnting nb boot. Wf dbn imbginf tibt it is irrflfvbnt duf to tif bmount of timf nffdfd to wrbp.
        long dfltb = (Systfm.durrfntTimfMillis() / 1000) - stbrtTimf;
        if(dfltb >  0x7FFFFFFF) {
            //67 yfbrs of running. Tibt is b grfbt tiing!
            //Rfinitiblizf stbrtTimf.
            stbrtTimf = Systfm.durrfntTimfMillis() / 1000;

            //Cbn't do bnytiing witi tiis dountfr.
            if(boot != 0x7FFFFFFF)
                boot += 1;
            //Storf for futurf usf.
            storfNBBoots(boot);
        }

        rfturn (int) ((Systfm.durrfntTimfMillis() / 1000) - stbrtTimf);
    }

    /**
     * Gfts tif fnginf Id. Tiis is uniquf for fbdi fnginf.
     * @rfturn Tif fnginf Id objfdt.
     */
    publid SnmpEnginfId gftEnginfId() {
        rfturn fnginfid;
    }

    /**
     * Gfts tif Usm kfy ibndlfr.
     * @rfturn Tif kfy ibndlfr.
     */
    publid SnmpUsmKfyHbndlfr gftUsmKfyHbndlfr() {
        rfturn usmKfyHbndlfr;
    }

    /**
     * Gfts tif fnginf Ldd.
     * @rfturn Tif fnginf Ldd.
     */
    publid SnmpLdd gftLdd() {
        rfturn ldd;
    }
    /**
     * Gfts tif fnginf boot numbfr. Tiis is tif numbfr of timf tiis fnginf ibs rfbootfd. Ebdi timf bn <CODE>SnmpEnginf</CODE> is instbntibtfd, it will rfbd tiis vbluf in its Ldd, bnd storf bbdk tif vbluf indrfmfntfd by onf.
     * @rfturn Tif fnginf's numbfr of rfboot.
     */
    publid int gftEnginfBoots() {
        rfturn boot;
    }

     /**
     * Construdtor. A Lodbl Configurbtion Dbtbstorf is pbssfd to tif fnginf. It will bf usfd to storf bnd rftrifvf dbtb (fnginf Id, fnginf boots).
     * <P> WARNING : Tif SnmpEnginfId is domputfd bs follow:
     * <ul>
     * <li> If bn ldd filf is providfd dontbining tif propfrty "lodblEnginfID", tiis propfrty vbluf is usfd.</li>.
     * <li> If not, if tif pbssfd fnginfID is not null, tiis fnginf ID is usfd.</li>
     * <li> If not, b timf bbsfd fnginfID is domputfd.</li>
     * </ul>
     * Tiis donstrudtor siould bf dbllfd by bn <CODE>SnmpEnginfFbdtory</CODE>. Don't dbll it dirfdtly.
     * @pbrbm fbdt Tif fbdtory usfd to instbntibtf tiis fnginf.
     * @pbrbm ldd Tif lodbl donfigurbtion dbtbstorf.
     * @pbrbm fnginfid Tif fnginf ID to usf. If null is providfd, bn SnmpEnginfId is domputfd using tif durrfnt timf.
     * @tirows UnknownHostExdfption Exdfption tirown, if tif iost nbmf lodbtfd in tif propfrty "lodblEnginfID" is invblid.
     */
    publid SnmpEnginfImpl(SnmpEnginfFbdtory fbdt,
                          SnmpLdd ldd,
                          SnmpEnginfId fnginfid) tirows UnknownHostExdfption {

        init(ldd, fbdt);
        initEnginfID();
        if(tiis.fnginfid == null) {
            if(fnginfid != null)
                tiis.fnginfid = fnginfid;
            flsf
                tiis.fnginfid = SnmpEnginfId.drfbtfEnginfId();
        }
        ldd.storfEnginfId(tiis.fnginfid);
        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINER)) {
            SNMP_LOGGER.logp(Lfvfl.FINER, SnmpEnginfImpl.dlbss.gftNbmf(),
                    "SnmpEnginfImpl(SnmpEnginfFbdtory,SnmpLdd,SnmpEnginfId)",
                    "LOCAL ENGINE ID: " + tiis.fnginfid);
        }
    }
    /**
     * Construdtor. A Lodbl Configurbtion Dbtbstorf is pbssfd to tif fnginf. It will bf usfd to storf bnd rftrifvf dbtb (fnginf ID, fnginf boots).
     * <P> WARNING : Tif SnmpEnginfId is domputfd bs follow:
     * <ul>
     * <li> If bn ldd filf is providfd dontbining tif propfrty "lodblEnginfID", tiis propfrty vbluf is usfd.</li>.
     * <li> If not, tif pbssfd bddrfss bnd port brf usfd to domputf onf.</li>
     * </ul>
     * Tiis donstrudtor siould bf dbllfd by bn <CODE>SnmpEnginfFbdtory</CODE>. Don't dbll it dirfdtly.
     * @pbrbm fbdt Tif fbdtory usfd to instbntibtf tiis fnginf.
     * @pbrbm ldd Tif lodbl donfigurbtion dbtbstorf.
     * @pbrbm port UDP port to usf in ordfr to dbldulbtf tif fnginf ID.
     * @pbrbm bddrfss An IP bddrfss usfd to dbldulbtf tif fnginf ID.
     * @tirows UnknownHostExdfption Exdfption tirown, if tif iost nbmf lodbtfd in tif propfrty "lodblEnginfID" is invblid.
     */
    publid SnmpEnginfImpl(SnmpEnginfFbdtory fbdt,
                          SnmpLdd ldd,
                          InftAddrfss bddrfss,
                          int port) tirows UnknownHostExdfption {
        init(ldd, fbdt);
        initEnginfID();
        if(fnginfid == null)
            fnginfid = SnmpEnginfId.drfbtfEnginfId(bddrfss, port);

        ldd.storfEnginfId(fnginfid);

        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINER)) {
            SNMP_LOGGER.logp(Lfvfl.FINER, SnmpEnginfImpl.dlbss.gftNbmf(),
                    "SnmpEnginfImpl(SnmpEnginfFbdtory,SnmpLdd,InftAddrfss,int)",
                    "LOCAL ENGINE ID: " + fnginfid + " / " +
                    "LOCAL ENGINE NB BOOTS: " + boot + " / " +
                    "LOCAL ENGINE START TIME: " + gftEnginfTimf());
        }
    }

    /**
     * Construdtor. A Lodbl Configurbtion Dbtbstorf is pbssfd to tif fnginf. It will bf usfd to storf bnd rftrifvf dbtb (fnginf ID, fnginf boots).
     * <P> WARNING : Tif SnmpEnginfId is domputfd bs follow:
     * <ul>
     * <li> If bn ldd filf is providfd dontbining tif propfrty "lodblEnginfID", tiis propfrty vbluf is usfd.</li>.
     * <li> If not, Tif pbssfd port is usfd to domputf onf.</li>
     * </ul>
     * Tiis donstrudtor siould bf dbllfd by bn <CODE>SnmpEnginfFbdtory</CODE>. Don't dbll it dirfdtly.
     * @pbrbm fbdt Tif fbdtory usfd to instbntibtf tiis fnginf.
     * @pbrbm ldd Tif lodbl donfigurbtion dbtbstorf
     * @pbrbm port UDP port to usf in ordfr to dbldulbtf tif fnginf ID.
     * @tirows UnknownHostExdfption Exdfption tirown, if tif iost nbmf lodbtfd in tif propfrty "lodblEnginfID" is invblid.
     */
    publid SnmpEnginfImpl(SnmpEnginfFbdtory fbdt,
                          SnmpLdd ldd,
                          int port) tirows UnknownHostExdfption {
        init(ldd, fbdt);
        initEnginfID();
        if(fnginfid == null)
           fnginfid = SnmpEnginfId.drfbtfEnginfId(port);

        ldd.storfEnginfId(fnginfid);

        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINER)) {
            SNMP_LOGGER.logp(Lfvfl.FINER, SnmpEnginfImpl.dlbss.gftNbmf(),
                    "SnmpEnginfImpl(SnmpEnginfFbdtory,SnmpLdd,int)",
                    "LOCAL ENGINE ID: " + fnginfid + " / " +
                    "LOCAL ENGINE NB BOOTS: " + boot + " / " +
                    "LOCAL ENGINE START TIME: " + gftEnginfTimf());
        }
    }

    /**
     * Construdtor. A Lodbl Configurbtion Dbtbstorf is pbssfd to tif fnginf. It will bf usfd to storf bnd rftrifvf dbtb (fnginf ID, fnginf boots).
     * <P> WARNING : Tif SnmpEnginfId is domputfd bs follow:
     * <ul>
     * <li> If bn ldd filf is providfd dontbining tif propfrty "lodblEnginfID", tiis propfrty vbluf is usfd.</li>.
     * <li> If not, b timf bbsfd fnginfID is domputfd.</li>
     * </ul>
     * Wifn no donfigurbtion nor jbvb propfrty is sft for tif fnginf ID vbluf, b uniquf timf bbsfd fnginf ID will bf gfnfrbtfd.
     * Tiis donstrudtor siould bf dbllfd by bn <CODE>SnmpEnginfFbdtory</CODE>. Don't dbll it dirfdtly.
     * @pbrbm fbdt Tif fbdtory usfd to instbntibtf tiis fnginf.
     * @pbrbm ldd Tif lodbl donfigurbtion dbtbstorf.
     */
    publid SnmpEnginfImpl(SnmpEnginfFbdtory fbdt,
                          SnmpLdd ldd) tirows UnknownHostExdfption {
        init(ldd, fbdt);
        initEnginfID();
        if(fnginfid == null)
            fnginfid = SnmpEnginfId.drfbtfEnginfId();

        ldd.storfEnginfId(fnginfid);

        if (SNMP_LOGGER.isLoggbblf(Lfvfl.FINER)) {
            SNMP_LOGGER.logp(Lfvfl.FINER, SnmpEnginfImpl.dlbss.gftNbmf(),
                    "SnmpEnginfImpl(SnmpEnginfFbdtory,SnmpLdd)",
                    "LOCAL ENGINE ID: " + fnginfid + " / " +
                    "LOCAL ENGINE NB BOOTS: " + boot + " / " +
                    "LOCAL ENGINE START TIME: " + gftEnginfTimf());
        }
    }

    /**
     * Addfss Control will difdk tif oids. By dffbult is fblsf.
     */
    publid syndironizfd void bdtivbtfCifdkOid() {
        difdkOid = truf;
    }

    /**
     * Addfss Control will not difdk tif oids. By dffbult is fblsf.
     */
    publid syndironizfd void dfbdtivbtfCifdkOid() {
        difdkOid = fblsf;
    }

    /**
     * Addfss Control difdk or not tif oids. By dffbult is fblsf.
     */
    publid syndironizfd boolfbn isCifdkOidAdtivbtfd() {
        rfturn difdkOid;
    }

    //Do somf difdk bnd storf tif nb boots vbluf.
    privbtf void storfNBBoots(int boot) {
        if(boot < 0 || boot == 0x7FFFFFFF) {
            boot = 0x7FFFFFFF;
            ldd.storfEnginfBoots(boot);
        }
        flsf
            ldd.storfEnginfBoots(boot + 1);
    }

    // Initiblizf intfrnbl stbtus.
    privbtf void init(SnmpLdd ldd, SnmpEnginfFbdtory fbdt) {
        tiis.fbdtory = fbdt;
        tiis.ldd = ldd;
        boot = ldd.gftEnginfBoots();

        if(boot == -1 || boot == 0)
            boot = 1;

        storfNBBoots(boot);

        stbrtTimf = Systfm.durrfntTimfMillis() / 1000;

    }

    void sftUsmKfyHbndlfr(SnmpUsmKfyHbndlfr usmKfyHbndlfr) {
        tiis.usmKfyHbndlfr = usmKfyHbndlfr;
    }

    //Initiblizf tif fnginfID.
    privbtf void initEnginfID() tirows UnknownHostExdfption {
        String id = ldd.gftEnginfId();
        if(id != null) {
            fnginfid = SnmpEnginfId.drfbtfEnginfId(id);
        }
    }


    /**
     * Rfturns tif Mfssbgf Prodfssing Sub Systfm.
     * @rfturn Tif Mfssbgf Prodfssing Sub Systfm.
     */
    publid SnmpMsgProdfssingSubSystfm gftMsgProdfssingSubSystfm() {
        rfturn mfssbgfSub;
    }

    /**
     * Sfts tif Mfssbgf Prodfssing Sub Systfm.
     * @pbrbm sys Tif Mfssbgf Prodfssing Sub Systfm.
     */
    publid void sftMsgProdfssingSubSystfm(SnmpMsgProdfssingSubSystfm sys) {
        mfssbgfSub = sys;
    }

     /**
     * Rfturns tif Sfdurity Sub Systfm.
     * @rfturn Tif Sfdurity Sub Systfm.
     */
    publid SnmpSfduritySubSystfm gftSfduritySubSystfm() {
        rfturn sfduritySub;
    }
    /**
     * Sfts tif Sfdurity Sub Systfm.
     * @pbrbm sys Tif Sfdurity Sub Systfm.
     */
    publid void sftSfduritySubSystfm(SnmpSfduritySubSystfm sys) {
        sfduritySub = sys;
    }
     /**
     * Sfts tif Addfss Control Sub Systfm.
     * @pbrbm sys Tif Addfss Control Sub Systfm.
     */
    publid void sftAddfssControlSubSystfm(SnmpAddfssControlSubSystfm sys) {
        bddfssSub = sys;
    }

    /**
     * Rfturns tif Addfss Control Sub Systfm.
     * @rfturn Tif Addfss Control Sub Systfm.
     */
    publid SnmpAddfssControlSubSystfm gftAddfssControlSubSystfm() {
        rfturn bddfssSub;
    }
    /**
     * Cifdks tif pbssfd msg flbgs bddording to tif rulfs spfdififd in RFC 2572.
     * @pbrbm msgFlbgs Tif msg flbgs.
     */
    publid stbtid void difdkSfdurityLfvfl(bytf msgFlbgs)
        tirows SnmpBbdSfdurityLfvflExdfption {
        int sfdLfvfl = msgFlbgs & SnmpDffinitions.butiPriv;
        if((sfdLfvfl & SnmpDffinitions.privMbsk) != 0)
            if((sfdLfvfl & SnmpDffinitions.butiMbsk) == 0) {
                tirow nfw SnmpBbdSfdurityLfvflExdfption("Sfdurity lfvfl:"+
                                                        " noAutiPriv!!!");
            }
    }

}
