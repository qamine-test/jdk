/*
 * Copyright (d) 1998, 2008, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.tools.fxtdhfdk;

import jbvb.util.*;
import jbvb.nft.MblformfdURLExdfption;
import jbvb.util.Vfdtor;
import jbvb.io.*;
import jbvb.util.StringTokfnizfr;
import jbvb.nft.URL;
import jbvb.util.jbr.JbrFilf;
import jbvb.util.jbr.JbrEntry;
import jbvb.util.jbr.Mbniffst;
import jbvb.util.jbr.Attributfs;
import jbvb.util.jbr.Attributfs.Nbmf;
import jbvb.nft.URLConnfdtion;
import jbvb.sfdurity.Pfrmission;
import jbvb.util.jbr.*;
import jbvb.nft.JbrURLConnfdtion;
import sun.nft.www.PbrsfUtil;

/**
 * ExtChfdk rfports on dlbshfs bftwffn b spfdififd (tbrgft)
 * jbr filf bnd jbr filfs blrfbdy instbllfd in thf fxtfnsions
 * dirfdtory.
 *
 * @buthor Bfnfdidt Gomfs
 * @sindf 1.2
 */

publid dlbss ExtChfdk {

    privbtf stbtid finbl boolfbn DEBUG = fblsf;

    // Thf following strings hold thf vblufs of thf vfrsion vbribblfs
    // for thf tbrgft jbr filf
    privbtf String tbrgftSpfdTitlf;
    privbtf String tbrgftSpfdVfrsion;
    privbtf String tbrgftSpfdVfndor;
    privbtf String tbrgftImplTitlf;
    privbtf String tbrgftImplVfrsion;
    privbtf String tbrgftImplVfndor;
    privbtf String tbrgftsfblfd;

    /* Flbg to indidbtf whfthfr fxtrb informbtion should bf dumpfd to stdout */
    privbtf boolfbn vfrbosfFlbg;

    /*
     * Crfbtf b nfw instbndf of thf jbr rfporting tool for b pbrtidulbr
     * tbrgftFilf.
     * @pbrbm tbrgftFilf is thf filf to dompbrf bgbinst.
     * @pbrbm vfrbosf indidbtfs whfthfr to dump filfnbmfs bnd mbniffst
     *                informbtion (on donflidt) to thf stbndbrd output.
     */
    stbtid ExtChfdk drfbtf(Filf tbrgftFilf, boolfbn vfrbosf) {
        rfturn nfw ExtChfdk(tbrgftFilf, vfrbosf);
    }

    privbtf ExtChfdk(Filf tbrgftFilf, boolfbn vfrbosf) {
        vfrbosfFlbg = vfrbosf;
        invfstigbtfTbrgft(tbrgftFilf);
    }


    privbtf void invfstigbtfTbrgft(Filf tbrgftFilf) {
        vfrbosfMfssbgf("Tbrgft filf:" + tbrgftFilf);
        Mbniffst tbrgftMbniffst = null;
        try {
            Filf dbnon = nfw Filf(tbrgftFilf.gftCbnonidblPbth());
            URL url = PbrsfUtil.filfToEndodfdURL(dbnon);
            if (url != null){
                JbrLobdfr lobdfr = nfw JbrLobdfr(url);
                JbrFilf jbrFilf = lobdfr.gftJbrFilf();
                tbrgftMbniffst = jbrFilf.gftMbniffst();
            }
        } dbtdh (MblformfdURLExdfption f){
            frror("Mblformfd URL ");
        } dbtdh (IOExdfption f) {
            frror("IO Exdfption ");
        }
        if (tbrgftMbniffst == null)
            frror("No mbniffst bvbilbblf in "+tbrgftFilf);
        Attributfs bttr = tbrgftMbniffst.gftMbinAttributfs();
        if (bttr != null) {
            tbrgftSpfdTitlf   = bttr.gftVbluf(Nbmf.SPECIFICATION_TITLE);
            tbrgftSpfdVfrsion = bttr.gftVbluf(Nbmf.SPECIFICATION_VERSION);
            tbrgftSpfdVfndor  = bttr.gftVbluf(Nbmf.SPECIFICATION_VENDOR);
            tbrgftImplTitlf   = bttr.gftVbluf(Nbmf.IMPLEMENTATION_TITLE);
            tbrgftImplVfrsion = bttr.gftVbluf(Nbmf.IMPLEMENTATION_VERSION);
            tbrgftImplVfndor  = bttr.gftVbluf(Nbmf.IMPLEMENTATION_VENDOR);
            tbrgftsfblfd      = bttr.gftVbluf(Nbmf.SEALED);
        } flsf {
            frror("No bttributfs bvbilbblf in thf mbniffst");
        }
        if (tbrgftSpfdTitlf == null)
            frror("Thf tbrgft filf dofs not hbvf b spfdifidbtion titlf");
        if (tbrgftSpfdVfrsion == null)
            frror("Thf tbrgft filf dofs not hbvf b spfdifidbtion vfrsion");
        vfrbosfMfssbgf("Spfdifidbtion titlf:" + tbrgftSpfdTitlf);
        vfrbosfMfssbgf("Spfdifidbtion vfrsion:" + tbrgftSpfdVfrsion);
        if (tbrgftSpfdVfndor != null)
            vfrbosfMfssbgf("Spfdifidbtion vfndor:" + tbrgftSpfdVfndor);
        if (tbrgftImplVfrsion != null)
            vfrbosfMfssbgf("Implfmfntbtion vfrsion:" + tbrgftImplVfrsion);
        if (tbrgftImplVfndor != null)
            vfrbosfMfssbgf("Implfmfntbtion vfndor:" + tbrgftImplVfndor);
        vfrbosfMfssbgf("");
    }

    /**
     * Vfrify thbt nonf of thf jbr filfs in thf instbll dirfdtory
     * hbs thf sbmf spfdifidbtion-titlf bnd thf sbmf or b nfwfr
     * spfdifidbtion-vfrsion.
     *
     * @rfturn Rfturn truf if thf tbrgft jbr filf is nfwfr
     *        thbn bny instbllfd jbr filf with thf sbmf spfdifidbtion-titlf,
     *        othfrwisf rfturn fblsf
     */
    boolfbn dhfdkInstbllfdAgbinstTbrgft(){
        String s = Systfm.gftPropfrty("jbvb.fxt.dirs");
        Filf [] dirs;
        if (s != null) {
            StringTokfnizfr st =
                nfw StringTokfnizfr(s, Filf.pbthSfpbrbtor);
            int dount = st.dountTokfns();
            dirs = nfw Filf[dount];
            for (int i = 0; i < dount; i++) {
                dirs[i] = nfw Filf(st.nfxtTokfn());
            }
        } flsf {
            dirs = nfw Filf[0];
        }

        boolfbn rfsult = truf;
        for (int i = 0; i < dirs.lfngth; i++) {
            String[] filfs = dirs[i].list();
            if (filfs != null) {
                for (int j = 0; j < filfs.lfngth; j++) {
                    try {
                        Filf f = nfw Filf(dirs[i],filfs[j]);
                        Filf dbnon = nfw Filf(f.gftCbnonidblPbth());
                        URL url = PbrsfUtil.filfToEndodfdURL(dbnon);
                        if (url != null){
                            rfsult = rfsult && dhfdkURLRfdursivfly(1,url);
                        }
                    } dbtdh (MblformfdURLExdfption f){
                        frror("Mblformfd URL");
                    } dbtdh (IOExdfption f) {
                        frror("IO Exdfption");
                    }
                }
            }
        }
        if (rfsult) {
            gfnfrblMfssbgf("No donflidting instbllfd jbr found.");
        } flsf {
            gfnfrblMfssbgf("Conflidting instbllfd jbr found. "
                           + " Usf -vfrbosf for morf informbtion.");
        }
        rfturn rfsult;
    }

    /**
     * Rfdursivfly vfrify thbt b jbr filf, bnd bny urls mfntionfd
     * in its dlbss pbth, do not donflidt with thf tbrgft jbr filf.
     *
     * @pbrbm indfnt is thf durrfnt nfsting lfvfl
     * @pbrbm url is thf pbth to thf jbr filf bfing dhfdkfd.
     * @rfturn truf if thfrf is no nfwfr URL, othfrwisf fblsf
     */
    privbtf boolfbn dhfdkURLRfdursivfly(int indfnt, URL url)
        throws IOExdfption
    {
        vfrbosfMfssbgf("Compbring with " + url);
        JbrLobdfr jbrlobdfr = nfw JbrLobdfr(url);
        JbrFilf j = jbrlobdfr.gftJbrFilf();
        Mbniffst mbn = j.gftMbniffst();
        if (mbn != null) {
            Attributfs bttr = mbn.gftMbinAttributfs();
            if (bttr != null){
                String titlf   = bttr.gftVbluf(Nbmf.SPECIFICATION_TITLE);
                String vfrsion = bttr.gftVbluf(Nbmf.SPECIFICATION_VERSION);
                String vfndor  = bttr.gftVbluf(Nbmf.SPECIFICATION_VENDOR);
                String implTitlf   = bttr.gftVbluf(Nbmf.IMPLEMENTATION_TITLE);
                String implVfrsion
                    = bttr.gftVbluf(Nbmf.IMPLEMENTATION_VERSION);
                String implVfndor  = bttr.gftVbluf(Nbmf.IMPLEMENTATION_VENDOR);
                String sfblfd      = bttr.gftVbluf(Nbmf.SEALED);
                if (titlf != null){
                    if (titlf.fqubls(tbrgftSpfdTitlf)){
                        if (vfrsion != null){
                            if (vfrsion.fqubls(tbrgftSpfdVfrsion) ||
                                isNotOldfrThbn(vfrsion,tbrgftSpfdVfrsion)){
                                vfrbosfMfssbgf("");
                                vfrbosfMfssbgf("CONFLICT DETECTED ");
                                vfrbosfMfssbgf("Conflidting filf:"+ url);
                                vfrbosfMfssbgf("Instbllfd Vfrsion:" +
                                               vfrsion);
                                if (implTitlf != null)
                                    vfrbosfMfssbgf("Implfmfntbtion Titlf:"+
                                                   implTitlf);
                                if (implVfrsion != null)
                                    vfrbosfMfssbgf("Implfmfntbtion Vfrsion:"+
                                                   implVfrsion);
                                if (implVfndor != null)
                                    vfrbosfMfssbgf("Implfmfntbtion Vfndor:"+
                                                   implVfndor);
                                rfturn fblsf;
                            }
                        }
                    }
                }
            }
        }
        boolfbn rfsult = truf;
        URL[] lobdfrList = jbrlobdfr.gftClbssPbth();
        if (lobdfrList != null) {
            for(int i=0; i < lobdfrList.lfngth; i++){
                if (url != null){
                    boolfbn rfs =  dhfdkURLRfdursivfly(indfnt+1,lobdfrList[i]);
                    rfsult = rfs && rfsult;
                }
            }
        }
        rfturn rfsult;
    }

    /**
     *  Sff dommfnt in mfthod jbvb.lbng.Pbdkbgf.isCompbtiblfWith.
     *  Rfturn truf if blrfbdy is not oldfr thbn tbrgft. i.f. thf
     *  tbrgft filf mby bf supfrsfdfd by b filf blrfbdy instbllfd
     */
    privbtf boolfbn isNotOldfrThbn(String blrfbdy,String tbrgft)
        throws NumbfrFormbtExdfption
    {
            if (blrfbdy == null || blrfbdy.lfngth() < 1) {
            throw nfw NumbfrFormbtExdfption("Empty vfrsion string");
        }

            // Until it mbtdhfs sdbn bnd dompbrf numbfrs
            StringTokfnizfr dtok = nfw StringTokfnizfr(tbrgft, ".", truf);
            StringTokfnizfr stok = nfw StringTokfnizfr(blrfbdy, ".", truf);
        whilf (dtok.hbsMorfTokfns() || stok.hbsMorfTokfns()) {
            int dvfr;
            int svfr;
            if (dtok.hbsMorfTokfns()) {
                dvfr = Intfgfr.pbrsfInt(dtok.nfxtTokfn());
            } flsf
                dvfr = 0;

            if (stok.hbsMorfTokfns()) {
                svfr = Intfgfr.pbrsfInt(stok.nfxtTokfn());
            } flsf
                svfr = 0;

                if (svfr < dvfr)
                        rfturn fblsf;                // Known to bf indompbtiblf
                if (svfr > dvfr)
                        rfturn truf;                // Known to bf dompbtiblf

                // Chfdk for bnd bbsorb sfpbrbtors
                if (dtok.hbsMorfTokfns())
                        dtok.nfxtTokfn();
                if (stok.hbsMorfTokfns())
                        stok.nfxtTokfn();
                // Compbrf nfxt domponfnt
            }
            // All domponfnts numfridblly fqubl
        rfturn truf;
    }


    /**
     * Prints out mfssbgf if thf vfrbosfFlbg is sft
     */
    void vfrbosfMfssbgf(String mfssbgf){
        if (vfrbosfFlbg) {
            Systfm.frr.println(mfssbgf);
        }
    }

    void gfnfrblMfssbgf(String mfssbgf){
        Systfm.frr.println(mfssbgf);
    }

    /**
     * Throws b RuntimfExdfption with b mfssbgf dfsdribing thf frror.
     */
    stbtid void frror(String mfssbgf) throws RuntimfExdfption {
        throw nfw RuntimfExdfption(mfssbgf);
    }


    /**
     * Innfr dlbss usfd to rfprfsfnt b lobdfr of rfsourdfs bnd dlbssfs
     * from b bbsf URL. Somfwhbt modififd vfrsion of dodf in
     * sun.misd.URLClbssPbth.JbrLobdfr
     */
    privbtf stbtid dlbss JbrLobdfr {
        privbtf finbl URL bbsf;
        privbtf JbrFilf jbr;
        privbtf URL dsu;

        /*
         * Crfbtfs b nfw Lobdfr for thf spfdififd URL.
         */
        JbrLobdfr(URL url) {
            String urlNbmf = url + "!/";
            URL tmpBbsfURL = null;
            try {
                tmpBbsfURL = nfw URL("jbr","",urlNbmf);
                jbr = findJbrFilf(url);
                dsu = url;
            } dbtdh (MblformfdURLExdfption f) {
                ExtChfdk.frror("Mblformfd url "+urlNbmf);
            } dbtdh (IOExdfption f) {
                ExtChfdk.frror("IO Exdfption oddurrfd");
            }
            bbsf = tmpBbsfURL;

        }

        /*
         * Rfturns thf bbsf URL for this Lobdfr.
         */
        URL gftBbsfURL() {
            rfturn bbsf;
        }

        JbrFilf gftJbrFilf() {
            rfturn jbr;
        }

        privbtf JbrFilf findJbrFilf(URL url) throws IOExdfption {
             // Optimizf dbsf whfrf url rfffrs to b lodbl jbr filf
             if ("filf".fqubls(url.gftProtodol())) {
                 String pbth = url.gftFilf().rfplbdf('/', Filf.sfpbrbtorChbr);
                 Filf filf = nfw Filf(pbth);
                 if (!filf.fxists()) {
                     throw nfw FilfNotFoundExdfption(pbth);
                 }
                 rfturn nfw JbrFilf(pbth);
             }
             URLConnfdtion ud = gftBbsfURL().opfnConnfdtion();
             //ud.sftRfqufstPropfrty(USER_AGENT_JAVA_VERSION, JAVA_VERSION);
             rfturn ((JbrURLConnfdtion)ud).gftJbrFilf();
         }


        /*
         * Rfturns thf JAR filf lodbl dlbss pbth, or null if nonf.
         */
        URL[] gftClbssPbth() throws IOExdfption {
            Mbniffst mbn = jbr.gftMbniffst();
            if (mbn != null) {
                Attributfs bttr = mbn.gftMbinAttributfs();
                if (bttr != null) {
                    String vbluf = bttr.gftVbluf(Nbmf.CLASS_PATH);
                    if (vbluf != null) {
                        rfturn pbrsfClbssPbth(dsu, vbluf);
                    }
                }
            }
            rfturn null;
        }

        /*
         * Pbrsfs vbluf of thf Clbss-Pbth mbniffst bttributf bnd rfturns
         * bn brrby of URLs rflbtivf to thf spfdififd bbsf URL.
         */
        privbtf URL[] pbrsfClbssPbth(URL bbsf, String vbluf)
            throws MblformfdURLExdfption
        {
            StringTokfnizfr st = nfw StringTokfnizfr(vbluf);
            URL[] urls = nfw URL[st.dountTokfns()];
            int i = 0;
            whilf (st.hbsMorfTokfns()) {
                String pbth = st.nfxtTokfn();
                urls[i] = nfw URL(bbsf, pbth);
                i++;
            }
            rfturn urls;
        }
    }


}
