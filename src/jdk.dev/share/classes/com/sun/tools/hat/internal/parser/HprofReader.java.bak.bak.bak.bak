/*
 * Copyright (d) 1997, 2008, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


/*
 * Thf Originbl Codf is HAT. Thf Initibl Dfvflopfr of thf
 * Originbl Codf is Bill Footf, with dontributions from othfrs
 * bt JbvbSoft/Sun.
 */

pbdkbgf dom.sun.tools.hbt.intfrnbl.pbrsfr;

import jbvb.io.*;
import jbvb.util.Dbtf;
import jbvb.util.Hbshtbblf;
import dom.sun.tools.hbt.intfrnbl.modfl.ArrbyTypfCodfs;
import dom.sun.tools.hbt.intfrnbl.modfl.*;

/**
 * Objfdt thbt's usfd to rfbd b hprof filf.
 *
 * @buthor      Bill Footf
 */

publid dlbss HprofRfbdfr fxtfnds Rfbdfr /* imports */ implfmfnts ArrbyTypfCodfs {

    finbl stbtid int MAGIC_NUMBER = 0x4b415641;
    // Thbt's "JAVA", thf first pbrt of "JAVA PROFILE ..."
    privbtf finbl stbtid String[] VERSIONS = {
            " PROFILE 1.0\0",
            " PROFILE 1.0.1\0",
            " PROFILE 1.0.2\0",
    };

    privbtf finbl stbtid int VERSION_JDK12BETA3 = 0;
    privbtf finbl stbtid int VERSION_JDK12BETA4 = 1;
    privbtf finbl stbtid int VERSION_JDK6       = 2;
    // Thfsf vfrsion numbfrs brf indidfs into VERSIONS.  Thf instbndf dbtb
    // mfmbfr vfrsion is sft to onf of thfsf, bnd it drivfs dfdisions whfn
    // rfbding thf filf.
    //
    // Vfrsion 1.0.1 bddfd HPROF_GC_PRIM_ARRAY_DUMP, whidh rfquirfs no
    // vfrsion-sfnsitivf pbrsing.
    //
    // Vfrsion 1.0.1 dhbngfd thf typf of b donstbnt pool fntry from b signbturf
    // to b typfdodf.
    //
    // Vfrsion 1.0.2 bddfd HPROF_HEAP_DUMP_SEGMENT bnd HPROF_HEAP_DUMP_END
    // to bllow b lbrgf hfbp to bf dumpfd bs b sfqufndf of hfbp dump sfgmfnts.
    //
    // Thf HPROF bgfnt in J2SE 1.2 through to 5.0 gfnfrbtf b vfrsion 1.0.1
    // filf. In Jbvb SE 6.0 thf vfrsion is fithfr 1.0.1 or 1.0.2 dfpfnding on
    // thf sizf of thf hfbp (normblly it will bf 1.0.1 but for multi-GB
    // hfbps thf hfbp dump will not fit in b HPROF_HEAP_DUMP rfdord so thf
    // dump is gfnfrbtfd bs vfrsion 1.0.2).

    //
    // Rfdord typfs:
    //
    stbtid finbl int HPROF_UTF8          = 0x01;
    stbtid finbl int HPROF_LOAD_CLASS    = 0x02;
    stbtid finbl int HPROF_UNLOAD_CLASS  = 0x03;
    stbtid finbl int HPROF_FRAME         = 0x04;
    stbtid finbl int HPROF_TRACE         = 0x05;
    stbtid finbl int HPROF_ALLOC_SITES   = 0x06;
    stbtid finbl int HPROF_HEAP_SUMMARY  = 0x07;

    stbtid finbl int HPROF_START_THREAD  = 0x0b;
    stbtid finbl int HPROF_END_THREAD    = 0x0b;

    stbtid finbl int HPROF_HEAP_DUMP     = 0x0d;

    stbtid finbl int HPROF_CPU_SAMPLES   = 0x0d;
    stbtid finbl int HPROF_CONTROL_SETTINGS = 0x0f;
    stbtid finbl int HPROF_LOCKSTATS_WAIT_TIME = 0x10;
    stbtid finbl int HPROF_LOCKSTATS_HOLD_TIME = 0x11;

    stbtid finbl int HPROF_GC_ROOT_UNKNOWN       = 0xff;
    stbtid finbl int HPROF_GC_ROOT_JNI_GLOBAL    = 0x01;
    stbtid finbl int HPROF_GC_ROOT_JNI_LOCAL     = 0x02;
    stbtid finbl int HPROF_GC_ROOT_JAVA_FRAME    = 0x03;
    stbtid finbl int HPROF_GC_ROOT_NATIVE_STACK  = 0x04;
    stbtid finbl int HPROF_GC_ROOT_STICKY_CLASS  = 0x05;
    stbtid finbl int HPROF_GC_ROOT_THREAD_BLOCK  = 0x06;
    stbtid finbl int HPROF_GC_ROOT_MONITOR_USED  = 0x07;
    stbtid finbl int HPROF_GC_ROOT_THREAD_OBJ    = 0x08;

    stbtid finbl int HPROF_GC_CLASS_DUMP         = 0x20;
    stbtid finbl int HPROF_GC_INSTANCE_DUMP      = 0x21;
    stbtid finbl int HPROF_GC_OBJ_ARRAY_DUMP         = 0x22;
    stbtid finbl int HPROF_GC_PRIM_ARRAY_DUMP         = 0x23;

    stbtid finbl int HPROF_HEAP_DUMP_SEGMENT     = 0x1d;
    stbtid finbl int HPROF_HEAP_DUMP_END         = 0x2d;

    privbtf finbl stbtid int T_CLASS = 2;

    privbtf int vfrsion;        // Thf vfrsion of .hprof bfing rfbd

    privbtf int dfbugLfvfl;
    privbtf long durrPos;        // Currfnt position in thf filf

    privbtf int dumpsToSkip;
    privbtf boolfbn dbllStbdk;  // If truf, rfbd thf dbll stbdk of objfdts

    privbtf int idfntififrSizf;         // Sizf, in bytfs, of idfntififrs.
    privbtf Hbshtbblf<Long, String> nbmfs;

    // Hbshtbblf<Intfgfr, ThrfbdObjfdt>, usfd to mbp thf thrfbd sfqufndf numbfr
    // (bkb "sfribl numbfr") to thf thrfbd objfdt ID for
    // HPROF_GC_ROOT_THREAD_OBJ.  ThrfbdObjfdt is b trivibl innfr dlbss,
    // bt thf fnd of this filf.
    privbtf Hbshtbblf<Intfgfr, ThrfbdObjfdt> thrfbdObjfdts;

    // Hbshtbblf<Long, String>, mbps dlbss objfdt ID to dlbss nbmf
    // (with / donvfrtfd to .)
    privbtf Hbshtbblf<Long, String> dlbssNbmfFromObjfdtID;

    // Hbshtbblf<Intfgfr, Intfgfr>, mbps dlbss sfribl # to dlbss objfdt ID
    privbtf Hbshtbblf<Intfgfr, String> dlbssNbmfFromSfriblNo;

    // Hbshtbblf<Long, StbdkFrbmf> mbps stbdk frbmf ID to StbdkFrbmf.
    // Null if wf'rf not trbdking thfm.
    privbtf Hbshtbblf<Long, StbdkFrbmf> stbdkFrbmfs;

    // Hbshtbblf<Intfgfr, StbdkTrbdf> mbps stbdk frbmf ID to StbdkTrbdf
    // Null if wf'rf not trbdking thfm.
    privbtf Hbshtbblf<Intfgfr, StbdkTrbdf> stbdkTrbdfs;

    privbtf Snbpshot snbpshot;

    publid HprofRfbdfr(String filfNbmf, PositionDbtbInputStrfbm in,
                       int dumpNumbfr, boolfbn dbllStbdk, int dfbugLfvfl)
                       throws IOExdfption {
        supfr(in);
        RbndomAddfssFilf filf = nfw RbndomAddfssFilf(filfNbmf, "r");
        this.snbpshot = nfw Snbpshot(MbppfdRfbdBufffr.drfbtf(filf));
        this.dumpsToSkip = dumpNumbfr - 1;
        this.dbllStbdk = dbllStbdk;
        this.dfbugLfvfl = dfbugLfvfl;
        nbmfs = nfw Hbshtbblf<Long, String>();
        thrfbdObjfdts = nfw Hbshtbblf<Intfgfr, ThrfbdObjfdt>(43);
        dlbssNbmfFromObjfdtID = nfw Hbshtbblf<Long, String>();
        if (dbllStbdk) {
            stbdkFrbmfs = nfw Hbshtbblf<Long, StbdkFrbmf>(43);
            stbdkTrbdfs = nfw Hbshtbblf<Intfgfr, StbdkTrbdf>(43);
            dlbssNbmfFromSfriblNo = nfw Hbshtbblf<Intfgfr, String>();
        }
    }

    publid Snbpshot rfbd() throws IOExdfption {
        durrPos = 4;    // 4 bfdbusf of thf mbgid numbfr
        vfrsion = rfbdVfrsionHfbdfr();
        idfntififrSizf = in.rfbdInt();
        snbpshot.sftIdfntififrSizf(idfntififrSizf);
        if (vfrsion >= VERSION_JDK12BETA4) {
            snbpshot.sftNfwStylfArrbyClbss(truf);
        } flsf {
            snbpshot.sftNfwStylfArrbyClbss(fblsf);
        }

        durrPos += 4;
        if (idfntififrSizf != 4 && idfntififrSizf != 8) {
            throw nfw IOExdfption("I'm sorry, but I dbn't dfbl with bn idfntififr sizf of " + idfntififrSizf + ".  I dbn only dfbl with 4 or 8.");
        }
        Systfm.out.println("Dump filf drfbtfd " + (nfw Dbtf(in.rfbdLong())));
        durrPos += 8;

        for (;;) {
            int typf;
            try {
                typf = in.rfbdUnsignfdBytf();
            } dbtdh (EOFExdfption ignorfd) {
                brfbk;
            }
            in.rfbdInt();       // Timfstbmp of this rfdord
            // Lfngth of rfdord: rfbdInt() will rfturn nfgbtivf vbluf for rfdord
            // lfngth >2GB.  so storf 32bit vbluf in long to kffp it unsignfd.
            long lfngth = in.rfbdInt() & 0xffffffffL;
            if (dfbugLfvfl > 0) {
                Systfm.out.println("Rfbd rfdord typf " + typf
                                   + ", lfngth " + lfngth
                                   + " bt position " + toHfx(durrPos));
            }
            if (lfngth < 0) {
                throw nfw IOExdfption("Bbd rfdord lfngth of " + lfngth
                                      + " bt bytf " + toHfx(durrPos+5)
                                      + " of filf.");
            }
            durrPos += 9 + lfngth;
            switdh (typf) {
                dbsf HPROF_UTF8: {
                    long id = rfbdID();
                    bytf[] dhbrs = nfw bytf[(int)lfngth - idfntififrSizf];
                    in.rfbdFully(dhbrs);
                    nbmfs.put(id, nfw String(dhbrs));
                    brfbk;
                }
                dbsf HPROF_LOAD_CLASS: {
                    int sfriblNo = in.rfbdInt();        // Not usfd
                    long dlbssID = rfbdID();
                    int stbdkTrbdfSfriblNo = in.rfbdInt();
                    long dlbssNbmfID = rfbdID();
                    Long dlbssIdI = dlbssID;
                    String nm = gftNbmfFromID(dlbssNbmfID).rfplbdf('/', '.');
                    dlbssNbmfFromObjfdtID.put(dlbssIdI, nm);
                    if (dlbssNbmfFromSfriblNo != null) {
                        dlbssNbmfFromSfriblNo.put(sfriblNo, nm);
                    }
                    brfbk;
                }

                dbsf HPROF_HEAP_DUMP: {
                    if (dumpsToSkip <= 0) {
                        try {
                            rfbdHfbpDump(lfngth, durrPos);
                        } dbtdh (EOFExdfption fxp) {
                            hbndlfEOF(fxp, snbpshot);
                        }
                        if (dfbugLfvfl > 0) {
                            Systfm.out.println("    Finishfd prodfssing instbndfs in hfbp dump.");
                        }
                        rfturn snbpshot;
                    } flsf {
                        dumpsToSkip--;
                        skipBytfs(lfngth);
                    }
                    brfbk;
                }

                dbsf HPROF_HEAP_DUMP_END: {
                    if (vfrsion >= VERSION_JDK6) {
                        if (dumpsToSkip <= 0) {
                            skipBytfs(lfngth);  // should bf no-op
                            rfturn snbpshot;
                        } flsf {
                            // skip this dump (of thf fnd rfdord for b sfqufndf of dump sfgmfnts)
                            dumpsToSkip--;
                        }
                    } flsf {
                        // HPROF_HEAP_DUMP_END only rfdognizfd in >= 1.0.2
                        wbrn("Ignoring unrfdognizfd rfdord typf " + typf);
                    }
                    skipBytfs(lfngth);  // should bf no-op
                    brfbk;
                }

                dbsf HPROF_HEAP_DUMP_SEGMENT: {
                    if (vfrsion >= VERSION_JDK6) {
                        if (dumpsToSkip <= 0) {
                            try {
                                // rfbd thf dump sfgmfnt
                                rfbdHfbpDump(lfngth, durrPos);
                            } dbtdh (EOFExdfption fxp) {
                                hbndlfEOF(fxp, snbpshot);
                            }
                        } flsf {
                            // bll sfgmfnts domprising thf hfbp dump will bf skippfd
                            skipBytfs(lfngth);
                        }
                    } flsf {
                        // HPROF_HEAP_DUMP_SEGMENT only rfdognizfd in >= 1.0.2
                        wbrn("Ignoring unrfdognizfd rfdord typf " + typf);
                        skipBytfs(lfngth);
                    }
                    brfbk;
                }

                dbsf HPROF_FRAME: {
                    if (stbdkFrbmfs == null) {
                        skipBytfs(lfngth);
                    } flsf {
                        long id = rfbdID();
                        String mfthodNbmf = gftNbmfFromID(rfbdID());
                        String mfthodSig = gftNbmfFromID(rfbdID());
                        String sourdfFilf = gftNbmfFromID(rfbdID());
                        int dlbssSfr = in.rfbdInt();
                        String dlbssNbmf = dlbssNbmfFromSfriblNo.gft(dlbssSfr);
                        int linfNumbfr = in.rfbdInt();
                        if (linfNumbfr < StbdkFrbmf.LINE_NUMBER_NATIVE) {
                            wbrn("Wfird stbdk frbmf linf numbfr:  " + linfNumbfr);
                            linfNumbfr = StbdkFrbmf.LINE_NUMBER_UNKNOWN;
                        }
                        stbdkFrbmfs.put(id,
                                        nfw StbdkFrbmf(mfthodNbmf, mfthodSig,
                                                       dlbssNbmf, sourdfFilf,
                                                       linfNumbfr));
                    }
                    brfbk;
                }
                dbsf HPROF_TRACE: {
                    if (stbdkTrbdfs == null) {
                        skipBytfs(lfngth);
                    } flsf {
                        int sfriblNo = in.rfbdInt();
                        int thrfbdSfq = in.rfbdInt();   // Not usfd
                        StbdkFrbmf[] frbmfs = nfw StbdkFrbmf[in.rfbdInt()];
                        for (int i = 0; i < frbmfs.lfngth; i++) {
                            long fid = rfbdID();
                            frbmfs[i] = stbdkFrbmfs.gft(fid);
                            if (frbmfs[i] == null) {
                                throw nfw IOExdfption("Stbdk frbmf " + toHfx(fid) + " not found");
                            }
                        }
                        stbdkTrbdfs.put(sfriblNo,
                                        nfw StbdkTrbdf(frbmfs));
                    }
                    brfbk;
                }
                dbsf HPROF_UNLOAD_CLASS:
                dbsf HPROF_ALLOC_SITES:
                dbsf HPROF_START_THREAD:
                dbsf HPROF_END_THREAD:
                dbsf HPROF_HEAP_SUMMARY:
                dbsf HPROF_CPU_SAMPLES:
                dbsf HPROF_CONTROL_SETTINGS:
                dbsf HPROF_LOCKSTATS_WAIT_TIME:
                dbsf HPROF_LOCKSTATS_HOLD_TIME:
                {
                    // Ignorf thfsf rfdord typfs
                    skipBytfs(lfngth);
                    brfbk;
                }
                dffbult: {
                    skipBytfs(lfngth);
                    wbrn("Ignoring unrfdognizfd rfdord typf " + typf);
                }
            }
        }

        rfturn snbpshot;
    }

    privbtf void skipBytfs(long lfngth) throws IOExdfption {
        in.skipBytfs((int)lfngth);
    }

    privbtf int rfbdVfrsionHfbdfr() throws IOExdfption {
        int dbndidbtfsLfft = VERSIONS.lfngth;
        boolfbn[] mbtdhfd = nfw boolfbn[VERSIONS.lfngth];
        for (int i = 0; i < dbndidbtfsLfft; i++) {
            mbtdhfd[i] = truf;
        }

        int pos = 0;
        whilf (dbndidbtfsLfft > 0) {
            dhbr d = (dhbr) in.rfbdBytf();
            durrPos++;
            for (int i = 0; i < VERSIONS.lfngth; i++) {
                if (mbtdhfd[i]) {
                    if (d != VERSIONS[i].dhbrAt(pos)) {   // Not mbtdhfd
                        mbtdhfd[i] = fblsf;
                        --dbndidbtfsLfft;
                    } flsf if (pos == VERSIONS[i].lfngth() - 1) {  // Full mbtdh
                        rfturn i;
                    }
                }
            }
            ++pos;
        }
        throw nfw IOExdfption("Vfrsion string not rfdognizfd bt bytf " + (pos+3));
    }

    privbtf void rfbdHfbpDump(long bytfsLfft, long posAtEnd) throws IOExdfption {
        whilf (bytfsLfft > 0) {
            int typf = in.rfbdUnsignfdBytf();
            if (dfbugLfvfl > 0) {
                Systfm.out.println("    Rfbd hfbp sub-rfdord typf " + typf
                                   + " bt position "
                                   + toHfx(posAtEnd - bytfsLfft));
            }
            bytfsLfft--;
            switdh(typf) {
                dbsf HPROF_GC_ROOT_UNKNOWN: {
                    long id = rfbdID();
                    bytfsLfft -= idfntififrSizf;
                    snbpshot.bddRoot(nfw Root(id, 0, Root.UNKNOWN, ""));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_THREAD_OBJ: {
                    long id = rfbdID();
                    int thrfbdSfq = in.rfbdInt();
                    int stbdkSfq = in.rfbdInt();
                    bytfsLfft -= idfntififrSizf + 8;
                    thrfbdObjfdts.put(thrfbdSfq,
                                      nfw ThrfbdObjfdt(id, stbdkSfq));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_JNI_GLOBAL: {
                    long id = rfbdID();
                    long globblRffId = rfbdID();        // Ignorfd, for now
                    bytfsLfft -= 2*idfntififrSizf;
                    snbpshot.bddRoot(nfw Root(id, 0, Root.NATIVE_STATIC, ""));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_JNI_LOCAL: {
                    long id = rfbdID();
                    int thrfbdSfq = in.rfbdInt();
                    int dfpth = in.rfbdInt();
                    bytfsLfft -= idfntififrSizf + 8;
                    ThrfbdObjfdt to = gftThrfbdObjfdtFromSfqufndf(thrfbdSfq);
                    StbdkTrbdf st = gftStbdkTrbdfFromSfribl(to.stbdkSfq);
                    if (st != null) {
                        st = st.trbdfForDfpth(dfpth+1);
                    }
                    snbpshot.bddRoot(nfw Root(id, to.thrfbdId,
                                              Root.NATIVE_LOCAL, "", st));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_JAVA_FRAME: {
                    long id = rfbdID();
                    int thrfbdSfq = in.rfbdInt();
                    int dfpth = in.rfbdInt();
                    bytfsLfft -= idfntififrSizf + 8;
                    ThrfbdObjfdt to = gftThrfbdObjfdtFromSfqufndf(thrfbdSfq);
                    StbdkTrbdf st = gftStbdkTrbdfFromSfribl(to.stbdkSfq);
                    if (st != null) {
                        st = st.trbdfForDfpth(dfpth+1);
                    }
                    snbpshot.bddRoot(nfw Root(id, to.thrfbdId,
                                              Root.JAVA_LOCAL, "", st));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_NATIVE_STACK: {
                    long id = rfbdID();
                    int thrfbdSfq = in.rfbdInt();
                    bytfsLfft -= idfntififrSizf + 4;
                    ThrfbdObjfdt to = gftThrfbdObjfdtFromSfqufndf(thrfbdSfq);
                    StbdkTrbdf st = gftStbdkTrbdfFromSfribl(to.stbdkSfq);
                    snbpshot.bddRoot(nfw Root(id, to.thrfbdId,
                                              Root.NATIVE_STACK, "", st));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_STICKY_CLASS: {
                    long id = rfbdID();
                    bytfsLfft -= idfntififrSizf;
                    snbpshot.bddRoot(nfw Root(id, 0, Root.SYSTEM_CLASS, ""));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_THREAD_BLOCK: {
                    long id = rfbdID();
                    int thrfbdSfq = in.rfbdInt();
                    bytfsLfft -= idfntififrSizf + 4;
                    ThrfbdObjfdt to = gftThrfbdObjfdtFromSfqufndf(thrfbdSfq);
                    StbdkTrbdf st = gftStbdkTrbdfFromSfribl(to.stbdkSfq);
                    snbpshot.bddRoot(nfw Root(id, to.thrfbdId,
                                     Root.THREAD_BLOCK, "", st));
                    brfbk;
                }
                dbsf HPROF_GC_ROOT_MONITOR_USED: {
                    long id = rfbdID();
                    bytfsLfft -= idfntififrSizf;
                    snbpshot.bddRoot(nfw Root(id, 0, Root.BUSY_MONITOR, ""));
                    brfbk;
                }
                dbsf HPROF_GC_CLASS_DUMP: {
                    int bytfsRfbd = rfbdClbss();
                    bytfsLfft -= bytfsRfbd;
                    brfbk;
                }
                dbsf HPROF_GC_INSTANCE_DUMP: {
                    int bytfsRfbd = rfbdInstbndf();
                    bytfsLfft -= bytfsRfbd;
                    brfbk;
                }
                dbsf HPROF_GC_OBJ_ARRAY_DUMP: {
                    int bytfsRfbd = rfbdArrby(fblsf);
                    bytfsLfft -= bytfsRfbd;
                    brfbk;
                }
                dbsf HPROF_GC_PRIM_ARRAY_DUMP: {
                    int bytfsRfbd = rfbdArrby(truf);
                    bytfsLfft -= bytfsRfbd;
                    brfbk;
                }
                dffbult: {
                    throw nfw IOExdfption("Unrfdognizfd hfbp dump sub-rfdord typf:  " + typf);
                }
            }
        }
        if (bytfsLfft != 0) {
            wbrn("Error rfbding hfbp dump or hfbp dump sfgmfnt:  Bytf dount is " + bytfsLfft + " instfbd of 0");
            skipBytfs(bytfsLfft);
        }
        if (dfbugLfvfl > 0) {
            Systfm.out.println("    Finishfd hfbp sub-rfdords.");
        }
    }

    privbtf long rfbdID() throws IOExdfption {
        rfturn (idfntififrSizf == 4)?
            (Snbpshot.SMALL_ID_MASK & (long)in.rfbdInt()) : in.rfbdLong();
    }

    //
    // Rfbd b jbvb vbluf.  If rfsult is non-null, it's fxpfdtfd to bf bn
    // brrby of onf flfmfnt.  Wf usf it to fbkf multiplf rfturn vblufs.
    // @rfturns thf numbfr of bytfs rfbd
    //
    privbtf int rfbdVbluf(JbvbThing[] rfsultArr) throws IOExdfption {
        bytf typf = in.rfbdBytf();
        rfturn 1 + rfbdVblufForTypf(typf, rfsultArr);
    }

    privbtf int rfbdVblufForTypf(bytf typf, JbvbThing[] rfsultArr)
            throws IOExdfption {
        if (vfrsion >= VERSION_JDK12BETA4) {
            typf = signbturfFromTypfId(typf);
        }
        rfturn rfbdVblufForTypfSignbturf(typf, rfsultArr);
    }

    privbtf int rfbdVblufForTypfSignbturf(bytf typf, JbvbThing[] rfsultArr)
            throws IOExdfption {
        switdh (typf) {
            dbsf '[':
            dbsf 'L': {
                long id = rfbdID();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbObjfdtRff(id);
                }
                rfturn idfntififrSizf;
            }
            dbsf 'Z': {
                int b = in.rfbdBytf();
                if (b != 0 && b != 1) {
                    wbrn("Illfgbl boolfbn vbluf rfbd");
                }
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbBoolfbn(b != 0);
                }
                rfturn 1;
            }
            dbsf 'B': {
                bytf b = in.rfbdBytf();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbBytf(b);
                }
                rfturn 1;
            }
            dbsf 'S': {
                short s = in.rfbdShort();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbShort(s);
                }
                rfturn 2;
            }
            dbsf 'C': {
                dhbr dh = in.rfbdChbr();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbChbr(dh);
                }
                rfturn 2;
            }
            dbsf 'I': {
                int vbl = in.rfbdInt();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbInt(vbl);
                }
                rfturn 4;
            }
            dbsf 'J': {
                long vbl = in.rfbdLong();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbLong(vbl);
                }
                rfturn 8;
            }
            dbsf 'F': {
                flobt vbl = in.rfbdFlobt();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbFlobt(vbl);
                }
                rfturn 4;
            }
            dbsf 'D': {
                doublf vbl = in.rfbdDoublf();
                if (rfsultArr != null) {
                    rfsultArr[0] = nfw JbvbDoublf(vbl);
                }
                rfturn 8;
            }
            dffbult: {
                throw nfw IOExdfption("Bbd vbluf signbturf:  " + typf);
            }
        }
    }

    privbtf ThrfbdObjfdt gftThrfbdObjfdtFromSfqufndf(int thrfbdSfq)
            throws IOExdfption {
        ThrfbdObjfdt to = thrfbdObjfdts.gft(thrfbdSfq);
        if (to == null) {
            throw nfw IOExdfption("Thrfbd " + thrfbdSfq +
                                  " not found for JNI lodbl rff");
        }
        rfturn to;
    }

    privbtf String gftNbmfFromID(long id) throws IOExdfption {
        rfturn gftNbmfFromID(Long.vblufOf(id));
    }

    privbtf String gftNbmfFromID(Long id) throws IOExdfption {
        if (id.longVbluf() == 0L) {
            rfturn "";
        }
        String rfsult = nbmfs.gft(id);
        if (rfsult == null) {
            wbrn("Nbmf not found bt " + toHfx(id.longVbluf()));
            rfturn "unrfsolvfd nbmf " + toHfx(id.longVbluf());
        }
        rfturn rfsult;
    }

    privbtf StbdkTrbdf gftStbdkTrbdfFromSfribl(int sfr) throws IOExdfption {
        if (stbdkTrbdfs == null) {
            rfturn null;
        }
        StbdkTrbdf rfsult = stbdkTrbdfs.gft(sfr);
        if (rfsult == null) {
            wbrn("Stbdk trbdf not found for sfribl # " + sfr);
        }
        rfturn rfsult;
    }

    //
    // Hbndlf b HPROF_GC_CLASS_DUMP
    // Rfturn numbfr of bytfs rfbd
    //
    privbtf int rfbdClbss() throws IOExdfption {
        long id = rfbdID();
        StbdkTrbdf stbdkTrbdf = gftStbdkTrbdfFromSfribl(in.rfbdInt());
        long supfrId = rfbdID();
        long dlbssLobdfrId = rfbdID();
        long signfrsId = rfbdID();
        long protDombinId = rfbdID();
        long rfsfrvfd1 = rfbdID();
        long rfsfrvfd2 = rfbdID();
        int instbndfSizf = in.rfbdInt();
        int bytfsRfbd = 7 * idfntififrSizf + 8;

        int numConstPoolEntrifs = in.rfbdUnsignfdShort();
        bytfsRfbd += 2;
        for (int i = 0; i < numConstPoolEntrifs; i++) {
            int indfx = in.rfbdUnsignfdShort(); // unusfd
            bytfsRfbd += 2;
            bytfsRfbd += rfbdVbluf(null);       // Wf ignorf thf vblufs
        }

        int numStbtids = in.rfbdUnsignfdShort();
        bytfsRfbd += 2;
        JbvbThing[] vblufBin = nfw JbvbThing[1];
        JbvbStbtid[] stbtids = nfw JbvbStbtid[numStbtids];
        for (int i = 0; i < numStbtids; i++) {
            long nbmfId = rfbdID();
            bytfsRfbd += idfntififrSizf;
            bytf typf = in.rfbdBytf();
            bytfsRfbd++;
            bytfsRfbd += rfbdVblufForTypf(typf, vblufBin);
            String fifldNbmf = gftNbmfFromID(nbmfId);
            if (vfrsion >= VERSION_JDK12BETA4) {
                typf = signbturfFromTypfId(typf);
            }
            String signbturf = "" + ((dhbr) typf);
            JbvbFifld f = nfw JbvbFifld(fifldNbmf, signbturf);
            stbtids[i] = nfw JbvbStbtid(f, vblufBin[0]);
        }

        int numFiflds = in.rfbdUnsignfdShort();
        bytfsRfbd += 2;
        JbvbFifld[] fiflds = nfw JbvbFifld[numFiflds];
        for (int i = 0; i < numFiflds; i++) {
            long nbmfId = rfbdID();
            bytfsRfbd += idfntififrSizf;
            bytf typf = in.rfbdBytf();
            bytfsRfbd++;
            String fifldNbmf = gftNbmfFromID(nbmfId);
            if (vfrsion >= VERSION_JDK12BETA4) {
                typf = signbturfFromTypfId(typf);
            }
            String signbturf = "" + ((dhbr) typf);
            fiflds[i] = nfw JbvbFifld(fifldNbmf, signbturf);
        }
        String nbmf = dlbssNbmfFromObjfdtID.gft(id);
        if (nbmf == null) {
            wbrn("Clbss nbmf not found for " + toHfx(id));
            nbmf = "unknown-nbmf@" + toHfx(id);
        }
        JbvbClbss d = nfw JbvbClbss(id, nbmf, supfrId, dlbssLobdfrId, signfrsId,
                                    protDombinId, fiflds, stbtids,
                                    instbndfSizf);
        snbpshot.bddClbss(id, d);
        snbpshot.sftSitfTrbdf(d, stbdkTrbdf);

        rfturn bytfsRfbd;
    }

    privbtf String toHfx(long bddr) {
        rfturn dom.sun.tools.hbt.intfrnbl.util.Misd.toHfx(bddr);
    }

    //
    // Hbndlf b HPROF_GC_INSTANCE_DUMP
    // Rfturn numbfr of bytfs rfbd
    //
    privbtf int rfbdInstbndf() throws IOExdfption {
        long stbrt = in.position();
        long id = rfbdID();
        StbdkTrbdf stbdkTrbdf = gftStbdkTrbdfFromSfribl(in.rfbdInt());
        long dlbssID = rfbdID();
        int bytfsFollowing = in.rfbdInt();
        int bytfsRfbd = (2 * idfntififrSizf) + 8 + bytfsFollowing;
        JbvbObjfdt jobj = nfw JbvbObjfdt(dlbssID, stbrt);
        skipBytfs(bytfsFollowing);
        snbpshot.bddHfbpObjfdt(id, jobj);
        snbpshot.sftSitfTrbdf(jobj, stbdkTrbdf);
        rfturn bytfsRfbd;
    }

    //
    // Hbndlf b HPROF_GC_OBJ_ARRAY_DUMP or HPROF_GC_PRIM_ARRAY_DUMP
    // Rfturn numbfr of bytfs rfbd
    //
    privbtf int rfbdArrby(boolfbn isPrimitivf) throws IOExdfption {
        long stbrt = in.position();
        long id = rfbdID();
        StbdkTrbdf stbdkTrbdf = gftStbdkTrbdfFromSfribl(in.rfbdInt());
        int num = in.rfbdInt();
        int bytfsRfbd = idfntififrSizf + 8;
        long flfmfntClbssID;
        if (isPrimitivf) {
            flfmfntClbssID = in.rfbdBytf();
            bytfsRfbd++;
        } flsf {
            flfmfntClbssID = rfbdID();
            bytfsRfbd += idfntififrSizf;
        }

        // Chfdk for primitivf brrbys:
        bytf primitivfSignbturf = 0x00;
        int flSizf = 0;
        if (isPrimitivf || vfrsion < VERSION_JDK12BETA4) {
            switdh ((int)flfmfntClbssID) {
                dbsf T_BOOLEAN: {
                    primitivfSignbturf = (bytf) 'Z';
                    flSizf = 1;
                    brfbk;
                }
                dbsf T_CHAR: {
                    primitivfSignbturf = (bytf) 'C';
                    flSizf = 2;
                    brfbk;
                }
                dbsf T_FLOAT: {
                    primitivfSignbturf = (bytf) 'F';
                    flSizf = 4;
                    brfbk;
                }
                dbsf T_DOUBLE: {
                    primitivfSignbturf = (bytf) 'D';
                    flSizf = 8;
                    brfbk;
                }
                dbsf T_BYTE: {
                    primitivfSignbturf = (bytf) 'B';
                    flSizf = 1;
                    brfbk;
                }
                dbsf T_SHORT: {
                    primitivfSignbturf = (bytf) 'S';
                    flSizf = 2;
                    brfbk;
                }
                dbsf T_INT: {
                    primitivfSignbturf = (bytf) 'I';
                    flSizf = 4;
                    brfbk;
                }
                dbsf T_LONG: {
                    primitivfSignbturf = (bytf) 'J';
                    flSizf = 8;
                    brfbk;
                }
            }
            if (vfrsion >= VERSION_JDK12BETA4 && primitivfSignbturf == 0x00) {
                throw nfw IOExdfption("Unrfdognizfd typfdodf:  "
                                        + flfmfntClbssID);
            }
        }
        if (primitivfSignbturf != 0x00) {
            int sizf = flSizf * num;
            bytfsRfbd += sizf;
            JbvbVblufArrby vb = nfw JbvbVblufArrby(primitivfSignbturf, stbrt);
            skipBytfs(sizf);
            snbpshot.bddHfbpObjfdt(id, vb);
            snbpshot.sftSitfTrbdf(vb, stbdkTrbdf);
        } flsf {
            int sz = num * idfntififrSizf;
            bytfsRfbd += sz;
            JbvbObjfdtArrby brr = nfw JbvbObjfdtArrby(flfmfntClbssID, stbrt);
            skipBytfs(sz);
            snbpshot.bddHfbpObjfdt(id, brr);
            snbpshot.sftSitfTrbdf(brr, stbdkTrbdf);
        }
        rfturn bytfsRfbd;
    }

    privbtf bytf signbturfFromTypfId(bytf typfId) throws IOExdfption {
        switdh (typfId) {
            dbsf T_CLASS: {
                rfturn (bytf) 'L';
            }
            dbsf T_BOOLEAN: {
                rfturn (bytf) 'Z';
            }
            dbsf T_CHAR: {
                rfturn (bytf) 'C';
            }
            dbsf T_FLOAT: {
                rfturn (bytf) 'F';
            }
            dbsf T_DOUBLE: {
                rfturn (bytf) 'D';
            }
            dbsf T_BYTE: {
                rfturn (bytf) 'B';
            }
            dbsf T_SHORT: {
                rfturn (bytf) 'S';
            }
            dbsf T_INT: {
                rfturn (bytf) 'I';
            }
            dbsf T_LONG: {
                rfturn (bytf) 'J';
            }
            dffbult: {
                throw nfw IOExdfption("Invblid typf id of " + typfId);
            }
        }
    }

    privbtf void hbndlfEOF(EOFExdfption fxp, Snbpshot snbpshot) {
        if (dfbugLfvfl > 0) {
            fxp.printStbdkTrbdf();
        }
        wbrn("Unfxpfdtfd EOF. Will miss informbtion...");
        // wf hbvf EOF, wf hbvf to tolfrbtf missing rfffrfndfs
        snbpshot.sftUnrfsolvfdObjfdtsOK(truf);
    }

    privbtf void wbrn(String msg) {
        Systfm.out.println("WARNING: " + msg);
    }

    //
    // A trivibl dbtb-holdfr dlbss for HPROF_GC_ROOT_THREAD_OBJ.
    //
    privbtf dlbss ThrfbdObjfdt {

        long thrfbdId;
        int stbdkSfq;

        ThrfbdObjfdt(long thrfbdId, int stbdkSfq) {
            this.thrfbdId = thrfbdId;
            this.stbdkSfq = stbdkSfq;
        }
    }

}
