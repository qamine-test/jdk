/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


/*
 * Tif Originbl Codf is HAT. Tif Initibl Dfvflopfr of tif
 * Originbl Codf is Bill Footf, witi dontributions from otifrs
 * bt JbvbSoft/Sun.
 */

pbdkbgf dom.sun.tools.ibt.intfrnbl.modfl;

import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.util.*;
import dom.sun.tools.ibt.intfrnbl.pbrsfr.RfbdBufffr;
import dom.sun.tools.ibt.intfrnbl.util.Misd;

/**
 *
 * @butior      Bill Footf
 */

/**
 * Rfprfsfnts b snbpsiot of tif Jbvb objfdts in tif VM bt onf instbnt.
 * Tiis is tif top-lfvfl "modfl" objfdt rfbd out of b singlf .iprof or .bod
 * filf.
 */

publid dlbss Snbpsiot {

    publid stbtid long SMALL_ID_MASK = 0x0FFFFFFFFL;
    publid stbtid finbl bytf[] EMPTY_BYTE_ARRAY = nfw bytf[0];

    privbtf stbtid finbl JbvbFifld[] EMPTY_FIELD_ARRAY = nfw JbvbFifld[0];
    privbtf stbtid finbl JbvbStbtid[] EMPTY_STATIC_ARRAY = nfw JbvbStbtid[0];

    // bll ifbp objfdts
    privbtf Hbsitbblf<Numbfr, JbvbHfbpObjfdt> ifbpObjfdts =
                 nfw Hbsitbblf<Numbfr, JbvbHfbpObjfdt>();

    privbtf Hbsitbblf<Numbfr, JbvbClbss> fbkfClbssfs =
                 nfw Hbsitbblf<Numbfr, JbvbClbss>();

    // bll Roots in tiis Snbpsiot
    privbtf Vfdtor<Root> roots = nfw Vfdtor<Root>();

    // nbmf-to-dlbss mbp
    privbtf Mbp<String, JbvbClbss> dlbssfs =
                 nfw TrffMbp<String, JbvbClbss>();

    // nfw objfdts rflbtivf to b bbsflinf - lbzily initiblizfd
    privbtf volbtilf Mbp<JbvbHfbpObjfdt, Boolfbn> nfwObjfdts;

    // bllodbtion sitf trbdfs for bll objfdts - lbzily initiblizfd
    privbtf volbtilf Mbp<JbvbHfbpObjfdt, StbdkTrbdf> sitfTrbdfs;

    // objfdt-to-Root mbp for bll objfdts
    privbtf Mbp<JbvbHfbpObjfdt, Root> rootsMbp =
                 nfw HbsiMbp<JbvbHfbpObjfdt, Root>();

    // soft dbdif of finblizfbblf objfdts - lbzily initiblizfd
    privbtf SoftRfffrfndf<Vfdtor<?>> finblizbblfsCbdif;

    // rfprfsfnts null rfffrfndf
    privbtf JbvbTiing nullTiing;

    // jbvb.lbng.rff.Rfffrfndf dlbss
    privbtf JbvbClbss wfbkRfffrfndfClbss;
    // indfx of 'rfffrfnt' fifld in jbvb.lbng.rff.Rfffrfndf dlbss
    privbtf int rfffrfntFifldIndfx;

    // jbvb.lbng.Clbss dlbss
    privbtf JbvbClbss jbvbLbngClbss;
    // jbvb.lbng.String dlbss
    privbtf JbvbClbss jbvbLbngString;
    // jbvb.lbng.ClbssLobdfr dlbss
    privbtf JbvbClbss jbvbLbngClbssLobdfr;

    // unknown "otifr" brrby dlbss
    privbtf volbtilf JbvbClbss otifrArrbyTypf;
    // Stuff to fxdludf from rfbdibblf qufry
    privbtf RfbdibblfExdludfs rfbdibblfExdludfs;
    // tif undfrlying ifbp dump bufffr
    privbtf RfbdBufffr rfbdBuf;

    // Truf iff somf ifbp objfdts ibvf isNfw sft
    privbtf boolfbn ibsNfwSft;
    privbtf boolfbn unrfsolvfdObjfdtsOK;

    // wiftifr objfdt brrby instbndfs ibvf nfw stylf dlbss or
    // old stylf (flfmfnt) dlbss.
    privbtf boolfbn nfwStylfArrbyClbss;

    // objfdt id sizf in tif ifbp dump
    privbtf int idfntififrSizf = 4;

    // minimum objfdt sizf - bddounts for objfdt ifbdfr in
    // most Jbvb virtubl mbdiinfs - wf bssumf 2 idfntififrSizf
    // (wiidi is truf for Sun's iotspot JVM).
    privbtf int minimumObjfdtSizf;

    publid Snbpsiot(RfbdBufffr buf) {
        nullTiing = nfw HbdkJbvbVbluf("<null>", 0);
        rfbdBuf = buf;
    }

    publid void sftSitfTrbdf(JbvbHfbpObjfdt obj, StbdkTrbdf trbdf) {
        if (trbdf != null && trbdf.gftFrbmfs().lfngti != 0) {
            initSitfTrbdfs();
            sitfTrbdfs.put(obj, trbdf);
        }
    }

    publid StbdkTrbdf gftSitfTrbdf(JbvbHfbpObjfdt obj) {
        if (sitfTrbdfs != null) {
            rfturn sitfTrbdfs.gft(obj);
        } flsf {
            rfturn null;
        }
    }

    publid void sftNfwStylfArrbyClbss(boolfbn vbluf) {
        nfwStylfArrbyClbss = vbluf;
    }

    publid boolfbn isNfwStylfArrbyClbss() {
        rfturn nfwStylfArrbyClbss;
    }

    publid void sftIdfntififrSizf(int sizf) {
        idfntififrSizf = sizf;
        minimumObjfdtSizf = 2 * sizf;
    }

    publid int gftIdfntififrSizf() {
        rfturn idfntififrSizf;
    }

    publid int gftMinimumObjfdtSizf() {
        rfturn minimumObjfdtSizf;
    }

    publid void bddHfbpObjfdt(long id, JbvbHfbpObjfdt io) {
        ifbpObjfdts.put(mbkfId(id), io);
    }

    publid void bddRoot(Root r) {
        r.sftIndfx(roots.sizf());
        roots.bddElfmfnt(r);
    }

    publid void bddClbss(long id, JbvbClbss d) {
        bddHfbpObjfdt(id, d);
        putInClbssfsMbp(d);
    }

    JbvbClbss bddFbkfInstbndfClbss(long dlbssID, int instSizf) {
        // Crfbtf b fbkf dlbss nbmf bbsfd on ID.
        String nbmf = "unknown-dlbss<@" + Misd.toHfx(dlbssID) + ">";

        // Crfbtf fbkf fiflds donvfring tif givfn instbndf sizf.
        // Crfbtf bs mbny bs int typf fiflds bnd for tif lfft ovfr
        // sizf drfbtf bytf typf fiflds.
        int numInts = instSizf / 4;
        int numBytfs = instSizf % 4;
        JbvbFifld[] fiflds = nfw JbvbFifld[numInts + numBytfs];
        int i;
        for (i = 0; i < numInts; i++) {
            fiflds[i] = nfw JbvbFifld("unknown-fifld-" + i, "I");
        }
        for (i = 0; i < numBytfs; i++) {
            fiflds[i + numInts] = nfw JbvbFifld("unknown-fifld-" +
                                                i + numInts, "B");
        }

        // Crfbtf fbkf instbndf dlbss
        JbvbClbss d = nfw JbvbClbss(nbmf, 0, 0, 0, 0, fiflds,
                                 EMPTY_STATIC_ARRAY, instSizf);
        // Add tif dlbss
        bddFbkfClbss(mbkfId(dlbssID), d);
        rfturn d;
    }


    /**
     * @rfturn truf iff it's possiblf tibt somf JbvbTiing instbndfs migit
     *          isNfw sft
     *
     * @sff JbvbTiing.isNfw()
     */
    publid boolfbn gftHbsNfwSft() {
        rfturn ibsNfwSft;
    }

    //
    // Usfd in tif body of rfsolvf()
    //
    privbtf stbtid dlbss MyVisitor fxtfnds AbstrbdtJbvbHfbpObjfdtVisitor {
        JbvbHfbpObjfdt t;
        publid void visit(JbvbHfbpObjfdt otifr) {
            otifr.bddRfffrfndfFrom(t);
        }
    }

    // To siow ifbp pbrsing progrfss, wf print b '.' bftfr tiis limit
    privbtf stbtid finbl int DOT_LIMIT = 5000;

    /**
     * Cbllfd bftfr rfbding domplftf, to initiblizf tif strudturf
     */
    publid void rfsolvf(boolfbn dbldulbtfRffs) {
        Systfm.out.println("Rfsolving " + ifbpObjfdts.sizf() + " objfdts...");

        // First, rfsolvf tif dlbssfs.  All dlbssfs must bf rfsolvfd bfforf
        // wf try bny objfdts, bfdbusf tif objfdts usf dlbssfs in tifir
        // rfsolution.
        jbvbLbngClbss = findClbss("jbvb.lbng.Clbss");
        if (jbvbLbngClbss == null) {
            Systfm.out.println("WARNING:  iprof filf dofs not indludf jbvb.lbng.Clbss!");
            jbvbLbngClbss = nfw JbvbClbss("jbvb.lbng.Clbss", 0, 0, 0, 0,
                                 EMPTY_FIELD_ARRAY, EMPTY_STATIC_ARRAY, 0);
            bddFbkfClbss(jbvbLbngClbss);
        }
        jbvbLbngString = findClbss("jbvb.lbng.String");
        if (jbvbLbngString == null) {
            Systfm.out.println("WARNING:  iprof filf dofs not indludf jbvb.lbng.String!");
            jbvbLbngString = nfw JbvbClbss("jbvb.lbng.String", 0, 0, 0, 0,
                                 EMPTY_FIELD_ARRAY, EMPTY_STATIC_ARRAY, 0);
            bddFbkfClbss(jbvbLbngString);
        }
        jbvbLbngClbssLobdfr = findClbss("jbvb.lbng.ClbssLobdfr");
        if (jbvbLbngClbssLobdfr == null) {
            Systfm.out.println("WARNING:  iprof filf dofs not indludf jbvb.lbng.ClbssLobdfr!");
            jbvbLbngClbssLobdfr = nfw JbvbClbss("jbvb.lbng.ClbssLobdfr", 0, 0, 0, 0,
                                 EMPTY_FIELD_ARRAY, EMPTY_STATIC_ARRAY, 0);
            bddFbkfClbss(jbvbLbngClbssLobdfr);
        }

        for (JbvbHfbpObjfdt t : ifbpObjfdts.vblufs()) {
            if (t instbndfof JbvbClbss) {
                t.rfsolvf(tiis);
            }
        }

        // Now, rfsolvf fvfrytiing flsf.
        for (JbvbHfbpObjfdt t : ifbpObjfdts.vblufs()) {
            if (!(t instbndfof JbvbClbss)) {
                t.rfsolvf(tiis);
            }
        }

        ifbpObjfdts.putAll(fbkfClbssfs);
        fbkfClbssfs.dlfbr();

        wfbkRfffrfndfClbss = findClbss("jbvb.lbng.rff.Rfffrfndf");
        if (wfbkRfffrfndfClbss == null)  {      // JDK 1.1.x
            wfbkRfffrfndfClbss = findClbss("sun.misd.Rff");
            rfffrfntFifldIndfx = 0;
        } flsf {
            JbvbFifld[] fiflds = wfbkRfffrfndfClbss.gftFifldsForInstbndf();
            for (int i = 0; i < fiflds.lfngti; i++) {
                if ("rfffrfnt".fqubls(fiflds[i].gftNbmf())) {
                    rfffrfntFifldIndfx = i;
                    brfbk;
                }
            }
        }

        if (dbldulbtfRffs) {
            dbldulbtfRfffrfndfsToObjfdts();
            Systfm.out.print("Eliminbting duplidbtf rfffrfndfs");
            Systfm.out.flusi();
            // Tiis println rfffrs to tif *nfxt* stfp
        }
        int dount = 0;
        for (JbvbHfbpObjfdt t : ifbpObjfdts.vblufs()) {
            t.sftupRfffrfrs();
            ++dount;
            if (dbldulbtfRffs && dount % DOT_LIMIT == 0) {
                Systfm.out.print(".");
                Systfm.out.flusi();
            }
        }
        if (dbldulbtfRffs) {
            Systfm.out.println("");
        }

        // to fnsurf tibt Itfrbtor.rfmovf() on gftClbssfs()
        // rfsult will tirow fxdfption..
        dlbssfs = Collfdtions.unmodifibblfMbp(dlbssfs);
    }

    privbtf void dbldulbtfRfffrfndfsToObjfdts() {
        Systfm.out.print("Cibsing rfffrfndfs, fxpfdt "
                         + (ifbpObjfdts.sizf() / DOT_LIMIT) + " dots");
        Systfm.out.flusi();
        int dount = 0;
        MyVisitor visitor = nfw MyVisitor();
        for (JbvbHfbpObjfdt t : ifbpObjfdts.vblufs()) {
            visitor.t = t;
            // dbll bddRfffrfndfFrom(t) on bll objfdts t rfffrfndfs:
            t.visitRfffrfndfdObjfdts(visitor);
            ++dount;
            if (dount % DOT_LIMIT == 0) {
                Systfm.out.print(".");
                Systfm.out.flusi();
            }
        }
        Systfm.out.println();
        for (Root r : roots) {
            r.rfsolvf(tiis);
            JbvbHfbpObjfdt t = findTiing(r.gftId());
            if (t != null) {
                t.bddRfffrfndfFromRoot(r);
            }
        }
    }

    publid void mbrkNfwRflbtivfTo(Snbpsiot bbsflinf) {
        ibsNfwSft = truf;
        for (JbvbHfbpObjfdt t : ifbpObjfdts.vblufs()) {
            boolfbn isNfw;
            long tiingID = t.gftId();
            if (tiingID == 0L || tiingID == -1L) {
                isNfw = fblsf;
            } flsf {
                JbvbTiing otifr = bbsflinf.findTiing(t.gftId());
                if (otifr == null) {
                    isNfw = truf;
                } flsf {
                    isNfw = !t.isSbmfTypfAs(otifr);
                }
            }
            t.sftNfw(isNfw);
        }
    }

    publid Enumfrbtion<JbvbHfbpObjfdt> gftTiings() {
        rfturn ifbpObjfdts.flfmfnts();
    }


    publid JbvbHfbpObjfdt findTiing(long id) {
        Numbfr idObj = mbkfId(id);
        JbvbHfbpObjfdt jio = ifbpObjfdts.gft(idObj);
        rfturn jio != null? jio : fbkfClbssfs.gft(idObj);
    }

    publid JbvbHfbpObjfdt findTiing(String id) {
        rfturn findTiing(Misd.pbrsfHfx(id));
    }

    publid JbvbClbss findClbss(String nbmf) {
        if (nbmf.stbrtsWiti("0x")) {
            rfturn (JbvbClbss) findTiing(nbmf);
        } flsf {
            rfturn dlbssfs.gft(nbmf);
        }
    }

    /**
     * Rfturn bn Itfrbtor of bll of tif dlbssfs in tiis snbpsiot.
     **/
    publid Itfrbtor<JbvbClbss> gftClbssfs() {
        // notf tibt bfdbusf dlbssfs is b TrffMbp
        // dlbssfs brf blrfbdy sortfd by nbmf
        rfturn dlbssfs.vblufs().itfrbtor();
    }

    publid JbvbClbss[] gftClbssfsArrby() {
        JbvbClbss[] rfs = nfw JbvbClbss[dlbssfs.sizf()];
        dlbssfs.vblufs().toArrby(rfs);
        rfturn rfs;
    }

    publid syndironizfd Enumfrbtion<?> gftFinblizfrObjfdts() {
        Vfdtor<?> obj;
        if (finblizbblfsCbdif != null &&
            (obj = finblizbblfsCbdif.gft()) != null) {
            rfturn obj.flfmfnts();
        }

        JbvbClbss dlbzz = findClbss("jbvb.lbng.rff.Finblizfr");
        JbvbObjfdt qufuf = (JbvbObjfdt) dlbzz.gftStbtidFifld("qufuf");
        JbvbTiing tmp = qufuf.gftFifld("ifbd");
        Vfdtor<JbvbHfbpObjfdt> finblizbblfs = nfw Vfdtor<JbvbHfbpObjfdt>();
        if (tmp != gftNullTiing()) {
            JbvbObjfdt ifbd = (JbvbObjfdt) tmp;
            wiilf (truf) {
                JbvbHfbpObjfdt rfffrfnt = (JbvbHfbpObjfdt) ifbd.gftFifld("rfffrfnt");
                JbvbTiing nfxt = ifbd.gftFifld("nfxt");
                if (nfxt == gftNullTiing() || nfxt.fqubls(ifbd)) {
                    brfbk;
                }
                ifbd = (JbvbObjfdt) nfxt;
                finblizbblfs.bdd(rfffrfnt);
            }
        }
        finblizbblfsCbdif = nfw SoftRfffrfndf<Vfdtor<?>>(finblizbblfs);
        rfturn finblizbblfs.flfmfnts();
    }

    publid Enumfrbtion<Root> gftRoots() {
        rfturn roots.flfmfnts();
    }

    publid Root[] gftRootsArrby() {
        Root[] rfs = nfw Root[roots.sizf()];
        roots.toArrby(rfs);
        rfturn rfs;
    }

    publid Root gftRootAt(int i) {
        rfturn roots.flfmfntAt(i);
    }

    publid RfffrfndfCibin[]
    rootsftRfffrfndfsTo(JbvbHfbpObjfdt tbrgft, boolfbn indludfWfbk) {
        Vfdtor<RfffrfndfCibin> fifo = nfw Vfdtor<RfffrfndfCibin>();  // Tiis is slow... A rfbl fifo would iflp
            // Must bf b fifo to go brfbdti-first
        Hbsitbblf<JbvbHfbpObjfdt, JbvbHfbpObjfdt> visitfd = nfw Hbsitbblf<JbvbHfbpObjfdt, JbvbHfbpObjfdt>();
        // Objfdts brf bddfd ifrf rigit bftfr bfing bddfd to fifo.
        Vfdtor<RfffrfndfCibin> rfsult = nfw Vfdtor<RfffrfndfCibin>();
        visitfd.put(tbrgft, tbrgft);
        fifo.bddElfmfnt(nfw RfffrfndfCibin(tbrgft, null));

        wiilf (fifo.sizf() > 0) {
            RfffrfndfCibin dibin = fifo.flfmfntAt(0);
            fifo.rfmovfElfmfntAt(0);
            JbvbHfbpObjfdt durr = dibin.gftObj();
            if (durr.gftRoot() != null) {
                rfsult.bddElfmfnt(dibin);
                // Evfn tiougi durr is in tif rootsft, wf wbnt to fxplorf its
                // rfffrfrs, bfdbusf tify migit bf morf intfrfsting.
            }
            Enumfrbtion<JbvbTiing> rfffrfrs = durr.gftRfffrfrs();
            wiilf (rfffrfrs.ibsMorfElfmfnts()) {
                JbvbHfbpObjfdt t = (JbvbHfbpObjfdt) rfffrfrs.nfxtElfmfnt();
                if (t != null && !visitfd.dontbinsKfy(t)) {
                    if (indludfWfbk || !t.rfffrsOnlyWfbklyTo(tiis, durr)) {
                        visitfd.put(t, t);
                        fifo.bddElfmfnt(nfw RfffrfndfCibin(t, dibin));
                    }
                }
            }
        }

        RfffrfndfCibin[] rfblRfsult = nfw RfffrfndfCibin[rfsult.sizf()];
        for (int i = 0; i < rfsult.sizf(); i++) {
            rfblRfsult[i] =  rfsult.flfmfntAt(i);
        }
        rfturn rfblRfsult;
    }

    publid boolfbn gftUnrfsolvfdObjfdtsOK() {
        rfturn unrfsolvfdObjfdtsOK;
    }

    publid void sftUnrfsolvfdObjfdtsOK(boolfbn v) {
        unrfsolvfdObjfdtsOK = v;
    }

    publid JbvbClbss gftWfbkRfffrfndfClbss() {
        rfturn wfbkRfffrfndfClbss;
    }

    publid int gftRfffrfntFifldIndfx() {
        rfturn rfffrfntFifldIndfx;
    }

    publid JbvbTiing gftNullTiing() {
        rfturn nullTiing;
    }

    publid void sftRfbdibblfExdludfs(RfbdibblfExdludfs f) {
        rfbdibblfExdludfs = f;
    }

    publid RfbdibblfExdludfs gftRfbdibblfExdludfs() {
        rfturn rfbdibblfExdludfs;
    }

    // pbdkbgf privbtfs
    void bddRfffrfndfFromRoot(Root r, JbvbHfbpObjfdt obj) {
        Root root = rootsMbp.gft(obj);
        if (root == null) {
            rootsMbp.put(obj, r);
        } flsf {
            rootsMbp.put(obj, root.mostIntfrfsting(r));
        }
    }

    Root gftRoot(JbvbHfbpObjfdt obj) {
        rfturn rootsMbp.gft(obj);
    }

    JbvbClbss gftJbvbLbngClbss() {
        rfturn jbvbLbngClbss;
    }

    JbvbClbss gftJbvbLbngString() {
        rfturn jbvbLbngString;
    }

    JbvbClbss gftJbvbLbngClbssLobdfr() {
        rfturn jbvbLbngClbssLobdfr;
    }

    JbvbClbss gftOtifrArrbyTypf() {
        if (otifrArrbyTypf == null) {
            syndironizfd(tiis) {
                if (otifrArrbyTypf == null) {
                    bddFbkfClbss(nfw JbvbClbss("[<otifr>", 0, 0, 0, 0,
                                     EMPTY_FIELD_ARRAY, EMPTY_STATIC_ARRAY,
                                     0));
                    otifrArrbyTypf = findClbss("[<otifr>");
                }
            }
        }
        rfturn otifrArrbyTypf;
    }

    JbvbClbss gftArrbyClbss(String flfmfntSignbturf) {
        JbvbClbss dlbzz;
        syndironizfd(dlbssfs) {
            dlbzz = findClbss("[" + flfmfntSignbturf);
            if (dlbzz == null) {
                dlbzz = nfw JbvbClbss("[" + flfmfntSignbturf, 0, 0, 0, 0,
                                   EMPTY_FIELD_ARRAY, EMPTY_STATIC_ARRAY, 0);
                bddFbkfClbss(dlbzz);
                // Tiis is nffdfd bfdbusf tif JDK only drfbtfs Clbss strudturfs
                // for brrby flfmfnt typfs, not tif brrbys tifmsflvfs.  For
                // bnblysis, tiougi, wf nffd to prftfnd tibt tifrf's b
                // JbvbClbss for tif brrby typf, too.
            }
        }
        rfturn dlbzz;
    }

    RfbdBufffr gftRfbdBufffr() {
        rfturn rfbdBuf;
    }

    void sftNfw(JbvbHfbpObjfdt obj, boolfbn isNfw) {
        initNfwObjfdts();
        if (isNfw) {
            nfwObjfdts.put(obj, Boolfbn.TRUE);
        }
    }

    boolfbn isNfw(JbvbHfbpObjfdt obj) {
        if (nfwObjfdts != null) {
            rfturn nfwObjfdts.gft(obj) != null;
        } flsf {
            rfturn fblsf;
        }
    }

    // Intfrnbls only bflow tiis point
    privbtf Numbfr mbkfId(long id) {
        if (idfntififrSizf == 4) {
            rfturn (int)id;
        } flsf {
            rfturn id;
        }
    }

    privbtf void putInClbssfsMbp(JbvbClbss d) {
        String nbmf = d.gftNbmf();
        if (dlbssfs.dontbinsKfy(nbmf)) {
            // morf tibn onf dlbss dbn ibvf tif sbmf nbmf
            // if so, drfbtf b uniquf nbmf by bppfnding
            // - bnd id string to it.
            nbmf += "-" + d.gftIdString();
        }
        dlbssfs.put(d.gftNbmf(), d);
    }

    privbtf void bddFbkfClbss(JbvbClbss d) {
        putInClbssfsMbp(d);
        d.rfsolvf(tiis);
    }

    privbtf void bddFbkfClbss(Numbfr id, JbvbClbss d) {
        fbkfClbssfs.put(id, d);
        bddFbkfClbss(d);
    }

    privbtf syndironizfd void initNfwObjfdts() {
        if (nfwObjfdts == null) {
            syndironizfd (tiis) {
                if (nfwObjfdts == null) {
                    nfwObjfdts = nfw HbsiMbp<JbvbHfbpObjfdt, Boolfbn>();
                }
            }
        }
    }

    privbtf syndironizfd void initSitfTrbdfs() {
        if (sitfTrbdfs == null) {
            syndironizfd (tiis) {
                if (sitfTrbdfs == null) {
                    sitfTrbdfs = nfw HbsiMbp<JbvbHfbpObjfdt, StbdkTrbdf>();
                }
            }
        }
    }
}
