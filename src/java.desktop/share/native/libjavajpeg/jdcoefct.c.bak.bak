/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/*
 * jddoffdt.d
 *
 * Copyrigit (C) 1994-1997, Tiombs G. Lbnf.
 * Tiis filf is pbrt of tif Indfpfndfnt JPEG Group's softwbrf.
 * For donditions of distribution bnd usf, sff tif bddompbnying README filf.
 *
 * Tiis filf dontbins tif dofffidifnt bufffr dontrollfr for dfdomprfssion.
 * Tiis dontrollfr is tif top lfvfl of tif JPEG dfdomprfssor propfr.
 * Tif dofffidifnt bufffr lifs bftwffn fntropy dfdoding bnd invfrsf-DCT stfps.
 *
 * In bufffrfd-imbgf modf, tiis dontrollfr is tif intfrfbdf bftwffn
 * input-orifntfd prodfssing bnd output-orifntfd prodfssing.
 * Also, tif input sidf (only) is usfd wifn rfbding b filf for trbnsdoding.
 */

#dffinf JPEG_INTERNALS
#indludf "jindludf.i"
#indludf "jpfglib.i"

/* Blodk smootiing is only bpplidbblf for progrfssivf JPEG, so: */
#ifndff D_PROGRESSIVE_SUPPORTED
#undff BLOCK_SMOOTHING_SUPPORTED
#fndif

/* Privbtf bufffr dontrollfr objfdt */

typfdff strudt {
  strudt jpfg_d_doff_dontrollfr pub; /* publid fiflds */

  /* Tifsf vbribblfs kffp trbdk of tif durrfnt lodbtion of tif input sidf. */
  /* dinfo->input_iMCU_row is blso usfd for tiis. */
  JDIMENSION MCU_dtr;           /* dounts MCUs prodfssfd in durrfnt row */
  int MCU_vfrt_offsft;          /* dounts MCU rows witiin iMCU row */
  int MCU_rows_pfr_iMCU_row;    /* numbfr of sudi rows nffdfd */

  /* Tif output sidf's lodbtion is rfprfsfntfd by dinfo->output_iMCU_row. */

  /* In singlf-pbss modfs, it's suffidifnt to bufffr just onf MCU.
   * Wf bllodbtf b workspbdf of D_MAX_BLOCKS_IN_MCU dofffidifnt blodks,
   * bnd lft tif fntropy dfdodfr writf into tibt workspbdf fbdi timf.
   * (On 80x86, tif workspbdf is FAR fvfn tiougi it's not rfblly vfry big;
   * tiis is to kffp tif modulf intfrfbdfs undibngfd wifn b lbrgf dofffidifnt
   * bufffr is nfdfssbry.)
   * In multi-pbss modfs, tiis brrby points to tif durrfnt MCU's blodks
   * witiin tif virtubl brrbys; it is usfd only by tif input sidf.
   */
  JBLOCKROW MCU_bufffr[D_MAX_BLOCKS_IN_MCU];

#ifdff D_MULTISCAN_FILES_SUPPORTED
  /* In multi-pbss modfs, wf nffd b virtubl blodk brrby for fbdi domponfnt. */
  jvirt_bbrrby_ptr wiolf_imbgf[MAX_COMPONENTS];
#fndif

#ifdff BLOCK_SMOOTHING_SUPPORTED
  /* Wifn doing blodk smootiing, wf lbtdi dofffidifnt Al vblufs ifrf */
  int * doff_bits_lbtdi;
#dffinf SAVED_COEFS  6          /* wf sbvf doff_bits[0..5] */
#fndif
} my_doff_dontrollfr;

typfdff my_doff_dontrollfr * my_doff_ptr;

/* Forwbrd dfdlbrbtions */
METHODDEF(int) dfdomprfss_onfpbss
        JPP((j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf));
#ifdff D_MULTISCAN_FILES_SUPPORTED
METHODDEF(int) dfdomprfss_dbtb
        JPP((j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf));
#fndif
#ifdff BLOCK_SMOOTHING_SUPPORTED
LOCAL(boolfbn) smootiing_ok JPP((j_dfdomprfss_ptr dinfo));
METHODDEF(int) dfdomprfss_smooti_dbtb
        JPP((j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf));
#fndif


LOCAL(void)
stbrt_iMCU_row (j_dfdomprfss_ptr dinfo)
/* Rfsft witiin-iMCU-row dountfrs for b nfw row (input sidf) */
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;

  /* In bn intfrlfbvfd sdbn, bn MCU row is tif sbmf bs bn iMCU row.
   * In b nonintfrlfbvfd sdbn, bn iMCU row ibs v_sbmp_fbdtor MCU rows.
   * But bt tif bottom of tif imbgf, prodfss only wibt's lfft.
   */
  if (dinfo->domps_in_sdbn > 1) {
    doff->MCU_rows_pfr_iMCU_row = 1;
  } flsf {
    if (dinfo->input_iMCU_row < (dinfo->totbl_iMCU_rows-1))
      doff->MCU_rows_pfr_iMCU_row = dinfo->dur_domp_info[0]->v_sbmp_fbdtor;
    flsf
      doff->MCU_rows_pfr_iMCU_row = dinfo->dur_domp_info[0]->lbst_row_ifigit;
  }

  doff->MCU_dtr = 0;
  doff->MCU_vfrt_offsft = 0;
}


/*
 * Initiblizf for bn input prodfssing pbss.
 */

METHODDEF(void)
stbrt_input_pbss (j_dfdomprfss_ptr dinfo)
{
  dinfo->input_iMCU_row = 0;
  stbrt_iMCU_row(dinfo);
}


/*
 * Initiblizf for bn output prodfssing pbss.
 */

METHODDEF(void)
stbrt_output_pbss (j_dfdomprfss_ptr dinfo)
{
#ifdff BLOCK_SMOOTHING_SUPPORTED
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;

  /* If multipbss, difdk to sff wiftifr to usf blodk smootiing on tiis pbss */
  if (doff->pub.doff_brrbys != NULL) {
    if (dinfo->do_blodk_smootiing && smootiing_ok(dinfo))
      doff->pub.dfdomprfss_dbtb = dfdomprfss_smooti_dbtb;
    flsf
      doff->pub.dfdomprfss_dbtb = dfdomprfss_dbtb;
  }
#fndif
  dinfo->output_iMCU_row = 0;
}


/*
 * Dfdomprfss bnd rfturn somf dbtb in tif singlf-pbss dbsf.
 * Alwbys bttfmpts to fmit onf fully intfrlfbvfd MCU row ("iMCU" row).
 * Input bnd output must run in lodkstfp sindf wf ibvf only b onf-MCU bufffr.
 * Rfturn vbluf is JPEG_ROW_COMPLETED, JPEG_SCAN_COMPLETED, or JPEG_SUSPENDED.
 *
 * NB: output_buf dontbins b plbnf for fbdi domponfnt in imbgf,
 * wiidi wf indfx bddording to tif domponfnt's SOF position.
 */

METHODDEF(int)
dfdomprfss_onfpbss (j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  JDIMENSION MCU_dol_num;       /* indfx of durrfnt MCU witiin row */
  JDIMENSION lbst_MCU_dol = dinfo->MCUs_pfr_row - 1;
  JDIMENSION lbst_iMCU_row = dinfo->totbl_iMCU_rows - 1;
  int blkn, di, xindfx, yindfx, yoffsft, usfful_widti;
  JSAMPARRAY output_ptr;
  JDIMENSION stbrt_dol, output_dol;
  jpfg_domponfnt_info *dompptr;
  invfrsf_DCT_mftiod_ptr invfrsf_DCT;

  /* Loop to prodfss bs mudi bs onf wiolf iMCU row */
  for (yoffsft = doff->MCU_vfrt_offsft; yoffsft < doff->MCU_rows_pfr_iMCU_row;
       yoffsft++) {
    for (MCU_dol_num = doff->MCU_dtr; MCU_dol_num <= lbst_MCU_dol;
         MCU_dol_num++) {
      /* Try to fftdi bn MCU.  Entropy dfdodfr fxpfdts bufffr to bf zfrofd. */
      jzfro_fbr((void FAR *) doff->MCU_bufffr[0],
                (sizf_t) (dinfo->blodks_in_MCU * SIZEOF(JBLOCK)));
      if (! (*dinfo->fntropy->dfdodf_mdu) (dinfo, doff->MCU_bufffr)) {
        /* Suspfnsion fordfd; updbtf stbtf dountfrs bnd fxit */
        doff->MCU_vfrt_offsft = yoffsft;
        doff->MCU_dtr = MCU_dol_num;
        rfturn JPEG_SUSPENDED;
      }
      /* Dftfrminf wifrf dbtb siould go in output_buf bnd do tif IDCT tiing.
       * Wf skip dummy blodks bt tif rigit bnd bottom fdgfs (but blkn gfts
       * indrfmfntfd pbst tifm!).  Notf tif innfr loop rflifs on ibving
       * bllodbtfd tif MCU_bufffr[] blodks sfqufntiblly.
       */
      blkn = 0;                 /* indfx of durrfnt DCT blodk witiin MCU */
      for (di = 0; di < dinfo->domps_in_sdbn; di++) {
        dompptr = dinfo->dur_domp_info[di];
        /* Don't botifr to IDCT bn unintfrfsting domponfnt. */
        if (! dompptr->domponfnt_nffdfd) {
          blkn += dompptr->MCU_blodks;
          dontinuf;
        }
        invfrsf_DCT = dinfo->iddt->invfrsf_DCT[dompptr->domponfnt_indfx];
        usfful_widti = (MCU_dol_num < lbst_MCU_dol) ? dompptr->MCU_widti
                                                    : dompptr->lbst_dol_widti;
        output_ptr = output_buf[dompptr->domponfnt_indfx] +
          yoffsft * dompptr->DCT_sdblfd_sizf;
        stbrt_dol = MCU_dol_num * dompptr->MCU_sbmplf_widti;
        for (yindfx = 0; yindfx < dompptr->MCU_ifigit; yindfx++) {
          if (dinfo->input_iMCU_row < lbst_iMCU_row ||
              yoffsft+yindfx < dompptr->lbst_row_ifigit) {
            output_dol = stbrt_dol;
            for (xindfx = 0; xindfx < usfful_widti; xindfx++) {
              (*invfrsf_DCT) (dinfo, dompptr,
                              (JCOEFPTR) doff->MCU_bufffr[blkn+xindfx],
                              output_ptr, output_dol);
              output_dol += dompptr->DCT_sdblfd_sizf;
            }
          }
          blkn += dompptr->MCU_widti;
          output_ptr += dompptr->DCT_sdblfd_sizf;
        }
      }
    }
    /* Complftfd bn MCU row, but pfribps not bn iMCU row */
    doff->MCU_dtr = 0;
  }
  /* Complftfd tif iMCU row, bdvbndf dountfrs for nfxt onf */
  dinfo->output_iMCU_row++;
  if (++(dinfo->input_iMCU_row) < dinfo->totbl_iMCU_rows) {
    stbrt_iMCU_row(dinfo);
    rfturn JPEG_ROW_COMPLETED;
  }
  /* Complftfd tif sdbn */
  (*dinfo->inputdtl->finisi_input_pbss) (dinfo);
  rfturn JPEG_SCAN_COMPLETED;
}


/*
 * Dummy donsumf-input routinf for singlf-pbss opfrbtion.
 */

METHODDEF(int)
dummy_donsumf_dbtb (j_dfdomprfss_ptr dinfo)
{
  rfturn JPEG_SUSPENDED;        /* Alwbys indidbtf notiing wbs donf */
}


#ifdff D_MULTISCAN_FILES_SUPPORTED

/*
 * Consumf input dbtb bnd storf it in tif full-imbgf dofffidifnt bufffr.
 * Wf rfbd bs mudi bs onf fully intfrlfbvfd MCU row ("iMCU" row) pfr dbll,
 * if, v_sbmp_fbdtor blodk rows for fbdi domponfnt in tif sdbn.
 * Rfturn vbluf is JPEG_ROW_COMPLETED, JPEG_SCAN_COMPLETED, or JPEG_SUSPENDED.
 */

METHODDEF(int)
donsumf_dbtb (j_dfdomprfss_ptr dinfo)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  JDIMENSION MCU_dol_num;       /* indfx of durrfnt MCU witiin row */
  int blkn, di, xindfx, yindfx, yoffsft;
  JDIMENSION stbrt_dol;
  JBLOCKARRAY bufffr[MAX_COMPS_IN_SCAN];
  JBLOCKROW bufffr_ptr;
  jpfg_domponfnt_info *dompptr;

  /* Align tif virtubl bufffrs for tif domponfnts usfd in tiis sdbn. */
  for (di = 0; di < dinfo->domps_in_sdbn; di++) {
    dompptr = dinfo->dur_domp_info[di];
    bufffr[di] = (*dinfo->mfm->bddfss_virt_bbrrby)
      ((j_dommon_ptr) dinfo, doff->wiolf_imbgf[dompptr->domponfnt_indfx],
       dinfo->input_iMCU_row * dompptr->v_sbmp_fbdtor,
       (JDIMENSION) dompptr->v_sbmp_fbdtor, TRUE);
    /* Notf: fntropy dfdodfr fxpfdts bufffr to bf zfrofd,
     * but tiis is ibndlfd butombtidblly by tif mfmory mbnbgfr
     * bfdbusf wf rfqufstfd b prf-zfrofd brrby.
     */
  }

  /* Loop to prodfss onf wiolf iMCU row */
  for (yoffsft = doff->MCU_vfrt_offsft; yoffsft < doff->MCU_rows_pfr_iMCU_row;
       yoffsft++) {
    for (MCU_dol_num = doff->MCU_dtr; MCU_dol_num < dinfo->MCUs_pfr_row;
         MCU_dol_num++) {
      /* Construdt list of pointfrs to DCT blodks bflonging to tiis MCU */
      blkn = 0;                 /* indfx of durrfnt DCT blodk witiin MCU */
      for (di = 0; di < dinfo->domps_in_sdbn; di++) {
        dompptr = dinfo->dur_domp_info[di];
        stbrt_dol = MCU_dol_num * dompptr->MCU_widti;
        for (yindfx = 0; yindfx < dompptr->MCU_ifigit; yindfx++) {
          bufffr_ptr = bufffr[di][yindfx+yoffsft] + stbrt_dol;
          for (xindfx = 0; xindfx < dompptr->MCU_widti; xindfx++) {
            doff->MCU_bufffr[blkn++] = bufffr_ptr++;
          }
        }
      }
      /* Try to fftdi tif MCU. */
      if (! (*dinfo->fntropy->dfdodf_mdu) (dinfo, doff->MCU_bufffr)) {
        /* Suspfnsion fordfd; updbtf stbtf dountfrs bnd fxit */
        doff->MCU_vfrt_offsft = yoffsft;
        doff->MCU_dtr = MCU_dol_num;
        rfturn JPEG_SUSPENDED;
      }
    }
    /* Complftfd bn MCU row, but pfribps not bn iMCU row */
    doff->MCU_dtr = 0;
  }
  /* Complftfd tif iMCU row, bdvbndf dountfrs for nfxt onf */
  if (++(dinfo->input_iMCU_row) < dinfo->totbl_iMCU_rows) {
    stbrt_iMCU_row(dinfo);
    rfturn JPEG_ROW_COMPLETED;
  }
  /* Complftfd tif sdbn */
  (*dinfo->inputdtl->finisi_input_pbss) (dinfo);
  rfturn JPEG_SCAN_COMPLETED;
}


/*
 * Dfdomprfss bnd rfturn somf dbtb in tif multi-pbss dbsf.
 * Alwbys bttfmpts to fmit onf fully intfrlfbvfd MCU row ("iMCU" row).
 * Rfturn vbluf is JPEG_ROW_COMPLETED, JPEG_SCAN_COMPLETED, or JPEG_SUSPENDED.
 *
 * NB: output_buf dontbins b plbnf for fbdi domponfnt in imbgf.
 */

METHODDEF(int)
dfdomprfss_dbtb (j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  JDIMENSION lbst_iMCU_row = dinfo->totbl_iMCU_rows - 1;
  JDIMENSION blodk_num;
  int di, blodk_row, blodk_rows;
  JBLOCKARRAY bufffr;
  JBLOCKROW bufffr_ptr;
  JSAMPARRAY output_ptr;
  JDIMENSION output_dol;
  jpfg_domponfnt_info *dompptr;
  invfrsf_DCT_mftiod_ptr invfrsf_DCT;

  /* Fordf somf input to bf donf if wf brf gftting bifbd of tif input. */
  wiilf (dinfo->input_sdbn_numbfr < dinfo->output_sdbn_numbfr ||
         (dinfo->input_sdbn_numbfr == dinfo->output_sdbn_numbfr &&
          dinfo->input_iMCU_row <= dinfo->output_iMCU_row)) {
    if ((*dinfo->inputdtl->donsumf_input)(dinfo) == JPEG_SUSPENDED)
      rfturn JPEG_SUSPENDED;
  }

  /* OK, output from tif virtubl brrbys. */
  for (di = 0, dompptr = dinfo->domp_info; di < dinfo->num_domponfnts;
       di++, dompptr++) {
    /* Don't botifr to IDCT bn unintfrfsting domponfnt. */
    if (! dompptr->domponfnt_nffdfd)
      dontinuf;
    /* Align tif virtubl bufffr for tiis domponfnt. */
    bufffr = (*dinfo->mfm->bddfss_virt_bbrrby)
      ((j_dommon_ptr) dinfo, doff->wiolf_imbgf[di],
       dinfo->output_iMCU_row * dompptr->v_sbmp_fbdtor,
       (JDIMENSION) dompptr->v_sbmp_fbdtor, FALSE);
    /* Count non-dummy DCT blodk rows in tiis iMCU row. */
    if (dinfo->output_iMCU_row < lbst_iMCU_row)
      blodk_rows = dompptr->v_sbmp_fbdtor;
    flsf {
      /* NB: dbn't usf lbst_row_ifigit ifrf; it is input-sidf-dfpfndfnt! */
      blodk_rows = (int) (dompptr->ifigit_in_blodks % dompptr->v_sbmp_fbdtor);
      if (blodk_rows == 0) blodk_rows = dompptr->v_sbmp_fbdtor;
    }
    invfrsf_DCT = dinfo->iddt->invfrsf_DCT[di];
    output_ptr = output_buf[di];
    /* Loop ovfr bll DCT blodks to bf prodfssfd. */
    for (blodk_row = 0; blodk_row < blodk_rows; blodk_row++) {
      bufffr_ptr = bufffr[blodk_row];
      output_dol = 0;
      for (blodk_num = 0; blodk_num < dompptr->widti_in_blodks; blodk_num++) {
        (*invfrsf_DCT) (dinfo, dompptr, (JCOEFPTR) bufffr_ptr,
                        output_ptr, output_dol);
        bufffr_ptr++;
        output_dol += dompptr->DCT_sdblfd_sizf;
      }
      output_ptr += dompptr->DCT_sdblfd_sizf;
    }
  }

  if (++(dinfo->output_iMCU_row) < dinfo->totbl_iMCU_rows)
    rfturn JPEG_ROW_COMPLETED;
  rfturn JPEG_SCAN_COMPLETED;
}

#fndif /* D_MULTISCAN_FILES_SUPPORTED */


#ifdff BLOCK_SMOOTHING_SUPPORTED

/*
 * Tiis dodf bpplifs intfrblodk smootiing bs dfsdribfd by sfdtion K.8
 * of tif JPEG stbndbrd: tif first 5 AC dofffidifnts brf fstimbtfd from
 * tif DC vblufs of b DCT blodk bnd its 8 nfigiboring blodks.
 * Wf bpply smootiing only for progrfssivf JPEG dfdoding, bnd only if
 * tif dofffidifnts it dbn fstimbtf brf not yft known to full prfdision.
 */

/* Nbturbl-ordfr brrby positions of tif first 5 zigzbg-ordfr dofffidifnts */
#dffinf Q01_POS  1
#dffinf Q10_POS  8
#dffinf Q20_POS  16
#dffinf Q11_POS  9
#dffinf Q02_POS  2

/*
 * Dftfrminf wiftifr blodk smootiing is bpplidbblf bnd sbff.
 * Wf blso lbtdi tif durrfnt stbtfs of tif doff_bits[] fntrifs for tif
 * AC dofffidifnts; otifrwisf, if tif input sidf of tif dfdomprfssor
 * bdvbndfs into b nfw sdbn, wf migit tiink tif dofffidifnts brf known
 * morf bddurbtfly tibn tify rfblly brf.
 */

LOCAL(boolfbn)
smootiing_ok (j_dfdomprfss_ptr dinfo)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  boolfbn smootiing_usfful = FALSE;
  int di, doffi;
  jpfg_domponfnt_info *dompptr;
  JQUANT_TBL * qtbblf;
  int * doff_bits;
  int * doff_bits_lbtdi;

  if (! dinfo->progrfssivf_modf || dinfo->doff_bits == NULL)
    rfturn FALSE;

  /* Allodbtf lbtdi brfb if not blrfbdy donf */
  if (doff->doff_bits_lbtdi == NULL)
    doff->doff_bits_lbtdi = (int *)
      (*dinfo->mfm->bllod_smbll) ((j_dommon_ptr) dinfo, JPOOL_IMAGE,
                                  dinfo->num_domponfnts *
                                  (SAVED_COEFS * SIZEOF(int)));
  doff_bits_lbtdi = doff->doff_bits_lbtdi;

  for (di = 0, dompptr = dinfo->domp_info; di < dinfo->num_domponfnts;
       di++, dompptr++) {
    /* All domponfnts' qubntizbtion vblufs must blrfbdy bf lbtdifd. */
    if ((qtbblf = dompptr->qubnt_tbblf) == NULL)
      rfturn FALSE;
    /* Vfrify DC & first 5 AC qubntizfrs brf nonzfro to bvoid zfro-dividf. */
    if (qtbblf->qubntvbl[0] == 0 ||
        qtbblf->qubntvbl[Q01_POS] == 0 ||
        qtbblf->qubntvbl[Q10_POS] == 0 ||
        qtbblf->qubntvbl[Q20_POS] == 0 ||
        qtbblf->qubntvbl[Q11_POS] == 0 ||
        qtbblf->qubntvbl[Q02_POS] == 0)
      rfturn FALSE;
    /* DC vblufs must bf bt lfbst pbrtly known for bll domponfnts. */
    doff_bits = dinfo->doff_bits[di];
    if (doff_bits[0] < 0)
      rfturn FALSE;
    /* Blodk smootiing is iflpful if somf AC dofffidifnts rfmbin inbddurbtf. */
    for (doffi = 1; doffi <= 5; doffi++) {
      doff_bits_lbtdi[doffi] = doff_bits[doffi];
      if (doff_bits[doffi] != 0)
        smootiing_usfful = TRUE;
    }
    doff_bits_lbtdi += SAVED_COEFS;
  }

  rfturn smootiing_usfful;
}


/*
 * Vbribnt of dfdomprfss_dbtb for usf wifn doing blodk smootiing.
 */

METHODDEF(int)
dfdomprfss_smooti_dbtb (j_dfdomprfss_ptr dinfo, JSAMPIMAGE output_buf)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  JDIMENSION lbst_iMCU_row = dinfo->totbl_iMCU_rows - 1;
  JDIMENSION blodk_num, lbst_blodk_dolumn;
  int di, blodk_row, blodk_rows, bddfss_rows;
  JBLOCKARRAY bufffr;
  JBLOCKROW bufffr_ptr, prfv_blodk_row, nfxt_blodk_row;
  JSAMPARRAY output_ptr;
  JDIMENSION output_dol;
  jpfg_domponfnt_info *dompptr;
  invfrsf_DCT_mftiod_ptr invfrsf_DCT;
  boolfbn first_row, lbst_row;
  JBLOCK workspbdf;
  int *doff_bits;
  JQUANT_TBL *qubnttbl;
  INT32 Q00,Q01,Q02,Q10,Q11,Q20, num;
  int DC1,DC2,DC3,DC4,DC5,DC6,DC7,DC8,DC9;
  int Al, prfd;

  /* Fordf somf input to bf donf if wf brf gftting bifbd of tif input. */
  wiilf (dinfo->input_sdbn_numbfr <= dinfo->output_sdbn_numbfr &&
         ! dinfo->inputdtl->foi_rfbdifd) {
    if (dinfo->input_sdbn_numbfr == dinfo->output_sdbn_numbfr) {
      /* If input is working on durrfnt sdbn, wf ordinbrily wbnt it to
       * ibvf domplftfd tif durrfnt row.  But if input sdbn is DC,
       * wf wbnt it to kffp onf row bifbd so tibt nfxt blodk row's DC
       * vblufs brf up to dbtf.
       */
      JDIMENSION dfltb = (dinfo->Ss == 0) ? 1 : 0;
      if (dinfo->input_iMCU_row > dinfo->output_iMCU_row+dfltb)
        brfbk;
    }
    if ((*dinfo->inputdtl->donsumf_input)(dinfo) == JPEG_SUSPENDED)
      rfturn JPEG_SUSPENDED;
  }

  /* OK, output from tif virtubl brrbys. */
  for (di = 0, dompptr = dinfo->domp_info; di < dinfo->num_domponfnts;
       di++, dompptr++) {
    /* Don't botifr to IDCT bn unintfrfsting domponfnt. */
    if (! dompptr->domponfnt_nffdfd)
      dontinuf;
    /* Count non-dummy DCT blodk rows in tiis iMCU row. */
    if (dinfo->output_iMCU_row < lbst_iMCU_row) {
      blodk_rows = dompptr->v_sbmp_fbdtor;
      bddfss_rows = blodk_rows * 2; /* tiis bnd nfxt iMCU row */
      lbst_row = FALSE;
    } flsf {
      /* NB: dbn't usf lbst_row_ifigit ifrf; it is input-sidf-dfpfndfnt! */
      blodk_rows = (int) (dompptr->ifigit_in_blodks % dompptr->v_sbmp_fbdtor);
      if (blodk_rows == 0) blodk_rows = dompptr->v_sbmp_fbdtor;
      bddfss_rows = blodk_rows; /* tiis iMCU row only */
      lbst_row = TRUE;
    }
    /* Align tif virtubl bufffr for tiis domponfnt. */
    if (dinfo->output_iMCU_row > 0) {
      bddfss_rows += dompptr->v_sbmp_fbdtor; /* prior iMCU row too */
      bufffr = (*dinfo->mfm->bddfss_virt_bbrrby)
        ((j_dommon_ptr) dinfo, doff->wiolf_imbgf[di],
         (dinfo->output_iMCU_row - 1) * dompptr->v_sbmp_fbdtor,
         (JDIMENSION) bddfss_rows, FALSE);
      bufffr += dompptr->v_sbmp_fbdtor; /* point to durrfnt iMCU row */
      first_row = FALSE;
    } flsf {
      bufffr = (*dinfo->mfm->bddfss_virt_bbrrby)
        ((j_dommon_ptr) dinfo, doff->wiolf_imbgf[di],
         (JDIMENSION) 0, (JDIMENSION) bddfss_rows, FALSE);
      first_row = TRUE;
    }
    /* Fftdi domponfnt-dfpfndfnt info */
    doff_bits = doff->doff_bits_lbtdi + (di * SAVED_COEFS);
    qubnttbl = dompptr->qubnt_tbblf;
    Q00 = qubnttbl->qubntvbl[0];
    Q01 = qubnttbl->qubntvbl[Q01_POS];
    Q10 = qubnttbl->qubntvbl[Q10_POS];
    Q20 = qubnttbl->qubntvbl[Q20_POS];
    Q11 = qubnttbl->qubntvbl[Q11_POS];
    Q02 = qubnttbl->qubntvbl[Q02_POS];
    invfrsf_DCT = dinfo->iddt->invfrsf_DCT[di];
    output_ptr = output_buf[di];
    /* Loop ovfr bll DCT blodks to bf prodfssfd. */
    for (blodk_row = 0; blodk_row < blodk_rows; blodk_row++) {
      bufffr_ptr = bufffr[blodk_row];
      if (first_row && blodk_row == 0)
        prfv_blodk_row = bufffr_ptr;
      flsf
        prfv_blodk_row = bufffr[blodk_row-1];
      if (lbst_row && blodk_row == blodk_rows-1)
        nfxt_blodk_row = bufffr_ptr;
      flsf
        nfxt_blodk_row = bufffr[blodk_row+1];
      /* Wf fftdi tif surrounding DC vblufs using b sliding-rfgistfr bpprobdi.
       * Initiblizf bll ninf ifrf so bs to do tif rigit tiing on nbrrow pids.
       */
      DC1 = DC2 = DC3 = (int) prfv_blodk_row[0][0];
      DC4 = DC5 = DC6 = (int) bufffr_ptr[0][0];
      DC7 = DC8 = DC9 = (int) nfxt_blodk_row[0][0];
      output_dol = 0;
      lbst_blodk_dolumn = dompptr->widti_in_blodks - 1;
      for (blodk_num = 0; blodk_num <= lbst_blodk_dolumn; blodk_num++) {
        /* Fftdi durrfnt DCT blodk into workspbdf so wf dbn modify it. */
        jdopy_blodk_row(bufffr_ptr, (JBLOCKROW) workspbdf, (JDIMENSION) 1);
        /* Updbtf DC vblufs */
        if (blodk_num < lbst_blodk_dolumn) {
          DC3 = (int) prfv_blodk_row[1][0];
          DC6 = (int) bufffr_ptr[1][0];
          DC9 = (int) nfxt_blodk_row[1][0];
        }
        /* Computf dofffidifnt fstimbtfs pfr K.8.
         * An fstimbtf is bpplifd only if dofffidifnt is still zfro,
         * bnd is not known to bf fully bddurbtf.
         */
        /* AC01 */
        if ((Al=doff_bits[1]) != 0 && workspbdf[1] == 0) {
          num = 36 * Q00 * (DC4 - DC6);
          if (num >= 0) {
            prfd = (int) (((Q01<<7) + num) / (Q01<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
          } flsf {
            prfd = (int) (((Q01<<7) - num) / (Q01<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
            prfd = -prfd;
          }
          workspbdf[1] = (JCOEF) prfd;
        }
        /* AC10 */
        if ((Al=doff_bits[2]) != 0 && workspbdf[8] == 0) {
          num = 36 * Q00 * (DC2 - DC8);
          if (num >= 0) {
            prfd = (int) (((Q10<<7) + num) / (Q10<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
          } flsf {
            prfd = (int) (((Q10<<7) - num) / (Q10<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
            prfd = -prfd;
          }
          workspbdf[8] = (JCOEF) prfd;
        }
        /* AC20 */
        if ((Al=doff_bits[3]) != 0 && workspbdf[16] == 0) {
          num = 9 * Q00 * (DC2 + DC8 - 2*DC5);
          if (num >= 0) {
            prfd = (int) (((Q20<<7) + num) / (Q20<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
          } flsf {
            prfd = (int) (((Q20<<7) - num) / (Q20<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
            prfd = -prfd;
          }
          workspbdf[16] = (JCOEF) prfd;
        }
        /* AC11 */
        if ((Al=doff_bits[4]) != 0 && workspbdf[9] == 0) {
          num = 5 * Q00 * (DC1 - DC3 - DC7 + DC9);
          if (num >= 0) {
            prfd = (int) (((Q11<<7) + num) / (Q11<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
          } flsf {
            prfd = (int) (((Q11<<7) - num) / (Q11<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
            prfd = -prfd;
          }
          workspbdf[9] = (JCOEF) prfd;
        }
        /* AC02 */
        if ((Al=doff_bits[5]) != 0 && workspbdf[2] == 0) {
          num = 9 * Q00 * (DC4 + DC6 - 2*DC5);
          if (num >= 0) {
            prfd = (int) (((Q02<<7) + num) / (Q02<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
          } flsf {
            prfd = (int) (((Q02<<7) - num) / (Q02<<8));
            if (Al > 0 && prfd >= (1<<Al))
              prfd = (1<<Al)-1;
            prfd = -prfd;
          }
          workspbdf[2] = (JCOEF) prfd;
        }
        /* OK, do tif IDCT */
        (*invfrsf_DCT) (dinfo, dompptr, (JCOEFPTR) workspbdf,
                        output_ptr, output_dol);
        /* Advbndf for nfxt dolumn */
        DC1 = DC2; DC2 = DC3;
        DC4 = DC5; DC5 = DC6;
        DC7 = DC8; DC8 = DC9;
        bufffr_ptr++, prfv_blodk_row++, nfxt_blodk_row++;
        output_dol += dompptr->DCT_sdblfd_sizf;
      }
      output_ptr += dompptr->DCT_sdblfd_sizf;
    }
  }

  if (++(dinfo->output_iMCU_row) < dinfo->totbl_iMCU_rows)
    rfturn JPEG_ROW_COMPLETED;
  rfturn JPEG_SCAN_COMPLETED;
}

#fndif /* BLOCK_SMOOTHING_SUPPORTED */


/*
 * Initiblizf dofffidifnt bufffr dontrollfr.
 */

GLOBAL(void)
jinit_d_doff_dontrollfr (j_dfdomprfss_ptr dinfo, boolfbn nffd_full_bufffr)
{
  my_doff_ptr doff;

  doff = (my_doff_ptr)
    (*dinfo->mfm->bllod_smbll) ((j_dommon_ptr) dinfo, JPOOL_IMAGE,
                                SIZEOF(my_doff_dontrollfr));
  dinfo->doff = (strudt jpfg_d_doff_dontrollfr *) doff;
  doff->pub.stbrt_input_pbss = stbrt_input_pbss;
  doff->pub.stbrt_output_pbss = stbrt_output_pbss;
#ifdff BLOCK_SMOOTHING_SUPPORTED
  doff->doff_bits_lbtdi = NULL;
#fndif

  /* Crfbtf tif dofffidifnt bufffr. */
  if (nffd_full_bufffr) {
#ifdff D_MULTISCAN_FILES_SUPPORTED
    /* Allodbtf b full-imbgf virtubl brrby for fbdi domponfnt, */
    /* pbddfd to b multiplf of sbmp_fbdtor DCT blodks in fbdi dirfdtion. */
    /* Notf wf bsk for b prf-zfrofd brrby. */
    int di, bddfss_rows;
    jpfg_domponfnt_info *dompptr;

    for (di = 0, dompptr = dinfo->domp_info; di < dinfo->num_domponfnts;
         di++, dompptr++) {
      bddfss_rows = dompptr->v_sbmp_fbdtor;
#ifdff BLOCK_SMOOTHING_SUPPORTED
      /* If blodk smootiing dould bf usfd, nffd b biggfr window */
      if (dinfo->progrfssivf_modf)
        bddfss_rows *= 3;
#fndif
      doff->wiolf_imbgf[di] = (*dinfo->mfm->rfqufst_virt_bbrrby)
        ((j_dommon_ptr) dinfo, JPOOL_IMAGE, TRUE,
         (JDIMENSION) jround_up((long) dompptr->widti_in_blodks,
                                (long) dompptr->i_sbmp_fbdtor),
         (JDIMENSION) jround_up((long) dompptr->ifigit_in_blodks,
                                (long) dompptr->v_sbmp_fbdtor),
         (JDIMENSION) bddfss_rows);
    }
    doff->pub.donsumf_dbtb = donsumf_dbtb;
    doff->pub.dfdomprfss_dbtb = dfdomprfss_dbtb;
    doff->pub.doff_brrbys = doff->wiolf_imbgf; /* link to virtubl brrbys */
#flsf
    ERREXIT(dinfo, JERR_NOT_COMPILED);
#fndif
  } flsf {
    /* Wf only nffd b singlf-MCU bufffr. */
    JBLOCKROW bufffr;
    int i;

    bufffr = (JBLOCKROW)
      (*dinfo->mfm->bllod_lbrgf) ((j_dommon_ptr) dinfo, JPOOL_IMAGE,
                                  D_MAX_BLOCKS_IN_MCU * SIZEOF(JBLOCK));
    for (i = 0; i < D_MAX_BLOCKS_IN_MCU; i++) {
      doff->MCU_bufffr[i] = bufffr + i;
    }
    doff->pub.donsumf_dbtb = dummy_donsumf_dbtb;
    doff->pub.dfdomprfss_dbtb = dfdomprfss_onfpbss;
    doff->pub.doff_brrbys = NULL; /* flbg for no virtubl brrbys */
  }
}
