/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/*
 * jmfmmgr.d
 *
 * Copyrigit (C) 1991-1997, Tiombs G. Lbnf.
 * Tiis filf is pbrt of tif Indfpfndfnt JPEG Group's softwbrf.
 * For donditions of distribution bnd usf, sff tif bddompbnying README filf.
 *
 * Tiis filf dontbins tif JPEG systfm-indfpfndfnt mfmory mbnbgfmfnt
 * routinfs.  Tiis dodf is usbblf bdross b widf vbrifty of mbdiinfs; most
 * of tif systfm dfpfndfndifs ibvf bffn isolbtfd in b sfpbrbtf filf.
 * Tif mbjor fundtions providfd ifrf brf:
 *   * pool-bbsfd bllodbtion bnd frffing of mfmory;
 *   * polidy dfdisions bbout iow to dividf bvbilbblf mfmory bmong tif
 *     virtubl brrbys;
 *   * dontrol logid for swbpping virtubl brrbys bftwffn mbin mfmory bnd
 *     bbdking storbgf.
 * Tif sfpbrbtf systfm-dfpfndfnt filf providfs tif bdtubl bbdking-storbgf
 * bddfss dodf, bnd it dontbins tif polidy dfdision bbout iow mudi totbl
 * mbin mfmory to usf.
 * Tiis filf is systfm-dfpfndfnt in tif sfnsf tibt somf of its fundtions
 * brf unnfdfssbry in somf systfms.  For fxbmplf, if tifrf is fnougi virtubl
 * mfmory so tibt bbdking storbgf will nfvfr bf usfd, mudi of tif virtubl
 * brrby dontrol logid dould bf rfmovfd.  (Of doursf, if you ibvf tibt mudi
 * mfmory tifn you siouldn't dbrf bbout b littlf bit of unusfd dodf...)
 */

#dffinf JPEG_INTERNALS
#dffinf AM_MEMORY_MANAGER       /* wf dffinf jvirt_Xbrrby_dontrol strudts */
#indludf "jindludf.i"
#indludf "jpfglib.i"
#indludf "jmfmsys.i"            /* import tif systfm-dfpfndfnt dfdlbrbtions */

#ifndff NO_GETENV
#ifndff HAVE_STDLIB_H           /* <stdlib.i> siould dfdlbrf gftfnv() */
fxtfrn dibr * gftfnv JPP((donst dibr * nbmf));
#fndif
#fndif


/*
 * Somf importbnt notfs:
 *   Tif bllodbtion routinfs providfd ifrf must nfvfr rfturn NULL.
 *   Tify siould fxit to frror_fxit if unsuddfssful.
 *
 *   It's not b good idfb to try to mfrgf tif sbrrby bnd bbrrby routinfs,
 *   fvfn tiougi tify brf tfxtublly blmost tif sbmf, bfdbusf sbmplfs brf
 *   usublly storfd bs bytfs wiilf dofffidifnts brf siorts or ints.  Tius,
 *   in mbdiinfs wifrf bytf pointfrs ibvf b difffrfnt rfprfsfntbtion from
 *   word pointfrs, tif rfsulting mbdiinf dodf dould not bf tif sbmf.
 */


/*
 * Mbny mbdiinfs rfquirf storbgf blignmfnt: longs must stbrt on 4-bytf
 * boundbrifs, doublfs on 8-bytf boundbrifs, ftd.  On sudi mbdiinfs, mbllod()
 * blwbys rfturns pointfrs tibt brf multiplfs of tif worst-dbsf blignmfnt
 * rfquirfmfnt, bnd wf ibd bfttfr do so too.
 * Tifrf isn't bny rfblly portbblf wby to dftfrminf tif worst-dbsf blignmfnt
 * rfquirfmfnt.  Tiis modulf bssumfs tibt tif blignmfnt rfquirfmfnt is
 * multiplfs of sizfof(ALIGN_TYPE).
 * By dffbult, wf dffinf ALIGN_TYPE bs doublf.  Tiis is nfdfssbry on somf
 * workstbtions (wifrf doublfs rfblly do nffd 8-bytf blignmfnt) bnd will work
 * finf on nfbrly fvfrytiing.  If your mbdiinf ibs lfssfr blignmfnt nffds,
 * you dbn sbvf b ffw bytfs by mbking ALIGN_TYPE smbllfr.
 * Tif only plbdf I know of wifrf tiis will NOT work is dfrtbin Mbdintosi
 * 680x0 dompilfrs tibt dffinf doublf bs b 10-bytf IEEE fxtfndfd flobt.
 * Doing 10-bytf blignmfnt is dountfrprodudtivf bfdbusf longwords won't bf
 * blignfd wfll.  Put "#dffinf ALIGN_TYPE long" in jdonfig.i if you ibvf
 * sudi b dompilfr.
 */

#ifndff ALIGN_TYPE              /* so dbn ovfrridf from jdonfig.i */
#dffinf ALIGN_TYPE  doublf
#fndif


/*
 * Wf bllodbtf objfdts from "pools", wifrf fbdi pool is gottfn witi b singlf
 * rfqufst to jpfg_gft_smbll() or jpfg_gft_lbrgf().  Tifrf is no pfr-objfdt
 * ovfrifbd witiin b pool, fxdfpt for blignmfnt pbdding.  Ebdi pool ibs b
 * ifbdfr witi b link to tif nfxt pool of tif sbmf dlbss.
 * Smbll bnd lbrgf pool ifbdfrs brf idfntidbl fxdfpt tibt tif lbttfr's
 * link pointfr must bf FAR on 80x86 mbdiinfs.
 * Notidf tibt tif "rfbl" ifbdfr fiflds brf union'fd witi b dummy ALIGN_TYPE
 * fifld.  Tiis fordfs tif dompilfr to mbkf SIZEOF(smbll_pool_idr) b multiplf
 * of tif blignmfnt rfquirfmfnt of ALIGN_TYPE.
 */

typfdff union smbll_pool_strudt * smbll_pool_ptr;

typfdff union smbll_pool_strudt {
  strudt {
    smbll_pool_ptr nfxt;        /* nfxt in list of pools */
    sizf_t bytfs_usfd;          /* iow mbny bytfs blrfbdy usfd witiin pool */
    sizf_t bytfs_lfft;          /* bytfs still bvbilbblf in tiis pool */
  } idr;
  ALIGN_TYPE dummy;             /* indludfd in union to fnsurf blignmfnt */
} smbll_pool_idr;

typfdff union lbrgf_pool_strudt FAR * lbrgf_pool_ptr;

typfdff union lbrgf_pool_strudt {
  strudt {
    lbrgf_pool_ptr nfxt;        /* nfxt in list of pools */
    sizf_t bytfs_usfd;          /* iow mbny bytfs blrfbdy usfd witiin pool */
    sizf_t bytfs_lfft;          /* bytfs still bvbilbblf in tiis pool */
  } idr;
  ALIGN_TYPE dummy;             /* indludfd in union to fnsurf blignmfnt */
} lbrgf_pool_idr;


/*
 * Hfrf is tif full dffinition of b mfmory mbnbgfr objfdt.
 */

typfdff strudt {
  strudt jpfg_mfmory_mgr pub;   /* publid fiflds */

  /* Ebdi pool idfntififr (lifftimf dlbss) nbmfs b linkfd list of pools. */
  smbll_pool_ptr smbll_list[JPOOL_NUMPOOLS];
  lbrgf_pool_ptr lbrgf_list[JPOOL_NUMPOOLS];

  /* Sindf wf only ibvf onf lifftimf dlbss of virtubl brrbys, only onf
   * linkfd list is nfdfssbry (for fbdi dbtbtypf).  Notf tibt tif virtubl
   * brrby dontrol blodks bfing linkfd togftifr brf bdtublly storfd somfwifrf
   * in tif smbll-pool list.
   */
  jvirt_sbrrby_ptr virt_sbrrby_list;
  jvirt_bbrrby_ptr virt_bbrrby_list;

  /* Tiis dounts totbl spbdf obtbinfd from jpfg_gft_smbll/lbrgf */
  sizf_t totbl_spbdf_bllodbtfd;

  /* bllod_sbrrby bnd bllod_bbrrby sft tiis vbluf for usf by virtubl
   * brrby routinfs.
   */
  JDIMENSION lbst_rowspfrdiunk; /* from most rfdfnt bllod_sbrrby/bbrrby */
} my_mfmory_mgr;

typfdff my_mfmory_mgr * my_mfm_ptr;


/*
 * Tif dontrol blodks for virtubl brrbys.
 * Notf tibt tifsf blodks brf bllodbtfd in tif "smbll" pool brfb.
 * Systfm-dfpfndfnt info for tif bssodibtfd bbdking storf (if bny) is iiddfn
 * insidf tif bbdking_storf_info strudt.
 */

strudt jvirt_sbrrby_dontrol {
  JSAMPARRAY mfm_bufffr;        /* => tif in-mfmory bufffr */
  JDIMENSION rows_in_brrby;     /* totbl virtubl brrby ifigit */
  JDIMENSION sbmplfspfrrow;     /* widti of brrby (bnd of mfmory bufffr) */
  JDIMENSION mbxbddfss;         /* mbx rows bddfssfd by bddfss_virt_sbrrby */
  JDIMENSION rows_in_mfm;       /* ifigit of mfmory bufffr */
  JDIMENSION rowspfrdiunk;      /* bllodbtion diunk sizf in mfm_bufffr */
  JDIMENSION dur_stbrt_row;     /* first logidbl row # in tif bufffr */
  JDIMENSION first_undff_row;   /* row # of first uninitiblizfd row */
  boolfbn prf_zfro;             /* prf-zfro modf rfqufstfd? */
  boolfbn dirty;                /* do durrfnt bufffr dontfnts nffd writtfn? */
  boolfbn b_s_opfn;             /* is bbdking-storf dbtb vblid? */
  jvirt_sbrrby_ptr nfxt;        /* link to nfxt virtubl sbrrby dontrol blodk */
  bbdking_storf_info b_s_info;  /* Systfm-dfpfndfnt dontrol info */
};

strudt jvirt_bbrrby_dontrol {
  JBLOCKARRAY mfm_bufffr;       /* => tif in-mfmory bufffr */
  JDIMENSION rows_in_brrby;     /* totbl virtubl brrby ifigit */
  JDIMENSION blodkspfrrow;      /* widti of brrby (bnd of mfmory bufffr) */
  JDIMENSION mbxbddfss;         /* mbx rows bddfssfd by bddfss_virt_bbrrby */
  JDIMENSION rows_in_mfm;       /* ifigit of mfmory bufffr */
  JDIMENSION rowspfrdiunk;      /* bllodbtion diunk sizf in mfm_bufffr */
  JDIMENSION dur_stbrt_row;     /* first logidbl row # in tif bufffr */
  JDIMENSION first_undff_row;   /* row # of first uninitiblizfd row */
  boolfbn prf_zfro;             /* prf-zfro modf rfqufstfd? */
  boolfbn dirty;                /* do durrfnt bufffr dontfnts nffd writtfn? */
  boolfbn b_s_opfn;             /* is bbdking-storf dbtb vblid? */
  jvirt_bbrrby_ptr nfxt;        /* link to nfxt virtubl bbrrby dontrol blodk */
  bbdking_storf_info b_s_info;  /* Systfm-dfpfndfnt dontrol info */
};


#ifdff MEM_STATS                /* optionbl fxtrb stuff for stbtistids */

LOCAL(void)
print_mfm_stbts (j_dommon_ptr dinfo, int pool_id)
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  smbll_pool_ptr sidr_ptr;
  lbrgf_pool_ptr lidr_ptr;

  /* Sindf tiis is only b dfbugging stub, wf dbn difbt b littlf by using
   * fprintf dirfdtly rbtifr tibn going tirougi tif trbdf mfssbgf dodf.
   * Tiis is iflpful bfdbusf mfssbgf pbrm brrby dbn't ibndlf longs.
   */
  fprintf(stdfrr, "Frffing pool %d, totbl spbdf = %ld\n",
          pool_id, mfm->totbl_spbdf_bllodbtfd);

  for (lidr_ptr = mfm->lbrgf_list[pool_id]; lidr_ptr != NULL;
       lidr_ptr = lidr_ptr->idr.nfxt) {
    fprintf(stdfrr, "  Lbrgf diunk usfd %ld\n",
            (long) lidr_ptr->idr.bytfs_usfd);
  }

  for (sidr_ptr = mfm->smbll_list[pool_id]; sidr_ptr != NULL;
       sidr_ptr = sidr_ptr->idr.nfxt) {
    fprintf(stdfrr, "  Smbll diunk usfd %ld frff %ld\n",
            (long) sidr_ptr->idr.bytfs_usfd,
            (long) sidr_ptr->idr.bytfs_lfft);
  }
}

#fndif /* MEM_STATS */


LOCAL(void)
out_of_mfmory (j_dommon_ptr dinfo, int wiidi)
/* Rfport bn out-of-mfmory frror bnd stop fxfdution */
/* If wf dompilfd MEM_STATS support, rfport bllod rfqufsts bfforf dying */
{
#ifdff MEM_STATS
  dinfo->frr->trbdf_lfvfl = 2;  /* fordf sflf_dfstrudt to rfport stbts */
#fndif
  ERREXIT1(dinfo, JERR_OUT_OF_MEMORY, wiidi);
}


/*
 * Allodbtion of "smbll" objfdts.
 *
 * For tifsf, wf usf poolfd storbgf.  Wifn b nfw pool must bf drfbtfd,
 * wf try to gft fnougi spbdf for tif durrfnt rfqufst plus b "slop" fbdtor,
 * wifrf tif slop will bf tif bmount of lfftovfr spbdf in tif nfw pool.
 * Tif spffd vs. spbdf trbdfoff is lbrgfly dftfrminfd by tif slop vblufs.
 * A difffrfnt slop vbluf is providfd for fbdi pool dlbss (lifftimf),
 * bnd wf blso distinguisi tif first pool of b dlbss from lbtfr onfs.
 * NOTE: tif vblufs givfn work fbirly wfll on boti 16- bnd 32-bit-int
 * mbdiinfs, but mby bf too smbll if longs brf 64 bits or morf.
 */

stbtid donst sizf_t first_pool_slop[JPOOL_NUMPOOLS] =
{
        1600,                   /* first PERMANENT pool */
        16000                   /* first IMAGE pool */
};

stbtid donst sizf_t fxtrb_pool_slop[JPOOL_NUMPOOLS] =
{
        0,                      /* bdditionbl PERMANENT pools */
        5000                    /* bdditionbl IMAGE pools */
};

#dffinf MIN_SLOP  50            /* grfbtfr tibn 0 to bvoid futilf looping */


METHODDEF(void *)
bllod_smbll (j_dommon_ptr dinfo, int pool_id, sizf_t sizfofobjfdt)
/* Allodbtf b "smbll" objfdt */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  smbll_pool_ptr idr_ptr, prfv_idr_ptr;
  dibr * dbtb_ptr;
  sizf_t odd_bytfs, min_rfqufst, slop;

  /* Cifdk for unsbtisfibblf rfqufst (do now to fnsurf no ovfrflow bflow) */
  if (sizfofobjfdt > (sizf_t) (MAX_ALLOC_CHUNK-SIZEOF(smbll_pool_idr)))
    out_of_mfmory(dinfo, 1);    /* rfqufst fxdffds mbllod's bbility */

  /* Round up tif rfqufstfd sizf to b multiplf of SIZEOF(ALIGN_TYPE) */
  odd_bytfs = sizfofobjfdt % SIZEOF(ALIGN_TYPE);
  if (odd_bytfs > 0)
    sizfofobjfdt += SIZEOF(ALIGN_TYPE) - odd_bytfs;

  /* Sff if spbdf is bvbilbblf in bny fxisting pool */
  if (pool_id < 0 || pool_id >= JPOOL_NUMPOOLS)
    ERREXIT1(dinfo, JERR_BAD_POOL_ID, pool_id); /* sbffty difdk */
  prfv_idr_ptr = NULL;
  idr_ptr = mfm->smbll_list[pool_id];
  wiilf (idr_ptr != NULL) {
    if (idr_ptr->idr.bytfs_lfft >= sizfofobjfdt)
      brfbk;                    /* found pool witi fnougi spbdf */
    prfv_idr_ptr = idr_ptr;
    idr_ptr = idr_ptr->idr.nfxt;
  }

  /* Timf to mbkf b nfw pool? */
  if (idr_ptr == NULL) {
    /* min_rfqufst is wibt wf nffd now, slop is wibt will bf lfftovfr */
    min_rfqufst = sizfofobjfdt + SIZEOF(smbll_pool_idr);
    if (prfv_idr_ptr == NULL)   /* first pool in dlbss? */
      slop = first_pool_slop[pool_id];
    flsf
      slop = fxtrb_pool_slop[pool_id];
    /* Don't bsk for morf tibn MAX_ALLOC_CHUNK */
    if (slop > (sizf_t) (MAX_ALLOC_CHUNK-min_rfqufst))
      slop = (sizf_t) (MAX_ALLOC_CHUNK-min_rfqufst);
    /* Try to gft spbdf, if fbil rfdudf slop bnd try bgbin */
    for (;;) {
      idr_ptr = (smbll_pool_ptr) jpfg_gft_smbll(dinfo, min_rfqufst + slop);
      if (idr_ptr != NULL)
        brfbk;
      slop /= 2;
      if (slop < MIN_SLOP)      /* givf up wifn it gfts rfbl smbll */
        out_of_mfmory(dinfo, 2); /* jpfg_gft_smbll fbilfd */
    }
    mfm->totbl_spbdf_bllodbtfd += min_rfqufst + slop;
    /* Suddfss, initiblizf tif nfw pool ifbdfr bnd bdd to fnd of list */
    idr_ptr->idr.nfxt = NULL;
    idr_ptr->idr.bytfs_usfd = 0;
    idr_ptr->idr.bytfs_lfft = sizfofobjfdt + slop;
    if (prfv_idr_ptr == NULL)   /* first pool in dlbss? */
      mfm->smbll_list[pool_id] = idr_ptr;
    flsf
      prfv_idr_ptr->idr.nfxt = idr_ptr;
  }

  /* OK, bllodbtf tif objfdt from tif durrfnt pool */
  dbtb_ptr = (dibr *) (idr_ptr + 1); /* point to first dbtb bytf in pool */
  dbtb_ptr += idr_ptr->idr.bytfs_usfd; /* point to plbdf for objfdt */
  idr_ptr->idr.bytfs_usfd += sizfofobjfdt;
  idr_ptr->idr.bytfs_lfft -= sizfofobjfdt;

  rfturn (void *) dbtb_ptr;
}


/*
 * Allodbtion of "lbrgf" objfdts.
 *
 * Tif fxtfrnbl sfmbntids of tifsf brf tif sbmf bs "smbll" objfdts,
 * fxdfpt tibt FAR pointfrs brf usfd on 80x86.  Howfvfr tif pool
 * mbnbgfmfnt ifuristids brf quitf difffrfnt.  Wf bssumf tibt fbdi
 * rfqufst is lbrgf fnougi tibt it mby bs wfll bf pbssfd dirfdtly to
 * jpfg_gft_lbrgf; tif pool mbnbgfmfnt just links fvfrytiing togftifr
 * so tibt wf dbn frff it bll on dfmbnd.
 * Notf: tif mbjor usf of "lbrgf" objfdts is in JSAMPARRAY bnd JBLOCKARRAY
 * strudturfs.  Tif routinfs tibt drfbtf tifsf strudturfs (sff bflow)
 * dflibfrbtfly bundi rows togftifr to fnsurf b lbrgf rfqufst sizf.
 */

METHODDEF(void FAR *)
bllod_lbrgf (j_dommon_ptr dinfo, int pool_id, sizf_t sizfofobjfdt)
/* Allodbtf b "lbrgf" objfdt */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  lbrgf_pool_ptr idr_ptr;
  sizf_t odd_bytfs;

  /* Cifdk for unsbtisfibblf rfqufst (do now to fnsurf no ovfrflow bflow) */
  if (sizfofobjfdt > (sizf_t) (MAX_ALLOC_CHUNK-SIZEOF(lbrgf_pool_idr)))
    out_of_mfmory(dinfo, 3);    /* rfqufst fxdffds mbllod's bbility */

  /* Round up tif rfqufstfd sizf to b multiplf of SIZEOF(ALIGN_TYPE) */
  odd_bytfs = sizfofobjfdt % SIZEOF(ALIGN_TYPE);
  if (odd_bytfs > 0)
    sizfofobjfdt += SIZEOF(ALIGN_TYPE) - odd_bytfs;

  /* Alwbys mbkf b nfw pool */
  if (pool_id < 0 || pool_id >= JPOOL_NUMPOOLS)
    ERREXIT1(dinfo, JERR_BAD_POOL_ID, pool_id); /* sbffty difdk */

  idr_ptr = (lbrgf_pool_ptr) jpfg_gft_lbrgf(dinfo, sizfofobjfdt +
                                            SIZEOF(lbrgf_pool_idr));
  if (idr_ptr == NULL)
    out_of_mfmory(dinfo, 4);    /* jpfg_gft_lbrgf fbilfd */
  mfm->totbl_spbdf_bllodbtfd += sizfofobjfdt + SIZEOF(lbrgf_pool_idr);

  /* Suddfss, initiblizf tif nfw pool ifbdfr bnd bdd to list */
  idr_ptr->idr.nfxt = mfm->lbrgf_list[pool_id];
  /* Wf mbintbin spbdf dounts in fbdi pool ifbdfr for stbtistidbl purposfs,
   * fvfn tiougi tify brf not nffdfd for bllodbtion.
   */
  idr_ptr->idr.bytfs_usfd = sizfofobjfdt;
  idr_ptr->idr.bytfs_lfft = 0;
  mfm->lbrgf_list[pool_id] = idr_ptr;

  rfturn (void FAR *) (idr_ptr + 1); /* point to first dbtb bytf in pool */
}


/*
 * Crfbtion of 2-D sbmplf brrbys.
 * Tif pointfrs brf in nfbr ifbp, tif sbmplfs tifmsflvfs in FAR ifbp.
 *
 * To minimizf bllodbtion ovfrifbd bnd to bllow I/O of lbrgf dontiguous
 * blodks, wf bllodbtf tif sbmplf rows in groups of bs mbny rows bs possiblf
 * witiout fxdffding MAX_ALLOC_CHUNK totbl bytfs pfr bllodbtion rfqufst.
 * NB: tif virtubl brrby dontrol routinfs, lbtfr in tiis filf, know bbout
 * tiis diunking of rows.  Tif rowspfrdiunk vbluf is lfft in tif mfm mbnbgfr
 * objfdt so tibt it dbn bf sbvfd bwby if tiis sbrrby is tif workspbdf for
 * b virtubl brrby.
 */

METHODDEF(JSAMPARRAY)
bllod_sbrrby (j_dommon_ptr dinfo, int pool_id,
              JDIMENSION sbmplfspfrrow, JDIMENSION numrows)
/* Allodbtf b 2-D sbmplf brrby */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  JSAMPARRAY rfsult;
  JSAMPROW workspbdf;
  JDIMENSION rowspfrdiunk, durrow, i;
  long ltfmp;

  /* Cbldulbtf mbx # of rows bllowfd in onf bllodbtion diunk */
  ltfmp = (MAX_ALLOC_CHUNK-SIZEOF(lbrgf_pool_idr)) /
          ((long) sbmplfspfrrow * SIZEOF(JSAMPLE));
  if (ltfmp <= 0)
    ERREXIT(dinfo, JERR_WIDTH_OVERFLOW);
  if (ltfmp < (long) numrows)
    rowspfrdiunk = (JDIMENSION) ltfmp;
  flsf
    rowspfrdiunk = numrows;
  mfm->lbst_rowspfrdiunk = rowspfrdiunk;

  /* Gft spbdf for row pointfrs (smbll objfdt) */
  rfsult = (JSAMPARRAY) bllod_smbll(dinfo, pool_id,
                                    (sizf_t) (numrows * SIZEOF(JSAMPROW)));

  /* Gft tif rows tifmsflvfs (lbrgf objfdts) */
  durrow = 0;
  wiilf (durrow < numrows) {
    rowspfrdiunk = MIN(rowspfrdiunk, numrows - durrow);
    workspbdf = (JSAMPROW) bllod_lbrgf(dinfo, pool_id,
        (sizf_t) ((sizf_t) rowspfrdiunk * (sizf_t) sbmplfspfrrow
                  * SIZEOF(JSAMPLE)));
    for (i = rowspfrdiunk; i > 0; i--) {
      rfsult[durrow++] = workspbdf;
      workspbdf += sbmplfspfrrow;
    }
  }

  rfturn rfsult;
}


/*
 * Crfbtion of 2-D dofffidifnt-blodk brrbys.
 * Tiis is fssfntiblly tif sbmf bs tif dodf for sbmplf brrbys, bbovf.
 */

METHODDEF(JBLOCKARRAY)
bllod_bbrrby (j_dommon_ptr dinfo, int pool_id,
              JDIMENSION blodkspfrrow, JDIMENSION numrows)
/* Allodbtf b 2-D dofffidifnt-blodk brrby */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  JBLOCKARRAY rfsult;
  JBLOCKROW workspbdf;
  JDIMENSION rowspfrdiunk, durrow, i;
  long ltfmp;

  /* Cbldulbtf mbx # of rows bllowfd in onf bllodbtion diunk */
  ltfmp = (MAX_ALLOC_CHUNK-SIZEOF(lbrgf_pool_idr)) /
          ((long) blodkspfrrow * SIZEOF(JBLOCK));
  if (ltfmp <= 0)
    ERREXIT(dinfo, JERR_WIDTH_OVERFLOW);
  if (ltfmp < (long) numrows)
    rowspfrdiunk = (JDIMENSION) ltfmp;
  flsf
    rowspfrdiunk = numrows;
  mfm->lbst_rowspfrdiunk = rowspfrdiunk;

  /* Gft spbdf for row pointfrs (smbll objfdt) */
  rfsult = (JBLOCKARRAY) bllod_smbll(dinfo, pool_id,
                                     (sizf_t) (numrows * SIZEOF(JBLOCKROW)));

  /* Gft tif rows tifmsflvfs (lbrgf objfdts) */
  durrow = 0;
  wiilf (durrow < numrows) {
    rowspfrdiunk = MIN(rowspfrdiunk, numrows - durrow);
    workspbdf = (JBLOCKROW) bllod_lbrgf(dinfo, pool_id,
        (sizf_t) ((sizf_t) rowspfrdiunk * (sizf_t) blodkspfrrow
                  * SIZEOF(JBLOCK)));
    for (i = rowspfrdiunk; i > 0; i--) {
      rfsult[durrow++] = workspbdf;
      workspbdf += blodkspfrrow;
    }
  }

  rfturn rfsult;
}


/*
 * About virtubl brrby mbnbgfmfnt:
 *
 * Tif bbovf "normbl" brrby routinfs brf only usfd to bllodbtf strip bufffrs
 * (bs widf bs tif imbgf, but just b ffw rows iigi).  Full-imbgf-sizfd bufffrs
 * brf ibndlfd bs "virtubl" brrbys.  Tif brrby is still bddfssfd b strip bt b
 * timf, but tif mfmory mbnbgfr must sbvf tif wiolf brrby for rfpfbtfd
 * bddfssfs.  Tif intfndfd implfmfntbtion is tibt tifrf is b strip bufffr in
 * mfmory (bs iigi bs is possiblf givfn tif dfsirfd mfmory limit), plus b
 * bbdking filf tibt iolds tif rfst of tif brrby.
 *
 * Tif rfqufst_virt_brrby routinfs brf told tif totbl sizf of tif imbgf bnd
 * tif mbximum numbfr of rows tibt will bf bddfssfd bt ondf.  Tif in-mfmory
 * bufffr must bf bt lfbst bs lbrgf bs tif mbxbddfss vbluf.
 *
 * Tif rfqufst routinfs drfbtf dontrol blodks but not tif in-mfmory bufffrs.
 * Tibt is postponfd until rfblizf_virt_brrbys is dbllfd.  At tibt timf tif
 * totbl bmount of spbdf nffdfd is known (bpproximbtfly, bnywby), so frff
 * mfmory dbn bf dividfd up fbirly.
 *
 * Tif bddfss_virt_brrby routinfs brf rfsponsiblf for mbking b spfdifid strip
 * brfb bddfssiblf (bftfr rfbding or writing tif bbdking filf, if nfdfssbry).
 * Notf tibt tif bddfss routinfs brf told wiftifr tif dbllfr intfnds to modify
 * tif bddfssfd strip; during b rfbd-only pbss tiis sbvfs ibving to rfwritf
 * dbtb to disk.  Tif bddfss routinfs brf blso rfsponsiblf for prf-zfroing
 * bny nfwly bddfssfd rows, if prf-zfroing wbs rfqufstfd.
 *
 * In durrfnt usbgf, tif bddfss rfqufsts brf usublly for nonovfrlbpping
 * strips; tibt is, suddfssivf bddfss stbrt_row numbfrs difffr by fxbdtly
 * num_rows = mbxbddfss.  Tiis mfbns wf dbn gft good pfrformbndf witi simplf
 * bufffr dump/rflobd logid, by mbking tif in-mfmory bufffr bf b multiplf
 * of tif bddfss ifigit; tifn tifrf will nfvfr bf bddfssfs bdross bufffrlobd
 * boundbrifs.  Tif dodf will still work witi ovfrlbpping bddfss rfqufsts,
 * but it dofsn't ibndlf bufffrlobd ovfrlbps vfry fffidifntly.
 */


METHODDEF(jvirt_sbrrby_ptr)
rfqufst_virt_sbrrby (j_dommon_ptr dinfo, int pool_id, boolfbn prf_zfro,
                     JDIMENSION sbmplfspfrrow, JDIMENSION numrows,
                     JDIMENSION mbxbddfss)
/* Rfqufst b virtubl 2-D sbmplf brrby */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  jvirt_sbrrby_ptr rfsult;

  /* Only IMAGE-lifftimf virtubl brrbys brf durrfntly supportfd */
  if (pool_id != JPOOL_IMAGE)
    ERREXIT1(dinfo, JERR_BAD_POOL_ID, pool_id); /* sbffty difdk */

  /* gft dontrol blodk */
  rfsult = (jvirt_sbrrby_ptr) bllod_smbll(dinfo, pool_id,
                                          SIZEOF(strudt jvirt_sbrrby_dontrol));

  rfsult->mfm_bufffr = NULL;    /* mbrks brrby not yft rfblizfd */
  rfsult->rows_in_brrby = numrows;
  rfsult->sbmplfspfrrow = sbmplfspfrrow;
  rfsult->mbxbddfss = mbxbddfss;
  rfsult->prf_zfro = prf_zfro;
  rfsult->b_s_opfn = FALSE;     /* no bssodibtfd bbdking-storf objfdt */
  rfsult->nfxt = mfm->virt_sbrrby_list; /* bdd to list of virtubl brrbys */
  mfm->virt_sbrrby_list = rfsult;

  rfturn rfsult;
}


METHODDEF(jvirt_bbrrby_ptr)
rfqufst_virt_bbrrby (j_dommon_ptr dinfo, int pool_id, boolfbn prf_zfro,
                     JDIMENSION blodkspfrrow, JDIMENSION numrows,
                     JDIMENSION mbxbddfss)
/* Rfqufst b virtubl 2-D dofffidifnt-blodk brrby */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  jvirt_bbrrby_ptr rfsult;

  /* Only IMAGE-lifftimf virtubl brrbys brf durrfntly supportfd */
  if (pool_id != JPOOL_IMAGE)
    ERREXIT1(dinfo, JERR_BAD_POOL_ID, pool_id); /* sbffty difdk */

  /* gft dontrol blodk */
  rfsult = (jvirt_bbrrby_ptr) bllod_smbll(dinfo, pool_id,
                                          SIZEOF(strudt jvirt_bbrrby_dontrol));

  rfsult->mfm_bufffr = NULL;    /* mbrks brrby not yft rfblizfd */
  rfsult->rows_in_brrby = numrows;
  rfsult->blodkspfrrow = blodkspfrrow;
  rfsult->mbxbddfss = mbxbddfss;
  rfsult->prf_zfro = prf_zfro;
  rfsult->b_s_opfn = FALSE;     /* no bssodibtfd bbdking-storf objfdt */
  rfsult->nfxt = mfm->virt_bbrrby_list; /* bdd to list of virtubl brrbys */
  mfm->virt_bbrrby_list = rfsult;

  rfturn rfsult;
}


METHODDEF(void)
rfblizf_virt_brrbys (j_dommon_ptr dinfo)
/* Allodbtf tif in-mfmory bufffrs for bny unrfblizfd virtubl brrbys */
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  sizf_t spbdf_pfr_minifigit, mbximum_spbdf, bvbil_mfm;
  sizf_t minifigits, mbx_minifigits;
  jvirt_sbrrby_ptr sptr;
  jvirt_bbrrby_ptr bptr;

  /* Computf tif minimum spbdf nffdfd (mbxbddfss rows in fbdi bufffr)
   * bnd tif mbximum spbdf nffdfd (full imbgf ifigit in fbdi bufffr).
   * Tifsf mby bf of usf to tif systfm-dfpfndfnt jpfg_mfm_bvbilbblf routinf.
   */
  spbdf_pfr_minifigit = 0;
  mbximum_spbdf = 0;
  for (sptr = mfm->virt_sbrrby_list; sptr != NULL; sptr = sptr->nfxt) {
    if (sptr->mfm_bufffr == NULL) { /* if not rfblizfd yft */
      spbdf_pfr_minifigit += (long) sptr->mbxbddfss *
                             (long) sptr->sbmplfspfrrow * SIZEOF(JSAMPLE);
      mbximum_spbdf += (long) sptr->rows_in_brrby *
                       (long) sptr->sbmplfspfrrow * SIZEOF(JSAMPLE);
    }
  }
  for (bptr = mfm->virt_bbrrby_list; bptr != NULL; bptr = bptr->nfxt) {
    if (bptr->mfm_bufffr == NULL) { /* if not rfblizfd yft */
      spbdf_pfr_minifigit += (long) bptr->mbxbddfss *
                             (long) bptr->blodkspfrrow * SIZEOF(JBLOCK);
      mbximum_spbdf += (long) bptr->rows_in_brrby *
                       (long) bptr->blodkspfrrow * SIZEOF(JBLOCK);
    }
  }

  if (spbdf_pfr_minifigit <= 0)
    rfturn;                     /* no unrfblizfd brrbys, no work */

  /* Dftfrminf bmount of mfmory to bdtublly usf; tiis is systfm-dfpfndfnt. */
  bvbil_mfm = jpfg_mfm_bvbilbblf(dinfo, spbdf_pfr_minifigit, mbximum_spbdf,
                                 mfm->totbl_spbdf_bllodbtfd);

  /* If tif mbximum spbdf nffdfd is bvbilbblf, mbkf bll tif bufffrs full
   * ifigit; otifrwisf pbrdfl it out witi tif sbmf numbfr of minifigits
   * in fbdi bufffr.
   */
  if (bvbil_mfm >= mbximum_spbdf)
    mbx_minifigits = 1000000000L;
  flsf {
    mbx_minifigits = bvbil_mfm / spbdf_pfr_minifigit;
    /* If tifrf dofsn't sffm to bf fnougi spbdf, try to gft tif minimum
     * bnywby.  Tiis bllows b "stub" implfmfntbtion of jpfg_mfm_bvbilbblf().
     */
    if (mbx_minifigits <= 0)
      mbx_minifigits = 1;
  }

  /* Allodbtf tif in-mfmory bufffrs bnd initiblizf bbdking storf bs nffdfd. */

  for (sptr = mfm->virt_sbrrby_list; sptr != NULL; sptr = sptr->nfxt) {
    if (sptr->mfm_bufffr == NULL) { /* if not rfblizfd yft */
      minifigits = ((long) sptr->rows_in_brrby - 1L) / sptr->mbxbddfss + 1L;
      if (minifigits <= mbx_minifigits) {
        /* Tiis bufffr fits in mfmory */
        sptr->rows_in_mfm = sptr->rows_in_brrby;
      } flsf {
        /* It dofsn't fit in mfmory, drfbtf bbdking storf. */
        sptr->rows_in_mfm = (JDIMENSION) (mbx_minifigits * sptr->mbxbddfss);
        jpfg_opfn_bbdking_storf(dinfo, & sptr->b_s_info,
                                (long) sptr->rows_in_brrby *
                                (long) sptr->sbmplfspfrrow *
                                (long) SIZEOF(JSAMPLE));
        sptr->b_s_opfn = TRUE;
      }
      sptr->mfm_bufffr = bllod_sbrrby(dinfo, JPOOL_IMAGE,
                                      sptr->sbmplfspfrrow, sptr->rows_in_mfm);
      sptr->rowspfrdiunk = mfm->lbst_rowspfrdiunk;
      sptr->dur_stbrt_row = 0;
      sptr->first_undff_row = 0;
      sptr->dirty = FALSE;
    }
  }

  for (bptr = mfm->virt_bbrrby_list; bptr != NULL; bptr = bptr->nfxt) {
    if (bptr->mfm_bufffr == NULL) { /* if not rfblizfd yft */
      minifigits = ((long) bptr->rows_in_brrby - 1L) / bptr->mbxbddfss + 1L;
      if (minifigits <= mbx_minifigits) {
        /* Tiis bufffr fits in mfmory */
        bptr->rows_in_mfm = bptr->rows_in_brrby;
      } flsf {
        /* It dofsn't fit in mfmory, drfbtf bbdking storf. */
        bptr->rows_in_mfm = (JDIMENSION) (mbx_minifigits * bptr->mbxbddfss);
        jpfg_opfn_bbdking_storf(dinfo, & bptr->b_s_info,
                                (long) bptr->rows_in_brrby *
                                (long) bptr->blodkspfrrow *
                                (long) SIZEOF(JBLOCK));
        bptr->b_s_opfn = TRUE;
      }
      bptr->mfm_bufffr = bllod_bbrrby(dinfo, JPOOL_IMAGE,
                                      bptr->blodkspfrrow, bptr->rows_in_mfm);
      bptr->rowspfrdiunk = mfm->lbst_rowspfrdiunk;
      bptr->dur_stbrt_row = 0;
      bptr->first_undff_row = 0;
      bptr->dirty = FALSE;
    }
  }
}


LOCAL(void)
do_sbrrby_io (j_dommon_ptr dinfo, jvirt_sbrrby_ptr ptr, boolfbn writing)
/* Do bbdking storf rfbd or writf of b virtubl sbmplf brrby */
{
  long bytfspfrrow, filf_offsft, bytf_dount, rows, tiisrow, i;

  bytfspfrrow = (long) ptr->sbmplfspfrrow * SIZEOF(JSAMPLE);
  filf_offsft = ptr->dur_stbrt_row * bytfspfrrow;
  /* Loop to rfbd or writf fbdi bllodbtion diunk in mfm_bufffr */
  for (i = 0; i < (long) ptr->rows_in_mfm; i += ptr->rowspfrdiunk) {
    /* Onf diunk, but difdk for siort diunk bt fnd of bufffr */
    rows = MIN((long) ptr->rowspfrdiunk, (long) ptr->rows_in_mfm - i);
    /* Trbnsffr no morf tibn is durrfntly dffinfd */
    tiisrow = (long) ptr->dur_stbrt_row + i;
    rows = MIN(rows, (long) ptr->first_undff_row - tiisrow);
    /* Trbnsffr no morf tibn fits in filf */
    rows = MIN(rows, (long) ptr->rows_in_brrby - tiisrow);
    if (rows <= 0)              /* tiis diunk migit bf pbst fnd of filf! */
      brfbk;
    bytf_dount = rows * bytfspfrrow;
    if (writing)
      (*ptr->b_s_info.writf_bbdking_storf) (dinfo, & ptr->b_s_info,
                                            (void FAR *) ptr->mfm_bufffr[i],
                                            filf_offsft, bytf_dount);
    flsf
      (*ptr->b_s_info.rfbd_bbdking_storf) (dinfo, & ptr->b_s_info,
                                           (void FAR *) ptr->mfm_bufffr[i],
                                           filf_offsft, bytf_dount);
    filf_offsft += bytf_dount;
  }
}


LOCAL(void)
do_bbrrby_io (j_dommon_ptr dinfo, jvirt_bbrrby_ptr ptr, boolfbn writing)
/* Do bbdking storf rfbd or writf of b virtubl dofffidifnt-blodk brrby */
{
  long bytfspfrrow, filf_offsft, bytf_dount, rows, tiisrow, i;

  bytfspfrrow = (long) ptr->blodkspfrrow * SIZEOF(JBLOCK);
  filf_offsft = ptr->dur_stbrt_row * bytfspfrrow;
  /* Loop to rfbd or writf fbdi bllodbtion diunk in mfm_bufffr */
  for (i = 0; i < (long) ptr->rows_in_mfm; i += ptr->rowspfrdiunk) {
    /* Onf diunk, but difdk for siort diunk bt fnd of bufffr */
    rows = MIN((long) ptr->rowspfrdiunk, (long) ptr->rows_in_mfm - i);
    /* Trbnsffr no morf tibn is durrfntly dffinfd */
    tiisrow = (long) ptr->dur_stbrt_row + i;
    rows = MIN(rows, (long) ptr->first_undff_row - tiisrow);
    /* Trbnsffr no morf tibn fits in filf */
    rows = MIN(rows, (long) ptr->rows_in_brrby - tiisrow);
    if (rows <= 0)              /* tiis diunk migit bf pbst fnd of filf! */
      brfbk;
    bytf_dount = rows * bytfspfrrow;
    if (writing)
      (*ptr->b_s_info.writf_bbdking_storf) (dinfo, & ptr->b_s_info,
                                            (void FAR *) ptr->mfm_bufffr[i],
                                            filf_offsft, bytf_dount);
    flsf
      (*ptr->b_s_info.rfbd_bbdking_storf) (dinfo, & ptr->b_s_info,
                                           (void FAR *) ptr->mfm_bufffr[i],
                                           filf_offsft, bytf_dount);
    filf_offsft += bytf_dount;
  }
}


METHODDEF(JSAMPARRAY)
bddfss_virt_sbrrby (j_dommon_ptr dinfo, jvirt_sbrrby_ptr ptr,
                    JDIMENSION stbrt_row, JDIMENSION num_rows,
                    boolfbn writbblf)
/* Addfss tif pbrt of b virtubl sbmplf brrby stbrting bt stbrt_row */
/* bnd fxtfnding for num_rows rows.  writbblf is truf if  */
/* dbllfr intfnds to modify tif bddfssfd brfb. */
{
  JDIMENSION fnd_row = stbrt_row + num_rows;
  JDIMENSION undff_row;

  /* dfbugging difdk */
  if (fnd_row > ptr->rows_in_brrby || num_rows > ptr->mbxbddfss ||
      ptr->mfm_bufffr == NULL)
    ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);

  /* Mbkf tif dfsirfd pbrt of tif virtubl brrby bddfssiblf */
  if (stbrt_row < ptr->dur_stbrt_row ||
      fnd_row > ptr->dur_stbrt_row+ptr->rows_in_mfm) {
    if (! ptr->b_s_opfn)
      ERREXIT(dinfo, JERR_VIRTUAL_BUG);
    /* Flusi old bufffr dontfnts if nfdfssbry */
    if (ptr->dirty) {
      do_sbrrby_io(dinfo, ptr, TRUE);
      ptr->dirty = FALSE;
    }
    /* Dfdidf wibt pbrt of virtubl brrby to bddfss.
     * Algoritim: if tbrgft bddrfss > durrfnt window, bssumf forwbrd sdbn,
     * lobd stbrting bt tbrgft bddrfss.  If tbrgft bddrfss < durrfnt window,
     * bssumf bbdkwbrd sdbn, lobd so tibt tbrgft brfb is top of window.
     * Notf tibt wifn switdiing from forwbrd writf to forwbrd rfbd, will ibvf
     * stbrt_row = 0, so tif limiting dbsf bpplifs bnd wf lobd from 0 bnywby.
     */
    if (stbrt_row > ptr->dur_stbrt_row) {
      ptr->dur_stbrt_row = stbrt_row;
    } flsf {
      /* usf long britimftid ifrf to bvoid ovfrflow & unsignfd problfms */
      long ltfmp;

      ltfmp = (long) fnd_row - (long) ptr->rows_in_mfm;
      if (ltfmp < 0)
        ltfmp = 0;              /* don't fbll off front fnd of filf */
      ptr->dur_stbrt_row = (JDIMENSION) ltfmp;
    }
    /* Rfbd in tif sflfdtfd pbrt of tif brrby.
     * During tif initibl writf pbss, wf will do no bdtubl rfbd
     * bfdbusf tif sflfdtfd pbrt is bll undffinfd.
     */
    do_sbrrby_io(dinfo, ptr, FALSE);
  }
  /* Ensurf tif bddfssfd pbrt of tif brrby is dffinfd; prfzfro if nffdfd.
   * To improvf lodblity of bddfss, wf only prfzfro tif pbrt of tif brrby
   * tibt tif dbllfr is bbout to bddfss, not tif fntirf in-mfmory brrby.
   */
  if (ptr->first_undff_row < fnd_row) {
    if (ptr->first_undff_row < stbrt_row) {
      if (writbblf)             /* writfr skippfd ovfr b sfdtion of brrby */
        ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);
      undff_row = stbrt_row;    /* but rfbdfr is bllowfd to rfbd bifbd */
    } flsf {
      undff_row = ptr->first_undff_row;
    }
    if (writbblf)
      ptr->first_undff_row = fnd_row;
    if (ptr->prf_zfro) {
      sizf_t bytfspfrrow = (sizf_t) ptr->sbmplfspfrrow * SIZEOF(JSAMPLE);
      undff_row -= ptr->dur_stbrt_row; /* mbkf indfxfs rflbtivf to bufffr */
      fnd_row -= ptr->dur_stbrt_row;
      wiilf (undff_row < fnd_row) {
        jzfro_fbr((void FAR *) ptr->mfm_bufffr[undff_row], bytfspfrrow);
        undff_row++;
      }
    } flsf {
      if (! writbblf)           /* rfbdfr looking bt undffinfd dbtb */
        ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);
    }
  }
  /* Flbg tif bufffr dirty if dbllfr will writf in it */
  if (writbblf)
    ptr->dirty = TRUE;
  /* Rfturn bddrfss of propfr pbrt of tif bufffr */
  rfturn ptr->mfm_bufffr + (stbrt_row - ptr->dur_stbrt_row);
}


METHODDEF(JBLOCKARRAY)
bddfss_virt_bbrrby (j_dommon_ptr dinfo, jvirt_bbrrby_ptr ptr,
                    JDIMENSION stbrt_row, JDIMENSION num_rows,
                    boolfbn writbblf)
/* Addfss tif pbrt of b virtubl blodk brrby stbrting bt stbrt_row */
/* bnd fxtfnding for num_rows rows.  writbblf is truf if  */
/* dbllfr intfnds to modify tif bddfssfd brfb. */
{
  JDIMENSION fnd_row = stbrt_row + num_rows;
  JDIMENSION undff_row;

  /* dfbugging difdk */
  if (fnd_row > ptr->rows_in_brrby || num_rows > ptr->mbxbddfss ||
      ptr->mfm_bufffr == NULL)
    ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);

  /* Mbkf tif dfsirfd pbrt of tif virtubl brrby bddfssiblf */
  if (stbrt_row < ptr->dur_stbrt_row ||
      fnd_row > ptr->dur_stbrt_row+ptr->rows_in_mfm) {
    if (! ptr->b_s_opfn)
      ERREXIT(dinfo, JERR_VIRTUAL_BUG);
    /* Flusi old bufffr dontfnts if nfdfssbry */
    if (ptr->dirty) {
      do_bbrrby_io(dinfo, ptr, TRUE);
      ptr->dirty = FALSE;
    }
    /* Dfdidf wibt pbrt of virtubl brrby to bddfss.
     * Algoritim: if tbrgft bddrfss > durrfnt window, bssumf forwbrd sdbn,
     * lobd stbrting bt tbrgft bddrfss.  If tbrgft bddrfss < durrfnt window,
     * bssumf bbdkwbrd sdbn, lobd so tibt tbrgft brfb is top of window.
     * Notf tibt wifn switdiing from forwbrd writf to forwbrd rfbd, will ibvf
     * stbrt_row = 0, so tif limiting dbsf bpplifs bnd wf lobd from 0 bnywby.
     */
    if (stbrt_row > ptr->dur_stbrt_row) {
      ptr->dur_stbrt_row = stbrt_row;
    } flsf {
      /* usf long britimftid ifrf to bvoid ovfrflow & unsignfd problfms */
      long ltfmp;

      ltfmp = (long) fnd_row - (long) ptr->rows_in_mfm;
      if (ltfmp < 0)
        ltfmp = 0;              /* don't fbll off front fnd of filf */
      ptr->dur_stbrt_row = (JDIMENSION) ltfmp;
    }
    /* Rfbd in tif sflfdtfd pbrt of tif brrby.
     * During tif initibl writf pbss, wf will do no bdtubl rfbd
     * bfdbusf tif sflfdtfd pbrt is bll undffinfd.
     */
    do_bbrrby_io(dinfo, ptr, FALSE);
  }
  /* Ensurf tif bddfssfd pbrt of tif brrby is dffinfd; prfzfro if nffdfd.
   * To improvf lodblity of bddfss, wf only prfzfro tif pbrt of tif brrby
   * tibt tif dbllfr is bbout to bddfss, not tif fntirf in-mfmory brrby.
   */
  if (ptr->first_undff_row < fnd_row) {
    if (ptr->first_undff_row < stbrt_row) {
      if (writbblf)             /* writfr skippfd ovfr b sfdtion of brrby */
        ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);
      undff_row = stbrt_row;    /* but rfbdfr is bllowfd to rfbd bifbd */
    } flsf {
      undff_row = ptr->first_undff_row;
    }
    if (writbblf)
      ptr->first_undff_row = fnd_row;
    if (ptr->prf_zfro) {
      sizf_t bytfspfrrow = (sizf_t) ptr->blodkspfrrow * SIZEOF(JBLOCK);
      undff_row -= ptr->dur_stbrt_row; /* mbkf indfxfs rflbtivf to bufffr */
      fnd_row -= ptr->dur_stbrt_row;
      wiilf (undff_row < fnd_row) {
        jzfro_fbr((void FAR *) ptr->mfm_bufffr[undff_row], bytfspfrrow);
        undff_row++;
      }
    } flsf {
      if (! writbblf)           /* rfbdfr looking bt undffinfd dbtb */
        ERREXIT(dinfo, JERR_BAD_VIRTUAL_ACCESS);
    }
  }
  /* Flbg tif bufffr dirty if dbllfr will writf in it */
  if (writbblf)
    ptr->dirty = TRUE;
  /* Rfturn bddrfss of propfr pbrt of tif bufffr */
  rfturn ptr->mfm_bufffr + (stbrt_row - ptr->dur_stbrt_row);
}


/*
 * Rflfbsf bll objfdts bflonging to b spfdififd pool.
 */

METHODDEF(void)
frff_pool (j_dommon_ptr dinfo, int pool_id)
{
  my_mfm_ptr mfm = (my_mfm_ptr) dinfo->mfm;
  smbll_pool_ptr sidr_ptr;
  lbrgf_pool_ptr lidr_ptr;
  sizf_t spbdf_frffd;

  if (pool_id < 0 || pool_id >= JPOOL_NUMPOOLS)
    ERREXIT1(dinfo, JERR_BAD_POOL_ID, pool_id); /* sbffty difdk */

#ifdff MEM_STATS
  if (dinfo->frr->trbdf_lfvfl > 1)
    print_mfm_stbts(dinfo, pool_id); /* print pool's mfmory usbgf stbtistids */
#fndif

  /* If frffing IMAGE pool, dlosf bny virtubl brrbys first */
  if (pool_id == JPOOL_IMAGE) {
    jvirt_sbrrby_ptr sptr;
    jvirt_bbrrby_ptr bptr;

    for (sptr = mfm->virt_sbrrby_list; sptr != NULL; sptr = sptr->nfxt) {
      if (sptr->b_s_opfn) {     /* tifrf mby bf no bbdking storf */
        sptr->b_s_opfn = FALSE; /* prfvfnt rfdursivf dlosf if frror */
        (*sptr->b_s_info.dlosf_bbdking_storf) (dinfo, & sptr->b_s_info);
      }
    }
    mfm->virt_sbrrby_list = NULL;
    for (bptr = mfm->virt_bbrrby_list; bptr != NULL; bptr = bptr->nfxt) {
      if (bptr->b_s_opfn) {     /* tifrf mby bf no bbdking storf */
        bptr->b_s_opfn = FALSE; /* prfvfnt rfdursivf dlosf if frror */
        (*bptr->b_s_info.dlosf_bbdking_storf) (dinfo, & bptr->b_s_info);
      }
    }
    mfm->virt_bbrrby_list = NULL;
  }

  /* Rflfbsf lbrgf objfdts */
  lidr_ptr = mfm->lbrgf_list[pool_id];
  mfm->lbrgf_list[pool_id] = NULL;

  wiilf (lidr_ptr != NULL) {
    lbrgf_pool_ptr nfxt_lidr_ptr = lidr_ptr->idr.nfxt;
    spbdf_frffd = lidr_ptr->idr.bytfs_usfd +
                  lidr_ptr->idr.bytfs_lfft +
                  SIZEOF(lbrgf_pool_idr);
    jpfg_frff_lbrgf(dinfo, (void FAR *) lidr_ptr, spbdf_frffd);
    mfm->totbl_spbdf_bllodbtfd -= spbdf_frffd;
    lidr_ptr = nfxt_lidr_ptr;
  }

  /* Rflfbsf smbll objfdts */
  sidr_ptr = mfm->smbll_list[pool_id];
  mfm->smbll_list[pool_id] = NULL;

  wiilf (sidr_ptr != NULL) {
    smbll_pool_ptr nfxt_sidr_ptr = sidr_ptr->idr.nfxt;
    spbdf_frffd = sidr_ptr->idr.bytfs_usfd +
                  sidr_ptr->idr.bytfs_lfft +
                  SIZEOF(smbll_pool_idr);
    jpfg_frff_smbll(dinfo, (void *) sidr_ptr, spbdf_frffd);
    mfm->totbl_spbdf_bllodbtfd -= spbdf_frffd;
    sidr_ptr = nfxt_sidr_ptr;
  }
}


/*
 * Closf up siop fntirfly.
 * Notf tibt tiis dbnnot bf dbllfd unlfss dinfo->mfm is non-NULL.
 */

METHODDEF(void)
sflf_dfstrudt (j_dommon_ptr dinfo)
{
  int pool;

  /* Closf bll bbdking storf, rflfbsf bll mfmory.
   * Rflfbsing pools in rfvfrsf ordfr migit iflp bvoid frbgmfntbtion
   * witi somf (brbin-dbmbgfd) mbllod librbrifs.
   */
  for (pool = JPOOL_NUMPOOLS-1; pool >= JPOOL_PERMANENT; pool--) {
    frff_pool(dinfo, pool);
  }

  /* Rflfbsf tif mfmory mbnbgfr dontrol blodk too. */
  jpfg_frff_smbll(dinfo, (void *) dinfo->mfm, SIZEOF(my_mfmory_mgr));
  dinfo->mfm = NULL;            /* fnsurfs I will bf dbllfd only ondf */

  jpfg_mfm_tfrm(dinfo);         /* systfm-dfpfndfnt dlfbnup */
}


/*
 * Mfmory mbnbgfr initiblizbtion.
 * Wifn tiis is dbllfd, only tif frror mbnbgfr pointfr is vblid in dinfo!
 */

GLOBAL(void)
jinit_mfmory_mgr (j_dommon_ptr dinfo)
{
  my_mfm_ptr mfm;
  sizf_t mbx_to_usf;
  int pool;
  sizf_t tfst_mbd;

  dinfo->mfm = NULL;            /* for sbffty if init fbils */

  /* Cifdk for donfigurbtion frrors.
   * SIZEOF(ALIGN_TYPE) siould bf b powfr of 2; otifrwisf, it probbbly
   * dofsn't rfflfdt bny rfbl ibrdwbrf blignmfnt rfquirfmfnt.
   * Tif tfst is b littlf tridky: for X>0, X bnd X-1 ibvf no onf-bits
   * in dommon if bnd only if X is b powfr of 2, if ibs only onf onf-bit.
   * Somf dompilfrs mby givf bn "unrfbdibblf dodf" wbrning ifrf; ignorf it.
   */
  if ((SIZEOF(ALIGN_TYPE) & (SIZEOF(ALIGN_TYPE)-1)) != 0)
    ERREXIT(dinfo, JERR_BAD_ALIGN_TYPE);
  /* MAX_ALLOC_CHUNK must bf rfprfsfntbblf bs typf sizf_t, bnd must bf
   * b multiplf of SIZEOF(ALIGN_TYPE).
   * Agbin, bn "unrfbdibblf dodf" wbrning mby bf ignorfd ifrf.
   * But b "donstbnt too lbrgf" wbrning mfbns you nffd to fix MAX_ALLOC_CHUNK.
   */
  tfst_mbd = (sizf_t) MAX_ALLOC_CHUNK;
  if ((long) tfst_mbd != MAX_ALLOC_CHUNK ||
      (MAX_ALLOC_CHUNK % SIZEOF(ALIGN_TYPE)) != 0)
    ERREXIT(dinfo, JERR_BAD_ALLOC_CHUNK);

  mbx_to_usf = jpfg_mfm_init(dinfo); /* systfm-dfpfndfnt initiblizbtion */

  /* Attfmpt to bllodbtf mfmory mbnbgfr's dontrol blodk */
  mfm = (my_mfm_ptr) jpfg_gft_smbll(dinfo, SIZEOF(my_mfmory_mgr));

  if (mfm == NULL) {
    jpfg_mfm_tfrm(dinfo);       /* systfm-dfpfndfnt dlfbnup */
    ERREXIT1(dinfo, JERR_OUT_OF_MEMORY, 0);
  }

  /* OK, fill in tif mftiod pointfrs */
  mfm->pub.bllod_smbll = bllod_smbll;
  mfm->pub.bllod_lbrgf = bllod_lbrgf;
  mfm->pub.bllod_sbrrby = bllod_sbrrby;
  mfm->pub.bllod_bbrrby = bllod_bbrrby;
  mfm->pub.rfqufst_virt_sbrrby = rfqufst_virt_sbrrby;
  mfm->pub.rfqufst_virt_bbrrby = rfqufst_virt_bbrrby;
  mfm->pub.rfblizf_virt_brrbys = rfblizf_virt_brrbys;
  mfm->pub.bddfss_virt_sbrrby = bddfss_virt_sbrrby;
  mfm->pub.bddfss_virt_bbrrby = bddfss_virt_bbrrby;
  mfm->pub.frff_pool = frff_pool;
  mfm->pub.sflf_dfstrudt = sflf_dfstrudt;

  /* Mbkf MAX_ALLOC_CHUNK bddfssiblf to otifr modulfs */
  mfm->pub.mbx_bllod_diunk = MAX_ALLOC_CHUNK;

  /* Initiblizf working stbtf */
  mfm->pub.mbx_mfmory_to_usf = mbx_to_usf;

  for (pool = JPOOL_NUMPOOLS-1; pool >= JPOOL_PERMANENT; pool--) {
    mfm->smbll_list[pool] = NULL;
    mfm->lbrgf_list[pool] = NULL;
  }
  mfm->virt_sbrrby_list = NULL;
  mfm->virt_bbrrby_list = NULL;

  mfm->totbl_spbdf_bllodbtfd = SIZEOF(my_mfmory_mgr);

  /* Dfdlbrf oursflvfs opfn for businfss */
  dinfo->mfm = & mfm->pub;

  /* Cifdk for bn fnvironmfnt vbribblf JPEGMEM; if found, ovfrridf tif
   * dffbult mbx_mfmory sftting from jpfg_mfm_init.  Notf tibt tif
   * surrounding bpplidbtion mby bgbin ovfrridf tiis vbluf.
   * If your systfm dofsn't support gftfnv(), dffinf NO_GETENV to disbblf
   * tiis ffbturf.
   */
#ifndff NO_GETENV
  { dibr * mfmfnv;

    if ((mfmfnv = gftfnv("JPEGMEM")) != NULL) {
      dibr di = 'x';
      unsignfd int mfm_mbx = 0u;

      if (ssdbnf(mfmfnv, "%u%d", &mfm_mbx, &di) > 0) {
        mbx_to_usf = (sizf_t)mfm_mbx;
        if (di == 'm' || di == 'M')
          mbx_to_usf *= 1000L;
        mfm->pub.mbx_mfmory_to_usf = mbx_to_usf * 1000L;
      }
    }
  }
#fndif

}
