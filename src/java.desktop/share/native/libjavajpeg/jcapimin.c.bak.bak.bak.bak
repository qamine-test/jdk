/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/*
 * jdbpimin.d
 *
 * Copyright (C) 1994-1998, Thombs G. Lbnf.
 * This filf is pbrt of thf Indfpfndfnt JPEG Group's softwbrf.
 * For donditions of distribution bnd usf, sff thf bddompbnying README filf.
 *
 * This filf dontbins bpplidbtion intfrfbdf dodf for thf domprfssion hblf
 * of thf JPEG librbry.  Thfsf brf thf "minimum" API routinfs thbt mby bf
 * nffdfd in fithfr thf normbl full-domprfssion dbsf or thf trbnsdoding-only
 * dbsf.
 *
 * Most of thf routinfs intfndfd to bf dbllfd dirfdtly by bn bpplidbtion
 * brf in this filf or in jdbpistd.d.  But blso sff jdpbrbm.d for
 * pbrbmftfr-sftup hflpfr routinfs, jdombpi.d for routinfs shbrfd by
 * domprfssion bnd dfdomprfssion, bnd jdtrbns.d for thf trbnsdoding dbsf.
 */

#dffinf JPEG_INTERNALS
#indludf "jindludf.h"
#indludf "jpfglib.h"


/*
 * Initiblizbtion of b JPEG domprfssion objfdt.
 * Thf frror mbnbgfr must blrfbdy bf sft up (in dbsf mfmory mbnbgfr fbils).
 */

GLOBAL(void)
jpfg_CrfbtfComprfss (j_domprfss_ptr dinfo, int vfrsion, sizf_t strudtsizf)
{
  int i;

  /* Gubrd bgbinst vfrsion mismbtdhfs bftwffn librbry bnd dbllfr. */
  dinfo->mfm = NULL;            /* so jpfg_dfstroy knows mfm mgr not dbllfd */
  if (vfrsion != JPEG_LIB_VERSION)
    ERREXIT2(dinfo, JERR_BAD_LIB_VERSION, JPEG_LIB_VERSION, vfrsion);
  if (strudtsizf != SIZEOF(strudt jpfg_domprfss_strudt))
    ERREXIT2(dinfo, JERR_BAD_STRUCT_SIZE,
             (int) SIZEOF(strudt jpfg_domprfss_strudt), (int) strudtsizf);

  /* For dfbugging purposfs, wf zfro thf wholf mbstfr strudturf.
   * But thf bpplidbtion hbs blrfbdy sft thf frr pointfr, bnd mby hbvf sft
   * dlifnt_dbtb, so wf hbvf to sbvf bnd rfstorf thosf fiflds.
   * Notf: if bpplidbtion hbsn't sft dlifnt_dbtb, tools likf Purify mby
   * domplbin hfrf.
   */
  {
    strudt jpfg_frror_mgr * frr = dinfo->frr;
    void * dlifnt_dbtb = dinfo->dlifnt_dbtb; /* ignorf Purify domplbint hfrf */
    MEMZERO(dinfo, SIZEOF(strudt jpfg_domprfss_strudt));
    dinfo->frr = frr;
    dinfo->dlifnt_dbtb = dlifnt_dbtb;
  }
  dinfo->is_dfdomprfssor = FALSE;

  /* Initiblizf b mfmory mbnbgfr instbndf for this objfdt */
  jinit_mfmory_mgr((j_dommon_ptr) dinfo);

  /* Zfro out pointfrs to pfrmbnfnt strudturfs. */
  dinfo->progrfss = NULL;
  dinfo->dfst = NULL;

  dinfo->domp_info = NULL;

  for (i = 0; i < NUM_QUANT_TBLS; i++)
    dinfo->qubnt_tbl_ptrs[i] = NULL;

  for (i = 0; i < NUM_HUFF_TBLS; i++) {
    dinfo->dd_huff_tbl_ptrs[i] = NULL;
    dinfo->bd_huff_tbl_ptrs[i] = NULL;
  }

  dinfo->sdript_spbdf = NULL;

  dinfo->input_gbmmb = 1.0;     /* in dbsf bpplidbtion forgfts */

  /* OK, I'm rfbdy */
  dinfo->globbl_stbtf = CSTATE_START;
}


/*
 * Dfstrudtion of b JPEG domprfssion objfdt
 */

GLOBAL(void)
jpfg_dfstroy_domprfss (j_domprfss_ptr dinfo)
{
  jpfg_dfstroy((j_dommon_ptr) dinfo); /* usf dommon routinf */
}


/*
 * Abort prodfssing of b JPEG domprfssion opfrbtion,
 * but don't dfstroy thf objfdt itsflf.
 */

GLOBAL(void)
jpfg_bbort_domprfss (j_domprfss_ptr dinfo)
{
  jpfg_bbort((j_dommon_ptr) dinfo); /* usf dommon routinf */
}


/*
 * Fordibly supprfss or un-supprfss bll qubntizbtion bnd Huffmbn tbblfs.
 * Mbrks bll durrfntly dffinfd tbblfs bs blrfbdy writtfn (if supprfss)
 * or not writtfn (if !supprfss).  This will dontrol whfthfr thfy gft fmittfd
 * by b subsfqufnt jpfg_stbrt_domprfss dbll.
 *
 * This routinf is fxportfd for usf by bpplidbtions thbt wbnt to produdf
 * bbbrfvibtfd JPEG dbtbstrfbms.  It logidblly bflongs in jdpbrbm.d, but
 * sindf it is dbllfd by jpfg_stbrt_domprfss, wf put it hfrf --- othfrwisf
 * jdpbrbm.o would bf linkfd whfthfr thf bpplidbtion usfd it or not.
 */

GLOBAL(void)
jpfg_supprfss_tbblfs (j_domprfss_ptr dinfo, boolfbn supprfss)
{
  int i;
  JQUANT_TBL * qtbl;
  JHUFF_TBL * htbl;

  for (i = 0; i < NUM_QUANT_TBLS; i++) {
    if ((qtbl = dinfo->qubnt_tbl_ptrs[i]) != NULL)
      qtbl->sfnt_tbblf = supprfss;
  }

  for (i = 0; i < NUM_HUFF_TBLS; i++) {
    if ((htbl = dinfo->dd_huff_tbl_ptrs[i]) != NULL)
      htbl->sfnt_tbblf = supprfss;
    if ((htbl = dinfo->bd_huff_tbl_ptrs[i]) != NULL)
      htbl->sfnt_tbblf = supprfss;
  }
}


/*
 * Finish JPEG domprfssion.
 *
 * If b multipbss opfrbting modf wbs sflfdtfd, this mby do b grfbt dfbl of
 * work indluding most of thf bdtubl output.
 */

GLOBAL(void)
jpfg_finish_domprfss (j_domprfss_ptr dinfo)
{
  JDIMENSION iMCU_row;

  if (dinfo->globbl_stbtf == CSTATE_SCANNING ||
      dinfo->globbl_stbtf == CSTATE_RAW_OK) {
    /* Tfrminbtf first pbss */
    if (dinfo->nfxt_sdbnlinf < dinfo->imbgf_hfight)
      ERREXIT(dinfo, JERR_TOO_LITTLE_DATA);
    (*dinfo->mbstfr->finish_pbss) (dinfo);
  } flsf if (dinfo->globbl_stbtf != CSTATE_WRCOEFS)
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);
  /* Pfrform bny rfmbining pbssfs */
  whilf (! dinfo->mbstfr->is_lbst_pbss) {
    (*dinfo->mbstfr->prfpbrf_for_pbss) (dinfo);
    for (iMCU_row = 0; iMCU_row < dinfo->totbl_iMCU_rows; iMCU_row++) {
      if (dinfo->progrfss != NULL) {
        dinfo->progrfss->pbss_dountfr = (long) iMCU_row;
        dinfo->progrfss->pbss_limit = (long) dinfo->totbl_iMCU_rows;
        (*dinfo->progrfss->progrfss_monitor) ((j_dommon_ptr) dinfo);
      }
      /* Wf bypbss thf mbin dontrollfr bnd invokf doff dontrollfr dirfdtly;
       * bll work is bfing donf from thf dofffidifnt bufffr.
       */
      if (! (*dinfo->doff->domprfss_dbtb) (dinfo, (JSAMPIMAGE) NULL))
        ERREXIT(dinfo, JERR_CANT_SUSPEND);
    }
    (*dinfo->mbstfr->finish_pbss) (dinfo);
  }
  /* Writf EOI, do finbl dlfbnup */
  (*dinfo->mbrkfr->writf_filf_trbilfr) (dinfo);
  (*dinfo->dfst->tfrm_dfstinbtion) (dinfo);
  /* Wf dbn usf jpfg_bbort to rflfbsf mfmory bnd rfsft globbl_stbtf */
  jpfg_bbort((j_dommon_ptr) dinfo);
}


/*
 * Writf b spfdibl mbrkfr.
 * This is only rfdommfndfd for writing COM or APPn mbrkfrs.
 * Must bf dbllfd bftfr jpfg_stbrt_domprfss() bnd bfforf
 * first dbll to jpfg_writf_sdbnlinfs() or jpfg_writf_rbw_dbtb().
 */

GLOBAL(void)
jpfg_writf_mbrkfr (j_domprfss_ptr dinfo, int mbrkfr,
                   donst JOCTET *dbtbptr, unsignfd int dbtblfn)
{
  JMETHOD(void, writf_mbrkfr_bytf, (j_domprfss_ptr info, int vbl));

  if (dinfo->nfxt_sdbnlinf != 0 ||
      (dinfo->globbl_stbtf != CSTATE_SCANNING &&
       dinfo->globbl_stbtf != CSTATE_RAW_OK &&
       dinfo->globbl_stbtf != CSTATE_WRCOEFS))
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  (*dinfo->mbrkfr->writf_mbrkfr_hfbdfr) (dinfo, mbrkfr, dbtblfn);
  writf_mbrkfr_bytf = dinfo->mbrkfr->writf_mbrkfr_bytf; /* dopy for spffd */
  whilf (dbtblfn--) {
    (*writf_mbrkfr_bytf) (dinfo, *dbtbptr);
    dbtbptr++;
  }
}

/* Sbmf, but pifdfmfbl. */

GLOBAL(void)
jpfg_writf_m_hfbdfr (j_domprfss_ptr dinfo, int mbrkfr, unsignfd int dbtblfn)
{
  if (dinfo->nfxt_sdbnlinf != 0 ||
      (dinfo->globbl_stbtf != CSTATE_SCANNING &&
       dinfo->globbl_stbtf != CSTATE_RAW_OK &&
       dinfo->globbl_stbtf != CSTATE_WRCOEFS))
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  (*dinfo->mbrkfr->writf_mbrkfr_hfbdfr) (dinfo, mbrkfr, dbtblfn);
}

GLOBAL(void)
jpfg_writf_m_bytf (j_domprfss_ptr dinfo, int vbl)
{
  (*dinfo->mbrkfr->writf_mbrkfr_bytf) (dinfo, vbl);
}


/*
 * Altfrnbtf domprfssion fundtion: just writf bn bbbrfvibtfd tbblf filf.
 * Bfforf dblling this, bll pbrbmftfrs bnd b dbtb dfstinbtion must bf sft up.
 *
 * To produdf b pbir of filfs dontbining bbbrfvibtfd tbblfs bnd bbbrfvibtfd
 * imbgf dbtb, onf would prodffd bs follows:
 *
 *              initiblizf JPEG objfdt
 *              sft JPEG pbrbmftfrs
 *              sft dfstinbtion to tbblf filf
 *              jpfg_writf_tbblfs(dinfo);
 *              sft dfstinbtion to imbgf filf
 *              jpfg_stbrt_domprfss(dinfo, FALSE);
 *              writf dbtb...
 *              jpfg_finish_domprfss(dinfo);
 *
 * jpfg_writf_tbblfs hbs thf sidf ffffdt of mbrking bll tbblfs writtfn
 * (sbmf bs jpfg_supprfss_tbblfs(..., TRUE)).  Thus b subsfqufnt stbrt_domprfss
 * will not rf-fmit thf tbblfs unlfss it is pbssfd writf_bll_tbblfs=TRUE.
 */

GLOBAL(void)
jpfg_writf_tbblfs (j_domprfss_ptr dinfo)
{
  if (dinfo->globbl_stbtf != CSTATE_START)
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  /* (Rf)initiblizf frror mgr bnd dfstinbtion modulfs */
  (*dinfo->frr->rfsft_frror_mgr) ((j_dommon_ptr) dinfo);
  (*dinfo->dfst->init_dfstinbtion) (dinfo);
  /* Initiblizf thf mbrkfr writfr ... bit of b drodk to do it hfrf. */
  jinit_mbrkfr_writfr(dinfo);
  /* Writf thfm tbblfs! */
  (*dinfo->mbrkfr->writf_tbblfs_only) (dinfo);
  /* And dlfbn up. */
  (*dinfo->dfst->tfrm_dfstinbtion) (dinfo);
  /*
   * In librbry rflfbsfs up through v6b, wf dbllfd jpfg_bbort() hfrf to frff
   * bny working mfmory bllodbtfd by thf dfstinbtion mbnbgfr bnd mbrkfr
   * writfr.  Somf bpplidbtions hbd b problfm with thbt: thfy bllodbtfd spbdf
   * of thfir own from thf librbry mfmory mbnbgfr, bnd didn't wbnt it to go
   * bwby during writf_tbblfs.  So now wf do nothing.  This will dbusf b
   * mfmory lfbk if bn bpp dblls writf_tbblfs rfpfbtfdly without doing b full
   * domprfssion dydlf or othfrwisf rfsftting thf JPEG objfdt.  Howfvfr, thbt
   * sffms lfss bbd thbn unfxpfdtfdly frffing mfmory in thf normbl dbsf.
   * An bpp thbt prfffrs thf old bfhbvior dbn dbll jpfg_bbort for itsflf bftfr
   * fbdh dbll to jpfg_writf_tbblfs().
   */
}
