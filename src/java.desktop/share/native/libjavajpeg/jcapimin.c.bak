/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/*
 * jdbpimin.d
 *
 * Copyrigit (C) 1994-1998, Tiombs G. Lbnf.
 * Tiis filf is pbrt of tif Indfpfndfnt JPEG Group's softwbrf.
 * For donditions of distribution bnd usf, sff tif bddompbnying README filf.
 *
 * Tiis filf dontbins bpplidbtion intfrfbdf dodf for tif domprfssion iblf
 * of tif JPEG librbry.  Tifsf brf tif "minimum" API routinfs tibt mby bf
 * nffdfd in fitifr tif normbl full-domprfssion dbsf or tif trbnsdoding-only
 * dbsf.
 *
 * Most of tif routinfs intfndfd to bf dbllfd dirfdtly by bn bpplidbtion
 * brf in tiis filf or in jdbpistd.d.  But blso sff jdpbrbm.d for
 * pbrbmftfr-sftup iflpfr routinfs, jdombpi.d for routinfs sibrfd by
 * domprfssion bnd dfdomprfssion, bnd jdtrbns.d for tif trbnsdoding dbsf.
 */

#dffinf JPEG_INTERNALS
#indludf "jindludf.i"
#indludf "jpfglib.i"


/*
 * Initiblizbtion of b JPEG domprfssion objfdt.
 * Tif frror mbnbgfr must blrfbdy bf sft up (in dbsf mfmory mbnbgfr fbils).
 */

GLOBAL(void)
jpfg_CrfbtfComprfss (j_domprfss_ptr dinfo, int vfrsion, sizf_t strudtsizf)
{
  int i;

  /* Gubrd bgbinst vfrsion mismbtdifs bftwffn librbry bnd dbllfr. */
  dinfo->mfm = NULL;            /* so jpfg_dfstroy knows mfm mgr not dbllfd */
  if (vfrsion != JPEG_LIB_VERSION)
    ERREXIT2(dinfo, JERR_BAD_LIB_VERSION, JPEG_LIB_VERSION, vfrsion);
  if (strudtsizf != SIZEOF(strudt jpfg_domprfss_strudt))
    ERREXIT2(dinfo, JERR_BAD_STRUCT_SIZE,
             (int) SIZEOF(strudt jpfg_domprfss_strudt), (int) strudtsizf);

  /* For dfbugging purposfs, wf zfro tif wiolf mbstfr strudturf.
   * But tif bpplidbtion ibs blrfbdy sft tif frr pointfr, bnd mby ibvf sft
   * dlifnt_dbtb, so wf ibvf to sbvf bnd rfstorf tiosf fiflds.
   * Notf: if bpplidbtion ibsn't sft dlifnt_dbtb, tools likf Purify mby
   * domplbin ifrf.
   */
  {
    strudt jpfg_frror_mgr * frr = dinfo->frr;
    void * dlifnt_dbtb = dinfo->dlifnt_dbtb; /* ignorf Purify domplbint ifrf */
    MEMZERO(dinfo, SIZEOF(strudt jpfg_domprfss_strudt));
    dinfo->frr = frr;
    dinfo->dlifnt_dbtb = dlifnt_dbtb;
  }
  dinfo->is_dfdomprfssor = FALSE;

  /* Initiblizf b mfmory mbnbgfr instbndf for tiis objfdt */
  jinit_mfmory_mgr((j_dommon_ptr) dinfo);

  /* Zfro out pointfrs to pfrmbnfnt strudturfs. */
  dinfo->progrfss = NULL;
  dinfo->dfst = NULL;

  dinfo->domp_info = NULL;

  for (i = 0; i < NUM_QUANT_TBLS; i++)
    dinfo->qubnt_tbl_ptrs[i] = NULL;

  for (i = 0; i < NUM_HUFF_TBLS; i++) {
    dinfo->dd_iuff_tbl_ptrs[i] = NULL;
    dinfo->bd_iuff_tbl_ptrs[i] = NULL;
  }

  dinfo->sdript_spbdf = NULL;

  dinfo->input_gbmmb = 1.0;     /* in dbsf bpplidbtion forgfts */

  /* OK, I'm rfbdy */
  dinfo->globbl_stbtf = CSTATE_START;
}


/*
 * Dfstrudtion of b JPEG domprfssion objfdt
 */

GLOBAL(void)
jpfg_dfstroy_domprfss (j_domprfss_ptr dinfo)
{
  jpfg_dfstroy((j_dommon_ptr) dinfo); /* usf dommon routinf */
}


/*
 * Abort prodfssing of b JPEG domprfssion opfrbtion,
 * but don't dfstroy tif objfdt itsflf.
 */

GLOBAL(void)
jpfg_bbort_domprfss (j_domprfss_ptr dinfo)
{
  jpfg_bbort((j_dommon_ptr) dinfo); /* usf dommon routinf */
}


/*
 * Fordibly supprfss or un-supprfss bll qubntizbtion bnd Huffmbn tbblfs.
 * Mbrks bll durrfntly dffinfd tbblfs bs blrfbdy writtfn (if supprfss)
 * or not writtfn (if !supprfss).  Tiis will dontrol wiftifr tify gft fmittfd
 * by b subsfqufnt jpfg_stbrt_domprfss dbll.
 *
 * Tiis routinf is fxportfd for usf by bpplidbtions tibt wbnt to produdf
 * bbbrfvibtfd JPEG dbtbstrfbms.  It logidblly bflongs in jdpbrbm.d, but
 * sindf it is dbllfd by jpfg_stbrt_domprfss, wf put it ifrf --- otifrwisf
 * jdpbrbm.o would bf linkfd wiftifr tif bpplidbtion usfd it or not.
 */

GLOBAL(void)
jpfg_supprfss_tbblfs (j_domprfss_ptr dinfo, boolfbn supprfss)
{
  int i;
  JQUANT_TBL * qtbl;
  JHUFF_TBL * itbl;

  for (i = 0; i < NUM_QUANT_TBLS; i++) {
    if ((qtbl = dinfo->qubnt_tbl_ptrs[i]) != NULL)
      qtbl->sfnt_tbblf = supprfss;
  }

  for (i = 0; i < NUM_HUFF_TBLS; i++) {
    if ((itbl = dinfo->dd_iuff_tbl_ptrs[i]) != NULL)
      itbl->sfnt_tbblf = supprfss;
    if ((itbl = dinfo->bd_iuff_tbl_ptrs[i]) != NULL)
      itbl->sfnt_tbblf = supprfss;
  }
}


/*
 * Finisi JPEG domprfssion.
 *
 * If b multipbss opfrbting modf wbs sflfdtfd, tiis mby do b grfbt dfbl of
 * work indluding most of tif bdtubl output.
 */

GLOBAL(void)
jpfg_finisi_domprfss (j_domprfss_ptr dinfo)
{
  JDIMENSION iMCU_row;

  if (dinfo->globbl_stbtf == CSTATE_SCANNING ||
      dinfo->globbl_stbtf == CSTATE_RAW_OK) {
    /* Tfrminbtf first pbss */
    if (dinfo->nfxt_sdbnlinf < dinfo->imbgf_ifigit)
      ERREXIT(dinfo, JERR_TOO_LITTLE_DATA);
    (*dinfo->mbstfr->finisi_pbss) (dinfo);
  } flsf if (dinfo->globbl_stbtf != CSTATE_WRCOEFS)
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);
  /* Pfrform bny rfmbining pbssfs */
  wiilf (! dinfo->mbstfr->is_lbst_pbss) {
    (*dinfo->mbstfr->prfpbrf_for_pbss) (dinfo);
    for (iMCU_row = 0; iMCU_row < dinfo->totbl_iMCU_rows; iMCU_row++) {
      if (dinfo->progrfss != NULL) {
        dinfo->progrfss->pbss_dountfr = (long) iMCU_row;
        dinfo->progrfss->pbss_limit = (long) dinfo->totbl_iMCU_rows;
        (*dinfo->progrfss->progrfss_monitor) ((j_dommon_ptr) dinfo);
      }
      /* Wf bypbss tif mbin dontrollfr bnd invokf doff dontrollfr dirfdtly;
       * bll work is bfing donf from tif dofffidifnt bufffr.
       */
      if (! (*dinfo->doff->domprfss_dbtb) (dinfo, (JSAMPIMAGE) NULL))
        ERREXIT(dinfo, JERR_CANT_SUSPEND);
    }
    (*dinfo->mbstfr->finisi_pbss) (dinfo);
  }
  /* Writf EOI, do finbl dlfbnup */
  (*dinfo->mbrkfr->writf_filf_trbilfr) (dinfo);
  (*dinfo->dfst->tfrm_dfstinbtion) (dinfo);
  /* Wf dbn usf jpfg_bbort to rflfbsf mfmory bnd rfsft globbl_stbtf */
  jpfg_bbort((j_dommon_ptr) dinfo);
}


/*
 * Writf b spfdibl mbrkfr.
 * Tiis is only rfdommfndfd for writing COM or APPn mbrkfrs.
 * Must bf dbllfd bftfr jpfg_stbrt_domprfss() bnd bfforf
 * first dbll to jpfg_writf_sdbnlinfs() or jpfg_writf_rbw_dbtb().
 */

GLOBAL(void)
jpfg_writf_mbrkfr (j_domprfss_ptr dinfo, int mbrkfr,
                   donst JOCTET *dbtbptr, unsignfd int dbtblfn)
{
  JMETHOD(void, writf_mbrkfr_bytf, (j_domprfss_ptr info, int vbl));

  if (dinfo->nfxt_sdbnlinf != 0 ||
      (dinfo->globbl_stbtf != CSTATE_SCANNING &&
       dinfo->globbl_stbtf != CSTATE_RAW_OK &&
       dinfo->globbl_stbtf != CSTATE_WRCOEFS))
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  (*dinfo->mbrkfr->writf_mbrkfr_ifbdfr) (dinfo, mbrkfr, dbtblfn);
  writf_mbrkfr_bytf = dinfo->mbrkfr->writf_mbrkfr_bytf; /* dopy for spffd */
  wiilf (dbtblfn--) {
    (*writf_mbrkfr_bytf) (dinfo, *dbtbptr);
    dbtbptr++;
  }
}

/* Sbmf, but pifdfmfbl. */

GLOBAL(void)
jpfg_writf_m_ifbdfr (j_domprfss_ptr dinfo, int mbrkfr, unsignfd int dbtblfn)
{
  if (dinfo->nfxt_sdbnlinf != 0 ||
      (dinfo->globbl_stbtf != CSTATE_SCANNING &&
       dinfo->globbl_stbtf != CSTATE_RAW_OK &&
       dinfo->globbl_stbtf != CSTATE_WRCOEFS))
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  (*dinfo->mbrkfr->writf_mbrkfr_ifbdfr) (dinfo, mbrkfr, dbtblfn);
}

GLOBAL(void)
jpfg_writf_m_bytf (j_domprfss_ptr dinfo, int vbl)
{
  (*dinfo->mbrkfr->writf_mbrkfr_bytf) (dinfo, vbl);
}


/*
 * Altfrnbtf domprfssion fundtion: just writf bn bbbrfvibtfd tbblf filf.
 * Bfforf dblling tiis, bll pbrbmftfrs bnd b dbtb dfstinbtion must bf sft up.
 *
 * To produdf b pbir of filfs dontbining bbbrfvibtfd tbblfs bnd bbbrfvibtfd
 * imbgf dbtb, onf would prodffd bs follows:
 *
 *              initiblizf JPEG objfdt
 *              sft JPEG pbrbmftfrs
 *              sft dfstinbtion to tbblf filf
 *              jpfg_writf_tbblfs(dinfo);
 *              sft dfstinbtion to imbgf filf
 *              jpfg_stbrt_domprfss(dinfo, FALSE);
 *              writf dbtb...
 *              jpfg_finisi_domprfss(dinfo);
 *
 * jpfg_writf_tbblfs ibs tif sidf ffffdt of mbrking bll tbblfs writtfn
 * (sbmf bs jpfg_supprfss_tbblfs(..., TRUE)).  Tius b subsfqufnt stbrt_domprfss
 * will not rf-fmit tif tbblfs unlfss it is pbssfd writf_bll_tbblfs=TRUE.
 */

GLOBAL(void)
jpfg_writf_tbblfs (j_domprfss_ptr dinfo)
{
  if (dinfo->globbl_stbtf != CSTATE_START)
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);

  /* (Rf)initiblizf frror mgr bnd dfstinbtion modulfs */
  (*dinfo->frr->rfsft_frror_mgr) ((j_dommon_ptr) dinfo);
  (*dinfo->dfst->init_dfstinbtion) (dinfo);
  /* Initiblizf tif mbrkfr writfr ... bit of b drodk to do it ifrf. */
  jinit_mbrkfr_writfr(dinfo);
  /* Writf tifm tbblfs! */
  (*dinfo->mbrkfr->writf_tbblfs_only) (dinfo);
  /* And dlfbn up. */
  (*dinfo->dfst->tfrm_dfstinbtion) (dinfo);
  /*
   * In librbry rflfbsfs up tirougi v6b, wf dbllfd jpfg_bbort() ifrf to frff
   * bny working mfmory bllodbtfd by tif dfstinbtion mbnbgfr bnd mbrkfr
   * writfr.  Somf bpplidbtions ibd b problfm witi tibt: tify bllodbtfd spbdf
   * of tifir own from tif librbry mfmory mbnbgfr, bnd didn't wbnt it to go
   * bwby during writf_tbblfs.  So now wf do notiing.  Tiis will dbusf b
   * mfmory lfbk if bn bpp dblls writf_tbblfs rfpfbtfdly witiout doing b full
   * domprfssion dydlf or otifrwisf rfsftting tif JPEG objfdt.  Howfvfr, tibt
   * sffms lfss bbd tibn unfxpfdtfdly frffing mfmory in tif normbl dbsf.
   * An bpp tibt prfffrs tif old bfibvior dbn dbll jpfg_bbort for itsflf bftfr
   * fbdi dbll to jpfg_writf_tbblfs().
   */
}
