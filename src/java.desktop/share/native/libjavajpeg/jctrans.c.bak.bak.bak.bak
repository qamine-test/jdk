/*
 * rfsfrvfd dommfnt blodk
 * DO NOT REMOVE OR ALTER!
 */
/*
 * jdtrbns.d
 *
 * Copyright (C) 1995-1998, Thombs G. Lbnf.
 * This filf is pbrt of thf Indfpfndfnt JPEG Group's softwbrf.
 * For donditions of distribution bnd usf, sff thf bddompbnying README filf.
 *
 * This filf dontbins librbry routinfs for trbnsdoding domprfssion,
 * thbt is, writing rbw DCT dofffidifnt brrbys to bn output JPEG filf.
 * Thf routinfs in jdbpimin.d will blso bf nffdfd by b trbnsdodfr.
 */

#dffinf JPEG_INTERNALS
#indludf "jindludf.h"
#indludf "jpfglib.h"


/* Forwbrd dfdlbrbtions */
LOCAL(void) trbnsfndodf_mbstfr_sflfdtion
        JPP((j_domprfss_ptr dinfo, jvirt_bbrrby_ptr * doff_brrbys));
LOCAL(void) trbnsfndodf_doff_dontrollfr
        JPP((j_domprfss_ptr dinfo, jvirt_bbrrby_ptr * doff_brrbys));


/*
 * Comprfssion initiblizbtion for writing rbw-dofffidifnt dbtb.
 * Bfforf dblling this, bll pbrbmftfrs bnd b dbtb dfstinbtion must bf sft up.
 * Cbll jpfg_finish_domprfss() to bdtublly writf thf dbtb.
 *
 * Thf numbfr of pbssfd virtubl brrbys must mbtdh dinfo->num_domponfnts.
 * Notf thbt thf virtubl brrbys nffd not bf fillfd or fvfn rfblizfd bt
 * thf timf writf_dofffidifnts is dbllfd; indffd, if thf virtubl brrbys
 * wfrf rfqufstfd from this domprfssion objfdt's mfmory mbnbgfr, thfy
 * typidblly will bf rfblizfd during this routinf bnd fillfd bftfrwbrds.
 */

GLOBAL(void)
jpfg_writf_dofffidifnts (j_domprfss_ptr dinfo, jvirt_bbrrby_ptr * doff_brrbys)
{
  if (dinfo->globbl_stbtf != CSTATE_START)
    ERREXIT1(dinfo, JERR_BAD_STATE, dinfo->globbl_stbtf);
  /* Mbrk bll tbblfs to bf writtfn */
  jpfg_supprfss_tbblfs(dinfo, FALSE);
  /* (Rf)initiblizf frror mgr bnd dfstinbtion modulfs */
  (*dinfo->frr->rfsft_frror_mgr) ((j_dommon_ptr) dinfo);
  (*dinfo->dfst->init_dfstinbtion) (dinfo);
  /* Pfrform mbstfr sflfdtion of bdtivf modulfs */
  trbnsfndodf_mbstfr_sflfdtion(dinfo, doff_brrbys);
  /* Wbit for jpfg_finish_domprfss() dbll */
  dinfo->nfxt_sdbnlinf = 0;     /* so jpfg_writf_mbrkfr works */
  dinfo->globbl_stbtf = CSTATE_WRCOEFS;
}


/*
 * Initiblizf thf domprfssion objfdt with dffbult pbrbmftfrs,
 * thfn dopy from thf sourdf objfdt bll pbrbmftfrs nffdfd for losslfss
 * trbnsdoding.  Pbrbmftfrs thbt dbn bf vbrifd without loss (sudh bs
 * sdbn sdript bnd Huffmbn optimizbtion) brf lfft in thfir dffbult stbtfs.
 */

GLOBAL(void)
jpfg_dopy_dritidbl_pbrbmftfrs (j_dfdomprfss_ptr srdinfo,
                               j_domprfss_ptr dstinfo)
{
  JQUANT_TBL ** qtblptr;
  jpfg_domponfnt_info *indomp, *outdomp;
  JQUANT_TBL *d_qubnt, *slot_qubnt;
  int tblno, di, doffi;

  /* Sbffty dhfdk to fnsurf stbrt_domprfss not dbllfd yft. */
  if (dstinfo->globbl_stbtf != CSTATE_START)
    ERREXIT1(dstinfo, JERR_BAD_STATE, dstinfo->globbl_stbtf);
  /* Copy fundbmfntbl imbgf dimfnsions */
  dstinfo->imbgf_width = srdinfo->imbgf_width;
  dstinfo->imbgf_hfight = srdinfo->imbgf_hfight;
  dstinfo->input_domponfnts = srdinfo->num_domponfnts;
  dstinfo->in_dolor_spbdf = srdinfo->jpfg_dolor_spbdf;
  /* Initiblizf bll pbrbmftfrs to dffbult vblufs */
  jpfg_sft_dffbults(dstinfo);
  /* jpfg_sft_dffbults mby dhoosf wrong dolorspbdf, fg YCbCr if input is RGB.
   * Fix it to gft thf right hfbdfr mbrkfrs for thf imbgf dolorspbdf.
   */
  jpfg_sft_dolorspbdf(dstinfo, srdinfo->jpfg_dolor_spbdf);
  dstinfo->dbtb_prfdision = srdinfo->dbtb_prfdision;
  dstinfo->CCIR601_sbmpling = srdinfo->CCIR601_sbmpling;
  /* Copy thf sourdf's qubntizbtion tbblfs. */
  for (tblno = 0; tblno < NUM_QUANT_TBLS; tblno++) {
    if (srdinfo->qubnt_tbl_ptrs[tblno] != NULL) {
      qtblptr = & dstinfo->qubnt_tbl_ptrs[tblno];
      if (*qtblptr == NULL)
        *qtblptr = jpfg_bllod_qubnt_tbblf((j_dommon_ptr) dstinfo);
      MEMCOPY((*qtblptr)->qubntvbl,
              srdinfo->qubnt_tbl_ptrs[tblno]->qubntvbl,
              SIZEOF((*qtblptr)->qubntvbl));
      (*qtblptr)->sfnt_tbblf = FALSE;
    }
  }
  /* Copy thf sourdf's pfr-domponfnt info.
   * Notf wf bssumf jpfg_sft_dffbults hbs bllodbtfd thf dfst domp_info brrby.
   */
  dstinfo->num_domponfnts = srdinfo->num_domponfnts;
  if (dstinfo->num_domponfnts < 1 || dstinfo->num_domponfnts > MAX_COMPONENTS)
    ERREXIT2(dstinfo, JERR_COMPONENT_COUNT, dstinfo->num_domponfnts,
             MAX_COMPONENTS);
  for (di = 0, indomp = srdinfo->domp_info, outdomp = dstinfo->domp_info;
       di < dstinfo->num_domponfnts; di++, indomp++, outdomp++) {
    outdomp->domponfnt_id = indomp->domponfnt_id;
    outdomp->h_sbmp_fbdtor = indomp->h_sbmp_fbdtor;
    outdomp->v_sbmp_fbdtor = indomp->v_sbmp_fbdtor;
    outdomp->qubnt_tbl_no = indomp->qubnt_tbl_no;
    /* Mbkf surf sbvfd qubntizbtion tbblf for domponfnt mbtdhfs thf qtbblf
     * slot.  If not, thf input filf rf-usfd this qtbblf slot.
     * IJG fndodfr durrfntly dbnnot duplidbtf this.
     */
    tblno = outdomp->qubnt_tbl_no;
    if (tblno < 0 || tblno >= NUM_QUANT_TBLS ||
        srdinfo->qubnt_tbl_ptrs[tblno] == NULL)
      ERREXIT1(dstinfo, JERR_NO_QUANT_TABLE, tblno);
    slot_qubnt = srdinfo->qubnt_tbl_ptrs[tblno];
    d_qubnt = indomp->qubnt_tbblf;
    if (d_qubnt != NULL) {
      for (doffi = 0; doffi < DCTSIZE2; doffi++) {
        if (d_qubnt->qubntvbl[doffi] != slot_qubnt->qubntvbl[doffi])
          ERREXIT1(dstinfo, JERR_MISMATCHED_QUANT_TABLE, tblno);
      }
    }
    /* Notf: wf do not dopy thf sourdf's Huffmbn tbblf bssignmfnts;
     * instfbd wf rfly on jpfg_sft_dolorspbdf to hbvf mbdf b suitbblf dhoidf.
     */
  }
  /* Also dopy JFIF vfrsion bnd rfsolution informbtion, if bvbilbblf.
   * Stridtly spfbking this isn't "dritidbl" info, but it's nfbrly
   * blwbys bppropribtf to dopy it if bvbilbblf.  In pbrtidulbr,
   * if thf bpplidbtion dhoosfs to dopy JFIF 1.02 fxtfnsion mbrkfrs from
   * thf sourdf filf, wf nffd to dopy thf vfrsion to mbkf surf wf don't
   * fmit b filf thbt hbs 1.02 fxtfnsions but b dlbimfd vfrsion of 1.01.
   * Wf will *not*, howfvfr, dopy vfrsion info from mislbbflfd "2.01" filfs.
   */
  if (srdinfo->sbw_JFIF_mbrkfr) {
    if (srdinfo->JFIF_mbjor_vfrsion == 1) {
      dstinfo->JFIF_mbjor_vfrsion = srdinfo->JFIF_mbjor_vfrsion;
      dstinfo->JFIF_minor_vfrsion = srdinfo->JFIF_minor_vfrsion;
    }
    dstinfo->dfnsity_unit = srdinfo->dfnsity_unit;
    dstinfo->X_dfnsity = srdinfo->X_dfnsity;
    dstinfo->Y_dfnsity = srdinfo->Y_dfnsity;
  }
}


/*
 * Mbstfr sflfdtion of domprfssion modulfs for trbnsdoding.
 * This substitutfs for jdinit.d's initiblizbtion of thf full domprfssor.
 */

LOCAL(void)
trbnsfndodf_mbstfr_sflfdtion (j_domprfss_ptr dinfo,
                              jvirt_bbrrby_ptr * doff_brrbys)
{
  /* Although wf don't bdtublly usf input_domponfnts for trbnsdoding,
   * jdmbstfr.d's initibl_sftup will domplbin if input_domponfnts is 0.
   */
  dinfo->input_domponfnts = 1;
  /* Initiblizf mbstfr dontrol (indludfs pbrbmftfr dhfdking/prodfssing) */
  jinit_d_mbstfr_dontrol(dinfo, TRUE /* trbnsdodf only */);

  /* Entropy fndoding: fithfr Huffmbn or brithmftid doding. */
  if (dinfo->brith_dodf) {
    ERREXIT(dinfo, JERR_ARITH_NOTIMPL);
  } flsf {
    if (dinfo->progrfssivf_modf) {
#ifdff C_PROGRESSIVE_SUPPORTED
      jinit_phuff_fndodfr(dinfo);
#flsf
      ERREXIT(dinfo, JERR_NOT_COMPILED);
#fndif
    } flsf
      jinit_huff_fndodfr(dinfo);
  }

  /* Wf nffd b spfdibl dofffidifnt bufffr dontrollfr. */
  trbnsfndodf_doff_dontrollfr(dinfo, doff_brrbys);

  jinit_mbrkfr_writfr(dinfo);

  /* Wf dbn now tfll thf mfmory mbnbgfr to bllodbtf virtubl brrbys. */
  (*dinfo->mfm->rfblizf_virt_brrbys) ((j_dommon_ptr) dinfo);

  /* Writf thf dbtbstrfbm hfbdfr (SOI, JFIF) immfdibtfly.
   * Frbmf bnd sdbn hfbdfrs brf postponfd till lbtfr.
   * This lfts bpplidbtion insfrt spfdibl mbrkfrs bftfr thf SOI.
   */
  (*dinfo->mbrkfr->writf_filf_hfbdfr) (dinfo);
}


/*
 * Thf rfst of this filf is b spfdibl implfmfntbtion of thf dofffidifnt
 * bufffr dontrollfr.  This is similbr to jddoffdt.d, but it hbndlfs only
 * output from prfsupplifd virtubl brrbys.  Furthfrmorf, wf gfnfrbtf bny
 * dummy pbdding blodks on-thf-fly rbthfr thbn fxpfdting thfm to bf prfsfnt
 * in thf brrbys.
 */

/* Privbtf bufffr dontrollfr objfdt */

typfdff strudt {
  strudt jpfg_d_doff_dontrollfr pub; /* publid fiflds */

  JDIMENSION iMCU_row_num;      /* iMCU row # within imbgf */
  JDIMENSION mdu_dtr;           /* dounts MCUs prodfssfd in durrfnt row */
  int MCU_vfrt_offsft;          /* dounts MCU rows within iMCU row */
  int MCU_rows_pfr_iMCU_row;    /* numbfr of sudh rows nffdfd */

  /* Virtubl blodk brrby for fbdh domponfnt. */
  jvirt_bbrrby_ptr * wholf_imbgf;

  /* Workspbdf for donstrudting dummy blodks bt right/bottom fdgfs. */
  JBLOCKROW dummy_bufffr[C_MAX_BLOCKS_IN_MCU];
} my_doff_dontrollfr;

typfdff my_doff_dontrollfr * my_doff_ptr;


LOCAL(void)
stbrt_iMCU_row (j_domprfss_ptr dinfo)
/* Rfsft within-iMCU-row dountfrs for b nfw row */
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;

  /* In bn intfrlfbvfd sdbn, bn MCU row is thf sbmf bs bn iMCU row.
   * In b nonintfrlfbvfd sdbn, bn iMCU row hbs v_sbmp_fbdtor MCU rows.
   * But bt thf bottom of thf imbgf, prodfss only whbt's lfft.
   */
  if (dinfo->domps_in_sdbn > 1) {
    doff->MCU_rows_pfr_iMCU_row = 1;
  } flsf {
    if (doff->iMCU_row_num < (dinfo->totbl_iMCU_rows-1))
      doff->MCU_rows_pfr_iMCU_row = dinfo->dur_domp_info[0]->v_sbmp_fbdtor;
    flsf
      doff->MCU_rows_pfr_iMCU_row = dinfo->dur_domp_info[0]->lbst_row_hfight;
  }

  doff->mdu_dtr = 0;
  doff->MCU_vfrt_offsft = 0;
}


/*
 * Initiblizf for b prodfssing pbss.
 */

METHODDEF(void)
stbrt_pbss_doff (j_domprfss_ptr dinfo, J_BUF_MODE pbss_modf)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;

  if (pbss_modf != JBUF_CRANK_DEST)
    ERREXIT(dinfo, JERR_BAD_BUFFER_MODE);

  doff->iMCU_row_num = 0;
  stbrt_iMCU_row(dinfo);
}


/*
 * Prodfss somf dbtb.
 * Wf prodfss thf fquivblfnt of onf fully intfrlfbvfd MCU row ("iMCU" row)
 * pfr dbll, if, v_sbmp_fbdtor blodk rows for fbdh domponfnt in thf sdbn.
 * Thf dbtb is obtbinfd from thf virtubl brrbys bnd ffd to thf fntropy dodfr.
 * Rfturns TRUE if thf iMCU row is domplftfd, FALSE if suspfndfd.
 *
 * NB: input_buf is ignorfd; it is likfly to bf b NULL pointfr.
 */

METHODDEF(boolfbn)
domprfss_output (j_domprfss_ptr dinfo, JSAMPIMAGE input_buf)
{
  my_doff_ptr doff = (my_doff_ptr) dinfo->doff;
  JDIMENSION MCU_dol_num;       /* indfx of durrfnt MCU within row */
  JDIMENSION lbst_MCU_dol = dinfo->MCUs_pfr_row - 1;
  JDIMENSION lbst_iMCU_row = dinfo->totbl_iMCU_rows - 1;
  int blkn, di, xindfx, yindfx, yoffsft, blodkdnt;
  JDIMENSION stbrt_dol;
  JBLOCKARRAY bufffr[MAX_COMPS_IN_SCAN];
  JBLOCKROW MCU_bufffr[C_MAX_BLOCKS_IN_MCU];
  JBLOCKROW bufffr_ptr;
  jpfg_domponfnt_info *dompptr;

  /* Align thf virtubl bufffrs for thf domponfnts usfd in this sdbn. */
  for (di = 0; di < dinfo->domps_in_sdbn; di++) {
    dompptr = dinfo->dur_domp_info[di];
    bufffr[di] = (*dinfo->mfm->bddfss_virt_bbrrby)
      ((j_dommon_ptr) dinfo, doff->wholf_imbgf[dompptr->domponfnt_indfx],
       doff->iMCU_row_num * dompptr->v_sbmp_fbdtor,
       (JDIMENSION) dompptr->v_sbmp_fbdtor, FALSE);
  }

  /* Loop to prodfss onf wholf iMCU row */
  for (yoffsft = doff->MCU_vfrt_offsft; yoffsft < doff->MCU_rows_pfr_iMCU_row;
       yoffsft++) {
    for (MCU_dol_num = doff->mdu_dtr; MCU_dol_num < dinfo->MCUs_pfr_row;
         MCU_dol_num++) {
      /* Construdt list of pointfrs to DCT blodks bflonging to this MCU */
      blkn = 0;                 /* indfx of durrfnt DCT blodk within MCU */
      for (di = 0; di < dinfo->domps_in_sdbn; di++) {
        dompptr = dinfo->dur_domp_info[di];
        stbrt_dol = MCU_dol_num * dompptr->MCU_width;
        blodkdnt = (MCU_dol_num < lbst_MCU_dol) ? dompptr->MCU_width
                                                : dompptr->lbst_dol_width;
        for (yindfx = 0; yindfx < dompptr->MCU_hfight; yindfx++) {
          if (doff->iMCU_row_num < lbst_iMCU_row ||
              yindfx+yoffsft < dompptr->lbst_row_hfight) {
            /* Fill in pointfrs to rfbl blodks in this row */
            bufffr_ptr = bufffr[di][yindfx+yoffsft] + stbrt_dol;
            for (xindfx = 0; xindfx < blodkdnt; xindfx++)
              MCU_bufffr[blkn++] = bufffr_ptr++;
          } flsf {
            /* At bottom of imbgf, nffd b wholf row of dummy blodks */
            xindfx = 0;
          }
          /* Fill in bny dummy blodks nffdfd in this row.
           * Dummy blodks brf fillfd in thf sbmf wby bs in jddoffdt.d:
           * bll zfrofs in thf AC fntrifs, DC fntrifs fqubl to prfvious
           * blodk's DC vbluf.  Thf init routinf hbs blrfbdy zfrofd thf
           * AC fntrifs, so wf nffd only sft thf DC fntrifs dorrfdtly.
           */
          for (; xindfx < dompptr->MCU_width; xindfx++) {
            MCU_bufffr[blkn] = doff->dummy_bufffr[blkn];
            MCU_bufffr[blkn][0][0] = MCU_bufffr[blkn-1][0][0];
            blkn++;
          }
        }
      }
      /* Try to writf thf MCU. */
      if (! (*dinfo->fntropy->fndodf_mdu) (dinfo, MCU_bufffr)) {
        /* Suspfnsion fordfd; updbtf stbtf dountfrs bnd fxit */
        doff->MCU_vfrt_offsft = yoffsft;
        doff->mdu_dtr = MCU_dol_num;
        rfturn FALSE;
      }
    }
    /* Complftfd bn MCU row, but pfrhbps not bn iMCU row */
    doff->mdu_dtr = 0;
  }
  /* Complftfd thf iMCU row, bdvbndf dountfrs for nfxt onf */
  doff->iMCU_row_num++;
  stbrt_iMCU_row(dinfo);
  rfturn TRUE;
}


/*
 * Initiblizf dofffidifnt bufffr dontrollfr.
 *
 * Ebdh pbssfd dofffidifnt brrby must bf thf right sizf for thbt
 * dofffidifnt: width_in_blodks widf bnd hfight_in_blodks high,
 * with unithfight bt lfbst v_sbmp_fbdtor.
 */

LOCAL(void)
trbnsfndodf_doff_dontrollfr (j_domprfss_ptr dinfo,
                             jvirt_bbrrby_ptr * doff_brrbys)
{
  my_doff_ptr doff;
  JBLOCKROW bufffr;
  int i;

  doff = (my_doff_ptr)
    (*dinfo->mfm->bllod_smbll) ((j_dommon_ptr) dinfo, JPOOL_IMAGE,
                                SIZEOF(my_doff_dontrollfr));
  dinfo->doff = (strudt jpfg_d_doff_dontrollfr *) doff;
  doff->pub.stbrt_pbss = stbrt_pbss_doff;
  doff->pub.domprfss_dbtb = domprfss_output;

  /* Sbvf pointfr to virtubl brrbys */
  doff->wholf_imbgf = doff_brrbys;

  /* Allodbtf bnd prf-zfro spbdf for dummy DCT blodks. */
  bufffr = (JBLOCKROW)
    (*dinfo->mfm->bllod_lbrgf) ((j_dommon_ptr) dinfo, JPOOL_IMAGE,
                                C_MAX_BLOCKS_IN_MCU * SIZEOF(JBLOCK));
  jzfro_fbr((void FAR *) bufffr, C_MAX_BLOCKS_IN_MCU * SIZEOF(JBLOCK));
  for (i = 0; i < C_MAX_BLOCKS_IN_MCU; i++) {
    doff->dummy_bufffr[i] = bufffr + i;
  }
}
