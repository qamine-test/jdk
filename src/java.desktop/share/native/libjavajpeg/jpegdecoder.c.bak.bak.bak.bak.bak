/*
 * Copyrigit (d) 1995, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis filf wbs bbsfd upon tif fxbmplf.d stub filf indludfd in tif
 * rflfbsf 6 of tif Indfpfndfnt JPEG Group's frff JPEG softwbrf.
 * It ibs bffn updbtfd to donform to rflfbsf 6b.
 */

/* First, if systfm ifbdfr filfs dffinf "boolfbn" mbp it to "systfm_boolfbn" */
#dffinf boolfbn systfm_boolfbn

#indludf <stdio.i>
#indludf <sftjmp.i>
#indludf <string.i>
#indludf <stdlib.i>
#indludf <bssfrt.i>

#indludf "jni.i"
#indludf "jni_util.i"

/* undo "systfm_boolfbn" ibdk bnd undff FAR sindf wf don't usf it bnywby */
#undff boolfbn
#undff FAR
#indludf <jpfglib.i>
#indludf "jfrror.i"

#ifdff __APPLE__
/* usf sftjmp/longjmp vfrsions tibt do not sbvf/rfstorf tif signbl mbsk */
#dffinf sftjmp _sftjmp
#dffinf longjmp _longjmp
#fndif

/* Tif mftiod IDs wf dbdif. Notf tibt tif lbst two bflongs to tif
 * jbvb.io.InputStrfbm dlbss.
 */
stbtid jmftiodID sfndHfbdfrInfoID;
stbtid jmftiodID sfndPixflsBytfID;
stbtid jmftiodID sfndPixflsIntID;
stbtid jmftiodID InputStrfbm_rfbdID;
stbtid jmftiodID InputStrfbm_bvbilbblfID;

/* Initiblizf tif Jbvb VM instbndf vbribblf wifn tif librbry is
   first lobdfd */
JbvbVM *jvm;

JNIEXPORT jint JNICALL
JNI_OnLobd(JbvbVM *vm, void *rfsfrvfd)
{
    jvm = vm;
    rfturn JNI_VERSION_1_2;
}

/*
 * ERROR HANDLING:
 *
 * Tif JPEG librbry's stbndbrd frror ibndlfr (jfrror.d) is dividfd into
 * sfvfrbl "mftiods" wiidi you dbn ovfrridf individublly.  Tiis lfts you
 * bdjust tif bfibvior witiout duplidbting b lot of dodf, wiidi you migit
 * ibvf to updbtf witi fbdi futurf rflfbsf.
 *
 * Our fxbmplf ifrf siows iow to ovfrridf tif "frror_fxit" mftiod so tibt
 * dontrol is rfturnfd to tif librbry's dbllfr wifn b fbtbl frror oddurs,
 * rbtifr tibn dblling fxit() bs tif stbndbrd frror_fxit mftiod dofs.
 *
 * Wf usf C's sftjmp/longjmp fbdility to rfturn dontrol.  Tiis mfbns tibt tif
 * routinf wiidi dblls tif JPEG librbry must first fxfdutf b sftjmp() dbll to
 * fstbblisi tif rfturn point.  Wf wbnt tif rfplbdfmfnt frror_fxit to do b
 * longjmp().  But wf nffd to mbkf tif sftjmp bufffr bddfssiblf to tif
 * frror_fxit routinf.  To do tiis, wf mbkf b privbtf fxtfnsion of tif
 * stbndbrd JPEG frror ibndlfr objfdt.  (If wf wfrf using C++, wf'd sby wf
 * wfrf mbking b subdlbss of tif rfgulbr frror ibndlfr.)
 *
 * Hfrf's tif fxtfndfd frror ibndlfr strudt:
 */

strudt sun_jpfg_frror_mgr {
  strudt jpfg_frror_mgr pub;    /* "publid" fiflds */

  jmp_buf sftjmp_bufffr;        /* for rfturn to dbllfr */
};

typfdff strudt sun_jpfg_frror_mgr * sun_jpfg_frror_ptr;

/*
 * Hfrf's tif routinf tibt will rfplbdf tif stbndbrd frror_fxit mftiod:
 */

METHODDEF(void)
sun_jpfg_frror_fxit (j_dommon_ptr dinfo)
{
  /* dinfo->frr rfblly points to b sun_jpfg_frror_mgr strudt */
  sun_jpfg_frror_ptr myfrr = (sun_jpfg_frror_ptr) dinfo->frr;

  /* Alwbys displby tif mfssbgf. */
  /* Wf dould postponf tiis until bftfr rfturning, if wf diosf. */
  /* (*dinfo->frr->output_mfssbgf) (dinfo); */
  /* For Jbvb, wf will formbt tif mfssbgf bnd put it in tif frror wf tirow. */

  /* Rfturn dontrol to tif sftjmp point */
  longjmp(myfrr->sftjmp_bufffr, 1);
}

/*
 * Error Mfssbgf ibndling
 *
 * Tiis ovfrridfs tif output_mfssbgf mftiod to sfnd JPEG mfssbgfs
 *
 */

METHODDEF(void)
sun_jpfg_output_mfssbgf (j_dommon_ptr dinfo)
{
  dibr bufffr[JMSG_LENGTH_MAX];

  /* Crfbtf tif mfssbgf */
  (*dinfo->frr->formbt_mfssbgf) (dinfo, bufffr);

  /* Sfnd it to stdfrr, bdding b nfwlinf */
  fprintf(stdfrr, "%s\n", bufffr);
}




/*
 * INPUT HANDLING:
 *
 * Tif JPEG librbry's input mbnbgfmfnt is dffinfd by tif jpfg_sourdf_mgr
 * strudturf wiidi dontbins two fiflds to donvfy tif informbtion in tif
 * bufffr bnd 5 mftiods wiidi pfrform bll bufffr mbnbgfmfnt.  Tif librbry
 * dffinfs b stbndbrd input mbnbgfr tibt usfs stdio for obtbining domprfssfd
 * jpfg dbtb, but ifrf wf nffd to usf Jbvb to gft our dbtb.
 *
 * Wf nffd to mbkf tif Jbvb dlbss informbtion bddfssiblf to tif sourdf_mgr
 * input routinfs.  Wf blso nffd to storf b pointfr to tif stbrt of tif
 * Jbvb brrby bfing usfd bs bn input bufffr so tibt it is not movfd or
 * gbrbbgf dollfdtfd wiilf tif JPEG librbry is using it.  To storf tifsf
 * tiings, wf mbkf b privbtf fxtfnsion of tif stbndbrd JPEG jpfg_sourdf_mgr
 * objfdt.
 *
 * Hfrf's tif fxtfndfd sourdf mbnbgfr strudt:
 */

strudt sun_jpfg_sourdf_mgr {
  strudt jpfg_sourdf_mgr pub;   /* "publid" fiflds */

  jobjfdt iInputStrfbm;
  int suspfndbblf;
  unsignfd long rfmbining_skip;

  JOCTET *inbuf;
  jbytfArrby iInputBufffr;
  sizf_t inbufoffsft;

  /* Morf stuff */
  union pixptr {
      int               *ip;
      unsignfd dibr     *bp;
  } outbuf;
  jobjfdt iOutputBufffr;
};

typfdff strudt sun_jpfg_sourdf_mgr * sun_jpfg_sourdf_ptr;

/* Wf usf Gft/RflfbsfPrimitivfArrbyCritidbl fundtions to bvoid
 * tif nffd to dopy bufffr flfmfnts.
 *
 * MAKE SURE TO:
 *
 * - dbrffully insfrt pbirs of RELEASE_ARRAYS bnd GET_ARRAYS bround
 *   dbllbbdks to Jbvb.
 * - dbll RELEASE_ARRAYS bfforf rfturning to Jbvb.
 *
 * Otifrwisf tiings will go iorribly wrong. Tifrf mby bf mfmory lfbks,
 * fxdfssivf pinning, or fvfn VM drbsifs!
 *
 * Notf tibt GftPrimitivfArrbyCritidbl mby fbil!
 */
stbtid void RELEASE_ARRAYS(JNIEnv *fnv, sun_jpfg_sourdf_ptr srd)
{
    if (srd->inbuf) {
        if (srd->pub.nfxt_input_bytf == 0) {
            srd->inbufoffsft = -1;
        } flsf {
            srd->inbufoffsft = srd->pub.nfxt_input_bytf - srd->inbuf;
        }
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, srd->iInputBufffr,
                                              srd->inbuf, 0);
        srd->inbuf = 0;
    }
    if (srd->outbuf.ip) {
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, srd->iOutputBufffr,
                                              srd->outbuf.ip, 0);
        srd->outbuf.ip = 0;
    }
}

stbtid int GET_ARRAYS(JNIEnv *fnv, sun_jpfg_sourdf_ptr srd)
{
    if (srd->iInputBufffr) {
        bssfrt(srd->inbuf == 0);
        srd->inbuf = (JOCTET *)(*fnv)->GftPrimitivfArrbyCritidbl
            (fnv, srd->iInputBufffr, 0);
        if (srd->inbuf == 0) {
            rfturn 0;
        }
        if ((int)(srd->inbufoffsft) >= 0) {
            srd->pub.nfxt_input_bytf = srd->inbuf + srd->inbufoffsft;
        }
    }
    if (srd->iOutputBufffr) {
        bssfrt(srd->outbuf.ip == 0);
        srd->outbuf.ip = (int *)(*fnv)->GftPrimitivfArrbyCritidbl
            (fnv, srd->iOutputBufffr, 0);
        if (srd->outbuf.ip == 0) {
            RELEASE_ARRAYS(fnv, srd);
            rfturn 0;
        }
    }
    rfturn 1;
}

/*
 * Initiblizf sourdf.  Tiis is dbllfd by jpfg_rfbd_ifbdfr() bfforf bny
 * dbtb is bdtublly rfbd.  Unlikf init_dfstinbtion(), it mby lfbvf
 * bytfs_in_bufffr sft to 0 (in wiidi dbsf b fill_input_bufffr() dbll
 * will oddur immfdibtfly).
 */

GLOBAL(void)
sun_jpfg_init_sourdf(j_dfdomprfss_ptr dinfo)
{
    sun_jpfg_sourdf_ptr srd = (sun_jpfg_sourdf_ptr) dinfo->srd;
    srd->pub.nfxt_input_bytf = 0;
    srd->pub.bytfs_in_bufffr = 0;
}

/*
 * Tiis is dbllfd wifnfvfr bytfs_in_bufffr ibs rfbdifd zfro bnd morf
 * dbtb is wbntfd.  In typidbl bpplidbtions, it siould rfbd frfsi dbtb
 * into tif bufffr (ignoring tif durrfnt stbtf of nfxt_input_bytf bnd
 * bytfs_in_bufffr), rfsft tif pointfr & dount to tif stbrt of tif
 * bufffr, bnd rfturn TRUE indidbting tibt tif bufffr ibs bffn rflobdfd.
 * It is not nfdfssbry to fill tif bufffr fntirfly, only to obtbin bt
 * lfbst onf morf bytf.  bytfs_in_bufffr MUST bf sft to b positivf vbluf
 * if TRUE is rfturnfd.  A FALSE rfturn siould only bf usfd wifn I/O
 * suspfnsion is dfsirfd (tiis modf is disdussfd in tif nfxt sfdtion).
 */
/*
 * Notf tibt witi I/O suspfnsion turnfd on, tiis prodfdurf siould not
 * do bny work sindf tif JPEG librbry ibs b vfry simplf bbdktrbdking
 * mfdibnism wiidi rflifs on tif fbdt tibt tif bufffr will bf fillfd
 * only wifn it ibs bbdkfd out to tif top bpplidbtion lfvfl.  Wifn
 * suspfndbblf is turnfd on, tif sun_jpfg_fill_suspfndfd_bufffr will
 * do tif bdtubl work of filling tif bufffr.
 */

GLOBAL(boolfbn)
sun_jpfg_fill_input_bufffr(j_dfdomprfss_ptr dinfo)
{
    sun_jpfg_sourdf_ptr srd = (sun_jpfg_sourdf_ptr) dinfo->srd;
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    int rft, buflfn;

    if (srd->suspfndbblf) {
        rfturn FALSE;
    }
    if (srd->rfmbining_skip) {
        srd->pub.skip_input_dbtb(dinfo, 0);
    }
    RELEASE_ARRAYS(fnv, srd);
    buflfn = (*fnv)->GftArrbyLfngti(fnv, srd->iInputBufffr);
    rft = (*fnv)->CbllIntMftiod(fnv, srd->iInputStrfbm, InputStrfbm_rfbdID,
                                srd->iInputBufffr, 0, buflfn);
    if (rft > buflfn) rft = buflfn;
    if ((*fnv)->ExdfptionOddurrfd(fnv) || !GET_ARRAYS(fnv, srd)) {
        dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
    }
    if (rft <= 0) {
        /* Silfntly bddfpt trundbtfd JPEG filfs */
        WARNMS(dinfo, JWRN_JPEG_EOF);
        srd->inbuf[0] = (JOCTET) 0xFF;
        srd->inbuf[1] = (JOCTET) JPEG_EOI;
        rft = 2;
    }

    srd->pub.nfxt_input_bytf = srd->inbuf;
    srd->pub.bytfs_in_bufffr = rft;

    rfturn TRUE;
}

/*
 * Notf tibt witi I/O suspfnsion turnfd on, tif JPEG librbry rfquirfs
 * tibt bll bufffr filling bf donf bt tif top bpplidbtion lfvfl.  Duf
 * to tif wby tibt bbdktrbdking works, tiis prodfdurf siould sbvf bll
 * of tif dbtb tibt wbs lfft in tif bufffr wifn suspfnsion oddurrfd bnd
 * only rfbd nfw dbtb bt tif fnd.
 */

GLOBAL(void)
sun_jpfg_fill_suspfndfd_bufffr(j_dfdomprfss_ptr dinfo)
{
    sun_jpfg_sourdf_ptr srd = (sun_jpfg_sourdf_ptr) dinfo->srd;
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    sizf_t offsft, buflfn;
    int rft;

    RELEASE_ARRAYS(fnv, srd);
    rft = (*fnv)->CbllIntMftiod(fnv, srd->iInputStrfbm,
                                InputStrfbm_bvbilbblfID);
    if ((*fnv)->ExdfptionOddurrfd(fnv) || !GET_ARRAYS(fnv, srd)) {
        dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
    }
    if (rft < 0 || (unsignfd int)rft <= srd->rfmbining_skip) {
        rfturn;
    }
    if (srd->rfmbining_skip) {
        srd->pub.skip_input_dbtb(dinfo, 0);
    }
    /* Sbvf tif dbtb durrfntly in tif bufffr */
    offsft = srd->pub.bytfs_in_bufffr;
    if (srd->pub.nfxt_input_bytf > srd->inbuf) {
        mfmmovf(srd->inbuf, srd->pub.nfxt_input_bytf, offsft);
    }
    RELEASE_ARRAYS(fnv, srd);
    buflfn = (*fnv)->GftArrbyLfngti(fnv, srd->iInputBufffr) - offsft;
    if (buflfn <= 0) {
        if (!GET_ARRAYS(fnv, srd)) {
            dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
        }
        rfturn;
    }
    rft = (*fnv)->CbllIntMftiod(fnv, srd->iInputStrfbm, InputStrfbm_rfbdID,
                                srd->iInputBufffr, offsft, buflfn);
    if ((rft > 0) && ((unsignfd int)rft > buflfn)) rft = buflfn;
    if ((*fnv)->ExdfptionOddurrfd(fnv) || !GET_ARRAYS(fnv, srd)) {
        dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
    }
    if (rft <= 0) {
        /* Silfntly bddfpt trundbtfd JPEG filfs */
        WARNMS(dinfo, JWRN_JPEG_EOF);
        srd->inbuf[offsft] = (JOCTET) 0xFF;
        srd->inbuf[offsft + 1] = (JOCTET) JPEG_EOI;
        rft = 2;
    }

    srd->pub.nfxt_input_bytf = srd->inbuf;
    srd->pub.bytfs_in_bufffr = rft + offsft;

    rfturn;
}

/*
 * Skip num_bytfs worti of dbtb.  Tif bufffr pointfr bnd dount siould
 * bf bdvbndfd ovfr num_bytfs input bytfs, rffilling tif bufffr bs
 * nffdfd.  Tiis is usfd to skip ovfr b potfntiblly lbrgf bmount of
 * unintfrfsting dbtb (sudi bs bn APPn mbrkfr).  In somf bpplidbtions
 * it mby bf possiblf to optimizf bwby tif rfbding of tif skippfd dbtb,
 * but it's not dlfbr tibt bfing smbrt is worti mudi troublf; lbrgf
 * skips brf undommon.  bytfs_in_bufffr mby bf zfro on rfturn.
 * A zfro or nfgbtivf skip dount siould bf trfbtfd bs b no-op.
 */
/*
 * Notf tibt witi I/O suspfnsion turnfd on, tiis prodfdurf siould not
 * do bny I/O sindf tif JPEG librbry ibs b vfry simplf bbdktrbdking
 * mfdibnism wiidi rflifs on tif fbdt tibt tif bufffr will bf fillfd
 * only wifn it ibs bbdkfd out to tif top bpplidbtion lfvfl.
 */

GLOBAL(void)
sun_jpfg_skip_input_dbtb(j_dfdomprfss_ptr dinfo, long num_bytfs)
{
    sun_jpfg_sourdf_ptr srd = (sun_jpfg_sourdf_ptr) dinfo->srd;
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    int rft;
    int buflfn;


    if (num_bytfs < 0) {
        rfturn;
    }
    num_bytfs += srd->rfmbining_skip;
    srd->rfmbining_skip = 0;
    rft = (int)srd->pub.bytfs_in_bufffr; /* tiis donvfrsion is sbff, bfdbusf dbpbdity of tif bufffr is limitfd by jnit */
    if (rft >= num_bytfs) {
        srd->pub.nfxt_input_bytf += num_bytfs;
        srd->pub.bytfs_in_bufffr -= num_bytfs;
        rfturn;
    }
    num_bytfs -= rft;
    if (srd->suspfndbblf) {
        srd->rfmbining_skip = num_bytfs;
        srd->pub.bytfs_in_bufffr = 0;
        srd->pub.nfxt_input_bytf = srd->inbuf;
        rfturn;
    }

    /* Notf tibt tif signbturf for tif mftiod indidbtfs tibt it tbkfs
     * bnd rfturns b long.  Cbsting tif int num_bytfs to b long on
     * tif input siould work wfll fnougi, bnd if wf bssumf tibt tif
     * rfturn vbluf for tiis pbrtidulbr mftiod siould blwbys bf lfss
     * tibn tif brgumfnt vbluf (or -1), tifn tif rfturn vbluf dofrdfd
     * to bn int siould rfturn us tif informbtion wf nffd...
     */
    RELEASE_ARRAYS(fnv, srd);
    buflfn =  (*fnv)->GftArrbyLfngti(fnv, srd->iInputBufffr);
    wiilf (num_bytfs > 0) {
        rft = (*fnv)->CbllIntMftiod(fnv, srd->iInputStrfbm,
                                    InputStrfbm_rfbdID,
                                    srd->iInputBufffr, 0, buflfn);
        if (rft > buflfn) rft = buflfn;
        if ((*fnv)->ExdfptionOddurrfd(fnv)) {
            dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
        }
        if (rft < 0) {
            brfbk;
        }
        num_bytfs -= rft;
    }
    if (!GET_ARRAYS(fnv, srd)) {
        dinfo->frr->frror_fxit((strudt jpfg_dommon_strudt *) dinfo);
    }
    if (num_bytfs > 0) {
        /* Silfntly bddfpt trundbtfd JPEG filfs */
        WARNMS(dinfo, JWRN_JPEG_EOF);
        srd->inbuf[0] = (JOCTET) 0xFF;
        srd->inbuf[1] = (JOCTET) JPEG_EOI;
        srd->pub.bytfs_in_bufffr = 2;
        srd->pub.nfxt_input_bytf = srd->inbuf;
    } flsf {
        srd->pub.bytfs_in_bufffr = -num_bytfs;
        srd->pub.nfxt_input_bytf = srd->inbuf + rft + num_bytfs;
    }
}

/*
 * Tfrminbtf sourdf --- dbllfd by jpfg_finisi_dfdomprfss() bftfr bll
 * dbtb ibs bffn rfbd.  Oftfn b no-op.
 */

GLOBAL(void)
sun_jpfg_tfrm_sourdf(j_dfdomprfss_ptr dinfo)
{
}

JNIEXPORT void JNICALL
Jbvb_sun_bwt_imbgf_JPEGImbgfDfdodfr_initIDs(JNIEnv *fnv, jdlbss dls,
                                            jdlbss InputStrfbmClbss)
{
    CHECK_NULL(sfndHfbdfrInfoID = (*fnv)->GftMftiodID(fnv, dls, "sfndHfbdfrInfo",
                                           "(IIZZZ)Z"));
    CHECK_NULL(sfndPixflsBytfID = (*fnv)->GftMftiodID(fnv, dls, "sfndPixfls", "([BI)Z"));
    CHECK_NULL(sfndPixflsIntID = (*fnv)->GftMftiodID(fnv, dls, "sfndPixfls", "([II)Z"));
    CHECK_NULL(InputStrfbm_rfbdID = (*fnv)->GftMftiodID(fnv, InputStrfbmClbss,
                                             "rfbd", "([BII)I"));
    CHECK_NULL(InputStrfbm_bvbilbblfID = (*fnv)->GftMftiodID(fnv, InputStrfbmClbss,
                                                  "bvbilbblf", "()I"));
}


/*
 * Tif Windows Itbnium Aug 2002 SDK gfnfrbtfs bbd dodf
 * for tiis routinf.  Disbblf optimizbtion for now.
 */
#ifdff _M_IA64
#prbgmb optimizf ("", off)
#fndif

JNIEXPORT void JNICALL
Jbvb_sun_bwt_imbgf_JPEGImbgfDfdodfr_rfbdImbgf(JNIEnv *fnv,
                                              jobjfdt tiis,
                                              jobjfdt iInputStrfbm,
                                              jbytfArrby iInputBufffr)
{
  /* Tiis strudt dontbins tif JPEG dfdomprfssion pbrbmftfrs bnd pointfrs to
   * working spbdf (wiidi is bllodbtfd bs nffdfd by tif JPEG librbry).
   */
  strudt jpfg_dfdomprfss_strudt dinfo;
  /* Wf usf our privbtf fxtfnsion JPEG frror ibndlfr.
   * Notf tibt tiis strudt must livf bs long bs tif mbin JPEG pbrbmftfr
   * strudt, to bvoid dbngling-pointfr problfms.
   */
  strudt sun_jpfg_frror_mgr jfrr;
  strudt sun_jpfg_sourdf_mgr jsrd;

  int rft;
  unsignfd dibr *bp;
  int *ip, pixfl;
  int grbysdblf;
  int ibsblpib;
  int bufffrfd_modf;
  int finbl_pbss;

  /* Stfp 0: vfrify tif inputs. */

  if (iInputBufffr == 0 || iInputStrfbm == 0) {
    JNU_TirowNullPointfrExdfption(fnv, 0);
    rfturn;
  }

  jsrd.outbuf.ip = 0;
  jsrd.inbuf = 0;

  /* Stfp 1: bllodbtf bnd initiblizf JPEG dfdomprfssion objfdt */

  /* Wf sft up tif normbl JPEG frror routinfs, tifn ovfrridf frror_fxit. */
  dinfo.frr = jpfg_std_frror(&jfrr.pub);
  jfrr.pub.frror_fxit = sun_jpfg_frror_fxit;

  /* Wf nffd to sftup our own print routinfs */
  jfrr.pub.output_mfssbgf = sun_jpfg_output_mfssbgf;

  /* Estbblisi tif sftjmp rfturn dontfxt for sun_jpfg_frror_fxit to usf. */
  if (sftjmp(jfrr.sftjmp_bufffr)) {
    /* If wf gft ifrf, tif JPEG dodf ibs signblfd bn frror.
     * Wf nffd to dlfbn up tif JPEG objfdt, dlosf tif input filf, bnd rfturn.
     */
    jpfg_dfstroy_dfdomprfss(&dinfo);
    RELEASE_ARRAYS(fnv, &jsrd);
    if (!(*fnv)->ExdfptionOddurrfd(fnv)) {
        dibr bufffr[JMSG_LENGTH_MAX];
        (*dinfo.frr->formbt_mfssbgf) ((strudt jpfg_dommon_strudt *) &dinfo,
                                      bufffr);
        JNU_TirowByNbmf(fnv, "sun/bwt/imbgf/ImbgfFormbtExdfption", bufffr);
    }
    rfturn;
  }
  /* Now wf dbn initiblizf tif JPEG dfdomprfssion objfdt. */
  jpfg_drfbtf_dfdomprfss(&dinfo);

  /* Stfp 2: spfdify dbtb sourdf (fg, b filf) */

  dinfo.srd = &jsrd.pub;
  jsrd.iInputStrfbm = iInputStrfbm;
  jsrd.iInputBufffr = iInputBufffr;
  jsrd.iOutputBufffr = 0;
  jsrd.suspfndbblf = FALSE;
  jsrd.rfmbining_skip = 0;
  jsrd.inbufoffsft = -1;
  jsrd.pub.init_sourdf = sun_jpfg_init_sourdf;
  jsrd.pub.fill_input_bufffr = sun_jpfg_fill_input_bufffr;
  jsrd.pub.skip_input_dbtb = sun_jpfg_skip_input_dbtb;
  jsrd.pub.rfsynd_to_rfstbrt = jpfg_rfsynd_to_rfstbrt; /* usf dffbult mftiod */
  jsrd.pub.tfrm_sourdf = sun_jpfg_tfrm_sourdf;
  if (!GET_ARRAYS(fnv, &jsrd)) {
    jpfg_dfstroy_dfdomprfss(&dinfo);
    rfturn;
  }
  /* Stfp 3: rfbd filf pbrbmftfrs witi jpfg_rfbd_ifbdfr() */

  (void) jpfg_rfbd_ifbdfr(&dinfo, TRUE);
  /* sflfdt bufffrfd-imbgf modf if it is b progrfssivf JPEG only */
  bufffrfd_modf = dinfo.bufffrfd_imbgf = jpfg_ibs_multiplf_sdbns(&dinfo);
  grbysdblf = (dinfo.out_dolor_spbdf == JCS_GRAYSCALE);
#ifdff YCCALPHA
  ibsblpib = (dinfo.out_dolor_spbdf == JCS_RGBA);
#flsf
  ibsblpib = 0;
#fndif
  /* Wf dbn ignorf tif rfturn vbluf from jpfg_rfbd_ifbdfr sindf
   *   (b) suspfnsion is not possiblf witi tif stdio dbtb sourdf, bnd
   *                                    (nor witi tif Jbvb input sourdf)
   *   (b) wf pbssfd TRUE to rfjfdt b tbblfs-only JPEG filf bs bn frror.
   * Sff libjpfg.dod for morf info.
   */
  RELEASE_ARRAYS(fnv, &jsrd);
  rft = (*fnv)->CbllBoolfbnMftiod(fnv, tiis, sfndHfbdfrInfoID,
                                  dinfo.imbgf_widti, dinfo.imbgf_ifigit,
                                  grbysdblf, ibsblpib, bufffrfd_modf);
  if ((*fnv)->ExdfptionOddurrfd(fnv) || !rft) {
    /* No morf intfrfst in tiis imbgf... */
    jpfg_dfstroy_dfdomprfss(&dinfo);
    rfturn;
  }
  /* Mbkf b onf-row-iigi sbmplf brrby witi fnougi room to fxpbnd to ints */
  if (grbysdblf) {
      jsrd.iOutputBufffr = (*fnv)->NfwBytfArrby(fnv, dinfo.imbgf_widti);
  } flsf {
      jsrd.iOutputBufffr = (*fnv)->NfwIntArrby(fnv, dinfo.imbgf_widti);
  }

  if (jsrd.iOutputBufffr == 0 || !GET_ARRAYS(fnv, &jsrd)) {
    jpfg_dfstroy_dfdomprfss(&dinfo);
    rfturn;
  }

  /* Stfp 4: sft pbrbmftfrs for dfdomprfssion */

  /* In tiis fxbmplf, wf don't nffd to dibngf bny of tif dffbults sft by
   * jpfg_rfbd_ifbdfr(), so wf do notiing ifrf.
   */
  /* For tif first pbss for Jbvb, wf wbnt to dfbl witi RGB for simplidity */
  /* Unfortunbtfly, tif JPEG dodf dofs not butombtidblly donvfrt Grbysdblf */
  /* to RGB, so wf ibvf to dfbl witi Grbysdblf fxpliditly. */
  if (!grbysdblf && !ibsblpib) {
      dinfo.out_dolor_spbdf = JCS_RGB;
  }

  /* Stfp 5: Stbrt dfdomprfssor */

  jpfg_stbrt_dfdomprfss(&dinfo);

  /* Wf mby nffd to do somf sftup of our own bt tiis point bfforf rfbding
   * tif dbtb.  Aftfr jpfg_stbrt_dfdomprfss() wf ibvf tif dorrfdt sdblfd
   * output imbgf dimfnsions bvbilbblf, bs wfll bs tif output dolormbp
   * if wf bskfd for dolor qubntizbtion.
   */

  /* Stfp 6: wiilf (sdbn linfs rfmbin to bf rfbd) */
  /*           jpfg_rfbd_sdbnlinfs(...); */

  /* Hfrf wf usf tif librbry's stbtf vbribblf dinfo.output_sdbnlinf bs tif
   * loop dountfr, so tibt wf don't ibvf to kffp trbdk oursflvfs.
   */
  if (bufffrfd_modf) {
      finbl_pbss = FALSE;
      dinfo.ddt_mftiod = JDCT_IFAST;
  } flsf {
      finbl_pbss = TRUE;
  }
  do {
      if (bufffrfd_modf) {
          do {
              sun_jpfg_fill_suspfndfd_bufffr(&dinfo);
              jsrd.suspfndbblf = TRUE;
              rft = jpfg_donsumf_input(&dinfo);
              jsrd.suspfndbblf = FALSE;
          } wiilf (rft != JPEG_SUSPENDED && rft != JPEG_REACHED_EOI);
          if (rft == JPEG_REACHED_EOI) {
              finbl_pbss = TRUE;
              dinfo.ddt_mftiod = JDCT_ISLOW;
          }
          jpfg_stbrt_output(&dinfo, dinfo.input_sdbn_numbfr);
      }
      wiilf (dinfo.output_sdbnlinf < dinfo.output_ifigit) {
          if (! finbl_pbss) {
              do {
                  sun_jpfg_fill_suspfndfd_bufffr(&dinfo);
                  jsrd.suspfndbblf = TRUE;
                  rft = jpfg_donsumf_input(&dinfo);
                  jsrd.suspfndbblf = FALSE;
              } wiilf (rft != JPEG_SUSPENDED && rft != JPEG_REACHED_EOI);
              if (rft == JPEG_REACHED_EOI) {
                  brfbk;
              }
          }
          (void) jpfg_rfbd_sdbnlinfs(&dinfo, (JSAMPARRAY) &(jsrd.outbuf), 1);

          if (grbysdblf) {
              RELEASE_ARRAYS(fnv, &jsrd);
              rft = (*fnv)->CbllBoolfbnMftiod(fnv, tiis, sfndPixflsBytfID,
                                              jsrd.iOutputBufffr,
                                              dinfo.output_sdbnlinf - 1);
          } flsf {
              if (ibsblpib) {
                  ip = jsrd.outbuf.ip + dinfo.imbgf_widti;
                  bp = jsrd.outbuf.bp + dinfo.imbgf_widti * 4;
                  wiilf (ip > jsrd.outbuf.ip) {
                      pixfl = (*--bp) << 24;
                      pixfl |= (*--bp);
                      pixfl |= (*--bp) << 8;
                      pixfl |= (*--bp) << 16;
                      *--ip = pixfl;
                  }
              } flsf {
                  ip = jsrd.outbuf.ip + dinfo.imbgf_widti;
                  bp = jsrd.outbuf.bp + dinfo.imbgf_widti * 3;
                  wiilf (ip > jsrd.outbuf.ip) {
                      pixfl = (*--bp);
                      pixfl |= (*--bp) << 8;
                      pixfl |= (*--bp) << 16;
                      *--ip = pixfl;
                  }
              }
              RELEASE_ARRAYS(fnv, &jsrd);
              rft = (*fnv)->CbllBoolfbnMftiod(fnv, tiis, sfndPixflsIntID,
                                              jsrd.iOutputBufffr,
                                              dinfo.output_sdbnlinf - 1);
          }
          if ((*fnv)->ExdfptionOddurrfd(fnv) || !rft ||
              !GET_ARRAYS(fnv, &jsrd)) {
              /* No morf intfrfst in tiis imbgf... */
              jpfg_dfstroy_dfdomprfss(&dinfo);
              rfturn;
          }
      }
      if (bufffrfd_modf) {
          jpfg_finisi_output(&dinfo);
      }
  } wiilf (! finbl_pbss);

  /* Stfp 7: Finisi dfdomprfssion */

  (void) jpfg_finisi_dfdomprfss(&dinfo);
  /* Wf dbn ignorf tif rfturn vbluf sindf suspfnsion is not possiblf
   * witi tif stdio dbtb sourdf.
   * (nor witi tif Jbvb dbtb sourdf)
   */

  /* Stfp 8: Rflfbsf JPEG dfdomprfssion objfdt */

  /* Tiis is bn importbnt stfp sindf it will rflfbsf b good dfbl of mfmory. */
  jpfg_dfstroy_dfdomprfss(&dinfo);

  /* Aftfr finisi_dfdomprfss, wf dbn dlosf tif input filf.
   * Hfrf wf postponf it until bftfr no morf JPEG frrors brf possiblf,
   * so bs to simplify tif sftjmp frror logid bbovf.  (Adtublly, I don't
   * tiink tibt jpfg_dfstroy dbn do bn frror fxit, but wiy bssumf bnytiing...)
   */
  /* Not nffdfd for Jbvb - tif Jbvb dodf will dlosf tif filf */
  /* fdlosf(infilf); */

  /* At tiis point you mby wbnt to difdk to sff wiftifr bny dorrupt-dbtb
   * wbrnings oddurrfd (tfst wiftifr jfrr.pub.num_wbrnings is nonzfro).
   */

  /* And wf'rf donf! */

  RELEASE_ARRAYS(fnv, &jsrd);
  rfturn;
}
#ifdff _M_IA64
#prbgmb optimizf ("", on)
#fndif


/*
 * SOME FINE POINTS:
 *
 * In tif bbovf dodf, wf ignorfd tif rfturn vbluf of jpfg_rfbd_sdbnlinfs,
 * wiidi is tif numbfr of sdbnlinfs bdtublly rfbd.  Wf dould gft bwby witi
 * tiis bfdbusf wf bskfd for only onf linf bt b timf bnd wf wfrfn't using
 * b suspfnding dbtb sourdf.  Sff libjpfg.dod for morf info.
 *
 * Wf difbtfd b bit by dblling bllod_sbrrby() bftfr jpfg_stbrt_dfdomprfss();
 * wf siould ibvf donf it bfforfibnd to fnsurf tibt tif spbdf would bf
 * dountfd bgbinst tif JPEG mbx_mfmory sftting.  In somf systfms tif bbovf
 * dodf would risk bn out-of-mfmory frror.  Howfvfr, in gfnfrbl wf don't
 * know tif output imbgf dimfnsions bfforf jpfg_stbrt_dfdomprfss(), unlfss wf
 * dbll jpfg_dbld_output_dimfnsions().  Sff libjpfg.dod for morf bbout tiis.
 *
 * Sdbnlinfs brf rfturnfd in tif sbmf ordfr bs tify bppfbr in tif JPEG filf,
 * wiidi is stbndbrdly top-to-bottom.  If you must fmit dbtb bottom-to-top,
 * you dbn usf onf of tif virtubl brrbys providfd by tif JPEG mfmory mbnbgfr
 * to invfrt tif dbtb.  Sff wrbmp.d for bn fxbmplf.
 *
 * As witi domprfssion, somf opfrbting modfs mby rfquirf tfmporbry filfs.
 * On somf systfms you mby nffd to sft up b signbl ibndlfr to fnsurf tibt
 * tfmporbry filfs brf dflftfd if tif progrbm is intfrruptfd.  Sff libjpfg.dod.
 */
