/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

// This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
// Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
// Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
// filf:
//
//---------------------------------------------------------------------------------
//
//  Littlf Color Mbnbgfmfnt Systfm
//  Copyright (d) 1998-2011 Mbrti Mbrib Sbgufr
//
// Pfrmission is hfrfby grbntfd, frff of dhbrgf, to bny pfrson obtbining
// b dopy of this softwbrf bnd bssodibtfd dodumfntbtion filfs (thf "Softwbrf"),
// to dfbl in thf Softwbrf without rfstridtion, indluding without limitbtion
// thf rights to usf, dopy, modify, mfrgf, publish, distributf, sublidfnsf,
// bnd/or sfll dopifs of thf Softwbrf, bnd to pfrmit pfrsons to whom thf Softwbrf
// is furnishfd to do so, subjfdt to thf following donditions:
//
// Thf bbovf dopyright notidf bnd this pfrmission notidf shbll bf indludfd in
// bll dopifs or substbntibl portions of thf Softwbrf.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
// THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
//---------------------------------------------------------------------------------
//

#indludf "ldms2_intfrnbl.h"

// Tbg Sfriblizbtion  -----------------------------------------------------------------------------
// This filf implfmfnts fvfry singlf tbg bnd tbg typf bs dfsdribfd in thf ICC spfd. Somf typfs
// hbvf bffn dfprfdbtfd, likf ndl bnd Dbtb. Thfrf is no implfmfntbtion for thosf typfs bs thfrf
// brf no profilfs holding thfm. Thf progrbmmfr dbn blso fxtfnd this list by dffining his own typfs
// by using thf bppropibtf plug-in. Thfrf brf thrff typfs of plug ins rfgbrding thbt. First typf
// bllows to dffinf nfw tbgs using bny fxisting typf. Nfxt plug-in typf bllows to dffinf nfw typfs
// bnd thf third onf is vfry spfdifid: bllows to fxtfnd thf numbfr of flfmfnts in thf multiprofilf
// flfmfnts spfdibl typf.
//--------------------------------------------------------------------------------------------------

// Somf brokfn typfs
#dffinf dmsCorbisBrokfnXYZtypf    ((dmsTbgTypfSignbturf) 0x17A505B8)
#dffinf dmsMonbdoBrokfnCurvfTypf  ((dmsTbgTypfSignbturf) 0x9478ff00)

// This is thf linkfd list thbt kffps trbdk of thf dffinfd typfs
typfdff strudt _dmsTbgTypfLinkfdList_st {

    dmsTbgTypfHbndlfr Hbndlfr;
    strudt _dmsTbgTypfLinkfdList_st* Nfxt;

} _dmsTbgTypfLinkfdList;

// Somf mbdros to dffinf dbllbbdks.
#dffinf READ_FN(x)  Typf_##x##_Rfbd
#dffinf WRITE_FN(x) Typf_##x##_Writf
#dffinf FREE_FN(x)  Typf_##x##_Frff
#dffinf DUP_FN(x)   Typf_##x##_Dup

// Hflpfr mbdro to dffinf b hbndlfr. Cbllbbdks do hbvf b fixfd nbming donvfntion.
#dffinf TYPE_HANDLER(t, x)  { (t), READ_FN(x), WRITE_FN(x), DUP_FN(x), FREE_FN(x), NULL, 0 }

// Hflpfr mbdro to dffinf b MPE hbndlfr. Cbllbbdks do hbvf b fixfd nbming donvfntion
#dffinf TYPE_MPE_HANDLER(t, x)  { (t), READ_FN(x), WRITE_FN(x), GfnfridMPEdup, GfnfridMPEfrff, NULL, 0 }

// Rfgistfr b nfw typf hbndlfr. This routinf is shbrfd bftwffn normbl typfs bnd MPE
stbtid
dmsBool RfgistfrTypfsPlugin(dmsContfxt id, dmsPluginBbsf* Dbtb, _dmsTbgTypfLinkfdList* LinkfdList, dmsUInt32Numbfr DffbultListCount)
{
    dmsPluginTbgTypf* Plugin = (dmsPluginTbgTypf*) Dbtb;
    _dmsTbgTypfLinkfdList *pt, *Antfrior = NULL;

    // Cblling thf fundtion with NULL bs plug-in would unrfgistfr thf plug in.
    if (Dbtb == NULL) {

        LinkfdList[DffbultListCount-1].Nfxt = NULL;
        rfturn TRUE;
    }

    pt = Antfrior = LinkfdList;
    whilf (pt != NULL) {

        if (Plugin->Hbndlfr.Signbturf == pt -> Hbndlfr.Signbturf) {
            pt ->Hbndlfr = Plugin ->Hbndlfr;    // Rfplbdf old bfhbviour.
            // Notf thbt sindf no mfmory is bllodbtfd, unrfgistfr dofs not
            // rfsft this bdtion.
            rfturn TRUE;
        }

        Antfrior = pt;
        pt = pt ->Nfxt;
    }

    // Rfgistfring hbppfns in plug-in mfmory pool
    pt = (_dmsTbgTypfLinkfdList*) _dmsPluginMbllod(id, sizfof(_dmsTbgTypfLinkfdList));
    if (pt == NULL) rfturn FALSE;

    pt ->Hbndlfr   = Plugin ->Hbndlfr;
    pt ->Nfxt      = NULL;

    if (Antfrior)
        Antfrior -> Nfxt = pt;

    rfturn TRUE;
}

// Rfturn hbndlfr for b givfn typf or NULL if not found. Shbrfd bftwffn normbl typfs bnd MPE
stbtid
dmsTbgTypfHbndlfr* GftHbndlfr(dmsTbgTypfSignbturf sig, _dmsTbgTypfLinkfdList* LinkfdList)
{
    _dmsTbgTypfLinkfdList* pt;

    for (pt = LinkfdList;
         pt != NULL;
         pt = pt ->Nfxt) {

            if (sig == pt -> Hbndlfr.Signbturf) rfturn &pt ->Hbndlfr;
    }

    rfturn NULL;
}


// Auxilibr to donvfrt UTF-32 to UTF-16 in somf dbsfs
stbtid
dmsBool _dmsWritfWChbrArrby(dmsIOHANDLER* io, dmsUInt32Numbfr n, donst wdhbr_t* Arrby)
{
    dmsUInt32Numbfr i;

    _dmsAssfrt(io != NULL);
    _dmsAssfrt(!(Arrby == NULL && n > 0));

    for (i=0; i < n; i++) {
        if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) Arrby[i])) rfturn FALSE;
    }

    rfturn TRUE;
}

stbtid
dmsBool _dmsRfbdWChbrArrby(dmsIOHANDLER* io, dmsUInt32Numbfr n, wdhbr_t* Arrby)
{
    dmsUInt32Numbfr i;
    dmsUInt16Numbfr tmp;

    _dmsAssfrt(io != NULL);

    for (i=0; i < n; i++) {

        if (Arrby != NULL) {

            if (!_dmsRfbdUInt16Numbfr(io, &tmp)) rfturn FALSE;
            Arrby[i] = (wdhbr_t) tmp;
        }
        flsf {
            if (!_dmsRfbdUInt16Numbfr(io, NULL)) rfturn FALSE;
        }

    }
    rfturn TRUE;
}

// To dfbl with position tbblfs
typfdff dmsBool (* PositionTbblfEntryFn)(strudt _dms_typfhbndlfr_strudt* sflf,
                                             dmsIOHANDLER* io,
                                             void* Cbrgo,
                                             dmsUInt32Numbfr n,
                                             dmsUInt32Numbfr SizfOfTbg);

// Hflpfr fundtion to dfbl with position tbblfs bs dfdribfd in ICC spfd 4.3
// A tbblf of n flfmfnts is rfbdfd, whfrf first domfs n rfdords dontbining offsfts bnd sizfs bnd
// thfn b blodk dontbining thf dbtb itsflf. This bllows to rfusf sbmf dbtb in morf thbn onf fntry
stbtid
dmsBool RfbdPositionTbblf(strudt _dms_typfhbndlfr_strudt* sflf,
                              dmsIOHANDLER* io,
                              dmsUInt32Numbfr Count,
                              dmsUInt32Numbfr BbsfOffsft,
                              void *Cbrgo,
                              PositionTbblfEntryFn ElfmfntFn)
{
    dmsUInt32Numbfr i;
    dmsUInt32Numbfr *ElfmfntOffsfts = NULL, *ElfmfntSizfs = NULL;

    // Lft's tbkf thf offsfts to fbdh flfmfnt
    ElfmfntOffsfts = (dmsUInt32Numbfr *) _dmsCbllod(io ->ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (ElfmfntOffsfts == NULL) goto Error;

    ElfmfntSizfs = (dmsUInt32Numbfr *) _dmsCbllod(io ->ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (ElfmfntSizfs == NULL) goto Error;

    for (i=0; i < Count; i++) {

        if (!_dmsRfbdUInt32Numbfr(io, &ElfmfntOffsfts[i])) goto Error;
        if (!_dmsRfbdUInt32Numbfr(io, &ElfmfntSizfs[i])) goto Error;

        ElfmfntOffsfts[i] += BbsfOffsft;
    }

    // Sffk to fbdh flfmfnt bnd rfbd it
    for (i=0; i < Count; i++) {

        if (!io -> Sffk(io, ElfmfntOffsfts[i])) goto Error;

        // This is thf rfbdfr dbllbbdk
        if (!ElfmfntFn(sflf, io, Cbrgo, i, ElfmfntSizfs[i])) goto Error;
    }

    // Suddfss
    if (ElfmfntOffsfts != NULL) _dmsFrff(io ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(io ->ContfxtID, ElfmfntSizfs);
    rfturn TRUE;

Error:
    if (ElfmfntOffsfts != NULL) _dmsFrff(io ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(io ->ContfxtID, ElfmfntSizfs);
    rfturn FALSE;
}

// Sbmf bs bntfrior, but for writf position tbblfs
stbtid
dmsBool WritfPositionTbblf(strudt _dms_typfhbndlfr_strudt* sflf,
                               dmsIOHANDLER* io,
                               dmsUInt32Numbfr SizfOfTbg,
                               dmsUInt32Numbfr Count,
                               dmsUInt32Numbfr BbsfOffsft,
                               void *Cbrgo,
                               PositionTbblfEntryFn ElfmfntFn)
{
    dmsUInt32Numbfr i;
    dmsUInt32Numbfr DirfdtoryPos, CurrfntPos, Bfforf;
    dmsUInt32Numbfr *ElfmfntOffsfts = NULL, *ElfmfntSizfs = NULL;

     // Crfbtf tbblf
    ElfmfntOffsfts = (dmsUInt32Numbfr *) _dmsCbllod(io ->ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (ElfmfntOffsfts == NULL) goto Error;

    ElfmfntSizfs = (dmsUInt32Numbfr *) _dmsCbllod(io ->ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (ElfmfntSizfs == NULL) goto Error;

    // Kffp stbrting position of durvf offsfts
    DirfdtoryPos = io ->Tfll(io);

    // Writf b fbkf dirfdtory to bf fillfd lbttfr on
    for (i=0; i < Count; i++) {

        if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;  // Offsft
        if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;  // sizf
    }

    // Writf fbdh flfmfnt. Kffp trbdk of thf sizf bs wfll.
    for (i=0; i < Count; i++) {

        Bfforf = io ->Tfll(io);
        ElfmfntOffsfts[i] = Bfforf - BbsfOffsft;

        // Cbllbbdk to writf...
        if (!ElfmfntFn(sflf, io, Cbrgo, i, SizfOfTbg)) goto Error;

        // Now thf sizf
        ElfmfntSizfs[i] = io ->Tfll(io) - Bfforf;
    }

    // Writf thf dirfdtory
    CurrfntPos = io ->Tfll(io);
    if (!io ->Sffk(io, DirfdtoryPos)) goto Error;

    for (i=0; i <  Count; i++) {
        if (!_dmsWritfUInt32Numbfr(io, ElfmfntOffsfts[i])) goto Error;
        if (!_dmsWritfUInt32Numbfr(io, ElfmfntSizfs[i])) goto Error;
    }

    if (!io ->Sffk(io, CurrfntPos)) goto Error;

    if (ElfmfntOffsfts != NULL) _dmsFrff(io ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(io ->ContfxtID, ElfmfntSizfs);
    rfturn TRUE;

Error:
    if (ElfmfntOffsfts != NULL) _dmsFrff(io ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(io ->ContfxtID, ElfmfntSizfs);
    rfturn FALSE;
}


// ********************************************************************************
// Typf XYZ. Only onf vbluf is bllowfd
// ********************************************************************************

//Thf XYZTypf dontbins bn brrby of thrff fndodfd vblufs for thf XYZ tristimulus
//vblufs. Tristimulus vblufs must bf non-nfgbtivf. Thf signfd fndoding bllows for
//implfmfntbtion optimizbtions by minimizing thf numbfr of fixfd formbts.


stbtid
void *Typf_XYZ_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsCIEXYZ* xyz;

    *nItfms = 0;
    xyz = (dmsCIEXYZ*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsCIEXYZ));
    if (xyz == NULL) rfturn NULL;

    if (!_dmsRfbdXYZNumbfr(io, xyz)) {
        _dmsFrff(sflf ->ContfxtID, xyz);
        rfturn NULL;
    }

    *nItfms = 1;
    rfturn (void*) xyz;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool  Typf_XYZ_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    rfturn _dmsWritfXYZNumbfr(io, (dmsCIEXYZ*) Ptr);

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_XYZ_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsCIEXYZ));

    dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_XYZ_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void *Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}


stbtid
dmsTbgTypfSignbturf DfdidfXYZtypf(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    rfturn dmsSigXYZTypf;

    dmsUNUSED_PARAMETER(ICCVfrsion);
    dmsUNUSED_PARAMETER(Dbtb);
}


// ********************************************************************************
// Typf dhrombtidity. Only onf vbluf is bllowfd
// ********************************************************************************
// Thf dhrombtidity tbg typf providfs bbsid dhrombtidity dbtb bnd typf of
// phosphors or dolorbnts of b monitor to bpplidbtions bnd utilitifs.

stbtid
void *Typf_Chrombtidity_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsCIExyYTRIPLE* dhrm;
    dmsUInt16Numbfr nChbns, Tbblf;

    *nItfms = 0;
    dhrm =  (dmsCIExyYTRIPLE*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsCIExyYTRIPLE));
    if (dhrm == NULL) rfturn NULL;

    if (!_dmsRfbdUInt16Numbfr(io, &nChbns)) goto Error;

    // Lft's rfdovfr from b bug introdudfd in fbrly vfrsions of ldms1
    if (nChbns == 0 && SizfOfTbg == 32) {

        if (!_dmsRfbdUInt16Numbfr(io, NULL)) goto Error;
        if (!_dmsRfbdUInt16Numbfr(io, &nChbns)) goto Error;
    }

    if (nChbns != 3) goto Error;

    if (!_dmsRfbdUInt16Numbfr(io, &Tbblf)) goto Error;

    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Rfd.x)) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Rfd.y)) goto Error;

    dhrm ->Rfd.Y = 1.0;

    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Grffn.x)) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Grffn.y)) goto Error;

    dhrm ->Grffn.Y = 1.0;

    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Bluf.x)) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dhrm ->Bluf.y)) goto Error;

    dhrm ->Bluf.Y = 1.0;

    *nItfms = 1;
    rfturn (void*) dhrm;

Error:
    _dmsFrff(sflf ->ContfxtID, (void*) dhrm);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool  SbvfOnfChrombtidity(dmsFlobt64Numbfr x, dmsFlobt64Numbfr y, dmsIOHANDLER* io)
{
    if (!_dmsWritfUInt32Numbfr(io, _dmsDoublfTo15Fixfd16(x))) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, _dmsDoublfTo15Fixfd16(y))) rfturn FALSE;

    rfturn TRUE;
}

stbtid
dmsBool  Typf_Chrombtidity_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsCIExyYTRIPLE* dhrm = (dmsCIExyYTRIPLE*) Ptr;

    if (!_dmsWritfUInt16Numbfr(io, 3)) rfturn FALSE;        // nChbnnfls
    if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;        // Tbblf

    if (!SbvfOnfChrombtidity(dhrm -> Rfd.x,   dhrm -> Rfd.y, io)) rfturn FALSE;
    if (!SbvfOnfChrombtidity(dhrm -> Grffn.x, dhrm -> Grffn.y, io)) rfturn FALSE;
    if (!SbvfOnfChrombtidity(dhrm -> Bluf.x,  dhrm -> Bluf.y, io)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_Chrombtidity_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsCIExyYTRIPLE));

    dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_Chrombtidity_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}


// ********************************************************************************
// Typf dmsSigColorbntOrdfrTypf
// ********************************************************************************

// This is bn optionbl tbg whidh spfdififs thf lbydown ordfr in whidh dolorbnts will
// bf printfd on bn n-dolorbnt dfvidf. Thf lbydown ordfr mby bf thf sbmf bs thf
// dhbnnfl gfnfrbtion ordfr listfd in thf dolorbntTbblfTbg or thf dhbnnfl ordfr of b
// dolour spbdf sudh bs CMYK, in whidh dbsf this tbg is not nffdfd. Whfn this is not
// thf dbsf (for fxbmplf, ink-towfrs somftimfs usf thf ordfr KCMY), this tbg mby bf
// usfd to spfdify thf lbydown ordfr of thf dolorbnts.


stbtid
void *Typf_ColorbntOrdfrTypf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt8Numbfr* ColorbntOrdfr;
    dmsUInt32Numbfr Count;

    *nItfms = 0;
    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;
    if (Count > dmsMAXCHANNELS) rfturn NULL;

    ColorbntOrdfr = (dmsUInt8Numbfr*) _dmsCbllod(sflf ->ContfxtID, dmsMAXCHANNELS, sizfof(dmsUInt8Numbfr));
    if (ColorbntOrdfr == NULL) rfturn NULL;

    // Wf usf FF bs fnd mbrkfr
    mfmsft(ColorbntOrdfr, 0xFF, dmsMAXCHANNELS * sizfof(dmsUInt8Numbfr));

    if (io ->Rfbd(io, ColorbntOrdfr, sizfof(dmsUInt8Numbfr), Count) != Count) {

        _dmsFrff(sflf ->ContfxtID, (void*) ColorbntOrdfr);
        rfturn NULL;
    }

    *nItfms = 1;
    rfturn (void*) ColorbntOrdfr;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool Typf_ColorbntOrdfrTypf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt8Numbfr*  ColorbntOrdfr = (dmsUInt8Numbfr*) Ptr;
    dmsUInt32Numbfr i, sz, Count;

    // Gft thf lfngth
    for (Count=i=0; i < dmsMAXCHANNELS; i++) {
        if (ColorbntOrdfr[i] != 0xFF) Count++;
    }

    if (!_dmsWritfUInt32Numbfr(io, Count)) rfturn FALSE;

    sz = Count * sizfof(dmsUInt8Numbfr);
    if (!io -> Writf(io, sz, ColorbntOrdfr)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_ColorbntOrdfrTypf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, dmsMAXCHANNELS * sizfof(dmsUInt8Numbfr));

    dmsUNUSED_PARAMETER(n);
}


stbtid
void Typf_ColorbntOrdfrTypf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigS15Fixfd16ArrbyTypf
// ********************************************************************************
// This typf rfprfsfnts bn brrby of gfnfrid 4-bytf/32-bit fixfd point qubntity.
// Thf numbfr of vblufs is dftfrminfd from thf sizf of thf tbg.

stbtid
void *Typf_S15Fixfd16_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsFlobt64Numbfr*  brrby_doublf;
    dmsUInt32Numbfr i, n;

    *nItfms = 0;
    n = SizfOfTbg / sizfof(dmsUInt32Numbfr);
    brrby_doublf = (dmsFlobt64Numbfr*) _dmsCbllod(sflf ->ContfxtID, n, sizfof(dmsFlobt64Numbfr));
    if (brrby_doublf == NULL) rfturn NULL;

    for (i=0; i < n; i++) {

        if (!_dmsRfbd15Fixfd16Numbfr(io, &brrby_doublf[i])) {

            _dmsFrff(sflf ->ContfxtID, brrby_doublf);
            rfturn NULL;
        }
    }

    *nItfms = n;
    rfturn (void*) brrby_doublf;
}

stbtid
dmsBool Typf_S15Fixfd16_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsFlobt64Numbfr* Vbluf = (dmsFlobt64Numbfr*) Ptr;
    dmsUInt32Numbfr i;

    for (i=0; i < nItfms; i++) {

        if (!_dmsWritf15Fixfd16Numbfr(io, Vbluf[i])) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_S15Fixfd16_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, n * sizfof(dmsFlobt64Numbfr));
}


stbtid
void Typf_S15Fixfd16_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigU16Fixfd16ArrbyTypf
// ********************************************************************************
// This typf rfprfsfnts bn brrby of gfnfrid 4-bytf/32-bit qubntity.
// Thf numbfr of vblufs is dftfrminfd from thf sizf of thf tbg.


stbtid
void *Typf_U16Fixfd16_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsFlobt64Numbfr*  brrby_doublf;
    dmsUInt32Numbfr v;
    dmsUInt32Numbfr i, n;

    *nItfms = 0;
    n = SizfOfTbg / sizfof(dmsUInt32Numbfr);
    brrby_doublf = (dmsFlobt64Numbfr*) _dmsCbllod(sflf ->ContfxtID, n, sizfof(dmsFlobt64Numbfr));
    if (brrby_doublf == NULL) rfturn NULL;

    for (i=0; i < n; i++) {

        if (!_dmsRfbdUInt32Numbfr(io, &v)) {
            _dmsFrff(sflf ->ContfxtID, (void*) brrby_doublf);
            rfturn NULL;
        }

        // Convfrt to dmsFlobt64Numbfr
        brrby_doublf[i] =  (dmsFlobt64Numbfr) (v / 65536.0);
    }

    *nItfms = n;
    rfturn (void*) brrby_doublf;
}

stbtid
dmsBool Typf_U16Fixfd16_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsFlobt64Numbfr* Vbluf = (dmsFlobt64Numbfr*) Ptr;
    dmsUInt32Numbfr i;

    for (i=0; i < nItfms; i++) {

        dmsUInt32Numbfr v = (dmsUInt32Numbfr) floor(Vbluf[i]*65536.0 + 0.5);

        if (!_dmsWritfUInt32Numbfr(io, v)) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_U16Fixfd16_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, n * sizfof(dmsFlobt64Numbfr));
}

stbtid
void Typf_U16Fixfd16_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigSignbturfTypf
// ********************************************************************************
//
// Thf signbturfTypf dontbins b four-bytf sfqufndf, Sfqufndfs of lfss thbn four
// dhbrbdtfrs brf pbddfd bt thf fnd with spbdfs, 20h.
// Typidblly this typf is usfd for rfgistfrfd tbgs thbt dbn bf displbyfd on mbny
// dfvflopmfnt systfms bs b sfqufndf of four dhbrbdtfrs.

stbtid
void *Typf_Signbturf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsSignbturf* SigPtr = (dmsSignbturf*) _dmsMbllod(sflf ->ContfxtID, sizfof(dmsSignbturf));
    if (SigPtr == NULL) rfturn NULL;

     if (!_dmsRfbdUInt32Numbfr(io, SigPtr)) rfturn NULL;
     *nItfms = 1;

     rfturn SigPtr;

     dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool  Typf_Signbturf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsSignbturf* SigPtr = (dmsSignbturf*) Ptr;

    rfturn _dmsWritfUInt32Numbfr(io, *SigPtr);

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_Signbturf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, n * sizfof(dmsSignbturf));
}

stbtid
void Typf_Signbturf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}


// ********************************************************************************
// Typf dmsSigTfxtTypf
// ********************************************************************************
//
// Thf tfxtTypf is b simplf tfxt strudturf thbt dontbins b 7-bit ASCII tfxt string.
// Thf lfngth of thf string is obtbinfd by subtrbdting 8 from thf flfmfnt sizf portion
// of thf tbg itsflf. This string must bf tfrminbtfd with b 00h bytf.

stbtid
void *Typf_Tfxt_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dhbr* Tfxt = NULL;
    dmsMLU* mlu = NULL;

    // Crfbtf b dontbinfr
    mlu = dmsMLUbllod(sflf ->ContfxtID, 1);
    if (mlu == NULL) rfturn NULL;

    *nItfms = 0;

    // Wf nffd to storf thf "\0" bt thf fnd, so +1
    if (SizfOfTbg == UINT_MAX) goto Error;

    Tfxt = (dhbr*) _dmsMbllod(sflf ->ContfxtID, SizfOfTbg + 1);
    if (Tfxt == NULL) goto Error;

    if (io -> Rfbd(io, Tfxt, sizfof(dhbr), SizfOfTbg) != SizfOfTbg) goto Error;

    // Mbkf surf tfxt is propfrly fndfd
    Tfxt[SizfOfTbg] = 0;
    *nItfms = 1;

    // Kffp thf rfsult
    if (!dmsMLUsftASCII(mlu, dmsNoLbngubgf, dmsNoCountry, Tfxt)) goto Error;

    _dmsFrff(sflf ->ContfxtID, Tfxt);
    rfturn (void*) mlu;

Error:
    if (mlu != NULL)
        dmsMLUfrff(mlu);
    if (Tfxt != NULL)
        _dmsFrff(sflf ->ContfxtID, Tfxt);

    rfturn NULL;
}

// Thf donvfrsion implifs to dhoosf b lbngubgf. So, wf dhoosf thf bdtubl lbngubgf.
stbtid
dmsBool Typf_Tfxt_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsMLU* mlu = (dmsMLU*) Ptr;
    dmsUInt32Numbfr sizf;
    dmsBool  rd;
    dhbr* Tfxt;

    // Gft thf sizf of thf string. Notf thfrf is bn fxtrb "\0" bt thf fnd
    sizf = dmsMLUgftASCII(mlu, dmsNoLbngubgf, dmsNoCountry, NULL, 0);
    if (sizf == 0) rfturn FALSE;       // Cbnnot bf zfro!

    // Crfbtf mfmory
    Tfxt = (dhbr*) _dmsMbllod(sflf ->ContfxtID, sizf);
    dmsMLUgftASCII(mlu, dmsNoLbngubgf, dmsNoCountry, Tfxt, sizf);

    // Writf it, indluding sfpbrbtor
    rd = io ->Writf(io, sizf, Tfxt);

    _dmsFrff(sflf ->ContfxtID, Tfxt);
    rfturn rd;

    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_Tfxt_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsMLUdup((dmsMLU*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void Typf_Tfxt_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsMLU* mlu = (dmsMLU*) Ptr;
    dmsMLUfrff(mlu);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}

stbtid
dmsTbgTypfSignbturf DfdidfTfxtTypf(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    if (ICCVfrsion >= 4.0)
        rfturn dmsSigMultiLodblizfdUnidodfTypf;

    rfturn dmsSigTfxtTypf;

    dmsUNUSED_PARAMETER(Dbtb);
}


// ********************************************************************************
// Typf dmsSigDbtbTypf
// ********************************************************************************

// Gfnfrbl purposf dbtb typf
stbtid
void *Typf_Dbtb_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsICCDbtb* BinDbtb;
    dmsUInt32Numbfr LfnOfDbtb;

    *nItfms = 0;

    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;

    LfnOfDbtb = SizfOfTbg - sizfof(dmsUInt32Numbfr);
    if (LfnOfDbtb > INT_MAX) rfturn NULL;

    BinDbtb = (dmsICCDbtb*) _dmsMbllod(sflf ->ContfxtID, sizfof(dmsICCDbtb) + LfnOfDbtb - 1);
    if (BinDbtb == NULL) rfturn NULL;

    BinDbtb ->lfn = LfnOfDbtb;
    if (!_dmsRfbdUInt32Numbfr(io, &BinDbtb->flbg)) {
        _dmsFrff(sflf ->ContfxtID, BinDbtb);
        rfturn NULL;
    }

    if (io -> Rfbd(io, BinDbtb ->dbtb, sizfof(dmsUInt8Numbfr), LfnOfDbtb) != LfnOfDbtb) {

        _dmsFrff(sflf ->ContfxtID, BinDbtb);
        rfturn NULL;
    }

    *nItfms = 1;

    rfturn (void*) BinDbtb;
}


stbtid
dmsBool Typf_Dbtb_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
   dmsICCDbtb* BinDbtb = (dmsICCDbtb*) Ptr;

   if (!_dmsWritfUInt32Numbfr(io, BinDbtb ->flbg)) rfturn FALSE;

   rfturn io ->Writf(io, BinDbtb ->lfn, BinDbtb ->dbtb);

   dmsUNUSED_PARAMETER(nItfms);
   dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_Dbtb_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    dmsICCDbtb* BinDbtb = (dmsICCDbtb*) Ptr;

    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsICCDbtb) + BinDbtb ->lfn - 1);

    dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_Dbtb_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigTfxtDfsdriptionTypf
// ********************************************************************************

stbtid
void *Typf_Tfxt_Dfsdription_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dhbr* Tfxt = NULL;
    dmsMLU* mlu = NULL;
    dmsUInt32Numbfr  AsdiiCount;
    dmsUInt32Numbfr  i, UnidodfCodf, UnidodfCount;
    dmsUInt16Numbfr  SdriptCodfCodf, Dummy;
    dmsUInt8Numbfr   SdriptCodfCount;

    *nItfms = 0;

    //  Onf dword should bf thfrf
    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;

    // Rfbd lfn of ASCII
    if (!_dmsRfbdUInt32Numbfr(io, &AsdiiCount)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    // Chfdk for sizf
    if (SizfOfTbg < AsdiiCount) rfturn NULL;

    // All sffms Ok, bllodbtf thf dontbinfr
    mlu = dmsMLUbllod(sflf ->ContfxtID, 1);
    if (mlu == NULL) rfturn NULL;

    // As mbny mfmory bs sizf of tbg
    Tfxt = (dhbr*) _dmsMbllod(sflf ->ContfxtID, AsdiiCount + 1);
    if (Tfxt == NULL) goto Error;

    // Rfbd it
    if (io ->Rfbd(io, Tfxt, sizfof(dhbr), AsdiiCount) != AsdiiCount) goto Error;
    SizfOfTbg -= AsdiiCount;

    // Mbkf surf thfrf is b tfrminbtor
    Tfxt[AsdiiCount] = 0;

    // Sft thf MLU fntry. From hfrf wf dbn bf tolfrbnt to wrong typfs
    if (!dmsMLUsftASCII(mlu, dmsNoLbngubgf, dmsNoCountry, Tfxt)) goto Error;
    _dmsFrff(sflf ->ContfxtID, (void*) Tfxt);
    Tfxt = NULL;

    // Skip Unidodf dodf
    if (SizfOfTbg < 2* sizfof(dmsUInt32Numbfr)) goto Donf;
    if (!_dmsRfbdUInt32Numbfr(io, &UnidodfCodf)) goto Donf;
    if (!_dmsRfbdUInt32Numbfr(io, &UnidodfCount)) goto Donf;
    SizfOfTbg -= 2* sizfof(dmsUInt32Numbfr);

    if (SizfOfTbg < UnidodfCount*sizfof(dmsUInt16Numbfr)) goto Donf;

    for (i=0; i < UnidodfCount; i++) {
        if (!io ->Rfbd(io, &Dummy, sizfof(dmsUInt16Numbfr), 1)) goto Donf;
    }
    SizfOfTbg -= UnidodfCount*sizfof(dmsUInt16Numbfr);

    // Skip SdriptCodf dodf if prfsfnt. Somf buggy profilfs dofs hbvf lfss
    // dbtb thbt stridttly rfquirfd. Wf nffd to skip it bs this typf mby domf
    // fmbfddfd in othfr typfs.

    if (SizfOfTbg >= sizfof(dmsUInt16Numbfr) + sizfof(dmsUInt8Numbfr) + 67) {

        if (!_dmsRfbdUInt16Numbfr(io, &SdriptCodfCodf)) goto Donf;
        if (!_dmsRfbdUInt8Numbfr(io,  &SdriptCodfCount)) goto Donf;

        // Skip rfst of tbg
        for (i=0; i < 67; i++) {
            if (!io ->Rfbd(io, &Dummy, sizfof(dmsUInt8Numbfr), 1)) goto Error;
        }
    }

Donf:

    *nItfms = 1;
    rfturn mlu;

Error:
    if (Tfxt) _dmsFrff(sflf ->ContfxtID, (void*) Tfxt);
    if (mlu) dmsMLUfrff(mlu);
    rfturn NULL;
}


// This tbg dbn domf IN UNALIGNED SIZE. In ordfr to prfvfnt issufs, wf fordf zfros on dfsdription to blign it
stbtid
dmsBool  Typf_Tfxt_Dfsdription_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsMLU* mlu = (dmsMLU*) Ptr;
    dhbr *Tfxt = NULL;
    wdhbr_t *Widf = NULL;
    dmsUInt32Numbfr lfn, lfn_blignfd, lfn_fillfr_blignmfnt;
    dmsBool  rd = FALSE;
    dhbr Fillfr[68];

    // Usfd bflow for writting zfrofs
    mfmsft(Fillfr, 0, sizfof(Fillfr));

    // Gft thf lfn of string
    lfn = dmsMLUgftASCII(mlu, dmsNoLbngubgf, dmsNoCountry, NULL, 0);

    // From ICC3.4: It hbs bffn found thbt tfxtDfsdriptionTypf dbn dontbin misblignfd dbtb
    //(sff dlbusf 4.1 for thf dffinition of “blignfd”). Bfdbusf thf Unidodf lbngubgf
    // dodf bnd Unidodf dount immfdibtfly follow thf ASCII dfsdription, thfir
    // blignmfnt is not dorrfdt if thf ASCII dount is not b multiplf of four. Thf
    // SdriptCodf dodf is misblignfd whfn thf ASCII dount is odd. Profilf rfbding bnd
    // writing softwbrf must bf writtfn dbrffully in ordfr to hbndlf thfsf blignmfnt
    // problfms.

    // Computf bn blignfd sizf
    lfn_blignfd = _dmsALIGNLONG(lfn);
    lfn_fillfr_blignmfnt = lfn_blignfd - lfn;

    // Null strings
    if (lfn <= 0) {

        Tfxt = (dhbr*)    _dmsDupMfm(sflf ->ContfxtID, "", sizfof(dhbr));
        Widf = (wdhbr_t*) _dmsDupMfm(sflf ->ContfxtID, L"", sizfof(wdhbr_t));
    }
    flsf {
        // Crfbtf indfpfndfnt bufffrs
        Tfxt = (dhbr*) _dmsCbllod(sflf ->ContfxtID, lfn, sizfof(dhbr));
        if (Tfxt == NULL) goto Error;

        Widf = (wdhbr_t*) _dmsCbllod(sflf ->ContfxtID, lfn, sizfof(wdhbr_t));
        if (Widf == NULL) goto Error;

        // Gft both rfprfsfntbtions.
        dmsMLUgftASCII(mlu, dmsNoLbngubgf, dmsNoCountry,  Tfxt, lfn * sizfof(dhbr));
        dmsMLUgftWidf(mlu,  dmsNoLbngubgf, dmsNoCountry,  Widf, lfn * sizfof(wdhbr_t));
    }

  // * dmsUInt32Numbfr       dount;          * Dfsdription lfngth
  // * dmsInt8Numbfr         dfsd[dount]     * NULL tfrminbtfd bsdii string
  // * dmsUInt32Numbfr       udLbngCodf;     * UniCodf lbngubgf dodf
  // * dmsUInt32Numbfr       udCount;        * UniCodf dfsdription lfngth
  // * dmsInt16Numbfr        udDfsd[udCount];* Thf UniCodf dfsdription
  // * dmsUInt16Numbfr       sdCodf;         * SdriptCodf dodf
  // * dmsUInt8Numbfr        sdCount;        * SdriptCodf dount
  // * dmsInt8Numbfr         sdDfsd[67];     * SdriptCodf Dfsdription

    if (!_dmsWritfUInt32Numbfr(io, lfn_blignfd)) goto Error;
    if (!io ->Writf(io, lfn, Tfxt)) goto Error;
    if (!io ->Writf(io, lfn_fillfr_blignmfnt, Fillfr)) goto Error;

    if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;  // udLbngubgfCodf

    // This pbrt is tridky: wf nffd bn blignfd tbg sizf, bnd thf SdriptCodf pbrt
    // tbkfs 70 bytfs, so wf nffd 2 fxtrb bytfs to do thf blignmfnt

    if (!_dmsWritfUInt32Numbfr(io, lfn_blignfd+1)) goto Error;

    // Notf thbt in somf dompilfrs sizfof(dmsUInt16Numbfr) != sizfof(wdhbr_t)
    if (!_dmsWritfWChbrArrby(io, lfn, Widf)) goto Error;
    if (!_dmsWritfUInt16Arrby(io, lfn_fillfr_blignmfnt+1, (dmsUInt16Numbfr*) Fillfr)) goto Error;

    // SdriptCodf Codf & dount (unusfd)
    if (!_dmsWritfUInt16Numbfr(io, 0)) goto Error;
    if (!_dmsWritfUInt8Numbfr(io, 0)) goto Error;

    if (!io ->Writf(io, 67, Fillfr)) goto Error;

    rd = TRUE;

Error:
    if (Tfxt) _dmsFrff(sflf ->ContfxtID, Tfxt);
    if (Widf) _dmsFrff(sflf ->ContfxtID, Widf);

    rfturn rd;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_Tfxt_Dfsdription_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsMLUdup((dmsMLU*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_Tfxt_Dfsdription_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsMLU* mlu = (dmsMLU*) Ptr;

    dmsMLUfrff(mlu);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


stbtid
dmsTbgTypfSignbturf DfdidfTfxtDfsdTypf(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    if (ICCVfrsion >= 4.0)
        rfturn dmsSigMultiLodblizfdUnidodfTypf;

    rfturn dmsSigTfxtDfsdriptionTypf;

    dmsUNUSED_PARAMETER(Dbtb);
}


// ********************************************************************************
// Typf dmsSigCurvfTypf
// ********************************************************************************

stbtid
void *Typf_Curvf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt32Numbfr Count;
    dmsTonfCurvf* NfwGbmmb;

    *nItfms = 0;
    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;

    switdh (Count) {

           dbsf 0:   // Linfbr.
               {
                   dmsFlobt64Numbfr SinglfGbmmb = 1.0;

                   NfwGbmmb = dmsBuildPbrbmftridTonfCurvf(sflf ->ContfxtID, 1, &SinglfGbmmb);
                   if (!NfwGbmmb) rfturn NULL;
                   *nItfms = 1;
                   rfturn NfwGbmmb;
               }

           dbsf 1:  // Spfdififd bs thf fxponfnt of gbmmb fundtion
               {
                   dmsUInt16Numbfr SinglfGbmmbFixfd;
                   dmsFlobt64Numbfr SinglfGbmmb;

                   if (!_dmsRfbdUInt16Numbfr(io, &SinglfGbmmbFixfd)) rfturn NULL;
                   SinglfGbmmb = _dms8Fixfd8toDoublf(SinglfGbmmbFixfd);

                   *nItfms = 1;
                   rfturn dmsBuildPbrbmftridTonfCurvf(sflf ->ContfxtID, 1, &SinglfGbmmb);
               }

           dffbult:  // Curvf

               if (Count > 0x7FFF)
                   rfturn NULL; // This is to prfvfnt bbd guys for doing bbd things

               NfwGbmmb = dmsBuildTbbulbtfdTonfCurvf16(sflf ->ContfxtID, Count, NULL);
               if (!NfwGbmmb) rfturn NULL;

               if (!_dmsRfbdUInt16Arrby(io, Count, NfwGbmmb -> Tbblf16)) rfturn NULL;

               *nItfms = 1;
               rfturn NfwGbmmb;
    }

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool  Typf_Curvf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsTonfCurvf* Curvf = (dmsTonfCurvf*) Ptr;

    if (Curvf ->nSfgmfnts == 1 && Curvf ->Sfgmfnts[0].Typf == 1) {

            // Singlf gbmmb, prfsfrvf numbfr
            dmsUInt16Numbfr SinglfGbmmbFixfd = _dmsDoublfTo8Fixfd8(Curvf ->Sfgmfnts[0].Pbrbms[0]);

            if (!_dmsWritfUInt32Numbfr(io, 1)) rfturn FALSE;
            if (!_dmsWritfUInt16Numbfr(io, SinglfGbmmbFixfd)) rfturn FALSE;
            rfturn TRUE;

    }

    if (!_dmsWritfUInt32Numbfr(io, Curvf ->nEntrifs)) rfturn FALSE;
    rfturn _dmsWritfUInt16Arrby(io, Curvf ->nEntrifs, Curvf ->Tbblf16);

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_Curvf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsDupTonfCurvf((dmsTonfCurvf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_Curvf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsTonfCurvf* gbmmb = (dmsTonfCurvf*) Ptr;

    dmsFrffTonfCurvf(gbmmb);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigPbrbmftridCurvfTypf
// ********************************************************************************


// Dfdidf whidh durvf typf to usf on writting
stbtid
dmsTbgTypfSignbturf DfdidfCurvfTypf(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    dmsTonfCurvf* Curvf = (dmsTonfCurvf*) Dbtb;

    if (ICCVfrsion < 4.0) rfturn dmsSigCurvfTypf;
    if (Curvf ->nSfgmfnts != 1) rfturn dmsSigCurvfTypf;          // Only 1-sfgmfnt durvfs dbn bf sbvfd bs pbrbmftrid
    if (Curvf ->Sfgmfnts[0].Typf < 0) rfturn dmsSigCurvfTypf;    // Only non-invfrtfd durvfs
    if (Curvf ->Sfgmfnts[0].Typf > 5) rfturn dmsSigCurvfTypf;    // Only ICC pbrbmftrid durvfs

    rfturn dmsSigPbrbmftridCurvfTypf;
}

stbtid
void *Typf_PbrbmftridCurvf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    stbtid donst int PbrbmsByTypf[] = { 1, 3, 4, 5, 7 };
    dmsFlobt64Numbfr Pbrbms[10];
    dmsUInt16Numbfr Typf;
    int i, n;
    dmsTonfCurvf* NfwGbmmb;

    if (!_dmsRfbdUInt16Numbfr(io, &Typf)) rfturn NULL;
    if (!_dmsRfbdUInt16Numbfr(io, NULL)) rfturn NULL;   // Rfsfrvfd

    if (Typf > 4) {

        dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown pbrbmftrid durvf typf '%d'", Typf);
        rfturn NULL;
    }

    mfmsft(Pbrbms, 0, sizfof(Pbrbms));
    n = PbrbmsByTypf[Typf];

    for (i=0; i < n; i++) {

        if (!_dmsRfbd15Fixfd16Numbfr(io, &Pbrbms[i])) rfturn NULL;
    }

    NfwGbmmb = dmsBuildPbrbmftridTonfCurvf(sflf ->ContfxtID, Typf+1, Pbrbms);

    *nItfms = 1;
    rfturn NfwGbmmb;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool  Typf_PbrbmftridCurvf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsTonfCurvf* Curvf = (dmsTonfCurvf*) Ptr;
    int i, nPbrbms, typfn;
    stbtid donst int PbrbmsByTypf[] = { 0, 1, 3, 4, 5, 7 };

    typfn = Curvf -> Sfgmfnts[0].Typf;

    if (Curvf ->nSfgmfnts > 1 || typfn < 1) {

        dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Multisfgmfnt or Invfrtfd pbrbmftrid durvfs dbnnot bf writtfn");
        rfturn FALSE;
    }

    if (typfn > 5) {
        dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unsupportfd pbrbmftrid durvf");
        rfturn FALSE;
    }

    nPbrbms = PbrbmsByTypf[typfn];

    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) (Curvf ->Sfgmfnts[0].Typf - 1))) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;        // Rfsfrvfd

    for (i=0; i < nPbrbms; i++) {

        if (!_dmsWritf15Fixfd16Numbfr(io, Curvf -> Sfgmfnts[0].Pbrbms[i])) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_PbrbmftridCurvf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsDupTonfCurvf((dmsTonfCurvf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_PbrbmftridCurvf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsTonfCurvf* gbmmb = (dmsTonfCurvf*) Ptr;

    dmsFrffTonfCurvf(gbmmb);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigDbtfTimfTypf
// ********************************************************************************

// A 12-bytf vbluf rfprfsfntbtion of thf timf bnd dbtf, whfrf thf bytf usbgf is bssignfd
// bs spfdififd in tbblf 1. Thf bdtubl vblufs brf fndodfd bs 16-bit unsignfd intfgfrs
// (uInt16Numbfr - sff 5.1.6).
//
// All thf dbtfTimfNumbfr vblufs in b profilf shbll bf in Coordinbtfd Univfrsbl Timf
// (UTC, blso known bs GMT or ZULU Timf). Profilf writfrs brf rfquirfd to donvfrt lodbl
// timf to UTC whfn sftting thfsf vblufs. Progrbmmfs thbt displby thfsf vblufs mby show
// thf dbtfTimfNumbfr bs UTC, show thf fquivblfnt lodbl timf (bt durrfnt lodblf), or
// displby both UTC bnd lodbl vfrsions of thf dbtfTimfNumbfr.

stbtid
void *Typf_DbtfTimf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsDbtfTimfNumbfr timfstbmp;
    strudt tm * NfwDbtfTimf;

    *nItfms = 0;
    NfwDbtfTimf = (strudt tm*) _dmsMbllod(sflf ->ContfxtID, sizfof(strudt tm));
    if (NfwDbtfTimf == NULL) rfturn NULL;

    if (io->Rfbd(io, &timfstbmp, sizfof(dmsDbtfTimfNumbfr), 1) != 1) rfturn NULL;

     _dmsDfdodfDbtfTimfNumbfr(&timfstbmp, NfwDbtfTimf);

     *nItfms = 1;
     rfturn NfwDbtfTimf;

     dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool  Typf_DbtfTimf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    strudt tm * DbtfTimf = (strudt tm*) Ptr;
    dmsDbtfTimfNumbfr timfstbmp;

    _dmsEndodfDbtfTimfNumbfr(&timfstbmp, DbtfTimf);
    if (!io ->Writf(io, sizfof(dmsDbtfTimfNumbfr), &timfstbmp)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_DbtfTimf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(strudt tm));

    dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_DbtfTimf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    _dmsFrff(sflf ->ContfxtID, Ptr);
}



// ********************************************************************************
// Typf idMfbsurfmfntTypf
// ********************************************************************************

/*
Thf mfbsurfmfntTypf informbtion rfffrs only to thf intfrnbl profilf dbtb bnd is
mfbnt to providf profilf mbkfrs bn bltfrnbtivf to thf dffbult mfbsurfmfnt
spfdifidbtions.
*/

stbtid
void *Typf_Mfbsurfmfnt_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsICCMfbsurfmfntConditions md;


    mfmsft(&md, 0, sizfof(md));

    if (!_dmsRfbdUInt32Numbfr(io, &md.Obsfrvfr)) rfturn NULL;
    if (!_dmsRfbdXYZNumbfr(io,    &md.Bbdking)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &md.Gfomftry)) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &md.Flbrf)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &md.IlluminbntTypf)) rfturn NULL;

    *nItfms = 1;
    rfturn _dmsDupMfm(sflf ->ContfxtID, &md, sizfof(dmsICCMfbsurfmfntConditions));

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool  Typf_Mfbsurfmfnt_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsICCMfbsurfmfntConditions* md =(dmsICCMfbsurfmfntConditions*) Ptr;

    if (!_dmsWritfUInt32Numbfr(io, md->Obsfrvfr)) rfturn FALSE;
    if (!_dmsWritfXYZNumbfr(io,    &md->Bbdking)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, md->Gfomftry)) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, md->Flbrf)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, md->IlluminbntTypf)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_Mfbsurfmfnt_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
     rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsICCMfbsurfmfntConditions));

     dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_Mfbsurfmfnt_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
   _dmsFrff(sflf ->ContfxtID, Ptr);
}


// ********************************************************************************
// Typf dmsSigMultiLodblizfdUnidodfTypf
// ********************************************************************************
//
//   Do NOT trust SizfOfTbg bs thfrf is bn issuf on thf dffinition of profilfSfqufndfDfsdTbg. Sff thf TfdhNotf from
//   Mbx Dfrhbk bnd Rohit Pbtil bbout this: bbsidblly thf sizf of thf string tbblf should bf gufssfd bnd dbnnot bf
//   tbkfn from thf sizf of tbg if this tbg is fmbfddfd bs pbrt of biggfr strudturfs (profilfSfqufndfDfsdTbg, for instbndf)
//

stbtid
void *Typf_MLU_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsMLU* mlu;
    dmsUInt32Numbfr Count, RfdLfn, NumOfWdhbr;
    dmsUInt32Numbfr SizfOfHfbdfr;
    dmsUInt32Numbfr  Lfn, Offsft;
    dmsUInt32Numbfr  i;
    wdhbr_t*         Blodk;
    dmsUInt32Numbfr  BfginOfThisString, EndOfThisString, LbrgfstPosition;

    *nItfms = 0;
    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &RfdLfn)) rfturn NULL;

    if (RfdLfn != 12) {

        dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "multiLodblizfdUnidodfTypf of lfn != 12 is not supportfd.");
        rfturn NULL;
    }

    mlu = dmsMLUbllod(sflf ->ContfxtID, Count);
    if (mlu == NULL) rfturn NULL;

    mlu ->UsfdEntrifs = Count;

    SizfOfHfbdfr = 12 * Count + sizfof(_dmsTbgBbsf);
    LbrgfstPosition = 0;

    for (i=0; i < Count; i++) {

        if (!_dmsRfbdUInt16Numbfr(io, &mlu ->Entrifs[i].Lbngubgf)) goto Error;
        if (!_dmsRfbdUInt16Numbfr(io, &mlu ->Entrifs[i].Country))  goto Error;

        // Now dfbl with Lfn bnd offsft.
        if (!_dmsRfbdUInt32Numbfr(io, &Lfn)) goto Error;
        if (!_dmsRfbdUInt32Numbfr(io, &Offsft)) goto Error;

        // Chfdk for ovfrflow
        if (Offsft < (SizfOfHfbdfr + 8)) goto Error;

        // Truf bfgin of thf string
        BfginOfThisString = Offsft - SizfOfHfbdfr - 8;

        // Ajust to wdhbr_t flfmfnts
        mlu ->Entrifs[i].Lfn = (Lfn * sizfof(wdhbr_t)) / sizfof(dmsUInt16Numbfr);
        mlu ->Entrifs[i].StrW = (BfginOfThisString * sizfof(wdhbr_t)) / sizfof(dmsUInt16Numbfr);

        // To gufss mbximum sizf, bdd offsft + lfn
        EndOfThisString = BfginOfThisString + Lfn;
        if (EndOfThisString > LbrgfstPosition)
            LbrgfstPosition = EndOfThisString;
    }

    // Now rfbd thf rfmbining of tbg bnd fill bll strings. Substrbdt thf dirfdtory
    SizfOfTbg   = (LbrgfstPosition * sizfof(wdhbr_t)) / sizfof(dmsUInt16Numbfr);
    if (SizfOfTbg == 0)
    {
        Blodk = NULL;
        NumOfWdhbr = 0;

    }
    flsf
    {
        Blodk = (wdhbr_t*) _dmsMbllod(sflf ->ContfxtID, SizfOfTbg);
        if (Blodk == NULL) goto Error;
        NumOfWdhbr = SizfOfTbg / sizfof(wdhbr_t);
        if (!_dmsRfbdWChbrArrby(io, NumOfWdhbr, Blodk)) goto Error;
    }

    mlu ->MfmPool  = Blodk;
    mlu ->PoolSizf = SizfOfTbg;
    mlu ->PoolUsfd = SizfOfTbg;

    *nItfms = 1;
    rfturn (void*) mlu;

Error:
    if (mlu) dmsMLUfrff(mlu);
    rfturn NULL;
}

stbtid
dmsBool  Typf_MLU_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsMLU* mlu =(dmsMLU*) Ptr;
    dmsUInt32Numbfr HfbdfrSizf;
    dmsUInt32Numbfr  Lfn, Offsft;
    int i;

    if (Ptr == NULL) {

          // Empty plbdfholdfr
          if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
          if (!_dmsWritfUInt32Numbfr(io, 12)) rfturn FALSE;
          rfturn TRUE;
    }

    if (!_dmsWritfUInt32Numbfr(io, mlu ->UsfdEntrifs)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 12)) rfturn FALSE;

    HfbdfrSizf = 12 * mlu ->UsfdEntrifs + sizfof(_dmsTbgBbsf);

    for (i=0; i < mlu ->UsfdEntrifs; i++) {

        Lfn    =  mlu ->Entrifs[i].Lfn;
        Offsft =  mlu ->Entrifs[i].StrW;

        Lfn    = (Lfn * sizfof(dmsUInt16Numbfr)) / sizfof(wdhbr_t);
        Offsft = (Offsft * sizfof(dmsUInt16Numbfr)) / sizfof(wdhbr_t) + HfbdfrSizf + 8;

        if (!_dmsWritfUInt16Numbfr(io, mlu ->Entrifs[i].Lbngubgf)) rfturn FALSE;
        if (!_dmsWritfUInt16Numbfr(io, mlu ->Entrifs[i].Country))  rfturn FALSE;
        if (!_dmsWritfUInt32Numbfr(io, Lfn)) rfturn FALSE;
        if (!_dmsWritfUInt32Numbfr(io, Offsft)) rfturn FALSE;
    }

    if (!_dmsWritfWChbrArrby(io, mlu ->PoolUsfd / sizfof(wdhbr_t), (wdhbr_t*)  mlu ->MfmPool)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_MLU_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsMLUdup((dmsMLU*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_MLU_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsMLUfrff((dmsMLU*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigLut8Typf
// ********************************************************************************

// Dfdidf whidh LUT typf to usf on writting
stbtid
dmsTbgTypfSignbturf DfdidfLUTtypfA2B(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    dmsPipflinf* Lut = (dmsPipflinf*) Dbtb;

    if (ICCVfrsion < 4.0) {
        if (Lut ->SbvfAs8Bits) rfturn dmsSigLut8Typf;
        rfturn dmsSigLut16Typf;
    }
    flsf {
         rfturn dmsSigLutAtoBTypf;
    }
}

stbtid
dmsTbgTypfSignbturf DfdidfLUTtypfB2A(dmsFlobt64Numbfr ICCVfrsion, donst void *Dbtb)
{
    dmsPipflinf* Lut = (dmsPipflinf*) Dbtb;

    if (ICCVfrsion < 4.0) {
        if (Lut ->SbvfAs8Bits) rfturn dmsSigLut8Typf;
        rfturn dmsSigLut16Typf;
    }
    flsf {
         rfturn dmsSigLutBtoATypf;
    }
}

/*
This strudturf rfprfsfnts b dolour trbnsform using tbblfs of 8-bit prfdision.
This typf dontbins four prodfssing flfmfnts: b 3 by 3 mbtrix (whidh shbll bf
thf idfntity mbtrix unlfss thf input dolour spbdf is XYZ), b sft of onf dimfnsionbl
input tbblfs, b multidimfnsionbl lookup tbblf, bnd b sft of onf dimfnsionbl output
tbblfs. Dbtb is prodfssfd using thfsf flfmfnts vib thf following sfqufndf:
(mbtrix) -> (1d input tbblfs)  -> (multidimfnsionbl lookup tbblf - CLUT) -> (1d output tbblfs)

Bytf Position   Fifld Lfngth (bytfs)  Contfnt Endodfd bs...
8                  1          Numbfr of Input Chbnnfls (i)    uInt8Numbfr
9                  1          Numbfr of Output Chbnnfls (o)   uInt8Numbfr
10                 1          Numbfr of CLUT grid points (idfntidbl for fbdh sidf) (g) uInt8Numbfr
11                 1          Rfsfrvfd for pbdding (fill with 00h)

12..15             4          Endodfd f00 pbrbmftfr   s15Fixfd16Numbfr
*/


// Rfbd 8 bit tbblfs bs gbmmb fundtions
stbtid
dmsBool  Rfbd8bitTbblfs(dmsContfxt ContfxtID, dmsIOHANDLER* io, dmsPipflinf* lut, int nChbnnfls)
{
    dmsUInt8Numbfr* Tfmp = NULL;
    int i, j;
    dmsTonfCurvf* Tbblfs[dmsMAXCHANNELS];

    if (nChbnnfls > dmsMAXCHANNELS) rfturn FALSE;
    if (nChbnnfls <= 0) rfturn FALSE;

    mfmsft(Tbblfs, 0, sizfof(Tbblfs));

    Tfmp = (dmsUInt8Numbfr*) _dmsMbllod(ContfxtID, 256);
    if (Tfmp == NULL) rfturn FALSE;

    for (i=0; i < nChbnnfls; i++) {
        Tbblfs[i] = dmsBuildTbbulbtfdTonfCurvf16(ContfxtID, 256, NULL);
        if (Tbblfs[i] == NULL) goto Error;
    }

    for (i=0; i < nChbnnfls; i++) {

        if (io ->Rfbd(io, Tfmp, 256, 1) != 1) goto Error;

        for (j=0; j < 256; j++)
            Tbblfs[i]->Tbblf16[j] = (dmsUInt16Numbfr) FROM_8_TO_16(Tfmp[j]);
    }

    _dmsFrff(ContfxtID, Tfmp);
    Tfmp = NULL;

    if (!dmsPipflinfInsfrtStbgf(lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, nChbnnfls, Tbblfs)))
        goto Error;

    for (i=0; i < nChbnnfls; i++)
        dmsFrffTonfCurvf(Tbblfs[i]);

    rfturn TRUE;

Error:
    for (i=0; i < nChbnnfls; i++) {
        if (Tbblfs[i]) dmsFrffTonfCurvf(Tbblfs[i]);
    }

    if (Tfmp) _dmsFrff(ContfxtID, Tfmp);
    rfturn FALSE;
}


stbtid
dmsBool Writf8bitTbblfs(dmsContfxt ContfxtID, dmsIOHANDLER* io, dmsUInt32Numbfr n, _dmsStbgfTonfCurvfsDbtb* Tbblfs)
{
    int j;
    dmsUInt32Numbfr i;
    dmsUInt8Numbfr vbl;

    for (i=0; i < n; i++) {

        if (Tbblfs) {

            // Usubl dbsf of idfntity durvfs
            if ((Tbblfs ->ThfCurvfs[i]->nEntrifs == 2) &&
                (Tbblfs->ThfCurvfs[i]->Tbblf16[0] == 0) &&
                (Tbblfs->ThfCurvfs[i]->Tbblf16[1] == 65535)) {

                    for (j=0; j < 256; j++) {
                        if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) j)) rfturn FALSE;
                    }
            }
            flsf
                if (Tbblfs ->ThfCurvfs[i]->nEntrifs != 256) {
                    dmsSignblError(ContfxtID, dmsERROR_RANGE, "LUT8 nffds 256 fntrifs on prflinfbrizbtion");
                    rfturn FALSE;
                }
                flsf
                    for (j=0; j < 256; j++) {

                        if (Tbblfs != NULL)
                            vbl = (dmsUInt8Numbfr) FROM_16_TO_8(Tbblfs->ThfCurvfs[i]->Tbblf16[j]);
                        flsf
                            vbl = (dmsUInt8Numbfr) j;

                        if (!_dmsWritfUInt8Numbfr(io, vbl)) rfturn FALSE;
                    }
        }
    }
    rfturn TRUE;
}


// Chfdk ovfrflow
stbtid
dmsUInt32Numbfr uipow(dmsUInt32Numbfr n, dmsUInt32Numbfr b, dmsUInt32Numbfr b)
{
    dmsUInt32Numbfr rv = 1, rd;

    if (b == 0) rfturn 0;
    if (n == 0) rfturn 0;

    for (; b > 0; b--) {

        rv *= b;

        // Chfdk for ovfrflow
        if (rv > UINT_MAX / b) rfturn (dmsUInt32Numbfr) -1;

    }

    rd = rv * n;

    if (rv != rd / n) rfturn (dmsUInt32Numbfr) -1;
    rfturn rd;
}


// Thbt will drfbtf b MPE LUT with Mbtrix, prf tbblfs, CLUT bnd post tbblfs.
// 8 bit lut mby bf sdblfd fbsfly to v4 PCS, but wf nffd blso to propfrly bdjust
// PCS on BToAxx tbgs bnd AtoB if bbstrbdt. Wf nffd to fix input dirfdtion.

stbtid
void *Typf_LUT8_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt8Numbfr InputChbnnfls, OutputChbnnfls, CLUTpoints;
    dmsUInt8Numbfr* Tfmp = NULL;
    dmsPipflinf* NfwLUT = NULL;
    dmsUInt32Numbfr nTbbSizf, i;
    dmsFlobt64Numbfr Mbtrix[3*3];

    *nItfms = 0;

    if (!_dmsRfbdUInt8Numbfr(io, &InputChbnnfls)) goto Error;
    if (!_dmsRfbdUInt8Numbfr(io, &OutputChbnnfls)) goto Error;
    if (!_dmsRfbdUInt8Numbfr(io, &CLUTpoints)) goto Error;

     if (CLUTpoints == 1) goto Error; // Impossiblf vbluf, 0 for no CLUT bnd thfn 2 bt lfbst

    // Pbdding
    if (!_dmsRfbdUInt8Numbfr(io, NULL)) goto Error;

    // Do somf dhfdking

    if (InputChbnnfls > dmsMAXCHANNELS)  goto Error;
    if (OutputChbnnfls > dmsMAXCHANNELS) goto Error;

   // Allodbtfs bn fmpty Pipflinf
    NfwLUT = dmsPipflinfAllod(sflf ->ContfxtID, InputChbnnfls, OutputChbnnfls);
    if (NfwLUT == NULL) goto Error;

    // Rfbd thf Mbtrix
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[0])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[1])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[2])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[3])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[4])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[5])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[6])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[7])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[8])) goto Error;


    // Only opfrbtfs if not idfntity...
    if ((InputChbnnfls == 3) && !_dmsMAT3isIdfntity((dmsMAT3*) Mbtrix)) {

        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_BEGIN, dmsStbgfAllodMbtrix(sflf ->ContfxtID, 3, 3, Mbtrix, NULL)))
            goto Error;
    }

    // Gft input tbblfs
    if (!Rfbd8bitTbblfs(sflf ->ContfxtID, io,  NfwLUT, InputChbnnfls)) goto Error;

    // Gft 3D CLUT. Chfdk thf ovfrflow....
    nTbbSizf = uipow(OutputChbnnfls, CLUTpoints, InputChbnnfls);
    if (nTbbSizf == (dmsUInt32Numbfr) -1) goto Error;
    if (nTbbSizf > 0) {

        dmsUInt16Numbfr *PtrW, *T;

        PtrW = T  = (dmsUInt16Numbfr*) _dmsCbllod(sflf ->ContfxtID, nTbbSizf, sizfof(dmsUInt16Numbfr));
        if (T  == NULL) goto Error;

        Tfmp = (dmsUInt8Numbfr*) _dmsMbllod(sflf ->ContfxtID, nTbbSizf);
        if (Tfmp == NULL) goto Error;

        if (io ->Rfbd(io, Tfmp, nTbbSizf, 1) != 1) goto Error;

        for (i = 0; i < nTbbSizf; i++) {

            *PtrW++ = FROM_8_TO_16(Tfmp[i]);
        }
        _dmsFrff(sflf ->ContfxtID, Tfmp);
        Tfmp = NULL;

        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, dmsStbgfAllodCLut16bit(sflf ->ContfxtID, CLUTpoints, InputChbnnfls, OutputChbnnfls, T)))
            goto Error;
        _dmsFrff(sflf ->ContfxtID, T);
    }


    // Gft output tbblfs
    if (!Rfbd8bitTbblfs(sflf ->ContfxtID, io,  NfwLUT, OutputChbnnfls)) goto Error;

    *nItfms = 1;
    rfturn NfwLUT;

Error:
    if (NfwLUT != NULL) dmsPipflinfFrff(NfwLUT);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

// Wf only bllow b spfdifid MPE strudturf: Mbtrix plus prflin, plus dlut, plus post-lin.
stbtid
dmsBool  Typf_LUT8_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt32Numbfr j, nTbbSizf;
    dmsUInt8Numbfr  vbl;
    dmsPipflinf* NfwLUT = (dmsPipflinf*) Ptr;
    dmsStbgf* mpf;
    _dmsStbgfTonfCurvfsDbtb* PrfMPE = NULL, *PostMPE = NULL;
    _dmsStbgfMbtrixDbtb* MbtMPE = NULL;
    _dmsStbgfCLutDbtb* dlut = NULL;
    int dlutPoints;

    // Disbssfmblf thf LUT into domponfnts.
    mpf = NfwLUT -> Elfmfnts;
    if (mpf ->Typf == dmsSigMbtrixElfmTypf) {

        MbtMPE = (_dmsStbgfMbtrixDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }

    if (mpf != NULL && mpf ->Typf == dmsSigCurvfSftElfmTypf) {
        PrfMPE = (_dmsStbgfTonfCurvfsDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }

    if (mpf != NULL && mpf ->Typf == dmsSigCLutElfmTypf) {
        dlut  = (_dmsStbgfCLutDbtb*) mpf -> Dbtb;
        mpf = mpf ->Nfxt;
    }

    if (mpf != NULL && mpf ->Typf == dmsSigCurvfSftElfmTypf) {
        PostMPE = (_dmsStbgfTonfCurvfsDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }

    // Thbt should bf bll
    if (mpf != NULL) {
        dmsSignblError(mpf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "LUT is not suitbblf to bf sbvfd bs LUT8");
        rfturn FALSE;
    }


    if (dlut == NULL)
        dlutPoints = 0;
    flsf
        dlutPoints    = dlut->Pbrbms->nSbmplfs[0];

    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) NfwLUT ->InputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) NfwLUT ->OutputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) dlutPoints)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, 0)) rfturn FALSE; // Pbdding


    if (MbtMPE != NULL) {

        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[0])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[1])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[2])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[3])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[4])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[5])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[6])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[7])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[8])) rfturn FALSE;

    }
    flsf {

        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
    }

    // Thf prflinfbrizbtion tbblf
    if (!Writf8bitTbblfs(sflf ->ContfxtID, io, NfwLUT ->InputChbnnfls, PrfMPE)) rfturn FALSE;

    nTbbSizf = uipow(NfwLUT->OutputChbnnfls, dlutPoints, NfwLUT ->InputChbnnfls);
    if (nTbbSizf == (dmsUInt32Numbfr) -1) rfturn FALSE;
    if (nTbbSizf > 0) {

        // Thf 3D CLUT.
        if (dlut != NULL) {

            for (j=0; j < nTbbSizf; j++) {

                vbl = (dmsUInt8Numbfr) FROM_16_TO_8(dlut ->Tbb.T[j]);
                if (!_dmsWritfUInt8Numbfr(io, vbl)) rfturn FALSE;
            }
        }
    }

    // Thf postlinfbrizbtion tbblf
    if (!Writf8bitTbblfs(sflf ->ContfxtID, io, NfwLUT ->OutputChbnnfls, PostMPE)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_LUT8_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsPipflinfDup((dmsPipflinf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_LUT8_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsPipflinfFrff((dmsPipflinf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}

// ********************************************************************************
// Typf dmsSigLut16Typf
// ********************************************************************************

// Rfbd 16 bit tbblfs bs gbmmb fundtions
stbtid
dmsBool  Rfbd16bitTbblfs(dmsContfxt ContfxtID, dmsIOHANDLER* io, dmsPipflinf* lut, int nChbnnfls, int nEntrifs)
{
    int i;
    dmsTonfCurvf* Tbblfs[dmsMAXCHANNELS];

    // Mbybf bn fmpty tbblf? (this is b ldms fxtfnsion)
    if (nEntrifs <= 0) rfturn TRUE;

    // Chfdk for mblidious profilfs
    if (nEntrifs < 2) rfturn FALSE;
    if (nChbnnfls > dmsMAXCHANNELS) rfturn FALSE;

    // Init tbblf to zfro
    mfmsft(Tbblfs, 0, sizfof(Tbblfs));

    for (i=0; i < nChbnnfls; i++) {

        Tbblfs[i] = dmsBuildTbbulbtfdTonfCurvf16(ContfxtID, nEntrifs, NULL);
        if (Tbblfs[i] == NULL) goto Error;

        if (!_dmsRfbdUInt16Arrby(io, nEntrifs, Tbblfs[i]->Tbblf16)) goto Error;
    }


    // Add thf tbblf (whidh mby dfrtbinly bf bn idfntity, but this is up to thf optimizfr, not thf rfbding dodf)
    if (!dmsPipflinfInsfrtStbgf(lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, nChbnnfls, Tbblfs)))
        goto Error;

    for (i=0; i < nChbnnfls; i++)
        dmsFrffTonfCurvf(Tbblfs[i]);

    rfturn TRUE;

Error:
    for (i=0; i < nChbnnfls; i++) {
        if (Tbblfs[i]) dmsFrffTonfCurvf(Tbblfs[i]);
    }

    rfturn FALSE;
}

stbtid
dmsBool Writf16bitTbblfs(dmsContfxt ContfxtID, dmsIOHANDLER* io, _dmsStbgfTonfCurvfsDbtb* Tbblfs)
{
    int j;
    dmsUInt32Numbfr i;
    dmsUInt16Numbfr vbl;
    int nEntrifs;

    _dmsAssfrt(Tbblfs != NULL);

    nEntrifs = Tbblfs->ThfCurvfs[0]->nEntrifs;

    for (i=0; i < Tbblfs ->nCurvfs; i++) {

        for (j=0; j < nEntrifs; j++) {

            vbl = Tbblfs->ThfCurvfs[i]->Tbblf16[j];
            if (!_dmsWritfUInt16Numbfr(io, vbl)) rfturn FALSE;
        }
    }
    rfturn TRUE;

    dmsUNUSED_PARAMETER(ContfxtID);
}

stbtid
void *Typf_LUT16_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt8Numbfr InputChbnnfls, OutputChbnnfls, CLUTpoints;
    dmsPipflinf* NfwLUT = NULL;
    dmsUInt32Numbfr nTbbSizf;
    dmsFlobt64Numbfr Mbtrix[3*3];
    dmsUInt16Numbfr InputEntrifs, OutputEntrifs;

    *nItfms = 0;

    if (!_dmsRfbdUInt8Numbfr(io, &InputChbnnfls)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, &OutputChbnnfls)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, &CLUTpoints)) rfturn NULL;   // 255 mbximum

    // Pbdding
    if (!_dmsRfbdUInt8Numbfr(io, NULL)) rfturn NULL;

    // Do somf dhfdking
    if (InputChbnnfls > dmsMAXCHANNELS)  goto Error;
    if (OutputChbnnfls > dmsMAXCHANNELS) goto Error;

    // Allodbtfs bn fmpty LUT
    NfwLUT = dmsPipflinfAllod(sflf ->ContfxtID, InputChbnnfls, OutputChbnnfls);
    if (NfwLUT == NULL) goto Error;

    // Rfbd thf Mbtrix
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[0])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[1])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[2])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[3])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[4])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[5])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[6])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[7])) goto Error;
    if (!_dmsRfbd15Fixfd16Numbfr(io,  &Mbtrix[8])) goto Error;


    // Only opfrbtfs on 3 dhbnnfls
    if ((InputChbnnfls == 3) && !_dmsMAT3isIdfntity((dmsMAT3*) Mbtrix)) {

        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, dmsStbgfAllodMbtrix(sflf ->ContfxtID, 3, 3, Mbtrix, NULL)))
            goto Error;
    }

    if (!_dmsRfbdUInt16Numbfr(io, &InputEntrifs)) goto Error;
    if (!_dmsRfbdUInt16Numbfr(io, &OutputEntrifs)) goto Error;

    if (InputEntrifs > 0x7FFF || OutputEntrifs > 0x7FFF) goto Error;
    if (CLUTpoints == 1) goto Error; // Impossiblf vbluf, 0 for no CLUT bnd thfn 2 bt lfbst

    // Gft input tbblfs
    if (!Rfbd16bitTbblfs(sflf ->ContfxtID, io,  NfwLUT, InputChbnnfls, InputEntrifs)) goto Error;

    // Gft 3D CLUT
    nTbbSizf = uipow(OutputChbnnfls, CLUTpoints, InputChbnnfls);
    if (nTbbSizf == (dmsUInt32Numbfr) -1) goto Error;
    if (nTbbSizf > 0) {

        dmsUInt16Numbfr *T;

        T  = (dmsUInt16Numbfr*) _dmsCbllod(sflf ->ContfxtID, nTbbSizf, sizfof(dmsUInt16Numbfr));
        if (T  == NULL) goto Error;

        if (!_dmsRfbdUInt16Arrby(io, nTbbSizf, T)) {
            _dmsFrff(sflf ->ContfxtID, T);
            goto Error;
        }

        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, dmsStbgfAllodCLut16bit(sflf ->ContfxtID, CLUTpoints, InputChbnnfls, OutputChbnnfls, T))) {
            _dmsFrff(sflf ->ContfxtID, T);
            goto Error;
        }
        _dmsFrff(sflf ->ContfxtID, T);
    }


    // Gft output tbblfs
    if (!Rfbd16bitTbblfs(sflf ->ContfxtID, io,  NfwLUT, OutputChbnnfls, OutputEntrifs)) goto Error;

    *nItfms = 1;
    rfturn NfwLUT;

Error:
    if (NfwLUT != NULL) dmsPipflinfFrff(NfwLUT);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

// Wf only bllow somf spfdifid MPE strudturfs: Mbtrix plus prflin, plus dlut, plus post-lin.
// Somf fmpty dffbults brf drfbtfd for missing pbrts

stbtid
dmsBool  Typf_LUT16_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt32Numbfr nTbbSizf;
    dmsPipflinf* NfwLUT = (dmsPipflinf*) Ptr;
    dmsStbgf* mpf;
    _dmsStbgfTonfCurvfsDbtb* PrfMPE = NULL, *PostMPE = NULL;
    _dmsStbgfMbtrixDbtb* MbtMPE = NULL;
    _dmsStbgfCLutDbtb* dlut = NULL;
    int i, InputChbnnfls, OutputChbnnfls, dlutPoints;

    // Disbssfmblf thf LUT into domponfnts.
    mpf = NfwLUT -> Elfmfnts;
    if (mpf != NULL && mpf ->Typf == dmsSigMbtrixElfmTypf) {

        MbtMPE = (_dmsStbgfMbtrixDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }


    if (mpf != NULL && mpf ->Typf == dmsSigCurvfSftElfmTypf) {
        PrfMPE = (_dmsStbgfTonfCurvfsDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }

    if (mpf != NULL && mpf ->Typf == dmsSigCLutElfmTypf) {
        dlut  = (_dmsStbgfCLutDbtb*) mpf -> Dbtb;
        mpf = mpf ->Nfxt;
    }

    if (mpf != NULL && mpf ->Typf == dmsSigCurvfSftElfmTypf) {
        PostMPE = (_dmsStbgfTonfCurvfsDbtb*) mpf ->Dbtb;
        mpf = mpf -> Nfxt;
    }

    // Thbt should bf bll
    if (mpf != NULL) {
        dmsSignblError(mpf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "LUT is not suitbblf to bf sbvfd bs LUT16");
        rfturn FALSE;
    }

    InputChbnnfls  = dmsPipflinfInputChbnnfls(NfwLUT);
    OutputChbnnfls = dmsPipflinfOutputChbnnfls(NfwLUT);

    if (dlut == NULL)
        dlutPoints = 0;
    flsf
        dlutPoints    = dlut->Pbrbms->nSbmplfs[0];

    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) InputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) OutputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) dlutPoints)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, 0)) rfturn FALSE; // Pbdding


    if (MbtMPE != NULL) {

        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[0])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[1])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[2])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[3])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[4])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[5])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[6])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[7])) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, MbtMPE -> Doublf[8])) rfturn FALSE;
    }
    flsf {

        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 1)) rfturn FALSE;
    }


    if (PrfMPE != NULL) {
        if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) PrfMPE ->ThfCurvfs[0]->nEntrifs)) rfturn FALSE;
    } flsf {
            if (!_dmsWritfUInt16Numbfr(io, 2)) rfturn FALSE;
    }

    if (PostMPE != NULL) {
        if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) PostMPE ->ThfCurvfs[0]->nEntrifs)) rfturn FALSE;
    } flsf {
        if (!_dmsWritfUInt16Numbfr(io, 2)) rfturn FALSE;

    }

    // Thf prflinfbrizbtion tbblf

    if (PrfMPE != NULL) {
        if (!Writf16bitTbblfs(sflf ->ContfxtID, io, PrfMPE)) rfturn FALSE;
    }
    flsf {
        for (i=0; i < InputChbnnfls; i++) {

            if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;
            if (!_dmsWritfUInt16Numbfr(io, 0xffff)) rfturn FALSE;
        }
    }

    nTbbSizf = uipow(OutputChbnnfls, dlutPoints, InputChbnnfls);
    if (nTbbSizf == (dmsUInt32Numbfr) -1) rfturn FALSE;
    if (nTbbSizf > 0) {
        // Thf 3D CLUT.
        if (dlut != NULL) {
            if (!_dmsWritfUInt16Arrby(io, nTbbSizf, dlut->Tbb.T)) rfturn FALSE;
        }
    }

    // Thf postlinfbrizbtion tbblf
    if (PostMPE != NULL) {
        if (!Writf16bitTbblfs(sflf ->ContfxtID, io, PostMPE)) rfturn FALSE;
    }
    flsf {
        for (i=0; i < OutputChbnnfls; i++) {

            if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;
            if (!_dmsWritfUInt16Numbfr(io, 0xffff)) rfturn FALSE;
        }
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_LUT16_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsPipflinfDup((dmsPipflinf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_LUT16_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsPipflinfFrff((dmsPipflinf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigLutAToBTypf
// ********************************************************************************


// V4 stuff. Rfbd mbtrix for LutAtoB bnd LutBtoA

stbtid
dmsStbgf* RfbdMbtrix(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr Offsft)
{
    dmsFlobt64Numbfr dMbt[3*3];
    dmsFlobt64Numbfr dOff[3];
    dmsStbgf* Mbt;

    // Go to bddrfss
    if (!io -> Sffk(io, Offsft)) rfturn NULL;

    // Rfbd thf Mbtrix
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[0])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[1])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[2])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[3])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[4])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[5])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[6])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[7])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dMbt[8])) rfturn NULL;

    if (!_dmsRfbd15Fixfd16Numbfr(io, &dOff[0])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dOff[1])) rfturn NULL;
    if (!_dmsRfbd15Fixfd16Numbfr(io, &dOff[2])) rfturn NULL;

    Mbt = dmsStbgfAllodMbtrix(sflf ->ContfxtID, 3, 3, dMbt, dOff);

     rfturn Mbt;
}




//  V4 stuff. Rfbd CLUT pbrt for LutAtoB bnd LutBtoA

stbtid
dmsStbgf* RfbdCLUT(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr Offsft, int InputChbnnfls, int OutputChbnnfls)
{
    dmsUInt8Numbfr  gridPoints8[dmsMAXCHANNELS]; // Numbfr of grid points in fbdh dimfnsion.
    dmsUInt32Numbfr GridPoints[dmsMAXCHANNELS], i;
    dmsUInt8Numbfr  Prfdision;
    dmsStbgf* CLUT;
    _dmsStbgfCLutDbtb* Dbtb;

    if (!io -> Sffk(io, Offsft)) rfturn NULL;
    if (io -> Rfbd(io, gridPoints8, dmsMAXCHANNELS, 1) != 1) rfturn NULL;


    for (i=0; i < dmsMAXCHANNELS; i++) {

        if (gridPoints8[i] == 1) rfturn NULL; // Impossiblf vbluf, 0 for no CLUT bnd thfn 2 bt lfbst
        GridPoints[i] = gridPoints8[i];
    }

    if (!_dmsRfbdUInt8Numbfr(io, &Prfdision)) rfturn NULL;

    if (!_dmsRfbdUInt8Numbfr(io, NULL)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, NULL)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, NULL)) rfturn NULL;

    CLUT = dmsStbgfAllodCLut16bitGrbnulbr(sflf ->ContfxtID, GridPoints, InputChbnnfls, OutputChbnnfls, NULL);
    if (CLUT == NULL) rfturn NULL;

    Dbtb = (_dmsStbgfCLutDbtb*) CLUT ->Dbtb;

    // Prfdision dbn bf 1 or 2 bytfs
    if (Prfdision == 1) {

       dmsUInt8Numbfr  v;

        for (i=0; i < Dbtb ->nEntrifs; i++) {

                if (io ->Rfbd(io, &v, sizfof(dmsUInt8Numbfr), 1) != 1) rfturn NULL;
                Dbtb ->Tbb.T[i] = FROM_8_TO_16(v);
        }

    }
    flsf
        if (Prfdision == 2) {

            if (!_dmsRfbdUInt16Arrby(io, Dbtb->nEntrifs, Dbtb ->Tbb.T)) rfturn NULL;
    }
    flsf {
        dmsSignblError(sflf ->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown prfdision of '%d'", Prfdision);
        rfturn NULL;
    }


    rfturn CLUT;
}

stbtid
dmsTonfCurvf* RfbdEmbfddfdCurvf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io)
{
    dmsTbgTypfSignbturf  BbsfTypf;
    dmsUInt32Numbfr nItfms;

    BbsfTypf = _dmsRfbdTypfBbsf(io);
    switdh (BbsfTypf) {

            dbsf dmsSigCurvfTypf:
                rfturn (dmsTonfCurvf*) Typf_Curvf_Rfbd(sflf, io, &nItfms, 0);

            dbsf dmsSigPbrbmftridCurvfTypf:
                rfturn (dmsTonfCurvf*) Typf_PbrbmftridCurvf_Rfbd(sflf, io, &nItfms, 0);

            dffbult:
                {
                    dhbr String[5];

                    _dmsTbgSignbturf2String(String, (dmsTbgSignbturf) BbsfTypf);
                    dmsSignblError(sflf ->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown durvf typf '%s'", String);
                }
                rfturn NULL;
    }
}


// Rfbd b sft of durvfs from spfdifid offsft
stbtid
dmsStbgf* RfbdSftOfCurvfs(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr Offsft, dmsUInt32Numbfr nCurvfs)
{
    dmsTonfCurvf* Curvfs[dmsMAXCHANNELS];
    dmsUInt32Numbfr i;
    dmsStbgf* Lin = NULL;

    if (nCurvfs > dmsMAXCHANNELS) rfturn FALSE;

    if (!io -> Sffk(io, Offsft)) rfturn FALSE;

    for (i=0; i < nCurvfs; i++)
        Curvfs[i] = NULL;

    for (i=0; i < nCurvfs; i++) {

        Curvfs[i] = RfbdEmbfddfdCurvf(sflf, io);
        if (Curvfs[i] == NULL) goto Error;
        if (!_dmsRfbdAlignmfnt(io)) goto Error;

    }

    Lin = dmsStbgfAllodTonfCurvfs(sflf ->ContfxtID, nCurvfs, Curvfs);

Error:
    for (i=0; i < nCurvfs; i++)
        dmsFrffTonfCurvf(Curvfs[i]);

    rfturn Lin;
}


// LutAtoB typf

// This strudturf rfprfsfnts b dolour trbnsform. Thf typf dontbins up to fivf prodfssing
// flfmfnts whidh brf storfd in thf AtoBTbg tbg in thf following ordfr: b sft of onf
// dimfnsionbl durvfs, b 3 by 3 mbtrix with offsft tfrms, b sft of onf dimfnsionbl durvfs,
// b multidimfnsionbl lookup tbblf, bnd b sft of onf dimfnsionbl output durvfs.
// Dbtb brf prodfssfd using thfsf flfmfnts vib thf following sfqufndf:
//
//("A" durvfs) -> (multidimfnsionbl lookup tbblf - CLUT) -> ("M" durvfs) -> (mbtrix) -> ("B" durvfs).
//
/*
It is possiblf to usf bny or bll of thfsf prodfssing flfmfnts. At lfbst onf prodfssing flfmfnt
must bf indludfd.Only thf following dombinbtions brf bllowfd:

B
M - Mbtrix - B
A - CLUT - B
A - CLUT - M - Mbtrix - B

*/

stbtid
void* Typf_LUTA2B_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt32Numbfr      BbsfOffsft;
    dmsUInt8Numbfr       inputChbn;      // Numbfr of input dhbnnfls
    dmsUInt8Numbfr       outputChbn;     // Numbfr of output dhbnnfls
    dmsUInt32Numbfr      offsftB;        // Offsft to first "B" durvf
    dmsUInt32Numbfr      offsftMbt;      // Offsft to mbtrix
    dmsUInt32Numbfr      offsftM;        // Offsft to first "M" durvf
    dmsUInt32Numbfr      offsftC;        // Offsft to CLUT
    dmsUInt32Numbfr      offsftA;        // Offsft to first "A" durvf
    dmsPipflinf* NfwLUT = NULL;


    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    if (!_dmsRfbdUInt8Numbfr(io, &inputChbn)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, &outputChbn)) rfturn NULL;

    if (!_dmsRfbdUInt16Numbfr(io, NULL)) rfturn NULL;

    if (!_dmsRfbdUInt32Numbfr(io, &offsftB)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftMbt)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftM)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftC)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftA)) rfturn NULL;

   // Allodbtfs bn fmpty LUT
    NfwLUT = dmsPipflinfAllod(sflf ->ContfxtID, inputChbn, outputChbn);
    if (NfwLUT == NULL) rfturn NULL;

    if (offsftA!= 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftA, inputChbn)))
            goto Error;
    }

    if (offsftC != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdCLUT(sflf, io, BbsfOffsft + offsftC, inputChbn, outputChbn)))
            goto Error;
    }

    if (offsftM != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftM, outputChbn)))
            goto Error;
    }

    if (offsftMbt != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdMbtrix(sflf, io, BbsfOffsft + offsftMbt)))
            goto Error;
    }

    if (offsftB != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftB, outputChbn)))
            goto Error;
    }

    *nItfms = 1;
    rfturn NfwLUT;
Error:
    dmsPipflinfFrff(NfwLUT);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

// Writf b sft of durvfs
stbtid
dmsBool  WritfMbtrix(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsStbgf* mpf)
{
    _dmsStbgfMbtrixDbtb* m = (_dmsStbgfMbtrixDbtb*) mpf -> Dbtb;

    // Writf thf Mbtrix
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[0])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[1])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[2])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[3])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[4])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[5])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[6])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[7])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Doublf[8])) rfturn FALSE;

    if (m ->Offsft != NULL) {

    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Offsft[0])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Offsft[1])) rfturn FALSE;
    if (!_dmsWritf15Fixfd16Numbfr(io, m -> Offsft[2])) rfturn FALSE;
    }
    flsf {
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, 0)) rfturn FALSE;

    }


    rfturn TRUE;

    dmsUNUSED_PARAMETER(sflf);
}


// Writf b sft of durvfs
stbtid
dmsBool WritfSftOfCurvfs(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsTbgTypfSignbturf Typf, dmsStbgf* mpf)
{
    dmsUInt32Numbfr i, n;
    dmsTbgTypfSignbturf CurrfntTypf;
    dmsTonfCurvf** Curvfs;


    n      = dmsStbgfOutputChbnnfls(mpf);
    Curvfs = _dmsStbgfGftPtrToCurvfSft(mpf);

    for (i=0; i < n; i++) {

        // If this is b tbblf-bbsfd durvf, usf durvf typf fvfn on V4
        CurrfntTypf = Typf;

        if ((Curvfs[i] ->nSfgmfnts == 0)||
            ((Curvfs[i]->nSfgmfnts == 2) && (Curvfs[i] ->Sfgmfnts[1].Typf == 0)) )
            CurrfntTypf = dmsSigCurvfTypf;
        flsf
        if (Curvfs[i] ->Sfgmfnts[0].Typf < 0)
            CurrfntTypf = dmsSigCurvfTypf;

        if (!_dmsWritfTypfBbsf(io, CurrfntTypf)) rfturn FALSE;

        switdh (CurrfntTypf) {

            dbsf dmsSigCurvfTypf:
                if (!Typf_Curvf_Writf(sflf, io, Curvfs[i], 1)) rfturn FALSE;
                brfbk;

            dbsf dmsSigPbrbmftridCurvfTypf:
                if (!Typf_PbrbmftridCurvf_Writf(sflf, io, Curvfs[i], 1)) rfturn FALSE;
                brfbk;

            dffbult:
                {
                    dhbr String[5];

                    _dmsTbgSignbturf2String(String, (dmsTbgSignbturf) Typf);
                    dmsSignblError(sflf ->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown durvf typf '%s'", String);
                }
                rfturn FALSE;
        }

        if (!_dmsWritfAlignmfnt(io)) rfturn FALSE;
    }


    rfturn TRUE;
}


stbtid
dmsBool WritfCLUT(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt8Numbfr  Prfdision, dmsStbgf* mpf)
{
    dmsUInt8Numbfr  gridPoints[dmsMAXCHANNELS]; // Numbfr of grid points in fbdh dimfnsion.
    dmsUInt32Numbfr i;
    _dmsStbgfCLutDbtb* CLUT = ( _dmsStbgfCLutDbtb*) mpf -> Dbtb;

    if (CLUT ->HbsFlobtVblufs) {
         dmsSignblError(sflf ->ContfxtID, dmsERROR_NOT_SUITABLE, "Cbnnot sbvf flobting point dbtb, CLUT brf 8 or 16 bit only");
         rfturn FALSE;
    }

    mfmsft(gridPoints, 0, sizfof(gridPoints));
    for (i=0; i < (dmsUInt32Numbfr) CLUT ->Pbrbms ->nInputs; i++)
        gridPoints[i] = (dmsUInt8Numbfr) CLUT ->Pbrbms ->nSbmplfs[i];

    if (!io -> Writf(io, dmsMAXCHANNELS*sizfof(dmsUInt8Numbfr), gridPoints)) rfturn FALSE;

    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) Prfdision)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, 0)) rfturn FALSE;

    // Prfdision dbn bf 1 or 2 bytfs
    if (Prfdision == 1) {

        for (i=0; i < CLUT->nEntrifs; i++) {

            if (!_dmsWritfUInt8Numbfr(io, FROM_16_TO_8(CLUT->Tbb.T[i]))) rfturn FALSE;
        }
    }
    flsf
        if (Prfdision == 2) {

            if (!_dmsWritfUInt16Arrby(io, CLUT->nEntrifs, CLUT ->Tbb.T)) rfturn FALSE;
        }
        flsf {
             dmsSignblError(sflf ->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown prfdision of '%d'", Prfdision);
            rfturn FALSE;
        }

        if (!_dmsWritfAlignmfnt(io)) rfturn FALSE;

        rfturn TRUE;
}




stbtid
dmsBool Typf_LUTA2B_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsPipflinf* Lut = (dmsPipflinf*) Ptr;
    int inputChbn, outputChbn;
    dmsStbgf *A = NULL, *B = NULL, *M = NULL;
    dmsStbgf * Mbtrix = NULL;
    dmsStbgf * CLUT = NULL;
    dmsUInt32Numbfr offsftB = 0, offsftMbt = 0, offsftM = 0, offsftC = 0, offsftA = 0;
    dmsUInt32Numbfr BbsfOffsft, DirfdtoryPos, CurrfntPos;

    // Gft thf bbsf for bll offsfts
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    if (Lut ->Elfmfnts != NULL)
        if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 1, dmsSigCurvfSftElfmTypf, &B))
            if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 3, dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf, &M, &Mbtrix, &B))
                if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 3, dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf, &A, &CLUT, &B))
                    if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 5, dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf,
                        dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf, &A, &CLUT, &M, &Mbtrix, &B)) {

                            dmsSignblError(sflf->ContfxtID, dmsERROR_NOT_SUITABLE, "LUT is not suitbblf to bf sbvfd bs LutAToB");
                            rfturn FALSE;
                    }

    // Gft input, output dhbnnfls
    inputChbn  = dmsPipflinfInputChbnnfls(Lut);
    outputChbn = dmsPipflinfOutputChbnnfls(Lut);

    // Writf dhbnnfl dount
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) inputChbn)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) outputChbn)) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;

    // Kffp dirfdtory to bf fillfd lbttfr
    DirfdtoryPos = io ->Tfll(io);

    // Writf thf dirfdtory
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;

    if (A != NULL) {

        offsftA = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, A)) rfturn FALSE;
    }

    if (CLUT != NULL) {
        offsftC = io ->Tfll(io) - BbsfOffsft;
        if (!WritfCLUT(sflf, io, Lut ->SbvfAs8Bits ? 1 : 2, CLUT)) rfturn FALSE;

    }
    if (M != NULL) {

        offsftM = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, M)) rfturn FALSE;
    }

    if (Mbtrix != NULL) {
        offsftMbt = io ->Tfll(io) - BbsfOffsft;
        if (!WritfMbtrix(sflf, io, Mbtrix)) rfturn FALSE;
    }

    if (B != NULL) {

        offsftB = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, B)) rfturn FALSE;
    }

    CurrfntPos = io ->Tfll(io);

    if (!io ->Sffk(io, DirfdtoryPos)) rfturn FALSE;

    if (!_dmsWritfUInt32Numbfr(io, offsftB)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftMbt)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftM)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftC)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftA)) rfturn FALSE;

    if (!io ->Sffk(io, CurrfntPos)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_LUTA2B_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsPipflinfDup((dmsPipflinf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_LUTA2B_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsPipflinfFrff((dmsPipflinf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// LutBToA typf

stbtid
void* Typf_LUTB2A_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt8Numbfr       inputChbn;      // Numbfr of input dhbnnfls
    dmsUInt8Numbfr       outputChbn;     // Numbfr of output dhbnnfls
    dmsUInt32Numbfr      BbsfOffsft;     // Adtubl position in filf
    dmsUInt32Numbfr      offsftB;        // Offsft to first "B" durvf
    dmsUInt32Numbfr      offsftMbt;      // Offsft to mbtrix
    dmsUInt32Numbfr      offsftM;        // Offsft to first "M" durvf
    dmsUInt32Numbfr      offsftC;        // Offsft to CLUT
    dmsUInt32Numbfr      offsftA;        // Offsft to first "A" durvf
    dmsPipflinf* NfwLUT = NULL;


    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    if (!_dmsRfbdUInt8Numbfr(io, &inputChbn)) rfturn NULL;
    if (!_dmsRfbdUInt8Numbfr(io, &outputChbn)) rfturn NULL;

    // Pbdding
    if (!_dmsRfbdUInt16Numbfr(io, NULL)) rfturn NULL;

    if (!_dmsRfbdUInt32Numbfr(io, &offsftB)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftMbt)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftM)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftC)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &offsftA)) rfturn NULL;

    // Allodbtfs bn fmpty LUT
    NfwLUT = dmsPipflinfAllod(sflf ->ContfxtID, inputChbn, outputChbn);
    if (NfwLUT == NULL) rfturn NULL;

    if (offsftB != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftB, inputChbn)))
            goto Error;
    }

    if (offsftMbt != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdMbtrix(sflf, io, BbsfOffsft + offsftMbt)))
            goto Error;
    }

    if (offsftM != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftM, inputChbn)))
            goto Error;
    }

    if (offsftC != 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdCLUT(sflf, io, BbsfOffsft + offsftC, inputChbn, outputChbn)))
            goto Error;
    }

    if (offsftA!= 0) {
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, RfbdSftOfCurvfs(sflf, io, BbsfOffsft + offsftA, outputChbn)))
            goto Error;
    }

    *nItfms = 1;
    rfturn NfwLUT;
Error:
    dmsPipflinfFrff(NfwLUT);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


/*
B
B - Mbtrix - M
B - CLUT - A
B - Mbtrix - M - CLUT - A
*/

stbtid
dmsBool  Typf_LUTB2A_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsPipflinf* Lut = (dmsPipflinf*) Ptr;
    int inputChbn, outputChbn;
    dmsStbgf *A = NULL, *B = NULL, *M = NULL;
    dmsStbgf *Mbtrix = NULL;
    dmsStbgf *CLUT = NULL;
    dmsUInt32Numbfr offsftB = 0, offsftMbt = 0, offsftM = 0, offsftC = 0, offsftA = 0;
    dmsUInt32Numbfr BbsfOffsft, DirfdtoryPos, CurrfntPos;


    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 1, dmsSigCurvfSftElfmTypf, &B))
        if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 3, dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf, &B, &Mbtrix, &M))
            if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 3, dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf, &B, &CLUT, &A))
                if (!dmsPipflinfChfdkAndRftrfivfStbgfs(Lut, 5, dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf,
                    dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf, &B, &Mbtrix, &M, &CLUT, &A)) {
                        dmsSignblError(sflf->ContfxtID, dmsERROR_NOT_SUITABLE, "LUT is not suitbblf to bf sbvfd bs LutBToA");
                        rfturn FALSE;
                }

    inputChbn  = dmsPipflinfInputChbnnfls(Lut);
    outputChbn = dmsPipflinfOutputChbnnfls(Lut);

    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) inputChbn)) rfturn FALSE;
    if (!_dmsWritfUInt8Numbfr(io, (dmsUInt8Numbfr) outputChbn)) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, 0)) rfturn FALSE;

    DirfdtoryPos = io ->Tfll(io);

    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;

    if (A != NULL) {

        offsftA = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, A)) rfturn FALSE;
    }

    if (CLUT != NULL) {
        offsftC = io ->Tfll(io) - BbsfOffsft;
        if (!WritfCLUT(sflf, io, Lut ->SbvfAs8Bits ? 1 : 2, CLUT)) rfturn FALSE;

    }
    if (M != NULL) {

        offsftM = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, M)) rfturn FALSE;
    }

    if (Mbtrix != NULL) {
        offsftMbt = io ->Tfll(io) - BbsfOffsft;
        if (!WritfMbtrix(sflf, io, Mbtrix)) rfturn FALSE;
    }

    if (B != NULL) {

        offsftB = io ->Tfll(io) - BbsfOffsft;
        if (!WritfSftOfCurvfs(sflf, io, dmsSigPbrbmftridCurvfTypf, B)) rfturn FALSE;
    }

    CurrfntPos = io ->Tfll(io);

    if (!io ->Sffk(io, DirfdtoryPos)) rfturn FALSE;

    if (!_dmsWritfUInt32Numbfr(io, offsftB)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftMbt)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftM)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftC)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, offsftA)) rfturn FALSE;

    if (!io ->Sffk(io, CurrfntPos)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}



stbtid
void* Typf_LUTB2A_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsPipflinfDup((dmsPipflinf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_LUTB2A_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsPipflinfFrff((dmsPipflinf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}



// ********************************************************************************
// Typf dmsSigColorbntTbblfTypf
// ********************************************************************************
/*
Thf purposf of this tbg is to idfntify thf dolorbnts usfd in thf profilf by b
uniquf nbmf bnd sft of XYZ or L*b*b* vblufs to givf thf dolorbnt bn unbmbiguous
vbluf. Thf first dolorbnt listfd is thf dolorbnt of thf first dfvidf dhbnnfl of
b lut tbg. Thf sfdond dolorbnt listfd is thf dolorbnt of thf sfdond dfvidf dhbnnfl
of b lut tbg, bnd so on.
*/

stbtid
void *Typf_ColorbntTbblf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt32Numbfr i, Count;
    dmsNAMEDCOLORLIST* List;
    dhbr Nbmf[34];
    dmsUInt16Numbfr PCS[3];


    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;

    if (Count > dmsMAXCHANNELS) {
        dmsSignblError(sflf->ContfxtID, dmsERROR_RANGE, "Too mbny dolorbnts '%d'", Count);
        rfturn NULL;
    }

    List = dmsAllodNbmfdColorList(sflf ->ContfxtID, Count, 0, "", "");
    for (i=0; i < Count; i++) {

        if (io ->Rfbd(io, Nbmf, 32, 1) != 1) goto Error;
        Nbmf[33] = 0;

        if (!_dmsRfbdUInt16Arrby(io, 3, PCS)) goto Error;

        if (!dmsAppfndNbmfdColor(List, Nbmf, PCS, NULL)) goto Error;

    }

    *nItfms = 1;
    rfturn List;

Error:
    *nItfms = 0;
    dmsFrffNbmfdColorList(List);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}



// Sbvfs b dolorbnt tbblf. It is using thf nbmfd dolor strudturf for simplidity sbkf
stbtid
dmsBool  Typf_ColorbntTbblf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsNAMEDCOLORLIST* NbmfdColorList = (dmsNAMEDCOLORLIST*) Ptr;
    int i, nColors;

    nColors = dmsNbmfdColorCount(NbmfdColorList);

    if (!_dmsWritfUInt32Numbfr(io, nColors)) rfturn FALSE;

    for (i=0; i < nColors; i++) {

        dhbr root[33];
        dmsUInt16Numbfr PCS[3];

        if (!dmsNbmfdColorInfo(NbmfdColorList, i, root, NULL, NULL, PCS, NULL)) rfturn 0;
        root[32] = 0;

        if (!io ->Writf(io, 32, root)) rfturn FALSE;
        if (!_dmsWritfUInt16Arrby(io, 3, PCS)) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_ColorbntTbblf_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void* Ptr, dmsUInt32Numbfr n)
{
    dmsNAMEDCOLORLIST* nd = (dmsNAMEDCOLORLIST*) Ptr;
    rfturn (void*) dmsDupNbmfdColorList(nd);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void Typf_ColorbntTbblf_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsFrffNbmfdColorList((dmsNAMEDCOLORLIST*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigNbmfdColor2Typf
// ********************************************************************************
//
//Thf nbmfdColor2Typf is b dount vbluf bnd brrby of strudturfs thbt providf dolor
//doordinbtfs for 7-bit ASCII dolor nbmfs. For fbdh nbmfd dolor, b PCS bnd optionbl
//dfvidf rfprfsfntbtion of thf dolor brf givfn. Both rfprfsfntbtions brf 16-bit vblufs.
//Thf dfvidf rfprfsfntbtion dorrfsponds to thf hfbdfr’s “dolor spbdf of dbtb” fifld.
//This rfprfsfntbtion should bf donsistfnt with thf “numbfr of dfvidf domponfnts”
//fifld in thf nbmfdColor2Typf. If this fifld is 0, dfvidf doordinbtfs brf not providfd.
//Thf PCS rfprfsfntbtion dorrfsponds to thf hfbdfr’s PCS fifld. Thf PCS rfprfsfntbtion
//is blwbys providfd. Color nbmfs brf fixfd-lfngth, 32-bytf fiflds indluding null
//tfrminbtion. In ordfr to mbintbin mbximum portbbility, it is strongly rfdommfndfd
//thbt spfdibl dhbrbdtfrs of thf 7-bit ASCII sft not bf usfd.

stbtid
void *Typf_NbmfdColor_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{

    dmsUInt32Numbfr      vfndorFlbg;     // Bottom 16 bits for ICC usf
    dmsUInt32Numbfr      dount;          // Count of nbmfd dolors
    dmsUInt32Numbfr      nDfvidfCoords;  // Num of dfvidf doordinbtfs
    dhbr                 prffix[32];     // Prffix for fbdh dolor nbmf
    dhbr                 suffix[32];     // Suffix for fbdh dolor nbmf
    dmsNAMEDCOLORLIST*  v;
    dmsUInt32Numbfr i;


    *nItfms = 0;
    if (!_dmsRfbdUInt32Numbfr(io, &vfndorFlbg)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &dount)) rfturn NULL;
    if (!_dmsRfbdUInt32Numbfr(io, &nDfvidfCoords)) rfturn NULL;

    if (io -> Rfbd(io, prffix, 32, 1) != 1) rfturn NULL;
    if (io -> Rfbd(io, suffix, 32, 1) != 1) rfturn NULL;

    prffix[31] = suffix[31] = 0;

    v = dmsAllodNbmfdColorList(sflf ->ContfxtID, dount, nDfvidfCoords, prffix, suffix);
    if (v == NULL) {
        dmsSignblError(sflf->ContfxtID, dmsERROR_RANGE, "Too mbny nbmfd dolors '%d'", dount);
        rfturn NULL;
    }

    if (nDfvidfCoords > dmsMAXCHANNELS) {
        dmsSignblError(sflf->ContfxtID, dmsERROR_RANGE, "Too mbny dfvidf doordinbtfs '%d'", nDfvidfCoords);
        rfturn 0;
    }
    for (i=0; i < dount; i++) {

        dmsUInt16Numbfr PCS[3];
        dmsUInt16Numbfr Colorbnt[dmsMAXCHANNELS];
        dhbr Root[33];

        mfmsft(Colorbnt, 0, sizfof(Colorbnt));
        if (io -> Rfbd(io, Root, 32, 1) != 1) rfturn NULL;
        if (!_dmsRfbdUInt16Arrby(io, 3, PCS)) goto Error;
        if (!_dmsRfbdUInt16Arrby(io, nDfvidfCoords, Colorbnt)) goto Error;

        if (!dmsAppfndNbmfdColor(v, Root, PCS, Colorbnt)) goto Error;
    }

    *nItfms = 1;
    rfturn (void*) v ;

Error:
    dmsFrffNbmfdColorList(v);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


// Sbvfs b nbmfd dolor list into b nbmfd dolor profilf
stbtid
dmsBool Typf_NbmfdColor_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsNAMEDCOLORLIST* NbmfdColorList = (dmsNAMEDCOLORLIST*) Ptr;
    dhbr                prffix[32];     // Prffix for fbdh dolor nbmf
    dhbr                suffix[32];     // Suffix for fbdh dolor nbmf
    int i, nColors;

    nColors = dmsNbmfdColorCount(NbmfdColorList);

    if (!_dmsWritfUInt32Numbfr(io, 0)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, nColors)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, NbmfdColorList ->ColorbntCount)) rfturn FALSE;

    strndpy(prffix, (donst dhbr*) NbmfdColorList->Prffix, 32);
    strndpy(suffix, (donst dhbr*) NbmfdColorList->Suffix, 32);

    suffix[31] = prffix[31] = 0;

    if (!io ->Writf(io, 32, prffix)) rfturn FALSE;
    if (!io ->Writf(io, 32, suffix)) rfturn FALSE;

    for (i=0; i < nColors; i++) {

       dmsUInt16Numbfr PCS[3];
       dmsUInt16Numbfr Colorbnt[dmsMAXCHANNELS];
       dhbr Root[33];

        if (!dmsNbmfdColorInfo(NbmfdColorList, i, Root, NULL, NULL, PCS, Colorbnt)) rfturn 0;
        if (!io ->Writf(io, 32 , Root)) rfturn FALSE;
        if (!_dmsWritfUInt16Arrby(io, 3, PCS)) rfturn FALSE;
        if (!_dmsWritfUInt16Arrby(io, NbmfdColorList ->ColorbntCount, Colorbnt)) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void* Typf_NbmfdColor_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void* Ptr, dmsUInt32Numbfr n)
{
    dmsNAMEDCOLORLIST* nd = (dmsNAMEDCOLORLIST*) Ptr;

    rfturn (void*) dmsDupNbmfdColorList(nd);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void Typf_NbmfdColor_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsFrffNbmfdColorList((dmsNAMEDCOLORLIST*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigProfilfSfqufndfDfsdTypf
// ********************************************************************************

// This typf is bn brrby of strudturfs, fbdh of whidh dontbins informbtion from thf
// hfbdfr fiflds bnd tbgs from thf originbl profilfs whidh wfrf dombinfd to drfbtf
// thf finbl profilf. Thf ordfr of thf strudturfs is thf ordfr in whidh thf profilfs
// wfrf dombinfd bnd indludfs b strudturf for thf finbl profilf. This providfs b
// dfsdription of thf profilf sfqufndf from sourdf to dfstinbtion,
// typidblly usfd with thf DfvidfLink profilf.

stbtid
dmsBool RfbdEmbfddfdTfxt(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsMLU** mlu, dmsUInt32Numbfr SizfOfTbg)
{
    dmsTbgTypfSignbturf  BbsfTypf;
    dmsUInt32Numbfr nItfms;

    BbsfTypf = _dmsRfbdTypfBbsf(io);

    switdh (BbsfTypf) {

       dbsf dmsSigTfxtTypf:
           if (*mlu) dmsMLUfrff(*mlu);
           *mlu = (dmsMLU*)Typf_Tfxt_Rfbd(sflf, io, &nItfms, SizfOfTbg);
           rfturn (*mlu != NULL);

       dbsf dmsSigTfxtDfsdriptionTypf:
           if (*mlu) dmsMLUfrff(*mlu);
           *mlu =  (dmsMLU*) Typf_Tfxt_Dfsdription_Rfbd(sflf, io, &nItfms, SizfOfTbg);
           rfturn (*mlu != NULL);

           /*
           TBD: Sizf is nffdfd for MLU, bnd wf hbvf no idfb on whidh is thf bvbilbblf sizf
           */

       dbsf dmsSigMultiLodblizfdUnidodfTypf:
           if (*mlu) dmsMLUfrff(*mlu);
           *mlu =  (dmsMLU*) Typf_MLU_Rfbd(sflf, io, &nItfms, SizfOfTbg);
           rfturn (*mlu != NULL);

       dffbult: rfturn FALSE;
    }
}


stbtid
void *Typf_ProfilfSfqufndfDfsd_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsSEQ* OutSfq;
    dmsUInt32Numbfr i, Count;

    *nItfms = 0;

    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;

    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);


    OutSfq = dmsAllodProfilfSfqufndfDfsdription(sflf ->ContfxtID, Count);
    if (OutSfq == NULL) rfturn NULL;

    OutSfq ->n = Count;

    // Gft strudturfs bs wfll

    for (i=0; i < Count; i++) {

        dmsPSEQDESC* sfd = &OutSfq -> sfq[i];

        if (!_dmsRfbdUInt32Numbfr(io, &sfd ->dfvidfMfg)) goto Error;
        if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) goto Error;
        SizfOfTbg -= sizfof(dmsUInt32Numbfr);

        if (!_dmsRfbdUInt32Numbfr(io, &sfd ->dfvidfModfl)) goto Error;
        if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) goto Error;
        SizfOfTbg -= sizfof(dmsUInt32Numbfr);

        if (!_dmsRfbdUInt64Numbfr(io, &sfd ->bttributfs)) goto Error;
        if (SizfOfTbg < sizfof(dmsUInt64Numbfr)) goto Error;
        SizfOfTbg -= sizfof(dmsUInt64Numbfr);

        if (!_dmsRfbdUInt32Numbfr(io, (dmsUInt32Numbfr *)&sfd ->tfdhnology)) goto Error;
        if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) goto Error;
        SizfOfTbg -= sizfof(dmsUInt32Numbfr);

        if (!RfbdEmbfddfdTfxt(sflf, io, &sfd ->Mbnufbdturfr, SizfOfTbg)) goto Error;
        if (!RfbdEmbfddfdTfxt(sflf, io, &sfd ->Modfl, SizfOfTbg)) goto Error;
    }

    *nItfms = 1;
    rfturn OutSfq;

Error:
    dmsFrffProfilfSfqufndfDfsdription(OutSfq);
    rfturn NULL;
}


// Aux--Embfd b tfxt dfsdription typf. It dbn bf of typf tfxt dfsdription or multilodblizfd unidodf
// bnd it dfpfnds of thf vfrsion numbfr pbssfd on dmsTbgDfsdriptor strudturf instfbd of stbdk
stbtid
dmsBool  SbvfDfsdription(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsMLU* Tfxt)
{
    if (sflf ->ICCVfrsion < 0x4000000) {

        if (!_dmsWritfTypfBbsf(io, dmsSigTfxtDfsdriptionTypf)) rfturn FALSE;
        rfturn Typf_Tfxt_Dfsdription_Writf(sflf, io, Tfxt, 1);
    }
    flsf {
        if (!_dmsWritfTypfBbsf(io, dmsSigMultiLodblizfdUnidodfTypf)) rfturn FALSE;
        rfturn Typf_MLU_Writf(sflf, io, Tfxt, 1);
    }
}


stbtid
dmsBool  Typf_ProfilfSfqufndfDfsd_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsSEQ* Sfq = (dmsSEQ*) Ptr;
    dmsUInt32Numbfr i;

    if (!_dmsWritfUInt32Numbfr(io, Sfq->n)) rfturn FALSE;

    for (i=0; i < Sfq ->n; i++) {

        dmsPSEQDESC* sfd = &Sfq -> sfq[i];

        if (!_dmsWritfUInt32Numbfr(io, sfd ->dfvidfMfg)) rfturn FALSE;
        if (!_dmsWritfUInt32Numbfr(io, sfd ->dfvidfModfl)) rfturn FALSE;
        if (!_dmsWritfUInt64Numbfr(io, &sfd ->bttributfs)) rfturn FALSE;
        if (!_dmsWritfUInt32Numbfr(io, sfd ->tfdhnology)) rfturn FALSE;

        if (!SbvfDfsdription(sflf, io, sfd ->Mbnufbdturfr)) rfturn FALSE;
        if (!SbvfDfsdription(sflf, io, sfd ->Modfl)) rfturn FALSE;
    }

     rfturn TRUE;

     dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_ProfilfSfqufndfDfsd_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void* Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsDupProfilfSfqufndfDfsdription((dmsSEQ*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_ProfilfSfqufndfDfsd_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsFrffProfilfSfqufndfDfsdription((dmsSEQ*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigProfilfSfqufndfIdTypf
// ********************************************************************************
/*
In dfrtbin workflows using ICC Dfvidf Link Profilfs, it is nfdfssbry to idfntify thf
originbl profilfs thbt wfrf dombinfd to drfbtf thf Dfvidf Link Profilf.
This typf is bn brrby of strudturfs, fbdh of whidh dontbins informbtion for
idfntifidbtion of b profilf usfd in b sfqufndf
*/


stbtid
dmsBool RfbdSfqID(strudt _dms_typfhbndlfr_strudt* sflf,
                                             dmsIOHANDLER* io,
                                             void* Cbrgo,
                                             dmsUInt32Numbfr n,
                                             dmsUInt32Numbfr SizfOfTbg)
{
    dmsSEQ* OutSfq = (dmsSEQ*) Cbrgo;
    dmsPSEQDESC* sfq = &OutSfq ->sfq[n];

    if (io -> Rfbd(io, sfq ->ProfilfID.ID8, 16, 1) != 1) rfturn FALSE;
    if (!RfbdEmbfddfdTfxt(sflf, io, &sfq ->Dfsdription, SizfOfTbg)) rfturn FALSE;

    rfturn TRUE;
}



stbtid
void *Typf_ProfilfSfqufndfId_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsSEQ* OutSfq;
    dmsUInt32Numbfr Count;
    dmsUInt32Numbfr BbsfOffsft;

    *nItfms = 0;

    // Gft bdtubl position bs b bbsis for flfmfnt offsfts
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // Gft tbblf dount
    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    // Allodbtf bn fmpty strudturf
    OutSfq = dmsAllodProfilfSfqufndfDfsdription(sflf ->ContfxtID, Count);
    if (OutSfq == NULL) rfturn NULL;


    // Rfbd thf position tbblf
    if (!RfbdPositionTbblf(sflf, io, Count, BbsfOffsft, OutSfq, RfbdSfqID)) {

        dmsFrffProfilfSfqufndfDfsdription(OutSfq);
        rfturn NULL;
    }

    // Suddfss
    *nItfms = 1;
    rfturn OutSfq;

}


stbtid
dmsBool WritfSfqID(strudt _dms_typfhbndlfr_strudt* sflf,
                                             dmsIOHANDLER* io,
                                             void* Cbrgo,
                                             dmsUInt32Numbfr n,
                                             dmsUInt32Numbfr SizfOfTbg)
{
    dmsSEQ* Sfq = (dmsSEQ*) Cbrgo;

    if (!io ->Writf(io, 16, Sfq ->sfq[n].ProfilfID.ID8)) rfturn FALSE;

    // Storf hfrf thf MLU
    if (!SbvfDfsdription(sflf, io, Sfq ->sfq[n].Dfsdription)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool  Typf_ProfilfSfqufndfId_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsSEQ* Sfq = (dmsSEQ*) Ptr;
    dmsUInt32Numbfr BbsfOffsft;

    // Kffp thf bbsf offsft
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // This is thf tbblf dount
    if (!_dmsWritfUInt32Numbfr(io, Sfq ->n)) rfturn FALSE;

    // This is thf position tbblf bnd dontfnt
    if (!WritfPositionTbblf(sflf, io, 0, Sfq ->n, BbsfOffsft, Sfq, WritfSfqID)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_ProfilfSfqufndfId_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void* Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsDupProfilfSfqufndfDfsdription((dmsSEQ*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_ProfilfSfqufndfId_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsFrffProfilfSfqufndfDfsdription((dmsSEQ*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigUdrBgTypf
// ********************************************************************************
/*
This typf dontbins durvfs rfprfsfnting thf undfr dolor rfmovbl bnd blbdk
gfnfrbtion bnd b tfxt string whidh is b gfnfrbl dfsdription of thf mfthod usfd
for thf udr/bg.
*/

stbtid
void *Typf_UdrBg_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUdrBg* n = (dmsUdrBg*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsUdrBg));
    dmsUInt32Numbfr CountUdr, CountBg;
    dhbr* ASCIIString;

    *nItfms = 0;
    if (n == NULL) rfturn NULL;

    // First durvf is Undfr dolor rfmovbl
    if (!_dmsRfbdUInt32Numbfr(io, &CountUdr)) rfturn NULL;
    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    n ->Udr = dmsBuildTbbulbtfdTonfCurvf16(sflf ->ContfxtID, CountUdr, NULL);
    if (n ->Udr == NULL) rfturn NULL;

    if (!_dmsRfbdUInt16Arrby(io, CountUdr, n ->Udr->Tbblf16)) rfturn NULL;
    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;
    SizfOfTbg -= CountUdr * sizfof(dmsUInt16Numbfr);

    // Sfdond durvf is Blbdk gfnfrbtion
    if (!_dmsRfbdUInt32Numbfr(io, &CountBg)) rfturn NULL;
    if (SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    n ->Bg = dmsBuildTbbulbtfdTonfCurvf16(sflf ->ContfxtID, CountBg, NULL);
    if (n ->Bg == NULL) rfturn NULL;
    if (!_dmsRfbdUInt16Arrby(io, CountBg, n ->Bg->Tbblf16)) rfturn NULL;
    if (SizfOfTbg < CountBg * sizfof(dmsUInt16Numbfr)) rfturn NULL;
    SizfOfTbg -= CountBg * sizfof(dmsUInt16Numbfr);
    if (SizfOfTbg == UINT_MAX) rfturn NULL;

    // Now domfs thf tfxt. Thf lfngth is spfdififd by thf tbg sizf
    n ->Dfsd = dmsMLUbllod(sflf ->ContfxtID, 1);
    if (n ->Dfsd == NULL) rfturn NULL;

    ASCIIString = (dhbr*) _dmsMbllod(sflf ->ContfxtID, SizfOfTbg + 1);
    if (io ->Rfbd(io, ASCIIString, sizfof(dhbr), SizfOfTbg) != SizfOfTbg) rfturn NULL;
    ASCIIString[SizfOfTbg] = 0;
    dmsMLUsftASCII(n ->Dfsd, dmsNoLbngubgf, dmsNoCountry, ASCIIString);
    _dmsFrff(sflf ->ContfxtID, ASCIIString);

    *nItfms = 1;
    rfturn (void*) n;
}

stbtid
dmsBool  Typf_UdrBg_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUdrBg* Vbluf = (dmsUdrBg*) Ptr;
    dmsUInt32Numbfr TfxtSizf;
    dhbr* Tfxt;

    // First durvf is Undfr dolor rfmovbl
    if (!_dmsWritfUInt32Numbfr(io, Vbluf ->Udr ->nEntrifs)) rfturn FALSE;
    if (!_dmsWritfUInt16Arrby(io, Vbluf ->Udr ->nEntrifs, Vbluf ->Udr ->Tbblf16)) rfturn FALSE;

    // Thfn blbdk gfnfrbtion
    if (!_dmsWritfUInt32Numbfr(io, Vbluf ->Bg ->nEntrifs)) rfturn FALSE;
    if (!_dmsWritfUInt16Arrby(io, Vbluf ->Bg ->nEntrifs, Vbluf ->Bg ->Tbblf16)) rfturn FALSE;

    // Now domfs thf tfxt. Thf lfngth is spfdififd by thf tbg sizf
    TfxtSizf = dmsMLUgftASCII(Vbluf ->Dfsd, dmsNoLbngubgf, dmsNoCountry, NULL, 0);
    Tfxt     = (dhbr*) _dmsMbllod(sflf ->ContfxtID, TfxtSizf);
    if (dmsMLUgftASCII(Vbluf ->Dfsd, dmsNoLbngubgf, dmsNoCountry, Tfxt, TfxtSizf) != TfxtSizf) rfturn FALSE;

    if (!io ->Writf(io, TfxtSizf, Tfxt)) rfturn FALSE;
    _dmsFrff(sflf ->ContfxtID, Tfxt);

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_UdrBg_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    dmsUdrBg* Srd = (dmsUdrBg*) Ptr;
    dmsUdrBg* NfwUdrBg = (dmsUdrBg*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsUdrBg));

    if (NfwUdrBg == NULL) rfturn NULL;

    NfwUdrBg ->Bg   = dmsDupTonfCurvf(Srd ->Bg);
    NfwUdrBg ->Udr  = dmsDupTonfCurvf(Srd ->Udr);
    NfwUdrBg ->Dfsd = dmsMLUdup(Srd ->Dfsd);

    rfturn (void*) NfwUdrBg;

    dmsUNUSED_PARAMETER(n);
}

stbtid
void Typf_UdrBg_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void *Ptr)
{
   dmsUdrBg* Srd = (dmsUdrBg*) Ptr;

   if (Srd ->Udr) dmsFrffTonfCurvf(Srd ->Udr);
   if (Srd ->Bg)  dmsFrffTonfCurvf(Srd ->Bg);
   if (Srd ->Dfsd) dmsMLUfrff(Srd ->Dfsd);

   _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigCrdInfoTypf
// ********************************************************************************

/*
This typf dontbins thf PostSdript produdt nbmf to whidh this profilf dorrfsponds
bnd thf nbmfs of thf dompbnion CRDs. Rfdbll thbt b singlf profilf dbn gfnfrbtf
multiplf CRDs. It is implfmfntfd bs b MLU bfing thf lbngubgf dodf "PS" bnd thfn
dountry vbrifs for fbdh flfmfnt:

                nm: PostSdript produdt nbmf
                #0: Rfndfring intfnt 0 CRD nbmf
                #1: Rfndfring intfnt 1 CRD nbmf
                #2: Rfndfring intfnt 2 CRD nbmf
                #3: Rfndfring intfnt 3 CRD nbmf
*/



// Auxilibr, rfbd bn string spfdififd bs dount + string
stbtid
dmsBool  RfbdCountAndSting(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsMLU* mlu, dmsUInt32Numbfr* SizfOfTbg, donst dhbr* Sfdtion)
{
    dmsUInt32Numbfr Count;
    dhbr* Tfxt;

    if (*SizfOfTbg < sizfof(dmsUInt32Numbfr)) rfturn FALSE;

    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn FALSE;

    if (Count > UINT_MAX - sizfof(dmsUInt32Numbfr)) rfturn FALSE;
    if (*SizfOfTbg < Count + sizfof(dmsUInt32Numbfr)) rfturn FALSE;

    Tfxt     = (dhbr*) _dmsMbllod(sflf ->ContfxtID, Count+1);
    if (Tfxt == NULL) rfturn FALSE;

    if (io ->Rfbd(io, Tfxt, sizfof(dmsUInt8Numbfr), Count) != Count) {
        _dmsFrff(sflf ->ContfxtID, Tfxt);
        rfturn FALSE;
    }

    Tfxt[Count] = 0;

    dmsMLUsftASCII(mlu, "PS", Sfdtion, Tfxt);
    _dmsFrff(sflf ->ContfxtID, Tfxt);

    *SizfOfTbg -= (Count + sizfof(dmsUInt32Numbfr));
    rfturn TRUE;
}

stbtid
dmsBool  WritfCountAndSting(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsMLU* mlu, donst dhbr* Sfdtion)
{
 dmsUInt32Numbfr TfxtSizf;
 dhbr* Tfxt;

    TfxtSizf = dmsMLUgftASCII(mlu, "PS", Sfdtion, NULL, 0);
    Tfxt     = (dhbr*) _dmsMbllod(sflf ->ContfxtID, TfxtSizf);

    if (!_dmsWritfUInt32Numbfr(io, TfxtSizf)) rfturn FALSE;

    if (dmsMLUgftASCII(mlu, "PS", Sfdtion, Tfxt, TfxtSizf) == 0) rfturn FALSE;

    if (!io ->Writf(io, TfxtSizf, Tfxt)) rfturn FALSE;
    _dmsFrff(sflf ->ContfxtID, Tfxt);

    rfturn TRUE;
}

stbtid
void *Typf_CrdInfo_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsMLU* mlu = dmsMLUbllod(sflf ->ContfxtID, 5);

    *nItfms = 0;
    if (!RfbdCountAndSting(sflf, io, mlu, &SizfOfTbg, "nm")) goto Error;
    if (!RfbdCountAndSting(sflf, io, mlu, &SizfOfTbg, "#0")) goto Error;
    if (!RfbdCountAndSting(sflf, io, mlu, &SizfOfTbg, "#1")) goto Error;
    if (!RfbdCountAndSting(sflf, io, mlu, &SizfOfTbg, "#2")) goto Error;
    if (!RfbdCountAndSting(sflf, io, mlu, &SizfOfTbg, "#3")) goto Error;

    *nItfms = 1;
    rfturn (void*) mlu;

Error:
    dmsMLUfrff(mlu);
    rfturn NULL;

}

stbtid
dmsBool  Typf_CrdInfo_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{

    dmsMLU* mlu = (dmsMLU*) Ptr;

    if (!WritfCountAndSting(sflf, io, mlu, "nm")) goto Error;
    if (!WritfCountAndSting(sflf, io, mlu, "#0")) goto Error;
    if (!WritfCountAndSting(sflf, io, mlu, "#1")) goto Error;
    if (!WritfCountAndSting(sflf, io, mlu, "#2")) goto Error;
    if (!WritfCountAndSting(sflf, io, mlu, "#3")) goto Error;

    rfturn TRUE;

Error:
    rfturn FALSE;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_CrdInfo_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsMLUdup((dmsMLU*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_CrdInfo_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void *Ptr)
{
    dmsMLUfrff((dmsMLU*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}

// ********************************************************************************
// Typf dmsSigSdrffningTypf
// ********************************************************************************
//
//Thf sdrffningTypf dfsdribfs vbrious sdrffning pbrbmftfrs indluding sdrffn
//frfqufndy, sdrffning bnglf, bnd spot shbpf.

stbtid
void *Typf_Sdrffning_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsSdrffning* sd = NULL;
    dmsUInt32Numbfr i;

    sd = (dmsSdrffning*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsSdrffning));
    if (sd == NULL) rfturn NULL;

    *nItfms = 0;

    if (!_dmsRfbdUInt32Numbfr(io, &sd ->Flbg)) goto Error;
    if (!_dmsRfbdUInt32Numbfr(io, &sd ->nChbnnfls)) goto Error;

    if (sd ->nChbnnfls > dmsMAXCHANNELS - 1)
        sd ->nChbnnfls = dmsMAXCHANNELS - 1;

    for (i=0; i < sd ->nChbnnfls; i++) {

        if (!_dmsRfbd15Fixfd16Numbfr(io, &sd ->Chbnnfls[i].Frfqufndy)) goto Error;
        if (!_dmsRfbd15Fixfd16Numbfr(io, &sd ->Chbnnfls[i].SdrffnAnglf)) goto Error;
        if (!_dmsRfbdUInt32Numbfr(io, &sd ->Chbnnfls[i].SpotShbpf)) goto Error;
    }


    *nItfms = 1;

    rfturn (void*) sd;

Error:
    if (sd != NULL)
        _dmsFrff(sflf ->ContfxtID, sd);

    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool Typf_Sdrffning_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsSdrffning* sd = (dmsSdrffning* ) Ptr;
    dmsUInt32Numbfr i;

    if (!_dmsWritfUInt32Numbfr(io, sd ->Flbg)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, sd ->nChbnnfls)) rfturn FALSE;

    for (i=0; i < sd ->nChbnnfls; i++) {

        if (!_dmsWritf15Fixfd16Numbfr(io, sd ->Chbnnfls[i].Frfqufndy)) rfturn FALSE;
        if (!_dmsWritf15Fixfd16Numbfr(io, sd ->Chbnnfls[i].SdrffnAnglf)) rfturn FALSE;
        if (!_dmsWritfUInt32Numbfr(io, sd ->Chbnnfls[i].SpotShbpf)) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_Sdrffning_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
   rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsSdrffning));

   dmsUNUSED_PARAMETER(n);
}


stbtid
void Typf_Sdrffning_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
   _dmsFrff(sflf ->ContfxtID, Ptr);
}

// ********************************************************************************
// Typf dmsSigVifwingConditionsTypf
// ********************************************************************************
//
//This typf rfprfsfnts b sft of vifwing dondition pbrbmftfrs indluding:
//CIE ’bbsolutf’ illuminbnt whitf point tristimulus vblufs bnd CIE ’bbsolutf’
//surround tristimulus vblufs.

stbtid
void *Typf_VifwingConditions_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsICCVifwingConditions* vd = NULL;

    vd = (dmsICCVifwingConditions*) _dmsMbllodZfro(sflf ->ContfxtID, sizfof(dmsICCVifwingConditions));
    if (vd == NULL) rfturn NULL;

    *nItfms = 0;

    if (!_dmsRfbdXYZNumbfr(io, &vd ->IlluminbntXYZ)) goto Error;
    if (!_dmsRfbdXYZNumbfr(io, &vd ->SurroundXYZ)) goto Error;
    if (!_dmsRfbdUInt32Numbfr(io, &vd ->IlluminbntTypf)) goto Error;

    *nItfms = 1;

    rfturn (void*) vd;

Error:
    if (vd != NULL)
        _dmsFrff(sflf ->ContfxtID, vd);

    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


stbtid
dmsBool Typf_VifwingConditions_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsICCVifwingConditions* sd = (dmsICCVifwingConditions* ) Ptr;

    if (!_dmsWritfXYZNumbfr(io, &sd ->IlluminbntXYZ)) rfturn FALSE;
    if (!_dmsWritfXYZNumbfr(io, &sd ->SurroundXYZ)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, sd ->IlluminbntTypf)) rfturn FALSE;

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void* Typf_VifwingConditions_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
   rfturn _dmsDupMfm(sflf ->ContfxtID, Ptr, sizfof(dmsSdrffning));

   dmsUNUSED_PARAMETER(n);
}


stbtid
void Typf_VifwingConditions_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
   _dmsFrff(sflf ->ContfxtID, Ptr);
}


// ********************************************************************************
// Typf dmsSigMultiProdfssElfmfntTypf
// ********************************************************************************


stbtid
void* GfnfridMPEdup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsStbgfDup((dmsStbgf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void GfnfridMPEfrff(strudt _dms_typfhbndlfr_strudt* sflf, void *Ptr)
{
    dmsStbgfFrff((dmsStbgf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}

// Ebdh durvf is storfd in onf or morf durvf sfgmfnts, with brfbk-points spfdififd bftwffn durvf sfgmfnts.
// Thf first durvf sfgmfnt blwbys stbrts bt –Infinity, bnd thf lbst durvf sfgmfnt blwbys fnds bt +Infinity. Thf
// first bnd lbst durvf sfgmfnts shbll bf spfdififd in tfrms of b formulb, whfrfbs thf othfr sfgmfnts shbll bf
// spfdififd fithfr in tfrms of b formulb, or by b sbmplfd durvf.


// Rfbd bn fmbfddfd sfgmfntfd durvf
stbtid
dmsTonfCurvf* RfbdSfgmfntfdCurvf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io)
{
    dmsCurvfSfgSignbturf ElfmfntSig;
    dmsUInt32Numbfr i, j;
    dmsUInt16Numbfr nSfgmfnts;
    dmsCurvfSfgmfnt*  Sfgmfnts;
    dmsTonfCurvf* Curvf;
    dmsFlobt32Numbfr PrfvBrfbk = -1E22F;    // - infinitf

    // Tbkf signbturf bnd dhbnnfls for fbdh flfmfnt.
     if (!_dmsRfbdUInt32Numbfr(io, (dmsUInt32Numbfr*) &ElfmfntSig)) rfturn NULL;

     // Thbt should bf b sfgmfntfd durvf
     if (ElfmfntSig != dmsSigSfgmfntfdCurvf) rfturn NULL;

     if (!_dmsRfbdUInt32Numbfr(io, NULL)) rfturn NULL;
     if (!_dmsRfbdUInt16Numbfr(io, &nSfgmfnts)) rfturn NULL;
     if (!_dmsRfbdUInt16Numbfr(io, NULL)) rfturn NULL;

     if (nSfgmfnts < 1) rfturn NULL;
     Sfgmfnts = (dmsCurvfSfgmfnt*) _dmsCbllod(sflf ->ContfxtID, nSfgmfnts, sizfof(dmsCurvfSfgmfnt));
     if (Sfgmfnts == NULL) rfturn NULL;

     // Rfbd brfbkpoints
     for (i=0; i < (dmsUInt32Numbfr) nSfgmfnts - 1; i++) {

         Sfgmfnts[i].x0 = PrfvBrfbk;
         if (!_dmsRfbdFlobt32Numbfr(io, &Sfgmfnts[i].x1)) goto Error;
         PrfvBrfbk = Sfgmfnts[i].x1;
     }

     Sfgmfnts[nSfgmfnts-1].x0 = PrfvBrfbk;
     Sfgmfnts[nSfgmfnts-1].x1 = 1E22F;     // A big dmsFlobt32Numbfr numbfr

     // Rfbd sfgmfnts
     for (i=0; i < nSfgmfnts; i++) {

          if (!_dmsRfbdUInt32Numbfr(io, (dmsUInt32Numbfr*) &ElfmfntSig)) goto Error;
          if (!_dmsRfbdUInt32Numbfr(io, NULL)) goto Error;

           switdh (ElfmfntSig) {

            dbsf dmsSigFormulbCurvfSfg: {

                dmsUInt16Numbfr Typf;
                dmsUInt32Numbfr PbrbmsByTypf[] = {4, 5, 5 };

                if (!_dmsRfbdUInt16Numbfr(io, &Typf)) goto Error;
                if (!_dmsRfbdUInt16Numbfr(io, NULL)) goto Error;

                Sfgmfnts[i].Typf = Typf + 6;
                if (Typf > 2) goto Error;

                for (j=0; j < PbrbmsByTypf[Typf]; j++) {

                    dmsFlobt32Numbfr f;
                    if (!_dmsRfbdFlobt32Numbfr(io, &f)) goto Error;
                    Sfgmfnts[i].Pbrbms[j] = f;
                }
                }
                brfbk;


            dbsf dmsSigSbmplfdCurvfSfg: {
                dmsUInt32Numbfr Count;

                if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;

                Sfgmfnts[i].nGridPoints = Count;
                Sfgmfnts[i].SbmplfdPoints = (dmsFlobt32Numbfr*) _dmsCbllod(sflf ->ContfxtID, Count, sizfof(dmsFlobt32Numbfr));
                if (Sfgmfnts[i].SbmplfdPoints == NULL) goto Error;

                for (j=0; j < Count; j++) {
                    if (!_dmsRfbdFlobt32Numbfr(io, &Sfgmfnts[i].SbmplfdPoints[j])) goto Error;
                }
                }
                brfbk;

            dffbult:
                {
                dhbr String[5];

                _dmsTbgSignbturf2String(String, (dmsTbgSignbturf) ElfmfntSig);
                dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown durvf flfmfnt typf '%s' found.", String);
                }
                rfturn NULL;

         }
     }

     Curvf = dmsBuildSfgmfntfdTonfCurvf(sflf ->ContfxtID, nSfgmfnts, Sfgmfnts);

     for (i=0; i < nSfgmfnts; i++) {
         if (Sfgmfnts[i].SbmplfdPoints) _dmsFrff(sflf ->ContfxtID, Sfgmfnts[i].SbmplfdPoints);
     }
     _dmsFrff(sflf ->ContfxtID, Sfgmfnts);
     rfturn Curvf;

Error:
     if (Sfgmfnts) _dmsFrff(sflf ->ContfxtID, Sfgmfnts);
     rfturn NULL;
}


stbtid
dmsBool RfbdMPECurvf(strudt _dms_typfhbndlfr_strudt* sflf,
                     dmsIOHANDLER* io,
                     void* Cbrgo,
                     dmsUInt32Numbfr n,
                     dmsUInt32Numbfr SizfOfTbg)
{
      dmsTonfCurvf** GbmmbTbblfs = ( dmsTonfCurvf**) Cbrgo;

      GbmmbTbblfs[n] = RfbdSfgmfntfdCurvf(sflf, io);
      rfturn (GbmmbTbblfs[n] != NULL);

      dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
void *Typf_MPEdurvf_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsStbgf* mpf = NULL;
    dmsUInt16Numbfr InputChbns, OutputChbns;
    dmsUInt32Numbfr i, BbsfOffsft;
    dmsTonfCurvf** GbmmbTbblfs;

    *nItfms = 0;

    // Gft bdtubl position bs b bbsis for flfmfnt offsfts
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    if (!_dmsRfbdUInt16Numbfr(io, &InputChbns)) rfturn NULL;
    if (!_dmsRfbdUInt16Numbfr(io, &OutputChbns)) rfturn NULL;

    if (InputChbns != OutputChbns) rfturn NULL;

    GbmmbTbblfs = (dmsTonfCurvf**) _dmsCbllod(sflf ->ContfxtID, InputChbns, sizfof(dmsTonfCurvf*));
    if (GbmmbTbblfs == NULL) rfturn NULL;

    if (RfbdPositionTbblf(sflf, io, InputChbns, BbsfOffsft, GbmmbTbblfs, RfbdMPECurvf)) {

        mpf = dmsStbgfAllodTonfCurvfs(sflf ->ContfxtID, InputChbns, GbmmbTbblfs);
    }
    flsf {
        mpf = NULL;
    }

    for (i=0; i < InputChbns; i++) {
        if (GbmmbTbblfs[i]) dmsFrffTonfCurvf(GbmmbTbblfs[i]);
    }

    _dmsFrff(sflf ->ContfxtID, GbmmbTbblfs);
    *nItfms = (mpf != NULL) ? 1 : 0;
    rfturn mpf;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}


// Writf b singlf sfgmfntfd durvf. NO CHECK IS PERFORMED ON VALIDITY
stbtid
dmsBool WritfSfgmfntfdCurvf(dmsIOHANDLER* io, dmsTonfCurvf* g)
{
    dmsUInt32Numbfr i, j;
    dmsCurvfSfgmfnt* Sfgmfnts = g ->Sfgmfnts;
    dmsUInt32Numbfr nSfgmfnts = g ->nSfgmfnts;

    if (!_dmsWritfUInt32Numbfr(io, dmsSigSfgmfntfdCurvf)) goto Error;
    if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) nSfgmfnts)) goto Error;
    if (!_dmsWritfUInt16Numbfr(io, 0)) goto Error;

    // Writf thf brfbk-points
    for (i=0; i < nSfgmfnts - 1; i++) {
        if (!_dmsWritfFlobt32Numbfr(io, Sfgmfnts[i].x1)) goto Error;
    }

    // Writf thf sfgmfnts
    for (i=0; i < g ->nSfgmfnts; i++) {

        dmsCurvfSfgmfnt* AdtublSfg = Sfgmfnts + i;

        if (AdtublSfg -> Typf == 0) {

            // This is b sbmplfd durvf
            if (!_dmsWritfUInt32Numbfr(io, (dmsUInt32Numbfr) dmsSigSbmplfdCurvfSfg)) goto Error;
            if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;
            if (!_dmsWritfUInt32Numbfr(io, AdtublSfg -> nGridPoints)) goto Error;

            for (j=0; j < g ->Sfgmfnts[i].nGridPoints; j++) {
                if (!_dmsWritfFlobt32Numbfr(io, AdtublSfg -> SbmplfdPoints[j])) goto Error;
            }

        }
        flsf {
            int Typf;
            dmsUInt32Numbfr PbrbmsByTypf[] = { 4, 5, 5 };

            // This is b formulb-bbsfd
            if (!_dmsWritfUInt32Numbfr(io, (dmsUInt32Numbfr) dmsSigFormulbCurvfSfg)) goto Error;
            if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;

            // Wf only bllow 1, 2 bnd 3 bs typfs
            Typf = AdtublSfg ->Typf - 6;
            if (Typf > 2 || Typf < 0) goto Error;

            if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) Typf)) goto Error;
            if (!_dmsWritfUInt16Numbfr(io, 0)) goto Error;

            for (j=0; j < PbrbmsByTypf[Typf]; j++) {
                if (!_dmsWritfFlobt32Numbfr(io, (dmsFlobt32Numbfr) AdtublSfg ->Pbrbms[j])) goto Error;
            }
        }

        // It sffms thfrf is no nffd to blign. Codf is hfrf, bnd for sbffty dommfntfd out
        // if (!_dmsWritfAlignmfnt(io)) goto Error;
    }

    rfturn TRUE;

Error:
    rfturn FALSE;
}


stbtid
dmsBool WritfMPECurvf(strudt _dms_typfhbndlfr_strudt* sflf,
                      dmsIOHANDLER* io,
                      void* Cbrgo,
                      dmsUInt32Numbfr n,
                      dmsUInt32Numbfr SizfOfTbg)
{
    _dmsStbgfTonfCurvfsDbtb* Curvfs  = (_dmsStbgfTonfCurvfsDbtb*) Cbrgo;

    rfturn WritfSfgmfntfdCurvf(io, Curvfs ->ThfCurvfs[n]);

    dmsUNUSED_PARAMETER(SizfOfTbg);
    dmsUNUSED_PARAMETER(sflf);
}

// Writf b durvf, dhfdking first for vblidity
stbtid
dmsBool  Typf_MPEdurvf_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt32Numbfr BbsfOffsft;
    dmsStbgf* mpf = (dmsStbgf*) Ptr;
    _dmsStbgfTonfCurvfsDbtb* Curvfs = (_dmsStbgfTonfCurvfsDbtb*) mpf ->Dbtb;

    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // Writf thf hfbdfr. Sindf thosf brf durvfs, input bnd output dhbnnfls brf sbmf
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->InputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->InputChbnnfls)) rfturn FALSE;

    if (!WritfPositionTbblf(sflf, io, 0,
                                mpf ->InputChbnnfls, BbsfOffsft, Curvfs, WritfMPECurvf)) rfturn FALSE;


    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
}



// Thf mbtrix is orgbnizfd bs bn brrby of PxQ+Q flfmfnts, whfrf P is thf numbfr of input dhbnnfls to thf
// mbtrix, bnd Q is thf numbfr of output dhbnnfls. Thf mbtrix flfmfnts brf fbdh flobt32Numbfrs. Thf brrby
// is orgbnizfd bs follows:
// brrby = [f11, f12, …, f1P, f21, f22, …, f2P, …, fQ1, fQ2, …, fQP, f1, f2, …, fQ]

stbtid
void *Typf_MPEmbtrix_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsStbgf* mpf;
    dmsUInt16Numbfr   InputChbns, OutputChbns;
    dmsUInt32Numbfr   nElfms, i;
    dmsFlobt64Numbfr* Mbtrix;
    dmsFlobt64Numbfr* Offsfts;

    if (!_dmsRfbdUInt16Numbfr(io, &InputChbns)) rfturn NULL;
    if (!_dmsRfbdUInt16Numbfr(io, &OutputChbns)) rfturn NULL;


    nElfms = InputChbns * OutputChbns;

    // Input bnd output dhbns mby bf ANY (up to 0xffff)
    Mbtrix = (dmsFlobt64Numbfr*) _dmsCbllod(sflf ->ContfxtID, nElfms, sizfof(dmsFlobt64Numbfr));
    if (Mbtrix == NULL) rfturn NULL;

    Offsfts = (dmsFlobt64Numbfr*) _dmsCbllod(sflf ->ContfxtID, OutputChbns, sizfof(dmsFlobt64Numbfr));
    if (Offsfts == NULL) {

        _dmsFrff(sflf ->ContfxtID, Mbtrix);
        rfturn NULL;
    }

    for (i=0; i < nElfms; i++) {

        dmsFlobt32Numbfr v;

        if (!_dmsRfbdFlobt32Numbfr(io, &v)) rfturn NULL;
        Mbtrix[i] = v;
    }


    for (i=0; i < OutputChbns; i++) {

        dmsFlobt32Numbfr v;

        if (!_dmsRfbdFlobt32Numbfr(io, &v)) rfturn NULL;
        Offsfts[i] = v;
    }


    mpf = dmsStbgfAllodMbtrix(sflf ->ContfxtID, OutputChbns, InputChbns, Mbtrix, Offsfts);
    _dmsFrff(sflf ->ContfxtID, Mbtrix);
    _dmsFrff(sflf ->ContfxtID, Offsfts);

    *nItfms = 1;

    rfturn mpf;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

stbtid
dmsBool  Typf_MPEmbtrix_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt32Numbfr i, nElfms;
    dmsStbgf* mpf = (dmsStbgf*) Ptr;
    _dmsStbgfMbtrixDbtb* Mbtrix = (_dmsStbgfMbtrixDbtb*) mpf ->Dbtb;

    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->InputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->OutputChbnnfls)) rfturn FALSE;

    nElfms = mpf ->InputChbnnfls * mpf ->OutputChbnnfls;

    for (i=0; i < nElfms; i++) {
        if (!_dmsWritfFlobt32Numbfr(io, (dmsFlobt32Numbfr) Mbtrix->Doublf[i])) rfturn FALSE;
    }


    for (i=0; i < mpf ->OutputChbnnfls; i++) {

        if (Mbtrix ->Offsft == NULL) {

               if (!_dmsWritfFlobt32Numbfr(io, 0)) rfturn FALSE;
        }
        flsf {
               if (!_dmsWritfFlobt32Numbfr(io, (dmsFlobt32Numbfr) Mbtrix->Offsft[i])) rfturn FALSE;
        }
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}



stbtid
void *Typf_MPEdlut_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsStbgf* mpf = NULL;
    dmsUInt16Numbfr InputChbns, OutputChbns;
    dmsUInt8Numbfr Dimfnsions8[16];
    dmsUInt32Numbfr i, nMbxGrids, GridPoints[MAX_INPUT_DIMENSIONS];
    _dmsStbgfCLutDbtb* dlut;

    if (!_dmsRfbdUInt16Numbfr(io, &InputChbns)) rfturn NULL;
    if (!_dmsRfbdUInt16Numbfr(io, &OutputChbns)) rfturn NULL;

    if (InputChbns == 0) goto Error;
    if (OutputChbns == 0) goto Error;

    if (io ->Rfbd(io, Dimfnsions8, sizfof(dmsUInt8Numbfr), 16) != 16)
        goto Error;

    // Copy MAX_INPUT_DIMENSIONS bt most. Expbnd to dmsUInt32Numbfr
    nMbxGrids = InputChbns > MAX_INPUT_DIMENSIONS ? MAX_INPUT_DIMENSIONS : InputChbns;
    for (i=0; i < nMbxGrids; i++) GridPoints[i] = (dmsUInt32Numbfr) Dimfnsions8[i];

    // Allodbtf thf truf CLUT
    mpf = dmsStbgfAllodCLutFlobtGrbnulbr(sflf ->ContfxtID, GridPoints, InputChbns, OutputChbns, NULL);
    if (mpf == NULL) goto Error;

    // Rfbd thf dbtb
    dlut = (_dmsStbgfCLutDbtb*) mpf ->Dbtb;
    for (i=0; i < dlut ->nEntrifs; i++) {

        if (!_dmsRfbdFlobt32Numbfr(io, &dlut ->Tbb.TFlobt[i])) goto Error;
    }

    *nItfms = 1;
    rfturn mpf;

Error:
    *nItfms = 0;
    if (mpf != NULL) dmsStbgfFrff(mpf);
    rfturn NULL;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}

// Writf b CLUT in flobting point
stbtid
dmsBool  Typf_MPEdlut_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt8Numbfr Dimfnsions8[16];
    dmsUInt32Numbfr i;
    dmsStbgf* mpf = (dmsStbgf*) Ptr;
    _dmsStbgfCLutDbtb* dlut = (_dmsStbgfCLutDbtb*) mpf ->Dbtb;

    // Chfdk for mbximum numbfr of dhbnnfls
    if (mpf -> InputChbnnfls > 15) rfturn FALSE;

    // Only flobts brf supportfd in MPE
    if (dlut ->HbsFlobtVblufs == FALSE) rfturn FALSE;

    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->InputChbnnfls)) rfturn FALSE;
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) mpf ->OutputChbnnfls)) rfturn FALSE;

    mfmsft(Dimfnsions8, 0, sizfof(Dimfnsions8));

    for (i=0; i < mpf ->InputChbnnfls; i++)
        Dimfnsions8[i] = (dmsUInt8Numbfr) dlut ->Pbrbms ->nSbmplfs[i];

    if (!io ->Writf(io, 16, Dimfnsions8)) rfturn FALSE;

    for (i=0; i < dlut ->nEntrifs; i++) {

        if (!_dmsWritfFlobt32Numbfr(io, dlut ->Tbb.TFlobt[i])) rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(nItfms);
    dmsUNUSED_PARAMETER(sflf);
}



// This is thf list of built-in MPE typfs
stbtid _dmsTbgTypfLinkfdList SupportfdMPEtypfs[] = {

{{ (dmsTbgTypfSignbturf) dmsSigBAdsElfmTypf, NULL, NULL, NULL, NULL, NULL, 0 }, &SupportfdMPEtypfs[1] },   // Ignorf thosf flfmfnts for now
{{ (dmsTbgTypfSignbturf) dmsSigEAdsElfmTypf, NULL, NULL, NULL, NULL, NULL, 0 }, &SupportfdMPEtypfs[2] },   // (Thbt's whbt thf spfd sbys)

{TYPE_MPE_HANDLER((dmsTbgTypfSignbturf) dmsSigCurvfSftElfmTypf,     MPEdurvf),      &SupportfdMPEtypfs[3] },
{TYPE_MPE_HANDLER((dmsTbgTypfSignbturf) dmsSigMbtrixElfmTypf,       MPEmbtrix),     &SupportfdMPEtypfs[4] },
{TYPE_MPE_HANDLER((dmsTbgTypfSignbturf) dmsSigCLutElfmTypf,         MPEdlut),        NULL },
};

#dffinf DEFAULT_MPE_TYPE_COUNT  (sizfof(SupportfdMPEtypfs) / sizfof(_dmsTbgTypfLinkfdList))

stbtid
dmsBool RfbdMPEElfm(strudt _dms_typfhbndlfr_strudt* sflf,
                    dmsIOHANDLER* io,
                    void* Cbrgo,
                    dmsUInt32Numbfr n,
                    dmsUInt32Numbfr SizfOfTbg)
{
    dmsStbgfSignbturf ElfmfntSig;
    dmsTbgTypfHbndlfr* TypfHbndlfr;
    dmsUInt32Numbfr nItfms;
    dmsPipflinf *NfwLUT = (dmsPipflinf *) Cbrgo;

    // Tbkf signbturf bnd dhbnnfls for fbdh flfmfnt.
    if (!_dmsRfbdUInt32Numbfr(io, (dmsUInt32Numbfr*) &ElfmfntSig)) rfturn FALSE;

    // Thf rfsfrvfd plbdfholdfr
    if (!_dmsRfbdUInt32Numbfr(io, NULL)) rfturn FALSE;

    // Rfbd divfrsf MPE typfs
    TypfHbndlfr = GftHbndlfr((dmsTbgTypfSignbturf) ElfmfntSig, SupportfdMPEtypfs);
    if (TypfHbndlfr == NULL)  {

        dhbr String[5];

        _dmsTbgSignbturf2String(String, (dmsTbgSignbturf) ElfmfntSig);

        // An unknown flfmfnt wbs found.
        dmsSignblError(sflf ->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown MPE typf '%s' found.", String);
        rfturn FALSE;
    }

    // If no rfbd mfthod, just ignorf thf flfmfnt (vblid for dmsSigBAdsElfmTypf bnd dmsSigEAdsElfmTypf)
    // Rfbd thf MPE. No sizf is givfn
    if (TypfHbndlfr ->RfbdPtr != NULL) {

        // This is b rfbl flfmfnt whidh should bf rfbd bnd prodfssfd
        if (!dmsPipflinfInsfrtStbgf(NfwLUT, dmsAT_END, (dmsStbgf*) TypfHbndlfr ->RfbdPtr(sflf, io, &nItfms, SizfOfTbg)))
            rfturn FALSE;
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(SizfOfTbg);
    dmsUNUSED_PARAMETER(n);
}


// This is thf mbin dispbtdhfr for MPE
stbtid
void *Typf_MPE_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt16Numbfr InputChbns, OutputChbns;
    dmsUInt32Numbfr ElfmfntCount;
    dmsPipflinf *NfwLUT = NULL;
    dmsUInt32Numbfr BbsfOffsft;

    // Gft bdtubl position bs b bbsis for flfmfnt offsfts
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // Rfbd dhbnnfls bnd flfmfnt dount
    if (!_dmsRfbdUInt16Numbfr(io, &InputChbns)) rfturn NULL;
    if (!_dmsRfbdUInt16Numbfr(io, &OutputChbns)) rfturn NULL;

    // Allodbtfs bn fmpty LUT
    NfwLUT = dmsPipflinfAllod(sflf ->ContfxtID, InputChbns, OutputChbns);
    if (NfwLUT == NULL) rfturn NULL;

    if (!_dmsRfbdUInt32Numbfr(io, &ElfmfntCount)) rfturn NULL;

    if (!RfbdPositionTbblf(sflf, io, ElfmfntCount, BbsfOffsft, NfwLUT, RfbdMPEElfm)) {
        if (NfwLUT != NULL) dmsPipflinfFrff(NfwLUT);
        *nItfms = 0;
        rfturn NULL;
    }

    // Suddfss
    *nItfms = 1;
    rfturn NfwLUT;

    dmsUNUSED_PARAMETER(SizfOfTbg);
}



// This onf is b liitlf bit morf domplfx, so wf don't usf position tbblfs this timf.
stbtid
dmsBool Typf_MPE_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsUInt32Numbfr i, BbsfOffsft, DirfdtoryPos, CurrfntPos;
    int inputChbn, outputChbn;
    dmsUInt32Numbfr ElfmCount;
    dmsUInt32Numbfr *ElfmfntOffsfts = NULL, *ElfmfntSizfs = NULL, Bfforf;
    dmsStbgfSignbturf ElfmfntSig;
    dmsPipflinf* Lut = (dmsPipflinf*) Ptr;
    dmsStbgf* Elfm = Lut ->Elfmfnts;
    dmsTbgTypfHbndlfr* TypfHbndlfr;

    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    inputChbn  = dmsPipflinfInputChbnnfls(Lut);
    outputChbn = dmsPipflinfOutputChbnnfls(Lut);
    ElfmCount  = dmsPipflinfStbgfCount(Lut);

    ElfmfntOffsfts = (dmsUInt32Numbfr *) _dmsCbllod(sflf ->ContfxtID, ElfmCount, sizfof(dmsUInt32Numbfr));
    if (ElfmfntOffsfts == NULL) goto Error;

    ElfmfntSizfs = (dmsUInt32Numbfr *) _dmsCbllod(sflf ->ContfxtID, ElfmCount, sizfof(dmsUInt32Numbfr));
    if (ElfmfntSizfs == NULL) goto Error;

    // Writf thf hfbd
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) inputChbn)) goto Error;
    if (!_dmsWritfUInt16Numbfr(io, (dmsUInt16Numbfr) outputChbn)) goto Error;
    if (!_dmsWritfUInt32Numbfr(io, (dmsUInt16Numbfr) ElfmCount)) goto Error;

    DirfdtoryPos = io ->Tfll(io);

    // Writf b fbkf dirfdtory to bf fillfd lbttfr on
    for (i=0; i < ElfmCount; i++) {
        if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;  // Offsft
        if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;  // sizf
    }

    // Writf fbdh singlf tbg. Kffp trbdk of thf sizf bs wfll.
    for (i=0; i < ElfmCount; i++) {

        ElfmfntOffsfts[i] = io ->Tfll(io) - BbsfOffsft;

        ElfmfntSig = Elfm ->Typf;

        TypfHbndlfr = GftHbndlfr((dmsTbgTypfSignbturf) ElfmfntSig, SupportfdMPEtypfs);
        if (TypfHbndlfr == NULL)  {

                dhbr String[5];

                _dmsTbgSignbturf2String(String, (dmsTbgSignbturf) ElfmfntSig);

                 // An unknow flfmfnt wbs found.
                 dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Found unknown MPE typf '%s'", String);
                 goto Error;
        }

        if (!_dmsWritfUInt32Numbfr(io, ElfmfntSig)) goto Error;
        if (!_dmsWritfUInt32Numbfr(io, 0)) goto Error;
        Bfforf = io ->Tfll(io);
        if (!TypfHbndlfr ->WritfPtr(sflf, io, Elfm, 1)) goto Error;
        if (!_dmsWritfAlignmfnt(io)) goto Error;

        ElfmfntSizfs[i] = io ->Tfll(io) - Bfforf;

        Elfm = Elfm ->Nfxt;
    }

    // Writf thf dirfdtory
    CurrfntPos = io ->Tfll(io);

    if (!io ->Sffk(io, DirfdtoryPos)) goto Error;

    for (i=0; i < ElfmCount; i++) {
        if (!_dmsWritfUInt32Numbfr(io, ElfmfntOffsfts[i])) goto Error;
        if (!_dmsWritfUInt32Numbfr(io, ElfmfntSizfs[i])) goto Error;
    }

    if (!io ->Sffk(io, CurrfntPos)) goto Error;

    if (ElfmfntOffsfts != NULL) _dmsFrff(sflf ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(sflf ->ContfxtID, ElfmfntSizfs);
    rfturn TRUE;

Error:
    if (ElfmfntOffsfts != NULL) _dmsFrff(sflf ->ContfxtID, ElfmfntOffsfts);
    if (ElfmfntSizfs != NULL) _dmsFrff(sflf ->ContfxtID, ElfmfntSizfs);
    rfturn FALSE;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_MPE_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*) dmsPipflinfDup((dmsPipflinf*) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}

stbtid
void Typf_MPE_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void *Ptr)
{
    dmsPipflinfFrff((dmsPipflinf*) Ptr);
    rfturn;

    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf dmsSigVdgtTypf
// ********************************************************************************


#dffinf dmsVidfoCbrdGbmmbTbblfTypf    0
#dffinf dmsVidfoCbrdGbmmbFormulbTypf  1

// Usfd intfrnblly
typfdff strudt {
    doublf Gbmmb;
    doublf Min;
    doublf Mbx;
} _dmsVCGTGAMMA;


stbtid
void *Typf_vdgt_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf,
                     dmsIOHANDLER* io,
                     dmsUInt32Numbfr* nItfms,
                     dmsUInt32Numbfr SizfOfTbg)
{
    dmsUInt32Numbfr TbgTypf, n, i;
    dmsTonfCurvf** Curvfs;

    *nItfms = 0;

    // Rfbd tbg typf
    if (!_dmsRfbdUInt32Numbfr(io, &TbgTypf)) rfturn NULL;

    // Allodbtf spbdf for thf brrby
    Curvfs = ( dmsTonfCurvf**) _dmsCbllod(sflf ->ContfxtID, 3, sizfof(dmsTonfCurvf*));
    if (Curvfs == NULL) rfturn NULL;

    // Thfrf brf two possiblf flbvors
    switdh (TbgTypf) {

    // Gbmmb is storfd bs b tbblf
    dbsf dmsVidfoCbrdGbmmbTbblfTypf:
    {
       dmsUInt16Numbfr nChbnnfls, nElfms, nBytfs;

       // Chfdk dhbnnfl dount, whidh should bf 3 (wf don't support monodhromf this timf)
       if (!_dmsRfbdUInt16Numbfr(io, &nChbnnfls)) goto Error;

       if (nChbnnfls != 3) {
           dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unsupportfd numbfr of dhbnnfls for VCGT '%d'", nChbnnfls);
           goto Error;
       }

       // Gft Tbblf flfmfnt dount bnd bytfs pfr flfmfnt
       if (!_dmsRfbdUInt16Numbfr(io, &nElfms)) goto Error;
       if (!_dmsRfbdUInt16Numbfr(io, &nBytfs)) goto Error;

       // Adobf's quirk fixup. Fixing brokfn profilfs...
       if (nElfms == 256 && nBytfs == 1 && SizfOfTbg == 1576)
           nBytfs = 2;


       // Populbtf tonf durvfs
       for (n=0; n < 3; n++) {

           Curvfs[n] = dmsBuildTbbulbtfdTonfCurvf16(sflf ->ContfxtID, nElfms, NULL);
           if (Curvfs[n] == NULL) goto Error;

           // On dfpfnding on bytf dfpth
           switdh (nBytfs) {

           // Onf bytf, 0..255
           dbsf 1:
               for (i=0; i < nElfms; i++) {

                   dmsUInt8Numbfr v;

                      if (!_dmsRfbdUInt8Numbfr(io, &v)) goto Error;
                      Curvfs[n] ->Tbblf16[i] = FROM_8_TO_16(v);
               }
               brfbk;

           // Onf word 0..65535
           dbsf 2:
              if (!_dmsRfbdUInt16Arrby(io, nElfms, Curvfs[n]->Tbblf16)) goto Error;
              brfbk;

          // Unsupportfd
           dffbult:
              dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unsupportfd bit dfpth for VCGT '%d'", nBytfs * 8);
              goto Error;
           }
       } // For bll 3 dhbnnfls
    }
    brfbk;

   // In this dbsf, gbmmb is storfd bs b formulb
   dbsf dmsVidfoCbrdGbmmbFormulbTypf:
   {
       _dmsVCGTGAMMA Colorbnt[3];

        // Populbtf tonf durvfs
       for (n=0; n < 3; n++) {

           doublf Pbrbms[10];

           if (!_dmsRfbd15Fixfd16Numbfr(io, &Colorbnt[n].Gbmmb)) goto Error;
           if (!_dmsRfbd15Fixfd16Numbfr(io, &Colorbnt[n].Min)) goto Error;
           if (!_dmsRfbd15Fixfd16Numbfr(io, &Colorbnt[n].Mbx)) goto Error;

            // Pbrbmftrid durvf typf 5 is:
            // Y = (bX + b)^Gbmmb + f | X >= d
            // Y = dX + f             | X < d

            // vdgt formulb is:
            // Y = (Mbx – Min) * (X ^ Gbmmb) + Min

            // So, thf trbnslbtion is
            // b = (Mbx – Min) ^ ( 1 / Gbmmb)
            // f = Min
            // b=d=d=f=0

           Pbrbms[0] = Colorbnt[n].Gbmmb;
           Pbrbms[1] = pow((Colorbnt[n].Mbx - Colorbnt[n].Min), (1.0 / Colorbnt[n].Gbmmb));
           Pbrbms[2] = 0;
           Pbrbms[3] = 0;
           Pbrbms[4] = 0;
           Pbrbms[5] = Colorbnt[n].Min;
           Pbrbms[6] = 0;

           Curvfs[n] = dmsBuildPbrbmftridTonfCurvf(sflf ->ContfxtID, 5, Pbrbms);
           if (Curvfs[n] == NULL) goto Error;
       }
   }
   brfbk;

   // Unsupportfd
   dffbult:
      dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unsupportfd tbg typf for VCGT '%d'", TbgTypf);
      goto Error;
   }

   *nItfms = 1;
   rfturn (void*) Curvfs;

// Rfgrft,  frff bll rfsourdfs
Error:

    dmsFrffTonfCurvfTriplf(Curvfs);
    _dmsFrff(sflf ->ContfxtID, Curvfs);
    rfturn NULL;

     dmsUNUSED_PARAMETER(SizfOfTbg);
}


// Wf don't support bll flbvors, only 16bits tbblfs bnd formulb
stbtid
dmsBool Typf_vdgt_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsTonfCurvf** Curvfs =  (dmsTonfCurvf**) Ptr;
    dmsUInt32Numbfr i, j;

    if (dmsGftTonfCurvfPbrbmftridTypf(Curvfs[0]) == 5 &&
        dmsGftTonfCurvfPbrbmftridTypf(Curvfs[1]) == 5 &&
        dmsGftTonfCurvfPbrbmftridTypf(Curvfs[2]) == 5) {

            if (!_dmsWritfUInt32Numbfr(io, dmsVidfoCbrdGbmmbFormulbTypf)) rfturn FALSE;

            // Sbvf pbrbmftfrs
            for (i=0; i < 3; i++) {

                _dmsVCGTGAMMA v;

                v.Gbmmb = Curvfs[i] ->Sfgmfnts[0].Pbrbms[0];
                v.Min   = Curvfs[i] ->Sfgmfnts[0].Pbrbms[5];
                v.Mbx   = pow(Curvfs[i] ->Sfgmfnts[0].Pbrbms[1], v.Gbmmb) + v.Min;

                if (!_dmsWritf15Fixfd16Numbfr(io, v.Gbmmb)) rfturn FALSE;
                if (!_dmsWritf15Fixfd16Numbfr(io, v.Min)) rfturn FALSE;
                if (!_dmsWritf15Fixfd16Numbfr(io, v.Mbx)) rfturn FALSE;
            }
    }

    flsf {

        // Alwbys storf bs b tbblf of 256 words
        if (!_dmsWritfUInt32Numbfr(io, dmsVidfoCbrdGbmmbTbblfTypf)) rfturn FALSE;
        if (!_dmsWritfUInt16Numbfr(io, 3)) rfturn FALSE;
        if (!_dmsWritfUInt16Numbfr(io, 256)) rfturn FALSE;
        if (!_dmsWritfUInt16Numbfr(io, 2)) rfturn FALSE;

        for (i=0; i < 3; i++) {
            for (j=0; j < 256; j++) {

                dmsFlobt32Numbfr v = dmsEvblTonfCurvfFlobt(Curvfs[i], (dmsFlobt32Numbfr) (j / 255.0));
                dmsUInt16Numbfr  n = _dmsQuidkSbturbtfWord(v * 65535.0);

                if (!_dmsWritfUInt16Numbfr(io, n)) rfturn FALSE;
            }
        }
    }

    rfturn TRUE;

    dmsUNUSED_PARAMETER(sflf);
    dmsUNUSED_PARAMETER(nItfms);
}

stbtid
void* Typf_vdgt_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    dmsTonfCurvf** OldCurvfs =  (dmsTonfCurvf**) Ptr;
    dmsTonfCurvf** NfwCurvfs;

    NfwCurvfs = ( dmsTonfCurvf**) _dmsCbllod(sflf ->ContfxtID, 3, sizfof(dmsTonfCurvf*));
    if (NfwCurvfs == NULL) rfturn NULL;

    NfwCurvfs[0] = dmsDupTonfCurvf(OldCurvfs[0]);
    NfwCurvfs[1] = dmsDupTonfCurvf(OldCurvfs[1]);
    NfwCurvfs[2] = dmsDupTonfCurvf(OldCurvfs[2]);

    rfturn (void*) NfwCurvfs;

    dmsUNUSED_PARAMETER(n);
}


stbtid
void Typf_vdgt_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsFrffTonfCurvfTriplf((dmsTonfCurvf**) Ptr);
    _dmsFrff(sflf ->ContfxtID, Ptr);
}


// ********************************************************************************
// Typf dmsSigDidtTypf
// ********************************************************************************

// Singlf dolumn of thf tbblf dbn point to wdhbr or MLUC flfmfnts. Holds brrbys of dbtb
typfdff strudt {
    dmsContfxt ContfxtID;
    dmsUInt32Numbfr *Offsfts;
    dmsUInt32Numbfr *Sizfs;
} _dmsDICflfm;

typfdff strudt {
    _dmsDICflfm Nbmf, Vbluf, DisplbyNbmf, DisplbyVbluf;

} _dmsDICbrrby;

// Allodbtf bn fmpty brrby flfmfnt
stbtid
dmsBool AllodElfm(dmsContfxt ContfxtID, _dmsDICflfm* f,  dmsUInt32Numbfr Count)
{
    f->Offsfts = (dmsUInt32Numbfr *) _dmsCbllod(ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (f->Offsfts == NULL) rfturn FALSE;

    f->Sizfs = (dmsUInt32Numbfr *) _dmsCbllod(ContfxtID, Count, sizfof(dmsUInt32Numbfr));
    if (f->Sizfs == NULL) {

        _dmsFrff(ContfxtID, f -> Offsfts);
        rfturn FALSE;
    }

    f ->ContfxtID = ContfxtID;
    rfturn TRUE;
}

// Frff bn brrby flfmfnt
stbtid
void FrffElfm(_dmsDICflfm* f)
{
    if (f ->Offsfts != NULL)  _dmsFrff(f -> ContfxtID, f -> Offsfts);
    if (f ->Sizfs   != NULL)  _dmsFrff(f -> ContfxtID, f -> Sizfs);
    f->Offsfts = f ->Sizfs = NULL;
}

// Gft rid of wholf brrby
stbtid
void FrffArrby( _dmsDICbrrby* b)
{
    if (b ->Nbmf.Offsfts != NULL) FrffElfm(&b->Nbmf);
    if (b ->Vbluf.Offsfts != NULL) FrffElfm(&b ->Vbluf);
    if (b ->DisplbyNbmf.Offsfts != NULL) FrffElfm(&b->DisplbyNbmf);
    if (b ->DisplbyVbluf.Offsfts != NULL) FrffElfm(&b ->DisplbyVbluf);
}


// Allodbtf wholf brrby
stbtid
dmsBool AllodArrby(dmsContfxt ContfxtID, _dmsDICbrrby* b, dmsUInt32Numbfr Count, dmsUInt32Numbfr Lfngth)
{
    // Empty vblufs
    mfmsft(b, 0, sizfof(_dmsDICbrrby));

    // On dfpfnding on rfdord sizf, drfbtf dolumn brrbys
    if (!AllodElfm(ContfxtID, &b ->Nbmf, Count)) goto Error;
    if (!AllodElfm(ContfxtID, &b ->Vbluf, Count)) goto Error;

    if (Lfngth > 16) {
        if (!AllodElfm(ContfxtID, &b -> DisplbyNbmf, Count)) goto Error;

    }
    if (Lfngth > 24) {
        if (!AllodElfm(ContfxtID, &b ->DisplbyVbluf, Count)) goto Error;
    }
    rfturn TRUE;

Error:
    FrffArrby(b);
    rfturn FALSE;
}

// Rfbd onf flfmfnt
stbtid
dmsBool RfbdOnfElfm(dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i, dmsUInt32Numbfr BbsfOffsft)
{
    if (!_dmsRfbdUInt32Numbfr(io, &f->Offsfts[i])) rfturn FALSE;
    if (!_dmsRfbdUInt32Numbfr(io, &f ->Sizfs[i])) rfturn FALSE;

    // An offsft of zfro hbs spfdibl mfbning bnd shbl bf prfsfrvfd
    if (f ->Offsfts[i] > 0)
        f ->Offsfts[i] += BbsfOffsft;
    rfturn TRUE;
}


stbtid
dmsBool RfbdOffsftArrby(dmsIOHANDLER* io,  _dmsDICbrrby* b, dmsUInt32Numbfr Count, dmsUInt32Numbfr Lfngth, dmsUInt32Numbfr BbsfOffsft)
{
    dmsUInt32Numbfr i;

    // Rfbd dolumn brrbys
    for (i=0; i < Count; i++) {

        if (!RfbdOnfElfm(io, &b -> Nbmf, i, BbsfOffsft)) rfturn FALSE;
        if (!RfbdOnfElfm(io, &b -> Vbluf, i, BbsfOffsft)) rfturn FALSE;

        if (Lfngth > 16) {

            if (!RfbdOnfElfm(io, &b ->DisplbyNbmf, i, BbsfOffsft)) rfturn FALSE;

        }

        if (Lfngth > 24) {

            if (!RfbdOnfElfm(io, & b -> DisplbyVbluf, i, BbsfOffsft)) rfturn FALSE;
        }
    }
    rfturn TRUE;
}


// Writf onf flfmfnt
stbtid
dmsBool WritfOnfElfm(dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i)
{
    if (!_dmsWritfUInt32Numbfr(io, f->Offsfts[i])) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, f ->Sizfs[i])) rfturn FALSE;

    rfturn TRUE;
}

stbtid
dmsBool WritfOffsftArrby(dmsIOHANDLER* io,  _dmsDICbrrby* b, dmsUInt32Numbfr Count, dmsUInt32Numbfr Lfngth)
{
    dmsUInt32Numbfr i;

    for (i=0; i < Count; i++) {

        if (!WritfOnfElfm(io, &b -> Nbmf, i)) rfturn FALSE;
        if (!WritfOnfElfm(io, &b -> Vbluf, i))  rfturn FALSE;

        if (Lfngth > 16) {

            if (!WritfOnfElfm(io, &b -> DisplbyNbmf, i))  rfturn FALSE;
        }

        if (Lfngth > 24) {

            if (!WritfOnfElfm(io, &b -> DisplbyVbluf, i))  rfturn FALSE;
        }
    }

    rfturn TRUE;
}

stbtid
dmsBool RfbdOnfWChbr(dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i, wdhbr_t ** wdstr)
{

    dmsUInt32Numbfr nChbrs;

      // Spfdibl dbsf for undffinfd strings (sff ICC Votbblf
      // Proposbl Submission, Didtionbry Typf bnd Mftbdbtb TAG Dffinition)
      if (f -> Offsfts[i] == 0) {

          *wdstr = NULL;
          rfturn TRUE;
      }

      if (!io -> Sffk(io, f -> Offsfts[i])) rfturn FALSE;

      nChbrs = f ->Sizfs[i] / sizfof(dmsUInt16Numbfr);


      *wdstr = (wdhbr_t*) _dmsMbllodZfro(f ->ContfxtID, (nChbrs + 1) * sizfof(wdhbr_t));
      if (*wdstr == NULL) rfturn FALSE;

      if (!_dmsRfbdWChbrArrby(io, nChbrs, *wdstr)) {
          _dmsFrff(f ->ContfxtID, *wdstr);
          rfturn FALSE;
      }

      // End of string mbrkfr
      (*wdstr)[nChbrs] = 0;
      rfturn TRUE;
}

stbtid
dmsUInt32Numbfr mywdslfn(donst wdhbr_t *s)
{
    donst wdhbr_t *p;

    p = s;
    whilf (*p)
        p++;

    rfturn (dmsUInt32Numbfr)(p - s);
}

stbtid
dmsBool WritfOnfWChbr(dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i, donst wdhbr_t * wdstr, dmsUInt32Numbfr BbsfOffsft)
{
    dmsUInt32Numbfr Bfforf = io ->Tfll(io);
    dmsUInt32Numbfr n;

    f ->Offsfts[i] = Bfforf - BbsfOffsft;

    if (wdstr == NULL) {
        f ->Sizfs[i] = 0;
        f ->Offsfts[i] = 0;
        rfturn TRUE;
    }

    n = mywdslfn(wdstr);
    if (!_dmsWritfWChbrArrby(io,  n, wdstr)) rfturn FALSE;

    f ->Sizfs[i] = io ->Tfll(io) - Bfforf;
    rfturn TRUE;
}

stbtid
dmsBool RfbdOnfMLUC(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i, dmsMLU** mlu)
{
    dmsUInt32Numbfr nItfms = 0;

    // A wby to gft null MLUCs
    if (f -> Offsfts[i] == 0 || f ->Sizfs[i] == 0) {

        *mlu = NULL;
        rfturn TRUE;
    }

    if (!io -> Sffk(io, f -> Offsfts[i])) rfturn FALSE;

    *mlu = (dmsMLU*) Typf_MLU_Rfbd(sflf, io, &nItfms, f ->Sizfs[i]);
    rfturn *mlu != NULL;
}

stbtid
dmsBool WritfOnfMLUC(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io,  _dmsDICflfm* f, dmsUInt32Numbfr i, donst dmsMLU* mlu, dmsUInt32Numbfr BbsfOffsft)
{
    dmsUInt32Numbfr Bfforf;

     // Spfdibl dbsf for undffinfd strings (sff ICC Votbblf
     // Proposbl Submission, Didtionbry Typf bnd Mftbdbtb TAG Dffinition)
     if (mlu == NULL) {
        f ->Sizfs[i] = 0;
        f ->Offsfts[i] = 0;
        rfturn TRUE;
    }

    Bfforf = io ->Tfll(io);
    f ->Offsfts[i] = Bfforf - BbsfOffsft;

    if (!Typf_MLU_Writf(sflf, io, (void*) mlu, 1)) rfturn FALSE;

    f ->Sizfs[i] = io ->Tfll(io) - Bfforf;
    rfturn TRUE;
}


stbtid
void *Typf_Didtionbry_Rfbd(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, dmsUInt32Numbfr* nItfms, dmsUInt32Numbfr SizfOfTbg)
{
   dmsHANDLE hDidt;
   dmsUInt32Numbfr i, Count, Lfngth;
   dmsUInt32Numbfr BbsfOffsft;
   _dmsDICbrrby b;
   wdhbr_t *NbmfWCS = NULL, *VblufWCS = NULL;
   dmsMLU *DisplbyNbmfMLU = NULL, *DisplbyVblufMLU=NULL;
   dmsBool rd;

    *nItfms = 0;

    // Gft bdtubl position bs b bbsis for flfmfnt offsfts
    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // Gft nbmf-vbluf rfdord dount
    if (!_dmsRfbdUInt32Numbfr(io, &Count)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    // Gft rfd lfngth
    if (!_dmsRfbdUInt32Numbfr(io, &Lfngth)) rfturn NULL;
    SizfOfTbg -= sizfof(dmsUInt32Numbfr);

    // Chfdk for vblid lfngths
    if (Lfngth != 16 && Lfngth != 24 && Lfngth != 32) {
         dmsSignblError(sflf->ContfxtID, dmsERROR_UNKNOWN_EXTENSION, "Unknown rfdord lfngth in didtionbry '%d'", Lfngth);
         rfturn NULL;
    }

    // Crfbtfs bn fmpty didtionbry
    hDidt = dmsDidtAllod(sflf -> ContfxtID);
    if (hDidt == NULL) rfturn NULL;

    // On dfpfnding on rfdord sizf, drfbtf dolumn brrbys
    if (!AllodArrby(sflf -> ContfxtID, &b, Count, Lfngth)) goto Error;

    // Rfbd dolumn brrbys
    if (!RfbdOffsftArrby(io, &b, Count, Lfngth, BbsfOffsft)) goto Error;

    // Sffk to fbdh flfmfnt bnd rfbd it
    for (i=0; i < Count; i++) {

        if (!RfbdOnfWChbr(io, &b.Nbmf, i, &NbmfWCS)) goto Error;
        if (!RfbdOnfWChbr(io, &b.Vbluf, i, &VblufWCS)) goto Error;

        if (Lfngth > 16) {
            if (!RfbdOnfMLUC(sflf, io, &b.DisplbyNbmf, i, &DisplbyNbmfMLU)) goto Error;
        }

        if (Lfngth > 24) {
            if (!RfbdOnfMLUC(sflf, io, &b.DisplbyVbluf, i, &DisplbyVblufMLU)) goto Error;
        }

        if (NbmfWCS == NULL || VblufWCS == NULL) {

            dmsSignblError(sflf->ContfxtID, dmsERROR_CORRUPTION_DETECTED, "Bbd didtionbry Nbmf/Vbluf");
            rd = FALSE;
        }
        flsf {

        rd = dmsDidtAddEntry(hDidt, NbmfWCS, VblufWCS, DisplbyNbmfMLU, DisplbyVblufMLU);
        }

        if (NbmfWCS != NULL) _dmsFrff(sflf ->ContfxtID, NbmfWCS);
        if (VblufWCS != NULL) _dmsFrff(sflf ->ContfxtID, VblufWCS);
        if (DisplbyNbmfMLU != NULL) dmsMLUfrff(DisplbyNbmfMLU);
        if (DisplbyVblufMLU != NULL) dmsMLUfrff(DisplbyVblufMLU);

        if (!rd) goto Error;
    }

   FrffArrby(&b);
   *nItfms = 1;
   rfturn (void*) hDidt;

Error:
   FrffArrby(&b);
   dmsDidtFrff(hDidt);
   rfturn NULL;
}


stbtid
dmsBool Typf_Didtionbry_Writf(strudt _dms_typfhbndlfr_strudt* sflf, dmsIOHANDLER* io, void* Ptr, dmsUInt32Numbfr nItfms)
{
    dmsHANDLE hDidt = (dmsHANDLE) Ptr;
    donst dmsDICTfntry* p;
    dmsBool AnyNbmf, AnyVbluf;
    dmsUInt32Numbfr i, Count, Lfngth;
    dmsUInt32Numbfr DirfdtoryPos, CurrfntPos, BbsfOffsft;
   _dmsDICbrrby b;

    if (hDidt == NULL) rfturn FALSE;

    BbsfOffsft = io ->Tfll(io) - sizfof(_dmsTbgBbsf);

    // Lft's inspfdt thf didtionbry
    Count = 0; AnyNbmf = FALSE; AnyVbluf = FALSE;
    for (p = dmsDidtGftEntryList(hDidt); p != NULL; p = dmsDidtNfxtEntry(p)) {

        if (p ->DisplbyNbmf != NULL) AnyNbmf = TRUE;
        if (p ->DisplbyVbluf != NULL) AnyVbluf = TRUE;
        Count++;
    }

    Lfngth = 16;
    if (AnyNbmf)  Lfngth += 8;
    if (AnyVbluf) Lfngth += 8;

    if (!_dmsWritfUInt32Numbfr(io, Count)) rfturn FALSE;
    if (!_dmsWritfUInt32Numbfr(io, Lfngth)) rfturn FALSE;

    // Kffp stbrting position of offsfts tbblf
    DirfdtoryPos = io ->Tfll(io);

    // Allodbtf offsfts brrby
    if (!AllodArrby(sflf ->ContfxtID, &b, Count, Lfngth)) goto Error;

    // Writf b fbkf dirfdtory to bf fillfd lbttfr on
    if (!WritfOffsftArrby(io, &b, Count, Lfngth)) goto Error;

    // Writf fbdh flfmfnt. Kffp trbdk of thf sizf bs wfll.
    p = dmsDidtGftEntryList(hDidt);
    for (i=0; i < Count; i++) {

        if (!WritfOnfWChbr(io, &b.Nbmf, i,  p ->Nbmf, BbsfOffsft)) goto Error;
        if (!WritfOnfWChbr(io, &b.Vbluf, i, p ->Vbluf, BbsfOffsft)) goto Error;

        if (p ->DisplbyNbmf != NULL) {
            if (!WritfOnfMLUC(sflf, io, &b.DisplbyNbmf, i, p ->DisplbyNbmf, BbsfOffsft)) goto Error;
        }

        if (p ->DisplbyVbluf != NULL) {
            if (!WritfOnfMLUC(sflf, io, &b.DisplbyVbluf, i, p ->DisplbyVbluf, BbsfOffsft)) goto Error;
        }

       p = dmsDidtNfxtEntry(p);
    }

    // Writf thf dirfdtory
    CurrfntPos = io ->Tfll(io);
    if (!io ->Sffk(io, DirfdtoryPos)) goto Error;

    if (!WritfOffsftArrby(io, &b, Count, Lfngth)) goto Error;

    if (!io ->Sffk(io, CurrfntPos)) goto Error;

    FrffArrby(&b);
    rfturn TRUE;

Error:
    FrffArrby(&b);
    rfturn FALSE;

    dmsUNUSED_PARAMETER(nItfms);
}


stbtid
void* Typf_Didtionbry_Dup(strudt _dms_typfhbndlfr_strudt* sflf, donst void *Ptr, dmsUInt32Numbfr n)
{
    rfturn (void*)  dmsDidtDup((dmsHANDLE) Ptr);

    dmsUNUSED_PARAMETER(n);
    dmsUNUSED_PARAMETER(sflf);
}


stbtid
void Typf_Didtionbry_Frff(strudt _dms_typfhbndlfr_strudt* sflf, void* Ptr)
{
    dmsDidtFrff((dmsHANDLE) Ptr);
    dmsUNUSED_PARAMETER(sflf);
}


// ********************************************************************************
// Typf support mbin routinfs
// ********************************************************************************


// This is thf list of built-in typfs
stbtid _dmsTbgTypfLinkfdList SupportfdTbgTypfs[] = {

{TYPE_HANDLER(dmsSigChrombtidityTypf,          Chrombtidity),        &SupportfdTbgTypfs[1] },
{TYPE_HANDLER(dmsSigColorbntOrdfrTypf,         ColorbntOrdfrTypf),   &SupportfdTbgTypfs[2] },
{TYPE_HANDLER(dmsSigS15Fixfd16ArrbyTypf,       S15Fixfd16),          &SupportfdTbgTypfs[3] },
{TYPE_HANDLER(dmsSigU16Fixfd16ArrbyTypf,       U16Fixfd16),          &SupportfdTbgTypfs[4] },
{TYPE_HANDLER(dmsSigTfxtTypf,                  Tfxt),                &SupportfdTbgTypfs[5] },
{TYPE_HANDLER(dmsSigTfxtDfsdriptionTypf,       Tfxt_Dfsdription),    &SupportfdTbgTypfs[6] },
{TYPE_HANDLER(dmsSigCurvfTypf,                 Curvf),               &SupportfdTbgTypfs[7] },
{TYPE_HANDLER(dmsSigPbrbmftridCurvfTypf,       PbrbmftridCurvf),     &SupportfdTbgTypfs[8] },
{TYPE_HANDLER(dmsSigDbtfTimfTypf,              DbtfTimf),            &SupportfdTbgTypfs[9] },
{TYPE_HANDLER(dmsSigLut8Typf,                  LUT8),                &SupportfdTbgTypfs[10] },
{TYPE_HANDLER(dmsSigLut16Typf,                 LUT16),               &SupportfdTbgTypfs[11] },
{TYPE_HANDLER(dmsSigColorbntTbblfTypf,         ColorbntTbblf),       &SupportfdTbgTypfs[12] },
{TYPE_HANDLER(dmsSigNbmfdColor2Typf,           NbmfdColor),          &SupportfdTbgTypfs[13] },
{TYPE_HANDLER(dmsSigMultiLodblizfdUnidodfTypf, MLU),                 &SupportfdTbgTypfs[14] },
{TYPE_HANDLER(dmsSigProfilfSfqufndfDfsdTypf,   ProfilfSfqufndfDfsd), &SupportfdTbgTypfs[15] },
{TYPE_HANDLER(dmsSigSignbturfTypf,             Signbturf),           &SupportfdTbgTypfs[16] },
{TYPE_HANDLER(dmsSigMfbsurfmfntTypf,           Mfbsurfmfnt),         &SupportfdTbgTypfs[17] },
{TYPE_HANDLER(dmsSigDbtbTypf,                  Dbtb),                &SupportfdTbgTypfs[18] },
{TYPE_HANDLER(dmsSigLutAtoBTypf,               LUTA2B),              &SupportfdTbgTypfs[19] },
{TYPE_HANDLER(dmsSigLutBtoATypf,               LUTB2A),              &SupportfdTbgTypfs[20] },
{TYPE_HANDLER(dmsSigUdrBgTypf,                 UdrBg),               &SupportfdTbgTypfs[21] },
{TYPE_HANDLER(dmsSigCrdInfoTypf,               CrdInfo),             &SupportfdTbgTypfs[22] },
{TYPE_HANDLER(dmsSigMultiProdfssElfmfntTypf,   MPE),                 &SupportfdTbgTypfs[23] },
{TYPE_HANDLER(dmsSigSdrffningTypf,             Sdrffning),           &SupportfdTbgTypfs[24] },
{TYPE_HANDLER(dmsSigVifwingConditionsTypf,     VifwingConditions),   &SupportfdTbgTypfs[25] },
{TYPE_HANDLER(dmsSigXYZTypf,                   XYZ),                 &SupportfdTbgTypfs[26] },
{TYPE_HANDLER(dmsCorbisBrokfnXYZtypf,          XYZ),                 &SupportfdTbgTypfs[27] },
{TYPE_HANDLER(dmsMonbdoBrokfnCurvfTypf,        Curvf),               &SupportfdTbgTypfs[28] },
{TYPE_HANDLER(dmsSigProfilfSfqufndfIdTypf,     ProfilfSfqufndfId),   &SupportfdTbgTypfs[29] },
{TYPE_HANDLER(dmsSigDidtTypf,                  Didtionbry),          &SupportfdTbgTypfs[30] },
{TYPE_HANDLER(dmsSigVdgtTypf,                  vdgt),                NULL }
};

#dffinf DEFAULT_TAG_TYPE_COUNT  (sizfof(SupportfdTbgTypfs) / sizfof(_dmsTbgTypfLinkfdList))

// Both kind of plug-ins shbrf sbmf strudturf
dmsBool  _dmsRfgistfrTbgTypfPlugin(dmsContfxt id, dmsPluginBbsf* Dbtb)
{
    rfturn RfgistfrTypfsPlugin(id, Dbtb, SupportfdTbgTypfs, DEFAULT_TAG_TYPE_COUNT);
}

dmsBool  _dmsRfgistfrMultiProdfssElfmfntPlugin(dmsContfxt id, dmsPluginBbsf* Dbtb)
{
    rfturn RfgistfrTypfsPlugin(id, Dbtb, SupportfdMPEtypfs, DEFAULT_MPE_TYPE_COUNT);
}


// Wrbppfr for tbg typfs
dmsTbgTypfHbndlfr* _dmsGftTbgTypfHbndlfr(dmsTbgTypfSignbturf sig)
{
    rfturn GftHbndlfr(sig, SupportfdTbgTypfs);
}

// ********************************************************************************
// Tbg support mbin routinfs
// ********************************************************************************

typfdff strudt _dmsTbgLinkfdList_st {

            dmsTbgSignbturf Signbturf;
            dmsTbgDfsdriptor Dfsdriptor;
            strudt _dmsTbgLinkfdList_st* Nfxt;

} _dmsTbgLinkfdList;

// This is thf list of built-in tbgs
stbtid _dmsTbgLinkfdList SupportfdTbgs[] = {

    { dmsSigAToB0Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutAtoBTypf, dmsSigLut8Typf}, DfdidfLUTtypfA2B}, &SupportfdTbgs[1]},
    { dmsSigAToB1Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutAtoBTypf, dmsSigLut8Typf}, DfdidfLUTtypfA2B}, &SupportfdTbgs[2]},
    { dmsSigAToB2Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutAtoBTypf, dmsSigLut8Typf}, DfdidfLUTtypfA2B}, &SupportfdTbgs[3]},
    { dmsSigBToA0Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutBtoATypf, dmsSigLut8Typf}, DfdidfLUTtypfB2A}, &SupportfdTbgs[4]},
    { dmsSigBToA1Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutBtoATypf, dmsSigLut8Typf}, DfdidfLUTtypfB2A}, &SupportfdTbgs[5]},
    { dmsSigBToA2Tbg,               { 1, 3,  { dmsSigLut16Typf,  dmsSigLutBtoATypf, dmsSigLut8Typf}, DfdidfLUTtypfB2A}, &SupportfdTbgs[6]},

    // Allow dorbis  bnd its brokfn XYZ typf
    { dmsSigRfdColorbntTbg,         { 1, 2, { dmsSigXYZTypf, dmsCorbisBrokfnXYZtypf }, DfdidfXYZtypf}, &SupportfdTbgs[7]},
    { dmsSigGrffnColorbntTbg,       { 1, 2, { dmsSigXYZTypf, dmsCorbisBrokfnXYZtypf }, DfdidfXYZtypf}, &SupportfdTbgs[8]},
    { dmsSigBlufColorbntTbg,        { 1, 2, { dmsSigXYZTypf, dmsCorbisBrokfnXYZtypf }, DfdidfXYZtypf}, &SupportfdTbgs[9]},

    { dmsSigRfdTRCTbg,              { 1, 3, { dmsSigCurvfTypf, dmsSigPbrbmftridCurvfTypf, dmsMonbdoBrokfnCurvfTypf }, DfdidfCurvfTypf}, &SupportfdTbgs[10]},
    { dmsSigGrffnTRCTbg,            { 1, 3, { dmsSigCurvfTypf, dmsSigPbrbmftridCurvfTypf, dmsMonbdoBrokfnCurvfTypf }, DfdidfCurvfTypf}, &SupportfdTbgs[11]},
    { dmsSigBlufTRCTbg,             { 1, 3, { dmsSigCurvfTypf, dmsSigPbrbmftridCurvfTypf, dmsMonbdoBrokfnCurvfTypf }, DfdidfCurvfTypf}, &SupportfdTbgs[12]},

    { dmsSigCblibrbtionDbtfTimfTbg, { 1, 1, { dmsSigDbtfTimfTypf }, NULL}, &SupportfdTbgs[13]},
    { dmsSigChbrTbrgftTbg,          { 1, 1, { dmsSigTfxtTypf },     NULL}, &SupportfdTbgs[14]},

    { dmsSigChrombtidAdbptbtionTbg, { 9, 1, { dmsSigS15Fixfd16ArrbyTypf }, NULL}, &SupportfdTbgs[15]},
    { dmsSigChrombtidityTbg,        { 1, 1, { dmsSigChrombtidityTypf    }, NULL}, &SupportfdTbgs[16]},
    { dmsSigColorbntOrdfrTbg,       { 1, 1, { dmsSigColorbntOrdfrTypf   }, NULL}, &SupportfdTbgs[17]},
    { dmsSigColorbntTbblfTbg,       { 1, 1, { dmsSigColorbntTbblfTypf   }, NULL}, &SupportfdTbgs[18]},
    { dmsSigColorbntTbblfOutTbg,    { 1, 1, { dmsSigColorbntTbblfTypf   }, NULL}, &SupportfdTbgs[19]},

    { dmsSigCopyrightTbg,           { 1, 3, { dmsSigTfxtTypf,  dmsSigMultiLodblizfdUnidodfTypf, dmsSigTfxtDfsdriptionTypf}, DfdidfTfxtTypf}, &SupportfdTbgs[20]},
    { dmsSigDbtfTimfTbg,            { 1, 1, { dmsSigDbtfTimfTypf }, NULL}, &SupportfdTbgs[21]},

    { dmsSigDfvidfMfgDfsdTbg,       { 1, 3, { dmsSigTfxtDfsdriptionTypf, dmsSigMultiLodblizfdUnidodfTypf, dmsSigTfxtTypf}, DfdidfTfxtDfsdTypf}, &SupportfdTbgs[22]},
    { dmsSigDfvidfModflDfsdTbg,     { 1, 3, { dmsSigTfxtDfsdriptionTypf, dmsSigMultiLodblizfdUnidodfTypf, dmsSigTfxtTypf}, DfdidfTfxtDfsdTypf}, &SupportfdTbgs[23]},

    { dmsSigGbmutTbg,               { 1, 3, { dmsSigLut16Typf, dmsSigLutBtoATypf, dmsSigLut8Typf }, DfdidfLUTtypfB2A}, &SupportfdTbgs[24]},

    { dmsSigGrbyTRCTbg,             { 1, 2, { dmsSigCurvfTypf, dmsSigPbrbmftridCurvfTypf }, DfdidfCurvfTypf}, &SupportfdTbgs[25]},
    { dmsSigLuminbndfTbg,           { 1, 1, { dmsSigXYZTypf }, NULL}, &SupportfdTbgs[26]},

    { dmsSigMfdibBlbdkPointTbg,     { 1, 2, { dmsSigXYZTypf, dmsCorbisBrokfnXYZtypf }, NULL}, &SupportfdTbgs[27]},
    { dmsSigMfdibWhitfPointTbg,     { 1, 2, { dmsSigXYZTypf, dmsCorbisBrokfnXYZtypf }, NULL}, &SupportfdTbgs[28]},

    { dmsSigNbmfdColor2Tbg,         { 1, 1, { dmsSigNbmfdColor2Typf }, NULL}, &SupportfdTbgs[29]},

    { dmsSigPrfvifw0Tbg,            { 1, 3,  { dmsSigLut16Typf, dmsSigLutBtoATypf, dmsSigLut8Typf }, DfdidfLUTtypfB2A}, &SupportfdTbgs[30]},
    { dmsSigPrfvifw1Tbg,            { 1, 3,  { dmsSigLut16Typf, dmsSigLutBtoATypf, dmsSigLut8Typf }, DfdidfLUTtypfB2A}, &SupportfdTbgs[31]},
    { dmsSigPrfvifw2Tbg,            { 1, 3,  { dmsSigLut16Typf, dmsSigLutBtoATypf, dmsSigLut8Typf }, DfdidfLUTtypfB2A}, &SupportfdTbgs[32]},

    { dmsSigProfilfDfsdriptionTbg,  { 1, 3, { dmsSigTfxtDfsdriptionTypf, dmsSigMultiLodblizfdUnidodfTypf, dmsSigTfxtTypf}, DfdidfTfxtDfsdTypf}, &SupportfdTbgs[33]},
    { dmsSigProfilfSfqufndfDfsdTbg, { 1, 1, { dmsSigProfilfSfqufndfDfsdTypf }, NULL}, &SupportfdTbgs[34]},
    { dmsSigTfdhnologyTbg,          { 1, 1, { dmsSigSignbturfTypf }, NULL},  &SupportfdTbgs[35]},

    { dmsSigColorimftridIntfntImbgfStbtfTbg,   { 1, 1, { dmsSigSignbturfTypf }, NULL}, &SupportfdTbgs[36]},
    { dmsSigPfrdfptublRfndfringIntfntGbmutTbg, { 1, 1, { dmsSigSignbturfTypf }, NULL}, &SupportfdTbgs[37]},
    { dmsSigSbturbtionRfndfringIntfntGbmutTbg, { 1, 1, { dmsSigSignbturfTypf }, NULL}, &SupportfdTbgs[38]},

    { dmsSigMfbsurfmfntTbg,         { 1, 1, { dmsSigMfbsurfmfntTypf }, NULL}, &SupportfdTbgs[39]},

    { dmsSigPs2CRD0Tbg,             { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[40]},
    { dmsSigPs2CRD1Tbg,             { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[41]},
    { dmsSigPs2CRD2Tbg,             { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[42]},
    { dmsSigPs2CRD3Tbg,             { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[43]},
    { dmsSigPs2CSATbg,              { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[44]},
    { dmsSigPs2RfndfringIntfntTbg,  { 1, 1, { dmsSigDbtbTypf }, NULL}, &SupportfdTbgs[45]},

    { dmsSigVifwingCondDfsdTbg,     { 1, 3, { dmsSigTfxtDfsdriptionTypf, dmsSigMultiLodblizfdUnidodfTypf, dmsSigTfxtTypf}, DfdidfTfxtDfsdTypf}, &SupportfdTbgs[46]},

    { dmsSigUdrBgTbg,               { 1, 1, { dmsSigUdrBgTypf}, NULL},    &SupportfdTbgs[47]},
    { dmsSigCrdInfoTbg,             { 1, 1, { dmsSigCrdInfoTypf}, NULL},  &SupportfdTbgs[48]},

    { dmsSigDToB0Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[49]},
    { dmsSigDToB1Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[50]},
    { dmsSigDToB2Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[51]},
    { dmsSigDToB3Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[52]},
    { dmsSigBToD0Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[53]},
    { dmsSigBToD1Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[54]},
    { dmsSigBToD2Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[55]},
    { dmsSigBToD3Tbg,               { 1, 1, { dmsSigMultiProdfssElfmfntTypf}, NULL}, &SupportfdTbgs[56]},

    { dmsSigSdrffningDfsdTbg,       { 1, 1, { dmsSigTfxtDfsdriptionTypf },    NULL}, &SupportfdTbgs[57]},
    { dmsSigVifwingConditionsTbg,   { 1, 1, { dmsSigVifwingConditionsTypf },  NULL}, &SupportfdTbgs[58]},

    { dmsSigSdrffningTbg,           { 1, 1, { dmsSigSdrffningTypf},          NULL }, &SupportfdTbgs[59]},
    { dmsSigVdgtTbg,                { 1, 1, { dmsSigVdgtTypf},               NULL }, &SupportfdTbgs[60]},
    { dmsSigMftbTbg,                { 1, 1, { dmsSigDidtTypf},               NULL }, &SupportfdTbgs[61]},
    { dmsSigProfilfSfqufndfIdTbg,   { 1, 1, { dmsSigProfilfSfqufndfIdTypf},  NULL },  &SupportfdTbgs[62]},
    { dmsSigProfilfDfsdriptionMLTbg,{ 1, 1, { dmsSigMultiLodblizfdUnidodfTypf}, NULL}, NULL}


};

/*
    Not supportfd                 Why
    =======================       =========================================
    dmsSigOutputRfsponsfTbg   ==> WARNING, POSSIBLE PATENT ON THIS SUBJECT!
    dmsSigNbmfdColorTbg       ==> Dfprfdbtfd
    dmsSigDbtbTbg             ==> Andifnt, unusfd
    dmsSigDfvidfSfttingsTbg   ==> Dfprfdbtfd, usflfss
*/

#dffinf DEFAULT_TAG_COUNT  (sizfof(SupportfdTbgs) / sizfof(_dmsTbgLinkfdList))

dmsBool  _dmsRfgistfrTbgPlugin(dmsContfxt id, dmsPluginBbsf* Dbtb)
{
    dmsPluginTbg* Plugin = (dmsPluginTbg*) Dbtb;
    _dmsTbgLinkfdList *pt, *Antfrior;


    if (Dbtb == NULL) {

        SupportfdTbgs[DEFAULT_TAG_COUNT-1].Nfxt = NULL;
        rfturn TRUE;
    }

    pt = Antfrior = SupportfdTbgs;
    whilf (pt != NULL) {

        if (Plugin->Signbturf == pt -> Signbturf) {
            pt ->Dfsdriptor = Plugin ->Dfsdriptor;  // Rfplbdf old bfhbviour
            rfturn TRUE;
        }

        Antfrior = pt;
        pt = pt ->Nfxt;
    }

    pt = (_dmsTbgLinkfdList*) _dmsPluginMbllod(id, sizfof(_dmsTbgLinkfdList));
    if (pt == NULL) rfturn FALSE;

    pt ->Signbturf  = Plugin ->Signbturf;
    pt ->Dfsdriptor = Plugin ->Dfsdriptor;
    pt ->Nfxt       = NULL;

    if (Antfrior != NULL) Antfrior -> Nfxt = pt;

    rfturn TRUE;
}

// Rfturn b dfsdriptor for b givfn tbg or NULL
dmsTbgDfsdriptor* _dmsGftTbgDfsdriptor(dmsTbgSignbturf sig)
{
    _dmsTbgLinkfdList* pt;

    for (pt = SupportfdTbgs;
            pt != NULL;
            pt = pt ->Nfxt) {

                if (sig == pt -> Signbturf) rfturn &pt ->Dfsdriptor;
    }

    rfturn NULL;
}

