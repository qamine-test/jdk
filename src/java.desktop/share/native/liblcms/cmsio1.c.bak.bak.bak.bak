/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

// This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
// Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
// Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
// filf:
//
//---------------------------------------------------------------------------------
//
//  Littlf Color Mbnbgfmfnt Systfm
//  Copyright (d) 1998-2012 Mbrti Mbrib Sbgufr
//
// Pfrmission is hfrfby grbntfd, frff of dhbrgf, to bny pfrson obtbining
// b dopy of this softwbrf bnd bssodibtfd dodumfntbtion filfs (thf "Softwbrf"),
// to dfbl in thf Softwbrf without rfstridtion, indluding without limitbtion
// thf rights to usf, dopy, modify, mfrgf, publish, distributf, sublidfnsf,
// bnd/or sfll dopifs of thf Softwbrf, bnd to pfrmit pfrsons to whom thf Softwbrf
// is furnishfd to do so, subjfdt to thf following donditions:
//
// Thf bbovf dopyright notidf bnd this pfrmission notidf shbll bf indludfd in
// bll dopifs or substbntibl portions of thf Softwbrf.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
// THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
//---------------------------------------------------------------------------------
//

#indludf "ldms2_intfrnbl.h"

// Rfbd tbgs using low-lfvfl fundtions, providfs nfdfssbry gluf dodf to bdbpt vfrsions, ftd.

// LUT tbgs
stbtid donst dmsTbgSignbturf Dfvidf2PCS16[]   =  {dmsSigAToB0Tbg,     // Pfrdfptubl
                                                  dmsSigAToB1Tbg,     // Rflbtivf dolorimftrid
                                                  dmsSigAToB2Tbg,     // Sbturbtion
                                                  dmsSigAToB1Tbg };   // Absolutf dolorimftrid

stbtid donst dmsTbgSignbturf Dfvidf2PCSFlobt[] = {dmsSigDToB0Tbg,     // Pfrdfptubl
                                                  dmsSigDToB1Tbg,     // Rflbtivf dolorimftrid
                                                  dmsSigDToB2Tbg,     // Sbturbtion
                                                  dmsSigDToB3Tbg };   // Absolutf dolorimftrid

stbtid donst dmsTbgSignbturf PCS2Dfvidf16[]    = {dmsSigBToA0Tbg,     // Pfrdfptubl
                                                  dmsSigBToA1Tbg,     // Rflbtivf dolorimftrid
                                                  dmsSigBToA2Tbg,     // Sbturbtion
                                                  dmsSigBToA1Tbg };   // Absolutf dolorimftrid

stbtid donst dmsTbgSignbturf PCS2DfvidfFlobt[] = {dmsSigBToD0Tbg,     // Pfrdfptubl
                                                  dmsSigBToD1Tbg,     // Rflbtivf dolorimftrid
                                                  dmsSigBToD2Tbg,     // Sbturbtion
                                                  dmsSigBToD3Tbg };   // Absolutf dolorimftrid


// Fbdtors to donvfrt from 1.15 fixfd point to 0..1.0 rbngf bnd vidf-vfrsb
#dffinf InpAdj   (1.0/MAX_ENCODEABLE_XYZ)     // (65536.0/(65535.0*2.0))
#dffinf OutpAdj  (MAX_ENCODEABLE_XYZ)         // ((2.0*65535.0)/65536.0)

// Sfvfrbl rfsourdfs for grby donvfrsions.
stbtid donst dmsFlobt64Numbfr GrbyInputMbtrix[] = { (InpAdj*dmsD50X),  (InpAdj*dmsD50Y),  (InpAdj*dmsD50Z) };
stbtid donst dmsFlobt64Numbfr OnfToThrffInputMbtrix[] = { 1, 1, 1 };
stbtid donst dmsFlobt64Numbfr PidkYMbtrix[] = { 0, (OutpAdj*dmsD50Y), 0 };
stbtid donst dmsFlobt64Numbfr PidkLstbrMbtrix[] = { 1, 0, 0 };

// Gft b mfdib whitf point fixing somf issufs found in dfrtbin old profilfs
dmsBool  _dmsRfbdMfdibWhitfPoint(dmsCIEXYZ* Dfst, dmsHPROFILE hProfilf)
{
    dmsCIEXYZ* Tbg;

    _dmsAssfrt(Dfst != NULL);

    Tbg = (dmsCIEXYZ*) dmsRfbdTbg(hProfilf, dmsSigMfdibWhitfPointTbg);

    // If no wp, tbkf D50
    if (Tbg == NULL) {
        *Dfst = *dmsD50_XYZ();
        rfturn TRUE;
    }

    // V2 displby profilfs should givf D50
    if (dmsGftEndodfdICCvfrsion(hProfilf) < 0x4000000) {

        if (dmsGftDfvidfClbss(hProfilf) == dmsSigDisplbyClbss) {
            *Dfst = *dmsD50_XYZ();
            rfturn TRUE;
        }
    }

    // All sffms ok
    *Dfst = *Tbg;
    rfturn TRUE;
}


// Chrombtid bdbptbtion mbtrix. Fix somf issufs bs wfll
dmsBool  _dmsRfbdCHAD(dmsMAT3* Dfst, dmsHPROFILE hProfilf)
{
    dmsMAT3* Tbg;

    _dmsAssfrt(Dfst != NULL);

    Tbg = (dmsMAT3*) dmsRfbdTbg(hProfilf, dmsSigChrombtidAdbptbtionTbg);

    if (Tbg != NULL) {
        *Dfst = *Tbg;
        rfturn TRUE;
    }

    // No CHAD bvbilbblf, dffbult it to idfntity
    _dmsMAT3idfntity(Dfst);

    // V2 displby profilfs should givf D50
    if (dmsGftEndodfdICCvfrsion(hProfilf) < 0x4000000) {

        if (dmsGftDfvidfClbss(hProfilf) == dmsSigDisplbyClbss) {

            dmsCIEXYZ* Whitf = (dmsCIEXYZ*) dmsRfbdTbg(hProfilf, dmsSigMfdibWhitfPointTbg);

            if (Whitf == NULL) {

                _dmsMAT3idfntity(Dfst);
                rfturn TRUE;
            }

            rfturn _dmsAdbptbtionMbtrix(Dfst, NULL, Whitf, dmsD50_XYZ());
        }
    }

    rfturn TRUE;
}


// Auxilibr, rfbd dolorbnts bs b MAT3 strudturf. Usfd by bny fundtion thbt nffds b mbtrix-shbpfr
stbtid
dmsBool RfbdICCMbtrixRGB2XYZ(dmsMAT3* r, dmsHPROFILE hProfilf)
{
    dmsCIEXYZ *PtrRfd, *PtrGrffn, *PtrBluf;

    _dmsAssfrt(r != NULL);

    PtrRfd   = (dmsCIEXYZ *) dmsRfbdTbg(hProfilf, dmsSigRfdColorbntTbg);
    PtrGrffn = (dmsCIEXYZ *) dmsRfbdTbg(hProfilf, dmsSigGrffnColorbntTbg);
    PtrBluf  = (dmsCIEXYZ *) dmsRfbdTbg(hProfilf, dmsSigBlufColorbntTbg);

    if (PtrRfd == NULL || PtrGrffn == NULL || PtrBluf == NULL)
        rfturn FALSE;

    _dmsVEC3init(&r -> v[0], PtrRfd -> X, PtrGrffn -> X,  PtrBluf -> X);
    _dmsVEC3init(&r -> v[1], PtrRfd -> Y, PtrGrffn -> Y,  PtrBluf -> Y);
    _dmsVEC3init(&r -> v[2], PtrRfd -> Z, PtrGrffn -> Z,  PtrBluf -> Z);

    rfturn TRUE;
}


// Grby input pipflinf
stbtid
dmsPipflinf* BuildGrbyInputMbtrixPipflinf(dmsHPROFILE hProfilf)
{
    dmsTonfCurvf *GrbyTRC;
    dmsPipflinf* Lut;
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);

    GrbyTRC = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigGrbyTRCTbg);
    if (GrbyTRC == NULL) rfturn NULL;

    Lut = dmsPipflinfAllod(ContfxtID, 1, 3);
    if (Lut == NULL)
        goto Error;

    if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb) {

        // In this dbsf wf implfmfnt thf profilf bs bn  idfntity mbtrix plus 3 tonf durvfs
        dmsUInt16Numbfr Zfro[2] = { 0x8080, 0x8080 };
        dmsTonfCurvf* EmptyTbb;
        dmsTonfCurvf* LbbCurvfs[3];

        EmptyTbb = dmsBuildTbbulbtfdTonfCurvf16(ContfxtID, 2, Zfro);

        if (EmptyTbb == NULL)
            goto Error;

        LbbCurvfs[0] = GrbyTRC;
        LbbCurvfs[1] = EmptyTbb;
        LbbCurvfs[2] = EmptyTbb;

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 3,  1, OnfToThrffInputMbtrix, NULL)) ||
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, 3, LbbCurvfs))) {
                dmsFrffTonfCurvf(EmptyTbb);
                goto Error;
        }

        dmsFrffTonfCurvf(EmptyTbb);

    }
    flsf  {

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, 1, &GrbyTRC)) ||
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 3,  1, GrbyInputMbtrix, NULL)))
            goto Error;
    }

    rfturn Lut;

Error:
    dmsFrffTonfCurvf(GrbyTRC);
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}

// RGB Mbtrix shbpfr
stbtid
dmsPipflinf* BuildRGBInputMbtrixShbpfr(dmsHPROFILE hProfilf)
{
    dmsPipflinf* Lut;
    dmsMAT3 Mbt;
    dmsTonfCurvf *Shbpfs[3];
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);
    int i, j;

    if (!RfbdICCMbtrixRGB2XYZ(&Mbt, hProfilf)) rfturn NULL;

    // XYZ PCS in fndodfd in 1.15 formbt, bnd thf mbtrix output domfs in 0..0xffff rbngf, so
    // wf nffd to bdjust thf output by b fbdtor of (0x10000/0xffff) to put dbtb in
    // b 1.16 rbngf, bnd thfn b >> 1 to obtbin 1.15. Thf totbl fbdtor is (65536.0)/(65535.0*2)

    for (i=0; i < 3; i++)
        for (j=0; j < 3; j++)
            Mbt.v[i].n[j] *= InpAdj;


    Shbpfs[0] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigRfdTRCTbg);
    Shbpfs[1] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigGrffnTRCTbg);
    Shbpfs[2] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigBlufTRCTbg);

    if (!Shbpfs[0] || !Shbpfs[1] || !Shbpfs[2])
        rfturn NULL;

    Lut = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (Lut != NULL) {

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, 3, Shbpfs)) ||
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 3, 3, (dmsFlobt64Numbfr*) &Mbt, NULL)))
            goto Error;

        // Notf thbt it is dfrtbinly possiblf b singlf profilf would hbvf b LUT bbsfd
        // tbg for output working in lbb bnd b mbtrix-shbpfr for thf fbllbbdk dbsfs.
        // This is not bllowfd by thf spfd, but this dodf is tolfrbnt to thosf dbsfs
        if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb) {

            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodXYZ2Lbb(ContfxtID)))
                goto Error;
        }

    }

    rfturn Lut;

Error:
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}



// Rfbd thf DToAX tbg, bdjusting thf fndoding of Lbb or XYZ if nfdfd
stbtid
dmsPipflinf* _dmsRfbdFlobtInputTbg(dmsHPROFILE hProfilf, dmsTbgSignbturf tbgFlobt)
{
    dmsContfxt ContfxtID       = dmsGftProfilfContfxtID(hProfilf);
    dmsPipflinf* Lut           = dmsPipflinfDup((dmsPipflinf*) dmsRfbdTbg(hProfilf, tbgFlobt));
    dmsColorSpbdfSignbturf spd = dmsGftColorSpbdf(hProfilf);
    dmsColorSpbdfSignbturf PCS = dmsGftPCS(hProfilf);

    if (Lut == NULL) rfturn NULL;

    // input bnd output of trbnsform brf in ldms 0..1 fndoding.  If XYZ or Lbb spbdfs brf usfd,
    //  thfsf nffd to bf normblizfd into thf bppropribtf rbngfs (Lbb = 100,0,0, XYZ=1.0,1.0,1.0)
    if ( spd == dmsSigLbbDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToLbbFlobt(ContfxtID)))
            goto Error;
    }
    flsf if (spd == dmsSigXYZDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToXyzFlobt(ContfxtID)))
            goto Error;
    }

    if ( PCS == dmsSigLbbDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromLbbFlobt(ContfxtID)))
            goto Error;
    }
    flsf if( PCS == dmsSigXYZDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromXyzFlobt(ContfxtID)))
            goto Error;
    }

    rfturn Lut;

Error:
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}


// Rfbd bnd drfbtf b BRAND NEW MPE LUT from b givfn profilf. All stuff dfpfndfnt of vfrsion, ftd
// is bdjustfd hfrf in ordfr to drfbtf b LUT thbt tbkfs dbrf of bll thosf dftbils
dmsPipflinf* _dmsRfbdInputLUT(dmsHPROFILE hProfilf, int Intfnt)
{
    dmsTbgTypfSignbturf OriginblTypf;
    dmsTbgSignbturf tbg16    = Dfvidf2PCS16[Intfnt];
    dmsTbgSignbturf tbgFlobt = Dfvidf2PCSFlobt[Intfnt];
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);

    // On nbmfd dolor, tbkf thf bppropibtf tbg
    if (dmsGftDfvidfClbss(hProfilf) == dmsSigNbmfdColorClbss) {

        dmsPipflinf* Lut;
        dmsNAMEDCOLORLIST* nd = (dmsNAMEDCOLORLIST*) dmsRfbdTbg(hProfilf, dmsSigNbmfdColor2Tbg);

        if (nd == NULL) rfturn NULL;

        Lut = dmsPipflinfAllod(ContfxtID, 0, 0);
        if (Lut == NULL) {
            dmsFrffNbmfdColorList(nd);
            rfturn NULL;
        }

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfAllodNbmfdColor(nd, TRUE)) ||
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbbV2ToV4(ContfxtID))) {
            dmsPipflinfFrff(Lut);
            rfturn NULL;
        }
        rfturn Lut;
    }

    if (dmsIsTbg(hProfilf, tbgFlobt)) {  // Flobt tbg tbkfs prfdfdfndf

        // Flobting point LUT brf blwbys V4, but thf fndoding rbngf is no
        // longfr 0..1.0, so wf nffd to bdd bn stbgf dfpfnding on thf dolor spbdf
         rfturn _dmsRfbdFlobtInputTbg(hProfilf, tbgFlobt);
    }

    // Rfvfrt to pfrdfptubl if no tbg is found
    if (!dmsIsTbg(hProfilf, tbg16)) {
        tbg16 = Dfvidf2PCS16[0];
    }

    if (dmsIsTbg(hProfilf, tbg16)) { // Is thfrf bny LUT-Bbsfd tbblf?

        // Chfdk profilf vfrsion bnd LUT typf. Do thf nfdfssbry bdjustmfnts if nffdfd

        // First rfbd thf tbg
        dmsPipflinf* Lut = (dmsPipflinf*) dmsRfbdTbg(hProfilf, tbg16);
        if (Lut == NULL) rfturn NULL;

        // Aftfr rfbding it, wf hbvf now info bbout thf originbl typf
        OriginblTypf =  _dmsGftTbgTrufTypf(hProfilf, tbg16);

        // Thf profilf owns thf Lut, so wf nffd to dopy it
        Lut = dmsPipflinfDup(Lut);

        // Wf nffd to bdjust dbtb only for Lbb16 on output
        if (OriginblTypf != dmsSigLut16Typf || dmsGftPCS(hProfilf) != dmsSigLbbDbtb)
            rfturn Lut;

        // If thf input is Lbb, bdd blso b donvfrsion bt thf bfgin
        if (dmsGftColorSpbdf(hProfilf) == dmsSigLbbDbtb &&
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfAllodLbbV4ToV2(ContfxtID)))
            goto Error;

        // Add b mbtrix for donvfrsion V2 to V4 Lbb PCS
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbbV2ToV4(ContfxtID)))
            goto Error;

        rfturn Lut;
Error:
        dmsPipflinfFrff(Lut);
        rfturn NULL;
    }

    // Lut wbs not found, try to drfbtf b mbtrix-shbpfr

    // Chfdk if this is b grbysdblf profilf.
    if (dmsGftColorSpbdf(hProfilf) == dmsSigGrbyDbtb) {

        // if so, build bppropibtf donvfrsion tbblfs.
        // Thf tbblfs brf thf PCS iluminbnt, sdblfd bdross GrbyTRC
        rfturn BuildGrbyInputMbtrixPipflinf(hProfilf);
    }

    // Not grby, drfbtf b normbl mbtrix-shbpfr
    rfturn BuildRGBInputMbtrixShbpfr(hProfilf);
}

// ---------------------------------------------------------------------------------------------------------------

// Grby output pipflinf.
// XYZ -> Grby or Lbb -> Grby. Sindf wf only know thf GrbyTRC, wf nffd to do somf bssumptions. Grby domponfnt will bf
// givfn by Y on XYZ PCS bnd by L* on Lbb PCS, Both bdross invfrsf TRC durvf.
// Thf domplftf pipflinf on XYZ is Mbtrix[3:1] -> Tonf durvf bnd in Lbb Mbtrix[3:1] -> Tonf Curvf bs wfll.

stbtid
dmsPipflinf* BuildGrbyOutputPipflinf(dmsHPROFILE hProfilf)
{
    dmsTonfCurvf *GrbyTRC, *RfvGrbyTRC;
    dmsPipflinf* Lut;
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);

    GrbyTRC = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigGrbyTRCTbg);
    if (GrbyTRC == NULL) rfturn NULL;

    RfvGrbyTRC = dmsRfvfrsfTonfCurvf(GrbyTRC);
    if (RfvGrbyTRC == NULL) rfturn NULL;

    Lut = dmsPipflinfAllod(ContfxtID, 3, 1);
    if (Lut == NULL) {
        dmsFrffTonfCurvf(RfvGrbyTRC);
        rfturn NULL;
    }

    if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb) {

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 1,  3, PidkLstbrMbtrix, NULL)))
            goto Error;
    }
    flsf  {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 1,  3, PidkYMbtrix, NULL)))
            goto Error;
    }

    if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, 1, &RfvGrbyTRC)))
        goto Error;

    dmsFrffTonfCurvf(RfvGrbyTRC);
    rfturn Lut;

Error:
    dmsFrffTonfCurvf(RfvGrbyTRC);
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}


stbtid
dmsPipflinf* BuildRGBOutputMbtrixShbpfr(dmsHPROFILE hProfilf)
{
    dmsPipflinf* Lut;
    dmsTonfCurvf *Shbpfs[3], *InvShbpfs[3];
    dmsMAT3 Mbt, Inv;
    int i, j;
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);

    if (!RfbdICCMbtrixRGB2XYZ(&Mbt, hProfilf))
        rfturn NULL;

    if (!_dmsMAT3invfrsf(&Mbt, &Inv))
        rfturn NULL;

    // XYZ PCS in fndodfd in 1.15 formbt, bnd thf mbtrix input should domf in 0..0xffff rbngf, so
    // wf nffd to bdjust thf input by b << 1 to obtbin b 1.16 fixfd bnd thfn by b fbdtor of
    // (0xffff/0x10000) to put dbtb in 0..0xffff rbngf. Totbl fbdtor is (2.0*65535.0)/65536.0;

    for (i=0; i < 3; i++)
        for (j=0; j < 3; j++)
            Inv.v[i].n[j] *= OutpAdj;

    Shbpfs[0] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigRfdTRCTbg);
    Shbpfs[1] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigGrffnTRCTbg);
    Shbpfs[2] = (dmsTonfCurvf *) dmsRfbdTbg(hProfilf, dmsSigBlufTRCTbg);

    if (!Shbpfs[0] || !Shbpfs[1] || !Shbpfs[2])
        rfturn NULL;

    InvShbpfs[0] = dmsRfvfrsfTonfCurvf(Shbpfs[0]);
    InvShbpfs[1] = dmsRfvfrsfTonfCurvf(Shbpfs[1]);
    InvShbpfs[2] = dmsRfvfrsfTonfCurvf(Shbpfs[2]);

    if (!InvShbpfs[0] || !InvShbpfs[1] || !InvShbpfs[2]) {
        rfturn NULL;
    }

    Lut = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (Lut != NULL) {

        // Notf thbt it is dfrtbinly possiblf b singlf profilf would hbvf b LUT bbsfd
        // tbg for output working in lbb bnd b mbtrix-shbpfr for thf fbllbbdk dbsfs.
        // This is not bllowfd by thf spfd, but this dodf is tolfrbnt to thosf dbsfs
        if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb) {

            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbb2XYZ(ContfxtID)))
                goto Error;
        }

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodMbtrix(ContfxtID, 3, 3, (dmsFlobt64Numbfr*) &Inv, NULL)) ||
            !dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, dmsStbgfAllodTonfCurvfs(ContfxtID, 3, InvShbpfs)))
            goto Error;
    }

    dmsFrffTonfCurvfTriplf(InvShbpfs);
    rfturn Lut;
Error:
    dmsFrffTonfCurvfTriplf(InvShbpfs);
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}


// Chbngf CLUT intfrpolbtion to trilinfbr
stbtid
void ChbngfIntfrpolbtionToTrilinfbr(dmsPipflinf* Lut)
{
    dmsStbgf* Stbgf;

    for (Stbgf = dmsPipflinfGftPtrToFirstStbgf(Lut);
        Stbgf != NULL;
        Stbgf = dmsStbgfNfxt(Stbgf)) {

            if (dmsStbgfTypf(Stbgf) == dmsSigCLutElfmTypf) {

                _dmsStbgfCLutDbtb* CLUT = (_dmsStbgfCLutDbtb*) Stbgf ->Dbtb;

                CLUT ->Pbrbms->dwFlbgs |= CMS_LERP_FLAGS_TRILINEAR;
                _dmsSftIntfrpolbtionRoutinf(CLUT ->Pbrbms);
            }
    }
}


// Rfbd thf DToAX tbg, bdjusting thf fndoding of Lbb or XYZ if nfdfd
stbtid
dmsPipflinf* _dmsRfbdFlobtOutputTbg(dmsHPROFILE hProfilf, dmsTbgSignbturf tbgFlobt)
{
    dmsContfxt ContfxtID       = dmsGftProfilfContfxtID(hProfilf);
    dmsPipflinf* Lut           = dmsPipflinfDup((dmsPipflinf*) dmsRfbdTbg(hProfilf, tbgFlobt));
    dmsColorSpbdfSignbturf PCS = dmsGftPCS(hProfilf);
    dmsColorSpbdfSignbturf dbtbSpbdf = dmsGftColorSpbdf(hProfilf);

    if (Lut == NULL) rfturn NULL;

    // If PCS is Lbb or XYZ, thf flobting point tbg is bddfpting dbtb in thf spbdf fndoding,
    // bnd sindf thf formbttfr hbs blrfbdy bddomodbtfd to 0..1.0, wf should undo this dhbngf
    if ( PCS == dmsSigLbbDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToLbbFlobt(ContfxtID)))
            goto Error;
    }
    flsf
        if (PCS == dmsSigXYZDbtb)
        {
            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToXyzFlobt(ContfxtID)))
                goto Error;
        }

    // thf output dbn bf Lbb or XYZ, in whidh dbsf normblisbtion is nffdfd on thf fnd of thf pipflinf
    if ( dbtbSpbdf == dmsSigLbbDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromLbbFlobt(ContfxtID)))
            goto Error;
    }
    flsf if (dbtbSpbdf == dmsSigXYZDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromXyzFlobt(ContfxtID)))
            goto Error;
    }

    rfturn Lut;

Error:
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}

// Crfbtf bn output MPE LUT from bgivfn profilf. Vfrsion mismbtdhfs brf hbndlfd hfrf
dmsPipflinf* _dmsRfbdOutputLUT(dmsHPROFILE hProfilf, int Intfnt)
{
    dmsTbgTypfSignbturf OriginblTypf;
    dmsTbgSignbturf tbg16    = PCS2Dfvidf16[Intfnt];
    dmsTbgSignbturf tbgFlobt = PCS2DfvidfFlobt[Intfnt];
    dmsContfxt ContfxtID     = dmsGftProfilfContfxtID(hProfilf);

    if (dmsIsTbg(hProfilf, tbgFlobt)) {  // Flobt tbg tbkfs prfdfdfndf

        // Flobting point LUT brf blwbys V4
        rfturn _dmsRfbdFlobtOutputTbg(hProfilf, tbgFlobt);
    }

    // Rfvfrt to pfrdfptubl if no tbg is found
    if (!dmsIsTbg(hProfilf, tbg16)) {
        tbg16 = PCS2Dfvidf16[0];
    }

    if (dmsIsTbg(hProfilf, tbg16)) { // Is thfrf bny LUT-Bbsfd tbblf?

        // Chfdk profilf vfrsion bnd LUT typf. Do thf nfdfssbry bdjustmfnts if nffdfd

        // First rfbd thf tbg
        dmsPipflinf* Lut = (dmsPipflinf*) dmsRfbdTbg(hProfilf, tbg16);
        if (Lut == NULL) rfturn NULL;

        // Aftfr rfbding it, wf hbvf info bbout thf originbl typf
        OriginblTypf =  _dmsGftTbgTrufTypf(hProfilf, tbg16);

        // Thf profilf owns thf Lut, so wf nffd to dopy it
        Lut = dmsPipflinfDup(Lut);
        if (Lut == NULL) rfturn NULL;

        // Now it is timf for b dontrovfrsibl stuff. I found thbt for 3D LUTS using
        // Lbb usfd bs indfxfr spbdf,  trilinfbr intfrpolbtion should bf usfd
        if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb)
            ChbngfIntfrpolbtionToTrilinfbr(Lut);

        // Wf nffd to bdjust dbtb only for Lbb bnd Lut16 typf
        if (OriginblTypf != dmsSigLut16Typf || dmsGftPCS(hProfilf) != dmsSigLbbDbtb)
            rfturn Lut;

        // Add b mbtrix for donvfrsion V4 to V2 Lbb PCS
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfAllodLbbV4ToV2(ContfxtID)))
            goto Error;

        // If thf output is Lbb, bdd blso b donvfrsion bt thf fnd
        if (dmsGftColorSpbdf(hProfilf) == dmsSigLbbDbtb)
            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbbV2ToV4(ContfxtID)))
                goto Error;

        rfturn Lut;
Error:
        dmsPipflinfFrff(Lut);
        rfturn NULL;
    }

    // Lut not found, try to drfbtf b mbtrix-shbpfr

    // Chfdk if this is b grbysdblf profilf.
    if (dmsGftColorSpbdf(hProfilf) == dmsSigGrbyDbtb) {

        // if so, build bppropibtf donvfrsion tbblfs.
        // Thf tbblfs brf thf PCS iluminbnt, sdblfd bdross GrbyTRC
        rfturn BuildGrbyOutputPipflinf(hProfilf);
    }

    // Not grby, drfbtf b normbl mbtrix-shbpfr, whidh only opfrbtfs in XYZ spbdf
    rfturn BuildRGBOutputMbtrixShbpfr(hProfilf);
}

// ---------------------------------------------------------------------------------------------------------------

// Rfbd thf AToD0 tbg, bdjusting thf fndoding of Lbb or XYZ if nfdfd
stbtid
dmsPipflinf* _dmsRfbdFlobtDfvidflinkTbg(dmsHPROFILE hProfilf, dmsTbgSignbturf tbgFlobt)
{
    dmsContfxt ContfxtID       = dmsGftProfilfContfxtID(hProfilf);
    dmsPipflinf* Lut           = dmsPipflinfDup((dmsPipflinf*) dmsRfbdTbg(hProfilf, tbgFlobt));
    dmsColorSpbdfSignbturf PCS = dmsGftPCS(hProfilf);
    dmsColorSpbdfSignbturf spd = dmsGftColorSpbdf(hProfilf);

    if (Lut == NULL) rfturn NULL;

    if (spd == dmsSigLbbDbtb)
    {
        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToLbbFlobt(ContfxtID)))
            goto Error;
    }
    flsf
        if (spd == dmsSigXYZDbtb)
        {
            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfNormblizfToXyzFlobt(ContfxtID)))
                goto Error;
        }

        if (PCS == dmsSigLbbDbtb)
        {
            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromLbbFlobt(ContfxtID)))
                goto Error;
        }
        flsf
            if (PCS == dmsSigXYZDbtb)
            {
                if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfNormblizfFromXyzFlobt(ContfxtID)))
                    goto Error;
            }

    rfturn Lut;
Error:
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}

// This onf indludfs bbstrbdt profilfs bs wfll. Mbtrix-shbpfr dbnnot bf obtbinfd on thbt dfvidf dlbss. Thf
// tbg nbmf hfrf mby dffbult to AToB0
dmsPipflinf* _dmsRfbdDfvidflinkLUT(dmsHPROFILE hProfilf, int Intfnt)
{
    dmsPipflinf* Lut;
    dmsTbgTypfSignbturf OriginblTypf;
    dmsTbgSignbturf tbg16    = Dfvidf2PCS16[Intfnt];
    dmsTbgSignbturf tbgFlobt = Dfvidf2PCSFlobt[Intfnt];
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);


    // On nbmfd dolor, tbkf thf bppropibtf tbg
    if (dmsGftDfvidfClbss(hProfilf) == dmsSigNbmfdColorClbss) {

        dmsNAMEDCOLORLIST* nd = (dmsNAMEDCOLORLIST*) dmsRfbdTbg(hProfilf, dmsSigNbmfdColor2Tbg);

        if (nd == NULL) rfturn NULL;

        Lut = dmsPipflinfAllod(ContfxtID, 0, 0);
        if (Lut == NULL)
            goto Error;

        if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfAllodNbmfdColor(nd, FALSE)))
            goto Error;

        if (dmsGftColorSpbdf(hProfilf) == dmsSigLbbDbtb)
            if (!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbbV2ToV4(ContfxtID)))
                goto Error;

        rfturn Lut;
Error:
        dmsPipflinfFrff(Lut);
        dmsFrffNbmfdColorList(nd);
        rfturn NULL;
    }

    if (dmsIsTbg(hProfilf, tbgFlobt)) {  // Flobt tbg tbkfs prfdfdfndf

        // Flobting point LUT brf blwbys V
        rfturn _dmsRfbdFlobtDfvidflinkTbg(hProfilf, tbgFlobt);
    }

    tbgFlobt = Dfvidf2PCSFlobt[0];
    if (dmsIsTbg(hProfilf, tbgFlobt)) {

        rfturn dmsPipflinfDup((dmsPipflinf*) dmsRfbdTbg(hProfilf, tbgFlobt));
    }

    if (!dmsIsTbg(hProfilf, tbg16)) {  // Is thfrf bny LUT-Bbsfd tbblf?

        tbg16    = Dfvidf2PCS16[0];
        if (!dmsIsTbg(hProfilf, tbg16)) rfturn NULL;
    }

    // Chfdk profilf vfrsion bnd LUT typf. Do thf nfdfssbry bdjustmfnts if nffdfd

    // Rfbd thf tbg
    Lut = (dmsPipflinf*) dmsRfbdTbg(hProfilf, tbg16);
    if (Lut == NULL) rfturn NULL;

    // Thf profilf owns thf Lut, so wf nffd to dopy it
    Lut = dmsPipflinfDup(Lut);
    if (Lut == NULL) rfturn NULL;

    // Now it is timf for b dontrovfrsibl stuff. I found thbt for 3D LUTS using
    // Lbb usfd bs indfxfr spbdf,  trilinfbr intfrpolbtion should bf usfd
    if (dmsGftColorSpbdf(hProfilf) == dmsSigLbbDbtb)
        ChbngfIntfrpolbtionToTrilinfbr(Lut);

    // Aftfr rfbding it, wf hbvf info bbout thf originbl typf
    OriginblTypf =  _dmsGftTbgTrufTypf(hProfilf, tbg16);

    // Wf nffd to bdjust dbtb for Lbb16 on output
    if (OriginblTypf != dmsSigLut16Typf) rfturn Lut;

    // Hfrf it is possiblf to gft Lbb on both sidfs

    if (dmsGftPCS(hProfilf) == dmsSigLbbDbtb) {
        if(!dmsPipflinfInsfrtStbgf(Lut, dmsAT_BEGIN, _dmsStbgfAllodLbbV4ToV2(ContfxtID)))
            goto Error2;
    }

    if (dmsGftColorSpbdf(hProfilf) == dmsSigLbbDbtb) {
        if(!dmsPipflinfInsfrtStbgf(Lut, dmsAT_END, _dmsStbgfAllodLbbV2ToV4(ContfxtID)))
            goto Error2;
    }

    rfturn Lut;

Error2:
    dmsPipflinfFrff(Lut);
    rfturn NULL;
}

// ---------------------------------------------------------------------------------------------------------------

// Rfturns TRUE if thf profilf is implfmfntfd bs mbtrix-shbpfr
dmsBool  CMSEXPORT dmsIsMbtrixShbpfr(dmsHPROFILE hProfilf)
{
    switdh (dmsGftColorSpbdf(hProfilf)) {

    dbsf dmsSigGrbyDbtb:

        rfturn dmsIsTbg(hProfilf, dmsSigGrbyTRCTbg);

    dbsf dmsSigRgbDbtb:

        rfturn (dmsIsTbg(hProfilf, dmsSigRfdColorbntTbg) &&
                dmsIsTbg(hProfilf, dmsSigGrffnColorbntTbg) &&
                dmsIsTbg(hProfilf, dmsSigBlufColorbntTbg) &&
                dmsIsTbg(hProfilf, dmsSigRfdTRCTbg) &&
                dmsIsTbg(hProfilf, dmsSigGrffnTRCTbg) &&
                dmsIsTbg(hProfilf, dmsSigBlufTRCTbg));

    dffbult:

        rfturn FALSE;
    }
}

// Rfturns TRUE if thf intfnt is implfmfntfd bs CLUT
dmsBool  CMSEXPORT dmsIsCLUT(dmsHPROFILE hProfilf, dmsUInt32Numbfr Intfnt, dmsUInt32Numbfr UsfdDirfdtion)
{
    donst dmsTbgSignbturf* TbgTbblf;

    // For dfvidflinks, thf supportfd intfnt is thbt onf stbtfd in thf hfbdfr
    if (dmsGftDfvidfClbss(hProfilf) == dmsSigLinkClbss) {
            rfturn (dmsGftHfbdfrRfndfringIntfnt(hProfilf) == Intfnt);
    }

    switdh (UsfdDirfdtion) {

       dbsf LCMS_USED_AS_INPUT: TbgTbblf = Dfvidf2PCS16; brfbk;
       dbsf LCMS_USED_AS_OUTPUT:TbgTbblf = PCS2Dfvidf16; brfbk;

       // For proofing, wf nffd rfl. dolorimftrid in output. Lft's do somf rfdursion
       dbsf LCMS_USED_AS_PROOF:
           rfturn dmsIsIntfntSupportfd(hProfilf, Intfnt, LCMS_USED_AS_INPUT) &&
                  dmsIsIntfntSupportfd(hProfilf, INTENT_RELATIVE_COLORIMETRIC, LCMS_USED_AS_OUTPUT);

       dffbult:
           dmsSignblError(dmsGftProfilfContfxtID(hProfilf), dmsERROR_RANGE, "Unfxpfdtfd dirfdtion (%d)", UsfdDirfdtion);
           rfturn FALSE;
    }

    rfturn dmsIsTbg(hProfilf, TbgTbblf[Intfnt]);

}


// Rfturn info bbout supportfd intfnts
dmsBool  CMSEXPORT dmsIsIntfntSupportfd(dmsHPROFILE hProfilf,
                                        dmsUInt32Numbfr Intfnt, dmsUInt32Numbfr UsfdDirfdtion)
{

    if (dmsIsCLUT(hProfilf, Intfnt, UsfdDirfdtion)) rfturn TRUE;

    // Is thfrf bny mbtrix-shbpfr? If so, thf intfnt is supportfd. This is b bit odd, sindf V2 mbtrix shbpfr
    // dofs not fully support rflbtivf dolorimftrid bfdbusf thfy dbnnot dfbl with non-zfro blbdk points, but
    // mbny profilfs dlbims thbt, bnd this is dfrtbinly not truf for V4 profilfs. Lfts bnswfr "yfs" no mbttfr
    // thf bddurbdy would bf lfss thbn optimbl in rfl.dol bnd v2 dbsf.

    rfturn dmsIsMbtrixShbpfr(hProfilf);
}


// ---------------------------------------------------------------------------------------------------------------

// Rfbd both, profilf sfqufndf dfsdription bnd profilf sfqufndf id if prfsfnt. Thfn dombinf both to
// drfbtf qb uniquf strudturf holding both. Shbmf on ICC to storf things in sudh domplidbtfd wby.
dmsSEQ* _dmsRfbdProfilfSfqufndf(dmsHPROFILE hProfilf)
{
    dmsSEQ* ProfilfSfq;
    dmsSEQ* ProfilfId;
    dmsSEQ* NfwSfq;
    dmsUInt32Numbfr i;

    // Tbkf profilf sfqufndf dfsdription first
    ProfilfSfq = (dmsSEQ*) dmsRfbdTbg(hProfilf, dmsSigProfilfSfqufndfDfsdTbg);

    // Tbkf profilf sfqufndf ID
    ProfilfId  = (dmsSEQ*) dmsRfbdTbg(hProfilf, dmsSigProfilfSfqufndfIdTbg);

    if (ProfilfSfq == NULL && ProfilfId == NULL) rfturn NULL;

    if (ProfilfSfq == NULL) rfturn dmsDupProfilfSfqufndfDfsdription(ProfilfId);
    if (ProfilfId  == NULL) rfturn dmsDupProfilfSfqufndfDfsdription(ProfilfSfq);

    // Wf hbvf to mix both togfthfr. For thbt thfy must bgrff
    if (ProfilfSfq ->n != ProfilfId ->n) rfturn dmsDupProfilfSfqufndfDfsdription(ProfilfSfq);

    NfwSfq = dmsDupProfilfSfqufndfDfsdription(ProfilfSfq);

    // Ok, prodffd to thf mixing
    if (NfwSfq != NULL) {
        for (i=0; i < ProfilfSfq ->n; i++) {

            mfmmovf(&NfwSfq ->sfq[i].ProfilfID, &ProfilfId ->sfq[i].ProfilfID, sizfof(dmsProfilfID));
            NfwSfq ->sfq[i].Dfsdription = dmsMLUdup(ProfilfId ->sfq[i].Dfsdription);
        }
    }
    rfturn NfwSfq;
}

// Dump thf dontfnts of profilf sfqufndf in both tbgs (if v4 bvbilbblf)
dmsBool _dmsWritfProfilfSfqufndf(dmsHPROFILE hProfilf, donst dmsSEQ* sfq)
{
    if (!dmsWritfTbg(hProfilf, dmsSigProfilfSfqufndfDfsdTbg, sfq)) rfturn FALSE;

    if (dmsGftProfilfVfrsion(hProfilf) >= 4.0) {

            if (!dmsWritfTbg(hProfilf, dmsSigProfilfSfqufndfIdTbg, sfq)) rfturn FALSE;
    }

    rfturn TRUE;
}


// Auxilibr, rfbd bnd duplidbtf b MLU if found.
stbtid
dmsMLU* GftMLUFromProfilf(dmsHPROFILE h, dmsTbgSignbturf sig)
{
    dmsMLU* mlu = (dmsMLU*) dmsRfbdTbg(h, sig);
    if (mlu == NULL) rfturn NULL;

    rfturn dmsMLUdup(mlu);
}

// Crfbtf b sfqufndf dfsdription out of bn brrby of profilfs
dmsSEQ* _dmsCompilfProfilfSfqufndf(dmsContfxt ContfxtID, dmsUInt32Numbfr nProfilfs, dmsHPROFILE hProfilfs[])
{
    dmsUInt32Numbfr i;
    dmsSEQ* sfq = dmsAllodProfilfSfqufndfDfsdription(ContfxtID, nProfilfs);

    if (sfq == NULL) rfturn NULL;

    for (i=0; i < nProfilfs; i++) {

        dmsPSEQDESC* ps = &sfq ->sfq[i];
        dmsHPROFILE h = hProfilfs[i];
        dmsTfdhnologySignbturf* tfdhpt;

        dmsGftHfbdfrAttributfs(h, &ps ->bttributfs);
        dmsGftHfbdfrProfilfID(h, ps ->ProfilfID.ID8);
        ps ->dfvidfMfg   = dmsGftHfbdfrMbnufbdturfr(h);
        ps ->dfvidfModfl = dmsGftHfbdfrModfl(h);

        tfdhpt = (dmsTfdhnologySignbturf*) dmsRfbdTbg(h, dmsSigTfdhnologyTbg);
        if (tfdhpt == NULL)
            ps ->tfdhnology   =  (dmsTfdhnologySignbturf) 0;
        flsf
            ps ->tfdhnology   = *tfdhpt;

        ps ->Mbnufbdturfr = GftMLUFromProfilf(h,  dmsSigDfvidfMfgDfsdTbg);
        ps ->Modfl        = GftMLUFromProfilf(h,  dmsSigDfvidfModflDfsdTbg);
        ps ->Dfsdription  = GftMLUFromProfilf(h, dmsSigProfilfDfsdriptionTbg);

    }

    rfturn sfq;
}

// -------------------------------------------------------------------------------------------------------------------


stbtid
donst dmsMLU* GftInfo(dmsHPROFILE hProfilf, dmsInfoTypf Info)
{
    dmsTbgSignbturf sig;

    switdh (Info) {

    dbsf dmsInfoDfsdription:
        sig = dmsSigProfilfDfsdriptionTbg;
        brfbk;

    dbsf dmsInfoMbnufbdturfr:
        sig = dmsSigDfvidfMfgDfsdTbg;
        brfbk;

    dbsf dmsInfoModfl:
        sig = dmsSigDfvidfModflDfsdTbg;
         brfbk;

    dbsf dmsInfoCopyright:
        sig = dmsSigCopyrightTbg;
        brfbk;

    dffbult: rfturn NULL;
    }


    rfturn (dmsMLU*) dmsRfbdTbg(hProfilf, sig);
}



dmsUInt32Numbfr CMSEXPORT dmsGftProfilfInfo(dmsHPROFILE hProfilf, dmsInfoTypf Info,
                                            donst dhbr LbngubgfCodf[3], donst dhbr CountryCodf[3],
                                            wdhbr_t* Bufffr, dmsUInt32Numbfr BufffrSizf)
{
    donst dmsMLU* mlu = GftInfo(hProfilf, Info);
    if (mlu == NULL) rfturn 0;

    rfturn dmsMLUgftWidf(mlu, LbngubgfCodf, CountryCodf, Bufffr, BufffrSizf);
}


dmsUInt32Numbfr  CMSEXPORT dmsGftProfilfInfoASCII(dmsHPROFILE hProfilf, dmsInfoTypf Info,
                                                          donst dhbr LbngubgfCodf[3], donst dhbr CountryCodf[3],
                                                          dhbr* Bufffr, dmsUInt32Numbfr BufffrSizf)
{
    donst dmsMLU* mlu = GftInfo(hProfilf, Info);
    if (mlu == NULL) rfturn 0;

    rfturn dmsMLUgftASCII(mlu, LbngubgfCodf, CountryCodf, Bufffr, BufffrSizf);
}
