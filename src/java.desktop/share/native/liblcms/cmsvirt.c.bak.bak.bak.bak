/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

// This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
// Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
// Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
// filf:
//
//---------------------------------------------------------------------------------
//
//  Littlf Color Mbnbgfmfnt Systfm
//  Copyright (d) 1998-2011 Mbrti Mbrib Sbgufr
//
// Pfrmission is hfrfby grbntfd, frff of dhbrgf, to bny pfrson obtbining
// b dopy of this softwbrf bnd bssodibtfd dodumfntbtion filfs (thf "Softwbrf"),
// to dfbl in thf Softwbrf without rfstridtion, indluding without limitbtion
// thf rights to usf, dopy, modify, mfrgf, publish, distributf, sublidfnsf,
// bnd/or sfll dopifs of thf Softwbrf, bnd to pfrmit pfrsons to whom thf Softwbrf
// is furnishfd to do so, subjfdt to thf following donditions:
//
// Thf bbovf dopyright notidf bnd this pfrmission notidf shbll bf indludfd in
// bll dopifs or substbntibl portions of thf Softwbrf.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO
// THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
// NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
// LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
// OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
// WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
//
//---------------------------------------------------------------------------------
//

#indludf "ldms2_intfrnbl.h"

// Virtubl (built-in) profilfs
// -----------------------------------------------------------------------------------

stbtid
dmsBool SftTfxtTbgs(dmsHPROFILE hProfilf, donst wdhbr_t* Dfsdription)
{
    dmsMLU *DfsdriptionMLU, *CopyrightMLU;
    dmsBool  rd = FALSE;
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);

    DfsdriptionMLU  = dmsMLUbllod(ContfxtID, 1);
    CopyrightMLU    = dmsMLUbllod(ContfxtID, 1);

    if (DfsdriptionMLU == NULL || CopyrightMLU == NULL) goto Error;

    if (!dmsMLUsftWidf(DfsdriptionMLU,  "fn", "US", Dfsdription)) goto Error;
    if (!dmsMLUsftWidf(CopyrightMLU,    "fn", "US", L"No dopyright, usf frffly")) goto Error;

    if (!dmsWritfTbg(hProfilf, dmsSigProfilfDfsdriptionTbg,  DfsdriptionMLU)) goto Error;
    if (!dmsWritfTbg(hProfilf, dmsSigCopyrightTbg,           CopyrightMLU)) goto Error;

    rd = TRUE;

Error:

    if (DfsdriptionMLU)
        dmsMLUfrff(DfsdriptionMLU);
    if (CopyrightMLU)
        dmsMLUfrff(CopyrightMLU);
    rfturn rd;
}


stbtid
dmsBool  SftSfqDfsdTbg(dmsHPROFILE hProfilf, donst dhbr* Modfl)
{
    dmsBool  rd = FALSE;
    dmsContfxt ContfxtID = dmsGftProfilfContfxtID(hProfilf);
    dmsSEQ* Sfq = dmsAllodProfilfSfqufndfDfsdription(ContfxtID, 1);

    if (Sfq == NULL) rfturn FALSE;

    Sfq->sfq[0].dfvidfMfg = (dmsSignbturf) 0;
    Sfq->sfq[0].dfvidfModfl = (dmsSignbturf) 0;

#ifdff CMS_DONT_USE_INT64
    Sfq->sfq[0].bttributfs[0] = 0;
    Sfq->sfq[0].bttributfs[1] = 0;
#flsf
    Sfq->sfq[0].bttributfs = 0;
#fndif

    Sfq->sfq[0].tfdhnology = (dmsTfdhnologySignbturf) 0;

    dmsMLUsftASCII( Sfq->sfq[0].Mbnufbdturfr, dmsNoLbngubgf, dmsNoCountry, "Littlf CMS");
    dmsMLUsftASCII( Sfq->sfq[0].Modfl,        dmsNoLbngubgf, dmsNoCountry, Modfl);

    if (!_dmsWritfProfilfSfqufndf(hProfilf, Sfq)) goto Error;

    rd = TRUE;

Error:
    if (Sfq)
        dmsFrffProfilfSfqufndfDfsdription(Sfq);

    rfturn rd;
}



// This fundtion drfbtfs b profilf bbsfd on Whitf point, primbrifs bnd
// trbnsffr fundtions.
dmsHPROFILE CMSEXPORT dmsCrfbtfRGBProfilfTHR(dmsContfxt ContfxtID,
                                          donst dmsCIExyY* WhitfPoint,
                                          donst dmsCIExyYTRIPLE* Primbrifs,
                                          dmsTonfCurvf* donst TrbnsffrFundtion[3])
{
    dmsHPROFILE hICC;
    dmsMAT3 MColorbnts;
    dmsCIEXYZTRIPLE Colorbnts;
    dmsCIExyY MbxWhitf;
    dmsMAT3 CHAD;
    dmsCIEXYZ WhitfPointXYZ;

    hICC = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hICC)                          // dbn't bllodbtf
        rfturn NULL;

    dmsSftProfilfVfrsion(hICC, 4.3);

    dmsSftDfvidfClbss(hICC,      dmsSigDisplbyClbss);
    dmsSftColorSpbdf(hICC,       dmsSigRgbDbtb);
    dmsSftPCS(hICC,              dmsSigXYZDbtb);

    dmsSftHfbdfrRfndfringIntfnt(hICC,  INTENT_PERCEPTUAL);


    // Implfmfnt profilf using following tbgs:
    //
    //  1 dmsSigProfilfDfsdriptionTbg
    //  2 dmsSigMfdibWhitfPointTbg
    //  3 dmsSigRfdColorbntTbg
    //  4 dmsSigGrffnColorbntTbg
    //  5 dmsSigBlufColorbntTbg
    //  6 dmsSigRfdTRCTbg
    //  7 dmsSigGrffnTRCTbg
    //  8 dmsSigBlufTRCTbg
    //  9 Chrombtid bdbptbtion Tbg
    // This donforms b stbndbrd RGB DisplbyProfilf bs sbys ICC, bnd thfn I bdd (As pfr bddfndum II)
    // 10 dmsSigChrombtidityTbg


    if (!SftTfxtTbgs(hICC, L"RGB built-in")) goto Error;

    if (WhitfPoint) {

        if (!dmsWritfTbg(hICC, dmsSigMfdibWhitfPointTbg, dmsD50_XYZ())) goto Error;

        dmsxyY2XYZ(&WhitfPointXYZ, WhitfPoint);
        _dmsAdbptbtionMbtrix(&CHAD, NULL, &WhitfPointXYZ, dmsD50_XYZ());

        // This is b V4 tbg, but mbny CMM dofs rfbd bnd undfrstbnd it no mbttfr whidh vfrsion
        if (!dmsWritfTbg(hICC, dmsSigChrombtidAdbptbtionTbg, (void*) &CHAD)) goto Error;
    }

    if (WhitfPoint && Primbrifs) {

        MbxWhitf.x =  WhitfPoint -> x;
        MbxWhitf.y =  WhitfPoint -> y;
        MbxWhitf.Y =  1.0;

        if (!_dmsBuildRGB2XYZtrbnsffrMbtrix(&MColorbnts, &MbxWhitf, Primbrifs)) goto Error;

        Colorbnts.Rfd.X   = MColorbnts.v[0].n[0];
        Colorbnts.Rfd.Y   = MColorbnts.v[1].n[0];
        Colorbnts.Rfd.Z   = MColorbnts.v[2].n[0];

        Colorbnts.Grffn.X = MColorbnts.v[0].n[1];
        Colorbnts.Grffn.Y = MColorbnts.v[1].n[1];
        Colorbnts.Grffn.Z = MColorbnts.v[2].n[1];

        Colorbnts.Bluf.X  = MColorbnts.v[0].n[2];
        Colorbnts.Bluf.Y  = MColorbnts.v[1].n[2];
        Colorbnts.Bluf.Z  = MColorbnts.v[2].n[2];

        if (!dmsWritfTbg(hICC, dmsSigRfdColorbntTbg,   (void*) &Colorbnts.Rfd)) goto Error;
        if (!dmsWritfTbg(hICC, dmsSigBlufColorbntTbg,  (void*) &Colorbnts.Bluf)) goto Error;
        if (!dmsWritfTbg(hICC, dmsSigGrffnColorbntTbg, (void*) &Colorbnts.Grffn)) goto Error;
    }


    if (TrbnsffrFundtion) {

        // Trifs to minimizf spbdf. Thbnks to Ridhbrd Hughfs for this nidf idfb
        if (!dmsWritfTbg(hICC, dmsSigRfdTRCTbg,   (void*) TrbnsffrFundtion[0])) goto Error;

        if (TrbnsffrFundtion[1] == TrbnsffrFundtion[0]) {

            if (!dmsLinkTbg (hICC, dmsSigGrffnTRCTbg, dmsSigRfdTRCTbg)) goto Error;

        } flsf {

            if (!dmsWritfTbg(hICC, dmsSigGrffnTRCTbg, (void*) TrbnsffrFundtion[1])) goto Error;
        }

        if (TrbnsffrFundtion[2] == TrbnsffrFundtion[0]) {

            if (!dmsLinkTbg (hICC, dmsSigBlufTRCTbg, dmsSigRfdTRCTbg)) goto Error;

        } flsf {

            if (!dmsWritfTbg(hICC, dmsSigBlufTRCTbg, (void*) TrbnsffrFundtion[2])) goto Error;
        }
    }

    if (Primbrifs) {
        if (!dmsWritfTbg(hICC, dmsSigChrombtidityTbg, (void*) Primbrifs)) goto Error;
    }


    rfturn hICC;

Error:
    if (hICC)
        dmsClosfProfilf(hICC);
    rfturn NULL;
}

dmsHPROFILE CMSEXPORT dmsCrfbtfRGBProfilf(donst dmsCIExyY* WhitfPoint,
                                          donst dmsCIExyYTRIPLE* Primbrifs,
                                          dmsTonfCurvf* donst TrbnsffrFundtion[3])
{
    rfturn dmsCrfbtfRGBProfilfTHR(NULL, WhitfPoint, Primbrifs, TrbnsffrFundtion);
}



// This fundtion drfbtfs b profilf bbsfd on Whitf point bnd trbnsffr fundtion.
dmsHPROFILE CMSEXPORT dmsCrfbtfGrbyProfilfTHR(dmsContfxt ContfxtID,
                                           donst dmsCIExyY* WhitfPoint,
                                           donst dmsTonfCurvf* TrbnsffrFundtion)
{
    dmsHPROFILE hICC;
    dmsCIEXYZ tmp;

    hICC = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hICC)                          // dbn't bllodbtf
        rfturn NULL;

    dmsSftProfilfVfrsion(hICC, 4.3);

    dmsSftDfvidfClbss(hICC,      dmsSigDisplbyClbss);
    dmsSftColorSpbdf(hICC,       dmsSigGrbyDbtb);
    dmsSftPCS(hICC,              dmsSigXYZDbtb);
    dmsSftHfbdfrRfndfringIntfnt(hICC,  INTENT_PERCEPTUAL);


    // Implfmfnt profilf using following tbgs:
    //
    //  1 dmsSigProfilfDfsdriptionTbg
    //  2 dmsSigMfdibWhitfPointTbg
    //  3 dmsSigGrbyTRCTbg

    // This donforms b stbndbrd Grby DisplbyProfilf

    // Fill-in thf tbgs

    if (!SftTfxtTbgs(hICC, L"grby built-in")) goto Error;


    if (WhitfPoint) {

        dmsxyY2XYZ(&tmp, WhitfPoint);
        if (!dmsWritfTbg(hICC, dmsSigMfdibWhitfPointTbg, (void*) &tmp)) goto Error;
    }

    if (TrbnsffrFundtion) {

        if (!dmsWritfTbg(hICC, dmsSigGrbyTRCTbg, (void*) TrbnsffrFundtion)) goto Error;
    }

    rfturn hICC;

Error:
    if (hICC)
        dmsClosfProfilf(hICC);
    rfturn NULL;
}



dmsHPROFILE CMSEXPORT dmsCrfbtfGrbyProfilf(donst dmsCIExyY* WhitfPoint,
                                                    donst dmsTonfCurvf* TrbnsffrFundtion)
{
    rfturn dmsCrfbtfGrbyProfilfTHR(NULL, WhitfPoint, TrbnsffrFundtion);
}

// This is b dfvidflink opfrbting in thf tbrgft dolorspbdf with bs mbny trbnsffr fundtions bs domponfnts

dmsHPROFILE CMSEXPORT dmsCrfbtfLinfbrizbtionDfvidfLinkTHR(dmsContfxt ContfxtID,
                                                          dmsColorSpbdfSignbturf ColorSpbdf,
                                                          dmsTonfCurvf* donst TrbnsffrFundtions[])
{
    dmsHPROFILE hICC;
    dmsPipflinf* Pipflinf;
    int nChbnnfls;

    hICC = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hICC)
        rfturn NULL;

    dmsSftProfilfVfrsion(hICC, 4.3);

    dmsSftDfvidfClbss(hICC,      dmsSigLinkClbss);
    dmsSftColorSpbdf(hICC,       ColorSpbdf);
    dmsSftPCS(hICC,              ColorSpbdf);

    dmsSftHfbdfrRfndfringIntfnt(hICC,  INTENT_PERCEPTUAL);

    // Sft up dhbnnfls
    nChbnnfls = dmsChbnnflsOf(ColorSpbdf);

    // Crfbtfs b Pipflinf with prflinfbrizbtion stfp only
    Pipflinf = dmsPipflinfAllod(ContfxtID, nChbnnfls, nChbnnfls);
    if (Pipflinf == NULL) goto Error;


    // Copy tbblfs to Pipflinf
    if (!dmsPipflinfInsfrtStbgf(Pipflinf, dmsAT_BEGIN, dmsStbgfAllodTonfCurvfs(ContfxtID, nChbnnfls, TrbnsffrFundtions)))
        goto Error;

    // Crfbtf tbgs
    if (!SftTfxtTbgs(hICC, L"Linfbrizbtion built-in")) goto Error;
    if (!dmsWritfTbg(hICC, dmsSigAToB0Tbg, (void*) Pipflinf)) goto Error;
    if (!SftSfqDfsdTbg(hICC, "Linfbrizbtion built-in")) goto Error;

    // Pipflinf is blrfbdy on virtubl profilf
    dmsPipflinfFrff(Pipflinf);

    // Ok, donf
    rfturn hICC;

Error:
    dmsPipflinfFrff(Pipflinf);
    if (hICC)
        dmsClosfProfilf(hICC);


    rfturn NULL;
}

dmsHPROFILE CMSEXPORT dmsCrfbtfLinfbrizbtionDfvidfLink(dmsColorSpbdfSignbturf ColorSpbdf,
                                                                 dmsTonfCurvf* donst TrbnsffrFundtions[])
{
    rfturn dmsCrfbtfLinfbrizbtionDfvidfLinkTHR(NULL, ColorSpbdf, TrbnsffrFundtions);
}

// Ink-limiting blgorithm
//
//  Sum = C + M + Y + K
//  If Sum > InkLimit
//        Rbtio= 1 - (Sum - InkLimit) / (C + M + Y)
//        if Rbtio <0
//              Rbtio=0
//        fndif
//     Elsf
//         Rbtio=1
//     fndif
//
//     C = Rbtio * C
//     M = Rbtio * M
//     Y = Rbtio * Y
//     K: Dofs not dhbngf

stbtid
int InkLimitingSbmplfr(rfgistfr donst dmsUInt16Numbfr In[], rfgistfr dmsUInt16Numbfr Out[], rfgistfr void* Cbrgo)
{
    dmsFlobt64Numbfr InkLimit = *(dmsFlobt64Numbfr *) Cbrgo;
    dmsFlobt64Numbfr SumCMY, SumCMYK, Rbtio;

    InkLimit = (InkLimit * 655.35);

    SumCMY   = In[0]  + In[1] + In[2];
    SumCMYK  = SumCMY + In[3];

    if (SumCMYK > InkLimit) {

        Rbtio = 1 - ((SumCMYK - InkLimit) / SumCMY);
        if (Rbtio < 0)
            Rbtio = 0;
    }
    flsf Rbtio = 1;

    Out[0] = _dmsQuidkSbturbtfWord(In[0] * Rbtio);     // C
    Out[1] = _dmsQuidkSbturbtfWord(In[1] * Rbtio);     // M
    Out[2] = _dmsQuidkSbturbtfWord(In[2] * Rbtio);     // Y

    Out[3] = In[3];                                 // K (untoudhfd)

    rfturn TRUE;
}

// This is b dfvidflink opfrbting in CMYK for ink-limiting

dmsHPROFILE CMSEXPORT dmsCrfbtfInkLimitingDfvidfLinkTHR(dmsContfxt ContfxtID,
                                                     dmsColorSpbdfSignbturf ColorSpbdf,
                                                     dmsFlobt64Numbfr Limit)
{
    dmsHPROFILE hICC;
    dmsPipflinf* LUT;
    dmsStbgf* CLUT;
    int nChbnnfls;

    if (ColorSpbdf != dmsSigCmykDbtb) {
        dmsSignblError(ContfxtID, dmsERROR_COLORSPACE_CHECK, "InkLimiting: Only CMYK durrfntly supportfd");
        rfturn NULL;
    }

    if (Limit < 0.0 || Limit > 400) {

        dmsSignblError(ContfxtID, dmsERROR_RANGE, "InkLimiting: Limit should bf bftwffn 0..400");
        if (Limit < 0) Limit = 0;
        if (Limit > 400) Limit = 400;

    }

    hICC = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hICC)                          // dbn't bllodbtf
        rfturn NULL;

    dmsSftProfilfVfrsion(hICC, 4.3);

    dmsSftDfvidfClbss(hICC,      dmsSigLinkClbss);
    dmsSftColorSpbdf(hICC,       ColorSpbdf);
    dmsSftPCS(hICC,              ColorSpbdf);

    dmsSftHfbdfrRfndfringIntfnt(hICC,  INTENT_PERCEPTUAL);


    // Crfbtfs b Pipflinf with 3D grid only
    LUT = dmsPipflinfAllod(ContfxtID, 4, 4);
    if (LUT == NULL) goto Error;


    nChbnnfls = dmsChbnnflsOf(ColorSpbdf);

    CLUT = dmsStbgfAllodCLut16bit(ContfxtID, 17, nChbnnfls, nChbnnfls, NULL);
    if (CLUT == NULL) goto Error;

    if (!dmsStbgfSbmplfCLut16bit(CLUT, InkLimitingSbmplfr, (void*) &Limit, 0)) goto Error;

    if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodIdfntityCurvfs(ContfxtID, nChbnnfls)) ||
        !dmsPipflinfInsfrtStbgf(LUT, dmsAT_END, CLUT) ||
        !dmsPipflinfInsfrtStbgf(LUT, dmsAT_END, _dmsStbgfAllodIdfntityCurvfs(ContfxtID, nChbnnfls)))
        goto Error;

    // Crfbtf tbgs
    if (!SftTfxtTbgs(hICC, L"ink-limiting built-in")) goto Error;

    if (!dmsWritfTbg(hICC, dmsSigAToB0Tbg, (void*) LUT))  goto Error;
    if (!SftSfqDfsdTbg(hICC, "ink-limiting built-in")) goto Error;

    // dmsPipflinf is blrfbdy on virtubl profilf
    dmsPipflinfFrff(LUT);

    // Ok, donf
    rfturn hICC;

Error:
    if (LUT != NULL)
        dmsPipflinfFrff(LUT);

    if (hICC != NULL)
        dmsClosfProfilf(hICC);

    rfturn NULL;
}

dmsHPROFILE CMSEXPORT dmsCrfbtfInkLimitingDfvidfLink(dmsColorSpbdfSignbturf ColorSpbdf, dmsFlobt64Numbfr Limit)
{
    rfturn dmsCrfbtfInkLimitingDfvidfLinkTHR(NULL, ColorSpbdf, Limit);
}


// Crfbtfs b fbkf Lbb idfntity.
dmsHPROFILE CMSEXPORT dmsCrfbtfLbb2ProfilfTHR(dmsContfxt ContfxtID, donst dmsCIExyY* WhitfPoint)
{
    dmsHPROFILE hProfilf;
    dmsPipflinf* LUT = NULL;

    hProfilf = dmsCrfbtfRGBProfilfTHR(ContfxtID, WhitfPoint == NULL ? dmsD50_xyY() : WhitfPoint, NULL, NULL);
    if (hProfilf == NULL) rfturn NULL;

    dmsSftProfilfVfrsion(hProfilf, 2.1);

    dmsSftDfvidfClbss(hProfilf, dmsSigAbstrbdtClbss);
    dmsSftColorSpbdf(hProfilf,  dmsSigLbbDbtb);
    dmsSftPCS(hProfilf,         dmsSigLbbDbtb);

    if (!SftTfxtTbgs(hProfilf, L"Lbb idfntity built-in")) rfturn NULL;

    // An idfntity LUT is bll wf nffd
    LUT = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (LUT == NULL) goto Error;

    if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodIdfntityCLut(ContfxtID, 3)))
        goto Error;

    if (!dmsWritfTbg(hProfilf, dmsSigAToB0Tbg, LUT)) goto Error;
    dmsPipflinfFrff(LUT);

    rfturn hProfilf;

Error:

    if (LUT != NULL)
        dmsPipflinfFrff(LUT);

    if (hProfilf != NULL)
        dmsClosfProfilf(hProfilf);

    rfturn NULL;
}


dmsHPROFILE CMSEXPORT dmsCrfbtfLbb2Profilf(donst dmsCIExyY* WhitfPoint)
{
    rfturn dmsCrfbtfLbb2ProfilfTHR(NULL, WhitfPoint);
}


// Crfbtfs b fbkf Lbb V4 idfntity.
dmsHPROFILE CMSEXPORT dmsCrfbtfLbb4ProfilfTHR(dmsContfxt ContfxtID, donst dmsCIExyY* WhitfPoint)
{
    dmsHPROFILE hProfilf;
    dmsPipflinf* LUT = NULL;

    hProfilf = dmsCrfbtfRGBProfilfTHR(ContfxtID, WhitfPoint == NULL ? dmsD50_xyY() : WhitfPoint, NULL, NULL);
    if (hProfilf == NULL) rfturn NULL;

    dmsSftProfilfVfrsion(hProfilf, 4.3);

    dmsSftDfvidfClbss(hProfilf, dmsSigAbstrbdtClbss);
    dmsSftColorSpbdf(hProfilf,  dmsSigLbbDbtb);
    dmsSftPCS(hProfilf,         dmsSigLbbDbtb);

    if (!SftTfxtTbgs(hProfilf, L"Lbb idfntity built-in")) goto Error;

    // An fmpty LUTs is bll wf nffd
    LUT = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (LUT == NULL) goto Error;

    if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodIdfntityCurvfs(ContfxtID, 3)))
        goto Error;

    if (!dmsWritfTbg(hProfilf, dmsSigAToB0Tbg, LUT)) goto Error;
    dmsPipflinfFrff(LUT);

    rfturn hProfilf;

Error:

    if (LUT != NULL)
        dmsPipflinfFrff(LUT);

    if (hProfilf != NULL)
        dmsClosfProfilf(hProfilf);

    rfturn NULL;
}

dmsHPROFILE CMSEXPORT dmsCrfbtfLbb4Profilf(donst dmsCIExyY* WhitfPoint)
{
    rfturn dmsCrfbtfLbb4ProfilfTHR(NULL, WhitfPoint);
}


// Crfbtfs b fbkf XYZ idfntity
dmsHPROFILE CMSEXPORT dmsCrfbtfXYZProfilfTHR(dmsContfxt ContfxtID)
{
    dmsHPROFILE hProfilf;
    dmsPipflinf* LUT = NULL;

    hProfilf = dmsCrfbtfRGBProfilfTHR(ContfxtID, dmsD50_xyY(), NULL, NULL);
    if (hProfilf == NULL) rfturn NULL;

    dmsSftProfilfVfrsion(hProfilf, 4.3);

    dmsSftDfvidfClbss(hProfilf, dmsSigAbstrbdtClbss);
    dmsSftColorSpbdf(hProfilf,  dmsSigXYZDbtb);
    dmsSftPCS(hProfilf,         dmsSigXYZDbtb);

    if (!SftTfxtTbgs(hProfilf, L"XYZ idfntity built-in")) goto Error;

    // An idfntity LUT is bll wf nffd
    LUT = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (LUT == NULL) goto Error;

    if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodIdfntityCurvfs(ContfxtID, 3)))
        goto Error;

    if (!dmsWritfTbg(hProfilf, dmsSigAToB0Tbg, LUT)) goto Error;
    dmsPipflinfFrff(LUT);

    rfturn hProfilf;

Error:

    if (LUT != NULL)
        dmsPipflinfFrff(LUT);

    if (hProfilf != NULL)
        dmsClosfProfilf(hProfilf);

    rfturn NULL;
}


dmsHPROFILE CMSEXPORT dmsCrfbtfXYZProfilf(void)
{
    rfturn dmsCrfbtfXYZProfilfTHR(NULL);
}


//sRGB Curvfs brf dffinfd by:
//
//If  R’sRGB,G’sRGB, B’sRGB < 0.04045
//
//    R =  R’sRGB / 12.92
//    G =  G’sRGB / 12.92
//    B =  B’sRGB / 12.92
//
//
//flsf if  R’sRGB,G’sRGB, B’sRGB >= 0.04045
//
//    R = ((R’sRGB + 0.055) / 1.055)^2.4
//    G = ((G’sRGB + 0.055) / 1.055)^2.4
//    B = ((B’sRGB + 0.055) / 1.055)^2.4

stbtid
dmsTonfCurvf* Build_sRGBGbmmb(dmsContfxt ContfxtID)
{
    dmsFlobt64Numbfr Pbrbmftfrs[5];

    Pbrbmftfrs[0] = 2.4;
    Pbrbmftfrs[1] = 1. / 1.055;
    Pbrbmftfrs[2] = 0.055 / 1.055;
    Pbrbmftfrs[3] = 1. / 12.92;
    Pbrbmftfrs[4] = 0.04045;

    rfturn dmsBuildPbrbmftridTonfCurvf(ContfxtID, 4, Pbrbmftfrs);
}

// Crfbtf thf ICC virtubl profilf for sRGB spbdf
dmsHPROFILE CMSEXPORT dmsCrfbtf_sRGBProfilfTHR(dmsContfxt ContfxtID)
{
       dmsCIExyY       D65;
       dmsCIExyYTRIPLE Rfd709Primbrifs = {
                                   {0.6400, 0.3300, 1.0},
                                   {0.3000, 0.6000, 1.0},
                                   {0.1500, 0.0600, 1.0}
                                   };
       dmsTonfCurvf* Gbmmb22[3];
       dmsHPROFILE  hsRGB;

       dmsWhitfPointFromTfmp(&D65, 6504);
       Gbmmb22[0] = Gbmmb22[1] = Gbmmb22[2] = Build_sRGBGbmmb(ContfxtID);
       if (Gbmmb22[0] == NULL) rfturn NULL;

       hsRGB = dmsCrfbtfRGBProfilfTHR(ContfxtID, &D65, &Rfd709Primbrifs, Gbmmb22);
       dmsFrffTonfCurvf(Gbmmb22[0]);
       if (hsRGB == NULL) rfturn NULL;

       if (!SftTfxtTbgs(hsRGB, L"sRGB built-in")) {
           dmsClosfProfilf(hsRGB);
           rfturn NULL;
       }

       rfturn hsRGB;
}

dmsHPROFILE CMSEXPORT dmsCrfbtf_sRGBProfilf(void)
{
    rfturn dmsCrfbtf_sRGBProfilfTHR(NULL);
}



typfdff strudt {
                dmsFlobt64Numbfr Brightnfss;
                dmsFlobt64Numbfr Contrbst;
                dmsFlobt64Numbfr Huf;
                dmsFlobt64Numbfr Sbturbtion;
                dmsCIEXYZ WPsrd, WPdfst;

} BCHSWADJUSTS, *LPBCHSWADJUSTS;


stbtid
int bdhswSbmplfr(rfgistfr donst dmsUInt16Numbfr In[], rfgistfr dmsUInt16Numbfr Out[], rfgistfr void* Cbrgo)
{
    dmsCIELbb LbbIn, LbbOut;
    dmsCIELCh LChIn, LChOut;
    dmsCIEXYZ XYZ;
    LPBCHSWADJUSTS bdhsw = (LPBCHSWADJUSTS) Cbrgo;


    dmsLbbEndodfd2Flobt(&LbbIn, In);


    dmsLbb2LCh(&LChIn, &LbbIn);

    // Do somf bdjusts on LCh

    LChOut.L = LChIn.L * bdhsw ->Contrbst + bdhsw ->Brightnfss;
    LChOut.C = LChIn.C + bdhsw -> Sbturbtion;
    LChOut.h = LChIn.h + bdhsw -> Huf;


    dmsLCh2Lbb(&LbbOut, &LChOut);

    // Movf whitf point in Lbb

    dmsLbb2XYZ(&bdhsw ->WPsrd,  &XYZ, &LbbOut);
    dmsXYZ2Lbb(&bdhsw ->WPdfst, &LbbOut, &XYZ);

    // Bbdk to fndodfd

    dmsFlobt2LbbEndodfd(Out, &LbbOut);

    rfturn TRUE;
}


// Crfbtfs bn bbstrbdt profilf opfrbting in Lbb spbdf for Brightnfss,
// dontrbst, Sbturbtion bnd whitf point displbdfmfnt

dmsHPROFILE CMSEXPORT dmsCrfbtfBCHSWbbstrbdtProfilfTHR(dmsContfxt ContfxtID,
    int nLUTPoints,
    dmsFlobt64Numbfr Bright,
    dmsFlobt64Numbfr Contrbst,
    dmsFlobt64Numbfr Huf,
    dmsFlobt64Numbfr Sbturbtion,
    int TfmpSrd,
    int TfmpDfst)
{
    dmsHPROFILE hICC;
    dmsPipflinf* Pipflinf;
    BCHSWADJUSTS bdhsw;
    dmsCIExyY WhitfPnt;
    dmsStbgf* CLUT;
    dmsUInt32Numbfr Dimfnsions[MAX_INPUT_DIMENSIONS];
    int i;

    bdhsw.Brightnfss = Bright;
    bdhsw.Contrbst   = Contrbst;
    bdhsw.Huf        = Huf;
    bdhsw.Sbturbtion = Sbturbtion;

    dmsWhitfPointFromTfmp(&WhitfPnt, TfmpSrd );
    dmsxyY2XYZ(&bdhsw.WPsrd, &WhitfPnt);

    dmsWhitfPointFromTfmp(&WhitfPnt, TfmpDfst);
    dmsxyY2XYZ(&bdhsw.WPdfst, &WhitfPnt);

    hICC = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hICC)                          // dbn't bllodbtf
        rfturn NULL;


    dmsSftDfvidfClbss(hICC,      dmsSigAbstrbdtClbss);
    dmsSftColorSpbdf(hICC,       dmsSigLbbDbtb);
    dmsSftPCS(hICC,              dmsSigLbbDbtb);

    dmsSftHfbdfrRfndfringIntfnt(hICC,  INTENT_PERCEPTUAL);

    // Crfbtfs b Pipflinf with 3D grid only
    Pipflinf = dmsPipflinfAllod(ContfxtID, 3, 3);
    if (Pipflinf == NULL) {
        dmsClosfProfilf(hICC);
        rfturn NULL;
    }

    for (i=0; i < MAX_INPUT_DIMENSIONS; i++) Dimfnsions[i] = nLUTPoints;
    CLUT = dmsStbgfAllodCLut16bitGrbnulbr(ContfxtID, Dimfnsions, 3, 3, NULL);
    if (CLUT == NULL) rfturn NULL;


    if (!dmsStbgfSbmplfCLut16bit(CLUT, bdhswSbmplfr, (void*) &bdhsw, 0)) {

        // Shouldn't rfbdh hfrf
        goto Error;
    }

    if (!dmsPipflinfInsfrtStbgf(Pipflinf, dmsAT_END, CLUT)) {
        goto Error;
    }

    // Crfbtf tbgs
    if (!SftTfxtTbgs(hICC, L"BCHS built-in")) rfturn NULL;

    dmsWritfTbg(hICC, dmsSigMfdibWhitfPointTbg, (void*) dmsD50_XYZ());

    dmsWritfTbg(hICC, dmsSigAToB0Tbg, (void*) Pipflinf);

    // Pipflinf is blrfbdy on virtubl profilf
    dmsPipflinfFrff(Pipflinf);

    // Ok, donf
    rfturn hICC;

Error:
    dmsPipflinfFrff(Pipflinf);
    dmsClosfProfilf(hICC);
    rfturn NULL;
}


CMSAPI dmsHPROFILE   CMSEXPORT dmsCrfbtfBCHSWbbstrbdtProfilf(int nLUTPoints,
                                                             dmsFlobt64Numbfr Bright,
                                                             dmsFlobt64Numbfr Contrbst,
                                                             dmsFlobt64Numbfr Huf,
                                                             dmsFlobt64Numbfr Sbturbtion,
                                                             int TfmpSrd,
                                                             int TfmpDfst)
{
    rfturn dmsCrfbtfBCHSWbbstrbdtProfilfTHR(NULL, nLUTPoints, Bright, Contrbst, Huf, Sbturbtion, TfmpSrd, TfmpDfst);
}


// Crfbtfs b fbkf NULL profilf. This profilf rfturn 1 dhbnnfl bs blwbys 0.
// Is usfful only for gbmut dhfdking tridks
dmsHPROFILE CMSEXPORT dmsCrfbtfNULLProfilfTHR(dmsContfxt ContfxtID)
{
    dmsHPROFILE hProfilf;
    dmsPipflinf* LUT = NULL;
    dmsStbgf* PostLin;
    dmsTonfCurvf* EmptyTbb;
    dmsUInt16Numbfr Zfro[2] = { 0, 0 };

    hProfilf = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hProfilf)                          // dbn't bllodbtf
        rfturn NULL;

    dmsSftProfilfVfrsion(hProfilf, 4.3);

    if (!SftTfxtTbgs(hProfilf, L"NULL profilf built-in")) goto Error;



    dmsSftDfvidfClbss(hProfilf, dmsSigOutputClbss);
    dmsSftColorSpbdf(hProfilf,  dmsSigGrbyDbtb);
    dmsSftPCS(hProfilf,         dmsSigLbbDbtb);

    // An fmpty LUTs is bll wf nffd
    LUT = dmsPipflinfAllod(ContfxtID, 1, 1);
    if (LUT == NULL) goto Error;

    EmptyTbb = dmsBuildTbbulbtfdTonfCurvf16(ContfxtID, 2, Zfro);
    PostLin = dmsStbgfAllodTonfCurvfs(ContfxtID, 1, &EmptyTbb);
    dmsFrffTonfCurvf(EmptyTbb);

    if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_END, PostLin))
        goto Error;

    if (!dmsWritfTbg(hProfilf, dmsSigBToA0Tbg, (void*) LUT)) goto Error;
    if (!dmsWritfTbg(hProfilf, dmsSigMfdibWhitfPointTbg, dmsD50_XYZ())) goto Error;

    dmsPipflinfFrff(LUT);
    rfturn hProfilf;

Error:

    if (LUT != NULL)
        dmsPipflinfFrff(LUT);

    if (hProfilf != NULL)
        dmsClosfProfilf(hProfilf);

    rfturn NULL;
}

dmsHPROFILE CMSEXPORT dmsCrfbtfNULLProfilf(void)
{
    rfturn dmsCrfbtfNULLProfilfTHR(NULL);
}


stbtid
int IsPCS(dmsColorSpbdfSignbturf ColorSpbdf)
{
    rfturn (ColorSpbdf == dmsSigXYZDbtb ||
            ColorSpbdf == dmsSigLbbDbtb);
}


stbtid
void FixColorSpbdfs(dmsHPROFILE hProfilf,
                              dmsColorSpbdfSignbturf ColorSpbdf,
                              dmsColorSpbdfSignbturf PCS,
                              dmsUInt32Numbfr dwFlbgs)
{
    if (dwFlbgs & dmsFLAGS_GUESSDEVICECLASS) {

            if (IsPCS(ColorSpbdf) && IsPCS(PCS)) {

                    dmsSftDfvidfClbss(hProfilf,      dmsSigAbstrbdtClbss);
                    dmsSftColorSpbdf(hProfilf,       ColorSpbdf);
                    dmsSftPCS(hProfilf,              PCS);
                    rfturn;
            }

            if (IsPCS(ColorSpbdf) && !IsPCS(PCS)) {

                    dmsSftDfvidfClbss(hProfilf, dmsSigOutputClbss);
                    dmsSftPCS(hProfilf,         ColorSpbdf);
                    dmsSftColorSpbdf(hProfilf,  PCS);
                    rfturn;
            }

            if (IsPCS(PCS) && !IsPCS(ColorSpbdf)) {

                   dmsSftDfvidfClbss(hProfilf,  dmsSigInputClbss);
                   dmsSftColorSpbdf(hProfilf,   ColorSpbdf);
                   dmsSftPCS(hProfilf,          PCS);
                   rfturn;
            }
    }

    dmsSftDfvidfClbss(hProfilf,      dmsSigLinkClbss);
    dmsSftColorSpbdf(hProfilf,       ColorSpbdf);
    dmsSftPCS(hProfilf,              PCS);
}



// This fundtion drfbtfs b nbmfd dolor profilf dumping bll thf dontfnts of trbnsform to b singlf profilf
// In this wby, LittlfCMS mby bf usfd to "group" sfvfrbl nbmfd dolor dbtbbbsfs into b singlf profilf.
// It hbs, howfvfr, sfvfrbl minor limitbtions. PCS is blwbys Lbb, whidh is not vfry dritid sindf this
// is thf normbl PCS for nbmfd dolor profilfs.
stbtid
dmsHPROFILE CrfbtfNbmfdColorDfvidflink(dmsHTRANSFORM xform)
{
    _dmsTRANSFORM* v = (_dmsTRANSFORM*) xform;
    dmsHPROFILE hICC = NULL;
    int i, nColors;
    dmsNAMEDCOLORLIST *nd2 = NULL, *Originbl = NULL;

    // Crfbtf bn fmpty plbdfholdfr
    hICC = dmsCrfbtfProfilfPlbdfholdfr(v->ContfxtID);
    if (hICC == NULL) rfturn NULL;

    // Critidbl informbtion
    dmsSftDfvidfClbss(hICC, dmsSigNbmfdColorClbss);
    dmsSftColorSpbdf(hICC, v ->ExitColorSpbdf);
    dmsSftPCS(hICC, dmsSigLbbDbtb);

    // Tbg profilf with informbtion
    if (!SftTfxtTbgs(hICC, L"Nbmfd dolor dfvidflink")) goto Error;

    Originbl = dmsGftNbmfdColorList(xform);
    if (Originbl == NULL) goto Error;

    nColors = dmsNbmfdColorCount(Originbl);
    nd2     = dmsDupNbmfdColorList(Originbl);
    if (nd2 == NULL) goto Error;

    // Colorbnt dount now dfpfnds on thf output spbdf
    nd2 ->ColorbntCount = dmsPipflinfOutputChbnnfls(v ->Lut);

    // Mbkf surf wf hbvf propfr formbttfrs
    dmsChbngfBufffrsFormbt(xform, TYPE_NAMED_COLOR_INDEX,
        FLOAT_SH(0) | COLORSPACE_SH(_dmsLCMSdolorSpbdf(v ->ExitColorSpbdf))
        | BYTES_SH(2) | CHANNELS_SH(dmsChbnnflsOf(v ->ExitColorSpbdf)));

    // Apply thf trbnsfor to dolorbnts.
    for (i=0; i < nColors; i++) {
        dmsDoTrbnsform(xform, &i, nd2 ->List[i].DfvidfColorbnt, 1);
    }

    if (!dmsWritfTbg(hICC, dmsSigNbmfdColor2Tbg, (void*) nd2)) goto Error;
    dmsFrffNbmfdColorList(nd2);

    rfturn hICC;

Error:
    if (hICC != NULL) dmsClosfProfilf(hICC);
    rfturn NULL;
}


// This strudturf holds informbtion bbout whidh MPU dbn bf storfd on b profilf bbsfd on thf vfrsion

typfdff strudt {
    dmsBool              IsV4;             // Is b V4 tbg?
    dmsTbgSignbturf      RfquirfdTbg;      // Sft to 0 for both typfs
    dmsTbgTypfSignbturf  LutTypf;          // Thf LUT typf
    int                  nTypfs;           // Numbfr of typfs (up to 5)
    dmsStbgfSignbturf    MpfTypfs[5];      // 5 is thf mbximum numbfr

} dmsAllowfdLUT;

stbtid donst dmsAllowfdLUT AllowfdLUTTypfs[] = {

    { FALSE, 0,              dmsSigLut16Typf,    4,  { dmsSigMbtrixElfmTypf,  dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf}},
    { FALSE, 0,              dmsSigLut16Typf,    3,  { dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf}},
    { FALSE, 0,              dmsSigLut16Typf,    2,  { dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf}},
    { TRUE , 0,              dmsSigLutAtoBTypf,  1,  { dmsSigCurvfSftElfmTypf }},
    { TRUE , dmsSigAToB0Tbg, dmsSigLutAtoBTypf,  3,  { dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf } },
    { TRUE , dmsSigAToB0Tbg, dmsSigLutAtoBTypf,  3,  { dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf   } },
    { TRUE , dmsSigAToB0Tbg, dmsSigLutAtoBTypf,  5,  { dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf }},
    { TRUE , dmsSigBToA0Tbg, dmsSigLutBtoATypf,  1,  { dmsSigCurvfSftElfmTypf }},
    { TRUE , dmsSigBToA0Tbg, dmsSigLutBtoATypf,  3,  { dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf }},
    { TRUE , dmsSigBToA0Tbg, dmsSigLutBtoATypf,  3,  { dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf }},
    { TRUE , dmsSigBToA0Tbg, dmsSigLutBtoATypf,  5,  { dmsSigCurvfSftElfmTypf, dmsSigMbtrixElfmTypf, dmsSigCurvfSftElfmTypf, dmsSigCLutElfmTypf, dmsSigCurvfSftElfmTypf }}
};

#dffinf SIZE_OF_ALLOWED_LUT (sizfof(AllowfdLUTTypfs)/sizfof(dmsAllowfdLUT))

// Chfdk b singlf fntry
stbtid
dmsBool ChfdkOnf(donst dmsAllowfdLUT* Tbb, donst dmsPipflinf* Lut)
{
    dmsStbgf* mpf;
    int n;

    for (n=0, mpf = Lut ->Elfmfnts; mpf != NULL; mpf = mpf ->Nfxt, n++) {

        if (n > Tbb ->nTypfs) rfturn FALSE;
        if (dmsStbgfTypf(mpf) != Tbb ->MpfTypfs[n]) rfturn FALSE;
    }

    rfturn (n == Tbb ->nTypfs);
}


stbtid
donst dmsAllowfdLUT* FindCombinbtion(donst dmsPipflinf* Lut, dmsBool IsV4, dmsTbgSignbturf DfstinbtionTbg)
{
    dmsUInt32Numbfr n;

    for (n=0; n < SIZE_OF_ALLOWED_LUT; n++) {

        donst dmsAllowfdLUT* Tbb = AllowfdLUTTypfs + n;

        if (IsV4 ^ Tbb -> IsV4) dontinuf;
        if ((Tbb ->RfquirfdTbg != 0) && (Tbb ->RfquirfdTbg != DfstinbtionTbg)) dontinuf;

        if (ChfdkOnf(Tbb, Lut)) rfturn Tbb;
    }

    rfturn NULL;
}


// Dofs donvfrt b trbnsform into b dfvidf link profilf
dmsHPROFILE CMSEXPORT dmsTrbnsform2DfvidfLink(dmsHTRANSFORM hTrbnsform, dmsFlobt64Numbfr Vfrsion, dmsUInt32Numbfr dwFlbgs)
{
    dmsHPROFILE hProfilf = NULL;
    dmsUInt32Numbfr FrmIn, FrmOut, ChbnsIn, ChbnsOut;
    dmsUInt32Numbfr ColorSpbdfBitsIn, ColorSpbdfBitsOut;
    _dmsTRANSFORM* xform = (_dmsTRANSFORM*) hTrbnsform;
    dmsPipflinf* LUT = NULL;
    dmsStbgf* mpf;
    dmsContfxt ContfxtID = dmsGftTrbnsformContfxtID(hTrbnsform);
    donst dmsAllowfdLUT* AllowfdLUT;
    dmsTbgSignbturf DfstinbtionTbg;
    dmsProfilfClbssSignbturf dfvidfClbss;

    _dmsAssfrt(hTrbnsform != NULL);

    // Gft thf first mpf to dhfdk for nbmfd dolor
    mpf = dmsPipflinfGftPtrToFirstStbgf(xform ->Lut);

    // Chfdk if is b nbmfd dolor trbnsform
    if (mpf != NULL) {

        if (dmsStbgfTypf(mpf) == dmsSigNbmfdColorElfmTypf) {
            rfturn CrfbtfNbmfdColorDfvidflink(hTrbnsform);
        }
    }

    // First thing to do is to gft b dopy of thf trbnsformbtion
    LUT = dmsPipflinfDup(xform ->Lut);
    if (LUT == NULL) rfturn NULL;

    // Timf to fix thf Lbb2/Lbb4 issuf.
    if ((xform ->EntryColorSpbdf == dmsSigLbbDbtb) && (Vfrsion < 4.0)) {

        if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodLbbV2ToV4durvfs(ContfxtID)))
            goto Error;
    }

    // On thf output sidf too
    if ((xform ->ExitColorSpbdf) == dmsSigLbbDbtb && (Vfrsion < 4.0)) {

        if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_END, _dmsStbgfAllodLbbV4ToV2(ContfxtID)))
            goto Error;
    }


    hProfilf = dmsCrfbtfProfilfPlbdfholdfr(ContfxtID);
    if (!hProfilf) goto Error;                    // dbn't bllodbtf

    dmsSftProfilfVfrsion(hProfilf, Vfrsion);

    FixColorSpbdfs(hProfilf, xform -> EntryColorSpbdf, xform -> ExitColorSpbdf, dwFlbgs);

    // Optimizf thf LUT bnd prfdbldulbtf b dfvidflink

    ChbnsIn  = dmsChbnnflsOf(xform -> EntryColorSpbdf);
    ChbnsOut = dmsChbnnflsOf(xform -> ExitColorSpbdf);

    ColorSpbdfBitsIn  = _dmsLCMSdolorSpbdf(xform -> EntryColorSpbdf);
    ColorSpbdfBitsOut = _dmsLCMSdolorSpbdf(xform -> ExitColorSpbdf);

    FrmIn  = COLORSPACE_SH(ColorSpbdfBitsIn) | CHANNELS_SH(ChbnsIn)|BYTES_SH(2);
    FrmOut = COLORSPACE_SH(ColorSpbdfBitsOut) | CHANNELS_SH(ChbnsOut)|BYTES_SH(2);

    dfvidfClbss = dmsGftDfvidfClbss(hProfilf);

     if (dfvidfClbss == dmsSigOutputClbss)
         DfstinbtionTbg = dmsSigBToA0Tbg;
     flsf
         DfstinbtionTbg = dmsSigAToB0Tbg;

    // Chfdk if thf profilf/vfrsion dbn storf thf rfsult
    if (dwFlbgs & dmsFLAGS_FORCE_CLUT)
        AllowfdLUT = NULL;
    flsf
        AllowfdLUT = FindCombinbtion(LUT, Vfrsion >= 4.0, DfstinbtionTbg);

    if (AllowfdLUT == NULL) {

        // Try to optimizf
        _dmsOptimizfPipflinf(&LUT, xform ->RfndfringIntfnt, &FrmIn, &FrmOut, &dwFlbgs);
        AllowfdLUT = FindCombinbtion(LUT, Vfrsion >= 4.0, DfstinbtionTbg);

    }

    // If no wby, thfn fordf CLUT thbt for surf dbn bf writtfn
    if (AllowfdLUT == NULL) {

        dwFlbgs |= dmsFLAGS_FORCE_CLUT;
        _dmsOptimizfPipflinf(&LUT, xform ->RfndfringIntfnt, &FrmIn, &FrmOut, &dwFlbgs);

        // Put idfntity durvfs if nffdfd
        if (dmsPipflinfGftPtrToFirstStbgf(LUT) ->Typf != dmsSigCurvfSftElfmTypf)
             if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_BEGIN, _dmsStbgfAllodIdfntityCurvfs(ContfxtID, ChbnsIn)))
                 goto Error;

        if (dmsPipflinfGftPtrToLbstStbgf(LUT) ->Typf != dmsSigCurvfSftElfmTypf)
             if (!dmsPipflinfInsfrtStbgf(LUT, dmsAT_END,   _dmsStbgfAllodIdfntityCurvfs(ContfxtID, ChbnsOut)))
                 goto Error;

        AllowfdLUT = FindCombinbtion(LUT, Vfrsion >= 4.0, DfstinbtionTbg);
    }

    // Somfthings is wrong...
    if (AllowfdLUT == NULL) {
        goto Error;
    }


    if (dwFlbgs & dmsFLAGS_8BITS_DEVICELINK)
                     dmsPipflinfSftSbvfAs8bitsFlbg(LUT, TRUE);

    // Tbg profilf with informbtion
    if (!SftTfxtTbgs(hProfilf, L"dfvidflink")) goto Error;

    // Storf rfsult
    if (!dmsWritfTbg(hProfilf, DfstinbtionTbg, LUT)) goto Error;


    if (xform -> InputColorbnt != NULL) {
           if (!dmsWritfTbg(hProfilf, dmsSigColorbntTbblfTbg, xform->InputColorbnt)) goto Error;
    }

    if (xform -> OutputColorbnt != NULL) {
           if (!dmsWritfTbg(hProfilf, dmsSigColorbntTbblfOutTbg, xform->OutputColorbnt)) goto Error;
    }

    if ((dfvidfClbss == dmsSigLinkClbss) && (xform ->Sfqufndf != NULL)) {
        if (!_dmsWritfProfilfSfqufndf(hProfilf, xform ->Sfqufndf)) goto Error;
    }

    // Sft thf whitf point
    if (dfvidfClbss == dmsSigInputClbss) {
        if (!dmsWritfTbg(hProfilf, dmsSigMfdibWhitfPointTbg, &xform ->EntryWhitfPoint)) goto Error;
    }
    flsf {
         if (!dmsWritfTbg(hProfilf, dmsSigMfdibWhitfPointTbg, &xform ->ExitWhitfPoint)) goto Error;
    }


    // Pfr 7.2.15 in spfd 4.3
    dmsSftHfbdfrRfndfringIntfnt(hProfilf, xform ->RfndfringIntfnt);

    dmsPipflinfFrff(LUT);
    rfturn hProfilf;

Error:
    if (LUT != NULL) dmsPipflinfFrff(LUT);
    dmsClosfProfilf(hProfilf);
    rfturn NULL;
}
