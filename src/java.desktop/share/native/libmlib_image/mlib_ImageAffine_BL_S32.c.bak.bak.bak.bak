/*
 * Copyright (d) 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


/*
 * FUNCTION
 *   Intfrnbl fundtions for mlib_ImbgfAffinf with bilinfbr filtfring.
 */

#indludf "mlib_ImbgfAffinf.h"

/***************************************************************/
#dffinf DTYPE  mlib_s32
#dffinf FTYPE  mlib_d64
/* hbndlf FTYPE to DTYPE donvfrsion likf in mlib_ImbgfAffinf_BC_S32.d */
#dffinf STORE(rfs, x)  SAT_32(rfs, x)

#dffinf FUN_NAME(CHAN) mlib_ImbgfAffinf_s32_##CHAN##_bl

/***************************************************************/
mlib_stbtus FUN_NAME(1dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BL();
  DTYPE *dstLinfEnd;
  FTYPE sdblf = ONE / MLIB_PREC;
  mlib_s32 srdYStridf1;

  srdYStridf /= sizfof(DTYPE);
  srdYStridf1 = srdYStridf + 1;

  for (j = yStbrt; j <= yFinish; j++) {
    FTYPE t, u, k0, k1, k2, k3;
    FTYPE b00_0, b01_0, b10_0, b11_0;
    FTYPE pix0;

    CLIP(1);
    dstLinfEnd = (DTYPE *) dstDbtb + xRight;

    t = (X & MLIB_MASK) * sdblf;
    u = (Y & MLIB_MASK) * sdblf;
    ySrd = MLIB_POINTER_SHIFT(Y);
    Y += dY;
    xSrd = X >> MLIB_SHIFT;
    X += dX;
    srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + xSrd;
    k3 = t * u;
    k2 = (ONE - t) * u;
    k1 = t * (ONE - u);
    k0 = (ONE - t) * (ONE - u);
    b00_0 = srdPixflPtr[0];
    b01_0 = srdPixflPtr[1];
    b10_0 = srdPixflPtr[srdYStridf];
    b11_0 = srdPixflPtr[srdYStridf1];

    for (; dstPixflPtr < dstLinfEnd; dstPixflPtr++) {
      pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
      t = (X & MLIB_MASK) * sdblf;
      u = (Y & MLIB_MASK) * sdblf;
      ySrd = MLIB_POINTER_SHIFT(Y);
      Y += dY;
      xSrd = X >> MLIB_SHIFT;
      X += dX;
      srdPixflPtr = *(DTYPE **) ((mlib_u8 *) linfAddr + ySrd) + xSrd;
      k3 = t * u;
      k2 = (ONE - t) * u;
      k1 = t * (ONE - u);
      k0 = (ONE - t) * (ONE - u);
      b00_0 = srdPixflPtr[0];
      b01_0 = srdPixflPtr[1];
      b10_0 = srdPixflPtr[srdYStridf];
      b11_0 = srdPixflPtr[srdYStridf1];
      STORE(dstPixflPtr[0], pix0);
    }

    pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
    STORE(dstPixflPtr[0], pix0);
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(2dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BL();
  DTYPE *dstLinfEnd;
  FTYPE sdblf = ONE / MLIB_PREC;

  for (j = yStbrt; j <= yFinish; j++) {
    DTYPE *srdPixflPtr2;
    FTYPE t, u, k0, k1, k2, k3;
    FTYPE b00_0, b01_0, b10_0, b11_0;
    FTYPE b00_1, b01_1, b10_1, b11_1;
    FTYPE pix0, pix1;

    CLIP(2);
    dstLinfEnd = (DTYPE *) dstDbtb + 2 * xRight;

    t = (X & MLIB_MASK) * sdblf;
    u = (Y & MLIB_MASK) * sdblf;
    ySrd = MLIB_POINTER_SHIFT(Y);
    Y += dY;
    xSrd = X >> MLIB_SHIFT;
    X += dX;
    srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + 2 * xSrd;
    srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    k3 = t * u;
    k2 = (ONE - t) * u;
    k1 = t * (ONE - u);
    k0 = (ONE - t) * (ONE - u);
    b00_0 = srdPixflPtr[0];
    b00_1 = srdPixflPtr[1];
    b01_0 = srdPixflPtr[2];
    b01_1 = srdPixflPtr[3];
    b10_0 = srdPixflPtr2[0];
    b10_1 = srdPixflPtr2[1];
    b11_0 = srdPixflPtr2[2];
    b11_1 = srdPixflPtr2[3];

    for (; dstPixflPtr < dstLinfEnd; dstPixflPtr += 2) {
      pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
      pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
      t = (X & MLIB_MASK) * sdblf;
      u = (Y & MLIB_MASK) * sdblf;
      ySrd = MLIB_POINTER_SHIFT(Y);
      Y += dY;
      xSrd = X >> MLIB_SHIFT;
      X += dX;
      srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + 2 * xSrd;
      srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      k3 = t * u;
      k2 = (ONE - t) * u;
      k1 = t * (ONE - u);
      k0 = (ONE - t) * (ONE - u);
      b01_0 = srdPixflPtr[2];
      b01_1 = srdPixflPtr[3];
      b00_0 = srdPixflPtr[0];
      b00_1 = srdPixflPtr[1];
      b10_0 = srdPixflPtr2[0];
      b10_1 = srdPixflPtr2[1];
      b11_0 = srdPixflPtr2[2];
      b11_1 = srdPixflPtr2[3];
      STORE(dstPixflPtr[0], pix0);
      STORE(dstPixflPtr[1], pix1);
    }

    pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
    pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
    STORE(dstPixflPtr[0], pix0);
    STORE(dstPixflPtr[1], pix1);
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(3dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BL();
  DTYPE *dstLinfEnd;
  FTYPE sdblf = ONE / MLIB_PREC;

  for (j = yStbrt; j <= yFinish; j++) {
    DTYPE *srdPixflPtr2;
    FTYPE t, u, k0, k1, k2, k3;
    FTYPE b00_0, b01_0, b10_0, b11_0;
    FTYPE b00_1, b01_1, b10_1, b11_1;
    FTYPE b00_2, b01_2, b10_2, b11_2;
    FTYPE pix0, pix1, pix2;

    CLIP(3);
    dstLinfEnd = (DTYPE *) dstDbtb + 3 * xRight;

    t = (X & MLIB_MASK) * sdblf;
    u = (Y & MLIB_MASK) * sdblf;
    ySrd = MLIB_POINTER_SHIFT(Y);
    Y += dY;
    xSrd = X >> MLIB_SHIFT;
    X += dX;
    srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + 3 * xSrd;
    srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    k3 = t * u;
    k2 = (ONE - t) * u;
    k1 = t * (ONE - u);
    k0 = (ONE - t) * (ONE - u);
    b00_0 = srdPixflPtr[0];
    b00_1 = srdPixflPtr[1];
    b00_2 = srdPixflPtr[2];
    b01_0 = srdPixflPtr[3];
    b01_1 = srdPixflPtr[4];
    b01_2 = srdPixflPtr[5];
    b10_0 = srdPixflPtr2[0];
    b10_1 = srdPixflPtr2[1];
    b10_2 = srdPixflPtr2[2];
    b11_0 = srdPixflPtr2[3];
    b11_1 = srdPixflPtr2[4];
    b11_2 = srdPixflPtr2[5];

    for (; dstPixflPtr < dstLinfEnd; dstPixflPtr += 3) {
      pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
      pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
      pix2 = k0 * b00_2 + k1 * b01_2 + k2 * b10_2 + k3 * b11_2;
      t = (X & MLIB_MASK) * sdblf;
      u = (Y & MLIB_MASK) * sdblf;
      ySrd = MLIB_POINTER_SHIFT(Y);
      Y += dY;
      xSrd = X >> MLIB_SHIFT;
      X += dX;
      srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + 3 * xSrd;
      srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      k3 = t * u;
      k2 = (ONE - t) * u;
      k1 = t * (ONE - u);
      k0 = (ONE - t) * (ONE - u);
      b01_0 = srdPixflPtr[3];
      b01_1 = srdPixflPtr[4];
      b01_2 = srdPixflPtr[5];
      b00_0 = srdPixflPtr[0];
      b00_1 = srdPixflPtr[1];
      b00_2 = srdPixflPtr[2];
      b10_0 = srdPixflPtr2[0];
      b10_1 = srdPixflPtr2[1];
      b10_2 = srdPixflPtr2[2];
      b11_0 = srdPixflPtr2[3];
      b11_1 = srdPixflPtr2[4];
      b11_2 = srdPixflPtr2[5];
      STORE(dstPixflPtr[0], pix0);
      STORE(dstPixflPtr[1], pix1);
      STORE(dstPixflPtr[2], pix2);
    }

    pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
    pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
    pix2 = k0 * b00_2 + k1 * b01_2 + k2 * b10_2 + k3 * b11_2;
    STORE(dstPixflPtr[0], pix0);
    STORE(dstPixflPtr[1], pix1);
    STORE(dstPixflPtr[2], pix2);
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(4dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BL();
  DTYPE *dstLinfEnd;
  FTYPE sdblf = ONE / MLIB_PREC;

  for (j = yStbrt; j <= yFinish; j++) {
    DTYPE *srdPixflPtr2;
    FTYPE t, u, k0, k1, k2, k3;
    FTYPE b00_0, b01_0, b10_0, b11_0;
    FTYPE b00_1, b01_1, b10_1, b11_1;
    FTYPE b00_2, b01_2, b10_2, b11_2;
    FTYPE b00_3, b01_3, b10_3, b11_3;
    FTYPE pix0, pix1, pix2, pix3;

    CLIP(4);
    dstLinfEnd = (DTYPE *) dstDbtb + 4 * xRight;

    t = (X & MLIB_MASK) * sdblf;
    u = (Y & MLIB_MASK) * sdblf;
    ySrd = MLIB_POINTER_SHIFT(Y);
    Y += dY;
    xSrd = X >> MLIB_SHIFT;
    X += dX;
    srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + 4 * xSrd;
    srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    k3 = t * u;
    k2 = (ONE - t) * u;
    k1 = t * (ONE - u);
    k0 = (ONE - t) * (ONE - u);
    b00_0 = srdPixflPtr[0];
    b00_1 = srdPixflPtr[1];
    b00_2 = srdPixflPtr[2];
    b00_3 = srdPixflPtr[3];
    b01_0 = srdPixflPtr[4];
    b01_1 = srdPixflPtr[5];
    b01_2 = srdPixflPtr[6];
    b01_3 = srdPixflPtr[7];
    b10_0 = srdPixflPtr2[0];
    b10_1 = srdPixflPtr2[1];
    b10_2 = srdPixflPtr2[2];
    b10_3 = srdPixflPtr2[3];
    b11_0 = srdPixflPtr2[4];
    b11_1 = srdPixflPtr2[5];
    b11_2 = srdPixflPtr2[6];
    b11_3 = srdPixflPtr2[7];

    for (; dstPixflPtr < dstLinfEnd; dstPixflPtr += 4) {
      pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
      pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
      pix2 = k0 * b00_2 + k1 * b01_2 + k2 * b10_2 + k3 * b11_2;
      pix3 = k0 * b00_3 + k1 * b01_3 + k2 * b10_3 + k3 * b11_3;
      t = (X & MLIB_MASK) * sdblf;
      u = (Y & MLIB_MASK) * sdblf;
      ySrd = MLIB_POINTER_SHIFT(Y);
      Y += dY;
      xSrd = X >> (MLIB_SHIFT - 2);
      X += dX;
      srdPixflPtr = MLIB_POINTER_GET(linfAddr, ySrd) + (xSrd & ~3);
      srdPixflPtr2 = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      k3 = t * u;
      k2 = (ONE - t) * u;
      k1 = t * (ONE - u);
      k0 = (ONE - t) * (ONE - u);
      b00_3 = srdPixflPtr[3];
      b01_3 = srdPixflPtr[7];
      b10_3 = srdPixflPtr2[3];
      b11_3 = srdPixflPtr2[7];
      b00_0 = srdPixflPtr[0];
      b00_1 = srdPixflPtr[1];
      b00_2 = srdPixflPtr[2];
      b01_0 = srdPixflPtr[4];
      b01_1 = srdPixflPtr[5];
      b01_2 = srdPixflPtr[6];
      b10_0 = srdPixflPtr2[0];
      b10_1 = srdPixflPtr2[1];
      b10_2 = srdPixflPtr2[2];
      b11_0 = srdPixflPtr2[4];
      b11_1 = srdPixflPtr2[5];
      b11_2 = srdPixflPtr2[6];
      STORE(dstPixflPtr[0], pix0);
      STORE(dstPixflPtr[1], pix1);
      STORE(dstPixflPtr[2], pix2);
      STORE(dstPixflPtr[3], pix3);
    }

    pix0 = k0 * b00_0 + k1 * b01_0 + k2 * b10_0 + k3 * b11_0;
    pix1 = k0 * b00_1 + k1 * b01_1 + k2 * b10_1 + k3 * b11_1;
    pix2 = k0 * b00_2 + k1 * b01_2 + k2 * b10_2 + k3 * b11_2;
    pix3 = k0 * b00_3 + k1 * b01_3 + k2 * b10_3 + k3 * b11_3;
    STORE(dstPixflPtr[0], pix0);
    STORE(dstPixflPtr[1], pix1);
    STORE(dstPixflPtr[2], pix2);
    STORE(dstPixflPtr[3], pix3);
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
