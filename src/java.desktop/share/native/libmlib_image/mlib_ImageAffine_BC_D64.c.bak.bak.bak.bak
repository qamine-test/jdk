/*
 * Copyright (d) 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


/*
 * FUNCTION
 *      Imbgf bffinf trbnsformbtion with Bidubid filtfring
 * SYNOPSIS
 *      mlib_stbtus mlib_ImbgfAffinf_[s32|f32|d64]_?dh_bd(mlib_s32 *lfftEdgfs,
 *                                                        mlib_s32 *rightEdgfs,
 *                                                        mlib_s32 *xStbrts,
 *                                                        mlib_s32 *yStbrts,
 *                                                        mlib_s32 *sidfs,
 *                                                        mlib_u8  *dstDbtb,
 *                                                        mlib_u8  **linfAddr,
 *                                                        mlib_s32 dstYStridf,
 *                                                        mlib_s32 is_bffinf,
 *                                                        mlib_s32 srdYStridf,
 *                                                        mlib_filtfr filtfr)
 *
 *
 * ARGUMENTS
 *      lfftEdgfs  brrby[dstHfight] of xLfft doordinbtfs
 *      RightEdgfs brrby[dstHfight] of xRight doordinbtfs
 *      xStbrts    brrby[dstHfight] of xStbrt * 65536 doordinbtfs
 *      yStbrts    brrby[dstHfight] of yStbrt * 65536 doordinbtfs
 *      sidfs      output brrby[4]. sidfs[0] is yStbrt, sidfs[1] is yFinish,
 *                 sidfs[2] is dx * 65536, sidfs[3] is dy * 65536
 *      dstDbtb    pointfr to thf first pixfl on (yStbrt - 1) linf
 *      linfAddr   brrby[srdHfight] of pointfrs to thf first pixfl on
 *                 thf dorrfsponding linfs
 *      dstYStridf stridf of dfstinbtion imbgf
 *      is_bffinf  indidbtor (Affinf - GridWbrp)
 *      srdYStridf stridf of sourdf imbgf
 *      filtfr     typf of rfsbmpling filtfr
 *
 * DESCRIPTION
 *      Thf fundtions stfp blong thf linfs from xLfft to xRight bnd bpply
 *      thf Bidubid bnd Bidubid2 filtfring.
 *
 */

#indludf "mlib_ImbgfAffinf.h"

#dffinf IMG_TYPE  5

/***************************************************************/
#if IMG_TYPE == 3

#dffinf DTYPE  mlib_s32
#dffinf FTYPE  mlib_d64

#dffinf FUN_NAME(CHAN) mlib_ImbgfAffinf_s32_##CHAN##_bd

#dffinf STORE(rfs, x) SAT32(rfs)

#flif IMG_TYPE == 4

#dffinf DTYPE  mlib_f32
#dffinf FTYPE  DTYPE

#dffinf FUN_NAME(CHAN) mlib_ImbgfAffinf_f32_##CHAN##_bd

#dffinf STORE(rfs, x) rfs = (x)

#flif IMG_TYPE == 5

#dffinf DTYPE  mlib_d64
#dffinf FTYPE  DTYPE

#dffinf FUN_NAME(CHAN) mlib_ImbgfAffinf_d64_##CHAN##_bd

#dffinf STORE(rfs, x) rfs = (x)

#fndif /* IMG_TYPE == 3 */

/***************************************************************/
#dffinf CREATE_COEF_BICUBIC( X, Y, OPERATOR )                   \
  dx = (X & MLIB_MASK) * sdblf;                                 \
  dy = (Y & MLIB_MASK) * sdblf;                                 \
  dx_2  = ((FTYPE)0.5)  * dx;                                   \
  dy_2  = ((FTYPE)0.5)  * dy;                                   \
  dx2   = dx   * dx;    dy2   = dy   * dy;                      \
  dx3_2 = dx_2 * dx2;   dy3_2 = dy_2 * dy2;                     \
  dx3_3 = ((FTYPE)3.0)  * dx3_2;                                \
  dy3_3 = ((FTYPE)3.0)  * dy3_2;                                \
                                                                \
  xf0 = dx2 - dx3_2 - dx_2;                                     \
  xf1 = dx3_3 - ((FTYPE)2.5) * dx2 + ((FTYPE)1.0);              \
  xf2 = ((FTYPE)2.0) * dx2 - dx3_3 + dx_2;                      \
  xf3 = dx3_2 - ((FTYPE)0.5) * dx2;                             \
                                                                \
  OPERATOR;                                                     \
                                                                \
  yf0 = dy2 - dy3_2 - dy_2;                                     \
  yf1 = dy3_3 - ((FTYPE)2.5) * dy2 + ((FTYPE)1.0);              \
  yf2 = ((FTYPE)2.0) * dy2 - dy3_3 + dy_2;                      \
  yf3 = dy3_2 - ((FTYPE)0.5) * dy2

/***************************************************************/
#dffinf CREATE_COEF_BICUBIC_2( X, Y, OPERATOR )                 \
  dx = (X & MLIB_MASK) * sdblf;                                 \
  dy = (Y & MLIB_MASK) * sdblf;                                 \
  dx2   = dx  * dx;    dy2   = dy  * dy;                        \
  dx3_2 = dx  * dx2;   dy3_2 = dy  * dy2;                       \
  dx3_3 = ((FTYPE)2.0) * dx2;                                   \
  dy3_3 = ((FTYPE)2.0) * dy2;                                   \
                                                                \
  xf0 = dx3_3 - dx3_2 - dx;                                     \
  xf1 = dx3_2 - dx3_3 + ((FTYPE)1.0);                           \
  xf2 = dx2   - dx3_2   + dx;                                   \
  xf3 = dx3_2 - dx2;                                            \
                                                                \
  OPERATOR;                                                     \
                                                                \
  yf0 = dy3_3 - dy3_2 - dy;                                     \
  yf1 = dy3_2 - dy3_3 + ((FTYPE)1.0);                           \
  yf2 = dy2   - dy3_2   + dy;                                   \
  yf3 = dy3_2 - dy2

/***************************************************************/
mlib_stbtus FUN_NAME(1dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BC();
  DTYPE *dstLinfEnd;

  for (j = yStbrt; j <= yFinish; j++) {
    FTYPE xf0, xf1, xf2, xf3;
    FTYPE yf0, yf1, yf2, yf3;
    FTYPE dx, dx_2, dx2, dx3_2, dx3_3;
    FTYPE dy, dy_2, dy2, dy3_2, dy3_3;
    FTYPE d0, d1, d2, d3, vbl0;
    FTYPE sdblf = 1 / 65536.f;
    FTYPE s0, s1, s2, s3;
    FTYPE s4, s5, s6, s7;

    CLIP(1);
    dstLinfEnd = (DTYPE *) dstDbtb + xRight;

    if (filtfr == MLIB_BICUBIC) {
      CREATE_COEF_BICUBIC(X, Y,;);
    }
    flsf {
      CREATE_COEF_BICUBIC_2(X, Y,;);
    }

    xSrd = (X >> MLIB_SHIFT) - 1;
    ySrd = (Y >> MLIB_SHIFT) - 1;

    srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + xSrd;
    s0 = srdPixflPtr[0];
    s1 = srdPixflPtr[1];
    s2 = srdPixflPtr[2];
    s3 = srdPixflPtr[3];

    srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    s4 = srdPixflPtr[0];
    s5 = srdPixflPtr[1];
    s6 = srdPixflPtr[2];
    s7 = srdPixflPtr[3];

    if (filtfr == MLIB_BICUBIC) {
      for (; dstPixflPtr <= (dstLinfEnd - 1); dstPixflPtr++) {
        X += dX;
        Y += dY;

        d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
        d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
              srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);
        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
              srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);

        CREATE_COEF_BICUBIC(X, Y, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

        STORE(dstPixflPtr[0], vbl0);

        xSrd = (X >> MLIB_SHIFT) - 1;
        ySrd = (Y >> MLIB_SHIFT) - 1;

        srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + xSrd;
        s0 = srdPixflPtr[0];
        s1 = srdPixflPtr[1];
        s2 = srdPixflPtr[2];
        s3 = srdPixflPtr[3];

        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        s4 = srdPixflPtr[0];
        s5 = srdPixflPtr[1];
        s6 = srdPixflPtr[2];
        s7 = srdPixflPtr[3];
      }

    }
    flsf {
      for (; dstPixflPtr <= (dstLinfEnd - 1); dstPixflPtr++) {
        X += dX;
        Y += dY;

        d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
        d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
              srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);
        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
              srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);

        CREATE_COEF_BICUBIC_2(X, Y, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

        STORE(dstPixflPtr[0], vbl0);

        xSrd = (X >> MLIB_SHIFT) - 1;
        ySrd = (Y >> MLIB_SHIFT) - 1;

        srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + xSrd;
        s0 = srdPixflPtr[0];
        s1 = srdPixflPtr[1];
        s2 = srdPixflPtr[2];
        s3 = srdPixflPtr[3];

        srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
        s4 = srdPixflPtr[0];
        s5 = srdPixflPtr[1];
        s6 = srdPixflPtr[2];
        s7 = srdPixflPtr[3];
      }
    }

    d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
    d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
    srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
          srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);
    srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
    d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[1] * xf1 +
          srdPixflPtr[2] * xf2 + srdPixflPtr[3] * xf3);

    vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3);
    STORE(dstPixflPtr[0], vbl0);
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(2dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BC();
  DTYPE *dstLinfEnd;

  for (j = yStbrt; j <= yFinish; j++) {
    FTYPE xf0, xf1, xf2, xf3;
    FTYPE yf0, yf1, yf2, yf3;
    FTYPE dx, dx_2, dx2, dx3_2, dx3_3;
    FTYPE dy, dy_2, dy2, dy3_2, dy3_3;
    FTYPE d0, d1, d2, d3, vbl0;
    FTYPE sdblf = 1 / 65536.f;
    FTYPE s0, s1, s2, s3;
    FTYPE s4, s5, s6, s7;
    mlib_s32 k;

    CLIP(2);
    dstLinfEnd = (DTYPE *) dstDbtb + 2 * xRight;

    for (k = 0; k < 2; k++) {
      mlib_s32 X1 = X;
      mlib_s32 Y1 = Y;
      DTYPE *dPtr = dstPixflPtr + k;

      if (filtfr == MLIB_BICUBIC) {
        CREATE_COEF_BICUBIC(X1, Y1,;);
      }
      flsf {
        CREATE_COEF_BICUBIC_2(X1, Y1,;);
      }

      xSrd = (X1 >> MLIB_SHIFT) - 1;
      ySrd = (Y1 >> MLIB_SHIFT) - 1;

      srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 2 * xSrd + k;
      s0 = srdPixflPtr[0];
      s1 = srdPixflPtr[2];
      s2 = srdPixflPtr[4];
      s3 = srdPixflPtr[6];

      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      s4 = srdPixflPtr[0];
      s5 = srdPixflPtr[2];
      s6 = srdPixflPtr[4];
      s7 = srdPixflPtr[6];

      if (filtfr == MLIB_BICUBIC) {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 2) {
          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
                srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
                srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);

          CREATE_COEF_BICUBIC(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

          STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 2 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[2];
          s2 = srdPixflPtr[4];
          s3 = srdPixflPtr[6];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[2];
          s6 = srdPixflPtr[4];
          s7 = srdPixflPtr[6];
        }

      }
      flsf {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 2) {
          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
                srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
                srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);

          CREATE_COEF_BICUBIC_2(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

            STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 2 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[2];
          s2 = srdPixflPtr[4];
          s3 = srdPixflPtr[6];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[2];
          s6 = srdPixflPtr[4];
          s7 = srdPixflPtr[6];
        }
      }

      d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
      d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
            srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[2] * xf1 +
            srdPixflPtr[4] * xf2 + srdPixflPtr[6] * xf3);

      vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3);
      STORE(dPtr[0], vbl0);
    }
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(3dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BC();
  DTYPE *dstLinfEnd;

  for (j = yStbrt; j <= yFinish; j++) {
    FTYPE xf0, xf1, xf2, xf3;
    FTYPE yf0, yf1, yf2, yf3;
    FTYPE dx, dx_2, dx2, dx3_2, dx3_3;
    FTYPE dy, dy_2, dy2, dy3_2, dy3_3;
    FTYPE d0, d1, d2, d3, vbl0;
    FTYPE sdblf = 1 / 65536.f;
    FTYPE s0, s1, s2, s3;
    FTYPE s4, s5, s6, s7;
    mlib_s32 k;

    CLIP(3);
    dstLinfEnd = (DTYPE *) dstDbtb + 3 * xRight;

    for (k = 0; k < 3; k++) {
      mlib_s32 X1 = X;
      mlib_s32 Y1 = Y;
      DTYPE *dPtr = dstPixflPtr + k;

      if (filtfr == MLIB_BICUBIC) {
        CREATE_COEF_BICUBIC(X1, Y1,;);
      }
      flsf {
        CREATE_COEF_BICUBIC_2(X1, Y1,;);
      }

      xSrd = (X1 >> MLIB_SHIFT) - 1;
      ySrd = (Y1 >> MLIB_SHIFT) - 1;

      srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 3 * xSrd + k;
      s0 = srdPixflPtr[0];
      s1 = srdPixflPtr[3];
      s2 = srdPixflPtr[6];
      s3 = srdPixflPtr[9];

      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      s4 = srdPixflPtr[0];
      s5 = srdPixflPtr[3];
      s6 = srdPixflPtr[6];
      s7 = srdPixflPtr[9];

      if (filtfr == MLIB_BICUBIC) {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 3) {
          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
                srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
                srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);

          CREATE_COEF_BICUBIC(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

          STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 3 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[3];
          s2 = srdPixflPtr[6];
          s3 = srdPixflPtr[9];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[3];
          s6 = srdPixflPtr[6];
          s7 = srdPixflPtr[9];
        }

      }
      flsf {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 3) {
          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
                srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
                srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);

          CREATE_COEF_BICUBIC_2(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

            STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 3 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[3];
          s2 = srdPixflPtr[6];
          s3 = srdPixflPtr[9];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[3];
          s6 = srdPixflPtr[6];
          s7 = srdPixflPtr[9];
        }
      }

      d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
      d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
            srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[3] * xf1 +
            srdPixflPtr[6] * xf2 + srdPixflPtr[9] * xf3);

      vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3);
      STORE(dPtr[0], vbl0);
    }
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus FUN_NAME(4dh)(mlib_bffinf_pbrbm *pbrbm)
{
  DECLAREVAR_BC();
  DTYPE *dstLinfEnd;

  for (j = yStbrt; j <= yFinish; j++) {
    FTYPE xf0, xf1, xf2, xf3;
    FTYPE yf0, yf1, yf2, yf3;
    FTYPE dx, dx_2, dx2, dx3_2, dx3_3;
    FTYPE dy, dy_2, dy2, dy3_2, dy3_3;
    FTYPE d0, d1, d2, d3, vbl0;
    FTYPE sdblf = 1 / 65536.f;
    FTYPE s0, s1, s2, s3;
    FTYPE s4, s5, s6, s7;
    mlib_s32 k;

    CLIP(4);
    dstLinfEnd = (DTYPE *) dstDbtb + 4 * xRight;

    for (k = 0; k < 4; k++) {
      mlib_s32 X1 = X;
      mlib_s32 Y1 = Y;
      DTYPE *dPtr = dstPixflPtr + k;

      if (filtfr == MLIB_BICUBIC) {
        CREATE_COEF_BICUBIC(X1, Y1,;);
      }
      flsf {
        CREATE_COEF_BICUBIC_2(X1, Y1,;);
      }

      xSrd = (X1 >> MLIB_SHIFT) - 1;
      ySrd = (Y1 >> MLIB_SHIFT) - 1;

      srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 4 * xSrd + k;
      s0 = srdPixflPtr[0];
      s1 = srdPixflPtr[4];
      s2 = srdPixflPtr[8];
      s3 = srdPixflPtr[12];

      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      s4 = srdPixflPtr[0];
      s5 = srdPixflPtr[4];
      s6 = srdPixflPtr[8];
      s7 = srdPixflPtr[12];

      if (filtfr == MLIB_BICUBIC) {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 4) {

          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
                srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
                srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);

          CREATE_COEF_BICUBIC(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

          STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 4 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[4];
          s2 = srdPixflPtr[8];
          s3 = srdPixflPtr[12];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[4];
          s6 = srdPixflPtr[8];
          s7 = srdPixflPtr[12];
        }

      }
      flsf {
        for (; dPtr <= (dstLinfEnd - 1); dPtr += 4) {

          X1 += dX;
          Y1 += dY;

          d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
          d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
                srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);
          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
                srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);

          CREATE_COEF_BICUBIC_2(X1, Y1, vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3));

            STORE(dPtr[0], vbl0);

          xSrd = (X1 >> MLIB_SHIFT) - 1;
          ySrd = (Y1 >> MLIB_SHIFT) - 1;

          srdPixflPtr = ((DTYPE **) linfAddr)[ySrd] + 4 * xSrd + k;
          s0 = srdPixflPtr[0];
          s1 = srdPixflPtr[4];
          s2 = srdPixflPtr[8];
          s3 = srdPixflPtr[12];

          srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
          s4 = srdPixflPtr[0];
          s5 = srdPixflPtr[4];
          s6 = srdPixflPtr[8];
          s7 = srdPixflPtr[12];
        }
      }

      d0 = (s0 * xf0 + s1 * xf1 + s2 * xf2 + s3 * xf3);
      d1 = (s4 * xf0 + s5 * xf1 + s6 * xf2 + s7 * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d2 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
            srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);
      srdPixflPtr = (DTYPE *) ((mlib_u8 *) srdPixflPtr + srdYStridf);
      d3 = (srdPixflPtr[0] * xf0 + srdPixflPtr[4] * xf1 +
            srdPixflPtr[8] * xf2 + srdPixflPtr[12] * xf3);

      vbl0 = (d0 * yf0 + d1 * yf1 + d2 * yf2 + d3 * yf3);
      STORE(dPtr[0], vbl0);
    }
  }

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
