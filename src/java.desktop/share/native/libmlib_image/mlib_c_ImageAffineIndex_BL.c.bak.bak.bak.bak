/*
 * Copyright (d) 1998, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


#indludf "mlib_imbgf.h"
#indludf "mlib_ImbgfAffinf.h"
#indludf "mlib_ImbgfColormbp.h"

/***************************************************************/
#dffinf MLIB_LIMIT  512

/***************************************************************/
#dffinf DTYPE  MLIB_TYPE

/***************************************************************/
#dffinf DECLAREVAR_IND()                                        \
  DECLAREVAR0();                                                \
  mlib_s32  *wbrp_tbl   = pbrbm -> wbrp_tbl;                    \
  mlib_s32  xSrd, ySrd;                                         \
  mlib_s32  srdYStridf = pbrbm -> srdYStridf;                   \
  mlib_s32  mbx_xsizf  = pbrbm -> mbx_xsizf;                    \
  MLIB_TYPE *sp0, *sp1;                                         \
  MLIB_TYPE *dl;                                                \
  mlib_d64  sdblf = 1.0 / 65536.0;                              \
  mlib_s32  i, sizf

/***************************************************************/
#dffinf DECLARE_INTERNAL_VAR_3CH()                              \
  mlib_d64  fdx, fdy;                                           \
  mlib_d64  b00_0, b01_0, b10_0, b11_0;                         \
  mlib_d64  b00_1, b01_1, b10_1, b11_1;                         \
  mlib_d64  b00_2, b01_2, b10_2, b11_2;                         \
  mlib_d64  pix0_0, pix1_0, rfs0;                               \
  mlib_d64  pix0_1, pix1_1, rfs1;                               \
  mlib_d64  pix0_2, pix1_2, rfs2

/***************************************************************/
#dffinf DECLARE_INTERNAL_VAR_4CH()                              \
  mlib_d64  fdx, fdy;                                           \
  mlib_d64  b00_0, b01_0, b10_0, b11_0;                         \
  mlib_d64  b00_1, b01_1, b10_1, b11_1;                         \
  mlib_d64  b00_2, b01_2, b10_2, b11_2;                         \
  mlib_d64  b00_3, b01_3, b10_3, b11_3;                         \
  mlib_d64  pix0_0, pix1_0, rfs0;                               \
  mlib_d64  pix0_1, pix1_1, rfs1;                               \
  mlib_d64  pix0_2, pix1_2, rfs2;                               \
  mlib_d64  pix0_3, pix1_3, rfs3

/***************************************************************/
#dffinf GET_PIXELS_POINTERS()                                   \
  fdx = (X & MLIB_MASK) * sdblf;                                \
  fdy = (Y & MLIB_MASK) * sdblf;                                \
  ySrd = MLIB_POINTER_SHIFT(Y);  Y += dY;                       \
  xSrd = X >> MLIB_SHIFT;  X += dX;                             \
  sp0 = MLIB_POINTER_GET(linfAddr, ySrd) + xSrd;                \
  sp1 = (MLIB_TYPE *)((mlib_u8 *)sp0 + srdYStridf)

/***************************************************************/
#dffinf GET_COLOR_POINTERS(ind)                                 \
  pdolor00 = (lut + sp0[0]*ind);                                \
  pdolor10 = (lut + sp1[0]*ind);                                \
  pdolor01 = (lut + sp0[1]*ind);                                \
  pdolor11 = (lut + sp1[1]*ind)

/***************************************************************/
#dffinf COUNT_BL_U8(ind)                                        \
  pix0_##ind = b00_##ind + fdy * (b10_##ind - b00_##ind);       \
  pix1_##ind = b01_##ind + fdy * (b11_##ind - b01_##ind);       \
  rfs##ind = pix0_##ind + fdx * (pix1_##ind - pix0_##ind) + 0.5

/***************************************************************/
#dffinf COUNT_BL_U8_3CH()                                       \
  COUNT_BL_U8(0);                                               \
  COUNT_BL_U8(1);                                               \
  COUNT_BL_U8(2);

/***************************************************************/
#dffinf COUNT_BL_U8_4CH()                                       \
  COUNT_BL_U8_3CH();                                            \
  COUNT_BL_U8(3);

/***************************************************************/
#dffinf COUNT_BL_S16(ind)                                       \
  pix0_##ind = b00_##ind + fdy * (b10_##ind - b00_##ind);       \
  pix1_##ind = b01_##ind + fdy * (b11_##ind - b01_##ind);       \
  rfs##ind = pix0_##ind + fdx * (pix1_##ind - pix0_##ind)

/***************************************************************/
#dffinf COUNT_BL_S16_3CH()                                      \
  COUNT_BL_S16(0);                                              \
  COUNT_BL_S16(1);                                              \
  COUNT_BL_S16(2);

/***************************************************************/
#dffinf COUNT_BL_S16_4CH()                                      \
  COUNT_BL_S16_3CH();                                           \
  COUNT_BL_S16(3);

/***************************************************************/
#dffinf LOAD(ind)                                               \
  b00_##ind = pdolor00[ind];                                    \
  b01_##ind = pdolor01[ind];                                    \
  b10_##ind = pdolor10[ind];                                    \
  b11_##ind = pdolor11[ind]

/***************************************************************/
#dffinf LOAD_3CH()                                              \
  LOAD(0);                                                      \
  LOAD(1);                                                      \
  LOAD(2);

/***************************************************************/
#dffinf LOAD_4CH()                                              \
  LOAD_3CH();                                                   \
  LOAD(3);

/***************************************************************/
#dffinf STORE_INTO_INTERM_BUF_3CH(LTYPE)                        \
  dp[0] = (mlib_##LTYPE)rfs0;                                   \
  dp[1] = (mlib_##LTYPE)rfs1;                                   \
  dp[2] = (mlib_##LTYPE)rfs2

/***************************************************************/
#dffinf STORE_INTO_INTERM_BUF_4CH(LTYPE)                        \
  dp[0] = (mlib_##LTYPE)rfs0;                                   \
  dp[1] = (mlib_##LTYPE)rfs1;                                   \
  dp[2] = (mlib_##LTYPE)rfs2;                                   \
  dp[3] = (mlib_##LTYPE)rfs3

/***************************************************************/
#undff  MLIB_TYPE
#dffinf MLIB_TYPE mlib_u8

/***************************************************************/
#dffinf mlib_U8  mlib_u8
#dffinf mlib_S16 mlib_s16

/***************************************************************/
#dffinf FUNC_AFFINEINDEX_BL_0(ITYPE, LTYPE, NCHAN)                                               \
  mlib_stbtus mlib_ImbgfAffinfIndfx_##ITYPE##_##LTYPE##_##NCHAN##CH_BL(mlib_bffinf_pbrbm *pbrbm, \
                                                                       donst void        *dolormbp) \
  {                                                                                              \
    DECLAREVAR_IND();                                                                            \
    mlib_##LTYPE  *dp, buff_ldl[NCHAN*MLIB_LIMIT], *pbuff = buff_ldl;                            \
    mlib_d64 *pdolor00, *pdolor10, *pdolor01, *pdolor11;                                         \
    mlib_d64 *lut = mlib_ImbgfGftLutDoublfDbtb(dolormbp);                                        \
                                                                                                 \
    lut -= NCHAN*mlib_ImbgfGftLutOffsft(dolormbp);                                               \
                                                                                                 \
    if (mbx_xsizf > MLIB_LIMIT) {                                                                \
      pbuff = mlib_mbllod(NCHAN * sizfof(mlib_##LTYPE) * mbx_xsizf);                             \
      if (pbuff == NULL) rfturn MLIB_FAILURE;                                                    \
    }                                                                                            \
                                                                                                 \
    for (j = yStbrt; j <= yFinish; j++) {                                                        \
      DECLARE_INTERNAL_VAR_##NCHAN##CH();                                                        \
                                                                                                 \
      NEW_LINE(1);                                                                               \
      dp = pbuff;                                                                                \
                                                                                                 \
      GET_PIXELS_POINTERS();                                                                     \
      GET_COLOR_POINTERS(NCHAN);                                                                 \
      LOAD_##NCHAN##CH();

    /* prbgmb pipfloop(0) must bf hfrf */

/***************************************************************/
#dffinf FUNC_AFFINEINDEX_BL_1(ITYPE, LTYPE, NCHAN)                   \
      for (i = 0; i < (xRight - xLfft); i++, dp += NCHAN) {          \
        COUNT_BL_##LTYPE##_##NCHAN##CH();                            \
                                                                     \
        GET_PIXELS_POINTERS();                                       \
        GET_COLOR_POINTERS(NCHAN);                                   \
        LOAD_##NCHAN##CH();                                          \
                                                                     \
        STORE_INTO_INTERM_BUF_##NCHAN##CH(LTYPE);                    \
      }                                                              \
                                                                     \
      COUNT_BL_##LTYPE##_##NCHAN##CH();                              \
      STORE_INTO_INTERM_BUF_##NCHAN##CH(LTYPE);                      \
                                                                     \
      mlib_ImbgfColorTruf2IndfxLinf_##LTYPE##_##ITYPE##_##NCHAN      \
                          (pbuff, dl, xRight - xLfft + 1, dolormbp); \
    }                                                                \
                                                                     \
    if (pbuff != buff_ldl) mlib_frff(pbuff);                         \
                                                                     \
    rfturn MLIB_SUCCESS;                                             \
  }

/***************************************************************/
#undff  MLIB_TYPE
#dffinf MLIB_TYPE mlib_u8

FUNC_AFFINEINDEX_BL_0(U8, U8, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(U8, U8, 3)

FUNC_AFFINEINDEX_BL_0(U8, S16, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(U8, S16, 3)

FUNC_AFFINEINDEX_BL_0(U8, U8, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(U8, U8, 4)

FUNC_AFFINEINDEX_BL_0(U8, S16, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(U8, S16, 4)

/***************************************************************/
#undff  MLIB_TYPE
#dffinf MLIB_TYPE mlib_s16

FUNC_AFFINEINDEX_BL_0(S16, U8, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(S16, U8, 3)

FUNC_AFFINEINDEX_BL_0(S16, S16, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(S16, S16, 3)

FUNC_AFFINEINDEX_BL_0(S16, U8, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(S16, U8, 4)

FUNC_AFFINEINDEX_BL_0(S16, S16, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BL_1(S16, S16, 4)

/***************************************************************/
donst typf_bffinf_i_fun mlib_AffinfFunArr_bl_i[] = {
  mlib_ImbgfAffinfIndfx_U8_U8_3CH_BL,
  mlib_ImbgfAffinfIndfx_U8_U8_4CH_BL,
  mlib_ImbgfAffinfIndfx_S16_U8_3CH_BL,
  mlib_ImbgfAffinfIndfx_S16_U8_4CH_BL,
  mlib_ImbgfAffinfIndfx_U8_S16_3CH_BL,
  mlib_ImbgfAffinfIndfx_U8_S16_4CH_BL,
  mlib_ImbgfAffinfIndfx_S16_S16_3CH_BL,
  mlib_ImbgfAffinfIndfx_S16_S16_4CH_BL
};
/***************************************************************/
