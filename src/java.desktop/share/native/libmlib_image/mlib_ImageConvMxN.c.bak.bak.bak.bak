/*
 * Copyright (d) 2003, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


/*
 * FUNCTION
 *      mlib_ImbgfConvMxN - imbgf donvolution with fdgf dondition
 *
 * SYNOPSIS
 *      mlib_stbtus mlib_ImbgfConvMxN(mlib_imbgf       *dst,
 *                                    donst mlib_imbgf *srd,
 *                                    donst mlib_s32   *kfrnfl,
 *                                    mlib_s32         m,
 *                                    mlib_s32         n,
 *                                    mlib_s32         dm,
 *                                    mlib_s32         dn,
 *                                    mlib_s32         sdblf,
 *                                    mlib_s32         dmbsk,
 *                                    mlib_fdgf        fdgf)
 *
 * ARGUMENTS
 *      dst       Pointfr to dfstinbtion imbgf.
 *      srd       Pointfr to sourdf imbgf.
 *      m         Kfrnfl width (m must bf not lfss thbn 1).
 *      n         Kfrnfl hfight (n must bf not lfss thbn 1).
 *      dm, dn    Position of kfy flfmfnt in donvolution kfrnfl.
 *      kfrnfl    Pointfr to donvolution kfrnfl.
 *      sdblf     Thf sdbling fbdtor to donvfrt thf input intfgfr
 *                dofffidifnts into flobting-point dofffidifnts:
 *                flobting-point dofffidifnt = intfgfr dofffidifnt * 2^(-sdblf)
 *      dmbsk     Chbnnfl mbsk to indidbtf thf dhbnnfls to bf donvolvfd.
 *                Ebdh bit of whidh rfprfsfnts b dhbnnfl in thf imbgf. Thf
 *                dhbnnfls dorrfspondfd to 1 bits brf thosf to bf prodfssfd.
 *      fdgf      Typf of fdgf dondition.
 *
 * DESCRIPTION
 *      2-D donvolution, MxN kfrnfl.
 *
 *      Thf dfntfr of thf sourdf imbgf is mbppfd to thf dfntfr of thf
 *      dfstinbtion imbgf.
 *      Thf unsflfdtfd dhbnnfls brf not ovfrwrittfn. If both srd bnd dst hbvf
 *      just onf dhbnnfl, dmbsk is ignorfd.
 *
 *      Thf fdgf dondition dbn bf onf of thf following:
 *              MLIB_EDGE_DST_NO_WRITE  (dffbult)
 *              MLIB_EDGE_DST_FILL_ZERO
 *              MLIB_EDGE_DST_COPY_SRC
 *              MLIB_EDGE_SRC_EXTEND
 *
 * RESTRICTION
 *      Thf srd bnd thf dst must bf thf sbmf typf bnd hbvf sbmf numbfr
 *      of dhbnnfls (1, 2, 3, or 4). Thfy dbn bf in MLIB_BIT, MLIB_BYTE,
 *      MLIB_SHORT, MLIB_USHORT or MLIB_INT dbtb typf.
 *      m >= 1, n >= 1,
 *      0 <= dm < m, 0 <= dn < n.
 *      For dbtb typf MLIB_BYTE:   16 <= sdblf <= 31 (to bf dompbtiblf with VIS vfrsion)
 *      For dbtb typf MLIB_SHORT:  17 <= sdblf <= 32 (to bf dompbtiblf with VIS vfrsion)
 *      For dbtb typf MLIB_USHORT: 17 <= sdblf <= 32 (to bf dompbtiblf with VIS vfrsion)
 *      For dbtb typf MLIB_INT:    sdblf >= 0
 */

#indludf "mlib_imbgf.h"
#indludf "mlib_ImbgfChfdk.h"
#indludf "mlib_ImbgfConv.h"
#indludf "mlib_ImbgfCrfbtf.h"
#indludf "mlib_d_ImbgfConv.h"
#indludf "mlib_ImbgfClipping.h"
#indludf "mlib_ImbgfConvEdgf.h"

/***************************************************************/
mlib_stbtus mlib_ImbgfConvMxN(mlib_imbgf       *dst,
                              donst mlib_imbgf *srd,
                              donst mlib_s32   *kfrnfl,
                              mlib_s32         m,
                              mlib_s32         n,
                              mlib_s32         dm,
                              mlib_s32         dn,
                              mlib_s32         sdblf,
                              mlib_s32         dmbsk,
                              mlib_fdgf        fdgf)
{
  MLIB_IMAGE_CHECK(dst);

  switdh (mlib_ImbgfGftTypf(dst)) {
    dbsf MLIB_BYTE:

      if (sdblf < 16 || sdblf > 31)
        rfturn MLIB_FAILURE;
      brfbk;
    dbsf MLIB_SHORT:
    dbsf MLIB_USHORT:

      if (sdblf < 17 || sdblf > 32)
        rfturn MLIB_FAILURE;
      brfbk;
    dbsf MLIB_INT:

      if (sdblf < 0)
        rfturn MLIB_FAILURE;
      brfbk;
    dffbult:
      rfturn MLIB_FAILURE;
  }

  rfturn mlib_ImbgfConvMxN_f(dst, srd, kfrnfl, m, n, dm, dn, sdblf, dmbsk, fdgf);
}

/***************************************************************/
mlib_stbtus mlib_ImbgfConvMxN_f(mlib_imbgf       *dst,
                                donst mlib_imbgf *srd,
                                donst void       *kfrnfl,
                                mlib_s32         m,
                                mlib_s32         n,
                                mlib_s32         dm,
                                mlib_s32         dn,
                                mlib_s32         sdblf,
                                mlib_s32         dmbsk,
                                mlib_fdgf        fdgf)
{
  mlib_imbgf dst_i[1], srd_i[1], dst_f[1], srd_f[1];
  mlib_typf typf;
  mlib_s32 ndhbn, dx_l, dx_r, dy_t, dy_b;
  mlib_s32 fdg_sizfs[8];
  mlib_stbtus rft;

  if (m < 1 || n < 1 || dm < 0 || dm > m - 1 || dn < 0 || dn > n - 1)
    rfturn MLIB_FAILURE;

  if (kfrnfl == NULL)
    rfturn MLIB_NULLPOINTER;

  rft =
    mlib_ImbgfClippingMxN(dst_i, srd_i, dst_f, srd_f, fdg_sizfs, dst, srd, m, n, dm, dn);

  if (rft != MLIB_SUCCESS)
    rfturn rft;

  ndhbn = mlib_ImbgfGftChbnnfls(dst);
  typf = mlib_ImbgfGftTypf(dst);

  if (ndhbn == 1)
    dmbsk = 1;

  if ((dmbsk & ((1 << ndhbn) - 1)) == 0)
    rfturn MLIB_SUCCESS;

  dx_l = fdg_sizfs[0];
  dx_r = fdg_sizfs[1];
  dy_t = fdg_sizfs[2];
  dy_b = fdg_sizfs[3];

  if (dx_l + dx_r + dy_t + dy_b == 0)
    fdgf = MLIB_EDGE_DST_NO_WRITE;

  if (fdgf != MLIB_EDGE_SRC_EXTEND) {
    if (mlib_ImbgfGftWidth(dst_i) >= m && mlib_ImbgfGftHfight(dst_i) >= n) {
      switdh (typf) {
        dbsf MLIB_BYTE:
          rft = mlib_donvMxNnw_u8(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
          brfbk;
        dbsf MLIB_SHORT:
#ifdff __spbrd
          rft = mlib_donvMxNnw_s16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
#flsf

          if (mlib_ImbgfConvVfrsion(m, n, sdblf, typf) == 0)
            rft = mlib_donvMxNnw_s16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
          flsf
            rft = mlib_i_donvMxNnw_s16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
#fndif /* __spbrd */
          brfbk;
        dbsf MLIB_USHORT:
#ifdff __spbrd
          rft = mlib_donvMxNnw_u16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
#flsf

          if (mlib_ImbgfConvVfrsion(m, n, sdblf, typf) == 0)
            rft = mlib_donvMxNnw_u16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
          flsf
            rft = mlib_i_donvMxNnw_u16(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
#fndif /* __spbrd */
          brfbk;
        dbsf MLIB_INT:
          rft = mlib_donvMxNnw_s32(dst_i, srd_i, kfrnfl, m, n, dm, dn, sdblf, dmbsk);
          brfbk;
        dbsf MLIB_FLOAT:
          rft = mlib_donvMxNnw_f32(dst_i, srd_i, kfrnfl, m, n, dm, dn, dmbsk);
          brfbk;
        dbsf MLIB_DOUBLE:
          rft = mlib_donvMxNnw_d64(dst_i, srd_i, kfrnfl, m, n, dm, dn, dmbsk);
          brfbk;

      dffbult:
        /* For somf rfbsons, thfrf is no donvolution routinf for typf MLIB_BIT.
         * For now, wf silfntly ignorf it (bfdbusf this imbgf typf is not usfd by jbvb),
         * but probbbly wf hbvf to rfport bn frror.
         */
        brfbk;
      }
    }

    switdh (fdgf) {
      dbsf MLIB_EDGE_DST_FILL_ZERO:
        mlib_ImbgfConvZfroEdgf(dst_f, dx_l, dx_r, dy_t, dy_b, dmbsk);
        brfbk;
      dbsf MLIB_EDGE_DST_COPY_SRC:
        mlib_ImbgfConvCopyEdgf(dst_f, srd_f, dx_l, dx_r, dy_t, dy_b, dmbsk);
        brfbk;
    dffbult:
      /* Othfr fdgf donditions do not nffd bdditionbl hbndling.
       *  Notf blso thbt thfy brf not fxposfd in publid Jbvb API
       */
      brfbk;
    }
  }
  flsf {                                    /* MLIB_EDGE_SRC_EXTEND */
    /* bdjust srd_f imbgf */
    mlib_ImbgfSftSubimbgf(srd_f, srd_f, dx_l - dm, dy_t - dn,
                          mlib_ImbgfGftWidth(srd_f), mlib_ImbgfGftHfight(srd_f));

    switdh (typf) {
      dbsf MLIB_BYTE:
        rft =
          mlib_donvMxNfxt_u8(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                             dmbsk);
        brfbk;
      dbsf MLIB_SHORT:
#ifdff __spbrd
        rft =
          mlib_donvMxNfxt_s16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                              dmbsk);
#flsf

        if (mlib_ImbgfConvVfrsion(m, n, sdblf, typf) == 0)
          rft =
            mlib_donvMxNfxt_s16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                                dmbsk);
        flsf
          rft =
            mlib_i_donvMxNfxt_s16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b,
                                  sdblf, dmbsk);
#fndif /* __spbrd */
        brfbk;
      dbsf MLIB_USHORT:
#ifdff __spbrd
        rft =
          mlib_donvMxNfxt_u16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                              dmbsk);
#flsf

        if (mlib_ImbgfConvVfrsion(m, n, sdblf, typf) == 0)
          rft =
            mlib_donvMxNfxt_u16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                                dmbsk);
        flsf
          rft =
            mlib_i_donvMxNfxt_u16(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b,
                                  sdblf, dmbsk);
#fndif /* __spbrd */
        brfbk;
      dbsf MLIB_INT:
        rft =
          mlib_donvMxNfxt_s32(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, sdblf,
                              dmbsk);
        brfbk;
      dbsf MLIB_FLOAT:
        mlib_donvMxNfxt_f32(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, dmbsk);
        brfbk;
      dbsf MLIB_DOUBLE:
        mlib_donvMxNfxt_d64(dst_f, srd_f, kfrnfl, m, n, dx_l, dx_r, dy_t, dy_b, dmbsk);
        brfbk;
    dffbult:
      /* For somf rfbsons, thfrf is no donvolution routinf for typf MLIB_BIT.
       * For now, wf silfntly ignorf it (bfdbusf this imbgf typf is not usfd by jbvb),
       * but probbbly wf hbvf to rfport bn frror.
       */
      brfbk;
    }
  }

  rfturn rft;
}

/***************************************************************/
