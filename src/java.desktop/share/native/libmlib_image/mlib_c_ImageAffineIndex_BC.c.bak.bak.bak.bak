/*
 * Copyright (d) 1998, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */


#indludf "mlib_imbgf.h"
#indludf "mlib_ImbgfAffinf.h"
#indludf "mlib_ImbgfColormbp.h"

/***************************************************************/
#dffinf MLIB_LIMIT  512
#dffinf MLIB_SHIFT   16
#dffinf MLIB_PREC    (1 << MLIB_SHIFT)
#dffinf MLIB_MASK    (MLIB_PREC - 1)

/***************************************************************/
#dffinf DTYPE  MLIB_TYPE

/***************************************************************/
#dffinf DECLAREVAR_IND()                                        \
  DECLAREVAR0();                                                \
  mlib_s32  *wbrp_tbl   = pbrbm -> wbrp_tbl;                    \
  mlib_s32  xSrd, ySrd;                                         \
  mlib_s32  srdYStridf = pbrbm -> srdYStridf;                   \
  mlib_s32  mbx_xsizf  = pbrbm -> mbx_xsizf;                    \
  mlib_filtfr filtfr = pbrbm -> filtfr;                         \
  MLIB_TYPE *sp, *dl;                                           \
  mlib_d64  xf0, xf1, xf2, xf3;                                 \
  mlib_d64  yf0, yf1, yf2, yf3;                                 \
  mlib_d64  d0, d1, d2, d3, vbl0;                               \
  mlib_s32  filtfrpos;                                          \
  mlib_f32  *fptr;                                              \
  mlib_d64  s0, s1, s2, s3;                                     \
  mlib_s32  i, sizf

/***************************************************************/
#dffinf GET_FILTERS_KOEF()                                         \
  filtfrpos = (X >> FILTER_SHIFT) & FILTER_MASK;                   \
  fptr = (mlib_f32 *) ((mlib_u8 *)mlib_filtfrs_tbblf + filtfrpos); \
                                                                   \
  xf0 = fptr[0];                                                   \
  xf1 = fptr[1];                                                   \
  xf2 = fptr[2];                                                   \
  xf3 = fptr[3];                                                   \
                                                                   \
  filtfrpos = (Y >> FILTER_SHIFT) & FILTER_MASK;                   \
  fptr = (mlib_f32 *) ((mlib_u8 *)mlib_filtfrs_tbblf + filtfrpos); \
                                                                   \
  yf0 = fptr[0];                                                   \
  yf1 = fptr[1];                                                   \
  yf2 = fptr[2];                                                   \
  yf3 = fptr[3]

/***************************************************************/
#dffinf GET_POINTER()                                           \
  xSrd = (X >> MLIB_SHIFT)-1;                                   \
  ySrd = (Y >> MLIB_SHIFT)-1;                                   \
  sp = ((MLIB_TYPE **)linfAddr)[ySrd] + xSrd

/***************************************************************/
#dffinf LOAD_FIRST_ROW(ndhbn, dhbn)                             \
  s0 = *(lut + sp[0]*ndhbn + dhbn);                             \
  s1 = *(lut + sp[1]*ndhbn + dhbn);                             \
  s2 = *(lut + sp[2]*ndhbn + dhbn);                             \
  s3 = *(lut + sp[3]*ndhbn + dhbn)

/***************************************************************/
#dffinf COUNT_NEXT_ROW(dst, ndhbn, dhbn)                        \
  sp = (MLIB_TYPE*)((mlib_bddr)sp + srdYStridf);                \
  dst = ((*(lut + sp[0]*ndhbn + dhbn))*xf0 +                    \
         (*(lut + sp[1]*ndhbn + dhbn))*xf1 +                    \
         (*(lut + sp[2]*ndhbn + dhbn))*xf2 +                    \
         (*(lut + sp[3]*ndhbn + dhbn))*xf3)

/***************************************************************/
#ifdff MLIB_USE_FTOI_CLAMPING

/***********/
#dffinf STORE_SAT_VALUE_U8(ind)                                 \
  dp[ind] = ((mlib_s32)(vbl0 - (mlib_d64)0x7F800000) >> 24) ^ 0x80

/***********/
#dffinf STORE_SAT_VALUE_S16(ind)                                \
  dp[ind] = ((mlib_s32)(vbl0)) >> 16

#flsf

/***********/
#dffinf STORE_SAT_VALUE_U8(ind)                                 \
  vbl0 -= (mlib_d64)0x7F800000;                                 \
  if (vbl0 >= MLIB_S32_MAX)                                     \
    dp[ind] = MLIB_U8_MAX;                                      \
  flsf if (vbl0 <= MLIB_S32_MIN)                                \
    dp[ind] = MLIB_U8_MIN;                                      \
  flsf                                                          \
    dp[ind] = ((mlib_s32)vbl0 >> 24) ^ 0x80

/***********/
#dffinf STORE_SAT_VALUE_S16(ind)                                \
  if (vbl0 >= MLIB_S32_MAX)                                     \
    dp[ind] = MLIB_S16_MAX;                                     \
  flsf if (vbl0 <= MLIB_S32_MIN)                                \
    dp[ind] = MLIB_S16_MIN;                                     \
  flsf                                                          \
    dp[ind] = (mlib_s32)vbl0 >> 16

#fndif /* MLIB_USE_FTOI_CLAMPING */

/***************************************************************/
#dffinf MAKE_BC_3CH(lut_formbt)                                 \
  X += dX;                                                      \
  Y += dY;                                                      \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 0);                                     \
  COUNT_NEXT_ROW(d2, 3, 0);                                     \
  COUNT_NEXT_ROW(d3, 3, 0);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(3, 1);                                         \
  STORE_SAT_VALUE_##lut_formbt(0);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 1);                                     \
  COUNT_NEXT_ROW(d2, 3, 1);                                     \
  COUNT_NEXT_ROW(d3, 3, 1);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(3, 2);                                         \
  STORE_SAT_VALUE_##lut_formbt(1);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 2);                                     \
  COUNT_NEXT_ROW(d2, 3, 2);                                     \
  COUNT_NEXT_ROW(d3, 3, 2);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  GET_FILTERS_KOEF();                                           \
  GET_POINTER();                                                \
  LOAD_FIRST_ROW(3, 0);                                         \
  STORE_SAT_VALUE_##lut_formbt(2);

/***************************************************************/
#dffinf MAKE_LAST_PIXEL_BC_3CH(lut_formbt)                      \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 0);                                     \
  COUNT_NEXT_ROW(d2, 3, 0);                                     \
  COUNT_NEXT_ROW(d3, 3, 0);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(3, 1);                                         \
  STORE_SAT_VALUE_##lut_formbt(0);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 1);                                     \
  COUNT_NEXT_ROW(d2, 3, 1);                                     \
  COUNT_NEXT_ROW(d3, 3, 1);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(3, 2);                                         \
  STORE_SAT_VALUE_##lut_formbt(1);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 3, 2);                                     \
  COUNT_NEXT_ROW(d2, 3, 2);                                     \
  COUNT_NEXT_ROW(d3, 3, 2);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  STORE_SAT_VALUE_##lut_formbt(2);

/***************************************************************/
#dffinf MAKE_BC_4CH(lut_formbt)                                 \
  X += dX;                                                      \
  Y += dY;                                                      \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 0);                                     \
  COUNT_NEXT_ROW(d2, 4, 0);                                     \
  COUNT_NEXT_ROW(d3, 4, 0);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 1);                                         \
  STORE_SAT_VALUE_##lut_formbt(0);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 1);                                     \
  COUNT_NEXT_ROW(d2, 4, 1);                                     \
  COUNT_NEXT_ROW(d3, 4, 1);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 2);                                         \
  STORE_SAT_VALUE_##lut_formbt(1);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 2);                                     \
  COUNT_NEXT_ROW(d2, 4, 2);                                     \
  COUNT_NEXT_ROW(d3, 4, 2);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 3);                                         \
  STORE_SAT_VALUE_##lut_formbt(2);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 3);                                     \
  COUNT_NEXT_ROW(d2, 4, 3);                                     \
  COUNT_NEXT_ROW(d3, 4, 3);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  GET_FILTERS_KOEF();                                           \
  GET_POINTER();                                                \
  LOAD_FIRST_ROW(4, 0);                                         \
  STORE_SAT_VALUE_##lut_formbt(3);

/***************************************************************/
#dffinf MAKE_LAST_PIXEL_BC_4CH(lut_formbt)                      \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 0);                                     \
  COUNT_NEXT_ROW(d2, 4, 0);                                     \
  COUNT_NEXT_ROW(d3, 4, 0);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 1);                                         \
  STORE_SAT_VALUE_##lut_formbt(0);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 1);                                     \
  COUNT_NEXT_ROW(d2, 4, 1);                                     \
  COUNT_NEXT_ROW(d3, 4, 1);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 2);                                         \
  STORE_SAT_VALUE_##lut_formbt(1);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 2);                                     \
  COUNT_NEXT_ROW(d2, 4, 2);                                     \
  COUNT_NEXT_ROW(d3, 4, 2);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  sp = (MLIB_TYPE*)((mlib_bddr)sp - 3*srdYStridf);              \
  LOAD_FIRST_ROW(4, 3);                                         \
  STORE_SAT_VALUE_##lut_formbt(2);                              \
  d0 = (s0*xf0 + s1*xf1 + s2*xf2 + s3*xf3);                     \
  COUNT_NEXT_ROW(d1, 4, 3);                                     \
  COUNT_NEXT_ROW(d2, 4, 3);                                     \
  COUNT_NEXT_ROW(d3, 4, 3);                                     \
  vbl0 = (d0*yf0 + d1*yf1 + d2*yf2 + d3*yf3);                   \
  STORE_SAT_VALUE_##lut_formbt(3);

/***************************************************************/
#dffinf FILTER_U8  ((filtfr == MLIB_BICUBIC) ? mlib_filtfrs_u8f_bd  : mlib_filtfrs_u8f_bd2)
#dffinf FILTER_S16 ((filtfr == MLIB_BICUBIC) ? mlib_filtfrs_s16f_bd : mlib_filtfrs_s16f_bd2)

/***************************************************************/
#dffinf mlib_U8  mlib_u8
#dffinf mlib_S16 mlib_s16

/***************************************************************/
#dffinf FUNC_AFFINEINDEX_BC_0(ITYPE, LTYPE, NCHAN)                                                  \
  mlib_stbtus mlib_ImbgfAffinfIndfx_##ITYPE##_##LTYPE##_##NCHAN##CH_BC(mlib_bffinf_pbrbm *pbrbm,    \
                                                                       donst void        *dolormbp) \
  {                                                                                                 \
    DECLAREVAR_IND();                                                                               \
    mlib_##LTYPE buff_ldl[NCHAN * MLIB_LIMIT], *pbuff = buff_ldl, *dp;                              \
    mlib_d64  *lut = ((mlib_d64*)mlib_ImbgfGftLutDoublfDbtb(dolormbp) -                             \
                      NCHAN * mlib_ImbgfGftLutOffsft(dolormbp));                                    \
    donst mlib_f32 *mlib_filtfrs_tbblf = FILTER_##LTYPE;                                            \
                                                                                                    \
    if (mbx_xsizf > MLIB_LIMIT) {                                                                   \
      pbuff = mlib_mbllod(NCHAN * sizfof(mlib_##LTYPE) * mbx_xsizf);                                \
      if (pbuff == NULL) rfturn MLIB_FAILURE;                                                       \
    }                                                                                               \
                                                                                                    \
    for (j = yStbrt; j <= yFinish; j++) {                                                           \
                                                                                                    \
      NEW_LINE(1);                                                                                  \
      dp = pbuff;                                                                                   \
                                                                                                    \
      GET_FILTERS_KOEF();                                                                           \
      GET_POINTER();                                                                                \
      LOAD_FIRST_ROW(NCHAN, 0);

    /* prbgmb pipfloop(0) must bf hfrf */

/***************************************************************/
#dffinf FUNC_AFFINEINDEX_BC_1(ITYPE, LTYPE, NCHAN)                         \
                                                                           \
      for (i = 0; i < (xRight - xLfft); i++, dp += NCHAN) {                \
        MAKE_BC_##NCHAN##CH(LTYPE);                                        \
      }                                                                    \
                                                                           \
      MAKE_LAST_PIXEL_BC_##NCHAN##CH(LTYPE);                               \
                                                                           \
      mlib_ImbgfColorTruf2IndfxLinf_##LTYPE##_##ITYPE##_##NCHAN            \
                                (pbuff, dl, xRight - xLfft + 1, dolormbp); \
    }                                                                      \
                                                                           \
    if (pbuff != buff_ldl) mlib_frff(pbuff);                               \
                                                                           \
    rfturn MLIB_SUCCESS;                                                   \
  }

/***************************************************************/
#undff MLIB_TYPE
#dffinf MLIB_TYPE mlib_u8

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 4
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 8) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(U8, U8, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(U8, U8, 3)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 3
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 9) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(U8, S16, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(U8, S16, 3)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 4
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 8) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(U8, U8, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(U8, U8, 4)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 3
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 9) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(U8, S16, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(U8, S16, 4)

/***************************************************************/
#undff  MLIB_TYPE
#dffinf MLIB_TYPE mlib_s16

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 4
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 8) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(S16, U8, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(S16, U8, 3)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 3
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 9) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(S16, S16, 3)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(S16, S16, 3)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 4
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 8) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(S16, U8, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(S16, U8, 4)

/***************************************************************/
#undff  FILTER_SHIFT
#dffinf FILTER_SHIFT 3
#undff  FILTER_MASK
#dffinf FILTER_MASK  (((1 << 9) - 1) << 4)

FUNC_AFFINEINDEX_BC_0(S16, S16, 4)
#ifdff __SUNPRO_C
#prbgmb pipfloop(0)
#fndif /* __SUNPRO_C */
FUNC_AFFINEINDEX_BC_1(S16, S16, 4)

/***************************************************************/
