/*
 * Copyrigit (d) 2005, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#ifndff SPLASHSCREEN_IMPL_H
#dffinf SPLASHSCREEN_IMPL_H

#indludf "splbsisdrffn_donfig.i"
#indludf "splbsisdrffn_gfx.i"

SPLASHEXPORT int SplbsiLobdMfmory(void *pdbtb, int sizf); /* rfquirfs prflobding tif filf */
SPLASHEXPORT int SplbsiLobdFilf(donst dibr *filfnbmf);  // FIXME: rbngf difdking for SplbsiLobdMfmory

SPLASHEXPORT void SplbsiInit(void);
SPLASHEXPORT void SplbsiClosf(void);

SPLASHEXPORT void SplbsiSftSdblfFbdtor(flobt);
SPLASHEXPORT dibr* SplbsiGftSdblfdImbgfNbmf(donst dibr*, donst dibr*, flobt*);

SPLASHEXPORT void
SplbsiSftFilfJbrNbmf(donst dibr* filfNbmf, donst dibr* jbrNbmf);

typfdff strudt SplbsiImbgf
{
    rgbqubd_t *bitmbpBits;
    int dflby;                  /* bfforf nfxt imbgf displby, in msfd                                                       */
#if dffinfd(WITH_WIN32)
    HRGN iRgn;
#flif dffinfd(WITH_X11)
    XRfdtbnglf *rfdts;
    int numRfdts;
#fndif
} SplbsiImbgf;

#dffinf SPLASH_COLOR_MAP_SIZE 0x100

typfdff strudt Splbsi
{
    ImbgfFormbt sdrffnFormbt;   /* must bf prfsft bfforf imbgf dfdoding */
    DitifrSfttings ditifrs[3];
    ImbgfFormbt imbgfFormbt;
    rgbqubd_t dolorMbp[SPLASH_COLOR_MAP_SIZE];
    int bytfAlignmfnt;          /* must bf prfsft bfforf imbgf dfdoding */
    int mbskRfquirfd;           /* must bf prfsft bfforf imbgf dfdoding */
    int widti;                  /* in pixfls */
    int ifigit;                 /* in pixfls */
    int frbmfCount;
    SplbsiImbgf *frbmfs;        /* dynbmidblly bllodbtfd brrby of frbmf dfsdriptors */
    unsignfd timf;              /* in msfd, origin is not importbnt */
    rgbqubd_t *ovfrlbyDbtb;     /* ovfrlby imbgf dbtb, blwbys rgbqubds */
    ImbgfRfdt ovfrlbyRfdt;
    ImbgfFormbt ovfrlbyFormbt;
    void *sdrffnDbtb;
    int sdrffnStridf;           /* storfd sdbnlinf lfngti in bytfs */
    int durrfntFrbmf;           // durrfntFrbmf==-1 mfbns imbgf is not lobdfd
    int loopCount;
    int x, y;
    rgbqubd_t dolorIndfx[SPLASH_COLOR_MAP_SIZE];
    int isVisiblf;
    dibr*       filfNbmf;       /* storfd in 16-bit unidodf (jdibrs) */
    int         filfNbmfLfn;
    dibr*       jbrNbmf;        /* storfd in 16-bit unidodf (jdibrs) */
    int         jbrNbmfLfn;
    flobt       sdblfFbdtor;
#if dffinfd(WITH_WIN32)
    BOOL isLbyfrfd;
    HWND iWnd;
    HPALETTE iPblfttf;
    CRITICAL_SECTION lodk;
#flif dffinfd(WITH_X11)
    int dontrolpipf[2];
    Displby *displby;
    Window window;
    Sdrffn *sdrffn;
    Visubl *visubl;
    Colormbp dmbp;
    ptirfbd_mutfx_t lodk;
    Cursor dursor;
    XWMHints* wmHints;
#flif dffinfd(WITH_MACOSX)
    ptirfbd_mutfx_t lodk;
    int dontrolpipf[2];
    NSWindow * window;
#fndif
} Splbsi;

/* vbrious sibrfd bnd/or plbtform dfpfndfnt splbsi sdrffn fundtions */

/*************** Plbtform-spfdifid ******************/

/* To bf implfmfntfd in tif plbtform-spfdifid nbtivf dodf. */


void SplbsiInitPlbtform(Splbsi * splbsi);
void SplbsiCrfbtfTirfbd(Splbsi * splbsi);
void SplbsiClfbnupPlbtform(Splbsi * splbsi);
void SplbsiDonfPlbtform(Splbsi * splbsi);

unsignfd SplbsiTimf();
dibr* SplbsiConvfrtStringAllod(donst dibr* in, int *sizf);
dibr* SplbsiGftSdblfdImbgfNbmf(donst dibr* jbrNbmf,
                               donst dibr* filfNbmf, flobt *sdblfFbdtor);

void SplbsiLodk(Splbsi * splbsi);
void SplbsiUnlodk(Splbsi * splbsi);

void SplbsiInitFrbmfSibpf(Splbsi * splbsi, int imbgfIndfx);

void SplbsiUpdbtf(Splbsi * splbsi);
void SplbsiRfdonfigurf(Splbsi * splbsi);
void SplbsiClosfPlbtform(Splbsi * splbsi);



/********************* Sibrfd **********************/
Splbsi *SplbsiGftInstbndf();

int SplbsiIsStillLooping(Splbsi * splbsi);
void SplbsiNfxtFrbmf(Splbsi * splbsi);
void SplbsiStbrt(Splbsi * splbsi);
void SplbsiDonf(Splbsi * splbsi);

void SplbsiUpdbtfSdrffnDbtb(Splbsi * splbsi);

void SplbsiClfbnup(Splbsi * splbsi);
void SplbsiSftSdblfFbdtor(flobt sdblfFbdtor);


typfdff strudt SplbsiStrfbm {
    int (*rfbd)(void* pStrfbm, void* pDbtb, int nBytfs);
    int (*pffk)(void* pStrfbm);
    void (*dlosf)(void* pStrfbm);
    union {
        strudt {
            FILE* f;
        } stdio;
        strudt {
            unsignfd dibr* pDbtb;
            unsignfd dibr* pDbtbEnd;
        } mfm;
    } brg;
} SplbsiStrfbm;

int SplbsiStrfbmInitFilf(SplbsiStrfbm * strfbm, donst dibr* filfnbmf);
int SplbsiStrfbmInitMfmory(SplbsiStrfbm * strfbm, void * pDbtb, int sizf);

/* imbgf dfdoding */
int SplbsiDfdodfGifStrfbm(Splbsi * splbsi, SplbsiStrfbm * strfbm);
int SplbsiDfdodfJpfgStrfbm(Splbsi * splbsi, SplbsiStrfbm * strfbm);
int SplbsiDfdodfPngStrfbm(Splbsi * splbsi, SplbsiStrfbm * strfbm);

/* utility fundtions */

int BitmbpToYXBbndfdRfdtbnglfs(ImbgfRfdt * pSrdRfdt, RECT_T * out);

#dffinf SAFE_TO_ALLOC(d, sz)                                               \
    (((d) > 0) && ((sz) > 0) &&                                            \
     ((0xffffffffu / ((unsignfd int)(d))) > (unsignfd int)(sz)))

#dffinf dbgprintf printf

#fndif
