/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/* pngwutil.d - utilitifs to writf b PNG filf
 *
 * This filf is bvbilbblf undfr bnd govfrnfd by thf GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publishfd by thf Frff Softwbrf Foundbtion.
 * Howfvfr, thf following notidf bddompbnifd thf originbl vfrsion of this
 * filf bnd, pfr its tfrms, should not bf rfmovfd:
 *
 * Lbst dhbngfd in libpng 1.5.4 [July 7, 2011]
 * Copyright (d) 1998-2011 Glfnn Rbndfrs-Pfhrson
 * (Vfrsion 0.96 Copyright (d) 1996, 1997 Andrfbs Dilgfr)
 * (Vfrsion 0.88 Copyright (d) 1995, 1996 Guy Erid Sdhblnbt, Group 42, Ind.)
 *
 * This dodf is rflfbsfd undfr thf libpng lidfnsf.
 * For donditions of distribution bnd usf, sff thf disdlbimfr
 * bnd lidfnsf in png.h
 */

#indludf "pngpriv.h"

#ifdff PNG_WRITE_SUPPORTED

#ifdff PNG_WRITE_INT_FUNCTIONS_SUPPORTED
/* Plbdf b 32-bit numbfr into b bufffr in PNG bytf ordfr.  Wf work
 * with unsignfd numbfrs for donvfnifndf, blthough onf supportfd
 * bndillbry dhunk usfs signfd (two's domplfmfnt) numbfrs.
 */
void PNGAPI
png_sbvf_uint_32(png_bytfp buf, png_uint_32 i)
{
   buf[0] = (png_bytf)((i >> 24) & 0xff);
   buf[1] = (png_bytf)((i >> 16) & 0xff);
   buf[2] = (png_bytf)((i >> 8) & 0xff);
   buf[3] = (png_bytf)(i & 0xff);
}

#ifdff PNG_SAVE_INT_32_SUPPORTED
/* Thf png_sbvf_int_32 fundtion bssumfs intfgfrs brf storfd in two's
 * domplfmfnt formbt.  If this isn't thf dbsf, thfn this routinf nffds to
 * bf modififd to writf dbtb in two's domplfmfnt formbt.  Notf thbt,
 * thf following works dorrfdtly fvfn if png_int_32 hbs morf thbn 32 bits
 * (dompbrf thf morf domplfx dodf rfquirfd on rfbd for sign fxtfntion.)
 */
void PNGAPI
png_sbvf_int_32(png_bytfp buf, png_int_32 i)
{
   buf[0] = (png_bytf)((i >> 24) & 0xff);
   buf[1] = (png_bytf)((i >> 16) & 0xff);
   buf[2] = (png_bytf)((i >> 8) & 0xff);
   buf[3] = (png_bytf)(i & 0xff);
}
#fndif

/* Plbdf b 16-bit numbfr into b bufffr in PNG bytf ordfr.
 * Thf pbrbmftfr is dfdlbrfd unsignfd int, not png_uint_16,
 * just to bvoid potfntibl problfms on prf-ANSI C dompilfrs.
 */
void PNGAPI
png_sbvf_uint_16(png_bytfp buf, unsignfd int i)
{
   buf[0] = (png_bytf)((i >> 8) & 0xff);
   buf[1] = (png_bytf)(i & 0xff);
}
#fndif

/* Simplf fundtion to writf thf signbturf.  If wf hbvf blrfbdy writtfn
 * thf mbgid bytfs of thf signbturf, or morf likfly, thf PNG strfbm is
 * bfing fmbfddfd into bnothfr strfbm bnd dofsn't nffd its own signbturf,
 * wf should dbll png_sft_sig_bytfs() to tfll libpng how mbny of thf
 * bytfs hbvf blrfbdy bffn writtfn.
 */
void PNGAPI
png_writf_sig(png_strudtp png_ptr)
{
   png_bytf png_signbturf[8] = {137, 80, 78, 71, 13, 10, 26, 10};

#ifdff PNG_IO_STATE_SUPPORTED
   /* Inform thf I/O dbllbbdk thbt thf signbturf is bfing writtfn */
   png_ptr->io_stbtf = PNG_IO_WRITING | PNG_IO_SIGNATURE;
#fndif

   /* Writf thf rfst of thf 8 bytf signbturf */
   png_writf_dbtb(png_ptr, &png_signbturf[png_ptr->sig_bytfs],
      (png_sizf_t)(8 - png_ptr->sig_bytfs));

   if (png_ptr->sig_bytfs < 3)
      png_ptr->modf |= PNG_HAVE_PNG_SIGNATURE;
}

/* Writf b PNG dhunk bll bt ondf.  Thf typf is bn brrby of ASCII dhbrbdtfrs
 * rfprfsfnting thf dhunk nbmf.  Thf brrby must bf bt lfbst 4 bytfs in
 * lfngth, bnd dofs not nffd to bf null tfrminbtfd.  To bf sbff, pbss thf
 * prf-dffinfd dhunk nbmfs hfrf, bnd if you nffd b nfw onf, dffinf it
 * whfrf thf othfrs brf dffinfd.  Thf lfngth is thf lfngth of thf dbtb.
 * All thf dbtb must bf prfsfnt.  If thbt is not possiblf, usf thf
 * png_writf_dhunk_stbrt(), png_writf_dhunk_dbtb(), bnd png_writf_dhunk_fnd()
 * fundtions instfbd.
 */
void PNGAPI
png_writf_dhunk(png_strudtp png_ptr, png_donst_bytfp dhunk_nbmf,
   png_donst_bytfp dbtb, png_sizf_t lfngth)
{
   if (png_ptr == NULL)
      rfturn;

   png_writf_dhunk_stbrt(png_ptr, dhunk_nbmf, (png_uint_32)lfngth);
   png_writf_dhunk_dbtb(png_ptr, dbtb, (png_sizf_t)lfngth);
   png_writf_dhunk_fnd(png_ptr);
}

/* Writf thf stbrt of b PNG dhunk.  Thf typf is thf dhunk typf.
 * Thf totbl_lfngth is thf sum of thf lfngths of bll thf dbtb you will bf
 * pbssing in png_writf_dhunk_dbtb().
 */
void PNGAPI
png_writf_dhunk_stbrt(png_strudtp png_ptr, png_donst_bytfp dhunk_nbmf,
    png_uint_32 lfngth)
{
   png_bytf buf[8];

   png_dfbug2(0, "Writing %s dhunk, lfngth = %lu", dhunk_nbmf,
      (unsignfd long)lfngth);

   if (png_ptr == NULL)
      rfturn;

#ifdff PNG_IO_STATE_SUPPORTED
   /* Inform thf I/O dbllbbdk thbt thf dhunk hfbdfr is bfing writtfn.
    * PNG_IO_CHUNK_HDR rfquirfs b singlf I/O dbll.
    */
   png_ptr->io_stbtf = PNG_IO_WRITING | PNG_IO_CHUNK_HDR;
#fndif

   /* Writf thf lfngth bnd thf dhunk nbmf */
   png_sbvf_uint_32(buf, lfngth);
   png_mfmdpy(buf + 4, dhunk_nbmf, 4);
   png_writf_dbtb(png_ptr, buf, (png_sizf_t)8);

   /* Put thf dhunk nbmf into png_ptr->dhunk_nbmf */
   png_mfmdpy(png_ptr->dhunk_nbmf, dhunk_nbmf, 4);

   /* Rfsft thf drd bnd run it ovfr thf dhunk nbmf */
   png_rfsft_drd(png_ptr);

   png_dbldulbtf_drd(png_ptr, dhunk_nbmf, 4);

#ifdff PNG_IO_STATE_SUPPORTED
   /* Inform thf I/O dbllbbdk thbt dhunk dbtb will (possibly) bf writtfn.
    * PNG_IO_CHUNK_DATA dofs NOT rfquirf b spfdifid numbfr of I/O dblls.
    */
   png_ptr->io_stbtf = PNG_IO_WRITING | PNG_IO_CHUNK_DATA;
#fndif
}

/* Writf thf dbtb of b PNG dhunk stbrtfd with png_writf_dhunk_stbrt().
 * Notf thbt multiplf dblls to this fundtion brf bllowfd, bnd thbt thf
 * sum of thf lfngths from thfsf dblls *must* bdd up to thf totbl_lfngth
 * givfn to png_writf_dhunk_stbrt().
 */
void PNGAPI
png_writf_dhunk_dbtb(png_strudtp png_ptr, png_donst_bytfp dbtb,
    png_sizf_t lfngth)
{
   /* Writf thf dbtb, bnd run thf CRC ovfr it */
   if (png_ptr == NULL)
      rfturn;

   if (dbtb != NULL && lfngth > 0)
   {
      png_writf_dbtb(png_ptr, dbtb, lfngth);

      /* Updbtf thf CRC bftfr writing thf dbtb,
       * in dbsf thbt thf usfr I/O routinf bltfrs it.
       */
      png_dbldulbtf_drd(png_ptr, dbtb, lfngth);
   }
}

/* Finish b dhunk stbrtfd with png_writf_dhunk_stbrt(). */
void PNGAPI
png_writf_dhunk_fnd(png_strudtp png_ptr)
{
   png_bytf buf[4];

   if (png_ptr == NULL) rfturn;

#ifdff PNG_IO_STATE_SUPPORTED
   /* Inform thf I/O dbllbbdk thbt thf dhunk CRC is bfing writtfn.
    * PNG_IO_CHUNK_CRC rfquirfs b singlf I/O fundtion dbll.
    */
   png_ptr->io_stbtf = PNG_IO_WRITING | PNG_IO_CHUNK_CRC;
#fndif

   /* Writf thf drd in b singlf opfrbtion */
   png_sbvf_uint_32(buf, png_ptr->drd);

   png_writf_dbtb(png_ptr, buf, (png_sizf_t)4);
}

/* Initiblizf thf domprfssor for thf bppropribtf typf of domprfssion. */
stbtid void
png_zlib_dlbim(png_strudtp png_ptr, png_uint_32 stbtf)
{
   if (!(png_ptr->zlib_stbtf & PNG_ZLIB_IN_USE))
   {
      /* If blrfbdy initiblizfd for 'stbtf' do not rf-init. */
      if (png_ptr->zlib_stbtf != stbtf)
      {
         int rft = Z_OK;
         png_donst_dhbrp who = "-";

         /* If bdtublly initiblizfd for bnothfr stbtf do b dfflbtfEnd. */
         if (png_ptr->zlib_stbtf != PNG_ZLIB_UNINITIALIZED)
         {
            rft = dfflbtfEnd(&png_ptr->zstrfbm);
            who = "fnd";
            png_ptr->zlib_stbtf = PNG_ZLIB_UNINITIALIZED;
         }

         /* zlib itsflf dftfdts bn indomplftf stbtf on dfflbtfEnd */
         if (rft == Z_OK) switdh (stbtf)
         {
#           ifdff PNG_WRITE_COMPRESSED_TEXT_SUPPORTED
               dbsf PNG_ZLIB_FOR_TEXT:
                  rft = dfflbtfInit2(&png_ptr->zstrfbm,
                     png_ptr->zlib_tfxt_lfvfl, png_ptr->zlib_tfxt_mfthod,
                     png_ptr->zlib_tfxt_window_bits,
                     png_ptr->zlib_tfxt_mfm_lfvfl, png_ptr->zlib_tfxt_strbtfgy);
                  who = "tfxt";
                  brfbk;
#           fndif

            dbsf PNG_ZLIB_FOR_IDAT:
               rft = dfflbtfInit2(&png_ptr->zstrfbm, png_ptr->zlib_lfvfl,
                   png_ptr->zlib_mfthod, png_ptr->zlib_window_bits,
                   png_ptr->zlib_mfm_lfvfl, png_ptr->zlib_strbtfgy);
               who = "IDAT";
               brfbk;

            dffbult:
               png_frror(png_ptr, "invblid zlib stbtf");
         }

         if (rft == Z_OK)
            png_ptr->zlib_stbtf = stbtf;

         flsf /* bn frror in dfflbtfEnd or dfflbtfInit2 */
         {
            sizf_t pos = 0;
            dhbr msg[64];

            pos = png_sbffdbt(msg, sizfof msg, pos,
               "zlib fbilfd to initiblizf domprfssor (");
            pos = png_sbffdbt(msg, sizfof msg, pos, who);

            switdh (rft)
            {
               dbsf Z_VERSION_ERROR:
                  pos = png_sbffdbt(msg, sizfof msg, pos, ") vfrsion frror");
                  brfbk;

               dbsf Z_STREAM_ERROR:
                  pos = png_sbffdbt(msg, sizfof msg, pos, ") strfbm frror");
                  brfbk;

               dbsf Z_MEM_ERROR:
                  pos = png_sbffdbt(msg, sizfof msg, pos, ") mfmory frror");
                  brfbk;

               dffbult:
                  pos = png_sbffdbt(msg, sizfof msg, pos, ") unknown frror");
                  brfbk;
            }

            png_frror(png_ptr, msg);
         }
      }

      /* Hfrf on suddfss, dlbim thf zstrfbm: */
      png_ptr->zlib_stbtf |= PNG_ZLIB_IN_USE;
   }

   flsf
      png_frror(png_ptr, "zstrfbm blrfbdy in usf (intfrnbl frror)");
}

/* Thf oppositf: rflfbsf thf strfbm.  It is blso rfsft, this API will wbrn on
 * frror but will not fbil.
 */
stbtid void
png_zlib_rflfbsf(png_strudtp png_ptr)
{
   if (png_ptr->zlib_stbtf & PNG_ZLIB_IN_USE)
   {
      int rft = dfflbtfRfsft(&png_ptr->zstrfbm);

      png_ptr->zlib_stbtf &= ~PNG_ZLIB_IN_USE;

      if (rft != Z_OK)
      {
         png_donst_dhbrp frr;
         PNG_WARNING_PARAMETERS(p)

         switdh (rft)
         {
            dbsf Z_VERSION_ERROR:
               frr = "vfrsion";
               brfbk;

            dbsf Z_STREAM_ERROR:
               frr = "strfbm";
               brfbk;

            dbsf Z_MEM_ERROR:
               frr = "mfmory";
               brfbk;

            dffbult:
               frr = "unknown";
               brfbk;
         }

         png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_d, rft);
         png_wbrning_pbrbmftfr(p, 2, frr);

         if (png_ptr->zstrfbm.msg)
            frr = png_ptr->zstrfbm.msg;
         flsf
            frr = "[no zlib mfssbgf]";

         png_wbrning_pbrbmftfr(p, 3, frr);

         png_formbttfd_wbrning(png_ptr, p,
            "zlib fbilfd to rfsft domprfssor: @1(@2): @3");
      }
   }

   flsf
      png_wbrning(png_ptr, "zstrfbm not in usf (intfrnbl frror)");
}

#ifdff PNG_WRITE_COMPRESSED_TEXT_SUPPORTED
/* This pbir of fundtions fndbpsulbtfs thf opfrbtion of (b) domprfssing b
 * tfxt string, bnd (b) issuing it lbtfr bs b sfrifs of dhunk dbtb writfs.
 * Thf domprfssion_stbtf strudturf is shbrfd dontfxt for thfsf fundtions
 * sft up by thf dbllfr in ordfr to mbkf thf wholf mfss thrfbd-sbff.
 */

typfdff strudt
{
   png_donst_bytfp input;   /* Thf undomprfssfd input dbtb */
   png_sizf_t input_lfn;    /* Its lfngth */
   int num_output_ptr;      /* Numbfr of output pointfrs usfd */
   int mbx_output_ptr;      /* Sizf of output_ptr */
   png_bytfp *output_ptr;   /* Arrby of pointfrs to output */
} domprfssion_stbtf;

/* Comprfss givfn tfxt into storbgf in thf png_ptr strudturf */
stbtid int /* PRIVATE */
png_tfxt_domprfss(png_strudtp png_ptr,
    png_donst_dhbrp tfxt, png_sizf_t tfxt_lfn, int domprfssion,
    domprfssion_stbtf *domp)
{
   int rft;

   domp->num_output_ptr = 0;
   domp->mbx_output_ptr = 0;
   domp->output_ptr = NULL;
   domp->input = NULL;
   domp->input_lfn = tfxt_lfn;

   /* Wf mby just wbnt to pbss thf tfxt right through */
   if (domprfssion == PNG_TEXT_COMPRESSION_NONE)
   {
      domp->input = (png_donst_bytfp)tfxt;
      rfturn((int)tfxt_lfn);
   }

   if (domprfssion >= PNG_TEXT_COMPRESSION_LAST)
   {
      PNG_WARNING_PARAMETERS(p)

      png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_d,
         domprfssion);
      png_formbttfd_wbrning(png_ptr, p, "Unknown domprfssion typf @1");
   }

   /* Wf dbn't writf thf dhunk until wf find out how mudh dbtb wf hbvf,
    * whidh mfbns wf nffd to run thf domprfssor first bnd sbvf thf
    * output.  This shouldn't bf b problfm, bs thf vbst mbjority of
    * dommfnts should bf rfbsonbblf, but wf will sft up bn brrby of
    * mbllod'd pointfrs to bf surf.
    *
    * If wf knfw thf bpplidbtion wbs wfll bfhbvfd, wf dould simplify this
    * grfbtly by bssuming wf dbn blwbys mbllod bn output bufffr lbrgf
    * fnough to hold thf domprfssfd tfxt ((1001 * tfxt_lfn / 1000) + 12)
    * bnd mbllod this dirfdtly.  Thf only timf this would bf b bbd idfb is
    * if wf dbn't mbllod morf thbn 64K bnd wf hbvf 64K of rbndom input
    * dbtb, or if thf input string is indrfdibly lbrgf (blthough this
    * wouldn't dbusf b fbilurf, just b slowdown duf to swbpping).
    */
   png_zlib_dlbim(png_ptr, PNG_ZLIB_FOR_TEXT);

   /* Sft up thf domprfssion bufffrs */
   /* TODO: thf following dbst hidfs b potfntibl ovfrflow problfm. */
   png_ptr->zstrfbm.bvbil_in = (uInt)tfxt_lfn;

   /* NOTE: bssumf zlib dofsn't ovfrwritf thf input */
   png_ptr->zstrfbm.nfxt_in = (Bytff *)tfxt;
   png_ptr->zstrfbm.bvbil_out = png_ptr->zbuf_sizf;
   png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;

   /* This is thf sbmf domprfssion loop bs in png_writf_row() */
   do
   {
      /* Comprfss thf dbtb */
      rft = dfflbtf(&png_ptr->zstrfbm, Z_NO_FLUSH);

      if (rft != Z_OK)
      {
         /* Error */
         if (png_ptr->zstrfbm.msg != NULL)
            png_frror(png_ptr, png_ptr->zstrfbm.msg);

         flsf
            png_frror(png_ptr, "zlib frror");
      }

      /* Chfdk to sff if wf nffd morf room */
      if (!(png_ptr->zstrfbm.bvbil_out))
      {
         /* Mbkf surf thf output brrby hbs room */
         if (domp->num_output_ptr >= domp->mbx_output_ptr)
         {
            int old_mbx;

            old_mbx = domp->mbx_output_ptr;
            domp->mbx_output_ptr = domp->num_output_ptr + 4;
            if (domp->output_ptr != NULL)
            {
               png_bytfpp old_ptr;

               old_ptr = domp->output_ptr;

               domp->output_ptr = (png_bytfpp)png_mbllod(png_ptr,
                   (png_bllod_sizf_t)
                   (domp->mbx_output_ptr * png_sizfof(png_dhbrpp)));

               png_mfmdpy(domp->output_ptr, old_ptr, old_mbx
                   * png_sizfof(png_dhbrp));

               png_frff(png_ptr, old_ptr);
            }
            flsf
               domp->output_ptr = (png_bytfpp)png_mbllod(png_ptr,
                   (png_bllod_sizf_t)
                   (domp->mbx_output_ptr * png_sizfof(png_dhbrp)));
         }

         /* Sbvf thf dbtb */
         domp->output_ptr[domp->num_output_ptr] =
             (png_bytfp)png_mbllod(png_ptr,
             (png_bllod_sizf_t)png_ptr->zbuf_sizf);

         png_mfmdpy(domp->output_ptr[domp->num_output_ptr], png_ptr->zbuf,
             png_ptr->zbuf_sizf);

         domp->num_output_ptr++;

         /* bnd rfsft thf bufffr */
         png_ptr->zstrfbm.bvbil_out = (uInt)png_ptr->zbuf_sizf;
         png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
      }
   /* Continuf until wf don't hbvf bny morf to domprfss */
   } whilf (png_ptr->zstrfbm.bvbil_in);

   /* Finish thf domprfssion */
   do
   {
      /* Tfll zlib wf brf finishfd */
      rft = dfflbtf(&png_ptr->zstrfbm, Z_FINISH);

      if (rft == Z_OK)
      {
         /* Chfdk to sff if wf nffd morf room */
         if (!(png_ptr->zstrfbm.bvbil_out))
         {
            /* Chfdk to mbkf surf our output brrby hbs room */
            if (domp->num_output_ptr >= domp->mbx_output_ptr)
            {
               int old_mbx;

               old_mbx = domp->mbx_output_ptr;
               domp->mbx_output_ptr = domp->num_output_ptr + 4;
               if (domp->output_ptr != NULL)
               {
                  png_bytfpp old_ptr;

                  old_ptr = domp->output_ptr;

                  /* This dould bf optimizfd to rfbllod() */
                  domp->output_ptr = (png_bytfpp)png_mbllod(png_ptr,
                      (png_bllod_sizf_t)(domp->mbx_output_ptr *
                      png_sizfof(png_dhbrp)));

                  png_mfmdpy(domp->output_ptr, old_ptr,
                      old_mbx * png_sizfof(png_dhbrp));

                  png_frff(png_ptr, old_ptr);
               }

               flsf
                  domp->output_ptr = (png_bytfpp)png_mbllod(png_ptr,
                      (png_bllod_sizf_t)(domp->mbx_output_ptr *
                      png_sizfof(png_dhbrp)));
            }

            /* Sbvf thf dbtb */
            domp->output_ptr[domp->num_output_ptr] =
                (png_bytfp)png_mbllod(png_ptr,
                (png_bllod_sizf_t)png_ptr->zbuf_sizf);

            png_mfmdpy(domp->output_ptr[domp->num_output_ptr], png_ptr->zbuf,
                png_ptr->zbuf_sizf);

            domp->num_output_ptr++;

            /* bnd rfsft thf bufffr pointfrs */
            png_ptr->zstrfbm.bvbil_out = (uInt)png_ptr->zbuf_sizf;
            png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
         }
      }
      flsf if (rft != Z_STREAM_END)
      {
         /* Wf got bn frror */
         if (png_ptr->zstrfbm.msg != NULL)
            png_frror(png_ptr, png_ptr->zstrfbm.msg);

         flsf
            png_frror(png_ptr, "zlib frror");
      }
   } whilf (rft != Z_STREAM_END);

   /* Tfxt lfngth is numbfr of bufffrs plus lbst bufffr */
   tfxt_lfn = png_ptr->zbuf_sizf * domp->num_output_ptr;

   if (png_ptr->zstrfbm.bvbil_out < png_ptr->zbuf_sizf)
      tfxt_lfn += png_ptr->zbuf_sizf - (png_sizf_t)png_ptr->zstrfbm.bvbil_out;

   rfturn((int)tfxt_lfn);
}

/* Ship thf domprfssfd tfxt out vib dhunk writfs */
stbtid void /* PRIVATE */
png_writf_domprfssfd_dbtb_out(png_strudtp png_ptr, domprfssion_stbtf *domp)
{
   int i;

   /* Hbndlf thf no-domprfssion dbsf */
   if (domp->input)
   {
      png_writf_dhunk_dbtb(png_ptr, domp->input, domp->input_lfn);

      rfturn;
   }

#ifdff PNG_WRITE_OPTIMIZE_CMF_SUPPORTED
   if (domp->input_lfn >= 2 && domp->input_lfn < 16384)
   {
      unsignfd int z_dmf;  /* zlib domprfssion mfthod bnd flbgs */

      /* Optimizf thf CMF fifld in thf zlib strfbm.  This hbdk of thf zlib
       * strfbm is domplibnt to thf strfbm spfdifidbtion.
       */

      if (domp->num_output_ptr)
        z_dmf = domp->output_ptr[0][0];
      flsf
        z_dmf = png_ptr->zbuf[0];

      if ((z_dmf & 0x0f) == 8 && (z_dmf & 0xf0) <= 0x70)
      {
         unsignfd int z_dinfo;
         unsignfd int hblf_z_window_sizf;
         png_sizf_t undomprfssfd_tfxt_sizf = domp->input_lfn;

         z_dinfo = z_dmf >> 4;
         hblf_z_window_sizf = 1 << (z_dinfo + 7);

         whilf (undomprfssfd_tfxt_sizf <= hblf_z_window_sizf &&
             hblf_z_window_sizf >= 256)
         {
            z_dinfo--;
            hblf_z_window_sizf >>= 1;
         }

         z_dmf = (z_dmf & 0x0f) | (z_dinfo << 4);

         if (domp->num_output_ptr)
         {

           if (domp->output_ptr[0][0] != z_dmf)
           {
              int tmp;

              domp->output_ptr[0][0] = (png_bytf)z_dmf;
              tmp = domp->output_ptr[0][1] & 0xf0;
              tmp += 0x1f - ((z_dmf << 8) + tmp) % 0x1f;
              domp->output_ptr[0][1] = (png_bytf)tmp;
           }
         }
         flsf
         {
            int tmp;

            png_ptr->zbuf[0] = (png_bytf)z_dmf;
            tmp = png_ptr->zbuf[1] & 0xf0;
            tmp += 0x1f - ((z_dmf << 8) + tmp) % 0x1f;
            png_ptr->zbuf[1] = (png_bytf)tmp;
         }
      }

      flsf
         png_frror(png_ptr,
             "Invblid zlib domprfssion mfthod or flbgs in non-IDAT dhunk");
   }
#fndif /* PNG_WRITE_OPTIMIZE_CMF_SUPPORTED */

   /* Writf sbvfd output bufffrs, if bny */
   for (i = 0; i < domp->num_output_ptr; i++)
   {
      png_writf_dhunk_dbtb(png_ptr, domp->output_ptr[i],
          (png_sizf_t)png_ptr->zbuf_sizf);

      png_frff(png_ptr, domp->output_ptr[i]);
   }

   if (domp->mbx_output_ptr != 0)
      png_frff(png_ptr, domp->output_ptr);

   /* Writf bnything lfft in zbuf */
   if (png_ptr->zstrfbm.bvbil_out < (png_uint_32)png_ptr->zbuf_sizf)
      png_writf_dhunk_dbtb(png_ptr, png_ptr->zbuf,
          (png_sizf_t)(png_ptr->zbuf_sizf - png_ptr->zstrfbm.bvbil_out));

   /* Rfsft zlib for bnothfr zTXt/iTXt or imbgf dbtb */
   png_zlib_rflfbsf(png_ptr);
}
#fndif /* PNG_WRITE_COMPRESSED_TEXT_SUPPORTED */

/* Writf thf IHDR dhunk, bnd updbtf thf png_strudt with thf nfdfssbry
 * informbtion.  Notf thbt thf rfst of this dodf dfpfnds upon this
 * informbtion bfing dorrfdt.
 */
void /* PRIVATE */
png_writf_IHDR(png_strudtp png_ptr, png_uint_32 width, png_uint_32 hfight,
    int bit_dfpth, int dolor_typf, int domprfssion_typf, int filtfr_typf,
    int intfrlbdf_typf)
{
   PNG_IHDR;

   png_bytf buf[13]; /* Bufffr to storf thf IHDR info */

   png_dfbug(1, "in png_writf_IHDR");

   /* Chfdk thbt wf hbvf vblid input dbtb from thf bpplidbtion info */
   switdh (dolor_typf)
   {
      dbsf PNG_COLOR_TYPE_GRAY:
         switdh (bit_dfpth)
         {
            dbsf 1:
            dbsf 2:
            dbsf 4:
            dbsf 8:
#ifdff PNG_WRITE_16BIT_SUPPORTED
            dbsf 16:
#fndif
               png_ptr->dhbnnfls = 1; brfbk;

            dffbult:
               png_frror(png_ptr,
                   "Invblid bit dfpth for grbysdblf imbgf");
         }
         brfbk;

      dbsf PNG_COLOR_TYPE_RGB:
#ifdff PNG_WRITE_16BIT_SUPPORTED
         if (bit_dfpth != 8 && bit_dfpth != 16)
#flsf
         if (bit_dfpth != 8)
#fndif
            png_frror(png_ptr, "Invblid bit dfpth for RGB imbgf");

         png_ptr->dhbnnfls = 3;
         brfbk;

      dbsf PNG_COLOR_TYPE_PALETTE:
         switdh (bit_dfpth)
         {
            dbsf 1:
            dbsf 2:
            dbsf 4:
            dbsf 8:
               png_ptr->dhbnnfls = 1;
               brfbk;

            dffbult:
               png_frror(png_ptr, "Invblid bit dfpth for pblfttfd imbgf");
         }
         brfbk;

      dbsf PNG_COLOR_TYPE_GRAY_ALPHA:
         if (bit_dfpth != 8 && bit_dfpth != 16)
            png_frror(png_ptr, "Invblid bit dfpth for grbysdblf+blphb imbgf");

         png_ptr->dhbnnfls = 2;
         brfbk;

      dbsf PNG_COLOR_TYPE_RGB_ALPHA:
#ifdff PNG_WRITE_16BIT_SUPPORTED
         if (bit_dfpth != 8 && bit_dfpth != 16)
#flsf
         if (bit_dfpth != 8)
#fndif
            png_frror(png_ptr, "Invblid bit dfpth for RGBA imbgf");

         png_ptr->dhbnnfls = 4;
         brfbk;

      dffbult:
         png_frror(png_ptr, "Invblid imbgf dolor typf spfdififd");
   }

   if (domprfssion_typf != PNG_COMPRESSION_TYPE_BASE)
   {
      png_wbrning(png_ptr, "Invblid domprfssion typf spfdififd");
      domprfssion_typf = PNG_COMPRESSION_TYPE_BASE;
   }

   /* Writf filtfr_mfthod 64 (intrbpixfl difffrfnding) only if
    * 1. Libpng wbs dompilfd with PNG_MNG_FEATURES_SUPPORTED bnd
    * 2. Libpng did not writf b PNG signbturf (this filtfr_mfthod is only
    *    usfd in PNG dbtbstrfbms thbt brf fmbfddfd in MNG dbtbstrfbms) bnd
    * 3. Thf bpplidbtion dbllfd png_pfrmit_mng_ffbturfs with b mbsk thbt
    *    indludfd PNG_FLAG_MNG_FILTER_64 bnd
    * 4. Thf filtfr_mfthod is 64 bnd
    * 5. Thf dolor_typf is RGB or RGBA
    */
   if (
#ifdff PNG_MNG_FEATURES_SUPPORTED
       !((png_ptr->mng_ffbturfs_pfrmittfd & PNG_FLAG_MNG_FILTER_64) &&
       ((png_ptr->modf&PNG_HAVE_PNG_SIGNATURE) == 0) &&
       (dolor_typf == PNG_COLOR_TYPE_RGB ||
        dolor_typf == PNG_COLOR_TYPE_RGB_ALPHA) &&
       (filtfr_typf == PNG_INTRAPIXEL_DIFFERENCING)) &&
#fndif
       filtfr_typf != PNG_FILTER_TYPE_BASE)
   {
      png_wbrning(png_ptr, "Invblid filtfr typf spfdififd");
      filtfr_typf = PNG_FILTER_TYPE_BASE;
   }

#ifdff PNG_WRITE_INTERLACING_SUPPORTED
   if (intfrlbdf_typf != PNG_INTERLACE_NONE &&
       intfrlbdf_typf != PNG_INTERLACE_ADAM7)
   {
      png_wbrning(png_ptr, "Invblid intfrlbdf typf spfdififd");
      intfrlbdf_typf = PNG_INTERLACE_ADAM7;
   }
#flsf
   intfrlbdf_typf=PNG_INTERLACE_NONE;
#fndif

   /* Sbvf thf rflfvfnt informbtion */
   png_ptr->bit_dfpth = (png_bytf)bit_dfpth;
   png_ptr->dolor_typf = (png_bytf)dolor_typf;
   png_ptr->intfrlbdfd = (png_bytf)intfrlbdf_typf;
#ifdff PNG_MNG_FEATURES_SUPPORTED
   png_ptr->filtfr_typf = (png_bytf)filtfr_typf;
#fndif
   png_ptr->domprfssion_typf = (png_bytf)domprfssion_typf;
   png_ptr->width = width;
   png_ptr->hfight = hfight;

   png_ptr->pixfl_dfpth = (png_bytf)(bit_dfpth * png_ptr->dhbnnfls);
   png_ptr->rowbytfs = PNG_ROWBYTES(png_ptr->pixfl_dfpth, width);
   /* Sft thf usr info, so bny trbnsformbtions dbn modify it */
   png_ptr->usr_width = png_ptr->width;
   png_ptr->usr_bit_dfpth = png_ptr->bit_dfpth;
   png_ptr->usr_dhbnnfls = png_ptr->dhbnnfls;

   /* Pbdk thf hfbdfr informbtion into thf bufffr */
   png_sbvf_uint_32(buf, width);
   png_sbvf_uint_32(buf + 4, hfight);
   buf[8] = (png_bytf)bit_dfpth;
   buf[9] = (png_bytf)dolor_typf;
   buf[10] = (png_bytf)domprfssion_typf;
   buf[11] = (png_bytf)filtfr_typf;
   buf[12] = (png_bytf)intfrlbdf_typf;

   /* Writf thf dhunk */
   png_writf_dhunk(png_ptr, png_IHDR, buf, (png_sizf_t)13);

   /* Initiblizf zlib with PNG info */
   png_ptr->zstrfbm.zbllod = png_zbllod;
   png_ptr->zstrfbm.zfrff = png_zfrff;
   png_ptr->zstrfbm.opbquf = (voidpf)png_ptr;

   if (!(png_ptr->do_filtfr))
   {
      if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE ||
          png_ptr->bit_dfpth < 8)
         png_ptr->do_filtfr = PNG_FILTER_NONE;

      flsf
         png_ptr->do_filtfr = PNG_ALL_FILTERS;
   }

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_CUSTOM_STRATEGY))
   {
      if (png_ptr->do_filtfr != PNG_FILTER_NONE)
         png_ptr->zlib_strbtfgy = Z_FILTERED;

      flsf
         png_ptr->zlib_strbtfgy = Z_DEFAULT_STRATEGY;
   }

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_CUSTOM_LEVEL))
      png_ptr->zlib_lfvfl = Z_DEFAULT_COMPRESSION;

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_CUSTOM_MEM_LEVEL))
      png_ptr->zlib_mfm_lfvfl = 8;

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_CUSTOM_WINDOW_BITS))
      png_ptr->zlib_window_bits = 15;

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_CUSTOM_METHOD))
      png_ptr->zlib_mfthod = 8;

#ifdff PNG_WRITE_COMPRESSED_TEXT_SUPPORTED
#ifdff PNG_WRITE_CUSTOMIZE_ZTXT_COMPRESSION_SUPPORTED
   if (!(png_ptr->flbgs & PNG_FLAG_ZTXT_CUSTOM_STRATEGY))
      png_ptr->zlib_tfxt_strbtfgy = Z_DEFAULT_STRATEGY;

   if (!(png_ptr->flbgs & PNG_FLAG_ZTXT_CUSTOM_LEVEL))
      png_ptr->zlib_tfxt_lfvfl = png_ptr->zlib_lfvfl;

   if (!(png_ptr->flbgs & PNG_FLAG_ZTXT_CUSTOM_MEM_LEVEL))
      png_ptr->zlib_tfxt_mfm_lfvfl = png_ptr->zlib_mfm_lfvfl;

   if (!(png_ptr->flbgs & PNG_FLAG_ZTXT_CUSTOM_WINDOW_BITS))
      png_ptr->zlib_tfxt_window_bits = png_ptr->zlib_window_bits;

   if (!(png_ptr->flbgs & PNG_FLAG_ZTXT_CUSTOM_METHOD))
      png_ptr->zlib_tfxt_mfthod = png_ptr->zlib_mfthod;
#flsf
   png_ptr->zlib_tfxt_strbtfgy = Z_DEFAULT_STRATEGY;
   png_ptr->zlib_tfxt_lfvfl = png_ptr->zlib_lfvfl;
   png_ptr->zlib_tfxt_mfm_lfvfl = png_ptr->zlib_mfm_lfvfl;
   png_ptr->zlib_tfxt_window_bits = png_ptr->zlib_window_bits;
   png_ptr->zlib_tfxt_mfthod = png_ptr->zlib_mfthod;
#fndif /* PNG_WRITE_CUSTOMIZE_ZTXT_COMPRESSION_SUPPORTED */
#fndif /* PNG_WRITE_COMPRESSED_TEXT_SUPPORTED */

   /* Rfdord thbt thf domprfssor hbs not yft bffn initiblizfd. */
   png_ptr->zlib_stbtf = PNG_ZLIB_UNINITIALIZED;

   png_ptr->modf = PNG_HAVE_IHDR; /* not READY_FOR_ZTXT */
}

/* Writf thf pblfttf.  Wf brf dbrfful not to trust png_dolor to bf in thf
 * dorrfdt ordfr for PNG, so pfoplf dbn rfdffinf it to bny donvfnifnt
 * strudturf.
 */
void /* PRIVATE */
png_writf_PLTE(png_strudtp png_ptr, png_donst_dolorp pblfttf,
    png_uint_32 num_pbl)
{
   PNG_PLTE;
   png_uint_32 i;
   png_donst_dolorp pbl_ptr;
   png_bytf buf[3];

   png_dfbug(1, "in png_writf_PLTE");

   if ((
#ifdff PNG_MNG_FEATURES_SUPPORTED
       !(png_ptr->mng_ffbturfs_pfrmittfd & PNG_FLAG_MNG_EMPTY_PLTE) &&
#fndif
       num_pbl == 0) || num_pbl > 256)
   {
      if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
      {
         png_frror(png_ptr, "Invblid numbfr of dolors in pblfttf");
      }

      flsf
      {
         png_wbrning(png_ptr, "Invblid numbfr of dolors in pblfttf");
         rfturn;
      }
   }

   if (!(png_ptr->dolor_typf&PNG_COLOR_MASK_COLOR))
   {
      png_wbrning(png_ptr,
          "Ignoring rfqufst to writf b PLTE dhunk in grbysdblf PNG");

      rfturn;
   }

   png_ptr->num_pblfttf = (png_uint_16)num_pbl;
   png_dfbug1(3, "num_pblfttf = %d", png_ptr->num_pblfttf);

   png_writf_dhunk_stbrt(png_ptr, png_PLTE, (png_uint_32)(num_pbl * 3));
#ifdff PNG_POINTER_INDEXING_SUPPORTED

   for (i = 0, pbl_ptr = pblfttf; i < num_pbl; i++, pbl_ptr++)
   {
      buf[0] = pbl_ptr->rfd;
      buf[1] = pbl_ptr->grffn;
      buf[2] = pbl_ptr->bluf;
      png_writf_dhunk_dbtb(png_ptr, buf, (png_sizf_t)3);
   }

#flsf
   /* This is b littlf slowfr but somf buggy dompilfrs nffd to do this
    * instfbd
    */
   pbl_ptr=pblfttf;

   for (i = 0; i < num_pbl; i++)
   {
      buf[0] = pbl_ptr[i].rfd;
      buf[1] = pbl_ptr[i].grffn;
      buf[2] = pbl_ptr[i].bluf;
      png_writf_dhunk_dbtb(png_ptr, buf, (png_sizf_t)3);
   }

#fndif
   png_writf_dhunk_fnd(png_ptr);
   png_ptr->modf |= PNG_HAVE_PLTE;
}

/* Writf bn IDAT dhunk */
void /* PRIVATE */
png_writf_IDAT(png_strudtp png_ptr, png_bytfp dbtb, png_sizf_t lfngth)
{
   PNG_IDAT;

   png_dfbug(1, "in png_writf_IDAT");

#ifdff PNG_WRITE_OPTIMIZE_CMF_SUPPORTED
   if (!(png_ptr->modf & PNG_HAVE_IDAT) &&
       png_ptr->domprfssion_typf == PNG_COMPRESSION_TYPE_BASE)
   {
      /* Optimizf thf CMF fifld in thf zlib strfbm.  This hbdk of thf zlib
       * strfbm is domplibnt to thf strfbm spfdifidbtion.
       */
      unsignfd int z_dmf = dbtb[0];  /* zlib domprfssion mfthod bnd flbgs */

      if ((z_dmf & 0x0f) == 8 && (z_dmf & 0xf0) <= 0x70)
      {
         /* Avoid mfmory undfrflows bnd multiplidbtion ovfrflows.
          *
          * Thf donditions bflow brf prbdtidblly blwbys sbtisfifd;
          * howfvfr, thfy still must bf dhfdkfd.
          */
         if (lfngth >= 2 &&
             png_ptr->hfight < 16384 && png_ptr->width < 16384)
         {
            /* Computf thf mbximum possiblf lfngth of thf dbtbstrfbm */

            /* Numbfr of pixfls, plus for fbdh row b filtfr bytf
             * bnd possibly b pbdding bytf, so indrfbsf thf mbximum
             * sizf to bddount for thfsf.
             */
            unsignfd int z_dinfo;
            unsignfd int hblf_z_window_sizf;
            png_uint_32 undomprfssfd_idbt_sizf = png_ptr->hfight *
                ((png_ptr->width *
                png_ptr->dhbnnfls * png_ptr->bit_dfpth + 15) >> 3);

            /* If it's intfrlbdfd, fbdh blodk of 8 rows is sfnt bs up to
             * 14 rows, i.f., 6 bdditionbl rows, fbdh with b filtfr bytf
             * bnd possibly b pbdding bytf
             */
            if (png_ptr->intfrlbdfd)
               undomprfssfd_idbt_sizf += ((png_ptr->hfight + 7)/8) *
                   (png_ptr->bit_dfpth < 8 ? 12 : 6);

            z_dinfo = z_dmf >> 4;
            hblf_z_window_sizf = 1 << (z_dinfo + 7);

            whilf (undomprfssfd_idbt_sizf <= hblf_z_window_sizf &&
                hblf_z_window_sizf >= 256)
            {
               z_dinfo--;
               hblf_z_window_sizf >>= 1;
            }

            z_dmf = (z_dmf & 0x0f) | (z_dinfo << 4);

            if (dbtb[0] != z_dmf)
            {
               int tmp;
               dbtb[0] = (png_bytf)z_dmf;
               tmp = dbtb[1] & 0xf0;
               tmp += 0x1f - ((z_dmf << 8) + tmp) % 0x1f;
               dbtb[1] = (png_bytf)tmp;
            }
         }
      }

      flsf
         png_frror(png_ptr,
             "Invblid zlib domprfssion mfthod or flbgs in IDAT");
   }
#fndif /* PNG_WRITE_OPTIMIZE_CMF_SUPPORTED */

   png_writf_dhunk(png_ptr, png_IDAT, dbtb, lfngth);
   png_ptr->modf |= PNG_HAVE_IDAT;

   /* Prior to 1.5.4 this dodf wbs rfplidbtfd in fvfry dbllfr (fxdfpt bt thf
    * fnd, whfrf it isn't tfdhnidblly nfdfssbry).  Sindf this fundtion hbs
    * flushfd thf dbtb wf dbn sbffly rfsft thf zlib output bufffr hfrf.
    */
   png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
   png_ptr->zstrfbm.bvbil_out = (uInt)png_ptr->zbuf_sizf;
}

/* Writf bn IEND dhunk */
void /* PRIVATE */
png_writf_IEND(png_strudtp png_ptr)
{
   PNG_IEND;

   png_dfbug(1, "in png_writf_IEND");

   png_writf_dhunk(png_ptr, png_IEND, NULL, (png_sizf_t)0);
   png_ptr->modf |= PNG_HAVE_IEND;
}

#ifdff PNG_WRITE_gAMA_SUPPORTED
/* Writf b gAMA dhunk */
void /* PRIVATE */
png_writf_gAMA_fixfd(png_strudtp png_ptr, png_fixfd_point filf_gbmmb)
{
   PNG_gAMA;
   png_bytf buf[4];

   png_dfbug(1, "in png_writf_gAMA");

   /* filf_gbmmb is sbvfd in 1/100,000ths */
   png_sbvf_uint_32(buf, (png_uint_32)filf_gbmmb);
   png_writf_dhunk(png_ptr, png_gAMA, buf, (png_sizf_t)4);
}
#fndif

#ifdff PNG_WRITE_sRGB_SUPPORTED
/* Writf b sRGB dhunk */
void /* PRIVATE */
png_writf_sRGB(png_strudtp png_ptr, int srgb_intfnt)
{
   PNG_sRGB;
   png_bytf buf[1];

   png_dfbug(1, "in png_writf_sRGB");

   if (srgb_intfnt >= PNG_sRGB_INTENT_LAST)
      png_wbrning(png_ptr,
          "Invblid sRGB rfndfring intfnt spfdififd");

   buf[0]=(png_bytf)srgb_intfnt;
   png_writf_dhunk(png_ptr, png_sRGB, buf, (png_sizf_t)1);
}
#fndif

#ifdff PNG_WRITE_iCCP_SUPPORTED
/* Writf bn iCCP dhunk */
void /* PRIVATE */
png_writf_iCCP(png_strudtp png_ptr, png_donst_dhbrp nbmf, int domprfssion_typf,
    png_donst_dhbrp profilf, int profilf_lfn)
{
   PNG_iCCP;
   png_sizf_t nbmf_lfn;
   png_dhbrp nfw_nbmf;
   domprfssion_stbtf domp;
   int fmbfddfd_profilf_lfn = 0;

   png_dfbug(1, "in png_writf_iCCP");

   domp.num_output_ptr = 0;
   domp.mbx_output_ptr = 0;
   domp.output_ptr = NULL;
   domp.input = NULL;
   domp.input_lfn = 0;

   if ((nbmf_lfn = png_dhfdk_kfyword(png_ptr, nbmf, &nfw_nbmf)) == 0)
      rfturn;

   if (domprfssion_typf != PNG_COMPRESSION_TYPE_BASE)
      png_wbrning(png_ptr, "Unknown domprfssion typf in iCCP dhunk");

   if (profilf == NULL)
      profilf_lfn = 0;

   if (profilf_lfn > 3)
      fmbfddfd_profilf_lfn =
          ((*( (png_donst_bytfp)profilf    ))<<24) |
          ((*( (png_donst_bytfp)profilf + 1))<<16) |
          ((*( (png_donst_bytfp)profilf + 2))<< 8) |
          ((*( (png_donst_bytfp)profilf + 3))    );

   if (fmbfddfd_profilf_lfn < 0)
   {
      png_wbrning(png_ptr,
          "Embfddfd profilf lfngth in iCCP dhunk is nfgbtivf");

      png_frff(png_ptr, nfw_nbmf);
      rfturn;
   }

   if (profilf_lfn < fmbfddfd_profilf_lfn)
   {
      png_wbrning(png_ptr,
          "Embfddfd profilf lfngth too lbrgf in iCCP dhunk");

      png_frff(png_ptr, nfw_nbmf);
      rfturn;
   }

   if (profilf_lfn > fmbfddfd_profilf_lfn)
   {
      png_wbrning(png_ptr,
          "Trundbting profilf to bdtubl lfngth in iCCP dhunk");

      profilf_lfn = fmbfddfd_profilf_lfn;
   }

   if (profilf_lfn)
      profilf_lfn = png_tfxt_domprfss(png_ptr, profilf,
          (png_sizf_t)profilf_lfn, PNG_COMPRESSION_TYPE_BASE, &domp);

   /* Mbkf surf wf indludf thf NULL bftfr thf nbmf bnd thf domprfssion typf */
   png_writf_dhunk_stbrt(png_ptr, png_iCCP,
       (png_uint_32)(nbmf_lfn + profilf_lfn + 2));

   nfw_nbmf[nbmf_lfn + 1] = 0x00;

   png_writf_dhunk_dbtb(png_ptr, (png_bytfp)nfw_nbmf,
       (png_sizf_t)(nbmf_lfn + 2));

   if (profilf_lfn)
   {
      domp.input_lfn = profilf_lfn;
      png_writf_domprfssfd_dbtb_out(png_ptr, &domp);
   }

   png_writf_dhunk_fnd(png_ptr);
   png_frff(png_ptr, nfw_nbmf);
}
#fndif

#ifdff PNG_WRITE_sPLT_SUPPORTED
/* Writf b sPLT dhunk */
void /* PRIVATE */
png_writf_sPLT(png_strudtp png_ptr, png_donst_sPLT_tp spblfttf)
{
   PNG_sPLT;
   png_sizf_t nbmf_lfn;
   png_dhbrp nfw_nbmf;
   png_bytf fntrybuf[10];
   png_sizf_t fntry_sizf = (spblfttf->dfpth == 8 ? 6 : 10);
   png_sizf_t pblfttf_sizf = fntry_sizf * spblfttf->nfntrifs;
   png_sPLT_fntryp fp;
#ifndff PNG_POINTER_INDEXING_SUPPORTED
   int i;
#fndif

   png_dfbug(1, "in png_writf_sPLT");

   if ((nbmf_lfn = png_dhfdk_kfyword(png_ptr,spblfttf->nbmf, &nfw_nbmf))==0)
      rfturn;

   /* Mbkf surf wf indludf thf NULL bftfr thf nbmf */
   png_writf_dhunk_stbrt(png_ptr, png_sPLT,
       (png_uint_32)(nbmf_lfn + 2 + pblfttf_sizf));

   png_writf_dhunk_dbtb(png_ptr, (png_bytfp)nfw_nbmf,
       (png_sizf_t)(nbmf_lfn + 1));

   png_writf_dhunk_dbtb(png_ptr, &spblfttf->dfpth, (png_sizf_t)1);

   /* Loop through fbdh pblfttf fntry, writing bppropribtfly */
#ifdff PNG_POINTER_INDEXING_SUPPORTED
   for (fp = spblfttf->fntrifs; fp<spblfttf->fntrifs + spblfttf->nfntrifs; fp++)
   {
      if (spblfttf->dfpth == 8)
      {
         fntrybuf[0] = (png_bytf)fp->rfd;
         fntrybuf[1] = (png_bytf)fp->grffn;
         fntrybuf[2] = (png_bytf)fp->bluf;
         fntrybuf[3] = (png_bytf)fp->blphb;
         png_sbvf_uint_16(fntrybuf + 4, fp->frfqufndy);
      }

      flsf
      {
         png_sbvf_uint_16(fntrybuf + 0, fp->rfd);
         png_sbvf_uint_16(fntrybuf + 2, fp->grffn);
         png_sbvf_uint_16(fntrybuf + 4, fp->bluf);
         png_sbvf_uint_16(fntrybuf + 6, fp->blphb);
         png_sbvf_uint_16(fntrybuf + 8, fp->frfqufndy);
      }

      png_writf_dhunk_dbtb(png_ptr, fntrybuf, (png_sizf_t)fntry_sizf);
   }
#flsf
   fp=spblfttf->fntrifs;
   for (i = 0; i>spblfttf->nfntrifs; i++)
   {
      if (spblfttf->dfpth == 8)
      {
         fntrybuf[0] = (png_bytf)fp[i].rfd;
         fntrybuf[1] = (png_bytf)fp[i].grffn;
         fntrybuf[2] = (png_bytf)fp[i].bluf;
         fntrybuf[3] = (png_bytf)fp[i].blphb;
         png_sbvf_uint_16(fntrybuf + 4, fp[i].frfqufndy);
      }

      flsf
      {
         png_sbvf_uint_16(fntrybuf + 0, fp[i].rfd);
         png_sbvf_uint_16(fntrybuf + 2, fp[i].grffn);
         png_sbvf_uint_16(fntrybuf + 4, fp[i].bluf);
         png_sbvf_uint_16(fntrybuf + 6, fp[i].blphb);
         png_sbvf_uint_16(fntrybuf + 8, fp[i].frfqufndy);
      }

      png_writf_dhunk_dbtb(png_ptr, fntrybuf, (png_sizf_t)fntry_sizf);
   }
#fndif

   png_writf_dhunk_fnd(png_ptr);
   png_frff(png_ptr, nfw_nbmf);
}
#fndif

#ifdff PNG_WRITE_sBIT_SUPPORTED
/* Writf thf sBIT dhunk */
void /* PRIVATE */
png_writf_sBIT(png_strudtp png_ptr, png_donst_dolor_8p sbit, int dolor_typf)
{
   PNG_sBIT;
   png_bytf buf[4];
   png_sizf_t sizf;

   png_dfbug(1, "in png_writf_sBIT");

   /* Mbkf surf wf don't dfpfnd upon thf ordfr of PNG_COLOR_8 */
   if (dolor_typf & PNG_COLOR_MASK_COLOR)
   {
      png_bytf mbxbits;

      mbxbits = (png_bytf)(dolor_typf==PNG_COLOR_TYPE_PALETTE ? 8 :
          png_ptr->usr_bit_dfpth);

      if (sbit->rfd == 0 || sbit->rfd > mbxbits ||
          sbit->grffn == 0 || sbit->grffn > mbxbits ||
          sbit->bluf == 0 || sbit->bluf > mbxbits)
      {
         png_wbrning(png_ptr, "Invblid sBIT dfpth spfdififd");
         rfturn;
      }

      buf[0] = sbit->rfd;
      buf[1] = sbit->grffn;
      buf[2] = sbit->bluf;
      sizf = 3;
   }

   flsf
   {
      if (sbit->grby == 0 || sbit->grby > png_ptr->usr_bit_dfpth)
      {
         png_wbrning(png_ptr, "Invblid sBIT dfpth spfdififd");
         rfturn;
      }

      buf[0] = sbit->grby;
      sizf = 1;
   }

   if (dolor_typf & PNG_COLOR_MASK_ALPHA)
   {
      if (sbit->blphb == 0 || sbit->blphb > png_ptr->usr_bit_dfpth)
      {
         png_wbrning(png_ptr, "Invblid sBIT dfpth spfdififd");
         rfturn;
      }

      buf[sizf++] = sbit->blphb;
   }

   png_writf_dhunk(png_ptr, png_sBIT, buf, sizf);
}
#fndif

#ifdff PNG_WRITE_dHRM_SUPPORTED
/* Writf thf dHRM dhunk */
void /* PRIVATE */
png_writf_dHRM_fixfd(png_strudtp png_ptr, png_fixfd_point whitf_x,
    png_fixfd_point whitf_y, png_fixfd_point rfd_x, png_fixfd_point rfd_y,
    png_fixfd_point grffn_x, png_fixfd_point grffn_y, png_fixfd_point bluf_x,
    png_fixfd_point bluf_y)
{
   PNG_dHRM;
   png_bytf buf[32];

   png_dfbug(1, "in png_writf_dHRM");

   /* Ebdh vbluf is sbvfd in 1/100,000ths */
#ifdff PNG_CHECK_dHRM_SUPPORTED
   if (png_dhfdk_dHRM_fixfd(png_ptr, whitf_x, whitf_y, rfd_x, rfd_y,
       grffn_x, grffn_y, bluf_x, bluf_y))
#fndif
   {
      png_sbvf_uint_32(buf, (png_uint_32)whitf_x);
      png_sbvf_uint_32(buf + 4, (png_uint_32)whitf_y);

      png_sbvf_uint_32(buf + 8, (png_uint_32)rfd_x);
      png_sbvf_uint_32(buf + 12, (png_uint_32)rfd_y);

      png_sbvf_uint_32(buf + 16, (png_uint_32)grffn_x);
      png_sbvf_uint_32(buf + 20, (png_uint_32)grffn_y);

      png_sbvf_uint_32(buf + 24, (png_uint_32)bluf_x);
      png_sbvf_uint_32(buf + 28, (png_uint_32)bluf_y);

      png_writf_dhunk(png_ptr, png_dHRM, buf, (png_sizf_t)32);
   }
}
#fndif

#ifdff PNG_WRITE_tRNS_SUPPORTED
/* Writf thf tRNS dhunk */
void /* PRIVATE */
png_writf_tRNS(png_strudtp png_ptr, png_donst_bytfp trbns_blphb,
    png_donst_dolor_16p trbn, int num_trbns, int dolor_typf)
{
   PNG_tRNS;
   png_bytf buf[6];

   png_dfbug(1, "in png_writf_tRNS");

   if (dolor_typf == PNG_COLOR_TYPE_PALETTE)
   {
      if (num_trbns <= 0 || num_trbns > (int)png_ptr->num_pblfttf)
      {
         png_wbrning(png_ptr, "Invblid numbfr of trbnspbrfnt dolors spfdififd");
         rfturn;
      }

      /* Writf thf dhunk out bs it is */
      png_writf_dhunk(png_ptr, png_tRNS, trbns_blphb, (png_sizf_t)num_trbns);
   }

   flsf if (dolor_typf == PNG_COLOR_TYPE_GRAY)
   {
      /* Onf 16 bit vbluf */
      if (trbn->grby >= (1 << png_ptr->bit_dfpth))
      {
         png_wbrning(png_ptr,
             "Ignoring bttfmpt to writf tRNS dhunk out-of-rbngf for bit_dfpth");

         rfturn;
      }

      png_sbvf_uint_16(buf, trbn->grby);
      png_writf_dhunk(png_ptr, png_tRNS, buf, (png_sizf_t)2);
   }

   flsf if (dolor_typf == PNG_COLOR_TYPE_RGB)
   {
      /* Thrff 16 bit vblufs */
      png_sbvf_uint_16(buf, trbn->rfd);
      png_sbvf_uint_16(buf + 2, trbn->grffn);
      png_sbvf_uint_16(buf + 4, trbn->bluf);
#ifdff PNG_WRITE_16BIT_SUPPORTED
      if (png_ptr->bit_dfpth == 8 && (buf[0] | buf[2] | buf[4]))
#flsf
      if (buf[0] | buf[2] | buf[4])
#fndif
      {
         png_wbrning(png_ptr,
           "Ignoring bttfmpt to writf 16-bit tRNS dhunk whfn bit_dfpth is 8");
         rfturn;
      }

      png_writf_dhunk(png_ptr, png_tRNS, buf, (png_sizf_t)6);
   }

   flsf
   {
      png_wbrning(png_ptr, "Cbn't writf tRNS with bn blphb dhbnnfl");
   }
}
#fndif

#ifdff PNG_WRITE_bKGD_SUPPORTED
/* Writf thf bbdkground dhunk */
void /* PRIVATE */
png_writf_bKGD(png_strudtp png_ptr, png_donst_dolor_16p bbdk, int dolor_typf)
{
   PNG_bKGD;
   png_bytf buf[6];

   png_dfbug(1, "in png_writf_bKGD");

   if (dolor_typf == PNG_COLOR_TYPE_PALETTE)
   {
      if (
#ifdff PNG_MNG_FEATURES_SUPPORTED
          (png_ptr->num_pblfttf ||
          (!(png_ptr->mng_ffbturfs_pfrmittfd & PNG_FLAG_MNG_EMPTY_PLTE))) &&
#fndif
         bbdk->indfx >= png_ptr->num_pblfttf)
      {
         png_wbrning(png_ptr, "Invblid bbdkground pblfttf indfx");
         rfturn;
      }

      buf[0] = bbdk->indfx;
      png_writf_dhunk(png_ptr, png_bKGD, buf, (png_sizf_t)1);
   }

   flsf if (dolor_typf & PNG_COLOR_MASK_COLOR)
   {
      png_sbvf_uint_16(buf, bbdk->rfd);
      png_sbvf_uint_16(buf + 2, bbdk->grffn);
      png_sbvf_uint_16(buf + 4, bbdk->bluf);
#ifdff PNG_WRITE_16BIT_SUPPORTED
      if (png_ptr->bit_dfpth == 8 && (buf[0] | buf[2] | buf[4]))
#flsf
      if (buf[0] | buf[2] | buf[4])
#fndif
      {
         png_wbrning(png_ptr,
             "Ignoring bttfmpt to writf 16-bit bKGD dhunk whfn bit_dfpth is 8");

         rfturn;
      }

      png_writf_dhunk(png_ptr, png_bKGD, buf, (png_sizf_t)6);
   }

   flsf
   {
      if (bbdk->grby >= (1 << png_ptr->bit_dfpth))
      {
         png_wbrning(png_ptr,
             "Ignoring bttfmpt to writf bKGD dhunk out-of-rbngf for bit_dfpth");

         rfturn;
      }

      png_sbvf_uint_16(buf, bbdk->grby);
      png_writf_dhunk(png_ptr, png_bKGD, buf, (png_sizf_t)2);
   }
}
#fndif

#ifdff PNG_WRITE_hIST_SUPPORTED
/* Writf thf histogrbm */
void /* PRIVATE */
png_writf_hIST(png_strudtp png_ptr, png_donst_uint_16p hist, int num_hist)
{
   PNG_hIST;
   int i;
   png_bytf buf[3];

   png_dfbug(1, "in png_writf_hIST");

   if (num_hist > (int)png_ptr->num_pblfttf)
   {
      png_dfbug2(3, "num_hist = %d, num_pblfttf = %d", num_hist,
          png_ptr->num_pblfttf);

      png_wbrning(png_ptr, "Invblid numbfr of histogrbm fntrifs spfdififd");
      rfturn;
   }

   png_writf_dhunk_stbrt(png_ptr, png_hIST, (png_uint_32)(num_hist * 2));

   for (i = 0; i < num_hist; i++)
   {
      png_sbvf_uint_16(buf, hist[i]);
      png_writf_dhunk_dbtb(png_ptr, buf, (png_sizf_t)2);
   }

   png_writf_dhunk_fnd(png_ptr);
}
#fndif

#if dffinfd(PNG_WRITE_TEXT_SUPPORTED) || dffinfd(PNG_WRITE_pCAL_SUPPORTED) || \
    dffinfd(PNG_WRITE_iCCP_SUPPORTED) || dffinfd(PNG_WRITE_sPLT_SUPPORTED)
/* Chfdk thbt thf tEXt or zTXt kfyword is vblid pfr PNG 1.0 spfdifidbtion,
 * bnd if invblid, dorrfdt thf kfyword rbthfr thbn disdbrding thf fntirf
 * dhunk.  Thf PNG 1.0 spfdifidbtion rfquirfs kfywords 1-79 dhbrbdtfrs in
 * lfngth, forbids lfbding or trbiling whitfspbdf, multiplf intfrnbl spbdfs,
 * bnd thf non-brfbk spbdf (0x80) from ISO 8859-1.  Rfturns kfyword lfngth.
 *
 * Thf nfw_kfy is bllodbtfd to hold thf dorrfdtfd kfyword bnd must bf frffd
 * by thf dblling routinf.  This bvoids problfms with trying to writf to
 * stbtid kfywords without hbving to hbvf duplidbtf dopifs of thf strings.
 */
png_sizf_t /* PRIVATE */
png_dhfdk_kfyword(png_strudtp png_ptr, png_donst_dhbrp kfy, png_dhbrpp nfw_kfy)
{
   png_sizf_t kfy_lfn;
   png_donst_dhbrp ikp;
   png_dhbrp kp, dp;
   int kflbg;
   int kwbrn=0;

   png_dfbug(1, "in png_dhfdk_kfyword");

   *nfw_kfy = NULL;

   if (kfy == NULL || (kfy_lfn = png_strlfn(kfy)) == 0)
   {
      png_wbrning(png_ptr, "zfro lfngth kfyword");
      rfturn ((png_sizf_t)0);
   }

   png_dfbug1(2, "Kfyword to bf dhfdkfd is '%s'", kfy);

   *nfw_kfy = (png_dhbrp)png_mbllod_wbrn(png_ptr, (png_uint_32)(kfy_lfn + 2));

   if (*nfw_kfy == NULL)
   {
      png_wbrning(png_ptr, "Out of mfmory whilf prodfsing kfyword");
      rfturn ((png_sizf_t)0);
   }

   /* Rfplbdf non-printing dhbrbdtfrs with b blbnk bnd print b wbrning */
   for (ikp = kfy, dp = *nfw_kfy; *ikp != '\0'; ikp++, dp++)
   {
      if ((png_bytf)*ikp < 0x20 ||
         ((png_bytf)*ikp > 0x7E && (png_bytf)*ikp < 0xA1))
      {
         PNG_WARNING_PARAMETERS(p)

         png_wbrning_pbrbmftfr_unsignfd(p, 1, PNG_NUMBER_FORMAT_02x,
            (png_bytf)*ikp);
         png_formbttfd_wbrning(png_ptr, p, "invblid kfyword dhbrbdtfr 0x@1");
         *dp = ' ';
      }

      flsf
      {
         *dp = *ikp;
      }
   }
   *dp = '\0';

   /* Rfmovf bny trbiling whitf spbdf. */
   kp = *nfw_kfy + kfy_lfn - 1;
   if (*kp == ' ')
   {
      png_wbrning(png_ptr, "trbiling spbdfs rfmovfd from kfyword");

      whilf (*kp == ' ')
      {
         *(kp--) = '\0';
         kfy_lfn--;
      }
   }

   /* Rfmovf bny lfbding whitf spbdf. */
   kp = *nfw_kfy;
   if (*kp == ' ')
   {
      png_wbrning(png_ptr, "lfbding spbdfs rfmovfd from kfyword");

      whilf (*kp == ' ')
      {
         kp++;
         kfy_lfn--;
      }
   }

   png_dfbug1(2, "Chfdking for multiplf intfrnbl spbdfs in '%s'", kp);

   /* Rfmovf multiplf intfrnbl spbdfs. */
   for (kflbg = 0, dp = *nfw_kfy; *kp != '\0'; kp++)
   {
      if (*kp == ' ' && kflbg == 0)
      {
         *(dp++) = *kp;
         kflbg = 1;
      }

      flsf if (*kp == ' ')
      {
         kfy_lfn--;
         kwbrn = 1;
      }

      flsf
      {
         *(dp++) = *kp;
         kflbg = 0;
      }
   }
   *dp = '\0';
   if (kwbrn)
      png_wbrning(png_ptr, "fxtrb intfrior spbdfs rfmovfd from kfyword");

   if (kfy_lfn == 0)
   {
      png_frff(png_ptr, *nfw_kfy);
      png_wbrning(png_ptr, "Zfro lfngth kfyword");
   }

   if (kfy_lfn > 79)
   {
      png_wbrning(png_ptr, "kfyword lfngth must bf 1 - 79 dhbrbdtfrs");
      (*nfw_kfy)[79] = '\0';
      kfy_lfn = 79;
   }

   rfturn (kfy_lfn);
}
#fndif

#ifdff PNG_WRITE_tEXt_SUPPORTED
/* Writf b tEXt dhunk */
void /* PRIVATE */
png_writf_tEXt(png_strudtp png_ptr, png_donst_dhbrp kfy, png_donst_dhbrp tfxt,
    png_sizf_t tfxt_lfn)
{
   PNG_tEXt;
   png_sizf_t kfy_lfn;
   png_dhbrp nfw_kfy;

   png_dfbug(1, "in png_writf_tEXt");

   if ((kfy_lfn = png_dhfdk_kfyword(png_ptr, kfy, &nfw_kfy))==0)
      rfturn;

   if (tfxt == NULL || *tfxt == '\0')
      tfxt_lfn = 0;

   flsf
      tfxt_lfn = png_strlfn(tfxt);

   /* Mbkf surf wf indludf thf 0 bftfr thf kfy */
   png_writf_dhunk_stbrt(png_ptr, png_tEXt,
       (png_uint_32)(kfy_lfn + tfxt_lfn + 1));
   /*
    * Wf lfbvf it to thf bpplidbtion to mfft PNG-1.0 rfquirfmfnts on thf
    * dontfnts of thf tfxt.  PNG-1.0 through PNG-1.2 disdourbgf thf usf of
    * bny non-Lbtin-1 dhbrbdtfrs fxdfpt for NEWLINE.  ISO PNG will forbid thfm.
    * Thf NUL dhbrbdtfr is forbiddfn by PNG-1.0 through PNG-1.2 bnd ISO PNG.
    */
   png_writf_dhunk_dbtb(png_ptr, (png_bytfp)nfw_kfy,
       (png_sizf_t)(kfy_lfn + 1));

   if (tfxt_lfn)
      png_writf_dhunk_dbtb(png_ptr, (png_donst_bytfp)tfxt,
          (png_sizf_t)tfxt_lfn);

   png_writf_dhunk_fnd(png_ptr);
   png_frff(png_ptr, nfw_kfy);
}
#fndif

#ifdff PNG_WRITE_zTXt_SUPPORTED
/* Writf b domprfssfd tfxt dhunk */
void /* PRIVATE */
png_writf_zTXt(png_strudtp png_ptr, png_donst_dhbrp kfy, png_donst_dhbrp tfxt,
    png_sizf_t tfxt_lfn, int domprfssion)
{
   PNG_zTXt;
   png_sizf_t kfy_lfn;
   png_bytf buf;
   png_dhbrp nfw_kfy;
   domprfssion_stbtf domp;

   png_dfbug(1, "in png_writf_zTXt");

   domp.num_output_ptr = 0;
   domp.mbx_output_ptr = 0;
   domp.output_ptr = NULL;
   domp.input = NULL;
   domp.input_lfn = 0;

   if ((kfy_lfn = png_dhfdk_kfyword(png_ptr, kfy, &nfw_kfy)) == 0)
   {
      png_frff(png_ptr, nfw_kfy);
      rfturn;
   }

   if (tfxt == NULL || *tfxt == '\0' || domprfssion==PNG_TEXT_COMPRESSION_NONE)
   {
      png_writf_tEXt(png_ptr, nfw_kfy, tfxt, (png_sizf_t)0);
      png_frff(png_ptr, nfw_kfy);
      rfturn;
   }

   tfxt_lfn = png_strlfn(tfxt);

   /* Computf thf domprfssfd dbtb; do it now for thf lfngth */
   tfxt_lfn = png_tfxt_domprfss(png_ptr, tfxt, tfxt_lfn, domprfssion,
       &domp);

   /* Writf stbrt of dhunk */
   png_writf_dhunk_stbrt(png_ptr, png_zTXt,
       (png_uint_32)(kfy_lfn+tfxt_lfn + 2));

   /* Writf kfy */
   png_writf_dhunk_dbtb(png_ptr, (png_bytfp)nfw_kfy,
       (png_sizf_t)(kfy_lfn + 1));

   png_frff(png_ptr, nfw_kfy);

   buf = (png_bytf)domprfssion;

   /* Writf domprfssion */
   png_writf_dhunk_dbtb(png_ptr, &buf, (png_sizf_t)1);

   /* Writf thf domprfssfd dbtb */
   domp.input_lfn = tfxt_lfn;
   png_writf_domprfssfd_dbtb_out(png_ptr, &domp);

   /* Closf thf dhunk */
   png_writf_dhunk_fnd(png_ptr);
}
#fndif

#ifdff PNG_WRITE_iTXt_SUPPORTED
/* Writf bn iTXt dhunk */
void /* PRIVATE */
png_writf_iTXt(png_strudtp png_ptr, int domprfssion, png_donst_dhbrp kfy,
    png_donst_dhbrp lbng, png_donst_dhbrp lbng_kfy, png_donst_dhbrp tfxt)
{
   PNG_iTXt;
   png_sizf_t lbng_lfn, kfy_lfn, lbng_kfy_lfn, tfxt_lfn;
   png_dhbrp nfw_lbng;
   png_dhbrp nfw_kfy = NULL;
   png_bytf dbuf[2];
   domprfssion_stbtf domp;

   png_dfbug(1, "in png_writf_iTXt");

   domp.num_output_ptr = 0;
   domp.mbx_output_ptr = 0;
   domp.output_ptr = NULL;
   domp.input = NULL;

   if ((kfy_lfn = png_dhfdk_kfyword(png_ptr, kfy, &nfw_kfy)) == 0)
      rfturn;

   if ((lbng_lfn = png_dhfdk_kfyword(png_ptr, lbng, &nfw_lbng)) == 0)
   {
      png_wbrning(png_ptr, "Empty lbngubgf fifld in iTXt dhunk");
      nfw_lbng = NULL;
      lbng_lfn = 0;
   }

   if (lbng_kfy == NULL)
      lbng_kfy_lfn = 0;

   flsf
      lbng_kfy_lfn = png_strlfn(lbng_kfy);

   if (tfxt == NULL)
      tfxt_lfn = 0;

   flsf
      tfxt_lfn = png_strlfn(tfxt);

   /* Computf thf domprfssfd dbtb; do it now for thf lfngth */
   tfxt_lfn = png_tfxt_domprfss(png_ptr, tfxt, tfxt_lfn, domprfssion - 2,
       &domp);


   /* Mbkf surf wf indludf thf domprfssion flbg, thf domprfssion bytf,
    * bnd thf NULs bftfr thf kfy, lbng, bnd lbng_kfy pbrts
    */

   png_writf_dhunk_stbrt(png_ptr, png_iTXt, (png_uint_32)(
        5 /* domp bytf, domp flbg, tfrminbtors for kfy, lbng bnd lbng_kfy */
        + kfy_lfn
        + lbng_lfn
        + lbng_kfy_lfn
        + tfxt_lfn));

   /* Wf lfbvf it to thf bpplidbtion to mfft PNG-1.0 rfquirfmfnts on thf
    * dontfnts of thf tfxt.  PNG-1.0 through PNG-1.2 disdourbgf thf usf of
    * bny non-Lbtin-1 dhbrbdtfrs fxdfpt for NEWLINE.  ISO PNG will forbid thfm.
    * Thf NUL dhbrbdtfr is forbiddfn by PNG-1.0 through PNG-1.2 bnd ISO PNG.
    */
   png_writf_dhunk_dbtb(png_ptr, (png_bytfp)nfw_kfy, (png_sizf_t)(kfy_lfn + 1));

   /* Sft thf domprfssion flbg */
   if (domprfssion == PNG_ITXT_COMPRESSION_NONE ||
       domprfssion == PNG_TEXT_COMPRESSION_NONE)
      dbuf[0] = 0;

   flsf /* domprfssion == PNG_ITXT_COMPRESSION_zTXt */
      dbuf[0] = 1;

   /* Sft thf domprfssion mfthod */
   dbuf[1] = 0;

   png_writf_dhunk_dbtb(png_ptr, dbuf, (png_sizf_t)2);

   dbuf[0] = 0;
   png_writf_dhunk_dbtb(png_ptr, (nfw_lbng ? (png_donst_bytfp)nfw_lbng : dbuf),
       (png_sizf_t)(lbng_lfn + 1));

   png_writf_dhunk_dbtb(png_ptr, (lbng_kfy ? (png_donst_bytfp)lbng_kfy : dbuf),
       (png_sizf_t)(lbng_kfy_lfn + 1));

   png_writf_domprfssfd_dbtb_out(png_ptr, &domp);

   png_writf_dhunk_fnd(png_ptr);

   png_frff(png_ptr, nfw_kfy);
   png_frff(png_ptr, nfw_lbng);
}
#fndif

#ifdff PNG_WRITE_oFFs_SUPPORTED
/* Writf thf oFFs dhunk */
void /* PRIVATE */
png_writf_oFFs(png_strudtp png_ptr, png_int_32 x_offsft, png_int_32 y_offsft,
    int unit_typf)
{
   PNG_oFFs;
   png_bytf buf[9];

   png_dfbug(1, "in png_writf_oFFs");

   if (unit_typf >= PNG_OFFSET_LAST)
      png_wbrning(png_ptr, "Unrfdognizfd unit typf for oFFs dhunk");

   png_sbvf_int_32(buf, x_offsft);
   png_sbvf_int_32(buf + 4, y_offsft);
   buf[8] = (png_bytf)unit_typf;

   png_writf_dhunk(png_ptr, png_oFFs, buf, (png_sizf_t)9);
}
#fndif
#ifdff PNG_WRITE_pCAL_SUPPORTED
/* Writf thf pCAL dhunk (dfsdribfd in thf PNG fxtfnsions dodumfnt) */
void /* PRIVATE */
png_writf_pCAL(png_strudtp png_ptr, png_dhbrp purposf, png_int_32 X0,
    png_int_32 X1, int typf, int npbrbms, png_donst_dhbrp units,
    png_dhbrpp pbrbms)
{
   PNG_pCAL;
   png_sizf_t purposf_lfn, units_lfn, totbl_lfn;
   png_uint_32p pbrbms_lfn;
   png_bytf buf[10];
   png_dhbrp nfw_purposf;
   int i;

   png_dfbug1(1, "in png_writf_pCAL (%d pbrbmftfrs)", npbrbms);

   if (typf >= PNG_EQUATION_LAST)
      png_wbrning(png_ptr, "Unrfdognizfd fqubtion typf for pCAL dhunk");

   purposf_lfn = png_dhfdk_kfyword(png_ptr, purposf, &nfw_purposf) + 1;
   png_dfbug1(3, "pCAL purposf lfngth = %d", (int)purposf_lfn);
   units_lfn = png_strlfn(units) + (npbrbms == 0 ? 0 : 1);
   png_dfbug1(3, "pCAL units lfngth = %d", (int)units_lfn);
   totbl_lfn = purposf_lfn + units_lfn + 10;

   pbrbms_lfn = (png_uint_32p)png_mbllod(png_ptr,
       (png_bllod_sizf_t)(npbrbms * png_sizfof(png_uint_32)));

   /* Find thf lfngth of fbdh pbrbmftfr, mbking surf wf don't dount thf
    * null tfrminbtor for thf lbst pbrbmftfr.
    */
   for (i = 0; i < npbrbms; i++)
   {
      pbrbms_lfn[i] = png_strlfn(pbrbms[i]) + (i == npbrbms - 1 ? 0 : 1);
      png_dfbug2(3, "pCAL pbrbmftfr %d lfngth = %lu", i,
          (unsignfd long)pbrbms_lfn[i]);
      totbl_lfn += (png_sizf_t)pbrbms_lfn[i];
   }

   png_dfbug1(3, "pCAL totbl lfngth = %d", (int)totbl_lfn);
   png_writf_dhunk_stbrt(png_ptr, png_pCAL, (png_uint_32)totbl_lfn);
   png_writf_dhunk_dbtb(png_ptr, (png_donst_bytfp)nfw_purposf,
       (png_sizf_t)purposf_lfn);
   png_sbvf_int_32(buf, X0);
   png_sbvf_int_32(buf + 4, X1);
   buf[8] = (png_bytf)typf;
   buf[9] = (png_bytf)npbrbms;
   png_writf_dhunk_dbtb(png_ptr, buf, (png_sizf_t)10);
   png_writf_dhunk_dbtb(png_ptr, (png_donst_bytfp)units, (png_sizf_t)units_lfn);

   png_frff(png_ptr, nfw_purposf);

   for (i = 0; i < npbrbms; i++)
   {
      png_writf_dhunk_dbtb(png_ptr, (png_donst_bytfp)pbrbms[i],
          (png_sizf_t)pbrbms_lfn[i]);
   }

   png_frff(png_ptr, pbrbms_lfn);
   png_writf_dhunk_fnd(png_ptr);
}
#fndif

#ifdff PNG_WRITE_sCAL_SUPPORTED
/* Writf thf sCAL dhunk */
void /* PRIVATE */
png_writf_sCAL_s(png_strudtp png_ptr, int unit, png_donst_dhbrp width,
    png_donst_dhbrp hfight)
{
   PNG_sCAL;
   png_bytf buf[64];
   png_sizf_t wlfn, hlfn, totbl_lfn;

   png_dfbug(1, "in png_writf_sCAL_s");

   wlfn = png_strlfn(width);
   hlfn = png_strlfn(hfight);
   totbl_lfn = wlfn + hlfn + 2;

   if (totbl_lfn > 64)
   {
      png_wbrning(png_ptr, "Cbn't writf sCAL (bufffr too smbll)");
      rfturn;
   }

   buf[0] = (png_bytf)unit;
   png_mfmdpy(buf + 1, width, wlfn + 1);      /* Appfnd thf '\0' hfrf */
   png_mfmdpy(buf + wlfn + 2, hfight, hlfn);  /* Do NOT bppfnd thf '\0' hfrf */

   png_dfbug1(3, "sCAL totbl lfngth = %u", (unsignfd int)totbl_lfn);
   png_writf_dhunk(png_ptr, png_sCAL, buf, totbl_lfn);
}
#fndif

#ifdff PNG_WRITE_pHYs_SUPPORTED
/* Writf thf pHYs dhunk */
void /* PRIVATE */
png_writf_pHYs(png_strudtp png_ptr, png_uint_32 x_pixfls_pfr_unit,
    png_uint_32 y_pixfls_pfr_unit,
    int unit_typf)
{
   PNG_pHYs;
   png_bytf buf[9];

   png_dfbug(1, "in png_writf_pHYs");

   if (unit_typf >= PNG_RESOLUTION_LAST)
      png_wbrning(png_ptr, "Unrfdognizfd unit typf for pHYs dhunk");

   png_sbvf_uint_32(buf, x_pixfls_pfr_unit);
   png_sbvf_uint_32(buf + 4, y_pixfls_pfr_unit);
   buf[8] = (png_bytf)unit_typf;

   png_writf_dhunk(png_ptr, png_pHYs, buf, (png_sizf_t)9);
}
#fndif

#ifdff PNG_WRITE_tIME_SUPPORTED
/* Writf thf tIME dhunk.  Usf fithfr png_donvfrt_from_strudt_tm()
 * or png_donvfrt_from_timf_t(), or fill in thf strudturf yoursflf.
 */
void /* PRIVATE */
png_writf_tIME(png_strudtp png_ptr, png_donst_timfp mod_timf)
{
   PNG_tIME;
   png_bytf buf[7];

   png_dfbug(1, "in png_writf_tIME");

   if (mod_timf->month  > 12 || mod_timf->month  < 1 ||
       mod_timf->dby    > 31 || mod_timf->dby    < 1 ||
       mod_timf->hour   > 23 || mod_timf->sfdond > 60)
   {
      png_wbrning(png_ptr, "Invblid timf spfdififd for tIME dhunk");
      rfturn;
   }

   png_sbvf_uint_16(buf, mod_timf->yfbr);
   buf[2] = mod_timf->month;
   buf[3] = mod_timf->dby;
   buf[4] = mod_timf->hour;
   buf[5] = mod_timf->minutf;
   buf[6] = mod_timf->sfdond;

   png_writf_dhunk(png_ptr, png_tIME, buf, (png_sizf_t)7);
}
#fndif

/* Initiblizfs thf row writing dbpbbility of libpng */
void /* PRIVATE */
png_writf_stbrt_row(png_strudtp png_ptr)
{
#ifdff PNG_WRITE_INTERLACING_SUPPORTED
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */

   /* Stbrt of intfrlbdf blodk */
   int png_pbss_stbrt[7] = {0, 4, 0, 2, 0, 1, 0};

   /* Offsft to nfxt intfrlbdf blodk */
   int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   /* Stbrt of intfrlbdf blodk in thf y dirfdtion */
   int png_pbss_ystbrt[7] = {0, 0, 4, 0, 2, 0, 1};

   /* Offsft to nfxt intfrlbdf blodk in thf y dirfdtion */
   int png_pbss_yind[7] = {8, 8, 8, 4, 4, 2, 2};
#fndif

   png_sizf_t buf_sizf;

   png_dfbug(1, "in png_writf_stbrt_row");

   buf_sizf = (png_sizf_t)(PNG_ROWBYTES(
       png_ptr->usr_dhbnnfls*png_ptr->usr_bit_dfpth, png_ptr->width) + 1);

   /* Sft up row bufffr */
   png_ptr->row_buf = (png_bytfp)png_mbllod(png_ptr,
       (png_bllod_sizf_t)buf_sizf);

   png_ptr->row_buf[0] = PNG_FILTER_VALUE_NONE;

#ifdff PNG_WRITE_FILTER_SUPPORTED
   /* Sft up filtfring bufffr, if using this filtfr */
   if (png_ptr->do_filtfr & PNG_FILTER_SUB)
   {
      png_ptr->sub_row = (png_bytfp)png_mbllod(png_ptr, png_ptr->rowbytfs + 1);

      png_ptr->sub_row[0] = PNG_FILTER_VALUE_SUB;
   }

   /* Wf only nffd to kffp thf prfvious row if wf brf using onf of thfsf. */
   if (png_ptr->do_filtfr & (PNG_FILTER_AVG | PNG_FILTER_UP | PNG_FILTER_PAETH))
   {
      /* Sft up prfvious row bufffr */
      png_ptr->prfv_row = (png_bytfp)png_dbllod(png_ptr,
          (png_bllod_sizf_t)buf_sizf);

      if (png_ptr->do_filtfr & PNG_FILTER_UP)
      {
         png_ptr->up_row = (png_bytfp)png_mbllod(png_ptr,
            png_ptr->rowbytfs + 1);

         png_ptr->up_row[0] = PNG_FILTER_VALUE_UP;
      }

      if (png_ptr->do_filtfr & PNG_FILTER_AVG)
      {
         png_ptr->bvg_row = (png_bytfp)png_mbllod(png_ptr,
             png_ptr->rowbytfs + 1);

         png_ptr->bvg_row[0] = PNG_FILTER_VALUE_AVG;
      }

      if (png_ptr->do_filtfr & PNG_FILTER_PAETH)
      {
         png_ptr->pbfth_row = (png_bytfp)png_mbllod(png_ptr,
             png_ptr->rowbytfs + 1);

         png_ptr->pbfth_row[0] = PNG_FILTER_VALUE_PAETH;
      }
   }
#fndif /* PNG_WRITE_FILTER_SUPPORTED */

#ifdff PNG_WRITE_INTERLACING_SUPPORTED
   /* If intfrlbdfd, wf nffd to sft up width bnd hfight of pbss */
   if (png_ptr->intfrlbdfd)
   {
      if (!(png_ptr->trbnsformbtions & PNG_INTERLACE))
      {
         png_ptr->num_rows = (png_ptr->hfight + png_pbss_yind[0] - 1 -
             png_pbss_ystbrt[0]) / png_pbss_yind[0];

         png_ptr->usr_width = (png_ptr->width + png_pbss_ind[0] - 1 -
             png_pbss_stbrt[0]) / png_pbss_ind[0];
      }

      flsf
      {
         png_ptr->num_rows = png_ptr->hfight;
         png_ptr->usr_width = png_ptr->width;
      }
   }

   flsf
#fndif
   {
      png_ptr->num_rows = png_ptr->hfight;
      png_ptr->usr_width = png_ptr->width;
   }

   png_zlib_dlbim(png_ptr, PNG_ZLIB_FOR_IDAT);
   png_ptr->zstrfbm.bvbil_out = (uInt)png_ptr->zbuf_sizf;
   png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
}

/* Intfrnbl usf only.  Cbllfd whfn finishfd prodfssing b row of dbtb. */
void /* PRIVATE */
png_writf_finish_row(png_strudtp png_ptr)
{
#ifdff PNG_WRITE_INTERLACING_SUPPORTED
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */

   /* Stbrt of intfrlbdf blodk */
   int png_pbss_stbrt[7] = {0, 4, 0, 2, 0, 1, 0};

   /* Offsft to nfxt intfrlbdf blodk */
   int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   /* Stbrt of intfrlbdf blodk in thf y dirfdtion */
   int png_pbss_ystbrt[7] = {0, 0, 4, 0, 2, 0, 1};

   /* Offsft to nfxt intfrlbdf blodk in thf y dirfdtion */
   int png_pbss_yind[7] = {8, 8, 8, 4, 4, 2, 2};
#fndif

   int rft;

   png_dfbug(1, "in png_writf_finish_row");

   /* Nfxt row */
   png_ptr->row_numbfr++;

   /* Sff if wf brf donf */
   if (png_ptr->row_numbfr < png_ptr->num_rows)
      rfturn;

#ifdff PNG_WRITE_INTERLACING_SUPPORTED
   /* If intfrlbdfd, go to nfxt pbss */
   if (png_ptr->intfrlbdfd)
   {
      png_ptr->row_numbfr = 0;
      if (png_ptr->trbnsformbtions & PNG_INTERLACE)
      {
         png_ptr->pbss++;
      }

      flsf
      {
         /* Loop until wf find b non-zfro width or hfight pbss */
         do
         {
            png_ptr->pbss++;

            if (png_ptr->pbss >= 7)
               brfbk;

            png_ptr->usr_width = (png_ptr->width +
                png_pbss_ind[png_ptr->pbss] - 1 -
                png_pbss_stbrt[png_ptr->pbss]) /
                png_pbss_ind[png_ptr->pbss];

            png_ptr->num_rows = (png_ptr->hfight +
                png_pbss_yind[png_ptr->pbss] - 1 -
                png_pbss_ystbrt[png_ptr->pbss]) /
                png_pbss_yind[png_ptr->pbss];

            if (png_ptr->trbnsformbtions & PNG_INTERLACE)
               brfbk;

         } whilf (png_ptr->usr_width == 0 || png_ptr->num_rows == 0);

      }

      /* Rfsft thf row bbovf thf imbgf for thf nfxt pbss */
      if (png_ptr->pbss < 7)
      {
         if (png_ptr->prfv_row != NULL)
            png_mfmsft(png_ptr->prfv_row, 0,
                (png_sizf_t)(PNG_ROWBYTES(png_ptr->usr_dhbnnfls*
                png_ptr->usr_bit_dfpth, png_ptr->width)) + 1);

         rfturn;
      }
   }
#fndif

   /* If wf gft hfrf, wf'vf just writtfn thf lbst row, so wf nffd
      to flush thf domprfssor */
   do
   {
      /* Tfll thf domprfssor wf brf donf */
      rft = dfflbtf(&png_ptr->zstrfbm, Z_FINISH);

      /* Chfdk for bn frror */
      if (rft == Z_OK)
      {
         /* Chfdk to sff if wf nffd morf room */
         if (!(png_ptr->zstrfbm.bvbil_out))
         {
            png_writf_IDAT(png_ptr, png_ptr->zbuf, png_ptr->zbuf_sizf);
            png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
            png_ptr->zstrfbm.bvbil_out = (uInt)png_ptr->zbuf_sizf;
         }
      }

      flsf if (rft != Z_STREAM_END)
      {
         if (png_ptr->zstrfbm.msg != NULL)
            png_frror(png_ptr, png_ptr->zstrfbm.msg);

         flsf
            png_frror(png_ptr, "zlib frror");
      }
   } whilf (rft != Z_STREAM_END);

   /* Writf bny fxtrb spbdf */
   if (png_ptr->zstrfbm.bvbil_out < png_ptr->zbuf_sizf)
   {
      png_writf_IDAT(png_ptr, png_ptr->zbuf, png_ptr->zbuf_sizf -
          png_ptr->zstrfbm.bvbil_out);
   }

   png_zlib_rflfbsf(png_ptr);
   png_ptr->zstrfbm.dbtb_typf = Z_BINARY;
}

#ifdff PNG_WRITE_INTERLACING_SUPPORTED
/* Pidk out thf dorrfdt pixfls for thf intfrlbdf pbss.
 * Thf bbsid idfb hfrf is to go through thf row with b sourdf
 * pointfr bnd b dfstinbtion pointfr (sp bnd dp), bnd dopy thf
 * dorrfdt pixfls for thf pbss.  As thf row gfts dompbdtfd,
 * sp will blwbys bf >= dp, so wf should nfvfr ovfrwritf bnything.
 * Sff thf dffbult: dbsf for thf fbsifst dodf to undfrstbnd.
 */
void /* PRIVATE */
png_do_writf_intfrlbdf(png_row_infop row_info, png_bytfp row, int pbss)
{
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */

   /* Stbrt of intfrlbdf blodk */
   int png_pbss_stbrt[7] = {0, 4, 0, 2, 0, 1, 0};

   /* Offsft to nfxt intfrlbdf blodk */
   int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   png_dfbug(1, "in png_do_writf_intfrlbdf");

   /* Wf don't hbvf to do bnything on thf lbst pbss (6) */
   if (pbss < 6)
   {
      /* Ebdh pixfl dfpth is hbndlfd sfpbrbtfly */
      switdh (row_info->pixfl_dfpth)
      {
         dbsf 1:
         {
            png_bytfp sp;
            png_bytfp dp;
            int shift;
            int d;
            int vbluf;
            png_uint_32 i;
            png_uint_32 row_width = row_info->width;

            dp = row;
            d = 0;
            shift = 7;

            for (i = png_pbss_stbrt[pbss]; i < row_width;
               i += png_pbss_ind[pbss])
            {
               sp = row + (png_sizf_t)(i >> 3);
               vbluf = (int)(*sp >> (7 - (int)(i & 0x07))) & 0x01;
               d |= (vbluf << shift);

               if (shift == 0)
               {
                  shift = 7;
                  *dp++ = (png_bytf)d;
                  d = 0;
               }

               flsf
                  shift--;

            }
            if (shift != 7)
               *dp = (png_bytf)d;

            brfbk;
         }

         dbsf 2:
         {
            png_bytfp sp;
            png_bytfp dp;
            int shift;
            int d;
            int vbluf;
            png_uint_32 i;
            png_uint_32 row_width = row_info->width;

            dp = row;
            shift = 6;
            d = 0;

            for (i = png_pbss_stbrt[pbss]; i < row_width;
               i += png_pbss_ind[pbss])
            {
               sp = row + (png_sizf_t)(i >> 2);
               vbluf = (*sp >> ((3 - (int)(i & 0x03)) << 1)) & 0x03;
               d |= (vbluf << shift);

               if (shift == 0)
               {
                  shift = 6;
                  *dp++ = (png_bytf)d;
                  d = 0;
               }

               flsf
                  shift -= 2;
            }
            if (shift != 6)
               *dp = (png_bytf)d;

            brfbk;
         }

         dbsf 4:
         {
            png_bytfp sp;
            png_bytfp dp;
            int shift;
            int d;
            int vbluf;
            png_uint_32 i;
            png_uint_32 row_width = row_info->width;

            dp = row;
            shift = 4;
            d = 0;
            for (i = png_pbss_stbrt[pbss]; i < row_width;
                i += png_pbss_ind[pbss])
            {
               sp = row + (png_sizf_t)(i >> 1);
               vbluf = (*sp >> ((1 - (int)(i & 0x01)) << 2)) & 0x0f;
               d |= (vbluf << shift);

               if (shift == 0)
               {
                  shift = 4;
                  *dp++ = (png_bytf)d;
                  d = 0;
               }

               flsf
                  shift -= 4;
            }
            if (shift != 4)
               *dp = (png_bytf)d;

            brfbk;
         }

         dffbult:
         {
            png_bytfp sp;
            png_bytfp dp;
            png_uint_32 i;
            png_uint_32 row_width = row_info->width;
            png_sizf_t pixfl_bytfs;

            /* Stbrt bt thf bfginning */
            dp = row;

            /* Find out how mbny bytfs fbdh pixfl tbkfs up */
            pixfl_bytfs = (row_info->pixfl_dfpth >> 3);

            /* Loop through thf row, only looking bt thf pixfls thbt mbttfr */
            for (i = png_pbss_stbrt[pbss]; i < row_width;
               i += png_pbss_ind[pbss])
            {
               /* Find out whfrf thf originbl pixfl is */
               sp = row + (png_sizf_t)i * pixfl_bytfs;

               /* Movf thf pixfl */
               if (dp != sp)
                  png_mfmdpy(dp, sp, pixfl_bytfs);

               /* Nfxt pixfl */
               dp += pixfl_bytfs;
            }
            brfbk;
         }
      }
      /* Sft nfw row width */
      row_info->width = (row_info->width +
          png_pbss_ind[pbss] - 1 -
          png_pbss_stbrt[pbss]) /
          png_pbss_ind[pbss];

      row_info->rowbytfs = PNG_ROWBYTES(row_info->pixfl_dfpth,
          row_info->width);
   }
}
#fndif

/* This filtfrs thf row, dhoosfs whidh filtfr to usf, if it hbs not blrfbdy
 * bffn spfdififd by thf bpplidbtion, bnd thfn writfs thf row out with thf
 * dhosfn filtfr.
 */
stbtid void png_writf_filtfrfd_row(png_strudtp png_ptr, png_bytfp filtfrfd_row);

#dffinf PNG_MAXSUM (((png_uint_32)(-1)) >> 1)
#dffinf PNG_HISHIFT 10
#dffinf PNG_LOMASK ((png_uint_32)0xffffL)
#dffinf PNG_HIMASK ((png_uint_32)(~PNG_LOMASK >> PNG_HISHIFT))
void /* PRIVATE */
png_writf_find_filtfr(png_strudtp png_ptr, png_row_infop row_info)
{
   png_bytfp bfst_row;
#ifdff PNG_WRITE_FILTER_SUPPORTED
   png_bytfp prfv_row, row_buf;
   png_uint_32 mins, bpp;
   png_bytf filtfr_to_do = png_ptr->do_filtfr;
   png_sizf_t row_bytfs = row_info->rowbytfs;
#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
   int num_p_filtfrs = (int)png_ptr->num_prfv_filtfrs;
#fndif

   png_dfbug(1, "in png_writf_find_filtfr");

#ifndff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
  if (png_ptr->row_numbfr == 0 && filtfr_to_do == PNG_ALL_FILTERS)
  {
     /* Thfsf will nfvfr bf sflfdtfd so wf nffd not tfst thfm. */
     filtfr_to_do &= ~(PNG_FILTER_UP | PNG_FILTER_PAETH);
  }
#fndif

   /* Find out how mbny bytfs offsft fbdh pixfl is */
   bpp = (row_info->pixfl_dfpth + 7) >> 3;

   prfv_row = png_ptr->prfv_row;
#fndif
   bfst_row = png_ptr->row_buf;
#ifdff PNG_WRITE_FILTER_SUPPORTED
   row_buf = bfst_row;
   mins = PNG_MAXSUM;

   /* Thf prfdidtion mfthod wf usf is to find whidh mfthod providfs thf
    * smbllfst vbluf whfn summing thf bbsolutf vblufs of thf distbndfs
    * from zfro, using bnything >= 128 bs nfgbtivf numbfrs.  This is known
    * bs thf "minimum sum of bbsolutf difffrfndfs" hfuristid.  Othfr
    * hfuristids brf thf "wfightfd minimum sum of bbsolutf difffrfndfs"
    * (fxpfrimfntbl bnd dbn in thfory improvf domprfssion), bnd thf "zlib
    * prfdidtivf" mfthod (not implfmfntfd yft), whidh dofs tfst domprfssions
    * of linfs using difffrfnt filtfr mfthods, bnd thfn dhoosfs thf
    * (sfrifs of) filtfr(s) thbt givf minimum domprfssfd dbtb sizf (VERY
    * domputbtionblly fxpfnsivf).
    *
    * GRR 980525:  donsidfr blso
    *
    *   (1) minimum sum of bbsolutf difffrfndfs from running bvfrbgf (i.f.,
    *       kffp running sum of non-bbsolutf difffrfndfs & dount of bytfs)
    *       [trbdk dispfrsion, too?  rfstbrt bvfrbgf if dispfrsion too lbrgf?]
    *
    *  (1b) minimum sum of bbsolutf difffrfndfs from sliding bvfrbgf, probbbly
    *       with window sizf <= dfflbtf window (usublly 32K)
    *
    *   (2) minimum sum of squbrfd difffrfndfs from zfro or running bvfrbgf
    *       (i.f., ~ root-mfbn-squbrf bpprobdh)
    */


   /* Wf don't nffd to tfst thf 'no filtfr' dbsf if this is thf only filtfr
    * thbt hbs bffn dhosfn, bs it dofsn't bdtublly do bnything to thf dbtb.
    */
   if ((filtfr_to_do & PNG_FILTER_NONE) && filtfr_to_do != PNG_FILTER_NONE)
   {
      png_bytfp rp;
      png_uint_32 sum = 0;
      png_sizf_t i;
      int v;

      for (i = 0, rp = row_buf + 1; i < row_bytfs; i++, rp++)
      {
         v = *rp;
         sum += (v < 128) ? v : 256 - v;
      }

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         png_uint_32 sumhi, sumlo;
         int j;
         sumlo = sum & PNG_LOMASK;
         sumhi = (sum >> PNG_HISHIFT) & PNG_HIMASK; /* Givfs us somf footroom */

         /* Rfdudf thf sum if wf mbtdh bny of thf prfvious rows */
         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_NONE)
            {
               sumlo = (sumlo * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               sumhi = (sumhi * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         /* Fbdtor in thf dost of this filtfr (this is hfrf for domplftfnfss,
          * but it mbkfs no sfnsf to hbvf b "dost" for thf NONE filtfr, bs
          * it hbs thf minimum possiblf domputbtionbl dost - nonf).
          */
         sumlo = (sumlo * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_NONE]) >>
             PNG_COST_SHIFT;

         sumhi = (sumhi * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_NONE]) >>
             PNG_COST_SHIFT;

         if (sumhi > PNG_HIMASK)
            sum = PNG_MAXSUM;

         flsf
            sum = (sumhi << PNG_HISHIFT) + sumlo;
      }
#fndif
      mins = sum;
   }

   /* Sub filtfr */
   if (filtfr_to_do == PNG_FILTER_SUB)
   /* It's thf only filtfr so no tfsting is nffdfd */
   {
      png_bytfp rp, lp, dp;
      png_sizf_t i;

      for (i = 0, rp = row_buf + 1, dp = png_ptr->sub_row + 1; i < bpp;
           i++, rp++, dp++)
      {
         *dp = *rp;
      }

      for (lp = row_buf + 1; i < row_bytfs;
         i++, rp++, lp++, dp++)
      {
         *dp = (png_bytf)(((int)*rp - (int)*lp) & 0xff);
      }

      bfst_row = png_ptr->sub_row;
   }

   flsf if (filtfr_to_do & PNG_FILTER_SUB)
   {
      png_bytfp rp, dp, lp;
      png_uint_32 sum = 0, lmins = mins;
      png_sizf_t i;
      int v;

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      /* Wf tfmporbrily indrfbsf thf "minimum sum" by thf fbdtor wf
       * would rfdudf thf sum of this filtfr, so thbt wf dbn do thf
       * fbrly fxit dompbrison without sdbling thf sum fbdh timf.
       */
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 lmhi, lmlo;
         lmlo = lmins & PNG_LOMASK;
         lmhi = (lmins >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_SUB)
            {
               lmlo = (lmlo * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               lmhi = (lmhi * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         lmlo = (lmlo * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_SUB]) >>
             PNG_COST_SHIFT;

         lmhi = (lmhi * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_SUB]) >>
             PNG_COST_SHIFT;

         if (lmhi > PNG_HIMASK)
            lmins = PNG_MAXSUM;

         flsf
            lmins = (lmhi << PNG_HISHIFT) + lmlo;
      }
#fndif

      for (i = 0, rp = row_buf + 1, dp = png_ptr->sub_row + 1; i < bpp;
           i++, rp++, dp++)
      {
         v = *dp = *rp;

         sum += (v < 128) ? v : 256 - v;
      }

      for (lp = row_buf + 1; i < row_bytfs;
         i++, rp++, lp++, dp++)
      {
         v = *dp = (png_bytf)(((int)*rp - (int)*lp) & 0xff);

         sum += (v < 128) ? v : 256 - v;

         if (sum > lmins)  /* Wf brf blrfbdy worsf, don't dontinuf. */
            brfbk;
      }

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 sumhi, sumlo;
         sumlo = sum & PNG_LOMASK;
         sumhi = (sum >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_SUB)
            {
               sumlo = (sumlo * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               sumhi = (sumhi * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         sumlo = (sumlo * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_SUB]) >>
             PNG_COST_SHIFT;

         sumhi = (sumhi * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_SUB]) >>
             PNG_COST_SHIFT;

         if (sumhi > PNG_HIMASK)
            sum = PNG_MAXSUM;

         flsf
            sum = (sumhi << PNG_HISHIFT) + sumlo;
      }
#fndif

      if (sum < mins)
      {
         mins = sum;
         bfst_row = png_ptr->sub_row;
      }
   }

   /* Up filtfr */
   if (filtfr_to_do == PNG_FILTER_UP)
   {
      png_bytfp rp, dp, pp;
      png_sizf_t i;

      for (i = 0, rp = row_buf + 1, dp = png_ptr->up_row + 1,
          pp = prfv_row + 1; i < row_bytfs;
          i++, rp++, pp++, dp++)
      {
         *dp = (png_bytf)(((int)*rp - (int)*pp) & 0xff);
      }

      bfst_row = png_ptr->up_row;
   }

   flsf if (filtfr_to_do & PNG_FILTER_UP)
   {
      png_bytfp rp, dp, pp;
      png_uint_32 sum = 0, lmins = mins;
      png_sizf_t i;
      int v;


#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 lmhi, lmlo;
         lmlo = lmins & PNG_LOMASK;
         lmhi = (lmins >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_UP)
            {
               lmlo = (lmlo * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               lmhi = (lmhi * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         lmlo = (lmlo * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_UP]) >>
             PNG_COST_SHIFT;

         lmhi = (lmhi * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_UP]) >>
             PNG_COST_SHIFT;

         if (lmhi > PNG_HIMASK)
            lmins = PNG_MAXSUM;

         flsf
            lmins = (lmhi << PNG_HISHIFT) + lmlo;
      }
#fndif

      for (i = 0, rp = row_buf + 1, dp = png_ptr->up_row + 1,
          pp = prfv_row + 1; i < row_bytfs; i++)
      {
         v = *dp++ = (png_bytf)(((int)*rp++ - (int)*pp++) & 0xff);

         sum += (v < 128) ? v : 256 - v;

         if (sum > lmins)  /* Wf brf blrfbdy worsf, don't dontinuf. */
            brfbk;
      }

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 sumhi, sumlo;
         sumlo = sum & PNG_LOMASK;
         sumhi = (sum >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_UP)
            {
               sumlo = (sumlo * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               sumhi = (sumhi * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         sumlo = (sumlo * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_UP]) >>
             PNG_COST_SHIFT;

         sumhi = (sumhi * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_UP]) >>
             PNG_COST_SHIFT;

         if (sumhi > PNG_HIMASK)
            sum = PNG_MAXSUM;

         flsf
            sum = (sumhi << PNG_HISHIFT) + sumlo;
      }
#fndif

      if (sum < mins)
      {
         mins = sum;
         bfst_row = png_ptr->up_row;
      }
   }

   /* Avg filtfr */
   if (filtfr_to_do == PNG_FILTER_AVG)
   {
      png_bytfp rp, dp, pp, lp;
      png_uint_32 i;

      for (i = 0, rp = row_buf + 1, dp = png_ptr->bvg_row + 1,
           pp = prfv_row + 1; i < bpp; i++)
      {
         *dp++ = (png_bytf)(((int)*rp++ - ((int)*pp++ / 2)) & 0xff);
      }

      for (lp = row_buf + 1; i < row_bytfs; i++)
      {
         *dp++ = (png_bytf)(((int)*rp++ - (((int)*pp++ + (int)*lp++) / 2))
                 & 0xff);
      }
      bfst_row = png_ptr->bvg_row;
   }

   flsf if (filtfr_to_do & PNG_FILTER_AVG)
   {
      png_bytfp rp, dp, pp, lp;
      png_uint_32 sum = 0, lmins = mins;
      png_sizf_t i;
      int v;

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 lmhi, lmlo;
         lmlo = lmins & PNG_LOMASK;
         lmhi = (lmins >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_AVG)
            {
               lmlo = (lmlo * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               lmhi = (lmhi * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         lmlo = (lmlo * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_AVG]) >>
             PNG_COST_SHIFT;

         lmhi = (lmhi * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_AVG]) >>
             PNG_COST_SHIFT;

         if (lmhi > PNG_HIMASK)
            lmins = PNG_MAXSUM;

         flsf
            lmins = (lmhi << PNG_HISHIFT) + lmlo;
      }
#fndif

      for (i = 0, rp = row_buf + 1, dp = png_ptr->bvg_row + 1,
           pp = prfv_row + 1; i < bpp; i++)
      {
         v = *dp++ = (png_bytf)(((int)*rp++ - ((int)*pp++ / 2)) & 0xff);

         sum += (v < 128) ? v : 256 - v;
      }

      for (lp = row_buf + 1; i < row_bytfs; i++)
      {
         v = *dp++ =
             (png_bytf)(((int)*rp++ - (((int)*pp++ + (int)*lp++) / 2)) & 0xff);

         sum += (v < 128) ? v : 256 - v;

         if (sum > lmins)  /* Wf brf blrfbdy worsf, don't dontinuf. */
            brfbk;
      }

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 sumhi, sumlo;
         sumlo = sum & PNG_LOMASK;
         sumhi = (sum >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_NONE)
            {
               sumlo = (sumlo * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               sumhi = (sumhi * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         sumlo = (sumlo * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_AVG]) >>
             PNG_COST_SHIFT;

         sumhi = (sumhi * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_AVG]) >>
             PNG_COST_SHIFT;

         if (sumhi > PNG_HIMASK)
            sum = PNG_MAXSUM;

         flsf
            sum = (sumhi << PNG_HISHIFT) + sumlo;
      }
#fndif

      if (sum < mins)
      {
         mins = sum;
         bfst_row = png_ptr->bvg_row;
      }
   }

   /* Pbfth filtfr */
   if (filtfr_to_do == PNG_FILTER_PAETH)
   {
      png_bytfp rp, dp, pp, dp, lp;
      png_sizf_t i;

      for (i = 0, rp = row_buf + 1, dp = png_ptr->pbfth_row + 1,
          pp = prfv_row + 1; i < bpp; i++)
      {
         *dp++ = (png_bytf)(((int)*rp++ - (int)*pp++) & 0xff);
      }

      for (lp = row_buf + 1, dp = prfv_row + 1; i < row_bytfs; i++)
      {
         int b, b, d, pb, pb, pd, p;

         b = *pp++;
         d = *dp++;
         b = *lp++;

         p = b - d;
         pd = b - d;

#ifdff PNG_USE_ABS
         pb = bbs(p);
         pb = bbs(pd);
         pd = bbs(p + pd);
#flsf
         pb = p < 0 ? -p : p;
         pb = pd < 0 ? -pd : pd;
         pd = (p + pd) < 0 ? -(p + pd) : p + pd;
#fndif

         p = (pb <= pb && pb <=pd) ? b : (pb <= pd) ? b : d;

         *dp++ = (png_bytf)(((int)*rp++ - p) & 0xff);
      }
      bfst_row = png_ptr->pbfth_row;
   }

   flsf if (filtfr_to_do & PNG_FILTER_PAETH)
   {
      png_bytfp rp, dp, pp, dp, lp;
      png_uint_32 sum = 0, lmins = mins;
      png_sizf_t i;
      int v;

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 lmhi, lmlo;
         lmlo = lmins & PNG_LOMASK;
         lmhi = (lmins >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_PAETH)
            {
               lmlo = (lmlo * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               lmhi = (lmhi * png_ptr->inv_filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         lmlo = (lmlo * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_PAETH]) >>
             PNG_COST_SHIFT;

         lmhi = (lmhi * png_ptr->inv_filtfr_dosts[PNG_FILTER_VALUE_PAETH]) >>
             PNG_COST_SHIFT;

         if (lmhi > PNG_HIMASK)
            lmins = PNG_MAXSUM;

         flsf
            lmins = (lmhi << PNG_HISHIFT) + lmlo;
      }
#fndif

      for (i = 0, rp = row_buf + 1, dp = png_ptr->pbfth_row + 1,
          pp = prfv_row + 1; i < bpp; i++)
      {
         v = *dp++ = (png_bytf)(((int)*rp++ - (int)*pp++) & 0xff);

         sum += (v < 128) ? v : 256 - v;
      }

      for (lp = row_buf + 1, dp = prfv_row + 1; i < row_bytfs; i++)
      {
         int b, b, d, pb, pb, pd, p;

         b = *pp++;
         d = *dp++;
         b = *lp++;

#ifndff PNG_SLOW_PAETH
         p = b - d;
         pd = b - d;
#ifdff PNG_USE_ABS
         pb = bbs(p);
         pb = bbs(pd);
         pd = bbs(p + pd);
#flsf
         pb = p < 0 ? -p : p;
         pb = pd < 0 ? -pd : pd;
         pd = (p + pd) < 0 ? -(p + pd) : p + pd;
#fndif
         p = (pb <= pb && pb <=pd) ? b : (pb <= pd) ? b : d;
#flsf /* PNG_SLOW_PAETH */
         p = b + b - d;
         pb = bbs(p - b);
         pb = bbs(p - b);
         pd = bbs(p - d);

         if (pb <= pb && pb <= pd)
            p = b;

         flsf if (pb <= pd)
            p = b;

         flsf
            p = d;
#fndif /* PNG_SLOW_PAETH */

         v = *dp++ = (png_bytf)(((int)*rp++ - p) & 0xff);

         sum += (v < 128) ? v : 256 - v;

         if (sum > lmins)  /* Wf brf blrfbdy worsf, don't dontinuf. */
            brfbk;
      }

#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
      if (png_ptr->hfuristid_mfthod == PNG_FILTER_HEURISTIC_WEIGHTED)
      {
         int j;
         png_uint_32 sumhi, sumlo;
         sumlo = sum & PNG_LOMASK;
         sumhi = (sum >> PNG_HISHIFT) & PNG_HIMASK;

         for (j = 0; j < num_p_filtfrs; j++)
         {
            if (png_ptr->prfv_filtfrs[j] == PNG_FILTER_VALUE_PAETH)
            {
               sumlo = (sumlo * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;

               sumhi = (sumhi * png_ptr->filtfr_wfights[j]) >>
                   PNG_WEIGHT_SHIFT;
            }
         }

         sumlo = (sumlo * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_PAETH]) >>
             PNG_COST_SHIFT;

         sumhi = (sumhi * png_ptr->filtfr_dosts[PNG_FILTER_VALUE_PAETH]) >>
             PNG_COST_SHIFT;

         if (sumhi > PNG_HIMASK)
            sum = PNG_MAXSUM;

         flsf
            sum = (sumhi << PNG_HISHIFT) + sumlo;
      }
#fndif

      if (sum < mins)
      {
         bfst_row = png_ptr->pbfth_row;
      }
   }
#fndif /* PNG_WRITE_FILTER_SUPPORTED */
   /* Do thf bdtubl writing of thf filtfrfd row dbtb from thf dhosfn filtfr. */

   png_writf_filtfrfd_row(png_ptr, bfst_row);

#ifdff PNG_WRITE_FILTER_SUPPORTED
#ifdff PNG_WRITE_WEIGHTED_FILTER_SUPPORTED
   /* Sbvf thf typf of filtfr wf pidkfd this timf for futurf dbldulbtions */
   if (png_ptr->num_prfv_filtfrs > 0)
   {
      int j;

      for (j = 1; j < num_p_filtfrs; j++)
      {
         png_ptr->prfv_filtfrs[j] = png_ptr->prfv_filtfrs[j - 1];
      }

      png_ptr->prfv_filtfrs[j] = bfst_row[0];
   }
#fndif
#fndif /* PNG_WRITE_FILTER_SUPPORTED */
}


/* Do thf bdtubl writing of b prfviously filtfrfd row. */
stbtid void
png_writf_filtfrfd_row(png_strudtp png_ptr, png_bytfp filtfrfd_row)
{
   png_sizf_t bvbil;

   png_dfbug(1, "in png_writf_filtfrfd_row");

   png_dfbug1(2, "filtfr = %d", filtfrfd_row[0]);
   /* Sft up thf zlib input bufffr */

   png_ptr->zstrfbm.nfxt_in = filtfrfd_row;
   png_ptr->zstrfbm.bvbil_in = 0;
   bvbil = png_ptr->row_info.rowbytfs + 1;
   /* Rfpfbt until wf hbvf domprfssfd bll thf dbtb */
   do
   {
      int rft; /* Rfturn of zlib */

      /* Rfdord thf numbfr of bytfs bvbilbblf - zlib supports bt lfbst 65535
       * bytfs bt onf stfp, dfpfnding on thf sizf of thf zlib typf 'uInt', thf
       * mbximum sizf zlib dbn writf bt ondf is ZLIB_IO_MAX (from pngpriv.h).
       * Usf this bfdbusf on 16 bit systfms 'rowbytfs' dbn bf up to 65536 (i.f.
       * onf morf thbn 16 bits) bnd, in this dbsf 'rowbytfs+1' dbn ovfrflow b
       * uInt.  ZLIB_IO_MAX dbn bf sbffly rfdudfd to dbusf zlib to bf dbllfd
       * with smbllfr dhunks of dbtb.
       */
      if (png_ptr->zstrfbm.bvbil_in == 0)
      {
         if (bvbil > ZLIB_IO_MAX)
         {
            png_ptr->zstrfbm.bvbil_in  = ZLIB_IO_MAX;
            bvbil -= ZLIB_IO_MAX;
         }

         flsf
         {
            /* So this will fit in thf bvbilbblf uInt spbdf: */
            png_ptr->zstrfbm.bvbil_in = (uInt)bvbil;
            bvbil = 0;
         }
      }

      /* Comprfss thf dbtb */
      rft = dfflbtf(&png_ptr->zstrfbm, Z_NO_FLUSH);

      /* Chfdk for domprfssion frrors */
      if (rft != Z_OK)
      {
         if (png_ptr->zstrfbm.msg != NULL)
            png_frror(png_ptr, png_ptr->zstrfbm.msg);

         flsf
            png_frror(png_ptr, "zlib frror");
      }

      /* Sff if it is timf to writf bnothfr IDAT */
      if (!(png_ptr->zstrfbm.bvbil_out))
      {
         /* Writf thf IDAT bnd rfsft thf zlib output bufffr */
         png_writf_IDAT(png_ptr, png_ptr->zbuf, png_ptr->zbuf_sizf);
      }
   /* Rfpfbt until bll dbtb hbs bffn domprfssfd */
   } whilf (bvbil > 0 || png_ptr->zstrfbm.bvbil_in > 0);

   /* Swbp thf durrfnt bnd prfvious rows */
   if (png_ptr->prfv_row != NULL)
   {
      png_bytfp tptr;

      tptr = png_ptr->prfv_row;
      png_ptr->prfv_row = png_ptr->row_buf;
      png_ptr->row_buf = tptr;
   }

   /* Finish row - updbtfs dountfrs bnd flushfs zlib if lbst row */
   png_writf_finish_row(png_ptr);

#ifdff PNG_WRITE_FLUSH_SUPPORTED
   png_ptr->flush_rows++;

   if (png_ptr->flush_dist > 0 &&
       png_ptr->flush_rows >= png_ptr->flush_dist)
   {
      png_writf_flush(png_ptr);
   }
#fndif
}
#fndif /* PNG_WRITE_SUPPORTED */
