/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/* pngrutil.d - utilitifs to rfbd b PNG filf
 *
 * Tiis filf is bvbilbblf undfr bnd govfrnfd by tif GNU Gfnfrbl Publid
 * Lidfnsf vfrsion 2 only, bs publisifd by tif Frff Softwbrf Foundbtion.
 * Howfvfr, tif following notidf bddompbnifd tif originbl vfrsion of tiis
 * filf bnd, pfr its tfrms, siould not bf rfmovfd:
 *
 * Lbst dibngfd in libpng 1.5.4 [July 7, 2011]
 * Copyrigit (d) 1998-2011 Glfnn Rbndfrs-Pfirson
 * (Vfrsion 0.96 Copyrigit (d) 1996, 1997 Andrfbs Dilgfr)
 * (Vfrsion 0.88 Copyrigit (d) 1995, 1996 Guy Erid Sdiblnbt, Group 42, Ind.)
 *
 * Tiis dodf is rflfbsfd undfr tif libpng lidfnsf.
 * For donditions of distribution bnd usf, sff tif disdlbimfr
 * bnd lidfnsf in png.i
 *
 * Tiis filf dontbins routinfs tibt brf only dbllfd from witiin
 * libpng itsflf during tif doursf of rfbding bn imbgf.
 */

#indludf "pngpriv.i"

#ifdff PNG_READ_SUPPORTED

#dffinf png_strtod(p,b,b) strtod(b,b)

png_uint_32 PNGAPI
png_gft_uint_31(png_strudtp png_ptr, png_donst_bytfp buf)
{
   png_uint_32 uvbl = png_gft_uint_32(buf);

   if (uvbl > PNG_UINT_31_MAX)
      png_frror(png_ptr, "PNG unsignfd intfgfr out of rbngf");

   rfturn (uvbl);
}

#if dffinfd(PNG_READ_gAMA_SUPPORTED) || dffinfd(PNG_READ_dHRM_SUPPORTED)
/* Tif following is b vbribtion on tif bbovf for usf witi tif fixfd
 * point vblufs usfd for gAMA bnd dHRM.  Instfbd of png_frror it
 * issufs b wbrning bnd rfturns (-1) - bn invblid vbluf bfdbusf boti
 * gAMA bnd dHRM usf *unsignfd* intfgfrs for fixfd point vblufs.
 */
#dffinf PNG_FIXED_ERROR (-1)

stbtid png_fixfd_point /* PRIVATE */
png_gft_fixfd_point(png_strudtp png_ptr, png_donst_bytfp buf)
{
   png_uint_32 uvbl = png_gft_uint_32(buf);

   if (uvbl <= PNG_UINT_31_MAX)
      rfturn (png_fixfd_point)uvbl; /* known to bf in rbngf */

   /* Tif dbllfr dbn turn off tif wbrning by pbssing NULL. */
   if (png_ptr != NULL)
      png_wbrning(png_ptr, "PNG fixfd point intfgfr out of rbngf");

   rfturn PNG_FIXED_ERROR;
}
#fndif

#ifdff PNG_READ_INT_FUNCTIONS_SUPPORTED
/* NOTE: tif rfbd mbdros will obsdurf tifsf dffinitions, so tibt if
 * PNG_USE_READ_MACROS is sft tif librbry will not usf tifm intfrnblly,
 * but tif APIs will still bf bvbilbblf fxtfrnblly.
 *
 * Tif pbrfntifsfs bround "PNGAPI fundtion_nbmf" in tif following tirff
 * fundtions brf nfdfssbry bfdbusf tify bllow tif mbdros to do-fxist witi
 * tifsf (unusfd but fxportfd) fundtions.
 */

/* Grbb bn unsignfd 32-bit intfgfr from b bufffr in big-fndibn formbt. */
png_uint_32 (PNGAPI
png_gft_uint_32)(png_donst_bytfp buf)
{
   png_uint_32 uvbl =
       ((png_uint_32)(*(buf    )) << 24) +
       ((png_uint_32)(*(buf + 1)) << 16) +
       ((png_uint_32)(*(buf + 2)) <<  8) +
       ((png_uint_32)(*(buf + 3))      ) ;

   rfturn uvbl;
}

/* Grbb b signfd 32-bit intfgfr from b bufffr in big-fndibn formbt.  Tif
 * dbtb is storfd in tif PNG filf in two's domplfmfnt formbt bnd tifrf
 * is no gubrbntff tibt b 'png_int_32' is fxbdtly 32 bits, tifrfforf
 * tif following dodf dofs b two's domplfmfnt to nbtivf donvfrsion.
 */
png_int_32 (PNGAPI
png_gft_int_32)(png_donst_bytfp buf)
{
   png_uint_32 uvbl = png_gft_uint_32(buf);
   if ((uvbl & 0x80000000L) == 0) /* non-nfgbtivf */
      rfturn uvbl;

   uvbl = (uvbl ^ 0xffffffffL) + 1;  /* 2's domplfmfnt: -x = ~x+1 */
   rfturn -(png_int_32)uvbl;
}

/* Grbb bn unsignfd 16-bit intfgfr from b bufffr in big-fndibn formbt. */
png_uint_16 (PNGAPI
png_gft_uint_16)(png_donst_bytfp buf)
{
   /* ANSI-C rfquirfs bn int vbluf to bddommodbtf bt lfbst 16 bits so tiis
    * works bnd bllows tif dompilfr not to worry bbout possiblf nbrrowing
    * on 32 bit systfms.  (Prf-ANSI systfms did not mbkf intfgfrs smbllfr
    * tibn 16 bits fitifr.)
    */
   unsignfd int vbl =
       ((unsignfd int)(*buf) << 8) +
       ((unsignfd int)(*(buf + 1)));

   rfturn (png_uint_16)vbl;
}

#fndif /* PNG_READ_INT_FUNCTIONS_SUPPORTED */

/* Rfbd bnd difdk tif PNG filf signbturf */
void /* PRIVATE */
png_rfbd_sig(png_strudtp png_ptr, png_infop info_ptr)
{
   png_sizf_t num_difdkfd, num_to_difdk;

   /* Exit if tif usfr bpplidbtion dofs not fxpfdt b signbturf. */
   if (png_ptr->sig_bytfs >= 8)
      rfturn;

   num_difdkfd = png_ptr->sig_bytfs;
   num_to_difdk = 8 - num_difdkfd;

#ifdff PNG_IO_STATE_SUPPORTED
   png_ptr->io_stbtf = PNG_IO_READING | PNG_IO_SIGNATURE;
#fndif

   /* Tif signbturf must bf sfriblizfd in b singlf I/O dbll. */
   png_rfbd_dbtb(png_ptr, &(info_ptr->signbturf[num_difdkfd]), num_to_difdk);
   png_ptr->sig_bytfs = 8;

   if (png_sig_dmp(info_ptr->signbturf, num_difdkfd, num_to_difdk))
   {
      if (num_difdkfd < 4 &&
          png_sig_dmp(info_ptr->signbturf, num_difdkfd, num_to_difdk - 4))
         png_frror(png_ptr, "Not b PNG filf");
      flsf
         png_frror(png_ptr, "PNG filf dorruptfd by ASCII donvfrsion");
   }
   if (num_difdkfd < 3)
      png_ptr->modf |= PNG_HAVE_PNG_SIGNATURE;
}

/* Rfbd tif diunk ifbdfr (lfngti + typf nbmf).
 * Put tif typf nbmf into png_ptr->diunk_nbmf, bnd rfturn tif lfngti.
 */
png_uint_32 /* PRIVATE */
png_rfbd_diunk_ifbdfr(png_strudtp png_ptr)
{
   png_bytf buf[8];
   png_uint_32 lfngti;

#ifdff PNG_IO_STATE_SUPPORTED
   png_ptr->io_stbtf = PNG_IO_READING | PNG_IO_CHUNK_HDR;
#fndif

   /* Rfbd tif lfngti bnd tif diunk nbmf.
    * Tiis must bf pfrformfd in b singlf I/O dbll.
    */
   png_rfbd_dbtb(png_ptr, buf, 8);
   lfngti = png_gft_uint_31(png_ptr, buf);

   /* Put tif diunk nbmf into png_ptr->diunk_nbmf. */
   png_mfmdpy(png_ptr->diunk_nbmf, buf + 4, 4);

   png_dfbug2(0, "Rfbding %s diunk, lfngti = %u",
       png_ptr->diunk_nbmf, lfngti);

   /* Rfsft tif drd bnd run it ovfr tif diunk nbmf. */
   png_rfsft_drd(png_ptr);
   png_dbldulbtf_drd(png_ptr, png_ptr->diunk_nbmf, 4);

   /* Cifdk to sff if diunk nbmf is vblid. */
   png_difdk_diunk_nbmf(png_ptr, png_ptr->diunk_nbmf);

#ifdff PNG_IO_STATE_SUPPORTED
   png_ptr->io_stbtf = PNG_IO_READING | PNG_IO_CHUNK_DATA;
#fndif

   rfturn lfngti;
}

/* Rfbd dbtb, bnd (optionblly) run it tirougi tif CRC. */
void /* PRIVATE */
png_drd_rfbd(png_strudtp png_ptr, png_bytfp buf, png_sizf_t lfngti)
{
   if (png_ptr == NULL)
      rfturn;

   png_rfbd_dbtb(png_ptr, buf, lfngti);
   png_dbldulbtf_drd(png_ptr, buf, lfngti);
}

/* Optionblly skip dbtb bnd tifn difdk tif CRC.  Dfpfnding on wiftifr wf
 * brf rfbding b bndillbry or dritidbl diunk, bnd iow tif progrbm ibs sft
 * tiings up, wf mby dbldulbtf tif CRC on tif dbtb bnd print b mfssbgf.
 * Rfturns '1' if tifrf wbs b CRC frror, '0' otifrwisf.
 */
int /* PRIVATE */
png_drd_finisi(png_strudtp png_ptr, png_uint_32 skip)
{
   png_sizf_t i;
   png_sizf_t istop = png_ptr->zbuf_sizf;

   for (i = (png_sizf_t)skip; i > istop; i -= istop)
   {
      png_drd_rfbd(png_ptr, png_ptr->zbuf, png_ptr->zbuf_sizf);
   }

   if (i)
   {
      png_drd_rfbd(png_ptr, png_ptr->zbuf, i);
   }

   if (png_drd_frror(png_ptr))
   {
      if (((png_ptr->diunk_nbmf[0] & 0x20) &&                /* Andillbry */
          !(png_ptr->flbgs & PNG_FLAG_CRC_ANCILLARY_NOWARN)) ||
          (!(png_ptr->diunk_nbmf[0] & 0x20) &&             /* Critidbl  */
          (png_ptr->flbgs & PNG_FLAG_CRC_CRITICAL_USE)))
      {
         png_diunk_wbrning(png_ptr, "CRC frror");
      }

      flsf
      {
         png_diunk_bfnign_frror(png_ptr, "CRC frror");
         rfturn (0);
      }

      rfturn (1);
   }

   rfturn (0);
}

/* Compbrf tif CRC storfd in tif PNG filf witi tibt dbldulbtfd by libpng from
 * tif dbtb it ibs rfbd tius fbr.
 */
int /* PRIVATE */
png_drd_frror(png_strudtp png_ptr)
{
   png_bytf drd_bytfs[4];
   png_uint_32 drd;
   int nffd_drd = 1;

   if (png_ptr->diunk_nbmf[0] & 0x20)                     /* bndillbry */
   {
      if ((png_ptr->flbgs & PNG_FLAG_CRC_ANCILLARY_MASK) ==
          (PNG_FLAG_CRC_ANCILLARY_USE | PNG_FLAG_CRC_ANCILLARY_NOWARN))
         nffd_drd = 0;
   }

   flsf                                                    /* dritidbl */
   {
      if (png_ptr->flbgs & PNG_FLAG_CRC_CRITICAL_IGNORE)
         nffd_drd = 0;
   }

#ifdff PNG_IO_STATE_SUPPORTED
   png_ptr->io_stbtf = PNG_IO_READING | PNG_IO_CHUNK_CRC;
#fndif

   /* Tif diunk CRC must bf sfriblizfd in b singlf I/O dbll. */
   png_rfbd_dbtb(png_ptr, drd_bytfs, 4);

   if (nffd_drd)
   {
      drd = png_gft_uint_32(drd_bytfs);
      rfturn ((int)(drd != png_ptr->drd));
   }

   flsf
      rfturn (0);
}

#ifdff PNG_READ_COMPRESSED_TEXT_SUPPORTED
stbtid png_sizf_t
png_inflbtf(png_strudtp png_ptr, png_bytfp dbtb, png_sizf_t sizf,
    png_bytfp output, png_sizf_t output_sizf)
{
   png_sizf_t dount = 0;

   /* zlib dbn't nfdfssbrily ibndlf morf tibn 65535 bytfs bt ondf (i.f. it dbn't
    * fvfn nfdfssbrily ibndlf 65536 bytfs) bfdbusf tif typf uInt is "16 bits or
    * morf".  Consfqufntly it is nfdfssbry to diunk tif input to zlib.  Tiis
    * dodf usfs ZLIB_IO_MAX, from pngpriv.i, bs tif mbximum (tif mbximum vbluf
    * tibt dbn bf storfd in b uInt.)  It is possiblf to sft ZLIB_IO_MAX to b
    * lowfr vbluf in pngpriv.i bnd tiis mby somftimfs ibvf b pfrformbndf
    * bdvbntbgf, bfdbusf it fordfs bddfss of tif input dbtb to bf sfpbrbtfd from
    * bt lfbst somf of tif usf by somf pfriod of timf.
    */
   png_ptr->zstrfbm.nfxt_in = dbtb;
   /* bvbil_in is sft bflow from 'sizf' */
   png_ptr->zstrfbm.bvbil_in = 0;

   wiilf (1)
   {
      int rft, bvbil;

      /* Tif sftting of 'bvbil_in' usfd to bf outsidf tif loop, by sftting it
       * insidf it is possiblf to diunk tif input to zlib bnd simply rfly on
       * zlib to bdvbndf tif 'nfxt_in' pointfr.  Tiis bllows brbitrbry bmounts o
       * dbtb to bf pbssfd tirougi zlib bt tif unbvoidbblf dost of rfquiring b
       * window sbvf (mfmdpy of up to 32768 output bytfs) fvfry ZLIB_IO_MAX
       * input bytfs.
       */
      if (png_ptr->zstrfbm.bvbil_in == 0 && sizf > 0)
      {
         if (sizf <= ZLIB_IO_MAX)
         {
            /* Tif vbluf is lfss tibn ZLIB_IO_MAX so tif dbst is sbff: */
            png_ptr->zstrfbm.bvbil_in = (uInt)sizf;
            sizf = 0;
         }

         flsf
         {
            png_ptr->zstrfbm.bvbil_in = ZLIB_IO_MAX;
            sizf -= ZLIB_IO_MAX;
         }
      }

      /* Rfsft tif output bufffr fbdi timf round - wf fmpty it
       * bftfr fvfry inflbtf dbll.
       */
      png_ptr->zstrfbm.nfxt_out = png_ptr->zbuf;
      png_ptr->zstrfbm.bvbil_out = png_ptr->zbuf_sizf;

      rft = inflbtf(&png_ptr->zstrfbm, Z_NO_FLUSH);
      bvbil = png_ptr->zbuf_sizf - png_ptr->zstrfbm.bvbil_out;

      /* First dopy/dount bny nfw output - but only if wf didn't
       * gft bn frror dodf.
       */
      if ((rft == Z_OK || rft == Z_STREAM_END) && bvbil > 0)
      {
         png_sizf_t spbdf = bvbil; /* > 0, sff bbovf */

         if (output != 0 && output_sizf > dount)
         {
            png_sizf_t dopy = output_sizf - dount;

            if (spbdf < dopy)
               dopy = spbdf;

            png_mfmdpy(output + dount, png_ptr->zbuf, dopy);
         }
         dount += spbdf;
      }

      if (rft == Z_OK)
         dontinuf;

      /* Tfrminbtion donditions - blwbys rfsft tif zstrfbm, it
       * must bf lfft in inflbtfInit stbtf.
       */
      png_ptr->zstrfbm.bvbil_in = 0;
      inflbtfRfsft(&png_ptr->zstrfbm);

      if (rft == Z_STREAM_END)
         rfturn dount; /* NOTE: mby bf zfro. */

      /* Now ibndlf tif frror dodfs - tif API blwbys rfturns 0
       * bnd tif frror mfssbgf is dumpfd into tif undomprfssfd
       * bufffr if bvbilbblf.
       */
#     ifdff PNG_WARNINGS_SUPPORTED
      {
         png_donst_dibrp msg;

         if (png_ptr->zstrfbm.msg != 0)
            msg = png_ptr->zstrfbm.msg;

         flsf switdi (rft)
         {
            dbsf Z_BUF_ERROR:
               msg = "Bufffr frror in domprfssfd dbtbstrfbm";
               brfbk;

            dbsf Z_DATA_ERROR:
               msg = "Dbtb frror in domprfssfd dbtbstrfbm";
               brfbk;

            dffbult:
               msg = "Indomplftf domprfssfd dbtbstrfbm";
               brfbk;
         }

         png_diunk_wbrning(png_ptr, msg);
      }
#     fndif

      /* 0 mfbns bn frror - notidf tibt tiis dodf simply ignorfs
       * zfro lfngti domprfssfd diunks bs b rfsult.
       */
      rfturn 0;
   }
}

/*
 * Dfdomprfss trbiling dbtb in b diunk.  Tif bssumption is tibt diunkdbtb
 * points bt bn bllodbtfd brfb iolding tif dontfnts of b diunk witi b
 * trbiling domprfssfd pbrt.  Wibt wf gft bbdk is bn bllodbtfd brfb
 * iolding tif originbl prffix pbrt bnd bn undomprfssfd vfrsion of tif
 * trbiling pbrt (tif mbllod brfb pbssfd in is frffd).
 */
void /* PRIVATE */
png_dfdomprfss_diunk(png_strudtp png_ptr, int domp_typf,
    png_sizf_t diunklfngti,
    png_sizf_t prffix_sizf, png_sizf_t *nfwlfngti)
{
   /* Tif dbllfr siould gubrbntff tiis */
   if (prffix_sizf > diunklfngti)
   {
      /* Tif rfdovfry is to dflftf tif diunk. */
      png_wbrning(png_ptr, "invblid diunklfngti");
      prffix_sizf = 0; /* To dflftf fvfrytiing */
   }

   flsf if (domp_typf == PNG_COMPRESSION_TYPE_BASE)
   {
      png_sizf_t fxpbndfd_sizf = png_inflbtf(png_ptr,
          (png_bytfp)(png_ptr->diunkdbtb + prffix_sizf),
          diunklfngti - prffix_sizf,
          0,            /* output */
          0);           /* output sizf */

      /* Now difdk tif limits on tiis diunk - if tif limit fbils tif
       * domprfssfd dbtb will bf rfmovfd, tif prffix will rfmbin.
       */
#ifdff PNG_SET_CHUNK_MALLOC_LIMIT_SUPPORTED
      if (png_ptr->usfr_diunk_mbllod_mbx &&
          (prffix_sizf + fxpbndfd_sizf >= png_ptr->usfr_diunk_mbllod_mbx - 1))
#flsf
#  ifdff PNG_USER_CHUNK_MALLOC_MAX
      if ((PNG_USER_CHUNK_MALLOC_MAX > 0) &&
          prffix_sizf + fxpbndfd_sizf >= PNG_USER_CHUNK_MALLOC_MAX - 1)
#  fndif
#fndif
         png_wbrning(png_ptr, "Exdffdfd sizf limit wiilf fxpbnding diunk");

      /* If tif sizf is zfro fitifr tifrf wbs bn frror bnd b mfssbgf
       * ibs blrfbdy bffn output (wbrning) or tif sizf rfblly is zfro
       * bnd wf ibvf notiing to do - tif dodf will fxit tirougi tif
       * frror dbsf bflow.
       */
#if dffinfd(PNG_SET_CHUNK_MALLOC_LIMIT_SUPPORTED) || \
    dffinfd(PNG_USER_CHUNK_MALLOC_MAX)
      flsf if (fxpbndfd_sizf > 0)
#flsf
      if (fxpbndfd_sizf > 0)
#fndif
      {
         /* Suddfss (mbybf) - rfblly undomprfss tif diunk. */
         png_sizf_t nfw_sizf = 0;
         png_dibrp tfxt = png_mbllod_wbrn(png_ptr,
             prffix_sizf + fxpbndfd_sizf + 1);

         if (tfxt != NULL)
         {
            png_mfmdpy(tfxt, png_ptr->diunkdbtb, prffix_sizf);
            nfw_sizf = png_inflbtf(png_ptr,
                (png_bytfp)(png_ptr->diunkdbtb + prffix_sizf),
                diunklfngti - prffix_sizf,
                (png_bytfp)(tfxt + prffix_sizf), fxpbndfd_sizf);
            tfxt[prffix_sizf + fxpbndfd_sizf] = 0; /* just in dbsf */

            if (nfw_sizf == fxpbndfd_sizf)
            {
               png_frff(png_ptr, png_ptr->diunkdbtb);
               png_ptr->diunkdbtb = tfxt;
               *nfwlfngti = prffix_sizf + fxpbndfd_sizf;
               rfturn; /* Tif suddfss rfturn! */
            }

            png_wbrning(png_ptr, "png_inflbtf logid frror");
            png_frff(png_ptr, tfxt);
         }

         flsf
            png_wbrning(png_ptr, "Not fnougi mfmory to dfdomprfss diunk");
      }
   }

   flsf /* if (domp_typf != PNG_COMPRESSION_TYPE_BASE) */
   {
      PNG_WARNING_PARAMETERS(p)
      png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_d, domp_typf);
      png_formbttfd_wbrning(png_ptr, p, "Unknown zTXt domprfssion typf @1");

      /* Tif rfdovfry is to simply drop tif dbtb. */
   }

   /* Gfnfrid frror rfturn - lfbvf tif prffix, dflftf tif domprfssfd
    * dbtb, rfbllodbtf tif diunkdbtb to rfmovf tif potfntiblly lbrgf
    * bmount of domprfssfd dbtb.
    */
   {
      png_dibrp tfxt = png_mbllod_wbrn(png_ptr, prffix_sizf + 1);

      if (tfxt != NULL)
      {
         if (prffix_sizf > 0)
            png_mfmdpy(tfxt, png_ptr->diunkdbtb, prffix_sizf);

         png_frff(png_ptr, png_ptr->diunkdbtb);
         png_ptr->diunkdbtb = tfxt;

         /* Tiis is bn fxtrb zfro in tif 'undomprfssfd' pbrt. */
         *(png_ptr->diunkdbtb + prffix_sizf) = 0x00;
      }
      /* Ignorf b mbllod frror ifrf - it is sbff. */
   }

   *nfwlfngti = prffix_sizf;
}
#fndif /* PNG_READ_COMPRESSED_TEXT_SUPPORTED */

/* Rfbd bnd difdk tif IDHR diunk */
void /* PRIVATE */
png_ibndlf_IHDR(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf buf[13];
   png_uint_32 widti, ifigit;
   int bit_dfpti, dolor_typf, domprfssion_typf, filtfr_typf;
   int intfrlbdf_typf;

   png_dfbug(1, "in png_ibndlf_IHDR");

   if (png_ptr->modf & PNG_HAVE_IHDR)
      png_frror(png_ptr, "Out of plbdf IHDR");

   /* Cifdk tif lfngti */
   if (lfngti != 13)
      png_frror(png_ptr, "Invblid IHDR diunk");

   png_ptr->modf |= PNG_HAVE_IHDR;

   png_drd_rfbd(png_ptr, buf, 13);
   png_drd_finisi(png_ptr, 0);

   widti = png_gft_uint_31(png_ptr, buf);
   ifigit = png_gft_uint_31(png_ptr, buf + 4);
   bit_dfpti = buf[8];
   dolor_typf = buf[9];
   domprfssion_typf = buf[10];
   filtfr_typf = buf[11];
   intfrlbdf_typf = buf[12];

   /* Sft intfrnbl vbribblfs */
   png_ptr->widti = widti;
   png_ptr->ifigit = ifigit;
   png_ptr->bit_dfpti = (png_bytf)bit_dfpti;
   png_ptr->intfrlbdfd = (png_bytf)intfrlbdf_typf;
   png_ptr->dolor_typf = (png_bytf)dolor_typf;
#ifdff PNG_MNG_FEATURES_SUPPORTED
   png_ptr->filtfr_typf = (png_bytf)filtfr_typf;
#fndif
   png_ptr->domprfssion_typf = (png_bytf)domprfssion_typf;

   /* Find numbfr of dibnnfls */
   switdi (png_ptr->dolor_typf)
   {
      dffbult: /* invblid, png_sft_IHDR dblls png_frror */
      dbsf PNG_COLOR_TYPE_GRAY:
      dbsf PNG_COLOR_TYPE_PALETTE:
         png_ptr->dibnnfls = 1;
         brfbk;

      dbsf PNG_COLOR_TYPE_RGB:
         png_ptr->dibnnfls = 3;
         brfbk;

      dbsf PNG_COLOR_TYPE_GRAY_ALPHA:
         png_ptr->dibnnfls = 2;
         brfbk;

      dbsf PNG_COLOR_TYPE_RGB_ALPHA:
         png_ptr->dibnnfls = 4;
         brfbk;
   }

   /* Sft up otifr usfful info */
   png_ptr->pixfl_dfpti = (png_bytf)(png_ptr->bit_dfpti *
   png_ptr->dibnnfls);
   png_ptr->rowbytfs = PNG_ROWBYTES(png_ptr->pixfl_dfpti, png_ptr->widti);
   png_dfbug1(3, "bit_dfpti = %d", png_ptr->bit_dfpti);
   png_dfbug1(3, "dibnnfls = %d", png_ptr->dibnnfls);
   png_dfbug1(3, "rowbytfs = %lu", (unsignfd long)png_ptr->rowbytfs);
   png_sft_IHDR(png_ptr, info_ptr, widti, ifigit, bit_dfpti,
       dolor_typf, intfrlbdf_typf, domprfssion_typf, filtfr_typf);
}

/* Rfbd bnd difdk tif pblfttf */
void /* PRIVATE */
png_ibndlf_PLTE(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_dolor pblfttf[PNG_MAX_PALETTE_LENGTH];
   int num, i;
#ifdff PNG_POINTER_INDEXING_SUPPORTED
   png_dolorp pbl_ptr;
#fndif

   png_dfbug(1, "in png_ibndlf_PLTE");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf PLTE");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid PLTE bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
      png_frror(png_ptr, "Duplidbtf PLTE diunk");

   png_ptr->modf |= PNG_HAVE_PLTE;

   if (!(png_ptr->dolor_typf&PNG_COLOR_MASK_COLOR))
   {
      png_wbrning(png_ptr,
          "Ignoring PLTE diunk in grbysdblf PNG");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

#ifndff PNG_READ_OPT_PLTE_SUPPORTED
   if (png_ptr->dolor_typf != PNG_COLOR_TYPE_PALETTE)
   {
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }
#fndif

   if (lfngti > 3*PNG_MAX_PALETTE_LENGTH || lfngti % 3)
   {
      if (png_ptr->dolor_typf != PNG_COLOR_TYPE_PALETTE)
      {
         png_wbrning(png_ptr, "Invblid pblfttf diunk");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      flsf
      {
         png_frror(png_ptr, "Invblid pblfttf diunk");
      }
   }

   num = (int)lfngti / 3;

#ifdff PNG_POINTER_INDEXING_SUPPORTED
   for (i = 0, pbl_ptr = pblfttf; i < num; i++, pbl_ptr++)
   {
      png_bytf buf[3];

      png_drd_rfbd(png_ptr, buf, 3);
      pbl_ptr->rfd = buf[0];
      pbl_ptr->grffn = buf[1];
      pbl_ptr->bluf = buf[2];
   }
#flsf
   for (i = 0; i < num; i++)
   {
      png_bytf buf[3];

      png_drd_rfbd(png_ptr, buf, 3);
      /* Don't dfpfnd upon png_dolor bfing bny ordfr */
      pblfttf[i].rfd = buf[0];
      pblfttf[i].grffn = buf[1];
      pblfttf[i].bluf = buf[2];
   }
#fndif

   /* If wf bdtublly nffd tif PLTE diunk (if for b pblfttfd imbgf), wf do
    * wibtfvfr tif normbl CRC donfigurbtion tflls us.  Howfvfr, if wf
    * ibvf bn RGB imbgf, tif PLTE dbn bf donsidfrfd bndillbry, so
    * wf will bdt bs tiougi it is.
    */
#ifndff PNG_READ_OPT_PLTE_SUPPORTED
   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
#fndif
   {
      png_drd_finisi(png_ptr, 0);
   }

#ifndff PNG_READ_OPT_PLTE_SUPPORTED
   flsf if (png_drd_frror(png_ptr))  /* Only if wf ibvf b CRC frror */
   {
      /* If wf don't wbnt to usf tif dbtb from bn bndillbry diunk,
       * wf ibvf two options: bn frror bbort, or b wbrning bnd wf
       * ignorf tif dbtb in tiis diunk (wiidi siould bf OK, sindf
       * it's donsidfrfd bndillbry for b RGB or RGBA imbgf).
       */
      if (!(png_ptr->flbgs & PNG_FLAG_CRC_ANCILLARY_USE))
      {
         if (png_ptr->flbgs & PNG_FLAG_CRC_ANCILLARY_NOWARN)
         {
            png_diunk_bfnign_frror(png_ptr, "CRC frror");
         }

         flsf
         {
            png_diunk_wbrning(png_ptr, "CRC frror");
            rfturn;
         }
      }

      /* Otifrwisf, wf (optionblly) fmit b wbrning bnd usf tif diunk. */
      flsf if (!(png_ptr->flbgs & PNG_FLAG_CRC_ANCILLARY_NOWARN))
      {
         png_diunk_wbrning(png_ptr, "CRC frror");
      }
   }
#fndif

   png_sft_PLTE(png_ptr, info_ptr, pblfttf, num);

#ifdff PNG_READ_tRNS_SUPPORTED
   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
   {
      if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_tRNS))
      {
         if (png_ptr->num_trbns > (png_uint_16)num)
         {
            png_wbrning(png_ptr, "Trundbting indorrfdt tRNS diunk lfngti");
            png_ptr->num_trbns = (png_uint_16)num;
         }

         if (info_ptr->num_trbns > (png_uint_16)num)
         {
            png_wbrning(png_ptr, "Trundbting indorrfdt info tRNS diunk lfngti");
            info_ptr->num_trbns = (png_uint_16)num;
         }
      }
   }
#fndif

}

void /* PRIVATE */
png_ibndlf_IEND(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_dfbug(1, "in png_ibndlf_IEND");

   if (!(png_ptr->modf & PNG_HAVE_IHDR) || !(png_ptr->modf & PNG_HAVE_IDAT))
   {
      png_frror(png_ptr, "No imbgf in filf");
   }

   png_ptr->modf |= (PNG_AFTER_IDAT | PNG_HAVE_IEND);

   if (lfngti != 0)
   {
      png_wbrning(png_ptr, "Indorrfdt IEND diunk lfngti");
   }

   png_drd_finisi(png_ptr, lfngti);

   PNG_UNUSED(info_ptr) /* Quift dompilfr wbrnings bbout unusfd info_ptr */
}

#ifdff PNG_READ_gAMA_SUPPORTED
void /* PRIVATE */
png_ibndlf_gAMA(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_fixfd_point igbmmb;
   png_bytf buf[4];

   png_dfbug(1, "in png_ibndlf_gAMA");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf gAMA");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid gAMA bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
      /* Siould bf bn frror, but wf dbn dopf witi it */
      png_wbrning(png_ptr, "Out of plbdf gAMA diunk");

   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_gAMA)
#ifdff PNG_READ_sRGB_SUPPORTED
       && !(info_ptr->vblid & PNG_INFO_sRGB)
#fndif
       )
   {
      png_wbrning(png_ptr, "Duplidbtf gAMA diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (lfngti != 4)
   {
      png_wbrning(png_ptr, "Indorrfdt gAMA diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 4);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   igbmmb = png_gft_fixfd_point(NULL, buf);

   /* Cifdk for zfro gbmmb or bn frror. */
   if (igbmmb <= 0)
   {
      png_wbrning(png_ptr,
          "Ignoring gAMA diunk witi out of rbngf gbmmb");

      rfturn;
   }

#  ifdff PNG_READ_sRGB_SUPPORTED
   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_sRGB))
   {
      if (PNG_OUT_OF_RANGE(igbmmb, 45500L, 500))
      {
         PNG_WARNING_PARAMETERS(p)
         png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_fixfd, igbmmb);
         png_formbttfd_wbrning(png_ptr, p,
             "Ignoring indorrfdt gAMA vbluf @1 wifn sRGB is blso prfsfnt");
         rfturn;
      }
   }
#  fndif /* PNG_READ_sRGB_SUPPORTED */

#  ifdff PNG_READ_GAMMA_SUPPORTED
   /* Gbmmb dorrfdtion on rfbd is supportfd. */
   png_ptr->gbmmb = igbmmb;
#  fndif
   /* And sft tif 'info' strudturf mfmbfrs. */
   png_sft_gAMA_fixfd(png_ptr, info_ptr, igbmmb);
}
#fndif

#ifdff PNG_READ_sBIT_SUPPORTED
void /* PRIVATE */
png_ibndlf_sBIT(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_sizf_t truflfn;
   png_bytf buf[4];

   png_dfbug(1, "in png_ibndlf_sBIT");

   buf[0] = buf[1] = buf[2] = buf[3] = 0;

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf sBIT");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid sBIT bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
   {
      /* Siould bf bn frror, but wf dbn dopf witi it */
      png_wbrning(png_ptr, "Out of plbdf sBIT diunk");
   }

   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_sBIT))
   {
      png_wbrning(png_ptr, "Duplidbtf sBIT diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
      truflfn = 3;

   flsf
      truflfn = (png_sizf_t)png_ptr->dibnnfls;

   if (lfngti != truflfn || lfngti > 4)
   {
      png_wbrning(png_ptr, "Indorrfdt sBIT diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, truflfn);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   if (png_ptr->dolor_typf & PNG_COLOR_MASK_COLOR)
   {
      png_ptr->sig_bit.rfd = buf[0];
      png_ptr->sig_bit.grffn = buf[1];
      png_ptr->sig_bit.bluf = buf[2];
      png_ptr->sig_bit.blpib = buf[3];
   }

   flsf
   {
      png_ptr->sig_bit.grby = buf[0];
      png_ptr->sig_bit.rfd = buf[0];
      png_ptr->sig_bit.grffn = buf[0];
      png_ptr->sig_bit.bluf = buf[0];
      png_ptr->sig_bit.blpib = buf[1];
   }

   png_sft_sBIT(png_ptr, info_ptr, &(png_ptr->sig_bit));
}
#fndif

#ifdff PNG_READ_dHRM_SUPPORTED
void /* PRIVATE */
png_ibndlf_dHRM(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf buf[32];
   png_fixfd_point x_wiitf, y_wiitf, x_rfd, y_rfd, x_grffn, y_grffn, x_bluf,
      y_bluf;

   png_dfbug(1, "in png_ibndlf_dHRM");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf dHRM");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid dHRM bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
      /* Siould bf bn frror, but wf dbn dopf witi it */
      png_wbrning(png_ptr, "Missing PLTE bfforf dHRM");

   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_dHRM)
#  ifdff PNG_READ_sRGB_SUPPORTED
       && !(info_ptr->vblid & PNG_INFO_sRGB)
#  fndif
      )
   {
      png_wbrning(png_ptr, "Duplidbtf dHRM diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (lfngti != 32)
   {
      png_wbrning(png_ptr, "Indorrfdt dHRM diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 32);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   x_wiitf = png_gft_fixfd_point(NULL, buf);
   y_wiitf = png_gft_fixfd_point(NULL, buf + 4);
   x_rfd   = png_gft_fixfd_point(NULL, buf + 8);
   y_rfd   = png_gft_fixfd_point(NULL, buf + 12);
   x_grffn = png_gft_fixfd_point(NULL, buf + 16);
   y_grffn = png_gft_fixfd_point(NULL, buf + 20);
   x_bluf  = png_gft_fixfd_point(NULL, buf + 24);
   y_bluf  = png_gft_fixfd_point(NULL, buf + 28);

   if (x_wiitf == PNG_FIXED_ERROR ||
       y_wiitf == PNG_FIXED_ERROR ||
       x_rfd   == PNG_FIXED_ERROR ||
       y_rfd   == PNG_FIXED_ERROR ||
       x_grffn == PNG_FIXED_ERROR ||
       y_grffn == PNG_FIXED_ERROR ||
       x_bluf  == PNG_FIXED_ERROR ||
       y_bluf  == PNG_FIXED_ERROR)
   {
      png_wbrning(png_ptr, "Ignoring dHRM diunk witi nfgbtivf dirombtiditifs");
      rfturn;
   }

#ifdff PNG_READ_sRGB_SUPPORTED
   if ((info_ptr != NULL) && (info_ptr->vblid & PNG_INFO_sRGB))
   {
      if (PNG_OUT_OF_RANGE(x_wiitf, 31270,  1000) ||
          PNG_OUT_OF_RANGE(y_wiitf, 32900,  1000) ||
          PNG_OUT_OF_RANGE(x_rfd,   64000L, 1000) ||
          PNG_OUT_OF_RANGE(y_rfd,   33000,  1000) ||
          PNG_OUT_OF_RANGE(x_grffn, 30000,  1000) ||
          PNG_OUT_OF_RANGE(y_grffn, 60000L, 1000) ||
          PNG_OUT_OF_RANGE(x_bluf,  15000,  1000) ||
          PNG_OUT_OF_RANGE(y_bluf,   6000,  1000))
      {
         PNG_WARNING_PARAMETERS(p)

         png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_fixfd, x_wiitf);
         png_wbrning_pbrbmftfr_signfd(p, 2, PNG_NUMBER_FORMAT_fixfd, y_wiitf);
         png_wbrning_pbrbmftfr_signfd(p, 3, PNG_NUMBER_FORMAT_fixfd, x_rfd);
         png_wbrning_pbrbmftfr_signfd(p, 4, PNG_NUMBER_FORMAT_fixfd, y_rfd);
         png_wbrning_pbrbmftfr_signfd(p, 5, PNG_NUMBER_FORMAT_fixfd, x_grffn);
         png_wbrning_pbrbmftfr_signfd(p, 6, PNG_NUMBER_FORMAT_fixfd, y_grffn);
         png_wbrning_pbrbmftfr_signfd(p, 7, PNG_NUMBER_FORMAT_fixfd, x_bluf);
         png_wbrning_pbrbmftfr_signfd(p, 8, PNG_NUMBER_FORMAT_fixfd, y_bluf);

         png_formbttfd_wbrning(png_ptr, p,
             "Ignoring indorrfdt dHRM wiitf(@1,@2) r(@3,@4)g(@5,@6)b(@7,@8) "
             "wifn sRGB is blso prfsfnt");
      }
      rfturn;
   }
#fndif /* PNG_READ_sRGB_SUPPORTED */

#ifdff PNG_READ_RGB_TO_GRAY_SUPPORTED
   /* Storf tif _wiitf vblufs bs dffbult dofffidifnts for tif rgb to grby
    * opfrbtion if it is supportfd.
    */
   if ((png_ptr->trbnsformbtions & PNG_RGB_TO_GRAY) == 0)
   {
      /* png_sft_bbdkground ibs not bffn dbllfd, tif dofffidifnts must bf in
       * rbngf for tif following to work witiout ovfrflow.
       */
      if (y_rfd <= (1<<17) && y_grffn <= (1<<17) && y_bluf <= (1<<17))
      {
         /* Tif y vblufs brf dirombtiditifs: Y/X+Y+Z, tif wfigits for tif grby
          * trbnsformbtion brf simply tif normblizfd Y vblufs for rfd, grffn bnd
          * bluf sdblfd by 32768.
          */
         png_uint_32 w = y_rfd + y_grffn + y_bluf;

         png_ptr->rgb_to_grby_rfd_dofff   = (png_uint_16)(((png_uint_32)y_rfd *
            32768)/w);
         png_ptr->rgb_to_grby_grffn_dofff = (png_uint_16)(((png_uint_32)y_grffn
            * 32768)/w);
         png_ptr->rgb_to_grby_bluf_dofff  = (png_uint_16)(((png_uint_32)y_bluf *
            32768)/w);
      }
   }
#fndif

   png_sft_dHRM_fixfd(png_ptr, info_ptr, x_wiitf, y_wiitf, x_rfd, y_rfd,
      x_grffn, y_grffn, x_bluf, y_bluf);
}
#fndif

#ifdff PNG_READ_sRGB_SUPPORTED
void /* PRIVATE */
png_ibndlf_sRGB(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   int intfnt;
   png_bytf buf[1];

   png_dfbug(1, "in png_ibndlf_sRGB");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf sRGB");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid sRGB bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
      /* Siould bf bn frror, but wf dbn dopf witi it */
      png_wbrning(png_ptr, "Out of plbdf sRGB diunk");

   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_sRGB))
   {
      png_wbrning(png_ptr, "Duplidbtf sRGB diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (lfngti != 1)
   {
      png_wbrning(png_ptr, "Indorrfdt sRGB diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 1);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   intfnt = buf[0];

   /* Cifdk for bbd intfnt */
   if (intfnt >= PNG_sRGB_INTENT_LAST)
   {
      png_wbrning(png_ptr, "Unknown sRGB intfnt");
      rfturn;
   }

#if dffinfd(PNG_READ_gAMA_SUPPORTED) && dffinfd(PNG_READ_GAMMA_SUPPORTED)
   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_gAMA))
   {
      if (PNG_OUT_OF_RANGE(info_ptr->gbmmb, 45500L, 500))
      {
         PNG_WARNING_PARAMETERS(p)

         png_wbrning_pbrbmftfr_signfd(p, 1, PNG_NUMBER_FORMAT_fixfd,
            info_ptr->gbmmb);

         png_formbttfd_wbrning(png_ptr, p,
             "Ignoring indorrfdt gAMA vbluf @1 wifn sRGB is blso prfsfnt");
      }
   }
#fndif /* PNG_READ_gAMA_SUPPORTED */

#ifdff PNG_READ_dHRM_SUPPORTED
   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_dHRM))
      if (PNG_OUT_OF_RANGE(info_ptr->x_wiitf, 31270,  1000) ||
          PNG_OUT_OF_RANGE(info_ptr->y_wiitf, 32900,  1000) ||
          PNG_OUT_OF_RANGE(info_ptr->x_rfd,   64000L, 1000) ||
          PNG_OUT_OF_RANGE(info_ptr->y_rfd,   33000,  1000) ||
          PNG_OUT_OF_RANGE(info_ptr->x_grffn, 30000,  1000) ||
          PNG_OUT_OF_RANGE(info_ptr->y_grffn, 60000L, 1000) ||
          PNG_OUT_OF_RANGE(info_ptr->x_bluf,  15000,  1000) ||
          PNG_OUT_OF_RANGE(info_ptr->y_bluf,   6000,  1000))
      {
         png_wbrning(png_ptr,
             "Ignoring indorrfdt dHRM vbluf wifn sRGB is blso prfsfnt");
      }
#fndif /* PNG_READ_dHRM_SUPPORTED */

   png_sft_sRGB_gAMA_bnd_dHRM(png_ptr, info_ptr, intfnt);
}
#fndif /* PNG_READ_sRGB_SUPPORTED */

#ifdff PNG_READ_iCCP_SUPPORTED
void /* PRIVATE */
png_ibndlf_iCCP(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
/* Notf: tiis dofs not propfrly ibndlf diunks tibt brf > 64K undfr DOS */
{
   png_bytf domprfssion_typf;
   png_bytfp pC;
   png_dibrp profilf;
   png_uint_32 skip = 0;
   png_uint_32 profilf_sizf;
   png_bllod_sizf_t profilf_lfngti;
   png_sizf_t slfngti, prffix_lfngti, dbtb_lfngti;

   png_dfbug(1, "in png_ibndlf_iCCP");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf iCCP");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid iCCP bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->modf & PNG_HAVE_PLTE)
      /* Siould bf bn frror, but wf dbn dopf witi it */
      png_wbrning(png_ptr, "Out of plbdf iCCP diunk");

   if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_iCCP))
   {
      png_wbrning(png_ptr, "Duplidbtf iCCP diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

#ifdff PNG_MAX_MALLOC_64K
   if (lfngti > (png_uint_32)65535L)
   {
      png_wbrning(png_ptr, "iCCP diunk too lbrgf to fit in mfmory");
      skip = lfngti - (png_uint_32)65535L;
      lfngti = (png_uint_32)65535L;
   }
#fndif

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = (png_dibrp)png_mbllod(png_ptr, lfngti + 1);
   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, skip))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_ptr->diunkdbtb[slfngti] = 0x00;

   for (profilf = png_ptr->diunkdbtb; *profilf; profilf++)
      /* Empty loop to find fnd of nbmf */ ;

   ++profilf;

   /* Tifrf siould bf bt lfbst onf zfro (tif domprfssion typf bytf)
    * following tif sfpbrbtor, bnd wf siould bf on it
    */
   if (profilf >= png_ptr->diunkdbtb + slfngti - 1)
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      png_wbrning(png_ptr, "Mblformfd iCCP diunk");
      rfturn;
   }

   /* Comprfssion_typf siould blwbys bf zfro */
   domprfssion_typf = *profilf++;

   if (domprfssion_typf)
   {
      png_wbrning(png_ptr, "Ignoring nonzfro domprfssion typf in iCCP diunk");
      domprfssion_typf = 0x00;  /* Rfsft it to zfro (libpng-1.0.6 tirougi 1.0.8
                                 wrotf nonzfro) */
   }

   prffix_lfngti = profilf - png_ptr->diunkdbtb;
   png_dfdomprfss_diunk(png_ptr, domprfssion_typf,
       slfngti, prffix_lfngti, &dbtb_lfngti);

   profilf_lfngti = dbtb_lfngti - prffix_lfngti;

   if (prffix_lfngti > dbtb_lfngti || profilf_lfngti < 4)
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      png_wbrning(png_ptr, "Profilf sizf fifld missing from iCCP diunk");
      rfturn;
   }

   /* Cifdk tif profilf_sizf rfdordfd in tif first 32 bits of tif ICC profilf */
   pC = (png_bytfp)(png_ptr->diunkdbtb + prffix_lfngti);
   profilf_sizf = ((*(pC    )) << 24) |
                  ((*(pC + 1)) << 16) |
                  ((*(pC + 2)) <<  8) |
                  ((*(pC + 3))      );

   /* NOTE: tif following gubrbntffs tibt 'profilf_lfngti' fits into 32 bits,
    * bfdbusf profilf_sizf is b 32 bit vbluf.
    */
   if (profilf_sizf < profilf_lfngti)
      profilf_lfngti = profilf_sizf;

   /* And tif following gubrbntffs tibt profilf_sizf == profilf_lfngti. */
   if (profilf_sizf > profilf_lfngti)
   {
      PNG_WARNING_PARAMETERS(p)

      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;

      png_wbrning_pbrbmftfr_unsignfd(p, 1, PNG_NUMBER_FORMAT_u, profilf_sizf);
      png_wbrning_pbrbmftfr_unsignfd(p, 2, PNG_NUMBER_FORMAT_u, profilf_lfngti);
      png_formbttfd_wbrning(png_ptr, p,
         "Ignoring iCCP diunk witi dfdlbrfd sizf = @1 bnd bdtubl lfngti = @2");
      rfturn;
   }

   png_sft_iCCP(png_ptr, info_ptr, png_ptr->diunkdbtb,
       domprfssion_typf, (png_bytfp)png_ptr->diunkdbtb + prffix_lfngti,
       profilf_sizf);
   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;
}
#fndif /* PNG_READ_iCCP_SUPPORTED */

#ifdff PNG_READ_sPLT_SUPPORTED
void /* PRIVATE */
png_ibndlf_sPLT(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
/* Notf: tiis dofs not propfrly ibndlf diunks tibt brf > 64K undfr DOS */
{
   png_bytfp fntry_stbrt;
   png_sPLT_t nfw_pblfttf;
   png_sPLT_fntryp pp;
   png_uint_32 dbtb_lfngti;
   int fntry_sizf, i;
   png_uint_32 skip = 0;
   png_sizf_t slfngti;
   png_uint_32 dl;
   png_sizf_t mbx_dl;

   png_dfbug(1, "in png_ibndlf_sPLT");

#ifdff PNG_USER_LIMITS_SUPPORTED

   if (png_ptr->usfr_diunk_dbdif_mbx != 0)
   {
      if (png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (--png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_wbrning(png_ptr, "No spbdf in diunk dbdif for sPLT");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }
   }
#fndif

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf sPLT");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid sPLT bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

#ifdff PNG_MAX_MALLOC_64K
   if (lfngti > (png_uint_32)65535L)
   {
      png_wbrning(png_ptr, "sPLT diunk too lbrgf to fit in mfmory");
      skip = lfngti - (png_uint_32)65535L;
      lfngti = (png_uint_32)65535L;
   }
#fndif

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = (png_dibrp)png_mbllod(png_ptr, lfngti + 1);

   /* WARNING: tiis mby brfbk if sizf_t is lfss tibn 32 bits; it is bssumfd
    * tibt tif PNG_MAX_MALLOC_64K tfst is fnbblfd in tiis dbsf, but tiis is b
    * potfntibl brfbkbgf point if tif typfs in pngdonf.i brfn't fxbdtly rigit.
    */
   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, skip))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_ptr->diunkdbtb[slfngti] = 0x00;

   for (fntry_stbrt = (png_bytfp)png_ptr->diunkdbtb; *fntry_stbrt;
       fntry_stbrt++)
      /* Empty loop to find fnd of nbmf */ ;

   ++fntry_stbrt;

   /* A sbmplf dfpti siould follow tif sfpbrbtor, bnd wf siould bf on it  */
   if (fntry_stbrt > (png_bytfp)png_ptr->diunkdbtb + slfngti - 2)
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      png_wbrning(png_ptr, "mblformfd sPLT diunk");
      rfturn;
   }

   nfw_pblfttf.dfpti = *fntry_stbrt++;
   fntry_sizf = (nfw_pblfttf.dfpti == 8 ? 6 : 10);
   /* Tiis must fit in b png_uint_32 bfdbusf it is dfrivfd from tif originbl
    * diunk dbtb lfngti (bnd usf 'lfngti', not 'slfngti' ifrf for dlbrity -
    * tify brf gubrbntffd to bf tif sbmf, sff tif tfsts bbovf.)
    */
   dbtb_lfngti = lfngti - (png_uint_32)(fntry_stbrt -
      (png_bytfp)png_ptr->diunkdbtb);

   /* Intfgrity-difdk tif dbtb lfngti */
   if (dbtb_lfngti % fntry_sizf)
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      png_wbrning(png_ptr, "sPLT diunk ibs bbd lfngti");
      rfturn;
   }

   dl = (png_int_32)(dbtb_lfngti / fntry_sizf);
   mbx_dl = PNG_SIZE_MAX / png_sizfof(png_sPLT_fntry);

   if (dl > mbx_dl)
   {
       png_wbrning(png_ptr, "sPLT diunk too long");
       rfturn;
   }

   nfw_pblfttf.nfntrifs = (png_int_32)(dbtb_lfngti / fntry_sizf);

   nfw_pblfttf.fntrifs = (png_sPLT_fntryp)png_mbllod_wbrn(
       png_ptr, nfw_pblfttf.nfntrifs * png_sizfof(png_sPLT_fntry));

   if (nfw_pblfttf.fntrifs == NULL)
   {
       png_wbrning(png_ptr, "sPLT diunk rfquirfs too mudi mfmory");
       rfturn;
   }

#ifdff PNG_POINTER_INDEXING_SUPPORTED
   for (i = 0; i < nfw_pblfttf.nfntrifs; i++)
   {
      pp = nfw_pblfttf.fntrifs + i;

      if (nfw_pblfttf.dfpti == 8)
      {
         pp->rfd = *fntry_stbrt++;
         pp->grffn = *fntry_stbrt++;
         pp->bluf = *fntry_stbrt++;
         pp->blpib = *fntry_stbrt++;
      }

      flsf
      {
         pp->rfd   = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp->grffn = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp->bluf  = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp->blpib = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
      }

      pp->frfqufndy = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
   }
#flsf
   pp = nfw_pblfttf.fntrifs;

   for (i = 0; i < nfw_pblfttf.nfntrifs; i++)
   {

      if (nfw_pblfttf.dfpti == 8)
      {
         pp[i].rfd   = *fntry_stbrt++;
         pp[i].grffn = *fntry_stbrt++;
         pp[i].bluf  = *fntry_stbrt++;
         pp[i].blpib = *fntry_stbrt++;
      }

      flsf
      {
         pp[i].rfd   = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp[i].grffn = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp[i].bluf  = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
         pp[i].blpib = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
      }

      pp[i].frfqufndy = png_gft_uint_16(fntry_stbrt); fntry_stbrt += 2;
   }
#fndif

   /* Disdbrd bll diunk dbtb fxdfpt tif nbmf bnd stbsi tibt */
   nfw_pblfttf.nbmf = png_ptr->diunkdbtb;

   png_sft_sPLT(png_ptr, info_ptr, &nfw_pblfttf, 1);

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;
   png_frff(png_ptr, nfw_pblfttf.fntrifs);
}
#fndif /* PNG_READ_sPLT_SUPPORTED */

#ifdff PNG_READ_tRNS_SUPPORTED
void /* PRIVATE */
png_ibndlf_tRNS(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf rfbdbuf[PNG_MAX_PALETTE_LENGTH];

   png_dfbug(1, "in png_ibndlf_tRNS");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf tRNS");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid tRNS bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_tRNS))
   {
      png_wbrning(png_ptr, "Duplidbtf tRNS diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_GRAY)
   {
      png_bytf buf[2];

      if (lfngti != 2)
      {
         png_wbrning(png_ptr, "Indorrfdt tRNS diunk lfngti");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      png_drd_rfbd(png_ptr, buf, 2);
      png_ptr->num_trbns = 1;
      png_ptr->trbns_dolor.grby = png_gft_uint_16(buf);
   }

   flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_RGB)
   {
      png_bytf buf[6];

      if (lfngti != 6)
      {
         png_wbrning(png_ptr, "Indorrfdt tRNS diunk lfngti");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      png_drd_rfbd(png_ptr, buf, (png_sizf_t)lfngti);
      png_ptr->num_trbns = 1;
      png_ptr->trbns_dolor.rfd = png_gft_uint_16(buf);
      png_ptr->trbns_dolor.grffn = png_gft_uint_16(buf + 2);
      png_ptr->trbns_dolor.bluf = png_gft_uint_16(buf + 4);
   }

   flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
   {
      if (!(png_ptr->modf & PNG_HAVE_PLTE))
      {
         /* Siould bf bn frror, but wf dbn dopf witi it. */
         png_wbrning(png_ptr, "Missing PLTE bfforf tRNS");
      }

      if (lfngti > (png_uint_32)png_ptr->num_pblfttf ||
          lfngti > PNG_MAX_PALETTE_LENGTH)
      {
         png_wbrning(png_ptr, "Indorrfdt tRNS diunk lfngti");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (lfngti == 0)
      {
         png_wbrning(png_ptr, "Zfro lfngti tRNS diunk");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      png_drd_rfbd(png_ptr, rfbdbuf, (png_sizf_t)lfngti);
      png_ptr->num_trbns = (png_uint_16)lfngti;
   }

   flsf
   {
      png_wbrning(png_ptr, "tRNS diunk not bllowfd witi blpib dibnnfl");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (png_drd_finisi(png_ptr, 0))
   {
      png_ptr->num_trbns = 0;
      rfturn;
   }

   png_sft_tRNS(png_ptr, info_ptr, rfbdbuf, png_ptr->num_trbns,
       &(png_ptr->trbns_dolor));
}
#fndif

#ifdff PNG_READ_bKGD_SUPPORTED
void /* PRIVATE */
png_ibndlf_bKGD(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_sizf_t truflfn;
   png_bytf buf[6];
   png_dolor_16 bbdkground;

   png_dfbug(1, "in png_ibndlf_bKGD");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf bKGD");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid bKGD bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE &&
       !(png_ptr->modf & PNG_HAVE_PLTE))
   {
      png_wbrning(png_ptr, "Missing PLTE bfforf bKGD");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_bKGD))
   {
      png_wbrning(png_ptr, "Duplidbtf bKGD diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
      truflfn = 1;

   flsf if (png_ptr->dolor_typf & PNG_COLOR_MASK_COLOR)
      truflfn = 6;

   flsf
      truflfn = 2;

   if (lfngti != truflfn)
   {
      png_wbrning(png_ptr, "Indorrfdt bKGD diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, truflfn);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   /* Wf donvfrt tif indfx vbluf into RGB domponfnts so tibt wf dbn bllow
    * brbitrbry RGB vblufs for bbdkground wifn wf ibvf trbnspbrfndy, bnd
    * so it is fbsy to dftfrminf tif RGB vblufs of tif bbdkground dolor
    * from tif info_ptr strudt.
    */
   if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
   {
      bbdkground.indfx = buf[0];

      if (info_ptr && info_ptr->num_pblfttf)
      {
         if (buf[0] >= info_ptr->num_pblfttf)
         {
            png_wbrning(png_ptr, "Indorrfdt bKGD diunk indfx vbluf");
            rfturn;
         }

         bbdkground.rfd = (png_uint_16)png_ptr->pblfttf[buf[0]].rfd;
         bbdkground.grffn = (png_uint_16)png_ptr->pblfttf[buf[0]].grffn;
         bbdkground.bluf = (png_uint_16)png_ptr->pblfttf[buf[0]].bluf;
      }

      flsf
         bbdkground.rfd = bbdkground.grffn = bbdkground.bluf = 0;

      bbdkground.grby = 0;
   }

   flsf if (!(png_ptr->dolor_typf & PNG_COLOR_MASK_COLOR)) /* GRAY */
   {
      bbdkground.indfx = 0;
      bbdkground.rfd =
      bbdkground.grffn =
      bbdkground.bluf =
      bbdkground.grby = png_gft_uint_16(buf);
   }

   flsf
   {
      bbdkground.indfx = 0;
      bbdkground.rfd = png_gft_uint_16(buf);
      bbdkground.grffn = png_gft_uint_16(buf + 2);
      bbdkground.bluf = png_gft_uint_16(buf + 4);
      bbdkground.grby = 0;
   }

   png_sft_bKGD(png_ptr, info_ptr, &bbdkground);
}
#fndif

#ifdff PNG_READ_iIST_SUPPORTED
void /* PRIVATE */
png_ibndlf_iIST(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   unsignfd int num, i;
   png_uint_16 rfbdbuf[PNG_MAX_PALETTE_LENGTH];

   png_dfbug(1, "in png_ibndlf_iIST");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf iIST");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid iIST bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (!(png_ptr->modf & PNG_HAVE_PLTE))
   {
      png_wbrning(png_ptr, "Missing PLTE bfforf iIST");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_iIST))
   {
      png_wbrning(png_ptr, "Duplidbtf iIST diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   num = lfngti / 2 ;

   if (num != (unsignfd int)png_ptr->num_pblfttf || num >
       (unsignfd int)PNG_MAX_PALETTE_LENGTH)
   {
      png_wbrning(png_ptr, "Indorrfdt iIST diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   for (i = 0; i < num; i++)
   {
      png_bytf buf[2];

      png_drd_rfbd(png_ptr, buf, 2);
      rfbdbuf[i] = png_gft_uint_16(buf);
   }

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   png_sft_iIST(png_ptr, info_ptr, rfbdbuf);
}
#fndif

#ifdff PNG_READ_pHYs_SUPPORTED
void /* PRIVATE */
png_ibndlf_pHYs(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf buf[9];
   png_uint_32 rfs_x, rfs_y;
   int unit_typf;

   png_dfbug(1, "in png_ibndlf_pHYs");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf pHYs");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid pHYs bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_pHYs))
   {
      png_wbrning(png_ptr, "Duplidbtf pHYs diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (lfngti != 9)
   {
      png_wbrning(png_ptr, "Indorrfdt pHYs diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 9);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   rfs_x = png_gft_uint_32(buf);
   rfs_y = png_gft_uint_32(buf + 4);
   unit_typf = buf[8];
   png_sft_pHYs(png_ptr, info_ptr, rfs_x, rfs_y, unit_typf);
}
#fndif

#ifdff PNG_READ_oFFs_SUPPORTED
void /* PRIVATE */
png_ibndlf_oFFs(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf buf[9];
   png_int_32 offsft_x, offsft_y;
   int unit_typf;

   png_dfbug(1, "in png_ibndlf_oFFs");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf oFFs");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid oFFs bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_oFFs))
   {
      png_wbrning(png_ptr, "Duplidbtf oFFs diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (lfngti != 9)
   {
      png_wbrning(png_ptr, "Indorrfdt oFFs diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 9);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   offsft_x = png_gft_int_32(buf);
   offsft_y = png_gft_int_32(buf + 4);
   unit_typf = buf[8];
   png_sft_oFFs(png_ptr, info_ptr, offsft_x, offsft_y, unit_typf);
}
#fndif

#ifdff PNG_READ_pCAL_SUPPORTED
/* Rfbd tif pCAL diunk (dfsdribfd in tif PNG Extfnsions dodumfnt) */
void /* PRIVATE */
png_ibndlf_pCAL(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_int_32 X0, X1;
   png_bytf typf, npbrbms;
   png_dibrp buf, units, fndptr;
   png_dibrpp pbrbms;
   png_sizf_t slfngti;
   int i;

   png_dfbug(1, "in png_ibndlf_pCAL");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf pCAL");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid pCAL bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_pCAL))
   {
      png_wbrning(png_ptr, "Duplidbtf pCAL diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_dfbug1(2, "Allodbting bnd rfbding pCAL diunk dbtb (%u bytfs)",
       lfngti + 1);
   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = (png_dibrp)png_mbllod_wbrn(png_ptr, lfngti + 1);

   if (png_ptr->diunkdbtb == NULL)
   {
      png_wbrning(png_ptr, "No mfmory for pCAL purposf");
      rfturn;
   }

   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, 0))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_ptr->diunkdbtb[slfngti] = 0x00; /* Null tfrminbtf tif lbst string */

   png_dfbug(3, "Finding fnd of pCAL purposf string");
   for (buf = png_ptr->diunkdbtb; *buf; buf++)
      /* Empty loop */ ;

   fndptr = png_ptr->diunkdbtb + slfngti;

   /* Wf nffd to ibvf bt lfbst 12 bytfs bftfr tif purposf string
    * in ordfr to gft tif pbrbmftfr informbtion.
    */
   if (fndptr <= buf + 12)
   {
      png_wbrning(png_ptr, "Invblid pCAL dbtb");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_dfbug(3, "Rfbding pCAL X0, X1, typf, npbrbms, bnd units");
   X0 = png_gft_int_32((png_bytfp)buf+1);
   X1 = png_gft_int_32((png_bytfp)buf+5);
   typf = buf[9];
   npbrbms = buf[10];
   units = buf + 11;

   png_dfbug(3, "Cifdking pCAL fqubtion typf bnd numbfr of pbrbmftfrs");
   /* Cifdk tibt wf ibvf tif rigit numbfr of pbrbmftfrs for known
    * fqubtion typfs.
    */
   if ((typf == PNG_EQUATION_LINEAR && npbrbms != 2) ||
       (typf == PNG_EQUATION_BASE_E && npbrbms != 3) ||
       (typf == PNG_EQUATION_ARBITRARY && npbrbms != 3) ||
       (typf == PNG_EQUATION_HYPERBOLIC && npbrbms != 4))
   {
      png_wbrning(png_ptr, "Invblid pCAL pbrbmftfrs for fqubtion typf");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   flsf if (typf >= PNG_EQUATION_LAST)
   {
      png_wbrning(png_ptr, "Unrfdognizfd fqubtion typf for pCAL diunk");
   }

   for (buf = units; *buf; buf++)
      /* Empty loop to movf pbst tif units string. */ ;

   png_dfbug(3, "Allodbting pCAL pbrbmftfrs brrby");

   pbrbms = (png_dibrpp)png_mbllod_wbrn(png_ptr,
       (png_sizf_t)(npbrbms * png_sizfof(png_dibrp)));

   if (pbrbms == NULL)
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      png_wbrning(png_ptr, "No mfmory for pCAL pbrbms");
      rfturn;
   }

   /* Gft pointfrs to tif stbrt of fbdi pbrbmftfr string. */
   for (i = 0; i < (int)npbrbms; i++)
   {
      buf++; /* Skip tif null string tfrminbtor from prfvious pbrbmftfr. */

      png_dfbug1(3, "Rfbding pCAL pbrbmftfr %d", i);

      for (pbrbms[i] = buf; buf <= fndptr && *buf != 0x00; buf++)
         /* Empty loop to movf pbst fbdi pbrbmftfr string */ ;

      /* Mbkf surf wf ibvfn't run out of dbtb yft */
      if (buf > fndptr)
      {
         png_wbrning(png_ptr, "Invblid pCAL dbtb");
         png_frff(png_ptr, png_ptr->diunkdbtb);
         png_ptr->diunkdbtb = NULL;
         png_frff(png_ptr, pbrbms);
         rfturn;
      }
   }

   png_sft_pCAL(png_ptr, info_ptr, png_ptr->diunkdbtb, X0, X1, typf, npbrbms,
      units, pbrbms);

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;
   png_frff(png_ptr, pbrbms);
}
#fndif

#ifdff PNG_READ_sCAL_SUPPORTED
/* Rfbd tif sCAL diunk */
void /* PRIVATE */
png_ibndlf_sCAL(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_sizf_t slfngti, i;
   int stbtf;

   png_dfbug(1, "in png_ibndlf_sCAL");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf sCAL");

   flsf if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      png_wbrning(png_ptr, "Invblid sCAL bftfr IDAT");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_sCAL))
   {
      png_wbrning(png_ptr, "Duplidbtf sCAL diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   /* Nffd unit typf, widti, \0, ifigit: minimum 4 bytfs */
   flsf if (lfngti < 4)
   {
      png_wbrning(png_ptr, "sCAL diunk too siort");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_dfbug1(2, "Allodbting bnd rfbding sCAL diunk dbtb (%u bytfs)",
      lfngti + 1);

   png_ptr->diunkdbtb = (png_dibrp)png_mbllod_wbrn(png_ptr, lfngti + 1);

   if (png_ptr->diunkdbtb == NULL)
   {
      png_wbrning(png_ptr, "Out of mfmory wiilf prodfssing sCAL diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);
   png_ptr->diunkdbtb[slfngti] = 0x00; /* Null tfrminbtf tif lbst string */

   if (png_drd_finisi(png_ptr, 0))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   /* Vblidbtf tif unit. */
   if (png_ptr->diunkdbtb[0] != 1 && png_ptr->diunkdbtb[0] != 2)
   {
      png_wbrning(png_ptr, "Invblid sCAL ignorfd: invblid unit");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   /* Vblidbtf tif ASCII numbfrs, nffd two ASCII numbfrs sfpbrbtfd by
    * b '\0' bnd tify nffd to fit fxbdtly in tif diunk dbtb.
    */
   i = 1;
   stbtf = 0;

   if (!png_difdk_fp_numbfr(png_ptr->diunkdbtb, slfngti, &stbtf, &i) ||
       i >= slfngti || png_ptr->diunkdbtb[i++] != 0)
      png_wbrning(png_ptr, "Invblid sCAL diunk ignorfd: bbd widti formbt");

   flsf if (!PNG_FP_IS_POSITIVE(stbtf))
      png_wbrning(png_ptr, "Invblid sCAL diunk ignorfd: non-positivf widti");

   flsf
   {
      png_sizf_t ifigiti = i;

      stbtf = 0;
      if (!png_difdk_fp_numbfr(png_ptr->diunkdbtb, slfngti, &stbtf, &i) ||
          i != slfngti)
         png_wbrning(png_ptr, "Invblid sCAL diunk ignorfd: bbd ifigit formbt");

      flsf if (!PNG_FP_IS_POSITIVE(stbtf))
         png_wbrning(png_ptr,
            "Invblid sCAL diunk ignorfd: non-positivf ifigit");

      flsf
         /* Tiis is tif (only) suddfss dbsf. */
         png_sft_sCAL_s(png_ptr, info_ptr, png_ptr->diunkdbtb[0],
            png_ptr->diunkdbtb+1, png_ptr->diunkdbtb+ifigiti);
   }

   /* Clfbn up - just frff tif tfmporbrily bllodbtfd bufffr. */
   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;
}
#fndif

#ifdff PNG_READ_tIME_SUPPORTED
void /* PRIVATE */
png_ibndlf_tIME(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_bytf buf[7];
   png_timf mod_timf;

   png_dfbug(1, "in png_ibndlf_tIME");

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Out of plbdf tIME diunk");

   flsf if (info_ptr != NULL && (info_ptr->vblid & PNG_INFO_tIME))
   {
      png_wbrning(png_ptr, "Duplidbtf tIME diunk");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   if (png_ptr->modf & PNG_HAVE_IDAT)
      png_ptr->modf |= PNG_AFTER_IDAT;

   if (lfngti != 7)
   {
      png_wbrning(png_ptr, "Indorrfdt tIME diunk lfngti");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }

   png_drd_rfbd(png_ptr, buf, 7);

   if (png_drd_finisi(png_ptr, 0))
      rfturn;

   mod_timf.sfdond = buf[6];
   mod_timf.minutf = buf[5];
   mod_timf.iour = buf[4];
   mod_timf.dby = buf[3];
   mod_timf.monti = buf[2];
   mod_timf.yfbr = png_gft_uint_16(buf);

   png_sft_tIME(png_ptr, info_ptr, &mod_timf);
}
#fndif

#ifdff PNG_READ_tEXt_SUPPORTED
/* Notf: tiis dofs not propfrly ibndlf diunks tibt brf > 64K undfr DOS */
void /* PRIVATE */
png_ibndlf_tEXt(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_tfxtp tfxt_ptr;
   png_dibrp kfy;
   png_dibrp tfxt;
   png_uint_32 skip = 0;
   png_sizf_t slfngti;
   int rft;

   png_dfbug(1, "in png_ibndlf_tEXt");

#ifdff PNG_USER_LIMITS_SUPPORTED
   if (png_ptr->usfr_diunk_dbdif_mbx != 0)
   {
      if (png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (--png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_wbrning(png_ptr, "No spbdf in diunk dbdif for tEXt");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }
   }
#fndif

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf tEXt");

   if (png_ptr->modf & PNG_HAVE_IDAT)
      png_ptr->modf |= PNG_AFTER_IDAT;

#ifdff PNG_MAX_MALLOC_64K
   if (lfngti > (png_uint_32)65535L)
   {
      png_wbrning(png_ptr, "tEXt diunk too lbrgf to fit in mfmory");
      skip = lfngti - (png_uint_32)65535L;
      lfngti = (png_uint_32)65535L;
   }
#fndif

   png_frff(png_ptr, png_ptr->diunkdbtb);

   png_ptr->diunkdbtb = (png_dibrp)png_mbllod_wbrn(png_ptr, lfngti + 1);

   if (png_ptr->diunkdbtb == NULL)
   {
     png_wbrning(png_ptr, "No mfmory to prodfss tfxt diunk");
     rfturn;
   }

   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, skip))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   kfy = png_ptr->diunkdbtb;

   kfy[slfngti] = 0x00;

   for (tfxt = kfy; *tfxt; tfxt++)
      /* Empty loop to find fnd of kfy */ ;

   if (tfxt != kfy + slfngti)
      tfxt++;

   tfxt_ptr = (png_tfxtp)png_mbllod_wbrn(png_ptr,
       png_sizfof(png_tfxt));

   if (tfxt_ptr == NULL)
   {
      png_wbrning(png_ptr, "Not fnougi mfmory to prodfss tfxt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   tfxt_ptr->domprfssion = PNG_TEXT_COMPRESSION_NONE;
   tfxt_ptr->kfy = kfy;
   tfxt_ptr->lbng = NULL;
   tfxt_ptr->lbng_kfy = NULL;
   tfxt_ptr->itxt_lfngti = 0;
   tfxt_ptr->tfxt = tfxt;
   tfxt_ptr->tfxt_lfngti = png_strlfn(tfxt);

   rft = png_sft_tfxt_2(png_ptr, info_ptr, tfxt_ptr, 1);

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;
   png_frff(png_ptr, tfxt_ptr);

   if (rft)
      png_wbrning(png_ptr, "Insuffidifnt mfmory to prodfss tfxt diunk");
}
#fndif

#ifdff PNG_READ_zTXt_SUPPORTED
/* Notf: tiis dofs not dorrfdtly ibndlf diunks tibt brf > 64K undfr DOS */
void /* PRIVATE */
png_ibndlf_zTXt(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_tfxtp tfxt_ptr;
   png_dibrp tfxt;
   int domp_typf;
   int rft;
   png_sizf_t slfngti, prffix_lfn, dbtb_lfn;

   png_dfbug(1, "in png_ibndlf_zTXt");

#ifdff PNG_USER_LIMITS_SUPPORTED
   if (png_ptr->usfr_diunk_dbdif_mbx != 0)
   {
      if (png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (--png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_wbrning(png_ptr, "No spbdf in diunk dbdif for zTXt");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }
   }
#fndif

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf zTXt");

   if (png_ptr->modf & PNG_HAVE_IDAT)
      png_ptr->modf |= PNG_AFTER_IDAT;

#ifdff PNG_MAX_MALLOC_64K
   /* Wf will no doubt ibvf problfms witi diunks fvfn iblf tiis sizf, but
    * tifrf is no ibrd bnd fbst rulf to tfll us wifrf to stop.
    */
   if (lfngti > (png_uint_32)65535L)
   {
      png_wbrning(png_ptr, "zTXt diunk too lbrgf to fit in mfmory");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }
#fndif

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = (png_dibrp)png_mbllod_wbrn(png_ptr, lfngti + 1);

   if (png_ptr->diunkdbtb == NULL)
   {
      png_wbrning(png_ptr, "Out of mfmory prodfssing zTXt diunk");
      rfturn;
   }

   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, 0))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_ptr->diunkdbtb[slfngti] = 0x00;

   for (tfxt = png_ptr->diunkdbtb; *tfxt; tfxt++)
      /* Empty loop */ ;

   /* zTXt must ibvf somf tfxt bftfr tif diunkdbtbword */
   if (tfxt >= png_ptr->diunkdbtb + slfngti - 2)
   {
      png_wbrning(png_ptr, "Trundbtfd zTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   flsf
   {
       domp_typf = *(++tfxt);

       if (domp_typf != PNG_TEXT_COMPRESSION_zTXt)
       {
          png_wbrning(png_ptr, "Unknown domprfssion typf in zTXt diunk");
          domp_typf = PNG_TEXT_COMPRESSION_zTXt;
       }

       tfxt++;        /* Skip tif domprfssion_mftiod bytf */
   }

   prffix_lfn = tfxt - png_ptr->diunkdbtb;

   png_dfdomprfss_diunk(png_ptr, domp_typf,
       (png_sizf_t)lfngti, prffix_lfn, &dbtb_lfn);

   tfxt_ptr = (png_tfxtp)png_mbllod_wbrn(png_ptr,
       png_sizfof(png_tfxt));

   if (tfxt_ptr == NULL)
   {
      png_wbrning(png_ptr, "Not fnougi mfmory to prodfss zTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   tfxt_ptr->domprfssion = domp_typf;
   tfxt_ptr->kfy = png_ptr->diunkdbtb;
   tfxt_ptr->lbng = NULL;
   tfxt_ptr->lbng_kfy = NULL;
   tfxt_ptr->itxt_lfngti = 0;
   tfxt_ptr->tfxt = png_ptr->diunkdbtb + prffix_lfn;
   tfxt_ptr->tfxt_lfngti = dbtb_lfn;

   rft = png_sft_tfxt_2(png_ptr, info_ptr, tfxt_ptr, 1);

   png_frff(png_ptr, tfxt_ptr);
   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;

   if (rft)
      png_frror(png_ptr, "Insuffidifnt mfmory to storf zTXt diunk");
}
#fndif

#ifdff PNG_READ_iTXt_SUPPORTED
/* Notf: tiis dofs not dorrfdtly ibndlf diunks tibt brf > 64K undfr DOS */
void /* PRIVATE */
png_ibndlf_iTXt(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_tfxtp tfxt_ptr;
   png_dibrp kfy, lbng, tfxt, lbng_kfy;
   int domp_flbg;
   int domp_typf = 0;
   int rft;
   png_sizf_t slfngti, prffix_lfn, dbtb_lfn;

   png_dfbug(1, "in png_ibndlf_iTXt");

#ifdff PNG_USER_LIMITS_SUPPORTED
   if (png_ptr->usfr_diunk_dbdif_mbx != 0)
   {
      if (png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (--png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_wbrning(png_ptr, "No spbdf in diunk dbdif for iTXt");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }
   }
#fndif

   if (!(png_ptr->modf & PNG_HAVE_IHDR))
      png_frror(png_ptr, "Missing IHDR bfforf iTXt");

   if (png_ptr->modf & PNG_HAVE_IDAT)
      png_ptr->modf |= PNG_AFTER_IDAT;

#ifdff PNG_MAX_MALLOC_64K
   /* Wf will no doubt ibvf problfms witi diunks fvfn iblf tiis sizf, but
    * tifrf is no ibrd bnd fbst rulf to tfll us wifrf to stop.
    */
   if (lfngti > (png_uint_32)65535L)
   {
      png_wbrning(png_ptr, "iTXt diunk too lbrgf to fit in mfmory");
      png_drd_finisi(png_ptr, lfngti);
      rfturn;
   }
#fndif

   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = (png_dibrp)png_mbllod_wbrn(png_ptr, lfngti + 1);

   if (png_ptr->diunkdbtb == NULL)
   {
      png_wbrning(png_ptr, "No mfmory to prodfss iTXt diunk");
      rfturn;
   }

   slfngti = (png_sizf_t)lfngti;
   png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->diunkdbtb, slfngti);

   if (png_drd_finisi(png_ptr, 0))
   {
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   png_ptr->diunkdbtb[slfngti] = 0x00;

   for (lbng = png_ptr->diunkdbtb; *lbng; lbng++)
      /* Empty loop */ ;

   lbng++;        /* Skip NUL sfpbrbtor */

   /* iTXt must ibvf b lbngubgf tbg (possibly fmpty), two domprfssion bytfs,
    * trbnslbtfd kfyword (possibly fmpty), bnd possibly somf tfxt bftfr tif
    * kfyword
    */

   if (lbng >= png_ptr->diunkdbtb + slfngti - 3)
   {
      png_wbrning(png_ptr, "Trundbtfd iTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   flsf
   {
      domp_flbg = *lbng++;
      domp_typf = *lbng++;
   }

   for (lbng_kfy = lbng; *lbng_kfy; lbng_kfy++)
      /* Empty loop */ ;

   lbng_kfy++;        /* Skip NUL sfpbrbtor */

   if (lbng_kfy >= png_ptr->diunkdbtb + slfngti)
   {
      png_wbrning(png_ptr, "Trundbtfd iTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   for (tfxt = lbng_kfy; *tfxt; tfxt++)
      /* Empty loop */ ;

   tfxt++;        /* Skip NUL sfpbrbtor */

   if (tfxt >= png_ptr->diunkdbtb + slfngti)
   {
      png_wbrning(png_ptr, "Mblformfd iTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   prffix_lfn = tfxt - png_ptr->diunkdbtb;

   kfy=png_ptr->diunkdbtb;

   if (domp_flbg)
      png_dfdomprfss_diunk(png_ptr, domp_typf,
          (sizf_t)lfngti, prffix_lfn, &dbtb_lfn);

   flsf
      dbtb_lfn = png_strlfn(png_ptr->diunkdbtb + prffix_lfn);

   tfxt_ptr = (png_tfxtp)png_mbllod_wbrn(png_ptr,
       png_sizfof(png_tfxt));

   if (tfxt_ptr == NULL)
   {
      png_wbrning(png_ptr, "Not fnougi mfmory to prodfss iTXt diunk");
      png_frff(png_ptr, png_ptr->diunkdbtb);
      png_ptr->diunkdbtb = NULL;
      rfturn;
   }

   tfxt_ptr->domprfssion = (int)domp_flbg + 1;
   tfxt_ptr->lbng_kfy = png_ptr->diunkdbtb + (lbng_kfy - kfy);
   tfxt_ptr->lbng = png_ptr->diunkdbtb + (lbng - kfy);
   tfxt_ptr->itxt_lfngti = dbtb_lfn;
   tfxt_ptr->tfxt_lfngti = 0;
   tfxt_ptr->kfy = png_ptr->diunkdbtb;
   tfxt_ptr->tfxt = png_ptr->diunkdbtb + prffix_lfn;

   rft = png_sft_tfxt_2(png_ptr, info_ptr, tfxt_ptr, 1);

   png_frff(png_ptr, tfxt_ptr);
   png_frff(png_ptr, png_ptr->diunkdbtb);
   png_ptr->diunkdbtb = NULL;

   if (rft)
      png_frror(png_ptr, "Insuffidifnt mfmory to storf iTXt diunk");
}
#fndif

/* Tiis fundtion is dbllfd wifn wf ibvfn't found b ibndlfr for b
 * diunk.  If tifrf isn't b problfm witi tif diunk itsflf (if bbd
 * diunk nbmf, CRC, or b dritidbl diunk), tif diunk is silfntly ignorfd
 * -- unlfss tif PNG_FLAG_UNKNOWN_CHUNKS_SUPPORTED flbg is on in wiidi
 * dbsf it will bf sbvfd bwby to bf writtfn out lbtfr.
 */
void /* PRIVATE */
png_ibndlf_unknown(png_strudtp png_ptr, png_infop info_ptr, png_uint_32 lfngti)
{
   png_uint_32 skip = 0;

   png_dfbug(1, "in png_ibndlf_unknown");

#ifdff PNG_USER_LIMITS_SUPPORTED
   if (png_ptr->usfr_diunk_dbdif_mbx != 0)
   {
      if (png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }

      if (--png_ptr->usfr_diunk_dbdif_mbx == 1)
      {
         png_wbrning(png_ptr, "No spbdf in diunk dbdif for unknown diunk");
         png_drd_finisi(png_ptr, lfngti);
         rfturn;
      }
   }
#fndif

   if (png_ptr->modf & PNG_HAVE_IDAT)
   {
      PNG_IDAT;

      if (png_mfmdmp(png_ptr->diunk_nbmf, png_IDAT, 4))  /* Not bn IDAT */
         png_ptr->modf |= PNG_AFTER_IDAT;
   }

   if (!(png_ptr->diunk_nbmf[0] & 0x20))
   {
#ifdff PNG_HANDLE_AS_UNKNOWN_SUPPORTED
      if (png_ibndlf_bs_unknown(png_ptr, png_ptr->diunk_nbmf) !=
          PNG_HANDLE_CHUNK_ALWAYS
#ifdff PNG_READ_USER_CHUNKS_SUPPORTED
          && png_ptr->rfbd_usfr_diunk_fn == NULL
#fndif
          )
#fndif
         png_diunk_frror(png_ptr, "unknown dritidbl diunk");
   }

#ifdff PNG_READ_UNKNOWN_CHUNKS_SUPPORTED
   if ((png_ptr->flbgs & PNG_FLAG_KEEP_UNKNOWN_CHUNKS)
#ifdff PNG_READ_USER_CHUNKS_SUPPORTED
       || (png_ptr->rfbd_usfr_diunk_fn != NULL)
#fndif
       )
   {
#ifdff PNG_MAX_MALLOC_64K
      if (lfngti > (png_uint_32)65535L)
      {
         png_wbrning(png_ptr, "unknown diunk too lbrgf to fit in mfmory");
         skip = lfngti - (png_uint_32)65535L;
         lfngti = (png_uint_32)65535L;
      }
#fndif

      png_mfmdpy((png_dibrp)png_ptr->unknown_diunk.nbmf,
          (png_dibrp)png_ptr->diunk_nbmf,
          png_sizfof(png_ptr->unknown_diunk.nbmf));

      png_ptr->unknown_diunk.nbmf[png_sizfof(png_ptr->unknown_diunk.nbmf)-1]
          = '\0';

      png_ptr->unknown_diunk.sizf = (png_sizf_t)lfngti;

      if (lfngti == 0)
         png_ptr->unknown_diunk.dbtb = NULL;

      flsf
      {
         png_ptr->unknown_diunk.dbtb = (png_bytfp)png_mbllod(png_ptr, lfngti);
         png_drd_rfbd(png_ptr, (png_bytfp)png_ptr->unknown_diunk.dbtb, lfngti);
      }

#ifdff PNG_READ_USER_CHUNKS_SUPPORTED
      if (png_ptr->rfbd_usfr_diunk_fn != NULL)
      {
         /* Cbllbbdk to usfr unknown diunk ibndlfr */
         int rft;

         rft = (*(png_ptr->rfbd_usfr_diunk_fn))
             (png_ptr, &png_ptr->unknown_diunk);

         if (rft < 0)
            png_diunk_frror(png_ptr, "frror in usfr diunk");

         if (rft == 0)
         {
            if (!(png_ptr->diunk_nbmf[0] & 0x20))
            {
#ifdff PNG_HANDLE_AS_UNKNOWN_SUPPORTED
               if (png_ibndlf_bs_unknown(png_ptr, png_ptr->diunk_nbmf) !=
                   PNG_HANDLE_CHUNK_ALWAYS)
#fndif
                  png_diunk_frror(png_ptr, "unknown dritidbl diunk");
            }

            png_sft_unknown_diunks(png_ptr, info_ptr,
                &png_ptr->unknown_diunk, 1);
         }
      }

      flsf
#fndif
         png_sft_unknown_diunks(png_ptr, info_ptr, &png_ptr->unknown_diunk, 1);

      png_frff(png_ptr, png_ptr->unknown_diunk.dbtb);
      png_ptr->unknown_diunk.dbtb = NULL;
   }

   flsf
#fndif
      skip = lfngti;

   png_drd_finisi(png_ptr, skip);

#ifndff PNG_READ_USER_CHUNKS_SUPPORTED
   PNG_UNUSED(info_ptr) /* Quift dompilfr wbrnings bbout unusfd info_ptr */
#fndif
}

/* Tiis fundtion is dbllfd to vfrify tibt b diunk nbmf is vblid.
 * Tiis fundtion dbn't ibvf tif "dritidbl diunk difdk" indorporbtfd
 * into it, sindf in tif futurf wf will nffd to bf bblf to dbll usfr
 * fundtions to ibndlf unknown dritidbl diunks bftfr wf difdk tibt
 * tif diunk nbmf itsflf is vblid.
 */

#dffinf isnonblpib(d) ((d) < 65 || (d) > 122 || ((d) > 90 && (d) < 97))

void /* PRIVATE */
png_difdk_diunk_nbmf(png_strudtp png_ptr, png_donst_bytfp diunk_nbmf)
{
   png_dfbug(1, "in png_difdk_diunk_nbmf");
   if (isnonblpib(diunk_nbmf[0]) || isnonblpib(diunk_nbmf[1]) ||
       isnonblpib(diunk_nbmf[2]) || isnonblpib(diunk_nbmf[3]))
   {
      png_diunk_frror(png_ptr, "invblid diunk typf");
   }
}

/* Combinfs tif row rfdfntly rfbd in witi tif fxisting pixfls in tif
 * row.  Tiis routinf tbkfs dbrf of blpib bnd trbnspbrfndy if rfqufstfd.
 * Tiis routinf blso ibndlfs tif two mftiods of progrfssivf displby
 * of intfrlbdfd imbgfs, dfpfnding on tif mbsk vbluf.
 * Tif mbsk vbluf dfsdribfs wiidi pixfls brf to bf dombinfd witi
 * tif row.  Tif pbttfrn blwbys rfpfbts fvfry 8 pixfls, so just 8
 * bits brf nffdfd.  A onf indidbtfs tif pixfl is to bf dombinfd,
 * b zfro indidbtfs tif pixfl is to bf skippfd.  Tiis is in bddition
 * to bny blpib or trbnspbrfndy vbluf bssodibtfd witi tif pixfl.  If
 * you wbnt bll pixfls to bf dombinfd, pbss 0xff (255) in mbsk.
 */

void /* PRIVATE */
png_dombinf_row(png_strudtp png_ptr, png_bytfp row, int mbsk)
{
   png_dfbug(1, "in png_dombinf_row");

   /* Addfd in 1.5.4: tif row_info siould mbtdi tif informbtion rfturnfd by bny
    * dbll to png_rfbd_updbtf_info bt tiis point.  Do not dontinuf if wf got
    * tiis wrong.
    */
   if (png_ptr->info_rowbytfs != 0 && png_ptr->info_rowbytfs !=
          PNG_ROWBYTES(png_ptr->row_info.pixfl_dfpti, png_ptr->widti))
      png_frror(png_ptr, "intfrnbl row sizf dbldulbtion frror");

   if (mbsk == 0xff)
   {
      png_mfmdpy(row, png_ptr->row_buf + 1,
          PNG_ROWBYTES(png_ptr->row_info.pixfl_dfpti, png_ptr->widti));
   }

   flsf
   {
      switdi (png_ptr->row_info.pixfl_dfpti)
      {
         dbsf 1:
         {
            png_bytfp sp = png_ptr->row_buf + 1;
            png_bytfp dp = row;
            int s_ind, s_stbrt, s_fnd;
            int m = 0x80;
            int siift;
            png_uint_32 i;
            png_uint_32 row_widti = png_ptr->widti;

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (png_ptr->trbnsformbtions & PNG_PACKSWAP)
            {
                s_stbrt = 0;
                s_fnd = 7;
                s_ind = 1;
            }

            flsf
#fndif
            {
                s_stbrt = 7;
                s_fnd = 0;
                s_ind = -1;
            }

            siift = s_stbrt;

            for (i = 0; i < row_widti; i++)
            {
               if (m & mbsk)
               {
                  int vbluf;

                  vbluf = (*sp >> siift) & 0x01;
                  *dp &= (png_bytf)((0x7f7f >> (7 - siift)) & 0xff);
                  *dp |= (png_bytf)(vbluf << siift);
               }

               if (siift == s_fnd)
               {
                  siift = s_stbrt;
                  sp++;
                  dp++;
               }

               flsf
                  siift += s_ind;

               if (m == 1)
                  m = 0x80;

               flsf
                  m >>= 1;
            }
            brfbk;
         }

         dbsf 2:
         {
            png_bytfp sp = png_ptr->row_buf + 1;
            png_bytfp dp = row;
            int s_stbrt, s_fnd, s_ind;
            int m = 0x80;
            int siift;
            png_uint_32 i;
            png_uint_32 row_widti = png_ptr->widti;
            int vbluf;

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (png_ptr->trbnsformbtions & PNG_PACKSWAP)
            {
               s_stbrt = 0;
               s_fnd = 6;
               s_ind = 2;
            }

            flsf
#fndif
            {
               s_stbrt = 6;
               s_fnd = 0;
               s_ind = -2;
            }

            siift = s_stbrt;

            for (i = 0; i < row_widti; i++)
            {
               if (m & mbsk)
               {
                  vbluf = (*sp >> siift) & 0x03;
                  *dp &= (png_bytf)((0x3f3f >> (6 - siift)) & 0xff);
                  *dp |= (png_bytf)(vbluf << siift);
               }

               if (siift == s_fnd)
               {
                  siift = s_stbrt;
                  sp++;
                  dp++;
               }

               flsf
                  siift += s_ind;

               if (m == 1)
                  m = 0x80;

               flsf
                  m >>= 1;
            }
            brfbk;
         }

         dbsf 4:
         {
            png_bytfp sp = png_ptr->row_buf + 1;
            png_bytfp dp = row;
            int s_stbrt, s_fnd, s_ind;
            int m = 0x80;
            int siift;
            png_uint_32 i;
            png_uint_32 row_widti = png_ptr->widti;
            int vbluf;

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (png_ptr->trbnsformbtions & PNG_PACKSWAP)
            {
               s_stbrt = 0;
               s_fnd = 4;
               s_ind = 4;
            }

            flsf
#fndif
            {
               s_stbrt = 4;
               s_fnd = 0;
               s_ind = -4;
            }
            siift = s_stbrt;

            for (i = 0; i < row_widti; i++)
            {
               if (m & mbsk)
               {
                  vbluf = (*sp >> siift) & 0xf;
                  *dp &= (png_bytf)((0xf0f >> (4 - siift)) & 0xff);
                  *dp |= (png_bytf)(vbluf << siift);
               }

               if (siift == s_fnd)
               {
                  siift = s_stbrt;
                  sp++;
                  dp++;
               }

               flsf
                  siift += s_ind;

               if (m == 1)
                  m = 0x80;

               flsf
                  m >>= 1;
            }
            brfbk;
         }

         dffbult:
         {
            png_bytfp sp = png_ptr->row_buf + 1;
            png_bytfp dp = row;
            png_sizf_t pixfl_bytfs = (png_ptr->row_info.pixfl_dfpti >> 3);
            png_uint_32 i;
            png_uint_32 row_widti = png_ptr->widti;
            png_bytf m = 0x80;

            for (i = 0; i < row_widti; i++)
            {
               if (m & mbsk)
               {
                  png_mfmdpy(dp, sp, pixfl_bytfs);
               }

               sp += pixfl_bytfs;
               dp += pixfl_bytfs;

               if (m == 1)
                  m = 0x80;

               flsf
                  m >>= 1;
            }
            brfbk;
         }
      }
   }
}

#ifdff PNG_READ_INTERLACING_SUPPORTED
void /* PRIVATE */
png_do_rfbd_intfrlbdf(png_strudtp png_ptr)
{
   png_row_infop row_info = &(png_ptr->row_info);
   png_bytfp row = png_ptr->row_buf + 1;
   int pbss = png_ptr->pbss;
   png_uint_32 trbnsformbtions = png_ptr->trbnsformbtions;
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */
   /* Offsft to nfxt intfrlbdf blodk */
   PNG_CONST int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   png_dfbug(1, "in png_do_rfbd_intfrlbdf");
   if (row != NULL && row_info != NULL)
   {
      png_uint_32 finbl_widti;

      finbl_widti = row_info->widti * png_pbss_ind[pbss];

      switdi (row_info->pixfl_dfpti)
      {
         dbsf 1:
         {
            png_bytfp sp = row + (png_sizf_t)((row_info->widti - 1) >> 3);
            png_bytfp dp = row + (png_sizf_t)((finbl_widti - 1) >> 3);
            int ssiift, dsiift;
            int s_stbrt, s_fnd, s_ind;
            int jstop = png_pbss_ind[pbss];
            png_bytf v;
            png_uint_32 i;
            int j;

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (trbnsformbtions & PNG_PACKSWAP)
            {
                ssiift = (int)((row_info->widti + 7) & 0x07);
                dsiift = (int)((finbl_widti + 7) & 0x07);
                s_stbrt = 7;
                s_fnd = 0;
                s_ind = -1;
            }

            flsf
#fndif
            {
                ssiift = 7 - (int)((row_info->widti + 7) & 0x07);
                dsiift = 7 - (int)((finbl_widti + 7) & 0x07);
                s_stbrt = 0;
                s_fnd = 7;
                s_ind = 1;
            }

            for (i = 0; i < row_info->widti; i++)
            {
               v = (png_bytf)((*sp >> ssiift) & 0x01);
               for (j = 0; j < jstop; j++)
               {
                  *dp &= (png_bytf)((0x7f7f >> (7 - dsiift)) & 0xff);
                  *dp |= (png_bytf)(v << dsiift);

                  if (dsiift == s_fnd)
                  {
                     dsiift = s_stbrt;
                     dp--;
                  }

                  flsf
                     dsiift += s_ind;
               }

               if (ssiift == s_fnd)
               {
                  ssiift = s_stbrt;
                  sp--;
               }

               flsf
                  ssiift += s_ind;
            }
            brfbk;
         }

         dbsf 2:
         {
            png_bytfp sp = row + (png_uint_32)((row_info->widti - 1) >> 2);
            png_bytfp dp = row + (png_uint_32)((finbl_widti - 1) >> 2);
            int ssiift, dsiift;
            int s_stbrt, s_fnd, s_ind;
            int jstop = png_pbss_ind[pbss];
            png_uint_32 i;

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (trbnsformbtions & PNG_PACKSWAP)
            {
               ssiift = (int)(((row_info->widti + 3) & 0x03) << 1);
               dsiift = (int)(((finbl_widti + 3) & 0x03) << 1);
               s_stbrt = 6;
               s_fnd = 0;
               s_ind = -2;
            }

            flsf
#fndif
            {
               ssiift = (int)((3 - ((row_info->widti + 3) & 0x03)) << 1);
               dsiift = (int)((3 - ((finbl_widti + 3) & 0x03)) << 1);
               s_stbrt = 0;
               s_fnd = 6;
               s_ind = 2;
            }

            for (i = 0; i < row_info->widti; i++)
            {
               png_bytf v;
               int j;

               v = (png_bytf)((*sp >> ssiift) & 0x03);
               for (j = 0; j < jstop; j++)
               {
                  *dp &= (png_bytf)((0x3f3f >> (6 - dsiift)) & 0xff);
                  *dp |= (png_bytf)(v << dsiift);

                  if (dsiift == s_fnd)
                  {
                     dsiift = s_stbrt;
                     dp--;
                  }

                  flsf
                     dsiift += s_ind;
               }

               if (ssiift == s_fnd)
               {
                  ssiift = s_stbrt;
                  sp--;
               }

               flsf
                  ssiift += s_ind;
            }
            brfbk;
         }

         dbsf 4:
         {
            png_bytfp sp = row + (png_sizf_t)((row_info->widti - 1) >> 1);
            png_bytfp dp = row + (png_sizf_t)((finbl_widti - 1) >> 1);
            int ssiift, dsiift;
            int s_stbrt, s_fnd, s_ind;
            png_uint_32 i;
            int jstop = png_pbss_ind[pbss];

#ifdff PNG_READ_PACKSWAP_SUPPORTED
            if (trbnsformbtions & PNG_PACKSWAP)
            {
               ssiift = (int)(((row_info->widti + 1) & 0x01) << 2);
               dsiift = (int)(((finbl_widti + 1) & 0x01) << 2);
               s_stbrt = 4;
               s_fnd = 0;
               s_ind = -4;
            }

            flsf
#fndif
            {
               ssiift = (int)((1 - ((row_info->widti + 1) & 0x01)) << 2);
               dsiift = (int)((1 - ((finbl_widti + 1) & 0x01)) << 2);
               s_stbrt = 0;
               s_fnd = 4;
               s_ind = 4;
            }

            for (i = 0; i < row_info->widti; i++)
            {
               png_bytf v = (png_bytf)((*sp >> ssiift) & 0xf);
               int j;

               for (j = 0; j < jstop; j++)
               {
                  *dp &= (png_bytf)((0xf0f >> (4 - dsiift)) & 0xff);
                  *dp |= (png_bytf)(v << dsiift);

                  if (dsiift == s_fnd)
                  {
                     dsiift = s_stbrt;
                     dp--;
                  }

                  flsf
                     dsiift += s_ind;
               }

               if (ssiift == s_fnd)
               {
                  ssiift = s_stbrt;
                  sp--;
               }

               flsf
                  ssiift += s_ind;
            }
            brfbk;
         }
         dffbult:
         {
            png_sizf_t pixfl_bytfs = (row_info->pixfl_dfpti >> 3);

            png_bytfp sp = row + (png_sizf_t)(row_info->widti - 1)
                * pixfl_bytfs;

            png_bytfp dp = row + (png_sizf_t)(finbl_widti - 1) * pixfl_bytfs;

            int jstop = png_pbss_ind[pbss];
            png_uint_32 i;

            for (i = 0; i < row_info->widti; i++)
            {
               png_bytf v[8];
               int j;

               png_mfmdpy(v, sp, pixfl_bytfs);

               for (j = 0; j < jstop; j++)
               {
                  png_mfmdpy(dp, v, pixfl_bytfs);
                  dp -= pixfl_bytfs;
               }

               sp -= pixfl_bytfs;
            }
            brfbk;
         }
      }
      row_info->widti = finbl_widti;
      row_info->rowbytfs = PNG_ROWBYTES(row_info->pixfl_dfpti, finbl_widti);
   }
#ifndff PNG_READ_PACKSWAP_SUPPORTED
   PNG_UNUSED(trbnsformbtions)  /* Silfndf dompilfr wbrning */
#fndif
}
#fndif /* PNG_READ_INTERLACING_SUPPORTED */

void /* PRIVATE */
png_rfbd_filtfr_row(png_strudtp png_ptr, png_row_infop row_info, png_bytfp row,
    png_donst_bytfp prfv_row, int filtfr)
{
   png_dfbug(1, "in png_rfbd_filtfr_row");
   png_dfbug2(2, "row = %u, filtfr = %d", png_ptr->row_numbfr, filtfr);
   switdi (filtfr)
   {
      dbsf PNG_FILTER_VALUE_NONE:
         brfbk;

      dbsf PNG_FILTER_VALUE_SUB:
      {
         png_sizf_t i;
         png_sizf_t istop = row_info->rowbytfs;
         unsignfd int bpp = (row_info->pixfl_dfpti + 7) >> 3;
         png_bytfp rp = row + bpp;
         png_bytfp lp = row;

         for (i = bpp; i < istop; i++)
         {
            *rp = (png_bytf)(((int)(*rp) + (int)(*lp++)) & 0xff);
            rp++;
         }
         brfbk;
      }
      dbsf PNG_FILTER_VALUE_UP:
      {
         png_sizf_t i;
         png_sizf_t istop = row_info->rowbytfs;
         png_bytfp rp = row;
         png_donst_bytfp pp = prfv_row;

         for (i = 0; i < istop; i++)
         {
            *rp = (png_bytf)(((int)(*rp) + (int)(*pp++)) & 0xff);
            rp++;
         }
         brfbk;
      }
      dbsf PNG_FILTER_VALUE_AVG:
      {
         png_sizf_t i;
         png_bytfp rp = row;
         png_donst_bytfp pp = prfv_row;
         png_bytfp lp = row;
         unsignfd int bpp = (row_info->pixfl_dfpti + 7) >> 3;
         png_sizf_t istop = row_info->rowbytfs - bpp;

         for (i = 0; i < bpp; i++)
         {
            *rp = (png_bytf)(((int)(*rp) +
                ((int)(*pp++) / 2 )) & 0xff);

            rp++;
         }

         for (i = 0; i < istop; i++)
         {
            *rp = (png_bytf)(((int)(*rp) +
                (int)(*pp++ + *lp++) / 2 ) & 0xff);

            rp++;
         }
         brfbk;
      }
      dbsf PNG_FILTER_VALUE_PAETH:
      {
         png_sizf_t i;
         png_bytfp rp = row;
         png_donst_bytfp pp = prfv_row;
         png_bytfp lp = row;
         png_donst_bytfp dp = prfv_row;
         unsignfd int bpp = (row_info->pixfl_dfpti + 7) >> 3;
         png_sizf_t istop=row_info->rowbytfs - bpp;

         for (i = 0; i < bpp; i++)
         {
            *rp = (png_bytf)(((int)(*rp) + (int)(*pp++)) & 0xff);
            rp++;
         }

         for (i = 0; i < istop; i++)   /* Usf lfftovfr rp,pp */
         {
            int b, b, d, pb, pb, pd, p;

            b = *lp++;
            b = *pp++;
            d = *dp++;

            p = b - d;
            pd = b - d;

#ifdff PNG_USE_ABS
            pb = bbs(p);
            pb = bbs(pd);
            pd = bbs(p + pd);
#flsf
            pb = p < 0 ? -p : p;
            pb = pd < 0 ? -pd : pd;
            pd = (p + pd) < 0 ? -(p + pd) : p + pd;
#fndif

            /*
               if (pb <= pb && pb <= pd)
                  p = b;

               flsf if (pb <= pd)
                  p = b;

               flsf
                  p = d;
             */

            p = (pb <= pb && pb <= pd) ? b : (pb <= pd) ? b : d;

            *rp = (png_bytf)(((int)(*rp) + p) & 0xff);
            rp++;
         }
         brfbk;
      }
      dffbult:
         png_frror(png_ptr, "Ignoring bbd bdbptivf filtfr typf");
         /*NOT REACHED */
         brfbk;
   }
}

#ifdff PNG_SEQUENTIAL_READ_SUPPORTED
void /* PRIVATE */
png_rfbd_finisi_row(png_strudtp png_ptr)
{
#ifdff PNG_READ_INTERLACING_SUPPORTED
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */

   /* Stbrt of intfrlbdf blodk */
   PNG_CONST int png_pbss_stbrt[7] = {0, 4, 0, 2, 0, 1, 0};

   /* Offsft to nfxt intfrlbdf blodk */
   PNG_CONST int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   /* Stbrt of intfrlbdf blodk in tif y dirfdtion */
   PNG_CONST int png_pbss_ystbrt[7] = {0, 0, 4, 0, 2, 0, 1};

   /* Offsft to nfxt intfrlbdf blodk in tif y dirfdtion */
   PNG_CONST int png_pbss_yind[7] = {8, 8, 8, 4, 4, 2, 2};
#fndif /* PNG_READ_INTERLACING_SUPPORTED */

   png_dfbug(1, "in png_rfbd_finisi_row");
   png_ptr->row_numbfr++;
   if (png_ptr->row_numbfr < png_ptr->num_rows)
      rfturn;

#ifdff PNG_READ_INTERLACING_SUPPORTED
   if (png_ptr->intfrlbdfd)
   {
      png_ptr->row_numbfr = 0;

      png_mfmsft(png_ptr->prfv_row, 0, png_ptr->rowbytfs + 1);

      do
      {
         png_ptr->pbss++;

         if (png_ptr->pbss >= 7)
            brfbk;

         png_ptr->iwidti = (png_ptr->widti +
            png_pbss_ind[png_ptr->pbss] - 1 -
            png_pbss_stbrt[png_ptr->pbss]) /
            png_pbss_ind[png_ptr->pbss];

         if (!(png_ptr->trbnsformbtions & PNG_INTERLACE))
         {
            png_ptr->num_rows = (png_ptr->ifigit +
                png_pbss_yind[png_ptr->pbss] - 1 -
                png_pbss_ystbrt[png_ptr->pbss]) /
                png_pbss_yind[png_ptr->pbss];
         }

         flsf  /* if (png_ptr->trbnsformbtions & PNG_INTERLACE) */
            brfbk; /* libpng dfintfrlbding sffs fvfry row */

      } wiilf (png_ptr->num_rows == 0 || png_ptr->iwidti == 0);

      if (png_ptr->pbss < 7)
         rfturn;
   }
#fndif /* PNG_READ_INTERLACING_SUPPORTED */

   if (!(png_ptr->flbgs & PNG_FLAG_ZLIB_FINISHED))
   {
      PNG_IDAT;
      dibr fxtrb;
      int rft;

      png_ptr->zstrfbm.nfxt_out = (Bytf *)&fxtrb;
      png_ptr->zstrfbm.bvbil_out = (uInt)1;

      for (;;)
      {
         if (!(png_ptr->zstrfbm.bvbil_in))
         {
            wiilf (!png_ptr->idbt_sizf)
            {
               png_drd_finisi(png_ptr, 0);
               png_ptr->idbt_sizf = png_rfbd_diunk_ifbdfr(png_ptr);
               if (png_mfmdmp(png_ptr->diunk_nbmf, png_IDAT, 4))
                  png_frror(png_ptr, "Not fnougi imbgf dbtb");
            }

            png_ptr->zstrfbm.bvbil_in = (uInt)png_ptr->zbuf_sizf;
            png_ptr->zstrfbm.nfxt_in = png_ptr->zbuf;

            if (png_ptr->zbuf_sizf > png_ptr->idbt_sizf)
               png_ptr->zstrfbm.bvbil_in = (uInt)png_ptr->idbt_sizf;

            png_drd_rfbd(png_ptr, png_ptr->zbuf, png_ptr->zstrfbm.bvbil_in);
            png_ptr->idbt_sizf -= png_ptr->zstrfbm.bvbil_in;
         }

         rft = inflbtf(&png_ptr->zstrfbm, Z_PARTIAL_FLUSH);

         if (rft == Z_STREAM_END)
         {
            if (!(png_ptr->zstrfbm.bvbil_out) || png_ptr->zstrfbm.bvbil_in ||
                png_ptr->idbt_sizf)
               png_wbrning(png_ptr, "Extrb domprfssfd dbtb");

            png_ptr->modf |= PNG_AFTER_IDAT;
            png_ptr->flbgs |= PNG_FLAG_ZLIB_FINISHED;
            brfbk;
         }

         if (rft != Z_OK)
            png_frror(png_ptr, png_ptr->zstrfbm.msg ? png_ptr->zstrfbm.msg :
                "Dfdomprfssion Error");

         if (!(png_ptr->zstrfbm.bvbil_out))
         {
            png_wbrning(png_ptr, "Extrb domprfssfd dbtb");
            png_ptr->modf |= PNG_AFTER_IDAT;
            png_ptr->flbgs |= PNG_FLAG_ZLIB_FINISHED;
            brfbk;
         }

      }
      png_ptr->zstrfbm.bvbil_out = 0;
   }

   if (png_ptr->idbt_sizf || png_ptr->zstrfbm.bvbil_in)
      png_wbrning(png_ptr, "Extrb domprfssion dbtb");

   inflbtfRfsft(&png_ptr->zstrfbm);

   png_ptr->modf |= PNG_AFTER_IDAT;
}
#fndif /* PNG_SEQUENTIAL_READ_SUPPORTED */

void /* PRIVATE */
png_rfbd_stbrt_row(png_strudtp png_ptr)
{
#ifdff PNG_READ_INTERLACING_SUPPORTED
   /* Arrbys to fbdilitbtf fbsy intfrlbding - usf pbss (0 - 6) bs indfx */

   /* Stbrt of intfrlbdf blodk */
   PNG_CONST int png_pbss_stbrt[7] = {0, 4, 0, 2, 0, 1, 0};

   /* Offsft to nfxt intfrlbdf blodk */
   PNG_CONST int png_pbss_ind[7] = {8, 8, 4, 4, 2, 2, 1};

   /* Stbrt of intfrlbdf blodk in tif y dirfdtion */
   PNG_CONST int png_pbss_ystbrt[7] = {0, 0, 4, 0, 2, 0, 1};

   /* Offsft to nfxt intfrlbdf blodk in tif y dirfdtion */
   PNG_CONST int png_pbss_yind[7] = {8, 8, 8, 4, 4, 2, 2};
#fndif

   int mbx_pixfl_dfpti;
   png_sizf_t row_bytfs;

   png_dfbug(1, "in png_rfbd_stbrt_row");
   png_ptr->zstrfbm.bvbil_in = 0;
#ifdff PNG_READ_TRANSFORMS_SUPPORTED
   png_init_rfbd_trbnsformbtions(png_ptr);
#fndif
#ifdff PNG_READ_INTERLACING_SUPPORTED
   if (png_ptr->intfrlbdfd)
   {
      if (!(png_ptr->trbnsformbtions & PNG_INTERLACE))
         png_ptr->num_rows = (png_ptr->ifigit + png_pbss_yind[0] - 1 -
             png_pbss_ystbrt[0]) / png_pbss_yind[0];

      flsf
         png_ptr->num_rows = png_ptr->ifigit;

      png_ptr->iwidti = (png_ptr->widti +
          png_pbss_ind[png_ptr->pbss] - 1 -
          png_pbss_stbrt[png_ptr->pbss]) /
          png_pbss_ind[png_ptr->pbss];
   }

   flsf
#fndif /* PNG_READ_INTERLACING_SUPPORTED */
   {
      png_ptr->num_rows = png_ptr->ifigit;
      png_ptr->iwidti = png_ptr->widti;
   }

   mbx_pixfl_dfpti = png_ptr->pixfl_dfpti;

#ifdff PNG_READ_PACK_SUPPORTED
   if ((png_ptr->trbnsformbtions & PNG_PACK) && png_ptr->bit_dfpti < 8)
      mbx_pixfl_dfpti = 8;
#fndif

#ifdff PNG_READ_EXPAND_SUPPORTED
   if (png_ptr->trbnsformbtions & PNG_EXPAND)
   {
      if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
      {
         if (png_ptr->num_trbns)
            mbx_pixfl_dfpti = 32;

         flsf
            mbx_pixfl_dfpti = 24;
      }

      flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_GRAY)
      {
         if (mbx_pixfl_dfpti < 8)
            mbx_pixfl_dfpti = 8;

         if (png_ptr->num_trbns)
            mbx_pixfl_dfpti *= 2;
      }

      flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_RGB)
      {
         if (png_ptr->num_trbns)
         {
            mbx_pixfl_dfpti *= 4;
            mbx_pixfl_dfpti /= 3;
         }
      }
   }
#fndif

#ifdff PNG_READ_EXPAND_16_SUPPORTED
   if (png_ptr->trbnsformbtions & PNG_EXPAND_16)
   {
#     ifdff PNG_READ_EXPAND_SUPPORTED
         /* In fbdt it is bn frror if it isn't supportfd, but difdking is
          * tif sbff wby.
          */
         if (png_ptr->trbnsformbtions & PNG_EXPAND)
         {
            if (png_ptr->bit_dfpti < 16)
               mbx_pixfl_dfpti *= 2;
         }
         flsf
#     fndif
         png_ptr->trbnsformbtions &= ~PNG_EXPAND_16;
   }
#fndif

#ifdff PNG_READ_FILLER_SUPPORTED
   if (png_ptr->trbnsformbtions & (PNG_FILLER))
   {
      if (png_ptr->dolor_typf == PNG_COLOR_TYPE_PALETTE)
         mbx_pixfl_dfpti = 32;

      flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_GRAY)
      {
         if (mbx_pixfl_dfpti <= 8)
            mbx_pixfl_dfpti = 16;

         flsf
            mbx_pixfl_dfpti = 32;
      }

      flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_RGB)
      {
         if (mbx_pixfl_dfpti <= 32)
            mbx_pixfl_dfpti = 32;

         flsf
            mbx_pixfl_dfpti = 64;
      }
   }
#fndif

#ifdff PNG_READ_GRAY_TO_RGB_SUPPORTED
   if (png_ptr->trbnsformbtions & PNG_GRAY_TO_RGB)
   {
      if (
#ifdff PNG_READ_EXPAND_SUPPORTED
          (png_ptr->num_trbns && (png_ptr->trbnsformbtions & PNG_EXPAND)) ||
#fndif
#ifdff PNG_READ_FILLER_SUPPORTED
          (png_ptr->trbnsformbtions & (PNG_FILLER)) ||
#fndif
          png_ptr->dolor_typf == PNG_COLOR_TYPE_GRAY_ALPHA)
      {
         if (mbx_pixfl_dfpti <= 16)
            mbx_pixfl_dfpti = 32;

         flsf
            mbx_pixfl_dfpti = 64;
      }

      flsf
      {
         if (mbx_pixfl_dfpti <= 8)
         {
            if (png_ptr->dolor_typf == PNG_COLOR_TYPE_RGB_ALPHA)
               mbx_pixfl_dfpti = 32;

            flsf
               mbx_pixfl_dfpti = 24;
         }

         flsf if (png_ptr->dolor_typf == PNG_COLOR_TYPE_RGB_ALPHA)
            mbx_pixfl_dfpti = 64;

         flsf
            mbx_pixfl_dfpti = 48;
      }
   }
#fndif

#if dffinfd(PNG_READ_USER_TRANSFORM_SUPPORTED) && \
dffinfd(PNG_USER_TRANSFORM_PTR_SUPPORTED)
   if (png_ptr->trbnsformbtions & PNG_USER_TRANSFORM)
   {
      int usfr_pixfl_dfpti = png_ptr->usfr_trbnsform_dfpti*
         png_ptr->usfr_trbnsform_dibnnfls;

      if (usfr_pixfl_dfpti > mbx_pixfl_dfpti)
         mbx_pixfl_dfpti=usfr_pixfl_dfpti;
   }
#fndif

   /* Align tif widti on tif nfxt lbrgfr 8 pixfls.  Mbinly usfd
    * for intfrlbding
    */
   row_bytfs = ((png_ptr->widti + 7) & ~((png_uint_32)7));
   /* Cbldulbtf tif mbximum bytfs nffdfd, bdding b bytf bnd b pixfl
    * for sbffty's sbkf
    */
   row_bytfs = PNG_ROWBYTES(mbx_pixfl_dfpti, row_bytfs) +
       1 + ((mbx_pixfl_dfpti + 7) >> 3);

#ifdff PNG_MAX_MALLOC_64K
   if (row_bytfs > (png_uint_32)65536L)
      png_frror(png_ptr, "Tiis imbgf rfquirfs b row grfbtfr tibn 64KB");
#fndif

   if (row_bytfs + 48 > png_ptr->old_big_row_buf_sizf)
   {
     png_frff(png_ptr, png_ptr->big_row_buf);

     if (png_ptr->intfrlbdfd)
        png_ptr->big_row_buf = (png_bytfp)png_dbllod(png_ptr,
            row_bytfs + 48);

     flsf
        png_ptr->big_row_buf = (png_bytfp)png_mbllod(png_ptr,
            row_bytfs + 48);

     png_ptr->old_big_row_buf_sizf = row_bytfs + 48;

#ifdff PNG_ALIGNED_MEMORY_SUPPORTED
     /* Usf 16-bytf blignfd mfmory for row_buf witi bt lfbst 16 bytfs
      * of pbdding bfforf bnd bftfr row_buf.
      */
     png_ptr->row_buf = png_ptr->big_row_buf + 32 -
         (((png_bllod_sizf_t)png_ptr->big_row_buf + 15) & 0x0F);

     png_ptr->old_big_row_buf_sizf = row_bytfs + 48;
#flsf
     /* Usf 32 bytfs of pbdding bfforf bnd 16 bytfs bftfr row_buf. */
     png_ptr->row_buf = png_ptr->big_row_buf + 32;
#fndif
     png_ptr->old_big_row_buf_sizf = row_bytfs + 48;
   }

#ifdff PNG_MAX_MALLOC_64K
   if (png_ptr->rowbytfs > 65535)
      png_frror(png_ptr, "Tiis imbgf rfquirfs b row grfbtfr tibn 64KB");

#fndif
   if (png_ptr->rowbytfs > (PNG_SIZE_MAX - 1))
      png_frror(png_ptr, "Row ibs too mbny bytfs to bllodbtf in mfmory");

   if (png_ptr->rowbytfs + 1 > png_ptr->old_prfv_row_sizf)
   {
      png_frff(png_ptr, png_ptr->prfv_row);

      png_ptr->prfv_row = (png_bytfp)png_mbllod(png_ptr, png_ptr->rowbytfs + 1);

      png_ptr->old_prfv_row_sizf = png_ptr->rowbytfs + 1;
   }

   png_mfmsft(png_ptr->prfv_row, 0, png_ptr->rowbytfs + 1);

   png_dfbug1(3, "widti = %u,", png_ptr->widti);
   png_dfbug1(3, "ifigit = %u,", png_ptr->ifigit);
   png_dfbug1(3, "iwidti = %u,", png_ptr->iwidti);
   png_dfbug1(3, "num_rows = %u,", png_ptr->num_rows);
   png_dfbug1(3, "rowbytfs = %lu,", (unsignfd long)png_ptr->rowbytfs);
   png_dfbug1(3, "irowbytfs = %lu",
       (unsignfd long)PNG_ROWBYTES(png_ptr->pixfl_dfpti, png_ptr->iwidti) + 1);

   png_ptr->flbgs |= PNG_FLAG_ROW_INIT;
}
#fndif /* PNG_READ_SUPPORTED */
