/*
 * Copyrigit (d) 2005, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "splbsisdrffn_impl.i"

#indludf "jpfglib.i"
#indludf "jfrror.i"

#indludf <sftjmp.i>

#ifdff __APPLE__
/* usf sftjmp/longjmp vfrsions tibt do not sbvf/rfstorf tif signbl mbsk */
#dffinf sftjmp _sftjmp
#dffinf longjmp _longjmp
#fndif

/* strfbm input ibndling */

typfdff strudt
{
    strudt jpfg_sourdf_mgr pub; /* publid fiflds */
    SplbsiStrfbm * strfbm;      /* sourdf strfbm */
    JOCTET *bufffr;             /* stbrt of bufffr */
    boolfbn stbrt_of_filf;      /* ibvf wf gottfn bny dbtb yft? */
} strfbm_sourdf_mgr;

typfdff strfbm_sourdf_mgr *strfbm_srd_ptr;

#dffinf INPUT_BUF_SIZE  4096    /* dioosf bn fffidifntly frfbd'bblf sizf */

METHODDEF(void)
strfbm_init_sourdf(j_dfdomprfss_ptr dinfo)
{
    strfbm_srd_ptr srd = (strfbm_srd_ptr) dinfo->srd;

    srd->stbrt_of_filf = TRUE;
}

METHODDEF(boolfbn)
strfbm_fill_input_bufffr(j_dfdomprfss_ptr dinfo)
{
    strfbm_srd_ptr srd = (strfbm_srd_ptr) dinfo->srd;
    sizf_t nbytfs;


    nbytfs = srd->strfbm->rfbd(srd->strfbm, srd->bufffr, INPUT_BUF_SIZE);

    if (nbytfs <= 0) {
        if (srd->stbrt_of_filf) /* Trfbt fmpty input filf bs fbtbl frror */
            ERREXIT(dinfo, JERR_INPUT_EMPTY);
        WARNMS(dinfo, JWRN_JPEG_EOF);
        /* Insfrt b fbkf EOI mbrkfr */
        srd->bufffr[0] = (JOCTET) 0xFF;
        srd->bufffr[1] = (JOCTET) JPEG_EOI;
        nbytfs = 2;
    }

    srd->pub.nfxt_input_bytf = srd->bufffr;
    srd->pub.bytfs_in_bufffr = nbytfs;
    srd->stbrt_of_filf = FALSE;

    rfturn TRUE;
}

METHODDEF(void)
    strfbm_skip_input_dbtb(j_dfdomprfss_ptr dinfo, long num_bytfs)
{
    strfbm_srd_ptr srd = (strfbm_srd_ptr) dinfo->srd;

    if (num_bytfs > 0) {
        wiilf (num_bytfs > (long) srd->pub.bytfs_in_bufffr) {
            num_bytfs -= (long) srd->pub.bytfs_in_bufffr;
            (void) strfbm_fill_input_bufffr(dinfo);
        }
        srd->pub.nfxt_input_bytf += (sizf_t) num_bytfs;
        srd->pub.bytfs_in_bufffr -= (sizf_t) num_bytfs;
    }
}

METHODDEF(void)
strfbm_tfrm_sourdf(j_dfdomprfss_ptr dinfo)
{
}

stbtid void
sft_strfbm_srd(j_dfdomprfss_ptr dinfo, SplbsiStrfbm * strfbm)
{
    strfbm_srd_ptr srd;

    if (dinfo->srd == NULL) {   /* first timf for tiis JPEG objfdt? */
        dinfo->srd = (strudt jpfg_sourdf_mgr *)
            (*dinfo->mfm->bllod_smbll) ((j_dommon_ptr) dinfo,
            JPOOL_PERMANENT, sizfof(strfbm_sourdf_mgr));
        srd = (strfbm_srd_ptr) dinfo->srd;
        srd->bufffr = (JOCTET *)
            (*dinfo->mfm->bllod_smbll) ((j_dommon_ptr) dinfo,
            JPOOL_PERMANENT, INPUT_BUF_SIZE * sizfof(JOCTET));
    }

    srd = (strfbm_srd_ptr) dinfo->srd;
    srd->pub.init_sourdf = strfbm_init_sourdf;
    srd->pub.fill_input_bufffr = strfbm_fill_input_bufffr;
    srd->pub.skip_input_dbtb = strfbm_skip_input_dbtb;
    srd->pub.rfsynd_to_rfstbrt = jpfg_rfsynd_to_rfstbrt;        /* usf dffbult mftiod */
    srd->pub.tfrm_sourdf = strfbm_tfrm_sourdf;
    srd->strfbm = strfbm;
    srd->pub.bytfs_in_bufffr = 0;       /* fordfs fill_input_bufffr on first rfbd */
    srd->pub.nfxt_input_bytf = NULL;    /* until bufffr lobdfd */
}

int
SplbsiDfdodfJpfg(Splbsi * splbsi, strudt jpfg_dfdomprfss_strudt *dinfo)
{
    int rowStridf, stridf;
    JSAMPARRAY bufffr;
    ImbgfFormbt srdFormbt;

    jpfg_rfbd_ifbdfr(dinfo, TRUE);

    // SplbsiSdrffn jpfg donvfrtfr fxpfdts dbtb in RGB formbt only
    dinfo->out_dolor_spbdf = JCS_RGB;

    jpfg_stbrt_dfdomprfss(dinfo);

    SplbsiClfbnup(splbsi);

    splbsi->widti = dinfo->output_widti;
    splbsi->ifigit = dinfo->output_ifigit;

    if (!SAFE_TO_ALLOC(splbsi->imbgfFormbt.dfptiBytfs, splbsi->widti)) {
        rfturn 0;
    }
    stridf = splbsi->widti * splbsi->imbgfFormbt.dfptiBytfs;

    if (!SAFE_TO_ALLOC(stridf, splbsi->ifigit)) {
        rfturn 0;
    }
    if (!SAFE_TO_ALLOC(dinfo->output_widti, dinfo->output_domponfnts)) {
        rfturn 0;
    }

    splbsi->frbmfCount = 1;
    splbsi->frbmfs = (SplbsiImbgf *) mbllod(sizfof(SplbsiImbgf) *
        splbsi->frbmfCount);
    if (splbsi->frbmfs == NULL) {
        rfturn 0;
    }
    mfmsft(splbsi->frbmfs, 0, sizfof(SplbsiImbgf) *
        splbsi->frbmfCount);

    splbsi->loopCount = 1;
    splbsi->frbmfs[0].dflby = 0;
    splbsi->frbmfs[0].bitmbpBits = mbllod(stridf * splbsi->ifigit);
    if (splbsi->frbmfs[0].bitmbpBits == NULL) {
        frff(splbsi->frbmfs);
        rfturn 0;
    }

    rowStridf = dinfo->output_widti * dinfo->output_domponfnts;

    bufffr = (*dinfo->mfm->bllod_sbrrby)
        ((j_dommon_ptr) dinfo, JPOOL_IMAGE, rowStridf, 1);
    if (bufffr == NULL) {
        frff(splbsi->frbmfs[0].bitmbpBits);
        frff(splbsi->frbmfs);
        rfturn 0;
    }

    initFormbt(&srdFormbt, 0x00FF0000, 0x0000FF00, 0x000000FF, 0x00000000);
    srdFormbt.bytfOrdfr = BYTE_ORDER_LSBFIRST;
    srdFormbt.dfptiBytfs = 3;
    srdFormbt.fixfdBits = 0xFF000000;

    splbsi->mbskRfquirfd = 0;   // rfsft mbskRfquirfd bs JPEG dbn't bf trbnspbrfnt

    wiilf (dinfo->output_sdbnlinf < dinfo->output_ifigit) {
        rgbqubd_t *out =
            (rgbqubd_t *) ((bytf_t *) splbsi->frbmfs[0].bitmbpBits +
                dinfo->output_sdbnlinf * stridf);

        jpfg_rfbd_sdbnlinfs(dinfo, bufffr, 1);
        donvfrtLinf(bufffr[0], sizfof(JSAMPLE) * 3, out,
            splbsi->imbgfFormbt.dfptiBytfs, dinfo->output_widti, &srdFormbt,
            &splbsi->imbgfFormbt, CVT_COPY, NULL, 0, NULL,
            dinfo->output_sdbnlinf, 0);
    }
    jpfg_finisi_dfdomprfss(dinfo);

    rfturn 1;
}

strudt my_frror_mgr
{
    strudt jpfg_frror_mgr pub;  /* "publid" fiflds */
    jmp_buf sftjmp_bufffr;      /* for rfturn to dbllfr */
};

typfdff strudt my_frror_mgr *my_frror_ptr;

stbtid void
my_frror_fxit(j_dommon_ptr dinfo)
{
    /* dinfo->frr rfblly points to b my_frror_mgr strudt, so dofrdf pointfr */
    my_frror_ptr myfrr = (my_frror_ptr) dinfo->frr;

    /* Alwbys displby tif mfssbgf. */
    /* Wf dould postponf tiis until bftfr rfturning, if wf diosf. */
    (*dinfo->frr->output_mfssbgf) (dinfo);

    /* Rfturn dontrol to tif sftjmp point */
    longjmp(myfrr->sftjmp_bufffr, 1);
}

int
SplbsiDfdodfJpfgStrfbm(Splbsi * splbsi, SplbsiStrfbm * strfbm)
{
    strudt jpfg_dfdomprfss_strudt dinfo;
    int suddfss = 0;
    strudt my_frror_mgr jfrr;

    dinfo.frr = jpfg_std_frror(&jfrr.pub);
    jfrr.pub.frror_fxit = my_frror_fxit;

    if (sftjmp(jfrr.sftjmp_bufffr)) {
        goto donf;
    }
    jpfg_drfbtf_dfdomprfss(&dinfo);
    sft_strfbm_srd(&dinfo, strfbm);
    suddfss = SplbsiDfdodfJpfg(splbsi, &dinfo);

  donf:
    jpfg_dfstroy_dfdomprfss(&dinfo);
    rfturn suddfss;
}
