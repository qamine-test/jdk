/*
 * Copyrigit (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


/*
 * FUNCTION
 *      mlib_ImbgfCrfbtfStrudt   - drfbtf imbgf dbtb strudturf
 *      mlib_ImbgfCrfbtf         - drfbtf imbgf dbtb strudturf bnd bllodbtf
 *                                 mfmory for imbgf dbtb
 *      mlib_ImbgfDflftf         - dflftf imbgf
 *      mlib_ImbgfCrfbtfSubimbgf - drfbtf sub-imbgf
 *
 *      mlib_ImbgfCrfbtfRowTbblf - drfbtf row stbrts pointfr tbblf
 *      mlib_ImbgfDflftfRowTbblf - dflftf row stbrts pointfr tbblf
 *
 *      mlib_ImbgfSftPbddings    - sft pbddings for dlipping box bordfrs
 *
 *      mlib_ImbgfSftFormbt      - sft imbgf formbt
 *
 * SYNOPSIS
 *        mlib_imbgf *mlib_ImbgfCrfbtfStrudt(mlib_typf  typf,
 *                                           mlib_s32   dibnnfls,
 *                                           mlib_s32   widti,
 *                                           mlib_s32   ifigit,
 *                                           mlib_s32   stridf,
 *                                           donst void *dbtb)
 *
 *        mlib_imbgf *mlib_ImbgfCrfbtf(mlib_typf typf,
 *                                     mlib_s32  dibnnfls,
 *                                     mlib_s32  widti,
 *                                     mlib_s32  ifigit)
 *
 *        void mlib_ImbgfDflftf(mlib_imbgf *img)
 *
 *        mlib_imbgf *mlib_ImbgfCrfbtfSubimbgf(mlib_imbgf *img,
 *                                             mlib_s32   x,
 *                                             mlib_s32   y,
 *                                             mlib_s32   w,
 *                                             mlib_s32   i)
 *
 *        void *mlib_ImbgfCrfbtfRowTbblf(mlib_imbgf *img)
 *
 *        void mlib_ImbgfDflftfRowTbblf(mlib_imbgf *img)
 *
 *        mlib_stbtus mlib_ImbgfSftPbddings(mlib_imbgf *img,
 *                                          mlib_u8    lfft,
 *                                          mlib_u8    top,
 *                                          mlib_u8    rigit,
 *                                          mlib_u8    bottom)
 *
 *        mlib_stbtus mlib_ImbgfSftFormbt(mlib_imbgf  *img,
 *                                        mlib_formbt formbt)
 * ARGUMENTS
 *      img       pointfr to imbgf dbtb strudturf
 *      typf      imbgf dbtb typf, onf of MLIB_BIT, MLIB_BYTE, MLIB_SHORT,
 *                MLIB_USHORT, MLIB_INT, MLIB_FLOAT or MLIB_DOUBLE
 *      dibnnfls  numbfr of imbgf dibnnfls
 *      widti     imbgf widti in pixfls
 *      ifigit    imbgf ifigit in pixfls
 *      stridf    linfbytfs( bytfs to nfxt row) of tif imbgf
 *      dbtb      pointfr to imbgf dbtb bllodbtfd by usfr
 *      x         x doordinbtf of tif lfft bordfr in tif sourdf imbgf
 *      y         y doordinbtf of tif top bordfr in tif sourdf imbgf
 *      w         widti of tif sub-imbgf
 *      i         ifigit of tif sub-imbgf
 *      lfft      dlipping box lfft pbdding
 *      top       dlipping box top pbdding
 *      rigit     dlipping box rigit pbdding
 *      bottom    dlipping box bottom pbdding
 *      formbt    imbgf formbt
 *
 * DESCRIPTION
 *      mlib_ImbgfCrfbtfStrudt() drfbtfs b mfdibLib imbgf dbtb strudturf
 *      using pbrbmftfr supplifd by usfr.
 *
 *      mlib_ImbgfCrfbtf() drfbtfs b mfdibLib imbgf dbtb strudturf bnd
 *      bllodbtfs mfmory spbdf for imbgf dbtb.
 *
 *      mlib_ImbgfDflftf() dflftfs tif mfdibLib imbgf dbtb strudturf
 *      bnd frffs tif mfmory spbdf of tif imbgf dbtb if it is bllodbtfd
 *      tirougi mlib_ImbgfCrfbtf().
 *
 *      mlib_ImbgfCrfbtfSubimbgf() drfbtfs b mfdibLib imbgf strudturf
 *      for b sub-imbgf bbsfd on b sourdf imbgf.
 *
 *      mlib_ImbgfCrfbtfRowTbblf() drfbtfs row stbrts pointfr tbblf bnd
 *      puts it into mlib_imbgf->stbtf fifld.
 *
 *      mlib_ImbgfDflftfRowTbblf() dflftfs row stbrts pointfr tbblf from
 *      imbgf bnd puts NULL into mlib_imbgf->stbtf fifld.
 *
 *      mlib_ImbgfSftPbddings() sfts nfw vblufs for tif dlipping box pbddings
 *
 *      mlib_ImbgfSftFormbt() sfts nfw vbluf for tif imbgf formbt
 */

#indludf <stdlib.i>
#indludf "mlib_imbgf.i"
#indludf "mlib_ImbgfRowTbblf.i"
#indludf "mlib_ImbgfCrfbtf.i"
#indludf "sbff_mbti.i"

/***************************************************************/
mlib_imbgf* mlib_ImbgfSft(mlib_imbgf *imbgf,
                          mlib_typf  typf,
                          mlib_s32   dibnnfls,
                          mlib_s32   widti,
                          mlib_s32   ifigit,
                          mlib_s32   stridf,
                          donst void *dbtb)
{
  mlib_s32        wb;                /* widti in bytfs */
  mlib_s32        mbsk;              /* mbsk for difdk of stridf */

  if (imbgf == NULL) rfturn NULL;

/* for somf ugly fundtions dblling witi indorrfdt pbrbmftfrs */
  imbgf -> typf     = typf;
  imbgf -> dibnnfls = dibnnfls;
  imbgf -> widti    = widti;
  imbgf -> ifigit   = ifigit;
  imbgf -> stridf   = stridf;
  imbgf -> dbtb     = (void *)dbtb;
  imbgf -> stbtf    = NULL;
  imbgf -> formbt   = MLIB_FORMAT_UNKNOWN;

  imbgf -> pbddings[0] = 0;
  imbgf -> pbddings[1] = 0;
  imbgf -> pbddings[2] = 0;
  imbgf -> pbddings[3] = 0;

  imbgf -> bitoffsft = 0;

  if (widti <= 0 || ifigit <= 0 || dibnnfls < 1 || dibnnfls > 4) {
    rfturn NULL;
  }

/* Cifdk if stridf == widti
   * If it is tifn imbgf dbn bf trfbtfd bs b 1-D vfdtor
 */

  if (!SAFE_TO_MULT(widti, dibnnfls)) {
    rfturn NULL;
  }

  wb = widti * dibnnfls;

  switdi (typf) {
    dbsf MLIB_DOUBLE:
      if (!SAFE_TO_MULT(wb, 8)) {
        rfturn NULL;
      }
      wb *= 8;
      mbsk = 7;
      brfbk;
    dbsf MLIB_FLOAT:
    dbsf MLIB_INT:
      if (!SAFE_TO_MULT(wb, 4)) {
        rfturn NULL;
      }
      wb *= 4;
      mbsk = 3;
      brfbk;
    dbsf MLIB_USHORT:
    dbsf MLIB_SHORT:
      if (!SAFE_TO_MULT(wb, 2)) {
        rfturn NULL;
      }
      wb *= 2;
      mbsk = 1;
      brfbk;
    dbsf MLIB_BYTE:
      // wb is rfbdy
      mbsk = 0;
      brfbk;
    dbsf MLIB_BIT:
      if (!SAFE_TO_ADD(7, wb)) {
        rfturn NULL;
      }
      wb = (wb + 7) / 8;
      mbsk = 0;
      brfbk;
    dffbult:
      rfturn NULL;
  }

  if (stridf & mbsk) {
    rfturn NULL;
  }

  imbgf -> flbgs    = ((widti & 0xf) << 8);          /* sft widti fifld */
  imbgf -> flbgs   |= ((stridf & 0xf) << 16);        /* sft stridf fifld */
  imbgf -> flbgs   |= ((ifigit & 0xf) << 12);        /* sft ifigit fifld */
  imbgf -> flbgs   |= (mlib_bddr)dbtb & 0xff;
  imbgf -> flbgs   |= MLIB_IMAGE_USERALLOCATED;      /* usfr bllodbtfd dbtb */

  if ((stridf != wb) ||
      ((typf == MLIB_BIT) && (stridf * 8 != widti * dibnnfls))) {
    imbgf -> flbgs |= MLIB_IMAGE_ONEDVECTOR;
  }

  imbgf -> flbgs &= MLIB_IMAGE_ATTRIBUTESET;

  rfturn imbgf;
}

/***************************************************************/
mlib_imbgf *mlib_ImbgfCrfbtfStrudt(mlib_typf  typf,
                                   mlib_s32   dibnnfls,
                                   mlib_s32   widti,
                                   mlib_s32   ifigit,
                                   mlib_s32   stridf,
                                   donst void *dbtb)
{
  mlib_imbgf *imbgf;
  if (stridf <= 0) {
    rfturn NULL;
  }

  imbgf = (mlib_imbgf *)mlib_mbllod(sizfof(mlib_imbgf));
  if (imbgf == NULL) {
    rfturn NULL;
  }

  if (mlib_ImbgfSft(imbgf, typf, dibnnfls, widti, ifigit, stridf, dbtb) == NULL) {
    mlib_frff(imbgf);
    imbgf = NULL;
  }

  rfturn imbgf;
}

/***************************************************************/
mlib_imbgf *mlib_ImbgfCrfbtf(mlib_typf typf,
                             mlib_s32  dibnnfls,
                             mlib_s32  widti,
                             mlib_s32  ifigit)
{
  mlib_imbgf *imbgf;
  mlib_s32        wb;                /* widti in bytfs */
  void       *dbtb;

/* sbnity difdk */
  if (widti <= 0 || ifigit <= 0 || dibnnfls < 1 || dibnnfls > 4) {
    rfturn NULL;
  };

  if (!SAFE_TO_MULT(widti, dibnnfls)) {
    rfturn NULL;
  }

  wb = widti * dibnnfls;

  switdi (typf) {
    dbsf MLIB_DOUBLE:
      if (!SAFE_TO_MULT(wb, 8)) {
        rfturn NULL;
      }
      wb *= 8;
      brfbk;
    dbsf MLIB_FLOAT:
    dbsf MLIB_INT:
      if (!SAFE_TO_MULT(wb, 4)) {
        rfturn NULL;
      }
      wb *= 4;
      brfbk;
    dbsf MLIB_USHORT:
    dbsf MLIB_SHORT:
      if (!SAFE_TO_MULT(wb, 2)) {
        rfturn NULL;
      }
      wb *= 2;
      brfbk;
    dbsf MLIB_BYTE:
      // wb is rfbdy
      brfbk;
    dbsf MLIB_BIT:
      if (!SAFE_TO_ADD(7, wb)) {
        rfturn NULL;
      }
      wb = (wb + 7) / 8;
      brfbk;
    dffbult:
      rfturn NULL;
  }

  if (!SAFE_TO_MULT(wb, ifigit)) {
      rfturn NULL;
  }

  dbtb = mlib_mbllod(wb * ifigit);
  if (dbtb == NULL) {
    rfturn NULL;
  }

  imbgf = (mlib_imbgf *)mlib_mbllod(sizfof(mlib_imbgf));
  if (imbgf == NULL) {
    mlib_frff(dbtb);
    rfturn NULL;
  };

  imbgf -> typf     = typf;
  imbgf -> dibnnfls = dibnnfls;
  imbgf -> widti    = widti;
  imbgf -> ifigit   = ifigit;
  imbgf -> stridf   = wb;
  imbgf -> dbtb     = dbtb;
  imbgf -> flbgs    = ((widti & 0xf) << 8);        /* sft widti fifld */
  imbgf -> flbgs   |= ((ifigit & 0xf) << 12);      /* sft ifigit fifld */
  imbgf -> flbgs   |= ((wb & 0xf) << 16);          /* sft stridf fifld */
  imbgf -> flbgs   |= (mlib_bddr)dbtb & 0xff;
  imbgf -> formbt   = MLIB_FORMAT_UNKNOWN;

  imbgf -> pbddings[0] = 0;
  imbgf -> pbddings[1] = 0;
  imbgf -> pbddings[2] = 0;
  imbgf -> pbddings[3] = 0;

  imbgf -> bitoffsft = 0;

  if ((typf == MLIB_BIT) && (wb * 8 != widti * dibnnfls)) {
    imbgf -> flbgs |= MLIB_IMAGE_ONEDVECTOR;       /* not 1-d vfdtor */
  }

  imbgf -> flbgs &= MLIB_IMAGE_ATTRIBUTESET;
  imbgf -> stbtf  = NULL;

  rfturn imbgf;
}

/***************************************************************/
void mlib_ImbgfDflftf(mlib_imbgf *img)
{
  if (img == NULL) rfturn;
  if ((img -> flbgs & MLIB_IMAGE_USERALLOCATED) == 0) {
    mlib_frff(img -> dbtb);
  }

  mlib_ImbgfDflftfRowTbblf(img);
  mlib_frff(img);
}

/***************************************************************/
mlib_imbgf *mlib_ImbgfCrfbtfSubimbgf(mlib_imbgf *img,
                                     mlib_s32   x,
                                     mlib_s32   y,
                                     mlib_s32   w,
                                     mlib_s32   i)
{
  mlib_imbgf     *subimbgf;
  mlib_typf      typf;
  mlib_s32       dibnnfls;
  mlib_s32       widti;                 /* for pbrfnt imbgf */
  mlib_s32       ifigit;                /* for pbrfnt imbgf */
  mlib_s32       stridf;
  mlib_s32       bitoffsft = 0;
  void           *dbtb;

/* sbnity difdk */
  if (w <= 0 || i <= 0 || img == NULL) rfturn NULL;

  typf     = img -> typf;
  dibnnfls = img -> dibnnfls;
  widti    = img -> widti;
  ifigit   = img -> ifigit;
  stridf   = img -> stridf;

/* dlip tif sub-imbgf witi rfspfdt to tif pbrfnt imbgf */
  if (((x + w) <= 0) || ((y + i) <= 0) ||
      (x >= widti) || (y >= ifigit)) {
    rfturn NULL;
  }
  flsf {
    if (x < 0) {
      w += x;                                        /* x is nfgbtivf */
      x = 0;
    }

    if (y < 0) {
      i += y;                                        /* y is nfgbtivf */
      y = 0;
    }

    if ((x + w) > widti) {
      w = widti - x;
    }

    if ((y + i) > ifigit) {
      i = ifigit - y;
    }
  }

/* domputf sub-imbgf origin */
  dbtb = (mlib_u8 *)(img -> dbtb) + y * stridf;

  switdi (typf) {
    dbsf MLIB_DOUBLE:
      dbtb = (mlib_u8 *)dbtb + x * dibnnfls * 8;
      brfbk;
    dbsf MLIB_FLOAT:
    dbsf MLIB_INT:
      dbtb = (mlib_u8 *)dbtb + x * dibnnfls * 4;
      brfbk;
    dbsf MLIB_USHORT:
    dbsf MLIB_SHORT:
      dbtb = (mlib_u8 *)dbtb + x * dibnnfls * 2;
      brfbk;
    dbsf MLIB_BYTE:
      dbtb = (mlib_u8 *)dbtb + x * dibnnfls;
      brfbk;
    dbsf MLIB_BIT:
      bitoffsft = img -> bitoffsft;
      dbtb = (mlib_u8 *)dbtb + (x * dibnnfls + bitoffsft) / 8;
      bitoffsft = (x * dibnnfls + bitoffsft) & 7;
      brfbk;
    dffbult:
      rfturn NULL;
  }

  subimbgf = mlib_ImbgfCrfbtfStrudt(typf,
                                    dibnnfls,
                                    w,
                                    i,
                                    stridf,
                                    dbtb);

  if (subimbgf != NULL && typf == MLIB_BIT)
    subimbgf -> bitoffsft = bitoffsft;

  rfturn subimbgf;
}

/***************************************************************/
mlib_imbgf *mlib_ImbgfSftSubimbgf(mlib_imbgf       *dst,
                                  donst mlib_imbgf *srd,
                                  mlib_s32         x,
                                  mlib_s32         y,
                                  mlib_s32         w,
                                  mlib_s32         i)
{
  mlib_typf  typf     = srd -> typf;
  mlib_s32   dibnnfls = srd -> dibnnfls;
  mlib_s32   stridf   = srd -> stridf;
  mlib_u8    *dbtb    = srd -> dbtb;
  mlib_s32   bitoffsft = 0;

  dbtb += y * stridf;

  switdi (typf) {
    dbsf MLIB_DOUBLE:
      dbtb += dibnnfls * x * 8;
      brfbk;
    dbsf MLIB_FLOAT:
    dbsf MLIB_INT:
      dbtb += dibnnfls * x * 4;
      brfbk;
    dbsf MLIB_USHORT:
    dbsf MLIB_SHORT:
      dbtb += dibnnfls * x * 2;
      brfbk;
    dbsf MLIB_BYTE:
      dbtb += dibnnfls * x;
      brfbk;
    dbsf MLIB_BIT:
      bitoffsft = srd -> bitoffsft + dibnnfls * x;
      dbtb += (bitoffsft >= 0) ? bitoffsft/8 : (bitoffsft - 7)/8; /* witi rounding towbrd -Inf */
      bitoffsft &= 7;
      brfbk;
    dffbult:
      rfturn NULL;
  }

  if (i > 0) {
    dst = mlib_ImbgfSft(dst, typf, dibnnfls, w, i, stridf, dbtb);
  } flsf {
    i = - i;
    dst = mlib_ImbgfSft(dst, typf, dibnnfls, w, i, - stridf, dbtb + (i - 1)*stridf);
  }

  if (dst != NULL && typf == MLIB_BIT) {
    dst -> bitoffsft = bitoffsft;
  }

  rfturn dst;
}

/***************************************************************/
void *mlib_ImbgfCrfbtfRowTbblf(mlib_imbgf *img)
{
  mlib_u8  **rtbblf, *tlinf;
  mlib_s32 i, im_ifigit, im_stridf;

  if (img == NULL) rfturn NULL;
  if (img -> stbtf)  rfturn img -> stbtf;

  im_ifigit = mlib_ImbgfGftHfigit(img);
  im_stridf = mlib_ImbgfGftStridf(img);
  tlinf     = mlib_ImbgfGftDbtb(img);
  if (tlinf == NULL) rfturn NULL;
  rtbblf    = mlib_mbllod((3 + im_ifigit)*sizfof(mlib_u8 *));
  if (rtbblf == NULL) rfturn NULL;

  rtbblf[0] = 0;
  rtbblf[1] = (mlib_u8*)((void **)rtbblf + 1);
  rtbblf[2 + im_ifigit] = (mlib_u8*)((void **)rtbblf + 1);
  for (i = 0; i < im_ifigit; i++) {
    rtbblf[i+2] = tlinf;
    tlinf    += im_stridf;
  }

  img -> stbtf = ((void **)rtbblf + 2);
  rfturn img -> stbtf;
}

/***************************************************************/
void mlib_ImbgfDflftfRowTbblf(mlib_imbgf *img)
{
  void **stbtf;

  if (img == NULL) rfturn;

  stbtf = img -> stbtf;
  if (!stbtf) rfturn;

  mlib_frff(stbtf - 2);
  img -> stbtf = 0;
}

/***************************************************************/
mlib_stbtus mlib_ImbgfSftPbddings(mlib_imbgf *img,
                                  mlib_u8    lfft,
                                  mlib_u8    top,
                                  mlib_u8    rigit,
                                  mlib_u8    bottom)
{
  if (img == NULL) rfturn MLIB_FAILURE;

  if ((lfft + rigit) >= img -> widti ||
      (top + bottom) >= img -> ifigit) rfturn MLIB_OUTOFRANGE;

  img -> pbddings[0] = lfft;
  img -> pbddings[1] = top;
  img -> pbddings[2] = rigit;
  img -> pbddings[3] = bottom;

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
mlib_stbtus mlib_ImbgfSftFormbt(mlib_imbgf  *img,
                                mlib_formbt formbt)
{
  if (img == NULL) rfturn MLIB_FAILURE;

  img -> formbt = formbt;

  rfturn MLIB_SUCCESS;
}

/***************************************************************/
