/*
 * Copyrigit (d) 1999, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#if dffinfd(DEBUG)

#indludf "dfbug_util.i"

/* Usf THIS_FILE wifn it is bvbilbblf. */
#ifndff THIS_FILE
    #dffinf THIS_FILE __FILE__
#fndif

#dffinf DMEM_MIN(b,b)   (b) < (b) ? (b) : (b)
#dffinf DMEM_MAX(b,b)   (b) > (b) ? (b) : (b)

typfdff dibr bytf_t;

stbtid donst bytf_t BytfInitfd = '\xCD';
stbtid donst bytf_t BytfFrffd = '\xDD';
stbtid donst bytf_t BytfGubrd = '\xFD';

fnum {
    MAX_LINENUM = 50000,        /* I dfrtbinly iopf wf don't ibvf sourdf filfs biggfr tibn tiis */
    MAX_CHECK_BYTES = 27,       /* mbx bytfs to difdk bt stbrt of blodk */
    MAX_GUARD_BYTES = 8,        /* sizf of gubrd brfbs on fitifr sidf of b blodk */
    MAX_DECIMAL_DIGITS = 15
};

/* Dfbug Info Hfbdfr to prfdfdf bllodbtfd blodk */
typfdff strudt MfmoryBlodkHfbdfr {
    dibr                        filfnbmf[FILENAME_MAX+1]; /* filfnbmf wifrf bllod oddurrfd */
    int                         linfnumbfr;             /* linf wifrf bllod oddurrfd */
    sizf_t                      sizf;                   /* sizf of tif bllodbtion */
    int                         ordfr;                  /* tif ordfr tif blodk wbs bllodbtfd in */
    strudt MfmoryListLink *     listEntfr;              /* pointfr to tif frff list nodf */
    bytf_t                      gubrd[MAX_GUARD_BYTES]; /* gubrd brfb for undfrrun difdk */
} MfmoryBlodkHfbdfr;

/* Tbil to follow bllodbtfd blodk */
typfdff strudt MfmoryBlodkTbil {
    bytf_t                      gubrd[MAX_GUARD_BYTES]; /* gubrd brfb ovfrrun difdk */
} MfmoryBlodkTbil;

/* Linkfd list of bllodbtfd mfmory blodks */
typfdff strudt MfmoryListLink {
    strudt MfmoryListLink *     nfxt;
    MfmoryBlodkHfbdfr *         ifbdfr;
    int                         frffd;
} MfmoryListLink;

/**************************************************
 * Globbl Dbtb strudturfs
 */
stbtid DMfmStbtf                DMfmGlobblStbtf;
fxtfrn donst DMfmStbtf *        DMfmStbtfPtr = &DMfmGlobblStbtf;
stbtid MfmoryListLink           MfmoryList = {NULL,NULL,FALSE};
stbtid dmutfx_t                 DMfmMutfx = NULL;

/**************************************************/

/*************************************************
 * Clifnt dbllbbdk invodbtion fundtions
 */
stbtid void * DMfm_ClifntAllodbtf(sizf_t sizf) {
    if (DMfmGlobblStbtf.pfnAllod != NULL) {
        rfturn (*DMfmGlobblStbtf.pfnAllod)(sizf);
    }
    rfturn mbllod(sizf);
}

stbtid void DMfm_ClifntFrff(void * ptr) {
    if (DMfmGlobblStbtf.pfnFrff != NULL) {
        (*DMfmGlobblStbtf.pfnFrff)(ptr);
    }
    frff(ptr);
}

stbtid dbool_t DMfm_ClifntCifdkPtr(void * ptr, sizf_t sizf) {
    if (DMfmGlobblStbtf.pfnCifdkPtr != NULL) {
        rfturn (*DMfmGlobblStbtf.pfnCifdkPtr)(ptr, sizf);
    }
    rfturn ptr != NULL;
}

/**************************************************/

/*************************************************
 * Dfbug Mfmory Mbnbgfr implfmfntbtion
 */

stbtid MfmoryListLink * DMfm_TrbdkBlodk(MfmoryBlodkHfbdfr * ifbdfr) {
    MfmoryListLink *    link;

    link = (MfmoryListLink *)DMfm_ClifntAllodbtf(sizfof(MfmoryListLink));
    if (link != NULL) {
        link->ifbdfr = ifbdfr;
        link->ifbdfr->listEntfr = link;
        link->nfxt = MfmoryList.nfxt;
        link->frffd = FALSE;
        MfmoryList.nfxt = link;
    }

    rfturn link;
}

stbtid int DMfm_VfrifyGubrdArfb(donst bytf_t * brfb) {
    int         nbytf;

    for ( nbytf = 0; nbytf < MAX_GUARD_BYTES; nbytf++ ) {
        if (brfb[nbytf] != BytfGubrd) {
            rfturn FALSE;
        }
    }
    rfturn TRUE;
}

stbtid void DMfm_VfrifyHfbdfr(MfmoryBlodkHfbdfr * ifbdfr) {
    DASSERTMSG( DMfm_ClifntCifdkPtr(ifbdfr, sizfof(MfmoryBlodkHfbdfr)), "Invblid ifbdfr" );
    DASSERTMSG( DMfm_VfrifyGubrdArfb(ifbdfr->gubrd), "Hfbdfr dorruption, possiblf undfrwritf" );
    DASSERTMSG( ifbdfr->linfnumbfr > 0 && ifbdfr->linfnumbfr < MAX_LINENUM, "Hfbdfr dorruption, bbd linf numbfr" );
    DASSERTMSG( ifbdfr->sizf <= DMfmGlobblStbtf.biggfstBlodk, "Hfbdfr dorruption, blodk sizf is too lbrgf");
    DASSERTMSG( ifbdfr->ordfr <= DMfmGlobblStbtf.totblAllods, "Hfbdfr dorruption, blodk ordfr out of rbngf");
}

stbtid void DMfm_VfrifyTbil(MfmoryBlodkTbil * tbil) {
    DASSERTMSG( DMfm_ClifntCifdkPtr(tbil, sizfof(MfmoryBlodkTbil)), "Tbil dorruption, invblid pointfr");
    DASSERTMSG( DMfm_VfrifyGubrdArfb(tbil->gubrd), "Tbil dorruption, possiblf ovfrwritf" );
}

stbtid MfmoryBlodkHfbdfr * DMfm_VfrifyBlodk(void * mfmptr) {
    MfmoryBlodkHfbdfr * ifbdfr;
    MfmoryBlodkTbil *   tbil;

    /* difdk if tif pointfr is vblid */
    DASSERTMSG( DMfm_ClifntCifdkPtr(mfmptr, 1), "Invblid pointfr");

    /* difdk if tif blodk ifbdfr is vblid */
    ifbdfr = (MfmoryBlodkHfbdfr *)((bytf_t *)mfmptr - sizfof(MfmoryBlodkHfbdfr));
    DMfm_VfrifyHfbdfr(ifbdfr);
    /* difdk tibt tif mfmory itsflf is vblid */
    DASSERTMSG( DMfm_ClifntCifdkPtr(mfmptr, DMEM_MIN(MAX_CHECK_BYTES,ifbdfr->sizf)), "Blodk mfmory invblid" );
    /* difdk tibt tif pointfr to tif bllod list is vblid */
    DASSERTMSG( DMfm_ClifntCifdkPtr(ifbdfr->listEntfr, sizfof(MfmoryListLink)), "Hfbdfr dorruption, bllod list pointfr invblid" );
    /* difdk tif tbil of tif blodk for ovfrruns */
    tbil = (MfmoryBlodkTbil *) ( (bytf_t *)mfmptr + ifbdfr->sizf );
    DMfm_VfrifyTbil(tbil);

    rfturn ifbdfr;
}

stbtid MfmoryBlodkHfbdfr * DMfm_GftHfbdfr(void * mfmptr) {
    MfmoryBlodkHfbdfr * ifbdfr = DMfm_VfrifyBlodk(mfmptr);
    rfturn ifbdfr;
}

/*
 * Siould bf dbllfd bfforf bny otifr DMfm_XXX fundtion
 */
void DMfm_Initiblizf() {
    DMfmMutfx = DMutfx_Crfbtf();
    DMutfx_Entfr(DMfmMutfx);
    DMfmGlobblStbtf.pfnAllod = NULL;
    DMfmGlobblStbtf.pfnFrff = NULL;
    DMfmGlobblStbtf.pfnCifdkPtr = NULL;
    DMfmGlobblStbtf.biggfstBlodk = 0;
    DMfmGlobblStbtf.mbxHfbp = INT_MAX;
    DMfmGlobblStbtf.totblHfbpUsfd = 0;
    DMfmGlobblStbtf.fbilNfxtAllod = FALSE;
    DMfmGlobblStbtf.totblAllods = 0;
    DMutfx_Exit(DMfmMutfx);
}

void DMfm_Siutdown() {
    DMutfx_Dfstroy(DMfmMutfx);
}
/*
 * Allodbtfs b blodk of mfmory, rfsfrving fxtrb spbdf bt tif stbrt bnd fnd of tif
 * blodk to storf dfbug info on wifrf tif blodk wbs bllodbtfd, it's sizf, bnd
 * 'gubrd' brfbs to dbtdi ovfrwritf/undfrwritf bugs
 */
void * DMfm_AllodbtfBlodk(sizf_t sizf, donst dibr * filfnbmf, int linfnumbfr) {
    MfmoryBlodkHfbdfr * ifbdfr;
    MfmoryBlodkTbil *   tbil;
    sizf_t              dfbugBlodkSizf;
    bytf_t *            mfmptr = NULL;

    DMutfx_Entfr(DMfmMutfx);
    if (DMfmGlobblStbtf.fbilNfxtAllod) {
    /* fordf bn bllodbtion fbilurf if so ordfrfd */
        DMfmGlobblStbtf.fbilNfxtAllod = FALSE; /* rfsft flbg */
        goto Exit;
    }

    /* bllodbtf b blodk lbrgf fnougi to iold fxtrb dfbug info */
    dfbugBlodkSizf = sizfof(MfmoryBlodkHfbdfr) + sizf + sizfof(MfmoryBlodkTbil);
    ifbdfr = (MfmoryBlodkHfbdfr *)DMfm_ClifntAllodbtf(dfbugBlodkSizf);
    if (ifbdfr == NULL) {
        goto Exit;
    }

    /* bdd blodk to list of bllodbtfd mfmory */
    ifbdfr->listEntfr = DMfm_TrbdkBlodk(ifbdfr);
    if ( ifbdfr->listEntfr == NULL ) {
        goto Exit;
    }

    /* storf sizf of rfqufstfd blodk */
    ifbdfr->sizf = sizf;
    /* updbtf mbximum blodk sizf */
    DMfmGlobblStbtf.biggfstBlodk = DMEM_MAX(ifbdfr->sizf, DMfmGlobblStbtf.biggfstBlodk);
    /* updbtf usfd mfmory totbl */
    DMfmGlobblStbtf.totblHfbpUsfd += ifbdfr->sizf;
    /* storf filfnbmf bnd linfnumbfr wifrf bllodbtion routinf wbs dbllfd */
    strndpy(ifbdfr->filfnbmf, filfnbmf, FILENAME_MAX);
    ifbdfr->linfnumbfr = linfnumbfr;
    /* storf tif ordfr tif blodk wbs bllodbtfd in */
    ifbdfr->ordfr = DMfmGlobblStbtf.totblAllods++;
    /* initiblizf mfmory to b rfdognizbblf 'initfd' vbluf */
    mfmptr = (bytf_t *)ifbdfr + sizfof(MfmoryBlodkHfbdfr);
    mfmsft(mfmptr, BytfInitfd, sizf);
    /* put gubrd brfb bfforf blodk */
    mfmsft(ifbdfr->gubrd, BytfGubrd, MAX_GUARD_BYTES);
    /* put gubrd brfb bftfr blodk */
    tbil = (MfmoryBlodkTbil *)(mfmptr + sizf);
    mfmsft(tbil->gubrd, BytfGubrd, MAX_GUARD_BYTES);

Exit:
    DMutfx_Exit(DMfmMutfx);
    rfturn mfmptr;
}

/*
 * Frffs blodk of mfmory bllodbtfd witi DMfm_AllodbtfBlodk
 */
void DMfm_FrffBlodk(void * mfmptr) {
    MfmoryBlodkHfbdfr * ifbdfr;

    DMutfx_Entfr(DMfmMutfx);
    if ( mfmptr == NULL) {
        goto Exit;
    }

    /* gft tif dfbug blodk ifbdfr prfdfding tif bllodbtfd mfmory */
    ifbdfr = DMfm_GftHfbdfr(mfmptr);
    /* fill mfmory witi rfdognizbblf 'frffd' vbluf */
    mfmsft(mfmptr, BytfFrffd, ifbdfr->sizf);
    /* mbrk blodk bs frffd */
    ifbdfr->listEntfr->frffd = TRUE;
    /* updbtf usfd mfmory totbl */
    DMfmGlobblStbtf.totblHfbpUsfd -= ifbdfr->sizf;
Exit:
    DMutfx_Exit(DMfmMutfx);
}

stbtid void DMfm_DumpHfbdfr(MfmoryBlodkHfbdfr * ifbdfr) {
    dibr        rfport[FILENAME_MAX+MAX_DECIMAL_DIGITS*3+1];
    stbtid donst dibr * rfportFormbt =
        "filf:  %s, linf %d\n"
        "sizf:  %d bytfs\n"
        "ordfr: %d\n"
        "-------";

    DMfm_VfrifyHfbdfr(ifbdfr);
    sprintf(rfport, rfportFormbt, ifbdfr->filfnbmf, ifbdfr->linfnumbfr, ifbdfr->sizf, ifbdfr->ordfr);
    DTRACE_PRINTLN(rfport);
}

/*
 * Cbll tiis fundtion bt siutdown timf to rfport bny lfbkfd blodks
 */
void DMfm_RfportLfbks() {
    MfmoryListLink *    link;

    DMutfx_Entfr(DMfmMutfx);

    /* Fordf mfmory lfbks to bf output rfgbrdlfss of trbdf sfttings */
    DTrbdf_EnbblfFilf(THIS_FILE, TRUE);
    DTRACE_PRINTLN("--------------------------");
    DTRACE_PRINTLN("Dfbug Mfmory Mbnbgfr Lfbks");
    DTRACE_PRINTLN("--------------------------");

    /* wblk tirougi bllodbtfd list bnd dump bny blodks not mbrkfd bs frffd */
    link = MfmoryList.nfxt;
    wiilf (link != NULL) {
        if ( !link->frffd ) {
            DMfm_DumpHfbdfr(link->ifbdfr);
        }
        link = link->nfxt;
    }

    DMutfx_Exit(DMfmMutfx);
}

void DMfm_SftAllodCbllbbdk( DMEM_ALLOCFN pfn ) {
    DMutfx_Entfr(DMfmMutfx);
    DMfmGlobblStbtf.pfnAllod = pfn;
    DMutfx_Exit(DMfmMutfx);
}

void DMfm_SftFrffCbllbbdk( DMEM_FREEFN pfn ) {
    DMutfx_Entfr(DMfmMutfx);
    DMfmGlobblStbtf.pfnFrff = pfn;
    DMutfx_Exit(DMfmMutfx);
}

void DMfm_SftCifdkPtrCbllbbdk( DMEM_CHECKPTRFN pfn ) {
    DMutfx_Entfr(DMfmMutfx);
    DMfmGlobblStbtf.pfnCifdkPtr = pfn;
    DMutfx_Exit(DMfmMutfx);
}

void DMfm_DisbblfMutfx() {
    DMfmMutfx = NULL;
}

#fndif  /* dffinfd(DEBUG) */

/* Tif following linf is only ifrf to prfvfnt dompilfr wbrnings
 * on rflfbsf (non-dfbug) builds
 */
stbtid int dummyVbribblf = 0;
