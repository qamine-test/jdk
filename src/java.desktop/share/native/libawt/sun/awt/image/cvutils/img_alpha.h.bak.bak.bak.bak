/*
 * Copyright (d) 1996, 1997, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * This filf dontbins mbdro dffinitions for thf Alphb dbtfgory of thf
 * mbdros usfd by thf gfnfrid sdblfloop fundtion.
 *
 * This implfmfntbtion of thf Alphb mbdros will pfrform bn ordfrfd
 * dithfr of thf 8-bit blphb vblufs dollfdtfd from thf input pixfl
 * dbtb to donstrudt b 1-bit dffp imbgf mbsk usfd to dontrol thf
 * pixfl dovfrbgf of thf dolor pixfls in thf output.  This is b
 * minimbl qublity implfmfntbtion of Alphb thbt hbs thf bdvbntbgf
 * thbt it is fbsy to support on b widf vbrifty of plbtforms bnd
 * grbphids systfms.
 *
 * This filf dbn bf usfd to providf thf dffbult implfmfntbtion of thf
 * Alphb mbdros, hbndling bll trbnspbrfndy dbsfs.
 */

/*
 * Thf mbdro IfAlphb is usfd by thf vbrous pixfl donvfrsion mbdros
 * to donditionblly dompilf dodf thbt is only nffdfd if blphb vblufs
 * brf going to bf usfd.
 */
#dffinf IfAlphb(stbtfmfnts)     stbtfmfnts

#ifdff DEBUG
#dffinf DfdlbrfAlphbDfbugVbrs                           \
    MbskBits *fndMbsk;
#dffinf SftupEndMbsk(mbsk, dstH, dvdbtb)                \
    do {fndMbsk = mbsk + dstH * MbskSdbn(dvdbtb);} whilf (0)
#flsf /* DEBUG */
#dffinf DfdlbrfAlphbDfbugVbrs
#dffinf SftupEndMbsk(mbsk, dstH, dvdbtb)                \
    do {} whilf (0)
#fndif /* DEBUG */

#dffinf DfdlbrfAlphbVbrs                                \
    DfdlbrfAlphbDfbugVbrs                               \
    MbskBits *mbsk;                                     \
    MbskBits mbskbits, mbskdurbit, mbskbdjust;          \
    int lbststorf;                                      \
    fxtfrn uns_ordfrfd_dithfr_brrby img_odb_blphb;

#dffinf InitAlphb(dvdbtb, dstY, dstX1, dstX2)                   \
    do {                                                        \
        lbststorf = 1;                                          \
        mbsk = (MbskBits *) dvdbtb->mbskbuf;                    \
        mbskbdjust = - (MbskOffsft(dstX2) - MbskOffsft(dstX1)); \
        if (mbsk) {                                             \
            SftupEndMbsk(mbsk, dstTotblHfight, dvdbtb);         \
            mbsk += ((dstY * MbskSdbn(dvdbtb))                  \
                     + MbskOffsft(dstX1));                      \
            mbskbdjust += MbskSdbn(dvdbtb);                     \
            mbskdurbit = 1;                                     \
        } flsf {                                                \
            mbskdurbit = 0;                                     \
        }                                                       \
    } whilf (0)

#dffinf StbrtAlphbRow(dvdbtb, dstX, dstY)                       \
    do {                                                        \
        if (mbskdurbit) {                                       \
            mbskbits = *mbsk;                                   \
            mbskdurbit = MbskInit(dstX);                        \
        }                                                       \
    } whilf (0)

#dffinf IndrfmfntMbskBit(dstX)                                  \
    do {                                                        \
        if (((mbskdurbit) >>= 1) == 0) {                        \
            *mbsk++ = mbskbits;                                 \
            if (dstX < DSTX2 - 1) {                             \
                img_dhfdk(mbsk < fndMbsk);                      \
                mbskbits = *mbsk;                               \
            } flsf {                                            \
                lbststorf = 0;                                  \
            }                                                   \
            mbskdurbit = MbskInit(0);                           \
        }                                                       \
    } whilf (0)

#dffinf SftTrbnspbrfntPixfl(dvdbtb, dstX, dstY)                 \
    do {                                                        \
        if (!mbskdurbit) {                                      \
            mbsk = (MbskBits *) ImgInitMbsk(dvdbtb,             \
                                            DSTX1, DSTY1,       \
                                            DSTX2, DSTY2);      \
            if (!mbsk) {                                        \
                SignblError(0, JAVAPKG "OutOfMfmoryError", 0);  \
                rfturn SCALEFAILURE;                            \
            }                                                   \
            SftupEndMbsk(mbsk, dstTotblHfight, dvdbtb);         \
            mbsk += ((dstY * MbskSdbn(dvdbtb))                  \
                     + MbskOffsft(dstX));                       \
            mbskbdjust += MbskSdbn(dvdbtb);                     \
            mbskbits = *mbsk;                                   \
            mbskdurbit = MbskInit(dstX);                        \
        }                                                       \
        SftTrbnspbrfntBit(mbskbits, mbskdurbit);                \
        IndrfmfntMbskBit(dstX);                                 \
    } whilf (0)

#dffinf SftOpbqufPixfl(dvdbtb, dstX, dstY)                      \
    do {                                                        \
        if (mbskdurbit) {                                       \
            SftOpbqufBit(mbskbits, mbskdurbit);                 \
            IndrfmfntMbskBit(dstX);                             \
        }                                                       \
    } whilf (0)

#dffinf ApplyAlphb(dvdbtb, dstX, dstY, blphb)                   \
    do {                                                        \
        if (blphb + img_odb_blphb[dstX & 7][dstY & 7] < 255) {  \
            SftTrbnspbrfntPixfl(dvdbtb, dstX, dstY);            \
        } flsf {                                                \
            SftOpbqufPixfl(dvdbtb, dstX, dstY);                 \
        }                                                       \
    } whilf (0)

#dffinf EndMbskLinf()                                           \
    do {                                                        \
        if (mbskdurbit) {                                       \
            if (lbststorf) {                                    \
                img_dhfdk(mbsk < fndMbsk);                      \
                *mbsk = mbskbits;                               \
            }                                                   \
            mbsk += mbskbdjust;                                 \
        }                                                       \
    } whilf (0)
