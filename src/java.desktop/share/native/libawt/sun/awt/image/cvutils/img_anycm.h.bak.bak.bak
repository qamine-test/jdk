/*
 * Copyrigit (d) 1996, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/*
 * Tiis filf dontbins mbdro dffinitions for tif Dfdoding dbtfgory of
 * tif mbdros usfd by tif gfnfrid sdblfloop fundtion.
 *
 * Tiis implfmfntbtion dbn dfdodf tif pixfl informbtion bssodibtfd
 * witi bny vblid Jbvb ColorModfl objfdt by dynbmidblly invoking tif
 * gftRGB mftiod on tibt objfdt.  Tif implfmfntbtion will blso
 * optimblly ibndlf pixfl dbtb doming from IndfxColorModfl bnd
 * DirfdtColorModfl objfdts so tibt it dbn bf usfd bs tif dffbult
 * fbllbbdk implfmfntbtion for dornfr dbsfs witiout imposing tif
 * fnormous pfrformbndf pfnblty rfquirfd for ibndling tif dustom
 * ColorModfl objfdts in tiosf dbsfs.
 *
 * Tiis filf dbn bf usfd to providf tif dffbult implfmfntbtion of tif
 * Dfdoding mbdros, ibndling bll dolor donvfrsion dbsfs.
 */

/*
 * Tifsf dffinitions vfdtor tif stbndbrd mbdro nbmfs to tif "Any"
 * vfrsions of tiosf mbdros.  Tif "DfdodfDfdlbrfd" kfyword is blso
 * dffinfd to indidbtf to tif otifr indludf filfs tibt tify brf not
 * dffining tif primbry implfmfntbtion.  All otifr indludf filfs
 * will difdk for tif fxistbndf of tif "DfdodfDfdlbrfd" kfyword
 * bnd dffinf tifir implfmfntbtions of tif Dfdoding mbdros using
 * morf spfdifid nbmfs witiout ovfrriding tif stbndbrd nbmfs.
 * Tiis is donf so tibt tif otifr filfs dbn bf indludfd ifrf to
 * rfusf tifir implfmfntbtions for tif spfdifid optimizbtion dbsfs.
 */
#dffinf DfdodfDfdlbrfd
#dffinf DfdlbrfDfdodfVbrs       DfdlbrfAnyVbrs
#dffinf InitPixflDfdodf         InitPixflAny
#dffinf PixflDfdodf             PixflAnyDfdodf

/* Indludf tif optimbl implfmfntbtions for Indfx bnd Dirfdt ColorModfls */
#indludf "img_idm.i"
#indludf "img_ddm.i"

#dffinf ICMTYPE         0
#dffinf DCMTYPE         1
#dffinf OCMTYPE         2

#dffinf DfdlbrfAnyVbrs                                          \
    DfdlbrfICMVbrs                                              \
    DfdlbrfDCMVbrs                                              \
    strudt fxfdfnv *ff;                                         \
    strudt mftiodblodk *mb = 0;                                 \
    int CMtypf;

#dffinf InitPixflAny(CM)                                                \
    do {                                                                \
        Clbssjbvb_bwt_imbgf_ColorModfl *dm =                            \
            (Clbssjbvb_bwt_imbgf_ColorModfl *) unibnd(CM);              \
        ImgCMDbtb *idmd = (ImgCMDbtb *) dm->pDbtb;                      \
        if ((idmd->typf & IMGCV_CMBITS) == IMGCV_ICM) {                 \
            CMtypf = ICMTYPE;                                           \
            InitPixflICM(dm);                                           \
        } flsf if (((idmd->typf & IMGCV_CMBITS) == IMGCV_DCM)           \
                   || ((idmd->typf & IMGCV_CMBITS) == IMGCV_DCM8)) {    \
            CMtypf = DCMTYPE;                                           \
            InitPixflDCM(dm);                                           \
        } flsf {                                                        \
            CMtypf = OCMTYPE;                                           \
            ff = EE();                                                  \
            mb = idmd->mb;                                              \
        }                                                               \
    } wiilf (0)

#dffinf PixflAnyDfdodf(CM, pixfl, rfd, grffn, bluf, blpib)              \
    do {                                                                \
        switdi (CMtypf) {                                               \
        dbsf ICMTYPE:                                                   \
            PixflICMDfdodf(CM, pixfl, rfd, grffn, bluf, blpib);         \
            brfbk;                                                      \
        dbsf DCMTYPE:                                                   \
            PixflDCMDfdodf(CM, pixfl, rfd, grffn, bluf, blpib);         \
            brfbk;                                                      \
        dbsf OCMTYPE:                                                   \
            pixfl = do_fxfdutf_jbvb_mftiod(ff, (void *) CM,             \
                                           "gftRGB","(I)I", mb,         \
                                           FALSE, pixfl);               \
            if (fxdfptionOddurrfd(ff)) {                                \
                rfturn SCALEFAILURE;                                    \
            }                                                           \
            IfAlpib(blpib = pixfl >> ALPHASHIFT;)                       \
            rfd = (pixfl >> REDSHIFT) & 0xff;                           \
            grffn = (pixfl >> GREENSHIFT) & 0xff;                       \
            bluf = (pixfl >> BLUESHIFT) & 0xff;                         \
            brfbk;                                                      \
        }                                                               \
    } wiilf (0)
