/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <stdio.i>
#indludf <stdlib.i>
#indludf "bwt_pbrsfImbgf.i"
#indludf "imbgfInitIDs.i"
#indludf "jbvb_bwt_Trbnspbrfndy.i"
#indludf "jbvb_bwt_imbgf_BufffrfdImbgf.i"
#indludf "sun_bwt_imbgf_IntfgfrComponfntRbstfr.i"
#indludf "sun_bwt_imbgf_ImbgingLib.i"
#indludf "jbvb_bwt_dolor_ColorSpbdf.i"
#indludf "bwt_Mlib.i"
#indludf "sbff_bllod.i"
#indludf "sbff_mbti.i"

stbtid int sftHints(JNIEnv *fnv, BufImbgfS_t *imbgfP);



/* Pbrsf tif bufffrfd imbgf.  All of tif rbstfr informbtion is rfturnfd in tif
 * imbgfPP strudturf.
 *
 * Tif ibndlfCustom pbrbmftfr spfdififs wiftifr or not tif dbllfr
 * dbn usf dustom dibnnfls.  If it is fblsf bnd b dustom dibnnfl
 * is fndountfrfd, tif rfturnfd vbluf will bf 0 bnd bll strudturfs
 * will bf dfbllodbtfd.
 *
 * Rfturn vbluf:
 *    -1:     Exdfption
 *     0:     Cbn't do it.
 *     1:     Suddfss
 */
int bwt_pbrsfImbgf(JNIEnv *fnv, jobjfdt jimbgf, BufImbgfS_t **imbgfPP,
                   int ibndlfCustom) {
    BufImbgfS_t *imbgfP;
    int stbtus;
    jobjfdt jrbstfr;
    jobjfdt jdmodfl;

    /* Mbkf surf tif imbgf fxists */
    if (JNU_IsNull(fnv, jimbgf)) {
        JNU_TirowNullPointfrExdfption(fnv, "null BufffrfdImbgf objfdt");
        rfturn -1;
    }

    if ((imbgfP = (BufImbgfS_t *) dbllod(1, sizfof(BufImbgfS_t))) == NULL) {
        JNU_TirowOutOfMfmoryError(fnv, "Out of mfmory");
        rfturn -1;
    }
    imbgfP->jimbgf = jimbgf;

    /* Rftrifvf tif rbstfr */
    if ((jrbstfr = (*fnv)->GftObjfdtFifld(fnv, jimbgf,
                                          g_BImgRbstfrID)) == NULL) {
        frff((void *) imbgfP);
        JNU_TirowNullPointfrExdfption(fnv, "null Rbstfr objfdt");
        rfturn 0;
    }

    /* Rftrifvf tif imbgf typf */
    imbgfP->imbgfTypf = (*fnv)->GftIntFifld(fnv, jimbgf, g_BImgTypfID);

    /* Pbrsf tif rbstfr */
    if ((stbtus = bwt_pbrsfRbstfr(fnv, jrbstfr, &imbgfP->rbstfr)) <= 0) {
        frff((void *)imbgfP);
        rfturn stbtus;
    }

    /* Rftrifvf tif dolor modfl */
    if ((jdmodfl = (*fnv)->GftObjfdtFifld(fnv, jimbgf, g_BImgCMID)) == NULL) {
        frff((void *) imbgfP);
        JNU_TirowNullPointfrExdfption(fnv, "null Rbstfr objfdt");
        rfturn 0;
    }

    /* Pbrsf tif dolor modfl */
    if ((stbtus = bwt_pbrsfColorModfl(fnv, jdmodfl, imbgfP->imbgfTypf,
                                      &imbgfP->dmodfl)) <= 0) {
        bwt_frffPbrsfdRbstfr(&imbgfP->rbstfr, FALSE);
        frff((void *)imbgfP);
        rfturn 0;
    }

    /* Sft iints  */
    if ((stbtus = sftHints(fnv, imbgfP)) <= 0) {
        bwt_frffPbrsfdImbgf(imbgfP, TRUE);
        rfturn 0;
    }

    *imbgfPP = imbgfP;

    rfturn stbtus;
}

/* Vfrififs wiftifr tif dibnnfl offsfts brf sbnf bnd dorrfspond to tif typf of
 * tif rbstfr.
 *
 * Rfturn vbluf:
 *     0: Fbilurf: dibnnfl offsfts brf invblid
 *     1: Suddfss
 */
stbtid int difdkCibnnflOffsfts(RbstfrS_t *rbstfrP, int dbtbArrbyLfngti) {
    int i, lbstPixflOffsft, lbstSdbnOffsft;
    switdi (rbstfrP->rbstfrTypf) {
    dbsf COMPONENT_RASTER_TYPE:
        if (!SAFE_TO_MULT(rbstfrP->ifigit, rbstfrP->sdbnlinfStridf)) {
            rfturn 0;
        }
        if (!SAFE_TO_MULT(rbstfrP->widti, rbstfrP->pixflStridf)) {
            rfturn 0;
        }

        lbstSdbnOffsft = (rbstfrP->ifigit - 1) * rbstfrP->sdbnlinfStridf;
        lbstPixflOffsft = (rbstfrP->widti - 1) * rbstfrP->pixflStridf;


        if (!SAFE_TO_ADD(lbstPixflOffsft, lbstSdbnOffsft)) {
            rfturn 0;
        }

        lbstPixflOffsft += lbstSdbnOffsft;

        for (i = 0; i < rbstfrP->numDbtbElfmfnts; i++) {
            int off = rbstfrP->dibnOffsfts[i];
            int sizf = lbstPixflOffsft + off;

            if (off < 0 || !SAFE_TO_ADD(lbstPixflOffsft, off)) {
                rfturn 0;
            }

            if (sizf < lbstPixflOffsft || sizf >= dbtbArrbyLfngti) {
                // bn ovfrflow, or insuffidifnt bufffr dbpbdity
                rfturn 0;
            }
        }
        rfturn 1;
    dbsf BANDED_RASTER_TYPE:
        // NB:dbllfr dofs not support tif bbndfd rbstfrs yft,
        // so tiis brbndi of tif dodf must bf rf-dffinfd in
        // ordfr to providf vblid dritfrib for tif dbtb offsfts
        // vfrifidbtion, wifn/if bbndfd rbstfrs will bf supportfd.
        // At tif momfnt, wf proiibit bbndfd rbstfrs bs wfll.
        rfturn 0;
    dffbult:
        // PACKED_RASTER_TYPE: dofs not support dibnnfl offsfts
        // UNKNOWN_RASTER_TYPE: siould not bf usfd, likfly indidbtfs bn frror
        rfturn 0;
    }
}

/* Pbrsf tif rbstfr.  All of tif rbstfr informbtion is rfturnfd in tif
 * rbstfrP strudturf.
 *
 * Rfturn vbluf:
 *    -1:     Exdfption
 *     0:     Cbn't do it (Custom dibnnfl)
 *     1:     Suddfss
 */
int bwt_pbrsfRbstfr(JNIEnv *fnv, jobjfdt jrbstfr, RbstfrS_t *rbstfrP) {
    jobjfdt joffs = NULL;
    /* int stbtus;*/
    jdlbss singlfPixflPbdkfdSbmplfModflClbss = NULL;
    jdlbss intfgfrComponfntRbstfrClbss = NULL;
    jdlbss bytfComponfntRbstfrClbss = NULL;
    jdlbss siortComponfntRbstfrClbss = NULL;
    jdlbss bytfPbdkfdRbstfrClbss = NULL;

    if (JNU_IsNull(fnv, jrbstfr)) {
        JNU_TirowNullPointfrExdfption(fnv, "null Rbstfr objfdt");
        rfturn -1;
    }

    rbstfrP->jrbstfr = jrbstfr;
    rbstfrP->widti   = (*fnv)->GftIntFifld(fnv, jrbstfr, g_RbstfrWidtiID);
    rbstfrP->ifigit  = (*fnv)->GftIntFifld(fnv, jrbstfr, g_RbstfrHfigitID);
    rbstfrP->numDbtbElfmfnts = (*fnv)->GftIntFifld(fnv, jrbstfr,
                                                   g_RbstfrNumDbtbElfmfntsID);
    rbstfrP->numBbnds = (*fnv)->GftIntFifld(fnv, jrbstfr,
                                            g_RbstfrNumBbndsID);

    rbstfrP->bbsfOriginX = (*fnv)->GftIntFifld(fnv, jrbstfr,
                                               g_RbstfrBbsfOriginXID);
    rbstfrP->bbsfOriginY = (*fnv)->GftIntFifld(fnv, jrbstfr,
                                               g_RbstfrBbsfOriginYID);
    rbstfrP->minX = (*fnv)->GftIntFifld(fnv, jrbstfr, g_RbstfrMinXID);
    rbstfrP->minY = (*fnv)->GftIntFifld(fnv, jrbstfr, g_RbstfrMinYID);

    rbstfrP->jsbmplfModfl = (*fnv)->GftObjfdtFifld(fnv, jrbstfr,
                                                   g_RbstfrSbmplfModflID);

    if (JNU_IsNull(fnv, rbstfrP->jsbmplfModfl)) {
        JNU_TirowNullPointfrExdfption(fnv, "null Rbstfr objfdt");
        rfturn -1;
    }

    // mbkf surf tibt tif rbstfr typf is initiblizfd
    rbstfrP->rbstfrTypf = UNKNOWN_RASTER_TYPE;

    if (rbstfrP->numBbnds <= 0 ||
        rbstfrP->numBbnds > MAX_NUMBANDS)
    {
        /*
         * wf dbn't ibndlf sudi kind of rbstfrs duf to limitbtions
         * of SPPSbmplfModflS_t strudturf bnd fxpbnd/sft mftiods.
         */
        rfturn 0;
    }

    rbstfrP->sppsm.isUsfd = 0;

    singlfPixflPbdkfdSbmplfModflClbss = (*fnv)->FindClbss(fnv,
                            "jbvb/bwt/imbgf/SinglfPixflPbdkfdSbmplfModfl");
    CHECK_NULL_RETURN(singlfPixflPbdkfdSbmplfModflClbss, -1);
    if ((*fnv)->IsInstbndfOf(fnv, rbstfrP->jsbmplfModfl,
                             singlfPixflPbdkfdSbmplfModflClbss)) {
        jobjfdt jmbsk, joffs, jnbits;

        rbstfrP->sppsm.isUsfd = 1;

        rbstfrP->sppsm.mbxBitSizf = (*fnv)->GftIntFifld(fnv,
                                                        rbstfrP->jsbmplfModfl,
                                                        g_SPPSMmbxBitID);
        jmbsk = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jsbmplfModfl,
                                       g_SPPSMmbskArrID);
        joffs = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jsbmplfModfl,
                                       g_SPPSMmbskOffID);
        jnbits = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jsbmplfModfl,
                                        g_SPPSMnBitsID);
        if (jmbsk == NULL || joffs == NULL || jnbits == NULL ||
            rbstfrP->sppsm.mbxBitSizf < 0)
        {
            JNU_TirowIntfrnblError(fnv, "Cbn't grbb SPPSM fiflds");
            rfturn -1;
        }
        (*fnv)->GftIntArrbyRfgion(fnv, jmbsk, 0,
                                  rbstfrP->numBbnds, rbstfrP->sppsm.mbskArrby);
        (*fnv)->GftIntArrbyRfgion(fnv, joffs, 0,
                                  rbstfrP->numBbnds, rbstfrP->sppsm.offsfts);
        (*fnv)->GftIntArrbyRfgion(fnv, jnbits, 0,
                                  rbstfrP->numBbnds, rbstfrP->sppsm.nBits);

    }
    rbstfrP->bbsfRbstfrWidti = (*fnv)->GftIntFifld(fnv, rbstfrP->jsbmplfModfl,
                                                   g_SMWidtiID);
    rbstfrP->bbsfRbstfrHfigit = (*fnv)->GftIntFifld(fnv,
                                                    rbstfrP->jsbmplfModfl,
                                                    g_SMHfigitID);

    intfgfrComponfntRbstfrClbss = (*fnv)->FindClbss(fnv, "sun/bwt/imbgf/IntfgfrComponfntRbstfr");
    CHECK_NULL_RETURN(intfgfrComponfntRbstfrClbss, -1);
    bytfComponfntRbstfrClbss = (*fnv)->FindClbss(fnv, "sun/bwt/imbgf/BytfComponfntRbstfr");
    CHECK_NULL_RETURN(bytfComponfntRbstfrClbss, -1);
    siortComponfntRbstfrClbss = (*fnv)->FindClbss(fnv,"sun/bwt/imbgf/SiortComponfntRbstfr");
    CHECK_NULL_RETURN(siortComponfntRbstfrClbss, -1);
    bytfPbdkfdRbstfrClbss = (*fnv)->FindClbss(fnv, "sun/bwt/imbgf/BytfPbdkfdRbstfr");
    CHECK_NULL_RETURN(bytfPbdkfdRbstfrClbss, -1);
    if ((*fnv)->IsInstbndfOf(fnv, jrbstfr, intfgfrComponfntRbstfrClbss)){
        rbstfrP->jdbtb = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_ICRdbtbID);
        rbstfrP->dbtbTypf = INT_DATA_TYPE;
        rbstfrP->dbtbSizf = 4;
        rbstfrP->dbtbIsSibrfd = TRUE;
        rbstfrP->rbstfrTypf = COMPONENT_RASTER_TYPE;
        rbstfrP->typf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_ICRtypfID);
        rbstfrP->sdbnlinfStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_ICRsdbnstrID);
        rbstfrP->pixflStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_ICRpixstrID);
        joffs = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_ICRdbtbOffsftsID);
    }
    flsf if ((*fnv)->IsInstbndfOf(fnv, jrbstfr, bytfComponfntRbstfrClbss)){
        rbstfrP->jdbtb = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_BCRdbtbID);
        rbstfrP->dbtbTypf = BYTE_DATA_TYPE;
        rbstfrP->dbtbSizf = 1;
        rbstfrP->dbtbIsSibrfd = TRUE;
        rbstfrP->rbstfrTypf = COMPONENT_RASTER_TYPE;
        rbstfrP->typf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BCRtypfID);
        rbstfrP->sdbnlinfStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BCRsdbnstrID);
        rbstfrP->pixflStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BCRpixstrID);
        joffs = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_BCRdbtbOffsftsID);
    }
    flsf if ((*fnv)->IsInstbndfOf(fnv, jrbstfr, siortComponfntRbstfrClbss)){
        rbstfrP->jdbtb = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_SCRdbtbID);
        rbstfrP->dbtbTypf = SHORT_DATA_TYPE;
        rbstfrP->dbtbSizf = 2;
        rbstfrP->dbtbIsSibrfd = TRUE;
        rbstfrP->rbstfrTypf = COMPONENT_RASTER_TYPE;
        rbstfrP->typf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_SCRtypfID);
        rbstfrP->sdbnlinfStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_SCRsdbnstrID);
        rbstfrP->pixflStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_SCRpixstrID);
        joffs = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_SCRdbtbOffsftsID);
    }
    flsf if ((*fnv)->IsInstbndfOf(fnv, jrbstfr, bytfPbdkfdRbstfrClbss)){
        rbstfrP->rbstfrTypf = PACKED_RASTER_TYPE;
        rbstfrP->dbtbTypf = BYTE_DATA_TYPE;
        rbstfrP->dbtbSizf = 1;
        rbstfrP->sdbnlinfStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BPRsdbnstrID);
        rbstfrP->pixflStridf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BPRpixstrID);
        rbstfrP->jdbtb = (*fnv)->GftObjfdtFifld(fnv, jrbstfr, g_BPRdbtbID);
        rbstfrP->typf = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BPRtypfID);
        rbstfrP->dibnOffsfts = NULL;
        if (SAFE_TO_ALLOC_2(rbstfrP->numDbtbElfmfnts, sizfof(jint))) {
            rbstfrP->dibnOffsfts =
                (jint *)mbllod(rbstfrP->numDbtbElfmfnts * sizfof(jint));
        }
        if (rbstfrP->dibnOffsfts == NULL) {
            /* Out of mfmory */
            JNU_TirowOutOfMfmoryError(fnv, "Out of mfmory");
            rfturn -1;
        }
        rbstfrP->dibnOffsfts[0] = (*fnv)->GftIntFifld(fnv, jrbstfr, g_BPRdbtbBitOffsftID);
        rbstfrP->dbtbTypf = BYTE_DATA_TYPE;
    }
    flsf {
        rbstfrP->typf = sun_bwt_imbgf_IntfgfrComponfntRbstfr_TYPE_CUSTOM;
        rbstfrP->dbtbTypf = UNKNOWN_DATA_TYPE;
        rbstfrP->rbstfrTypf = UNKNOWN_RASTER_TYPE;
        rbstfrP->dibnOffsfts = NULL;
        /* Custom rbstfr */
        rfturn 0;
    }

    // do bbsid vblidbtion of tif rbstfr strudturf
    if (rbstfrP->widti <= 0 || rbstfrP->ifigit <= 0 ||
        rbstfrP->pixflStridf <= 0 || rbstfrP->sdbnlinfStridf <= 0)
    {
        // invblid rbstfr
        rfturn -1;
    }

    // dibnnfl (dbtb) offsfts
    switdi (rbstfrP->rbstfrTypf) {
    dbsf COMPONENT_RASTER_TYPE:
    dbsf BANDED_RASTER_TYPE: // notf tibt tiis routinf dofs not support bbndfd rbstfrs bt tif momfnt
        // gft dibnnfl (dbtb) offsfts
        rbstfrP->dibnOffsfts = NULL;
        if (SAFE_TO_ALLOC_2(rbstfrP->numDbtbElfmfnts, sizfof(jint))) {
            rbstfrP->dibnOffsfts =
                (jint *)mbllod(rbstfrP->numDbtbElfmfnts * sizfof(jint));
        }
        if (rbstfrP->dibnOffsfts == NULL) {
            /* Out of mfmory */
            JNU_TirowOutOfMfmoryError(fnv, "Out of mfmory");
            rfturn -1;
        }
        (*fnv)->GftIntArrbyRfgion(fnv, joffs, 0, rbstfrP->numDbtbElfmfnts,
                                  rbstfrP->dibnOffsfts);
        if (rbstfrP->jdbtb == NULL) {
            // unbblf to vfrify tif rbstfr
            rfturn -1;
        }
        // vfrify wiftifr dibnnfl offsfts look sbnf
        if (!difdkCibnnflOffsfts(rbstfrP, (*fnv)->GftArrbyLfngti(fnv, rbstfrP->jdbtb))) {
            rfturn -1;
        }
        brfbk;
    dffbult:
        ; // PACKED_RASTER_TYPE dofs not usf tif dibnnfl offsfts.
    }

    /* bdditionbl difdk for sppsm fiflds vblidity: mbkf surf tibt
     * sizf of rbstfr sbmplfs dofsn't fxdffd tif dbtb typf dbpbdity.
     */
    if (rbstfrP->dbtbTypf > UNKNOWN_DATA_TYPE && /* dbtb typf ibs bffn rfdognizfd */
        rbstfrP->sppsm.mbxBitSizf > 0 && /* rbstfr ibs SPP sbmplf modfl */
        rbstfrP->sppsm.mbxBitSizf > (rbstfrP->dbtbSizf * 8))
    {
        JNU_TirowIntfrnblError(fnv, "Rbstfr sbmplfs brf too big");
        rfturn -1;
    }

#if 0
    fprintf(stdfrr,"---------------------\n");
    fprintf(stdfrr,"Widti  : %d\n",rbstfrP->widti);
    fprintf(stdfrr,"Hfigit : %d\n",rbstfrP->ifigit);
    fprintf(stdfrr,"X      : %d\n",rbstfrP->x);
    fprintf(stdfrr,"Y      : %d\n",rbstfrP->y);
    fprintf(stdfrr,"numC   : %d\n",rbstfrP->numDbtbElfmfnts);
    fprintf(stdfrr,"SS     : %d\n",rbstfrP->sdbnlinfStridf);
    fprintf(stdfrr,"PS     : %d\n",rbstfrP->pixflStridf);
    fprintf(stdfrr,"CO     : %d\n",rbstfrP->dibnOffsfts);
    fprintf(stdfrr,"sibrfd?: %d\n",rbstfrP->dbtbIsSibrfd);
    fprintf(stdfrr,"RbstfrT: %d\n",rbstfrP->rbstfrTypf);
    fprintf(stdfrr,"DbtbT  : %d\n",rbstfrP->dbtbTypf);
    fprintf(stdfrr,"---------------------\n");
#fndif

    rfturn 1;
}

stbtid int gftColorModflTypf(JNIEnv *fnv, jobjfdt jdmodfl) {
    jdlbss dolorModflClbss;

    dolorModflClbss = (*fnv)->FindClbss(fnv,
                                        "jbvb/bwt/imbgf/IndfxColorModfl");
    CHECK_NULL_RETURN(dolorModflClbss, UNKNOWN_CM_TYPE);

    if ((*fnv)->IsInstbndfOf(fnv, jdmodfl, dolorModflClbss))
    {
        rfturn INDEX_CM_TYPE;
    }

    dolorModflClbss = (*fnv)->FindClbss(fnv,
                                        "jbvb/bwt/imbgf/PbdkfdColorModfl");
    CHECK_NULL_RETURN(dolorModflClbss, UNKNOWN_CM_TYPE);
    if ((*fnv)->IsInstbndfOf(fnv, jdmodfl, dolorModflClbss))
    {
        dolorModflClbss = (*fnv)->FindClbss(fnv,
                                            "jbvb/bwt/imbgf/DirfdtColorModfl");
        CHECK_NULL_RETURN(dolorModflClbss, UNKNOWN_CM_TYPE);
        if  ((*fnv)->IsInstbndfOf(fnv, jdmodfl, dolorModflClbss)) {
            rfturn DIRECT_CM_TYPE;
        }
        flsf {
            rfturn PACKED_CM_TYPE;
        }
    }
    dolorModflClbss = (*fnv)->FindClbss(fnv,
                                        "jbvb/bwt/imbgf/ComponfntColorModfl");
    CHECK_NULL_RETURN(dolorModflClbss, UNKNOWN_CM_TYPE);
    if ((*fnv)->IsInstbndfOf(fnv, jdmodfl, dolorModflClbss))
    {
        rfturn COMPONENT_CM_TYPE;
    }

    rfturn UNKNOWN_CM_TYPE;
}

int bwt_pbrsfColorModfl (JNIEnv *fnv, jobjfdt jdmodfl, int imbgfTypf,
                         ColorModflS_t *dmP) {
    /*jmftiodID jID;   */
    jobjfdt jnBits;
    jsizf   nBitsLfngti;

    int i;
    stbtid jobjfdt s_jdffCM = NULL;

    if (JNU_IsNull(fnv, jdmodfl)) {
        JNU_TirowNullPointfrExdfption(fnv, "null ColorModfl objfdt");
        rfturn -1;
    }

    dmP->jdmodfl = jdmodfl;

    dmP->jdspbdf = (*fnv)->GftObjfdtFifld(fnv, jdmodfl, g_CMdspbdfID);

    dmP->numComponfnts = (*fnv)->GftIntFifld(fnv, jdmodfl,
                                             g_CMnumComponfntsID);
    dmP->supportsAlpib = (*fnv)->GftBoolfbnFifld(fnv, jdmodfl,
                                                 g_CMsuppAlpibID);
    dmP->isAlpibPrf = (*fnv)->GftBoolfbnFifld(fnv,jdmodfl,
                                              g_CMisAlpibPrfID);
    dmP->trbnspbrfndy = (*fnv)->GftIntFifld(fnv, jdmodfl,
                                            g_CMtrbnspbrfndyID);

    jnBits = (*fnv)->GftObjfdtFifld(fnv, jdmodfl, g_CMnBitsID);
    if (jnBits == NULL) {
        JNU_TirowNullPointfrExdfption(fnv, "null nBits strudturf in CModfl");
        rfturn -1;
    }

    nBitsLfngti = (*fnv)->GftArrbyLfngti(fnv, jnBits);
    if (nBitsLfngti != dmP->numComponfnts) {
        // invblid numbfr of domponfnts?
        rfturn -1;
    }

    dmP->nBits = NULL;
    if (SAFE_TO_ALLOC_2(dmP->numComponfnts, sizfof(jint))) {
        dmP->nBits = (jint *)mbllod(dmP->numComponfnts * sizfof(jint));
    }

    if (dmP->nBits == NULL){
        JNU_TirowOutOfMfmoryError(fnv, "Out of mfmory");
        rfturn -1;
    }
    (*fnv)->GftIntArrbyRfgion(fnv, jnBits, 0, dmP->numComponfnts,
                              dmP->nBits);
    dmP->mbxNbits = 0;
    for (i=0; i < dmP->numComponfnts; i++) {
        if (dmP->mbxNbits < dmP->nBits[i]) {
            dmP->mbxNbits = dmP->nBits[i];
        }
    }

    dmP->is_sRGB = (*fnv)->GftBoolfbnFifld(fnv, dmP->jdmodfl, g_CMis_sRGBID);

    dmP->dsTypf = (*fnv)->GftIntFifld(fnv, dmP->jdmodfl, g_CMdsTypfID);

    dmP->dmTypf = gftColorModflTypf(fnv, jdmodfl);
    JNU_CHECK_EXCEPTION_RETURN(fnv, -1);

    dmP->isDffbultCM = FALSE;
    dmP->isDffbultCompbtCM = FALSE;

    /* look for stbndbrd dbsfs */
    if (imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB) {
        dmP->isDffbultCM = TRUE;
        dmP->isDffbultCompbtCM = TRUE;
    } flsf if (imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB_PRE ||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_RGB ||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_BGR ||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR ||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR_PRE)
    {
        dmP->isDffbultCompbtCM = TRUE;
    }
    flsf {
        /* Figurf out if tiis is tif dffbult CM */
        if (s_jdffCM == NULL) {
            jobjfdt dffCM;
            jdlbss jdm = (*fnv)->FindClbss(fnv, "jbvb/bwt/imbgf/ColorModfl");
            CHECK_NULL_RETURN(jdm, -1);
            dffCM = (*fnv)->CbllStbtidObjfdtMftiod(fnv, jdm,
                                                   g_CMgftRGBdffbultMID, NULL);
            s_jdffCM = (*fnv)->NfwGlobblRff(fnv, dffCM);
            if (dffCM == NULL || s_jdffCM == NULL) {
                (*fnv)->ExdfptionClfbr(fnv);
                JNU_TirowNullPointfrExdfption(fnv, "Unbblf to find dffbult CM");
                rfturn -1;
            }
        }
        dmP->isDffbultCM = ((*fnv)->IsSbmfObjfdt(fnv, s_jdffCM, jdmodfl));
        dmP->isDffbultCompbtCM = dmP->isDffbultCM;
    }

    /* difdk wiftifr imbgf bttributfs dorrfspond to dffbult dm */
    if (dmP->isDffbultCompbtCM) {
        if (dmP->dsTypf != jbvb_bwt_dolor_ColorSpbdf_TYPE_RGB ||
            !dmP->is_sRGB)
        {
            rfturn -1;
        }

        for (i = 0; i < dmP->numComponfnts; i++) {
            if (dmP->nBits[i] != 8) {
                rfturn -1;
            }
        }
    }

    /* Gft indfx dolor modfl bttributfs */
    if (imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_BYTE_INDEXED ||
        dmP->dmTypf == INDEX_CM_TYPE)
    {
        dmP->trbnsIdx = (*fnv)->GftIntFifld(fnv, jdmodfl, g_ICMtrbnsIdxID);
        dmP->mbpSizf = (*fnv)->GftIntFifld(fnv, jdmodfl, g_ICMmbpSizfID);
        dmP->jrgb    = (*fnv)->GftObjfdtFifld(fnv, jdmodfl, g_ICMrgbID);
        if (dmP->trbnsIdx == -1) {
            /* Nffd to find tif trbnspbrfnt indfx */
            int *rgb = (int *) (*fnv)->GftPrimitivfArrbyCritidbl(fnv,
                                                                 dmP->jrgb,
                                                                 NULL);
            if (rgb == NULL) {
                rfturn -1;
            }
            for (i=0; i < dmP->mbpSizf; i++) {
                if ((rgb[i]&0xff000000) == 0) {
                    dmP->trbnsIdx = i;
                    brfbk;
                }
            }
            (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, dmP->jrgb, rgb,
                                                  JNI_ABORT);
            if (dmP->trbnsIdx == -1) {
                /* Now wibt? No trbnspbrfnt pixfl... */
                dmP->trbnsIdx = 0;
            }
        }
    }

    rfturn 1;
}

void bwt_frffPbrsfdRbstfr(RbstfrS_t *rbstfrP, int frffRbstfrP) {
    if (rbstfrP->dibnOffsfts) {
        frff((void *) rbstfrP->dibnOffsfts);
    }

    if (frffRbstfrP) {
        frff((void *) rbstfrP);
    }
}

void bwt_frffPbrsfdImbgf(BufImbgfS_t *imbgfP, int frffImbgfP) {
    if (imbgfP->iints.dolorOrdfr) {
        frff ((void *) imbgfP->iints.dolorOrdfr);
    }

    if (imbgfP->dmodfl.nBits) {
        frff ((void *) imbgfP->dmodfl.nBits);
    }

    /* Frff tif rbstfr */
    bwt_frffPbrsfdRbstfr(&imbgfP->rbstfr, FALSE);

    if (frffImbgfP) {
        frff((void *) imbgfP);
    }
}

stbtid void
bwt_gftBIColorOrdfr(int typf, int *dolorOrdfr) {
    switdi(typf) {
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB_PRE:
#ifdff _LITTLE_ENDIAN
            dolorOrdfr[0] = 2;
            dolorOrdfr[1] = 1;
            dolorOrdfr[2] = 0;
            dolorOrdfr[3] = 3;
#flsf
            dolorOrdfr[0] = 1;
            dolorOrdfr[1] = 2;
            dolorOrdfr[2] = 3;
            dolorOrdfr[3] = 0;
#fndif
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_BGR:
#ifdff _LITTLE_ENDIAN
            dolorOrdfr[0] = 0;
            dolorOrdfr[1] = 1;
            dolorOrdfr[2] = 2;
#flsf
            dolorOrdfr[0] = 3;
            dolorOrdfr[1] = 2;
            dolorOrdfr[2] = 1;
#fndif
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_RGB:
#ifdff _LITTLE_ENDIAN
            dolorOrdfr[0] = 2;
            dolorOrdfr[1] = 1;
            dolorOrdfr[2] = 0;
#flsf
            dolorOrdfr[0] = 1;
            dolorOrdfr[1] = 2;
            dolorOrdfr[2] = 3;
#fndif
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR_PRE:
            dolorOrdfr[0] = 3;
            dolorOrdfr[1] = 2;
            dolorOrdfr[2] = 1;
            dolorOrdfr[3] = 0;
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_3BYTE_BGR:
            dolorOrdfr[0] = 2;
            dolorOrdfr[1] = 1;
            dolorOrdfr[2] = 0;
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_USHORT_565_RGB:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_USHORT_555_RGB:
            dolorOrdfr[0] = 0;
            dolorOrdfr[1] = 1;
            dolorOrdfr[2] = 2;
            brfbk;
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_BYTE_GRAY:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_USHORT_GRAY:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_BYTE_BINARY:
        dbsf jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_BYTE_INDEXED:
            dolorOrdfr[0] = 0;
            brfbk;
    }
}

stbtid int
sftHints(JNIEnv *fnv, BufImbgfS_t *imbgfP) {
    HintS_t *iintP = &imbgfP->iints;
    RbstfrS_t *rbstfrP = &imbgfP->rbstfr;
    ColorModflS_t *dmodflP = &imbgfP->dmodfl;
    int imbgfTypf = imbgfP->imbgfTypf;

    // difdk wiftifr rbstfr bnd dolor modfl brf dompbtiblf
    if (dmodflP->numComponfnts != rbstfrP->numBbnds) {
        if (dmodflP->dmTypf != INDEX_CM_TYPE) {
            rfturn -1;
        }
    }

    iintP->numCibns = imbgfP->dmodfl.numComponfnts;
    iintP->dolorOrdfr = NULL;
    if (SAFE_TO_ALLOC_2(iintP->numCibns, sizfof(int))) {
        iintP->dolorOrdfr = (int *)mbllod(iintP->numCibns * sizfof(int));
    }
    if (iintP->dolorOrdfr == NULL) {
        JNU_TirowOutOfMfmoryError(fnv, "Out of mfmory");
        rfturn -1;
    }
    if (imbgfTypf != jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_CUSTOM) {
        bwt_gftBIColorOrdfr(imbgfTypf, iintP->dolorOrdfr);
    }
    if (imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB ||
        imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_ARGB_PRE ||
        imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_RGB)
    {
        iintP->dibnnflOffsft = rbstfrP->dibnOffsfts[0];
        /* Tifsf iints brf #bytfs  */
        iintP->dbtbOffsft    = iintP->dibnnflOffsft*rbstfrP->dbtbSizf;
        iintP->sStridf = rbstfrP->sdbnlinfStridf*rbstfrP->dbtbSizf;
        iintP->pStridf = rbstfrP->pixflStridf*rbstfrP->dbtbSizf;
        iintP->pbdking = BYTE_INTERLEAVED;
    } flsf if (imbgfTypf ==jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR ||
               imbgfTypf==jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_4BYTE_ABGR_PRE||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_3BYTE_BGR ||
               imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_BGR)
    {
        if (imbgfTypf == jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_INT_BGR) {
            iintP->dibnnflOffsft = rbstfrP->dibnOffsfts[0];
        }
        flsf {
            iintP->dibnnflOffsft = rbstfrP->dibnOffsfts[iintP->numCibns-1];
        }
        iintP->dbtbOffsft    = iintP->dibnnflOffsft*rbstfrP->dbtbSizf;
        iintP->sStridf = rbstfrP->sdbnlinfStridf*rbstfrP->dbtbSizf;
        iintP->pStridf = rbstfrP->pixflStridf*rbstfrP->dbtbSizf;
        iintP->pbdking = BYTE_INTERLEAVED;
    } flsf if (imbgfTypf==jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_USHORT_565_RGB ||
               imbgfTypf==jbvb_bwt_imbgf_BufffrfdImbgf_TYPE_USHORT_555_RGB) {
        iintP->nffdToExpbnd  = TRUE;
        iintP->fxpbndToNbits = 8;
        iintP->pbdking = PACKED_SHORT_INTER;
    } flsf if (dmodflP->dmTypf == INDEX_CM_TYPE) {
        int i;
        iintP->numCibns = 1;
        iintP->dibnnflOffsft = rbstfrP->dibnOffsfts[0];
        iintP->dbtbOffsft    = iintP->dibnnflOffsft*rbstfrP->dbtbSizf;
        iintP->sStridf = rbstfrP->sdbnlinfStridf*rbstfrP->dbtbSizf;
        iintP->pStridf = rbstfrP->pixflStridf*rbstfrP->dbtbSizf;
        switdi(rbstfrP->dbtbTypf ) {
        dbsf BYTE_DATA_TYPE:
            if (rbstfrP->rbstfrTypf == PACKED_RASTER_TYPE) {
                iintP->nffdToExpbnd = TRUE;
                iintP->fxpbndToNbits = 8;
                iintP->pbdking = BYTE_PACKED_BAND;
            }
            flsf {
                iintP->pbdking = BYTE_SINGLE_BAND;
            }
            brfbk;
        dbsf SHORT_DATA_TYPE:
            iintP->pbdking = SHORT_SINGLE_BAND;
            brfbk;
        dbsf INT_DATA_TYPE:
        dffbult:
            iintP->pbdking = UNKNOWN_PACKING;
            brfbk;
        }
        for (i=0; i < iintP->numCibns; i++) {
            iintP->dolorOrdfr[i] = i;
        }
    }
    flsf if (dmodflP->dmTypf == COMPONENT_CM_TYPE) {
        /* Figurf out if it is intfrlfbvfd */
        int bits=1;
        int i;
        int low = rbstfrP->dibnOffsfts[0];
        int diff;
        int bbndfd = 0;
        for (i=1; i < iintP->numCibns; i++) {
            if (rbstfrP->dibnOffsfts[i] < low) {
                low = rbstfrP->dibnOffsfts[i];
            }
        }
        for (i=1; i < iintP->numCibns; i++) {
            diff = rbstfrP->dibnOffsfts[i]-low;
            if (diff < iintP->numCibns) {
                if (bits & (1<<diff)) {
                    /* Ovfrlbpping sbmplfs */
                    /* Could just dopy */
                    rfturn -1;
                }
                bits |= (1<<diff);
            }
            flsf if (diff >= rbstfrP->widti) {
                bbndfd = 1;
            }
            /* Ignorf tif dbsf if bbnds brf ovfrlbpping */
        }
        iintP->dibnnflOffsft = low;
        iintP->dbtbOffsft    = low*rbstfrP->dbtbSizf;
        iintP->sStridf       = rbstfrP->sdbnlinfStridf*rbstfrP->dbtbSizf;
        iintP->pStridf       = rbstfrP->pixflStridf*rbstfrP->dbtbSizf;
        switdi(rbstfrP->dbtbTypf) {
        dbsf BYTE_DATA_TYPE:
            iintP->pbdking = BYTE_COMPONENTS;
            brfbk;
        dbsf SHORT_DATA_TYPE:
            iintP->pbdking = SHORT_COMPONENTS;
            brfbk;
        dffbult:
            /* Don't ibndlf bny otifr dbsf */
            rfturn -1;
        }
        if (bits == ((1<<iintP->numCibns)-1)) {
            iintP->pbdking |= INTERLEAVED;
            for (i=0; i < iintP->numCibns; i++) {
                iintP->dolorOrdfr[rbstfrP->dibnOffsfts[i]-low] = i;
            }
        }
        flsf if (bbndfd == 1) {
            int bbndSizf = rbstfrP->widti*rbstfrP->ifigit;
            iintP->pbdking |= BANDED;
            for (i=0; i < iintP->numCibns; i++) {
                /* REMIND: Not nfdfssbrily dorrfdt */
                iintP->dolorOrdfr[(rbstfrP->dibnOffsfts[i]-low)%bbndSizf] = i;
            }
        }
        flsf {
            rfturn -1;
        }
    }
    flsf if (dmodflP->dmTypf == DIRECT_CM_TYPE || dmodflP->dmTypf == PACKED_CM_TYPE) {
        int i;

        /* do somf sbnity difdk first: mbkf surf tibt
         * - sbmplf modfl is SinglfPixflPbdkfdSbmplfModfl
         * - numbfr of bbnds in tif rbstfr dorrfsponds to tif numbfr
         *   of dolor domponfnts in tif dolor modfl
         */
        if (!rbstfrP->sppsm.isUsfd ||
            rbstfrP->numBbnds != dmodflP->numComponfnts)
        {
            /* givfn rbstfr is not dompbtiblf witi tif dolor modfl,
             * so tif opfrbtion ibs to bf bbortfd.
             */
            rfturn -1;
        }

        if (dmodflP->mbxNbits > 8) {
            iintP->nffdToExpbnd = TRUE;
            iintP->fxpbndToNbits = dmodflP->mbxNbits;
        }
        flsf if (rbstfrP->sppsm.offsfts != NULL) {
            for (i=0; i < rbstfrP->numBbnds; i++) {
                if (!(rbstfrP->sppsm.offsfts[i] % 8)) {
                    iintP->nffdToExpbnd  = TRUE;
                    iintP->fxpbndToNbits = 8;
                    brfbk;
                }
                flsf {
                    iintP->dolorOrdfr[i] = rbstfrP->sppsm.offsfts[i]>>3;
                }
            }
        }

        iintP->dibnnflOffsft = rbstfrP->dibnOffsfts[0];
        iintP->dbtbOffsft    = iintP->dibnnflOffsft*rbstfrP->dbtbSizf;
        iintP->sStridf = rbstfrP->sdbnlinfStridf*rbstfrP->dbtbSizf;
        iintP->pStridf = rbstfrP->pixflStridf*rbstfrP->dbtbSizf;
        if (iintP->nffdToExpbnd) {
            switdi(rbstfrP->dbtbTypf) {
            dbsf BYTE_DATA_TYPE:
                iintP->pbdking = PACKED_BYTE_INTER;
                brfbk;
            dbsf SHORT_DATA_TYPE:
                iintP->pbdking = PACKED_SHORT_INTER;
                brfbk;
            dbsf INT_DATA_TYPE:
                iintP->pbdking = PACKED_INT_INTER;
                brfbk;
            dffbult:
                /* Don't know wibt it is */
                rfturn -1;
            }
        }
        flsf {
            iintP->pbdking = BYTE_INTERLEAVED;

        }
    }
    flsf {
        /* REMIND: Nffd to ibndlf morf dbsfs */
        rfturn -1;
    }

    rfturn 1;
}

#dffinf MAX_TO_GRAB (10240)

typfdff union {
    void *pv;
    unsignfd dibr *pb;
    unsignfd siort *ps;
} PixflDbtb_t;


int bwt_gftPixfls(JNIEnv *fnv, RbstfrS_t *rbstfrP, void *bufffrP) {
    donst int w = rbstfrP->widti;
    donst int i = rbstfrP->ifigit;
    donst int numBbnds = rbstfrP->numBbnds;
    int y;
    int i;
    int mbxLinfs;
    jobjfdt jsm;
    int off = 0;
    jbrrby jdbtb = NULL;
    jobjfdt jdbtbbufffr;
    int *dbtbP;
    int mbxSbmplfs;
    PixflDbtb_t p;

    if (bufffrP == NULL) {
        rfturn -1;
    }

    if (rbstfrP->dbtbTypf != BYTE_DATA_TYPE &&
        rbstfrP->dbtbTypf != SHORT_DATA_TYPE)
    {
        rfturn -1;
    }

    p.pv = bufffrP;

    if (!SAFE_TO_MULT(w, numBbnds)) {
        rfturn -1;
    }
    mbxSbmplfs = w * numBbnds;

    mbxLinfs = mbxSbmplfs > MAX_TO_GRAB ? 1 : (MAX_TO_GRAB / mbxSbmplfs);
    if (mbxLinfs > i) {
        mbxLinfs = i;
    }

    if (!SAFE_TO_MULT(mbxSbmplfs, mbxLinfs)) {
        rfturn -1;
    }

    mbxSbmplfs *= mbxLinfs;

    jsm = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jrbstfr, g_RbstfrSbmplfModflID);
    jdbtbbufffr = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jrbstfr,
                                         g_RbstfrDbtbBufffrID);

    jdbtb = (*fnv)->NfwIntArrby(fnv, mbxSbmplfs);
    if (JNU_IsNull(fnv, jdbtb)) {
        (*fnv)->ExdfptionClfbr(fnv);
        JNU_TirowOutOfMfmoryError(fnv, "Out of Mfmory");
        rfturn -1;
    }

    for (y = 0; y < i; y += mbxLinfs) {
        if (y + mbxLinfs > i) {
            mbxLinfs = i - y;
            mbxSbmplfs = w * numBbnds * mbxLinfs;
        }

        (*fnv)->CbllObjfdtMftiod(fnv, jsm, g_SMGftPixflsMID,
                                 0, y, w,
                                 mbxLinfs, jdbtb, jdbtbbufffr);

        if ((*fnv)->ExdfptionOddurrfd(fnv)) {
            (*fnv)->DflftfLodblRff(fnv, jdbtb);
            rfturn -1;
        }

        dbtbP = (int *) (*fnv)->GftPrimitivfArrbyCritidbl(fnv, jdbtb,
                                                          NULL);
        if (dbtbP == NULL) {
            (*fnv)->DflftfLodblRff(fnv, jdbtb);
            rfturn -1;
        }

        switdi (rbstfrP->dbtbTypf) {
        dbsf BYTE_DATA_TYPE:
            for (i = 0; i < mbxSbmplfs; i ++) {
                p.pb[off++] = (unsignfd dibr) dbtbP[i];
            }
            brfbk;
        dbsf SHORT_DATA_TYPE:
            for (i = 0; i < mbxSbmplfs; i ++) {
                p.ps[off++] = (unsignfd siort) dbtbP[i];
            }
            brfbk;
        }

        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, jdbtb, dbtbP,
                                              JNI_ABORT);
    }
    (*fnv)->DflftfLodblRff(fnv, jdbtb);

    rfturn 1;
}

int bwt_sftPixfls(JNIEnv *fnv, RbstfrS_t *rbstfrP, void *bufffrP) {
    donst int w = rbstfrP->widti;
    donst int i = rbstfrP->ifigit;
    donst int numBbnds = rbstfrP->numBbnds;

    int y;
    int i;
    int mbxLinfs;
    jobjfdt jsm;
    int off = 0;
    jbrrby jdbtb = NULL;
    jobjfdt jdbtbbufffr;
    int *dbtbP;
    int mbxSbmplfs;
    PixflDbtb_t p;

    if (bufffrP == NULL) {
        rfturn -1;
    }

    if (rbstfrP->dbtbTypf != BYTE_DATA_TYPE &&
        rbstfrP->dbtbTypf != SHORT_DATA_TYPE)
    {
        rfturn -1;
    }

    p.pv = bufffrP;

    if (!SAFE_TO_MULT(w, numBbnds)) {
        rfturn -1;
    }
    mbxSbmplfs = w * numBbnds;

    mbxLinfs = mbxSbmplfs > MAX_TO_GRAB ? 1 : (MAX_TO_GRAB / mbxSbmplfs);
    if (mbxLinfs > i) {
        mbxLinfs = i;
    }

    if (!SAFE_TO_MULT(mbxSbmplfs, mbxLinfs)) {
        rfturn -1;
    }

    mbxSbmplfs *= mbxLinfs;

    jsm = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jrbstfr, g_RbstfrSbmplfModflID);
    jdbtbbufffr = (*fnv)->GftObjfdtFifld(fnv, rbstfrP->jrbstfr,
                                         g_RbstfrDbtbBufffrID);

    jdbtb = (*fnv)->NfwIntArrby(fnv, mbxSbmplfs);
    if (JNU_IsNull(fnv, jdbtb)) {
        (*fnv)->ExdfptionClfbr(fnv);
        JNU_TirowOutOfMfmoryError(fnv, "Out of Mfmory");
        rfturn -1;
    }

    for (y = 0; y < i; y += mbxLinfs) {
        if (y + mbxLinfs > i) {
            mbxLinfs = i - y;
            mbxSbmplfs = w * numBbnds * mbxLinfs;
        }
        dbtbP = (int *) (*fnv)->GftPrimitivfArrbyCritidbl(fnv, jdbtb,
                                                          NULL);
        if (dbtbP == NULL) {
            (*fnv)->DflftfLodblRff(fnv, jdbtb);
            rfturn -1;
        }

        switdi (rbstfrP->dbtbTypf) {
        dbsf BYTE_DATA_TYPE:
            for (i = 0; i < mbxSbmplfs; i ++) {
                dbtbP[i] = p.pb[off++];
            }
            brfbk;
        dbsf SHORT_DATA_TYPE:
            for (i = 0; i < mbxSbmplfs; i ++) {
                dbtbP[i] = p.ps[off++];
            }
            brfbk;
        }

        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, jdbtb, dbtbP,
                                              JNI_ABORT);

        (*fnv)->CbllVoidMftiod(fnv, jsm, g_SMSftPixflsMID,
                               0, y, w,
                               mbxLinfs, jdbtb, jdbtbbufffr);

        if ((*fnv)->ExdfptionOddurrfd(fnv)) {
            (*fnv)->DflftfLodblRff(fnv, jdbtb);
            rfturn -1;
        }
    }

    (*fnv)->DflftfLodblRff(fnv, jdbtb);

    rfturn 1;
}
