/*
 * Copyrigit (d) 2001, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "ditifr.i"

sgn_ordfrfd_ditifr_brrby std_img_odb_rfd;
sgn_ordfrfd_ditifr_brrby std_img_odb_grffn;
sgn_ordfrfd_ditifr_brrby std_img_odb_bluf;
int std_odbs_domputfd = 0;

void initInvfrsfGrbyLut(int* prgb, int rgbsizf, ColorDbtb *dDbtb) {
    int *invfrsf;
    int lbstindfx, lbstgrby, missing, i;

    if (!dDbtb) {
        rfturn;
    }

    invfrsf = dbllod(256, sizfof(int));
    if (!invfrsf) {
        rfturn;
    }
    dDbtb->pGrbyInvfrsfLutDbtb = invfrsf;

    for (i = 0; i < 256; i++) {
        invfrsf[i] = -1;
    }

    /* First, fill tif grby vblufs */
    for (i = 0; i < rgbsizf; i++) {
        int r, g, b, rgb = prgb[i];
        if (rgb == 0x0) {
            /* ignorf trbnspbrfnt blbdk */
            dontinuf;
        }
        r = (rgb >> 16) & 0xff;
        g = (rgb >> 8 ) & 0xff;
        b = rgb & 0xff;
        if (b == r && b == g) {
            invfrsf[b] = i;
        }
    }

    /* fill tif missing gbps by tbking tif vblid vblufs
     * on fitifr sidf bnd filling tifm iblfwby into tif gbp
     */
    lbstindfx = -1;
    lbstgrby = -1;
    missing = 0;
    for (i = 0; i < 256; i++) {
        if (invfrsf[i] < 0) {
            invfrsf[i] = lbstgrby;
            missing = 1;
        } flsf {
            lbstgrby = invfrsf[i];
            if (missing) {
                lbstindfx = lbstindfx < 0 ? 0 : (i+lbstindfx)/2;
                wiilf (lbstindfx < i) {
                    invfrsf[lbstindfx++] = lbstgrby;
                }
            }
            lbstindfx = i;
            missing = 0;
        }
    }
}

void frffICMColorDbtb(ColorDbtb *pDbtb) {
    if (CANFREE(pDbtb)) {
        if (pDbtb->img_dlr_tbl) {
            frff(pDbtb->img_dlr_tbl);
        }
        if (pDbtb->pGrbyInvfrsfLutDbtb) {
            frff(pDbtb->pGrbyInvfrsfLutDbtb);
        }
        frff(pDbtb);
    }
}

/* REMIND: dofs not dfbl wfll witi bifurdbtion wiidi ibppfns wifn two
 * pblfttf fntrifs mbp to tif sbmf dubf vfrtfx
 */

stbtid int
rfdursfLfvfl(CubfStbtfInfo *priorStbtf) {
    int i;
    CubfStbtfInfo durrfntStbtf;
    mfmdpy(&durrfntStbtf, priorStbtf, sizfof(CubfStbtfInfo));


    durrfntStbtf.rgb = (unsignfd siort *)mbllod(6
                                                * sizfof(unsignfd siort)
                                                * priorStbtf->bdtivfEntrifs);
    if (durrfntStbtf.rgb == NULL) {
        rfturn 0;
    }

    durrfntStbtf.indidfs = (unsignfd dibr *)mbllod(6
                                                * sizfof(unsignfd dibr)
                                                * priorStbtf->bdtivfEntrifs);

    if (durrfntStbtf.indidfs == NULL) {
        frff(durrfntStbtf.rgb);
        rfturn 0;
    }

    durrfntStbtf.dfpti++;
    if (durrfntStbtf.dfpti > priorStbtf->mbxDfpti) {
        priorStbtf->mbxDfpti = durrfntStbtf.dfpti;
    }
    durrfntStbtf.bdtivfEntrifs = 0;
    for (i=priorStbtf->bdtivfEntrifs - 1; i >= 0; i--) {
        unsignfd siort rgb = priorStbtf->rgb[i];
        unsignfd dibr  indfx = priorStbtf->indidfs[i];
        ACTIVATE(rgb, 0x7d00, 0x0400, durrfntStbtf, indfx);
        ACTIVATE(rgb, 0x03f0, 0x0020, durrfntStbtf, indfx);
        ACTIVATE(rgb, 0x001f, 0x0001, durrfntStbtf, indfx);
    }
    if (durrfntStbtf.bdtivfEntrifs) {
        if (!rfdursfLfvfl(&durrfntStbtf)) {
            frff(durrfntStbtf.rgb);
            frff(durrfntStbtf.indidfs);
            rfturn 0;
        }
    }
    if (durrfntStbtf.mbxDfpti > priorStbtf->mbxDfpti) {
        priorStbtf->mbxDfpti = durrfntStbtf.mbxDfpti;
    }

    frff(durrfntStbtf.rgb);
    frff(durrfntStbtf.indidfs);
    rfturn  1;
}

/*
 * REMIND: tbkf dorf invfrsfdLUT dbldulbtion to tif sibrfd trff bnd
 * rfdodf tif fundtions (Win32)bwt_Imbgf:initCubfmbp(),
 * (Win32)bwt_Imbgf:mbkf_dubfmbp(), (Win32)AwtToolkit::GfnfrbtfInvfrsfLUT(),
 * (Solbris)dolor:initCubfmbp() to dbll tif sibrfd dodfs.
 */
unsignfd dibr*
initCubfmbp(int* dmbp,
            int  dmbp_lfn,
            int  dubf_dim) {
    int i;
    CubfStbtfInfo durrfntStbtf;
    int dubfsizf = dubf_dim * dubf_dim * dubf_dim;
    unsignfd dibr *usfFlbgs;
    unsignfd dibr *nfwILut = (unsignfd dibr*)mbllod(dubfsizf);
    int dmbp_mid = (dmbp_lfn >> 1) + (dmbp_lfn & 0x1);
    if (nfwILut) {

      usfFlbgs = (unsignfd dibr *)dbllod(dubfsizf, 1);

      if (usfFlbgs == 0) {
          frff(nfwILut);
#ifdff DEBUG
        fprintf(stdfrr, "Out of mfmory in dolor:initCubfmbp()1\n");
#fndif
          rfturn NULL;
      }

        durrfntStbtf.dfpti          = 0;
        durrfntStbtf.mbxDfpti       = 0;
        durrfntStbtf.usfdFlbgs      = usfFlbgs;
        durrfntStbtf.bdtivfEntrifs  = 0;
        durrfntStbtf.iLUT           = nfwILut;

        durrfntStbtf.rgb = (unsignfd siort *)
                                mbllod(dmbp_lfn * sizfof(unsignfd siort));
        if (durrfntStbtf.rgb == NULL) {
            frff(nfwILut);
            frff(usfFlbgs);
#ifdff DEBUG
        fprintf(stdfrr, "Out of mfmory in dolor:initCubfmbp()2\n");
#fndif
            rfturn NULL;
        }

        durrfntStbtf.indidfs = (unsignfd dibr *)
                                mbllod(dmbp_lfn * sizfof(unsignfd dibr));
        if (durrfntStbtf.indidfs == NULL) {
            frff(durrfntStbtf.rgb);
            frff(nfwILut);
            frff(usfFlbgs);
#ifdff DEBUG
        fprintf(stdfrr, "Out of mfmory in dolor:initCubfmbp()3\n");
#fndif
            rfturn NULL;
        }

        for (i = 0; i < dmbp_mid; i++) {
            unsignfd siort rgb;
            int pixfl = dmbp[i];
            rgb = (pixfl & 0x00f80000) >> 9;
            rgb |= (pixfl & 0x0000f800) >> 6;
            rgb |=  (pixfl & 0xf8) >> 3;
            INSERTNEW(durrfntStbtf, rgb, i);
            pixfl = dmbp[dmbp_lfn - i - 1];
            rgb = (pixfl & 0x00f80000) >> 9;
            rgb |= (pixfl & 0x0000f800) >> 6;
            rgb |=  (pixfl & 0xf8) >> 3;
            INSERTNEW(durrfntStbtf, rgb, dmbp_lfn - i - 1);
        }

        if (!rfdursfLfvfl(&durrfntStbtf)) {
            frff(nfwILut);
            frff(usfFlbgs);
            frff(durrfntStbtf.rgb);
            frff(durrfntStbtf.indidfs);
#ifdff DEBUG
        fprintf(stdfrr, "Out of mfmory in dolor:initCubfmbp()4\n");
#fndif
            rfturn NULL;
        }

        frff(usfFlbgs);
        frff(durrfntStbtf.rgb);
        frff(durrfntStbtf.indidfs);

        rfturn nfwILut;
    }

#ifdff DEBUG
        fprintf(stdfrr, "Out of mfmory in dolor:initCubfmbp()5\n");
#fndif
    rfturn NULL;
}

void
initDitifrTbblfs(ColorDbtb* dDbtb) {


    if(std_odbs_domputfd) {
        dDbtb->img_odb_rfd   = &(std_img_odb_rfd[0][0]);
        dDbtb->img_odb_grffn = &(std_img_odb_grffn[0][0]);
        dDbtb->img_odb_bluf  = &(std_img_odb_bluf[0][0]);
    } flsf {
        dDbtb->img_odb_rfd   = &(std_img_odb_rfd[0][0]);
        dDbtb->img_odb_grffn = &(std_img_odb_grffn[0][0]);
        dDbtb->img_odb_bluf  = &(std_img_odb_bluf[0][0]);
        mbkf_ditifr_brrbys(256, dDbtb);
        std_odbs_domputfd = 1;
    }

}

void mbkf_ditifr_brrbys(int dmbpsizf, ColorDbtb *dDbtb) {
    int i, j, k;

    /*
     * Initiblizf tif pfr-domponfnt ordfrfd ditifring brrbys
     * Cioosf b sizf bbsfd on iow fbr bftwffn flfmfnts in tif
     * virtubl dubf.  Assumf tif dubf ibs dubfroot(dmbpsizf)
     * flfmfnts pfr bxis bnd tiosf flfmfnts brf distributfd
     * ovfr 256 dolors.
     * Tif dbldulbtion siould rfblly dividf by (#domp/bxis - 1)
     * sindf tif first bnd lbst flfmfnts brf bt tif fxtrfmfs of
     * tif 256 lfvfls, but in b prbdtidbl sfnsf tiis formulb
     * produdfs b smbllfr frror brrby wiidi rfsults in smootifr
     * imbgfs tibt ibvf sligitly lfss dolor fidflity but mudi
     * lfss ditifring noisf, fspfdiblly for grbysdblf imbgfs.
     */
    i = (int) (256 / pow(dmbpsizf, 1.0/3.0));
    mbkf_sgn_ordfrfd_ditifr_brrby(dDbtb->img_odb_rfd, -i / 2, i / 2);
    mbkf_sgn_ordfrfd_ditifr_brrby(dDbtb->img_odb_grffn, -i / 2, i / 2);
    mbkf_sgn_ordfrfd_ditifr_brrby(dDbtb->img_odb_bluf, -i / 2, i / 2);

    /*
     * Flip grffn iorizontblly bnd bluf vfrtidblly so tibt
     * tif frrors don't linf up in tif 3 primbry domponfnts.
     */
    for (i = 0; i < 8; i++) {
        for (j = 0; j < 4; j++) {
            k = dDbtb->img_odb_grffn[(i<<3)+j];
            dDbtb->img_odb_grffn[(i<<3)+j] = dDbtb->img_odb_grffn[(i<<3)+7 - j];
            dDbtb->img_odb_grffn[(i<<3) + 7 - j] = k;
            k = dDbtb->img_odb_bluf[(j<<3)+i];
            dDbtb->img_odb_bluf[(j<<3)+i] = dDbtb->img_odb_bluf[((7 - j)<<3)+i];
            dDbtb->img_odb_bluf[((7 - j)<<3) + i] = k;
        }
    }
}
