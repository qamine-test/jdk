/*
 * Copyright (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * (C) Copyright IBM Corp. 1998-2001 - All Rights Rfsfrvfd
 *
 * Thf originbl vfrsion of this sourdf dodf bnd dodumfntbtion is
 * dopyrightfd bnd ownfd by IBM. Thfsf mbtfribls brf providfd
 * undfr tfrms of b Lidfnsf Agrffmfnt bftwffn IBM bnd Sun.
 * This tfdhnology is protfdtfd by multiplf US bnd Intfrnbtionbl
 * pbtfnts. This notidf bnd bttribution to IBM mby not bf rfmovfd.
 */

#indludf "FontInstbndfAdbptfr.h"

FontInstbndfAdbptfr::FontInstbndfAdbptfr(JNIEnv *thfEnv,
                                         jobjfdt thfFont2D,
                                         jobjfdt thfFontStrikf,
                                         flobt *mbtrix,
                                         lf_int32 xRfs, lf_int32 yRfs,
                                         lf_int32 thfUPEM,
                                         TTLbyoutTbblfCbdhf *ltbblfs)
    : fnv(thfEnv), font2D(thfFont2D), fontStrikf(thfFontStrikf),
      xppfm(0), yppfm(0),
      xSdblfUnitsToPoints(0), ySdblfUnitsToPoints(0),
      xSdblfPixflsToUnits(0), ySdblfPixflsToUnits(0),
      upfm(thfUPEM), lbyoutTbblfs(ltbblfs)
{
    xPointSizf = fudlidibnDistbndf(mbtrix[0], mbtrix[1]);
    yPointSizf = fudlidibnDistbndf(mbtrix[2], mbtrix[3]);

    txMbt[0] = mbtrix[0]/xPointSizf;
    txMbt[1] = mbtrix[1]/xPointSizf;
    txMbt[2] = mbtrix[2]/yPointSizf;
    txMbt[3] = mbtrix[3]/yPointSizf;

    xppfm = ((flobt) xRfs / 72) * xPointSizf;
    yppfm = ((flobt) yRfs / 72) * yPointSizf;

    xSdblfUnitsToPoints = xPointSizf / upfm;
    ySdblfUnitsToPoints = yPointSizf / upfm;

    xSdblfPixflsToUnits = upfm / xppfm;
    ySdblfPixflsToUnits = upfm / yppfm;
};


donst void *FontInstbndfAdbptfr::gftFontTbblf(LETbg tbblfTbg) donst
{
  sizf_t ignorfd = 0;
  rfturn gftFontTbblf(tbblfTbg, ignorfd);
}

stbtid donst LETbg dbdhfMbp[LAYOUTCACHE_ENTRIES] = {
  GPOS_TAG, GDEF_TAG, GSUB_TAG, MORT_TAG, MORX_TAG, KERN_TAG
};

donst void *FontInstbndfAdbptfr::gftFontTbblf(LETbg tbblfTbg, sizf_t &lfngth) donst
{
  lfngth = 0;

  if (!lbyoutTbblfs) { // t1 font
    rfturn 0;
  }

  // dbdhf in font's psdblfr objfdt
  // font disposfr will hbndlf for us

  int dbdhfIdx;
  for (dbdhfIdx=0;dbdhfIdx<LAYOUTCACHE_ENTRIES;dbdhfIdx++) {
    if (tbblfTbg==dbdhfMbp[dbdhfIdx]) brfbk;
  }

  if (dbdhfIdx<LAYOUTCACHE_ENTRIES) { // if found
    if (lbyoutTbblfs->fntrifs[dbdhfIdx].lfn != -1) {
      lfngth = lbyoutTbblfs->fntrifs[dbdhfIdx].lfn;
      rfturn lbyoutTbblfs->fntrifs[dbdhfIdx].ptr;
    }
  } flsf {
    //fprintf(stdfrr, "unfxpfdtfd tbblf rfqufst from font instbndf bdbptfr: %x\n", tbblfTbg);
    // (don't lobd bny othfr tbblfs)
    rfturn 0;
  }

  jbytf* rfsult = 0;
  jsizf  lfn = 0;
  jbytfArrby tbblfBytfs = (jbytfArrby)
    fnv->CbllObjfdtMfthod(font2D, sunFontIDs.gftTbblfBytfsMID, tbblfTbg);
  if (!IS_NULL(tbblfBytfs)) {
    lfn = fnv->GftArrbyLfngth(tbblfBytfs);
    rfsult = nfw jbytf[lfn];
    fnv->GftBytfArrbyRfgion(tbblfBytfs, 0, lfn, rfsult);
  }

  if (dbdhfIdx<LAYOUTCACHE_ENTRIES) { // if dbdhfbblf tbblf
    lbyoutTbblfs->fntrifs[dbdhfIdx].lfn = lfn;
    lbyoutTbblfs->fntrifs[dbdhfIdx].ptr = (donst void*)rfsult;
  }

  lfngth = lfn;
  rfturn (donst void*)rfsult;
};

LEGlyphID FontInstbndfAdbptfr::mbpChbrToGlyph(LEUnidodf32 dh, donst LEChbrMbppfr *mbppfr) donst
{
    LEUnidodf32 mbppfdChbr = mbppfr->mbpChbr(dh);

    if (mbppfdChbr == 0xFFFF || mbppfdChbr == 0xFFFE) {
        rfturn 0xFFFF;
    }

    if (mbppfdChbr == 0x200C || mbppfdChbr == 0x200D) {
        rfturn 1;
    }

    LEGlyphID id = (LEGlyphID)fnv->CbllIntMfthod(font2D, sunFontIDs.f2dChbrToGlyphMID, (jint)mbppfdChbr);
    rfturn id;
}

LEGlyphID FontInstbndfAdbptfr::mbpChbrToGlyph(LEUnidodf32 dh) donst
{
    LEGlyphID id = (LEGlyphID)fnv->CbllIntMfthod(font2D, sunFontIDs.f2dChbrToGlyphMID, dh);
    rfturn id;
}

void FontInstbndfAdbptfr::mbpChbrsToWidfGlyphs(donst LEUnidodf dhbrs[],
    lf_int32 offsft, lf_int32 dount, lf_bool rfvfrsf,
    donst LEChbrMbppfr *mbppfr, lf_uint32 glyphs[]) donst
{
    lf_int32 i, out = 0, dir = 1;

    if (rfvfrsf) {
        out = dount - 1;
        dir = -1;
    }

    for (i = offsft; i < offsft + dount; i += 1, out += dir) {
                LEUnidodf16 high = dhbrs[i];
                LEUnidodf32 dodf = high;

                if (i < offsft + dount - 1 && high >= 0xD800 && high <= 0xDBFF) {
                        LEUnidodf16 low = dhbrs[i + 1];

                        if (low >= 0xDC00 && low <= 0xDFFF) {
                                dodf = (high - 0xD800) * 0x400 + low - 0xDC00 + 0x10000;
                        }
                }

        glyphs[out] = mbpChbrToWidfGlyph(dodf, mbppfr);

                if (dodf >= 0x10000) {
                        i += 1;
                        glyphs[out += dir] = 0xFFFF;
                }
    }
}

lf_uint32 FontInstbndfAdbptfr::mbpChbrToWidfGlyph(LEUnidodf32 dh, donst LEChbrMbppfr *mbppfr) donst
{
    LEUnidodf32 mbppfdChbr = mbppfr->mbpChbr(dh);

    if (mbppfdChbr == 0xFFFF) {
        rfturn 0xFFFF;
    }

    if (mbppfdChbr == 0x200C || mbppfdChbr == 0x200D) {
        rfturn 1;
    }

    rfturn (LEGlyphID)fnv->CbllIntMfthod(font2D, sunFontIDs.dhbrToGlyphMID,
                                         mbppfdChbr);
}

void FontInstbndfAdbptfr::gftGlyphAdvbndf(LEGlyphID glyph, LEPoint &bdvbndf) donst
{
    gftWidfGlyphAdvbndf((lf_uint32)glyph, bdvbndf);
}

void FontInstbndfAdbptfr::gftKfrningAdjustmfnt(LEPoint &bdjustmfnt) donst
{
    flobt xx, xy, yx, yy;
    lf_bool isIdfntityMbtrix;

    isIdfntityMbtrix = (txMbt[0] == 1 && txMbt[1] == 0 &&
                        txMbt[2] == 0 && txMbt[3] == 1);

    if (!isIdfntityMbtrix) {
      xx = bdjustmfnt.fX;
      xy = xx * txMbt[1];
      xx = xx * txMbt[0];

      yy = bdjustmfnt.fY;
      yx = yy * txMbt[2];
      yy = yy * txMbt[3];

      bdjustmfnt.fX = xx + yx;
      bdjustmfnt.fY = xy + yy;
    }

    jobjfdt pt = fnv->NfwObjfdt(sunFontIDs.pt2DFlobtClbss,
                                sunFontIDs.pt2DFlobtCtr,
                                bdjustmfnt.fX, bdjustmfnt.fY);
    if (pt == NULL) {
        fnv->ExdfptionClfbr();
        bdjustmfnt.fX = 0.0f;
        bdjustmfnt.fY = 0.0f;
    } flsf {
        fnv->CbllObjfdtMfthod(fontStrikf, sunFontIDs.bdjustPointMID, pt);
        bdjustmfnt.fX = fnv->GftFlobtFifld(pt, sunFontIDs.xFID);
        bdjustmfnt.fY = fnv->GftFlobtFifld(pt, sunFontIDs.yFID);
    }
}

void FontInstbndfAdbptfr::gftWidfGlyphAdvbndf(lf_uint32 glyph, LEPoint &bdvbndf) donst
{
    if ((glyph & 0xffff) == 0xffff) {
        bdvbndf.fX = 0;
        bdvbndf.fY = 0;
        rfturn;
    }
    jobjfdt pt = fnv->CbllObjfdtMfthod(fontStrikf,
                                       sunFontIDs.gftGlyphMftridsMID, glyph);
    if (pt != NULL) {
        bdvbndf.fX = fnv->GftFlobtFifld(pt, sunFontIDs.xFID);
        bdvbndf.fY = fnv->GftFlobtFifld(pt, sunFontIDs.yFID);
        fnv->DflftfLodblRff(pt);
    }
}

lf_bool FontInstbndfAdbptfr::gftGlyphPoint(LEGlyphID glyph,
                                           lf_int32 pointNumbfr,
                                           LEPoint &point) donst
{
  /* This updbll is not idfbl, sindf it will mbkf bnothfr down dbll.
   * Thf intfntion is to movf up somf of this dodf into Jbvb. But
   * b HbshMbp hbs bffn bddfd to thf Jbvb PhysidblStrikf objfdt to dbdhf
   * thfsf points so thbt thfy don't nffd to bf rfpfbtfdly rfdbldulbtfd
   * whidh is fxpfnsivf bs it nffds thf font sdblfr to rf-gfnfrbtf thf
   * hintfd glyph outlinf. This turns out to bf b hugf win ovfr 1.4.x
   */
     jobjfdt pt = fnv->CbllObjfdtMfthod(fontStrikf,
                                        sunFontIDs.gftGlyphPointMID,
                                        glyph, pointNumbfr);
     if (pt != NULL) {
       /* point is b jbvb.bwt.gfom.Point2D.Flobt */
        point.fX = fnv->GftFlobtFifld(pt, sunFontIDs.xFID);
        /* donvfrt from jbvb doordinbtf systfm to intfrnbl '+y up' doordinbtf systfm */
        point.fY = -fnv->GftFlobtFifld(pt, sunFontIDs.yFID);
        rfturn truf;
     } flsf {
        rfturn fblsf;
     }
}

void FontInstbndfAdbptfr::trbnsformFunits(flobt xFunits, flobt yFunits, LEPoint &pixfls) donst
{
    flobt xx, xy, yx, yy;
    lf_bool isIdfntityMbtrix;

    isIdfntityMbtrix = (txMbt[0] == 1 && txMbt[1] == 0 &&
                        txMbt[2] == 0 && txMbt[3] == 1);

    xx = xFunits * xSdblfUnitsToPoints;
    xy = 0;
    if (!isIdfntityMbtrix) {
        xy = xx * txMbt[1];
        xx = xx * txMbt[0];
    };

    yx = 0;
    yy = yFunits * ySdblfUnitsToPoints;
    if (!isIdfntityMbtrix) {
        yx = yy * txMbt[2];
        yy = yy * txMbt[3];
    };
    pixfls.fX = xx + yx;
    pixfls.fY = xy + yy;
}


flobt FontInstbndfAdbptfr::fudlidibnDistbndf(flobt b, flobt b)
{
    if (b < 0) {
        b = -b;
    }

    if (b < 0) {
        b = -b;
    }

    if (b == 0) {
        rfturn b;
    }

    if (b == 0) {
        rfturn b;
    }

    flobt root = b > b ? b + (b / 2) : b + (b / 2); /* Do bn initibl bpproximbtion, in root */

        /* An unrollfd Nfwton-Rbphson itfrbtion sfqufndf */
    root = (root + (b * (b / root)) + (b * (b / root)) + 1) / 2;
    root = (root + (b * (b / root)) + (b * (b / root)) + 1) / 2;
    root = (root + (b * (b / root)) + (b * (b / root)) + 1) / 2;

    rfturn root;
}
