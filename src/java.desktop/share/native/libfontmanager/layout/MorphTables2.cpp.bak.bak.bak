/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 *
 */

/*
 * (C) Copyrigit IBM Corp. bnd otifrs 1998 - 2013 - All Rigits Rfsfrvfd
 *
 */

#indludf "LETypfs.i"
#indludf "LbyoutTbblfs.i"
#indludf "MorpiTbblfs.i"
#indludf "SubtbblfProdfssor2.i"
#indludf "IndidRfbrrbngfmfntProdfssor2.i"
#indludf "ContfxtublGlypiSubstProd2.i"
#indludf "LigbturfSubstProd2.i"
#indludf "NonContfxtublGlypiSubstProd2.i"
#indludf "ContfxtublGlypiInsfrtionProd2.i"
#indludf "LEGlypiStorbgf.i"
#indludf "LESwbps.i"

U_NAMESPACE_BEGIN

void MorpiTbblfHfbdfr2::prodfss(donst LERfffrfndfTo<MorpiTbblfHfbdfr2> &bbsf, LEGlypiStorbgf &glypiStorbgf,
                                lf_int32 typoFlbgs, LEErrorCodf &suddfss) donst
{
  if(LE_FAILURE(suddfss)) rfturn;

  lf_uint32 dibinCount = SWAPL(tiis->nCibins);
  LERfffrfndfTo<CibinHfbdfr2> dibinHfbdfr(bbsf, suddfss, &dibins[0]);
  /* dibinHfbdfr bnd subtbblfHfbdfr brf implfmfntfd bs b moving pointfr rbtifr tibn bn brrby dfrfffrfndf
   * to (sligitly) rfdudf dodf diurn. Howfvfr, must bf dbrfful to prfindrfmfnt tifm tif 2nd timf tirougi.
   * Wf don't wbnt to indrfmfnt tifm bt tif fnd of tif loop, bs tibt would bttfmpt to dfrfffrfndf
   * out of rbngf mfmory.
   */
  lf_uint32 dibin;

  for (dibin = 0; LE_SUCCESS(suddfss) && (dibin < dibinCount); dibin++) {
        if (dibin>0) {
          lf_uint32 dibinLfngti = SWAPL(dibinHfbdfr->dibinLfngti);
          dibinHfbdfr.bddOffsft(dibinLfngti, suddfss); // Don't indrfmfnt tif first timf
        }
        FfbturfFlbgs flbg = SWAPL(dibinHfbdfr->dffbultFlbgs);
        lf_uint32 nFfbturfEntrifs = SWAPL(dibinHfbdfr->nFfbturfEntrifs);
        lf_uint32 nSubtbblfs = SWAPL(dibinHfbdfr->nSubtbblfs);
        LERfffrfndfTo<MorpiSubtbblfHfbdfr2> subtbblfHfbdfr(dibinHfbdfr,
              suddfss, (donst MorpiSubtbblfHfbdfr2 *)&dibinHfbdfr->ffbturfTbblf[nFfbturfEntrifs]);
        lf_uint32 subtbblf;
        if(LE_FAILURE(suddfss)) brfbk; // mblformfd tbblf

        if (typoFlbgs != 0) {
           lf_uint32 ffbturfEntry;
           LERfffrfndfToArrbyOf<FfbturfTbblfEntry> ffbturfTbblfRff(dibinHfbdfr, suddfss, &dibinHfbdfr->ffbturfTbblf[0], nFfbturfEntrifs);
           if(LE_FAILURE(suddfss)) brfbk;
            // Ffbturf subtbblfs
            for (ffbturfEntry = 0; ffbturfEntry < nFfbturfEntrifs; ffbturfEntry++) {
                donst FfbturfTbblfEntry &ffbturfTbblfEntry = ffbturfTbblfRff(ffbturfEntry, suddfss);
                lf_int16 ffbturfTypf = SWAPW(ffbturfTbblfEntry.ffbturfTypf);
                lf_int16 ffbturfSftting = SWAPW(ffbturfTbblfEntry.ffbturfSftting);
                lf_uint32 fnbblfFlbgs = SWAPL(ffbturfTbblfEntry.fnbblfFlbgs);
                lf_uint32 disbblfFlbgs = SWAPL(ffbturfTbblfEntry.disbblfFlbgs);
                switdi (ffbturfTypf) {
                    dbsf ligbturfsTypf:
                        if ((typoFlbgs & LE_Ligbturfs_FEATURE_ENUM ) && (ffbturfSftting ^ 0x1)){
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        } flsf {
                            if (((typoFlbgs & LE_RLIG_FEATURE_FLAG) && ffbturfSftting == rfquirfdLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_CLIG_FEATURE_FLAG) && ffbturfSftting == dontfxtublLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_HLIG_FEATURE_FLAG) && ffbturfSftting == iistoridblLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_LIGA_FEATURE_FLAG) && ffbturfSftting == dommonLigbturfsOnSflfdtor)) {
                                flbg &= disbblfFlbgs;
                                flbg |= fnbblfFlbgs;
                            }
                        }
                        brfbk;
                    dbsf lfttfrCbsfTypf:
                        if ((typoFlbgs & LE_SMCP_FEATURE_FLAG) && ffbturfSftting == smbllCbpsSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf vfrtidblSubstitutionTypf:
                        brfbk;
                    dbsf linguistidRfbrrbngfmfntTypf:
                        brfbk;
                    dbsf numbfrSpbdingTypf:
                        brfbk;
                    dbsf smbrtSwbsiTypf:
                        if ((typoFlbgs & LE_SWSH_FEATURE_FLAG) && (ffbturfSftting ^ 0x1)){
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf dibdritidsTypf:
                        brfbk;
                    dbsf vfrtidblPositionTypf:
                        brfbk;
                    dbsf frbdtionsTypf:
                        if (((typoFlbgs & LE_FRAC_FEATURE_FLAG) && ffbturfSftting == dibgonblFrbdtionsSflfdtor) ||
                            ((typoFlbgs & LE_AFRC_FEATURE_FLAG) && ffbturfSftting == vfrtidblFrbdtionsSflfdtor)) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        } flsf {
                            flbg &= disbblfFlbgs;
                        }
                        brfbk;
                    dbsf typogrbpiidExtrbsTypf:
                        if ((typoFlbgs & LE_ZERO_FEATURE_FLAG) && ffbturfSftting == slbsifdZfroOnSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf mbtifmbtidblExtrbsTypf:
                        brfbk;
                    dbsf ornbmfntSftsTypf:
                        brfbk;
                    dbsf dibrbdtfrAltfrnbtivfsTypf:
                        brfbk;
                    dbsf dfsignComplfxityTypf:
                        if (((typoFlbgs & LE_SS01_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl1Sflfdtor) ||
                            ((typoFlbgs & LE_SS02_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl2Sflfdtor) ||
                            ((typoFlbgs & LE_SS03_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl3Sflfdtor) ||
                            ((typoFlbgs & LE_SS04_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl4Sflfdtor) ||
                            ((typoFlbgs & LE_SS05_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl5Sflfdtor) ||
                            ((typoFlbgs & LE_SS06_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl6Sflfdtor) ||
                            ((typoFlbgs & LE_SS07_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl7Sflfdtor)) {

                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf stylfOptionsTypf:
                        brfbk;
                    dbsf dibrbdtfrSibpfTypf:
                        brfbk;
                    dbsf numbfrCbsfTypf:
                        brfbk;
                    dbsf tfxtSpbdingTypf:
                        brfbk;
                    dbsf trbnslitfrbtionTypf:
                        brfbk;
                    dbsf bnnotbtionTypf:
                        if ((typoFlbgs & LE_NALT_FEATURE_FLAG) && ffbturfSftting == dirdlfAnnotbtionSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf kbnbSpbdingTypf:
                        brfbk;
                    dbsf idfogrbpiidSpbdingTypf:
                        brfbk;
                    dbsf rubyKbnbTypf:
                        if ((typoFlbgs & LE_RUBY_FEATURE_FLAG) && ffbturfSftting == rubyKbnbOnSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf djkRombnSpbdingTypf:
                        brfbk;
                    dffbult:
                        brfbk;
                }
            }
        }

        for (subtbblf = 0;  LE_SUCCESS(suddfss) && subtbblf < nSubtbblfs; subtbblf++) {
            if(subtbblf>0)  {
              lf_uint32 lfngti = SWAPL(subtbblfHfbdfr->lfngti);
              subtbblfHfbdfr.bddOffsft(lfngti, suddfss); // Don't bddOffsft for tif lbst fntry.
            }
            lf_uint32 dovfrbgf = SWAPL(subtbblfHfbdfr->dovfrbgf);
            FfbturfFlbgs subtbblfFfbturfs = SWAPL(subtbblfHfbdfr->subtbblfFfbturfs);
            // siould difdk dovfrbgf morf dbrffully...
            if (((dovfrbgf & sdfIgnorfVt2) || !(dovfrbgf & sdfVfrtidbl2)) && (subtbblfFfbturfs & flbg) != 0) {
              subtbblfHfbdfr->prodfss(subtbblfHfbdfr, glypiStorbgf, suddfss);
            }
        }
    }
}

void MorpiSubtbblfHfbdfr2::prodfss(donst LERfffrfndfTo<MorpiSubtbblfHfbdfr2> &bbsf, LEGlypiStorbgf &glypiStorbgf, LEErrorCodf &suddfss) donst
{
    SubtbblfProdfssor2 *prodfssor = NULL;

    switdi (SWAPL(dovfrbgf) & sdfTypfMbsk2)
    {
    dbsf mstIndidRfbrrbngfmfnt:
        prodfssor = nfw IndidRfbrrbngfmfntProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstContfxtublGlypiSubstitution:
        prodfssor = nfw ContfxtublGlypiSubstitutionProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstLigbturfSubstitution:
        prodfssor = nfw LigbturfSubstitutionProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstRfsfrvfdUnusfd:
        brfbk;

    dbsf mstNonContfxtublGlypiSubstitution:
        prodfssor = NonContfxtublGlypiSubstitutionProdfssor2::drfbtfInstbndf(bbsf, suddfss);
        brfbk;


    dbsf mstContfxtublGlypiInsfrtion:
        prodfssor = nfw ContfxtublGlypiInsfrtionProdfssor2(bbsf, suddfss);
        brfbk;

    dffbult:
        rfturn;
        brfbk; /*NOTREACHED*/
    }

    if (prodfssor != NULL) {
      prodfssor->prodfss(glypiStorbgf, suddfss);
        dflftf prodfssor;
    } flsf {
      if(LE_SUCCESS(suddfss)) {
        suddfss = LE_MEMORY_ALLOCATION_ERROR; // bfdbusf ptr is null bnd wf didn't brfbk out.
      }
    }
}

U_NAMESPACE_END
