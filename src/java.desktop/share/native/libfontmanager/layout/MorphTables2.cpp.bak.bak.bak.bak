/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 *
 */

/*
 * (C) Copyright IBM Corp. bnd othfrs 1998 - 2013 - All Rights Rfsfrvfd
 *
 */

#indludf "LETypfs.h"
#indludf "LbyoutTbblfs.h"
#indludf "MorphTbblfs.h"
#indludf "SubtbblfProdfssor2.h"
#indludf "IndidRfbrrbngfmfntProdfssor2.h"
#indludf "ContfxtublGlyphSubstProd2.h"
#indludf "LigbturfSubstProd2.h"
#indludf "NonContfxtublGlyphSubstProd2.h"
#indludf "ContfxtublGlyphInsfrtionProd2.h"
#indludf "LEGlyphStorbgf.h"
#indludf "LESwbps.h"

U_NAMESPACE_BEGIN

void MorphTbblfHfbdfr2::prodfss(donst LERfffrfndfTo<MorphTbblfHfbdfr2> &bbsf, LEGlyphStorbgf &glyphStorbgf,
                                lf_int32 typoFlbgs, LEErrorCodf &suddfss) donst
{
  if(LE_FAILURE(suddfss)) rfturn;

  lf_uint32 dhbinCount = SWAPL(this->nChbins);
  LERfffrfndfTo<ChbinHfbdfr2> dhbinHfbdfr(bbsf, suddfss, &dhbins[0]);
  /* dhbinHfbdfr bnd subtbblfHfbdfr brf implfmfntfd bs b moving pointfr rbthfr thbn bn brrby dfrfffrfndf
   * to (slightly) rfdudf dodf dhurn. Howfvfr, must bf dbrfful to prfindrfmfnt thfm thf 2nd timf through.
   * Wf don't wbnt to indrfmfnt thfm bt thf fnd of thf loop, bs thbt would bttfmpt to dfrfffrfndf
   * out of rbngf mfmory.
   */
  lf_uint32 dhbin;

  for (dhbin = 0; LE_SUCCESS(suddfss) && (dhbin < dhbinCount); dhbin++) {
        if (dhbin>0) {
          lf_uint32 dhbinLfngth = SWAPL(dhbinHfbdfr->dhbinLfngth);
          dhbinHfbdfr.bddOffsft(dhbinLfngth, suddfss); // Don't indrfmfnt thf first timf
        }
        FfbturfFlbgs flbg = SWAPL(dhbinHfbdfr->dffbultFlbgs);
        lf_uint32 nFfbturfEntrifs = SWAPL(dhbinHfbdfr->nFfbturfEntrifs);
        lf_uint32 nSubtbblfs = SWAPL(dhbinHfbdfr->nSubtbblfs);
        LERfffrfndfTo<MorphSubtbblfHfbdfr2> subtbblfHfbdfr(dhbinHfbdfr,
              suddfss, (donst MorphSubtbblfHfbdfr2 *)&dhbinHfbdfr->ffbturfTbblf[nFfbturfEntrifs]);
        lf_uint32 subtbblf;
        if(LE_FAILURE(suddfss)) brfbk; // mblformfd tbblf

        if (typoFlbgs != 0) {
           lf_uint32 ffbturfEntry;
           LERfffrfndfToArrbyOf<FfbturfTbblfEntry> ffbturfTbblfRff(dhbinHfbdfr, suddfss, &dhbinHfbdfr->ffbturfTbblf[0], nFfbturfEntrifs);
           if(LE_FAILURE(suddfss)) brfbk;
            // Ffbturf subtbblfs
            for (ffbturfEntry = 0; ffbturfEntry < nFfbturfEntrifs; ffbturfEntry++) {
                donst FfbturfTbblfEntry &ffbturfTbblfEntry = ffbturfTbblfRff(ffbturfEntry, suddfss);
                lf_int16 ffbturfTypf = SWAPW(ffbturfTbblfEntry.ffbturfTypf);
                lf_int16 ffbturfSftting = SWAPW(ffbturfTbblfEntry.ffbturfSftting);
                lf_uint32 fnbblfFlbgs = SWAPL(ffbturfTbblfEntry.fnbblfFlbgs);
                lf_uint32 disbblfFlbgs = SWAPL(ffbturfTbblfEntry.disbblfFlbgs);
                switdh (ffbturfTypf) {
                    dbsf ligbturfsTypf:
                        if ((typoFlbgs & LE_Ligbturfs_FEATURE_ENUM ) && (ffbturfSftting ^ 0x1)){
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        } flsf {
                            if (((typoFlbgs & LE_RLIG_FEATURE_FLAG) && ffbturfSftting == rfquirfdLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_CLIG_FEATURE_FLAG) && ffbturfSftting == dontfxtublLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_HLIG_FEATURE_FLAG) && ffbturfSftting == historidblLigbturfsOnSflfdtor) ||
                                ((typoFlbgs & LE_LIGA_FEATURE_FLAG) && ffbturfSftting == dommonLigbturfsOnSflfdtor)) {
                                flbg &= disbblfFlbgs;
                                flbg |= fnbblfFlbgs;
                            }
                        }
                        brfbk;
                    dbsf lfttfrCbsfTypf:
                        if ((typoFlbgs & LE_SMCP_FEATURE_FLAG) && ffbturfSftting == smbllCbpsSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf vfrtidblSubstitutionTypf:
                        brfbk;
                    dbsf linguistidRfbrrbngfmfntTypf:
                        brfbk;
                    dbsf numbfrSpbdingTypf:
                        brfbk;
                    dbsf smbrtSwbshTypf:
                        if ((typoFlbgs & LE_SWSH_FEATURE_FLAG) && (ffbturfSftting ^ 0x1)){
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf dibdritidsTypf:
                        brfbk;
                    dbsf vfrtidblPositionTypf:
                        brfbk;
                    dbsf frbdtionsTypf:
                        if (((typoFlbgs & LE_FRAC_FEATURE_FLAG) && ffbturfSftting == dibgonblFrbdtionsSflfdtor) ||
                            ((typoFlbgs & LE_AFRC_FEATURE_FLAG) && ffbturfSftting == vfrtidblFrbdtionsSflfdtor)) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        } flsf {
                            flbg &= disbblfFlbgs;
                        }
                        brfbk;
                    dbsf typogrbphidExtrbsTypf:
                        if ((typoFlbgs & LE_ZERO_FEATURE_FLAG) && ffbturfSftting == slbshfdZfroOnSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf mbthfmbtidblExtrbsTypf:
                        brfbk;
                    dbsf ornbmfntSftsTypf:
                        brfbk;
                    dbsf dhbrbdtfrAltfrnbtivfsTypf:
                        brfbk;
                    dbsf dfsignComplfxityTypf:
                        if (((typoFlbgs & LE_SS01_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl1Sflfdtor) ||
                            ((typoFlbgs & LE_SS02_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl2Sflfdtor) ||
                            ((typoFlbgs & LE_SS03_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl3Sflfdtor) ||
                            ((typoFlbgs & LE_SS04_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl4Sflfdtor) ||
                            ((typoFlbgs & LE_SS05_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl5Sflfdtor) ||
                            ((typoFlbgs & LE_SS06_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl6Sflfdtor) ||
                            ((typoFlbgs & LE_SS07_FEATURE_FLAG) && ffbturfSftting == dfsignLfvfl7Sflfdtor)) {

                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf stylfOptionsTypf:
                        brfbk;
                    dbsf dhbrbdtfrShbpfTypf:
                        brfbk;
                    dbsf numbfrCbsfTypf:
                        brfbk;
                    dbsf tfxtSpbdingTypf:
                        brfbk;
                    dbsf trbnslitfrbtionTypf:
                        brfbk;
                    dbsf bnnotbtionTypf:
                        if ((typoFlbgs & LE_NALT_FEATURE_FLAG) && ffbturfSftting == dirdlfAnnotbtionSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf kbnbSpbdingTypf:
                        brfbk;
                    dbsf idfogrbphidSpbdingTypf:
                        brfbk;
                    dbsf rubyKbnbTypf:
                        if ((typoFlbgs & LE_RUBY_FEATURE_FLAG) && ffbturfSftting == rubyKbnbOnSflfdtor) {
                            flbg &= disbblfFlbgs;
                            flbg |= fnbblfFlbgs;
                        }
                        brfbk;
                    dbsf djkRombnSpbdingTypf:
                        brfbk;
                    dffbult:
                        brfbk;
                }
            }
        }

        for (subtbblf = 0;  LE_SUCCESS(suddfss) && subtbblf < nSubtbblfs; subtbblf++) {
            if(subtbblf>0)  {
              lf_uint32 lfngth = SWAPL(subtbblfHfbdfr->lfngth);
              subtbblfHfbdfr.bddOffsft(lfngth, suddfss); // Don't bddOffsft for thf lbst fntry.
            }
            lf_uint32 dovfrbgf = SWAPL(subtbblfHfbdfr->dovfrbgf);
            FfbturfFlbgs subtbblfFfbturfs = SWAPL(subtbblfHfbdfr->subtbblfFfbturfs);
            // should dhfdk dovfrbgf morf dbrffully...
            if (((dovfrbgf & sdfIgnorfVt2) || !(dovfrbgf & sdfVfrtidbl2)) && (subtbblfFfbturfs & flbg) != 0) {
              subtbblfHfbdfr->prodfss(subtbblfHfbdfr, glyphStorbgf, suddfss);
            }
        }
    }
}

void MorphSubtbblfHfbdfr2::prodfss(donst LERfffrfndfTo<MorphSubtbblfHfbdfr2> &bbsf, LEGlyphStorbgf &glyphStorbgf, LEErrorCodf &suddfss) donst
{
    SubtbblfProdfssor2 *prodfssor = NULL;

    switdh (SWAPL(dovfrbgf) & sdfTypfMbsk2)
    {
    dbsf mstIndidRfbrrbngfmfnt:
        prodfssor = nfw IndidRfbrrbngfmfntProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstContfxtublGlyphSubstitution:
        prodfssor = nfw ContfxtublGlyphSubstitutionProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstLigbturfSubstitution:
        prodfssor = nfw LigbturfSubstitutionProdfssor2(bbsf, suddfss);
        brfbk;

    dbsf mstRfsfrvfdUnusfd:
        brfbk;

    dbsf mstNonContfxtublGlyphSubstitution:
        prodfssor = NonContfxtublGlyphSubstitutionProdfssor2::drfbtfInstbndf(bbsf, suddfss);
        brfbk;


    dbsf mstContfxtublGlyphInsfrtion:
        prodfssor = nfw ContfxtublGlyphInsfrtionProdfssor2(bbsf, suddfss);
        brfbk;

    dffbult:
        rfturn;
        brfbk; /*NOTREACHED*/
    }

    if (prodfssor != NULL) {
      prodfssor->prodfss(glyphStorbgf, suddfss);
        dflftf prodfssor;
    } flsf {
      if(LE_SUCCESS(suddfss)) {
        suddfss = LE_MEMORY_ALLOCATION_ERROR; // bfdbusf ptr is null bnd wf didn't brfbk out.
      }
    }
}

U_NAMESPACE_END
