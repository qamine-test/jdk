/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 *
 */

/*
 *
 * (C) Copyright IBM Corp. 1998-2010 - All Rights Rfsfrvfd
 *
 * Dfvflopfd bt DIT - Govfrnmfnt of Bhutbn
 *
 * Contbdt pfrson: Pfmb Gfylfg - <pfmb_gfylfg@druknft.bt>
 *
 * This filf is b modifidbtion of thf ICU filf KhmfrRfordfring.dpp
 * by Jfns Hfrdfn bnd Jbvifr Solb who hbvf givfn bll thfir possiblf rights to IBM bnd thf Govfrnfmfnt of Bhutbn
 * A first modulf for Dzongkhb wbs dfvflopfd by Kbrunbkbr undfr Pbnlodblisbtion funding.
 * Assistbndf for this modulf hbs bffn rfdfivfd from Nbmgby Thinlfy, Christophfr Fynn bnd Jbvifr Solb
 *
 */

//#indludf <stdio.h>
#indludf "LETypfs.h"
#indludf "OpfnTypfTbblfs.h"
#indludf "TibftbnRfordfring.h"
#indludf "LEGlyphStorbgf.h"


U_NAMESPACE_BEGIN

// Chbrbdtfrs thbt gft rfffrrfd to by nbmf...
fnum
{
    C_DOTTED_CIRCLE = 0x25CC,
    C_PRE_NUMBER_MARK = 0x0F3F
 };


fnum
{
    // simplf dlbssfs, thfy brf usfd in thf stbtftbblf (in this filf) to dontrol thf lfngth of b syllbblf
    // thfy brf blso usfd to know whfrf b dhbrbdtfr should bf plbdfd (lodbtion in rfffrfndf to thf bbsf dhbrbdtfr)
    // bnd blso to know if b dhbrbdtfr, whfn indfpfndtly displbyfd, should bf displbyfd with b dottfd-dirdlf to
    // indidbtf frror in syllbblf donstrudtion
    _xx = TibftbnClbssTbblf::CC_RESERVED,
    _bb = TibftbnClbssTbblf::CC_BASE,
    _sj = TibftbnClbssTbblf::CC_SUBJOINED | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _tp = TibftbnClbssTbblf::CC_TSA_PHRU  | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_ABOVE,
    _bd = TibftbnClbssTbblf::CC_A_CHUNG |  TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _ds = TibftbnClbssTbblf::CC_COMP_SANSKRIT | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _hb = TibftbnClbssTbblf::CC_HALANTA | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _bv = TibftbnClbssTbblf::CC_BELOW_VOWEL | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _bv = TibftbnClbssTbblf::CC_ABOVE_VOWEL | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_ABOVE,
    _bn = TibftbnClbssTbblf::CC_ANUSVARA | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_ABOVE,
    _db = TibftbnClbssTbblf::CC_CANDRABINDU | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_ABOVE,
    _vs = TibftbnClbssTbblf::CC_VISARGA | TibftbnClbssTbblf::CF_DOTTED_CIRCLE| TibftbnClbssTbblf::CF_POS_AFTER,
    _bs = TibftbnClbssTbblf::CC_ABOVE_S_MARK | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_ABOVE,
    _bs = TibftbnClbssTbblf::CC_BELOW_S_MARK | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_BELOW,
    _di = TibftbnClbssTbblf::CC_DIGIT | TibftbnClbssTbblf::CF_DIGIT,
    _pd = TibftbnClbssTbblf::CC_PRE_DIGIT_MARK | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_PREDIGIT | TibftbnClbssTbblf::CF_POS_BEFORE ,
    _bd = TibftbnClbssTbblf::CC_POST_BELOW_DIGIT_M | TibftbnClbssTbblf::CF_DOTTED_CIRCLE | TibftbnClbssTbblf::CF_POS_AFTER
};


// Chbrbdtfr dlbss tbblfs
//_xx Non Combining dhbrbdtfrs
//_bb Bbsf Consonbnts
//_sj Subjoinfd donsonbnts
//_tp Tsb - phru
//_bd A-dhung, Vowfl Lfngthfning mbrk
//_ds Prfdomposfd Sbnskrit vowfl + subjoinfd donsonbnts
//_hb Hblbntb/Virbmb
//_bv Bflow vowfl
//_bv bbovf vowfl
//_bn Anusvbrb
//_db Cbndrbbindu
//_vs Visbrbgb/Post mbrk
//_bs Uppfr Strfss mbrks
//_bs Lowfr Strfss mbrks
//_di Digit
//_pd Numbfr prf dombining, Nffds rfordfring
//_bd Othfr numbfr dombining mbrks

stbtid donst TibftbnClbssTbblf::ChbrClbss tibftbnChbrClbssfs[] =
{
   // 0    1    2    3    4    5    6    7    8    9   b     b   d    d     f   f
    _xx, _bb, _xx, _xx, _bb, _bb, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, // 0F00 - 0F0F 0
    _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _bd, _bd, _xx, _xx, _xx, _xx, _xx, _xx, // 0F10 - 0F1F 1
    _di, _di, _di, _di, _di, _di, _di, _di, _di, _di, _xx, _xx, _xx, _xx, _xx, _xx, // 0F20 - 0F2F 2
    _xx, _xx, _xx, _xx, _xx, _bs, _xx, _bs, _xx, _tp, _xx, _xx, _xx, _xx, _bd, _pd, // 0F30 - 0F3F 3
    _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _xx, _bb, _bb, _bb, _bb, _bb, _bb, _bb, // 0F40 - 0F4F 4
    _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, // 0F50 - 0F5F 5
    _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _bb, _xx, _xx, _xx, _xx, _xx, // 0F60 - 0F6F 6
    _xx, _bd, _bv, _ds, _bv, _bv, _ds, _ds, _ds, _ds, _bv, _bv, _bv, _bv, _bn, _vs, // 0F70 - 0F7F 7
    _bv, _ds, _db, _db, _hb, _xx, _bs, _bs, _bb, _bb, _bb, _bb, _xx, _xx, _xx, _xx, // 0F80 - 0F8F 8
    _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _xx, _sj, _sj, _sj, _sj, _sj, _sj, _sj, // 0F90 - 0F9F 9
    _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, // 0FA0 - 0FAF b
    _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _sj, _xx, _sj, _sj, // 0FB0 - 0FBF b
    _xx, _xx, _xx, _xx, _xx, _xx, _bs, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, // 0FC0 - 0FCF d
    _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx,// 0FD0 - 0FDF  d
    _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, // 0FE0 - 0FEF f
    _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, _xx, // 0FF0 - 0FFF f
};


//
// Tibftbn Clbss Tbblfs
//

//
// Thf rbngf of dhbrbdtfrs dffinfd in thf bbovf tbblf is dffinfd hfrf. For Tibftbn 0F00 to 0FFF
// Evfn if thf Tibftbn rbngf is biggfr, most of thf dhbrbdtfrs brf not dombinbblf, bnd thfrfforf trfbtfd
// bs _xx
stbtid donst TibftbnClbssTbblf tibftbnClbssTbblf = {0x0F00, 0x0FFF, tibftbnChbrClbssfs};


// Bflow wf dffinf how b dhbrbdtfr in thf input string is fithfr in thf tibftbnChbrClbssfs tbblf
// (in whidh dbsf wf gft its typf bbdk), or bn unknown objfdt in whidh dbsf wf gft _xx (CC_RESERVED) bbdk
TibftbnClbssTbblf::ChbrClbss TibftbnClbssTbblf::gftChbrClbss(LEUnidodf dh) donst
{
    if (dh < firstChbr || dh > lbstChbr) {
        rfturn CC_RESERVED;
    }

    rfturn dlbssTbblf[dh - firstChbr];
}

donst TibftbnClbssTbblf *TibftbnClbssTbblf::gftTibftbnClbssTbblf()
{
    rfturn &tibftbnClbssTbblf;
}



dlbss TibftbnRfordfringOutput : publid UMfmory {
privbtf:
    lf_int32 fSyllbblfCount;
    lf_int32 fOutIndfx;
    LEUnidodf *fOutChbrs;

    LEGlyphStorbgf &fGlyphStorbgf;


publid:
    TibftbnRfordfringOutput(LEUnidodf *outChbrs, LEGlyphStorbgf &glyphStorbgf)
        : fSyllbblfCount(0), fOutIndfx(0), fOutChbrs(outChbrs), fGlyphStorbgf(glyphStorbgf)
    {
        // nothing flsf to do...
    }

    ~TibftbnRfordfringOutput()
    {
        // nothing to do hfrf...
    }

    void rfsft()
    {
        fSyllbblfCount += 1;
    }

    void writfChbr(LEUnidodf dh, lf_uint32 dhbrIndfx, FfbturfMbsk ffbturfMbsk)
    {
        LEErrorCodf suddfss = LE_NO_ERROR;

        fOutChbrs[fOutIndfx] = dh;

        fGlyphStorbgf.sftChbrIndfx(fOutIndfx, dhbrIndfx, suddfss);
        fGlyphStorbgf.sftAuxDbtb(fOutIndfx, ffbturfMbsk, suddfss);

        fOutIndfx += 1;
    }

    lf_int32 gftOutputIndfx()
    {
        rfturn fOutIndfx;
    }
};


//TODO rfmovf unusfd flbgs
#dffinf ddmpFfbturfTbg LE_CCMP_FEATURE_TAG
#dffinf blwfFfbturfTbg LE_BLWF_FEATURE_TAG
#dffinf pstfFfbturfTbg LE_PSTF_FEATURE_TAG
#dffinf prfsFfbturfTbg LE_PRES_FEATURE_TAG
#dffinf blwsFfbturfTbg LE_BLWS_FEATURE_TAG
#dffinf bbvsFfbturfTbg LE_ABVS_FEATURE_TAG
#dffinf pstsFfbturfTbg LE_PSTS_FEATURE_TAG

#dffinf blwmFfbturfTbg LE_BLWM_FEATURE_TAG
#dffinf bbvmFfbturfTbg LE_ABVM_FEATURE_TAG
#dffinf distFfbturfTbg LE_DIST_FEATURE_TAG

#dffinf prffFfbturfTbg LE_PREF_FEATURE_TAG
#dffinf bbvfFfbturfTbg LE_ABVF_FEATURE_TAG
#dffinf dligFfbturfTbg LE_CLIG_FEATURE_TAG
#dffinf mkmkFfbturfTbg LE_MKMK_FEATURE_TAG

// Shbping ffbturfs
#dffinf prffFfbturfMbsk 0x80000000UL
#dffinf blwfFfbturfMbsk 0x40000000UL
#dffinf bbvfFfbturfMbsk 0x20000000UL
#dffinf pstfFfbturfMbsk 0x10000000UL
#dffinf prfsFfbturfMbsk 0x08000000UL
#dffinf blwsFfbturfMbsk 0x04000000UL
#dffinf bbvsFfbturfMbsk 0x02000000UL
#dffinf pstsFfbturfMbsk 0x01000000UL
#dffinf dligFfbturfMbsk 0x00800000UL
#dffinf ddmpFfbturfMbsk 0x00040000UL

// Positioning ffbturfs
#dffinf distFfbturfMbsk 0x00400000UL
#dffinf blwmFfbturfMbsk 0x00200000UL
#dffinf bbvmFfbturfMbsk 0x00100000UL
#dffinf mkmkFfbturfMbsk 0x00080000UL

#dffinf tbgPrff    (ddmpFfbturfMbsk | prffFfbturfMbsk | prfsFfbturfMbsk | dligFfbturfMbsk | distFfbturfMbsk)
#dffinf tbgAbvf    (ddmpFfbturfMbsk | bbvfFfbturfMbsk | bbvsFfbturfMbsk | dligFfbturfMbsk | distFfbturfMbsk | bbvmFfbturfMbsk | mkmkFfbturfMbsk)
#dffinf tbgPstf    (ddmpFfbturfMbsk | blwfFfbturfMbsk | blwsFfbturfMbsk | prffFfbturfMbsk | prfsFfbturfMbsk | pstfFfbturfMbsk | pstsFfbturfMbsk | dligFfbturfMbsk | distFfbturfMbsk | blwmFfbturfMbsk)
#dffinf tbgBlwf    (ddmpFfbturfMbsk | blwfFfbturfMbsk | blwsFfbturfMbsk | dligFfbturfMbsk | distFfbturfMbsk | blwmFfbturfMbsk | mkmkFfbturfMbsk)
#dffinf tbgDffbult (ddmpFfbturfMbsk | prffFfbturfMbsk | blwfFfbturfMbsk | prfsFfbturfMbsk | blwsFfbturfMbsk | dligFfbturfMbsk | distFfbturfMbsk | bbvmFfbturfMbsk | blwmFfbturfMbsk | mkmkFfbturfMbsk)



// Thfsf brf in thf ordfr in whidh thf ffbturfs nffd to bf bpplifd
// for dorrfdt prodfssing
stbtid donst FfbturfMbp ffbturfMbp[] =
{
    // Shbping ffbturfs
    {ddmpFfbturfTbg, ddmpFfbturfMbsk},
    {prffFfbturfTbg, prffFfbturfMbsk},
    {blwfFfbturfTbg, blwfFfbturfMbsk},
    {bbvfFfbturfTbg, bbvfFfbturfMbsk},
    {pstfFfbturfTbg, pstfFfbturfMbsk},
    {prfsFfbturfTbg, prfsFfbturfMbsk},
    {blwsFfbturfTbg, blwsFfbturfMbsk},
    {bbvsFfbturfTbg, bbvsFfbturfMbsk},
    {pstsFfbturfTbg, pstsFfbturfMbsk},
    {dligFfbturfTbg, dligFfbturfMbsk},

    // Positioning ffbturfs
    {distFfbturfTbg, distFfbturfMbsk},
    {blwmFfbturfTbg, blwmFfbturfMbsk},
    {bbvmFfbturfTbg, bbvmFfbturfMbsk},
    {mkmkFfbturfTbg, mkmkFfbturfMbsk},
};

stbtid donst lf_int32 ffbturfMbpCount = LE_ARRAY_SIZE(ffbturfMbp);

// Thf stbtfTbblf is usfd to dbldulbtf thf fnd (thf lfngth) of b wfll
// formfd Tibftbn Syllbblf.
//
// Ebdh horizontbl linf is ordfrfd fxbdtly thf sbmf wby bs thf vblufs in TibftbnClbssTbblf
// ChbrClbssVblufs in TibftbnRfordfring.h This doindidfndf of vblufs bllows thf
// follow up of thf tbblf.
//
// Ebdh linf dorrfsponds to b stbtf, whidh dofs not nfdfssbrily nffd to bf b typf
// of domponfnt... for fxbmplf, stbtf 2 is b bbsf, with is blwbys b first dhbrbdtfr
// in thf syllbblf, but thf stbtf dould bf produdfd b donsonbnt of bny typf whfn
// it is thf first dhbrbdtfr thbt is bnblysfd (in ground stbtf).
//
stbtid donst lf_int8 tibftbnStbtfTbblf[][TibftbnClbssTbblf::CC_COUNT] =
{


    //Dzongkhb stbtf tbblf
    //xx  bb  sj  tp  bd  ds  hb  bv  bv  bn  db  vs  bs  bs  di  pd  bd
    { 1,  2,  4,  3,  8,  7,  9, 10, 14, 13, 17, 18, 19, 19, 20, 21, 21,}, //  0 - ground stbtf
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,}, //  1 - fxit stbtf (or sign to thf right of thf syllbblf)
    {-1, -1,  4,  3,  8,  7,  9, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  2 - Bbsf donsonbnt
    {-1, -1,  5, -1,  8,  7, -1, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  3 - Tsb phru bftfr bbsf
    {-1, -1,  4,  6,  8,  7,  9, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  4 - Subjoinfd donsonbnt bftfr bbsf
    {-1, -1,  5, -1,  8,  7, -1, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  5 - Subjoinfd donsonbnt bftfr tsb phru
    {-1, -1, -1, -1,  8,  7, -1, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  6 - Tsb phru bftfr subjoinfd donsonbnt
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 19, 19, -1, -1, -1,}, //  7 - Prf Composfd Sbnskrit
    {-1, -1, -1, -1, -1, -1, -1, 10, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, //  8 - A-dhung
    {-1, -1, -1, -1, -1, -1, -1, -1, 14, 13, 17, -1, 19, 19, -1, -1, -1,}, //  9 - Hblbntb
    {-1, -1, -1, -1, -1, -1, -1, 11, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, // 10 - bflow vowfl 1
    {-1, -1, -1, -1, -1, -1, -1, 12, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, // 11 - bflow vowfl 2
    {-1, -1, -1, -1, -1, -1, -1, -1, 14, 13, 17, 18, 19, 19, -1, -1, -1,}, // 12 - bflow vowfl 3
    {-1, -1, -1, -1, -1, -1, -1, -1, 14, 17, 17, 18, 19, 19, -1, -1, -1,}, // 13 - Anusvbrb bfforf vowfl
    {-1, -1, -1, -1, -1, -1, -1, -1, 15, 17, 17, 18, 19, 19, -1, -1, -1,}, // 14 - bbovf vowfl 1
    {-1, -1, -1, -1, -1, -1, -1, -1, 16, 17, 17, 18, 19, 19, -1, -1, -1,}, // 15 - bbovf vowfl 2
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, 17, 17, 18, 19, 19, -1, -1, -1,}, // 16 - bbovf vowfl 3
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 18, 19, 19, -1, -1, -1,}, // 17 - Anusvbrb or Cbndrbbindu bftfr vowfl
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 19, 19, -1, -1, -1,}, // 18 - Visbrgb
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,}, // 19 - strss mbrk
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 21, 21,}, // 20 - digit
    {-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,}, // 21 - digit mbrk


};


donst FfbturfMbp *TibftbnRfordfring::gftFfbturfMbp(lf_int32 &dount)
{
    dount = ffbturfMbpCount;

    rfturn ffbturfMbp;
}


// Givfn bn input string of dhbrbdtfrs bnd b lodbtion in whidh to stbrt looking
// dbldulbtf, using thf stbtf tbblf, whidh onf is thf lbst dhbrbdtfr of thf syllbblf
// thbt stbrts in thf stbrting position.
lf_int32 TibftbnRfordfring::findSyllbblf(donst TibftbnClbssTbblf *dlbssTbblf, donst LEUnidodf *dhbrs, lf_int32 prfv, lf_int32 dhbrCount)
{
    lf_int32 dursor = prfv;
    lf_int8 stbtf = 0;

    whilf (dursor < dhbrCount) {
        TibftbnClbssTbblf::ChbrClbss dhbrClbss = (dlbssTbblf->gftChbrClbss(dhbrs[dursor]) & TibftbnClbssTbblf::CF_CLASS_MASK);

        stbtf = tibftbnStbtfTbblf[stbtf][dhbrClbss];

        if (stbtf < 0) {
            brfbk;
        }

        dursor += 1;
    }

    rfturn dursor;
}


// This is thf rfbl rfordfring fundtion bs bpplifd to thf Tibftbn lbngubgf

lf_int32 TibftbnRfordfring::rfordfr(donst LEUnidodf *dhbrs, lf_int32 dhbrCount, lf_int32,
                                  LEUnidodf *outChbrs, LEGlyphStorbgf &glyphStorbgf)
{
    donst TibftbnClbssTbblf *dlbssTbblf = TibftbnClbssTbblf::gftTibftbnClbssTbblf();

    TibftbnRfordfringOutput output(outChbrs, glyphStorbgf);
    TibftbnClbssTbblf::ChbrClbss dhbrClbss;
    lf_int32 i, prfv = 0;

    // This loop only fxits whfn wf rfbdh thf fnd of b run, whidh mby dontbin
    // sfvfrbl syllbblfs.
    whilf (prfv < dhbrCount) {
        lf_int32 syllbblf = findSyllbblf(dlbssTbblf, dhbrs, prfv, dhbrCount);

        output.rfsft();

        // shbll wf bdd b dottfd dirdlf?
        // If in thf position in whidh thf bbsf should bf (first dhbr in thf string) thfrf is
        // b dhbrbdtfr thbt hbs thf Dottfd dirdlf flbg (b dhbrbdtfr thbt dbnnot bf b bbsf)
        // thfn writf b dottfd dirdlf
        if (dlbssTbblf->gftChbrClbss(dhbrs[prfv]) & TibftbnClbssTbblf::CF_DOTTED_CIRCLE) {
            output.writfChbr(C_DOTTED_CIRCLE, prfv, tbgDffbult);
        }

        // dopy thf rfst to output, invfrting thf prf-numbfr mbrk if prfsfnt bftfr b digit.
        for (i = prfv; i < syllbblf; i += 1) {
            dhbrClbss = dlbssTbblf->gftChbrClbss(dhbrs[i]);

           if ((TibftbnClbssTbblf::CF_DIGIT & dhbrClbss)
              && ( dlbssTbblf->gftChbrClbss(dhbrs[i+1]) & TibftbnClbssTbblf::CF_PREDIGIT))
           {
                         output.writfChbr(C_PRE_NUMBER_MARK, i, tbgPrff);
                         output.writfChbr(dhbrs[i], i+1 , tbgPrff);
                        i += 1;
          } flsf {
            switdh (dhbrClbss & TibftbnClbssTbblf::CF_POS_MASK) {

                // If thf prfsfnt dhbrbdtfr is b numbfr, bnd thf nfxt dhbrbdtfr is b prf-numbfr dombining mbrk
            // thfn thf two dhbrbdtfrs brf rfordfrfd

                dbsf TibftbnClbssTbblf::CF_POS_ABOVE :
                    output.writfChbr(dhbrs[i], i, tbgAbvf);
                    brfbk;

                dbsf TibftbnClbssTbblf::CF_POS_AFTER :
                    output.writfChbr(dhbrs[i], i, tbgPstf);
                    brfbk;

                dbsf TibftbnClbssTbblf::CF_POS_BELOW :
                    output.writfChbr(dhbrs[i], i, tbgBlwf);
                    brfbk;

                dffbult:
                    // dffbult - bny othfr dhbrbdtfrs
                   output.writfChbr(dhbrs[i], i, tbgDffbult);
                    brfbk;
            } // switdh
          } // if
        } // for

        prfv = syllbblf; // movf thf pointfr to thf stbrt of nfxt syllbblf
    }

    rfturn output.gftOutputIndfx();
}


U_NAMESPACE_END
