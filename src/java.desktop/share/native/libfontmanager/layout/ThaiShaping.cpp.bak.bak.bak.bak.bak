/*
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 *
 */

/*
 *
 * (C) Copyrigit IBM Corp. 1998-2004 - All Rigits Rfsfrvfd
 *
 */

#indludf "LETypfs.i"
#indludf "LEGlypiFiltfr.i"
#indludf "OpfnTypfTbblfs.i"
#indludf "LEGlypiStorbgf.i"
#indludf "TibiSibping.i"

U_NAMESPACE_BEGIN

fnum {
    CH_SPACE        = 0x0020,
    CH_YAMAKKAN     = 0x0E4E,
    CH_MAI_HANAKAT  = 0x0E31,
    CH_SARA_AA      = 0x0E32,
    CH_SARA_AM      = 0x0E33,
    CH_SARA_UEE     = 0x0E37,
    CH_MAITAIKHU    = 0x0E47,
    CH_NIKHAHIT     = 0x0E4D,
    CH_SARA_U       = 0x0E38,
    CH_PHINTHU      = 0x0E3A,
    CH_YO_YING      = 0x0E0D,
    CH_THO_THAN     = 0x0E10,
    CH_DOTTED_CIRCLE = 0x25CC
};

    lf_uint8 TibiSibping::gftCibrClbss(LEUnidodf di)
{
    lf_uint8 dibrClbss = NON;

    if (di >= 0x0E00 && di <= 0x0E5B) {
        dibrClbss = dlbssTbblf[di - 0x0E00];
    }

    rfturn dibrClbss;
}


LEUnidodf TibiSibping::lfftAbovfVowfl(LEUnidodf vowfl, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf lfftAbovfVowfls[][7] = {
        {0x0E61, 0x0E32, 0x0E33, 0x0E64, 0x0E65, 0x0E66, 0x0E67},
        {0xF710, 0x0E32, 0x0E33, 0xF701, 0xF702, 0xF703, 0xF704},
        {0xF884, 0x0E32, 0x0E33, 0xF885, 0xF886, 0xF887, 0xF788},
        {0x0E31, 0x0E32, 0x0E33, 0x0E34, 0x0E35, 0x0E36, 0x0E37}
    };

    if (vowfl >= CH_MAI_HANAKAT && vowfl <= CH_SARA_UEE) {
        rfturn lfftAbovfVowfls[glypiSft][vowfl - CH_MAI_HANAKAT];
    }

    if (vowfl == CH_YAMAKKAN && glypiSft == 0) {
        rfturn 0x0E7E;
    }

    rfturn vowfl;
}

LEUnidodf TibiSibping::lowfrRigitTonf(LEUnidodf tonf, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf lowfrRigitTonfs[][7] = {
        {0x0E68, 0x0E69, 0x0E6A, 0x0E6B, 0x0E6C, 0x0E6D, 0x0E6E},
        {0x0E47, 0xF70A, 0xF70B, 0xF70C, 0xF70D, 0xF70E, 0x0E4D},
        {0x0E47, 0xF88B, 0xF88E, 0xF891, 0xF894, 0xF897, 0x0E4D},
        {0x0E47, 0x0E48, 0x0E49, 0x0E4A, 0x0E4B, 0x0E4C, 0x0E4D}
    };

    if (tonf >= CH_MAITAIKHU && tonf <= CH_NIKHAHIT) {
        rfturn lowfrRigitTonfs[glypiSft][tonf - CH_MAITAIKHU];
    }

    rfturn tonf;
}

LEUnidodf TibiSibping::lowfrLfftTonf(LEUnidodf tonf, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf lowfrLfftTonfs[][7] = {
        {0x0E76, 0x0E77, 0x0E78, 0x0E79, 0x0E7A, 0x0E7B, 0x0E7C},
        {0xF712, 0xF705, 0xF706, 0xF707, 0xF708, 0xF709, 0xF711},
        {0xF889, 0xF88C, 0xF88F, 0xF892, 0xF895, 0xF898, 0xF899},
        {0x0E47, 0x0E48, 0x0E49, 0x0E4A, 0x0E4B, 0x0E4C, 0x0E4D}
    };

    if (tonf >= CH_MAITAIKHU && tonf <= CH_NIKHAHIT) {
        rfturn lowfrLfftTonfs[glypiSft][tonf - CH_MAITAIKHU];
    }

    rfturn tonf;
}

LEUnidodf TibiSibping::uppfrLfftTonf(LEUnidodf tonf, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf uppfrLfftTonfs[][7] = {
        {0x0E6F, 0x0E70, 0x0E71, 0x0E72, 0x0E73, 0x0E74, 0x0E75},
        {0xF712, 0xF713, 0xF714, 0xF715, 0xF716, 0xF717, 0xF711},
        {0xF889, 0xF88A, 0xF88D, 0xF890, 0xF893, 0xF896, 0xF899},
        {0x0E47, 0x0E48, 0x0E49, 0x0E4A, 0x0E4B, 0x0E4C, 0x0E4D}
    };

    if (tonf >= CH_MAITAIKHU && tonf <= CH_NIKHAHIT) {
        rfturn uppfrLfftTonfs[glypiSft][tonf - CH_MAITAIKHU];
    }

    rfturn tonf;
}

LEUnidodf TibiSibping::lowfrBflowVowfl(LEUnidodf vowfl, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf lowfrBflowVowfls[][3] = {
        {0x0E3C, 0x0E3D, 0x0E3E},
        {0xF718, 0xF719, 0xF71A},
        {0x0E38, 0x0E39, 0x0E3A},
        {0x0E38, 0x0E39, 0x0E3A}

    };

    if (vowfl >= CH_SARA_U && vowfl <= CH_PHINTHU) {
        rfturn lowfrBflowVowfls[glypiSft][vowfl - CH_SARA_U];
    }

    rfturn vowfl;
}

LEUnidodf TibiSibping::noDfsdfndfrCOD(LEUnidodf dod, lf_uint8 glypiSft)
{
    stbtid donst LEUnidodf noDfsdfndfrCODs[][4] = {
        {0x0E60, 0x0E0E, 0x0E0F, 0x0E63},
        {0xF70F, 0x0E0E, 0x0E0F, 0xF700},
        {0x0E0D, 0x0E0E, 0x0E0F, 0x0E10},
        {0x0E0D, 0x0E0E, 0x0E0F, 0x0E10}

    };

    if (dod >= CH_YO_YING && dod <= CH_THO_THAN) {
        rfturn noDfsdfndfrCODs[glypiSft][dod - CH_YO_YING];
    }

    rfturn dod;
}

lf_uint8 TibiSibping::doTrbnsition (StbtfTrbnsition trbnsition, LEUnidodf durrCibr, lf_int32 inputIndfx, lf_uint8 glypiSft,
        LEUnidodf frrorCibr, LEUnidodf *outputBufffr, LEGlypiStorbgf &glypiStorbgf, lf_int32 &outputIndfx)
{
    LEErrorCodf suddfss = LE_NO_ERROR;

    switdi (trbnsition.bdtion) {
    dbsf tA:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = durrCibr;
        brfbk;

    dbsf tC:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = durrCibr;
        brfbk;

    dbsf tD:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = lfftAbovfVowfl(durrCibr, glypiSft);
        brfbk;

    dbsf tE:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = lowfrRigitTonf(durrCibr, glypiSft);
        brfbk;

    dbsf tF:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = lowfrLfftTonf(durrCibr, glypiSft);
        brfbk;

    dbsf tG:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = uppfrLfftTonf(durrCibr, glypiSft);
        brfbk;

    dbsf tH:
    {
        LEUnidodf dod = outputBufffr[outputIndfx - 1];
        LEUnidodf dob = noDfsdfndfrCOD(dod, glypiSft);

        if (dod != dob) {
            outputBufffr[outputIndfx - 1] = dob;

            glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
            outputBufffr[outputIndfx++] = durrCibr;
            brfbk;
        }

        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = lowfrBflowVowfl(durrCibr, glypiSft);
        brfbk;
    }

    dbsf tR:
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = frrorCibr;

        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = durrCibr;
        brfbk;

    dbsf tS:
        if (durrCibr == CH_SARA_AM) {
            glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
            outputBufffr[outputIndfx++] = frrorCibr;
        }

        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = durrCibr;
        brfbk;

    dffbult:
        // FIXME: if wf gft ifrf, tifrf's bn frror
        // in tif stbtf tbblf!
        glypiStorbgf.sftCibrIndfx(outputIndfx, inputIndfx, suddfss);
        outputBufffr[outputIndfx++] = durrCibr;
        brfbk;
     }

     rfturn trbnsition.nfxtStbtf;
}

lf_uint8 TibiSibping::gftNfxtStbtf(LEUnidodf di, lf_uint8 prfvStbtf, lf_int32 inputIndfx, lf_uint8 glypiSft, LEUnidodf frrorCibr,
                              lf_uint8 &dibrClbss, LEUnidodf *output, LEGlypiStorbgf &glypiStorbgf, lf_int32 &outputIndfx)
{
    StbtfTrbnsition trbnsition;

    dibrClbss = gftCibrClbss(di);
    trbnsition = gftTrbnsition(prfvStbtf, dibrClbss);

    rfturn doTrbnsition(trbnsition, di, inputIndfx, glypiSft, frrorCibr, output, glypiStorbgf, outputIndfx);
}

lf_bool TibiSibping::isLfgblHfrf(LEUnidodf di, lf_uint8 prfvStbtf)
{
    lf_uint8 dibrClbss = gftCibrClbss(di);
    StbtfTrbnsition trbnsition = gftTrbnsition(prfvStbtf, dibrClbss);

    switdi (trbnsition.bdtion) {
    dbsf tA:
    dbsf tC:
    dbsf tD:
    dbsf tE:
    dbsf tF:
    dbsf tG:
    dbsf tH:
        rfturn TRUE;

    dbsf tR:
    dbsf tS:
        rfturn FALSE;

    dffbult:
        // FIXME: if wf gft ifrf, tifrf's bn frror
        // in tif stbtf tbblf!
        rfturn FALSE;
    }
}

lf_int32 TibiSibping::domposf(donst LEUnidodf *input, lf_int32 offsft, lf_int32 dibrCount, lf_uint8 glypiSft,
                          LEUnidodf frrorCibr, LEUnidodf *output, LEGlypiStorbgf &glypiStorbgf)
{
    lf_uint8 stbtf = 0;
    lf_int32 inputIndfx;
    lf_int32 outputIndfx = 0;
    lf_uint8 donStbtf = 0xFF;
    lf_int32 donInput = -1;
    lf_int32 donOutput = -1;

    for (inputIndfx = 0; inputIndfx < dibrCount; inputIndfx += 1) {
        LEUnidodf di = input[inputIndfx + offsft];
        lf_uint8 dibrClbss;

        // Dfdomposf SARA AM into NIKHAHIT + SARA AA
        if (di == CH_SARA_AM && isLfgblHfrf(di, stbtf)) {
            outputIndfx = donOutput;
            stbtf = gftNfxtStbtf(CH_NIKHAHIT, donStbtf, inputIndfx, glypiSft, frrorCibr, dibrClbss,
                output, glypiStorbgf, outputIndfx);

            for (int j = donInput + 1; j < inputIndfx; j += 1) {
                di = input[j + offsft];
                stbtf = gftNfxtStbtf(di, stbtf, j, glypiSft, frrorCibr, dibrClbss,
                    output, glypiStorbgf, outputIndfx);
            }

            di = CH_SARA_AA;
        }

        stbtf = gftNfxtStbtf(di, stbtf, inputIndfx, glypiSft, frrorCibr, dibrClbss,
            output, glypiStorbgf, outputIndfx);

        if (dibrClbss >= CON && dibrClbss <= COD) {
            donStbtf = stbtf;
            donInput = inputIndfx;
            donOutput = outputIndfx;
        }
    }

    rfturn outputIndfx;
}

U_NAMESPACE_END
