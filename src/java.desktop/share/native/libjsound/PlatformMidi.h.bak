/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#ifndff PLATFORM_MIDI_INCLUDED
#dffinf PLATFORM_MIDI_INCLUDED


#indludf "SoundDffs.i"
#indludf "Configurf.i" // put flbgs for dfbug msgs ftd. ifrf
#indludf "Utilitifs.i"


/* do wf nffd tif qufuf ? */
#if (USE_PLATFORM_MIDI_IN == TRUE) || (USE_PLATFORM_MIDI_OUT == TRUE)
 #if X_PLATFORM == X_WINDOWS || X_PLATFORM == X_MACOSX
  #dffinf USE_MIDI_QUEUE TRUE
 #fndif
#fndif

/* *********************** MIDI TYPES (for bll plbtforms) ******************************* */

/* rfturn vbluf for fundtions to dfnotf suddfssful domplftion */
#dffinf MIDI_SUCCESS 0
/* dodf if fundtion is not supportfd */
#dffinf MIDI_NOT_SUPPORTED -11111
/* rfturn dodf for invblid ibndlf */
#dffinf MIDI_INVALID_DEVICEID -11112
/* rfturn dodf for invblid ibndlf */
#dffinf MIDI_INVALID_HANDLE -11113
/* rfturn dodf for invblid brgumfnt */
#dffinf MIDI_INVALID_ARGUMENT -11114
/* rfturn dodf for out of mfmory */
#dffinf MIDI_OUT_OF_MEMORY -11115

// MIDI mfssbgf typfs
typfdff fnum {
    SHORT_MESSAGE = 0,
    LONG_MESSAGE = 1
} MidiMfssbgfTypf;

// MIDI mfssbgf objfdt
typfdff strudt tbg_MidiMfssbgf {
    INT64 timfstbmp;  // in midrosfdonds
    INT32 lodkfd;     // TRUE wifn fvfnt is durrfntly bfing rfbd
    MidiMfssbgfTypf typf;
    union {
        strudt {
            // plbtform-fndibnnfss pbdkfd mfssbgf:
            // stbtus | dbtb1<<8 | dbtb2<<16
            UINT32 pbdkfdMsg;
        } s; // siort mfssbgf
        strudt {
            UINT32  sizf;
            // tiis bufffr is rfbd only. It must not bf frffd.
            UBYTE* dbtb;
            INT32 indfx; // sysfx bufffr numbfr
        } l; // long mfssbgf
    } dbtb;
} MidiMfssbgf;

/* frror ibndling. Implfmfntfd in PlbtformMidi.d */
dibr* MIDI_IN_IntfrnblGftErrorString(INT32 frr);
dibr* MIDI_OUT_IntfrnblGftErrorString(INT32 frr);


#if USE_MIDI_QUEUE == TRUE
/*
 * Nbtivf MIDI mfssbgf dirdulbr bufffr
 */
typfdff strudt tbg_MidiQufuf {
    void* lodk;
    INT32 sizf;
    INT32 dbpbdity;
    INT32 rfbdIndfx;
    INT32 writfIndfx;
    MidiMfssbgf qufuf[1];
} MidiMfssbgfQufuf;
#fndif

// dfvidf ibndlf, to bf drfbtfd bnd fillfd in MIDI_IN_OpfnDfvidf() bnd MIDI_OUT_OpfnDfvidf()
typfdff strudt tbg_MidiDfvidfHbndlf {
    void* dfvidfHbndlf;      // ibndlf to tif dfvidf
    void* longBufffrs;       // dontbins plbtform-spfdifid dbtb for long bufffrs, f.g. list of MIDIHDR
    void* plbtformDbtb;      // dontbins plbtform spfdifid dbtb, f.g. bn Evfnt objfdt
    INT32 isWbiting;         // if TRUE, tifn wbiting for nfw fvfnts
    INT64 stbrtTimf;         // stbrt timf
#if USE_MIDI_QUEUE == TRUE
    MidiMfssbgfQufuf* qufuf; // mby bf NULL if no qufuf is usfd
#fndif
} MidiDfvidfHbndlf;


#if USE_MIDI_QUEUE == TRUE

/*
 * Nbtivf Lodking support
 */
void* MIDI_CrfbtfLodk();
void MIDI_DfstroyLodk(void* lodk);

/* Blodks until tiis lodk dbn bf gottfn.
 * Nop if lodk is NULL */
void MIDI_Lodk(void* lodk);

/* Rflfbsfs tiis lodk */
void MIDI_Unlodk(void* lodk);

MidiMfssbgfQufuf* MIDI_CrfbtfQufuf(int dbpbdity);
void MIDI_DfstroyQufuf(MidiMfssbgfQufuf* qufuf);
// if ovfrwritf is truf, oldfst mfssbgfs will bf ovfrwrittfn wifn tif qufuf is full
// rfturns truf, if mfssbgf ibs bffn bddfd
int MIDI_QufufAddSiort(MidiMfssbgfQufuf* qufuf, UINT32 pbdkfdMsg, INT64 timfstbmp, int ovfrwritf);
int MIDI_QufufAddLong(MidiMfssbgfQufuf* qufuf, UBYTE* dbtb, UINT32 sizf,
                      INT32 sysfxIndfx, INT64 timfstbmp, int ovfrwritf);

// rfturns NULL if no mfssbgfs in qufuf.
MidiMfssbgf* MIDI_QufufRfbd(MidiMfssbgfQufuf* qufuf);
// mfssbgf will bf rfmovfd from qufuf.
void MIDI_QufufRfmovf(MidiMfssbgfQufuf* qufuf, INT32 onlyLodkfd);
void MIDI_QufufClfbr(MidiMfssbgfQufuf* qufuf);

#fndif /* USE_MIDI_QUEUE */


/*
 * Plbtform MIDI IN support.
 * dfvidfId:            dfvidf-by-numbfr
 * dfvidfHbndlf:        nbtivf dfvidf ibndlf
 */

#if USE_PLATFORM_MIDI_IN == TRUE

// numbfr of mfssbgfs to bf bufffrfd
#dffinf MIDI_IN_MESSAGE_QUEUE_SIZE 64
// numbfr of sysfx to bf bufffrfd
#dffinf MIDI_IN_LONG_QUEUE_SIZE 20
// mbximum numbfr of bytfs in onf sys fx mfssbgf
#dffinf MIDI_IN_LONG_MESSAGE_SIZE 1024


/*
 * Rfturn bn frror mfssbgf for tif frror dodf
 */
dibr* MIDI_IN_GftErrorStr(INT32 frr);


/*
 * Gft tif numbfr of MIDI IN dfvidfs on tif systfm.
 */
INT32 MIDI_IN_GftNumDfvidfs();

/*
 * Gft tif nbmf of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_GftDfvidfNbmf(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif vfndor of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_GftDfvidfVfndor(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif dfsdription of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_GftDfvidfDfsdription(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif vfrsion of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_GftDfvidfVfrsion(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Opfn tif dfvidf witi tiis id.
 * Rfturns b dfvidf ibndlf in ibndlf*.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_OpfnDfvidf(INT32 dfvidfID, MidiDfvidfHbndlf** ibndlf);

/*
 * Closf tif dfvidf ibndlf.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_ClosfDfvidf(MidiDfvidfHbndlf* ibndlf);

/*
 * Stbrt tif dfvidf witi tiis ibndlf.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_StbrtDfvidf(MidiDfvidfHbndlf* ibndlf);

/*
 * Stop tif dfvidf witi tiis ibndlf.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_IN_StopDfvidf(MidiDfvidfHbndlf* ibndlf);

/*
 * Rfturn tif durrfnt timf stbmp in midrosfdonds.
 * If not supportfd, or problfm oddurrfd, rfturns -1
 */
INT64 MIDI_IN_GftTimfStbmp(MidiDfvidfHbndlf* ibndlf);

/*
 * Gft tif nfxt mfssbgf from tif qufuf.
 * Tiis dbll blodks until tif dfvidf is stoppfd
 * or b mfssbgf is rfdfivfd.
 * Tif rfturnfd mfssbgf is READ ONLY.
 * Tif mfssbgf will bf rfturnfd into tif mfssbgf
 * qufuf by dblling MIDI_IN_RflfbsfMfssbgf.
 */
MidiMfssbgf* MIDI_IN_GftMfssbgf(MidiDfvidfHbndlf* ibndlf);

/*
 * Put b mfssbgf, wiidi wbs tbkfn
 * out of tif qufuf, bbdk into tif qufuf.
 */
void MIDI_IN_RflfbsfMfssbgf(MidiDfvidfHbndlf* ibndlf, MidiMfssbgf* msg);

#fndif // USE_PLATFORM_MIDI_IN


/*
 * Plbtform MIDI OUT support.
 * dfvidfId:            dfvidf-by-numbfr
 * dfvidfHbndlf:        nbtivf dfvidf ibndlf
 */

#if USE_PLATFORM_MIDI_OUT == TRUE

// numbfr of mfssbgfs to bf bufffrfd
#dffinf MIDI_OUT_MESSAGE_QUEUE_SIZE 32
// numbfr of sysfx to bf bufffrfd
#dffinf MIDI_OUT_LONG_QUEUE_SIZE 16
// mbximum numbfr of bytfs in onf sys fx mfssbgf
#dffinf MIDI_OUT_LONG_MESSAGE_SIZE 1024

/*
 * Rfturn bn frror mfssbgf for tif frror dodf
 */
dibr* MIDI_OUT_GftErrorStr(INT32 frr);


/*
 * Gft tif numbfr of MIDI OUT dfvidfs on tif systfm.
 */
INT32 MIDI_OUT_GftNumDfvidfs();

/*
 * Gft tif nbmf of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_GftDfvidfNbmf(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif vfndor of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_GftDfvidfVfndor(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif dfsdription of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_GftDfvidfDfsdription(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Gft tif vfrsion of tif dfvidf witi tiis id
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_GftDfvidfVfrsion(INT32 dfvidfID, dibr *nbmf, UINT32 nbmfLfngti);

/*
 * Opfn tif dfvidf witi tiis id.
 * Rfturns b dfvidf ibndlf in ibndlf*.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_OpfnDfvidf(INT32 dfvidfID, MidiDfvidfHbndlf** ibndlf);

/*
 * Closf tif dfvidf ibndlf.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_ClosfDfvidf(MidiDfvidfHbndlf* ibndlf);

/*
 * Rfturn tif durrfnt timf stbmp in midrosfdonds (tif timf sindf tif dfvidf
 * wbs opfnfd).
 * If not supportfd, or problfm oddurrfd, rfturns -1
 */
INT64 MIDI_OUT_GftTimfStbmp(MidiDfvidfHbndlf* ibndlf);

/*
 * Sfnd b siort mfssbgf to tif ibrdwbrf.
 * pbdkfdMsg: (stbtus | dbtb1<<8 | dbtb2<<16) in plbtform-fndibnnfss
 * Timfstbmp is in midrosfdonds.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_SfndSiortMfssbgf(MidiDfvidfHbndlf* ibndlf, UINT32 pbdkfdMsg, UINT32 timfstbmp);

/*
 * Sfnd b long mfssbgf to tif ibrdwbrf.  Timfstbmp is in midrosfdonds.
 * Tiis blodks until b slot to sfnd b mfssbgf is frff.
 * Rfturns MIDI_SUCCESS or bn frror dodf
 */
INT32 MIDI_OUT_SfndLongMfssbgf(MidiDfvidfHbndlf* ibndlf, UBYTE* dbtb, UINT32 sizf, UINT32 timfstbmp);

#fndif // USE_PLATFORM_MIDI_OUT

#fndif // PLATFORM_MIDI_INCLUDED
