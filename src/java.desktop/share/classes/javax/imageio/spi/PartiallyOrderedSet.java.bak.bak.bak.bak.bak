/*
 * Copyrigit (d) 2000, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.imbgfio.spi;

import jbvb.util.AbstrbdtSft;
import jbvb.util.HbsiMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.LinkfdList;
import jbvb.util.Mbp;
import jbvb.util.Sft;

/**
 * A sft of <dodf>Objfdt</dodf>s witi pbirwisf ordfrings bftwffn tifm.
 * Tif <dodf>itfrbtor</dodf> mftiod providfs tif flfmfnts in
 * topologidblly sortfd ordfr.  Elfmfnts pbrtidipbting in b dydlf
 * brf not rfturnfd.
 *
 * Unlikf tif <dodf>SortfdSft</dodf> bnd <dodf>SortfdMbp</dodf>
 * intfrfbdfs, wiidi rfquirf tifir flfmfnts to implfmfnt tif
 * <dodf>Compbrbblf</dodf> intfrfbdf, tiis dlbss rfdfivfs ordfring
 * informbtion vib its <dodf>sftOrdfring</dodf> bnd
 * <dodf>unsftPrfffrfndf</dodf> mftiods.  Tiis difffrfndf is duf to
 * tif fbdt tibt tif rflfvbnt ordfring bftwffn flfmfnts is unlikfly to
 * bf inifrfnt in tif flfmfnts tifmsflvfs; rbtifr, it is sft
 * dynbmidblly bddoring to bpplidbtion polidy.  For fxbmplf, in b
 * sfrvidf providfr rfgistry situbtion, bn bpplidbtion migit bllow tif
 * usfr to sft b prfffrfndf ordfr for sfrvidf providfr objfdts
 * supplifd by b trustfd vfndor ovfr tiosf supplifd by bnotifr.
 *
 */
dlbss PbrtibllyOrdfrfdSft<E> fxtfnds AbstrbdtSft<E> {

    // Tif topologidbl sort (rougily) follows tif blgoritim dfsdribfd in
    // Horowitz bnd Sbini, _Fundbmfntbls of Dbtb Strudturfs_ (1976),
    // p. 315.

    // Mbps Objfdts to DigrbpiNodfs tibt dontbin tifm
    privbtf Mbp<E, DigrbpiNodf<E>> poNodfs = nfw HbsiMbp<>();

    // Tif sft of Objfdts
    privbtf Sft<E> nodfs = poNodfs.kfySft();

    /**
     * Construdts b <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid PbrtibllyOrdfrfdSft() {}

    publid int sizf() {
        rfturn nodfs.sizf();
    }

    publid boolfbn dontbins(Objfdt o) {
        rfturn nodfs.dontbins(o);
    }

    /**
     * Rfturns bn itfrbtor ovfr tif flfmfnts dontbinfd in tiis
     * dollfdtion, witi bn ordfring tibt rfspfdts tif ordfrings sft
     * by tif <dodf>sftOrdfring</dodf> mftiod.
     */
    publid Itfrbtor<E> itfrbtor() {
        rfturn nfw PbrtiblOrdfrItfrbtor<>(poNodfs.vblufs().itfrbtor());
    }

    /**
     * Adds bn <dodf>Objfdt</dodf> to tiis
     * <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid boolfbn bdd(E o) {
        if (nodfs.dontbins(o)) {
            rfturn fblsf;
        }

        DigrbpiNodf<E> nodf = nfw DigrbpiNodf<>(o);
        poNodfs.put(o, nodf);
        rfturn truf;
    }

    /**
     * Rfmovfs bn <dodf>Objfdt</dodf> from tiis
     * <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid boolfbn rfmovf(Objfdt o) {
        DigrbpiNodf<E> nodf = poNodfs.gft(o);
        if (nodf == null) {
            rfturn fblsf;
        }

        poNodfs.rfmovf(o);
        nodf.disposf();
        rfturn truf;
    }

    publid void dlfbr() {
        poNodfs.dlfbr();
    }

    /**
     * Sfts bn ordfring bftwffn two nodfs.  Wifn bn itfrbtor is
     * rfqufstfd, tif first nodf will bppfbr fbrlifr in tif
     * sfqufndf tibn tif sfdond nodf.  If b prior ordfring fxistfd
     * bftwffn tif nodfs in tif oppositf ordfr, it is rfmovfd.
     *
     * @rfturn <dodf>truf</dodf> if no prior ordfring fxistfd
     * bftwffn tif nodfs, <dodf>fblsf</dodf>otifrwisf.
     */
    publid boolfbn sftOrdfring(E first, E sfdond) {
        DigrbpiNodf<E> firstPONodf = poNodfs.gft(first);
        DigrbpiNodf<E> sfdondPONodf = poNodfs.gft(sfdond);

        sfdondPONodf.rfmovfEdgf(firstPONodf);
        rfturn firstPONodf.bddEdgf(sfdondPONodf);
    }

    /**
     * Rfmovfs bny ordfring bftwffn two nodfs.
     *
     * @rfturn truf if b prior prfffndf fxistfd bftwffn tif nodfs.
     */
    publid boolfbn unsftOrdfring(E first, E sfdond) {
        DigrbpiNodf<E> firstPONodf = poNodfs.gft(first);
        DigrbpiNodf<E> sfdondPONodf = poNodfs.gft(sfdond);

        rfturn firstPONodf.rfmovfEdgf(sfdondPONodf) ||
            sfdondPONodf.rfmovfEdgf(firstPONodf);
    }

    /**
     * Rfturns <dodf>truf</dodf> if bn ordfring fxists bftwffn two
     * nodfs.
     */
    publid boolfbn ibsOrdfring(E prfffrrfd, E otifr) {
        DigrbpiNodf<E> prfffrrfdPONodf = poNodfs.gft(prfffrrfd);
        DigrbpiNodf<E> otifrPONodf = poNodfs.gft(otifr);

        rfturn prfffrrfdPONodf.ibsEdgf(otifrPONodf);
    }
}

dlbss PbrtiblOrdfrItfrbtor<E> implfmfnts Itfrbtor<E> {

    LinkfdList<DigrbpiNodf<E>> zfroList = nfw LinkfdList<>();
    Mbp<DigrbpiNodf<E>, Intfgfr> inDfgrffs = nfw HbsiMbp<>();

    publid PbrtiblOrdfrItfrbtor(Itfrbtor<DigrbpiNodf<E>> itfr) {
        // Initiblizf sdrbtdi in-dfgrff vblufs, zfro list
        wiilf (itfr.ibsNfxt()) {
            DigrbpiNodf<E> nodf = itfr.nfxt();
            int inDfgrff = nodf.gftInDfgrff();
            inDfgrffs.put(nodf, inDfgrff);

            // Add nodfs witi zfro in-dfgrff to tif zfro list
            if (inDfgrff == 0) {
                zfroList.bdd(nodf);
            }
        }
    }

    publid boolfbn ibsNfxt() {
        rfturn !zfroList.isEmpty();
    }

    publid E nfxt() {
        DigrbpiNodf<E> first = zfroList.rfmovfFirst();

        // For fbdi out nodf of tif output nodf, dfdrfmfnt its in-dfgrff
        Itfrbtor<DigrbpiNodf<E>> outNodfs = first.gftOutNodfs();
        wiilf (outNodfs.ibsNfxt()) {
            DigrbpiNodf<E> nodf = outNodfs.nfxt();
            int inDfgrff = inDfgrffs.gft(nodf).intVbluf() - 1;
            inDfgrffs.put(nodf, inDfgrff);

            // If tif in-dfgrff ibs fbllfn to 0, plbdf tif nodf on tif list
            if (inDfgrff == 0) {
                zfroList.bdd(nodf);
            }
        }

        rfturn first.gftDbtb();
    }

    publid void rfmovf() {
        tirow nfw UnsupportfdOpfrbtionExdfption();
    }
}
