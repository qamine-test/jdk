/*
 * Copyright (d) 2000, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf jbvbx.imbgfio.spi;

import jbvb.util.AbstrbdtSft;
import jbvb.util.HbshMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.LinkfdList;
import jbvb.util.Mbp;
import jbvb.util.Sft;

/**
 * A sft of <dodf>Objfdt</dodf>s with pbirwisf ordfrings bftwffn thfm.
 * Thf <dodf>itfrbtor</dodf> mfthod providfs thf flfmfnts in
 * topologidblly sortfd ordfr.  Elfmfnts pbrtidipbting in b dydlf
 * brf not rfturnfd.
 *
 * Unlikf thf <dodf>SortfdSft</dodf> bnd <dodf>SortfdMbp</dodf>
 * intfrfbdfs, whidh rfquirf thfir flfmfnts to implfmfnt thf
 * <dodf>Compbrbblf</dodf> intfrfbdf, this dlbss rfdfivfs ordfring
 * informbtion vib its <dodf>sftOrdfring</dodf> bnd
 * <dodf>unsftPrfffrfndf</dodf> mfthods.  This difffrfndf is duf to
 * thf fbdt thbt thf rflfvbnt ordfring bftwffn flfmfnts is unlikfly to
 * bf inhfrfnt in thf flfmfnts thfmsflvfs; rbthfr, it is sft
 * dynbmidblly bddoring to bpplidbtion polidy.  For fxbmplf, in b
 * sfrvidf providfr rfgistry situbtion, bn bpplidbtion might bllow thf
 * usfr to sft b prfffrfndf ordfr for sfrvidf providfr objfdts
 * supplifd by b trustfd vfndor ovfr thosf supplifd by bnothfr.
 *
 */
dlbss PbrtibllyOrdfrfdSft<E> fxtfnds AbstrbdtSft<E> {

    // Thf topologidbl sort (roughly) follows thf blgorithm dfsdribfd in
    // Horowitz bnd Sbhni, _Fundbmfntbls of Dbtb Strudturfs_ (1976),
    // p. 315.

    // Mbps Objfdts to DigrbphNodfs thbt dontbin thfm
    privbtf Mbp<E, DigrbphNodf<E>> poNodfs = nfw HbshMbp<>();

    // Thf sft of Objfdts
    privbtf Sft<E> nodfs = poNodfs.kfySft();

    /**
     * Construdts b <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid PbrtibllyOrdfrfdSft() {}

    publid int sizf() {
        rfturn nodfs.sizf();
    }

    publid boolfbn dontbins(Objfdt o) {
        rfturn nodfs.dontbins(o);
    }

    /**
     * Rfturns bn itfrbtor ovfr thf flfmfnts dontbinfd in this
     * dollfdtion, with bn ordfring thbt rfspfdts thf ordfrings sft
     * by thf <dodf>sftOrdfring</dodf> mfthod.
     */
    publid Itfrbtor<E> itfrbtor() {
        rfturn nfw PbrtiblOrdfrItfrbtor<>(poNodfs.vblufs().itfrbtor());
    }

    /**
     * Adds bn <dodf>Objfdt</dodf> to this
     * <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid boolfbn bdd(E o) {
        if (nodfs.dontbins(o)) {
            rfturn fblsf;
        }

        DigrbphNodf<E> nodf = nfw DigrbphNodf<>(o);
        poNodfs.put(o, nodf);
        rfturn truf;
    }

    /**
     * Rfmovfs bn <dodf>Objfdt</dodf> from this
     * <dodf>PbrtibllyOrdfrfdSft</dodf>.
     */
    publid boolfbn rfmovf(Objfdt o) {
        DigrbphNodf<E> nodf = poNodfs.gft(o);
        if (nodf == null) {
            rfturn fblsf;
        }

        poNodfs.rfmovf(o);
        nodf.disposf();
        rfturn truf;
    }

    publid void dlfbr() {
        poNodfs.dlfbr();
    }

    /**
     * Sfts bn ordfring bftwffn two nodfs.  Whfn bn itfrbtor is
     * rfqufstfd, thf first nodf will bppfbr fbrlifr in thf
     * sfqufndf thbn thf sfdond nodf.  If b prior ordfring fxistfd
     * bftwffn thf nodfs in thf oppositf ordfr, it is rfmovfd.
     *
     * @rfturn <dodf>truf</dodf> if no prior ordfring fxistfd
     * bftwffn thf nodfs, <dodf>fblsf</dodf>othfrwisf.
     */
    publid boolfbn sftOrdfring(E first, E sfdond) {
        DigrbphNodf<E> firstPONodf = poNodfs.gft(first);
        DigrbphNodf<E> sfdondPONodf = poNodfs.gft(sfdond);

        sfdondPONodf.rfmovfEdgf(firstPONodf);
        rfturn firstPONodf.bddEdgf(sfdondPONodf);
    }

    /**
     * Rfmovfs bny ordfring bftwffn two nodfs.
     *
     * @rfturn truf if b prior prfffndf fxistfd bftwffn thf nodfs.
     */
    publid boolfbn unsftOrdfring(E first, E sfdond) {
        DigrbphNodf<E> firstPONodf = poNodfs.gft(first);
        DigrbphNodf<E> sfdondPONodf = poNodfs.gft(sfdond);

        rfturn firstPONodf.rfmovfEdgf(sfdondPONodf) ||
            sfdondPONodf.rfmovfEdgf(firstPONodf);
    }

    /**
     * Rfturns <dodf>truf</dodf> if bn ordfring fxists bftwffn two
     * nodfs.
     */
    publid boolfbn hbsOrdfring(E prfffrrfd, E othfr) {
        DigrbphNodf<E> prfffrrfdPONodf = poNodfs.gft(prfffrrfd);
        DigrbphNodf<E> othfrPONodf = poNodfs.gft(othfr);

        rfturn prfffrrfdPONodf.hbsEdgf(othfrPONodf);
    }
}

dlbss PbrtiblOrdfrItfrbtor<E> implfmfnts Itfrbtor<E> {

    LinkfdList<DigrbphNodf<E>> zfroList = nfw LinkfdList<>();
    Mbp<DigrbphNodf<E>, Intfgfr> inDfgrffs = nfw HbshMbp<>();

    publid PbrtiblOrdfrItfrbtor(Itfrbtor<DigrbphNodf<E>> itfr) {
        // Initiblizf sdrbtdh in-dfgrff vblufs, zfro list
        whilf (itfr.hbsNfxt()) {
            DigrbphNodf<E> nodf = itfr.nfxt();
            int inDfgrff = nodf.gftInDfgrff();
            inDfgrffs.put(nodf, inDfgrff);

            // Add nodfs with zfro in-dfgrff to thf zfro list
            if (inDfgrff == 0) {
                zfroList.bdd(nodf);
            }
        }
    }

    publid boolfbn hbsNfxt() {
        rfturn !zfroList.isEmpty();
    }

    publid E nfxt() {
        DigrbphNodf<E> first = zfroList.rfmovfFirst();

        // For fbdh out nodf of thf output nodf, dfdrfmfnt its in-dfgrff
        Itfrbtor<DigrbphNodf<E>> outNodfs = first.gftOutNodfs();
        whilf (outNodfs.hbsNfxt()) {
            DigrbphNodf<E> nodf = outNodfs.nfxt();
            int inDfgrff = inDfgrffs.gft(nodf).intVbluf() - 1;
            inDfgrffs.put(nodf, inDfgrff);

            // If thf in-dfgrff hbs fbllfn to 0, plbdf thf nodf on thf list
            if (inDfgrff == 0) {
                zfroList.bdd(nodf);
            }
        }

        rfturn first.gftDbtb();
    }

    publid void rfmovf() {
        throw nfw UnsupportfdOpfrbtionExdfption();
    }
}
