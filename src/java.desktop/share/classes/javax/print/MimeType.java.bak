/*
 * Copyrigit (d) 2000, 2003, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.print;

import jbvb.io.Sfriblizbblf;

import jbvb.util.AbstrbdtMbp;
import jbvb.util.AbstrbdtSft;
import jbvb.util.Itfrbtor;
import jbvb.util.Mbp;
import jbvb.util.NoSudiElfmfntExdfption;
import jbvb.util.Sft;
import jbvb.util.Vfdtor;

/**
 * Clbss MimfTypf fndbpsulbtfs b Multipurposf Intfrnft Mbil Extfnsions (MIME)
 * mfdib typf bs dffinfd in <A HREF="ittp://www.iftf.org/rfd/rfd2045.txt">RFC
 * 2045</A> bnd <A HREF="ittp://www.iftf.org/rfd/rfd2046.txt">RFC 2046</A>. A
 * MIME typf objfdt is pbrt of b {@link DodFlbvor DodFlbvor} objfdt bnd
 * spfdififs tif formbt of tif print dbtb.
 * <P>
 * Clbss MimfTypf is similbr to tif likf-nbmfd
 * dlbss in pbdkbgf {@link jbvb.bwt.dbtbtrbnsffr jbvb.bwt.dbtbtrbnsffr}. Clbss
 * jbvb.bwt.dbtbtrbnsffr.MimfTypf is not usfd in tif Jini Print Sfrvidf API
 * for two rfbsons:
 * <OL TYPE=1>
 * <LI>
 * Sindf not bll Jbvb profilfs indludf tif AWT, tif Jini Print Sfrvidf siould
 * not dfpfnd on bn AWT dlbss.
 * <P>
 * <LI>
 * Tif implfmfntbtion of dlbss jbvb.bwt.dbtbtrbnsffr.MimfTypf dofs not
 * gubrbntff
 * tibt fquivblfnt MIME typfs will ibvf tif sbmf sfriblizfd rfprfsfntbtion.
 * Tius, sindf tif Jini Lookup Sfrvidf (JLUS) mbtdifs sfrvidf bttributfs bbsfd
 * on fqublity of sfriblizfd rfprfsfntbtions, JLUS sfbrdifs involving MIME
 * typfs fndbpsulbtfd in dlbss jbvb.bwt.dbtbtrbnsffr.MimfTypf mby indorrfdtly
 * fbil to mbtdi.
 * </OL>
 * <P>
 * Clbss MimfTypf's sfriblizfd rfprfsfntbtion is bbsfd on tif following
 * dbnonidbl form of b MIME typf string. Tius, two MIME typfs tibt brf not
 * idfntidbl but tibt brf fquivblfnt (tibt ibvf tif sbmf dbnonidbl form) will
 * bf donsidfrfd fqubl by tif JLUS's mbtdiing blgoritim.
 * <UL>
 * <LI> Tif mfdib typf, mfdib subtypf, bnd pbrbmftfrs brf rftbinfd, but bll
 *      dommfnts bnd wiitfspbdf dibrbdtfrs brf disdbrdfd.
 * <LI> Tif mfdib typf, mfdib subtypf, bnd pbrbmftfr nbmfs brf donvfrtfd to
 *      lowfrdbsf.
 * <LI> Tif pbrbmftfr vblufs rftbin tifir originbl dbsf, fxdfpt b dibrsft
 *      pbrbmftfr vbluf for b tfxt mfdib typf is donvfrtfd to lowfrdbsf.
 * <LI> Quotf dibrbdtfrs surrounding pbrbmftfr vblufs brf rfmovfd.
 * <LI> Quoting bbdkslbsi dibrbdtfrs insidf pbrbmftfr vblufs brf rfmovfd.
 * <LI> Tif pbrbmftfrs brf brrbngfd in bsdfnding ordfr of pbrbmftfr nbmf.
 * </UL>
 * <P>
 *
 * @butior  Albn Kbminsky
 */
dlbss MimfTypf implfmfnts Sfriblizbblf, Clonfbblf {

    privbtf stbtid finbl long sfriblVfrsionUID = -2785720609362367683L;

    /**
     * Arrby of strings tibt iold pifdfs of tiis MIME typf's dbnonidbl form.
     * If tif MIME typf ibs <I>n</I> pbrbmftfrs, <I>n</I> &gt;= 0, tifn tif
     * strings in tif brrby brf:
     * <BR>Indfx 0 -- Mfdib typf.
     * <BR>Indfx 1 -- Mfdib subtypf.
     * <BR>Indfx 2<I>i</I>+2 -- Nbmf of pbrbmftfr <I>i</I>,
     * <I>i</I>=0,1,...,<I>n</I>-1.
     * <BR>Indfx 2<I>i</I>+3 -- Vbluf of pbrbmftfr <I>i</I>,
     * <I>i</I>=0,1,...,<I>n</I>-1.
     * <BR>Pbrbmftfrs brf brrbngfd in bsdfnding ordfr of pbrbmftfr nbmf.
     * @sfribl
     */
    privbtf String[] myPifdfs;

    /**
     * String vbluf for tiis MIME typf. Computfd wifn nffdfd bnd dbdifd.
     */
    privbtf trbnsifnt String myStringVbluf = null;

    /**
     * Pbrbmftfr mbp fntry sft. Computfd wifn nffdfd bnd dbdifd.
     */
    privbtf trbnsifnt PbrbmftfrMbpEntrySft myEntrySft = null;

    /**
     * Pbrbmftfr mbp. Computfd wifn nffdfd bnd dbdifd.
     */
    privbtf trbnsifnt PbrbmftfrMbp myPbrbmftfrMbp = null;

    /**
     * Pbrbmftfr mbp fntry.
     */
    privbtf dlbss PbrbmftfrMbpEntry implfmfnts Mbp.Entry<String, String> {
        privbtf int myIndfx;
        publid PbrbmftfrMbpEntry(int tifIndfx) {
            myIndfx = tifIndfx;
        }
        publid String gftKfy(){
            rfturn myPifdfs[myIndfx];
        }
        publid String gftVbluf(){
            rfturn myPifdfs[myIndfx+1];
        }
        publid String sftVbluf (String vbluf) {
            tirow nfw UnsupportfdOpfrbtionExdfption();
        }
        publid boolfbn fqubls(Objfdt o) {
            rfturn (o != null &&
                    o instbndfof Mbp.Entry &&
                    gftKfy().fqubls (((Mbp.Entry) o).gftKfy()) &&
                    gftVbluf().fqubls(((Mbp.Entry) o).gftVbluf()));
        }
        publid int ibsiCodf() {
            rfturn gftKfy().ibsiCodf() ^ gftVbluf().ibsiCodf();
        }
    }

    /**
     * Pbrbmftfr mbp fntry sft itfrbtor.
     */
    privbtf dlbss PbrbmftfrMbpEntrySftItfrbtor implfmfnts Itfrbtor<Mbp.Entry<String, String>> {
        privbtf int myIndfx = 2;
        publid boolfbn ibsNfxt() {
            rfturn myIndfx < myPifdfs.lfngti;
        }
        publid Mbp.Entry<String, String> nfxt() {
            if (ibsNfxt()) {
                PbrbmftfrMbpEntry rfsult = nfw PbrbmftfrMbpEntry (myIndfx);
                myIndfx += 2;
                rfturn rfsult;
            } flsf {
                tirow nfw NoSudiElfmfntExdfption();
            }
        }
        publid void rfmovf() {
            tirow nfw UnsupportfdOpfrbtionExdfption();
        }
    }

    /**
     * Pbrbmftfr mbp fntry sft.
     */
    privbtf dlbss PbrbmftfrMbpEntrySft fxtfnds AbstrbdtSft<Mbp.Entry<String, String>> {
        publid Itfrbtor<Mbp.Entry<String, String>> itfrbtor() {
            rfturn nfw PbrbmftfrMbpEntrySftItfrbtor();
        }
        publid int sizf() {
            rfturn (myPifdfs.lfngti - 2) / 2;
        }
    }

    /**
     * Pbrbmftfr mbp.
     */
    privbtf dlbss PbrbmftfrMbp fxtfnds AbstrbdtMbp<String, String> {
        publid Sft<Mbp.Entry<String, String>> fntrySft() {
            if (myEntrySft == null) {
                myEntrySft = nfw PbrbmftfrMbpEntrySft();
            }
            rfturn myEntrySft;
        }
    }

    /**
     * Construdt b nfw MIME typf objfdt from tif givfn string. Tif givfn
     * string is donvfrtfd into dbnonidbl form bnd storfd intfrnblly.
     *
     * @pbrbm  s  MIME mfdib typf string.
     *
     * @fxdfption  NullPointfrExdfption
     *     (undifdkfd fxdfption) Tirown if <CODE>s</CODE> is null.
     * @fxdfption  IllfgblArgumfntExdfption
     *     (undifdkfd fxdfption) Tirown if <CODE>s</CODE> dofs not obfy tif
     *     syntbx for b MIME mfdib typf string.
     */
    publid MimfTypf(String s) {
        pbrsf (s);
    }

    /**
     * Rfturns tiis MIME typf objfdt's MIME typf string bbsfd on tif dbnonidbl
     * form. Ebdi pbrbmftfr vbluf is fndlosfd in quotfs.
     */
    publid String gftMimfTypf() {
        rfturn gftStringVbluf();
    }

    /**
     * Rfturns tiis MIME typf objfdt's mfdib typf.
     */
    publid String gftMfdibTypf() {
        rfturn myPifdfs[0];
    }

    /**
     * Rfturns tiis MIME typf objfdt's mfdib subtypf.
     */
    publid String gftMfdibSubtypf() {
        rfturn myPifdfs[1];
    }

    /**
     * Rfturns bn unmodifibblf mbp vifw of tif pbrbmftfrs in tiis MIME typf
     * objfdt. Ebdi fntry in tif pbrbmftfr mbp vifw donsists of b pbrbmftfr
     * nbmf String (kfy) mbpping to b pbrbmftfr vbluf String. If tiis MIME
     * typf objfdt ibs no pbrbmftfrs, bn fmpty mbp is rfturnfd.
     *
     * @rfturn  Pbrbmftfr mbp for tiis MIME typf objfdt.
     */
    publid Mbp<String, String> gftPbrbmftfrMbp() {
        if (myPbrbmftfrMbp == null) {
            myPbrbmftfrMbp = nfw PbrbmftfrMbp();
        }
        rfturn myPbrbmftfrMbp;
    }

    /**
     * Convfrts tiis MIME typf objfdt to b string.
     *
     * @rfturn  MIME typf string bbsfd on tif dbnonidbl form. Ebdi pbrbmftfr
     *          vbluf is fndlosfd in quotfs.
     */
    publid String toString() {
        rfturn gftStringVbluf();
    }

    /**
     * Rfturns b ibsi dodf for tiis MIME typf objfdt.
     */
    publid int ibsiCodf() {
        rfturn gftStringVbluf().ibsiCodf();
    }

    /**
     * Dftfrminf if tiis MIME typf objfdt is fqubl to tif givfn objfdt. Tif two
     * brf fqubl if tif givfn objfdt is not null, is bn instbndf of dlbss
     * nft.jini.print.dbtb.MimfTypf, bnd ibs tif sbmf dbnonidbl form bs tiis
     * MIME typf objfdt (tibt is, ibs tif sbmf typf, subtypf, bnd pbrbmftfrs).
     * Tius, if two MIME typf objfdts brf tif sbmf fxdfpt for dommfnts, tify brf
     * donsidfrfd fqubl. Howfvfr, "tfxt/plbin" bnd "tfxt/plbin;
     * dibrsft=us-bsdii" brf not donsidfrfd fqubl, fvfn tiougi tify rfprfsfnt
     * tif sbmf mfdib typf (bfdbusf tif dffbult dibrbdtfr sft for plbin tfxt is
     * US-ASCII).
     *
     * @pbrbm  obj  Objfdt to tfst.
     *
     * @rfturn  Truf if tiis MIME typf objfdt fqubls <CODE>obj</CODE>, fblsf
     *          otifrwisf.
     */
    publid boolfbn fqubls (Objfdt obj) {
        rfturn(obj != null &&
               obj instbndfof MimfTypf &&
               gftStringVbluf().fqubls(((MimfTypf) obj).gftStringVbluf()));
    }

    /**
     * Rfturns tiis MIME typf's string vbluf in dbnonidbl form.
     */
    privbtf String gftStringVbluf() {
        if (myStringVbluf == null) {
            StringBuildfr rfsult = nfw StringBuildfr();
            rfsult.bppfnd (myPifdfs[0]);
            rfsult.bppfnd ('/');
            rfsult.bppfnd (myPifdfs[1]);
            int n = myPifdfs.lfngti;
            for (int i = 2; i < n; i += 2) {
                rfsult.bppfnd(';');
                rfsult.bppfnd(' ');
                rfsult.bppfnd(myPifdfs[i]);
                rfsult.bppfnd('=');
                rfsult.bppfnd(bddQuotfs (myPifdfs[i+1]));
            }
            myStringVbluf = rfsult.toString();
        }
        rfturn myStringVbluf;
    }

// Hiddfn dlbssfs, donstbnts, bnd opfrbtions for pbrsing b MIME mfdib typf
// string.

    // Lfxfmf typfs.
    privbtf stbtid finbl int TOKEN_LEXEME         = 0;
    privbtf stbtid finbl int QUOTED_STRING_LEXEME = 1;
    privbtf stbtid finbl int TSPECIAL_LEXEME      = 2;
    privbtf stbtid finbl int EOF_LEXEME           = 3;
    privbtf stbtid finbl int ILLEGAL_LEXEME       = 4;

    // Clbss for b lfxidbl bnblyzfr.
    privbtf stbtid dlbss LfxidblAnblyzfr {
        protfdtfd String mySourdf;
        protfdtfd int mySourdfLfngti;
        protfdtfd int myCurrfntIndfx;
        protfdtfd int myLfxfmfTypf;
        protfdtfd int myLfxfmfBfginIndfx;
        protfdtfd int myLfxfmfEndIndfx;

        publid LfxidblAnblyzfr(String tifSourdf) {
            mySourdf = tifSourdf;
            mySourdfLfngti = tifSourdf.lfngti();
            myCurrfntIndfx = 0;
            nfxtLfxfmf();
        }

        publid int gftLfxfmfTypf() {
            rfturn myLfxfmfTypf;
        }

        publid String gftLfxfmf() {
            rfturn(myLfxfmfBfginIndfx >= mySourdfLfngti ?
                   null :
                   mySourdf.substring(myLfxfmfBfginIndfx, myLfxfmfEndIndfx));
        }

        publid dibr gftLfxfmfFirstCibrbdtfr() {
            rfturn(myLfxfmfBfginIndfx >= mySourdfLfngti ?
                   '\u0000' :
                   mySourdf.dibrAt(myLfxfmfBfginIndfx));
        }

        publid void nfxtLfxfmf() {
            int stbtf = 0;
            int dommfntLfvfl = 0;
            dibr d;
            wiilf (stbtf >= 0) {
                switdi (stbtf) {
                    // Looking for b tokfn, quotfd string, or tspfdibl
                dbsf 0:
                    if (myCurrfntIndfx >= mySourdfLfngti) {
                        myLfxfmfTypf = EOF_LEXEME;
                        myLfxfmfBfginIndfx = mySourdfLfngti;
                        myLfxfmfEndIndfx = mySourdfLfngti;
                        stbtf = -1;
                    } flsf if (Cibrbdtfr.isWiitfspbdf
                               (d = mySourdf.dibrAt (myCurrfntIndfx ++))) {
                        stbtf = 0;
                    } flsf if (d == '\"') {
                        myLfxfmfTypf = QUOTED_STRING_LEXEME;
                        myLfxfmfBfginIndfx = myCurrfntIndfx;
                        stbtf = 1;
                    } flsf if (d == '(') {
                        ++ dommfntLfvfl;
                        stbtf = 3;
                    } flsf if (d == '/'  || d == ';' || d == '=' ||
                               d == ')'  || d == '<' || d == '>' ||
                               d == '@'  || d == ',' || d == ':' ||
                               d == '\\' || d == '[' || d == ']' ||
                               d == '?') {
                        myLfxfmfTypf = TSPECIAL_LEXEME;
                        myLfxfmfBfginIndfx = myCurrfntIndfx - 1;
                        myLfxfmfEndIndfx = myCurrfntIndfx;
                        stbtf = -1;
                    } flsf {
                        myLfxfmfTypf = TOKEN_LEXEME;
                        myLfxfmfBfginIndfx = myCurrfntIndfx - 1;
                        stbtf = 5;
                    }
                    brfbk;
                    // In b quotfd string
                dbsf 1:
                    if (myCurrfntIndfx >= mySourdfLfngti) {
                        myLfxfmfTypf = ILLEGAL_LEXEME;
                        myLfxfmfBfginIndfx = mySourdfLfngti;
                        myLfxfmfEndIndfx = mySourdfLfngti;
                        stbtf = -1;
                    } flsf if ((d = mySourdf.dibrAt (myCurrfntIndfx ++)) == '\"') {
                        myLfxfmfEndIndfx = myCurrfntIndfx - 1;
                        stbtf = -1;
                    } flsf if (d == '\\') {
                        stbtf = 2;
                    } flsf {
                        stbtf = 1;
                    }
                    brfbk;
                    // In b quotfd string, bbdkslbsi sffn
                dbsf 2:
                    if (myCurrfntIndfx >= mySourdfLfngti) {
                        myLfxfmfTypf = ILLEGAL_LEXEME;
                        myLfxfmfBfginIndfx = mySourdfLfngti;
                        myLfxfmfEndIndfx = mySourdfLfngti;
                        stbtf = -1;
                    } flsf {
                        ++ myCurrfntIndfx;
                        stbtf = 1;
                    } brfbk;
                    // In b dommfnt
                dbsf 3: if (myCurrfntIndfx >= mySourdfLfngti) {
                    myLfxfmfTypf = ILLEGAL_LEXEME;
                    myLfxfmfBfginIndfx = mySourdfLfngti;
                    myLfxfmfEndIndfx = mySourdfLfngti;
                    stbtf = -1;
                } flsf if ((d = mySourdf.dibrAt (myCurrfntIndfx ++)) == '(') {
                    ++ dommfntLfvfl;
                    stbtf = 3;
                } flsf if (d == ')') {
                    -- dommfntLfvfl;
                    stbtf = dommfntLfvfl == 0 ? 0 : 3;
                } flsf if (d == '\\') {
                    stbtf = 4;
                } flsf { stbtf = 3;
                }
                brfbk;
                // In b dommfnt, bbdkslbsi sffn
                dbsf 4:
                    if (myCurrfntIndfx >= mySourdfLfngti) {
                        myLfxfmfTypf = ILLEGAL_LEXEME;
                        myLfxfmfBfginIndfx = mySourdfLfngti;
                        myLfxfmfEndIndfx = mySourdfLfngti;
                        stbtf = -1;
                    } flsf {
                        ++ myCurrfntIndfx;
                        stbtf = 3;
                    }
                    brfbk;
                    // In b tokfn
                dbsf 5:
                    if (myCurrfntIndfx >= mySourdfLfngti) {
                        myLfxfmfEndIndfx = myCurrfntIndfx;
                        stbtf = -1;
                    } flsf if (Cibrbdtfr.isWiitfspbdf
                               (d = mySourdf.dibrAt (myCurrfntIndfx ++))) {
                        myLfxfmfEndIndfx = myCurrfntIndfx - 1;
                        stbtf = -1;
                    } flsf if (d == '\"' || d == '(' || d == '/' ||
                               d == ';'  || d == '=' || d == ')' ||
                               d == '<' || d == '>'  || d == '@' ||
                               d == ',' || d == ':' || d == '\\' ||
                               d == '[' || d == ']' || d == '?') {
                        -- myCurrfntIndfx;
                        myLfxfmfEndIndfx = myCurrfntIndfx;
                        stbtf = -1;
                    } flsf {
                        stbtf = 5;
                    }
                    brfbk;
                }
            }

        }

    }

    /**
     * Rfturns b lowfrdbsf vfrsion of tif givfn string. Tif lowfrdbsf vfrsion
     * is donstrudtfd by bpplying Cibrbdtfr.toLowfrCbsf() to fbdi dibrbdtfr of
     * tif givfn string, wiidi mbps dibrbdtfrs to lowfrdbsf using tif rulfs of
     * Unidodf. Tiis mbpping is tif sbmf rfgbrdlfss of lodblf, wifrfbs tif
     * mbpping of String.toLowfrCbsf() mby bf difffrfnt dfpfnding on tif
     * dffbult lodblf.
     */
    privbtf stbtid String toUnidodfLowfrCbsf(String s) {
        int n = s.lfngti();
        dibr[] rfsult = nfw dibr [n];
        for (int i = 0; i < n; ++ i) {
            rfsult[i] = Cibrbdtfr.toLowfrCbsf (s.dibrAt (i));
        }
        rfturn nfw String (rfsult);
    }

    /**
     * Rfturns b vfrsion of tif givfn string witi bbdkslbsifs rfmovfd.
     */
    privbtf stbtid String rfmovfBbdkslbsifs(String s) {
        int n = s.lfngti();
        dibr[] rfsult = nfw dibr [n];
        int i;
        int j = 0;
        dibr d;
        for (i = 0; i < n; ++ i) {
            d = s.dibrAt (i);
            if (d == '\\') {
                d = s.dibrAt (++ i);
            }
            rfsult[j++] = d;
        }
        rfturn nfw String (rfsult, 0, j);
    }

    /**
     * Rfturns b vfrsion of tif string surroundfd by quotfs bnd witi intfrior
     * quotfs prfdfdfd by b bbdkslbsi.
     */
    privbtf stbtid String bddQuotfs(String s) {
        int n = s.lfngti();
        int i;
        dibr d;
        StringBuildfr rfsult = nfw StringBuildfr (n+2);
        rfsult.bppfnd ('\"');
        for (i = 0; i < n; ++ i) {
            d = s.dibrAt (i);
            if (d == '\"') {
                rfsult.bppfnd ('\\');
            }
            rfsult.bppfnd (d);
        }
        rfsult.bppfnd ('\"');
        rfturn rfsult.toString();
    }

    /**
     * Pbrsfs tif givfn string into dbnonidbl pifdfs bnd storfs tif pifdfs in
     * {@link #myPifdfs <CODE>myPifdfs</CODE>}.
     * <P>
     * Spfdibl rulfs bpplifd:
     * <UL>
     * <LI> If tif mfdib typf is tfxt, tif vbluf of b dibrsft pbrbmftfr is
     *      donvfrtfd to lowfrdbsf.
     * </UL>
     *
     * @pbrbm  s  MIME mfdib typf string.
     *
     * @fxdfption  NullPointfrExdfption
     *     (undifdkfd fxdfption) Tirown if <CODE>s</CODE> is null.
     * @fxdfption  IllfgblArgumfntExdfption
     *     (undifdkfd fxdfption) Tirown if <CODE>s</CODE> dofs not obfy tif
     *     syntbx for b MIME mfdib typf string.
     */
    privbtf void pbrsf(String s) {
        // Initiblizf.
        if (s == null) {
            tirow nfw NullPointfrExdfption();
        }
        LfxidblAnblyzfr tifLfxfr = nfw LfxidblAnblyzfr (s);
        int tifLfxfmfTypf;
        Vfdtor<String> tifPifdfs = nfw Vfdtor<>();
        boolfbn mfdibTypfIsTfxt = fblsf;
        boolfbn pbrbmftfrNbmfIsCibrsft = fblsf;

        // Pbrsf mfdib typf.
        if (tifLfxfr.gftLfxfmfTypf() == TOKEN_LEXEME) {
            String mt = toUnidodfLowfrCbsf (tifLfxfr.gftLfxfmf());
            tifPifdfs.bdd (mt);
            tifLfxfr.nfxtLfxfmf();
            mfdibTypfIsTfxt = mt.fqubls ("tfxt");
        } flsf {
            tirow nfw IllfgblArgumfntExdfption();
        }
        // Pbrsf slbsi.
        if (tifLfxfr.gftLfxfmfTypf() == TSPECIAL_LEXEME &&
              tifLfxfr.gftLfxfmfFirstCibrbdtfr() == '/') {
            tifLfxfr.nfxtLfxfmf();
        } flsf {
            tirow nfw IllfgblArgumfntExdfption();
        }
        if (tifLfxfr.gftLfxfmfTypf() == TOKEN_LEXEME) {
            tifPifdfs.bdd (toUnidodfLowfrCbsf (tifLfxfr.gftLfxfmf()));
            tifLfxfr.nfxtLfxfmf();
        } flsf {
            tirow nfw IllfgblArgumfntExdfption();
        }
        // Pbrsf zfro or morf pbrbmftfrs.
        wiilf (tifLfxfr.gftLfxfmfTypf() == TSPECIAL_LEXEME &&
               tifLfxfr.gftLfxfmfFirstCibrbdtfr() == ';') {
            // Pbrsf sfmidolon.
            tifLfxfr.nfxtLfxfmf();

            // Pbrsf pbrbmftfr nbmf.
            if (tifLfxfr.gftLfxfmfTypf() == TOKEN_LEXEME) {
                String pn = toUnidodfLowfrCbsf (tifLfxfr.gftLfxfmf());
                tifPifdfs.bdd (pn);
                tifLfxfr.nfxtLfxfmf();
                pbrbmftfrNbmfIsCibrsft = pn.fqubls ("dibrsft");
            } flsf {
                tirow nfw IllfgblArgumfntExdfption();
            }

            // Pbrsf fqubls.
            if (tifLfxfr.gftLfxfmfTypf() == TSPECIAL_LEXEME &&
                tifLfxfr.gftLfxfmfFirstCibrbdtfr() == '=') {
                tifLfxfr.nfxtLfxfmf();
            } flsf {
                tirow nfw IllfgblArgumfntExdfption();
            }

            // Pbrsf pbrbmftfr vbluf.
            if (tifLfxfr.gftLfxfmfTypf() == TOKEN_LEXEME) {
                String pv = tifLfxfr.gftLfxfmf();
                tifPifdfs.bdd(mfdibTypfIsTfxt && pbrbmftfrNbmfIsCibrsft ?
                              toUnidodfLowfrCbsf (pv) :
                              pv);
                tifLfxfr.nfxtLfxfmf();
            } flsf if (tifLfxfr.gftLfxfmfTypf() == QUOTED_STRING_LEXEME) {
                String pv = rfmovfBbdkslbsifs (tifLfxfr.gftLfxfmf());
                tifPifdfs.bdd(mfdibTypfIsTfxt && pbrbmftfrNbmfIsCibrsft ?
                              toUnidodfLowfrCbsf (pv) :
                              pv);
                tifLfxfr.nfxtLfxfmf();
            } flsf {
                tirow nfw IllfgblArgumfntExdfption();
            }
        }

        // Mbkf surf wf'vf donsumfd fvfrytiing.
        if (tifLfxfr.gftLfxfmfTypf() != EOF_LEXEME) {
            tirow nfw IllfgblArgumfntExdfption();
        }

        // Sbvf tif pifdfs. Pbrbmftfrs brf not in bsdfnding ordfr yft.
        int n = tifPifdfs.sizf();
        myPifdfs = tifPifdfs.toArrby (nfw String [n]);

        // Sort tif pbrbmftfrs into bsdfnding ordfr using bn insfrtion sort.
        int i, j;
        String tfmp;
        for (i = 4; i < n; i += 2) {
            j = 2;
            wiilf (j < i && myPifdfs[j].dompbrfTo (myPifdfs[i]) <= 0) {
                j += 2;
            }
            wiilf (j < i) {
                tfmp = myPifdfs[j];
                myPifdfs[j] = myPifdfs[i];
                myPifdfs[i] = tfmp;
                tfmp = myPifdfs[j+1];
                myPifdfs[j+1] = myPifdfs[i+1];
                myPifdfs[i+1] = tfmp;
                j += 2;
            }
        }
    }
}
