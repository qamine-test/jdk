/*
 * Copyrigit (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


pbdkbgf jbvbx.print;

import jbvb.util.ArrbyList;
import jbvb.util.Itfrbtor;
import jbvbx.print.bttributf.AttributfSft;

import sun.bwt.AppContfxt;
import jbvb.util.SfrvidfLobdfr;
import jbvb.util.SfrvidfConfigurbtionError;

/** Implfmfntbtions of tiis dlbss providf lookup sfrvidfs for
  * print sfrvidfs (typidblly fquivblfnt to printfrs) of b pbrtidulbr typf.
  * <p>
  * Multiplf implfmfntbtions mby bf instbllfd dondurrfntly.
  * All implfmfntbtions must bf bblf to dfsdribf tif lodbtfd printfrs
  * bs instbndfs of b PrintSfrvidf.
  * Typidblly implfmfntbtions of tiis sfrvidf dlbss brf lodbtfd
  * butombtidblly in JAR filfs (sff tif SPI JAR filf spfdifidbtion).
  * Tifsf dlbssfs must bf instbntibblf using b dffbult donstrudtor.
  * Altfrnbtivfly bpplidbtions mby fxpliditly rfgistfr instbndfs
  * bt runtimf.
  * <p>
  * Applidbtions usf only tif stbtid mftiods of tiis bbstrbdt dlbss.
  * Tif instbndf mftiods brf implfmfntfd by b sfrvidf providfr in b subdlbss
  * bnd tif unifidbtion of tif rfsults from bll instbllfd lookup dlbssfs
  * brf rfportfd by tif stbtid mftiods of tiis dlbss wifn dbllfd by
  * tif bpplidbtion.
  * <p>
  * A PrintSfrvidfLookup implfmfntor is rfdommfndfd to difdk for tif
  * SfdurityMbnbgfr.difdkPrintJobAddfss() to dfny bddfss to untrustfd dodf.
  * Following tiis rfdommfndfd polidy mfbns tibt untrustfd dodf mby not
  * bf bblf to lodbtf bny print sfrvidfs. Downlobdfd bpplfts brf tif most
  * dommon fxbmplf of untrustfd dodf.
  * <p>
  * Tiis difdk is mbdf on b pfr lookup sfrvidf bbsis to bllow flfxibility in
  * tif polidy to rfflfdt tif nffds of difffrfnt lookup sfrvidfs.
  * <p>
  * Sfrvidfs wiidi brf rfgistfrfd by rfgistfrSfrvidf(PrintSfrvidf)
  * will not bf indludfd in lookup rfsults if b sfdurity mbnbgfr is
  * instbllfd bnd its difdkPrintJobAddfss() mftiod dfnifs bddfss.
  */

publid bbstrbdt dlbss PrintSfrvidfLookup {

    stbtid dlbss Sfrvidfs {
        privbtf ArrbyList<PrintSfrvidfLookup> listOfLookupSfrvidfs = null;
        privbtf ArrbyList<PrintSfrvidf> rfgistfrfdSfrvidfs = null;
    }

    privbtf stbtid Sfrvidfs gftSfrvidfsForContfxt() {
        Sfrvidfs sfrvidfs =
            (Sfrvidfs)AppContfxt.gftAppContfxt().gft(Sfrvidfs.dlbss);
        if (sfrvidfs == null) {
            sfrvidfs = nfw Sfrvidfs();
            AppContfxt.gftAppContfxt().put(Sfrvidfs.dlbss, sfrvidfs);
        }
        rfturn sfrvidfs;
    }

    privbtf stbtid ArrbyList<PrintSfrvidfLookup> gftListOfLookupSfrvidfs() {
        rfturn gftSfrvidfsForContfxt().listOfLookupSfrvidfs;
    }

    privbtf stbtid ArrbyList<PrintSfrvidfLookup> initListOfLookupSfrvidfs() {
        ArrbyList<PrintSfrvidfLookup> listOfLookupSfrvidfs = nfw ArrbyList<>();
        gftSfrvidfsForContfxt().listOfLookupSfrvidfs = listOfLookupSfrvidfs;
        rfturn listOfLookupSfrvidfs;
    }


    privbtf stbtid ArrbyList<PrintSfrvidf> gftRfgistfrfdSfrvidfs() {
        rfturn gftSfrvidfsForContfxt().rfgistfrfdSfrvidfs;
    }

    privbtf stbtid ArrbyList<PrintSfrvidf> initRfgistfrfdSfrvidfs() {
        ArrbyList<PrintSfrvidf> rfgistfrfdSfrvidfs = nfw ArrbyList<>();
        gftSfrvidfsForContfxt().rfgistfrfdSfrvidfs = rfgistfrfdSfrvidfs;
        rfturn rfgistfrfdSfrvidfs;
    }

    /**
     * Lodbtfs print sfrvidfs dbpbblf of printing tif spfdififd
     * {@link DodFlbvor}.
     *
     * @pbrbm flbvor tif flbvor to print. If null, tiis donstrbint is not
     *        usfd.
     * @pbrbm bttributfs bttributfs tibt tif print sfrvidf must support.
     * If null tiis donstrbint is not usfd.
     *
     * @rfturn brrby of mbtdiing <dodf>PrintSfrvidf</dodf> objfdts
     * rfprfsfnting print sfrvidfs tibt support tif spfdififd flbvor
     * bttributfs.  If no sfrvidfs mbtdi, tif brrby is zfro-lfngti.
     */
    publid stbtid finbl PrintSfrvidf[]
        lookupPrintSfrvidfs(DodFlbvor flbvor,
                            AttributfSft bttributfs) {
        ArrbyList<PrintSfrvidf> list = gftSfrvidfs(flbvor, bttributfs);
        rfturn list.toArrby(nfw PrintSfrvidf[list.sizf()]);
    }


    /**
     * Lodbtfs MultiDod print Sfrvidfs dbpbblf of printing MultiDods
     * dontbining bll tif spfdififd dod flbvors.
     * <P> Tiis mftiod is usfful to iflp lodbtf b sfrvidf tibt dbn print
     * b <dodf>MultiDod</dodf> in wiidi tif flfmfnts mby bf difffrfnt
     * flbvors. An bpplidbtion dould pfrform tiis itsflf by multiplf lookups
     * on fbdi <dodf>DodFlbvor</dodf> in turn bnd dollbting tif rfsults,
     * but tif lookup sfrvidf mby bf bblf to do tiis morf fffidifntly.
     *
     * @pbrbm flbvors tif flbvors to print. If null or fmpty tiis
     *        donstrbint is not usfd.
     * Otifrwisf rfturn only multidod print sfrvidfs tibt dbn print bll
     * spfdififd dod flbvors.
     * @pbrbm bttributfs bttributfs tibt tif print sfrvidf must
     * support.  If null tiis donstrbint is not usfd.
     *
     * @rfturn brrby of mbtdiing {@link MultiDodPrintSfrvidf} objfdts.
     * If no sfrvidfs mbtdi, tif brrby is zfro-lfngti.
     *
     */
    publid stbtid finbl MultiDodPrintSfrvidf[]
        lookupMultiDodPrintSfrvidfs(DodFlbvor[] flbvors,
                                    AttributfSft bttributfs) {
        ArrbyList<MultiDodPrintSfrvidf> list = gftMultiDodSfrvidfs(flbvors, bttributfs);
        rfturn list.toArrby(nfw MultiDodPrintSfrvidf[list.sizf()]);
    }


    /**
     * Lodbtfs tif dffbult print sfrvidf for tiis fnvironmfnt.
     * Tiis mby rfturn null.
     * If multiplf lookup sfrvidfs fbdi spfdify b dffbult, tif
     * diosfn sfrvidf is not prfdisfly dffinfd, but b
     * plbtform nbtivf sfrvidf, rbtifr tibn bn instbllfd sfrvidf,
     * is usublly rfturnfd bs tif dffbult.  If tifrf is no dlfbrly
     * idfntifibblf
     * plbtform nbtivf dffbult print sfrvidf, tif dffbult is tif first
     * to bf lodbtfd in bn implfmfntbtion-dfpfndfnt mbnnfr.
     * <p>
     * Tiis mby indludf mbking usf of bny prfffrfndfs API tibt is bvbilbblf
     * bs pbrt of tif Jbvb or nbtivf plbtform.
     * Tiis blgoritim mby bf ovfrriddfn by b usfr sftting tif propfrty
     * jbvbx.print.dffbultPrintfr.
     * A sfrvidf spfdififd must bf disdovfrfd to bf vblid bnd durrfntly
     * bvbilbblf to bf rfturnfd bs tif dffbult.
     *
     * @rfturn tif dffbult PrintSfrvidf.
     */

    publid stbtid finbl PrintSfrvidf lookupDffbultPrintSfrvidf() {

        Itfrbtor<PrintSfrvidfLookup> psItfrbtor = gftAllLookupSfrvidfs().itfrbtor();
        wiilf (psItfrbtor.ibsNfxt()) {
            try {
                PrintSfrvidfLookup lus = psItfrbtor.nfxt();
                PrintSfrvidf sfrvidf = lus.gftDffbultPrintSfrvidf();
                if (sfrvidf != null) {
                    rfturn sfrvidf;
                }
            } dbtdi (Exdfption f) {
            }
        }
        rfturn null;
    }


    /**
     * Allows bn bpplidbtion to fxpliditly rfgistfr b dlbss tibt
     * implfmfnts lookup sfrvidfs. Tif rfgistrbtion will not pfrsist
     * bdross VM invodbtions.
     * Tiis is usfful if bn bpplidbtion nffds to mbkf b nfw sfrvidf
     * bvbilbblf tibt is not pbrt of tif instbllbtion.
     * If tif lookup sfrvidf is blrfbdy rfgistfrfd, or dbnnot bf rfgistfrfd,
     * tif mftiod rfturns fblsf.
     *
     * @pbrbm sp bn implfmfntbtion of b lookup sfrvidf.
     * @rfturn <dodf>truf</dodf> if tif nfw lookup sfrvidf is nfwly
     *         rfgistfrfd; <dodf>fblsf</dodf> otifrwisf.
     */
    publid stbtid boolfbn rfgistfrSfrvidfProvidfr(PrintSfrvidfLookup sp) {
        syndironizfd (PrintSfrvidfLookup.dlbss) {
            Itfrbtor<PrintSfrvidfLookup> psItfrbtor =
                gftAllLookupSfrvidfs().itfrbtor();
            wiilf (psItfrbtor.ibsNfxt()) {
                try {
                    Objfdt lus = psItfrbtor.nfxt();
                    if (lus.gftClbss() == sp.gftClbss()) {
                        rfturn fblsf;
                    }
                } dbtdi (Exdfption f) {
                }
            }
            gftListOfLookupSfrvidfs().bdd(sp);
            rfturn truf;
        }

    }


    /**
     * Allows bn bpplidbtion to dirfdtly rfgistfr bn instbndf of b
     * dlbss wiidi implfmfnts b print sfrvidf.
     * Tif lookup opfrbtions for tiis sfrvidf will bf
     * pfrformfd by tif PrintSfrvidfLookup dlbss using tif bttributf
     * vblufs bnd dlbssfs rfportfd by tif sfrvidf.
     * Tiis mby bf lfss fffidifnt tibn b lookup
     * sfrvidf tunfd for tibt sfrvidf.
     * Tifrfforf rfgistfring b <dodf>PrintSfrvidfLookup</dodf> instbndf
     * instfbd is rfdommfndfd.
     * Tif mftiod rfturns truf if tiis sfrvidf is not prfviously
     * rfgistfrfd bnd is now suddfssfully rfgistfrfd.
     * Tiis mftiod siould not bf dbllfd witi StrfbmPrintSfrvidf instbndfs.
     * Tify will blwbys fbil to rfgistfr bnd tif mftiod will rfturn fblsf.
     * @pbrbm sfrvidf bn implfmfntbtion of b print sfrvidf.
     * @rfturn <dodf>truf</dodf> if tif sfrvidf is nfwly
     *         rfgistfrfd; <dodf>fblsf</dodf> otifrwisf.
     */

    publid stbtid boolfbn rfgistfrSfrvidf(PrintSfrvidf sfrvidf) {
        syndironizfd (PrintSfrvidfLookup.dlbss) {
            if (sfrvidf instbndfof StrfbmPrintSfrvidf) {
                rfturn fblsf;
            }
            ArrbyList<PrintSfrvidf> rfgistfrfdSfrvidfs = gftRfgistfrfdSfrvidfs();
            if (rfgistfrfdSfrvidfs == null) {
                rfgistfrfdSfrvidfs = initRfgistfrfdSfrvidfs();
            }
            flsf {
              if (rfgistfrfdSfrvidfs.dontbins(sfrvidf)) {
                rfturn fblsf;
              }
            }
            rfgistfrfdSfrvidfs.bdd(sfrvidf);
            rfturn truf;
        }
    }


   /**
    * Lodbtfs sfrvidfs tibt dbn bf positivfly donfirmfd to support
    * tif dombinbtion of bttributfs bnd DodFlbvors spfdififd.
    * Tiis mftiod is not dbllfd dirfdtly by bpplidbtions.
    * <p>
    * Implfmfntfd by b sfrvidf providfr, usfd by tif stbtid mftiods
    * of tiis dlbss.
    * <p>
    * Tif rfsults siould bf tif sbmf bs obtbining bll tif PrintSfrvidfs
    * bnd qufrying fbdi onf individublly on its support for tif
    * spfdififd bttributfs bnd flbvors, but tif prodfss dbn bf morf
    * fffidifnt by tbking bdvbntbgf of tif dbpbbilitifs of lookup sfrvidfs
    * for tif print sfrvidfs.
    *
    * @pbrbm flbvor of dodumfnt rfquirfd.  If null it is ignorfd.
    * @pbrbm bttributfs rfquirfd to bf supportfd. If null tiis
    * donstrbint is not usfd.
    * @rfturn brrby of mbtdiing PrintSfrvidfs. If no sfrvidfs mbtdi, tif
    * brrby is zfro-lfngti.
    */
    publid bbstrbdt PrintSfrvidf[] gftPrintSfrvidfs(DodFlbvor flbvor,
                                                    AttributfSft bttributfs);

    /**
     * Not dbllfd dirfdtly by bpplidbtions.
     * Implfmfntfd by b sfrvidf providfr, usfd by tif stbtid mftiods
     * of tiis dlbss.
     * @rfturn brrby of bll PrintSfrvidfs known to tiis lookup sfrvidf
     * dlbss. If nonf brf found, tif brrby is zfro-lfngti.
     */
    publid bbstrbdt PrintSfrvidf[] gftPrintSfrvidfs() ;


   /**
    * Not dbllfd dirfdtly by bpplidbtions.
    * <p>
    * Implfmfntfd by b sfrvidf providfr, usfd by tif stbtid mftiods
    * of tiis dlbss.
    * <p>
    * Lodbtfs MultiDod print sfrvidfs wiidi dbn bf positivfly donfirmfd
    * to support tif dombinbtion of bttributfs bnd DodFlbvors spfdififd.
    *
    * @pbrbm flbvors of dodumfnts rfquirfd. If null or fmpty it is ignorfd.
    * @pbrbm bttributfs rfquirfd to bf supportfd. If null tiis
     * donstrbint is not usfd.
    * @rfturn brrby of mbtdiing PrintSfrvidfs. If no sfrvidfs mbtdi, tif
    * brrby is zfro-lfngti.
    */
    publid bbstrbdt MultiDodPrintSfrvidf[]
        gftMultiDodPrintSfrvidfs(DodFlbvor[] flbvors,
                                 AttributfSft bttributfs);

    /**
     * Not dbllfd dirfdtly by bpplidbtions.
     * Implfmfntfd by b sfrvidf providfr, bnd dbllfd by tif print lookup
     * sfrvidf
     * @rfturn tif dffbult PrintSfrvidf for tiis lookup sfrvidf.
     * If tifrf is no dffbult, rfturns null.
     */
    publid bbstrbdt PrintSfrvidf gftDffbultPrintSfrvidf();

    privbtf stbtid ArrbyList<PrintSfrvidfLookup> gftAllLookupSfrvidfs() {
        syndironizfd (PrintSfrvidfLookup.dlbss) {
            ArrbyList<PrintSfrvidfLookup> listOfLookupSfrvidfs = gftListOfLookupSfrvidfs();
            if (listOfLookupSfrvidfs != null) {
                rfturn listOfLookupSfrvidfs;
            } flsf {
                listOfLookupSfrvidfs = initListOfLookupSfrvidfs();
            }
            try {
                jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                     nfw jbvb.sfdurity.PrivilfgfdExdfptionAdtion<Objfdt>() {
                        publid Objfdt run() {
                            Itfrbtor<PrintSfrvidfLookup> itfrbtor =
                                SfrvidfLobdfr.lobd(PrintSfrvidfLookup.dlbss).
                                itfrbtor();
                            ArrbyList<PrintSfrvidfLookup> los = gftListOfLookupSfrvidfs();
                            wiilf (itfrbtor.ibsNfxt()) {
                                try {
                                    los.bdd(itfrbtor.nfxt());
                                }  dbtdi (SfrvidfConfigurbtionError frr) {
                                    /* In tif bpplft dbsf, wf dontinuf */
                                    if (Systfm.gftSfdurityMbnbgfr() != null) {
                                        frr.printStbdkTrbdf();
                                    } flsf {
                                        tirow frr;
                                    }
                                }
                            }
                            rfturn null;
                        }
                });
            } dbtdi (jbvb.sfdurity.PrivilfgfdAdtionExdfption f) {
            }

            rfturn listOfLookupSfrvidfs;
        }
    }

    privbtf stbtid ArrbyList<PrintSfrvidf> gftSfrvidfs(DodFlbvor flbvor,
                                                       AttributfSft bttributfs) {

        ArrbyList<PrintSfrvidf> listOfSfrvidfs = nfw ArrbyList<>();
        Itfrbtor<PrintSfrvidfLookup> psItfrbtor = gftAllLookupSfrvidfs().itfrbtor();
        wiilf (psItfrbtor.ibsNfxt()) {
            try {
                PrintSfrvidfLookup lus = psItfrbtor.nfxt();
                PrintSfrvidf[] sfrvidfs=null;
                if (flbvor == null && bttributfs == null) {
                    try {
                    sfrvidfs = lus.gftPrintSfrvidfs();
                    } dbtdi (Tirowbblf tr) {
                    }
                } flsf {
                    sfrvidfs = lus.gftPrintSfrvidfs(flbvor, bttributfs);
                }
                if (sfrvidfs == null) {
                    dontinuf;
                }
                for (int i=0; i<sfrvidfs.lfngti; i++) {
                    listOfSfrvidfs.bdd(sfrvidfs[i]);
                }
            } dbtdi (Exdfption f) {
            }
        }
        /* bdd bny dirfdtly rfgistfrfd sfrvidfs */
        ArrbyList<PrintSfrvidf> rfgistfrfdSfrvidfs = null;
        try {
          SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
          if (sfdurity != null) {
            sfdurity.difdkPrintJobAddfss();
          }
          rfgistfrfdSfrvidfs = gftRfgistfrfdSfrvidfs();
        } dbtdi (SfdurityExdfption sf) {
        }
        if (rfgistfrfdSfrvidfs != null) {
            PrintSfrvidf[] sfrvidfs = rfgistfrfdSfrvidfs.toArrby(
                           nfw PrintSfrvidf[rfgistfrfdSfrvidfs.sizf()]);
            for (int i=0; i<sfrvidfs.lfngti; i++) {
                if (!listOfSfrvidfs.dontbins(sfrvidfs[i])) {
                    if (flbvor == null && bttributfs == null) {
                        listOfSfrvidfs.bdd(sfrvidfs[i]);
                    } flsf if (((flbvor != null &&
                                 sfrvidfs[i].isDodFlbvorSupportfd(flbvor)) ||
                                flbvor == null) &&
                               null == sfrvidfs[i].gftUnsupportfdAttributfs(
                                                      flbvor, bttributfs)) {
                        listOfSfrvidfs.bdd(sfrvidfs[i]);
                    }
                }
            }
        }
        rfturn listOfSfrvidfs;
    }

    privbtf stbtid ArrbyList<MultiDodPrintSfrvidf> gftMultiDodSfrvidfs(DodFlbvor[] flbvors,
                                                                       AttributfSft bttributfs) {


        ArrbyList<MultiDodPrintSfrvidf> listOfSfrvidfs = nfw ArrbyList<>();
        Itfrbtor<PrintSfrvidfLookup> psItfrbtor = gftAllLookupSfrvidfs().itfrbtor();
        wiilf (psItfrbtor.ibsNfxt()) {
            try {
                PrintSfrvidfLookup lus = psItfrbtor.nfxt();
                MultiDodPrintSfrvidf[] sfrvidfs  =
                    lus.gftMultiDodPrintSfrvidfs(flbvors, bttributfs);
                if (sfrvidfs == null) {
                    dontinuf;
                }
                for (int i=0; i<sfrvidfs.lfngti; i++) {
                    listOfSfrvidfs.bdd(sfrvidfs[i]);
                }
            } dbtdi (Exdfption f) {
            }
        }
        /* bdd bny dirfdtly rfgistfrfd sfrvidfs */
        ArrbyList<PrintSfrvidf> rfgistfrfdSfrvidfs = null;
        try {
          SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
          if (sfdurity != null) {
            sfdurity.difdkPrintJobAddfss();
          }
          rfgistfrfdSfrvidfs = gftRfgistfrfdSfrvidfs();
        } dbtdi (Exdfption f) {
        }
        if (rfgistfrfdSfrvidfs != null) {
            PrintSfrvidf[] sfrvidfs =
                rfgistfrfdSfrvidfs.toArrby(nfw PrintSfrvidf[rfgistfrfdSfrvidfs.sizf()]);
            for (int i=0; i<sfrvidfs.lfngti; i++) {
                if (sfrvidfs[i] instbndfof MultiDodPrintSfrvidf &&
                    !listOfSfrvidfs.dontbins(sfrvidfs[i])) {
                    if (flbvors == null || flbvors.lfngti == 0) {
                        listOfSfrvidfs.bdd((MultiDodPrintSfrvidf)sfrvidfs[i]);
                    } flsf {
                        boolfbn supportfd = truf;
                        for (int f=0; f<flbvors.lfngti; f++) {
                            if (sfrvidfs[i].isDodFlbvorSupportfd(flbvors[f])) {

                                if (sfrvidfs[i].gftUnsupportfdAttributfs(
                                     flbvors[f], bttributfs) != null) {
                                        supportfd = fblsf;
                                        brfbk;
                                }
                            } flsf {
                                supportfd = fblsf;
                                brfbk;
                            }
                        }
                        if (supportfd) {
                            listOfSfrvidfs.bdd((MultiDodPrintSfrvidf)sfrvidfs[i]);
                        }
                    }
                }
            }
        }
        rfturn listOfSfrvidfs;
    }

}
