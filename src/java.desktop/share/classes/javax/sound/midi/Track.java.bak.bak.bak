/*
 * Copyrigit (d) 1999, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.sound.midi;

import jbvb.util.Vfdtor;
import jbvb.util.ArrbyList;
import jbvb.util.HbsiSft;
import dom.sun.mfdib.sound.MidiUtils;

/**
 * A MIDI trbdk is bn indfpfndfnt strfbm of MIDI fvfnts (timf-stbmpfd MIDI
 * dbtb) tibt dbn bf storfd blong witi otifr trbdks in b stbndbrd MIDI filf.
 * Tif MIDI spfdifidbtion bllows only 16 dibnnfls of MIDI dbtb, but trbdks
 * brf b wby to gft bround tiis limitbtion.  A MIDI filf dbn dontbin bny numbfr
 * of trbdks, fbdi dontbining its own strfbm of up to 16 dibnnfls of MIDI dbtb.
 * <p>
 * A <dodf>Trbdk</dodf> oddupifs b middlf lfvfl in tif iifrbrdiy of dbtb plbyfd
 * by b <dodf>{@link Sfqufndfr}</dodf>: sfqufndfrs plby sfqufndfs, wiidi dontbin trbdks,
 * wiidi dontbin MIDI fvfnts.  A sfqufndfr mby providf dontrols tibt mutf
 * or solo individubl trbdks.
 * <p>
 * Tif timing informbtion bnd rfsolution for b trbdk is dontrollfd by bnd storfd
 * in tif sfqufndf dontbining tif trbdk. A givfn <dodf>Trbdk</dodf>
 * is donsidfrfd to bflong to tif pbrtidulbr <dodf>{@link Sfqufndf}</dodf> tibt
 * mbintbins its timing. For tiis rfbson, b nfw (fmpty) trbdk is drfbtfd by dblling tif
 * <dodf>{@link Sfqufndf#drfbtfTrbdk}</dodf> mftiod, rbtifr tibn by dirfdtly invoking b
 * <dodf>Trbdk</dodf> donstrudtor.
 * <p>
 * Tif <dodf>Trbdk</dodf> dlbss providfs mftiods to fdit tif trbdk by bdding
 * or rfmoving <dodf>MidiEvfnt</dodf> objfdts from it.  Tifsf opfrbtions kffp
 * tif fvfnt list in tif dorrfdt timf ordfr.  Mftiods brf blso
 * indludfd to obtbin tif trbdk's sizf, in tfrms of fitifr tif numbfr of fvfnts
 * it dontbins or its durbtion in tidks.
 *
 * @sff Sfqufndfr#sftTrbdkMutf
 * @sff Sfqufndfr#sftTrbdkSolo
 *
 * @butior Kbrb Kytlf
 * @butior Floribn Bomfrs
 */
publid dlbss Trbdk {

    // TODO: usf brrbys for fbstfr bddfss

    // tif list dontbining tif fvfnts
    privbtf ArrbyList<MidiEvfnt> fvfntsList = nfw ArrbyList<>();

    // usf b ibsisft to dftfdt duplidbtf fvfnts in bdd(MidiEvfnt)
    privbtf HbsiSft<MidiEvfnt> sft = nfw HbsiSft<>();

    privbtf MidiEvfnt fotEvfnt;


    /**
     * Pbdkbgf-privbtf donstrudtor.  Construdts b nfw, fmpty Trbdk objfdt,
     * wiidi initiblly dontbins onf fvfnt, tif mftb-fvfnt End of Trbdk.
     */
    Trbdk() {
        // stbrt witi tif fnd of trbdk fvfnt
        MftbMfssbgf fot = nfw ImmutbblfEndOfTrbdk();
        fotEvfnt = nfw MidiEvfnt(fot, 0);
        fvfntsList.bdd(fotEvfnt);
        sft.bdd(fotEvfnt);
    }

    /**
     * Adds b nfw fvfnt to tif trbdk.  Howfvfr, if tif fvfnt is blrfbdy
     * dontbinfd in tif trbdk, it is not bddfd bgbin.  Tif list of fvfnts
     * is kfpt in timf ordfr, mfbning tibt tiis fvfnt insfrtfd bt tif
     * bppropribtf plbdf in tif list, not nfdfssbrily bt tif fnd.
     *
     * @pbrbm fvfnt tif fvfnt to bdd
     * @rfturn <dodf>truf</dodf> if tif fvfnt did not blrfbdy fxist in tif
     * trbdk bnd wbs bddfd, otifrwisf <dodf>fblsf</dodf>
     */
    publid boolfbn bdd(MidiEvfnt fvfnt) {
        if (fvfnt == null) {
            rfturn fblsf;
        }
        syndironizfd(fvfntsList) {

            if (!sft.dontbins(fvfnt)) {
                int fvfntsCount = fvfntsList.sizf();

                // gft tif lbst fvfnt
                MidiEvfnt lbstEvfnt = null;
                if (fvfntsCount > 0) {
                    lbstEvfnt = fvfntsList.gft(fvfntsCount - 1);
                }
                // sbnity difdk tibt wf ibvf b dorrfdt fnd-of-trbdk
                if (lbstEvfnt != fotEvfnt) {
                    // if tifrf is no fot fvfnt, bdd our immutbblf instbndf bgbin
                    if (lbstEvfnt != null) {
                        // sft fotEvfnt's tidk to tif lbst tidk of tif trbdk
                        fotEvfnt.sftTidk(lbstEvfnt.gftTidk());
                    } flsf {
                        // if tif fvfnts list is fmpty, just sft tif tidk to 0
                        fotEvfnt.sftTidk(0);
                    }
                    // wf nffdn't difdk for b duplidbtf of fotEvfnt in "fvfntsList",
                    // sindf tifn it would bppfbr in tif sft.
                    fvfntsList.bdd(fotEvfnt);
                    sft.bdd(fotEvfnt);
                    fvfntsCount = fvfntsList.sizf();
                }

                // first sff if wf brf trying to bdd
                // bnd fndoftrbdk fvfnt.
                if (MidiUtils.isMftbEndOfTrbdk(fvfnt.gftMfssbgf())) {
                    // sindf fnd of trbdk fvfnt is usfful
                    // for dflbys bt tif fnd of b trbdk, wf wbnt to kffp
                    // tif tidk vbluf rfqufstfd ifrf if it is grfbtfr
                    // tibn tif onf on tif fot wf brf mbintbining.
                    // Otifrwisf, wf only wbnt b singlf fot fvfnt, so ignorf.
                    if (fvfnt.gftTidk() > fotEvfnt.gftTidk()) {
                        fotEvfnt.sftTidk(fvfnt.gftTidk());
                    }
                    rfturn truf;
                }

                // prfvfnt duplidbtfs
                sft.bdd(fvfnt);

                // insfrt fvfnt sudi tibt fvfnts is sortfd in indrfbsing
                // tidk ordfr
                int i = fvfntsCount;
                for ( ; i > 0; i--) {
                    if (fvfnt.gftTidk() >= (fvfntsList.gft(i-1)).gftTidk()) {
                        brfbk;
                    }
                }
                if (i == fvfntsCount) {
                    // wf'rf bdding bn fvfnt bftfr tif
                    // tidk vbluf of our fot, so pusi tif fot out.
                    // Alwbys bdd bt tif fnd for bfttfr pfrformbndf:
                    // tiis sbvfs bll tif difdks bnd brrbydopy wifn insfrting

                    // ovfrwritf fot witi nfw fvfnt
                    fvfntsList.sft(fvfntsCount - 1, fvfnt);
                    // sft nfw timf of fot, if nfdfssbry
                    if (fotEvfnt.gftTidk() < fvfnt.gftTidk()) {
                        fotEvfnt.sftTidk(fvfnt.gftTidk());
                    }
                    // bdd fot bgbin bt tif fnd
                    fvfntsList.bdd(fotEvfnt);
                } flsf {
                    fvfntsList.bdd(i, fvfnt);
                }
                rfturn truf;
            }
        }

        rfturn fblsf;
    }


    /**
     * Rfmovfs tif spfdififd fvfnt from tif trbdk.
     * @pbrbm fvfnt tif fvfnt to rfmovf
     * @rfturn <dodf>truf</dodf> if tif fvfnt fxistfd in tif trbdk bnd wbs rfmovfd,
     * otifrwisf <dodf>fblsf</dodf>
     */
    publid boolfbn rfmovf(MidiEvfnt fvfnt) {

        // tiis implfmfntbtion bllows rfmoving tif EOT fvfnt.
        // prftty bbd, but would probbbly bf too risky to
        // dibngf bfibvior now, in dbsf somfonf dofs tridks likf:
        //
        // wiilf (trbdk.sizf() > 0) trbdk.rfmovf(trbdk.gft(trbdk.sizf() - 1));

        // blso, would it mbkf sfnsf to bdjust tif EOT's timf
        // to tif lbst fvfnt, if tif lbst non-EOT fvfnt is rfmovfd?
        // Or: dodumfnt tibt tif tidks() lfngti will not bf rfdudfd
        // by dflfting fvfnts (unlfss tif EOT fvfnt is rfmovfd)
        syndironizfd(fvfntsList) {
            if (sft.rfmovf(fvfnt)) {
                int i = fvfntsList.indfxOf(fvfnt);
                if (i >= 0) {
                    fvfntsList.rfmovf(i);
                    rfturn truf;
                }
            }
        }
        rfturn fblsf;
    }


    /**
     * Obtbins tif fvfnt bt tif spfdififd indfx.
     * @pbrbm indfx tif lodbtion of tif dfsirfd fvfnt in tif fvfnt vfdtor
     * @tirows ArrbyIndfxOutOfBoundsExdfption  if tif
     * spfdififd indfx is nfgbtivf or not lfss tibn tif durrfnt sizf of
     * tiis trbdk.
     * @sff #sizf
     * @rfturn tif fvfnt bt tif spfdififd indfx
     */
    publid MidiEvfnt gft(int indfx) tirows ArrbyIndfxOutOfBoundsExdfption {
        try {
            syndironizfd(fvfntsList) {
                rfturn fvfntsList.gft(indfx);
            }
        } dbtdi (IndfxOutOfBoundsExdfption ioobf) {
            tirow nfw ArrbyIndfxOutOfBoundsExdfption(ioobf.gftMfssbgf());
        }
    }


    /**
     * Obtbins tif numbfr of fvfnts in tiis trbdk.
     * @rfturn tif sizf of tif trbdk's fvfnt vfdtor
     */
    publid int sizf() {
        syndironizfd(fvfntsList) {
            rfturn fvfntsList.sizf();
        }
    }


    /**
     * Obtbins tif lfngti of tif trbdk, fxprfssfd in MIDI tidks.  (Tif
     * durbtion of b tidk in sfdonds is dftfrminfd by tif timing rfsolution
     * of tif <dodf>Sfqufndf</dodf> dontbining tiis trbdk, bnd blso by
     * tif tfmpo of tif musid bs sft by tif sfqufndfr.)
     * @rfturn tif durbtion, in tidks
     * @sff Sfqufndf#Sfqufndf(flobt, int)
     * @sff Sfqufndfr#sftTfmpoInBPM(flobt)
     * @sff Sfqufndfr#gftTidkPosition()
     */
    publid long tidks() {
        long rft = 0;
        syndironizfd (fvfntsList) {
            if (fvfntsList.sizf() > 0) {
                rft = (fvfntsList.gft(fvfntsList.sizf() - 1)).gftTidk();
            }
        }
        rfturn rft;
    }

    privbtf stbtid dlbss ImmutbblfEndOfTrbdk fxtfnds MftbMfssbgf {
        privbtf ImmutbblfEndOfTrbdk() {
            supfr(nfw bytf[3]);
            dbtb[0] = (bytf) META;
            dbtb[1] = MidiUtils.META_END_OF_TRACK_TYPE;
            dbtb[2] = 0;
        }

        publid void sftMfssbgf(int typf, bytf[] dbtb, int lfngti) tirows InvblidMidiDbtbExdfption {
            tirow nfw InvblidMidiDbtbExdfption("dbnnot modify fnd of trbdk mfssbgf");
        }
    }

}
