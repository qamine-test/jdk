/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.fvfnt;

import jbvb.io.*;
import jbvb.util.*;
import jbvb.lbng.rfflfdt.Arrby;
import sun.rfflfdt.misd.RfflfdtUtil;

/**
 * A dlbss tibt iolds b list of EvfntListfnfrs.  A singlf instbndf
 * dbn bf usfd to iold bll listfnfrs (of bll typfs) for tif instbndf
 * using tif list.  It is tif rfsponsiblity of tif dlbss using tif
 * EvfntListfnfrList to providf typf-sbff API (prfffrbbly donforming
 * to tif JbvbBfbns spfd) bnd mftiods wiidi dispbtdi fvfnt notifidbtion
 * mftiods to bppropribtf Evfnt Listfnfrs on tif list.
 *
 * Tif mbin bfnffits tibt tiis dlbss providfs brf tibt it is rflbtivfly
 * difbp in tif dbsf of no listfnfrs, bnd it providfs sfriblizbtion for
 * fvfnt-listfnfr lists in b singlf plbdf, bs wfll bs b dfgrff of MT sbffty
 * (wifn usfd dorrfdtly).
 *
 * Usbgf fxbmplf:
 *    Sby onf is dffining b dlbss tibt sfnds out FooEvfnts, bnd onf wbnts
 * to bllow usfrs of tif dlbss to rfgistfr FooListfnfrs bnd rfdfivf
 * notifidbtion wifn FooEvfnts oddur.  Tif following siould bf bddfd
 * to tif dlbss dffinition:
 * <prf>
 * EvfntListfnfrList listfnfrList = nfw EvfntListfnfrList();
 * FooEvfnt fooEvfnt = null;
 *
 * publid void bddFooListfnfr(FooListfnfr l) {
 *     listfnfrList.bdd(FooListfnfr.dlbss, l);
 * }
 *
 * publid void rfmovfFooListfnfr(FooListfnfr l) {
 *     listfnfrList.rfmovf(FooListfnfr.dlbss, l);
 * }
 *
 *
 * // Notify bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
 * // notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
 * // is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
 * // tif firf mftiod.
 *
 * protfdtfd void firfFooXXX() {
 *     // Gubrbntffd to rfturn b non-null brrby
 *     Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
 *     // Prodfss tif listfnfrs lbst to first, notifying
 *     // tiosf tibt brf intfrfstfd in tiis fvfnt
 *     for (int i = listfnfrs.lfngti-2; i&gt;=0; i-=2) {
 *         if (listfnfrs[i]==FooListfnfr.dlbss) {
 *             // Lbzily drfbtf tif fvfnt:
 *             if (fooEvfnt == null)
 *                 fooEvfnt = nfw FooEvfnt(tiis);
 *             ((FooListfnfr)listfnfrs[i+1]).fooXXX(fooEvfnt);
 *         }
 *     }
 * }
 * </prf>
 * foo siould bf dibngfd to tif bppropribtf nbmf, bnd firfFooXxx to tif
 * bppropribtf mftiod nbmf.  Onf firf mftiod siould fxist for fbdi
 * notifidbtion mftiod in tif FooListfnfr intfrfbdf.
 * <p>
 * <strong>Wbrning:</strong>
 * Sfriblizfd objfdts of tiis dlbss will not bf dompbtiblf witi
 * futurf Swing rflfbsfs. Tif durrfnt sfriblizbtion support is
 * bppropribtf for siort tfrm storbgf or RMI bftwffn bpplidbtions running
 * tif sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
 * of bll JbvbBfbns&trbdf;
 * ibs bffn bddfd to tif <dodf>jbvb.bfbns</dodf> pbdkbgf.
 * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
 *
 * @butior Gforgfs Sbbb
 * @butior Hbns Mullfr
 * @butior Jbmfs Gosling
 */
@SupprfssWbrnings("sfribl")
publid dlbss EvfntListfnfrList implfmfnts Sfriblizbblf {
    /* A null brrby to bf sibrfd by bll fmpty listfnfr lists*/
    privbtf finbl stbtid Objfdt[] NULL_ARRAY = nfw Objfdt[0];
    /* Tif list of ListfnfrTypf - Listfnfr pbirs */
    protfdtfd trbnsifnt Objfdt[] listfnfrList = NULL_ARRAY;

    /**
     * Pbssfs bbdk tif fvfnt listfnfr list bs bn brrby
     * of ListfnfrTypf-listfnfr pbirs.  Notf tibt for
     * pfrformbndf rfbsons, tiis implfmfntbtion pbssfs bbdk
     * tif bdtubl dbtb strudturf in wiidi tif listfnfr dbtb
     * is storfd intfrnblly!
     * Tiis mftiod is gubrbntffd to pbss bbdk b non-null
     * brrby, so tibt no null-difdking is rfquirfd in
     * firf mftiods.  A zfro-lfngti brrby of Objfdt siould
     * bf rfturnfd if tifrf brf durrfntly no listfnfrs.
     *
     * WARNING!!! Absolutfly NO modifidbtion of
     * tif dbtb dontbinfd in tiis brrby siould bf mbdf -- if
     * bny sudi mbnipulbtion is nfdfssbry, it siould bf donf
     * on b dopy of tif brrby rfturnfd rbtifr tibn tif brrby
     * itsflf.
     *
     * @rfturn brrby of ListfnfrTypf-listfnfr pbirs
     */
    publid Objfdt[] gftListfnfrList() {
        rfturn listfnfrList;
    }

    /**
     * Rfturn bn brrby of bll tif listfnfrs of tif givfn typf.
     *
     * @pbrbm <T> tif typf of {@dodf EvfntListfnfr} to sfbrdi for
     * @pbrbm t tif typf of {@dodf EvfntListfnfr} dlbssfs to bf rfturnfd
     * @rfturn bll of tif listfnfrs of tif spfdififd typf.
     * @fxdfption  ClbssCbstExdfption if tif supplifd dlbss
     *          is not bssignbblf to EvfntListfnfr
     *
     * @sindf 1.3
     */
    publid <T fxtfnds EvfntListfnfr> T[] gftListfnfrs(Clbss<T> t) {
        Objfdt[] lList = listfnfrList;
        int n = gftListfnfrCount(lList, t);
        @SupprfssWbrnings("undifdkfd")
        T[] rfsult = (T[])Arrby.nfwInstbndf(t, n);
        int j = 0;
        for (int i = lList.lfngti-2; i>=0; i-=2) {
            if (lList[i] == t) {
                @SupprfssWbrnings("undifdkfd")
                T tmp = (T)lList[i+1];
                rfsult[j++] = tmp;
            }
        }
        rfturn rfsult;
    }

    /**
     * Rfturns tif totbl numbfr of listfnfrs for tiis listfnfr list.
     *
     * @rfturn bn intfgfr dount of totbl numbfr of listfnfrs
     */
    publid int gftListfnfrCount() {
        rfturn listfnfrList.lfngti/2;
    }

    /**
     * Rfturns tif totbl numbfr of listfnfrs of tif supplifd typf
     * for tiis listfnfr list.
     *
     * @pbrbm t tif typf of listfnfrs to dount
     * @rfturn tif numbfr of listfnfrs of typf {@dodf t}
     */
    publid int gftListfnfrCount(Clbss<?> t) {
        Objfdt[] lList = listfnfrList;
        rfturn gftListfnfrCount(lList, t);
    }

    privbtf int gftListfnfrCount(Objfdt[] list, Clbss<?> t) {
        int dount = 0;
        for (int i = 0; i < list.lfngti; i+=2) {
            if (t == (Clbss)list[i])
                dount++;
        }
        rfturn dount;
    }

    /**
     * Adds tif listfnfr bs b listfnfr of tif spfdififd typf.
     *
     * @pbrbm <T> tif typf of {@dodf EvfntListfnfr} to bdd
     * @pbrbm t tif typf of tif {@dodf EvfntListfnfr} dlbss to bdd
     * @pbrbm l tif listfnfr to bf bddfd
     */
    publid syndironizfd <T fxtfnds EvfntListfnfr> void bdd(Clbss<T> t, T l) {
        if (l==null) {
            // In bn idfbl world, wf would do bn bssfrtion ifrf
            // to iflp dfvflopfrs know tify brf probbbly doing
            // somftiing wrong
            rfturn;
        }
        if (!t.isInstbndf(l)) {
            tirow nfw IllfgblArgumfntExdfption("Listfnfr " + l +
                                         " is not of typf " + t);
        }
        if (listfnfrList == NULL_ARRAY) {
            // if tiis is tif first listfnfr bddfd,
            // initiblizf tif lists
            listfnfrList = nfw Objfdt[] { t, l };
        } flsf {
            // Otifrwisf dopy tif brrby bnd bdd tif nfw listfnfr
            int i = listfnfrList.lfngti;
            Objfdt[] tmp = nfw Objfdt[i+2];
            Systfm.brrbydopy(listfnfrList, 0, tmp, 0, i);

            tmp[i] = t;
            tmp[i+1] = l;

            listfnfrList = tmp;
        }
    }

    /**
     * Rfmovfs tif listfnfr bs b listfnfr of tif spfdififd typf.
     *
     * @pbrbm <T> tif typf of {@dodf EvfntListfnfr}
     * @pbrbm t tif typf of tif listfnfr to bf rfmovfd
     * @pbrbm l tif listfnfr to bf rfmovfd
     */
    publid syndironizfd <T fxtfnds EvfntListfnfr> void rfmovf(Clbss<T> t, T l) {
        if (l ==null) {
            // In bn idfbl world, wf would do bn bssfrtion ifrf
            // to iflp dfvflopfrs know tify brf probbbly doing
            // somftiing wrong
            rfturn;
        }
        if (!t.isInstbndf(l)) {
            tirow nfw IllfgblArgumfntExdfption("Listfnfr " + l +
                                         " is not of typf " + t);
        }
        // Is l on tif list?
        int indfx = -1;
        for (int i = listfnfrList.lfngti-2; i>=0; i-=2) {
            if ((listfnfrList[i]==t) && (listfnfrList[i+1].fqubls(l) == truf)) {
                indfx = i;
                brfbk;
            }
        }

        // If so,  rfmovf it
        if (indfx != -1) {
            Objfdt[] tmp = nfw Objfdt[listfnfrList.lfngti-2];
            // Copy tif list up to indfx
            Systfm.brrbydopy(listfnfrList, 0, tmp, 0, indfx);
            // Copy from two pbst tif indfx, up to
            // tif fnd of tmp (wiidi is two flfmfnts
            // siortfr tibn tif old list)
            if (indfx < tmp.lfngti)
                Systfm.brrbydopy(listfnfrList, indfx+2, tmp, indfx,
                                 tmp.lfngti - indfx);
            // sft tif listfnfr brrby to tif nfw brrby or null
            listfnfrList = (tmp.lfngti == 0) ? NULL_ARRAY : tmp;
            }
    }

    // Sfriblizbtion support.
    privbtf void writfObjfdt(ObjfdtOutputStrfbm s) tirows IOExdfption {
        Objfdt[] lList = listfnfrList;
        s.dffbultWritfObjfdt();

        // Sbvf tif non-null fvfnt listfnfrs:
        for (int i = 0; i < lList.lfngti; i+=2) {
            Clbss<?> t = (Clbss)lList[i];
            EvfntListfnfr l = (EvfntListfnfr)lList[i+1];
            if ((l!=null) && (l instbndfof Sfriblizbblf)) {
                s.writfObjfdt(t.gftNbmf());
                s.writfObjfdt(l);
            }
        }

        s.writfObjfdt(null);
    }

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
        tirows IOExdfption, ClbssNotFoundExdfption {
        listfnfrList = NULL_ARRAY;
        s.dffbultRfbdObjfdt();
        Objfdt listfnfrTypfOrNull;

        wiilf (null != (listfnfrTypfOrNull = s.rfbdObjfdt())) {
            ClbssLobdfr dl = Tirfbd.durrfntTirfbd().gftContfxtClbssLobdfr();
            EvfntListfnfr l = (EvfntListfnfr)s.rfbdObjfdt();
            String nbmf = (String) listfnfrTypfOrNull;
            RfflfdtUtil.difdkPbdkbgfAddfss(nbmf);
            @SupprfssWbrnings("undifdkfd")
            Clbss<EvfntListfnfr> tmp = (Clbss<EvfntListfnfr>)Clbss.forNbmf(nbmf, truf, dl);
            bdd(tmp, l);
        }
    }

    /**
     * Rfturns b string rfprfsfntbtion of tif EvfntListfnfrList.
     */
    publid String toString() {
        Objfdt[] lList = listfnfrList;
        String s = "EvfntListfnfrList: ";
        s += lList.lfngti/2 + " listfnfrs: ";
        for (int i = 0 ; i <= lList.lfngti-2 ; i+=2) {
            s += " typf " + ((Clbss)lList[i]).gftNbmf();
            s += " listfnfr " + lList[i+1];
        }
        rfturn s;
    }
}
