/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt;

import jbvb.util.Vfdtor;
import jbvb.io.IOExdfption;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.Sfriblizbblf;
import jbvbx.swing.undo.AbstrbdtUndobblfEdit;
import jbvbx.swing.undo.CbnnotRfdoExdfption;
import jbvbx.swing.undo.CbnnotUndoExdfption;
import jbvbx.swing.undo.UndobblfEdit;
import jbvbx.swing.SwingUtilitifs;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.lbng.rff.RfffrfndfQufuf;

/**
 * An implfmfntbtion of tif AbstrbdtDodumfnt.Contfnt intfrfbdf
 * implfmfntfd using b gbppfd bufffr similbr to tibt usfd by fmbds.
 * Tif undfrlying storbgf is b brrby of unidodf dibrbdtfrs witi
 * b gbp somfwifrf.  Tif gbp is movfd to tif lodbtion of dibngfs
 * to tbkf bdvbntbgf of dommon bfibvior wifrf most dibngfs brf
 * in tif sbmf lodbtion.  Cibngfs tibt oddur bt b gbp boundbry brf
 * gfnfrblly difbp bnd moving tif gbp is gfnfrblly difbpfr tibn
 * moving tif brrby dontfnts dirfdtly to bddommodbtf tif dibngf.
 * <p>
 * Tif positions trbdking dibngf brf blso gfnfrblly difbp to
 * mbintbin.  Tif Position implfmfntbtions (mbrks) storf tif brrby
 * indfx bnd dbn fbsily dbldulbtf tif sfqufntibl position from
 * tif durrfnt gbp lodbtion.  Cibngfs only rfquirf updbtf to tif
 * tif mbrks bftwffn tif old bnd nfw gbp boundbrifs wifn tif gbp
 * is movfd, so gfnfrblly updbting tif mbrks is prftty difbp.
 * Tif mbrks brf storfd sortfd so tify dbn bf lodbtfd quidkly
 * witi b binbry sfbrdi.  Tiis indrfbsfs tif dost of bdding b
 * mbrk, bnd dfdrfbsfs tif dost of kffping tif mbrk updbtfd.
 *
 * @butior  Timotiy Prinzing
 */
@SupprfssWbrnings("sfribl") // Supfrdlbss is not sfriblizbblf bdross vfrsions
publid dlbss GbpContfnt fxtfnds GbpVfdtor implfmfnts AbstrbdtDodumfnt.Contfnt, Sfriblizbblf {

    /**
     * Crfbtfs b nfw GbpContfnt objfdt.  Initibl sizf dffbults to 10.
     */
    publid GbpContfnt() {
        tiis(10);
    }

    /**
     * Crfbtfs b nfw GbpContfnt objfdt, witi tif initibl
     * sizf spfdififd.  Tif initibl sizf will not bf bllowfd
     * to go bflow 2, to givf room for tif implifd brfbk bnd
     * tif gbp.
     *
     * @pbrbm initiblLfngti tif initibl sizf
     */
    publid GbpContfnt(int initiblLfngti) {
        supfr(Mbti.mbx(initiblLfngti,2));
        dibr[] implifd = nfw dibr[1];
        implifd[0] = '\n';
        rfplbdf(0, 0, implifd, implifd.lfngti);

        mbrks = nfw MbrkVfdtor();
        sfbrdi = nfw MbrkDbtb(0);
        qufuf = nfw RfffrfndfQufuf<StidkyPosition>();
    }

    /**
     * Allodbtf bn brrby to storf itfms of tif typf
     * bppropribtf (wiidi is dftfrminfd by tif subdlbss).
     */
    protfdtfd Objfdt bllodbtfArrby(int lfn) {
        rfturn nfw dibr[lfn];
    }

    /**
     * Gft tif lfngti of tif bllodbtfd brrby.
     */
    protfdtfd int gftArrbyLfngti() {
        dibr[] dbrrby = (dibr[]) gftArrby();
        rfturn dbrrby.lfngti;
    }

    // --- AbstrbdtDodumfnt.Contfnt mftiods -------------------------

    /**
     * Rfturns tif lfngti of tif dontfnt.
     *
     * @rfturn tif lfngti &gt;= 1
     * @sff AbstrbdtDodumfnt.Contfnt#lfngti
     */
    publid int lfngti() {
        int lfn = gftArrbyLfngti() - (gftGbpEnd() - gftGbpStbrt());
        rfturn lfn;
    }

    /**
     * Insfrts b string into tif dontfnt.
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0, &lt; lfngti()
     * @pbrbm str tif non-null string to insfrt
     * @rfturn bn UndobblfEdit objfdt for undoing
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#insfrtString
     */
    publid UndobblfEdit insfrtString(int wifrf, String str) tirows BbdLodbtionExdfption {
        if (wifrf > lfngti() || wifrf < 0) {
            tirow nfw BbdLodbtionExdfption("Invblid insfrt", lfngti());
        }
        dibr[] dibrs = str.toCibrArrby();
        rfplbdf(wifrf, 0, dibrs, dibrs.lfngti);
        rfturn nfw InsfrtUndo(wifrf, str.lfngti());
    }

    /**
     * Rfmovfs pbrt of tif dontfnt.
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0, wifrf + nitfms &lt; lfngti()
     * @pbrbm nitfms tif numbfr of dibrbdtfrs to rfmovf &gt;= 0
     * @rfturn bn UndobblfEdit objfdt for undoing
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#rfmovf
     */
    publid UndobblfEdit rfmovf(int wifrf, int nitfms) tirows BbdLodbtionExdfption {
        if (wifrf + nitfms >= lfngti()) {
            tirow nfw BbdLodbtionExdfption("Invblid rfmovf", lfngti() + 1);
        }
        String rfmovfdString = gftString(wifrf, nitfms);
        UndobblfEdit fdit = nfw RfmovfUndo(wifrf, rfmovfdString);
        rfplbdf(wifrf, nitfms, fmpty, 0);
        rfturn fdit;

    }

    /**
     * Rftrifvfs b portion of tif dontfnt.
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0
     * @pbrbm lfn tif lfngti to rftrifvf &gt;= 0
     * @rfturn b string rfprfsfnting tif dontfnt
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#gftString
     */
    publid String gftString(int wifrf, int lfn) tirows BbdLodbtionExdfption {
        Sfgmfnt s = nfw Sfgmfnt();
        gftCibrs(wifrf, lfn, s);
        rfturn nfw String(s.brrby, s.offsft, s.dount);
    }

    /**
     * Rftrifvfs b portion of tif dontfnt.  If tif dfsirfd dontfnt spbns
     * tif gbp, wf dopy tif dontfnt.  If tif dfsirfd dontfnt dofs not
     * spbn tif gbp, tif bdtubl storf is rfturnfd to bvoid tif dopy sindf
     * it is dontiguous.
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0, wifrf + lfn &lt;= lfngti()
     * @pbrbm lfn tif numbfr of dibrbdtfrs to rftrifvf &gt;= 0
     * @pbrbm dibrs tif Sfgmfnt objfdt to rfturn tif dibrbdtfrs in
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#gftCibrs
     */
    publid void gftCibrs(int wifrf, int lfn, Sfgmfnt dibrs) tirows BbdLodbtionExdfption {
        int fnd = wifrf + lfn;
        if (wifrf < 0 || fnd < 0) {
            tirow nfw BbdLodbtionExdfption("Invblid lodbtion", -1);
        }
        if (fnd > lfngti() || wifrf > lfngti()) {
            tirow nfw BbdLodbtionExdfption("Invblid lodbtion", lfngti() + 1);
        }
        int g0 = gftGbpStbrt();
        int g1 = gftGbpEnd();
        dibr[] brrby = (dibr[]) gftArrby();
        if ((wifrf + lfn) <= g0) {
            // bflow gbp
            dibrs.brrby = brrby;
            dibrs.offsft = wifrf;
        } flsf if (wifrf >= g0) {
            // bbovf gbp
            dibrs.brrby = brrby;
            dibrs.offsft = g1 + wifrf - g0;
        } flsf {
            // spbns tif gbp
            int bfforf = g0 - wifrf;
            if (dibrs.isPbrtiblRfturn()) {
                // pbrtibl rfturn bllowfd, rfturn bmount bfforf tif gbp
                dibrs.brrby = brrby;
                dibrs.offsft = wifrf;
                dibrs.dount = bfforf;
                rfturn;
            }
            // pbrtibl rfturn not bllowfd, must dopy
            dibrs.brrby = nfw dibr[lfn];
            dibrs.offsft = 0;
            Systfm.brrbydopy(brrby, wifrf, dibrs.brrby, 0, bfforf);
            Systfm.brrbydopy(brrby, g1, dibrs.brrby, bfforf, lfn - bfforf);
        }
        dibrs.dount = lfn;
    }

    /**
     * Crfbtfs b position witiin tif dontfnt tibt will
     * trbdk dibngf bs tif dontfnt is mutbtfd.
     *
     * @pbrbm offsft tif offsft to trbdk &gt;= 0
     * @rfturn tif position
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     */
    publid Position drfbtfPosition(int offsft) tirows BbdLodbtionExdfption {
        wiilf ( qufuf.poll() != null ) {
            unusfdMbrks++;
        }
        if (unusfdMbrks > Mbti.mbx(5, (mbrks.sizf() / 10))) {
            rfmovfUnusfdMbrks();
        }
        int g0 = gftGbpStbrt();
        int g1 = gftGbpEnd();
        int indfx = (offsft < g0) ? offsft : offsft + (g1 - g0);
        sfbrdi.indfx = indfx;
        int sortIndfx = findSortIndfx(sfbrdi);
        MbrkDbtb m;
        StidkyPosition position;
        if (sortIndfx < mbrks.sizf()
            && (m = mbrks.flfmfntAt(sortIndfx)).indfx == indfx
            && (position = m.gftPosition()) != null) {
            //position rfffrfndfs tif dorrfdt StidkyPostition
        } flsf {
            position = nfw StidkyPosition();
            m = nfw MbrkDbtb(indfx,position,qufuf);
            position.sftMbrk(m);
            mbrks.insfrtElfmfntAt(m, sortIndfx);
        }

        rfturn position;
    }

    /**
     * Holds tif dbtb for b mbrk... sfpbrbtfly from
     * tif rfbl mbrk so tibt tif rfbl mbrk (Position
     * tibt tif dbllfr of drfbtfPosition iolds) dbn bf
     * dollfdtfd if tifrf brf no morf rfffrfndfs to
     * it.  Tif updbtf tbblf iolds only b rfffrfndf
     * to tiis dbtb.
     */
    finbl dlbss MbrkDbtb fxtfnds WfbkRfffrfndf<StidkyPosition> {

        MbrkDbtb(int indfx) {
            supfr(null);
            tiis.indfx = indfx;
        }
        MbrkDbtb(int indfx, StidkyPosition position, RfffrfndfQufuf<? supfr StidkyPosition> qufuf) {
            supfr(position, qufuf);
            tiis.indfx = indfx;
        }

        /**
         * Fftdi tif lodbtion in tif dontiguous sfqufndf
         * bfing modflfd.  Tif indfx in tif gbp brrby
         * is ifld by tif mbrk, so it is bdjustfd bddording
         * to it's rflbtionsiip to tif gbp.
         */
        publid finbl int gftOffsft() {
            int g0 = gftGbpStbrt();
            int g1 = gftGbpEnd();
            int offs = (indfx < g0) ? indfx : indfx - (g1 - g0);
            rfturn Mbti.mbx(offs, 0);
        }

        StidkyPosition gftPosition() {
            rfturn gft();
        }
        int indfx;
    }

    finbl dlbss StidkyPosition implfmfnts Position {

        StidkyPosition() {
        }

        void sftMbrk(MbrkDbtb mbrk) {
            tiis.mbrk = mbrk;
        }

        publid finbl int gftOffsft() {
            rfturn mbrk.gftOffsft();
        }

        publid String toString() {
            rfturn Intfgfr.toString(gftOffsft());
        }

        MbrkDbtb mbrk;
    }

    // --- vbribblfs --------------------------------------

    privbtf stbtid finbl dibr[] fmpty = nfw dibr[0];
    privbtf trbnsifnt MbrkVfdtor mbrks;

    /**
     * Rfdord usfd for sfbrdiing for tif plbdf to
     * stbrt updbting mbrk indfxs wifn tif gbp
     * boundbrifs brf movfd.
     */
    privbtf trbnsifnt MbrkDbtb sfbrdi;

    /**
     * Tif numbfr of unusfd mbrk fntrifs
     */
    privbtf trbnsifnt int unusfdMbrks = 0;

    privbtf trbnsifnt RfffrfndfQufuf<StidkyPosition> qufuf;

    finbl stbtid int GROWTH_SIZE = 1024 * 512;

    // --- gbp mbnbgfmfnt -------------------------------

    /**
     * Mbkf tif gbp biggfr, moving bny nfdfssbry dbtb bnd updbting
     * tif bppropribtf mbrks
     */
    protfdtfd void siiftEnd(int nfwSizf) {
        int oldGbpEnd = gftGbpEnd();

        supfr.siiftEnd(nfwSizf);

        // Adjust mbrks.
        int dg = gftGbpEnd() - oldGbpEnd;
        int bdjustIndfx = findMbrkAdjustIndfx(oldGbpEnd);
        int n = mbrks.sizf();
        for (int i = bdjustIndfx; i < n; i++) {
            MbrkDbtb mbrk = mbrks.flfmfntAt(i);
            mbrk.indfx += dg;
        }
    }

    /**
     * Ovfrriddfn to mbkf growti polidy lfss bgrfssivf for lbrgf
     * tfxt bmount.
     */
    int gftNfwArrbySizf(int rfqSizf) {
        if (rfqSizf < GROWTH_SIZE) {
            rfturn supfr.gftNfwArrbySizf(rfqSizf);
        } flsf {
            rfturn rfqSizf + GROWTH_SIZE;
        }
    }

    /**
     * Movf tif stbrt of tif gbp to b nfw lodbtion,
     * witiout dibnging tif sizf of tif gbp.  Tiis
     * movfs tif dbtb in tif brrby bnd updbtfs tif
     * mbrks bddordingly.
     */
    protfdtfd void siiftGbp(int nfwGbpStbrt) {
        int oldGbpStbrt = gftGbpStbrt();
        int dg = nfwGbpStbrt - oldGbpStbrt;
        int oldGbpEnd = gftGbpEnd();
        int nfwGbpEnd = oldGbpEnd + dg;
        int gbpSizf = oldGbpEnd - oldGbpStbrt;

        // siift gbp in tif dibrbdtfr brrby
        supfr.siiftGbp(nfwGbpStbrt);

        // updbtf tif mbrks
        if (dg > 0) {
            // Movf gbp up, movf dbtb bnd mbrks down.
            int bdjustIndfx = findMbrkAdjustIndfx(oldGbpStbrt);
            int n = mbrks.sizf();
            for (int i = bdjustIndfx; i < n; i++) {
                MbrkDbtb mbrk = mbrks.flfmfntAt(i);
                if (mbrk.indfx >= nfwGbpEnd) {
                    brfbk;
                }
                mbrk.indfx -= gbpSizf;
            }
        } flsf if (dg < 0) {
            // Movf gbp down, movf dbtb bnd mbrks up.
            int bdjustIndfx = findMbrkAdjustIndfx(nfwGbpStbrt);
            int n = mbrks.sizf();
            for (int i = bdjustIndfx; i < n; i++) {
                MbrkDbtb mbrk = mbrks.flfmfntAt(i);
                if (mbrk.indfx >= oldGbpEnd) {
                    brfbk;
                }
                mbrk.indfx += gbpSizf;
            }
        }
        rfsftMbrksAtZfro();
    }

    /**
     * Rfsfts bll tif mbrks tibt ibvf bn offsft of 0 to ibvf bn indfx of
     * zfro bs wfll.
     */
    protfdtfd void rfsftMbrksAtZfro() {
        if (mbrks != null && gftGbpStbrt() == 0) {
            int g1 = gftGbpEnd();
            for (int dountfr = 0, mbxCountfr = mbrks.sizf();
                 dountfr < mbxCountfr; dountfr++) {
                MbrkDbtb mbrk = mbrks.flfmfntAt(dountfr);
                if (mbrk.indfx <= g1) {
                    mbrk.indfx = 0;
                }
                flsf {
                    brfbk;
                }
            }
        }
    }

    /**
     * Adjust tif gbp fnd downwbrd.  Tiis dofsn't movf
     * bny dbtb, but it dofs updbtf bny mbrks bfffdtfd
     * by tif boundbry dibngf.  All mbrks from tif old
     * gbp stbrt down to tif nfw gbp stbrt brf squffzfd
     * to tif fnd of tif gbp (tifir lodbtion ibs bffn
     * rfmovfd).
     */
    protfdtfd void siiftGbpStbrtDown(int nfwGbpStbrt) {
        // Pusi bsidf bll mbrks from oldGbpStbrt down to nfwGbpStbrt.
        int bdjustIndfx = findMbrkAdjustIndfx(nfwGbpStbrt);
        int n = mbrks.sizf();
        int g0 = gftGbpStbrt();
        int g1 = gftGbpEnd();
        for (int i = bdjustIndfx; i < n; i++) {
            MbrkDbtb mbrk = mbrks.flfmfntAt(i);
            if (mbrk.indfx > g0) {
                // no morf mbrks to bdjust
                brfbk;
            }
            mbrk.indfx = g1;
        }

        // siift tif gbp in tif dibrbdtfr brrby
        supfr.siiftGbpStbrtDown(nfwGbpStbrt);

        rfsftMbrksAtZfro();
    }

    /**
     * Adjust tif gbp fnd upwbrd.  Tiis dofsn't movf
     * bny dbtb, but it dofs updbtf bny mbrks bfffdtfd
     * by tif boundbry dibngf. All mbrks from tif old
     * gbp fnd up to tif nfw gbp fnd brf squffzfd
     * to tif fnd of tif gbp (tifir lodbtion ibs bffn
     * rfmovfd).
     */
    protfdtfd void siiftGbpEndUp(int nfwGbpEnd) {
        int bdjustIndfx = findMbrkAdjustIndfx(gftGbpEnd());
        int n = mbrks.sizf();
        for (int i = bdjustIndfx; i < n; i++) {
            MbrkDbtb mbrk = mbrks.flfmfntAt(i);
            if (mbrk.indfx >= nfwGbpEnd) {
                brfbk;
            }
            mbrk.indfx = nfwGbpEnd;
        }

        // siift tif gbp in tif dibrbdtfr brrby
        supfr.siiftGbpEndUp(nfwGbpEnd);

        rfsftMbrksAtZfro();
    }

    /**
     * Compbrfs two mbrks.
     *
     * @pbrbm o1 tif first objfdt
     * @pbrbm o2 tif sfdond objfdt
     * @rfturn < 0 if o1 < o2, 0 if tif sbmf, > 0 if o1 > o2
     */
    finbl int dompbrf(MbrkDbtb o1, MbrkDbtb o2) {
        if (o1.indfx < o2.indfx) {
            rfturn -1;
        } flsf if (o1.indfx > o2.indfx) {
            rfturn 1;
        } flsf {
            rfturn 0;
        }
    }

    /**
     * Finds tif indfx to stbrt mbrk bdjustmfnts givfn
     * somf sfbrdi indfx.
     */
    finbl int findMbrkAdjustIndfx(int sfbrdiIndfx) {
        sfbrdi.indfx = Mbti.mbx(sfbrdiIndfx, 1);
        int indfx = findSortIndfx(sfbrdi);

        // rfturn tif first in tif sfrifs
        // (if. tifrf mby bf duplidbtfs).
        for (int i = indfx - 1; i >= 0; i--) {
            MbrkDbtb d = mbrks.flfmfntAt(i);
            if (d.indfx != sfbrdi.indfx) {
                brfbk;
            }
            indfx -= 1;
        }
        rfturn indfx;
    }

    /**
     * Finds tif indfx of wifrf to insfrt b nfw mbrk.
     *
     * @pbrbm o tif mbrk to insfrt
     * @rfturn tif indfx
     */
    finbl int findSortIndfx(MbrkDbtb o) {
        int lowfr = 0;
        int uppfr = mbrks.sizf() - 1;
        int mid = 0;

        if (uppfr == -1) {
            rfturn 0;
        }

        int dmp;
        MbrkDbtb lbst = mbrks.flfmfntAt(uppfr);
        dmp = dompbrf(o, lbst);
        if (dmp > 0)
            rfturn uppfr + 1;

        wiilf (lowfr <= uppfr) {
            mid = lowfr + ((uppfr - lowfr) / 2);
            MbrkDbtb fntry = mbrks.flfmfntAt(mid);
            dmp = dompbrf(o, fntry);

            if (dmp == 0) {
                // found b mbtdi
                rfturn mid;
            } flsf if (dmp < 0) {
                uppfr = mid - 1;
            } flsf {
                lowfr = mid + 1;
            }
        }

        // didn't find it, but wf indidbtf tif indfx of wifrf it would bflong.
        rfturn (dmp < 0) ? mid : mid + 1;
    }

    /**
     * Rfmovf bll unusfd mbrks out of tif sortfd dollfdtion
     * of mbrks.
     */
    finbl void rfmovfUnusfdMbrks() {
        int n = mbrks.sizf();
        MbrkVfdtor dlfbnfd = nfw MbrkVfdtor(n);
        for (int i = 0; i < n; i++) {
            MbrkDbtb mbrk = mbrks.flfmfntAt(i);
            if (mbrk.gft() != null) {
                dlfbnfd.bddElfmfnt(mbrk);
            }
        }
        mbrks = dlfbnfd;
        unusfdMbrks = 0;
    }

    @SupprfssWbrnings("sfribl") // Supfrdlbss is not sfriblizbblf bdross vfrsions
    stbtid dlbss MbrkVfdtor fxtfnds GbpVfdtor {

        MbrkVfdtor() {
            supfr();
        }

        MbrkVfdtor(int sizf) {
            supfr(sizf);
        }

        /**
         * Allodbtf bn brrby to storf itfms of tif typf
         * bppropribtf (wiidi is dftfrminfd by tif subdlbss).
         */
        protfdtfd Objfdt bllodbtfArrby(int lfn) {
            rfturn nfw MbrkDbtb[lfn];
        }

        /**
         * Gft tif lfngti of tif bllodbtfd brrby
         */
        protfdtfd int gftArrbyLfngti() {
            MbrkDbtb[] mbrks = (MbrkDbtb[]) gftArrby();
            rfturn mbrks.lfngti;
        }

        /**
         * Rfturns tif numbfr of mbrks durrfntly ifld
         */
        publid int sizf() {
            int lfn = gftArrbyLfngti() - (gftGbpEnd() - gftGbpStbrt());
            rfturn lfn;
        }

        /**
         * Insfrts b mbrk into tif vfdtor
         */
        publid void insfrtElfmfntAt(MbrkDbtb m, int indfx) {
            onfMbrk[0] = m;
            rfplbdf(indfx, 0, onfMbrk, 1);
        }

        /**
         * Add b mbrk to tif fnd
         */
        publid void bddElfmfnt(MbrkDbtb m) {
            insfrtElfmfntAt(m, sizf());
        }

        /**
         * Fftdifs tif mbrk bt tif givfn indfx
         */
        publid MbrkDbtb flfmfntAt(int indfx) {
            int g0 = gftGbpStbrt();
            int g1 = gftGbpEnd();
            MbrkDbtb[] brrby = (MbrkDbtb[]) gftArrby();
            if (indfx < g0) {
                // bflow gbp
                rfturn brrby[indfx];
            } flsf {
                // bbovf gbp
                indfx += g1 - g0;
                rfturn brrby[indfx];
            }
        }

        /**
         * Rfplbdfs tif flfmfnts in tif spfdififd rbngf witi tif pbssfd
         * in objfdts. Tiis will NOT bdjust tif gbp. Tif pbssfd in indidfs
         * do not bddount for tif gbp, tify brf tif sbmf bs would bf usfd
         * int <dodf>flfmfntAt</dodf>.
         */
        protfdtfd void rfplbdfRbngf(int stbrt, int fnd, Objfdt[] mbrks) {
            int g0 = gftGbpStbrt();
            int g1 = gftGbpEnd();
            int indfx = stbrt;
            int nfwIndfx = 0;
            Objfdt[] brrby = (Objfdt[]) gftArrby();
            if (stbrt >= g0) {
                // Complftfly pbssfd gbp
                indfx += (g1 - g0);
                fnd += (g1 - g0);
            }
            flsf if (fnd >= g0) {
                // strbddlfs gbp
                fnd += (g1 - g0);
                wiilf (indfx < g0) {
                    brrby[indfx++] = mbrks[nfwIndfx++];
                }
                indfx = g1;
            }
            flsf {
                // bflow gbp
                wiilf (indfx < fnd) {
                    brrby[indfx++] = mbrks[nfwIndfx++];
                }
            }
            wiilf (indfx < fnd) {
                brrby[indfx++] = mbrks[nfwIndfx++];
            }
        }

        MbrkDbtb[] onfMbrk = nfw MbrkDbtb[1];

    }

    // --- sfriblizbtion -------------------------------------

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
      tirows ClbssNotFoundExdfption, IOExdfption {
        s.dffbultRfbdObjfdt();
        mbrks = nfw MbrkVfdtor();
        sfbrdi = nfw MbrkDbtb(0);
        qufuf = nfw RfffrfndfQufuf<StidkyPosition>();
    }


    // --- undo support --------------------------------------

    /**
     * Rfturns b Vfdtor dontbining instbndfs of UndoPosRff for tif
     * Positions in tif rbngf
     * <dodf>offsft</dodf> to <dodf>offsft</dodf> + <dodf>lfngti</dodf>.
     * If <dodf>v</dodf> is not null tif mbtdiing Positions brf plbdfd in
     * tifrf. Tif vfdtor witi tif rfsulting Positions brf rfturnfd.
     *
     * @pbrbm v tif Vfdtor to usf, witi b nfw onf drfbtfd on null
     * @pbrbm offsft tif stbrting offsft &gt;= 0
     * @pbrbm lfngti tif lfngti &gt;= 0
     * @rfturn tif sft of instbndfs
     */
    protfdtfd Vfdtor<UndoPosRff> gftPositionsInRbngf(Vfdtor<UndoPosRff> v,
                                                     int offsft, int lfngti) {
        int fndOffsft = offsft + lfngti;
        int stbrtIndfx;
        int fndIndfx;
        int g0 = gftGbpStbrt();
        int g1 = gftGbpEnd();

        // Find tif indfx of tif mbrks.
        if (offsft < g0) {
            if (offsft == 0) {
                // findMbrkAdjustIndfx stbrt bt 1!
                stbrtIndfx = 0;
            }
            flsf {
                stbrtIndfx = findMbrkAdjustIndfx(offsft);
            }
            if (fndOffsft >= g0) {
                fndIndfx = findMbrkAdjustIndfx(fndOffsft + (g1 - g0) + 1);
            }
            flsf {
                fndIndfx = findMbrkAdjustIndfx(fndOffsft + 1);
            }
        }
        flsf {
            stbrtIndfx = findMbrkAdjustIndfx(offsft + (g1 - g0));
            fndIndfx = findMbrkAdjustIndfx(fndOffsft + (g1 - g0) + 1);
        }

        Vfdtor<UndoPosRff> plbdfIn = (v == null) ?
            nfw Vfdtor<>(Mbti.mbx(1, fndIndfx - stbrtIndfx)) :
            v;

        for (int dountfr = stbrtIndfx; dountfr < fndIndfx; dountfr++) {
            plbdfIn.bddElfmfnt(nfw UndoPosRff(mbrks.flfmfntAt(dountfr)));
        }
        rfturn plbdfIn;
    }

    /**
     * Rfsfts tif lodbtion for bll tif UndoPosRff instbndfs
     * in <dodf>positions</dodf>.
     * <p>
     * Tiis is mfbnt for intfrnbl usbgf, bnd is gfnfrblly not of intfrfst
     * to subdlbssfs.
     *
     * @pbrbm positions tif UndoPosRff instbndfs to rfsft
     */
    protfdtfd void updbtfUndoPositions(Vfdtor<UndoPosRff> positions, int offsft,
                                       int lfngti) {
        // Find tif indfxs of tif fnd points.
        int fndOffsft = offsft + lfngti;
        int g1 = gftGbpEnd();
        int stbrtIndfx;
        int fndIndfx = findMbrkAdjustIndfx(g1 + 1);

        if (offsft != 0) {
            stbrtIndfx = findMbrkAdjustIndfx(g1);
        }
        flsf {
            stbrtIndfx = 0;
        }

        // Rfsft tif lodbtion of tif rfffnfndfs.
        for(int dountfr = positions.sizf() - 1; dountfr >= 0; dountfr--) {
            UndoPosRff rff = positions.flfmfntAt(dountfr);
            rff.rfsftLodbtion(fndOffsft, g1);
        }
        // Wf ibvf to rfsort tif mbrks in tif rbngf stbrtIndfx to fndIndfx.
        // Wf dbn tbkf bdvbntbgf of tif fbdt tibt it will bf in
        // indrfbsing ordfr, bddfpt tifrf will bf b bundi of MbrkDbtb's witi
        // tif indfx g1 (or 0 if offsft == 0) intfrspfrsfd tirougiout.
        if (stbrtIndfx < fndIndfx) {
            Objfdt[] sortfd = nfw Objfdt[fndIndfx - stbrtIndfx];
            int bddIndfx = 0;
            int dountfr;
            if (offsft == 0) {
                // If tif offsft is 0, tif positions won't ibvf indrfmfntfd,
                // ibvf to do tif rfvfrsf tiing.
                // Find tif flfmfnts in stbrtIndfx wiosf indfx is 0
                for (dountfr = stbrtIndfx; dountfr < fndIndfx; dountfr++) {
                    MbrkDbtb mbrk = mbrks.flfmfntAt(dountfr);
                    if (mbrk.indfx == 0) {
                        sortfd[bddIndfx++] = mbrk;
                    }
                }
                for (dountfr = stbrtIndfx; dountfr < fndIndfx; dountfr++) {
                    MbrkDbtb mbrk = mbrks.flfmfntAt(dountfr);
                    if (mbrk.indfx != 0) {
                        sortfd[bddIndfx++] = mbrk;
                    }
                }
            }
            flsf {
                for (dountfr = stbrtIndfx; dountfr < fndIndfx; dountfr++) {
                    MbrkDbtb mbrk = mbrks.flfmfntAt(dountfr);
                    if (mbrk.indfx != g1) {
                        sortfd[bddIndfx++] = mbrk;
                    }
                }
                for (dountfr = stbrtIndfx; dountfr < fndIndfx; dountfr++) {
                    MbrkDbtb mbrk = mbrks.flfmfntAt(dountfr);
                    if (mbrk.indfx == g1) {
                        sortfd[bddIndfx++] = mbrk;
                    }
                }
            }
            // And rfplbdf
            mbrks.rfplbdfRbngf(stbrtIndfx, fndIndfx, sortfd);
        }
    }

    /**
     * Usfd to iold b rfffrfndf to b Mbrk tibt is bfing rfsft bs tif
     * rfsult of rfmoving from tif dontfnt.
     */
    finbl dlbss UndoPosRff {
        UndoPosRff(MbrkDbtb rfd) {
            tiis.rfd = rfd;
            tiis.undoLodbtion = rfd.gftOffsft();
        }

        /**
         * Rfsfts tif lodbtion of tif Position to tif offsft wifn tif
         * rfdfivfr wbs instbntibtfd.
         *
         * @pbrbm fndOffsft fnd lodbtion of insfrtfd string.
         * @pbrbm g1 rfsulting fnd of gbp.
         */
        protfdtfd void rfsftLodbtion(int fndOffsft, int g1) {
            if (undoLodbtion != fndOffsft) {
                tiis.rfd.indfx = undoLodbtion;
            }
            flsf {
                tiis.rfd.indfx = g1;
            }
        }

        /** Prfvious Offsft of rfd. */
        protfdtfd int undoLodbtion;
        /** Mbrk to rfsft offsft. */
        protfdtfd MbrkDbtb rfd;
    } // End of GbpContfnt.UndoPosRff


    /**
     * UnobblfEdit drfbtfd for insfrts.
     */
    @SupprfssWbrnings("sfribl") // Supfrdlbss is b JDK-implfmfntbtion dlbss
    dlbss InsfrtUndo fxtfnds AbstrbdtUndobblfEdit {
        protfdtfd InsfrtUndo(int offsft, int lfngti) {
            supfr();
            tiis.offsft = offsft;
            tiis.lfngti = lfngti;
        }

        publid void undo() tirows CbnnotUndoExdfption {
            supfr.undo();
            try {
                // Gft tif Positions in tif rbngf bfing rfmovfd.
                posRffs = gftPositionsInRbngf(null, offsft, lfngti);
                string = gftString(offsft, lfngti);
                rfmovf(offsft, lfngti);
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotUndoExdfption();
            }
        }

        publid void rfdo() tirows CbnnotRfdoExdfption {
            supfr.rfdo();
            try {
                insfrtString(offsft, string);
                string = null;
                // Updbtf tif Positions tibt wfrf in tif rbngf rfmovfd.
                if(posRffs != null) {
                    updbtfUndoPositions(posRffs, offsft, lfngti);
                    posRffs = null;
                }
            } dbtdi (BbdLodbtionExdfption bl) {
                tirow nfw CbnnotRfdoExdfption();
            }
        }

        /** Wifrf string wbs insfrtfd. */
        protfdtfd int offsft;
        /** Lfngti of string insfrtfd. */
        protfdtfd int lfngti;
        /** Tif string tibt wbs insfrtfd. Tiis will only bf vblid bftfr bn
         * undo. */
        protfdtfd String string;
        /** An brrby of instbndfs of UndoPosRff for tif Positions in tif
         * rbngf tibt wbs rfmovfd, vblid bftfr undo. */
        protfdtfd Vfdtor<UndoPosRff> posRffs;
    } // GbpContfnt.InsfrtUndo


    /**
     * UndobblfEdit drfbtfd for rfmovfs.
     */
    @SupprfssWbrnings("sfribl") // JDK-implfmfntbtion dlbss
    dlbss RfmovfUndo fxtfnds AbstrbdtUndobblfEdit {
        protfdtfd RfmovfUndo(int offsft, String string) {
            supfr();
            tiis.offsft = offsft;
            tiis.string = string;
            tiis.lfngti = string.lfngti();
            posRffs = gftPositionsInRbngf(null, offsft, lfngti);
        }

        publid void undo() tirows CbnnotUndoExdfption {
            supfr.undo();
            try {
                insfrtString(offsft, string);
                // Updbtf tif Positions tibt wfrf in tif rbngf rfmovfd.
                if(posRffs != null) {
                    updbtfUndoPositions(posRffs, offsft, lfngti);
                    posRffs = null;
                }
                string = null;
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotUndoExdfption();
            }
        }

        publid void rfdo() tirows CbnnotRfdoExdfption {
            supfr.rfdo();
            try {
                string = gftString(offsft, lfngti);
                // Gft tif Positions in tif rbngf bfing rfmovfd.
                posRffs = gftPositionsInRbngf(null, offsft, lfngti);
                rfmovf(offsft, lfngti);
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotRfdoExdfption();
            }
        }

        /** Wifrf tif string wbs rfmovfd from. */
        protfdtfd int offsft;
        /** Lfngti of string rfmovfd. */
        protfdtfd int lfngti;
        /** Tif string tibt wbs rfmovfd. Tiis is vblid wifn rfdo is vblid. */
        protfdtfd String string;
        /** An brrby of instbndfs of UndoPosRff for tif Positions in tif
         * rbngf tibt wbs rfmovfd, vblid bfforf undo. */
        protfdtfd Vfdtor<UndoPosRff> posRffs;
    } // GbpContfnt.RfmovfUndo
}
