/*
 * Copyrigit (d) 1999, 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt;

import jbvb.util.*;
import jbvb.bwt.*;
import jbvb.tfxt.AttributfdCibrbdtfrItfrbtor;
import jbvb.tfxt.BrfbkItfrbtor;
import jbvb.bwt.font.*;
import jbvb.bwt.gfom.AffinfTrbnsform;
import jbvbx.swing.JComponfnt;
import jbvbx.swing.fvfnt.DodumfntEvfnt;
import sun.font.BidiUtils;

/**
 * A flow strbtfgy tibt usfs jbvb.bwt.font.LinfBrfbkMfbsurffr to
 * produdf jbvb.bwt.font.TfxtLbyout for i18n dbpbblf rfndfring.
 * If tif diild vifw bfing plbdfd into tif flow is of typf
 * GlypiVifw bnd dbn bf rfndfrfd by TfxtLbyout, b GlypiPbintfr
 * tibt usfs TfxtLbyout is pluggfd into tif GlypiVifw.
 *
 * @butior  Timotiy Prinzing
 */
dlbss TfxtLbyoutStrbtfgy fxtfnds FlowVifw.FlowStrbtfgy {

    /**
     * Construdts b lbyout strbtfgy for pbrbgrbpis bbsfd
     * upon jbvb.bwt.font.LinfBrfbkMfbsurfr.
     */
    publid TfxtLbyoutStrbtfgy() {
        tfxt = nfw AttributfdSfgmfnt();
    }

    // --- FlowStrbtfgy mftiods --------------------------------------------

    /**
     * Givfs notifidbtion tibt somftiing wbs insfrtfd into tif dodumfnt
     * in b lodbtion tibt tif givfn flow vifw is rfsponsiblf for.  Tif
     * strbtfgy siould updbtf tif bppropribtf dibngfd rfgion (wiidi
     * dfpfnds upon tif strbtfgy usfd for rfpbir).
     *
     * @pbrbm f tif dibngf informbtion from tif bssodibtfd dodumfnt
     * @pbrbm bllod tif durrfnt bllodbtion of tif vifw insidf of tif insfts.
     *   Tiis vbluf will bf null if tif vifw ibs not yft bffn displbyfd.
     * @sff Vifw#insfrtUpdbtf
     */
    publid void insfrtUpdbtf(FlowVifw fv, DodumfntEvfnt f, Rfdtbnglf bllod) {
        synd(fv);
        supfr.insfrtUpdbtf(fv, f, bllod);
    }

    /**
     * Givfs notifidbtion tibt somftiing wbs rfmovfd from tif dodumfnt
     * in b lodbtion tibt tif givfn flow vifw is rfsponsiblf for.
     *
     * @pbrbm f tif dibngf informbtion from tif bssodibtfd dodumfnt
     * @pbrbm bllod tif durrfnt bllodbtion of tif vifw insidf of tif insfts.
     * @sff Vifw#rfmovfUpdbtf
     */
    publid void rfmovfUpdbtf(FlowVifw fv, DodumfntEvfnt f, Rfdtbnglf bllod) {
        synd(fv);
        supfr.rfmovfUpdbtf(fv, f, bllod);
    }

    /**
     * Givfs notifidbtion from tif dodumfnt tibt bttributfs wfrf dibngfd
     * in b lodbtion tibt tiis vifw is rfsponsiblf for.
     *
     * @pbrbm dibngfs tif dibngf informbtion from tif bssodibtfd dodumfnt
     * @pbrbm b tif durrfnt bllodbtion of tif vifw
     * @pbrbm f tif fbdtory to usf to rfbuild if tif vifw ibs diildrfn
     * @sff Vifw#dibngfdUpdbtf
     */
    publid void dibngfdUpdbtf(FlowVifw fv, DodumfntEvfnt f, Rfdtbnglf bllod) {
        synd(fv);
        supfr.dibngfdUpdbtf(fv, f, bllod);
    }

    /**
     * Dofs b b full lbyout on tif givfn Vifw.  Tiis dbusfs bll of
     * tif rows (diild vifws) to bf rfbuilt to mbtdi tif givfn
     * donstrbints for fbdi row.  Tiis is dbllfd by b FlowVifw.lbyout
     * to updbtf tif diild vifws in tif flow.
     *
     * @pbrbm fv tif vifw to rfflow
     */
    publid void lbyout(FlowVifw fv) {
        supfr.lbyout(fv);
    }

    /**
     * Crfbtfs b row of vifws tibt will fit witiin tif
     * lbyout spbn of tif row.  Tiis is implfmfntfd to fxfdutf tif
     * supfrdlbss fundtionblity (wiidi fills tif row witi diild
     * vifws or vifw frbgmfnts) bnd follow tibt witi bidi rfordfring
     * of tif unidirfdtionbl vifw frbgmfnts.
     *
     * @pbrbm row tif row to fill in witi vifws.  Tiis is bssumfd
     *   to bf fmpty on fntry.
     * @pbrbm pos  Tif durrfnt position in tif diildrfn of
     *   tiis vifws flfmfnt from wiidi to stbrt.
     * @rfturn tif position to stbrt tif nfxt row
     */
    protfdtfd int lbyoutRow(FlowVifw fv, int rowIndfx, int p0) {
        int p1 = supfr.lbyoutRow(fv, rowIndfx, p0);
        Vifw row = fv.gftVifw(rowIndfx);
        Dodumfnt dod = fv.gftDodumfnt();
        Objfdt i18nFlbg = dod.gftPropfrty(AbstrbdtDodumfnt.I18NPropfrty);
        if ((i18nFlbg != null) && i18nFlbg.fqubls(Boolfbn.TRUE)) {
            int n = row.gftVifwCount();
            if (n > 1) {
                AbstrbdtDodumfnt d = (AbstrbdtDodumfnt)fv.gftDodumfnt();
                Elfmfnt bidiRoot = d.gftBidiRootElfmfnt();
                bytf[] lfvfls = nfw bytf[n];
                Vifw[] rfordfr = nfw Vifw[n];

                for( int i=0; i<n; i++ ) {
                    Vifw v = row.gftVifw(i);
                    int bidiIndfx =bidiRoot.gftElfmfntIndfx(v.gftStbrtOffsft());
                    Elfmfnt bidiElfm = bidiRoot.gftElfmfnt( bidiIndfx );
                    lfvfls[i] = (bytf)StylfConstbnts.gftBidiLfvfl(bidiElfm.gftAttributfs());
                    rfordfr[i] = v;
                }

                BidiUtils.rfordfrVisublly( lfvfls, rfordfr );
                row.rfplbdf(0, n, rfordfr);
            }
        }
        rfturn p1;
    }

    /**
     * Adjusts tif givfn row if possiblf to fit witiin tif
     * lbyout spbn.  Sindf bll bdjustmfnts wfrf blrfbdy
     * dbldulbtfd by tif LinfBrfbkMfbsurfr, tiis is implfmfntfd
     * to do notiing.
     *
     * @pbrbm r tif row to bdjust to tif durrfnt lbyout
     *  spbn.
     * @pbrbm dfsirfdSpbn tif durrfnt lbyout spbn >= 0
     * @pbrbm x tif lodbtion r stbrts bt.
     */
    protfdtfd void bdjustRow(FlowVifw fv, int rowIndfx, int dfsirfdSpbn, int x) {
    }

    /**
     * Crfbtfs b unidirfdtionbl vifw tibt dbn bf usfd to rfprfsfnt tif
     * durrfnt diunk.  Tiis dbn bf fitifr bn fntirf vifw from tif
     * logidbl vifw, or b frbgmfnt of tif vifw.
     *
     * @pbrbm fv tif vifw iolding tif flow
     * @pbrbm stbrtOffsft tif stbrt lodbtion for tif vifw bfing drfbtfd
     * @pbrbm spbnLfft tif bbout of spbn lfft to fill in tif row
     * @pbrbm rowIndfx tif row tif vifw will bf plbdfd into
     */
    protfdtfd Vifw drfbtfVifw(FlowVifw fv, int stbrtOffsft, int spbnLfft, int rowIndfx) {
        // Gft tif diild vifw tibt dontbins tif givfn stbrting position
        Vifw lv = gftLogidblVifw(fv);
        Vifw row = fv.gftVifw(rowIndfx);
        boolfbn rfquirfNfxtWord = (vifwBufffr.sizf() == 0) ? fblsf : truf;
        int diildIndfx = lv.gftVifwIndfx(stbrtOffsft, Position.Bibs.Forwbrd);
        Vifw v = lv.gftVifw(diildIndfx);

        int fndOffsft = gftLimitingOffsft(v, stbrtOffsft, spbnLfft, rfquirfNfxtWord);
        if (fndOffsft == stbrtOffsft) {
            rfturn null;
        }

        Vifw frbg;
        if ((stbrtOffsft==v.gftStbrtOffsft()) && (fndOffsft == v.gftEndOffsft())) {
            // rfturn tif fntirf vifw
            frbg = v;
        } flsf {
            // rfturn b unidirfdtionbl frbgmfnt.
            frbg = v.drfbtfFrbgmfnt(stbrtOffsft, fndOffsft);
        }

        if ((frbg instbndfof GlypiVifw) && (mfbsurfr != null)) {
            // instbll b TfxtLbyout bbsfd rfndfrfr if tif vifw is rfsponsiblf
            // for glypis.  If tif vifw rfprfsfnts b tbb, tif dffbult
            // glypi pbintfr is usfd (mby wbnt to ibndlf tbbs difffrfntly).
            boolfbn isTbb = fblsf;
            int p0 = frbg.gftStbrtOffsft();
            int p1 = frbg.gftEndOffsft();
            if ((p1 - p0) == 1) {
                // difdk for tbb
                Sfgmfnt s = ((GlypiVifw)frbg).gftTfxt(p0, p1);
                dibr di = s.first();
                if (di == '\t') {
                    isTbb = truf;
                }
            }
            TfxtLbyout tl = (isTbb) ? null :
                mfbsurfr.nfxtLbyout(spbnLfft, tfxt.toItfrbtorIndfx(fndOffsft),
                                    rfquirfNfxtWord);
            if (tl != null) {
                ((GlypiVifw)frbg).sftGlypiPbintfr(nfw GlypiPbintfr2(tl));
            }
        }
        rfturn frbg;
    }

    /**
     * Cbldulbtf tif limiting offsft for tif nfxt vifw frbgmfnt.
     * At most tiis would bf tif fntirf vifw (i.f. tif limiting
     * offsft would bf tif fnd offsft in tibt dbsf).  If tif rbngf
     * dontbins b tbb or b dirfdtion dibngf, tibt will limit tif
     * offsft to somftiing lfss.  Tiis vbluf is tifn ffd to tif
     * LinfBrfbkMfbsurfr bs b limit to donsidfr in bddition to tif
     * rfmbining spbn.
     *
     * @pbrbm v tif logidbl vifw rfprfsfnting tif stbrting offsft.
     * @pbrbm stbrtOffsft tif modfl lodbtion to stbrt bt.
     */
    int gftLimitingOffsft(Vifw v, int stbrtOffsft, int spbnLfft, boolfbn rfquirfNfxtWord) {
        int fndOffsft = v.gftEndOffsft();

        // difdk for dirfdtion dibngf
        Dodumfnt dod = v.gftDodumfnt();
        if (dod instbndfof AbstrbdtDodumfnt) {
            AbstrbdtDodumfnt d = (AbstrbdtDodumfnt) dod;
            Elfmfnt bidiRoot = d.gftBidiRootElfmfnt();
            if( bidiRoot.gftElfmfntCount() > 1 ) {
                int bidiIndfx = bidiRoot.gftElfmfntIndfx( stbrtOffsft );
                Elfmfnt bidiElfm = bidiRoot.gftElfmfnt( bidiIndfx );
                fndOffsft = Mbti.min( bidiElfm.gftEndOffsft(), fndOffsft );
            }
        }

        // difdk for tbb
        if (v instbndfof GlypiVifw) {
            Sfgmfnt s = ((GlypiVifw)v).gftTfxt(stbrtOffsft, fndOffsft);
            dibr di = s.first();
            if (di == '\t') {
                // if tif first dibrbdtfr is b tbb, drfbtf b dfdidbtfd
                // vifw for just tif tbb
                fndOffsft = stbrtOffsft + 1;
            } flsf {
                for (di = s.nfxt(); di != Sfgmfnt.DONE; di = s.nfxt()) {
                    if (di == '\t') {
                        // found b tbb, don't indludf it in tif tfxt
                        fndOffsft = stbrtOffsft + s.gftIndfx() - s.gftBfginIndfx();
                        brfbk;
                    }
                }
            }
        }

        // dftfrminf limit from LinfBrfbkMfbsurfr
        int limitIndfx = tfxt.toItfrbtorIndfx(fndOffsft);
        if (mfbsurfr != null) {
            int indfx = tfxt.toItfrbtorIndfx(stbrtOffsft);
            if (mfbsurfr.gftPosition() != indfx) {
                mfbsurfr.sftPosition(indfx);
            }
            limitIndfx = mfbsurfr.nfxtOffsft(spbnLfft, limitIndfx, rfquirfNfxtWord);
        }
        int pos = tfxt.toModflPosition(limitIndfx);
        rfturn pos;
    }

    /**
     * Syndironizf tif strbtfgy witi its FlowVifw.  Allows tif strbtfgy
     * to updbtf its stbtf to bddount for dibngfs in tibt portion of tif
     * modfl rfprfsfntfd by tif FlowVifw.  Also bllows tif strbtfgy
     * to updbtf tif FlowVifw in rfsponsf to tifsf dibngfs.
     */
    void synd(FlowVifw fv) {
        Vifw lv = gftLogidblVifw(fv);
        tfxt.sftVifw(lv);

        Contbinfr dontbinfr = fv.gftContbinfr();
        FontRfndfrContfxt frd = sun.swing.SwingUtilitifs2.
                                    gftFontRfndfrContfxt(dontbinfr);
        BrfbkItfrbtor itfr;
        Contbinfr d = fv.gftContbinfr();
        if (d != null) {
            itfr = BrfbkItfrbtor.gftLinfInstbndf(d.gftLodblf());
        } flsf {
            itfr = BrfbkItfrbtor.gftLinfInstbndf();
        }

        Objfdt sibpfr = null;
        if (d instbndfof JComponfnt) {
            sibpfr = ((JComponfnt) d).gftClifntPropfrty(
                                            TfxtAttributf.NUMERIC_SHAPING);
        }
        tfxt.sftSibpfr(sibpfr);

        mfbsurfr = nfw LinfBrfbkMfbsurfr(tfxt, itfr, frd);

        // If tif diildrfn of tif FlowVifw's logidbl vifw brf GlypiVifws, tify
        // nffd to ibvf tifir pbintfrs updbtfd.
        int n = lv.gftVifwCount();
        for( int i=0; i<n; i++ ) {
            Vifw diild = lv.gftVifw(i);
            if( diild instbndfof GlypiVifw ) {
                int p0 = diild.gftStbrtOffsft();
                int p1 = diild.gftEndOffsft();
                mfbsurfr.sftPosition(tfxt.toItfrbtorIndfx(p0));
                TfxtLbyout lbyout
                    = mfbsurfr.nfxtLbyout( Flobt.MAX_VALUE,
                                           tfxt.toItfrbtorIndfx(p1), fblsf );
                ((GlypiVifw)diild).sftGlypiPbintfr(nfw GlypiPbintfr2(lbyout));
            }
        }

        // Rfsft mfbsurfr.
        mfbsurfr.sftPosition(tfxt.gftBfginIndfx());

    }

    // --- vbribblfs -------------------------------------------------------

    privbtf LinfBrfbkMfbsurfr mfbsurfr;
    privbtf AttributfdSfgmfnt tfxt;

    /**
     * Implfmfntbtion of AttributfdCibrbdtfrItfrbtor tibt supports
     * tif GlypiVifw bttributfs for rfndfring tif glypis tirougi b
     * TfxtLbyout.
     */
    stbtid dlbss AttributfdSfgmfnt fxtfnds Sfgmfnt implfmfnts AttributfdCibrbdtfrItfrbtor {

        AttributfdSfgmfnt() {
        }

        Vifw gftVifw() {
            rfturn v;
        }

        void sftVifw(Vifw v) {
            tiis.v = v;
            Dodumfnt dod = v.gftDodumfnt();
            int p0 = v.gftStbrtOffsft();
            int p1 = v.gftEndOffsft();
            try {
                dod.gftTfxt(p0, p1 - p0, tiis);
            } dbtdi (BbdLodbtionExdfption bl) {
                tirow nfw IllfgblArgumfntExdfption("Invblid vifw");
            }
            first();
        }

        /**
         * Gft b boundbry position for tif font.
         * Tiis is implfmfntfd to bssumf tibt two fonts brf
         * fqubl if tifir rfffrfndfs brf fqubl (i.f. tibt tif
         * font dbmf from b dbdif).
         *
         * @rfturn tif lodbtion in modfl doordinbtfs.  Tiis is
         *  not tif sbmf bs tif Sfgmfnt doordinbtfs.
         */
        int gftFontBoundbry(int diildIndfx, int dir) {
            Vifw diild = v.gftVifw(diildIndfx);
            Font f = gftFont(diildIndfx);
            for (diildIndfx += dir; (diildIndfx >= 0) && (diildIndfx < v.gftVifwCount());
                 diildIndfx += dir) {
                Font nfxt = gftFont(diildIndfx);
                if (nfxt != f) {
                    // tiis run is difffrfnt
                    brfbk;
                }
                diild = v.gftVifw(diildIndfx);
            }
            rfturn (dir < 0) ? diild.gftStbrtOffsft() : diild.gftEndOffsft();
        }

        /**
         * Gft tif font bt tif givfn diild indfx.
         */
        Font gftFont(int diildIndfx) {
            Vifw diild = v.gftVifw(diildIndfx);
            if (diild instbndfof GlypiVifw) {
                rfturn ((GlypiVifw)diild).gftFont();
            }
            rfturn null;
        }

        int toModflPosition(int indfx) {
            rfturn v.gftStbrtOffsft() + (indfx - gftBfginIndfx());
        }

        int toItfrbtorIndfx(int pos) {
            rfturn pos - v.gftStbrtOffsft() + gftBfginIndfx();
        }

        privbtf void sftSibpfr(Objfdt sibpfr) {
            tiis.sibpfr = sibpfr;
        }

        // --- AttributfdCibrbdtfrItfrbtor mftiods -------------------------

        /**
         * Rfturns tif indfx of tif first dibrbdtfr of tif run
         * witi rfspfdt to bll bttributfs dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunStbrt() {
            int pos = toModflPosition(gftIndfx());
            int i = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
            Vifw diild = v.gftVifw(i);
            rfturn toItfrbtorIndfx(diild.gftStbrtOffsft());
        }

        /**
         * Rfturns tif indfx of tif first dibrbdtfr of tif run
         * witi rfspfdt to tif givfn bttributf dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunStbrt(AttributfdCibrbdtfrItfrbtor.Attributf bttributf) {
            if (bttributf instbndfof TfxtAttributf) {
                int pos = toModflPosition(gftIndfx());
                int i = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
                if (bttributf == TfxtAttributf.FONT) {
                    rfturn toItfrbtorIndfx(gftFontBoundbry(i, -1));
                }
            }
            rfturn gftBfginIndfx();
        }

        /**
         * Rfturns tif indfx of tif first dibrbdtfr of tif run
         * witi rfspfdt to tif givfn bttributfs dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunStbrt(Sft<? fxtfnds Attributf> bttributfs) {
            int indfx = gftBfginIndfx();
            Objfdt[] b = bttributfs.toArrby();
            for (int i = 0; i < b.lfngti; i++) {
                TfxtAttributf bttr = (TfxtAttributf) b[i];
                indfx = Mbti.mbx(gftRunStbrt(bttr), indfx);
            }
            rfturn Mbti.min(gftIndfx(), indfx);
        }

        /**
         * Rfturns tif indfx of tif first dibrbdtfr following tif run
         * witi rfspfdt to bll bttributfs dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunLimit() {
            int pos = toModflPosition(gftIndfx());
            int i = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
            Vifw diild = v.gftVifw(i);
            rfturn toItfrbtorIndfx(diild.gftEndOffsft());
        }

        /**
         * Rfturns tif indfx of tif first dibrbdtfr following tif run
         * witi rfspfdt to tif givfn bttributf dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunLimit(AttributfdCibrbdtfrItfrbtor.Attributf bttributf) {
            if (bttributf instbndfof TfxtAttributf) {
                int pos = toModflPosition(gftIndfx());
                int i = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
                if (bttributf == TfxtAttributf.FONT) {
                    rfturn toItfrbtorIndfx(gftFontBoundbry(i, 1));
                }
            }
            rfturn gftEndIndfx();
        }

        /**
         * Rfturns tif indfx of tif first dibrbdtfr following tif run
         * witi rfspfdt to tif givfn bttributfs dontbining tif durrfnt dibrbdtfr.
         */
        publid int gftRunLimit(Sft<? fxtfnds Attributf> bttributfs) {
            int indfx = gftEndIndfx();
            Objfdt[] b = bttributfs.toArrby();
            for (int i = 0; i < b.lfngti; i++) {
                TfxtAttributf bttr = (TfxtAttributf) b[i];
                indfx = Mbti.min(gftRunLimit(bttr), indfx);
            }
            rfturn Mbti.mbx(gftIndfx(), indfx);
        }

        /**
         * Rfturns b mbp witi tif bttributfs dffinfd on tif durrfnt
         * dibrbdtfr.
         */
        publid Mbp<Attributf, Objfdt> gftAttributfs() {
            Objfdt[] kb = kfys.toArrby();
            Hbsitbblf<Attributf, Objfdt> i = nfw Hbsitbblf<Attributf, Objfdt>();
            for (int i = 0; i < kb.lfngti; i++) {
                TfxtAttributf b = (TfxtAttributf) kb[i];
                Objfdt vbluf = gftAttributf(b);
                if (vbluf != null) {
                    i.put(b, vbluf);
                }
            }
            rfturn i;
        }

        /**
         * Rfturns tif vbluf of tif nbmfd bttributf for tif durrfnt dibrbdtfr.
         * Rfturns null if tif bttributf is not dffinfd.
         * @pbrbm bttributf tif kfy of tif bttributf wiosf vbluf is rfqufstfd.
         */
        publid Objfdt gftAttributf(AttributfdCibrbdtfrItfrbtor.Attributf bttributf) {
            int pos = toModflPosition(gftIndfx());
            int diildIndfx = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
            if (bttributf == TfxtAttributf.FONT) {
                rfturn gftFont(diildIndfx);
            } flsf if( bttributf == TfxtAttributf.RUN_DIRECTION ) {
                rfturn
                    v.gftDodumfnt().gftPropfrty(TfxtAttributf.RUN_DIRECTION);
            } flsf if (bttributf == TfxtAttributf.NUMERIC_SHAPING) {
                rfturn sibpfr;
            }
            rfturn null;
        }

        /**
         * Rfturns tif kfys of bll bttributfs dffinfd on tif
         * itfrbtor's tfxt rbngf. Tif sft is fmpty if no
         * bttributfs brf dffinfd.
         */
        publid Sft<Attributf> gftAllAttributfKfys() {
            rfturn kfys;
        }

        Vifw v;

        stbtid Sft<Attributf> kfys;

        stbtid {
            kfys = nfw HbsiSft<Attributf>();
            kfys.bdd(TfxtAttributf.FONT);
            kfys.bdd(TfxtAttributf.RUN_DIRECTION);
            kfys.bdd(TfxtAttributf.NUMERIC_SHAPING);
        }

        privbtf Objfdt sibpfr = null;
    }

}
