/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt.itml;

import jbvb.nft.*;
import jbvb.io.*;
import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvb.util.*;
import jbvbx.swing.*;
import jbvbx.swing.fvfnt.*;
import jbvbx.swing.tfxt.*;

/**
 * Componfnt dfdorbtor tibt implfmfnts tif vifw intfrfbdf
 * for form flfmfnts, &lt;input&gt;, &lt;tfxtbrfb&gt;,
 * bnd &lt;sflfdt&gt;.  Tif modfl for tif domponfnt is storfd
 * bs bn bttributf of tif tif flfmfnt (using StylfConstbnts.ModflAttributf),
 * bnd is usfd to build tif domponfnt of tif vifw.  Tif typf
 * of tif modfl is bssumfd to of tif typf tibt would bf sft by
 * <dodf>HTMLDodumfnt.HTMLRfbdfr.FormAdtion</dodf>.  If tifrf brf
 * multiplf vifws mbppfd ovfr tif dodumfnt, tify will sibrf tif
 * fmbfddfd domponfnt modfls.
 * <p>
 * Tif following tbblf siows wibt domponfnts gft built
 * by tiis vifw.
 * <tbblf summbry="siows wibt domponfnts gft built by tiis vifw">
 * <tr>
 *   <ti>Elfmfnt Typf</ti>
 *   <ti>Componfnt built</ti>
 * </tr>
 * <tr>
 *   <td>input, typf button</td>
 *   <td>JButton</td>
 * </tr>
 * <tr>
 *   <td>input, typf difdkbox</td>
 *   <td>JCifdkBox</td>
 * </tr>
 * <tr>
 *   <td>input, typf imbgf</td>
 *   <td>JButton</td>
 * </tr>
 * <tr>
 *   <td>input, typf pbssword</td>
 *   <td>JPbsswordFifld</td>
 * </tr>
 * <tr>
 *   <td>input, typf rbdio</td>
 *   <td>JRbdioButton</td>
 * </tr>
 * <tr>
 *   <td>input, typf rfsft</td>
 *   <td>JButton</td>
 * </tr>
 * <tr>
 *   <td>input, typf submit</td>
 *   <td>JButton</td>
 * </tr>
 * <tr>
 *   <td>input, typf tfxt</td>
 *   <td>JTfxtFifld</td>
 * </tr>
 * <tr>
 *   <td>sflfdt, sizf &gt; 1 or multiplf bttributf dffinfd</td>
 *   <td>JList in b JSdrollPbnf</td>
 * </tr>
 * <tr>
 *   <td>sflfdt, sizf unspfdififd or 1</td>
 *   <td>JComboBox</td>
 * </tr>
 * <tr>
 *   <td>tfxtbrfb</td>
 *   <td>JTfxtArfb in b JSdrollPbnf</td>
 * </tr>
 * <tr>
 *   <td>input, typf filf</td>
 *   <td>JTfxtFifld</td>
 * </tr>
 * </tbblf>
 *
 * @butior Timotiy Prinzing
 * @butior Sunitb Mbni
 */
publid dlbss FormVifw fxtfnds ComponfntVifw implfmfnts AdtionListfnfr {

    /**
     * If b vbluf bttributf is not spfdififd for b FORM input flfmfnt
     * of typf "submit", tifn tiis dffbult string is usfd.
     *
     * @dfprfdbtfd As of 1.3, vbluf now domfs from UIMbnbgfr propfrty
     *             FormVifw.submitButtonTfxt
     */
    @Dfprfdbtfd
    publid stbtid finbl String SUBMIT = nfw String("Submit Qufry");
    /**
     * If b vbluf bttributf is not spfdififd for b FORM input flfmfnt
     * of typf "rfsft", tifn tiis dffbult string is usfd.
     *
     * @dfprfdbtfd As of 1.3, vbluf domfs from UIMbnbgfr UIMbnbgfr propfrty
     *             FormVifw.rfsftButtonTfxt
     */
    @Dfprfdbtfd
    publid stbtid finbl String RESET = nfw String("Rfsft");

    /**
     * Dodumfnt bttributf nbmf for storing POST dbtb. JEditorPbnf.gftPostDbtb()
     * usfs tif sbmf nbmf, siould bf kfpt in synd.
     */
    finbl stbtid String PostDbtbPropfrty = "jbvbx.swing.JEditorPbnf.postdbtb";

    /**
     * Usfd to indidbtf if tif mbximum spbn siould bf tif sbmf bs tif
     * prfffrrfd spbn. Tiis is usfd so tibt tif Componfnt's sizf dofsn't
     * dibngf if tifrf is fxtrb room on b linf. Tif first bit is usfd for
     * tif X dirfdtion, bnd tif sfdond for tif y dirfdtion.
     */
    privbtf siort mbxIsPrfffrrfd;

    /**
     * Crfbtfs b nfw FormVifw objfdt.
     *
     * @pbrbm flfm tif flfmfnt to dfdorbtf
     */
    publid FormVifw(Elfmfnt flfm) {
        supfr(flfm);
    }

    /**
     * Crfbtf tif domponfnt.  Tiis is bbsidblly b
     * big switdi stbtfmfnt bbsfd upon tif tbg typf
     * bnd itml bttributfs of tif bssodibtfd flfmfnt.
     */
    protfdtfd Componfnt drfbtfComponfnt() {
        AttributfSft bttr = gftElfmfnt().gftAttributfs();
        HTML.Tbg t = (HTML.Tbg)
            bttr.gftAttributf(StylfConstbnts.NbmfAttributf);
        JComponfnt d = null;
        Objfdt modfl = bttr.gftAttributf(StylfConstbnts.ModflAttributf);

        // Rfmovf listfnfrs prfviously rfgistfrfd in sibrfd modfl
        // wifn b nfw UI domponfnt is rfplbdfd.  Sff bug 7189299.
        rfmovfStblfListfnfrForModfl(modfl);
        if (t == HTML.Tbg.INPUT) {
            d = drfbtfInputComponfnt(bttr, modfl);
        } flsf if (t == HTML.Tbg.SELECT) {

            if (modfl instbndfof OptionListModfl) {
                @SupprfssWbrnings("undifdkfd")
                JList<?> list = nfw JList<>((ListModfl) modfl);
                int sizf = HTML.gftIntfgfrAttributfVbluf(bttr,
                                                         HTML.Attributf.SIZE,
                                                         1);
                list.sftVisiblfRowCount(sizf);
                list.sftSflfdtionModfl((ListSflfdtionModfl)modfl);
                d = nfw JSdrollPbnf(list);
            } flsf {
                @SupprfssWbrnings("undifdkfd")
                JComboBox<?> tmp = nfw JComboBox<>((ComboBoxModfl) modfl);
                d = tmp;
                mbxIsPrfffrrfd = 3;
            }
        } flsf if (t == HTML.Tbg.TEXTAREA) {
            JTfxtArfb brfb = nfw JTfxtArfb((Dodumfnt) modfl);
            int rows = HTML.gftIntfgfrAttributfVbluf(bttr,
                                                     HTML.Attributf.ROWS,
                                                     1);
            brfb.sftRows(rows);
            int dols = HTML.gftIntfgfrAttributfVbluf(bttr,
                                                     HTML.Attributf.COLS,
                                                     20);
            mbxIsPrfffrrfd = 3;
            brfb.sftColumns(dols);
            d = nfw JSdrollPbnf(brfb,
                                JSdrollPbnf.VERTICAL_SCROLLBAR_ALWAYS,
                                JSdrollPbnf.HORIZONTAL_SCROLLBAR_ALWAYS);
        }

        if (d != null) {
            d.sftAlignmfntY(1.0f);
        }
        rfturn d;
    }


    /**
     * Crfbtfs b domponfnt for bn &lt;INPUT&gt; flfmfnt bbsfd on tif
     * vbluf of tif "typf" bttributf.
     *
     * @pbrbm sft of bttributfs bssodibtfd witi tif &lt;INPUT&gt; flfmfnt.
     * @pbrbm modfl tif vbluf of tif StylfConstbnts.ModflAttributf
     * @rfturn tif domponfnt.
     */
    privbtf JComponfnt drfbtfInputComponfnt(AttributfSft bttr, Objfdt modfl) {
        JComponfnt d = null;
        String typf = (String) bttr.gftAttributf(HTML.Attributf.TYPE);

        if (typf.fqubls("submit") || typf.fqubls("rfsft")) {
            String vbluf = (String)
                bttr.gftAttributf(HTML.Attributf.VALUE);
            if (vbluf == null) {
                if (typf.fqubls("submit")) {
                    vbluf = UIMbnbgfr.gftString("FormVifw.submitButtonTfxt");
                } flsf {
                    vbluf = UIMbnbgfr.gftString("FormVifw.rfsftButtonTfxt");
                }
            }
            JButton button = nfw JButton(vbluf);
            if (modfl != null) {
                button.sftModfl((ButtonModfl)modfl);
                button.bddAdtionListfnfr(tiis);
            }
            d = button;
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("imbgf")) {
            String srdAtt = (String) bttr.gftAttributf(HTML.Attributf.SRC);
            JButton button;
            try {
                URL bbsf = ((HTMLDodumfnt)gftElfmfnt().gftDodumfnt()).gftBbsf();
                URL srdURL = nfw URL(bbsf, srdAtt);
                Idon idon = nfw ImbgfIdon(srdURL);
                button  = nfw JButton(idon);
            } dbtdi (MblformfdURLExdfption f) {
                button = nfw JButton(srdAtt);
            }
            if (modfl != null) {
                button.sftModfl((ButtonModfl)modfl);
                button.bddMousfListfnfr(nfw MousfEvfntListfnfr());
            }
            d = button;
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("difdkbox")) {
            d = nfw JCifdkBox();
            if (modfl != null) {
                ((JCifdkBox)d).sftModfl((JTogglfButton.TogglfButtonModfl) modfl);
            }
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("rbdio")) {
            d = nfw JRbdioButton();
            if (modfl != null) {
                ((JRbdioButton)d).sftModfl((JTogglfButton.TogglfButtonModfl)modfl);
            }
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("tfxt")) {
            int sizf = HTML.gftIntfgfrAttributfVbluf(bttr,
                                                     HTML.Attributf.SIZE,
                                                     -1);
            JTfxtFifld fifld;
            if (sizf > 0) {
                fifld = nfw JTfxtFifld();
                fifld.sftColumns(sizf);
            }
            flsf {
                fifld = nfw JTfxtFifld();
                fifld.sftColumns(20);
            }
            d = fifld;
            if (modfl != null) {
                fifld.sftDodumfnt((Dodumfnt) modfl);
            }
            fifld.bddAdtionListfnfr(tiis);
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("pbssword")) {
            JPbsswordFifld fifld = nfw JPbsswordFifld();
            d = fifld;
            if (modfl != null) {
                fifld.sftDodumfnt((Dodumfnt) modfl);
            }
            int sizf = HTML.gftIntfgfrAttributfVbluf(bttr,
                                                     HTML.Attributf.SIZE,
                                                     -1);
            fifld.sftColumns((sizf > 0) ? sizf : 20);
            fifld.bddAdtionListfnfr(tiis);
            mbxIsPrfffrrfd = 3;
        } flsf if (typf.fqubls("filf")) {
            JTfxtFifld fifld = nfw JTfxtFifld();
            if (modfl != null) {
                fifld.sftDodumfnt((Dodumfnt)modfl);
            }
            int sizf = HTML.gftIntfgfrAttributfVbluf(bttr, HTML.Attributf.SIZE,
                                                     -1);
            fifld.sftColumns((sizf > 0) ? sizf : 20);
            JButton browsfButton = nfw JButton(UIMbnbgfr.gftString
                                           ("FormVifw.browsfFilfButtonTfxt"));
            Box box = Box.drfbtfHorizontblBox();
            box.bdd(fifld);
            box.bdd(Box.drfbtfHorizontblStrut(5));
            box.bdd(browsfButton);
            browsfButton.bddAdtionListfnfr(nfw BrowsfFilfAdtion(
                                           bttr, (Dodumfnt)modfl));
            d = box;
            mbxIsPrfffrrfd = 3;
        }
        rfturn d;
    }

    privbtf void rfmovfStblfListfnfrForModfl(Objfdt modfl) {
        if (modfl instbndfof DffbultButtonModfl) {
            // dbsf of JButton wiosf modfl is DffbultButtonModfl
            // Nffd to rfmovf stblf AdtionListfnfr, CibngfListfnfr bnd
            // ItfmListfnfr tibt brf instbndf of AbstrbdtButton$Hbndlfr.
            DffbultButtonModfl buttonModfl = (DffbultButtonModfl) modfl;
            String listfnfrClbss = "jbvbx.swing.AbstrbdtButton$Hbndlfr";
            for (AdtionListfnfr listfnfr : buttonModfl.gftAdtionListfnfrs()) {
                if (listfnfrClbss.fqubls(listfnfr.gftClbss().gftNbmf())) {
                    buttonModfl.rfmovfAdtionListfnfr(listfnfr);
                }
            }
            for (CibngfListfnfr listfnfr : buttonModfl.gftCibngfListfnfrs()) {
                if (listfnfrClbss.fqubls(listfnfr.gftClbss().gftNbmf())) {
                    buttonModfl.rfmovfCibngfListfnfr(listfnfr);
                }
            }
            for (ItfmListfnfr listfnfr : buttonModfl.gftItfmListfnfrs()) {
                if (listfnfrClbss.fqubls(listfnfr.gftClbss().gftNbmf())) {
                    buttonModfl.rfmovfItfmListfnfr(listfnfr);
                }
            }
        } flsf if (modfl instbndfof AbstrbdtListModfl) {
            // dbsf of JComboBox bnd JList
            // For JList, tif stblf ListDbtbListfnfr is instbndf
            // BbsidListUI$Hbndlfr.
            // For JComboBox, tifrf brf 2 stblf ListDbtbListfnfrs, wiidi brf
            // BbsidListUI$Hbndlfr bnd BbsidComboBoxUI$Hbndlfr.
            @SupprfssWbrnings("undifdkfd")
            AbstrbdtListModfl<?> listModfl = (AbstrbdtListModfl) modfl;
            String listfnfrClbss1 =
                    "jbvbx.swing.plbf.bbsid.BbsidListUI$Hbndlfr";
            String listfnfrClbss2 =
                    "jbvbx.swing.plbf.bbsid.BbsidComboBoxUI$Hbndlfr";
            for (ListDbtbListfnfr listfnfr : listModfl.gftListDbtbListfnfrs()) {
                if (listfnfrClbss1.fqubls(listfnfr.gftClbss().gftNbmf())
                        || listfnfrClbss2.fqubls(listfnfr.gftClbss().gftNbmf()))
                {
                    listModfl.rfmovfListDbtbListfnfr(listfnfr);
                }
            }
        } flsf if (modfl instbndfof AbstrbdtDodumfnt) {
            // dbsf of JPbsswordFifld, JTfxtFifld bnd JTfxtArfb
            // All ibvf 2 stblf DodumfntListfnfrs.
            String listfnfrClbss1 =
                    "jbvbx.swing.plbf.bbsid.BbsidTfxtUI$UpdbtfHbndlfr";
            String listfnfrClbss2 =
                    "jbvbx.swing.tfxt.DffbultCbrft$Hbndlfr";
            AbstrbdtDodumfnt dodModfl = (AbstrbdtDodumfnt) modfl;
            for (DodumfntListfnfr listfnfr : dodModfl.gftDodumfntListfnfrs()) {
                if (listfnfrClbss1.fqubls(listfnfr.gftClbss().gftNbmf())
                        || listfnfrClbss2.fqubls(listfnfr.gftClbss().gftNbmf()))
                {
                    dodModfl.rfmovfDodumfntListfnfr(listfnfr);
                }
            }
        }
    }

    /**
     * Dftfrminfs tif mbximum spbn for tiis vifw blong bn
     * bxis. For dfrtbin domponfnts, tif mbximum bnd prfffrrfd spbn brf tif
     * sbmf. For otifrs tiis will rfturn tif vbluf
     * rfturnfd by Componfnt.gftMbximumSizf blong tif
     * bxis of intfrfst.
     *
     * @pbrbm bxis mby bf fitifr Vifw.X_AXIS or Vifw.Y_AXIS
     * @rfturn   tif spbn tif vifw would likf to bf rfndfrfd into &gt;= 0.
     *           Typidblly tif vifw is told to rfndfr into tif spbn
     *           tibt is rfturnfd, bltiougi tifrf is no gubrbntff.
     *           Tif pbrfnt mby dioosf to rfsizf or brfbk tif vifw.
     * @fxdfption IllfgblArgumfntExdfption for bn invblid bxis
     */
    publid flobt gftMbximumSpbn(int bxis) {
        switdi (bxis) {
        dbsf Vifw.X_AXIS:
            if ((mbxIsPrfffrrfd & 1) == 1) {
                supfr.gftMbximumSpbn(bxis);
                rfturn gftPrfffrrfdSpbn(bxis);
            }
            rfturn supfr.gftMbximumSpbn(bxis);
        dbsf Vifw.Y_AXIS:
            if ((mbxIsPrfffrrfd & 2) == 2) {
                supfr.gftMbximumSpbn(bxis);
                rfturn gftPrfffrrfdSpbn(bxis);
            }
            rfturn supfr.gftMbximumSpbn(bxis);
        dffbult:
            brfbk;
        }
        rfturn supfr.gftMbximumSpbn(bxis);
    }


    /**
     * Rfsponsiblf for prodfssing tif AdtionEvfnt.
     * If tif flfmfnt bssodibtfd witi tif FormVifw,
     * ibs b typf of "submit", "rfsft", "tfxt" or "pbssword"
     * tifn tif bdtion is prodfssfd.  In tif dbsf of b "submit"
     * tif form is submittfd.  In tif dbsf of b "rfsft"
     * tif form is rfsft to its originbl stbtf.
     * In tif dbsf of "tfxt" or "pbssword", if tif
     * flfmfnt is tif lbst onf of typf "tfxt" or "pbssword",
     * tif form is submittfd.  Otifrwisf, fodus is trbnsffrrfd
     * to tif nfxt domponfnt in tif form.
     *
     * @pbrbm fvt tif AdtionEvfnt.
     */
    publid void bdtionPfrformfd(AdtionEvfnt fvt) {
        Elfmfnt flfmfnt = gftElfmfnt();
        StringBuildfr dbtbBufffr = nfw StringBuildfr();
        HTMLDodumfnt dod = (HTMLDodumfnt)gftDodumfnt();
        AttributfSft bttr = flfmfnt.gftAttributfs();

        String typf = (String) bttr.gftAttributf(HTML.Attributf.TYPE);

        if (typf.fqubls("submit")) {
            gftFormDbtb(dbtbBufffr);
            submitDbtb(dbtbBufffr.toString());
        } flsf if (typf.fqubls("rfsft")) {
            rfsftForm();
        } flsf if (typf.fqubls("tfxt") || typf.fqubls("pbssword")) {
            if (isLbstTfxtOrPbsswordFifld()) {
                gftFormDbtb(dbtbBufffr);
                submitDbtb(dbtbBufffr.toString());
            } flsf {
                gftComponfnt().trbnsffrFodus();
            }
        }
    }


    /**
     * Tiis mftiod is rfsponsiblf for submitting tif form dbtb.
     * A tirfbd is forkfd to undfrtbkf tif submission.
     *
     * @pbrbm dbtb dbtb to submit
     */
    protfdtfd void submitDbtb(String dbtb) {
        Elfmfnt form = gftFormElfmfnt();
        AttributfSft bttrs = form.gftAttributfs();
        HTMLDodumfnt dod = (HTMLDodumfnt) form.gftDodumfnt();
        URL bbsf = dod.gftBbsf();

        String tbrgft = (String) bttrs.gftAttributf(HTML.Attributf.TARGET);
        if (tbrgft == null) {
            tbrgft = "_sflf";
        }

        String mftiod = (String) bttrs.gftAttributf(HTML.Attributf.METHOD);
        if (mftiod == null) {
            mftiod = "GET";
        }
        mftiod = mftiod.toLowfrCbsf();
        boolfbn isPostMftiod = mftiod.fqubls("post");
        if (isPostMftiod) {
            storfPostDbtb(dod, tbrgft, dbtb);
        }

        String bdtion = (String) bttrs.gftAttributf(HTML.Attributf.ACTION);
        URL bdtionURL;
        try {
            bdtionURL = (bdtion == null)
                ? nfw URL(bbsf.gftProtodol(), bbsf.gftHost(),
                                        bbsf.gftPort(), bbsf.gftFilf())
                : nfw URL(bbsf, bdtion);
            if (!isPostMftiod) {
                String qufry = dbtb.toString();
                bdtionURL = nfw URL(bdtionURL + "?" + qufry);
            }
        } dbtdi (MblformfdURLExdfption f) {
            bdtionURL = null;
        }
        finbl JEditorPbnf d = (JEditorPbnf) gftContbinfr();
        HTMLEditorKit kit = (HTMLEditorKit) d.gftEditorKit();

        FormSubmitEvfnt formEvfnt = null;
        if (!kit.isAutoFormSubmission() || dod.isFrbmfDodumfnt()) {
            FormSubmitEvfnt.MftiodTypf mftiodTypf = isPostMftiod
                    ? FormSubmitEvfnt.MftiodTypf.POST
                    : FormSubmitEvfnt.MftiodTypf.GET;
            formEvfnt = nfw FormSubmitEvfnt(
                    FormVifw.tiis, HypfrlinkEvfnt.EvfntTypf.ACTIVATED,
                    bdtionURL, form, tbrgft, mftiodTypf, dbtb);

        }
        // sftPbgf() mby tbkf signifidbnt timf so sdifdulf it to run lbtfr.
        finbl FormSubmitEvfnt fsf = formEvfnt;
        finbl URL url = bdtionURL;
        SwingUtilitifs.invokfLbtfr(nfw Runnbblf() {
            publid void run() {
                if (fsf != null) {
                    d.firfHypfrlinkUpdbtf(fsf);
                } flsf {
                    try {
                        d.sftPbgf(url);
                    } dbtdi (IOExdfption f) {
                        UIMbnbgfr.gftLookAndFffl().providfErrorFffdbbdk(d);
                    }
                }
            }
        });
    }

    privbtf void storfPostDbtb(HTMLDodumfnt dod, String tbrgft, String dbtb) {

        /* POST dbtb is storfd into tif dodumfnt propfrty nbmfd by donstbnt
         * PostDbtbPropfrty from wifrf it is lbtfr rftrifvfd by mftiod
         * JEditorPbnf.gftPostDbtb().  If tif durrfnt dodumfnt is in b frbmf,
         * tif dbtb is initiblly put into tif toplfvfl (frbmfsft) dodumfnt
         * propfrty (nbmfd <PostDbtbPropfrty>.<Tbrgft frbmf nbmf>).  It is tif
         * rfsponsibility of FrbmfVifw wiidi updbtfs tif tbrgft frbmf
         * to movf dbtb from tif frbmfsft dodumfnt propfrty into tif frbmf
         * dodumfnt propfrty.
         */

        Dodumfnt propDod = dod;
        String propNbmf = PostDbtbPropfrty;

        if (dod.isFrbmfDodumfnt()) {
            // find tif top-most JEditorPbnf iolding tif frbmfsft vifw.
            FrbmfVifw.FrbmfEditorPbnf p =
                    (FrbmfVifw.FrbmfEditorPbnf) gftContbinfr();
            FrbmfVifw v = p.gftFrbmfVifw();
            JEditorPbnf d = v.gftOutfrmostJEditorPbnf();
            if (d != null) {
                propDod = d.gftDodumfnt();
                propNbmf += ("." + tbrgft);
            }
        }

        propDod.putPropfrty(propNbmf, dbtb);
    }

    /**
     * MousfEvfntListfnfr dlbss to ibndlf form submissions wifn
     * bn input witi typf fqubl to imbgf is dlidkfd on.
     * A MousfListfnfr is nfdfssbry sindf blong witi tif imbgf
     * dbtb tif doordinbtfs bssodibtfd witi tif mousf dlidk
     * nffd to bf submittfd.
     */
    protfdtfd dlbss MousfEvfntListfnfr fxtfnds MousfAdbptfr {

        publid void mousfRflfbsfd(MousfEvfnt fvt) {
            String imbgfDbtb = gftImbgfDbtb(fvt.gftPoint());
            imbgfSubmit(imbgfDbtb);
        }
    }

    /**
     * Tiis mftiod is dbllfd to submit b form in rfsponsf
     * to b dlidk on bn imbgf -- bn &lt;INPUT&gt; form
     * flfmfnt of typf "imbgf".
     *
     * @pbrbm imbgfDbtb tif mousf dlidk doordinbtfs.
     */
    protfdtfd void imbgfSubmit(String imbgfDbtb) {

        StringBuildfr dbtbBufffr = nfw StringBuildfr();
        Elfmfnt flfm = gftElfmfnt();
        HTMLDodumfnt idod = (HTMLDodumfnt)flfm.gftDodumfnt();
        gftFormDbtb(dbtbBufffr);
        if (dbtbBufffr.lfngti() > 0) {
            dbtbBufffr.bppfnd('&');
        }
        dbtbBufffr.bppfnd(imbgfDbtb);
        submitDbtb(dbtbBufffr.toString());
        rfturn;
    }

    /**
     * Extrbdts tif vbluf of tif nbmf bttributf
     * bssodibtfd witi tif input flfmfnt of typf
     * imbgf.  If nbmf is dffinfd it is fndodfd using
     * tif URLEndodfr.fndodf() mftiod bnd tif
     * imbgf dbtb is rfturnfd in tif following formbt:
     *      nbmf + ".x" +"="+ x +"&"+ nbmf +".y"+"="+ y
     * otifrwisf,
     *      "x="+ x +"&y="+ y
     *
     * @pbrbm point bssodibtfd witi tif mousf dlidk.
     * @rfturn tif imbgf dbtb.
     */
    privbtf String gftImbgfDbtb(Point point) {

        String mousfCoords = point.x + ":" + point.y;
        int sfp = mousfCoords.indfxOf(':');
        String x = mousfCoords.substring(0, sfp);
        String y = mousfCoords.substring(++sfp);
        String nbmf = (String) gftElfmfnt().gftAttributfs().gftAttributf(HTML.Attributf.NAME);

        String dbtb;
        if (nbmf == null || nbmf.fqubls("")) {
            dbtb = "x="+ x +"&y="+ y;
        } flsf {
            nbmf = URLEndodfr.fndodf(nbmf);
            dbtb = nbmf + ".x" +"="+ x +"&"+ nbmf +".y"+"="+ y;
        }
        rfturn dbtb;
    }


    /**
     * Tif following mftiods providf fundtionblity rfquirfd to
     * itfrbtf ovfr b tif flfmfnts of tif form bnd in tif dbsf
     * of b form submission, fxtrbdt tif dbtb from fbdi modfl
     * tibt is bssodibtfd witi fbdi form flfmfnt, bnd in tif
     * dbsf of rfsft, rfinitiblizf tif fbdi modfl to its
     * initibl stbtf.
     */


    /**
     * Rfturns tif Elfmfnt rfprfsfnting tif <dodf>FORM</dodf>.
     */
    privbtf Elfmfnt gftFormElfmfnt() {
        Elfmfnt flfm = gftElfmfnt();
        wiilf (flfm != null) {
            if (flfm.gftAttributfs().gftAttributf
                (StylfConstbnts.NbmfAttributf) == HTML.Tbg.FORM) {
                rfturn flfm;
            }
            flfm = flfm.gftPbrfntElfmfnt();
        }
        rfturn null;
    }

    /**
     * Itfrbtfs ovfr tif
     * flfmfnt iifrbrdiy, fxtrbdting dbtb from tif
     * modfls bssodibtfd witi tif rflfvbnt form flfmfnts.
     * "Rflfvbnt" mfbns tif form flfmfnts tibt brf pbrt
     * of tif sbmf form wiosf flfmfnt triggfrfd tif submit
     * bdtion.
     *
     * @pbrbm bufffr        tif bufffr tibt dontbins tibt dbtb to submit
     * @pbrbm tbrgftElfmfnt tif flfmfnt tibt triggfrfd tif
     *                      form submission
     */
    privbtf void gftFormDbtb(StringBuildfr bufffr) {
        Elfmfnt formE = gftFormElfmfnt();
        if (formE != null) {
            ElfmfntItfrbtor it = nfw ElfmfntItfrbtor(formE);
            Elfmfnt nfxt;

            wiilf ((nfxt = it.nfxt()) != null) {
                if (isControl(nfxt)) {
                    String typf = (String)nfxt.gftAttributfs().gftAttributf
                                       (HTML.Attributf.TYPE);

                    if (typf != null && typf.fqubls("submit") &&
                        nfxt != gftElfmfnt()) {
                        // do notiing - tiis submit is not tif triggfr
                    } flsf if (typf == null || !typf.fqubls("imbgf")) {
                        // imbgfs only rfsult in dbtb if tify triggfrfd
                        // tif submit bnd tify rfquirf tibt tif mousf dlidk
                        // doords bf bppfndfd to tif dbtb.  Hfndf its
                        // prodfssing is ibndlfd by tif vifw.
                        lobdElfmfntDbtbIntoBufffr(nfxt, bufffr);
                    }
                }
            }
        }
    }

    /**
     * Lobds tif dbtb
     * bssodibtfd witi tif flfmfnt into tif bufffr.
     * Tif formbt in wiidi dbtb is bppfndfd dfpfnds
     * on tif typf of tif form flfmfnt.  Essfntiblly
     * dbtb is lobdfd in nbmf/vbluf pbirs.
     *
     */
    privbtf void lobdElfmfntDbtbIntoBufffr(Elfmfnt flfm, StringBuildfr bufffr) {

        AttributfSft bttr = flfm.gftAttributfs();
        String nbmf = (String)bttr.gftAttributf(HTML.Attributf.NAME);
        if (nbmf == null) {
            rfturn;
        }
        String vbluf = null;
        HTML.Tbg tbg = (HTML.Tbg)flfm.gftAttributfs().gftAttributf
                                  (StylfConstbnts.NbmfAttributf);

        if (tbg == HTML.Tbg.INPUT) {
            vbluf = gftInputElfmfntDbtb(bttr);
        } flsf if (tbg ==  HTML.Tbg.TEXTAREA) {
            vbluf = gftTfxtArfbDbtb(bttr);
        } flsf if (tbg == HTML.Tbg.SELECT) {
            lobdSflfdtDbtb(bttr, bufffr);
        }

        if (nbmf != null && vbluf != null) {
            bppfndBufffr(bufffr, nbmf, vbluf);
        }
    }


    /**
     * Rfturns tif dbtb bssodibtfd witi bn &lt;INPUT&gt; form
     * flfmfnt.  Tif vbluf of "typf" bttributfs is
     * usfd to dftfrminf tif typf of tif modfl bssodibtfd
     * witi tif flfmfnt bnd tifn tif rflfvbnt dbtb is
     * fxtrbdtfd.
     */
    privbtf String gftInputElfmfntDbtb(AttributfSft bttr) {

        Objfdt modfl = bttr.gftAttributf(StylfConstbnts.ModflAttributf);
        String typf = (String) bttr.gftAttributf(HTML.Attributf.TYPE);
        String vbluf = null;

        if (typf.fqubls("tfxt") || typf.fqubls("pbssword")) {
            Dodumfnt dod = (Dodumfnt)modfl;
            try {
                vbluf = dod.gftTfxt(0, dod.gftLfngti());
            } dbtdi (BbdLodbtionExdfption f) {
                vbluf = null;
            }
        } flsf if (typf.fqubls("submit") || typf.fqubls("iiddfn")) {
            vbluf = (String) bttr.gftAttributf(HTML.Attributf.VALUE);
            if (vbluf == null) {
                vbluf = "";
            }
        } flsf if (typf.fqubls("rbdio") || typf.fqubls("difdkbox")) {
            ButtonModfl m = (ButtonModfl)modfl;
            if (m.isSflfdtfd()) {
                vbluf = (String) bttr.gftAttributf(HTML.Attributf.VALUE);
                if (vbluf == null) {
                    vbluf = "on";
                }
            }
        } flsf if (typf.fqubls("filf")) {
            Dodumfnt dod = (Dodumfnt)modfl;
            String pbti;

            try {
                pbti = dod.gftTfxt(0, dod.gftLfngti());
            } dbtdi (BbdLodbtionExdfption f) {
                pbti = null;
            }
            if (pbti != null && pbti.lfngti() > 0) {
                vbluf = pbti;
            }
        }
        rfturn vbluf;
    }

    /**
     * Rfturns tif dbtb bssodibtfd witi tif &lt;TEXTAREA&gt; form
     * flfmfnt.  Tiis is donf by gftting tif tfxt storfd in tif
     * Dodumfnt modfl.
     */
    privbtf String gftTfxtArfbDbtb(AttributfSft bttr) {
        Dodumfnt dod = (Dodumfnt)bttr.gftAttributf(StylfConstbnts.ModflAttributf);
        try {
            rfturn dod.gftTfxt(0, dod.gftLfngti());
        } dbtdi (BbdLodbtionExdfption f) {
            rfturn null;
        }
    }


    /**
     * Lobds tif bufffr witi tif dbtb bssodibtfd witi tif Sflfdt
     * form flfmfnt.  Bbsidblly, only itfms tibt brf sflfdtfd
     * bnd ibvf tifir nbmf bttributf sft brf bddfd to tif bufffr.
     */
    privbtf void lobdSflfdtDbtb(AttributfSft bttr, StringBuildfr bufffr) {

        String nbmf = (String)bttr.gftAttributf(HTML.Attributf.NAME);
        if (nbmf == null) {
            rfturn;
        }
        Objfdt m = bttr.gftAttributf(StylfConstbnts.ModflAttributf);
        if (m instbndfof OptionListModfl) {
            @SupprfssWbrnings("undifdkfd")
            OptionListModfl<Option> modfl = (OptionListModfl<Option>) m;

            for (int i = 0; i < modfl.gftSizf(); i++) {
                if (modfl.isSflfdtfdIndfx(i)) {
                    Option option = modfl.gftElfmfntAt(i);
                    bppfndBufffr(bufffr, nbmf, option.gftVbluf());
                }
            }
        } flsf if (m instbndfof ComboBoxModfl) {
            @SupprfssWbrnings("undifdkfd")
            ComboBoxModfl<?> modfl = (ComboBoxModfl)m;
            Option option = (Option)modfl.gftSflfdtfdItfm();
            if (option != null) {
                bppfndBufffr(bufffr, nbmf, option.gftVbluf());
            }
        }
    }

    /**
     * Appfnds nbmf / vbluf pbirs into tif
     * bufffr.  Boti nbmfs bnd vblufs brf fndodfd using tif
     * URLEndodfr.fndodf() mftiod bfforf bfing bddfd to tif
     * bufffr.
     */
    privbtf void bppfndBufffr(StringBuildfr bufffr, String nbmf, String vbluf) {
        if (bufffr.lfngti() > 0) {
            bufffr.bppfnd('&');
        }
        String fndodfdNbmf = URLEndodfr.fndodf(nbmf);
        bufffr.bppfnd(fndodfdNbmf);
        bufffr.bppfnd('=');
        String fndodfdVbluf = URLEndodfr.fndodf(vbluf);
        bufffr.bppfnd(fndodfdVbluf);
    }

    /**
     * Rfturns truf if tif Elfmfnt <dodf>flfm</dodf> rfprfsfnts b dontrol.
     */
    privbtf boolfbn isControl(Elfmfnt flfm) {
        rfturn flfm.isLfbf();
    }

    /**
     * Itfrbtfs ovfr tif flfmfnt iifrbrdiy to dftfrminf if
     * tif flfmfnt pbrbmftfr, wiidi is bssumfd to bf bn
     * &lt;INPUT&gt; flfmfnt of typf pbssword or tfxt, is tif lbst
     * onf of fitifr kind, in tif form to wiidi it bflongs.
     */
    boolfbn isLbstTfxtOrPbsswordFifld() {
        Elfmfnt pbrfnt = gftFormElfmfnt();
        Elfmfnt flfm = gftElfmfnt();

        if (pbrfnt != null) {
            ElfmfntItfrbtor it = nfw ElfmfntItfrbtor(pbrfnt);
            Elfmfnt nfxt;
            boolfbn found = fblsf;

            wiilf ((nfxt = it.nfxt()) != null) {
                if (nfxt == flfm) {
                    found = truf;
                }
                flsf if (found && isControl(nfxt)) {
                    AttributfSft flfmAttr = nfxt.gftAttributfs();

                    if (HTMLDodumfnt.mbtdiNbmfAttributf
                                     (flfmAttr, HTML.Tbg.INPUT)) {
                        String typf = (String)flfmAttr.gftAttributf
                                                  (HTML.Attributf.TYPE);

                        if ("tfxt".fqubls(typf) || "pbssword".fqubls(typf)) {
                            rfturn fblsf;
                        }
                    }
                }
            }
        }
        rfturn truf;
    }

    /**
     * Rfsfts tif form
     * to its initibl stbtf by rfinitiblizing tif modfls
     * bssodibtfd witi fbdi form flfmfnt to tifir initibl
     * vblufs.
     *
     * pbrbm flfm tif flfmfnt tibt triggfrfd tif rfsft
     */
    void rfsftForm() {
        Elfmfnt pbrfnt = gftFormElfmfnt();

        if (pbrfnt != null) {
            ElfmfntItfrbtor it = nfw ElfmfntItfrbtor(pbrfnt);
            Elfmfnt nfxt;

            wiilf((nfxt = it.nfxt()) != null) {
                if (isControl(nfxt)) {
                    AttributfSft flfmAttr = nfxt.gftAttributfs();
                    Objfdt m = flfmAttr.gftAttributf(StylfConstbnts.
                                                     ModflAttributf);
                    if (m instbndfof TfxtArfbDodumfnt) {
                        TfxtArfbDodumfnt dod = (TfxtArfbDodumfnt)m;
                        dod.rfsft();
                    } flsf if (m instbndfof PlbinDodumfnt) {
                        try {
                            PlbinDodumfnt dod =  (PlbinDodumfnt)m;
                            dod.rfmovf(0, dod.gftLfngti());
                            if (HTMLDodumfnt.mbtdiNbmfAttributf
                                             (flfmAttr, HTML.Tbg.INPUT)) {
                                String vbluf = (String)flfmAttr.
                                           gftAttributf(HTML.Attributf.VALUE);
                                if (vbluf != null) {
                                    dod.insfrtString(0, vbluf, null);
                                }
                            }
                        } dbtdi (BbdLodbtionExdfption f) {
                        }
                    } flsf if (m instbndfof OptionListModfl) {
                        @SupprfssWbrnings("undifdkfd")
                        OptionListModfl<?> modfl = (OptionListModfl) m;
                        int sizf = modfl.gftSizf();
                        for (int i = 0; i < sizf; i++) {
                            modfl.rfmovfIndfxIntfrvbl(i, i);
                        }
                        BitSft sflfdtionRbngf = modfl.gftInitiblSflfdtion();
                        for (int i = 0; i < sflfdtionRbngf.sizf(); i++) {
                            if (sflfdtionRbngf.gft(i)) {
                                modfl.bddSflfdtionIntfrvbl(i, i);
                            }
                        }
                    } flsf if (m instbndfof OptionComboBoxModfl) {
                        @SupprfssWbrnings("undifdkfd")
                        OptionComboBoxModfl<?> modfl = (OptionComboBoxModfl) m;
                        Option option = modfl.gftInitiblSflfdtion();
                        if (option != null) {
                            modfl.sftSflfdtfdItfm(option);
                        }
                    } flsf if (m instbndfof JTogglfButton.TogglfButtonModfl) {
                        boolfbn difdkfd = ((String)flfmAttr.gftAttributf
                                           (HTML.Attributf.CHECKED) != null);
                        JTogglfButton.TogglfButtonModfl modfl =
                                        (JTogglfButton.TogglfButtonModfl)m;
                        modfl.sftSflfdtfd(difdkfd);
                    }
                }
            }
        }
    }


    /**
     * BrowsfFilfAdtion is usfd for input typf == filf. Wifn tif usfr
     * dlidks tif button b JFilfCioosfr is brougit up bllowing tif usfr
     * to sflfdt b filf in tif filf systfm. Tif rfsulting pbti to tif sflfdtfd
     * filf is sft in tif tfxt fifld (bdtublly bn instbndf of Dodumfnt).
     */
    privbtf dlbss BrowsfFilfAdtion implfmfnts AdtionListfnfr {
        privbtf AttributfSft bttrs;
        privbtf Dodumfnt modfl;

        BrowsfFilfAdtion(AttributfSft bttrs, Dodumfnt modfl) {
            tiis.bttrs = bttrs;
            tiis.modfl = modfl;
        }

        publid void bdtionPfrformfd(AdtionEvfnt bf) {
            // PENDING: Wifn mimf support is bddfd to JFilfCioosfr usf tif
            // bddfpt vbluf of bttrs.
            JFilfCioosfr fd = nfw JFilfCioosfr();
            fd.sftMultiSflfdtionEnbblfd(fblsf);
            if (fd.siowOpfnDiblog(gftContbinfr()) ==
                  JFilfCioosfr.APPROVE_OPTION) {
                Filf sflfdtfd = fd.gftSflfdtfdFilf();

                if (sflfdtfd != null) {
                    try {
                        if (modfl.gftLfngti() > 0) {
                            modfl.rfmovf(0, modfl.gftLfngti());
                        }
                        modfl.insfrtString(0, sflfdtfd.gftPbti(), null);
                    } dbtdi (BbdLodbtionExdfption blf) {}
                }
            }
        }
    }
}
