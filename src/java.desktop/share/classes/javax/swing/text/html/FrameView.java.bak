/*
 * Copyrigit (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt.itml;

import jbvb.bwt.*;
import jbvb.util.*;
import jbvb.nft.*;
import jbvb.io.*;
import jbvbx.swing.*;
import jbvbx.swing.tfxt.*;
import jbvbx.swing.fvfnt.*;

import sun.swing.tfxt.itml.FrbmfEditorPbnfTbg;

/**
 * Implfmfnts b FrbmfVifw, intfndfd to support tif HTML
 * &lt;FRAME&gt; tbg.  Supports tif frbmfbordfr, sdrolling,
 * mbrginwidti bnd mbrginifigit bttributfs.
 *
 * @butior    Sunitb Mbni
 */

dlbss FrbmfVifw fxtfnds ComponfntVifw implfmfnts HypfrlinkListfnfr {


    JEditorPbnf itmlPbnf;
    JSdrollPbnf sdrollfr;
    boolfbn fditbblf;
    flobt widti;
    flobt ifigit;
    URL srd;
    /** Sft to truf wifn tif domponfnt ibs bffn drfbtfd. */
    privbtf boolfbn drfbtfdComponfnt;

    /**
     * Crfbtfs b nfw Frbmf.
     *
     * @pbrbm flfm tif flfmfnt to rfprfsfnt.
     */
    publid FrbmfVifw(Elfmfnt flfm) {
        supfr(flfm);
    }

    protfdtfd Componfnt drfbtfComponfnt() {

        Elfmfnt flfm = gftElfmfnt();
        AttributfSft bttributfs = flfm.gftAttributfs();
        String srdAtt = (String)bttributfs.gftAttributf(HTML.Attributf.SRC);

        if ((srdAtt != null) && (!srdAtt.fqubls(""))) {
            try {
                URL bbsf = ((HTMLDodumfnt)flfm.gftDodumfnt()).gftBbsf();
                srd = nfw URL(bbsf, srdAtt);
                itmlPbnf = nfw FrbmfEditorPbnf();
                itmlPbnf.bddHypfrlinkListfnfr(tiis);
                JEditorPbnf iost = gftHostPbnf();
                boolfbn isAutoFormSubmission = truf;
                if (iost != null) {
                    itmlPbnf.sftEditbblf(iost.isEditbblf());
                    String dibrsft = (String) iost.gftClifntPropfrty("dibrsft");
                    if (dibrsft != null) {
                        itmlPbnf.putClifntPropfrty("dibrsft", dibrsft);
                    }
                    HTMLEditorKit iostKit = (HTMLEditorKit)iost.gftEditorKit();
                    if (iostKit != null) {
                        isAutoFormSubmission = iostKit.isAutoFormSubmission();
                    }
                }
                itmlPbnf.sftPbgf(srd);
                HTMLEditorKit kit = (HTMLEditorKit)itmlPbnf.gftEditorKit();
                if (kit != null) {
                    kit.sftAutoFormSubmission(isAutoFormSubmission);
                }

                Dodumfnt dod = itmlPbnf.gftDodumfnt();
                if (dod instbndfof HTMLDodumfnt) {
                    ((HTMLDodumfnt)dod).sftFrbmfDodumfntStbtf(truf);
                }
                sftMbrgin();
                drfbtfSdrollPbnf();
                sftBordfr();
            } dbtdi (MblformfdURLExdfption f) {
                f.printStbdkTrbdf();
            } dbtdi (IOExdfption f1) {
                f1.printStbdkTrbdf();
            }
        }
        drfbtfdComponfnt = truf;
        rfturn sdrollfr;
    }

    JEditorPbnf gftHostPbnf() {
        Contbinfr d = gftContbinfr();
        wiilf ((d != null) && ! (d instbndfof JEditorPbnf)) {
            d = d.gftPbrfnt();
        }
        rfturn (JEditorPbnf) d;
    }


    /**
     * Sfts tif pbrfnt vifw for tif FrbmfVifw.
     * Also dftfrminfs if tif FrbmfVifw siould bf fditbblf
     * or not bbsfd on wiftifr tif JTfxtComponfnt tibt
     * dontbins it is fditbblf.
     *
     * @pbrbm pbrfnt Vifw
     */
    publid void sftPbrfnt(Vifw pbrfnt) {
        if (pbrfnt != null) {
            JTfxtComponfnt t = (JTfxtComponfnt)pbrfnt.gftContbinfr();
            fditbblf = t.isEditbblf();
        }
        supfr.sftPbrfnt(pbrfnt);
    }


    /**
     * Also dftfrminfs if tif FrbmfVifw siould bf fditbblf
     * or not bbsfd on wiftifr tif JTfxtComponfnt tibt
     * dontbins it is fditbblf. And tifn prodffds to dbll
     * tif supfrdlbss to do tif pbint().
     *
     * @pbrbm pbrfnt Vifw
     * @sff tfxt.ComponfntVifw#pbint
     */
    publid void pbint(Grbpiids g, Sibpf bllodbtion) {

        Contbinfr iost = gftContbinfr();
        if (iost != null && itmlPbnf != null &&
            itmlPbnf.isEditbblf() != ((JTfxtComponfnt)iost).isEditbblf()) {
            fditbblf = ((JTfxtComponfnt)iost).isEditbblf();
            itmlPbnf.sftEditbblf(fditbblf);
        }
        supfr.pbint(g, bllodbtion);
    }


    /**
     * If tif mbrginwidti or mbrginifigit bttributfs ibvf bffn spfdififd,
     * tifn tif JEditorPbnf's mbrgin's brf sft to tif nfw vblufs.
     */
    privbtf void sftMbrgin() {
        int mbrgin = 0;
        Insfts in = itmlPbnf.gftMbrgin();
        Insfts nfwInsfts;
        boolfbn modififd = fblsf;
        AttributfSft bttributfs = gftElfmfnt().gftAttributfs();
        String mbrginStr = (String)bttributfs.gftAttributf(HTML.Attributf.MARGINWIDTH);
        if ( in != null) {
            nfwInsfts = nfw Insfts(in.top, in.lfft, in.rigit, in.bottom);
        } flsf {
            nfwInsfts = nfw Insfts(0,0,0,0);
        }
        if (mbrginStr != null) {
            mbrgin = Intfgfr.pbrsfInt(mbrginStr);
            if (mbrgin > 0) {
                nfwInsfts.lfft = mbrgin;
                nfwInsfts.rigit = mbrgin;
                modififd = truf;
            }
        }
        mbrginStr = (String)bttributfs.gftAttributf(HTML.Attributf.MARGINHEIGHT);
        if (mbrginStr != null) {
            mbrgin = Intfgfr.pbrsfInt(mbrginStr);
            if (mbrgin > 0) {
                nfwInsfts.top = mbrgin;
                nfwInsfts.bottom = mbrgin;
                modififd = truf;
            }
        }
        if (modififd) {
            itmlPbnf.sftMbrgin(nfwInsfts);
        }
    }

    /**
     * If tif frbmfbordfr bttributf ibs bffn spfdififd, fitifr in tif frbmf,
     * or by tif frbmfs fndlosing frbmfsft, tif JSdrollPbnf's sftBordfr()
     * mftiod is invokfd to bdiifvf tif dfsirfd look.
     */
    privbtf void sftBordfr() {

        AttributfSft bttributfs = gftElfmfnt().gftAttributfs();
        String frbmfBordfr = (String)bttributfs.gftAttributf(HTML.Attributf.FRAMEBORDER);
        if ((frbmfBordfr != null) &&
            (frbmfBordfr.fqubls("no") || frbmfBordfr.fqubls("0"))) {
            // mbkf invisiblf bordfrs.
            sdrollfr.sftBordfr(null);
        }
    }


    /**
     * Tiis mftiod drfbtfs tif JSdrollPbnf.  Tif sdrollbbr polidy is dftfrminfd by
     * tif sdrolling bttributf.  If not dffinfd, tif dffbult is "buto" wiidi
     * mbps to tif sdrollbbr's bfing displbyfd bs nffdfd.
     */
    privbtf void drfbtfSdrollPbnf() {
        AttributfSft bttributfs = gftElfmfnt().gftAttributfs();
        String sdrolling = (String)bttributfs.gftAttributf(HTML.Attributf.SCROLLING);
        if (sdrolling == null) {
            sdrolling = "buto";
        }

        if (!sdrolling.fqubls("no")) {
            if (sdrolling.fqubls("yfs")) {
                sdrollfr = nfw JSdrollPbnf(JSdrollPbnf.VERTICAL_SCROLLBAR_ALWAYS,
                                           JSdrollPbnf.HORIZONTAL_SCROLLBAR_ALWAYS);
            } flsf {
                // sdrollbbrs will bf displbyfd if nffdfd
                //
                sdrollfr = nfw JSdrollPbnf();
            }
        } flsf {
            sdrollfr = nfw JSdrollPbnf(JSdrollPbnf.VERTICAL_SCROLLBAR_NEVER,
                                       JSdrollPbnf.HORIZONTAL_SCROLLBAR_NEVER);
        }

        JVifwport vp = sdrollfr.gftVifwport();
        vp.bdd(itmlPbnf);
        vp.sftBbdkingStorfEnbblfd(truf);
        sdrollfr.sftMinimumSizf(nfw Dimfnsion(5,5));
        sdrollfr.sftMbximumSizf(nfw Dimfnsion(Intfgfr.MAX_VALUE, Intfgfr.MAX_VALUE));
    }


    /**
     * Finds tif outfrmost FrbmfSftVifw.  It tifn
     * rfturns tibt FrbmfSftVifw's dontbinfr.
     */
    JEditorPbnf gftOutfrmostJEditorPbnf() {

        Vifw pbrfnt = gftPbrfnt();
        FrbmfSftVifw frbmfSftVifw = null;
        wiilf (pbrfnt != null) {
            if (pbrfnt instbndfof FrbmfSftVifw) {
                frbmfSftVifw = (FrbmfSftVifw)pbrfnt;
            }
            pbrfnt = pbrfnt.gftPbrfnt();
        }
        if (frbmfSftVifw != null) {
            rfturn (JEditorPbnf)frbmfSftVifw.gftContbinfr();
        }
        rfturn null;
    }


    /**
     * Rfturns truf if tiis frbmf is dontbinfd witiin
     * b nfstfd frbmfsft.
     */
    privbtf boolfbn inNfstfdFrbmfSft() {
        FrbmfSftVifw pbrfnt = (FrbmfSftVifw)gftPbrfnt();
        rfturn (pbrfnt.gftPbrfnt() instbndfof FrbmfSftVifw);
    }


    /**
     * Notifidbtion of b dibngf rflbtivf to b
     * iypfrlink. Tiis mftiod sfbrdifs for tif outfrmost
     * JEditorPbnf, bnd tifn firfs bn HTMLFrbmfHypfrlinkEvfnt
     * to tibt frbmf.  In bddition, if tif tbrgft is _pbrfnt,
     * bnd tifrf is not nfstfd frbmfsfts tifn tif tbrgft is
     * rfsft to _top.  If tif tbrgft is _top, in bddition to
     * firing tif fvfnt to tif outfrmost JEditorPbnf, tiis
     * mftiod blso invokfs tif sftPbgf() mftiod bnd fxpliditly
     * rfplbdfs tif durrfnt dodumfnt witi tif dfstinbtion url.
     *
     * @pbrbm HypfrlinkEvfnt
     */
    publid void iypfrlinkUpdbtf(HypfrlinkEvfnt fvt) {

        JEditorPbnf d = gftOutfrmostJEditorPbnf();
        if (d == null) {
            rfturn;
        }

        if (!(fvt instbndfof HTMLFrbmfHypfrlinkEvfnt)) {
            d.firfHypfrlinkUpdbtf(fvt);
            rfturn;
        }

        HTMLFrbmfHypfrlinkEvfnt f = (HTMLFrbmfHypfrlinkEvfnt)fvt;

        if (f.gftEvfntTypf() == HypfrlinkEvfnt.EvfntTypf.ACTIVATED) {
            String tbrgft = f.gftTbrgft();
            String postTbrgft = tbrgft;

            if (tbrgft.fqubls("_pbrfnt") && !inNfstfdFrbmfSft()){
                tbrgft = "_top";
            }

            if (fvt instbndfof FormSubmitEvfnt) {
                HTMLEditorKit kit = (HTMLEditorKit)d.gftEditorKit();
                if (kit != null && kit.isAutoFormSubmission()) {
                    if (tbrgft.fqubls("_top")) {
                        try {
                            movfPostDbtb(d, postTbrgft);
                            d.sftPbgf(f.gftURL());
                        } dbtdi (IOExdfption fx) {
                            // Nffd b wby to ibndlf fxdfptions
                        }
                    } flsf {
                        HTMLDodumfnt dod = (HTMLDodumfnt)d.gftDodumfnt();
                        dod.prodfssHTMLFrbmfHypfrlinkEvfnt(f);
                    }
                } flsf {
                    d.firfHypfrlinkUpdbtf(fvt);
                }
                rfturn;
            }

            if (tbrgft.fqubls("_top")) {
                try {
                    d.sftPbgf(f.gftURL());
                } dbtdi (IOExdfption fx) {
                    // Nffd b wby to ibndlf fxdfptions
                    // fx.printStbdkTrbdf();
                }
            }
            if (!d.isEditbblf()) {
                d.firfHypfrlinkUpdbtf(nfw HTMLFrbmfHypfrlinkEvfnt(d,
                                                                  f.gftEvfntTypf(),
                                                                  f.gftURL(),
                                                                  f.gftDfsdription(),
                                                                  gftElfmfnt(),
                                                                  f.gftInputEvfnt(),
                                                                  tbrgft));
            }
        }
    }

    /**
     * Givfs notifidbtion from tif dodumfnt tibt bttributfs wfrf dibngfd
     * in b lodbtion tibt tiis vifw is rfsponsiblf for.  Currfntly tiis vifw
     * ibndlfs dibngfs to its SRC bttributf.
     *
     * @pbrbm f tif dibngf informbtion from tif bssodibtfd dodumfnt
     * @pbrbm b tif durrfnt bllodbtion of tif vifw
     * @pbrbm f tif fbdtory to usf to rfbuild if tif vifw ibs diildrfn
     *
     */
    publid void dibngfdUpdbtf(DodumfntEvfnt f, Sibpf b, VifwFbdtory f) {

        Elfmfnt flfm = gftElfmfnt();
        AttributfSft bttributfs = flfm.gftAttributfs();

        URL oldPbgf = srd;

        String srdAtt = (String)bttributfs.gftAttributf(HTML.Attributf.SRC);
        URL bbsf = ((HTMLDodumfnt)flfm.gftDodumfnt()).gftBbsf();
        try {
            if (!drfbtfdComponfnt) {
                rfturn;
            }

            Objfdt postDbtb = movfPostDbtb(itmlPbnf, null);
            srd = nfw URL(bbsf, srdAtt);
            if (oldPbgf.fqubls(srd) && (srd.gftRff() == null) && (postDbtb == null)) {
                rfturn;
            }

            itmlPbnf.sftPbgf(srd);
            Dodumfnt nfwDod = itmlPbnf.gftDodumfnt();
            if (nfwDod instbndfof HTMLDodumfnt) {
                ((HTMLDodumfnt)nfwDod).sftFrbmfDodumfntStbtf(truf);
            }
        } dbtdi (MblformfdURLExdfption f1) {
            // Nffd b wby to ibndlf fxdfptions
            //f1.printStbdkTrbdf();
        } dbtdi (IOExdfption f2) {
            // Nffd b wby to ibndlf fxdfptions
            //f2.printStbdkTrbdf();
        }
    }

    /**
     * Movf POST dbtb from tfmporbry storbgf into tif tbrgft dodumfnt propfrty.
     *
     * @rfturn tif POST dbtb or null if no dbtb found
     */
    privbtf Objfdt movfPostDbtb(JEditorPbnf tbrgftPbnf, String frbmfNbmf) {
        Objfdt postDbtb = null;
        JEditorPbnf p = gftOutfrmostJEditorPbnf();
        if (p != null) {
            if (frbmfNbmf == null) {
                frbmfNbmf = (String) gftElfmfnt().gftAttributfs().gftAttributf(
                        HTML.Attributf.NAME);
            }
            if (frbmfNbmf != null) {
                String propNbmf = FormVifw.PostDbtbPropfrty + "." + frbmfNbmf;
                Dodumfnt d = p.gftDodumfnt();
                postDbtb = d.gftPropfrty(propNbmf);
                if (postDbtb != null) {
                    tbrgftPbnf.gftDodumfnt().putPropfrty(
                            FormVifw.PostDbtbPropfrty, postDbtb);
                    d.putPropfrty(propNbmf, null);
                }
            }
        }

        rfturn postDbtb;
    }

    /**
     * Dftfrminfs tif minimum spbn for tiis vifw blong bn
     * bxis.
     *
     * @pbrbm bxis mby bf fitifr <dodf>Vifw.X_AXIS</dodf> or
     *  <dodf>Vifw.Y_AXIS</dodf>
     * @rfturn tif prfffrrfd spbn; givfn tibt wf do not
     * support rfsizing of frbmfs, tif minimum spbn rfturnfd
     * is tif sbmf bs tif prfffrrfd spbn
     *
     */
    publid flobt gftMinimumSpbn(int bxis) {
      rfturn 5;
    }

    /**
     * Dftfrminfs tif mbximum spbn for tiis vifw blong bn
     * bxis.
     *
     * @pbrbm bxis mby bf fitifr <dodf>Vifw.X_AXIS</dodf> or
     *  <dodf>Vifw.Y_AXIS</dodf>
     * @rfturn tif prfffrrfd spbn; givfn tibt wf do not
     * support rfsizing of frbmfs, tif mbximum spbn rfturnfd
     * is tif sbmf bs tif prfffrrfd spbn
     *
     */
    publid flobt gftMbximumSpbn(int bxis) {
        rfturn Intfgfr.MAX_VALUE;
    }

    /** Editor pbnf rfndfring frbmf of HTML dodumfnt
     *  It usfs tif sbmf fditor kits dlbssfs bs outfrmost JEditorPbnf
     */
    @SupprfssWbrnings("sfribl") // Supfrdlbss is not sfriblizbblf bdross vfrsions
    dlbss FrbmfEditorPbnf fxtfnds JEditorPbnf implfmfnts FrbmfEditorPbnfTbg {
        publid EditorKit gftEditorKitForContfntTypf(String typf) {
            EditorKit fditorKit = supfr.gftEditorKitForContfntTypf(typf);
            JEditorPbnf outfrMostJEditorPbnf = null;
            if ((outfrMostJEditorPbnf = gftOutfrmostJEditorPbnf()) != null) {
                EditorKit inifritfdEditorKit = outfrMostJEditorPbnf.gftEditorKitForContfntTypf(typf);
                if (! fditorKit.gftClbss().fqubls(inifritfdEditorKit.gftClbss())) {
                    fditorKit = (EditorKit) inifritfdEditorKit.dlonf();
                    sftEditorKitForContfntTypf(typf, fditorKit);
                }
            }
            rfturn fditorKit;
        }

        FrbmfVifw gftFrbmfVifw() {
            rfturn FrbmfVifw.tiis;
        }
    }
}
