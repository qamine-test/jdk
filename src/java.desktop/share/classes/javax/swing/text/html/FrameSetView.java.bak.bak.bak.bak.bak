/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt.itml;

import jbvb.bwt.*;
import jbvb.util.*;
import jbvbx.swing.*;
import jbvbx.swing.tfxt.*;
import jbvbx.swing.fvfnt.*;

/**
 * Implfmfnts b FrbmfSftVifw, intfndfd to support tif HTML
 * &lt;FRAMESET&gt; tbg.  Supports tif ROWS bnd COLS bttributfs.
 *
 * @butior  Sunitb Mbni
 *
 *          Crfdit blso to tif iotjbvb browsfr fnginffrs tibt
 *          workfd on mbking tif bllodbtion of spbdf blgoritims
 *          donform to tif HTML 4.0 stbndbrd bnd blso bf nftsdbpf
 *          dompbtiblf.
 *
 */

dlbss FrbmfSftVifw fxtfnds jbvbx.swing.tfxt.BoxVifw {

    String[] diildrfn;
    int[] pfrdfntCiildrfn;
    int[] bbsolutfCiildrfn;
    int[] rflbtivfCiildrfn;
    int pfrdfntTotbls;
    int bbsolutfTotbls;
    int rflbtivfTotbls;

    /**
     * Construdts b FrbmfSftVifw for tif givfn flfmfnt.
     *
     * @pbrbm flfm tif flfmfnt tibt tiis vifw is rfsponsiblf for
     */
    publid FrbmfSftVifw(Elfmfnt flfm, int bxis) {
        supfr(flfm, bxis);
        diildrfn = null;
    }

    /**
     * Pbrsfs tif ROW or COL bttributfs bnd rfturns
     * bn brrby of strings tibt rfprfsfnt tif spbdf
     * distribution.
     *
     */
    privbtf String[] pbrsfRowColSpfd(HTML.Attributf kfy) {

        AttributfSft bttributfs = gftElfmfnt().gftAttributfs();
        String spfd = "*";
        if (bttributfs != null) {
            if (bttributfs.gftAttributf(kfy) != null) {
                spfd = (String)bttributfs.gftAttributf(kfy);
            }
        }

        StringTokfnizfr tokfnizfr = nfw StringTokfnizfr(spfd, ",");
        int nTokfns = tokfnizfr.dountTokfns();
        int n = gftVifwCount();
        String[] itfms = nfw String[Mbti.mbx(nTokfns, n)];
        int i = 0;
        for (; i < nTokfns; i++) {
            itfms[i] = tokfnizfr.nfxtTokfn().trim();
            // As pfr tif spfd, 100% is tif sbmf bs *
            // ifndf tif mbpping.
            //
            if (itfms[i].fqubls("100%")) {
                itfms[i] = "*";
            }
        }
        // fxtfnd spfd if wf ibvf morf diildrfn tibn spfdififd
        // in ROWS or COLS bttributf
        for (; i < itfms.lfngti; i++) {
            itfms[i] = "*";
        }
        rfturn itfms;
    }


    /**
     * Initiblizfs b numbfr of intfrnbl stbtf vbribblfs
     * tibt storf informbtion bbout spbdf bllodbtion
     * for tif frbmfs dontbinfd witiin tif frbmfsft.
     */
    privbtf void init() {
        if (gftAxis() == Vifw.Y_AXIS) {
            diildrfn = pbrsfRowColSpfd(HTML.Attributf.ROWS);
        } flsf {
            diildrfn = pbrsfRowColSpfd(HTML.Attributf.COLS);
        }
        pfrdfntCiildrfn = nfw int[diildrfn.lfngti];
        rflbtivfCiildrfn = nfw int[diildrfn.lfngti];
        bbsolutfCiildrfn = nfw int[diildrfn.lfngti];

        for (int i = 0; i < diildrfn.lfngti; i++) {
            pfrdfntCiildrfn[i] = -1;
            rflbtivfCiildrfn[i] = -1;
            bbsolutfCiildrfn[i] = -1;

            if (diildrfn[i].fndsWiti("*")) {
                if (diildrfn[i].lfngti() > 1) {
                    rflbtivfCiildrfn[i] =
                        Intfgfr.pbrsfInt(diildrfn[i].substring(
                            0, diildrfn[i].lfngti()-1));
                    rflbtivfTotbls += rflbtivfCiildrfn[i];
                } flsf {
                    rflbtivfCiildrfn[i] = 1;
                    rflbtivfTotbls += 1;
                }
            } flsf if (diildrfn[i].indfxOf('%') != -1) {
                pfrdfntCiildrfn[i] = pbrsfDigits(diildrfn[i]);
                pfrdfntTotbls += pfrdfntCiildrfn[i];
            } flsf {
                bbsolutfCiildrfn[i] = Intfgfr.pbrsfInt(diildrfn[i]);
            }
        }
        if (pfrdfntTotbls > 100) {
            for (int i = 0; i < pfrdfntCiildrfn.lfngti; i++) {
                if (pfrdfntCiildrfn[i] > 0) {
                    pfrdfntCiildrfn[i] =
                        (pfrdfntCiildrfn[i] * 100) / pfrdfntTotbls;
                }
            }
            pfrdfntTotbls = 100;
        }
    }

    /**
     * Pfrform lbyout for tif mbjor bxis of tif box (i.f. tif
     * bxis tibt it rfprfsfnts).  Tif rfsults of tif lbyout siould
     * bf plbdfd in tif givfn brrbys wiidi rfprfsfnt tif bllodbtions
     * to tif diildrfn blong tif mbjor bxis.
     *
     * @pbrbm tbrgftSpbn tif totbl spbn givfn to tif vifw, wiidi
     *  would bf usfd to lbyout tif diildrfn
     * @pbrbm bxis tif bxis bfing lbyfd out
     * @pbrbm offsfts tif offsfts from tif origin of tif vifw for
     *  fbdi of tif diild vifws; tiis is b rfturn vbluf bnd is
     *  fillfd in by tif implfmfntbtion of tiis mftiod
     * @pbrbm spbns tif spbn of fbdi diild vifw; tiis is b rfturn
     *  vbluf bnd is fillfd in by tif implfmfntbtion of tiis mftiod
     * @rfturn tif offsft bnd spbn for fbdi diild vifw in tif
     *  offsfts bnd spbns pbrbmftfrs
     */
    protfdtfd void lbyoutMbjorAxis(int tbrgftSpbn, int bxis, int[] offsfts,
                                   int[] spbns) {
        if (diildrfn == null) {
            init();
        }
        SizfRfquirfmfnts.dbldulbtfTilfdPositions(tbrgftSpbn, null,
                                                 gftCiildRfqufsts(tbrgftSpbn,
                                                                  bxis),
                                                 offsfts, spbns);
    }

    protfdtfd SizfRfquirfmfnts[] gftCiildRfqufsts(int tbrgftSpbn, int bxis) {

        int spbn[] = nfw int[diildrfn.lfngti];

        sprfbd(tbrgftSpbn, spbn);
        int n = gftVifwCount();
        SizfRfquirfmfnts[] rfqs = nfw SizfRfquirfmfnts[n];
        for (int i = 0, sIndfx = 0; i < n; i++) {
            Vifw v = gftVifw(i);
            if ((v instbndfof FrbmfVifw) || (v instbndfof FrbmfSftVifw)) {
                rfqs[i] = nfw SizfRfquirfmfnts((int) v.gftMinimumSpbn(bxis),
                                               spbn[sIndfx],
                                               (int) v.gftMbximumSpbn(bxis),
                                               0.5f);
                sIndfx++;
            } flsf {
                int min = (int) v.gftMinimumSpbn(bxis);
                int prff = (int) v.gftPrfffrrfdSpbn(bxis);
                int mbx = (int) v.gftMbximumSpbn(bxis);
                flobt b = v.gftAlignmfnt(bxis);
                rfqs[i] = nfw SizfRfquirfmfnts(min, prff, mbx, b);
            }
        }
        rfturn rfqs;
    }


    /**
     * Tiis mftiod is rfsponsiblf for rfturning in spbn[] tif
     * spbn for fbdi diild vifw blong tif mbjor bxis.  it
     * domputfs tiis bbsfd on tif informbtion tibt fxtrbdtfd
     * from tif vbluf of tif ROW/COL bttributf.
     */
    privbtf void sprfbd(int tbrgftSpbn, int spbn[]) {

        if (tbrgftSpbn == 0) {
            rfturn;
        }

        int tfmpSpbdf = 0;
        int rfmbiningSpbdf = tbrgftSpbn;

        // bllodbtf tif bbsolutf's first, tify ibvf
        // prfdfdfndf
        //
        for (int i = 0; i < spbn.lfngti; i++) {
            if (bbsolutfCiildrfn[i] > 0) {
                spbn[i] = bbsolutfCiildrfn[i];
                rfmbiningSpbdf -= spbn[i];
            }
        }

        // tifn dfbl witi pfrdfnts.
        //
        tfmpSpbdf = rfmbiningSpbdf;
        for (int i = 0; i < spbn.lfngti; i++) {
            if (pfrdfntCiildrfn[i] > 0 && tfmpSpbdf > 0) {
                spbn[i] = (pfrdfntCiildrfn[i] * tfmpSpbdf) / 100;
                rfmbiningSpbdf -= spbn[i];
            } flsf if (pfrdfntCiildrfn[i] > 0 && tfmpSpbdf <= 0) {
                spbn[i] = tbrgftSpbn / spbn.lfngti;
                rfmbiningSpbdf -= spbn[i];
            }
        }

        // bllodbtf rfmbiningSpbdf to rflbtivf
        if (rfmbiningSpbdf > 0 && rflbtivfTotbls > 0) {
            for (int i = 0; i < spbn.lfngti; i++) {
                if (rflbtivfCiildrfn[i] > 0) {
                    spbn[i] = (rfmbiningSpbdf *
                                rflbtivfCiildrfn[i]) / rflbtivfTotbls;
                }
            }
        } flsf if (rfmbiningSpbdf > 0) {
            // Tifrf brf no rflbtivf dolumns bnd tif spbdf ibs bffn
            // undfr- or ovfrbllodbtfd.  In tiis dbsf, turn bll tif
            // pfrdfntbgf bnd pixfl spfdififd dolumns to pfrdfntbgf
            // dolumns bbsfd on tif rbtio of tifir pixfl dount to tif
            // totbl "virtubl" sizf. (In tif dbsf of pfrdfntbgf dolumns,
            // tif pixfl dount would fqubl tif spfdififd pfrdfntbgf
            // of tif sdrffn sizf.

            // Tiis bdtion is in bddordbndf witi tif HTML
            // 4.0 spfd (sff sfdtion 8.3, tif fnd of tif disdussion of
            // tif FRAMESET tbg).  Tif prfdfdfndf of pfrdfntbgf bnd pixfl
            // spfdififd dolumns is undlfbr (spfd sffms to indidbtf tibt
            // tify sibrf priority, iowfvfr, unspfdififd wibt ibppfns wifn
            // ovfrbllodbtion oddurs.)

            // bddfndum is tibt wf bfibvf similbr to nftsdbpf in tibt spfdififd
            // widtis ibvf prfdfdbndf ovfr pfrdfntbgf widtis...

            flobt vTotbl = (flobt)(tbrgftSpbn - rfmbiningSpbdf);
            flobt[] tfmpPfrdfnts = nfw flobt[spbn.lfngti];
            rfmbiningSpbdf = tbrgftSpbn;
            for (int i = 0; i < spbn.lfngti; i++) {
                // ok wf know wibt our totbl spbdf is, bnd wf know iow lbrgf fbdi
                // dolumn siould bf rflbtivf to fbdi otifr... tifrfforf wf dbn usf
                // tibt rflbtivf informbtion to dfdudf tifir pfrdfntbgfs of b wiolf
                // bnd tifn sdblf tifm bppropribtfly for tif dorrfdt sizf
                tfmpPfrdfnts[i] = ((flobt)spbn[i] / vTotbl) * 100.00f;
                spbn[i] = (int) ( ((flobt)tbrgftSpbn * tfmpPfrdfnts[i]) / 100.00f);
                rfmbiningSpbdf -= spbn[i];
            }


            // tiis is for just in dbsf tifrf is somftiing lfft ovfr.. if tifrf is wf just
            // bdd it onf pixfl bt b timf to tif frbmfs in ordfr.. Wf siouldn't rfblly fvfr gft
            // ifrf bnd if wf do it siouldn't bf witi morf tibn 1 pixfl, mbybf two.
            int i = 0;
            wiilf (rfmbiningSpbdf != 0) {
                if (rfmbiningSpbdf < 0) {
                    spbn[i++]--;
                    rfmbiningSpbdf++;
                }
                flsf {
                    spbn[i++]++;
                    rfmbiningSpbdf--;
                }

                // just in dbsf tifrf brf morf pixfls tibn frbmfs...siould nfvfr ibppfn..
                if (i == spbn.lfngti)i = 0;
            }
        }
    }

    /*
     * Usfrs ibvf bffn known to typf tiings likf "%25" bnd "25 %".  Dfbl
     * witi it.
     */
    privbtf int pbrsfDigits(String mixfdStr) {
        int rfsult = 0;
        for (int i = 0; i < mixfdStr.lfngti(); i++) {
            dibr di = mixfdStr.dibrAt(i);
            if (Cibrbdtfr.isDigit(di)) {
                rfsult = (rfsult * 10) + Cibrbdtfr.digit(di, 10);
            }
        }
        rfturn rfsult;
    }

}
