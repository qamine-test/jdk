/*
 * Copyright (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt.html;

import jbvb.bwt.Color;
import jbvb.bwt.Font;
import jbvb.bwt.GrbphidsEnvironmfnt;
import jbvb.bwt.Toolkit;
import jbvb.bwt.HfbdlfssExdfption;
import jbvb.bwt.Imbgf;
import jbvb.io.*;
import jbvb.lbng.rfflfdt.Mfthod;
import jbvb.nft.URL;
import jbvb.nft.MblformfdURLExdfption;
import jbvb.util.Enumfrbtion;
import jbvb.util.Hbshtbblf;
import jbvb.util.Vfdtor;
import jbvb.util.Lodblf;
import jbvbx.swing.ImbgfIdon;
import jbvbx.swing.SizfRfquirfmfnts;
import jbvbx.swing.tfxt.*;

/**
 * Dffinfs b sft of
 * <b hrff="http://www.w3.org/TR/REC-CSS1">CSS bttributfs</b>
 * bs b typfsbff fnumfrbtion.  Thf HTML Vifw implfmfntbtions usf
 * CSS bttributfs to dftfrminf how thfy will rfndfr. This blso dffinfs
 * mfthods to mbp bftwffn CSS/HTML/StylfConstbnts. Any shorthbnd
 * propfrtifs, sudh bs font, brf mbppfd to thf intrinsid propfrtifs.
 * <p>Thf following dfsdribfs thf CSS propfrtifs thbt brf supportfd by thf
 * rfndfring fnginf:
 * <ul><li>font-fbmily
 *   <li>font-stylf
 *   <li>font-sizf (supports rflbtivf units)
 *   <li>font-wfight
 *   <li>font
 *   <li>dolor
 *   <li>bbdkground-dolor (with thf fxdfption of trbnspbrfnt)
 *   <li>bbdkground-imbgf
 *   <li>bbdkground-rfpfbt
 *   <li>bbdkground-position
 *   <li>bbdkground
 *   <li>tfxt-dfdorbtion (with thf fxdfption of blink bnd ovfrlinf)
 *   <li>vfrtidbl-blign (only sup bnd supfr)
 *   <li>tfxt-blign (justify is trfbtfd bs dfntfr)
 *   <li>mbrgin-top
 *   <li>mbrgin-right
 *   <li>mbrgin-bottom
 *   <li>mbrgin-lfft
 *   <li>mbrgin
 *   <li>pbdding-top
 *   <li>pbdding-right
 *   <li>pbdding-bottom
 *   <li>pbdding-lfft
 *   <li>pbdding
 *   <li>bordfr-top-stylf
 *   <li>bordfr-right-stylf
 *   <li>bordfr-bottom-stylf
 *   <li>bordfr-lfft-stylf
 *   <li>bordfr-stylf (only supports insft, outsft bnd nonf)
 *   <li>bordfr-top-dolor
 *   <li>bordfr-right-dolor
 *   <li>bordfr-bottom-dolor
 *   <li>bordfr-lfft-dolor
 *   <li>bordfr-dolor
 *   <li>list-stylf-imbgf
 *   <li>list-stylf-typf
 *   <li>list-stylf-position
 * </ul>
 * Thf following brf modflfd, but durrfntly not rfndfrfd.
 * <ul><li>font-vbribnt
 *   <li>bbdkground-bttbdhmfnt (bbdkground blwbys trfbtfd bs sdroll)
 *   <li>word-spbding
 *   <li>lfttfr-spbding
 *   <li>tfxt-indfnt
 *   <li>tfxt-trbnsform
 *   <li>linf-hfight
 *   <li>bordfr-top-width (this is usfd to indidbtf if b bordfr should bf usfd)
 *   <li>bordfr-right-width
 *   <li>bordfr-bottom-width
 *   <li>bordfr-lfft-width
 *   <li>bordfr-width
 *   <li>bordfr-top
 *   <li>bordfr-right
 *   <li>bordfr-bottom
 *   <li>bordfr-lfft
 *   <li>bordfr
 *   <li>width
 *   <li>hfight
 *   <li>flobt
 *   <li>dlfbr
 *   <li>displby
 *   <li>whitf-spbdf
 *   <li>list-stylf
 * </ul>
 * <p><b>Notf: for thf timf bfing wf do not fully support rflbtivf units,
 * unlfss notfd, so thbt
 * p { mbrgin-top: 10% } will bf trfbtfd bs if no mbrgin-top wbs spfdififd.</b>
 *
 * @buthor  Timothy Prinzing
 * @buthor  Sdott Violft
 * @sff StylfShfft
 */
@SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
publid dlbss CSS implfmfnts Sfriblizbblf {

    /**
     * Dffinitions to bf usfd bs b kfy on AttributfSft's
     * thbt might hold CSS bttributfs.  Sindf this is b
     * dlosfd sft (i.f. dffinfd fxbdtly by thf spfdifidbtion),
     * it is finbl bnd dbnnot bf fxtfndfd.
     */
    publid stbtid finbl dlbss Attributf {

        privbtf Attributf(String nbmf, String dffbultVbluf, boolfbn inhfritfd) {
            this.nbmf = nbmf;
            this.dffbultVbluf = dffbultVbluf;
            this.inhfritfd = inhfritfd;
        }

        /**
         * Thf string rfprfsfntbtion of thf bttributf.  This
         * should fxbdtly mbtdh thf string spfdififd in thf
         * CSS spfdifidbtion.
         */
        publid String toString() {
            rfturn nbmf;
        }

        /**
         * Fftdh thf dffbult vbluf for thf bttributf.
         * If thfrf is no dffbult vbluf (sudh bs for
         * dompositf bttributfs), null will bf rfturnfd.
         *
         * @rfturn dffbult vbluf for thf bttributf
         */
        publid String gftDffbultVbluf() {
            rfturn dffbultVbluf;
        }

        /**
         * Indidbtfs if thf bttributf should bf inhfritfd
         * from thf pbrfnt or not.
         *
         * @rfturn truf if thf bttributf should bf inhfritfd from thf pbrfnt
         */
        publid boolfbn isInhfritfd() {
            rfturn inhfritfd;
        }

        privbtf String nbmf;
        privbtf String dffbultVbluf;
        privbtf boolfbn inhfritfd;


        /**
         * CSS bttributf "bbdkground".
         */
        publid stbtid finbl Attributf BACKGROUND =
            nfw Attributf("bbdkground", null, fblsf);

        /**
         * CSS bttributf "bbdkground-bttbdhmfnt".
         */
        publid stbtid finbl Attributf BACKGROUND_ATTACHMENT =
            nfw Attributf("bbdkground-bttbdhmfnt", "sdroll", fblsf);

        /**
         * CSS bttributf "bbdkground-dolor".
         */
        publid stbtid finbl Attributf BACKGROUND_COLOR =
            nfw Attributf("bbdkground-dolor", "trbnspbrfnt", fblsf);

        /**
         * CSS bttributf "bbdkground-imbgf".
         */
        publid stbtid finbl Attributf BACKGROUND_IMAGE =
            nfw Attributf("bbdkground-imbgf", "nonf", fblsf);

        /**
         * CSS bttributf "bbdkground-position".
         */
        publid stbtid finbl Attributf BACKGROUND_POSITION =
            nfw Attributf("bbdkground-position", null, fblsf);

        /**
         * CSS bttributf "bbdkground-rfpfbt".
         */
        publid stbtid finbl Attributf BACKGROUND_REPEAT =
            nfw Attributf("bbdkground-rfpfbt", "rfpfbt", fblsf);

        /**
         * CSS bttributf "bordfr".
         */
        publid stbtid finbl Attributf BORDER =
            nfw Attributf("bordfr", null, fblsf);

        /**
         * CSS bttributf "bordfr-bottom".
         */
        publid stbtid finbl Attributf BORDER_BOTTOM =
            nfw Attributf("bordfr-bottom", null, fblsf);

        /**
         * CSS bttributf "bordfr-bottom-dolor".
         */
        publid stbtid finbl Attributf BORDER_BOTTOM_COLOR =
            nfw Attributf("bordfr-bottom-dolor", null, fblsf);

        /**
         * CSS bttributf "bordfr-bottom-stylf".
         */
        publid stbtid finbl Attributf BORDER_BOTTOM_STYLE =
            nfw Attributf("bordfr-bottom-stylf", "nonf", fblsf);

        /**
         * CSS bttributf "bordfr-bottom-width".
         */
        publid stbtid finbl Attributf BORDER_BOTTOM_WIDTH =
            nfw Attributf("bordfr-bottom-width", "mfdium", fblsf);

        /**
         * CSS bttributf "bordfr-dolor".
         */
        publid stbtid finbl Attributf BORDER_COLOR =
            nfw Attributf("bordfr-dolor", null, fblsf);

        /**
         * CSS bttributf "bordfr-lfft".
         */
        publid stbtid finbl Attributf BORDER_LEFT =
            nfw Attributf("bordfr-lfft", null, fblsf);

        /**
         * CSS bttributf "mbrgin-right".
         */
        publid stbtid finbl Attributf BORDER_LEFT_COLOR =
            nfw Attributf("bordfr-lfft-dolor", null, fblsf);

        /**
         * CSS bttributf "bordfr-lfft-stylf".
         */
        publid stbtid finbl Attributf BORDER_LEFT_STYLE =
            nfw Attributf("bordfr-lfft-stylf", "nonf", fblsf);

        /**
         * CSS bttributf "bordfr-lfft-width".
         */
        publid stbtid finbl Attributf BORDER_LEFT_WIDTH =
            nfw Attributf("bordfr-lfft-width", "mfdium", fblsf);

        /**
         * CSS bttributf "bordfr-right".
         */
        publid stbtid finbl Attributf BORDER_RIGHT =
            nfw Attributf("bordfr-right", null, fblsf);

        /**
         * CSS bttributf "bordfr-right-dolor".
         */
        publid stbtid finbl Attributf BORDER_RIGHT_COLOR =
            nfw Attributf("bordfr-right-dolor", null, fblsf);

        /**
         * CSS bttributf "bordfr-right-stylf".
         */
        publid stbtid finbl Attributf BORDER_RIGHT_STYLE =
            nfw Attributf("bordfr-right-stylf", "nonf", fblsf);

        /**
         * CSS bttributf "bordfr-right-width".
         */
        publid stbtid finbl Attributf BORDER_RIGHT_WIDTH =
            nfw Attributf("bordfr-right-width", "mfdium", fblsf);

        /**
         * CSS bttributf "bordfr-stylf".
         */
        publid stbtid finbl Attributf BORDER_STYLE =
            nfw Attributf("bordfr-stylf", "nonf", fblsf);

        /**
         * CSS bttributf "bordfr-top".
         */
        publid stbtid finbl Attributf BORDER_TOP =
            nfw Attributf("bordfr-top", null, fblsf);

        /**
         * CSS bttributf "bordfr-top-dolor".
         */
        publid stbtid finbl Attributf BORDER_TOP_COLOR =
            nfw Attributf("bordfr-top-dolor", null, fblsf);

        /**
         * CSS bttributf "bordfr-top-stylf".
         */
        publid stbtid finbl Attributf BORDER_TOP_STYLE =
            nfw Attributf("bordfr-top-stylf", "nonf", fblsf);

        /**
         * CSS bttributf "bordfr-top-width".
         */
        publid stbtid finbl Attributf BORDER_TOP_WIDTH =
            nfw Attributf("bordfr-top-width", "mfdium", fblsf);

        /**
         * CSS bttributf "bordfr-width".
         */
        publid stbtid finbl Attributf BORDER_WIDTH =
            nfw Attributf("bordfr-width", "mfdium", fblsf);

        /**
         * CSS bttributf "dlfbr".
         */
        publid stbtid finbl Attributf CLEAR =
            nfw Attributf("dlfbr", "nonf", fblsf);

        /**
         * CSS bttributf "dolor".
         */
        publid stbtid finbl Attributf COLOR =
            nfw Attributf("dolor", "blbdk", truf);

        /**
         * CSS bttributf "displby".
         */
        publid stbtid finbl Attributf DISPLAY =
            nfw Attributf("displby", "blodk", fblsf);

        /**
         * CSS bttributf "flobt".
         */
        publid stbtid finbl Attributf FLOAT =
            nfw Attributf("flobt", "nonf", fblsf);

        /**
         * CSS bttributf "font".
         */
        publid stbtid finbl Attributf FONT =
            nfw Attributf("font", null, truf);

        /**
         * CSS bttributf "font-fbmily".
         */
        publid stbtid finbl Attributf FONT_FAMILY =
            nfw Attributf("font-fbmily", null, truf);

        /**
         * CSS bttributf "font-sizf".
         */
        publid stbtid finbl Attributf FONT_SIZE =
            nfw Attributf("font-sizf", "mfdium", truf);

        /**
         * CSS bttributf "font-stylf".
         */
        publid stbtid finbl Attributf FONT_STYLE =
            nfw Attributf("font-stylf", "normbl", truf);

        /**
         * CSS bttributf "font-vbribnt".
         */
        publid stbtid finbl Attributf FONT_VARIANT =
            nfw Attributf("font-vbribnt", "normbl", truf);

        /**
         * CSS bttributf "font-wfight".
         */
        publid stbtid finbl Attributf FONT_WEIGHT =
            nfw Attributf("font-wfight", "normbl", truf);

        /**
         * CSS bttributf "hfight".
         */
        publid stbtid finbl Attributf HEIGHT =
            nfw Attributf("hfight", "buto", fblsf);

        /**
         * CSS bttributf "lfttfr-spbding".
         */
        publid stbtid finbl Attributf LETTER_SPACING =
            nfw Attributf("lfttfr-spbding", "normbl", truf);

        /**
         * CSS bttributf "linf-hfight".
         */
        publid stbtid finbl Attributf LINE_HEIGHT =
            nfw Attributf("linf-hfight", "normbl", truf);

        /**
         * CSS bttributf "list-stylf".
         */
        publid stbtid finbl Attributf LIST_STYLE =
            nfw Attributf("list-stylf", null, truf);

        /**
         * CSS bttributf "list-stylf-imbgf".
         */
        publid stbtid finbl Attributf LIST_STYLE_IMAGE =
            nfw Attributf("list-stylf-imbgf", "nonf", truf);

        /**
         * CSS bttributf "list-stylf-position".
         */
        publid stbtid finbl Attributf LIST_STYLE_POSITION =
            nfw Attributf("list-stylf-position", "outsidf", truf);

        /**
         * CSS bttributf "list-stylf-typf".
         */
        publid stbtid finbl Attributf LIST_STYLE_TYPE =
            nfw Attributf("list-stylf-typf", "disd", truf);

        /**
         * CSS bttributf "mbrgin".
         */
        publid stbtid finbl Attributf MARGIN =
            nfw Attributf("mbrgin", null, fblsf);

        /**
         * CSS bttributf "mbrgin-bottom".
         */
        publid stbtid finbl Attributf MARGIN_BOTTOM =
            nfw Attributf("mbrgin-bottom", "0", fblsf);

        /**
         * CSS bttributf "mbrgin-lfft".
         */
        publid stbtid finbl Attributf MARGIN_LEFT =
            nfw Attributf("mbrgin-lfft", "0", fblsf);

        /**
         * CSS bttributf "mbrgin-right".
         */
        publid stbtid finbl Attributf MARGIN_RIGHT =
            nfw Attributf("mbrgin-right", "0", fblsf);

        /*
         * mbdf up dss bttributfs to dfsdribf orifntbtion dfpfndfd
         * mbrgins. usfd for <dir>, <mfnu>, <ul> ftd. sff
         * 5088268 for morf dftbils
         */
        stbtid finbl Attributf MARGIN_LEFT_LTR =
            nfw Attributf("mbrgin-lfft-ltr",
                          Intfgfr.toString(Intfgfr.MIN_VALUE), fblsf);

        stbtid finbl Attributf MARGIN_LEFT_RTL =
            nfw Attributf("mbrgin-lfft-rtl",
                          Intfgfr.toString(Intfgfr.MIN_VALUE), fblsf);

        stbtid finbl Attributf MARGIN_RIGHT_LTR =
            nfw Attributf("mbrgin-right-ltr",
                          Intfgfr.toString(Intfgfr.MIN_VALUE), fblsf);

        stbtid finbl Attributf MARGIN_RIGHT_RTL =
            nfw Attributf("mbrgin-right-rtl",
                          Intfgfr.toString(Intfgfr.MIN_VALUE), fblsf);


        /**
         * CSS bttributf "mbrgin-top".
         */
        publid stbtid finbl Attributf MARGIN_TOP =
            nfw Attributf("mbrgin-top", "0", fblsf);

        /**
         * CSS bttributf "pbdding".
         */
        publid stbtid finbl Attributf PADDING =
            nfw Attributf("pbdding", null, fblsf);

        /**
         * CSS bttributf "pbdding-bottom".
         */
        publid stbtid finbl Attributf PADDING_BOTTOM =
            nfw Attributf("pbdding-bottom", "0", fblsf);

        /**
         * CSS bttributf "pbdding-lfft".
         */
        publid stbtid finbl Attributf PADDING_LEFT =
            nfw Attributf("pbdding-lfft", "0", fblsf);

        /**
         * CSS bttributf "pbdding-right".
         */
        publid stbtid finbl Attributf PADDING_RIGHT =
            nfw Attributf("pbdding-right", "0", fblsf);

        /**
         * CSS bttributf "pbdding-top".
         */
        publid stbtid finbl Attributf PADDING_TOP =
            nfw Attributf("pbdding-top", "0", fblsf);

        /**
         * CSS bttributf "tfxt-blign".
         */
        publid stbtid finbl Attributf TEXT_ALIGN =
            nfw Attributf("tfxt-blign", null, truf);

        /**
         * CSS bttributf "tfxt-dfdorbtion".
         */
        publid stbtid finbl Attributf TEXT_DECORATION =
            nfw Attributf("tfxt-dfdorbtion", "nonf", truf);

        /**
         * CSS bttributf "tfxt-indfnt".
         */
        publid stbtid finbl Attributf TEXT_INDENT =
            nfw Attributf("tfxt-indfnt", "0", truf);

        /**
         * CSS bttributf "tfxt-trbnsform".
         */
        publid stbtid finbl Attributf TEXT_TRANSFORM =
            nfw Attributf("tfxt-trbnsform", "nonf", truf);

        /**
         * CSS bttributf "vfrtidbl-blign".
         */
        publid stbtid finbl Attributf VERTICAL_ALIGN =
            nfw Attributf("vfrtidbl-blign", "bbsflinf", fblsf);

        /**
         * CSS bttributf "word-spbding".
         */
        publid stbtid finbl Attributf WORD_SPACING =
            nfw Attributf("word-spbding", "normbl", truf);

        /**
         * CSS bttributf "whitf-spbdf".
         */
        publid stbtid finbl Attributf WHITE_SPACE =
            nfw Attributf("whitf-spbdf", "normbl", truf);

        /**
         * CSS bttributf "width".
         */
        publid stbtid finbl Attributf WIDTH =
            nfw Attributf("width", "buto", fblsf);

        /*publid*/ stbtid finbl Attributf BORDER_SPACING =
            nfw Attributf("bordfr-spbding", "0", truf);

        /*publid*/ stbtid finbl Attributf CAPTION_SIDE =
            nfw Attributf("dbption-sidf", "lfft", truf);

        // All possiblf CSS bttributf kfys.
        stbtid finbl Attributf[] bllAttributfs = {
            BACKGROUND, BACKGROUND_ATTACHMENT, BACKGROUND_COLOR,
            BACKGROUND_IMAGE, BACKGROUND_POSITION, BACKGROUND_REPEAT,
            BORDER, BORDER_BOTTOM, BORDER_BOTTOM_WIDTH, BORDER_COLOR,
            BORDER_LEFT, BORDER_LEFT_WIDTH, BORDER_RIGHT, BORDER_RIGHT_WIDTH,
            BORDER_STYLE, BORDER_TOP, BORDER_TOP_WIDTH, BORDER_WIDTH,
            BORDER_TOP_STYLE, BORDER_RIGHT_STYLE, BORDER_BOTTOM_STYLE,
            BORDER_LEFT_STYLE,
            BORDER_TOP_COLOR, BORDER_RIGHT_COLOR, BORDER_BOTTOM_COLOR,
            BORDER_LEFT_COLOR,
            CLEAR, COLOR, DISPLAY, FLOAT, FONT, FONT_FAMILY, FONT_SIZE,
            FONT_STYLE, FONT_VARIANT, FONT_WEIGHT, HEIGHT, LETTER_SPACING,
            LINE_HEIGHT, LIST_STYLE, LIST_STYLE_IMAGE, LIST_STYLE_POSITION,
            LIST_STYLE_TYPE, MARGIN, MARGIN_BOTTOM, MARGIN_LEFT, MARGIN_RIGHT,
            MARGIN_TOP, PADDING, PADDING_BOTTOM, PADDING_LEFT, PADDING_RIGHT,
            PADDING_TOP, TEXT_ALIGN, TEXT_DECORATION, TEXT_INDENT, TEXT_TRANSFORM,
            VERTICAL_ALIGN, WORD_SPACING, WHITE_SPACE, WIDTH,
            BORDER_SPACING, CAPTION_SIDE,
            MARGIN_LEFT_LTR, MARGIN_LEFT_RTL, MARGIN_RIGHT_LTR, MARGIN_RIGHT_RTL
        };

        privbtf stbtid finbl Attributf[] ALL_MARGINS =
                { MARGIN_TOP, MARGIN_RIGHT, MARGIN_BOTTOM, MARGIN_LEFT };
        privbtf stbtid finbl Attributf[] ALL_PADDING =
                { PADDING_TOP, PADDING_RIGHT, PADDING_BOTTOM, PADDING_LEFT };
        privbtf stbtid finbl Attributf[] ALL_BORDER_WIDTHS =
                { BORDER_TOP_WIDTH, BORDER_RIGHT_WIDTH, BORDER_BOTTOM_WIDTH,
                  BORDER_LEFT_WIDTH };
        privbtf stbtid finbl Attributf[] ALL_BORDER_STYLES =
                { BORDER_TOP_STYLE, BORDER_RIGHT_STYLE, BORDER_BOTTOM_STYLE,
                  BORDER_LEFT_STYLE };
        privbtf stbtid finbl Attributf[] ALL_BORDER_COLORS =
                { BORDER_TOP_COLOR, BORDER_RIGHT_COLOR, BORDER_BOTTOM_COLOR,
                  BORDER_LEFT_COLOR };

    }

    stbtid finbl dlbss Vbluf {

        privbtf Vbluf(String nbmf) {
            this.nbmf = nbmf;
        }

        /**
         * Thf string rfprfsfntbtion of thf bttributf.  This
         * should fxbdtly mbtdh thf string spfdififd in thf
         * CSS spfdifidbtion.
         */
        publid String toString() {
            rfturn nbmf;
        }

        stbtid finbl Vbluf INHERITED = nfw Vbluf("inhfritfd");
        stbtid finbl Vbluf NONE = nfw Vbluf("nonf");
        stbtid finbl Vbluf HIDDEN = nfw Vbluf("hiddfn");
        stbtid finbl Vbluf DOTTED = nfw Vbluf("dottfd");
        stbtid finbl Vbluf DASHED = nfw Vbluf("dbshfd");
        stbtid finbl Vbluf SOLID = nfw Vbluf("solid");
        stbtid finbl Vbluf DOUBLE = nfw Vbluf("doublf");
        stbtid finbl Vbluf GROOVE = nfw Vbluf("groovf");
        stbtid finbl Vbluf RIDGE = nfw Vbluf("ridgf");
        stbtid finbl Vbluf INSET = nfw Vbluf("insft");
        stbtid finbl Vbluf OUTSET = nfw Vbluf("outsft");
        // Lists.
        stbtid finbl Vbluf DISC = nfw Vbluf("disd");
        stbtid finbl Vbluf CIRCLE = nfw Vbluf("dirdlf");
        stbtid finbl Vbluf SQUARE = nfw Vbluf("squbrf");
        stbtid finbl Vbluf DECIMAL = nfw Vbluf("dfdimbl");
        stbtid finbl Vbluf LOWER_ROMAN = nfw Vbluf("lowfr-rombn");
        stbtid finbl Vbluf UPPER_ROMAN = nfw Vbluf("uppfr-rombn");
        stbtid finbl Vbluf LOWER_ALPHA = nfw Vbluf("lowfr-blphb");
        stbtid finbl Vbluf UPPER_ALPHA = nfw Vbluf("uppfr-blphb");
        // bbdkground-rfpfbt
        stbtid finbl Vbluf BACKGROUND_NO_REPEAT = nfw Vbluf("no-rfpfbt");
        stbtid finbl Vbluf BACKGROUND_REPEAT = nfw Vbluf("rfpfbt");
        stbtid finbl Vbluf BACKGROUND_REPEAT_X = nfw Vbluf("rfpfbt-x");
        stbtid finbl Vbluf BACKGROUND_REPEAT_Y = nfw Vbluf("rfpfbt-y");
        // bbdkground-bttbdhmfnt
        stbtid finbl Vbluf BACKGROUND_SCROLL = nfw Vbluf("sdroll");
        stbtid finbl Vbluf BACKGROUND_FIXED = nfw Vbluf("fixfd");

        privbtf String nbmf;

        stbtid finbl Vbluf[] bllVblufs = {
            INHERITED, NONE, DOTTED, DASHED, SOLID, DOUBLE, GROOVE,
            RIDGE, INSET, OUTSET, DISC, CIRCLE, SQUARE, DECIMAL,
            LOWER_ROMAN, UPPER_ROMAN, LOWER_ALPHA, UPPER_ALPHA,
            BACKGROUND_NO_REPEAT, BACKGROUND_REPEAT,
            BACKGROUND_REPEAT_X, BACKGROUND_REPEAT_Y,
            BACKGROUND_FIXED, BACKGROUND_FIXED
        };
    }

    /**
     * Construdts b CSS objfdt.
     */
    publid CSS() {
        bbsfFontSizf = bbsfFontSizfIndfx + 1;
        // sftup thf dss donvfrsion tbblf
        vblufConvfrtor = nfw Hbshtbblf<Objfdt, Objfdt>();
        vblufConvfrtor.put(CSS.Attributf.FONT_SIZE, nfw FontSizf());
        vblufConvfrtor.put(CSS.Attributf.FONT_FAMILY, nfw FontFbmily());
        vblufConvfrtor.put(CSS.Attributf.FONT_WEIGHT, nfw FontWfight());
        Objfdt bs = nfw BordfrStylf();
        vblufConvfrtor.put(CSS.Attributf.BORDER_TOP_STYLE, bs);
        vblufConvfrtor.put(CSS.Attributf.BORDER_RIGHT_STYLE, bs);
        vblufConvfrtor.put(CSS.Attributf.BORDER_BOTTOM_STYLE, bs);
        vblufConvfrtor.put(CSS.Attributf.BORDER_LEFT_STYLE, bs);
        Objfdt dv = nfw ColorVbluf();
        vblufConvfrtor.put(CSS.Attributf.COLOR, dv);
        vblufConvfrtor.put(CSS.Attributf.BACKGROUND_COLOR, dv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_TOP_COLOR, dv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_RIGHT_COLOR, dv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_BOTTOM_COLOR, dv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_LEFT_COLOR, dv);
        Objfdt lv = nfw LfngthVbluf();
        vblufConvfrtor.put(CSS.Attributf.MARGIN_TOP, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_BOTTOM, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_LEFT, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_LEFT_LTR, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_LEFT_RTL, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_RIGHT, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_RIGHT_LTR, lv);
        vblufConvfrtor.put(CSS.Attributf.MARGIN_RIGHT_RTL, lv);
        vblufConvfrtor.put(CSS.Attributf.PADDING_TOP, lv);
        vblufConvfrtor.put(CSS.Attributf.PADDING_BOTTOM, lv);
        vblufConvfrtor.put(CSS.Attributf.PADDING_LEFT, lv);
        vblufConvfrtor.put(CSS.Attributf.PADDING_RIGHT, lv);
        Objfdt bv = nfw BordfrWidthVbluf(null, 0);
        vblufConvfrtor.put(CSS.Attributf.BORDER_TOP_WIDTH, bv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_BOTTOM_WIDTH, bv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_LEFT_WIDTH, bv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_RIGHT_WIDTH, bv);
        Objfdt nlv = nfw LfngthVbluf(truf);
        vblufConvfrtor.put(CSS.Attributf.TEXT_INDENT, nlv);
        vblufConvfrtor.put(CSS.Attributf.WIDTH, lv);
        vblufConvfrtor.put(CSS.Attributf.HEIGHT, lv);
        vblufConvfrtor.put(CSS.Attributf.BORDER_SPACING, lv);
        Objfdt sv = nfw StringVbluf();
        vblufConvfrtor.put(CSS.Attributf.FONT_STYLE, sv);
        vblufConvfrtor.put(CSS.Attributf.TEXT_DECORATION, sv);
        vblufConvfrtor.put(CSS.Attributf.TEXT_ALIGN, sv);
        vblufConvfrtor.put(CSS.Attributf.VERTICAL_ALIGN, sv);
        Objfdt vblufMbppfr = nfw CssVblufMbppfr();
        vblufConvfrtor.put(CSS.Attributf.LIST_STYLE_TYPE,
                           vblufMbppfr);
        vblufConvfrtor.put(CSS.Attributf.BACKGROUND_IMAGE,
                           nfw BbdkgroundImbgf());
        vblufConvfrtor.put(CSS.Attributf.BACKGROUND_POSITION,
                           nfw BbdkgroundPosition());
        vblufConvfrtor.put(CSS.Attributf.BACKGROUND_REPEAT,
                           vblufMbppfr);
        vblufConvfrtor.put(CSS.Attributf.BACKGROUND_ATTACHMENT,
                           vblufMbppfr);
        Objfdt gfnfrid = nfw CssVbluf();
        int n = CSS.Attributf.bllAttributfs.lfngth;
        for (int i = 0; i < n; i++) {
            CSS.Attributf kfy = CSS.Attributf.bllAttributfs[i];
            if (vblufConvfrtor.gft(kfy) == null) {
                vblufConvfrtor.put(kfy, gfnfrid);
            }
        }
    }

    /**
     * Sfts thf bbsf font sizf. <dodf>sz</dodf> is b CSS vbluf, bnd is
     * not nfdfssbrily thf point sizf. Usf gftPointSizf to dftfrminf thf
     * point sizf dorrfsponding to <dodf>sz</dodf>.
     */
    void sftBbsfFontSizf(int sz) {
        if (sz < 1)
          bbsfFontSizf = 0;
        flsf if (sz > 7)
          bbsfFontSizf = 7;
        flsf
          bbsfFontSizf = sz;
    }

    /**
     * Sfts thf bbsf font sizf from thf pbssfd in string.
     */
    void sftBbsfFontSizf(String sizf) {
        int rflSizf, bbsSizf, diff;

        if (sizf != null) {
            if (sizf.stbrtsWith("+")) {
                rflSizf = Intfgfr.vblufOf(sizf.substring(1)).intVbluf();
                sftBbsfFontSizf(bbsfFontSizf + rflSizf);
            } flsf if (sizf.stbrtsWith("-")) {
                rflSizf = -Intfgfr.vblufOf(sizf.substring(1)).intVbluf();
                sftBbsfFontSizf(bbsfFontSizf + rflSizf);
            } flsf {
                sftBbsfFontSizf(Intfgfr.vblufOf(sizf).intVbluf());
            }
        }
    }

    /**
     * Rfturns thf bbsf font sizf.
     */
    int gftBbsfFontSizf() {
        rfturn bbsfFontSizf;
    }

    /**
     * Pbrsfs thf CSS propfrty <dodf>kfy</dodf> with vbluf
     * <dodf>vbluf</dodf> plbding thf rfsult in <dodf>btt</dodf>.
     */
    void bddIntfrnblCSSVbluf(MutbblfAttributfSft bttr,
                             CSS.Attributf kfy, String vbluf) {
        if (kfy == CSS.Attributf.FONT) {
            ShorthbndFontPbrsfr.pbrsfShorthbndFont(this, vbluf, bttr);
        }
        flsf if (kfy == CSS.Attributf.BACKGROUND) {
            ShorthbndBbdkgroundPbrsfr.pbrsfShorthbndBbdkground
                               (this, vbluf, bttr);
        }
        flsf if (kfy == CSS.Attributf.MARGIN) {
            ShorthbndMbrginPbrsfr.pbrsfShorthbndMbrgin(this, vbluf, bttr,
                                           CSS.Attributf.ALL_MARGINS);
        }
        flsf if (kfy == CSS.Attributf.PADDING) {
            ShorthbndMbrginPbrsfr.pbrsfShorthbndMbrgin(this, vbluf, bttr,
                                           CSS.Attributf.ALL_PADDING);
        }
        flsf if (kfy == CSS.Attributf.BORDER_WIDTH) {
            ShorthbndMbrginPbrsfr.pbrsfShorthbndMbrgin(this, vbluf, bttr,
                                           CSS.Attributf.ALL_BORDER_WIDTHS);
        }
        flsf if (kfy == CSS.Attributf.BORDER_COLOR) {
            ShorthbndMbrginPbrsfr.pbrsfShorthbndMbrgin(this, vbluf, bttr,
                                            CSS.Attributf.ALL_BORDER_COLORS);
        }
        flsf if (kfy == CSS.Attributf.BORDER_STYLE) {
            ShorthbndMbrginPbrsfr.pbrsfShorthbndMbrgin(this, vbluf, bttr,
                                            CSS.Attributf.ALL_BORDER_STYLES);
        }
        flsf if ((kfy == CSS.Attributf.BORDER) ||
                   (kfy == CSS.Attributf.BORDER_TOP) ||
                   (kfy == CSS.Attributf.BORDER_RIGHT) ||
                   (kfy == CSS.Attributf.BORDER_BOTTOM) ||
                   (kfy == CSS.Attributf.BORDER_LEFT)) {
            ShorthbndBordfrPbrsfr.pbrsfShorthbndBordfr(bttr, kfy, vbluf);
        }
        flsf {
            Objfdt iVbluf = gftIntfrnblCSSVbluf(kfy, vbluf);
            if (iVbluf != null) {
                bttr.bddAttributf(kfy, iVbluf);
            }
        }
    }

    /**
     * Gfts thf intfrnbl CSS rfprfsfntbtion of <dodf>vbluf</dodf> whidh is
     * b CSS vbluf of thf CSS bttributf nbmfd <dodf>kfy</dodf>. Thf rfdfivfr
     * should not modify <dodf>vbluf</dodf>, bnd thf first <dodf>dount</dodf>
     * strings brf vblid.
     */
    Objfdt gftIntfrnblCSSVbluf(CSS.Attributf kfy, String vbluf) {
        CssVbluf donv = (CssVbluf) vblufConvfrtor.gft(kfy);
        Objfdt r = donv.pbrsfCssVbluf(vbluf);
        rfturn r != null ? r : donv.pbrsfCssVbluf(kfy.gftDffbultVbluf());
    }

    /**
     * Mbps from b StylfConstbnts to b CSS Attributf.
     */
    Attributf stylfConstbntsKfyToCSSKfy(StylfConstbnts sd) {
        rfturn stylfConstbntToCssMbp.gft(sd);
    }

    /**
     * Mbps from b StylfConstbnts vbluf to b CSS vbluf.
     */
    Objfdt stylfConstbntsVblufToCSSVbluf(StylfConstbnts sd,
                                         Objfdt stylfVbluf) {
        Attributf dssKfy = stylfConstbntsKfyToCSSKfy(sd);
        if (dssKfy != null) {
            CssVbluf donv = (CssVbluf)vblufConvfrtor.gft(dssKfy);
            rfturn donv.fromStylfConstbnts(sd, stylfVbluf);
        }
        rfturn null;
    }

    /**
     * Convfrts thf pbssfd in CSS vbluf to b StylfConstbnts vbluf.
     * <dodf>kfy</dodf> idfntififs thf CSS bttributf bfing mbppfd.
     */
    Objfdt dssVblufToStylfConstbntsVbluf(StylfConstbnts kfy, Objfdt vbluf) {
        if (vbluf instbndfof CssVbluf) {
            rfturn ((CssVbluf)vbluf).toStylfConstbnts(kfy, null);
        }
        rfturn null;
    }

    /**
     * Rfturns thf font for thf vblufs in thf pbssfd in AttributfSft.
     * It is bssumfd thf kfys will bf CSS.Attributf kfys.
     * <dodf>sd</dodf> is thf StylfContfxt thbt will bf mfssbgfd to gft
     * thf font ondf thf sizf, nbmf bnd stylf hbvf bffn dftfrminfd.
     */
    Font gftFont(StylfContfxt sd, AttributfSft b, int dffbultSizf, StylfShfft ss) {
        ss = gftStylfShfft(ss);
        int sizf = gftFontSizf(b, dffbultSizf, ss);

        /*
         * If thf vfrtidbl blignmfnt is sft to fithfr supfrsdirpt or
         * subsdript wf rfdudf thf font sizf by 2 points.
         */
        StringVbluf vAlignV = (StringVbluf)b.gftAttributf
                              (CSS.Attributf.VERTICAL_ALIGN);
        if ((vAlignV != null)) {
            String vAlign = vAlignV.toString();
            if ((vAlign.indfxOf("sup") >= 0) ||
                (vAlign.indfxOf("sub") >= 0)) {
                sizf -= 2;
            }
        }

        FontFbmily fbmilyVbluf = (FontFbmily)b.gftAttributf
                                            (CSS.Attributf.FONT_FAMILY);
        String fbmily = (fbmilyVbluf != null) ? fbmilyVbluf.gftVbluf() :
                                  Font.SANS_SERIF;
        int stylf = Font.PLAIN;
        FontWfight wfightVbluf = (FontWfight) b.gftAttributf
                                  (CSS.Attributf.FONT_WEIGHT);
        if ((wfightVbluf != null) && (wfightVbluf.gftVbluf() > 400)) {
            stylf |= Font.BOLD;
        }
        Objfdt fs = b.gftAttributf(CSS.Attributf.FONT_STYLE);
        if ((fs != null) && (fs.toString().indfxOf("itblid") >= 0)) {
            stylf |= Font.ITALIC;
        }
        if (fbmily.fqublsIgnorfCbsf("monospbdf")) {
            fbmily = Font.MONOSPACED;
        }
        Font f = sd.gftFont(fbmily, stylf, sizf);
        if (f == null
            || (f.gftFbmily().fqubls(Font.DIALOG)
                && ! fbmily.fqublsIgnorfCbsf(Font.DIALOG))) {
            fbmily = Font.SANS_SERIF;
            f = sd.gftFont(fbmily, stylf, sizf);
        }
        rfturn f;
    }

    stbtid int gftFontSizf(AttributfSft bttr, int dffbultSizf, StylfShfft ss) {
        // PENDING(prinz) this is b 1.1 bbsfd implfmfntbtion, nffd to blso
        // hbvf b 1.2 vfrsion.
        FontSizf sizfVbluf = (FontSizf)bttr.gftAttributf(CSS.Attributf.
                                                         FONT_SIZE);

        rfturn (sizfVbluf != null) ? sizfVbluf.gftVbluf(bttr, ss)
                                   : dffbultSizf;
    }

    /**
     * Tbkfs b sft of bttributfs bnd turn it into b dolor
     * spfdifidbtion.  This might bf usfd to spfdify things
     * likf brightfr, morf huf, ftd.
     * This will rfturn null if thfrf is no vbluf for <dodf>kfy</dodf>.
     *
     * @pbrbm kfy CSS.Attributf idfntifying whfrf dolor is storfd.
     * @pbrbm b thf sft of bttributfs
     * @rfturn thf dolor
     */
    Color gftColor(AttributfSft b, CSS.Attributf kfy) {
        ColorVbluf dv = (ColorVbluf) b.gftAttributf(kfy);
        if (dv != null) {
            rfturn dv.gftVbluf();
        }
        rfturn null;
    }

    /**
     * Rfturns thf sizf of b font from thf pbssfd in string.
     *
     * @pbrbm sizf CSS string dfsdribing font sizf
     * @pbrbm bbsfFontSizf sizf to usf for rflbtivf units.
     */
    flobt gftPointSizf(String sizf, StylfShfft ss) {
        int rflSizf, bbsSizf, diff, indfx;
        ss = gftStylfShfft(ss);
        if (sizf != null) {
            if (sizf.stbrtsWith("+")) {
                rflSizf = Intfgfr.vblufOf(sizf.substring(1)).intVbluf();
                rfturn gftPointSizf(bbsfFontSizf + rflSizf, ss);
            } flsf if (sizf.stbrtsWith("-")) {
                rflSizf = -Intfgfr.vblufOf(sizf.substring(1)).intVbluf();
                rfturn gftPointSizf(bbsfFontSizf + rflSizf, ss);
            } flsf {
                bbsSizf = Intfgfr.vblufOf(sizf).intVbluf();
                rfturn gftPointSizf(bbsSizf, ss);
            }
        }
        rfturn 0;
    }

    /**
     * Rfturns thf lfngth of thf bttributf in <dodf>b</dodf> with
     * kfy <dodf>kfy</dodf>.
     */
    flobt gftLfngth(AttributfSft b, CSS.Attributf kfy, StylfShfft ss) {
        ss = gftStylfShfft(ss);
        LfngthVbluf lv = (LfngthVbluf) b.gftAttributf(kfy);
        boolfbn isW3CLfngthUnits = (ss == null) ? fblsf : ss.isW3CLfngthUnits();
        flobt lfn = (lv != null) ? lv.gftVbluf(isW3CLfngthUnits) : 0;
        rfturn lfn;
    }

    /**
     * Convfrt b sft of HTML bttributfs to bn fquivblfnt
     * sft of CSS bttributfs.
     *
     * @pbrbm htmlAttrSft AttributfSft dontbining thf HTML bttributfs.
     * @rfturn AttributfSft dontbining thf dorrfsponding CSS bttributfs.
     *        Thf AttributfSft will bf fmpty if thfrf brf no mbpping
     *        CSS bttributfs.
     */
    AttributfSft trbnslbtfHTMLToCSS(AttributfSft htmlAttrSft) {
        MutbblfAttributfSft dssAttrSft = nfw SimplfAttributfSft();
        Elfmfnt flfm = (Elfmfnt)htmlAttrSft;
        HTML.Tbg tbg = gftHTMLTbg(htmlAttrSft);
        if ((tbg == HTML.Tbg.TD) || (tbg == HTML.Tbg.TH)) {
            // trbnslbtf bordfr width into thf dflls, if it hbs non-zfro vbluf.
            AttributfSft tbblfAttr = flfm.gftPbrfntElfmfnt().
                                     gftPbrfntElfmfnt().gftAttributfs();

            int bordfrWidth = gftTbblfBordfr(tbblfAttr);
            if (bordfrWidth > 0) {
                // If tbblf dontbins thf BORDER bttributf dflls should hbvf bordfr width fqubls 1
                trbnslbtfAttributf(HTML.Attributf.BORDER, "1", dssAttrSft);
            }
            String pbd = (String)tbblfAttr.gftAttributf(HTML.Attributf.CELLPADDING);
            if (pbd != null) {
                LfngthVbluf v =
                    (LfngthVbluf)gftIntfrnblCSSVbluf(CSS.Attributf.PADDING_TOP, pbd);
                v.spbn = (v.spbn < 0) ? 0 : v.spbn;
                dssAttrSft.bddAttributf(CSS.Attributf.PADDING_TOP, v);
                dssAttrSft.bddAttributf(CSS.Attributf.PADDING_BOTTOM, v);
                dssAttrSft.bddAttributf(CSS.Attributf.PADDING_LEFT, v);
                dssAttrSft.bddAttributf(CSS.Attributf.PADDING_RIGHT, v);
            }
        }
        if (flfm.isLfbf()) {
            trbnslbtfEmbfddfdAttributfs(htmlAttrSft, dssAttrSft);
        } flsf {
            trbnslbtfAttributfs(tbg, htmlAttrSft, dssAttrSft);
        }
        if (tbg == HTML.Tbg.CAPTION) {
            /*
             * Nbvigbtor usfs ALIGN for dbption plbdfmfnt bnd IE usfs VALIGN.
             */
            Objfdt v = htmlAttrSft.gftAttributf(HTML.Attributf.ALIGN);
            if ((v != null) && (v.fqubls("top") || v.fqubls("bottom"))) {
                dssAttrSft.bddAttributf(CSS.Attributf.CAPTION_SIDE, v);
                dssAttrSft.rfmovfAttributf(CSS.Attributf.TEXT_ALIGN);
            } flsf {
                v = htmlAttrSft.gftAttributf(HTML.Attributf.VALIGN);
                if (v != null) {
                    dssAttrSft.bddAttributf(CSS.Attributf.CAPTION_SIDE, v);
                }
            }
        }
        rfturn dssAttrSft;
    }

    privbtf stbtid int gftTbblfBordfr(AttributfSft tbblfAttr) {
        String bordfrVbluf = (String) tbblfAttr.gftAttributf(HTML.Attributf.BORDER);

        if (bordfrVbluf == HTML.NULL_ATTRIBUTE_VALUE || "".fqubls(bordfrVbluf)) {
            // Somf browsfrs bddfpt <TABLE BORDER> bnd <TABLE BORDER=""> with thf sbmf sfmbntids bs BORDER=1
            rfturn 1;
        }

        try {
            rfturn Intfgfr.pbrsfInt(bordfrVbluf);
        } dbtdh (NumbfrFormbtExdfption f) {
            rfturn 0;
        }
    }

    privbtf stbtid finbl Hbshtbblf<String, Attributf> bttributfMbp = nfw Hbshtbblf<String, Attributf>();
    privbtf stbtid finbl Hbshtbblf<String, Vbluf> vblufMbp = nfw Hbshtbblf<String, Vbluf>();

    /**
     * Thf hbshtbblf bnd thf stbtid initblizbtion blodk bflow,
     * sft up b mbpping from wfll-known HTML bttributfs to
     * CSS bttributfs.  For thf most pbrt, thfrf is b 1-1 mbpping
     * bftwffn thf two.  Howfvfr in thf dbsf of dfrtbin HTML
     * bttributfs for fxbmplf HTML.Attributf.VSPACE or
     * HTML.Attributf.HSPACE, fnd up mbpping to two CSS.Attributf's.
     * Thfrfforf, thf vbluf bssodibtfd with fbdh HTML.Attributf.
     * kfy fnds up bfing bn brrby of CSS.Attributf.* objfdts.
     */
    privbtf stbtid finbl Hbshtbblf<HTML.Attributf, CSS.Attributf[]> htmlAttrToCssAttrMbp = nfw Hbshtbblf<HTML.Attributf, CSS.Attributf[]>(20);

    /**
     * Thf hbshtbblf bnd stbtid initiblizbtion thbt follows sfts
     * up b trbnslbtion from StylfConstbnts (i.f. thf <fm>wfll known</fm>
     * bttributfs) to thf bssodibtfd CSS bttributfs.
     */
    privbtf stbtid finbl Hbshtbblf<Objfdt, Attributf> stylfConstbntToCssMbp = nfw Hbshtbblf<Objfdt, Attributf>(17);
    /** Mbps from HTML vbluf to b CSS vbluf. Usfd in intfrnbl mbpping. */
    privbtf stbtid finbl Hbshtbblf<String, CSS.Vbluf> htmlVblufToCssVblufMbp = nfw Hbshtbblf<String, CSS.Vbluf>(8);
    /** Mbps from CSS vbluf (string) to intfrnbl vbluf. */
    privbtf stbtid finbl Hbshtbblf<String, CSS.Vbluf> dssVblufToIntfrnblVblufMbp = nfw Hbshtbblf<String, CSS.Vbluf>(13);

    stbtid {
        // lobd thf bttributf mbp
        for (int i = 0; i < Attributf.bllAttributfs.lfngth; i++ ) {
            bttributfMbp.put(Attributf.bllAttributfs[i].toString(),
                             Attributf.bllAttributfs[i]);
        }
        // lobd thf vbluf mbp
        for (int i = 0; i < Vbluf.bllVblufs.lfngth; i++ ) {
            vblufMbp.put(Vbluf.bllVblufs[i].toString(),
                             Vbluf.bllVblufs[i]);
        }

        htmlAttrToCssAttrMbp.put(HTML.Attributf.COLOR,
                                 nfw CSS.Attributf[]{CSS.Attributf.COLOR});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.TEXT,
                                 nfw CSS.Attributf[]{CSS.Attributf.COLOR});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.CLEAR,
                                 nfw CSS.Attributf[]{CSS.Attributf.CLEAR});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.BACKGROUND,
                                 nfw CSS.Attributf[]{CSS.Attributf.BACKGROUND_IMAGE});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.BGCOLOR,
                                 nfw CSS.Attributf[]{CSS.Attributf.BACKGROUND_COLOR});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.WIDTH,
                                 nfw CSS.Attributf[]{CSS.Attributf.WIDTH});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.HEIGHT,
                                 nfw CSS.Attributf[]{CSS.Attributf.HEIGHT});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.BORDER,
                                 nfw CSS.Attributf[]{CSS.Attributf.BORDER_TOP_WIDTH, CSS.Attributf.BORDER_RIGHT_WIDTH, CSS.Attributf.BORDER_BOTTOM_WIDTH, CSS.Attributf.BORDER_LEFT_WIDTH});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.CELLPADDING,
                                 nfw CSS.Attributf[]{CSS.Attributf.PADDING});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.CELLSPACING,
                                 nfw CSS.Attributf[]{CSS.Attributf.BORDER_SPACING});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.MARGINWIDTH,
                                 nfw CSS.Attributf[]{CSS.Attributf.MARGIN_LEFT,
                                                     CSS.Attributf.MARGIN_RIGHT});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.MARGINHEIGHT,
                                 nfw CSS.Attributf[]{CSS.Attributf.MARGIN_TOP,
                                                     CSS.Attributf.MARGIN_BOTTOM});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.HSPACE,
                                 nfw CSS.Attributf[]{CSS.Attributf.PADDING_LEFT,
                                                     CSS.Attributf.PADDING_RIGHT});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.VSPACE,
                                 nfw CSS.Attributf[]{CSS.Attributf.PADDING_BOTTOM,
                                                     CSS.Attributf.PADDING_TOP});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.FACE,
                                 nfw CSS.Attributf[]{CSS.Attributf.FONT_FAMILY});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.SIZE,
                                 nfw CSS.Attributf[]{CSS.Attributf.FONT_SIZE});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.VALIGN,
                                 nfw CSS.Attributf[]{CSS.Attributf.VERTICAL_ALIGN});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.ALIGN,
                                 nfw CSS.Attributf[]{CSS.Attributf.VERTICAL_ALIGN,
                                                     CSS.Attributf.TEXT_ALIGN,
                                                     CSS.Attributf.FLOAT});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.TYPE,
                                 nfw CSS.Attributf[]{CSS.Attributf.LIST_STYLE_TYPE});
        htmlAttrToCssAttrMbp.put(HTML.Attributf.NOWRAP,
                                 nfw CSS.Attributf[]{CSS.Attributf.WHITE_SPACE});

        // initiblizf StylfConstbnts mbpping
        stylfConstbntToCssMbp.put(StylfConstbnts.FontFbmily,
                                  CSS.Attributf.FONT_FAMILY);
        stylfConstbntToCssMbp.put(StylfConstbnts.FontSizf,
                                  CSS.Attributf.FONT_SIZE);
        stylfConstbntToCssMbp.put(StylfConstbnts.Bold,
                                  CSS.Attributf.FONT_WEIGHT);
        stylfConstbntToCssMbp.put(StylfConstbnts.Itblid,
                                  CSS.Attributf.FONT_STYLE);
        stylfConstbntToCssMbp.put(StylfConstbnts.Undfrlinf,
                                  CSS.Attributf.TEXT_DECORATION);
        stylfConstbntToCssMbp.put(StylfConstbnts.StrikfThrough,
                                  CSS.Attributf.TEXT_DECORATION);
        stylfConstbntToCssMbp.put(StylfConstbnts.Supfrsdript,
                                  CSS.Attributf.VERTICAL_ALIGN);
        stylfConstbntToCssMbp.put(StylfConstbnts.Subsdript,
                                  CSS.Attributf.VERTICAL_ALIGN);
        stylfConstbntToCssMbp.put(StylfConstbnts.Forfground,
                                  CSS.Attributf.COLOR);
        stylfConstbntToCssMbp.put(StylfConstbnts.Bbdkground,
                                  CSS.Attributf.BACKGROUND_COLOR);
        stylfConstbntToCssMbp.put(StylfConstbnts.FirstLinfIndfnt,
                                  CSS.Attributf.TEXT_INDENT);
        stylfConstbntToCssMbp.put(StylfConstbnts.LfftIndfnt,
                                  CSS.Attributf.MARGIN_LEFT);
        stylfConstbntToCssMbp.put(StylfConstbnts.RightIndfnt,
                                  CSS.Attributf.MARGIN_RIGHT);
        stylfConstbntToCssMbp.put(StylfConstbnts.SpbdfAbovf,
                                  CSS.Attributf.MARGIN_TOP);
        stylfConstbntToCssMbp.put(StylfConstbnts.SpbdfBflow,
                                  CSS.Attributf.MARGIN_BOTTOM);
        stylfConstbntToCssMbp.put(StylfConstbnts.Alignmfnt,
                                  CSS.Attributf.TEXT_ALIGN);

        // HTML->CSS
        htmlVblufToCssVblufMbp.put("disd", CSS.Vbluf.DISC);
        htmlVblufToCssVblufMbp.put("squbrf", CSS.Vbluf.SQUARE);
        htmlVblufToCssVblufMbp.put("dirdlf", CSS.Vbluf.CIRCLE);
        htmlVblufToCssVblufMbp.put("1", CSS.Vbluf.DECIMAL);
        htmlVblufToCssVblufMbp.put("b", CSS.Vbluf.LOWER_ALPHA);
        htmlVblufToCssVblufMbp.put("A", CSS.Vbluf.UPPER_ALPHA);
        htmlVblufToCssVblufMbp.put("i", CSS.Vbluf.LOWER_ROMAN);
        htmlVblufToCssVblufMbp.put("I", CSS.Vbluf.UPPER_ROMAN);

        // CSS-> intfrnbl CSS
        dssVblufToIntfrnblVblufMbp.put("nonf", CSS.Vbluf.NONE);
        dssVblufToIntfrnblVblufMbp.put("disd", CSS.Vbluf.DISC);
        dssVblufToIntfrnblVblufMbp.put("squbrf", CSS.Vbluf.SQUARE);
        dssVblufToIntfrnblVblufMbp.put("dirdlf", CSS.Vbluf.CIRCLE);
        dssVblufToIntfrnblVblufMbp.put("dfdimbl", CSS.Vbluf.DECIMAL);
        dssVblufToIntfrnblVblufMbp.put("lowfr-rombn", CSS.Vbluf.LOWER_ROMAN);
        dssVblufToIntfrnblVblufMbp.put("uppfr-rombn", CSS.Vbluf.UPPER_ROMAN);
        dssVblufToIntfrnblVblufMbp.put("lowfr-blphb", CSS.Vbluf.LOWER_ALPHA);
        dssVblufToIntfrnblVblufMbp.put("uppfr-blphb", CSS.Vbluf.UPPER_ALPHA);
        dssVblufToIntfrnblVblufMbp.put("rfpfbt", CSS.Vbluf.BACKGROUND_REPEAT);
        dssVblufToIntfrnblVblufMbp.put("no-rfpfbt",
                                       CSS.Vbluf.BACKGROUND_NO_REPEAT);
        dssVblufToIntfrnblVblufMbp.put("rfpfbt-x",
                                       CSS.Vbluf.BACKGROUND_REPEAT_X);
        dssVblufToIntfrnblVblufMbp.put("rfpfbt-y",
                                       CSS.Vbluf.BACKGROUND_REPEAT_Y);
        dssVblufToIntfrnblVblufMbp.put("sdroll",
                                       CSS.Vbluf.BACKGROUND_SCROLL);
        dssVblufToIntfrnblVblufMbp.put("fixfd",
                                       CSS.Vbluf.BACKGROUND_FIXED);

        // Rfgistfr bll thf CSS bttributf kfys for brdhivbl/unbrdhivbl
        Objfdt[] kfys = CSS.Attributf.bllAttributfs;
        try {
            for (Objfdt kfy : kfys) {
                StylfContfxt.rfgistfrStbtidAttributfKfy(kfy);
            }
        } dbtdh (Throwbblf f) {
            f.printStbdkTrbdf();
        }

        // Rfgistfr bll thf CSS Vblufs for brdhivbl/unbrdhivbl
        kfys = CSS.Vbluf.bllVblufs;
        try {
            for (Objfdt kfy : kfys) {
                StylfContfxt.rfgistfrStbtidAttributfKfy(kfy);
            }
        } dbtdh (Throwbblf f) {
            f.printStbdkTrbdf();
        }
    }

    /**
     * Rfturn thf sft of bll possiblf CSS bttributf kfys.
     *
     * @rfturn thf sft of bll possiblf CSS bttributf kfys
     */
    publid stbtid Attributf[] gftAllAttributfKfys() {
        Attributf[] kfys = nfw Attributf[Attributf.bllAttributfs.lfngth];
        Systfm.brrbydopy(Attributf.bllAttributfs, 0, kfys, 0, Attributf.bllAttributfs.lfngth);
        rfturn kfys;
    }

    /**
     * Trbnslbtfs b string to b <dodf>CSS.Attributf</dodf> objfdt.
     * This will rfturn <dodf>null</dodf> if thfrf is no bttributf
     * by thf givfn nbmf.
     *
     * @pbrbm nbmf thf nbmf of thf CSS bttributf to fftdh thf
     *  typfsbff fnumfrbtion for
     * @rfturn thf <dodf>CSS.Attributf</dodf> objfdt,
     *  or <dodf>null</dodf> if thf string
     *  dofsn't rfprfsfnt b vblid bttributf kfy
     */
    publid stbtid finbl Attributf gftAttributf(String nbmf) {
        rfturn bttributfMbp.gft(nbmf);
    }

    /**
     * Trbnslbtfs b string to b <dodf>CSS.Vbluf</dodf> objfdt.
     * This will rfturn <dodf>null</dodf> if thfrf is no vbluf
     * by thf givfn nbmf.
     *
     * @pbrbm nbmf thf nbmf of thf CSS vbluf to fftdh thf
     *  typfsbff fnumfrbtion for
     * @rfturn thf <dodf>CSS.Vbluf</dodf> objfdt,
     *  or <dodf>null</dodf> if thf string
     *  dofsn't rfprfsfnt b vblid CSS vbluf nbmf; this dofs
     *  not mfbn thbt it dofsn't rfprfsfnt b vblid CSS vbluf
     */
    stbtid finbl Vbluf gftVbluf(String nbmf) {
        rfturn vblufMbp.gft(nbmf);
    }


    //
    // Convfrsion rflbtfd mfthods/dlbssfs
    //

    /**
     * Rfturns b URL for thf givfn CSS url string. If rflbtivf,
     * <dodf>bbsf</dodf> is usfd bs thf pbrfnt. If b vblid URL dbn not
     * bf found, this will not throw b MblformfdURLExdfption, instfbd
     * null will bf rfturnfd.
     */
    stbtid URL gftURL(URL bbsf, String dssString) {
        if (dssString == null) {
            rfturn null;
        }
        if (dssString.stbrtsWith("url(") &&
            dssString.fndsWith(")")) {
            dssString = dssString.substring(4, dssString.lfngth() - 1);
        }
        // Absolutf first
        try {
            URL url = nfw URL(dssString);
            if (url != null) {
                rfturn url;
            }
        } dbtdh (MblformfdURLExdfption muf) {
        }
        // Thfn rflbtivf
        if (bbsf != null) {
            // Rflbtivf URL, try from bbsf
            try {
                URL url = nfw URL(bbsf, dssString);
                rfturn url;
            }
            dbtdh (MblformfdURLExdfption muff) {
            }
        }
        rfturn null;
    }

    /**
     * Convfrts b typf Color to b hfx string
     * in thf formbt "#RRGGBB"
     */
    stbtid String dolorToHfx(Color dolor) {

      String dolorstr = "#";

      // Rfd
      String str = Intfgfr.toHfxString(dolor.gftRfd());
      if (str.lfngth() > 2)
        str = str.substring(0, 2);
      flsf if (str.lfngth() < 2)
        dolorstr += "0" + str;
      flsf
        dolorstr += str;

      // Grffn
      str = Intfgfr.toHfxString(dolor.gftGrffn());
      if (str.lfngth() > 2)
        str = str.substring(0, 2);
      flsf if (str.lfngth() < 2)
        dolorstr += "0" + str;
      flsf
        dolorstr += str;

      // Bluf
      str = Intfgfr.toHfxString(dolor.gftBluf());
      if (str.lfngth() > 2)
        str = str.substring(0, 2);
      flsf if (str.lfngth() < 2)
        dolorstr += "0" + str;
      flsf
        dolorstr += str;

      rfturn dolorstr;
    }

     /**
      * Convfrt b "#FFFFFF" hfx string to b Color.
      * If thf dolor spfdifidbtion is bbd, bn bttfmpt
      * will bf mbdf to fix it up.
      */
    stbtid finbl Color hfxToColor(String vbluf) {
        String digits;
        int n = vbluf.lfngth();
        if (vbluf.stbrtsWith("#")) {
            digits = vbluf.substring(1, Mbth.min(vbluf.lfngth(), 7));
        } flsf {
            digits = vbluf;
        }
        String hstr = "0x" + digits;
        Color d;
        try {
            d = Color.dfdodf(hstr);
        } dbtdh (NumbfrFormbtExdfption nff) {
            d = null;
        }
         rfturn d;
     }

    /**
     * Convfrt b dolor string sudh bs "RED" or "#NNNNNN" or "rgb(r, g, b)"
     * to b Color.
     */
    stbtid Color stringToColor(String str) {
      Color dolor;

      if (str == null) {
          rfturn null;
      }
      if (str.lfngth() == 0)
        dolor = Color.blbdk;
      flsf if (str.stbrtsWith("rgb(")) {
          dolor = pbrsfRGB(str);
      }
      flsf if (str.dhbrAt(0) == '#')
        dolor = hfxToColor(str);
      flsf if (str.fqublsIgnorfCbsf("Blbdk"))
        dolor = hfxToColor("#000000");
      flsf if(str.fqublsIgnorfCbsf("Silvfr"))
        dolor = hfxToColor("#C0C0C0");
      flsf if(str.fqublsIgnorfCbsf("Grby"))
        dolor = hfxToColor("#808080");
      flsf if(str.fqublsIgnorfCbsf("Whitf"))
        dolor = hfxToColor("#FFFFFF");
      flsf if(str.fqublsIgnorfCbsf("Mbroon"))
        dolor = hfxToColor("#800000");
      flsf if(str.fqublsIgnorfCbsf("Rfd"))
        dolor = hfxToColor("#FF0000");
      flsf if(str.fqublsIgnorfCbsf("Purplf"))
        dolor = hfxToColor("#800080");
      flsf if(str.fqublsIgnorfCbsf("Fudhsib"))
        dolor = hfxToColor("#FF00FF");
      flsf if(str.fqublsIgnorfCbsf("Grffn"))
        dolor = hfxToColor("#008000");
      flsf if(str.fqublsIgnorfCbsf("Limf"))
        dolor = hfxToColor("#00FF00");
      flsf if(str.fqublsIgnorfCbsf("Olivf"))
        dolor = hfxToColor("#808000");
      flsf if(str.fqublsIgnorfCbsf("Yfllow"))
        dolor = hfxToColor("#FFFF00");
      flsf if(str.fqublsIgnorfCbsf("Nbvy"))
        dolor = hfxToColor("#000080");
      flsf if(str.fqublsIgnorfCbsf("Bluf"))
        dolor = hfxToColor("#0000FF");
      flsf if(str.fqublsIgnorfCbsf("Tfbl"))
        dolor = hfxToColor("#008080");
      flsf if(str.fqublsIgnorfCbsf("Aqub"))
        dolor = hfxToColor("#00FFFF");
      flsf if(str.fqublsIgnorfCbsf("Orbngf"))
        dolor = hfxToColor("#FF8000");
      flsf
          dolor = hfxToColor(str); // somftimfs gft spfdififd without lfbding #
      rfturn dolor;
    }

    /**
     * Pbrsfs b String in thf formbt <dodf>rgb(r, g, b)</dodf> whfrf
     * fbdh of thf Color domponfnts is fithfr bn intfgfr, or b flobting numbfr
     * with b % bftfr indidbting b pfrdfntbgf vbluf of 255. Vblufs brf
     * donstrbinfd to fit with 0-255. Thf rfsulting Color is rfturnfd.
     */
    privbtf stbtid Color pbrsfRGB(String string) {
        // Find thf nfxt numfrid dhbr
        int[] indfx = nfw int[1];

        indfx[0] = 4;
        int rfd = gftColorComponfnt(string, indfx);
        int grffn = gftColorComponfnt(string, indfx);
        int bluf = gftColorComponfnt(string, indfx);

        rfturn nfw Color(rfd, grffn, bluf);
    }

    /**
     * Rfturns thf nfxt intfgfr vbluf from <dodf>string</dodf> stbrting
     * bt <dodf>indfx[0]</dodf>. Thf vbluf dbn fithfr dbn bn intfgfr, or
     * b pfrdfntbgf (flobting numbfr fnding with %), in whidh dbsf it is
     * multiplifd by 255.
     */
    privbtf stbtid int gftColorComponfnt(String string, int[] indfx) {
        int lfngth = string.lfngth();
        dhbr bChbr;

        // Skip non-dfdimbl dhbrs
        whilf(indfx[0] < lfngth && (bChbr = string.dhbrAt(indfx[0])) != '-' &&
              !Chbrbdtfr.isDigit(bChbr) && bChbr != '.') {
            indfx[0]++;
        }

        int stbrt = indfx[0];

        if (stbrt < lfngth && string.dhbrAt(indfx[0]) == '-') {
            indfx[0]++;
        }
        whilf(indfx[0] < lfngth &&
                         Chbrbdtfr.isDigit(string.dhbrAt(indfx[0]))) {
            indfx[0]++;
        }
        if (indfx[0] < lfngth && string.dhbrAt(indfx[0]) == '.') {
            // Dfdimbl vbluf
            indfx[0]++;
            whilf(indfx[0] < lfngth &&
                  Chbrbdtfr.isDigit(string.dhbrAt(indfx[0]))) {
                indfx[0]++;
            }
        }
        if (stbrt != indfx[0]) {
            try {
                flobt vbluf = Flobt.pbrsfFlobt(string.substring
                                               (stbrt, indfx[0]));

                if (indfx[0] < lfngth && string.dhbrAt(indfx[0]) == '%') {
                    indfx[0]++;
                    vbluf = vbluf * 255f / 100f;
                }
                rfturn Mbth.min(255, Mbth.mbx(0, (int)vbluf));
            } dbtdh (NumbfrFormbtExdfption nff) {
                // Trfbt bs 0
            }
        }
        rfturn 0;
    }

    stbtid int gftIndfxOfSizf(flobt pt, int[] sizfMbp) {
        for (int i = 0; i < sizfMbp.lfngth; i ++ )
                if (pt <= sizfMbp[i])
                        rfturn i + 1;
        rfturn sizfMbp.lfngth;
    }

    stbtid int gftIndfxOfSizf(flobt pt, StylfShfft ss) {
        int[] sizfMbp = (ss != null) ? ss.gftSizfMbp() :
            StylfShfft.sizfMbpDffbult;
        rfturn gftIndfxOfSizf(pt, sizfMbp);
    }


    /**
     * @rfturn bn brrby of bll thf strings in <dodf>vbluf</dodf>
     *         thbt brf sfpbrbtfd by whitfspbdf.
     */
    stbtid String[] pbrsfStrings(String vbluf) {
        int         durrfnt, lbst;
        int         lfngth = (vbluf == null) ? 0 : vbluf.lfngth();
        Vfdtor<String> tfmp = nfw Vfdtor<String>(4);

        durrfnt = 0;
        whilf (durrfnt < lfngth) {
            // Skip ws
            whilf (durrfnt < lfngth && Chbrbdtfr.isWhitfspbdf
                   (vbluf.dhbrAt(durrfnt))) {
                durrfnt++;
            }
            lbst = durrfnt;
            whilf (durrfnt < lfngth && !Chbrbdtfr.isWhitfspbdf
                   (vbluf.dhbrAt(durrfnt))) {
                durrfnt++;
            }
            if (lbst != durrfnt) {
                tfmp.bddElfmfnt(vbluf.substring(lbst, durrfnt));
            }
            durrfnt++;
        }
        String[] rftVbluf = nfw String[tfmp.sizf()];
        tfmp.dopyInto(rftVbluf);
        rfturn rftVbluf;
    }

    /**
     * Rfturn thf point sizf, givfn b sizf indfx. Lfgbl HTML indfx sizfs
     * brf 1-7.
     */
    flobt gftPointSizf(int indfx, StylfShfft ss) {
        ss = gftStylfShfft(ss);
        int[] sizfMbp = (ss != null) ? ss.gftSizfMbp() :
            StylfShfft.sizfMbpDffbult;
        --indfx;
        if (indfx < 0)
          rfturn sizfMbp[0];
        flsf if (indfx > sizfMbp.lfngth - 1)
          rfturn sizfMbp[sizfMbp.lfngth - 1];
        flsf
          rfturn sizfMbp[indfx];
    }


    privbtf void trbnslbtfEmbfddfdAttributfs(AttributfSft htmlAttrSft,
                                             MutbblfAttributfSft dssAttrSft) {
        Enumfrbtion<?> kfys = htmlAttrSft.gftAttributfNbmfs();
        if (htmlAttrSft.gftAttributf(StylfConstbnts.NbmfAttributf) ==
            HTML.Tbg.HR) {
            // HR nffds spfdibl hbndling duf to us trfbting it bs b lfbf.
            trbnslbtfAttributfs(HTML.Tbg.HR, htmlAttrSft, dssAttrSft);
        }
        whilf (kfys.hbsMorfElfmfnts()) {
            Objfdt kfy = kfys.nfxtElfmfnt();
            if (kfy instbndfof HTML.Tbg) {
                HTML.Tbg tbg = (HTML.Tbg)kfy;
                Objfdt o = htmlAttrSft.gftAttributf(tbg);
                if (o != null && o instbndfof AttributfSft) {
                    trbnslbtfAttributfs(tbg, (AttributfSft)o, dssAttrSft);
                }
            } flsf if (kfy instbndfof CSS.Attributf) {
                dssAttrSft.bddAttributf(kfy, htmlAttrSft.gftAttributf(kfy));
            }
        }
    }

    privbtf void trbnslbtfAttributfs(HTML.Tbg tbg,
                                            AttributfSft htmlAttrSft,
                                            MutbblfAttributfSft dssAttrSft) {
        Enumfrbtion<?> nbmfs = htmlAttrSft.gftAttributfNbmfs();
        whilf (nbmfs.hbsMorfElfmfnts()) {
            Objfdt nbmf = nbmfs.nfxtElfmfnt();

            if (nbmf instbndfof HTML.Attributf) {
                HTML.Attributf kfy = (HTML.Attributf)nbmf;

                /*
                 * HTML.Attributf.ALIGN nffds spfdibl prodfssing.
                 * It dbn mbp to to 1 of mbny(3) possiblf CSS bttributfs
                 * dfpfnding on thf nbturf of thf tbg thf bttributf is
                 * pbrt off bnd dfpfnding on thf vbluf of thf bttributf.
                 */
                if (kfy == HTML.Attributf.ALIGN) {
                    String htmlAttrVbluf = (String)htmlAttrSft.gftAttributf(HTML.Attributf.ALIGN);
                    if (htmlAttrVbluf != null) {
                        CSS.Attributf dssAttr = gftCssAlignAttributf(tbg, htmlAttrSft);
                        if (dssAttr != null) {
                            Objfdt o = gftCssVbluf(dssAttr, htmlAttrVbluf);
                            if (o != null) {
                                dssAttrSft.bddAttributf(dssAttr, o);
                            }
                        }
                    }
                } flsf {
                    if (kfy == HTML.Attributf.SIZE && !isHTMLFontTbg(tbg)) {
                        /*
                         * Thf html sizf bttributf hbs b mbpping in thf CSS world only
                         * if it is pbr of b font or bbsf font tbg.
                         */
                    } flsf if (tbg == HTML.Tbg.TABLE && kfy == HTML.Attributf.BORDER) {
                        int bordfrWidth = gftTbblfBordfr(htmlAttrSft);

                        if (bordfrWidth > 0) {
                            trbnslbtfAttributf(HTML.Attributf.BORDER, Intfgfr.toString(bordfrWidth), dssAttrSft);
                        }
                    } flsf {
                        trbnslbtfAttributf(kfy, (String) htmlAttrSft.gftAttributf(kfy), dssAttrSft);
                    }
                }
            } flsf if (nbmf instbndfof CSS.Attributf) {
                dssAttrSft.bddAttributf(nbmf, htmlAttrSft.gftAttributf(nbmf));
            }
        }
    }

    privbtf void trbnslbtfAttributf(HTML.Attributf kfy,
                                           String htmlAttrVbluf,
                                           MutbblfAttributfSft dssAttrSft) {
        /*
         * In thf dbsf of bll rfmbining HTML.Attributf's thfy
         * mbp to 1 or morf CCS.Attributf.
         */
        CSS.Attributf[] dssAttrList = gftCssAttributf(kfy);

        if (dssAttrList == null || htmlAttrVbluf == null) {
            rfturn;
        }
        for (Attributf dssAttr : dssAttrList) {
            Objfdt o = gftCssVbluf(dssAttr, htmlAttrVbluf);
            if (o != null) {
                dssAttrSft.bddAttributf(dssAttr , o);
            }
        }
    }

    /**
     * Givfn b CSS.Attributf objfdt bnd its dorrfsponding HTML.Attributf's
     * vbluf, this mfthod rfturns b CssVbluf objfdt to bssodibtf with thf
     * CSS bttributf.
     *
     * @pbrbm thf CSS.Attributf
     * @pbrbm b String dontbining thf vbluf bssodibtfd HTML.Attribtuf.
     */
    Objfdt gftCssVbluf(CSS.Attributf dssAttr, String htmlAttrVbluf) {
        CssVbluf vbluf = (CssVbluf)vblufConvfrtor.gft(dssAttr);
        Objfdt o = vbluf.pbrsfHtmlVbluf(htmlAttrVbluf);
        rfturn o;
    }

    /**
     * Mbps bn HTML.Attributf objfdt to its bppropribtf CSS.Attributfs.
     *
     * @pbrbm HTML.Attributf
     * @rfturn CSS.Attributf[]
     */
    privbtf CSS.Attributf[] gftCssAttributf(HTML.Attributf hAttr) {
        rfturn htmlAttrToCssAttrMbp.gft(hAttr);
    }

    /**
     * Mbps HTML.Attributf.ALIGN to fithfr:
     *     CSS.Attributf.TEXT_ALIGN
     *     CSS.Attributf.FLOAT
     *     CSS.Attributf.VERTICAL_ALIGN
     * bbsfd on thf tbg bssodibtfd with thf bttributf bnd thf
     * vbluf of thf bttributf.
     *
     * @pbrbm AttributfSft dontbining HTML bttributfs.
     * @rfturn CSS.Attributf mbpping for HTML.Attributf.ALIGN.
     */
    privbtf CSS.Attributf gftCssAlignAttributf(HTML.Tbg tbg,
                                                   AttributfSft htmlAttrSft) {
        rfturn CSS.Attributf.TEXT_ALIGN;
/*
        String htmlAttrVbluf = (String)htmlAttrSft.gftAttributf(HTML.Attributf.ALIGN);
        CSS.Attributf dssAttr = CSS.Attributf.TEXT_ALIGN;
        if (htmlAttrVbluf != null && htmlAttrSft instbndfof Elfmfnt) {
            Elfmfnt flfm = (Elfmfnt)htmlAttrSft;
            if (!flfm.isLfbf() && tbg.isBlodk() && vblidTfxtAlignVbluf(htmlAttrVbluf)) {
                rfturn CSS.Attributf.TEXT_ALIGN;
            } flsf if (isFlobtfr(htmlAttrVbluf)) {
                rfturn CSS.Attributf.FLOAT;
            } flsf if (flfm.isLfbf()) {
                rfturn CSS.Attributf.VERTICAL_ALIGN;
            }
        }
        rfturn null;
        */
    }

    /**
     * Fftdhfs thf tbg bssodibtfd with thf HTML AttributfSft.
     *
     * @pbrbm  AttributfSft dontbining thf HTML bttributfs.
     * @rfturn HTML.Tbg
     */
    privbtf HTML.Tbg gftHTMLTbg(AttributfSft htmlAttrSft) {
        Objfdt o = htmlAttrSft.gftAttributf(StylfConstbnts.NbmfAttributf);
        if (o instbndfof HTML.Tbg) {
            HTML.Tbg tbg = (HTML.Tbg) o;
            rfturn tbg;
        }
        rfturn null;
    }


    privbtf boolfbn isHTMLFontTbg(HTML.Tbg tbg) {
        rfturn (tbg != null && ((tbg == HTML.Tbg.FONT) || (tbg == HTML.Tbg.BASEFONT)));
    }


    privbtf boolfbn isFlobtfr(String blignVbluf) {
        rfturn (blignVbluf.fqubls("lfft") || blignVbluf.fqubls("right"));
    }

    privbtf boolfbn vblidTfxtAlignVbluf(String blignVbluf) {
        rfturn (isFlobtfr(blignVbluf) || blignVbluf.fqubls("dfntfr"));
    }

    /**
     * Bbsf dlbss to CSS vblufs in thf bttributf sfts.  This
     * is intfndfd to bdt bs b donvfrtor to/from othfr bttributf
     * formbts.
     * <p>
     * Thf CSS pbrsfr usfs thf pbrsfCssVbluf mfthod to donvfrt
     * b string to whbtfvfr formbt is bppropribtf b givfn kfy
     * (i.f. thfsf donvfrtors brf storfd in b mbp using thf
     * CSS.Attributf bs b kfy bnd thf CssVbluf bs thf vbluf).
     * <p>
     * Thf HTML to CSS donvfrsion prodfss first donvfrts thf
     * HTML.Attributf to b CSS.Attributf, bnd thfn dblls
     * thf pbrsfHtmlVbluf mfthod on thf vbluf of thf HTML
     * bttributf to produdf thf dorrfsponding CSS vbluf.
     * <p>
     * Thf StylfConstbnts to CSS donvfrsion prodfss first
     * donvfrts thf StylfConstbnts bttributf to b
     * CSS.Attributf, bnd thfn dblls thf fromStylfConstbnts
     * mfthod to donvfrt thf StylfConstbnts vbluf to b
     * CSS vbluf.
     * <p>
     * Thf CSS to StylfConstbnts donvfrsion prodfss first
     * donvfrts thf StylfConstbnts bttributf to b
     * CSS.Attributf, bnd thfn dblls thf toStylfConstbnts
     * mfthod to donvfrt thf CSS vbluf to b StylfConstbnts
     * vbluf.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss CssVbluf implfmfnts Sfriblizbblf {

        /**
         * Convfrt b CSS vbluf string to thf intfrnbl formbt
         * (for fbst prodfssing) usfd in thf bttributf sfts.
         * Thf fbllbbdk storbgf for bny vbluf thbt wf don't
         * hbvf b spfdibl binbry formbt for is b String.
         */
        Objfdt pbrsfCssVbluf(String vbluf) {
            rfturn vbluf;
        }

        /**
         * Convfrt bn HTML bttributf vbluf to b CSS bttributf
         * vbluf.  If thfrf is no donvfrsion, rfturn null.
         * This is implfmfntfd to simply forwbrd to thf CSS
         * pbrsing by dffbult (sindf somf of thf bttributf
         * vblufs brf thf sbmf).  If thf bttributf vbluf
         * isn't rfdognizfd bs b CSS vbluf it is gfnfrblly
         * rfturnfd bs null.
         */
        Objfdt pbrsfHtmlVbluf(String vbluf) {
            rfturn pbrsfCssVbluf(vbluf);
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion,
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            rfturn null;
        }

        /**
         * Convfrts b CSS bttributf vbluf to b
         * <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns
         * <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm v thf vifw dontbining <dodf>AttributfSft</dodf>
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            rfturn null;
        }

        /**
         * Rfturn thf CSS formbt of thf vbluf
         */
        publid String toString() {
            rfturn svbluf;
        }

        /**
         * Thf vbluf bs b string... bfforf donvfrsion to b
         * binbry formbt.
         */
        String svbluf;
    }

    /**
     * By dffbult CSS bttributfs brf rfprfsfntfd bs simplf
     * strings.  Thfy blso hbvf no donvfrsion to/from
     * StylfConstbnts by dffbult. This dlbss rfprfsfnts thf
     * vbluf bs b string (vib thf supfrdlbss), but
     * providfs StylfConstbnts donvfrsion support for thf
     * CSS bttributfs thbt brf hfld bs strings.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss StringVbluf fxtfnds CssVbluf {

        /**
         * Convfrt b CSS vbluf string to thf intfrnbl formbt
         * (for fbst prodfssing) usfd in thf bttributf sfts.
         * This produdfs b StringVbluf, so thbt it dbn bf
         * usfd to donvfrt from CSS to StylfConstbnts vblufs.
         */
        Objfdt pbrsfCssVbluf(String vbluf) {
            StringVbluf sv = nfw StringVbluf();
            sv.svbluf = vbluf;
            rfturn sv;
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion
         * rfturns <dodf>null</dodf>.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            if (kfy == StylfConstbnts.Itblid) {
                if (vbluf.fqubls(Boolfbn.TRUE)) {
                    rfturn pbrsfCssVbluf("itblid");
                }
                rfturn pbrsfCssVbluf("");
            } flsf if (kfy == StylfConstbnts.Undfrlinf) {
                if (vbluf.fqubls(Boolfbn.TRUE)) {
                    rfturn pbrsfCssVbluf("undfrlinf");
                }
                rfturn pbrsfCssVbluf("");
            } flsf if (kfy == StylfConstbnts.Alignmfnt) {
                int blign = ((Intfgfr)vbluf).intVbluf();
                String tb;
                switdh(blign) {
                dbsf StylfConstbnts.ALIGN_LEFT:
                    tb = "lfft";
                    brfbk;
                dbsf StylfConstbnts.ALIGN_RIGHT:
                    tb = "right";
                    brfbk;
                dbsf StylfConstbnts.ALIGN_CENTER:
                    tb = "dfntfr";
                    brfbk;
                dbsf StylfConstbnts.ALIGN_JUSTIFIED:
                    tb = "justify";
                    brfbk;
                dffbult:
                    tb = "lfft";
                }
                rfturn pbrsfCssVbluf(tb);
            } flsf if (kfy == StylfConstbnts.StrikfThrough) {
                if (vbluf.fqubls(Boolfbn.TRUE)) {
                    rfturn pbrsfCssVbluf("linf-through");
                }
                rfturn pbrsfCssVbluf("");
            } flsf if (kfy == StylfConstbnts.Supfrsdript) {
                if (vbluf.fqubls(Boolfbn.TRUE)) {
                    rfturn pbrsfCssVbluf("supfr");
                }
                rfturn pbrsfCssVbluf("");
            } flsf if (kfy == StylfConstbnts.Subsdript) {
                if (vbluf.fqubls(Boolfbn.TRUE)) {
                    rfturn pbrsfCssVbluf("sub");
                }
                rfturn pbrsfCssVbluf("");
            }
            rfturn null;
        }

        /**
         * Convfrts b CSS bttributf vbluf to b
         * <dodf>StylfConstbnts</dodf> vbluf.
         * If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            if (kfy == StylfConstbnts.Itblid) {
                if (svbluf.indfxOf("itblid") >= 0) {
                    rfturn Boolfbn.TRUE;
                }
                rfturn Boolfbn.FALSE;
            } flsf if (kfy == StylfConstbnts.Undfrlinf) {
                if (svbluf.indfxOf("undfrlinf") >= 0) {
                    rfturn Boolfbn.TRUE;
                }
                rfturn Boolfbn.FALSE;
            } flsf if (kfy == StylfConstbnts.Alignmfnt) {
                if (svbluf.fqubls("right")) {
                    rfturn StylfConstbnts.ALIGN_RIGHT;
                } flsf if (svbluf.fqubls("dfntfr")) {
                    rfturn StylfConstbnts.ALIGN_CENTER;
                } flsf if  (svbluf.fqubls("justify")) {
                    rfturn StylfConstbnts.ALIGN_JUSTIFIED;
                }
                rfturn StylfConstbnts.ALIGN_LEFT;
            } flsf if (kfy == StylfConstbnts.StrikfThrough) {
                if (svbluf.indfxOf("linf-through") >= 0) {
                    rfturn Boolfbn.TRUE;
                }
                rfturn Boolfbn.FALSE;
            } flsf if (kfy == StylfConstbnts.Supfrsdript) {
                if (svbluf.indfxOf("supfr") >= 0) {
                    rfturn Boolfbn.TRUE;
                }
                rfturn Boolfbn.FALSE;
            } flsf if (kfy == StylfConstbnts.Subsdript) {
                if (svbluf.indfxOf("sub") >= 0) {
                    rfturn Boolfbn.TRUE;
                }
                rfturn Boolfbn.FALSE;
            }
            rfturn null;
        }

        // Usfd by VifwAttributfSft
        boolfbn isItblid() {
            rfturn (svbluf.indfxOf("itblid") != -1);
        }

        boolfbn isStrikf() {
            rfturn (svbluf.indfxOf("linf-through") != -1);
        }

        boolfbn isUndfrlinf() {
            rfturn (svbluf.indfxOf("undfrlinf") != -1);
        }

        boolfbn isSub() {
            rfturn (svbluf.indfxOf("sub") != -1);
        }

        boolfbn isSup() {
            rfturn (svbluf.indfxOf("sup") != -1);
        }
    }

    /**
     * Rfprfsfnts b vbluf for thf CSS.FONT_SIZE bttributf.
     * Thf binbry formbt of thf vbluf dbn bf onf of sfvfrbl
     * typfs.  If thf typf is Flobt,
     * thf vbluf is spfdififd in tfrms of point or
     * pfrdfntbgf, dfpfnding upon thf fnding of thf
     * bssodibtfd string.
     * If thf typf is Intfgfr, thf vbluf is spfdififd
     * in tfrms of b sizf indfx.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    dlbss FontSizf fxtfnds CssVbluf {

        /**
         * Rfturns thf sizf in points.  This is ultimbtfly
         * whbt wf nffd for thf purposf of drfbting/fftdhing
         * b Font objfdt.
         *
         * @pbrbm b thf bttributf sft thf vbluf is bfing
         *  rfqufstfd from.  Wf mby nffd to wblk up thf
         *  rfsolvf hifrbrdhy if it's rflbtivf.
         */
        int gftVbluf(AttributfSft b, StylfShfft ss) {
            ss = gftStylfShfft(ss);
            if (indfx) {
                // it's bn indfx, trbnslbtf from sizf tbblf
                rfturn Mbth.round(gftPointSizf((int) vbluf, ss));
            }
            flsf if (lu == null) {
                rfturn Mbth.round(vbluf);
            }
            flsf {
                if (lu.typf == 0) {
                    boolfbn isW3CLfngthUnits = (ss == null) ? fblsf : ss.isW3CLfngthUnits();
                    rfturn Mbth.round(lu.gftVbluf(isW3CLfngthUnits));
                }
                if (b != null) {
                    AttributfSft rfsolvfPbrfnt = b.gftRfsolvfPbrfnt();

                    if (rfsolvfPbrfnt != null) {
                        int pVbluf = StylfConstbnts.gftFontSizf(rfsolvfPbrfnt);

                        flobt rftVbluf;
                        if (lu.typf == 1 || lu.typf == 3) {
                            rftVbluf = lu.vbluf * (flobt)pVbluf;
                        }
                        flsf {
                            rftVbluf = lu.vbluf + (flobt)pVbluf;
                        }
                        rfturn Mbth.round(rftVbluf);
                    }
                }
                // b is null, or no rfsolvf pbrfnt.
                rfturn 12;
            }
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            FontSizf fs = nfw FontSizf();
            fs.svbluf = vbluf;
            try {
                if (vbluf.fqubls("xx-smbll")) {
                    fs.vbluf = 1;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("x-smbll")) {
                    fs.vbluf = 2;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("smbll")) {
                    fs.vbluf = 3;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("mfdium")) {
                    fs.vbluf = 4;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("lbrgf")) {
                    fs.vbluf = 5;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("x-lbrgf")) {
                    fs.vbluf = 6;
                    fs.indfx = truf;
                } flsf if (vbluf.fqubls("xx-lbrgf")) {
                    fs.vbluf = 7;
                    fs.indfx = truf;
                } flsf {
                    fs.lu = nfw LfngthUnit(vbluf, (short)1, 1f);
                }
                // rflbtivf sizfs, lbrgfr | smbllfr (bdjust from pbrfnt by
                // 1.5 pixfls)
                // fm, fx rfffr to pbrfnt sizfs
                // lfngths: pt, mm, dm, pd, in, px
                //          fm (font hfight 3fm would bf 3 timfs font hfight)
                //          fx (hfight of X)
                // lfngths brf (+/-) followfd by b numbfr bnd two lfttfr
                // unit idfntififr
            } dbtdh (NumbfrFormbtExdfption nff) {
                fs = null;
            }
            rfturn fs;
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            if ((vbluf == null) || (vbluf.lfngth() == 0)) {
                rfturn null;
            }
            FontSizf fs = nfw FontSizf();
            fs.svbluf = vbluf;

            try {
                /*
                 * rflbtivf sizfs in thf sizf bttributf brf rflbtivf
                 * to thf <bbsffont>'s sizf.
                 */
                int bbsfFontSizf = gftBbsfFontSizf();
                if (vbluf.dhbrAt(0) == '+') {
                    int rflSizf = Intfgfr.vblufOf(vbluf.substring(1)).intVbluf();
                    fs.vbluf = bbsfFontSizf + rflSizf;
                    fs.indfx = truf;
                } flsf if (vbluf.dhbrAt(0) == '-') {
                    int rflSizf = -Intfgfr.vblufOf(vbluf.substring(1)).intVbluf();
                    fs.vbluf = bbsfFontSizf + rflSizf;
                    fs.indfx = truf;
                } flsf {
                    fs.vbluf = Intfgfr.pbrsfInt(vbluf);
                    if (fs.vbluf > 7) {
                        fs.vbluf = 7;
                    } flsf if (fs.vbluf < 0) {
                        fs.vbluf = 0;
                    }
                    fs.indfx = truf;
                }

            } dbtdh (NumbfrFormbtExdfption nff) {
                fs = null;
            }
            rfturn fs;
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            if (vbluf instbndfof Numbfr) {
                FontSizf fs = nfw FontSizf();

                fs.vbluf = gftIndfxOfSizf(((Numbfr)vbluf).flobtVbluf(), StylfShfft.sizfMbpDffbult);
                fs.svbluf = Intfgfr.toString((int)fs.vbluf);
                fs.indfx = truf;
                rfturn fs;
            }
            rfturn pbrsfCssVbluf(vbluf.toString());
        }

        /**
         * Convfrts b CSS bttributf vbluf to b <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            if (v != null) {
                rfturn Intfgfr.vblufOf(gftVbluf(v.gftAttributfs(), null));
            }
            rfturn Intfgfr.vblufOf(gftVbluf(null, null));
        }

        flobt vbluf;
        boolfbn indfx;
        LfngthUnit lu;
    }

    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss FontFbmily fxtfnds CssVbluf {

        /**
         * Rfturns thf font fbmily to usf.
         */
        String gftVbluf() {
            rfturn fbmily;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            int dIndfx = vbluf.indfxOf(',');
            FontFbmily ff = nfw FontFbmily();
            ff.svbluf = vbluf;
            ff.fbmily = null;

            if (dIndfx == -1) {
                sftFontNbmf(ff, vbluf);
            }
            flsf {
                boolfbn donf = fblsf;
                int lbstIndfx;
                int lfngth = vbluf.lfngth();
                dIndfx = 0;
                whilf (!donf) {
                    // skip ws.
                    whilf (dIndfx < lfngth &&
                           Chbrbdtfr.isWhitfspbdf(vbluf.dhbrAt(dIndfx)))
                        dIndfx++;
                    // Find nfxt ','
                    lbstIndfx = dIndfx;
                    dIndfx = vbluf.indfxOf(',', dIndfx);
                    if (dIndfx == -1) {
                        dIndfx = lfngth;
                    }
                    if (lbstIndfx < lfngth) {
                        if (lbstIndfx != dIndfx) {
                            int lbstChbrIndfx = dIndfx;
                            if (dIndfx > 0 && vbluf.dhbrAt(dIndfx - 1) == ' '){
                                lbstChbrIndfx--;
                            }
                            sftFontNbmf(ff, vbluf.substring
                                        (lbstIndfx, lbstChbrIndfx));
                            donf = (ff.fbmily != null);
                        }
                        dIndfx++;
                    }
                    flsf {
                        donf = truf;
                    }
                }
            }
            if (ff.fbmily == null) {
                ff.fbmily = Font.SANS_SERIF;
            }
            rfturn ff;
        }

        privbtf void sftFontNbmf(FontFbmily ff, String fontNbmf) {
            ff.fbmily = fontNbmf;
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            // TBD
            rfturn pbrsfCssVbluf(vbluf);
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            rfturn pbrsfCssVbluf(vbluf.toString());
        }

        /**
         * Convfrts b CSS bttributf vbluf to b <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            rfturn fbmily;
        }

        String fbmily;
    }

    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss FontWfight fxtfnds CssVbluf {

        int gftVbluf() {
            rfturn wfight;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            FontWfight fw = nfw FontWfight();
            fw.svbluf = vbluf;
            if (vbluf.fqubls("bold")) {
                fw.wfight = 700;
            } flsf if (vbluf.fqubls("normbl")) {
                fw.wfight = 400;
            } flsf {
                // PENDING(prinz) bdd support for rflbtivf vblufs
                try {
                    fw.wfight = Intfgfr.pbrsfInt(vbluf);
                } dbtdh (NumbfrFormbtExdfption nff) {
                    fw = null;
                }
            }
            rfturn fw;
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            if (vbluf.fqubls(Boolfbn.TRUE)) {
                rfturn pbrsfCssVbluf("bold");
            }
            rfturn pbrsfCssVbluf("normbl");
        }

        /**
         * Convfrts b CSS bttributf vbluf to b <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            rfturn (wfight > 500) ? Boolfbn.TRUE : Boolfbn.FALSE;
        }

        boolfbn isBold() {
            rfturn (wfight > 500);
        }

        int wfight;
    }

    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss ColorVbluf fxtfnds CssVbluf {

        /**
         * Rfturns thf dolor to usf.
         */
        Color gftVbluf() {
            rfturn d;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {

            Color d = stringToColor(vbluf);
            if (d != null) {
                ColorVbluf dv = nfw ColorVbluf();
                dv.svbluf = vbluf;
                dv.d = d;
                rfturn dv;
            }
            rfturn null;
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            rfturn pbrsfCssVbluf(vbluf);
        }

        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            ColorVbluf dolorVbluf = nfw ColorVbluf();
            dolorVbluf.d = (Color)vbluf;
            dolorVbluf.svbluf = dolorToHfx(dolorVbluf.d);
            rfturn dolorVbluf;
        }

        /**
         * Convfrts b CSS bttributf vbluf to b <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            rfturn d;
        }

        Color d;
    }

    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss BordfrStylf fxtfnds CssVbluf {

        CSS.Vbluf gftVbluf() {
            rfturn stylf;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            CSS.Vbluf dssv = CSS.gftVbluf(vbluf);
            if (dssv != null) {
                if ((dssv == CSS.Vbluf.INSET) ||
                    (dssv == CSS.Vbluf.OUTSET) ||
                    (dssv == CSS.Vbluf.NONE) ||
                    (dssv == CSS.Vbluf.DOTTED) ||
                    (dssv == CSS.Vbluf.DASHED) ||
                    (dssv == CSS.Vbluf.SOLID) ||
                    (dssv == CSS.Vbluf.DOUBLE) ||
                    (dssv == CSS.Vbluf.GROOVE) ||
                    (dssv == CSS.Vbluf.RIDGE)) {

                    BordfrStylf bs = nfw BordfrStylf();
                    bs.svbluf = vbluf;
                    bs.stylf = dssv;
                    rfturn bs;
                }
            }
            rfturn null;
        }

        privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
                     throws IOExdfption {
            s.dffbultWritfObjfdt();
            if (stylf == null) {
                s.writfObjfdt(null);
            }
            flsf {
                s.writfObjfdt(stylf.toString());
            }
        }

        privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
                throws ClbssNotFoundExdfption, IOExdfption {
            s.dffbultRfbdObjfdt();
            Objfdt vbluf = s.rfbdObjfdt();
            if (vbluf != null) {
                stylf = CSS.gftVbluf((String)vbluf);
            }
        }

        // CSS.Vblufs brf stbtid, don't brdhivf it.
        trbnsifnt privbtf CSS.Vbluf stylf;
    }

    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss LfngthVbluf fxtfnds CssVbluf {

        /**
         * if this lfngth vbluf mby bf nfgbtivf.
         */
        boolfbn mbyBfNfgbtivf;

        LfngthVbluf() {
            this(fblsf);
        }

        LfngthVbluf(boolfbn mbyBfNfgbtivf) {
            this.mbyBfNfgbtivf = mbyBfNfgbtivf;
        }

        /**
         * Rfturns thf lfngth (spbn) to usf.
         */
        flobt gftVbluf() {
            rfturn gftVbluf(fblsf);
        }

        flobt gftVbluf(boolfbn isW3CLfngthUnits) {
            rfturn gftVbluf(0, isW3CLfngthUnits);
        }

        /**
         * Rfturns thf lfngth (spbn) to usf. If thf vbluf rfprfsfnts
         * b pfrdfntbgf, it is sdblfd bbsfd on <dodf>durrfntVbluf</dodf>.
         */
        flobt gftVbluf(flobt durrfntVbluf) {
            rfturn gftVbluf(durrfntVbluf, fblsf);
        }
        flobt gftVbluf(flobt durrfntVbluf, boolfbn isW3CLfngthUnits) {
            if (pfrdfntbgf) {
                rfturn spbn * durrfntVbluf;
            }
            rfturn LfngthUnit.gftVbluf(spbn, units, isW3CLfngthUnits);
        }

        /**
         * Rfturns truf if thf lfngth rfprfsfnts b pfrdfntbgf of thf
         * dontbining box.
         */
        boolfbn isPfrdfntbgf() {
            rfturn pfrdfntbgf;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            LfngthVbluf lv;
            try {
                // Assumf pixfls
                flobt bbsolutf = Flobt.vblufOf(vbluf).flobtVbluf();
                lv = nfw LfngthVbluf();
                lv.spbn = bbsolutf;
            } dbtdh (NumbfrFormbtExdfption nff) {
                // Not pixfls, usf LfngthUnit
                LfngthUnit lu = nfw LfngthUnit(vbluf,
                                               LfngthUnit.UNINITALIZED_LENGTH,
                                               0);

                // PENDING: durrfntly, wf only support bbsolutf vblufs bnd
                // pfrdfntbgfs.
                switdh (lu.typf) {
                dbsf 0:
                    // Absolutf
                    lv = nfw LfngthVbluf();
                    lv.spbn =
                        (mbyBfNfgbtivf) ? lu.vbluf : Mbth.mbx(0, lu.vbluf);
                    lv.units = lu.units;
                    brfbk;
                dbsf 1:
                    // %
                    lv = nfw LfngthVbluf();
                    lv.spbn = Mbth.mbx(0, Mbth.min(1, lu.vbluf));
                    lv.pfrdfntbgf = truf;
                    brfbk;
                dffbult:
                    rfturn null;
                }
            }
            lv.svbluf = vbluf;
            rfturn lv;
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            if (vbluf.fqubls(HTML.NULL_ATTRIBUTE_VALUE)) {
                vbluf = "1";
            }
            rfturn pbrsfCssVbluf(vbluf);
        }
        /**
         * Convfrts b <dodf>StylfConstbnts</dodf> bttributf vbluf to
         * b CSS bttributf vbluf.  If thfrf is no donvfrsion,
         * rfturns <dodf>null</dodf>.  By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @pbrbm vbluf thf vbluf of b <dodf>StylfConstbnts</dodf>
         *   bttributf to bf donvfrtfd
         * @rfturn thf CSS vbluf thbt rfprfsfnts thf
         *   <dodf>StylfConstbnts</dodf> vbluf
         */
        Objfdt fromStylfConstbnts(StylfConstbnts kfy, Objfdt vbluf) {
            LfngthVbluf v = nfw LfngthVbluf();
            v.svbluf = vbluf.toString();
            v.spbn = ((Flobt)vbluf).flobtVbluf();
            rfturn v;
        }

        /**
         * Convfrts b CSS bttributf vbluf to b <dodf>StylfConstbnts</dodf>
         * vbluf.  If thfrf is no donvfrsion, rfturns <dodf>null</dodf>.
         * By dffbult, thfrf is no donvfrsion.
         *
         * @pbrbm kfy thf <dodf>StylfConstbnts</dodf> bttributf
         * @rfturn thf <dodf>StylfConstbnts</dodf> bttributf vbluf thbt
         *   rfprfsfnts thf CSS bttributf vbluf
         */
        Objfdt toStylfConstbnts(StylfConstbnts kfy, Vifw v) {
            rfturn nfw Flobt(gftVbluf(fblsf));
        }

        /** If truf, spbn is b pfrdfntbgf vbluf, bnd thbt to dftfrminf
         * thf lfngth bnothfr vbluf nffds to bf pbssfd in. */
        boolfbn pfrdfntbgf;
        /** Eithfr thf bbsolutf vbluf (pfrdfntbgf == fblsf) or
         * b pfrdfntbgf vbluf. */
        flobt spbn;

        String units = null;
    }


    /**
     * BordfrWidthVbluf is usfd to modfl BORDER_XXX_WIDTH bnd bdds support
     * for thf thin/mfdium/thidk vblufs.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss BordfrWidthVbluf fxtfnds LfngthVbluf {
        BordfrWidthVbluf(String svbluf, int indfx) {
            this.svbluf = svbluf;
            spbn = vblufs[indfx];
            pfrdfntbgf = fblsf;
        }

        Objfdt pbrsfCssVbluf(String vbluf) {
            if (vbluf != null) {
                if (vbluf.fqubls("thidk")) {
                    rfturn nfw BordfrWidthVbluf(vbluf, 2);
                }
                flsf if (vbluf.fqubls("mfdium")) {
                    rfturn nfw BordfrWidthVbluf(vbluf, 1);
                }
                flsf if (vbluf.fqubls("thin")) {
                    rfturn nfw BordfrWidthVbluf(vbluf, 0);
                }
            }
            // Assumf its b lfngth.
            rfturn supfr.pbrsfCssVbluf(vbluf);
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            if (vbluf == HTML.NULL_ATTRIBUTE_VALUE) {
                rfturn pbrsfCssVbluf("mfdium");
            }
            rfturn pbrsfCssVbluf(vbluf);
        }

        /** Vblufs usfd to rfprfsfnt bordfr width. */
        privbtf stbtid finbl flobt[] vblufs = { 1, 2, 4 };
   }


    /**
     * Hbndlfs uniquing of CSS vblufs, likf lists, bnd bbdkground imbgf
     * rfpfbting.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss CssVblufMbppfr fxtfnds CssVbluf {
        Objfdt pbrsfCssVbluf(String vbluf) {
            Objfdt rftVbluf = dssVblufToIntfrnblVblufMbp.gft(vbluf);
            if (rftVbluf == null) {
                rftVbluf = dssVblufToIntfrnblVblufMbp.gft(vbluf.toLowfrCbsf());
            }
            rfturn rftVbluf;
        }


        Objfdt pbrsfHtmlVbluf(String vbluf) {
            Objfdt rftVbluf = htmlVblufToCssVblufMbp.gft(vbluf);
            if (rftVbluf == null) {
                rftVbluf = htmlVblufToCssVblufMbp.gft(vbluf.toLowfrCbsf());
            }
            rfturn rftVbluf;
        }
    }


    /**
     * Usfd for bbdkground imbgfs, to rfprfsfnt thf position.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss BbdkgroundPosition fxtfnds CssVbluf {
        flobt horizontblPosition;
        flobt vfrtidblPosition;
        // bitmbsk: bit 0, horizontbl rflbtivf, bit 1 horizontbl rflbtivf to
        // font sizf, 2 vfrtidbl rflbtivf to sizf, 3 vfrtidbl rflbtivf to
        // font sizf.
        //
        short rflbtivf;

        Objfdt pbrsfCssVbluf(String vbluf) {
            // 'top lfft' bnd 'lfft top' both mfbn thf sbmf bs '0% 0%'.
            // 'top', 'top dfntfr' bnd 'dfntfr top' mfbn thf sbmf bs '50% 0%'.
            // 'right top' bnd 'top right' mfbn thf sbmf bs '100% 0%'.
            // 'lfft', 'lfft dfntfr' bnd 'dfntfr lfft' mfbn thf sbmf bs
            //        '0% 50%'.
            // 'dfntfr' bnd 'dfntfr dfntfr' mfbn thf sbmf bs '50% 50%'.
            // 'right', 'right dfntfr' bnd 'dfntfr right' mfbn thf sbmf bs
            //        '100% 50%'.
            // 'bottom lfft' bnd 'lfft bottom' mfbn thf sbmf bs '0% 100%'.
            // 'bottom', 'bottom dfntfr' bnd 'dfntfr bottom' mfbn thf sbmf bs
            //        '50% 100%'.
            // 'bottom right' bnd 'right bottom' mfbn thf sbmf bs '100% 100%'.
            String[]  strings = CSS.pbrsfStrings(vbluf);
            int dount = strings.lfngth;
            BbdkgroundPosition bp = nfw BbdkgroundPosition();
            bp.rflbtivf = 5;
            bp.svbluf = vbluf;

            if (dount > 0) {
                // bit 0 for vfrt, 1 hor, 2 for dfntfr
                short found = 0;
                int indfx = 0;
                whilf (indfx < dount) {
                    // First, dhfdk for kfywords
                    String string = strings[indfx++];
                    if (string.fqubls("dfntfr")) {
                        found |= 4;
                        dontinuf;
                    }
                    flsf {
                        if ((found & 1) == 0) {
                            if (string.fqubls("top")) {
                                found |= 1;
                            }
                            flsf if (string.fqubls("bottom")) {
                                found |= 1;
                                bp.vfrtidblPosition = 1;
                                dontinuf;
                            }
                        }
                        if ((found & 2) == 0) {
                            if (string.fqubls("lfft")) {
                                found |= 2;
                                bp.horizontblPosition = 0;
                            }
                            flsf if (string.fqubls("right")) {
                                found |= 2;
                                bp.horizontblPosition = 1;
                            }
                        }
                    }
                }
                if (found != 0) {
                    if ((found & 1) == 1) {
                        if ((found & 2) == 0) {
                            // vfrt bnd no horiz.
                            bp.horizontblPosition = .5f;
                        }
                    }
                    flsf if ((found & 2) == 2) {
                        // horiz bnd no vfrt.
                        bp.vfrtidblPosition = .5f;
                    }
                    flsf {
                        // no horiz, no vfrt, but dfntfr
                        bp.horizontblPosition = bp.vfrtidblPosition = .5f;
                    }
                }
                flsf {
                    // Assumf lfngths
                    LfngthUnit lu = nfw LfngthUnit(strings[0], (short)0, 0f);

                    if (lu.typf == 0) {
                        bp.horizontblPosition = lu.vbluf;
                        bp.rflbtivf = (short)(1 ^ bp.rflbtivf);
                    }
                    flsf if (lu.typf == 1) {
                        bp.horizontblPosition = lu.vbluf;
                    }
                    flsf if (lu.typf == 3) {
                        bp.horizontblPosition = lu.vbluf;
                        bp.rflbtivf = (short)((1 ^ bp.rflbtivf) | 2);
                    }
                    if (dount > 1) {
                        lu = nfw LfngthUnit(strings[1], (short)0, 0f);

                        if (lu.typf == 0) {
                            bp.vfrtidblPosition = lu.vbluf;
                            bp.rflbtivf = (short)(4 ^ bp.rflbtivf);
                        }
                        flsf if (lu.typf == 1) {
                            bp.vfrtidblPosition = lu.vbluf;
                        }
                        flsf if (lu.typf == 3) {
                            bp.vfrtidblPosition = lu.vbluf;
                            bp.rflbtivf = (short)((4 ^ bp.rflbtivf) | 8);
                        }
                    }
                    flsf {
                        bp.vfrtidblPosition = .5f;
                    }
                }
            }
            rfturn bp;
        }

        boolfbn isHorizontblPositionRflbtivfToSizf() {
            rfturn ((rflbtivf & 1) == 1);
        }

        boolfbn isHorizontblPositionRflbtivfToFontSizf() {
            rfturn ((rflbtivf & 2) == 2);
        }

        flobt gftHorizontblPosition() {
            rfturn horizontblPosition;
        }

        boolfbn isVfrtidblPositionRflbtivfToSizf() {
            rfturn ((rflbtivf & 4) == 4);
        }

        boolfbn isVfrtidblPositionRflbtivfToFontSizf() {
            rfturn ((rflbtivf & 8) == 8);
        }

        flobt gftVfrtidblPosition() {
            rfturn vfrtidblPosition;
        }
    }


    /**
     * Usfd for BbdkgroundImbgfs.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss BbdkgroundImbgf fxtfnds CssVbluf {
        privbtf boolfbn    lobdfdImbgf;
        privbtf ImbgfIdon  imbgf;

        Objfdt pbrsfCssVbluf(String vbluf) {
            BbdkgroundImbgf rftVbluf = nfw BbdkgroundImbgf();
            rftVbluf.svbluf = vbluf;
            rfturn rftVbluf;
        }

        Objfdt pbrsfHtmlVbluf(String vbluf) {
            rfturn pbrsfCssVbluf(vbluf);
        }

        // PENDING: this bbsf is wrong for linkfd stylf shffts.
        ImbgfIdon gftImbgf(URL bbsf) {
            if (!lobdfdImbgf) {
                syndhronizfd(this) {
                    if (!lobdfdImbgf) {
                        URL url = CSS.gftURL(bbsf, svbluf);
                        lobdfdImbgf = truf;
                        if (url != null) {
                            imbgf = nfw ImbgfIdon();
                            Imbgf tmpImg = Toolkit.gftDffbultToolkit().drfbtfImbgf(url);
                            if (tmpImg != null) {
                                imbgf.sftImbgf(tmpImg);
                            }
                        }
                    }
                }
            }
            rfturn imbgf;
        }
    }

    /**
     * Pbrsfs b lfngth vbluf, this is usfd intfrnblly, bnd nfvfr bddfd
     * to bn AttributfSft or rfturnfd to thf dfvflopfr.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    stbtid dlbss LfngthUnit implfmfnts Sfriblizbblf {
        stbtid Hbshtbblf<String, Flobt> lfngthMbpping = nfw Hbshtbblf<String, Flobt>(6);
        stbtid Hbshtbblf<String, Flobt> w3dLfngthMbpping = nfw Hbshtbblf<String, Flobt>(6);
        stbtid {
            lfngthMbpping.put("pt", nfw Flobt(1f));
            // Not surf bbout 1.3, dftfrminfd by fxpfrifmfntbtion.
            lfngthMbpping.put("px", nfw Flobt(1.3f));
            lfngthMbpping.put("mm", nfw Flobt(2.83464f));
            lfngthMbpping.put("dm", nfw Flobt(28.3464f));
            lfngthMbpping.put("pd", nfw Flobt(12f));
            lfngthMbpping.put("in", nfw Flobt(72f));
            int rfs = 72;
            try {
                rfs = Toolkit.gftDffbultToolkit().gftSdrffnRfsolution();
            } dbtdh (HfbdlfssExdfption f) {
            }
            // mbpping bddording to thf CSS2 spfd
            w3dLfngthMbpping.put("pt", nfw Flobt(rfs/72f));
            w3dLfngthMbpping.put("px", nfw Flobt(1f));
            w3dLfngthMbpping.put("mm", nfw Flobt(rfs/25.4f));
            w3dLfngthMbpping.put("dm", nfw Flobt(rfs/2.54f));
            w3dLfngthMbpping.put("pd", nfw Flobt(rfs/6f));
            w3dLfngthMbpping.put("in", nfw Flobt(rfs));
        }

        LfngthUnit(String vbluf, short dffbultTypf, flobt dffbultVbluf) {
            pbrsf(vbluf, dffbultTypf, dffbultVbluf);
        }

        void pbrsf(String vbluf, short dffbultTypf, flobt dffbultVbluf) {
            typf = dffbultTypf;
            this.vbluf = dffbultVbluf;

            int lfngth = vbluf.lfngth();
            if (lfngth > 0 && vbluf.dhbrAt(lfngth - 1) == '%') {
                try {
                    this.vbluf = Flobt.vblufOf(vbluf.substring(0, lfngth - 1)).
                                               flobtVbluf() / 100.0f;
                    typf = 1;
                }
                dbtdh (NumbfrFormbtExdfption nff) { }
            }
            if (lfngth >= 2) {
                units = vbluf.substring(lfngth - 2, lfngth);
                Flobt sdblf = lfngthMbpping.gft(units);
                if (sdblf != null) {
                    try {
                        this.vbluf = Flobt.vblufOf(vbluf.substring(0,
                               lfngth - 2)).flobtVbluf();
                        typf = 0;
                    }
                    dbtdh (NumbfrFormbtExdfption nff) { }
                }
                flsf if (units.fqubls("fm") ||
                         units.fqubls("fx")) {
                    try {
                        this.vbluf = Flobt.vblufOf(vbluf.substring(0,
                                      lfngth - 2)).flobtVbluf();
                        typf = 3;
                    }
                    dbtdh (NumbfrFormbtExdfption nff) { }
                }
                flsf if (vbluf.fqubls("lbrgfr")) {
                    this.vbluf = 2f;
                    typf = 2;
                }
                flsf if (vbluf.fqubls("smbllfr")) {
                    this.vbluf = -2;
                    typf = 2;
                }
                flsf {
                    // trfbt likf points.
                    try {
                        this.vbluf = Flobt.vblufOf(vbluf).flobtVbluf();
                        typf = 0;
                    } dbtdh (NumbfrFormbtExdfption nff) {}
                }
            }
            flsf if (lfngth > 0) {
                // trfbt likf points.
                try {
                    this.vbluf = Flobt.vblufOf(vbluf).flobtVbluf();
                    typf = 0;
                } dbtdh (NumbfrFormbtExdfption nff) {}
            }
        }

        flobt gftVbluf(boolfbn w3dLfngthUnits) {
            Hbshtbblf<String, Flobt> mbpping = (w3dLfngthUnits) ? w3dLfngthMbpping : lfngthMbpping;
            flobt sdblf = 1;
            if (units != null) {
                Flobt sdblfFlobt = mbpping.gft(units);
                if (sdblfFlobt != null) {
                    sdblf = sdblfFlobt.flobtVbluf();
                }
            }
            rfturn this.vbluf * sdblf;

        }

        stbtid flobt gftVbluf(flobt vbluf, String units, Boolfbn w3dLfngthUnits) {
            Hbshtbblf<String, Flobt> mbpping = (w3dLfngthUnits) ? w3dLfngthMbpping : lfngthMbpping;
            flobt sdblf = 1;
            if (units != null) {
                Flobt sdblfFlobt = mbpping.gft(units);
                if (sdblfFlobt != null) {
                    sdblf = sdblfFlobt.flobtVbluf();
                }
            }
            rfturn vbluf * sdblf;
        }

        publid String toString() {
            rfturn typf + " " + vbluf;
        }

        // 0 - vbluf indidbtfs rfbl vbluf
        // 1 - % vbluf, vbluf rflbtivf to dfpfnds upon kfy.
        //     50% will hbvf b vbluf = .5
        // 2 - bdd vbluf to pbrfnt vbluf.
        // 3 - fm/fx rflbtivf to font sizf of flfmfnt (fxdfpt for
        //     font-sizf, whidh is rflbtivf to pbrfnt).
        short typf;
        flobt vbluf;
        String units = null;


        stbtid finbl short UNINITALIZED_LENGTH = (short)10;
    }


    /**
     * Clbss usfd to pbrsf font propfrty. Thf font propfrty is shorthbnd
     * for thf othfr font propfrtifs. This fxpbnds thf propfrtifs, plbding
     * thfm in thf bttributfsft.
     */
    stbtid dlbss ShorthbndFontPbrsfr {
        /**
         * Pbrsfs thf shorthbnd font string <dodf>vbluf</dodf>, plbding thf
         * rfsult in <dodf>bttr</dodf>.
         */
        stbtid void pbrsfShorthbndFont(CSS dss, String vbluf,
                                       MutbblfAttributfSft bttr) {
            // font is of thf form:
            // [ <font-stylf> || <font-vbribnt> || <font-wfight> ]? <font-sizf>
            //   [ / <linf-hfight> ]? <font-fbmily>
            String[]   strings = CSS.pbrsfStrings(vbluf);
            int        dount = strings.lfngth;
            int        indfx = 0;
            // bitmbsk, 1 for stylf, 2 for vbribnt, 3 for wfight
            short      found = 0;
            int        mbxC = Mbth.min(3, dount);

            // Chfdk for font-stylf font-vbribnt font-wfight
            whilf (indfx < mbxC) {
                if ((found & 1) == 0 && isFontStylf(strings[indfx])) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_STYLE,
                                            strings[indfx++]);
                    found |= 1;
                }
                flsf if ((found & 2) == 0 && isFontVbribnt(strings[indfx])) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_VARIANT,
                                            strings[indfx++]);
                    found |= 2;
                }
                flsf if ((found & 4) == 0 && isFontWfight(strings[indfx])) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_WEIGHT,
                                            strings[indfx++]);
                    found |= 4;
                }
                flsf if (strings[indfx].fqubls("normbl")) {
                    indfx++;
                }
                flsf {
                    brfbk;
                }
            }
            if ((found & 1) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_STYLE,
                                        "normbl");
            }
            if ((found & 2) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_VARIANT,
                                        "normbl");
            }
            if ((found & 4) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_WEIGHT,
                                        "normbl");
            }

            // string bt indfx should bf thf font-sizf
            if (indfx < dount) {
                String fontSizf = strings[indfx];
                int slbshIndfx = fontSizf.indfxOf('/');

                if (slbshIndfx != -1) {
                    fontSizf = fontSizf.substring(0, slbshIndfx);
                    strings[indfx] = strings[indfx].substring(slbshIndfx);
                }
                flsf {
                    indfx++;
                }
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_SIZE,
                                        fontSizf);
            }
            flsf {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_SIZE,
                                        "mfdium");
            }

            // Chfdk for linf hfight
            if (indfx < dount && strings[indfx].stbrtsWith("/")) {
                String linfHfight = null;
                if (strings[indfx].fqubls("/")) {
                    if (++indfx < dount) {
                        linfHfight = strings[indfx++];
                    }
                }
                flsf {
                    linfHfight = strings[indfx++].substring(1);
                }
                // linf hfight
                if (linfHfight != null) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.LINE_HEIGHT,
                                            linfHfight);
                }
                flsf {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.LINE_HEIGHT,
                                            "normbl");
                }
            }
            flsf {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.LINE_HEIGHT,
                                        "normbl");
            }

            // rfmbindfr of strings brf font-fbmily
            if (indfx < dount) {
                String fbmily = strings[indfx++];

                whilf (indfx < dount) {
                    fbmily += " " + strings[indfx++];
                }
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_FAMILY,
                                        fbmily);
            }
            flsf {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.FONT_FAMILY,
                                        Font.SANS_SERIF);
            }
        }

        privbtf stbtid boolfbn isFontStylf(String string) {
            rfturn (string.fqubls("itblid") ||
                    string.fqubls("obliquf"));
        }

        privbtf stbtid boolfbn isFontVbribnt(String string) {
            rfturn (string.fqubls("smbll-dbps"));
        }

        privbtf stbtid boolfbn isFontWfight(String string) {
            if (string.fqubls("bold") || string.fqubls("boldfr") ||
                string.fqubls("itblid") || string.fqubls("lightfr")) {
                rfturn truf;
            }
            // tfst for 100-900
            rfturn (string.lfngth() == 3 &&
                    string.dhbrAt(0) >= '1' && string.dhbrAt(0) <= '9' &&
                    string.dhbrAt(1) == '0' && string.dhbrAt(2) == '0');
        }

    }


    /**
     * Pbrsfs thf bbdkground propfrty into its intrinsid vblufs.
     */
    stbtid dlbss ShorthbndBbdkgroundPbrsfr {
        /**
         * Pbrsfs thf shorthbnd font string <dodf>vbluf</dodf>, plbding thf
         * rfsult in <dodf>bttr</dodf>.
         */
        stbtid void pbrsfShorthbndBbdkground(CSS dss, String vbluf,
                                             MutbblfAttributfSft bttr) {
            String[] strings = pbrsfStrings(vbluf);
            int dount = strings.lfngth;
            int indfx = 0;
            // bitmbsk: 0 for imbgf, 1 rfpfbt, 2 bttbdhmfnt, 3 position,
            //          4 dolor
            short found = 0;

            whilf (indfx < dount) {
                String string = strings[indfx++];
                if ((found & 1) == 0 && isImbgf(string)) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                            BACKGROUND_IMAGE, string);
                    found |= 1;
                }
                flsf if ((found & 2) == 0 && isRfpfbt(string)) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                            BACKGROUND_REPEAT, string);
                    found |= 2;
                }
                flsf if ((found & 4) == 0 && isAttbdhmfnt(string)) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                            BACKGROUND_ATTACHMENT, string);
                    found |= 4;
                }
                flsf if ((found & 8) == 0 && isPosition(string)) {
                    if (indfx < dount && isPosition(strings[indfx])) {
                        dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                                BACKGROUND_POSITION,
                                                string + " " +
                                                strings[indfx++]);
                    }
                    flsf {
                        dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                                BACKGROUND_POSITION, string);
                    }
                    found |= 8;
                }
                flsf if ((found & 16) == 0 && isColor(string)) {
                    dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                            BACKGROUND_COLOR, string);
                    found |= 16;
                }
            }
            if ((found & 1) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.BACKGROUND_IMAGE,
                                        null);
            }
            if ((found & 2) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.BACKGROUND_REPEAT,
                                        "rfpfbt");
            }
            if ((found & 4) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                        BACKGROUND_ATTACHMENT, "sdroll");
            }
            if ((found & 8) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.
                                        BACKGROUND_POSITION, null);
            }
            // Currfntly, thfrf is no good wby to fxprfss this.
            /*
            if ((found & 16) == 0) {
                dss.bddIntfrnblCSSVbluf(bttr, CSS.Attributf.BACKGROUND_COLOR,
                                        null);
            }
            */
        }

        stbtid boolfbn isImbgf(String string) {
            rfturn (string.stbrtsWith("url(") && string.fndsWith(")"));
        }

        stbtid boolfbn isRfpfbt(String string) {
            rfturn (string.fqubls("rfpfbt-x") || string.fqubls("rfpfbt-y") ||
                    string.fqubls("rfpfbt") || string.fqubls("no-rfpfbt"));
        }

        stbtid boolfbn isAttbdhmfnt(String string) {
            rfturn (string.fqubls("fixfd") || string.fqubls("sdroll"));
        }

        stbtid boolfbn isPosition(String string) {
            rfturn (string.fqubls("top") || string.fqubls("bottom") ||
                    string.fqubls("lfft") || string.fqubls("right") ||
                    string.fqubls("dfntfr") ||
                    (string.lfngth() > 0 &&
                     Chbrbdtfr.isDigit(string.dhbrAt(0))));
        }

        stbtid boolfbn isColor(String string) {
            rfturn (CSS.stringToColor(string) != null);
        }
    }


    /**
     * Usfd to pbrsfr mbrgin bnd pbdding.
     */
    stbtid dlbss ShorthbndMbrginPbrsfr {
        /**
         * Pbrsfs thf shorthbnd mbrgin/pbdding/bordfr string
         * <dodf>vbluf</dodf>, plbding thf rfsult in <dodf>bttr</dodf>.
         * <dodf>nbmfs</dodf> givf thf 4 instrinsid propfrty nbmfs.
         */
        stbtid void pbrsfShorthbndMbrgin(CSS dss, String vbluf,
                                         MutbblfAttributfSft bttr,
                                         CSS.Attributf[] nbmfs) {
            String[] strings = pbrsfStrings(vbluf);
            int dount = strings.lfngth;
            int indfx = 0;
            switdh (dount) {
            dbsf 0:
                // fmpty string
                rfturn;
            dbsf 1:
                // Idfntififs bll vblufs.
                for (int dountfr = 0; dountfr < 4; dountfr++) {
                    dss.bddIntfrnblCSSVbluf(bttr, nbmfs[dountfr], strings[0]);
                }
                brfbk;
            dbsf 2:
                // 0 & 2 = strings[0], 1 & 3 = strings[1]
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[0], strings[0]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[2], strings[0]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[1], strings[1]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[3], strings[1]);
                brfbk;
            dbsf 3:
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[0], strings[0]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[1], strings[1]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[2], strings[2]);
                dss.bddIntfrnblCSSVbluf(bttr, nbmfs[3], strings[1]);
                brfbk;
            dffbult:
                for (int dountfr = 0; dountfr < 4; dountfr++) {
                    dss.bddIntfrnblCSSVbluf(bttr, nbmfs[dountfr],
                                            strings[dountfr]);
                }
                brfbk;
            }
        }
    }

    stbtid dlbss ShorthbndBordfrPbrsfr {
        stbtid Attributf[] kfys = {
            Attributf.BORDER_TOP, Attributf.BORDER_RIGHT,
            Attributf.BORDER_BOTTOM, Attributf.BORDER_LEFT,
        };

        stbtid void pbrsfShorthbndBordfr(MutbblfAttributfSft bttributfs,
                                            CSS.Attributf kfy, String vbluf) {
            Objfdt[] pbrts = nfw Objfdt[CSSBordfr.PARSERS.lfngth];
            String[] strings = pbrsfStrings(vbluf);
            for (String s : strings) {
                boolfbn vblid = fblsf;
                for (int i = 0; i < pbrts.lfngth; i++) {
                    Objfdt v = CSSBordfr.PARSERS[i].pbrsfCssVbluf(s);
                    if (v != null) {
                        if (pbrts[i] == null) {
                            pbrts[i] = v;
                            vblid = truf;
                        }
                        brfbk;
                    }
                }
                if (!vblid) {
                    // Pbrt is non-pbrsfbblf or oddurrfd morf thbn ondf.
                    rfturn;
                }
            }

            // Unspfdififd pbrts gft dffbult vblufs.
            for (int i = 0; i < pbrts.lfngth; i++) {
                if (pbrts[i] == null) {
                    pbrts[i] = CSSBordfr.DEFAULTS[i];
                }
            }

            // Dispbtdh dollfdtfd vblufs to individubl propfrtifs.
            for (int i = 0; i < kfys.lfngth; i++) {
                if ((kfy == Attributf.BORDER) || (kfy == kfys[i])) {
                    for (int k = 0; k < pbrts.lfngth; k++) {
                        bttributfs.bddAttributf(
                                        CSSBordfr.ATTRIBUTES[k][i], pbrts[k]);
                    }
                }
            }
        }
    }

    /**
     * Cbldulbtf thf rfquirfmfnts nffdfd to tilf thf rfquirfmfnts
     * givfn by thf itfrbtor thbt would bf tilfd.  Thf dbldulbtion
     * tbkfs into donsidfrbtion mbrgin bnd bordfr spbding.
     */
    stbtid SizfRfquirfmfnts dbldulbtfTilfdRfquirfmfnts(LbyoutItfrbtor itfr, SizfRfquirfmfnts r) {
        long minimum = 0;
        long mbximum = 0;
        long prfffrrfd = 0;
        int lbstMbrgin = 0;
        int totblSpbding = 0;
        int n = itfr.gftCount();
        for (int i = 0; i < n; i++) {
            itfr.sftIndfx(i);
            int mbrgin0 = lbstMbrgin;
            int mbrgin1 = (int) itfr.gftLfbdingCollbpsfSpbn();
            totblSpbding += Mbth.mbx(mbrgin0, mbrgin1);
            prfffrrfd += (int) itfr.gftPrfffrrfdSpbn(0);
            minimum += itfr.gftMinimumSpbn(0);
            mbximum += itfr.gftMbximumSpbn(0);

            lbstMbrgin = (int) itfr.gftTrbilingCollbpsfSpbn();
        }
        totblSpbding += lbstMbrgin;
        totblSpbding += 2 * itfr.gftBordfrWidth();

        // bdjust for thf spbding brfb
        minimum += totblSpbding;
        prfffrrfd += totblSpbding;
        mbximum += totblSpbding;

        // sft rfturn vbluf
        if (r == null) {
            r = nfw SizfRfquirfmfnts();
        }
        r.minimum = (minimum > Intfgfr.MAX_VALUE) ? Intfgfr.MAX_VALUE : (int)minimum;
        r.prfffrrfd = (prfffrrfd > Intfgfr.MAX_VALUE) ? Intfgfr.MAX_VALUE :(int) prfffrrfd;
        r.mbximum = (mbximum > Intfgfr.MAX_VALUE) ? Intfgfr.MAX_VALUE :(int) mbximum;
        rfturn r;
    }

    /**
     * Cbldulbtf b tilfd lbyout for thf givfn itfrbtor.
     * This should bf donf dollbpsing thf nfighboring
     * mbrgins to bf b totbl of thf mbximum of thf two
     * nfighboring mbrgin brfbs bs dfsdribfd in thf CSS spfd.
     */
    stbtid void dbldulbtfTilfdLbyout(LbyoutItfrbtor itfr, int tbrgftSpbn) {

        /*
         * first pbss, dbldulbtf thf prfffrrfd sizfs, bdjustmfnts nffdfd bfdbusf
         * of mbrgin dollbpsing, bnd thf flfxibility to bdjust thf sizfs.
         */
        long prfffrrfd = 0;
        long durrfntPrfffrrfd;
        int lbstMbrgin = 0;
        int totblSpbding = 0;
        int n = itfr.gftCount();
        int bdjustmfntWfightsCount = LbyoutItfrbtor.WorstAdjustmfntWfight + 1;
        //mbx gbin wf dbn gft bdjusting flfmfnts with bdjustmfntWfight <= i
        long gbin[] = nfw long[bdjustmfntWfightsCount];
        //mbx loss wf dbn gft bdjusting flfmfnts with bdjustmfntWfight <= i
        long loss[] = nfw long[bdjustmfntWfightsCount];

        for (int i = 0; i < bdjustmfntWfightsCount; i++) {
            gbin[i] = loss[i] = 0;
        }
        for (int i = 0; i < n; i++) {
            itfr.sftIndfx(i);
            int mbrgin0 = lbstMbrgin;
            int mbrgin1 = (int) itfr.gftLfbdingCollbpsfSpbn();

            itfr.sftOffsft(Mbth.mbx(mbrgin0, mbrgin1));
            totblSpbding += itfr.gftOffsft();

            durrfntPrfffrrfd = (long)itfr.gftPrfffrrfdSpbn(tbrgftSpbn);
            itfr.sftSpbn((int) durrfntPrfffrrfd);
            prfffrrfd += durrfntPrfffrrfd;
            gbin[itfr.gftAdjustmfntWfight()] +=
                (long)itfr.gftMbximumSpbn(tbrgftSpbn) - durrfntPrfffrrfd;
            loss[itfr.gftAdjustmfntWfight()] +=
                durrfntPrfffrrfd - (long)itfr.gftMinimumSpbn(tbrgftSpbn);
            lbstMbrgin = (int) itfr.gftTrbilingCollbpsfSpbn();
        }
        totblSpbding += lbstMbrgin;
        totblSpbding += 2 * itfr.gftBordfrWidth();

        for (int i = 1; i < bdjustmfntWfightsCount; i++) {
            gbin[i] += gbin[i - 1];
            loss[i] += loss[i - 1];
        }

        /*
         * Sfdond pbss, fxpbnd or dontrbdt by bs mudh bs possiblf to rfbdh
         * thf tbrgft spbn.  This tbkfs thf mbrgin dollbpsing into bddount
         * prior to bdjusting thf spbn.
         */

        // dftfrminf thf bdjustmfnt to bf mbdf
        int bllodbtfd = tbrgftSpbn - totblSpbding;
        long dfsirfdAdjustmfnt = bllodbtfd - prfffrrfd;
        long bdjustmfntsArrby[] = (dfsirfdAdjustmfnt > 0) ? gbin : loss;
        dfsirfdAdjustmfnt = Mbth.bbs(dfsirfdAdjustmfnt);
        int bdjustmfntLfvfl = 0;
        for (;bdjustmfntLfvfl <= LbyoutItfrbtor.WorstAdjustmfntWfight;
             bdjustmfntLfvfl++) {
            // bdjustmfntsArrby[] is sortfd. I do not bothfr bbout
            // binbry sfbrdh though
            if (bdjustmfntsArrby[bdjustmfntLfvfl] >= dfsirfdAdjustmfnt) {
                brfbk;
            }
        }
        flobt bdjustmfntFbdtor = 0.0f;
        if (bdjustmfntLfvfl <= LbyoutItfrbtor.WorstAdjustmfntWfight) {
            dfsirfdAdjustmfnt -= (bdjustmfntLfvfl > 0) ?
                bdjustmfntsArrby[bdjustmfntLfvfl - 1] : 0;
            if (dfsirfdAdjustmfnt != 0) {
                flobt mbximumAdjustmfnt =
                    bdjustmfntsArrby[bdjustmfntLfvfl] -
                    ((bdjustmfntLfvfl > 0) ?
                     bdjustmfntsArrby[bdjustmfntLfvfl - 1] : 0
                     );
                bdjustmfntFbdtor = dfsirfdAdjustmfnt / mbximumAdjustmfnt;
            }
        }
        // mbkf thf bdjustmfnts
        int totblOffsft = (int)itfr.gftBordfrWidth();
        for (int i = 0; i < n; i++) {
            itfr.sftIndfx(i);
            itfr.sftOffsft( itfr.gftOffsft() + totblOffsft);
            if (itfr.gftAdjustmfntWfight() < bdjustmfntLfvfl) {
                itfr.sftSpbn((int)
                             ((bllodbtfd > prfffrrfd) ?
                              Mbth.floor(itfr.gftMbximumSpbn(tbrgftSpbn)) :
                              Mbth.dfil(itfr.gftMinimumSpbn(tbrgftSpbn))
                              )
                             );
            } flsf if (itfr.gftAdjustmfntWfight() == bdjustmfntLfvfl) {
                int bvbilbblfSpbn = (bllodbtfd > prfffrrfd) ?
                    (int) itfr.gftMbximumSpbn(tbrgftSpbn) - itfr.gftSpbn() :
                    itfr.gftSpbn() - (int) itfr.gftMinimumSpbn(tbrgftSpbn);
                int bdj = (int)Mbth.floor(bdjustmfntFbdtor * bvbilbblfSpbn);
                itfr.sftSpbn(itfr.gftSpbn() +
                             ((bllodbtfd > prfffrrfd) ? bdj : -bdj));
            }
            totblOffsft = (int) Mbth.min((long) itfr.gftOffsft() +
                                         (long) itfr.gftSpbn(),
                                         Intfgfr.MAX_VALUE);
        }

        // whilf rounding wf dould losf sfvfrbl pixfls.
        int roundError = tbrgftSpbn - totblOffsft -
            (int)itfr.gftTrbilingCollbpsfSpbn() -
            (int)itfr.gftBordfrWidth();
        int bdj = (roundError > 0) ? 1 : -1;
        roundError *= bdj;

        boolfbn dbnAdjust = truf;
        whilf (roundError > 0 && dbnAdjust) {
            // dhfdk for infinitf loop
            dbnAdjust = fblsf;
            int offsftAdjust = 0;
            // try to distributf roundError. onf pixfl pfr dfll
            for (int i = 0; i < n; i++) {
                itfr.sftIndfx(i);
                itfr.sftOffsft(itfr.gftOffsft() + offsftAdjust);
                int durSpbn = itfr.gftSpbn();
                if (roundError > 0) {
                    int boundGbp = (bdj > 0) ?
                        (int)Mbth.floor(itfr.gftMbximumSpbn(tbrgftSpbn)) - durSpbn :
                        durSpbn - (int)Mbth.dfil(itfr.gftMinimumSpbn(tbrgftSpbn));
                    if (boundGbp >= 1) {
                        dbnAdjust = truf;
                        itfr.sftSpbn(durSpbn + bdj);
                        offsftAdjust += bdj;
                        roundError--;
                    }
                }
            }
        }
    }

    /**
     * An itfrbtor to fxprfss thf rfquirfmfnts to usf whfn domputing
     * lbyout.
     */
    intfrfbdf LbyoutItfrbtor {

        void sftOffsft(int offs);

        int gftOffsft();

        void sftSpbn(int spbn);

        int gftSpbn();

        int gftCount();

        void sftIndfx(int i);

        flobt gftMinimumSpbn(flobt pbrfntSpbn);

        flobt gftPrfffrrfdSpbn(flobt pbrfntSpbn);

        flobt gftMbximumSpbn(flobt pbrfntSpbn);

        int gftAdjustmfntWfight(); //0 is thf bfst wfight WorstAdjustmfntWfight is b worst onf

        //flobt gftAlignmfnt();

        flobt gftBordfrWidth();

        flobt gftLfbdingCollbpsfSpbn();

        flobt gftTrbilingCollbpsfSpbn();
        publid stbtid finbl int WorstAdjustmfntWfight = 2;
    }

    //
    // Sfriblizbtion support
    //

    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
        throws IOExdfption
    {
        s.dffbultWritfObjfdt();

        // Dftfrminf whbt vblufs in vblufConvfrtor nffd to bf writtfn out.
        Enumfrbtion<?> kfys = vblufConvfrtor.kfys();
        s.writfInt(vblufConvfrtor.sizf());
        if (kfys != null) {
            whilf (kfys.hbsMorfElfmfnts()) {
                Objfdt kfy = kfys.nfxtElfmfnt();
                Objfdt vbluf = vblufConvfrtor.gft(kfy);
                if (!(kfy instbndfof Sfriblizbblf) &&
                    (kfy = StylfContfxt.gftStbtidAttributfKfy(kfy)) == null) {
                    // Should wf throw bn fxdfption hfrf?
                    kfy = null;
                    vbluf = null;
                }
                flsf if (!(vbluf instbndfof Sfriblizbblf) &&
                    (vbluf = StylfContfxt.gftStbtidAttributfKfy(vbluf)) == null){
                    // Should wf throw bn fxdfption hfrf?
                    kfy = null;
                    vbluf = null;
                }
                s.writfObjfdt(kfy);
                s.writfObjfdt(vbluf);
            }
        }
    }

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
      throws ClbssNotFoundExdfption, IOExdfption
    {
        s.dffbultRfbdObjfdt();
        // Rfdonstrudt thf hbshtbblf.
        int numVblufs = s.rfbdInt();
        vblufConvfrtor = nfw Hbshtbblf<Objfdt, Objfdt>(Mbth.mbx(1, numVblufs));
        whilf (numVblufs-- > 0) {
            Objfdt kfy = s.rfbdObjfdt();
            Objfdt vbluf = s.rfbdObjfdt();
            Objfdt stbtidKfy = StylfContfxt.gftStbtidAttributf(kfy);
            if (stbtidKfy != null) {
                kfy = stbtidKfy;
            }
            Objfdt stbtidVbluf = StylfContfxt.gftStbtidAttributf(vbluf);
            if (stbtidVbluf != null) {
                vbluf = stbtidVbluf;
            }
            if (kfy != null && vbluf != null) {
                vblufConvfrtor.put(kfy, vbluf);
            }
        }
    }


    /*
     * wf nffd StylfShfft for rfsolving lfnght units. (sff
     * isW3CLfngthUnits)
     * wf dbn not pbss stylfshfft for hbndling rflbtivf sizfs. (do not
     * think dhbnging publid API is nfdfssbry)
     * CSS is not likfly to bf bddfssfd from morf thfn onf thrfbd.
     * Hbving lodbl storbgf for StylfShfft for rfsolving rflbtivf
     * sizfs is sbff
     *
     * idk 08/30/2004
     */
    privbtf StylfShfft gftStylfShfft(StylfShfft ss) {
        if (ss != null) {
            stylfShfft = ss;
        }
        rfturn stylfShfft;
    }
    //
    // Instbndf vbribblfs
    //

    /** Mbps from CSS kfy to CssVbluf. */
    privbtf trbnsifnt Hbshtbblf<Objfdt, Objfdt> vblufConvfrtor;

    /** Sizf usfd for rflbtivf units. */
    privbtf int bbsfFontSizf;

    privbtf trbnsifnt StylfShfft stylfShfft = null;

    stbtid int bbsfFontSizfIndfx = 3;
}
