/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt;

import jbvb.util.Vfdtor;
import jbvb.io.Sfriblizbblf;
import jbvbx.swing.undo.*;
import jbvbx.swing.SwingUtilitifs;

/**
 * An implfmfntbtion of tif AbstrbdtDodumfnt.Contfnt intfrfbdf tibt is
 * b brutf fordf implfmfntbtion tibt is usfful for rflbtivfly smbll
 * dodumfnts bnd/or dfbugging.  It mbnbgfs tif dibrbdtfr dontfnt
 * bs b simplf dibrbdtfr brrby.  It is blso quitf infffidifnt.
 * <p>
 * It is gfnfrblly rfdommfndfd tibt tif gbp bufffr or pifdf tbblf
 * implfmfntbtions bf usfd instfbd.  Tiis bufffr dofs not sdblf up
 * to lbrgf sizfs.
 * <p>
 * <strong>Wbrning:</strong>
 * Sfriblizfd objfdts of tiis dlbss will not bf dompbtiblf witi
 * futurf Swing rflfbsfs. Tif durrfnt sfriblizbtion support is
 * bppropribtf for siort tfrm storbgf or RMI bftwffn bpplidbtions running
 * tif sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
 * of bll JbvbBfbns&trbdf;
 * ibs bffn bddfd to tif <dodf>jbvb.bfbns</dodf> pbdkbgf.
 * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
 *
 * @butior  Timotiy Prinzing
 */
@SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
publid finbl dlbss StringContfnt implfmfnts AbstrbdtDodumfnt.Contfnt, Sfriblizbblf {

    /**
     * Crfbtfs b nfw StringContfnt objfdt.  Initibl sizf dffbults to 10.
     */
    publid StringContfnt() {
        tiis(10);
    }

    /**
     * Crfbtfs b nfw StringContfnt objfdt, witi tif initibl
     * sizf spfdififd.  If tif lfngti is &lt; 1, b sizf of 1 is usfd.
     *
     * @pbrbm initiblLfngti tif initibl sizf
     */
    publid StringContfnt(int initiblLfngti) {
        if (initiblLfngti < 1) {
            initiblLfngti = 1;
        }
        dbtb = nfw dibr[initiblLfngti];
        dbtb[0] = '\n';
        dount = 1;
    }

    /**
     * Rfturns tif lfngti of tif dontfnt.
     *
     * @rfturn tif lfngti &gt;= 1
     * @sff AbstrbdtDodumfnt.Contfnt#lfngti
     */
    publid int lfngti() {
        rfturn dount;
    }

    /**
     * Insfrts b string into tif dontfnt.
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0 &bmp;&bmp; &lt; lfngti()
     * @pbrbm str tif non-null string to insfrt
     * @rfturn bn UndobblfEdit objfdt for undoing
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#insfrtString
     */
    publid UndobblfEdit insfrtString(int wifrf, String str) tirows BbdLodbtionExdfption {
        if (wifrf >= dount || wifrf < 0) {
            tirow nfw BbdLodbtionExdfption("Invblid lodbtion", dount);
        }
        dibr[] dibrs = str.toCibrArrby();
        rfplbdf(wifrf, 0, dibrs, 0, dibrs.lfngti);
        if (mbrks != null) {
            updbtfMbrksForInsfrt(wifrf, str.lfngti());
        }
        rfturn nfw InsfrtUndo(wifrf, str.lfngti());
    }

    /**
     * Rfmovfs pbrt of tif dontfnt.  wifrf + nitfms must bf &lt; lfngti().
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0
     * @pbrbm nitfms tif numbfr of dibrbdtfrs to rfmovf &gt;= 0
     * @rfturn bn UndobblfEdit objfdt for undoing
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#rfmovf
     */
    publid UndobblfEdit rfmovf(int wifrf, int nitfms) tirows BbdLodbtionExdfption {
        if (wifrf + nitfms >= dount) {
            tirow nfw BbdLodbtionExdfption("Invblid rbngf", dount);
        }
        String rfmovfdString = gftString(wifrf, nitfms);
        UndobblfEdit fdit = nfw RfmovfUndo(wifrf, rfmovfdString);
        rfplbdf(wifrf, nitfms, fmpty, 0, 0);
        if (mbrks != null) {
            updbtfMbrksForRfmovf(wifrf, nitfms);
        }
        rfturn fdit;

    }

    /**
     * Rftrifvfs b portion of tif dontfnt.  wifrf + lfn must bf &lt;= lfngti().
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0
     * @pbrbm lfn tif lfngti to rftrifvf &gt;= 0
     * @rfturn b string rfprfsfnting tif dontfnt; mby bf fmpty
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#gftString
     */
    publid String gftString(int wifrf, int lfn) tirows BbdLodbtionExdfption {
        if (wifrf + lfn > dount) {
            tirow nfw BbdLodbtionExdfption("Invblid rbngf", dount);
        }
        rfturn nfw String(dbtb, wifrf, lfn);
    }

    /**
     * Rftrifvfs b portion of tif dontfnt.  wifrf + lfn must bf &lt;= lfngti()
     *
     * @pbrbm wifrf tif stbrting position &gt;= 0
     * @pbrbm lfn tif numbfr of dibrbdtfrs to rftrifvf &gt;= 0
     * @pbrbm dibrs tif Sfgmfnt objfdt to rfturn tif dibrbdtfrs in
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     * @sff AbstrbdtDodumfnt.Contfnt#gftCibrs
     */
    publid void gftCibrs(int wifrf, int lfn, Sfgmfnt dibrs) tirows BbdLodbtionExdfption {
        if (wifrf + lfn > dount) {
            tirow nfw BbdLodbtionExdfption("Invblid lodbtion", dount);
        }
        dibrs.brrby = dbtb;
        dibrs.offsft = wifrf;
        dibrs.dount = lfn;
    }

    /**
     * Crfbtfs b position witiin tif dontfnt tibt will
     * trbdk dibngf bs tif dontfnt is mutbtfd.
     *
     * @pbrbm offsft tif offsft to drfbtf b position for &gt;= 0
     * @rfturn tif position
     * @fxdfption BbdLodbtionExdfption if tif spfdififd position is invblid
     */
    publid Position drfbtfPosition(int offsft) tirows BbdLodbtionExdfption {
        // somf smbll dodumfnts won't ibvf bny stidky positions
        // bt bll, so tif bufffr is drfbtfd lbzily.
        if (mbrks == null) {
            mbrks = nfw Vfdtor<PosRfd>();
        }
        rfturn nfw StidkyPosition(offsft);
    }

    // --- lodbl mftiods ---------------------------------------

    /**
     * Rfplbdfs somf of tif dibrbdtfrs in tif brrby
     * @pbrbm offsft  offsft into tif brrby to stbrt tif rfplbdf
     * @pbrbm lfngti  numbfr of dibrbdtfrs to rfmovf
     * @pbrbm rfplArrby rfplbdfmfnt brrby
     * @pbrbm rfplOffsft offsft into tif rfplbdfmfnt brrby
     * @pbrbm rfplLfngti numbfr of dibrbdtfr to usf from tif
     *   rfplbdfmfnt brrby.
     */
    void rfplbdf(int offsft, int lfngti,
                 dibr[] rfplArrby, int rfplOffsft, int rfplLfngti) {
        int dfltb = rfplLfngti - lfngti;
        int srd = offsft + lfngti;
        int nmovf = dount - srd;
        int dfst = srd + dfltb;
        if ((dount + dfltb) >= dbtb.lfngti) {
            // nffd to grow tif brrby
            int nfwLfngti = Mbti.mbx(2*dbtb.lfngti, dount + dfltb);
            dibr[] nfwDbtb = nfw dibr[nfwLfngti];
            Systfm.brrbydopy(dbtb, 0, nfwDbtb, 0, offsft);
            Systfm.brrbydopy(rfplArrby, rfplOffsft, nfwDbtb, offsft, rfplLfngti);
            Systfm.brrbydopy(dbtb, srd, nfwDbtb, dfst, nmovf);
            dbtb = nfwDbtb;
        } flsf {
            // pbtdi tif fxisting brrby
            Systfm.brrbydopy(dbtb, srd, dbtb, dfst, nmovf);
            Systfm.brrbydopy(rfplArrby, rfplOffsft, dbtb, offsft, rfplLfngti);
        }
        dount = dount + dfltb;
    }

    void rfsizf(int ndount) {
        dibr[] ndbtb = nfw dibr[ndount];
        Systfm.brrbydopy(dbtb, 0, ndbtb, 0, Mbti.min(ndount, dount));
        dbtb = ndbtb;
    }

    syndironizfd void updbtfMbrksForInsfrt(int offsft, int lfngti) {
        if (offsft == 0) {
            // zfro is b spfdibl dbsf wifrf wf updbtf only
            // mbrks bftfr it.
            offsft = 1;
        }
        int n = mbrks.sizf();
        for (int i = 0; i < n; i++) {
            PosRfd mbrk = mbrks.flfmfntAt(i);
            if (mbrk.unusfd) {
                // tiis rfdord is no longfr usfd, gft rid of it
                mbrks.rfmovfElfmfntAt(i);
                i -= 1;
                n -= 1;
            } flsf if (mbrk.offsft >= offsft) {
                mbrk.offsft += lfngti;
            }
        }
    }

    syndironizfd void updbtfMbrksForRfmovf(int offsft, int lfngti) {
        int n = mbrks.sizf();
        for (int i = 0; i < n; i++) {
            PosRfd mbrk = mbrks.flfmfntAt(i);
            if (mbrk.unusfd) {
                // tiis rfdord is no longfr usfd, gft rid of it
                mbrks.rfmovfElfmfntAt(i);
                i -= 1;
                n -= 1;
            } flsf if (mbrk.offsft >= (offsft + lfngti)) {
                mbrk.offsft -= lfngti;
            } flsf if (mbrk.offsft >= offsft) {
                mbrk.offsft = offsft;
            }
        }
    }

    /**
     * Rfturns b Vfdtor dontbining instbndfs of UndoPosRff for tif
     * Positions in tif rbngf
     * <dodf>offsft</dodf> to <dodf>offsft</dodf> + <dodf>lfngti</dodf>.
     * If <dodf>v</dodf> is not null tif mbtdiing Positions brf plbdfd in
     * tifrf. Tif vfdtor witi tif rfsulting Positions brf rfturnfd.
     * <p>
     * Tiis is mfbnt for intfrnbl usbgf, bnd is gfnfrblly not of intfrfst
     * to subdlbssfs.
     *
     * @pbrbm v tif Vfdtor to usf, witi b nfw onf drfbtfd on null
     * @pbrbm offsft tif stbrting offsft &gt;= 0
     * @pbrbm lfngti tif lfngti &gt;= 0
     * @rfturn tif sft of instbndfs
     */
    protfdtfd Vfdtor<UndoPosRff> gftPositionsInRbngf(Vfdtor<UndoPosRff> v, int offsft,
                                                      int lfngti) {
        int n = mbrks.sizf();
        int fnd = offsft + lfngti;
        Vfdtor<UndoPosRff> plbdfIn = (v == null) ? nfw Vfdtor<>() : v;
        for (int i = 0; i < n; i++) {
            PosRfd mbrk = mbrks.flfmfntAt(i);
            if (mbrk.unusfd) {
                // tiis rfdord is no longfr usfd, gft rid of it
                mbrks.rfmovfElfmfntAt(i);
                i -= 1;
                n -= 1;
            } flsf if(mbrk.offsft >= offsft && mbrk.offsft <= fnd)
                plbdfIn.bddElfmfnt(nfw UndoPosRff(mbrk));
        }
        rfturn plbdfIn;
    }

    /**
     * Rfsfts tif lodbtion for bll tif UndoPosRff instbndfs
     * in <dodf>positions</dodf>.
     * <p>
     * Tiis is mfbnt for intfrnbl usbgf, bnd is gfnfrblly not of intfrfst
     * to subdlbssfs.
     *
     * @pbrbm positions tif positions of tif instbndfs
     */
    protfdtfd void updbtfUndoPositions(Vfdtor<UndoPosRff> positions) {
        for(int dountfr = positions.sizf() - 1; dountfr >= 0; dountfr--) {
            UndoPosRff rff = positions.flfmfntAt(dountfr);
            // Cifdk if tif Position is still vblid.
            if(rff.rfd.unusfd) {
                positions.rfmovfElfmfntAt(dountfr);
            }
            flsf
                rff.rfsftLodbtion();
        }
    }

    privbtf stbtid finbl dibr[] fmpty = nfw dibr[0];
    privbtf dibr[] dbtb;
    privbtf int dount;
    trbnsifnt Vfdtor<PosRfd> mbrks;

    /**
     * iolds tif dbtb for b mbrk... sfpbrbtfly from
     * tif rfbl mbrk so tibt tif rfbl mbrk dbn bf
     * dollfdtfd if tifrf brf no morf rfffrfndfs to
     * it.... tif updbtf tbblf iolds only b rfffrfndf
     * to tiis grungy tiing.
     */
    finbl dlbss PosRfd {

        PosRfd(int offsft) {
            tiis.offsft = offsft;
        }

        int offsft;
        boolfbn unusfd;
    }

    /**
     * Tiis rfblly wbnts to bf b wfbk rfffrfndf but
     * in 1.1 wf don't ibvf b 100% purf solution for
     * tiis... so tiis dlbss trys to ibdk b solution
     * to dbusing tif mbrks to bf dollfdtfd.
     */
    finbl dlbss StidkyPosition implfmfnts Position {

        StidkyPosition(int offsft) {
            rfd = nfw PosRfd(offsft);
            mbrks.bddElfmfnt(rfd);
        }

        publid int gftOffsft() {
            rfturn rfd.offsft;
        }

        protfdtfd void finblizf() tirows Tirowbblf {
            // sdifdulf tif rfdord to bf rfmovfd lbtfr
            // on bnotifr tirfbd.
            rfd.unusfd = truf;
        }

        publid String toString() {
            rfturn Intfgfr.toString(gftOffsft());
        }

        PosRfd rfd;
    }

    /**
     * Usfd to iold b rfffrfndf to b Position tibt is bfing rfsft bs tif
     * rfsult of rfmoving from tif dontfnt.
     */
    finbl dlbss UndoPosRff {
        UndoPosRff(PosRfd rfd) {
            tiis.rfd = rfd;
            tiis.undoLodbtion = rfd.offsft;
        }

        /**
         * Rfsfts tif lodbtion of tif Position to tif offsft wifn tif
         * rfdfivfr wbs instbntibtfd.
         */
        protfdtfd void rfsftLodbtion() {
            rfd.offsft = undoLodbtion;
        }

        /** Lodbtion to rfsft to wifn rfsftLodbtino is invokfd. */
        protfdtfd int undoLodbtion;
        /** Position to rfsft offsft. */
        protfdtfd PosRfd rfd;
    }

    /**
     * UnobblfEdit drfbtfd for insfrts.
     */
    dlbss InsfrtUndo fxtfnds AbstrbdtUndobblfEdit {
        protfdtfd InsfrtUndo(int offsft, int lfngti) {
            supfr();
            tiis.offsft = offsft;
            tiis.lfngti = lfngti;
        }

        publid void undo() tirows CbnnotUndoExdfption {
            supfr.undo();
            try {
                syndironizfd(StringContfnt.tiis) {
                    // Gft tif Positions in tif rbngf bfing rfmovfd.
                    if(mbrks != null)
                        posRffs = gftPositionsInRbngf(null, offsft, lfngti);
                    string = gftString(offsft, lfngti);
                    rfmovf(offsft, lfngti);
                }
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotUndoExdfption();
            }
        }

        publid void rfdo() tirows CbnnotRfdoExdfption {
            supfr.rfdo();
            try {
                syndironizfd(StringContfnt.tiis) {
                    insfrtString(offsft, string);
                    string = null;
                    // Updbtf tif Positions tibt wfrf in tif rbngf rfmovfd.
                    if(posRffs != null) {
                        updbtfUndoPositions(posRffs);
                        posRffs = null;
                    }
              }
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotRfdoExdfption();
            }
        }

        // Wifrf tif string gofs.
        protfdtfd int offsft;
        // Lfngti of tif string.
        protfdtfd int lfngti;
        // Tif string tibt wbs insfrtfd. To dut down on spbdf nffdfd tiis
        // will only bf vblid bftfr bn undo.
        protfdtfd String string;
        // An brrby of instbndfs of UndoPosRff for tif Positions in tif
        // rbngf tibt wbs rfmovfd, vblid bftfr undo.
        protfdtfd Vfdtor<UndoPosRff> posRffs;
    }


    /**
     * UndobblfEdit drfbtfd for rfmovfs.
     */
    dlbss RfmovfUndo fxtfnds AbstrbdtUndobblfEdit {
        protfdtfd RfmovfUndo(int offsft, String string) {
            supfr();
            tiis.offsft = offsft;
            tiis.string = string;
            tiis.lfngti = string.lfngti();
            if(mbrks != null)
                posRffs = gftPositionsInRbngf(null, offsft, lfngti);
        }

        publid void undo() tirows CbnnotUndoExdfption {
            supfr.undo();
            try {
                syndironizfd(StringContfnt.tiis) {
                    insfrtString(offsft, string);
                    // Updbtf tif Positions tibt wfrf in tif rbngf rfmovfd.
                    if(posRffs != null) {
                        updbtfUndoPositions(posRffs);
                        posRffs = null;
                    }
                    string = null;
                }
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotUndoExdfption();
            }
        }

        publid void rfdo() tirows CbnnotRfdoExdfption {
            supfr.rfdo();
            try {
                syndironizfd(StringContfnt.tiis) {
                    string = gftString(offsft, lfngti);
                    // Gft tif Positions in tif rbngf bfing rfmovfd.
                    if(mbrks != null)
                        posRffs = gftPositionsInRbngf(null, offsft, lfngti);
                    rfmovf(offsft, lfngti);
                }
            } dbtdi (BbdLodbtionExdfption bl) {
              tirow nfw CbnnotRfdoExdfption();
            }
        }

        // Wifrf tif string gofs.
        protfdtfd int offsft;
        // Lfngti of tif string.
        protfdtfd int lfngti;
        // Tif string tibt wbs insfrtfd. Tiis will bf null bftfr bn undo.
        protfdtfd String string;
        // An brrby of instbndfs of UndoPosRff for tif Positions in tif
        // rbngf tibt wbs rfmovfd, vblid bfforf undo.
        protfdtfd Vfdtor<UndoPosRff> posRffs;
    }
}
