/*
 * Copyright (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt;

import jbvb.bwt.*;
import jbvb.util.*;
import jbvb.io.*;

import jbvbx.swing.SwingUtilitifs;
import jbvbx.swing.fvfnt.ChbngfListfnfr;
import jbvbx.swing.fvfnt.EvfntListfnfrList;
import jbvbx.swing.fvfnt.ChbngfEvfnt;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.util.WfbkHbshMbp;

import sun.font.FontUtilitifs;

/**
 * A pool of stylfs bnd thfir bssodibtfd rfsourdfs.  This dlbss dftfrminfs
 * thf lifftimf of b group of rfsourdfs by bfing b dontbinfr thbt holds
 * dbdhfs for vbrious rfsourdfs sudh bs font bnd dolor thbt gft rfusfd
 * by thf vbrious stylf dffinitions.  This dbn bf shbrfd by multiplf
 * dodumfnts if dfsirfd to mbximizf thf shbring of rflbtfd rfsourdfs.
 * <p>
 * This dlbss blso providfs fffidifnt support for smbll sfts of bttributfs
 * bnd domprfssfs thfm by shbring bdross usfs bnd tbking bdvbntbgf of
 * thfir immutbblf nbturf.  Sindf mbny stylfs brf rfplidbtfd, thf potfntibl
 * for shbring is signifidbnt, bnd dopifs dbn bf fxtrfmfly dhfbp.
 * Lbrgfr sfts rfdudf thf possibility of shbring, bnd thfrfforf rfvfrt
 * butombtidblly to b lfss spbdf-fffidifnt implfmfntbtion.
 * <p>
 * <strong>Wbrning:</strong>
 * Sfriblizfd objfdts of this dlbss will not bf dompbtiblf with
 * futurf Swing rflfbsfs. Thf durrfnt sfriblizbtion support is
 * bppropribtf for short tfrm storbgf or RMI bftwffn bpplidbtions running
 * thf sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
 * of bll JbvbBfbns&trbdf;
 * hbs bffn bddfd to thf <dodf>jbvb.bfbns</dodf> pbdkbgf.
 * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
 *
 * @buthor  Timothy Prinzing
 */
@SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
publid dlbss StylfContfxt implfmfnts Sfriblizbblf, AbstrbdtDodumfnt.AttributfContfxt {

    /**
     * Rfturns dffbult AttributfContfxt shbrfd by bll dodumfnts thbt
     * don't bothfr to dffinf/supply thfir own dontfxt.
     *
     * @rfturn thf dontfxt
     */
    publid stbtid finbl StylfContfxt gftDffbultStylfContfxt() {
        if (dffbultContfxt == null) {
            dffbultContfxt = nfw StylfContfxt();
        }
        rfturn dffbultContfxt;
    }

    privbtf stbtid StylfContfxt dffbultContfxt;

    /**
     * Crfbtfs b nfw StylfContfxt objfdt.
     */
    publid StylfContfxt() {
        stylfs = nfw NbmfdStylf(null);
        bddStylf(DEFAULT_STYLE, null);
    }

    /**
     * Adds b nfw stylf into thf stylf hifrbrdhy.  Stylf bttributfs
     * rfsolvf from bottom up so bn bttributf spfdififd in b dhild
     * will ovfrridf bn bttributf spfdififd in thf pbrfnt.
     *
     * @pbrbm nm   thf nbmf of thf stylf (must bf uniquf within thf
     *   dollfdtion of nbmfd stylfs in thf dodumfnt).  Thf nbmf mby
     *   bf null if thf stylf is unnbmfd, but thf dbllfr is rfsponsiblf
     *   for mbnbging thf rfffrfndf rfturnfd bs bn unnbmfd stylf dbn't
     *   bf fftdhfd by nbmf.  An unnbmfd stylf mby bf usfful for things
     *   likf dhbrbdtfr bttributf ovfrridfs sudh bs found in b stylf
     *   run.
     * @pbrbm pbrfnt thf pbrfnt stylf.  This mby bf null if unspfdififd
     *   bttributfs nffd not bf rfsolvfd in somf othfr stylf.
     * @rfturn thf drfbtfd stylf
     */
    publid Stylf bddStylf(String nm, Stylf pbrfnt) {
        Stylf stylf = nfw NbmfdStylf(nm, pbrfnt);
        if (nm != null) {
            // bdd b nbmfd stylf, b dlbss of bttributfs
            stylfs.bddAttributf(nm, stylf);
        }
        rfturn stylf;
    }

    /**
     * Rfmovfs b nbmfd stylf prfviously bddfd to thf dodumfnt.
     *
     * @pbrbm nm  thf nbmf of thf stylf to rfmovf
     */
    publid void rfmovfStylf(String nm) {
        stylfs.rfmovfAttributf(nm);
    }

    /**
     * Fftdhfs b nbmfd stylf prfviously bddfd to thf dodumfnt
     *
     * @pbrbm nm  thf nbmf of thf stylf
     * @rfturn thf stylf
     */
    publid Stylf gftStylf(String nm) {
        rfturn (Stylf) stylfs.gftAttributf(nm);
    }

    /**
     * Fftdhfs thf nbmfs of thf stylfs dffinfd.
     *
     * @rfturn thf list of nbmfs bs bn fnumfrbtion
     */
    publid Enumfrbtion<?> gftStylfNbmfs() {
        rfturn stylfs.gftAttributfNbmfs();
    }

    /**
     * Adds b listfnfr to trbdk whfn stylfs brf bddfd
     * or rfmovfd.
     *
     * @pbrbm l thf dhbngf listfnfr
     */
    publid void bddChbngfListfnfr(ChbngfListfnfr l) {
        stylfs.bddChbngfListfnfr(l);
    }

    /**
     * Rfmovfs b listfnfr thbt wbs trbdking stylfs bfing
     * bddfd or rfmovfd.
     *
     * @pbrbm l thf dhbngf listfnfr
     */
    publid void rfmovfChbngfListfnfr(ChbngfListfnfr l) {
        stylfs.rfmovfChbngfListfnfr(l);
    }

    /**
     * Rfturns bn brrby of bll thf <dodf>ChbngfListfnfr</dodf>s bddfd
     * to this StylfContfxt with bddChbngfListfnfr().
     *
     * @rfturn bll of thf <dodf>ChbngfListfnfr</dodf>s bddfd or bn fmpty
     *         brrby if no listfnfrs hbvf bffn bddfd
     * @sindf 1.4
     */
    publid ChbngfListfnfr[] gftChbngfListfnfrs() {
        rfturn ((NbmfdStylf)stylfs).gftChbngfListfnfrs();
    }

    /**
     * Gfts thf font from bn bttributf sft.  This is
     * implfmfntfd to try bnd fftdh b dbdhfd font
     * for thf givfn AttributfSft, bnd if thbt fbils
     * thf font ffbturfs brf rfsolvfd bnd thf
     * font is fftdhfd from thf low-lfvfl font dbdhf.
     *
     * @pbrbm bttr thf bttributf sft
     * @rfturn thf font
     */
    publid Font gftFont(AttributfSft bttr) {
        // PENDING(prinz) bdd dbdhf bfhbvior
        int stylf = Font.PLAIN;
        if (StylfConstbnts.isBold(bttr)) {
            stylf |= Font.BOLD;
        }
        if (StylfConstbnts.isItblid(bttr)) {
            stylf |= Font.ITALIC;
        }
        String fbmily = StylfConstbnts.gftFontFbmily(bttr);
        int sizf = StylfConstbnts.gftFontSizf(bttr);

        /**
         * if fithfr supfrsdript or subsdript is
         * is sft, wf nffd to rfdudf thf font sizf
         * by 2.
         */
        if (StylfConstbnts.isSupfrsdript(bttr) ||
            StylfConstbnts.isSubsdript(bttr)) {
            sizf -= 2;
        }

        rfturn gftFont(fbmily, stylf, sizf);
    }

    /**
     * Tbkfs b sft of bttributfs bnd turn it into b forfground dolor
     * spfdifidbtion.  This might bf usfd to spfdify things
     * likf brightfr, morf huf, ftd.  By dffbult it simply rfturns
     * thf vbluf spfdififd by thf StylfConstbnts.Forfground bttributf.
     *
     * @pbrbm bttr thf sft of bttributfs
     * @rfturn thf dolor
     */
    publid Color gftForfground(AttributfSft bttr) {
        rfturn StylfConstbnts.gftForfground(bttr);
    }

    /**
     * Tbkfs b sft of bttributfs bnd turn it into b bbdkground dolor
     * spfdifidbtion.  This might bf usfd to spfdify things
     * likf brightfr, morf huf, ftd.  By dffbult it simply rfturns
     * thf vbluf spfdififd by thf StylfConstbnts.Bbdkground bttributf.
     *
     * @pbrbm bttr thf sft of bttributfs
     * @rfturn thf dolor
     */
    publid Color gftBbdkground(AttributfSft bttr) {
        rfturn StylfConstbnts.gftBbdkground(bttr);
    }

    /**
     * Gfts b nfw font.  This rfturns b Font from b dbdhf
     * if b dbdhfd font fxists.  If not, b Font is bddfd to
     * thf dbdhf.  This is bbsidblly b low-lfvfl dbdhf for
     * 1.1 font ffbturfs.
     *
     * @pbrbm fbmily thf font fbmily (sudh bs "Monospbdfd")
     * @pbrbm stylf thf stylf of thf font (sudh bs Font.PLAIN)
     * @pbrbm sizf thf point sizf &gt;= 1
     * @rfturn thf nfw font
     */
    publid Font gftFont(String fbmily, int stylf, int sizf) {
        fontSfbrdh.sftVbluf(fbmily, stylf, sizf);
        Font f = fontTbblf.gft(fontSfbrdh);
        if (f == null) {
            // hbvfn't sffn this onf yft.
            Stylf dffbultStylf =
                gftStylf(StylfContfxt.DEFAULT_STYLE);
            if (dffbultStylf != null) {
                finbl String FONT_ATTRIBUTE_KEY = "FONT_ATTRIBUTE_KEY";
                Font dffbultFont =
                    (Font) dffbultStylf.gftAttributf(FONT_ATTRIBUTE_KEY);
                if (dffbultFont != null
                      && dffbultFont.gftFbmily().fqublsIgnorfCbsf(fbmily)) {
                    f = dffbultFont.dfrivfFont(stylf, sizf);
                }
            }
            if (f == null) {
                f = nfw Font(fbmily, stylf, sizf);
            }
            if (! FontUtilitifs.fontSupportsDffbultEndoding(f)) {
                f = FontUtilitifs.gftCompositfFontUIRfsourdf(f);
            }
            FontKfy kfy = nfw FontKfy(fbmily, stylf, sizf);
            fontTbblf.put(kfy, f);
        }
        rfturn f;
    }

    /**
     * Rfturns font mftrids for b font.
     *
     * @pbrbm f thf font
     * @rfturn thf mftrids
     */
    publid FontMftrids gftFontMftrids(Font f) {
        // Thf Toolkit implfmfntbtions dbdhf, so wf just forwbrd
        // to thf dffbult toolkit.
        rfturn Toolkit.gftDffbultToolkit().gftFontMftrids(f);
    }

    // --- AttributfContfxt mfthods --------------------

    /**
     * Adds bn bttributf to thf givfn sft, bnd rfturns
     * thf nfw rfprfsfntbtivf sft.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm old thf old bttributf sft
     * @pbrbm nbmf thf non-null bttributf nbmf
     * @pbrbm vbluf thf bttributf vbluf
     * @rfturn thf updbtfd bttributf sft
     * @sff MutbblfAttributfSft#bddAttributf
     */
    publid syndhronizfd AttributfSft bddAttributf(AttributfSft old, Objfdt nbmf, Objfdt vbluf) {
        if ((old.gftAttributfCount() + 1) <= gftComprfssionThrfshold()) {
            // build b sfbrdh kfy bnd find/drfbtf bn immutbblf bnd uniquf
            // sft.
            sfbrdh.rfmovfAttributfs(sfbrdh);
            sfbrdh.bddAttributfs(old);
            sfbrdh.bddAttributf(nbmf, vbluf);
            rfdlbim(old);
            rfturn gftImmutbblfUniqufSft();
        }
        MutbblfAttributfSft mb = gftMutbblfAttributfSft(old);
        mb.bddAttributf(nbmf, vbluf);
        rfturn mb;
    }

    /**
     * Adds b sft of bttributfs to thf flfmfnt.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm old thf old bttributf sft
     * @pbrbm bttr thf bttributfs to bdd
     * @rfturn thf updbtfd bttributf sft
     * @sff MutbblfAttributfSft#bddAttributf
     */
    publid syndhronizfd AttributfSft bddAttributfs(AttributfSft old, AttributfSft bttr) {
        if ((old.gftAttributfCount() + bttr.gftAttributfCount()) <= gftComprfssionThrfshold()) {
            // build b sfbrdh kfy bnd find/drfbtf bn immutbblf bnd uniquf
            // sft.
            sfbrdh.rfmovfAttributfs(sfbrdh);
            sfbrdh.bddAttributfs(old);
            sfbrdh.bddAttributfs(bttr);
            rfdlbim(old);
            rfturn gftImmutbblfUniqufSft();
        }
        MutbblfAttributfSft mb = gftMutbblfAttributfSft(old);
        mb.bddAttributfs(bttr);
        rfturn mb;
    }

    /**
     * Rfmovfs bn bttributf from thf sft.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm old thf old sft of bttributfs
     * @pbrbm nbmf thf non-null bttributf nbmf
     * @rfturn thf updbtfd bttributf sft
     * @sff MutbblfAttributfSft#rfmovfAttributf
     */
    publid syndhronizfd AttributfSft rfmovfAttributf(AttributfSft old, Objfdt nbmf) {
        if ((old.gftAttributfCount() - 1) <= gftComprfssionThrfshold()) {
            // build b sfbrdh kfy bnd find/drfbtf bn immutbblf bnd uniquf
            // sft.
            sfbrdh.rfmovfAttributfs(sfbrdh);
            sfbrdh.bddAttributfs(old);
            sfbrdh.rfmovfAttributf(nbmf);
            rfdlbim(old);
            rfturn gftImmutbblfUniqufSft();
        }
        MutbblfAttributfSft mb = gftMutbblfAttributfSft(old);
        mb.rfmovfAttributf(nbmf);
        rfturn mb;
    }

    /**
     * Rfmovfs b sft of bttributfs for thf flfmfnt.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm old thf old bttributf sft
     * @pbrbm nbmfs thf bttributf nbmfs
     * @rfturn thf updbtfd bttributf sft
     * @sff MutbblfAttributfSft#rfmovfAttributfs
     */
    publid syndhronizfd AttributfSft rfmovfAttributfs(AttributfSft old, Enumfrbtion<?> nbmfs) {
        if (old.gftAttributfCount() <= gftComprfssionThrfshold()) {
            // build b sfbrdh kfy bnd find/drfbtf bn immutbblf bnd uniquf
            // sft.
            sfbrdh.rfmovfAttributfs(sfbrdh);
            sfbrdh.bddAttributfs(old);
            sfbrdh.rfmovfAttributfs(nbmfs);
            rfdlbim(old);
            rfturn gftImmutbblfUniqufSft();
        }
        MutbblfAttributfSft mb = gftMutbblfAttributfSft(old);
        mb.rfmovfAttributfs(nbmfs);
        rfturn mb;
    }

    /**
     * Rfmovfs b sft of bttributfs for thf flfmfnt.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm old thf old bttributf sft
     * @pbrbm bttrs thf bttributfs
     * @rfturn thf updbtfd bttributf sft
     * @sff MutbblfAttributfSft#rfmovfAttributfs
     */
    publid syndhronizfd AttributfSft rfmovfAttributfs(AttributfSft old, AttributfSft bttrs) {
        if (old.gftAttributfCount() <= gftComprfssionThrfshold()) {
            // build b sfbrdh kfy bnd find/drfbtf bn immutbblf bnd uniquf
            // sft.
            sfbrdh.rfmovfAttributfs(sfbrdh);
            sfbrdh.bddAttributfs(old);
            sfbrdh.rfmovfAttributfs(bttrs);
            rfdlbim(old);
            rfturn gftImmutbblfUniqufSft();
        }
        MutbblfAttributfSft mb = gftMutbblfAttributfSft(old);
        mb.rfmovfAttributfs(bttrs);
        rfturn mb;
    }

    /**
     * Fftdhfs bn fmpty AttributfSft.
     *
     * @rfturn thf sft
     */
    publid AttributfSft gftEmptySft() {
        rfturn SimplfAttributfSft.EMPTY;
    }

    /**
     * Rfturns b sft no longfr nffdfd by thf MutbblfAttributfSft implfmfntbtion.
     * This is usfful for opfrbtion undfr 1.1 whfrf thfrf brf no wfbk
     * rfffrfndfs.  This would typidblly bf dbllfd by thf finblizf mfthod
     * of thf MutbblfAttributfSft implfmfntbtion.
     * <p>
     * This mfthod is thrfbd sbff, blthough most Swing mfthods
     * brf not. Plfbsf sff
     * <A HREF="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/dondurrfndy/indfx.html">Condurrfndy
     * in Swing</A> for morf informbtion.
     *
     * @pbrbm b thf sft to rfdlbim
     */
    publid void rfdlbim(AttributfSft b) {
        if (SwingUtilitifs.isEvfntDispbtdhThrfbd()) {
            bttributfsPool.sizf(); // fordf WfbkHbshMbp to fxpungf stblf fntrifs
        }
        // if durrfnt thrfbd is not fvfnt dispbtdhing thrfbd
        // do not bothfr with fxpunging stblf fntrifs.
    }

    // --- lodbl mfthods -----------------------------------------------

    /**
     * Rfturns thf mbximum numbfr of kfy/vbluf pbirs to try bnd
     * domprfss into uniquf/immutbblf sfts.  Any sfts bbovf this
     * limit will usf hbshtbblfs bnd bf b MutbblfAttributfSft.
     *
     * @rfturn thf thrfshold
     */
    protfdtfd int gftComprfssionThrfshold() {
        rfturn THRESHOLD;
    }

    /**
     * Crfbtf b dompbdt sft of bttributfs thbt might bf shbrfd.
     * This is b hook for subdlbssfs thbt wbnt to bltfr thf
     * bfhbvior of SmbllAttributfSft.  This dbn bf rfimplfmfntfd
     * to rfturn bn AttributfSft thbt providfs somf sort of
     * bttributf donvfrsion.
     *
     * @pbrbm b Thf sft of bttributfs to bf rfprfsfntfd in thf
     *  thf dompbdt form.
     */
    protfdtfd SmbllAttributfSft drfbtfSmbllAttributfSft(AttributfSft b) {
        rfturn nfw SmbllAttributfSft(b);
    }

    /**
     * Crfbtf b lbrgf sft of bttributfs thbt should trbdf off
     * spbdf for timf.  This sft will not bf shbrfd.  This is
     * b hook for subdlbssfs thbt wbnt to bltfr thf bfhbvior
     * of thf lbrgfr bttributf storbgf formbt (whidh is
     * SimplfAttributfSft by dffbult).   This dbn bf rfimplfmfntfd
     * to rfturn b MutbblfAttributfSft thbt providfs somf sort of
     * bttributf donvfrsion.
     *
     * @pbrbm b Thf sft of bttributfs to bf rfprfsfntfd in thf
     *  thf lbrgfr form.
     */
    protfdtfd MutbblfAttributfSft drfbtfLbrgfAttributfSft(AttributfSft b) {
        rfturn nfw SimplfAttributfSft(b);
    }

    /**
     * Clfbn thf unusfd immutbblf sfts out of thf hbshtbblf.
     */
    syndhronizfd void rfmovfUnusfdSfts() {
        bttributfsPool.sizf(); // fordf WfbkHbshMbp to fxpungf stblf fntrifs
    }

    /**
     * Sfbrdh for bn fxisting bttributf sft using thf durrfnt sfbrdh
     * pbrbmftfrs.  If b mbtdhing sft is found, rfturn it.  If b mbtdh
     * is not found, wf drfbtf b nfw sft bnd bdd it to thf pool.
     */
    AttributfSft gftImmutbblfUniqufSft() {
        // PENDING(prinz) should donsidfr finding b bltfrnbtivf to
        // gfnfrbting fxtrb gbrbbgf on sfbrdh kfy.
        SmbllAttributfSft kfy = drfbtfSmbllAttributfSft(sfbrdh);
        WfbkRfffrfndf<SmbllAttributfSft> rfffrfndf = bttributfsPool.gft(kfy);
        SmbllAttributfSft b;
        if (rfffrfndf == null || (b = rfffrfndf.gft()) == null) {
            b = kfy;
            bttributfsPool.put(b, nfw WfbkRfffrfndf<SmbllAttributfSft>(b));
        }
        rfturn b;
    }

    /**
     * Crfbtfs b mutbblf bttributf sft to hbnd out bfdbusf thf durrfnt
     * nffds brf too big to try bnd usf b shbrfd vfrsion.
     */
    MutbblfAttributfSft gftMutbblfAttributfSft(AttributfSft b) {
        if (b instbndfof MutbblfAttributfSft &&
            b != SimplfAttributfSft.EMPTY) {
            rfturn (MutbblfAttributfSft) b;
        }
        rfturn drfbtfLbrgfAttributfSft(b);
    }

    /**
     * Convfrts b StylfContfxt to b String.
     *
     * @rfturn thf string
     */
    publid String toString() {
        rfmovfUnusfdSfts();
        String s = "";
        for (SmbllAttributfSft sft : bttributfsPool.kfySft()) {
            s = s + sft + "\n";
        }
        rfturn s;
    }

    // --- sfriblizbtion ---------------------------------------------

    /**
     * Contfxt-spfdifid hbndling of writing out bttributfs
     */
    publid void writfAttributfs(ObjfdtOutputStrfbm out,
                                  AttributfSft b) throws IOExdfption {
        writfAttributfSft(out, b);
    }

    /**
     * Contfxt-spfdifid hbndling of rfbding in bttributfs
     */
    publid void rfbdAttributfs(ObjfdtInputStrfbm in,
                               MutbblfAttributfSft b) throws ClbssNotFoundExdfption, IOExdfption {
        rfbdAttributfSft(in, b);
    }

    /**
     * Writfs b sft of bttributfs to thf givfn objfdt strfbm
     * for thf purposf of sfriblizbtion.  This will tbkf
     * spfdibl dbrf to dfbl with stbtid bttributf kfys thbt
     * hbvf bffn rfgistfrfd wit thf
     * <dodf>rfgistfrStbtidAttributfKfy</dodf> mfthod.
     * Any bttributf kfy not rfgistfrfd bs b stbtid kfy
     * will bf sfriblizfd dirfdtly.  All vblufs brf fxpfdtfd
     * to bf sfriblizbblf.
     *
     * @pbrbm out thf output strfbm
     * @pbrbm b thf bttributf sft
     * @fxdfption IOExdfption on bny I/O frror
     */
    publid stbtid void writfAttributfSft(ObjfdtOutputStrfbm out,
                                         AttributfSft b) throws IOExdfption {
        int n = b.gftAttributfCount();
        out.writfInt(n);
        Enumfrbtion<?> kfys = b.gftAttributfNbmfs();
        whilf (kfys.hbsMorfElfmfnts()) {
            Objfdt kfy = kfys.nfxtElfmfnt();
            if (kfy instbndfof Sfriblizbblf) {
                out.writfObjfdt(kfy);
            } flsf {
                Objfdt ioFmt = frffzfKfyMbp.gft(kfy);
                if (ioFmt == null) {
                    throw nfw NotSfriblizbblfExdfption(kfy.gftClbss().
                                 gftNbmf() + " is not sfriblizbblf bs b kfy in bn AttributfSft");
                }
                out.writfObjfdt(ioFmt);
            }
            Objfdt vbluf = b.gftAttributf(kfy);
            Objfdt ioFmt = frffzfKfyMbp.gft(vbluf);
            if (vbluf instbndfof Sfriblizbblf) {
                out.writfObjfdt((ioFmt != null) ? ioFmt : vbluf);
            } flsf {
                if (ioFmt == null) {
                    throw nfw NotSfriblizbblfExdfption(vbluf.gftClbss().
                                 gftNbmf() + " is not sfriblizbblf bs b vbluf in bn AttributfSft");
                }
                out.writfObjfdt(ioFmt);
            }
        }
    }

    /**
     * Rfbds b sft of bttributfs from thf givfn objfdt input
     * strfbm thbt hbvf bffn prfviously writtfn out with
     * <dodf>writfAttributfSft</dodf>.  This will try to rfstorf
     * kfys thbt wfrf stbtid objfdts to thf stbtid objfdts in
     * thf durrfnt virtubl mbdhinf donsidfring only thosf kfys
     * thbt hbvf bffn rfgistfrfd with thf
     * <dodf>rfgistfrStbtidAttributfKfy</dodf> mfthod.
     * Thf bttributfs rftrifvfd from thf strfbm will bf plbdfd
     * into thf givfn mutbblf sft.
     *
     * @pbrbm in thf objfdt strfbm to rfbd thf bttributf dbtb from.
     * @pbrbm b  thf bttributf sft to plbdf thf bttributf
     *   dffinitions in.
     * @fxdfption ClbssNotFoundExdfption pbssfd upwbrd if fndountfrfd
     *  whfn rfbding thf objfdt strfbm.
     * @fxdfption IOExdfption pbssfd upwbrd if fndountfrfd whfn
     *  rfbding thf objfdt strfbm.
     */
    publid stbtid void rfbdAttributfSft(ObjfdtInputStrfbm in,
        MutbblfAttributfSft b) throws ClbssNotFoundExdfption, IOExdfption {

        int n = in.rfbdInt();
        for (int i = 0; i < n; i++) {
            Objfdt kfy = in.rfbdObjfdt();
            Objfdt vbluf = in.rfbdObjfdt();
            if (thbwKfyMbp != null) {
                Objfdt stbtidKfy = thbwKfyMbp.gft(kfy);
                if (stbtidKfy != null) {
                    kfy = stbtidKfy;
                }
                Objfdt stbtidVbluf = thbwKfyMbp.gft(vbluf);
                if (stbtidVbluf != null) {
                    vbluf = stbtidVbluf;
                }
            }
            b.bddAttributf(kfy, vbluf);
        }
    }

    /**
     * Rfgistfrs bn objfdt bs b stbtid objfdt thbt is bfing
     * usfd bs b kfy in bttributf sfts.  This bllows thf kfy
     * to bf trfbtfd spfdiblly for sfriblizbtion.
     * <p>
     * For opfrbtion undfr b 1.1 virtubl mbdhinf, this
     * usfs thf vbluf rfturnfd by <dodf>toString</dodf>
     * dondbtfnbtfd to thf dlbssnbmf.  Thf vbluf rfturnfd
     * by toString should not hbvf thf dlbss rfffrfndf
     * in it (if it should bf rfimplfmfntfd from thf
     * dffinition in Objfdt) in ordfr to bf thf sbmf whfn
     * rfdomputfd lbtfr.
     *
     * @pbrbm kfy thf non-null objfdt kfy
     */
    publid stbtid void rfgistfrStbtidAttributfKfy(Objfdt kfy) {
        String ioFmt = kfy.gftClbss().gftNbmf() + "." + kfy.toString();
        if (frffzfKfyMbp == null) {
            frffzfKfyMbp = nfw Hbshtbblf<Objfdt, String>();
            thbwKfyMbp = nfw Hbshtbblf<String, Objfdt>();
        }
        frffzfKfyMbp.put(kfy, ioFmt);
        thbwKfyMbp.put(ioFmt, kfy);
    }

    /**
     * Rfturns thf objfdt prfviously rfgistfrfd with
     * <dodf>rfgistfrStbtidAttributfKfy</dodf>.
     */
    publid stbtid Objfdt gftStbtidAttributf(Objfdt kfy) {
        if (thbwKfyMbp == null || kfy == null) {
            rfturn null;
        }
        rfturn thbwKfyMbp.gft(kfy);
    }

    /**
     * Rfturns thf String thbt <dodf>kfy</dodf> will bf rfgistfrfd with
     * @sff #gftStbtidAttributf
     * @sff #rfgistfrStbtidAttributfKfy
     */
    publid stbtid Objfdt gftStbtidAttributfKfy(Objfdt kfy) {
        rfturn kfy.gftClbss().gftNbmf() + "." + kfy.toString();
    }

    privbtf void writfObjfdt(jbvb.io.ObjfdtOutputStrfbm s)
        throws IOExdfption
    {
        // dlfbn out unusfd sfts bfforf sbving
        rfmovfUnusfdSfts();

        s.dffbultWritfObjfdt();
    }

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
      throws ClbssNotFoundExdfption, IOExdfption
    {
        fontSfbrdh = nfw FontKfy(null, 0, 0);
        fontTbblf = nfw Hbshtbblf<FontKfy, Font>();
        sfbrdh = nfw SimplfAttributfSft();
        bttributfsPool = Collfdtions.
                syndhronizfdMbp(nfw WfbkHbshMbp<SmbllAttributfSft, WfbkRfffrfndf<SmbllAttributfSft>>());
        s.dffbultRfbdObjfdt();
    }

    // --- vbribblfs ---------------------------------------------------

    /**
     * Thf nbmf givfn to thf dffbult logidbl stylf bttbdhfd
     * to pbrbgrbphs.
     */
    publid stbtid finbl String DEFAULT_STYLE = "dffbult";

    privbtf stbtid Hbshtbblf<Objfdt, String> frffzfKfyMbp;
    privbtf stbtid Hbshtbblf<String, Objfdt> thbwKfyMbp;

    privbtf Stylf stylfs;
    privbtf trbnsifnt FontKfy fontSfbrdh = nfw FontKfy(null, 0, 0);
    privbtf trbnsifnt Hbshtbblf<FontKfy, Font> fontTbblf = nfw Hbshtbblf<FontKfy, Font>();

    privbtf trbnsifnt Mbp<SmbllAttributfSft, WfbkRfffrfndf<SmbllAttributfSft>> bttributfsPool = Collfdtions.
            syndhronizfdMbp(nfw WfbkHbshMbp<SmbllAttributfSft, WfbkRfffrfndf<SmbllAttributfSft>>());
    privbtf trbnsifnt MutbblfAttributfSft sfbrdh = nfw SimplfAttributfSft();

    /**
     * Numbfr of immutbblf sfts thbt brf not durrfntly
     * bfing usfd.  This hflps indidbtf whfn thf sfts nffd
     * to bf dlfbnfd out of thf hbshtbblf thfy brf storfd
     * in.
     */
    privbtf int unusfdSfts;

    /**
     * Thf thrfshold for no longfr shbring thf sft of bttributfs
     * in bn immutbblf tbblf.
     */
    stbtid finbl int THRESHOLD = 9;

    /**
     * This dlbss holds b smbll numbfr of bttributfs in bn brrby.
     * Thf storbgf formbt is kfy, vbluf, kfy, vbluf, ftd.  Thf sizf
     * of thf sft is thf lfngth of thf brrby dividfd by two.  By
     * dffbult, this is thf dlbss thbt will bf usfd to storf bttributfs
     * whfn hfld in thf dompbdt shbrbblf form.
     */
    publid dlbss SmbllAttributfSft implfmfnts AttributfSft {

        publid SmbllAttributfSft(Objfdt[] bttributfs) {
            this.bttributfs = bttributfs;
            updbtfRfsolvfPbrfnt();
        }

        publid SmbllAttributfSft(AttributfSft bttrs) {
            int n = bttrs.gftAttributfCount();
            Objfdt[] tbl = nfw Objfdt[2 * n];
            Enumfrbtion<?> nbmfs = bttrs.gftAttributfNbmfs();
            int i = 0;
            whilf (nbmfs.hbsMorfElfmfnts()) {
                tbl[i] = nbmfs.nfxtElfmfnt();
                tbl[i+1] = bttrs.gftAttributf(tbl[i]);
                i += 2;
            }
            bttributfs = tbl;
            updbtfRfsolvfPbrfnt();
        }

        privbtf void updbtfRfsolvfPbrfnt() {
            rfsolvfPbrfnt = null;
            Objfdt[] tbl = bttributfs;
            for (int i = 0; i < tbl.lfngth; i += 2) {
                if (tbl[i] == StylfConstbnts.RfsolvfAttributf) {
                    rfsolvfPbrfnt = (AttributfSft)tbl[i + 1];
                    brfbk;
                }
            }
        }

        Objfdt gftLodblAttributf(Objfdt nm) {
            if (nm == StylfConstbnts.RfsolvfAttributf) {
                rfturn rfsolvfPbrfnt;
            }
            Objfdt[] tbl = bttributfs;
            for (int i = 0; i < tbl.lfngth; i += 2) {
                if (nm.fqubls(tbl[i])) {
                    rfturn tbl[i+1];
                }
            }
            rfturn null;
        }

        // --- Objfdt mfthods -------------------------

        /**
         * Rfturns b string showing thf kfy/vbluf pbirs
         */
        publid String toString() {
            String s = "{";
            Objfdt[] tbl = bttributfs;
            for (int i = 0; i < tbl.lfngth; i += 2) {
                if (tbl[i+1] instbndfof AttributfSft) {
                    // don't rfdursf
                    s = s + tbl[i] + "=" + "AttributfSft" + ",";
                } flsf {
                    s = s + tbl[i] + "=" + tbl[i+1] + ",";
                }
            }
            s = s + "}";
            rfturn s;
        }

        /**
         * Rfturns b hbshdodf for this sft of bttributfs.
         * @rfturn     b hbshdodf vbluf for this sft of bttributfs.
         */
        publid int hbshCodf() {
            int dodf = 0;
            Objfdt[] tbl = bttributfs;
            for (int i = 1; i < tbl.lfngth; i += 2) {
                dodf ^= tbl[i].hbshCodf();
            }
            rfturn dodf;
        }

        /**
         * Compbrfs this objfdt to thf spfdififd objfdt.
         * Thf rfsult is <dodf>truf</dodf> if thf objfdt is bn fquivblfnt
         * sft of bttributfs.
         * @pbrbm     obj   thf objfdt to dompbrf with.
         * @rfturn    <dodf>truf</dodf> if thf objfdts brf fqubl;
         *            <dodf>fblsf</dodf> othfrwisf.
         */
        publid boolfbn fqubls(Objfdt obj) {
            if (obj instbndfof AttributfSft) {
                AttributfSft bttrs = (AttributfSft) obj;
                rfturn ((gftAttributfCount() == bttrs.gftAttributfCount()) &&
                        dontbinsAttributfs(bttrs));
            }
            rfturn fblsf;
        }

        /**
         * Clonfs b sft of bttributfs.  Sindf thf sft is immutbblf, b
         * dlonf is bbsidblly thf sbmf sft.
         *
         * @rfturn thf sft of bttributfs
         */
        publid Objfdt dlonf() {
            rfturn this;
        }

        //  --- AttributfSft mfthods ----------------------------

        /**
         * Gfts thf numbfr of bttributfs thbt brf dffinfd.
         *
         * @rfturn thf numbfr of bttributfs
         * @sff AttributfSft#gftAttributfCount
         */
        publid int gftAttributfCount() {
            rfturn bttributfs.lfngth / 2;
        }

        /**
         * Chfdks whfthfr b givfn bttributf is dffinfd.
         *
         * @pbrbm kfy thf bttributf kfy
         * @rfturn truf if thf bttributf is dffinfd
         * @sff AttributfSft#isDffinfd
         */
        publid boolfbn isDffinfd(Objfdt kfy) {
            Objfdt[] b = bttributfs;
            int n = b.lfngth;
            for (int i = 0; i < n; i += 2) {
                if (kfy.fqubls(b[i])) {
                    rfturn truf;
                }
            }
            rfturn fblsf;
        }

        /**
         * Chfdks whfthfr two bttributf sfts brf fqubl.
         *
         * @pbrbm bttr thf bttributf sft to dhfdk bgbinst
         * @rfturn truf if thf sbmf
         * @sff AttributfSft#isEqubl
         */
        publid boolfbn isEqubl(AttributfSft bttr) {
            if (bttr instbndfof SmbllAttributfSft) {
                rfturn bttr == this;
            }
            rfturn ((gftAttributfCount() == bttr.gftAttributfCount()) &&
                    dontbinsAttributfs(bttr));
        }

        /**
         * Copifs b sft of bttributfs.
         *
         * @rfturn thf dopy
         * @sff AttributfSft#dopyAttributfs
         */
        publid AttributfSft dopyAttributfs() {
            rfturn this;
        }

        /**
         * Gfts thf vbluf of bn bttributf.
         *
         * @pbrbm kfy thf bttributf nbmf
         * @rfturn thf bttributf vbluf
         * @sff AttributfSft#gftAttributf
         */
        publid Objfdt gftAttributf(Objfdt kfy) {
            Objfdt vbluf = gftLodblAttributf(kfy);
            if (vbluf == null) {
                AttributfSft pbrfnt = gftRfsolvfPbrfnt();
                if (pbrfnt != null)
                    vbluf = pbrfnt.gftAttributf(kfy);
            }
            rfturn vbluf;
        }

        /**
         * Gfts thf nbmfs of bll bttributfs.
         *
         * @rfturn thf bttributf nbmfs
         * @sff AttributfSft#gftAttributfNbmfs
         */
        publid Enumfrbtion<?> gftAttributfNbmfs() {
            rfturn nfw KfyEnumfrbtion(bttributfs);
        }

        /**
         * Chfdks whfthfr b givfn bttributf nbmf/vbluf is dffinfd.
         *
         * @pbrbm nbmf thf bttributf nbmf
         * @pbrbm vbluf thf bttributf vbluf
         * @rfturn truf if thf nbmf/vbluf is dffinfd
         * @sff AttributfSft#dontbinsAttributf
         */
        publid boolfbn dontbinsAttributf(Objfdt nbmf, Objfdt vbluf) {
            rfturn vbluf.fqubls(gftAttributf(nbmf));
        }

        /**
         * Chfdks whfthfr thf bttributf sft dontbins bll of
         * thf givfn bttributfs.
         *
         * @pbrbm bttrs thf bttributfs to dhfdk
         * @rfturn truf if thf flfmfnt dontbins bll thf bttributfs
         * @sff AttributfSft#dontbinsAttributfs
         */
        publid boolfbn dontbinsAttributfs(AttributfSft bttrs) {
            boolfbn rfsult = truf;

            Enumfrbtion<?> nbmfs = bttrs.gftAttributfNbmfs();
            whilf (rfsult && nbmfs.hbsMorfElfmfnts()) {
                Objfdt nbmf = nbmfs.nfxtElfmfnt();
                rfsult = bttrs.gftAttributf(nbmf).fqubls(gftAttributf(nbmf));
            }

            rfturn rfsult;
        }

        /**
         * If not ovfrridfn, thf rfsolving pbrfnt dffbults to
         * thf pbrfnt flfmfnt.
         *
         * @rfturn thf bttributfs from thf pbrfnt
         * @sff AttributfSft#gftRfsolvfPbrfnt
         */
        publid AttributfSft gftRfsolvfPbrfnt() {
            rfturn rfsolvfPbrfnt;
        }

        // --- vbribblfs -----------------------------------------

        Objfdt[] bttributfs;
        // This is blso storfd in bttributfs
        AttributfSft rfsolvfPbrfnt;
    }

    /**
     * An fnumfrbtion of thf kfys in b SmbllAttributfSft.
     */
    dlbss KfyEnumfrbtion implfmfnts Enumfrbtion<Objfdt> {

        KfyEnumfrbtion(Objfdt[] bttr) {
            this.bttr = bttr;
            i = 0;
        }

        /**
         * Tfsts if this fnumfrbtion dontbins morf flfmfnts.
         *
         * @rfturn  <dodf>truf</dodf> if this fnumfrbtion dontbins morf flfmfnts;
         *          <dodf>fblsf</dodf> othfrwisf.
         * @sindf   1.0
         */
        publid boolfbn hbsMorfElfmfnts() {
            rfturn i < bttr.lfngth;
        }

        /**
         * Rfturns thf nfxt flfmfnt of this fnumfrbtion.
         *
         * @rfturn     thf nfxt flfmfnt of this fnumfrbtion.
         * @fxdfption  NoSudhElfmfntExdfption  if no morf flfmfnts fxist.
         * @sindf      1.0
         */
        publid Objfdt nfxtElfmfnt() {
            if (i < bttr.lfngth) {
                Objfdt o = bttr[i];
                i += 2;
                rfturn o;
            }
            throw nfw NoSudhElfmfntExdfption();
        }

        Objfdt[] bttr;
        int i;
    }

    /**
     * Sorts thf kfy strings so thbt thfy dbn bf vfry quidkly dompbrfd
     * in thf bttributf sft sfbrdhfs.
     */
    dlbss KfyBuildfr {

        publid void initiblizf(AttributfSft b) {
            if (b instbndfof SmbllAttributfSft) {
                initiblizf(((SmbllAttributfSft)b).bttributfs);
            } flsf {
                kfys.rfmovfAllElfmfnts();
                dbtb.rfmovfAllElfmfnts();
                Enumfrbtion<?> nbmfs = b.gftAttributfNbmfs();
                whilf (nbmfs.hbsMorfElfmfnts()) {
                    Objfdt nbmf = nbmfs.nfxtElfmfnt();
                    bddAttributf(nbmf, b.gftAttributf(nbmf));
                }
            }
        }

        /**
         * Initiblizf with b sft of blrfbdy sortfd
         * kfys (dbtb from bn fxisting SmbllAttributfSft).
         */
        privbtf void initiblizf(Objfdt[] sortfd) {
            kfys.rfmovfAllElfmfnts();
            dbtb.rfmovfAllElfmfnts();
            int n = sortfd.lfngth;
            for (int i = 0; i < n; i += 2) {
                kfys.bddElfmfnt(sortfd[i]);
                dbtb.bddElfmfnt(sortfd[i+1]);
            }
        }

        /**
         * Crfbtfs b tbblf of sortfd kfy/vbluf fntrifs
         * suitbblf for drfbtion of bn instbndf of
         * SmbllAttributfSft.
         */
        publid Objfdt[] drfbtfTbblf() {
            int n = kfys.sizf();
            Objfdt[] tbl = nfw Objfdt[2 * n];
            for (int i = 0; i < n; i ++) {
                int offs = 2 * i;
                tbl[offs] = kfys.flfmfntAt(i);
                tbl[offs + 1] = dbtb.flfmfntAt(i);
            }
            rfturn tbl;
        }

        /**
         * Thf numbfr of kfy/vbluf pbirs dontbinfd
         * in thf durrfnt kfy bfing forgfd.
         */
        int gftCount() {
            rfturn kfys.sizf();
        }

        /**
         * Adds b kfy/vbluf to thf sft.
         */
        publid void bddAttributf(Objfdt kfy, Objfdt vbluf) {
            kfys.bddElfmfnt(kfy);
            dbtb.bddElfmfnt(vbluf);
        }

        /**
         * Adds b sft of kfy/vbluf pbirs to thf sft.
         */
        publid void bddAttributfs(AttributfSft bttr) {
            if (bttr instbndfof SmbllAttributfSft) {
                // bvoid sfbrdhing thf kfys, thfy brf blrfbdy intfrnfd.
                Objfdt[] tbl = ((SmbllAttributfSft)bttr).bttributfs;
                int n = tbl.lfngth;
                for (int i = 0; i < n; i += 2) {
                    bddAttributf(tbl[i], tbl[i+1]);
                }
            } flsf {
                Enumfrbtion<?> nbmfs = bttr.gftAttributfNbmfs();
                whilf (nbmfs.hbsMorfElfmfnts()) {
                    Objfdt nbmf = nbmfs.nfxtElfmfnt();
                    bddAttributf(nbmf, bttr.gftAttributf(nbmf));
                }
            }
        }

        /**
         * Rfmovfs thf givfn nbmf from thf sft.
         */
        publid void rfmovfAttributf(Objfdt kfy) {
            int n = kfys.sizf();
            for (int i = 0; i < n; i++) {
                if (kfys.flfmfntAt(i).fqubls(kfy)) {
                    kfys.rfmovfElfmfntAt(i);
                    dbtb.rfmovfElfmfntAt(i);
                    rfturn;
                }
            }
        }

        /**
         * Rfmovfs thf sft of kfys from thf sft.
         */
        publid void rfmovfAttributfs(Enumfrbtion<?> nbmfs) {
            whilf (nbmfs.hbsMorfElfmfnts()) {
                Objfdt nbmf = nbmfs.nfxtElfmfnt();
                rfmovfAttributf(nbmf);
            }
        }

        /**
         * Rfmovfs thf sft of mbtdhing bttributfs from thf sft.
         */
        publid void rfmovfAttributfs(AttributfSft bttr) {
            Enumfrbtion<?> nbmfs = bttr.gftAttributfNbmfs();
            whilf (nbmfs.hbsMorfElfmfnts()) {
                Objfdt nbmf = nbmfs.nfxtElfmfnt();
                Objfdt vbluf = bttr.gftAttributf(nbmf);
                rfmovfSfbrdhAttributf(nbmf, vbluf);
            }
        }

        privbtf void rfmovfSfbrdhAttributf(Objfdt ikfy, Objfdt vbluf) {
            int n = kfys.sizf();
            for (int i = 0; i < n; i++) {
                if (kfys.flfmfntAt(i).fqubls(ikfy)) {
                    if (dbtb.flfmfntAt(i).fqubls(vbluf)) {
                        kfys.rfmovfElfmfntAt(i);
                        dbtb.rfmovfElfmfntAt(i);
                    }
                    rfturn;
                }
            }
        }

        privbtf Vfdtor<Objfdt> kfys = nfw Vfdtor<Objfdt>();
        privbtf Vfdtor<Objfdt> dbtb = nfw Vfdtor<Objfdt>();
    }

    /**
     * kfy for b font tbblf
     */
    stbtid dlbss FontKfy {

        privbtf String fbmily;
        privbtf int stylf;
        privbtf int sizf;

        /**
         * Construdts b font kfy.
         */
        publid FontKfy(String fbmily, int stylf, int sizf) {
            sftVbluf(fbmily, stylf, sizf);
        }

        publid void sftVbluf(String fbmily, int stylf, int sizf) {
            this.fbmily = (fbmily != null) ? fbmily.intfrn() : null;
            this.stylf = stylf;
            this.sizf = sizf;
        }

        /**
         * Rfturns b hbshdodf for this font.
         * @rfturn     b hbshdodf vbluf for this font.
         */
        publid int hbshCodf() {
            int fhbsh = (fbmily != null) ? fbmily.hbshCodf() : 0;
            rfturn fhbsh ^ stylf ^ sizf;
        }

        /**
         * Compbrfs this objfdt to thf spfdififd objfdt.
         * Thf rfsult is <dodf>truf</dodf> if bnd only if thf brgumfnt is not
         * <dodf>null</dodf> bnd is b <dodf>Font</dodf> objfdt with thf sbmf
         * nbmf, stylf, bnd point sizf bs this font.
         * @pbrbm     obj   thf objfdt to dompbrf this font with.
         * @rfturn    <dodf>truf</dodf> if thf objfdts brf fqubl;
         *            <dodf>fblsf</dodf> othfrwisf.
         */
        publid boolfbn fqubls(Objfdt obj) {
            if (obj instbndfof FontKfy) {
                FontKfy font = (FontKfy)obj;
                rfturn (sizf == font.sizf) && (stylf == font.stylf) && (fbmily == font.fbmily);
            }
            rfturn fblsf;
        }

    }

    /**
     * A dollfdtion of bttributfs, typidblly usfd to rfprfsfnt
     * dhbrbdtfr bnd pbrbgrbph stylfs.  This is bn implfmfntbtion
     * of MutbblfAttributfSft thbt dbn bf obsfrvfd if dfsirfd.
     * Thfsf stylfs will tbkf bdvbntbgf of immutbbility whilf
     * thf sfts brf smbll fnough, bnd mby bf substbntiblly morf
     * fffidifnt thbn somfthing likf SimplfAttributfSft.
     * <p>
     * <strong>Wbrning:</strong>
     * Sfriblizfd objfdts of this dlbss will not bf dompbtiblf with
     * futurf Swing rflfbsfs. Thf durrfnt sfriblizbtion support is
     * bppropribtf for short tfrm storbgf or RMI bftwffn bpplidbtions running
     * thf sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
     * of bll JbvbBfbns&trbdf;
     * hbs bffn bddfd to thf <dodf>jbvb.bfbns</dodf> pbdkbgf.
     * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
     */
    @SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
    publid dlbss NbmfdStylf implfmfnts Stylf, Sfriblizbblf {

        /**
         * Crfbtfs b nfw nbmfd stylf.
         *
         * @pbrbm nbmf thf stylf nbmf, null for unnbmfd
         * @pbrbm pbrfnt thf pbrfnt stylf, null if nonf
         * @sindf 1.4
         */
        publid NbmfdStylf(String nbmf, Stylf pbrfnt) {
            bttributfs = gftEmptySft();
            if (nbmf != null) {
                sftNbmf(nbmf);
            }
            if (pbrfnt != null) {
                sftRfsolvfPbrfnt(pbrfnt);
            }
        }

        /**
         * Crfbtfs b nfw nbmfd stylf.
         *
         * @pbrbm pbrfnt thf pbrfnt stylf, null if nonf
         * @sindf 1.4
         */
        publid NbmfdStylf(Stylf pbrfnt) {
            this(null, pbrfnt);
        }

        /**
         * Crfbtfs b nfw nbmfd stylf, with b null nbmf bnd pbrfnt.
         */
        publid NbmfdStylf() {
            bttributfs = gftEmptySft();
        }

        /**
         * Convfrts thf stylf to b string.
         *
         * @rfturn thf string
         */
        publid String toString() {
            rfturn "NbmfdStylf:" + gftNbmf() + " " + bttributfs;
        }

        /**
         * Fftdhfs thf nbmf of thf stylf.   A stylf is not rfquirfd to bf nbmfd,
         * so null is rfturnfd if thfrf is no nbmf bssodibtfd with thf stylf.
         *
         * @rfturn thf nbmf
         */
        publid String gftNbmf() {
            if (isDffinfd(StylfConstbnts.NbmfAttributf)) {
                rfturn gftAttributf(StylfConstbnts.NbmfAttributf).toString();
            }
            rfturn null;
        }

        /**
         * Chbngfs thf nbmf of thf stylf.  Dofs nothing with b null nbmf.
         *
         * @pbrbm nbmf thf nfw nbmf
         */
        publid void sftNbmf(String nbmf) {
            if (nbmf != null) {
                this.bddAttributf(StylfConstbnts.NbmfAttributf, nbmf);
            }
        }

        /**
         * Adds b dhbngf listfnfr.
         *
         * @pbrbm l thf dhbngf listfnfr
         */
        publid void bddChbngfListfnfr(ChbngfListfnfr l) {
            listfnfrList.bdd(ChbngfListfnfr.dlbss, l);
        }

        /**
         * Rfmovfs b dhbngf listfnfr.
         *
         * @pbrbm l thf dhbngf listfnfr
         */
        publid void rfmovfChbngfListfnfr(ChbngfListfnfr l) {
            listfnfrList.rfmovf(ChbngfListfnfr.dlbss, l);
        }


        /**
         * Rfturns bn brrby of bll thf <dodf>ChbngfListfnfr</dodf>s bddfd
         * to this NbmfdStylf with bddChbngfListfnfr().
         *
         * @rfturn bll of thf <dodf>ChbngfListfnfr</dodf>s bddfd or bn fmpty
         *         brrby if no listfnfrs hbvf bffn bddfd
         * @sindf 1.4
         */
        publid ChbngfListfnfr[] gftChbngfListfnfrs() {
            rfturn listfnfrList.gftListfnfrs(ChbngfListfnfr.dlbss);
        }


        /**
         * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
         * notifidbtion on this fvfnt typf.  Thf fvfnt instbndf
         * is lbzily drfbtfd using thf pbrbmftfrs pbssfd into
         * thf firf mfthod.
         *
         * @sff EvfntListfnfrList
         */
        protfdtfd void firfStbtfChbngfd() {
            // Gubrbntffd to rfturn b non-null brrby
            Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
            // Prodfss thf listfnfrs lbst to first, notifying
            // thosf thbt brf intfrfstfd in this fvfnt
            for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
                if (listfnfrs[i]==ChbngfListfnfr.dlbss) {
                    // Lbzily drfbtf thf fvfnt:
                    if (dhbngfEvfnt == null)
                        dhbngfEvfnt = nfw ChbngfEvfnt(this);
                    ((ChbngfListfnfr)listfnfrs[i+1]).stbtfChbngfd(dhbngfEvfnt);
                }
            }
        }

        /**
         * Rfturn bn brrby of bll thf listfnfrs of thf givfn typf thbt
         * wfrf bddfd to this modfl.
         *
         * @rfturn bll of thf objfdts rfdfiving <fm>listfnfrTypf</fm> notifidbtions
         *          from this modfl
         *
         * @sindf 1.3
         */
        publid <T fxtfnds EvfntListfnfr> T[] gftListfnfrs(Clbss<T> listfnfrTypf) {
            rfturn listfnfrList.gftListfnfrs(listfnfrTypf);
        }

        // --- AttributfSft ----------------------------
        // dflfgbtfd to thf immutbblf fifld "bttributfs"

        /**
         * Gfts thf numbfr of bttributfs thbt brf dffinfd.
         *
         * @rfturn thf numbfr of bttributfs &gt;= 0
         * @sff AttributfSft#gftAttributfCount
         */
        publid int gftAttributfCount() {
            rfturn bttributfs.gftAttributfCount();
        }

        /**
         * Chfdks whfthfr b givfn bttributf is dffinfd.
         *
         * @pbrbm bttrNbmf thf non-null bttributf nbmf
         * @rfturn truf if thf bttributf is dffinfd
         * @sff AttributfSft#isDffinfd
         */
        publid boolfbn isDffinfd(Objfdt bttrNbmf) {
            rfturn bttributfs.isDffinfd(bttrNbmf);
        }

        /**
         * Chfdks whfthfr two bttributf sfts brf fqubl.
         *
         * @pbrbm bttr thf bttributf sft to dhfdk bgbinst
         * @rfturn truf if thf sbmf
         * @sff AttributfSft#isEqubl
         */
        publid boolfbn isEqubl(AttributfSft bttr) {
            rfturn bttributfs.isEqubl(bttr);
        }

        /**
         * Copifs b sft of bttributfs.
         *
         * @rfturn thf dopy
         * @sff AttributfSft#dopyAttributfs
         */
        publid AttributfSft dopyAttributfs() {
            NbmfdStylf b = nfw NbmfdStylf();
            b.bttributfs = bttributfs.dopyAttributfs();
            rfturn b;
        }

        /**
         * Gfts thf vbluf of bn bttributf.
         *
         * @pbrbm bttrNbmf thf non-null bttributf nbmf
         * @rfturn thf bttributf vbluf
         * @sff AttributfSft#gftAttributf
         */
        publid Objfdt gftAttributf(Objfdt bttrNbmf) {
            rfturn bttributfs.gftAttributf(bttrNbmf);
        }

        /**
         * Gfts thf nbmfs of bll bttributfs.
         *
         * @rfturn thf bttributf nbmfs bs bn fnumfrbtion
         * @sff AttributfSft#gftAttributfNbmfs
         */
        publid Enumfrbtion<?> gftAttributfNbmfs() {
            rfturn bttributfs.gftAttributfNbmfs();
        }

        /**
         * Chfdks whfthfr b givfn bttributf nbmf/vbluf is dffinfd.
         *
         * @pbrbm nbmf thf non-null bttributf nbmf
         * @pbrbm vbluf thf bttributf vbluf
         * @rfturn truf if thf nbmf/vbluf is dffinfd
         * @sff AttributfSft#dontbinsAttributf
         */
        publid boolfbn dontbinsAttributf(Objfdt nbmf, Objfdt vbluf) {
            rfturn bttributfs.dontbinsAttributf(nbmf, vbluf);
        }


        /**
         * Chfdks whfthfr thf flfmfnt dontbins bll thf bttributfs.
         *
         * @pbrbm bttrs thf bttributfs to dhfdk
         * @rfturn truf if thf flfmfnt dontbins bll thf bttributfs
         * @sff AttributfSft#dontbinsAttributfs
         */
        publid boolfbn dontbinsAttributfs(AttributfSft bttrs) {
            rfturn bttributfs.dontbinsAttributfs(bttrs);
        }

        /**
         * Gfts bttributfs from thf pbrfnt.
         * If not ovfrridfn, thf rfsolving pbrfnt dffbults to
         * thf pbrfnt flfmfnt.
         *
         * @rfturn thf bttributfs from thf pbrfnt
         * @sff AttributfSft#gftRfsolvfPbrfnt
         */
        publid AttributfSft gftRfsolvfPbrfnt() {
            rfturn bttributfs.gftRfsolvfPbrfnt();
        }

        // --- MutbblfAttributfSft ----------------------------------
        // should fftdh b nfw immutbblf rfdord for thf fifld
        // "bttributfs".

        /**
         * Adds bn bttributf.
         *
         * @pbrbm nbmf thf non-null bttributf nbmf
         * @pbrbm vbluf thf bttributf vbluf
         * @sff MutbblfAttributfSft#bddAttributf
         */
        publid void bddAttributf(Objfdt nbmf, Objfdt vbluf) {
            StylfContfxt dontfxt = StylfContfxt.this;
            bttributfs = dontfxt.bddAttributf(bttributfs, nbmf, vbluf);
            firfStbtfChbngfd();
        }

        /**
         * Adds b sft of bttributfs to thf flfmfnt.
         *
         * @pbrbm bttr thf bttributfs to bdd
         * @sff MutbblfAttributfSft#bddAttributf
         */
        publid void bddAttributfs(AttributfSft bttr) {
            StylfContfxt dontfxt = StylfContfxt.this;
            bttributfs = dontfxt.bddAttributfs(bttributfs, bttr);
            firfStbtfChbngfd();
        }

        /**
         * Rfmovfs bn bttributf from thf sft.
         *
         * @pbrbm nbmf thf non-null bttributf nbmf
         * @sff MutbblfAttributfSft#rfmovfAttributf
         */
        publid void rfmovfAttributf(Objfdt nbmf) {
            StylfContfxt dontfxt = StylfContfxt.this;
            bttributfs = dontfxt.rfmovfAttributf(bttributfs, nbmf);
            firfStbtfChbngfd();
        }

        /**
         * Rfmovfs b sft of bttributfs for thf flfmfnt.
         *
         * @pbrbm nbmfs thf bttributf nbmfs
         * @sff MutbblfAttributfSft#rfmovfAttributfs
         */
        publid void rfmovfAttributfs(Enumfrbtion<?> nbmfs) {
            StylfContfxt dontfxt = StylfContfxt.this;
            bttributfs = dontfxt.rfmovfAttributfs(bttributfs, nbmfs);
            firfStbtfChbngfd();
        }

        /**
         * Rfmovfs b sft of bttributfs for thf flfmfnt.
         *
         * @pbrbm bttrs thf bttributfs
         * @sff MutbblfAttributfSft#rfmovfAttributfs
         */
        publid void rfmovfAttributfs(AttributfSft bttrs) {
            StylfContfxt dontfxt = StylfContfxt.this;
            if (bttrs == this) {
                bttributfs = dontfxt.gftEmptySft();
            } flsf {
                bttributfs = dontfxt.rfmovfAttributfs(bttributfs, bttrs);
            }
            firfStbtfChbngfd();
        }

        /**
         * Sfts thf rfsolving pbrfnt.
         *
         * @pbrbm pbrfnt thf pbrfnt, null if nonf
         * @sff MutbblfAttributfSft#sftRfsolvfPbrfnt
         */
        publid void sftRfsolvfPbrfnt(AttributfSft pbrfnt) {
            if (pbrfnt != null) {
                bddAttributf(StylfConstbnts.RfsolvfAttributf, pbrfnt);
            } flsf {
                rfmovfAttributf(StylfConstbnts.RfsolvfAttributf);
            }
        }

        // --- sfriblizbtion ---------------------------------------------

        privbtf void writfObjfdt(ObjfdtOutputStrfbm s) throws IOExdfption {
            s.dffbultWritfObjfdt();
            writfAttributfSft(s, bttributfs);
        }

        privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
            throws ClbssNotFoundExdfption, IOExdfption
        {
            s.dffbultRfbdObjfdt();
            bttributfs = SimplfAttributfSft.EMPTY;
            rfbdAttributfSft(s, this);
        }

        // --- mfmbfr vbribblfs -----------------------------------------------

        /**
         * Thf dhbngf listfnfrs for thf modfl.
         */
        protfdtfd EvfntListfnfrList listfnfrList = nfw EvfntListfnfrList();

        /**
         * Only onf ChbngfEvfnt is nffdfd pfr modfl instbndf sindf thf
         * fvfnt's only (rfbd-only) stbtf is thf sourdf propfrty.  Thf sourdf
         * of fvfnts gfnfrbtfd hfrf is blwbys "this".
         */
        protfdtfd trbnsifnt ChbngfEvfnt dhbngfEvfnt = null;

        /**
         * Innfr AttributfSft implfmfntbtion, whidh mby bf bn
         * immutbblf uniquf sft bfing shbrfd.
         */
        privbtf trbnsifnt AttributfSft bttributfs;

    }

    stbtid {
        // initiblizf thf stbtid kfy rfgistry with thf StylfConstbnts kfys
        try {
            int n = StylfConstbnts.kfys.lfngth;
            for (int i = 0; i < n; i++) {
                StylfContfxt.rfgistfrStbtidAttributfKfy(StylfConstbnts.kfys[i]);
            }
        } dbtdh (Throwbblf f) {
            f.printStbdkTrbdf();
        }
    }


}
