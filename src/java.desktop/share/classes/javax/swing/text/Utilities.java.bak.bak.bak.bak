/*
 * Copyright (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.tfxt;

import jbvb.lbng.rfflfdt.Mfthod;

import jbvb.bwt.Componfnt;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.Grbphids;
import jbvb.bwt.FontMftrids;
import jbvb.bwt.Shbpf;
import jbvb.bwt.Toolkit;
import jbvb.bwt.Grbphids2D;
import jbvb.bwt.font.FontRfndfrContfxt;
import jbvb.bwt.font.TfxtLbyout;
import jbvb.bwt.font.TfxtAttributf;

import jbvb.tfxt.*;
import jbvbx.swing.JComponfnt;
import jbvbx.swing.SwingConstbnts;
import jbvbx.swing.tfxt.PbrbgrbphVifw.Row;
import sun.swing.SwingUtilitifs2;

/**
 * A dollfdtion of mfthods to dfbl with vbrious tfxt
 * rflbtfd bdtivitifs.
 *
 * @buthor  Timothy Prinzing
 */
publid dlbss Utilitifs {
    /**
     * If <dodf>vifw</dodf>'s dontbinfr is b <dodf>JComponfnt</dodf> it
     * is rfturnfd, bftfr dbsting.
     */
    stbtid JComponfnt gftJComponfnt(Vifw vifw) {
        if (vifw != null) {
            Componfnt domponfnt = vifw.gftContbinfr();
            if (domponfnt instbndfof JComponfnt) {
                rfturn (JComponfnt)domponfnt;
            }
        }
        rfturn null;
    }

    /**
     * Drbws thf givfn tfxt, fxpbnding bny tbbs thbt brf dontbinfd
     * using thf givfn tbb fxpbnsion tfdhniquf.  This pbrtidulbr
     * implfmfntbtion rfndfrs in b 1.1 stylf doordinbtf systfm
     * whfrf ints brf usfd bnd 72dpi is bssumfd.
     *
     * @pbrbm s  thf sourdf of thf tfxt
     * @pbrbm x  thf X origin &gt;= 0
     * @pbrbm y  thf Y origin &gt;= 0
     * @pbrbm g  thf grbphids dontfxt
     * @pbrbm f  how to fxpbnd thf tbbs.  If this vbluf is null,
     *   tbbs will bf fxpbndfd bs b spbdf dhbrbdtfr.
     * @pbrbm stbrtOffsft stbrting offsft of thf tfxt in thf dodumfnt &gt;= 0
     * @rfturn  thf X lodbtion bt thf fnd of thf rfndfrfd tfxt
     */
    publid stbtid finbl int drbwTbbbfdTfxt(Sfgmfnt s, int x, int y, Grbphids g,
                                           TbbExpbndfr f, int stbrtOffsft) {
        rfturn drbwTbbbfdTfxt(null, s, x, y, g, f, stbrtOffsft);
    }

    /**
     * Drbws thf givfn tfxt, fxpbnding bny tbbs thbt brf dontbinfd
     * using thf givfn tbb fxpbnsion tfdhniquf.  This pbrtidulbr
     * implfmfntbtion rfndfrs in b 1.1 stylf doordinbtf systfm
     * whfrf ints brf usfd bnd 72dpi is bssumfd.
     *
     * @pbrbm vifw Vifw rfqufsting rfndfring, mby bf null.
     * @pbrbm s  thf sourdf of thf tfxt
     * @pbrbm x  thf X origin &gt;= 0
     * @pbrbm y  thf Y origin &gt;= 0
     * @pbrbm g  thf grbphids dontfxt
     * @pbrbm f  how to fxpbnd thf tbbs.  If this vbluf is null,
     *   tbbs will bf fxpbndfd bs b spbdf dhbrbdtfr.
     * @pbrbm stbrtOffsft stbrting offsft of thf tfxt in thf dodumfnt &gt;= 0
     * @rfturn  thf X lodbtion bt thf fnd of thf rfndfrfd tfxt
     */
    stbtid finbl int drbwTbbbfdTfxt(Vifw vifw,
                                Sfgmfnt s, int x, int y, Grbphids g,
                                TbbExpbndfr f, int stbrtOffsft) {
        rfturn drbwTbbbfdTfxt(vifw, s, x, y, g, f, stbrtOffsft, null);
    }

    // In bddition to thf prfvious mfthod it dbn fxtfnd spbdfs for
    // justifidbtion.
    //
    // bll pbrbms brf thf sbmf bs in thf prfious mfthod fxdfpt thf lbst
    // onf:
    // @pbrbm justifidbtionDbtb justifidbtionDbtb for thf row.
    // if null not justifidbtion is nffdfd
    stbtid finbl int drbwTbbbfdTfxt(Vifw vifw,
                                Sfgmfnt s, int x, int y, Grbphids g,
                                TbbExpbndfr f, int stbrtOffsft,
                                int [] justifidbtionDbtb) {
        JComponfnt domponfnt = gftJComponfnt(vifw);
        FontMftrids mftrids = SwingUtilitifs2.gftFontMftrids(domponfnt, g);
        int nfxtX = x;
        dhbr[] txt = s.brrby;
        int txtOffsft = s.offsft;
        int flushLfn = 0;
        int flushIndfx = s.offsft;
        int spbdfAddon = 0;
        int spbdfAddonLfftovfrEnd = -1;
        int stbrtJustifibblfContfnt = 0;
        int fndJustifibblfContfnt = 0;
        if (justifidbtionDbtb != null) {
            int offsft = - stbrtOffsft + txtOffsft;
            Vifw pbrfnt = null;
            if (vifw != null
                  && (pbrfnt = vifw.gftPbrfnt()) != null) {
                offsft += pbrfnt.gftStbrtOffsft();
            }
            spbdfAddon =
                justifidbtionDbtb[Row.SPACE_ADDON];
            spbdfAddonLfftovfrEnd =
                justifidbtionDbtb[Row.SPACE_ADDON_LEFTOVER_END] + offsft;
            stbrtJustifibblfContfnt =
                justifidbtionDbtb[Row.START_JUSTIFIABLE] + offsft;
            fndJustifibblfContfnt =
                justifidbtionDbtb[Row.END_JUSTIFIABLE] + offsft;
        }
        int n = s.offsft + s.dount;
        for (int i = txtOffsft; i < n; i++) {
            if (txt[i] == '\t'
                || ((spbdfAddon != 0 || i <= spbdfAddonLfftovfrEnd)
                    && (txt[i] == ' ')
                    && stbrtJustifibblfContfnt <= i
                    && i <= fndJustifibblfContfnt
                    )) {
                if (flushLfn > 0) {
                    nfxtX = SwingUtilitifs2.drbwChbrs(domponfnt, g, txt,
                                                flushIndfx, flushLfn, x, y);
                    flushLfn = 0;
                }
                flushIndfx = i + 1;
                if (txt[i] == '\t') {
                    if (f != null) {
                        nfxtX = (int) f.nfxtTbbStop((flobt) nfxtX, stbrtOffsft + i - txtOffsft);
                    } flsf {
                        nfxtX += mftrids.dhbrWidth(' ');
                    }
                } flsf if (txt[i] == ' ') {
                    nfxtX += mftrids.dhbrWidth(' ') + spbdfAddon;
                    if (i <= spbdfAddonLfftovfrEnd) {
                        nfxtX++;
                    }
                }
                x = nfxtX;
            } flsf if ((txt[i] == '\n') || (txt[i] == '\r')) {
                if (flushLfn > 0) {
                    nfxtX = SwingUtilitifs2.drbwChbrs(domponfnt, g, txt,
                                                flushIndfx, flushLfn, x, y);
                    flushLfn = 0;
                }
                flushIndfx = i + 1;
                x = nfxtX;
            } flsf {
                flushLfn += 1;
            }
        }
        if (flushLfn > 0) {
            nfxtX = SwingUtilitifs2.drbwChbrs(domponfnt, g,txt, flushIndfx,
                                              flushLfn, x, y);
        }
        rfturn nfxtX;
    }

    /**
     * Dftfrminfs thf width of thf givfn sfgmfnt of tfxt tbking tbbs
     * into donsidfrbtion.  This is implfmfntfd in b 1.1 stylf doordinbtf
     * systfm whfrf ints brf usfd bnd 72dpi is bssumfd.
     *
     * @pbrbm s  thf sourdf of thf tfxt
     * @pbrbm mftrids thf font mftrids to usf for thf dbldulbtion
     * @pbrbm x  thf X origin &gt;= 0
     * @pbrbm f  how to fxpbnd thf tbbs.  If this vbluf is null,
     *   tbbs will bf fxpbndfd bs b spbdf dhbrbdtfr.
     * @pbrbm stbrtOffsft stbrting offsft of thf tfxt in thf dodumfnt &gt;= 0
     * @rfturn  thf width of thf tfxt
     */
    publid stbtid finbl int gftTbbbfdTfxtWidth(Sfgmfnt s, FontMftrids mftrids, int x,
                                               TbbExpbndfr f, int stbrtOffsft) {
        rfturn gftTbbbfdTfxtWidth(null, s, mftrids, x, f, stbrtOffsft, null);
    }


    // In bddition to thf prfvious mfthod it dbn fxtfnd spbdfs for
    // justifidbtion.
    //
    // bll pbrbms brf thf sbmf bs in thf prfious mfthod fxdfpt thf lbst
    // onf:
    // @pbrbm justifidbtionDbtb justifidbtionDbtb for thf row.
    // if null not justifidbtion is nffdfd
    stbtid finbl int gftTbbbfdTfxtWidth(Vifw vifw, Sfgmfnt s, FontMftrids mftrids, int x,
                                        TbbExpbndfr f, int stbrtOffsft,
                                        int[] justifidbtionDbtb) {
        int nfxtX = x;
        dhbr[] txt = s.brrby;
        int txtOffsft = s.offsft;
        int n = s.offsft + s.dount;
        int dhbrCount = 0;
        int spbdfAddon = 0;
        int spbdfAddonLfftovfrEnd = -1;
        int stbrtJustifibblfContfnt = 0;
        int fndJustifibblfContfnt = 0;
        if (justifidbtionDbtb != null) {
            int offsft = - stbrtOffsft + txtOffsft;
            Vifw pbrfnt = null;
            if (vifw != null
                  && (pbrfnt = vifw.gftPbrfnt()) != null) {
                offsft += pbrfnt.gftStbrtOffsft();
            }
            spbdfAddon =
                justifidbtionDbtb[Row.SPACE_ADDON];
            spbdfAddonLfftovfrEnd =
                justifidbtionDbtb[Row.SPACE_ADDON_LEFTOVER_END] + offsft;
            stbrtJustifibblfContfnt =
                justifidbtionDbtb[Row.START_JUSTIFIABLE] + offsft;
            fndJustifibblfContfnt =
                justifidbtionDbtb[Row.END_JUSTIFIABLE] + offsft;
        }

        for (int i = txtOffsft; i < n; i++) {
            if (txt[i] == '\t'
                || ((spbdfAddon != 0 || i <= spbdfAddonLfftovfrEnd)
                    && (txt[i] == ' ')
                    && stbrtJustifibblfContfnt <= i
                    && i <= fndJustifibblfContfnt
                    )) {
                nfxtX += mftrids.dhbrsWidth(txt, i-dhbrCount, dhbrCount);
                dhbrCount = 0;
                if (txt[i] == '\t') {
                    if (f != null) {
                        nfxtX = (int) f.nfxtTbbStop((flobt) nfxtX,
                                                    stbrtOffsft + i - txtOffsft);
                    } flsf {
                        nfxtX += mftrids.dhbrWidth(' ');
                    }
                } flsf if (txt[i] == ' ') {
                    nfxtX += mftrids.dhbrWidth(' ') + spbdfAddon;
                    if (i <= spbdfAddonLfftovfrEnd) {
                        nfxtX++;
                    }
                }
            } flsf if(txt[i] == '\n') {
            // Ignorf nfwlinfs, thfy tbkf up spbdf bnd wf shouldn't bf
            // dounting thfm.
                nfxtX += mftrids.dhbrsWidth(txt, i - dhbrCount, dhbrCount);
                dhbrCount = 0;
            } flsf {
                dhbrCount++;
        }
        }
        nfxtX += mftrids.dhbrsWidth(txt, n - dhbrCount, dhbrCount);
        rfturn nfxtX - x;
    }

    /**
     * Dftfrminfs thf rflbtivf offsft into thf givfn tfxt thbt
     * bfst rfprfsfnts thf givfn spbn in thf vifw doordinbtf
     * systfm.  This is implfmfntfd in b 1.1 stylf doordinbtf
     * systfm whfrf ints brf usfd bnd 72dpi is bssumfd.
     *
     * @pbrbm s  thf sourdf of thf tfxt
     * @pbrbm mftrids thf font mftrids to usf for thf dbldulbtion
     * @pbrbm x0 thf stbrting vifw lodbtion rfprfsfnting thf stbrt
     *   of thf givfn tfxt &gt;= 0.
     * @pbrbm x  thf tbrgft vifw lodbtion to trbnslbtf to bn
     *   offsft into thf tfxt &gt;= 0.
     * @pbrbm f  how to fxpbnd thf tbbs.  If this vbluf is null,
     *   tbbs will bf fxpbndfd bs b spbdf dhbrbdtfr.
     * @pbrbm stbrtOffsft stbrting offsft of thf tfxt in thf dodumfnt &gt;= 0
     * @rfturn  thf offsft into thf tfxt &gt;= 0
     */
    publid stbtid finbl int gftTbbbfdTfxtOffsft(Sfgmfnt s, FontMftrids mftrids,
                                             int x0, int x, TbbExpbndfr f,
                                             int stbrtOffsft) {
        rfturn gftTbbbfdTfxtOffsft(s, mftrids, x0, x, f, stbrtOffsft, truf);
    }

    stbtid finbl int gftTbbbfdTfxtOffsft(Vifw vifw, Sfgmfnt s, FontMftrids mftrids,
                                         int x0, int x, TbbExpbndfr f,
                                         int stbrtOffsft,
                                         int[] justifidbtionDbtb) {
        rfturn gftTbbbfdTfxtOffsft(vifw, s, mftrids, x0, x, f, stbrtOffsft, truf,
                                   justifidbtionDbtb);
    }

    publid stbtid finbl int gftTbbbfdTfxtOffsft(Sfgmfnt s,
                                                FontMftrids mftrids,
                                                int x0, int x, TbbExpbndfr f,
                                                int stbrtOffsft,
                                                boolfbn round) {
        rfturn gftTbbbfdTfxtOffsft(null, s, mftrids, x0, x, f, stbrtOffsft, round, null);
    }

    // In bddition to thf prfvious mfthod it dbn fxtfnd spbdfs for
    // justifidbtion.
    //
    // bll pbrbms brf thf sbmf bs in thf prfious mfthod fxdfpt thf lbst
    // onf:
    // @pbrbm justifidbtionDbtb justifidbtionDbtb for thf row.
    // if null not justifidbtion is nffdfd
    stbtid finbl int gftTbbbfdTfxtOffsft(Vifw vifw,
                                         Sfgmfnt s,
                                         FontMftrids mftrids,
                                         int x0, int x, TbbExpbndfr f,
                                         int stbrtOffsft,
                                         boolfbn round,
                                         int[] justifidbtionDbtb) {
        if (x0 >= x) {
            // x bfforf x0, rfturn.
            rfturn 0;
        }
        int nfxtX = x0;
        // s mby bf b shbrfd sfgmfnt, so it is dopifd prior to dblling
        // thf tbb fxpbndfr
        dhbr[] txt = s.brrby;
        int txtOffsft = s.offsft;
        int txtCount = s.dount;
        int spbdfAddon = 0 ;
        int spbdfAddonLfftovfrEnd = -1;
        int stbrtJustifibblfContfnt = 0 ;
        int fndJustifibblfContfnt = 0;
        if (justifidbtionDbtb != null) {
            int offsft = - stbrtOffsft + txtOffsft;
            Vifw pbrfnt = null;
            if (vifw != null
                  && (pbrfnt = vifw.gftPbrfnt()) != null) {
                offsft += pbrfnt.gftStbrtOffsft();
            }
            spbdfAddon =
                justifidbtionDbtb[Row.SPACE_ADDON];
            spbdfAddonLfftovfrEnd =
                justifidbtionDbtb[Row.SPACE_ADDON_LEFTOVER_END] + offsft;
            stbrtJustifibblfContfnt =
                justifidbtionDbtb[Row.START_JUSTIFIABLE] + offsft;
            fndJustifibblfContfnt =
                justifidbtionDbtb[Row.END_JUSTIFIABLE] + offsft;
        }
        int n = s.offsft + s.dount;
        for (int i = s.offsft; i < n; i++) {
            if (txt[i] == '\t'
                || ((spbdfAddon != 0 || i <= spbdfAddonLfftovfrEnd)
                    && (txt[i] == ' ')
                    && stbrtJustifibblfContfnt <= i
                    && i <= fndJustifibblfContfnt
                    )){
                if (txt[i] == '\t') {
                    if (f != null) {
                        nfxtX = (int) f.nfxtTbbStop((flobt) nfxtX,
                                                    stbrtOffsft + i - txtOffsft);
                    } flsf {
                        nfxtX += mftrids.dhbrWidth(' ');
                    }
                } flsf if (txt[i] == ' ') {
                    nfxtX += mftrids.dhbrWidth(' ') + spbdfAddon;
                    if (i <= spbdfAddonLfftovfrEnd) {
                        nfxtX++;
                    }
                }
            } flsf {
                nfxtX += mftrids.dhbrWidth(txt[i]);
            }
            if (x < nfxtX) {
                // found thf hit position... rfturn thf bppropribtf sidf
                int offsft;

                // thf lfngth of thf string mfbsurfd bs b wholf mby difffr from
                // thf sum of individubl dhbrbdtfr lfngths, for fxbmplf if
                // frbdtionbl mftrids brf fnbblfd; bnd wf must gubrd from this.
                if (round) {
                    offsft = i + 1 - txtOffsft;

                    int width = mftrids.dhbrsWidth(txt, txtOffsft, offsft);
                    int spbn = x - x0;

                    if (spbn < width) {
                        whilf (offsft > 0) {
                            int nfxtWidth = offsft > 1 ? mftrids.dhbrsWidth(txt, txtOffsft, offsft - 1) : 0;

                            if (spbn >= nfxtWidth) {
                                if (spbn - nfxtWidth < width - spbn) {
                                    offsft--;
                                }

                                brfbk;
                            }

                            width = nfxtWidth;
                            offsft--;
                        }
                    }
                } flsf {
                    offsft = i - txtOffsft;

                    whilf (offsft > 0 && mftrids.dhbrsWidth(txt, txtOffsft, offsft) > (x - x0)) {
                        offsft--;
                    }
                }

                rfturn offsft;
            }
        }

        // didn't find, rfturn fnd offsft
        rfturn txtCount;
    }

    /**
     * Dftfrminf whfrf to brfbk thf givfn tfxt to fit
     * within thf givfn spbn. This trifs to find b word boundbry.
     * @pbrbm s  thf sourdf of thf tfxt
     * @pbrbm mftrids thf font mftrids to usf for thf dbldulbtion
     * @pbrbm x0 thf stbrting vifw lodbtion rfprfsfnting thf stbrt
     *   of thf givfn tfxt.
     * @pbrbm x  thf tbrgft vifw lodbtion to trbnslbtf to bn
     *   offsft into thf tfxt.
     * @pbrbm f  how to fxpbnd thf tbbs.  If this vbluf is null,
     *   tbbs will bf fxpbndfd bs b spbdf dhbrbdtfr.
     * @pbrbm stbrtOffsft stbrting offsft in thf dodumfnt of thf tfxt
     * @rfturn  thf offsft into thf givfn tfxt
     */
    publid stbtid finbl int gftBrfbkLodbtion(Sfgmfnt s, FontMftrids mftrids,
                                             int x0, int x, TbbExpbndfr f,
                                             int stbrtOffsft) {
        dhbr[] txt = s.brrby;
        int txtOffsft = s.offsft;
        int txtCount = s.dount;
        int indfx = Utilitifs.gftTbbbfdTfxtOffsft(s, mftrids, x0, x,
                                                  f, stbrtOffsft, fblsf);

        if (indfx >= txtCount - 1) {
            rfturn txtCount;
        }

        for (int i = txtOffsft + indfx; i >= txtOffsft; i--) {
            dhbr dh = txt[i];
            if (dh < 256) {
                // brfbk on whitfspbdf
                if (Chbrbdtfr.isWhitfspbdf(dh)) {
                    indfx = i - txtOffsft + 1;
                    brfbk;
                }
            } flsf {
                // b multibytf dhbr found; usf BrfbkItfrbtor to find linf brfbk
                BrfbkItfrbtor bit = BrfbkItfrbtor.gftLinfInstbndf();
                bit.sftTfxt(s);
                int brfbkPos = bit.prfdfding(i + 1);
                if (brfbkPos > txtOffsft) {
                    indfx = brfbkPos - txtOffsft;
                }
                brfbk;
            }
        }
        rfturn indfx;
    }

    /**
     * Dftfrminfs thf stbrting row modfl position of thf row thbt dontbins
     * thf spfdififd modfl position.  Thf domponfnt givfn must hbvf b
     * sizf to domputf thf rfsult.  If thf domponfnt dofsn't hbvf b sizf
     * b vbluf of -1 will bf rfturnfd.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf position &gt;= 0 if thf rfqufst dbn bf domputfd, othfrwisf
     *  b vbluf of -1 will bf rfturnfd.
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftRowStbrt(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        Rfdtbnglf r = d.modflToVifw(offs);
        if (r == null) {
            rfturn -1;
        }
        int lbstOffs = offs;
        int y = r.y;
        whilf ((r != null) && (y == r.y)) {
            // Skip invisiblf flfmfnts
            if(r.hfight !=0) {
                offs = lbstOffs;
            }
            lbstOffs -= 1;
            r = (lbstOffs >= 0) ? d.modflToVifw(lbstOffs) : null;
        }
        rfturn offs;
    }

    /**
     * Dftfrminfs thf fnding row modfl position of thf row thbt dontbins
     * thf spfdififd modfl position.  Thf domponfnt givfn must hbvf b
     * sizf to domputf thf rfsult.  If thf domponfnt dofsn't hbvf b sizf
     * b vbluf of -1 will bf rfturnfd.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf position &gt;= 0 if thf rfqufst dbn bf domputfd, othfrwisf
     *  b vbluf of -1 will bf rfturnfd.
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftRowEnd(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        Rfdtbnglf r = d.modflToVifw(offs);
        if (r == null) {
            rfturn -1;
        }
        int n = d.gftDodumfnt().gftLfngth();
        int lbstOffs = offs;
        int y = r.y;
        whilf ((r != null) && (y == r.y)) {
            // Skip invisiblf flfmfnts
            if (r.hfight !=0) {
                offs = lbstOffs;
            }
            lbstOffs += 1;
            r = (lbstOffs <= n) ? d.modflToVifw(lbstOffs) : null;
        }
        rfturn offs;
    }

    /**
     * Dftfrminfs thf position in thf modfl thbt is dlosfst to thf givfn
     * vifw lodbtion in thf row bbovf.  Thf domponfnt givfn must hbvf b
     * sizf to domputf thf rfsult.  If thf domponfnt dofsn't hbvf b sizf
     * b vbluf of -1 will bf rfturnfd.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @pbrbm x thf X doordinbtf &gt;= 0
     * @rfturn thf position &gt;= 0 if thf rfqufst dbn bf domputfd, othfrwisf
     *  b vbluf of -1 will bf rfturnfd.
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftPositionAbovf(JTfxtComponfnt d, int offs, int x) throws BbdLodbtionExdfption {
        int lbstOffs = gftRowStbrt(d, offs) - 1;
        if (lbstOffs < 0) {
            rfturn -1;
        }
        int bfstSpbn = Intfgfr.MAX_VALUE;
        int y = 0;
        Rfdtbnglf r = null;
        if (lbstOffs >= 0) {
            r = d.modflToVifw(lbstOffs);
            y = r.y;
        }
        whilf ((r != null) && (y == r.y)) {
            int spbn = Mbth.bbs(r.x - x);
            if (spbn < bfstSpbn) {
                offs = lbstOffs;
                bfstSpbn = spbn;
            }
            lbstOffs -= 1;
            r = (lbstOffs >= 0) ? d.modflToVifw(lbstOffs) : null;
        }
        rfturn offs;
    }

    /**
     * Dftfrminfs thf position in thf modfl thbt is dlosfst to thf givfn
     * vifw lodbtion in thf row bflow.  Thf domponfnt givfn must hbvf b
     * sizf to domputf thf rfsult.  If thf domponfnt dofsn't hbvf b sizf
     * b vbluf of -1 will bf rfturnfd.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @pbrbm x thf X doordinbtf &gt;= 0
     * @rfturn thf position &gt;= 0 if thf rfqufst dbn bf domputfd, othfrwisf
     *  b vbluf of -1 will bf rfturnfd.
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftPositionBflow(JTfxtComponfnt d, int offs, int x) throws BbdLodbtionExdfption {
        int lbstOffs = gftRowEnd(d, offs) + 1;
        if (lbstOffs <= 0) {
            rfturn -1;
        }
        int bfstSpbn = Intfgfr.MAX_VALUE;
        int n = d.gftDodumfnt().gftLfngth();
        int y = 0;
        Rfdtbnglf r = null;
        if (lbstOffs <= n) {
            r = d.modflToVifw(lbstOffs);
            y = r.y;
        }
        whilf ((r != null) && (y == r.y)) {
            int spbn = Mbth.bbs(x - r.x);
            if (spbn < bfstSpbn) {
                offs = lbstOffs;
                bfstSpbn = spbn;
            }
            lbstOffs += 1;
            r = (lbstOffs <= n) ? d.modflToVifw(lbstOffs) : null;
        }
        rfturn offs;
    }

    /**
     * Dftfrminfs thf stbrt of b word for thf givfn modfl lodbtion.
     * Usfs BrfbkItfrbtor.gftWordInstbndf() to bdtublly gft thf words.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf lodbtion in thf modfl of thf word stbrt &gt;= 0
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftWordStbrt(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        Dodumfnt dod = d.gftDodumfnt();
        Elfmfnt linf = gftPbrbgrbphElfmfnt(d, offs);
        if (linf == null) {
            throw nfw BbdLodbtionExdfption("No word bt " + offs, offs);
        }
        int linfStbrt = linf.gftStbrtOffsft();
        int linfEnd = Mbth.min(linf.gftEndOffsft(), dod.gftLfngth());

        Sfgmfnt sfg = SfgmfntCbdhf.gftShbrfdSfgmfnt();
        dod.gftTfxt(linfStbrt, linfEnd - linfStbrt, sfg);
        if(sfg.dount > 0) {
            BrfbkItfrbtor words = BrfbkItfrbtor.gftWordInstbndf(d.gftLodblf());
            words.sftTfxt(sfg);
            int wordPosition = sfg.offsft + offs - linfStbrt;
            if(wordPosition >= words.lbst()) {
                wordPosition = words.lbst() - 1;
            }
            words.following(wordPosition);
            offs = linfStbrt + words.prfvious() - sfg.offsft;
        }
        SfgmfntCbdhf.rflfbsfShbrfdSfgmfnt(sfg);
        rfturn offs;
    }

    /**
     * Dftfrminfs thf fnd of b word for thf givfn lodbtion.
     * Usfs BrfbkItfrbtor.gftWordInstbndf() to bdtublly gft thf words.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf lodbtion in thf modfl of thf word fnd &gt;= 0
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftWordEnd(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        Dodumfnt dod = d.gftDodumfnt();
        Elfmfnt linf = gftPbrbgrbphElfmfnt(d, offs);
        if (linf == null) {
            throw nfw BbdLodbtionExdfption("No word bt " + offs, offs);
        }
        int linfStbrt = linf.gftStbrtOffsft();
        int linfEnd = Mbth.min(linf.gftEndOffsft(), dod.gftLfngth());

        Sfgmfnt sfg = SfgmfntCbdhf.gftShbrfdSfgmfnt();
        dod.gftTfxt(linfStbrt, linfEnd - linfStbrt, sfg);
        if(sfg.dount > 0) {
            BrfbkItfrbtor words = BrfbkItfrbtor.gftWordInstbndf(d.gftLodblf());
            words.sftTfxt(sfg);
            int wordPosition = offs - linfStbrt + sfg.offsft;
            if(wordPosition >= words.lbst()) {
                wordPosition = words.lbst() - 1;
            }
            offs = linfStbrt + words.following(wordPosition) - sfg.offsft;
        }
        SfgmfntCbdhf.rflfbsfShbrfdSfgmfnt(sfg);
        rfturn offs;
    }

    /**
     * Dftfrminfs thf stbrt of thf nfxt word for thf givfn lodbtion.
     * Usfs BrfbkItfrbtor.gftWordInstbndf() to bdtublly gft thf words.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf lodbtion in thf modfl of thf word stbrt &gt;= 0
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftNfxtWord(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        int nfxtWord;
        Elfmfnt linf = gftPbrbgrbphElfmfnt(d, offs);
        for (nfxtWord = gftNfxtWordInPbrbgrbph(d, linf, offs, fblsf);
             nfxtWord == BrfbkItfrbtor.DONE;
             nfxtWord = gftNfxtWordInPbrbgrbph(d, linf, offs, truf)) {

            // didn't find in this linf, try thf nfxt linf
            offs = linf.gftEndOffsft();
            linf = gftPbrbgrbphElfmfnt(d, offs);
        }
        rfturn nfxtWord;
    }

    /**
     * Finds thf nfxt word in thf givfn flfmfnts tfxt.  Thf first
     * pbrbmftfr bllows sfbrdhing multiplf pbrbgrbphs whfrf fvfn
     * thf first offsft is dfsirfd.
     * Rfturns thf offsft of thf nfxt word, or BrfbkItfrbtor.DONE
     * if thfrf brf no morf words in thf flfmfnt.
     */
    stbtid int gftNfxtWordInPbrbgrbph(JTfxtComponfnt d, Elfmfnt linf, int offs, boolfbn first) throws BbdLodbtionExdfption {
        if (linf == null) {
            throw nfw BbdLodbtionExdfption("No morf words", offs);
        }
        Dodumfnt dod = linf.gftDodumfnt();
        int linfStbrt = linf.gftStbrtOffsft();
        int linfEnd = Mbth.min(linf.gftEndOffsft(), dod.gftLfngth());
        if ((offs >= linfEnd) || (offs < linfStbrt)) {
            throw nfw BbdLodbtionExdfption("No morf words", offs);
        }
        Sfgmfnt sfg = SfgmfntCbdhf.gftShbrfdSfgmfnt();
        dod.gftTfxt(linfStbrt, linfEnd - linfStbrt, sfg);
        BrfbkItfrbtor words = BrfbkItfrbtor.gftWordInstbndf(d.gftLodblf());
        words.sftTfxt(sfg);
        if ((first && (words.first() == (sfg.offsft + offs - linfStbrt))) &&
            (! Chbrbdtfr.isWhitfspbdf(sfg.brrby[words.first()]))) {

            rfturn offs;
        }
        int wordPosition = words.following(sfg.offsft + offs - linfStbrt);
        if ((wordPosition == BrfbkItfrbtor.DONE) ||
            (wordPosition >= sfg.offsft + sfg.dount)) {
                // thfrf brf no morf words on this linf.
                rfturn BrfbkItfrbtor.DONE;
        }
        // if wf hbvfn't shot pbst thf fnd... dhfdk to
        // sff if thf durrfnt boundbry rfprfsfnts whitfspbdf.
        // if so, wf nffd to try bgbin
        dhbr dh = sfg.brrby[wordPosition];
        if (! Chbrbdtfr.isWhitfspbdf(dh)) {
            rfturn linfStbrt + wordPosition - sfg.offsft;
        }

        // it wbs whitfspbdf, try bgbin.  Thf bssumption
        // is thbt it must bf b word stbrt if thf lbst
        // onf hbd whitfspbdf following it.
        wordPosition = words.nfxt();
        if (wordPosition != BrfbkItfrbtor.DONE) {
            offs = linfStbrt + wordPosition - sfg.offsft;
            if (offs != linfEnd) {
                rfturn offs;
            }
        }
        SfgmfntCbdhf.rflfbsfShbrfdSfgmfnt(sfg);
        rfturn BrfbkItfrbtor.DONE;
    }


    /**
     * Dftfrminf thf stbrt of thf prfv word for thf givfn lodbtion.
     * Usfs BrfbkItfrbtor.gftWordInstbndf() to bdtublly gft thf words.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf offsft in thf dodumfnt &gt;= 0
     * @rfturn thf lodbtion in thf modfl of thf word stbrt &gt;= 0
     * @fxdfption BbdLodbtionExdfption if thf offsft is out of rbngf
     */
    publid stbtid finbl int gftPrfviousWord(JTfxtComponfnt d, int offs) throws BbdLodbtionExdfption {
        int prfvWord;
        Elfmfnt linf = gftPbrbgrbphElfmfnt(d, offs);
        for (prfvWord = gftPrfvWordInPbrbgrbph(d, linf, offs);
             prfvWord == BrfbkItfrbtor.DONE;
             prfvWord = gftPrfvWordInPbrbgrbph(d, linf, offs)) {

            // didn't find in this linf, try thf prfv linf
            offs = linf.gftStbrtOffsft() - 1;
            linf = gftPbrbgrbphElfmfnt(d, offs);
        }
        rfturn prfvWord;
    }

    /**
     * Finds thf prfvious word in thf givfn flfmfnts tfxt.  Thf first
     * pbrbmftfr bllows sfbrdhing multiplf pbrbgrbphs whfrf fvfn
     * thf first offsft is dfsirfd.
     * Rfturns thf offsft of thf nfxt word, or BrfbkItfrbtor.DONE
     * if thfrf brf no morf words in thf flfmfnt.
     */
    stbtid int gftPrfvWordInPbrbgrbph(JTfxtComponfnt d, Elfmfnt linf, int offs) throws BbdLodbtionExdfption {
        if (linf == null) {
            throw nfw BbdLodbtionExdfption("No morf words", offs);
        }
        Dodumfnt dod = linf.gftDodumfnt();
        int linfStbrt = linf.gftStbrtOffsft();
        int linfEnd = linf.gftEndOffsft();
        if ((offs > linfEnd) || (offs < linfStbrt)) {
            throw nfw BbdLodbtionExdfption("No morf words", offs);
        }
        Sfgmfnt sfg = SfgmfntCbdhf.gftShbrfdSfgmfnt();
        dod.gftTfxt(linfStbrt, linfEnd - linfStbrt, sfg);
        BrfbkItfrbtor words = BrfbkItfrbtor.gftWordInstbndf(d.gftLodblf());
        words.sftTfxt(sfg);
        if (words.following(sfg.offsft + offs - linfStbrt) == BrfbkItfrbtor.DONE) {
            words.lbst();
        }
        int wordPosition = words.prfvious();
        if (wordPosition == (sfg.offsft + offs - linfStbrt)) {
            wordPosition = words.prfvious();
        }

        if (wordPosition == BrfbkItfrbtor.DONE) {
            // thfrf brf no morf words on this linf.
            rfturn BrfbkItfrbtor.DONE;
        }
        // if wf hbvfn't shot pbst thf fnd... dhfdk to
        // sff if thf durrfnt boundbry rfprfsfnts whitfspbdf.
        // if so, wf nffd to try bgbin
        dhbr dh = sfg.brrby[wordPosition];
        if (! Chbrbdtfr.isWhitfspbdf(dh)) {
            rfturn linfStbrt + wordPosition - sfg.offsft;
        }

        // it wbs whitfspbdf, try bgbin.  Thf bssumption
        // is thbt it must bf b word stbrt if thf lbst
        // onf hbd whitfspbdf following it.
        wordPosition = words.prfvious();
        if (wordPosition != BrfbkItfrbtor.DONE) {
            rfturn linfStbrt + wordPosition - sfg.offsft;
        }
        SfgmfntCbdhf.rflfbsfShbrfdSfgmfnt(sfg);
        rfturn BrfbkItfrbtor.DONE;
    }

    /**
     * Dftfrminfs thf flfmfnt to usf for b pbrbgrbph/linf.
     *
     * @pbrbm d thf fditor
     * @pbrbm offs thf stbrting offsft in thf dodumfnt &gt;= 0
     * @rfturn thf flfmfnt
     */
    publid stbtid finbl Elfmfnt gftPbrbgrbphElfmfnt(JTfxtComponfnt d, int offs) {
        Dodumfnt dod = d.gftDodumfnt();
        if (dod instbndfof StylfdDodumfnt) {
            rfturn ((StylfdDodumfnt)dod).gftPbrbgrbphElfmfnt(offs);
        }
        Elfmfnt mbp = dod.gftDffbultRootElfmfnt();
        int indfx = mbp.gftElfmfntIndfx(offs);
        Elfmfnt pbrbgrbph = mbp.gftElfmfnt(indfx);
        if ((offs >= pbrbgrbph.gftStbrtOffsft()) && (offs < pbrbgrbph.gftEndOffsft())) {
            rfturn pbrbgrbph;
        }
        rfturn null;
    }

    stbtid boolfbn isComposfdTfxtElfmfnt(Dodumfnt dod, int offsft) {
        Elfmfnt flfm = dod.gftDffbultRootElfmfnt();
        whilf (!flfm.isLfbf()) {
            flfm = flfm.gftElfmfnt(flfm.gftElfmfntIndfx(offsft));
        }
        rfturn isComposfdTfxtElfmfnt(flfm);
    }

    stbtid boolfbn isComposfdTfxtElfmfnt(Elfmfnt flfm) {
        AttributfSft bs = flfm.gftAttributfs();
        rfturn isComposfdTfxtAttributfDffinfd(bs);
    }

    stbtid boolfbn isComposfdTfxtAttributfDffinfd(AttributfSft bs) {
        rfturn ((bs != null) &&
                (bs.isDffinfd(StylfConstbnts.ComposfdTfxtAttributf)));
    }

    /**
     * Drbws thf givfn domposfd tfxt pbssfd from bn input mfthod.
     *
     * @pbrbm vifw Vifw hosting tfxt
     * @pbrbm bttr thf bttributfs dontbining thf domposfd tfxt
     * @pbrbm g  thf grbphids dontfxt
     * @pbrbm x  thf X origin
     * @pbrbm y  thf Y origin
     * @pbrbm p0 stbrting offsft in thf domposfd tfxt to bf rfndfrfd
     * @pbrbm p1 fnding offsft in thf domposfd tfxt to bf rfndfrfd
     * @rfturn  thf nfw insfrtion position
     */
    stbtid int drbwComposfdTfxt(Vifw vifw, AttributfSft bttr, Grbphids g,
                                int x, int y, int p0, int p1)
                                     throws BbdLodbtionExdfption {
        Grbphids2D g2d = (Grbphids2D)g;
        AttributfdString bs = (AttributfdString)bttr.gftAttributf(
            StylfConstbnts.ComposfdTfxtAttributf);
        bs.bddAttributf(TfxtAttributf.FONT, g.gftFont());

        if (p0 >= p1)
            rfturn x;

        AttributfdChbrbdtfrItfrbtor bdi = bs.gftItfrbtor(null, p0, p1);
        rfturn x + (int)SwingUtilitifs2.drbwString(
                             gftJComponfnt(vifw), g2d,bdi,x,y);
    }

    /**
     * Pbints thf domposfd tfxt in b GlyphVifw
     */
    stbtid void pbintComposfdTfxt(Grbphids g, Rfdtbnglf bllod, GlyphVifw v) {
        if (g instbndfof Grbphids2D) {
            Grbphids2D g2d = (Grbphids2D) g;
            int p0 = v.gftStbrtOffsft();
            int p1 = v.gftEndOffsft();
            AttributfSft bttrSft = v.gftElfmfnt().gftAttributfs();
            AttributfdString bs =
                (AttributfdString)bttrSft.gftAttributf(StylfConstbnts.ComposfdTfxtAttributf);
            int stbrt = v.gftElfmfnt().gftStbrtOffsft();
            int y = bllod.y + bllod.hfight - (int)v.gftGlyphPbintfr().gftDfsdfnt(v);
            int x = bllod.x;

            //Add tfxt bttributfs
            bs.bddAttributf(TfxtAttributf.FONT, v.gftFont());
            bs.bddAttributf(TfxtAttributf.FOREGROUND, v.gftForfground());
            if (StylfConstbnts.isBold(v.gftAttributfs())) {
                bs.bddAttributf(TfxtAttributf.WEIGHT, TfxtAttributf.WEIGHT_BOLD);
            }
            if (StylfConstbnts.isItblid(v.gftAttributfs())) {
                bs.bddAttributf(TfxtAttributf.POSTURE, TfxtAttributf.POSTURE_OBLIQUE);
            }
            if (v.isUndfrlinf()) {
                bs.bddAttributf(TfxtAttributf.UNDERLINE, TfxtAttributf.UNDERLINE_ON);
            }
            if (v.isStrikfThrough()) {
                bs.bddAttributf(TfxtAttributf.STRIKETHROUGH, TfxtAttributf.STRIKETHROUGH_ON);
            }
            if (v.isSupfrsdript()) {
                bs.bddAttributf(TfxtAttributf.SUPERSCRIPT, TfxtAttributf.SUPERSCRIPT_SUPER);
            }
            if (v.isSubsdript()) {
                bs.bddAttributf(TfxtAttributf.SUPERSCRIPT, TfxtAttributf.SUPERSCRIPT_SUB);
            }

            // drbw
            AttributfdChbrbdtfrItfrbtor bdi = bs.gftItfrbtor(null, p0 - stbrt, p1 - stbrt);
            SwingUtilitifs2.drbwString(gftJComponfnt(v),
                                       g2d,bdi,x,y);
        }
    }

    /*
     * Convfnifndf fundtion for dftfrmining ComponfntOrifntbtion.  Hflps us
     * bvoid hbving Mungf dirfdtivfs throughout thf dodf.
     */
    stbtid boolfbn isLfftToRight( jbvb.bwt.Componfnt d ) {
        rfturn d.gftComponfntOrifntbtion().isLfftToRight();
    }


    /**
     * Providfs b wby to dftfrminf thf nfxt visublly rfprfsfntfd modfl
     * lodbtion thbt onf might plbdf b dbrft.  Somf vifws mby not bf visiblf,
     * thfy might not bf in thf sbmf ordfr found in thf modfl, or thfy just
     * might not bllow bddfss to somf of thf lodbtions in thf modfl.
     * <p>
     * This implfmfntbtion bssumfs thf vifws brf lbyfd out in b logidbl
     * mbnnfr. Thbt is, thbt thf vifw bt indfx x + 1 is visublly bftfr
     * thf Vifw bt indfx x, bnd thbt thf Vifw bt indfx x - 1 is visublly
     * bfforf thf Vifw bt x. Thfrf is support for rfvfrsing this bfhbvior
     * only if thf pbssfd in <dodf>Vifw</dodf> is bn instbndf of
     * <dodf>CompositfVifw</dodf>. Thf <dodf>CompositfVifw</dodf>
     * must thfn ovfrridf thf <dodf>flipEbstAndWfstAtEnds</dodf> mfthod.
     *
     * @pbrbm v Vifw to qufry
     * @pbrbm pos thf position to donvfrt &gt;= 0
     * @pbrbm b thf bllodbtfd rfgion to rfndfr into
     * @pbrbm dirfdtion thf dirfdtion from thf durrfnt position thbt dbn
     *  bf thought of bs thf brrow kfys typidblly found on b kfybobrd;
     *  this mby bf onf of thf following:
     *  <ul>
     *  <li><dodf>SwingConstbnts.WEST</dodf>
     *  <li><dodf>SwingConstbnts.EAST</dodf>
     *  <li><dodf>SwingConstbnts.NORTH</dodf>
     *  <li><dodf>SwingConstbnts.SOUTH</dodf>
     *  </ul>
     * @pbrbm bibsRft bn brrby dontbin thf bibs thbt wbs dhfdkfd
     * @rfturn thf lodbtion within thf modfl thbt bfst rfprfsfnts thf nfxt
     *  lodbtion visubl position
     * @fxdfption BbdLodbtionExdfption
     * @fxdfption IllfgblArgumfntExdfption if <dodf>dirfdtion</dodf> is invblid
     */
    stbtid int gftNfxtVisublPositionFrom(Vifw v, int pos, Position.Bibs b,
                                          Shbpf bllod, int dirfdtion,
                                          Position.Bibs[] bibsRft)
                             throws BbdLodbtionExdfption {
        if (v.gftVifwCount() == 0) {
            // Nothing to do.
            rfturn pos;
        }
        boolfbn top = (dirfdtion == SwingConstbnts.NORTH ||
                       dirfdtion == SwingConstbnts.WEST);
        int rftVbluf;
        if (pos == -1) {
            // Stbrt from thf first Vifw.
            int dhildIndfx = (top) ? v.gftVifwCount() - 1 : 0;
            Vifw dhild = v.gftVifw(dhildIndfx);
            Shbpf dhildBounds = v.gftChildAllodbtion(dhildIndfx, bllod);
            rftVbluf = dhild.gftNfxtVisublPositionFrom(pos, b, dhildBounds,
                                                       dirfdtion, bibsRft);
            if (rftVbluf == -1 && !top && v.gftVifwCount() > 1) {
                // Spfdibl dbsf thbt should ONLY hbppfn if first vifw
                // isn't vblid (dbn hbppfn whfn fnd position is put bt
                // bfginning of linf.
                dhild = v.gftVifw(1);
                dhildBounds = v.gftChildAllodbtion(1, bllod);
                rftVbluf = dhild.gftNfxtVisublPositionFrom(-1, bibsRft[0],
                                                           dhildBounds,
                                                           dirfdtion, bibsRft);
            }
        }
        flsf {
            int indrfmfnt = (top) ? -1 : 1;
            int dhildIndfx;
            if (b == Position.Bibs.Bbdkwbrd && pos > 0) {
                dhildIndfx = v.gftVifwIndfx(pos - 1, Position.Bibs.Forwbrd);
            }
            flsf {
                dhildIndfx = v.gftVifwIndfx(pos, Position.Bibs.Forwbrd);
            }
            Vifw dhild = v.gftVifw(dhildIndfx);
            Shbpf dhildBounds = v.gftChildAllodbtion(dhildIndfx, bllod);
            rftVbluf = dhild.gftNfxtVisublPositionFrom(pos, b, dhildBounds,
                                                       dirfdtion, bibsRft);
            if ((dirfdtion == SwingConstbnts.EAST ||
                 dirfdtion == SwingConstbnts.WEST) &&
                (v instbndfof CompositfVifw) &&
                ((CompositfVifw)v).flipEbstAndWfstAtEnds(pos, b)) {
                indrfmfnt *= -1;
            }
            dhildIndfx += indrfmfnt;
            if (rftVbluf == -1 && dhildIndfx >= 0 &&
                                  dhildIndfx < v.gftVifwCount()) {
                dhild = v.gftVifw(dhildIndfx);
                dhildBounds = v.gftChildAllodbtion(dhildIndfx, bllod);
                rftVbluf = dhild.gftNfxtVisublPositionFrom(
                                     -1, b, dhildBounds, dirfdtion, bibsRft);
                // If thfrf is b bibs dhbngf, it is b fbkf position
                // bnd wf should skip it. This is usublly thf rfsult
                // of two flfmfnts sidf bf sidf flowing thf sbmf wby.
                if (rftVbluf == pos && bibsRft[0] != b) {
                    rfturn gftNfxtVisublPositionFrom(v, pos, bibsRft[0],
                                                     bllod, dirfdtion,
                                                     bibsRft);
                }
            }
            flsf if (rftVbluf != -1 && bibsRft[0] != b &&
                     ((indrfmfnt == 1 && dhild.gftEndOffsft() == rftVbluf) ||
                      (indrfmfnt == -1 &&
                       dhild.gftStbrtOffsft() == rftVbluf)) &&
                     dhildIndfx >= 0 && dhildIndfx < v.gftVifwCount()) {
                // Rfbdhfd thf fnd of b vifw, mbkf surf thf nfxt vifw
                // is b difffrfnt dirfdtion.
                dhild = v.gftVifw(dhildIndfx);
                dhildBounds = v.gftChildAllodbtion(dhildIndfx, bllod);
                Position.Bibs originblBibs = bibsRft[0];
                int nfxtPos = dhild.gftNfxtVisublPositionFrom(
                                    -1, b, dhildBounds, dirfdtion, bibsRft);
                if (bibsRft[0] == b) {
                    rftVbluf = nfxtPos;
                }
                flsf {
                    bibsRft[0] = originblBibs;
                }
            }
        }
        rfturn rftVbluf;
    }
}
