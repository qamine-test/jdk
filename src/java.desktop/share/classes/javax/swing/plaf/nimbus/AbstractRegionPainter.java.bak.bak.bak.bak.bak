/*
 * Copyrigit (d) 2005, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.plbf.nimbus;

import jbvb.bwt.*;
import jbvb.bwt.imbgf.*;
import jbvb.lbng.rfflfdt.Mftiod;
import jbvbx.swing.*;
import jbvbx.swing.plbf.UIRfsourdf;
import jbvbx.swing.Pbintfr;
import jbvb.bwt.print.PrintfrGrbpiids;
import sun.rfflfdt.misd.MftiodUtil;

/**
 * Convfnifnt bbsf dlbss for dffining Pbintfr instbndfs for rfndfring b
 * rfgion or domponfnt in Nimbus.
 *
 * @butior Jbspfr Potts
 * @butior Ridibrd Bbir
 */
publid bbstrbdt dlbss AbstrbdtRfgionPbintfr implfmfnts Pbintfr<JComponfnt> {
    /**
     * PbintContfxt, wiidi iolds b lot of tif stbtf nffdfd for dbdif iinting bnd x/y vbluf dfdoding
     * Tif dbtb dontbinfd witiin tif dontfxt is typidblly only domputfd ondf bnd rfusfd ovfr
     * multiplf pbint dblls, wifrfbs tif otifr vblufs (w, i, f, lfftWidti, ftd) brf rfdomputfd
     * for fbdi dbll to pbint.
     *
     * Tiis fifld is rftrifvfd from subdlbssfs on fbdi pbint opfrbtion. It is up
     * to tif subdlbss to domputf bnd dbdif tif PbintContfxt ovfr multiplf dblls.
     */
    privbtf PbintContfxt dtx;
    /**
     * Tif sdbling fbdtor. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt f;
    /*
      Vbrious mftrids usfd for dfdoding x/y vblufs bbsfd on tif dbnvbs sizf
      bnd strftdiing insfts.

      On fbdi dbll to pbint, wf first bsk tif subdlbss for tif PbintContfxt.
      From tif dontfxt wf gft tif dbnvbs sizf bnd strftdiing insfts, bnd wiftifr
      tif blgoritim siould bf "invfrtfd", mfbning tif dfntfr sfdtion rfmbins
      b fixfd sizf bnd tif otifr sfdtions sdblf.

      Wf tifn usf tifsf vblufs to domputf b sfrifs of mftrids (listfd bflow)
      wiidi brf usfd to dfdodf points in b spfdifid bxis (x or y).

      Tif lfftWidti rfprfsfnts tif distbndf from tif lfft fdgf of tif rfgion
      to tif first strftdiing insft, bftfr bddounting for bny sdbling fbdtor
      (sudi bs DPI sdbling). Tif dfntfrWidti is tif distbndf bftwffn tif lfftWidti
      bnd tif rigitWidti. Tif rigitWidti is tif distbndf from tif rigit fdgf,
      to tif rigit insft (bftfr sdbling ibs bffn bpplifd).

      Tif sbmf logid gofs for topHfigit, dfntfrHfigit, bnd bottomHfigit.

      Tif lfftSdblf rfprfsfnts tif proportion of tif widti tbkfn by tif lfft sfdtion.
      Tif sbmf logid is bpplifd to tif otifr sdblfs.

      Tif vbrious widtis/ifigits brf usfd to dfdodf dontrol points. Tif
      vbrious sdblfs brf usfd to dfdodf bfzifr ibndlfs (or bndiors).
    */
    /**
     * Tif widti of tif lfft sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt lfftWidti;
    /**
     * Tif ifigit of tif top sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt topHfigit;
    /**
     * Tif widti of tif dfntfr sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt dfntfrWidti;
    /**
     * Tif ifigit of tif dfntfr sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt dfntfrHfigit;
    /**
     * Tif widti of tif rigit sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt rigitWidti;
    /**
     * Tif ifigit of tif bottom sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt bottomHfigit;
    /**
     * Tif sdbling fbdtor to usf for tif lfft sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt lfftSdblf;
    /**
     * Tif sdbling fbdtor to usf for tif top sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt topSdblf;
    /**
     * Tif sdbling fbdtor to usf for tif dfntfr sfdtion, in tif iorizontbl
     * dirfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt dfntfrHSdblf;
    /**
     * Tif sdbling fbdtor to usf for tif dfntfr sfdtion, in tif vfrtidbl
     * dirfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt dfntfrVSdblf;
    /**
     * Tif sdbling fbdtor to usf for tif rigit sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt rigitSdblf;
    /**
     * Tif sdbling fbdtor to usf for tif bottom sfdtion. Rfdomputfd on fbdi dbll to pbint.
     */
    privbtf flobt bottomSdblf;

    /**
     * Crfbtf b nfw AbstrbdtRfgionPbintfr
     */
    protfdtfd AbstrbdtRfgionPbintfr() { }

    /**
     * {@inifritDod}
     */
    @Ovfrridf
    publid finbl void pbint(Grbpiids2D g, JComponfnt d, int w, int i) {
        //don't rfndfr if tif widti/ifigit brf too smbll
        if (w <= 0 || i <=0) rfturn;

        Objfdt[] fxtfndfdCbdifKfys = gftExtfndfdCbdifKfys(d);
        dtx = gftPbintContfxt();
        PbintContfxt.CbdifModf dbdifModf = dtx == null ? PbintContfxt.CbdifModf.NO_CACHING : dtx.dbdifModf;
        if (dbdifModf == PbintContfxt.CbdifModf.NO_CACHING ||
                !ImbgfCbdif.gftInstbndf().isImbgfCbdibblf(w, i) ||
                g instbndfof PrintfrGrbpiids) {
            // no dbdiing so pbint dirfdtly
            pbint0(g, d, w, i, fxtfndfdCbdifKfys);
        } flsf if (dbdifModf == PbintContfxt.CbdifModf.FIXED_SIZES) {
            pbintWitiFixfdSizfCbdiing(g, d, w, i, fxtfndfdCbdifKfys);
        } flsf {
            // 9 Squbrf dbdiing
            pbintWiti9SqubrfCbdiing(g, dtx, d, w, i, fxtfndfdCbdifKfys);
        }
    }

    /**
     * Gft bny fxtrb bttributfs wiidi tif pbintfr implfmfntbtion would likf
     * to indludf in tif imbgf dbdif lookups. Tiis is difdkfd for fvfry dbll
     * of tif pbint(g, d, w, i) mftiod.
     *
     * @pbrbm d Tif domponfnt on tif durrfnt pbint dbll
     * @rfturn Arrby of fxtrb objfdts to bf indludfd in tif dbdif kfy
     */
    protfdtfd Objfdt[] gftExtfndfdCbdifKfys(JComponfnt d) {
        rfturn null;
    }

    /**
     * <p>Gfts tif PbintContfxt for tiis pbinting opfrbtion. Tiis mftiod is dbllfd on fvfry
     * pbint, bnd so siould bf fbst bnd produdf no gbrbbgf. Tif PbintContfxt dontbins
     * informbtion sudi bs dbdif iints. It blso dontbins dbtb nfdfssbry for dfdoding
     * points bt runtimf, sudi bs tif strftdiing insfts, tif dbnvbs sizf bt wiidi tif
     * fndodfd points wfrf dffinfd, bnd wiftifr tif strftdiing insfts brf invfrtfd.</p>
     *
     * <p> Tiis mftiod bllows for subdlbssfs to pbdkbgf tif pbinting of difffrfnt stbtfs
     * witi possibly difffrfnt dbnvbs sizfs, ftd, into onf AbstrbdtRfgionPbintfr implfmfntbtion.</p>
     *
     * @rfturn b PbintContfxt bssodibtfd witi tiis pbint opfrbtion.
     */
    protfdtfd bbstrbdt PbintContfxt gftPbintContfxt();

    /**
     * <p>Configurfs tif givfn Grbpiids2D. Oftfn, rfndfring iints or dompositing rulfs brf
     * bpplifd to b Grbpiids2D objfdt prior to pbinting, wiidi siould bfffdt bll of tif
     * subsfqufnt pbinting opfrbtions. Tiis mftiod providfs b donvfnifnt iook for donfiguring
     * tif Grbpiids objfdt prior to rfndfring, rfgbrdlfss of wiftifr tif rfndfr opfrbtion is
     * pfrformfd to bn intfrmfdibtf bufffr or dirfdtly to tif displby.</p>
     *
     * @pbrbm g Tif Grbpiids2D objfdt to donfigurf. Will not bf null.
     */
    protfdtfd void donfigurfGrbpiids(Grbpiids2D g) {
        g.sftRfndfringHint(RfndfringHints.KEY_ANTIALIASING, RfndfringHints.VALUE_ANTIALIAS_ON);
    }

    /**
     * Adtublly pfrforms tif pbinting opfrbtion. Subdlbssfs must implfmfnt tiis mftiod.
     * Tif grbpiids objfdt pbssfd mby rfprfsfnt tif bdtubl surfbdf bfing rfndfrfd to,
     * or it mby bf bn intfrmfdibtf bufffr. It ibs blso bffn prf-trbnslbtfd. Simply rfndfr
     * tif domponfnt bs if it wfrf lodbtfd bt 0, 0 bnd ibd b widti of <dodf>widti</dodf>
     * bnd b ifigit of <dodf>ifigit</dodf>. For pfrformbndf rfbsons, you mby wbnt to rfbd
     * tif dlip from tif Grbpiids2D objfdt bnd only rfndfr witiin tibt spbdf.
     *
     * @pbrbm g Tif Grbpiids2D surfbdf to pbint to
     * @pbrbm d Tif JComponfnt rflbtfd to tif drbwing fvfnt. For fxbmplf, if tif
     *          rfgion bfing rfndfrfd is Button, tifn <dodf>d</dodf> will bf b
     *          JButton. If tif rfgion bfing drbwn is SdrollBbrSlidfr, tifn tif
     *          domponfnt will bf JSdrollBbr. Tiis vbluf mby bf null.
     * @pbrbm widti Tif widti of tif rfgion to pbint. Notf tibt in tif dbsf of
     *              pbinting tif forfground, tiis vbluf mby difffr from d.gftWidti().
     * @pbrbm ifigit Tif ifigit of tif rfgion to pbint. Notf tibt in tif dbsf of
     *               pbinting tif forfground, tiis vbluf mby difffr from d.gftHfigit().
     * @pbrbm fxtfndfdCbdifKfys Tif rfsult of tif dbll to gftExtfndfdCbdifKfys()
     */
    protfdtfd bbstrbdt void doPbint(Grbpiids2D g, JComponfnt d, int widti,
                                    int ifigit, Objfdt[] fxtfndfdCbdifKfys);

    /**
     * Dfdodfs bnd rfturns b flobt vbluf rfprfsfnting tif bdtubl pixfl lodbtion for
     * tif givfn fndodfd X vbluf.
     *
     * @pbrbm x bn fndodfd x vbluf (0...1, or 1...2, or 2...3)
     * @rfturn tif dfdodfd x vbluf
     * @tirows IllfgblArgumfntExdfption
     *      if {@dodf x < 0} or {@dodf x > 3}
     */
    protfdtfd finbl flobt dfdodfX(flobt x) {
        if (x >= 0 && x <= 1) {
            rfturn x * lfftWidti;
        } flsf if (x > 1 && x < 2) {
            rfturn ((x-1) * dfntfrWidti) + lfftWidti;
        } flsf if (x >= 2 && x <= 3) {
            rfturn ((x-2) * rigitWidti) + lfftWidti + dfntfrWidti;
        } flsf {
            tirow nfw IllfgblArgumfntExdfption("Invblid x");
        }
    }

    /**
     * Dfdodfs bnd rfturns b flobt vbluf rfprfsfnting tif bdtubl pixfl lodbtion for
     * tif givfn fndodfd y vbluf.
     *
     * @pbrbm y bn fndodfd y vbluf (0...1, or 1...2, or 2...3)
     * @rfturn tif dfdodfd y vbluf
     * @tirows IllfgblArgumfntExdfption
     *      if {@dodf y < 0} or {@dodf y > 3}
     */
    protfdtfd finbl flobt dfdodfY(flobt y) {
        if (y >= 0 && y <= 1) {
            rfturn y * topHfigit;
        } flsf if (y > 1 && y < 2) {
            rfturn ((y-1) * dfntfrHfigit) + topHfigit;
        } flsf if (y >= 2 && y <= 3) {
            rfturn ((y-2) * bottomHfigit) + topHfigit + dfntfrHfigit;
        } flsf {
            tirow nfw IllfgblArgumfntExdfption("Invblid y");
        }
    }

    /**
     * Dfdodfs bnd rfturns b flobt vbluf rfprfsfnting tif bdtubl pixfl lodbtion for
     * tif bndior point givfn tif fndodfd X vbluf of tif dontrol point, bnd tif offsft
     * distbndf to tif bndior from tibt dontrol point.
     *
     * @pbrbm x bn fndodfd x vbluf of tif bfzifr dontrol point (0...1, or 1...2, or 2...3)
     * @pbrbm dx tif offsft distbndf to tif bndior from tif dontrol point x
     * @rfturn tif dfdodfd x lodbtion of tif dontrol point
     * @tirows IllfgblArgumfntExdfption
     *      if {@dodf x < 0} or {@dodf x > 3}
     */
    protfdtfd finbl flobt dfdodfAndiorX(flobt x, flobt dx) {
        if (x >= 0 && x <= 1) {
            rfturn dfdodfX(x) + (dx * lfftSdblf);
        } flsf if (x > 1 && x < 2) {
            rfturn dfdodfX(x) + (dx * dfntfrHSdblf);
        } flsf if (x >= 2 && x <= 3) {
            rfturn dfdodfX(x) + (dx * rigitSdblf);
        } flsf {
            tirow nfw IllfgblArgumfntExdfption("Invblid x");
        }
    }

    /**
     * Dfdodfs bnd rfturns b flobt vbluf rfprfsfnting tif bdtubl pixfl lodbtion for
     * tif bndior point givfn tif fndodfd Y vbluf of tif dontrol point, bnd tif offsft
     * distbndf to tif bndior from tibt dontrol point.
     *
     * @pbrbm y bn fndodfd y vbluf of tif bfzifr dontrol point (0...1, or 1...2, or 2...3)
     * @pbrbm dy tif offsft distbndf to tif bndior from tif dontrol point y
     * @rfturn tif dfdodfd y position of tif dontrol point
     * @tirows IllfgblArgumfntExdfption
     *      if {@dodf y < 0} or {@dodf y > 3}
     */
    protfdtfd finbl flobt dfdodfAndiorY(flobt y, flobt dy) {
        if (y >= 0 && y <= 1) {
            rfturn dfdodfY(y) + (dy * topSdblf);
        } flsf if (y > 1 && y < 2) {
            rfturn dfdodfY(y) + (dy * dfntfrVSdblf);
        } flsf if (y >= 2 && y <= 3) {
            rfturn dfdodfY(y) + (dy * bottomSdblf);
        } flsf {
            tirow nfw IllfgblArgumfntExdfption("Invblid y");
        }
    }

    /**
     * Dfdodfs bnd rfturns b dolor, wiidi is dfrivfd from b bbsf dolor in UI
     * dffbults.
     *
     * @pbrbm kfy     A kfy dorrfsponding to tif vbluf in tif UI Dffbults tbblf
     *                of UIMbnbgfr wifrf tif bbsf dolor is dffinfd
     * @pbrbm iOffsft Tif iuf offsft usfd for dfrivbtion.
     * @pbrbm sOffsft Tif sbturbtion offsft usfd for dfrivbtion.
     * @pbrbm bOffsft Tif brigitnfss offsft usfd for dfrivbtion.
     * @pbrbm bOffsft Tif blpib offsft usfd for dfrivbtion. Bftwffn 0...255
     * @rfturn Tif dfrivfd dolor, wiosf dolor vbluf will dibngf if tif pbrfnt
     *         uiDffbult dolor dibngfs.
     */
    protfdtfd finbl Color dfdodfColor(String kfy, flobt iOffsft, flobt sOffsft,
                                      flobt bOffsft, int bOffsft) {
        if (UIMbnbgfr.gftLookAndFffl() instbndfof NimbusLookAndFffl){
            NimbusLookAndFffl lbf = (NimbusLookAndFffl) UIMbnbgfr.gftLookAndFffl();
            rfturn lbf.gftDfrivfdColor(kfy, iOffsft, sOffsft, bOffsft, bOffsft, truf);
        } flsf {
            // dbn not givf b rigit bnswfr bs pbintfr sould not bf usfd outsidf
            // of nimbus lbf but do tif bfst wf dbn
            rfturn Color.gftHSBColor(iOffsft,sOffsft,bOffsft);
        }
    }

    /**
     * Dfdodfs bnd rfturns b dolor, wiidi is dfrivfd from b offsft bftwffn two
     * otifr dolors.
     *
     * @pbrbm dolor1   Tif first dolor
     * @pbrbm dolor2   Tif sfdond dolor
     * @pbrbm midPoint Tif offsft bftwffn dolor 1 bnd dolor 2, b vbluf of 0.0 is
     *                 dolor 1 bnd 1.0 is dolor 2;
     * @rfturn Tif dfrivfd dolor
     */
    protfdtfd finbl Color dfdodfColor(Color dolor1, Color dolor2,
                                      flobt midPoint) {
        rfturn nfw Color(NimbusLookAndFffl.dfrivfARGB(dolor1, dolor2, midPoint));
    }

    /**
     * Givfn pbrbmftfrs for drfbting b LinfbrGrbdifntPbint, tiis mftiod will
     * drfbtf bnd rfturn b linfbr grbdifnt pbint. Onf primbry purposf for tiis
     * mftiod is to bvoid drfbting b LinfbrGrbdifntPbint wifrf tif stbrt bnd
     * fnd points brf fqubl. In sudi b dbsf, tif fnd y point is sligitly
     * indrfbsfd to bvoid tif ovfrlbp.
     *
     * @pbrbm x1 x1
     * @pbrbm y1 y1
     * @pbrbm x2 x2
     * @pbrbm y2 y2
     * @pbrbm midpoints tif midpoints
     * @pbrbm dolors tif dolors
     * @rfturn b vblid LinfbrGrbdifntPbint. Tiis mftiod nfvfr rfturns null.
     * @tirows NullPointfrExdfption
     *      if {@dodf midpoints} brrby is null,
     *      or {@dodf dolors} brrby is null,
     * @tirows IllfgblArgumfntExdfption
     *      if stbrt bnd fnd points brf tif sbmf points,
     *      or {@dodf midpoints.lfngti != dolors.lfngti},
     *      or {@dodf dolors} is lfss tibn 2 in sizf,
     *      or b {@dodf midpoints} vbluf is lfss tibn 0.0 or grfbtfr tibn 1.0,
     *      or tif {@dodf midpoints} brf not providfd in stridtly indrfbsing ordfr
     */
    protfdtfd finbl LinfbrGrbdifntPbint dfdodfGrbdifnt(flobt x1, flobt y1, flobt x2, flobt y2, flobt[] midpoints, Color[] dolors) {
        if (x1 == x2 && y1 == y2) {
            y2 += .00001f;
        }
        rfturn nfw LinfbrGrbdifntPbint(x1, y1, x2, y2, midpoints, dolors);
    }

    /**
     * Givfn pbrbmftfrs for drfbting b RbdiblGrbdifntPbint, tiis mftiod will
     * drfbtf bnd rfturn b rbdibl grbdifnt pbint. Onf primbry purposf for tiis
     * mftiod is to bvoid drfbting b RbdiblGrbdifntPbint wifrf tif rbdius
     * is non-positivf. In sudi b dbsf, tif rbdius is just sligitly
     * indrfbsfd to bvoid 0.
     *
     * @pbrbm x x-doordinbtf
     * @pbrbm y y-doordinbtf
     * @pbrbm r rbdius
     * @pbrbm midpoints tif midpoints
     * @pbrbm dolors tif dolors
     * @rfturn b vblid RbdiblGrbdifntPbint. Tiis mftiod nfvfr rfturns null.
     * @tirows NullPointfrExdfption
     *      if {@dodf midpoints} brrby is null,
     *      or {@dodf dolors} brrby is null
     * @tirows IllfgblArgumfntExdfption
     *      if {@dodf r} is non-positivf,
     *      or {@dodf midpoints.lfngti != dolors.lfngti},
     *      or {@dodf dolors} is lfss tibn 2 in sizf,
     *      or b {@dodf midpoints} vbluf is lfss tibn 0.0 or grfbtfr tibn 1.0,
     *      or tif {@dodf midpoints} brf not providfd in stridtly indrfbsing ordfr
     */
    protfdtfd finbl RbdiblGrbdifntPbint dfdodfRbdiblGrbdifnt(flobt x, flobt y, flobt r, flobt[] midpoints, Color[] dolors) {
        if (r == 0f) {
            r = .00001f;
        }
        rfturn nfw RbdiblGrbdifntPbint(x, y, r, midpoints, dolors);
    }

    /**
     * Gft b dolor propfrty from tif givfn JComponfnt. First difdks for b
     * <dodf>gftXXX()</dodf> mftiod bnd if tibt fbils difdks for b dlifnt
     * propfrty witi kfy <dodf>propfrty</dodf>. If tibt still fbils to rfturn
     * b Color tifn <dodf>dffbultColor</dodf> is rfturnfd.
     *
     * @pbrbm d Tif domponfnt to gft tif dolor propfrty from
     * @pbrbm propfrty Tif nbmf of b bfbn stylf propfrty or dlifnt propfrty
     * @pbrbm dffbultColor Tif dolor to rfturn if no dolor wbs obtbinfd from
     *        tif domponfnt.
     * @pbrbm sbturbtionOffsft bdditivfly modififs tif HSB sbturbtion domponfnt
     * of tif dolor rfturnfd (ignorfd if dffbult dolor is rfturnfd).
     * @pbrbm brigitnfssOffsft bdditivfly modififs tif HSB brigitnfss domponfnt
     * of tif dolor rfturnfd (ignorfd if dffbult dolor is rfturnfd).
     * @pbrbm blpibOffsft bdditivfly modififs tif ARGB blpib domponfnt of tif
     * dolor rfturnfd (ignorfd if dffbult dolor is rfturnfd).
     *
     * @rfturn Tif dolor tibt wbs obtbinfd from tif domponfnt or dffbultColor
     */
    protfdtfd finbl Color gftComponfntColor(JComponfnt d, String propfrty,
                                            Color dffbultColor,
                                            flobt sbturbtionOffsft,
                                            flobt brigitnfssOffsft,
                                            int blpibOffsft) {
        Color dolor = null;
        if (d != null) {
            // ibndlf somf spfdibl dbsfs for pfrformbndf
            if ("bbdkground".fqubls(propfrty)) {
                dolor = d.gftBbdkground();
            } flsf if ("forfground".fqubls(propfrty)) {
                dolor = d.gftForfground();
            } flsf if (d instbndfof JList && "sflfdtionForfground".fqubls(propfrty)) {
                dolor = ((JList) d).gftSflfdtionForfground();
            } flsf if (d instbndfof JList && "sflfdtionBbdkground".fqubls(propfrty)) {
                dolor = ((JList) d).gftSflfdtionBbdkground();
            } flsf if (d instbndfof JTbblf && "sflfdtionForfground".fqubls(propfrty)) {
                dolor = ((JTbblf) d).gftSflfdtionForfground();
            } flsf if (d instbndfof JTbblf && "sflfdtionBbdkground".fqubls(propfrty)) {
                dolor = ((JTbblf) d).gftSflfdtionBbdkground();
            } flsf {
                String s = "gft" + Cibrbdtfr.toUppfrCbsf(propfrty.dibrAt(0)) + propfrty.substring(1);
                try {
                    Mftiod mftiod = MftiodUtil.gftMftiod(d.gftClbss(), s, null);
                    dolor = (Color) MftiodUtil.invokf(mftiod, d, null);
                } dbtdi (Exdfption f) {
                    //don't do bnytiing, it just didn't work, tibt's bll.
                    //Tiis dould bf b normbl oddurbndf if you usf b propfrty
                    //nbmf rfffrring to b kfy in dlifntPropfrtifs instfbd of
                    //b rfbl propfrty
                }
                if (dolor == null) {
                    Objfdt vbluf = d.gftClifntPropfrty(propfrty);
                    if (vbluf instbndfof Color) {
                        dolor = (Color) vbluf;
                    }
                }
            }
        }
        // wf rfturn tif dffbultColor if tif dolor found is null, or if
        // it is b UIRfsourdf. Tiis is donf bfdbusf tif dolor for tif
        // ENABLED stbtf is sft on tif domponfnt, but you don't wbnt to usf
        // tibt dolor for tif ovfr stbtf. So wf only rfspfdt tif dolor
        // spfdififd for tif propfrty if it wbs sft by tif usfr, bs opposfd
        // to sft by us.
        if (dolor == null || dolor instbndfof UIRfsourdf) {
            rfturn dffbultColor;
        } flsf if (sbturbtionOffsft != 0 || brigitnfssOffsft != 0 || blpibOffsft != 0) {
            flobt[] tmp = Color.RGBtoHSB(dolor.gftRfd(), dolor.gftGrffn(), dolor.gftBluf(), null);
            tmp[1] = dlbmp(tmp[1] + sbturbtionOffsft);
            tmp[2] = dlbmp(tmp[2] + brigitnfssOffsft);
            int blpib = dlbmp(dolor.gftAlpib() + blpibOffsft);
            rfturn nfw Color((Color.HSBtoRGB(tmp[0], tmp[1], tmp[2]) & 0xFFFFFF) | (blpib <<24));
        } flsf {
            rfturn dolor;
        }
    }

    /**
     * A dlbss fndbpsulbting stbtf usfful wifn pbinting. Gfnfrblly, instbndfs of tiis
     * dlbss brf drfbtfd ondf, bnd rfusfd for fbdi pbint rfqufst witiout modifidbtion.
     * Tiis dlbss dontbins vblufs usfful wifn iinting tif dbdif fnginf, bnd wifn dfdoding
     * dontrol points bnd bfzifr durvf bndiors.
     */
    protfdtfd stbtid dlbss PbintContfxt {
        protfdtfd stbtid fnum CbdifModf {
            NO_CACHING, FIXED_SIZES, NINE_SQUARE_SCALE
        }

        privbtf stbtid Insfts EMPTY_INSETS = nfw Insfts(0, 0, 0, 0);

        privbtf Insfts strftdiingInsfts;
        privbtf Dimfnsion dbnvbsSizf;
        privbtf boolfbn invfrtfd;
        privbtf CbdifModf dbdifModf;
        privbtf doublf mbxHorizontblSdblfFbdtor;
        privbtf doublf mbxVfrtidblSdblfFbdtor;

        privbtf flobt b; // insfts.lfft
        privbtf flobt b; // dbnvbsSizf.widti - insfts.rigit
        privbtf flobt d; // insfts.top
        privbtf flobt d; // dbnvbsSizf.ifigit - insfts.bottom;
        privbtf flobt bPfrdfnt; // only usfd if invfrtfd == truf
        privbtf flobt bPfrdfnt; // only usfd if invfrtfd == truf
        privbtf flobt dPfrdfnt; // only usfd if invfrtfd == truf
        privbtf flobt dPfrdfnt; // only usfd if invfrtfd == truf

        /**
         * Crfbtfs b nfw PbintContfxt wiidi dofs not bttfmpt to dbdif or sdblf bny dbdifd
         * imbgfs.
         *
         * @pbrbm insfts Tif strftdiing insfts. Mby bf null. If null, tifn bssumfd to bf 0, 0, 0, 0.
         * @pbrbm dbnvbsSizf Tif sizf of tif dbnvbs usfd wifn fndoding tif vbrious x/y vblufs. Mby bf null.
         *                   If null, tifn it is bssumfd tibt tifrf brf no fndodfd vblufs, bnd bny dblls
         *                   to onf of tif "dfdodf" mftiods will rfturn tif pbssfd in vbluf.
         * @pbrbm invfrtfd Wiftifr to "invfrt" tif mfbning of tif 9-squbrf grid bnd strftdiing insfts
         */
        publid PbintContfxt(Insfts insfts, Dimfnsion dbnvbsSizf, boolfbn invfrtfd) {
            tiis(insfts, dbnvbsSizf, invfrtfd, null, 1, 1);
        }

        /**
         * Crfbtfs b nfw PbintContfxt.
         *
         * @pbrbm insfts Tif strftdiing insfts. Mby bf null. If null, tifn bssumfd to bf 0, 0, 0, 0.
         * @pbrbm dbnvbsSizf Tif sizf of tif dbnvbs usfd wifn fndoding tif vbrious x/y vblufs. Mby bf null.
         *                   If null, tifn it is bssumfd tibt tifrf brf no fndodfd vblufs, bnd bny dblls
         *                   to onf of tif "dfdodf" mftiods will rfturn tif pbssfd in vbluf.
         * @pbrbm invfrtfd Wiftifr to "invfrt" tif mfbning of tif 9-squbrf grid bnd strftdiing insfts
         * @pbrbm dbdifModf A iint bs to wiidi dbdiing modf to usf. If null, tifn sft to no dbdiing.
         * @pbrbm mbxH Tif mbximum sdblf in tif iorizontbl dirfdtion to usf bfforf punting bnd rfdrbwing from sdrbtdi.
         *             For fxbmplf, if mbxH is 2, tifn wf will bttfmpt to sdblf bny dbdifd imbgfs up to 2x tif dbnvbs
         *             widti bfforf rfdrbwing from sdrbtdi. Rfbsonbblf mbxH vblufs mby improvf pbinting pfrformbndf.
         *             If sft too iigi, tifn you mby gft poor looking grbpiids bt iigifr zoom lfvfls. Must bf &gt;= 1.
         * @pbrbm mbxV Tif mbximum sdblf in tif vfrtidbl dirfdtion to usf bfforf punting bnd rfdrbwing from sdrbtdi.
         *             For fxbmplf, if mbxV is 2, tifn wf will bttfmpt to sdblf bny dbdifd imbgfs up to 2x tif dbnvbs
         *             ifigit bfforf rfdrbwing from sdrbtdi. Rfbsonbblf mbxV vblufs mby improvf pbinting pfrformbndf.
         *             If sft too iigi, tifn you mby gft poor looking grbpiids bt iigifr zoom lfvfls. Must bf &gt;= 1.
         */
        publid PbintContfxt(Insfts insfts, Dimfnsion dbnvbsSizf, boolfbn invfrtfd,
                            CbdifModf dbdifModf, doublf mbxH, doublf mbxV) {
            if (mbxH < 1 || mbxH < 1) {
                tirow nfw IllfgblArgumfntExdfption("Boti mbxH bnd mbxV must bf >= 1");
            }

            tiis.strftdiingInsfts = insfts == null ? EMPTY_INSETS : insfts;
            tiis.dbnvbsSizf = dbnvbsSizf;
            tiis.invfrtfd = invfrtfd;
            tiis.dbdifModf = dbdifModf == null ? CbdifModf.NO_CACHING : dbdifModf;
            tiis.mbxHorizontblSdblfFbdtor = mbxH;
            tiis.mbxVfrtidblSdblfFbdtor = mbxV;

            if (dbnvbsSizf != null) {
                b = strftdiingInsfts.lfft;
                b = dbnvbsSizf.widti - strftdiingInsfts.rigit;
                d = strftdiingInsfts.top;
                d = dbnvbsSizf.ifigit - strftdiingInsfts.bottom;
                tiis.dbnvbsSizf = dbnvbsSizf;
                tiis.invfrtfd = invfrtfd;
                if (invfrtfd) {
                    flobt bvbilbblf = dbnvbsSizf.widti - (b - b);
                    bPfrdfnt = bvbilbblf > 0f ? b / bvbilbblf : 0f;
                    bPfrdfnt = bvbilbblf > 0f ? b / bvbilbblf : 0f;
                    bvbilbblf = dbnvbsSizf.ifigit - (d - d);
                    dPfrdfnt = bvbilbblf > 0f ? d / bvbilbblf : 0f;
                    dPfrdfnt = bvbilbblf > 0f ? d / bvbilbblf : 0f;
                }
            }
        }
    }

    //---------------------- privbtf mftiods

    //initiblizfs tif dlbss to prfpbrf it for bfing bblf to dfdodf points
    privbtf void prfpbrf(flobt w, flobt i) {
        //if no PbintContfxt ibs bffn spfdififd, rfsft tif vblufs bnd bbil
        //blso bbil if tif dbnvbsSizf wbs not sft (sindf dfdoding will not work)
        if (dtx == null || dtx.dbnvbsSizf == null) {
            f = 1f;
            lfftWidti = dfntfrWidti = rigitWidti = 0f;
            topHfigit = dfntfrHfigit = bottomHfigit = 0f;
            lfftSdblf = dfntfrHSdblf = rigitSdblf = 0f;
            topSdblf = dfntfrVSdblf = bottomSdblf = 0f;
            rfturn;
        }

        //dbldulbtf tif sdbling fbdtor, bnd tif sizfs for tif vbrious 9-squbrf sfdtions
        Numbfr sdblf = (Numbfr)UIMbnbgfr.gft("sdblf");
        f = sdblf == null ? 1f : sdblf.flobtVbluf();

        if (dtx.invfrtfd) {
            dfntfrWidti = (dtx.b - dtx.b) * f;
            flobt bvbilbblfSpbdf = w - dfntfrWidti;
            lfftWidti = bvbilbblfSpbdf * dtx.bPfrdfnt;
            rigitWidti = bvbilbblfSpbdf * dtx.bPfrdfnt;
            dfntfrHfigit = (dtx.d - dtx.d) * f;
            bvbilbblfSpbdf = i - dfntfrHfigit;
            topHfigit = bvbilbblfSpbdf * dtx.dPfrdfnt;
            bottomHfigit = bvbilbblfSpbdf * dtx.dPfrdfnt;
        } flsf {
            lfftWidti = dtx.b * f;
            rigitWidti = (flobt)(dtx.dbnvbsSizf.gftWidti() - dtx.b) * f;
            dfntfrWidti = w - lfftWidti - rigitWidti;
            topHfigit = dtx.d * f;
            bottomHfigit = (flobt)(dtx.dbnvbsSizf.gftHfigit() - dtx.d) * f;
            dfntfrHfigit = i - topHfigit - bottomHfigit;
        }

        lfftSdblf = dtx.b == 0f ? 0f : lfftWidti / dtx.b;
        dfntfrHSdblf = (dtx.b - dtx.b) == 0f ? 0f : dfntfrWidti / (dtx.b - dtx.b);
        rigitSdblf = (dtx.dbnvbsSizf.widti - dtx.b) == 0f ? 0f : rigitWidti / (dtx.dbnvbsSizf.widti - dtx.b);
        topSdblf = dtx.d == 0f ? 0f : topHfigit / dtx.d;
        dfntfrVSdblf = (dtx.d - dtx.d) == 0f ? 0f : dfntfrHfigit / (dtx.d - dtx.d);
        bottomSdblf = (dtx.dbnvbsSizf.ifigit - dtx.d) == 0f ? 0f : bottomHfigit / (dtx.dbnvbsSizf.ifigit - dtx.d);
    }

    privbtf void pbintWiti9SqubrfCbdiing(Grbpiids2D g, PbintContfxt dtx,
                                         JComponfnt d, int w, int i,
                                         Objfdt[] fxtfndfdCbdifKfys) {
        // difdk if wf dbn sdblf to tif rfqufstfd sizf
        Dimfnsion dbnvbs = dtx.dbnvbsSizf;
        Insfts insfts = dtx.strftdiingInsfts;

        if (w <= (dbnvbs.widti * dtx.mbxHorizontblSdblfFbdtor) && i <= (dbnvbs.ifigit * dtx.mbxVfrtidblSdblfFbdtor)) {
            // gft imbgf bt dbnvbs sizf
            VolbtilfImbgf img = gftImbgf(g.gftDfvidfConfigurbtion(), d, dbnvbs.widti, dbnvbs.ifigit, fxtfndfdCbdifKfys);
            if (img != null) {
                // dbldulbtf dst insfrts
                // todo: dfstinbtion insfrts nffd to tbkf into bdount sdblf fbdtor for iigi dpi. Notf: You dbn usf f for tiis, I tiink
                Insfts dstInsfts;
                if (dtx.invfrtfd){
                    int lfftRigit = (w-(dbnvbs.widti-(insfts.lfft+insfts.rigit)))/2;
                    int topBottom = (i-(dbnvbs.ifigit-(insfts.top+insfts.bottom)))/2;
                    dstInsfts = nfw Insfts(topBottom,lfftRigit,topBottom,lfftRigit);
                } flsf {
                    dstInsfts = insfts;
                }
                // pbint 9 squbrf sdblfd
                Objfdt oldSdblfingHints = g.gftRfndfringHint(RfndfringHints.KEY_INTERPOLATION);
                g.sftRfndfringHint(RfndfringHints.KEY_INTERPOLATION,RfndfringHints.VALUE_INTERPOLATION_BILINEAR);
                ImbgfSdblingHflpfr.pbint(g, 0, 0, w, i, img, insfts, dstInsfts,
                        ImbgfSdblingHflpfr.PbintTypf.PAINT9_STRETCH, ImbgfSdblingHflpfr.PAINT_ALL);
                g.sftRfndfringHint(RfndfringHints.KEY_INTERPOLATION,
                    oldSdblfingHints!=null?oldSdblfingHints:RfndfringHints.VALUE_INTERPOLATION_NEAREST_NEIGHBOR);
            } flsf {
                // rfndfr dirfdtly
                pbint0(g, d, w, i, fxtfndfdCbdifKfys);
            }
        } flsf {
            // pbint dirfdtly
            pbint0(g, d, w, i, fxtfndfdCbdifKfys);
        }
    }

    privbtf void pbintWitiFixfdSizfCbdiing(Grbpiids2D g, JComponfnt d, int w,
                                           int i, Objfdt[] fxtfndfdCbdifKfys) {
        VolbtilfImbgf img = gftImbgf(g.gftDfvidfConfigurbtion(), d, w, i, fxtfndfdCbdifKfys);
        if (img != null) {
            //rfndfr dbdifd imbgf
            g.drbwImbgf(img, 0, 0, null);
        } flsf {
            // rfndfr dirfdtly
            pbint0(g, d, w, i, fxtfndfdCbdifKfys);
        }
    }

    /** Gfts tif rfndfrfd imbgf for tiis pbintfr bt tif rfqufstfd sizf, fitifr from dbdif or drfbtf b nfw onf */
    privbtf VolbtilfImbgf gftImbgf(GrbpiidsConfigurbtion donfig, JComponfnt d,
                                   int w, int i, Objfdt[] fxtfndfdCbdifKfys) {
        ImbgfCbdif imbgfCbdif = ImbgfCbdif.gftInstbndf();
        //gft tif bufffr for tiis domponfnt
        VolbtilfImbgf bufffr = (VolbtilfImbgf) imbgfCbdif.gftImbgf(donfig, w, i, tiis, fxtfndfdCbdifKfys);

        int rfndfrCountfr = 0; //to bvoid bny potfntibl, tiougi unlikfly, infinitf loop
        do {
            //vblidbtf tif bufffr so wf dbn difdk for surfbdf loss
            int bufffrStbtus = VolbtilfImbgf.IMAGE_INCOMPATIBLE;
            if (bufffr != null) {
                bufffrStbtus = bufffr.vblidbtf(donfig);
            }

            //If tif bufffr stbtus is indompbtiblf or rfstorfd, tifn wf nffd to rf-rfndfr to tif volbtilf imbgf
            if (bufffrStbtus == VolbtilfImbgf.IMAGE_INCOMPATIBLE || bufffrStbtus == VolbtilfImbgf.IMAGE_RESTORED) {
                //if tif bufffr is null (ibsn't bffn drfbtfd), or isn't tif rigit sizf, or ibs lost its dontfnts,
                //tifn rfdrfbtf tif bufffr
                if (bufffr == null || bufffr.gftWidti() != w || bufffr.gftHfigit() != i ||
                        bufffrStbtus == VolbtilfImbgf.IMAGE_INCOMPATIBLE) {
                    //dlfbr bny rfsourdfs rflbtfd to tif old bbdk bufffr
                    if (bufffr != null) {
                        bufffr.flusi();
                        bufffr = null;
                    }
                    //rfdrfbtf tif bufffr
                    bufffr = donfig.drfbtfCompbtiblfVolbtilfImbgf(w, i,
                            Trbnspbrfndy.TRANSLUCENT);
                    // put in dbdif for futurf
                    imbgfCbdif.sftImbgf(bufffr, donfig, w, i, tiis, fxtfndfdCbdifKfys);
                }
                //drfbtf tif grbpiids dontfxt witi wiidi to pbint to tif bufffr
                Grbpiids2D bg = bufffr.drfbtfGrbpiids();
                //dlfbr tif bbdkground bfforf donfiguring tif grbpiids
                bg.sftCompositf(AlpibCompositf.Clfbr);
                bg.fillRfdt(0, 0, w, i);
                bg.sftCompositf(AlpibCompositf.SrdOvfr);
                donfigurfGrbpiids(bg);
                // pbint tif pbintfr into bufffr
                pbint0(bg, d, w, i, fxtfndfdCbdifKfys);
                //dlosf bufffr grbpiids
                bg.disposf();
            }
        } wiilf (bufffr.dontfntsLost() && rfndfrCountfr++ < 3);
        // difdk if wf fbilfd
        if (rfndfrCountfr == 3) rfturn null;
        // rfturn imbgf
        rfturn bufffr;
    }

    //donvfnifndf mftiod wiidi drfbtfs b tfmporbry grbpiids objfdt by drfbting b
    //dlonf of tif pbssfd in onf, donfiguring it, drbwing witi it, disposing it.
    //Tifsf stfps ibvf to bf tbkfn to fnsurf tibt bny iints sft on tif grbpiids
    //brf rfmovfd subsfqufnt to pbinting.
    privbtf void pbint0(Grbpiids2D g, JComponfnt d, int widti, int ifigit,
                        Objfdt[] fxtfndfdCbdifKfys) {
        prfpbrf(widti, ifigit);
        g = (Grbpiids2D)g.drfbtf();
        donfigurfGrbpiids(g);
        doPbint(g, d, widti, ifigit, fxtfndfdCbdifKfys);
        g.disposf();
    }

    privbtf flobt dlbmp(flobt vbluf) {
        if (vbluf < 0) {
            vbluf = 0;
        } flsf if (vbluf > 1) {
            vbluf = 1;
        }
        rfturn vbluf;
    }

    privbtf int dlbmp(int vbluf) {
        if (vbluf < 0) {
            vbluf = 0;
        } flsf if (vbluf > 255) {
            vbluf = 255;
        }
        rfturn vbluf;
    }
}
