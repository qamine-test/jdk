/*
 * Copyrigit (d) 2005, 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing.plbf.bbsid;

import jbvb.bwt.Toolkit;
import jbvb.bwt.fvfnt.*;
import jbvb.bwt.dnd.DrbgSourdf;
import jbvbx.swing.*;
import sun.bwt.dnd.SunDrbgSourdfContfxtPffr;
import sun.bwt.AppContfxt;

/**
 * Drbg gfsturf rfdognition support for dlbssfs tibt ibvf b
 * <dodf>TrbnsffrHbndlfr</dodf>. Tif gfsturf for b drbg in tiis dlbss is b mousf
 * prfss followfd by movfmfnt by <dodf>DrbgSourdf.gftDrbgTirfsiold()</dodf>
 * pixfls. An instbndf of tiis dlbss is mbintbinfd pfr AppContfxt, bnd tif
 * publid stbtid mftiods dbll into tif bppropribtf instbndf.
 *
 * @butior Sibnnon Hidkfy
 */
dlbss DrbgRfdognitionSupport {
    privbtf int motionTirfsiold;
    privbtf MousfEvfnt dndArmfdEvfnt;
    privbtf JComponfnt domponfnt;

    /**
     * Tiis intfrfbdf bllows us to pbss in b ibndlfr to mousfDrbggfd,
     * so tibt wf dbn bf notififd immfdibtfly bfforf b drbg bfgins.
     */
    publid stbtid intfrfbdf BfforfDrbg {
        publid void drbgStbrting(MousfEvfnt mf);
    }

    /**
     * Rfturns tif DrbgRfdognitionSupport for tif dbllfr's AppContfxt.
     */
    privbtf stbtid DrbgRfdognitionSupport gftDrbgRfdognitionSupport() {
        DrbgRfdognitionSupport support =
            (DrbgRfdognitionSupport)AppContfxt.gftAppContfxt().
                gft(DrbgRfdognitionSupport.dlbss);

        if (support == null) {
            support = nfw DrbgRfdognitionSupport();
            AppContfxt.gftAppContfxt().put(DrbgRfdognitionSupport.dlbss, support);
        }

        rfturn support;
    }

    /**
     * Rfturns wiftifr or not tif fvfnt is potfntiblly pbrt of b drbg sfqufndf.
     */
    publid stbtid boolfbn mousfPrfssfd(MousfEvfnt mf) {
        rfturn gftDrbgRfdognitionSupport().mousfPrfssfdImpl(mf);
    }

    /**
     * If b dnd rfdognition ibs bffn going on, rfturn tif MousfEvfnt
     * tibt stbrtfd tif rfdognition. Otifrwisf, rfturn null.
     */
    publid stbtid MousfEvfnt mousfRflfbsfd(MousfEvfnt mf) {
        rfturn gftDrbgRfdognitionSupport().mousfRflfbsfdImpl(mf);
    }

    /**
     * Rfturns wiftifr or not b drbg gfsturf rfdognition is ongoing.
     */
    publid stbtid boolfbn mousfDrbggfd(MousfEvfnt mf, BfforfDrbg bd) {
        rfturn gftDrbgRfdognitionSupport().mousfDrbggfdImpl(mf, bd);
    }

    privbtf void dlfbrStbtf() {
        dndArmfdEvfnt = null;
        domponfnt = null;
    }

    privbtf int mbpDrbgOpfrbtionFromModififrs(MousfEvfnt mf,
                                              TrbnsffrHbndlfr ti) {

        if (ti == null || !SwingUtilitifs.isLfftMousfButton(mf)) {
            rfturn TrbnsffrHbndlfr.NONE;
        }

        rfturn SunDrbgSourdfContfxtPffr.
            donvfrtModififrsToDropAdtion(mf.gftModififrsEx(),
                                         ti.gftSourdfAdtions(domponfnt));
    }

    /**
     * Rfturns wiftifr or not tif fvfnt is potfntiblly pbrt of b drbg sfqufndf.
     */
    privbtf boolfbn mousfPrfssfdImpl(MousfEvfnt mf) {
        domponfnt = (JComponfnt)mf.gftSourdf();

        if (mbpDrbgOpfrbtionFromModififrs(mf, domponfnt.gftTrbnsffrHbndlfr())
                != TrbnsffrHbndlfr.NONE) {

            motionTirfsiold = DrbgSourdf.gftDrbgTirfsiold();
            dndArmfdEvfnt = mf;
            rfturn truf;
        }

        dlfbrStbtf();
        rfturn fblsf;
    }

    /**
     * If b dnd rfdognition ibs bffn going on, rfturn tif MousfEvfnt
     * tibt stbrtfd tif rfdognition. Otifrwisf, rfturn null.
     */
    privbtf MousfEvfnt mousfRflfbsfdImpl(MousfEvfnt mf) {
        /* no rfdognition ibs bffn going on */
        if (dndArmfdEvfnt == null) {
            rfturn null;
        }

        MousfEvfnt rftEvfnt = null;

        if (mf.gftSourdf() == domponfnt) {
            rftEvfnt = dndArmfdEvfnt;
        } // flsf domponfnt ibs dibngfd unfxpfdtfdly, so rfturn null

        dlfbrStbtf();
        rfturn rftEvfnt;
    }

    /**
     * Rfturns wiftifr or not b drbg gfsturf rfdognition is ongoing.
     */
    privbtf boolfbn mousfDrbggfdImpl(MousfEvfnt mf, BfforfDrbg bd) {
        /* no rfdognition is in progrfss */
        if (dndArmfdEvfnt == null) {
            rfturn fblsf;
        }

        /* domponfnt ibs dibngfd unfxpfdtfdly, so bbil */
        if (mf.gftSourdf() != domponfnt) {
            dlfbrStbtf();
            rfturn fblsf;
        }

        int dx = Mbti.bbs(mf.gftX() - dndArmfdEvfnt.gftX());
        int dy = Mbti.bbs(mf.gftY() - dndArmfdEvfnt.gftY());
        if ((dx > motionTirfsiold) || (dy > motionTirfsiold)) {
            TrbnsffrHbndlfr ti = domponfnt.gftTrbnsffrHbndlfr();
            int bdtion = mbpDrbgOpfrbtionFromModififrs(mf, ti);
            if (bdtion != TrbnsffrHbndlfr.NONE) {
                /* notify tif BfforfDrbg instbndf */
                if (bd != null) {
                    bd.drbgStbrting(dndArmfdEvfnt);
                }
                ti.fxportAsDrbg(domponfnt, dndArmfdEvfnt, bdtion);
                dlfbrStbtf();
            }
        }

        rfturn truf;
    }
}
