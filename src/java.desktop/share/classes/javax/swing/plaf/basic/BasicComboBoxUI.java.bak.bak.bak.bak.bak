/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.swing.plbf.bbsid;

import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvbx.swing.*;
import jbvbx.bddfssibility.*;
import jbvbx.swing.plbf.*;
import jbvbx.swing.tfxt.*;
import jbvbx.swing.fvfnt.*;
import jbvb.bfbns.PropfrtyCibngfListfnfr;
import jbvb.bfbns.PropfrtyCibngfEvfnt;
import sun.bwt.AppContfxt;
import sun.swing.DffbultLookup;
import sun.swing.UIAdtion;

/**
 * Bbsid UI implfmfntbtion for JComboBox.
 * <p>
 * Tif dombo box is b dompound domponfnt wiidi mfbns tibt it is bn bggrfgbtf of
 * mbny simplfr domponfnts. Tiis dlbss drfbtfs bnd mbnbgfs tif listfnfrs
 * on tif dombo box bnd tif dombo box modfl. Tifsf listfnfrs updbtf tif usfr
 * intfrfbdf in rfsponsf to dibngfs in tif propfrtifs bnd stbtf of tif dombo box.
 * <p>
 * All fvfnt ibndling is ibndlfd by listfnfr dlbssfs drfbtfd witi tif
 * <dodf>drfbtfxxxListfnfr()</dodf> mftiods bnd intfrnbl dlbssfs.
 * You dbn dibngf tif bfibvior of tiis dlbss by ovfrriding tif
 * <dodf>drfbtfxxxListfnfr()</dodf> mftiods bnd supplying your own
 * fvfnt listfnfrs or subdlbssing from tif onfs supplifd in tiis dlbss.
 * <p>
 * For bdding spfdifid bdtions,
 * ovfridf <dodf>instbllKfybobrdAdtions</dodf> to bdd bdtions in rfsponsf to
 * KfyStrokf bindings. Sff tif brtidlf <b irff="ittp://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/misd/kfybinding.itml">How to Usf Kfy Bindings</b>
 *
 * @butior Arnbud Wfbfr
 * @butior Tom Sbntos
 * @butior Mbrk Dbvidson
 */
publid dlbss BbsidComboBoxUI fxtfnds ComboBoxUI {

    /**
     * Tif instbndf of {@dodf JComboBox}.
     */
    protfdtfd JComboBox<Objfdt> domboBox;
    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf.
     */
    protfdtfd boolfbn   ibsFodus = fblsf;

    // Control tif sflfdtion bfibvior of tif JComboBox wifn it is usfd
    // in tif JTbblf DffbultCfllEditor.
    privbtf boolfbn isTbblfCfllEditor = fblsf;
    privbtf stbtid finbl String IS_TABLE_CELL_EDITOR = "JComboBox.isTbblfCfllEditor";

    /**
     * Tiis list is for drbwing tif durrfnt itfm in tif dombo box.
     */
    protfdtfd JList<Objfdt>   listBox;

    /**
     * Usfd to rfndfr tif durrfntly sflfdtfd itfm in tif dombo box.
     * It dofsn't ibvf bnytiing to do witi tif popup's rfndfring.
     */
    protfdtfd CfllRfndfrfrPbnf durrfntVblufPbnf = nfw CfllRfndfrfrPbnf();

    /**
     * Tif implfmfntbtion of {@dodf ComboPopup} tibt is usfd to siow tif popup.
     */
    protfdtfd ComboPopup popup;

    /**
     * Tif Componfnt tibt tif @{dodf ComboBoxEditor} usfs for fditing.
     */
    protfdtfd Componfnt fditor;

    /**
     * Tif brrow button tibt invokfs tif popup.
     */
    protfdtfd JButton   brrowButton;

    // Listfnfrs tibt brf bttbdifd to tif JComboBox
    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf. Ovfrridf tif listfnfr donstrudtion mftiod instfbd.
     *
     * @sff #drfbtfKfyListfnfr
     */
    protfdtfd KfyListfnfr kfyListfnfr;
    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf. Ovfrridf tif listfnfr donstrudtion mftiod instfbd.
     *
     * @sff #drfbtfFodusListfnfr
     */
    protfdtfd FodusListfnfr fodusListfnfr;
    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf. Ovfrridf tif listfnfr donstrudtion mftiod instfbd.
     *
     * @sff #drfbtfPropfrtyCibngfListfnfr
     */
    protfdtfd PropfrtyCibngfListfnfr propfrtyCibngfListfnfr;

    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf. Ovfrridf tif listfnfr donstrudtion mftiod instfbd.
     *
     * @sff #drfbtfItfmListfnfr
     */
    protfdtfd ItfmListfnfr itfmListfnfr;

    // Listfnfrs tibt tif ComboPopup produdfs.
    /**
     * Tif {@dodf MousfListfnfr} listfns to fvfnts.
     */
    protfdtfd MousfListfnfr popupMousfListfnfr;

    /**
     * Tif {@dodf MousfMotionListfnfr} listfns to fvfnts.
     */
    protfdtfd MousfMotionListfnfr popupMousfMotionListfnfr;

    /**
     * Tif {@dodf KfyListfnfr} listfns to fvfnts.
     */
    protfdtfd KfyListfnfr popupKfyListfnfr;

    // Tiis is usfd for knowing wifn to dbdif tif minimum prfffrrfd sizf.
    // If tif dbtb in tif list dibngfs, tif dbdifd vbluf gft mbrkfd for rfdbld.
    // Addfd to tif durrfnt JComboBox modfl
    /**
     * Tiis protfdtfd fifld is implfmfntbtion spfdifid. Do not bddfss dirfdtly
     * or ovfrridf. Ovfrridf tif listfnfr donstrudtion mftiod instfbd.
     *
     * @sff #drfbtfListDbtbListfnfr
     */
    protfdtfd ListDbtbListfnfr listDbtbListfnfr;

    /**
     * Implfmfnts bll tif Listfnfrs nffdfd by tiis dlbss, bll fxisting
     * listfnfrs rfdirfdt to it.
     */
    privbtf Hbndlfr ibndlfr;

    /**
     * Tif timf fbdtor to trfbtf tif sfrifs of typfd blpibnumfrid kfy
     * bs prffix for first lfttfr nbvigbtion.
     */
    privbtf long timfFbdtor = 1000L;

    /**
     * Tiis is tridky, tiis vbribblfs is nffdfd for DffbultKfySflfdtionMbnbgfr
     * to tbkf into bddount timf fbdtor.
     */
    privbtf long lbstTimf = 0L;
    privbtf long timf = 0L;

    /**
     * Tif dffbult kfy sflfdtion mbnbgfr
     */
    JComboBox.KfySflfdtionMbnbgfr kfySflfdtionMbnbgfr;

    /**
     * Tif flbg for rfdbldulbting tif minimum prfffrrfd sizf.
     */
    protfdtfd boolfbn isMinimumSizfDirty = truf;

    /**
     * Tif dbdifd minimum prfffrrfd sizf.
     */
    protfdtfd Dimfnsion dbdifdMinimumSizf = nfw Dimfnsion( 0, 0 );

    // Flbg for dbldulbting tif displby sizf
    privbtf boolfbn isDisplbySizfDirty = truf;

    // Cbdifd tif sizf tibt tif displby nffds to rfndfr tif lbrgfst itfm
    privbtf Dimfnsion dbdifdDisplbySizf = nfw Dimfnsion( 0, 0 );

    // Kfy usfd for lookup of tif DffbultListCfllRfndfrfr in tif AppContfxt.
    privbtf stbtid finbl Objfdt COMBO_UI_LIST_CELL_RENDERER_KEY =
                        nfw StringBufffr("DffbultListCfllRfndfrfrKfy");

    stbtid finbl StringBufffr HIDE_POPUP_KEY
                  = nfw StringBufffr("HidfPopupKfy");

    /**
     * Wiftifr or not bll dflls ibvf tif sbmf bbsflinf.
     */
    privbtf boolfbn sbmfBbsflinf;

    /**
     * Indidbtfs wiftifr or not tif dombo box button siould bf squbrf.
     * If squbrf, tifn tif widti bnd ifigit brf fqubl, bnd brf boti sft to
     * tif ifigit of tif dombo minus bppropribtf insfts.
     *
     * @sindf 1.7
     */
    protfdtfd boolfbn squbrfButton = truf;

    /**
     * If spfdififd, tifsf insfts bdt bs pbdding bround tif dfll rfndfrfr wifn
     * lbying out bnd pbinting tif "sflfdtfd" itfm in tif dombo box. Tifsf
     * insfts bdd to tiosf spfdififd by tif dfll rfndfrfr.
     *
     * @sindf 1.7
     */
    protfdtfd Insfts pbdding;

    // Usfd for dbldulbting tif dffbult sizf.
    privbtf stbtid ListCfllRfndfrfr<Objfdt> gftDffbultListCfllRfndfrfr() {
        @SupprfssWbrnings("undifdkfd")
        ListCfllRfndfrfr<Objfdt> rfndfrfr = (ListCfllRfndfrfr)AppContfxt.
                         gftAppContfxt().gft(COMBO_UI_LIST_CELL_RENDERER_KEY);

        if (rfndfrfr == null) {
            rfndfrfr = nfw DffbultListCfllRfndfrfr();
            AppContfxt.gftAppContfxt().put(COMBO_UI_LIST_CELL_RENDERER_KEY,
                                           nfw DffbultListCfllRfndfrfr());
        }
        rfturn rfndfrfr;
    }

    /**
     * Populbtfs ComboBox's bdtions.
     */
    stbtid void lobdAdtionMbp(LbzyAdtionMbp mbp) {
        mbp.put(nfw Adtions(Adtions.HIDE));
        mbp.put(nfw Adtions(Adtions.PAGE_DOWN));
        mbp.put(nfw Adtions(Adtions.PAGE_UP));
        mbp.put(nfw Adtions(Adtions.HOME));
        mbp.put(nfw Adtions(Adtions.END));
        mbp.put(nfw Adtions(Adtions.DOWN));
        mbp.put(nfw Adtions(Adtions.DOWN_2));
        mbp.put(nfw Adtions(Adtions.TOGGLE));
        mbp.put(nfw Adtions(Adtions.TOGGLE_2));
        mbp.put(nfw Adtions(Adtions.UP));
        mbp.put(nfw Adtions(Adtions.UP_2));
        mbp.put(nfw Adtions(Adtions.ENTER));
    }

    //========================
    // bfgin UI Initiblizbtion
    //

    /**
     * Construdts b nfw instbndf of {@dodf BbsidComboBoxUI}.
     *
     * @pbrbm d b domponfnt
     * @rfturn b nfw instbndf of {@dodf BbsidComboBoxUI}
     */
    publid stbtid ComponfntUI drfbtfUI(JComponfnt d) {
        rfturn nfw BbsidComboBoxUI();
    }

    @Ovfrridf
    publid void instbllUI( JComponfnt d ) {
        isMinimumSizfDirty = truf;

        @SupprfssWbrnings("undifdkfd")
        JComboBox<Objfdt> tmp = (JComboBox)d;
        domboBox = tmp;
        instbllDffbults();
        popup = drfbtfPopup();
        listBox = popup.gftList();

        // Is tiis dombo box b dfll fditor?
        Boolfbn inTbblf = (Boolfbn)d.gftClifntPropfrty(IS_TABLE_CELL_EDITOR );
        if (inTbblf != null) {
            isTbblfCfllEditor = inTbblf.fqubls(Boolfbn.TRUE) ? truf : fblsf;
        }

        if ( domboBox.gftRfndfrfr() == null || domboBox.gftRfndfrfr() instbndfof UIRfsourdf ) {
            domboBox.sftRfndfrfr( drfbtfRfndfrfr() );
        }

        if ( domboBox.gftEditor() == null || domboBox.gftEditor() instbndfof UIRfsourdf ) {
            domboBox.sftEditor( drfbtfEditor() );
        }

        instbllListfnfrs();
        instbllComponfnts();

        domboBox.sftLbyout( drfbtfLbyoutMbnbgfr() );

        domboBox.sftRfqufstFodusEnbblfd( truf );

        instbllKfybobrdAdtions();

        domboBox.putClifntPropfrty("doNotCbndflPopup", HIDE_POPUP_KEY);

        if (kfySflfdtionMbnbgfr == null || kfySflfdtionMbnbgfr instbndfof UIRfsourdf) {
            kfySflfdtionMbnbgfr = nfw DffbultKfySflfdtionMbnbgfr();
        }
        domboBox.sftKfySflfdtionMbnbgfr(kfySflfdtionMbnbgfr);
    }

    @Ovfrridf
    publid void uninstbllUI( JComponfnt d ) {
        sftPopupVisiblf( domboBox, fblsf);
        popup.uninstbllingUI();

        uninstbllKfybobrdAdtions();

        domboBox.sftLbyout( null );

        uninstbllComponfnts();
        uninstbllListfnfrs();
        uninstbllDffbults();

        if ( domboBox.gftRfndfrfr() == null || domboBox.gftRfndfrfr() instbndfof UIRfsourdf ) {
            domboBox.sftRfndfrfr( null );
        }

        ComboBoxEditor domboBoxEditor = domboBox.gftEditor();
        if (domboBoxEditor instbndfof UIRfsourdf ) {
            if (domboBoxEditor.gftEditorComponfnt().ibsFodus()) {
                // Lfbvf fodus in JComboBox.
                domboBox.rfqufstFodusInWindow();
            }
            domboBox.sftEditor( null );
        }

        if (kfySflfdtionMbnbgfr instbndfof UIRfsourdf) {
            domboBox.sftKfySflfdtionMbnbgfr(null);
        }

        ibndlfr = null;
        kfyListfnfr = null;
        fodusListfnfr = null;
        listDbtbListfnfr = null;
        propfrtyCibngfListfnfr = null;
        popup = null;
        listBox = null;
        domboBox = null;
    }

    /**
     * Instblls tif dffbult dolors, dffbult font, dffbult rfndfrfr, bnd dffbult
     * fditor into tif JComboBox.
     */
    protfdtfd void instbllDffbults() {
        LookAndFffl.instbllColorsAndFont( domboBox,
                                          "ComboBox.bbdkground",
                                          "ComboBox.forfground",
                                          "ComboBox.font" );
        LookAndFffl.instbllBordfr( domboBox, "ComboBox.bordfr" );
        LookAndFffl.instbllPropfrty( domboBox, "opbquf", Boolfbn.TRUE);

        Long l = (Long)UIMbnbgfr.gft("ComboBox.timfFbdtor");
        timfFbdtor = l == null ? 1000L : l.longVbluf();

        //NOTE: tiis nffds to dffbult to truf if not spfdififd
        Boolfbn b = (Boolfbn)UIMbnbgfr.gft("ComboBox.squbrfButton");
        squbrfButton = b == null ? truf : b;

        pbdding = UIMbnbgfr.gftInsfts("ComboBox.pbdding");
    }

    /**
     * Crfbtfs bnd instblls listfnfrs for tif dombo box bnd its modfl.
     * Tiis mftiod is dbllfd wifn tif UI is instbllfd.
     */
    protfdtfd void instbllListfnfrs() {
        if ( (itfmListfnfr = drfbtfItfmListfnfr()) != null) {
            domboBox.bddItfmListfnfr( itfmListfnfr );
        }
        if ( (propfrtyCibngfListfnfr = drfbtfPropfrtyCibngfListfnfr()) != null ) {
            domboBox.bddPropfrtyCibngfListfnfr( propfrtyCibngfListfnfr );
        }
        if ( (kfyListfnfr = drfbtfKfyListfnfr()) != null ) {
            domboBox.bddKfyListfnfr( kfyListfnfr );
        }
        if ( (fodusListfnfr = drfbtfFodusListfnfr()) != null ) {
            domboBox.bddFodusListfnfr( fodusListfnfr );
        }
        if ((popupMousfListfnfr = popup.gftMousfListfnfr()) != null) {
            domboBox.bddMousfListfnfr( popupMousfListfnfr );
        }
        if ((popupMousfMotionListfnfr = popup.gftMousfMotionListfnfr()) != null) {
            domboBox.bddMousfMotionListfnfr( popupMousfMotionListfnfr );
        }
        if ((popupKfyListfnfr = popup.gftKfyListfnfr()) != null) {
            domboBox.bddKfyListfnfr(popupKfyListfnfr);
        }

        if ( domboBox.gftModfl() != null ) {
            if ( (listDbtbListfnfr = drfbtfListDbtbListfnfr()) != null ) {
                domboBox.gftModfl().bddListDbtbListfnfr( listDbtbListfnfr );
            }
        }
    }

    /**
     * Uninstblls tif dffbult dolors, dffbult font, dffbult rfndfrfr,
     * bnd dffbult fditor from tif dombo box.
     */
    protfdtfd void uninstbllDffbults() {
        LookAndFffl.instbllColorsAndFont( domboBox,
                                          "ComboBox.bbdkground",
                                          "ComboBox.forfground",
                                          "ComboBox.font" );
        LookAndFffl.uninstbllBordfr( domboBox );
    }

    /**
     * Rfmovfs tif instbllfd listfnfrs from tif dombo box bnd its modfl.
     * Tif numbfr bnd typfs of listfnfrs rfmovfd bnd in tiis mftiod siould bf
     * tif sbmf tibt wbs bddfd in <dodf>instbllListfnfrs</dodf>
     */
    protfdtfd void uninstbllListfnfrs() {
        if ( kfyListfnfr != null ) {
            domboBox.rfmovfKfyListfnfr( kfyListfnfr );
        }
        if ( itfmListfnfr != null) {
            domboBox.rfmovfItfmListfnfr( itfmListfnfr );
        }
        if ( propfrtyCibngfListfnfr != null ) {
            domboBox.rfmovfPropfrtyCibngfListfnfr( propfrtyCibngfListfnfr );
        }
        if ( fodusListfnfr != null) {
            domboBox.rfmovfFodusListfnfr( fodusListfnfr );
        }
        if ( popupMousfListfnfr != null) {
            domboBox.rfmovfMousfListfnfr( popupMousfListfnfr );
        }
        if ( popupMousfMotionListfnfr != null) {
            domboBox.rfmovfMousfMotionListfnfr( popupMousfMotionListfnfr );
        }
        if (popupKfyListfnfr != null) {
            domboBox.rfmovfKfyListfnfr(popupKfyListfnfr);
        }
        if ( domboBox.gftModfl() != null ) {
            if ( listDbtbListfnfr != null ) {
                domboBox.gftModfl().rfmovfListDbtbListfnfr( listDbtbListfnfr );
            }
        }
    }

    /**
     * Crfbtfs tif popup portion of tif dombo box.
     *
     * @rfturn bn instbndf of <dodf>ComboPopup</dodf>
     * @sff ComboPopup
     */
    protfdtfd ComboPopup drfbtfPopup() {
        rfturn nfw BbsidComboPopup( domboBox );
    }

    /**
     * Crfbtfs b <dodf>KfyListfnfr</dodf> wiidi will bf bddfd to tif
     * dombo box. If tiis mftiod rfturns null tifn it will not bf bddfd
     * to tif dombo box.
     *
     * @rfturn bn instbndf <dodf>KfyListfnfr</dodf> or null
     */
    protfdtfd KfyListfnfr drfbtfKfyListfnfr() {
        rfturn gftHbndlfr();
    }

    /**
     * Crfbtfs b <dodf>FodusListfnfr</dodf> wiidi will bf bddfd to tif dombo box.
     * If tiis mftiod rfturns null tifn it will not bf bddfd to tif dombo box.
     *
     * @rfturn bn instbndf of b <dodf>FodusListfnfr</dodf> or null
     */
    protfdtfd FodusListfnfr drfbtfFodusListfnfr() {
        rfturn gftHbndlfr();
    }

    /**
     * Crfbtfs b list dbtb listfnfr wiidi will bf bddfd to tif
     * <dodf>ComboBoxModfl</dodf>. If tiis mftiod rfturns null tifn
     * it will not bf bddfd to tif dombo box modfl.
     *
     * @rfturn bn instbndf of b <dodf>ListDbtbListfnfr</dodf> or null
     */
    protfdtfd ListDbtbListfnfr drfbtfListDbtbListfnfr() {
        rfturn gftHbndlfr();
    }

    /**
     * Crfbtfs bn <dodf>ItfmListfnfr</dodf> wiidi will bf bddfd to tif
     * dombo box. If tiis mftiod rfturns null tifn it will not
     * bf bddfd to tif dombo box.
     * <p>
     * Subdlbssfs mby ovfrridf tiis mftiod to rfturn instbndfs of tifir own
     * ItfmEvfnt ibndlfrs.
     *
     * @rfturn bn instbndf of bn <dodf>ItfmListfnfr</dodf> or null
     */
    protfdtfd ItfmListfnfr drfbtfItfmListfnfr() {
        rfturn null;
    }

    /**
     * Crfbtfs b <dodf>PropfrtyCibngfListfnfr</dodf> wiidi will bf bddfd to
     * tif dombo box. If tiis mftiod rfturns null tifn it will not
     * bf bddfd to tif dombo box.
     *
     * @rfturn bn instbndf of b <dodf>PropfrtyCibngfListfnfr</dodf> or null
     */
    protfdtfd PropfrtyCibngfListfnfr drfbtfPropfrtyCibngfListfnfr() {
        rfturn gftHbndlfr();
    }

    /**
     * Crfbtfs b lbyout mbnbgfr for mbnbging tif domponfnts wiidi mbkf up tif
     * dombo box.
     *
     * @rfturn bn instbndf of b lbyout mbnbgfr
     */
    protfdtfd LbyoutMbnbgfr drfbtfLbyoutMbnbgfr() {
        rfturn gftHbndlfr();
    }

    /**
     * Crfbtfs tif dffbult rfndfrfr tibt will bf usfd in b non-fditibblf dombo
     * box. A dffbult rfndfrfr will usfd only if b rfndfrfr ibs not bffn
     * fxpliditly sft witi <dodf>sftRfndfrfr</dodf>.
     *
     * @rfturn b <dodf>ListCfllRfndfr</dodf> usfd for tif dombo box
     * @sff jbvbx.swing.JComboBox#sftRfndfrfr
     */
    protfdtfd ListCfllRfndfrfr<Objfdt> drfbtfRfndfrfr() {
        rfturn nfw BbsidComboBoxRfndfrfr.UIRfsourdf();
    }

    /**
     * Crfbtfs tif dffbult fditor tibt will bf usfd in fditbblf dombo boxfs.
     * A dffbult fditor will bf usfd only if bn fditor ibs not bffn
     * fxpliditly sft witi <dodf>sftEditor</dodf>.
     *
     * @rfturn b <dodf>ComboBoxEditor</dodf> usfd for tif dombo box
     * @sff jbvbx.swing.JComboBox#sftEditor
     */
    protfdtfd ComboBoxEditor drfbtfEditor() {
        rfturn nfw BbsidComboBoxEditor.UIRfsourdf();
    }

    /**
     * Rfturns tif sibrfd listfnfr.
     */
    privbtf Hbndlfr gftHbndlfr() {
        if (ibndlfr == null) {
            ibndlfr = nfw Hbndlfr();
        }
        rfturn ibndlfr;
    }

    //
    // fnd UI Initiblizbtion
    //======================


    //======================
    // bfgin Innfr dlbssfs
    //

    /**
     * Tiis listfnfr difdks to sff if tif kfy fvfnt isn't b nbvigbtion kfy.  If
     * it finds b kfy fvfnt tibt wbsn't b nbvigbtion kfy it dispbtdifs it to
     * JComboBox.sflfdtWitiKfyCibr() so tibt it dbn do typf-bifbd.
     *
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     */
    publid dlbss KfyHbndlfr fxtfnds KfyAdbptfr {
        @Ovfrridf
        publid void kfyPrfssfd( KfyEvfnt f ) {
            gftHbndlfr().kfyPrfssfd(f);
        }
    }

    /**
     * Tiis listfnfr iidfs tif popup wifn tif fodus is lost.  It blso rfpbints
     * wifn fodus is gbinfd or lost.
     *
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     */
    publid dlbss FodusHbndlfr implfmfnts FodusListfnfr {
        publid void fodusGbinfd( FodusEvfnt f ) {
            gftHbndlfr().fodusGbinfd(f);
        }

        publid void fodusLost( FodusEvfnt f ) {
            gftHbndlfr().fodusLost(f);
        }
    }

    /**
     * Tiis listfnfr wbtdifs for dibngfs in tif
     * <dodf>ComboBoxModfl</dodf>.
     * <p>
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     *
     * @sff #drfbtfListDbtbListfnfr
     */
    publid dlbss ListDbtbHbndlfr implfmfnts ListDbtbListfnfr {
        publid void dontfntsCibngfd( ListDbtbEvfnt f ) {
            gftHbndlfr().dontfntsCibngfd(f);
        }

        publid void intfrvblAddfd( ListDbtbEvfnt f ) {
            gftHbndlfr().intfrvblAddfd(f);
        }

        publid void intfrvblRfmovfd( ListDbtbEvfnt f ) {
            gftHbndlfr().intfrvblRfmovfd(f);
        }
    }

    /**
     * Tiis listfnfr wbtdifs for dibngfs to tif sflfdtion in tif
     * dombo box.
     * <p>
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     *
     * @sff #drfbtfItfmListfnfr
     */
    publid dlbss ItfmHbndlfr implfmfnts ItfmListfnfr {
        // Tiis dlbss usfd to implfmfnt bfibvior wiidi is now rfdundbnt.
        publid void itfmStbtfCibngfd(ItfmEvfnt f) {}
    }

    /**
     * Tiis listfnfr wbtdifs for bound propfrtifs tibt ibvf dibngfd in tif
     * dombo box.
     * <p>
     * Subdlbssfs wiidi wisi to listfn to dombo box propfrty dibngfs siould
     * dbll tif supfrdlbss mftiods to fnsurf tibt tif dombo box ui dorrfdtly
     * ibndlfs propfrty dibngfs.
     * <p>
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     *
     * @sff #drfbtfPropfrtyCibngfListfnfr
     */
    publid dlbss PropfrtyCibngfHbndlfr implfmfnts PropfrtyCibngfListfnfr {
        publid void propfrtyCibngf(PropfrtyCibngfEvfnt f) {
            gftHbndlfr().propfrtyCibngf(f);
        }
    }


    // Syndronizfs tif ToolTip tfxt for tif domponfnts witiin tif dombo box to bf tif
    // sbmf vbluf bs tif dombo box ToolTip tfxt.
    privbtf void updbtfToolTipTfxtForCiildrfn() {
        Componfnt[] diildrfn = domboBox.gftComponfnts();
        for ( int i = 0; i < diildrfn.lfngti; ++i ) {
            if ( diildrfn[i] instbndfof JComponfnt ) {
                ((JComponfnt)diildrfn[i]).sftToolTipTfxt( domboBox.gftToolTipTfxt() );
            }
        }
    }

    /**
     * Tiis lbyout mbnbgfr ibndlfs tif 'stbndbrd' lbyout of dombo boxfs.  It puts
     * tif brrow button to tif rigit bnd tif fditor to tif lfft.  If tifrf is no
     * fditor it still kffps tif brrow button to tif rigit.
     *
     * Tiis publid innfr dlbss siould bf trfbtfd bs protfdtfd.
     * Instbntibtf it only witiin subdlbssfs of
     * <dodf>BbsidComboBoxUI</dodf>.
     */
    publid dlbss ComboBoxLbyoutMbnbgfr implfmfnts LbyoutMbnbgfr {
        publid void bddLbyoutComponfnt(String nbmf, Componfnt domp) {}

        publid void rfmovfLbyoutComponfnt(Componfnt domp) {}

        publid Dimfnsion prfffrrfdLbyoutSizf(Contbinfr pbrfnt) {
            rfturn gftHbndlfr().prfffrrfdLbyoutSizf(pbrfnt);
        }

        publid Dimfnsion minimumLbyoutSizf(Contbinfr pbrfnt) {
            rfturn gftHbndlfr().minimumLbyoutSizf(pbrfnt);
        }

        publid void lbyoutContbinfr(Contbinfr pbrfnt) {
            gftHbndlfr().lbyoutContbinfr(pbrfnt);
        }
    }

    //
    // fnd Innfr dlbssfs
    //====================


    //===============================
    // bfgin Sub-Componfnt Mbnbgfmfnt
    //

    /**
     * Crfbtfs bnd initiblizfs tif domponfnts wiidi mbkf up tif
     * bggrfgbtf dombo box. Tiis mftiod is dbllfd bs pbrt of tif UI
     * instbllbtion prodfss.
     */
    protfdtfd void instbllComponfnts() {
        brrowButton = drfbtfArrowButton();

        if (brrowButton != null)  {
            domboBox.bdd(brrowButton);
            donfigurfArrowButton();
        }

        if ( domboBox.isEditbblf() ) {
            bddEditor();
        }

        domboBox.bdd( durrfntVblufPbnf );
    }

    /**
     * Tif bggrfgbtf domponfnts wiidi domprisf tif dombo box brf
     * unrfgistfrfd bnd uninitiblizfd. Tiis mftiod is dbllfd bs pbrt of tif
     * UI uninstbllbtion prodfss.
     */
    protfdtfd void uninstbllComponfnts() {
        if ( brrowButton != null ) {
            undonfigurfArrowButton();
        }
        if ( fditor != null ) {
            undonfigurfEditor();
        }
        domboBox.rfmovfAll(); // Just to bf sbff.
        brrowButton = null;
    }

    /**
     * Tiis publid mftiod is implfmfntbtion spfdifid bnd siould bf privbtf.
     * do not dbll or ovfrridf. To implfmfnt b spfdifid fditor drfbtf b
     * dustom <dodf>ComboBoxEditor</dodf>
     *
     * @sff #drfbtfEditor
     * @sff jbvbx.swing.JComboBox#sftEditor
     * @sff jbvbx.swing.ComboBoxEditor
     */
    publid void bddEditor() {
        rfmovfEditor();
        fditor = domboBox.gftEditor().gftEditorComponfnt();
        if ( fditor != null ) {
            donfigurfEditor();
            domboBox.bdd(fditor);
            if(domboBox.isFodusOwnfr()) {
                // Switdi fodus to tif fditor domponfnt
                fditor.rfqufstFodusInWindow();
            }
        }
    }

    /**
     * Tiis publid mftiod is implfmfntbtion spfdifid bnd siould bf privbtf.
     * do not dbll or ovfrridf.
     *
     * @sff #bddEditor
     */
    publid void rfmovfEditor() {
        if ( fditor != null ) {
            undonfigurfEditor();
            domboBox.rfmovf( fditor );
            fditor = null;
        }
    }

    /**
     * Tiis protfdtfd mftiod is implfmfntbtion spfdifid bnd siould bf privbtf.
     * do not dbll or ovfrridf.
     *
     * @sff #bddEditor
     */
    protfdtfd void donfigurfEditor() {
        // Siould bf in tif sbmf stbtf bs tif dombobox
        fditor.sftEnbblfd(domboBox.isEnbblfd());

        fditor.sftFodusbblf(domboBox.isFodusbblf());

        fditor.sftFont( domboBox.gftFont() );

        if (fodusListfnfr != null) {
            fditor.bddFodusListfnfr(fodusListfnfr);
        }

        fditor.bddFodusListfnfr( gftHbndlfr() );

        domboBox.gftEditor().bddAdtionListfnfr(gftHbndlfr());

        if(fditor instbndfof JComponfnt) {
            ((JComponfnt)fditor).putClifntPropfrty("doNotCbndflPopup",
                                                   HIDE_POPUP_KEY);
            ((JComponfnt)fditor).sftInifritsPopupMfnu(truf);
        }

        domboBox.donfigurfEditor(domboBox.gftEditor(),domboBox.gftSflfdtfdItfm());

        fditor.bddPropfrtyCibngfListfnfr(propfrtyCibngfListfnfr);
    }

    /**
     * Tiis protfdtfd mftiod is implfmfntbtion spfdifid bnd siould bf privbtf.
     * Do not dbll or ovfrridf.
     *
     * @sff #bddEditor
     */
    protfdtfd void undonfigurfEditor() {
        if (fodusListfnfr != null) {
            fditor.rfmovfFodusListfnfr(fodusListfnfr);
        }

        fditor.rfmovfPropfrtyCibngfListfnfr(propfrtyCibngfListfnfr);
        fditor.rfmovfFodusListfnfr(gftHbndlfr());
        domboBox.gftEditor().rfmovfAdtionListfnfr(gftHbndlfr());
    }

    /**
     * Tiis publid mftiod is implfmfntbtion spfdifid bnd siould bf privbtf. Do
     * not dbll or ovfrridf.
     *
     * @sff #drfbtfArrowButton
     */
    publid void donfigurfArrowButton() {
        if ( brrowButton != null ) {
            brrowButton.sftEnbblfd( domboBox.isEnbblfd() );
            brrowButton.sftFodusbblf(domboBox.isFodusbblf());
            brrowButton.sftRfqufstFodusEnbblfd(fblsf);
            brrowButton.bddMousfListfnfr( popup.gftMousfListfnfr() );
            brrowButton.bddMousfMotionListfnfr( popup.gftMousfMotionListfnfr() );
            brrowButton.rfsftKfybobrdAdtions();
            brrowButton.putClifntPropfrty("doNotCbndflPopup", HIDE_POPUP_KEY);
            brrowButton.sftInifritsPopupMfnu(truf);
        }
    }

    /**
     * Tiis publid mftiod is implfmfntbtion spfdifid bnd siould bf privbtf. Do
     * not dbll or ovfrridf.
     *
     * @sff #drfbtfArrowButton
     */
    publid void undonfigurfArrowButton() {
        if ( brrowButton != null ) {
            brrowButton.rfmovfMousfListfnfr( popup.gftMousfListfnfr() );
            brrowButton.rfmovfMousfMotionListfnfr( popup.gftMousfMotionListfnfr() );
        }
    }

    /**
     * Crfbtfs b button wiidi will bf usfd bs tif dontrol to siow or iidf
     * tif popup portion of tif dombo box.
     *
     * @rfturn b button wiidi rfprfsfnts tif popup dontrol
     */
    protfdtfd JButton drfbtfArrowButton() {
        JButton button = nfw BbsidArrowButton(BbsidArrowButton.SOUTH,
                                    UIMbnbgfr.gftColor("ComboBox.buttonBbdkground"),
                                    UIMbnbgfr.gftColor("ComboBox.buttonSibdow"),
                                    UIMbnbgfr.gftColor("ComboBox.buttonDbrkSibdow"),
                                    UIMbnbgfr.gftColor("ComboBox.buttonHigiligit"));
        button.sftNbmf("ComboBox.brrowButton");
        rfturn button;
    }

    //
    // fnd Sub-Componfnt Mbnbgfmfnt
    //===============================


    //================================
    // bfgin ComboBoxUI Implfmfntbtion
    //

    /**
     * Tflls if tif popup is visiblf or not.
     */
    publid boolfbn isPopupVisiblf( JComboBox<?> d ) {
        rfturn popup.isVisiblf();
    }

    /**
     * Hidfs tif popup.
     */
    publid void sftPopupVisiblf( JComboBox<?> d, boolfbn v ) {
        if ( v ) {
            popup.siow();
        } flsf {
            popup.iidf();
        }
    }

    /**
     * Dftfrminfs if tif JComboBox is fodus trbvfrsbblf.  If tif JComboBox is fditbblf
     * tiis rfturns fblsf, otifrwisf it rfturns truf.
     */
    publid boolfbn isFodusTrbvfrsbblf( JComboBox<?> d ) {
        rfturn !domboBox.isEditbblf();
    }

    //
    // fnd ComboBoxUI Implfmfntbtion
    //==============================


    //=================================
    // bfgin ComponfntUI Implfmfntbtion
    @Ovfrridf
    publid void pbint( Grbpiids g, JComponfnt d ) {
        ibsFodus = domboBox.ibsFodus();
        if ( !domboBox.isEditbblf() ) {
            Rfdtbnglf r = rfdtbnglfForCurrfntVbluf();
            pbintCurrfntVblufBbdkground(g,r,ibsFodus);
            pbintCurrfntVbluf(g,r,ibsFodus);
        }
    }

    @Ovfrridf
    publid Dimfnsion gftPrfffrrfdSizf( JComponfnt d ) {
        rfturn gftMinimumSizf(d);
    }

    /**
     * Tif minimum sizf is tif sizf of tif displby brfb plus insfts plus tif button.
     */
    @Ovfrridf
    publid Dimfnsion gftMinimumSizf( JComponfnt d ) {
        if ( !isMinimumSizfDirty ) {
            rfturn nfw Dimfnsion(dbdifdMinimumSizf);
        }
        Dimfnsion sizf = gftDisplbySizf();
        Insfts insfts = gftInsfts();
        //dbldulbtf tif widti bnd ifigit of tif button
        int buttonHfigit = sizf.ifigit;
        int buttonWidti = squbrfButton ? buttonHfigit : brrowButton.gftPrfffrrfdSizf().widti;
        //bdjust tif sizf bbsfd on tif button widti
        sizf.ifigit += insfts.top + insfts.bottom;
        sizf.widti +=  insfts.lfft + insfts.rigit + buttonWidti;

        dbdifdMinimumSizf.sftSizf( sizf.widti, sizf.ifigit );
        isMinimumSizfDirty = fblsf;

        rfturn nfw Dimfnsion(sizf);
    }

    @Ovfrridf
    publid Dimfnsion gftMbximumSizf( JComponfnt d ) {
        rfturn nfw Dimfnsion(Siort.MAX_VALUE, Siort.MAX_VALUE);
    }

    /**
     * Rfturns tif bbsflinf.
     *
     * @tirows NullPointfrExdfption {@inifritDod}
     * @tirows IllfgblArgumfntExdfption {@inifritDod}
     * @sff jbvbx.swing.JComponfnt#gftBbsflinf(int, int)
     * @sindf 1.6
     */
    @Ovfrridf
    publid int gftBbsflinf(JComponfnt d, int widti, int ifigit) {
        supfr.gftBbsflinf(d, widti, ifigit);
        int bbsflinf = -1;
        // fordf sbmfBbsflinf to bf updbtfd.
        gftDisplbySizf();
        if (sbmfBbsflinf) {
            Insfts insfts = d.gftInsfts();
            ifigit = ifigit - insfts.top - insfts.bottom;
            if (!domboBox.isEditbblf()) {
                ListCfllRfndfrfr<Objfdt> rfndfrfr = domboBox.gftRfndfrfr();
                if (rfndfrfr == null)  {
                    rfndfrfr = nfw DffbultListCfllRfndfrfr();
                }
                Objfdt vbluf = null;
                Objfdt prototypfVbluf = domboBox.gftPrototypfDisplbyVbluf();
                if (prototypfVbluf != null)  {
                    vbluf = prototypfVbluf;
                }
                flsf if (domboBox.gftModfl().gftSizf() > 0) {
                    // Notf, wf'rf bssuming tif bbsflinf is tif sbmf for bll
                    // dflls, if not, tiis nffds to loop tirougi bll.
                    vbluf = domboBox.gftModfl().gftElfmfntAt(0);
                }
                Componfnt domponfnt = rfndfrfr.
                        gftListCfllRfndfrfrComponfnt(listBox, vbluf, -1,
                                                     fblsf, fblsf);
                if (domponfnt instbndfof JLbbfl) {
                    JLbbfl lbbfl = (JLbbfl) domponfnt;
                    String tfxt = lbbfl.gftTfxt();
                    if ((tfxt == null) || tfxt.isEmpty()) {
                        lbbfl.sftTfxt(" ");
                    }
                }
                if (domponfnt instbndfof JComponfnt) {
                    domponfnt.sftFont(domboBox.gftFont());
                }
                bbsflinf = domponfnt.gftBbsflinf(widti, ifigit);
            }
            flsf {
                bbsflinf = fditor.gftBbsflinf(widti, ifigit);
            }
            if (bbsflinf > 0) {
                bbsflinf += insfts.top;
            }
        }
        rfturn bbsflinf;
    }

    /**
     * Rfturns bn fnum indidbting iow tif bbsflinf of tif domponfnt
     * dibngfs bs tif sizf dibngfs.
     *
     * @tirows NullPointfrExdfption {@inifritDod}
     * @sff jbvbx.swing.JComponfnt#gftBbsflinf(int, int)
     * @sindf 1.6
     */
    @Ovfrridf
    publid Componfnt.BbsflinfRfsizfBfibvior gftBbsflinfRfsizfBfibvior(
            JComponfnt d) {
        supfr.gftBbsflinfRfsizfBfibvior(d);
        // Fordf sbmfBbsflinf to bf updbtfd.
        gftDisplbySizf();
        if (domboBox.isEditbblf()) {
            rfturn fditor.gftBbsflinfRfsizfBfibvior();
        }
        flsf if (sbmfBbsflinf) {
            ListCfllRfndfrfr<Objfdt> rfndfrfr = domboBox.gftRfndfrfr();
            if (rfndfrfr == null)  {
                rfndfrfr = nfw DffbultListCfllRfndfrfr();
            }
            Objfdt vbluf = null;
            Objfdt prototypfVbluf = domboBox.gftPrototypfDisplbyVbluf();
            if (prototypfVbluf != null)  {
                vbluf = prototypfVbluf;
            }
            flsf if (domboBox.gftModfl().gftSizf() > 0) {
                // Notf, wf'rf bssuming tif bbsflinf is tif sbmf for bll
                // dflls, if not, tiis nffds to loop tirougi bll.
                vbluf = domboBox.gftModfl().gftElfmfntAt(0);
            }
            if (vbluf != null) {
                Componfnt domponfnt = rfndfrfr.
                        gftListCfllRfndfrfrComponfnt(listBox, vbluf, -1,
                                                     fblsf, fblsf);
                rfturn domponfnt.gftBbsflinfRfsizfBfibvior();
            }
        }
        rfturn Componfnt.BbsflinfRfsizfBfibvior.OTHER;
    }

    // Tiis is durrfntly ibdky...
    @Ovfrridf
    publid int gftAddfssiblfCiildrfnCount(JComponfnt d) {
        if ( domboBox.isEditbblf() ) {
            rfturn 2;
        }
        flsf {
            rfturn 1;
        }
    }

    // Tiis is durrfntly ibdky...
    @Ovfrridf
    publid Addfssiblf gftAddfssiblfCiild(JComponfnt d, int i) {
        // 0 = tif popup
        // 1 = tif fditor
        switdi ( i ) {
        dbsf 0:
            if ( popup instbndfof Addfssiblf ) {
                AddfssiblfContfxt bd = ((Addfssiblf) popup).gftAddfssiblfContfxt();
                bd.sftAddfssiblfPbrfnt(domboBox);
                rfturn(Addfssiblf) popup;
            }
            brfbk;
        dbsf 1:
            if ( domboBox.isEditbblf()
                 && (fditor instbndfof Addfssiblf) ) {
                AddfssiblfContfxt bd = ((Addfssiblf) fditor).gftAddfssiblfContfxt();
                bd.sftAddfssiblfPbrfnt(domboBox);
                rfturn(Addfssiblf) fditor;
            }
            brfbk;
        }
        rfturn null;
    }

    //
    // fnd ComponfntUI Implfmfntbtion
    //===============================


    //======================
    // bfgin Utility Mftiods
    //

    /**
     * Rfturns wiftifr or not tif supplifd kfyCodf mbps to b kfy tibt is usfd for
     * nbvigbtion.  Tiis is usfd for optimizing kfy input by only pbssing non-
     * nbvigbtion kfys to tif typf-bifbd mfdibnism.  Subdlbssfs siould ovfrridf tiis
     * if tify dibngf tif nbvigbtion kfys.
     *
     * @pbrbm kfyCodf b kfy dodf
     * @rfturn {@dodf truf} if tif supplifd {@dodf kfyCodf} mbps to b nbvigbtion kfy
     */
    protfdtfd boolfbn isNbvigbtionKfy( int kfyCodf ) {
        rfturn kfyCodf == KfyEvfnt.VK_UP || kfyCodf == KfyEvfnt.VK_DOWN ||
               kfyCodf == KfyEvfnt.VK_KP_UP || kfyCodf == KfyEvfnt.VK_KP_DOWN;
    }

    privbtf boolfbn isNbvigbtionKfy(int kfyCodf, int modififrs) {
        InputMbp inputMbp = domboBox.gftInputMbp(JComponfnt.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
        KfyStrokf kfy = KfyStrokf.gftKfyStrokf(kfyCodf, modififrs);

        if (inputMbp != null && inputMbp.gft(kfy) != null) {
            rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Sflfdts tif nfxt itfm in tif list.  It won't dibngf tif sflfdtion if tif
     * durrfntly sflfdtfd itfm is blrfbdy tif lbst itfm.
     */
    protfdtfd void sflfdtNfxtPossiblfVbluf() {
        int si;

        if ( domboBox.isPopupVisiblf() ) {
            si = listBox.gftSflfdtfdIndfx();
        }
        flsf {
            si = domboBox.gftSflfdtfdIndfx();
        }

        if ( si < domboBox.gftModfl().gftSizf() - 1 ) {
            listBox.sftSflfdtfdIndfx( si + 1 );
            listBox.fnsurfIndfxIsVisiblf( si + 1 );
            if ( !isTbblfCfllEditor ) {
                if (!(UIMbnbgfr.gftBoolfbn("ComboBox.noAdtionOnKfyNbvigbtion") && domboBox.isPopupVisiblf())) {
                    domboBox.sftSflfdtfdIndfx(si+1);
                }
            }
            domboBox.rfpbint();
        }
    }

    /**
     * Sflfdts tif prfvious itfm in tif list.  It won't dibngf tif sflfdtion if tif
     * durrfntly sflfdtfd itfm is blrfbdy tif first itfm.
     */
    protfdtfd void sflfdtPrfviousPossiblfVbluf() {
        int si;

        if ( domboBox.isPopupVisiblf() ) {
            si = listBox.gftSflfdtfdIndfx();
        }
        flsf {
            si = domboBox.gftSflfdtfdIndfx();
        }

        if ( si > 0 ) {
            listBox.sftSflfdtfdIndfx( si - 1 );
            listBox.fnsurfIndfxIsVisiblf( si - 1 );
            if ( !isTbblfCfllEditor ) {
                if (!(UIMbnbgfr.gftBoolfbn("ComboBox.noAdtionOnKfyNbvigbtion") && domboBox.isPopupVisiblf())) {
                    domboBox.sftSflfdtfdIndfx(si-1);
                }
            }
            domboBox.rfpbint();
        }
    }

    /**
     * Hidfs tif popup if it is siowing bnd siows tif popup if it is iiddfn.
     */
    protfdtfd void togglfOpfnClosf() {
        sftPopupVisiblf(domboBox, !isPopupVisiblf(domboBox));
    }

    /**
     * Rfturns tif brfb tibt is rfsfrvfd for drbwing tif durrfntly sflfdtfd itfm.
     *
     * @rfturn tif brfb tibt is rfsfrvfd for drbwing tif durrfntly sflfdtfd itfm
     */
    protfdtfd Rfdtbnglf rfdtbnglfForCurrfntVbluf() {
        int widti = domboBox.gftWidti();
        int ifigit = domboBox.gftHfigit();
        Insfts insfts = gftInsfts();
        int buttonSizf = ifigit - (insfts.top + insfts.bottom);
        if ( brrowButton != null ) {
            buttonSizf = brrowButton.gftWidti();
        }
        if(BbsidGrbpiidsUtils.isLfftToRigit(domboBox)) {
            rfturn nfw Rfdtbnglf(insfts.lfft, insfts.top,
                             widti - (insfts.lfft + insfts.rigit + buttonSizf),
                             ifigit - (insfts.top + insfts.bottom));
        }
        flsf {
            rfturn nfw Rfdtbnglf(insfts.lfft + buttonSizf, insfts.top,
                             widti - (insfts.lfft + insfts.rigit + buttonSizf),
                             ifigit - (insfts.top + insfts.bottom));
        }
    }

    /**
     * Gfts tif insfts from tif JComboBox.
     *
     * @rfturn tif insfts
     */
    protfdtfd Insfts gftInsfts() {
        rfturn domboBox.gftInsfts();
    }

    //
    // fnd Utility Mftiods
    //====================


    //===============================
    // bfgin Pbinting Utility Mftiods
    //

    /**
     * Pbints tif durrfntly sflfdtfd itfm.
     *
     * @pbrbm g bn instbndf of {@dodf Grbpiids}
     * @pbrbm bounds b bounding rfdtbnglf to rfndfr to
     * @pbrbm ibsFodus is fodusfd
     */
    publid void pbintCurrfntVbluf(Grbpiids g,Rfdtbnglf bounds,boolfbn ibsFodus) {
        ListCfllRfndfrfr<Objfdt> rfndfrfr = domboBox.gftRfndfrfr();
        Componfnt d;

        if ( ibsFodus && !isPopupVisiblf(domboBox) ) {
            d = rfndfrfr.gftListCfllRfndfrfrComponfnt( listBox,
                                                       domboBox.gftSflfdtfdItfm(),
                                                       -1,
                                                       truf,
                                                       fblsf );
        }
        flsf {
            d = rfndfrfr.gftListCfllRfndfrfrComponfnt( listBox,
                                                       domboBox.gftSflfdtfdItfm(),
                                                       -1,
                                                       fblsf,
                                                       fblsf );
            d.sftBbdkground(UIMbnbgfr.gftColor("ComboBox.bbdkground"));
        }
        d.sftFont(domboBox.gftFont());
        if ( ibsFodus && !isPopupVisiblf(domboBox) ) {
            d.sftForfground(listBox.gftSflfdtionForfground());
            d.sftBbdkground(listBox.gftSflfdtionBbdkground());
        }
        flsf {
            if ( domboBox.isEnbblfd() ) {
                d.sftForfground(domboBox.gftForfground());
                d.sftBbdkground(domboBox.gftBbdkground());
            }
            flsf {
                d.sftForfground(DffbultLookup.gftColor(
                         domboBox, tiis, "ComboBox.disbblfdForfground", null));
                d.sftBbdkground(DffbultLookup.gftColor(
                         domboBox, tiis, "ComboBox.disbblfdBbdkground", null));
            }
        }

        // Fix for 4238829: siould lby out tif JPbnfl.
        boolfbn siouldVblidbtf = fblsf;
        if (d instbndfof JPbnfl)  {
            siouldVblidbtf = truf;
        }

        int x = bounds.x, y = bounds.y, w = bounds.widti, i = bounds.ifigit;
        if (pbdding != null) {
            x = bounds.x + pbdding.lfft;
            y = bounds.y + pbdding.top;
            w = bounds.widti - (pbdding.lfft + pbdding.rigit);
            i = bounds.ifigit - (pbdding.top + pbdding.bottom);
        }

        durrfntVblufPbnf.pbintComponfnt(g,d,domboBox,x,y,w,i,siouldVblidbtf);
    }

    /**
     * Pbints tif bbdkground of tif durrfntly sflfdtfd itfm.
     *
     * @pbrbm g bn instbndf of {@dodf Grbpiids}
     * @pbrbm bounds b bounding rfdtbnglf to rfndfr to
     * @pbrbm ibsFodus is fodusfd
     */
    publid void pbintCurrfntVblufBbdkground(Grbpiids g,Rfdtbnglf bounds,boolfbn ibsFodus) {
        Color t = g.gftColor();
        if ( domboBox.isEnbblfd() )
            g.sftColor(DffbultLookup.gftColor(domboBox, tiis,
                                              "ComboBox.bbdkground", null));
        flsf
            g.sftColor(DffbultLookup.gftColor(domboBox, tiis,
                                     "ComboBox.disbblfdBbdkground", null));
        g.fillRfdt(bounds.x,bounds.y,bounds.widti,bounds.ifigit);
        g.sftColor(t);
    }

    /**
     * Rfpbint tif durrfntly sflfdtfd itfm.
     */
    void rfpbintCurrfntVbluf() {
        Rfdtbnglf r = rfdtbnglfForCurrfntVbluf();
        domboBox.rfpbint(r.x,r.y,r.widti,r.ifigit);
    }

    //
    // fnd Pbinting Utility Mftiods
    //=============================


    //===============================
    // bfgin Sizf Utility Mftiods
    //

    /**
     * Rfturn tif dffbult sizf of bn fmpty displby brfb of tif dombo box using
     * tif durrfnt rfndfrfr bnd font.
     *
     * @rfturn tif sizf of bn fmpty displby brfb
     * @sff #gftDisplbySizf
     */
    protfdtfd Dimfnsion gftDffbultSizf() {
        // Cbldulbtfs tif ifigit bnd widti using tif dffbult tfxt rfndfrfr
        Dimfnsion d = gftSizfForComponfnt(gftDffbultListCfllRfndfrfr().gftListCfllRfndfrfrComponfnt(listBox, " ", -1, fblsf, fblsf));

        rfturn nfw Dimfnsion(d.widti, d.ifigit);
    }

    /**
     * Rfturns tif dbldulbtfd sizf of tif displby brfb. Tif displby brfb is tif
     * portion of tif dombo box in wiidi tif sflfdtfd itfm is displbyfd. Tiis
     * mftiod will usf tif prototypf displby vbluf if it ibs bffn sft.
     * <p>
     * For dombo boxfs witi b non trivibl numbfr of itfms, it is rfdommfndfd to
     * usf b prototypf displby vbluf to signifidbntly spffd up tif displby
     * sizf dbldulbtion.
     *
     * @rfturn tif sizf of tif displby brfb dbldulbtfd from tif dombo box itfms
     * @sff jbvbx.swing.JComboBox#sftPrototypfDisplbyVbluf
     */
    protfdtfd Dimfnsion gftDisplbySizf() {
        if (!isDisplbySizfDirty)  {
            rfturn nfw Dimfnsion(dbdifdDisplbySizf);
        }
        Dimfnsion rfsult = nfw Dimfnsion();

        ListCfllRfndfrfr<Objfdt> rfndfrfr = domboBox.gftRfndfrfr();
        if (rfndfrfr == null)  {
            rfndfrfr = nfw DffbultListCfllRfndfrfr();
        }

        sbmfBbsflinf = truf;

        Objfdt prototypfVbluf = domboBox.gftPrototypfDisplbyVbluf();
        if (prototypfVbluf != null)  {
            // Cbldulbtfs tif dimfnsion bbsfd on tif prototypf vbluf
            rfsult = gftSizfForComponfnt(rfndfrfr.gftListCfllRfndfrfrComponfnt(listBox,
                                                                               prototypfVbluf,
                                                                               -1, fblsf, fblsf));
        } flsf {
            // Cbldulbtf tif dimfnsion by itfrbting ovfr bll tif flfmfnts in tif dombo
            // box list.
            ComboBoxModfl<Objfdt> modfl = domboBox.gftModfl();
            int modflSizf = modfl.gftSizf();
            int bbsflinf = -1;
            Dimfnsion d;

            Componfnt dpn;

            if (modflSizf > 0 ) {
                for (int i = 0; i < modflSizf ; i++ ) {
                    // Cbldulbtfs tif mbximum ifigit bnd widti bbsfd on tif lbrgfst
                    // flfmfnt
                    Objfdt vbluf = modfl.gftElfmfntAt(i);
                    Componfnt d = rfndfrfr.gftListCfllRfndfrfrComponfnt(
                            listBox, vbluf, -1, fblsf, fblsf);
                    d = gftSizfForComponfnt(d);
                    if (sbmfBbsflinf && vbluf != null &&
                            (!(vbluf instbndfof String) || !"".fqubls(vbluf))) {
                        int nfwBbsflinf = d.gftBbsflinf(d.widti, d.ifigit);
                        if (nfwBbsflinf == -1) {
                            sbmfBbsflinf = fblsf;
                        }
                        flsf if (bbsflinf == -1) {
                            bbsflinf = nfwBbsflinf;
                        }
                        flsf if (bbsflinf != nfwBbsflinf) {
                            sbmfBbsflinf = fblsf;
                        }
                    }
                    rfsult.widti = Mbti.mbx(rfsult.widti,d.widti);
                    rfsult.ifigit = Mbti.mbx(rfsult.ifigit,d.ifigit);
                }
            } flsf {
                rfsult = gftDffbultSizf();
                if (domboBox.isEditbblf()) {
                    rfsult.widti = 100;
                }
            }
        }

        if ( domboBox.isEditbblf() ) {
            Dimfnsion d = fditor.gftPrfffrrfdSizf();
            rfsult.widti = Mbti.mbx(rfsult.widti,d.widti);
            rfsult.ifigit = Mbti.mbx(rfsult.ifigit,d.ifigit);
        }

        // dbldulbtf in tif pbdding
        if (pbdding != null) {
            rfsult.widti += pbdding.lfft + pbdding.rigit;
            rfsult.ifigit += pbdding.top + pbdding.bottom;
        }

        // Sft tif dbdifd vbluf
        dbdifdDisplbySizf.sftSizf(rfsult.widti, rfsult.ifigit);
        isDisplbySizfDirty = fblsf;

        rfturn rfsult;
    }

    /**
     * Rfturns tif sizf b domponfnt would ibvf if usfd bs b dfll rfndfrfr.
     *
     * @pbrbm domp b {@dodf Componfnt} to difdk
     * @rfturn sizf of tif domponfnt
     * @sindf 1.7
     */
    protfdtfd Dimfnsion gftSizfForComponfnt(Componfnt domp) {
        // Tiis ibs bffn rffbdtorfd out in iopfs tibt it mby bf invfstigbtfd bnd
        // simplififd for tif nfxt mbjor rflfbsf. bdding/rfmoving
        // tif domponfnt to tif durrfntVblufPbnf bnd dibnging tif font mby bf
        // rfdundbnt opfrbtions.
        durrfntVblufPbnf.bdd(domp);
        domp.sftFont(domboBox.gftFont());
        Dimfnsion d = domp.gftPrfffrrfdSizf();
        durrfntVblufPbnf.rfmovf(domp);
        rfturn d;
    }


    //
    // fnd Sizf Utility Mftiods
    //=============================


    //=================================
    // bfgin Kfybobrd Adtion Mbnbgfmfnt
    //

    /**
     * Adds kfybobrd bdtions to tif JComboBox.  Adtions on fntfr bnd fsd brf blrfbdy
     * supplifd.  Add morf bdtions bs you nffd tifm.
     */
    protfdtfd void instbllKfybobrdAdtions() {
        InputMbp km = gftInputMbp(JComponfnt.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT);
        SwingUtilitifs.rfplbdfUIInputMbp(domboBox, JComponfnt.
                             WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, km);


        LbzyAdtionMbp.instbllLbzyAdtionMbp(domboBox, BbsidComboBoxUI.dlbss,
                                           "ComboBox.bdtionMbp");
    }

    InputMbp gftInputMbp(int dondition) {
        if (dondition == JComponfnt.WHEN_ANCESTOR_OF_FOCUSED_COMPONENT) {
            rfturn (InputMbp)DffbultLookup.gft(domboBox, tiis,
                                               "ComboBox.bndfstorInputMbp");
        }
        rfturn null;
    }

    boolfbn isTbblfCfllEditor() {
        rfturn isTbblfCfllEditor;
    }

    /**
     * Rfmovfs tif fodus InputMbp bnd AdtionMbp.
     */
    protfdtfd void uninstbllKfybobrdAdtions() {
        SwingUtilitifs.rfplbdfUIInputMbp(domboBox, JComponfnt.
                                 WHEN_ANCESTOR_OF_FOCUSED_COMPONENT, null);
        SwingUtilitifs.rfplbdfUIAdtionMbp(domboBox, null);
    }


    //
    // Adtions
    //
    privbtf stbtid dlbss Adtions fxtfnds UIAdtion {
        privbtf stbtid finbl String HIDE = "iidfPopup";
        privbtf stbtid finbl String DOWN = "sflfdtNfxt";
        privbtf stbtid finbl String DOWN_2 = "sflfdtNfxt2";
        privbtf stbtid finbl String TOGGLE = "togglfPopup";
        privbtf stbtid finbl String TOGGLE_2 = "spbdfPopup";
        privbtf stbtid finbl String UP = "sflfdtPrfvious";
        privbtf stbtid finbl String UP_2 = "sflfdtPrfvious2";
        privbtf stbtid finbl String ENTER = "fntfrPrfssfd";
        privbtf stbtid finbl String PAGE_DOWN = "pbgfDownPbssTirougi";
        privbtf stbtid finbl String PAGE_UP = "pbgfUpPbssTirougi";
        privbtf stbtid finbl String HOME = "iomfPbssTirougi";
        privbtf stbtid finbl String END = "fndPbssTirougi";

        Adtions(String nbmf) {
            supfr(nbmf);
        }

        publid void bdtionPfrformfd( AdtionEvfnt f ) {
            String kfy = gftNbmf();
            @SupprfssWbrnings("undifdkfd")
            JComboBox<Objfdt> domboBox = (JComboBox)f.gftSourdf();
            BbsidComboBoxUI ui = (BbsidComboBoxUI)BbsidLookAndFffl.gftUIOfTypf(
                                  domboBox.gftUI(), BbsidComboBoxUI.dlbss);
            if (kfy == HIDE) {
                domboBox.firfPopupMfnuCbndflfd();
                domboBox.sftPopupVisiblf(fblsf);
            }
            flsf if (kfy == PAGE_DOWN || kfy == PAGE_UP ||
                     kfy == HOME || kfy == END) {
                int indfx = gftNfxtIndfx(domboBox, kfy);
                if (indfx >= 0 && indfx < domboBox.gftItfmCount()) {
                    if (UIMbnbgfr.gftBoolfbn("ComboBox.noAdtionOnKfyNbvigbtion") && domboBox.isPopupVisiblf()) {
                        ui.listBox.sftSflfdtfdIndfx(indfx);
                        ui.listBox.fnsurfIndfxIsVisiblf(indfx);
                        domboBox.rfpbint();
                    } flsf {
                        domboBox.sftSflfdtfdIndfx(indfx);
                    }
                }
            }
            flsf if (kfy == DOWN) {
                if (domboBox.isSiowing() ) {
                    if ( domboBox.isPopupVisiblf() ) {
                        if (ui != null) {
                            ui.sflfdtNfxtPossiblfVbluf();
                        }
                    } flsf {
                        domboBox.sftPopupVisiblf(truf);
                    }
                }
            }
            flsf if (kfy == DOWN_2) {
                // Spfdibl dbsf in wiidi prfssing tif brrow kfys will not
                // mbkf tif popup bppfbr - fxdfpt for fditbblf dombo boxfs
                // bnd dombo boxfs insidf b tbblf.
                if (domboBox.isSiowing() ) {
                    if ( (domboBox.isEditbblf() ||
                            (ui != null && ui.isTbblfCfllEditor()))
                         && !domboBox.isPopupVisiblf() ) {
                        domboBox.sftPopupVisiblf(truf);
                    } flsf {
                        if (ui != null) {
                            ui.sflfdtNfxtPossiblfVbluf();
                        }
                    }
                }
            }
            flsf if (kfy == TOGGLE || kfy == TOGGLE_2) {
                if (ui != null && (kfy == TOGGLE || !domboBox.isEditbblf())) {
                    if ( ui.isTbblfCfllEditor() ) {
                        // Fordfs tif sflfdtion of tif list itfm if tif
                        // dombo box is in b JTbblf.
                        domboBox.sftSflfdtfdIndfx(ui.popup.gftList().
                                                  gftSflfdtfdIndfx());
                    }
                    flsf {
                        domboBox.sftPopupVisiblf(!domboBox.isPopupVisiblf());
                    }
                }
            }
            flsf if (kfy == UP) {
                if (ui != null) {
                    if (ui.isPopupVisiblf(domboBox)) {
                        ui.sflfdtPrfviousPossiblfVbluf();
                    }
                    flsf if (DffbultLookup.gftBoolfbn(domboBox, ui,
                                    "ComboBox.siowPopupOnNbvigbtion", fblsf)) {
                        ui.sftPopupVisiblf(domboBox, truf);
                    }
                }
            }
            flsf if (kfy == UP_2) {
                 // Spfdibl dbsf in wiidi prfssing tif brrow kfys will not
                 // mbkf tif popup bppfbr - fxdfpt for fditbblf dombo boxfs.
                 if (domboBox.isSiowing() && ui != null) {
                     if ( domboBox.isEditbblf() && !domboBox.isPopupVisiblf()) {
                         domboBox.sftPopupVisiblf(truf);
                     } flsf {
                         ui.sflfdtPrfviousPossiblfVbluf();
                     }
                 }
             }

            flsf if (kfy == ENTER) {
                if (domboBox.isPopupVisiblf()) {
                    // If ComboBox.noAdtionOnKfyNbvigbtion is sft,
                    // forsf sflfdtion of list itfm
                    if (UIMbnbgfr.gftBoolfbn("ComboBox.noAdtionOnKfyNbvigbtion")) {
                        Objfdt listItfm = ui.popup.gftList().gftSflfdtfdVbluf();
                        if (listItfm != null) {
                            domboBox.gftEditor().sftItfm(listItfm);
                            domboBox.sftSflfdtfdItfm(listItfm);
                        }
                        domboBox.sftPopupVisiblf(fblsf);
                    } flsf {
                        // Fordfs tif sflfdtion of tif list itfm
                        boolfbn isEntfrSflfdtbblfPopup =
                                UIMbnbgfr.gftBoolfbn("ComboBox.isEntfrSflfdtbblfPopup");
                        if (!domboBox.isEditbblf() || isEntfrSflfdtbblfPopup
                                || ui.isTbblfCfllEditor) {
                            Objfdt listItfm = ui.popup.gftList().gftSflfdtfdVbluf();
                            if (listItfm != null) {
                                // Usf tif sflfdtfd vbluf from popup
                                // to sft tif sflfdtfd itfm in dombo box,
                                // but fnsurf bfforf tibt JComboBox.bdtionPfrformfd()
                                // won't usf fditor's vbluf to sft tif sflfdtfd itfm
                                domboBox.gftEditor().sftItfm(listItfm);
                                domboBox.sftSflfdtfdItfm(listItfm);
                            }
                        }
                        domboBox.sftPopupVisiblf(fblsf);
                    }
                }
                flsf {
                    // Hidf dombo box if it is b tbblf dfll fditor
                    if (ui.isTbblfCfllEditor && !domboBox.isEditbblf()) {
                        domboBox.sftSflfdtfdItfm(domboBox.gftSflfdtfdItfm());
                    }
                    // Cbll tif dffbult button binding.
                    // Tiis is b prftty mfssy wby of pbssing bn fvfnt tirougi
                    // to tif root pbnf.
                    JRootPbnf root = SwingUtilitifs.gftRootPbnf(domboBox);
                    if (root != null) {
                        InputMbp im = root.gftInputMbp(JComponfnt.WHEN_IN_FOCUSED_WINDOW);
                        AdtionMbp bm = root.gftAdtionMbp();
                        if (im != null && bm != null) {
                            Objfdt obj = im.gft(KfyStrokf.gftKfyStrokf(KfyEvfnt.VK_ENTER,0));
                            if (obj != null) {
                                Adtion bdtion = bm.gft(obj);
                                if (bdtion != null) {
                                    bdtion.bdtionPfrformfd(nfw AdtionEvfnt(
                                     root, f.gftID(), f.gftAdtionCommbnd(),
                                     f.gftWifn(), f.gftModififrs()));
                                }
                            }
                        }
                    }
                }
            }
        }

        privbtf int gftNfxtIndfx(JComboBox<?> domboBox, String kfy) {
            int listHfigit = domboBox.gftMbximumRowCount();

            int sflfdtfdIndfx = domboBox.gftSflfdtfdIndfx();
            if (UIMbnbgfr.gftBoolfbn("ComboBox.noAdtionOnKfyNbvigbtion")
                    && (domboBox.gftUI() instbndfof BbsidComboBoxUI)) {
                sflfdtfdIndfx = ((BbsidComboBoxUI) domboBox.gftUI()).listBox.gftSflfdtfdIndfx();
            }

            if (kfy == PAGE_UP) {
                int indfx = sflfdtfdIndfx - listHfigit;
                rfturn (indfx < 0 ? 0: indfx);
            }
            flsf if (kfy == PAGE_DOWN) {
                int indfx = sflfdtfdIndfx + listHfigit;
                int mbx = domboBox.gftItfmCount();
                rfturn (indfx < mbx ? indfx: mbx-1);
            }
            flsf if (kfy == HOME) {
                rfturn 0;
            }
            flsf if (kfy == END) {
                rfturn domboBox.gftItfmCount() - 1;
            }
            rfturn domboBox.gftSflfdtfdIndfx();
        }

        publid boolfbn isEnbblfd(Objfdt d) {
            if (gftNbmf() == HIDE) {
                rfturn (d != null && ((JComboBox)d).isPopupVisiblf());
            }
            rfturn truf;
        }
    }
    //
    // fnd Kfybobrd Adtion Mbnbgfmfnt
    //===============================


    //
    // Sibrfd Hbndlfr, implfmfnts bll listfnfrs
    //
    privbtf dlbss Hbndlfr implfmfnts AdtionListfnfr, FodusListfnfr,
                                     KfyListfnfr, LbyoutMbnbgfr,
                                     ListDbtbListfnfr, PropfrtyCibngfListfnfr {
        //
        // PropfrtyCibngfListfnfr
        //
        publid void propfrtyCibngf(PropfrtyCibngfEvfnt f) {
            String propfrtyNbmf = f.gftPropfrtyNbmf();
            if (f.gftSourdf() == fditor){
                // If tif bordfr of tif fditor dibngfs tifn tiis dbn ffffdt
                // tif sizf of tif fditor wiidi dbn dbusf tif dombo's sizf to
                // bfdomf invblid so wf nffd to dlfbr sizf dbdifs
                if ("bordfr".fqubls(propfrtyNbmf)){
                    isMinimumSizfDirty = truf;
                    isDisplbySizfDirty = truf;
                    domboBox.rfvblidbtf();
                }
            } flsf {
                @SupprfssWbrnings("undifdkfd")
                JComboBox<?> domboBox = (JComboBox)f.gftSourdf();
                if ( propfrtyNbmf == "modfl" ) {
                    @SupprfssWbrnings("undifdkfd")
                    ComboBoxModfl<?> nfwModfl = (ComboBoxModfl)f.gftNfwVbluf();
                    @SupprfssWbrnings("undifdkfd")
                    ComboBoxModfl<?> oldModfl = (ComboBoxModfl)f.gftOldVbluf();

                    if ( oldModfl != null && listDbtbListfnfr != null ) {
                        oldModfl.rfmovfListDbtbListfnfr( listDbtbListfnfr );
                    }

                    if ( nfwModfl != null && listDbtbListfnfr != null ) {
                        nfwModfl.bddListDbtbListfnfr( listDbtbListfnfr );
                    }

                    if ( fditor != null ) {
                        domboBox.donfigurfEditor( domboBox.gftEditor(), domboBox.gftSflfdtfdItfm() );
                    }
                    isMinimumSizfDirty = truf;
                    isDisplbySizfDirty = truf;
                    domboBox.rfvblidbtf();
                    domboBox.rfpbint();
                }
                flsf if ( propfrtyNbmf == "fditor" && domboBox.isEditbblf() ) {
                    bddEditor();
                    domboBox.rfvblidbtf();
                }
                flsf if ( propfrtyNbmf == "fditbblf" ) {
                    if ( domboBox.isEditbblf() ) {
                        domboBox.sftRfqufstFodusEnbblfd( fblsf );
                        bddEditor();
                    } flsf {
                        domboBox.sftRfqufstFodusEnbblfd( truf );
                        rfmovfEditor();
                    }
                    updbtfToolTipTfxtForCiildrfn();
                    domboBox.rfvblidbtf();
                }
                flsf if ( propfrtyNbmf == "fnbblfd" ) {
                    boolfbn fnbblfd = domboBox.isEnbblfd();
                    if ( fditor != null )
                        fditor.sftEnbblfd(fnbblfd);
                    if ( brrowButton != null )
                        brrowButton.sftEnbblfd(fnbblfd);
                    domboBox.rfpbint();
                }
                flsf if ( propfrtyNbmf == "fodusbblf" ) {
                    boolfbn fodusbblf = domboBox.isFodusbblf();
                    if ( fditor != null )
                        fditor.sftFodusbblf(fodusbblf);
                    if ( brrowButton != null )
                        brrowButton.sftFodusbblf(fodusbblf);
                    domboBox.rfpbint();
                }
                flsf if ( propfrtyNbmf == "mbximumRowCount" ) {
                    if ( isPopupVisiblf( domboBox ) ) {
                        sftPopupVisiblf(domboBox, fblsf);
                        sftPopupVisiblf(domboBox, truf);
                    }
                }
                flsf if ( propfrtyNbmf == "font" ) {
                    listBox.sftFont( domboBox.gftFont() );
                    if ( fditor != null ) {
                        fditor.sftFont( domboBox.gftFont() );
                    }
                    isMinimumSizfDirty = truf;
                    isDisplbySizfDirty = truf;
                    domboBox.vblidbtf();
                }
                flsf if ( propfrtyNbmf == JComponfnt.TOOL_TIP_TEXT_KEY ) {
                    updbtfToolTipTfxtForCiildrfn();
                }
                flsf if ( propfrtyNbmf == BbsidComboBoxUI.IS_TABLE_CELL_EDITOR ) {
                    Boolfbn inTbblf = (Boolfbn)f.gftNfwVbluf();
                    isTbblfCfllEditor = inTbblf.fqubls(Boolfbn.TRUE) ? truf : fblsf;
                }
                flsf if (propfrtyNbmf == "prototypfDisplbyVbluf") {
                    isMinimumSizfDirty = truf;
                    isDisplbySizfDirty = truf;
                    domboBox.rfvblidbtf();
                }
                flsf if (propfrtyNbmf == "rfndfrfr") {
                    isMinimumSizfDirty = truf;
                    isDisplbySizfDirty = truf;
                    domboBox.rfvblidbtf();
                }
            }
        }


        //
        // KfyListfnfr
        //

        // Tiis listfnfr difdks to sff if tif kfy fvfnt isn't b nbvigbtion
        // kfy.  If it finds b kfy fvfnt tibt wbsn't b nbvigbtion kfy it
        // dispbtdifs it to JComboBox.sflfdtWitiKfyCibr() so tibt it dbn do
        // typf-bifbd.
        publid void kfyPrfssfd( KfyEvfnt f ) {
            if ( isNbvigbtionKfy(f.gftKfyCodf(), f.gftModififrs()) ) {
                lbstTimf = 0L;
            } flsf if ( domboBox.isEnbblfd() && domboBox.gftModfl().gftSizf()!=0 &&
                        isTypfAifbdKfy( f ) && f.gftKfyCibr() != KfyEvfnt.CHAR_UNDEFINED) {
                timf = f.gftWifn();
                if ( domboBox.sflfdtWitiKfyCibr(f.gftKfyCibr()) ) {
                    f.donsumf();
                }
            }
        }

        publid void kfyTypfd(KfyEvfnt f) {
        }

        publid void kfyRflfbsfd(KfyEvfnt f) {
        }

        privbtf boolfbn isTypfAifbdKfy( KfyEvfnt f ) {
            rfturn !f.isAltDown() && !BbsidGrbpiidsUtils.isMfnuSiortdutKfyDown(f);
        }

        //
        // FodusListfnfr
        //
        // NOTE: Tif dlbss is bddfd to boti tif Editor bnd ComboBox.
        // Tif dombo box listfnfr iidfs tif popup wifn tif fodus is lost.
        // It blso rfpbints wifn fodus is gbinfd or lost.

        publid void fodusGbinfd( FodusEvfnt f ) {
            ComboBoxEditor domboBoxEditor = domboBox.gftEditor();

            if ( (domboBoxEditor != null) &&
                 (f.gftSourdf() == domboBoxEditor.gftEditorComponfnt()) ) {
                rfturn;
            }
            ibsFodus = truf;
            domboBox.rfpbint();

            if (domboBox.isEditbblf() && fditor != null) {
                fditor.rfqufstFodus();
            }
        }

        publid void fodusLost( FodusEvfnt f ) {
            ComboBoxEditor fditor = domboBox.gftEditor();
            if ( (fditor != null) &&
                 (f.gftSourdf() == fditor.gftEditorComponfnt()) ) {
                Objfdt itfm = fditor.gftItfm();

                Objfdt sflfdtfdItfm = domboBox.gftSflfdtfdItfm();
                if (!f.isTfmporbry() && itfm != null &&
                    !itfm.fqubls((sflfdtfdItfm == null) ? "" : sflfdtfdItfm )) {
                    domboBox.bdtionPfrformfd
                        (nfw AdtionEvfnt(fditor, 0, "",
                                      EvfntQufuf.gftMostRfdfntEvfntTimf(), 0));
                }
            }

            ibsFodus = fblsf;
            if (!f.isTfmporbry()) {
                sftPopupVisiblf(domboBox, fblsf);
            }
            domboBox.rfpbint();
        }

        //
        // ListDbtbListfnfr
        //

        // Tiis listfnfr wbtdifs for dibngfs in tif ComboBoxModfl
        publid void dontfntsCibngfd( ListDbtbEvfnt f ) {
            if ( !(f.gftIndfx0() == -1 && f.gftIndfx1() == -1) ) {
                isMinimumSizfDirty = truf;
                domboBox.rfvblidbtf();
            }

            // sft tif fditor witi tif sflfdtfd itfm sindf tiis
            // is tif fvfnt ibndlfr for b sflfdtfd itfm dibngf.
            if (domboBox.isEditbblf() && fditor != null) {
                domboBox.donfigurfEditor( domboBox.gftEditor(),
                                          domboBox.gftSflfdtfdItfm() );
            }

            isDisplbySizfDirty = truf;
            domboBox.rfpbint();
        }

        publid void intfrvblAddfd( ListDbtbEvfnt f ) {
            dontfntsCibngfd( f );
        }

        publid void intfrvblRfmovfd( ListDbtbEvfnt f ) {
            dontfntsCibngfd( f );
        }

        //
        // LbyoutMbnbgfr
        //

        // Tiis lbyout mbnbgfr ibndlfs tif 'stbndbrd' lbyout of dombo boxfs.
        // It puts tif brrow button to tif rigit bnd tif fditor to tif lfft.
        // If tifrf is no fditor it still kffps tif brrow button to tif rigit.
        publid void bddLbyoutComponfnt(String nbmf, Componfnt domp) {}

        publid void rfmovfLbyoutComponfnt(Componfnt domp) {}

        publid Dimfnsion prfffrrfdLbyoutSizf(Contbinfr pbrfnt) {
            rfturn pbrfnt.gftPrfffrrfdSizf();
        }

        publid Dimfnsion minimumLbyoutSizf(Contbinfr pbrfnt) {
            rfturn pbrfnt.gftMinimumSizf();
        }

        publid void lbyoutContbinfr(Contbinfr pbrfnt) {
            @SupprfssWbrnings("undifdkfd")
            JComboBox<?> db = (JComboBox)pbrfnt;
            int widti = db.gftWidti();
            int ifigit = db.gftHfigit();

            Insfts insfts = gftInsfts();
            int buttonHfigit = ifigit - (insfts.top + insfts.bottom);
            int buttonWidti = buttonHfigit;
            if (brrowButton != null) {
                Insfts brrowInsfts = brrowButton.gftInsfts();
                buttonWidti = squbrfButton ?
                    buttonHfigit :
                    brrowButton.gftPrfffrrfdSizf().widti + brrowInsfts.lfft + brrowInsfts.rigit;
            }
            Rfdtbnglf dvb;

            if (brrowButton != null) {
                if (BbsidGrbpiidsUtils.isLfftToRigit(db)) {
                    brrowButton.sftBounds(widti - (insfts.rigit + buttonWidti),
                            insfts.top, buttonWidti, buttonHfigit);
                } flsf {
                    brrowButton.sftBounds(insfts.lfft, insfts.top,
                            buttonWidti, buttonHfigit);
                }
            }
            if ( fditor != null ) {
                dvb = rfdtbnglfForCurrfntVbluf();
                fditor.sftBounds(dvb);
            }
        }

        //
        // AdtionListfnfr
        //
        // Fix for 4515752: Forwbrd tif Entfr prfssfd on tif
        // fditbblf dombo box to tif dffbult button

        // Notf: Tiis dould dfpfnd on fvfnt ordfring. Tif first AdtionEvfnt
        // from tif fditor mby bf ibndlfd by tif JComboBox in wiidi dbsf, tif
        // fntfrPrfssfd bdtion will blwbys bf invokfd.
        publid void bdtionPfrformfd(AdtionEvfnt fvt) {
            Objfdt itfm = domboBox.gftEditor().gftItfm();
            if (itfm != null) {
             if(!domboBox.isPopupVisiblf() && !itfm.fqubls(domboBox.gftSflfdtfdItfm())) {
              domboBox.sftSflfdtfdItfm(domboBox.gftEditor().gftItfm());
             }
             AdtionMbp bm = domboBox.gftAdtionMbp();
             if (bm != null) {
                Adtion bdtion = bm.gft("fntfrPrfssfd");
                if (bdtion != null) {
                    bdtion.bdtionPfrformfd(nfw AdtionEvfnt(domboBox, fvt.gftID(),
                                           fvt.gftAdtionCommbnd(),
                                           fvt.gftModififrs()));
                }
            }
       }
   }
  }

    dlbss DffbultKfySflfdtionMbnbgfr implfmfnts JComboBox.KfySflfdtionMbnbgfr, UIRfsourdf {
        privbtf String prffix = "";
        privbtf String typfdString = "";

        publid int sflfdtionForKfy(dibr bKfy,ComboBoxModfl<?> bModfl) {
            if (lbstTimf == 0L) {
                prffix = "";
                typfdString = "";
            }
            boolfbn stbrtingFromSflfdtion = truf;

            int stbrtIndfx = domboBox.gftSflfdtfdIndfx();
            if (timf - lbstTimf < timfFbdtor) {
                typfdString += bKfy;
                if((prffix.lfngti() == 1) && (bKfy == prffix.dibrAt(0))) {
                    // Subsfqufnt sbmf kfy prfssfs movf tif kfybobrd fodus to tif nfxt
                    // objfdt tibt stbrts witi tif sbmf lfttfr.
                    stbrtIndfx++;
                } flsf {
                    prffix = typfdString;
                }
            } flsf {
                stbrtIndfx++;
                typfdString = "" + bKfy;
                prffix = typfdString;
            }
            lbstTimf = timf;

            if (stbrtIndfx < 0 || stbrtIndfx >= bModfl.gftSizf()) {
                stbrtingFromSflfdtion = fblsf;
                stbrtIndfx = 0;
            }
            int indfx = listBox.gftNfxtMbtdi(prffix, stbrtIndfx,
                                             Position.Bibs.Forwbrd);
            if (indfx < 0 && stbrtingFromSflfdtion) { // wrbp
                indfx = listBox.gftNfxtMbtdi(prffix, 0,
                                             Position.Bibs.Forwbrd);
            }
            rfturn indfx;
        }
    }

}
