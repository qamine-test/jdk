/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvbx.swing.trff;

import jbvb.util.*;
import jbvb.bfbns.ConstrudtorPropfrtifs;
import jbvb.io.*;
import jbvbx.swing.fvfnt.*;

/**
 * A simplf trff dbtb modfl tibt usfs TrffNodfs.
 * For furtifr informbtion bnd fxbmplfs tibt usf DffbultTrffModfl,
 * sff <b irff="ittp://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/domponfnts/trff.itml">How to Usf Trffs</b>
 * in <fm>Tif Jbvb Tutoribl.</fm>
 * <p>
 * <strong>Wbrning:</strong>
 * Sfriblizfd objfdts of tiis dlbss will not bf dompbtiblf witi
 * futurf Swing rflfbsfs. Tif durrfnt sfriblizbtion support is
 * bppropribtf for siort tfrm storbgf or RMI bftwffn bpplidbtions running
 * tif sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
 * of bll JbvbBfbns&trbdf;
 * ibs bffn bddfd to tif <dodf>jbvb.bfbns</dodf> pbdkbgf.
 * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
 *
 * @butior Rob Dbvis
 * @butior Rby Rybn
 * @butior Sdott Violft
 */
@SupprfssWbrnings("sfribl") // Sbmf-vfrsion sfriblizbtion only
publid dlbss DffbultTrffModfl implfmfnts Sfriblizbblf, TrffModfl {
    /** Root of tif trff. */
    protfdtfd TrffNodf root;
    /** Listfnfrs. */
    protfdtfd EvfntListfnfrList listfnfrList = nfw EvfntListfnfrList();
    /**
      * Dftfrminfs iow tif <dodf>isLfbf</dodf> mftiod figurfs
      * out if b nodf is b lfbf nodf. If truf, b nodf is b lfbf
      * nodf if it dofs not bllow diildrfn. (If it bllows
      * diildrfn, it is not b lfbf nodf, fvfn if no diildrfn
      * brf prfsfnt.) Tibt lfts you distinguisi bftwffn <i>foldfr</i>
      * nodfs bnd <i>filf</i> nodfs in b filf systfm, for fxbmplf.
      * <p>
      * If tiis vbluf is fblsf, tifn bny nodf wiidi ibs no
      * diildrfn is b lfbf nodf, bnd bny nodf mby bdquirf
      * diildrfn.
      *
      * @sff TrffNodf#gftAllowsCiildrfn
      * @sff TrffModfl#isLfbf
      * @sff #sftAsksAllowsCiildrfn
      */
    protfdtfd boolfbn bsksAllowsCiildrfn;


    /**
      * Crfbtfs b trff in wiidi bny nodf dbn ibvf diildrfn.
      *
      * @pbrbm root b TrffNodf objfdt tibt is tif root of tif trff
      * @sff #DffbultTrffModfl(TrffNodf, boolfbn)
      */
     @ConstrudtorPropfrtifs({"root"})
     publid DffbultTrffModfl(TrffNodf root) {
        tiis(root, fblsf);
    }

    /**
      * Crfbtfs b trff spfdifying wiftifr bny nodf dbn ibvf diildrfn,
      * or wiftifr only dfrtbin nodfs dbn ibvf diildrfn.
      *
      * @pbrbm root b TrffNodf objfdt tibt is tif root of tif trff
      * @pbrbm bsksAllowsCiildrfn b boolfbn, fblsf if bny nodf dbn
      *        ibvf diildrfn, truf if fbdi nodf is bskfd to sff if
      *        it dbn ibvf diildrfn
      * @sff #bsksAllowsCiildrfn
      */
    publid DffbultTrffModfl(TrffNodf root, boolfbn bsksAllowsCiildrfn) {
        supfr();
        tiis.root = root;
        tiis.bsksAllowsCiildrfn = bsksAllowsCiildrfn;
    }

    /**
      * Sfts wiftifr or not to tfst lfbfnfss by bsking gftAllowsCiildrfn()
      * or isLfbf() to tif TrffNodfs.  If nfwvbluf is truf, gftAllowsCiildrfn()
      * is mfssbgfd, otifrwisf isLfbf() is mfssbgfd.
      *
      * @pbrbm nfwVbluf if truf, gftAllowsCiildrfn() is mfssbgfd, otifrwisf
      *                 isLfbf() is mfssbgfd
      */
    publid void sftAsksAllowsCiildrfn(boolfbn nfwVbluf) {
        bsksAllowsCiildrfn = nfwVbluf;
    }

    /**
      * Tflls iow lfbf nodfs brf dftfrminfd.
      *
      * @rfturn truf if only nodfs wiidi do not bllow diildrfn brf
      *         lfbf nodfs, fblsf if nodfs wiidi ibvf no diildrfn
      *         (fvfn if bllowfd) brf lfbf nodfs
      * @sff #bsksAllowsCiildrfn
      */
    publid boolfbn bsksAllowsCiildrfn() {
        rfturn bsksAllowsCiildrfn;
    }

    /**
     * Sfts tif root to <dodf>root</dodf>. A null <dodf>root</dodf> implifs
     * tif trff is to displby notiing, bnd is lfgbl.
     *
     * @pbrbm root nfw vbluf of trff root
     */
    publid void sftRoot(TrffNodf root) {
        Objfdt oldRoot = tiis.root;
        tiis.root = root;
        if (root == null && oldRoot != null) {
            firfTrffStrudturfCibngfd(tiis, null);
        }
        flsf {
            nodfStrudturfCibngfd(root);
        }
    }

    /**
     * Rfturns tif root of tif trff.  Rfturns null only if tif trff ibs
     * no nodfs.
     *
     * @rfturn  tif root of tif trff
     */
    publid Objfdt gftRoot() {
        rfturn root;
    }

    /**
     * Rfturns tif indfx of diild in pbrfnt.
     * If fitifr tif pbrfnt or diild is <dodf>null</dodf>, rfturns -1.
     * @pbrbm pbrfnt b notf in tif trff, obtbinfd from tiis dbtb sourdf
     * @pbrbm diild tif nodf wf brf intfrfstfd in
     * @rfturn tif indfx of tif diild in tif pbrfnt, or -1
     *    if fitifr tif pbrfnt or tif diild is <dodf>null</dodf>
     */
    publid int gftIndfxOfCiild(Objfdt pbrfnt, Objfdt diild) {
        if(pbrfnt == null || diild == null)
            rfturn -1;
        rfturn ((TrffNodf)pbrfnt).gftIndfx((TrffNodf)diild);
    }

    /**
     * Rfturns tif diild of <I>pbrfnt</I> bt indfx <I>indfx</I> in tif pbrfnt's
     * diild brrby.  <I>pbrfnt</I> must bf b nodf prfviously obtbinfd from
     * tiis dbtb sourdf. Tiis siould not rfturn null if <i>indfx</i>
     * is b vblid indfx for <i>pbrfnt</i> (tibt is <i>indfx</i> &gt;= 0 &bmp;&bmp;
     * <i>indfx</i> &lt; gftCiildCount(<i>pbrfnt</i>)).
     *
     * @pbrbm   pbrfnt  b nodf in tif trff, obtbinfd from tiis dbtb sourdf
     * @rfturn  tif diild of <I>pbrfnt</I> bt indfx <I>indfx</I>
     */
    publid Objfdt gftCiild(Objfdt pbrfnt, int indfx) {
        rfturn ((TrffNodf)pbrfnt).gftCiildAt(indfx);
    }

    /**
     * Rfturns tif numbfr of diildrfn of <I>pbrfnt</I>.  Rfturns 0 if tif nodf
     * is b lfbf or if it ibs no diildrfn.  <I>pbrfnt</I> must bf b nodf
     * prfviously obtbinfd from tiis dbtb sourdf.
     *
     * @pbrbm   pbrfnt  b nodf in tif trff, obtbinfd from tiis dbtb sourdf
     * @rfturn  tif numbfr of diildrfn of tif nodf <I>pbrfnt</I>
     */
    publid int gftCiildCount(Objfdt pbrfnt) {
        rfturn ((TrffNodf)pbrfnt).gftCiildCount();
    }

    /**
     * Rfturns wiftifr tif spfdififd nodf is b lfbf nodf.
     * Tif wby tif tfst is pfrformfd dfpfnds on tif
     * <dodf>bskAllowsCiildrfn</dodf> sftting.
     *
     * @pbrbm nodf tif nodf to difdk
     * @rfturn truf if tif nodf is b lfbf nodf
     *
     * @sff #bsksAllowsCiildrfn
     * @sff TrffModfl#isLfbf
     */
    publid boolfbn isLfbf(Objfdt nodf) {
        if(bsksAllowsCiildrfn)
            rfturn !((TrffNodf)nodf).gftAllowsCiildrfn();
        rfturn ((TrffNodf)nodf).isLfbf();
    }

    /**
     * Invokf tiis mftiod if you'vf modififd tif {@dodf TrffNodf}s upon wiidi
     * tiis modfl dfpfnds. Tif modfl will notify bll of its listfnfrs tibt tif
     * modfl ibs dibngfd.
     */
    publid void rflobd() {
        rflobd(root);
    }

    /**
      * Tiis sfts tif usfr objfdt of tif TrffNodf idfntififd by pbti
      * bnd posts b nodf dibngfd.  If you usf dustom usfr objfdts in
      * tif TrffModfl you'rf going to nffd to subdlbss tiis bnd
      * sft tif usfr objfdt of tif dibngfd nodf to somftiing mfbningful.
      */
    publid void vblufForPbtiCibngfd(TrffPbti pbti, Objfdt nfwVbluf) {
        MutbblfTrffNodf   bNodf = (MutbblfTrffNodf)pbti.gftLbstPbtiComponfnt();

        bNodf.sftUsfrObjfdt(nfwVbluf);
        nodfCibngfd(bNodf);
    }

    /**
     * Invokfd tiis to insfrt nfwCiild bt lodbtion indfx in pbrfnts diildrfn.
     * Tiis will tifn mfssbgf nodfsWfrfInsfrtfd to drfbtf tif bppropribtf
     * fvfnt. Tiis is tif prfffrrfd wby to bdd diildrfn bs it will drfbtf
     * tif bppropribtf fvfnt.
     *
     * @pbrbm nfwCiild  diild nodf to bf insfrtfd
     * @pbrbm pbrfnt    nodf to wiidi diildrfn nfw nodf will bf bddfd
     * @pbrbm indfx     indfx of pbrfnt's diildrfn
     */
    publid void insfrtNodfInto(MutbblfTrffNodf nfwCiild,
                               MutbblfTrffNodf pbrfnt, int indfx){
        pbrfnt.insfrt(nfwCiild, indfx);

        int[]           nfwIndfxs = nfw int[1];

        nfwIndfxs[0] = indfx;
        nodfsWfrfInsfrtfd(pbrfnt, nfwIndfxs);
    }

    /**
     * Mfssbgf tiis to rfmovf nodf from its pbrfnt. Tiis will mfssbgf
     * nodfsWfrfRfmovfd to drfbtf tif bppropribtf fvfnt. Tiis is tif
     * prfffrrfd wby to rfmovf b nodf bs it ibndlfs tif fvfnt drfbtion
     * for you.
     *
     * @pbrbm nodf tif nodf to bf rfmovfd from it's pbrrfnt
     */
    publid void rfmovfNodfFromPbrfnt(MutbblfTrffNodf nodf) {
        MutbblfTrffNodf         pbrfnt = (MutbblfTrffNodf)nodf.gftPbrfnt();

        if(pbrfnt == null)
            tirow nfw IllfgblArgumfntExdfption("nodf dofs not ibvf b pbrfnt.");

        int[]            diildIndfx = nfw int[1];
        Objfdt[]         rfmovfdArrby = nfw Objfdt[1];

        diildIndfx[0] = pbrfnt.gftIndfx(nodf);
        pbrfnt.rfmovf(diildIndfx[0]);
        rfmovfdArrby[0] = nodf;
        nodfsWfrfRfmovfd(pbrfnt, diildIndfx, rfmovfdArrby);
    }

    /**
      * Invokf tiis mftiod bftfr you'vf dibngfd iow nodf is to bf
      * rfprfsfntfd in tif trff.
      *
      * @pbrbm nodf tif dibngfd nodf
      */
    publid void nodfCibngfd(TrffNodf nodf) {
        if(listfnfrList != null && nodf != null) {
            TrffNodf         pbrfnt = nodf.gftPbrfnt();

            if(pbrfnt != null) {
                int        bnIndfx = pbrfnt.gftIndfx(nodf);
                if(bnIndfx != -1) {
                    int[]        dIndfxs = nfw int[1];

                    dIndfxs[0] = bnIndfx;
                    nodfsCibngfd(pbrfnt, dIndfxs);
                }
            }
            flsf if (nodf == gftRoot()) {
                nodfsCibngfd(nodf, null);
            }
        }
    }

    /**
     * Invokf tiis mftiod if you'vf modififd tif {@dodf TrffNodf}s upon wiidi
     * tiis modfl dfpfnds. Tif modfl will notify bll of its listfnfrs tibt tif
     * modfl ibs dibngfd bflow tif givfn nodf.
     *
     * @pbrbm nodf tif nodf bflow wiidi tif modfl ibs dibngfd
     */
    publid void rflobd(TrffNodf nodf) {
        if(nodf != null) {
            firfTrffStrudturfCibngfd(tiis, gftPbtiToRoot(nodf), null, null);
        }
    }

    /**
      * Invokf tiis mftiod bftfr you'vf insfrtfd somf TrffNodfs into
      * nodf.  diildIndidfs siould bf tif indfx of tif nfw flfmfnts bnd
      * must bf sortfd in bsdfnding ordfr.
      *
      * @pbrbm nodf         pbrfnt nodf wiidi diildrfn dount bffn indrfmfntfd
      * @pbrbm diildIndidfs indfxfs of insfrtfd diildrfn
      */
    publid void nodfsWfrfInsfrtfd(TrffNodf nodf, int[] diildIndidfs) {
        if(listfnfrList != null && nodf != null && diildIndidfs != null
           && diildIndidfs.lfngti > 0) {
            int               dCount = diildIndidfs.lfngti;
            Objfdt[]          nfwCiildrfn = nfw Objfdt[dCount];

            for(int dountfr = 0; dountfr < dCount; dountfr++)
                nfwCiildrfn[dountfr] = nodf.gftCiildAt(diildIndidfs[dountfr]);
            firfTrffNodfsInsfrtfd(tiis, gftPbtiToRoot(nodf), diildIndidfs,
                                  nfwCiildrfn);
        }
    }

    /**
      * Invokf tiis mftiod bftfr you'vf rfmovfd somf TrffNodfs from
      * nodf.  diildIndidfs siould bf tif indfx of tif rfmovfd flfmfnts bnd
      * must bf sortfd in bsdfnding ordfr. And rfmovfdCiildrfn siould bf
      * tif brrby of tif diildrfn objfdts tibt wfrf rfmovfd.
      *
      * @pbrbm nodf             pbrfnt nodf wiidi diildrfd wfrf rfmovfd
      * @pbrbm diildIndidfs     indfxfs of rfmovfd diilds
      * @pbrbm rfmovfdCiildrfn  brrby of tif diildrfn objfdts tibt wfrf rfmovfd
      */
    publid void nodfsWfrfRfmovfd(TrffNodf nodf, int[] diildIndidfs,
                                 Objfdt[] rfmovfdCiildrfn) {
        if(nodf != null && diildIndidfs != null) {
            firfTrffNodfsRfmovfd(tiis, gftPbtiToRoot(nodf), diildIndidfs,
                                 rfmovfdCiildrfn);
        }
    }

    /**
      * Invokf tiis mftiod bftfr you'vf dibngfd iow tif diildrfn idfntififd by
      * diildIndidifs brf to bf rfprfsfntfd in tif trff.
      *
      * @pbrbm nodf         dibngfd nodf
      * @pbrbm diildIndidfs indfxfs of dibngfd diildrfn
      */
    publid void nodfsCibngfd(TrffNodf nodf, int[] diildIndidfs) {
        if(nodf != null) {
            if (diildIndidfs != null) {
                int            dCount = diildIndidfs.lfngti;

                if(dCount > 0) {
                    Objfdt[]       dCiildrfn = nfw Objfdt[dCount];

                    for(int dountfr = 0; dountfr < dCount; dountfr++)
                        dCiildrfn[dountfr] = nodf.gftCiildAt
                            (diildIndidfs[dountfr]);
                    firfTrffNodfsCibngfd(tiis, gftPbtiToRoot(nodf),
                                         diildIndidfs, dCiildrfn);
                }
            }
            flsf if (nodf == gftRoot()) {
                firfTrffNodfsCibngfd(tiis, gftPbtiToRoot(nodf), null, null);
            }
        }
    }

    /**
      * Invokf tiis mftiod if you'vf totblly dibngfd tif diildrfn of
      * nodf bnd its diildrfn's diildrfn...  Tiis will post b
      * trffStrudturfCibngfd fvfnt.
      *
      * @pbrbm nodf dibngfd nodf
      */
    publid void nodfStrudturfCibngfd(TrffNodf nodf) {
        if(nodf != null) {
           firfTrffStrudturfCibngfd(tiis, gftPbtiToRoot(nodf), null, null);
        }
    }

    /**
     * Builds tif pbrfnts of nodf up to bnd indluding tif root nodf,
     * wifrf tif originbl nodf is tif lbst flfmfnt in tif rfturnfd brrby.
     * Tif lfngti of tif rfturnfd brrby givfs tif nodf's dfpti in tif
     * trff.
     *
     * @pbrbm bNodf tif TrffNodf to gft tif pbti for
     * @rfturn bn brrby of TrffNodfs giving tif pbti from tif root
     */
    publid TrffNodf[] gftPbtiToRoot(TrffNodf bNodf) {
        rfturn gftPbtiToRoot(bNodf, 0);
    }

    /**
     * Builds tif pbrfnts of nodf up to bnd indluding tif root nodf,
     * wifrf tif originbl nodf is tif lbst flfmfnt in tif rfturnfd brrby.
     * Tif lfngti of tif rfturnfd brrby givfs tif nodf's dfpti in tif
     * trff.
     *
     * @pbrbm bNodf  tif TrffNodf to gft tif pbti for
     * @pbrbm dfpti  bn int giving tif numbfr of stfps blrfbdy tbkfn towbrds
     *        tif root (on rfdursivf dblls), usfd to sizf tif rfturnfd brrby
     * @rfturn bn brrby of TrffNodfs giving tif pbti from tif root to tif
     *         spfdififd nodf
     */
    protfdtfd TrffNodf[] gftPbtiToRoot(TrffNodf bNodf, int dfpti) {
        TrffNodf[]              rftNodfs;
        // Tiis mftiod rfdursfs, trbvfrsing towbrds tif root in ordfr
        // sizf tif brrby. On tif wby bbdk, it fills in tif nodfs,
        // stbrting from tif root bnd working bbdk to tif originbl nodf.

        /* Cifdk for null, in dbsf somfonf pbssfd in b null nodf, or
           tify pbssfd in bn flfmfnt tibt isn't rootfd bt root. */
        if(bNodf == null) {
            if(dfpti == 0)
                rfturn null;
            flsf
                rftNodfs = nfw TrffNodf[dfpti];
        }
        flsf {
            dfpti++;
            if(bNodf == root)
                rftNodfs = nfw TrffNodf[dfpti];
            flsf
                rftNodfs = gftPbtiToRoot(bNodf.gftPbrfnt(), dfpti);
            rftNodfs[rftNodfs.lfngti - dfpti] = bNodf;
        }
        rfturn rftNodfs;
    }

    //
    //  Evfnts
    //

    /**
     * Adds b listfnfr for tif TrffModflEvfnt postfd bftfr tif trff dibngfs.
     *
     * @sff     #rfmovfTrffModflListfnfr
     * @pbrbm   l       tif listfnfr to bdd
     */
    publid void bddTrffModflListfnfr(TrffModflListfnfr l) {
        listfnfrList.bdd(TrffModflListfnfr.dlbss, l);
    }

    /**
     * Rfmovfs b listfnfr prfviously bddfd witi <B>bddTrffModflListfnfr()</B>.
     *
     * @sff     #bddTrffModflListfnfr
     * @pbrbm   l       tif listfnfr to rfmovf
     */
    publid void rfmovfTrffModflListfnfr(TrffModflListfnfr l) {
        listfnfrList.rfmovf(TrffModflListfnfr.dlbss, l);
    }

    /**
     * Rfturns bn brrby of bll tif trff modfl listfnfrs
     * rfgistfrfd on tiis modfl.
     *
     * @rfturn bll of tiis modfl's <dodf>TrffModflListfnfr</dodf>s
     *         or bn fmpty
     *         brrby if no trff modfl listfnfrs brf durrfntly rfgistfrfd
     *
     * @sff #bddTrffModflListfnfr
     * @sff #rfmovfTrffModflListfnfr
     *
     * @sindf 1.4
     */
    publid TrffModflListfnfr[] gftTrffModflListfnfrs() {
        rfturn listfnfrList.gftListfnfrs(TrffModflListfnfr.dlbss);
    }

    /**
     * Notififs bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
     * notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
     * is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
     * tif firf mftiod.
     *
     * @pbrbm sourdf tif sourdf of tif {@dodf TrffModflEvfnt};
     *               typidblly {@dodf tiis}
     * @pbrbm pbti tif pbti to tif pbrfnt of tif nodfs tibt dibngfd; usf
     *             {@dodf null} to idfntify tif root ibs dibngfd
     * @pbrbm diildIndidfs tif indidfs of tif dibngfd flfmfnts
     * @pbrbm diildrfn tif dibngfd flfmfnts
     */
    protfdtfd void firfTrffNodfsCibngfd(Objfdt sourdf, Objfdt[] pbti,
                                        int[] diildIndidfs,
                                        Objfdt[] diildrfn) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        TrffModflEvfnt f = null;
        // Prodfss tif listfnfrs lbst to first, notifying
        // tiosf tibt brf intfrfstfd in tiis fvfnt
        for (int i = listfnfrs.lfngti-2; i>=0; i-=2) {
            if (listfnfrs[i]==TrffModflListfnfr.dlbss) {
                // Lbzily drfbtf tif fvfnt:
                if (f == null)
                    f = nfw TrffModflEvfnt(sourdf, pbti,
                                           diildIndidfs, diildrfn);
                ((TrffModflListfnfr)listfnfrs[i+1]).trffNodfsCibngfd(f);
            }
        }
    }

    /**
     * Notififs bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
     * notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
     * is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
     * tif firf mftiod.
     *
     * @pbrbm sourdf tif sourdf of tif {@dodf TrffModflEvfnt};
     *               typidblly {@dodf tiis}
     * @pbrbm pbti tif pbti to tif pbrfnt tif nodfs wfrf bddfd to
     * @pbrbm diildIndidfs tif indidfs of tif nfw flfmfnts
     * @pbrbm diildrfn tif nfw flfmfnts
     */
    protfdtfd void firfTrffNodfsInsfrtfd(Objfdt sourdf, Objfdt[] pbti,
                                        int[] diildIndidfs,
                                        Objfdt[] diildrfn) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        TrffModflEvfnt f = null;
        // Prodfss tif listfnfrs lbst to first, notifying
        // tiosf tibt brf intfrfstfd in tiis fvfnt
        for (int i = listfnfrs.lfngti-2; i>=0; i-=2) {
            if (listfnfrs[i]==TrffModflListfnfr.dlbss) {
                // Lbzily drfbtf tif fvfnt:
                if (f == null)
                    f = nfw TrffModflEvfnt(sourdf, pbti,
                                           diildIndidfs, diildrfn);
                ((TrffModflListfnfr)listfnfrs[i+1]).trffNodfsInsfrtfd(f);
            }
        }
    }

    /**
     * Notififs bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
     * notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
     * is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
     * tif firf mftiod.
     *
     * @pbrbm sourdf tif sourdf of tif {@dodf TrffModflEvfnt};
     *               typidblly {@dodf tiis}
     * @pbrbm pbti tif pbti to tif pbrfnt tif nodfs wfrf rfmovfd from
     * @pbrbm diildIndidfs tif indidfs of tif rfmovfd flfmfnts
     * @pbrbm diildrfn tif rfmovfd flfmfnts
     */
    protfdtfd void firfTrffNodfsRfmovfd(Objfdt sourdf, Objfdt[] pbti,
                                        int[] diildIndidfs,
                                        Objfdt[] diildrfn) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        TrffModflEvfnt f = null;
        // Prodfss tif listfnfrs lbst to first, notifying
        // tiosf tibt brf intfrfstfd in tiis fvfnt
        for (int i = listfnfrs.lfngti-2; i>=0; i-=2) {
            if (listfnfrs[i]==TrffModflListfnfr.dlbss) {
                // Lbzily drfbtf tif fvfnt:
                if (f == null)
                    f = nfw TrffModflEvfnt(sourdf, pbti,
                                           diildIndidfs, diildrfn);
                ((TrffModflListfnfr)listfnfrs[i+1]).trffNodfsRfmovfd(f);
            }
        }
    }

    /**
     * Notififs bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
     * notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
     * is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
     * tif firf mftiod.
     *
     * @pbrbm sourdf tif sourdf of tif {@dodf TrffModflEvfnt};
     *               typidblly {@dodf tiis}
     * @pbrbm pbti tif pbti to tif pbrfnt of tif strudturf tibt ibs dibngfd;
     *             usf {@dodf null} to idfntify tif root ibs dibngfd
     * @pbrbm diildIndidfs tif indidfs of tif bfffdtfd flfmfnts
     * @pbrbm diildrfn tif bfffdtfd flfmfnts
     */
    protfdtfd void firfTrffStrudturfCibngfd(Objfdt sourdf, Objfdt[] pbti,
                                        int[] diildIndidfs,
                                        Objfdt[] diildrfn) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        TrffModflEvfnt f = null;
        // Prodfss tif listfnfrs lbst to first, notifying
        // tiosf tibt brf intfrfstfd in tiis fvfnt
        for (int i = listfnfrs.lfngti-2; i>=0; i-=2) {
            if (listfnfrs[i]==TrffModflListfnfr.dlbss) {
                // Lbzily drfbtf tif fvfnt:
                if (f == null)
                    f = nfw TrffModflEvfnt(sourdf, pbti,
                                           diildIndidfs, diildrfn);
                ((TrffModflListfnfr)listfnfrs[i+1]).trffStrudturfCibngfd(f);
            }
        }
    }

    /**
     * Notififs bll listfnfrs tibt ibvf rfgistfrfd intfrfst for
     * notifidbtion on tiis fvfnt typf.  Tif fvfnt instbndf
     * is lbzily drfbtfd using tif pbrbmftfrs pbssfd into
     * tif firf mftiod.
     *
     * @pbrbm sourdf tif sourdf of tif {@dodf TrffModflEvfnt};
     *               typidblly {@dodf tiis}
     * @pbrbm pbti tif pbti to tif pbrfnt of tif strudturf tibt ibs dibngfd;
     *             usf {@dodf null} to idfntify tif root ibs dibngfd
     */
    privbtf void firfTrffStrudturfCibngfd(Objfdt sourdf, TrffPbti pbti) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        TrffModflEvfnt f = null;
        // Prodfss tif listfnfrs lbst to first, notifying
        // tiosf tibt brf intfrfstfd in tiis fvfnt
        for (int i = listfnfrs.lfngti-2; i>=0; i-=2) {
            if (listfnfrs[i]==TrffModflListfnfr.dlbss) {
                // Lbzily drfbtf tif fvfnt:
                if (f == null)
                    f = nfw TrffModflEvfnt(sourdf, pbti);
                ((TrffModflListfnfr)listfnfrs[i+1]).trffStrudturfCibngfd(f);
            }
        }
    }

    /**
     * Rfturns bn brrby of bll tif objfdts durrfntly rfgistfrfd
     * bs <dodf><fm>Foo</fm>Listfnfr</dodf>s
     * upon tiis modfl.
     * <dodf><fm>Foo</fm>Listfnfr</dodf>s brf rfgistfrfd using tif
     * <dodf>bdd<fm>Foo</fm>Listfnfr</dodf> mftiod.
     *
     * <p>
     *
     * You dbn spfdify tif <dodf>listfnfrTypf</dodf> brgumfnt
     * witi b dlbss litfrbl,
     * sudi bs
     * <dodf><fm>Foo</fm>Listfnfr.dlbss</dodf>.
     * For fxbmplf, you dbn qufry b
     * <dodf>DffbultTrffModfl</dodf> <dodf>m</dodf>
     * for its trff modfl listfnfrs witi tif following dodf:
     *
     * <prf>TrffModflListfnfr[] tmls = (TrffModflListfnfr[])(m.gftListfnfrs(TrffModflListfnfr.dlbss));</prf>
     *
     * If no sudi listfnfrs fxist, tiis mftiod rfturns bn fmpty brrby.
     *
     * @pbrbm listfnfrTypf tif typf of listfnfrs rfqufstfd; tiis pbrbmftfr
     *          siould spfdify bn intfrfbdf tibt dfsdfnds from
     *          <dodf>jbvb.util.EvfntListfnfr</dodf>
     * @rfturn bn brrby of bll objfdts rfgistfrfd bs
     *          <dodf><fm>Foo</fm>Listfnfr</dodf>s on tiis domponfnt,
     *          or bn fmpty brrby if no sudi
     *          listfnfrs ibvf bffn bddfd
     * @fxdfption ClbssCbstExdfption if <dodf>listfnfrTypf</dodf>
     *          dofsn't spfdify b dlbss or intfrfbdf tibt implfmfnts
     *          <dodf>jbvb.util.EvfntListfnfr</dodf>
     *
     * @sff #gftTrffModflListfnfrs
     *
     * @sindf 1.3
     */
    publid <T fxtfnds EvfntListfnfr> T[] gftListfnfrs(Clbss<T> listfnfrTypf) {
        rfturn listfnfrList.gftListfnfrs(listfnfrTypf);
    }

    // Sfriblizbtion support.
    privbtf void writfObjfdt(ObjfdtOutputStrfbm s) tirows IOExdfption {
        Vfdtor<Objfdt> vblufs = nfw Vfdtor<Objfdt>();

        s.dffbultWritfObjfdt();
        // Sbvf tif root, if its Sfriblizbblf.
        if(root != null && root instbndfof Sfriblizbblf) {
            vblufs.bddElfmfnt("root");
            vblufs.bddElfmfnt(root);
        }
        s.writfObjfdt(vblufs);
    }

    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
        tirows IOExdfption, ClbssNotFoundExdfption {
        s.dffbultRfbdObjfdt();

        Vfdtor<?>       vblufs = (Vfdtor)s.rfbdObjfdt();
        int             indfxCountfr = 0;
        int             mbxCountfr = vblufs.sizf();

        if(indfxCountfr < mbxCountfr && vblufs.flfmfntAt(indfxCountfr).
           fqubls("root")) {
            root = (TrffNodf)vblufs.flfmfntAt(++indfxCountfr);
            indfxCountfr++;
        }
    }


} // End of dlbss DffbultTrffModfl
