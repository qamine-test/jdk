/*
 * Copyright (d) 1997, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf jbvbx.swing;

import jbvb.util.EvfntListfnfr;
import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvb.bwt.imbgf.*;

import jbvb.bfbns.PropfrtyChbngfEvfnt;
import jbvb.bfbns.PropfrtyChbngfListfnfr;

import jbvb.io.Sfriblizbblf;
import jbvb.io.ObjfdtOutputStrfbm;
import jbvb.io.ObjfdtInputStrfbm;
import jbvb.io.IOExdfption;

import jbvbx.swing.plbf.*;
import jbvbx.swing.plbf.bbsid.*;
import jbvbx.swing.fvfnt.*;
import jbvbx.bddfssibility.*;

/**
 * An implfmfntbtion of bn itfm in b mfnu. A mfnu itfm is fssfntiblly b button
 * sitting in b list. Whfn thf usfr sflfdts thf "button", thf bdtion
 * bssodibtfd with thf mfnu itfm is pfrformfd. A <dodf>JMfnuItfm</dodf>
 * dontbinfd in b <dodf>JPopupMfnu</dodf> pfrforms fxbdtly thbt fundtion.
 * <p>
 * Mfnu itfms dbn bf donfigurfd, bnd to somf dfgrff dontrollfd, by
 * <dodf><b hrff="Adtion.html">Adtion</b></dodf>s.  Using bn
 * <dodf>Adtion</dodf> with b mfnu itfm hbs mbny bfnffits bfyond dirfdtly
 * donfiguring b mfnu itfm.  Rfffr to <b hrff="Adtion.html#buttonAdtions">
 * Swing Componfnts Supporting <dodf>Adtion</dodf></b> for morf
 * dftbils, bnd you dbn find morf informbtion in <b
 * hrff="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/misd/bdtion.html">How
 * to Usf Adtions</b>, b sfdtion in <fm>Thf Jbvb Tutoribl</fm>.
 * <p>
 * For furthfr dodumfntbtion bnd for fxbmplfs, sff
 * <b
 hrff="http://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/domponfnts/mfnu.html">How to Usf Mfnus</b>
 * in <fm>Thf Jbvb Tutoribl.</fm>
 * <p>
 * <strong>Wbrning:</strong> Swing is not thrfbd sbff. For morf
 * informbtion sff <b
 * hrff="pbdkbgf-summbry.html#thrfbding">Swing's Thrfbding
 * Polidy</b>.
 * <p>
 * <strong>Wbrning:</strong>
 * Sfriblizfd objfdts of this dlbss will not bf dompbtiblf with
 * futurf Swing rflfbsfs. Thf durrfnt sfriblizbtion support is
 * bppropribtf for short tfrm storbgf or RMI bftwffn bpplidbtions running
 * thf sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
 * of bll JbvbBfbns&trbdf;
 * hbs bffn bddfd to thf <dodf>jbvb.bfbns</dodf> pbdkbgf.
 * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
 *
 * @bfbninfo
 *   bttributf: isContbinfr fblsf
 * dfsdription: An itfm whidh dbn bf sflfdtfd in b mfnu.
 *
 * @buthor Gforgfs Sbbb
 * @buthor Dbvid Kbrlton
 * @sff JPopupMfnu
 * @sff JMfnu
 * @sff JChfdkBoxMfnuItfm
 * @sff JRbdioButtonMfnuItfm
 * @sindf 1.2
 */
@SupprfssWbrnings("sfribl")
publid dlbss JMfnuItfm fxtfnds AbstrbdtButton implfmfnts Addfssiblf,MfnuElfmfnt  {

    /**
     * @sff #gftUIClbssID
     * @sff #rfbdObjfdt
     */
    privbtf stbtid finbl String uiClbssID = "MfnuItfmUI";

    /* dibgnostid bids -- should bf fblsf for produdtion builds. */
    privbtf stbtid finbl boolfbn TRACE =   fblsf; // trbdf drfbtfs bnd disposfs
    privbtf stbtid finbl boolfbn VERBOSE = fblsf; // show rfusf hits/missfs
    privbtf stbtid finbl boolfbn DEBUG =   fblsf;  // show bbd pbrbms, misd.

    privbtf boolfbn isMousfDrbggfd = fblsf;

    /**
     * Crfbtfs b <dodf>JMfnuItfm</dodf> with no sft tfxt or idon.
     */
    publid JMfnuItfm() {
        this(null, (Idon)null);
    }

    /**
     * Crfbtfs b <dodf>JMfnuItfm</dodf> with thf spfdififd idon.
     *
     * @pbrbm idon thf idon of thf <dodf>JMfnuItfm</dodf>
     */
    publid JMfnuItfm(Idon idon) {
        this(null, idon);
    }

    /**
     * Crfbtfs b <dodf>JMfnuItfm</dodf> with thf spfdififd tfxt.
     *
     * @pbrbm tfxt thf tfxt of thf <dodf>JMfnuItfm</dodf>
     */
    publid JMfnuItfm(String tfxt) {
        this(tfxt, (Idon)null);
    }

    /**
     * Crfbtfs b mfnu itfm whosf propfrtifs brf tbkfn from thf
     * spfdififd <dodf>Adtion</dodf>.
     *
     * @pbrbm b thf bdtion of thf <dodf>JMfnuItfm</dodf>
     * @sindf 1.3
     */
    publid JMfnuItfm(Adtion b) {
        this();
        sftAdtion(b);
    }

    /**
     * Crfbtfs b <dodf>JMfnuItfm</dodf> with thf spfdififd tfxt bnd idon.
     *
     * @pbrbm tfxt thf tfxt of thf <dodf>JMfnuItfm</dodf>
     * @pbrbm idon thf idon of thf <dodf>JMfnuItfm</dodf>
     */
    publid JMfnuItfm(String tfxt, Idon idon) {
        sftModfl(nfw DffbultButtonModfl());
        init(tfxt, idon);
        initFodusbbility();
    }

    /**
     * Crfbtfs b <dodf>JMfnuItfm</dodf> with thf spfdififd tfxt bnd
     * kfybobrd mnfmonid.
     *
     * @pbrbm tfxt thf tfxt of thf <dodf>JMfnuItfm</dodf>
     * @pbrbm mnfmonid thf kfybobrd mnfmonid for thf <dodf>JMfnuItfm</dodf>
     */
    publid JMfnuItfm(String tfxt, int mnfmonid) {
        sftModfl(nfw DffbultButtonModfl());
        init(tfxt, null);
        sftMnfmonid(mnfmonid);
        initFodusbbility();
    }

    /**
     * {@inhfritDod}
     */
    publid void sftModfl(ButtonModfl nfwModfl) {
        supfr.sftModfl(nfwModfl);
        if(nfwModfl instbndfof DffbultButtonModfl) {
            ((DffbultButtonModfl)nfwModfl).sftMfnuItfm(truf);
        }
    }

    /**
     * Inititblizfs thf fodusbbility of thf thf <dodf>JMfnuItfm</dodf>.
     * <dodf>JMfnuItfm</dodf>'s brf fodusbblf, but subdlbssfs mby
     * wbnt to bf, this providfs thfm thf opportunity to ovfrridf this
     * bnd invokf somfthing flsf, or nothing bt bll. Rfffr to
     * {@link jbvbx.swing.JMfnu#initFodusbbility} for thf motivbtion of
     * this.
     */
    void initFodusbbility() {
        sftFodusbblf(fblsf);
    }

    /**
     * Initiblizfs thf mfnu itfm with thf spfdififd tfxt bnd idon.
     *
     * @pbrbm tfxt thf tfxt of thf <dodf>JMfnuItfm</dodf>
     * @pbrbm idon thf idon of thf <dodf>JMfnuItfm</dodf>
     */
    protfdtfd void init(String tfxt, Idon idon) {
        if(tfxt != null) {
            sftTfxt(tfxt);
        }

        if(idon != null) {
            sftIdon(idon);
        }

        // Listfn for Fodus fvfnts
        bddFodusListfnfr(nfw MfnuItfmFodusListfnfr());
        sftUIPropfrty("bordfrPbintfd", Boolfbn.FALSE);
        sftFodusPbintfd(fblsf);
        sftHorizontblTfxtPosition(JButton.TRAILING);
        sftHorizontblAlignmfnt(JButton.LEADING);
        updbtfUI();
    }

    privbtf stbtid dlbss MfnuItfmFodusListfnfr implfmfnts FodusListfnfr,
        Sfriblizbblf {
        publid void fodusGbinfd(FodusEvfnt fvfnt) {}
        publid void fodusLost(FodusEvfnt fvfnt) {
            // Whfn fodus is lost, rfpbint if
            // thf fodus informbtion is pbintfd
            JMfnuItfm mi = (JMfnuItfm)fvfnt.gftSourdf();
            if(mi.isFodusPbintfd()) {
                mi.rfpbint();
            }
        }
    }


    /**
     * Sfts thf look bnd fffl objfdt thbt rfndfrs this domponfnt.
     *
     * @pbrbm ui  thf <dodf>JMfnuItfmUI</dodf> L&bmp;F objfdt
     * @sff UIDffbults#gftUI
     * @bfbninfo
     *        bound: truf
     *       hiddfn: truf
     *    bttributf: visublUpdbtf truf
     *  dfsdription: Thf UI objfdt thbt implfmfnts thf Componfnt's LookAndFffl.
     */
    publid void sftUI(MfnuItfmUI ui) {
        supfr.sftUI(ui);
    }

    /**
     * Rfsfts thf UI propfrty with b vbluf from thf durrfnt look bnd fffl.
     *
     * @sff JComponfnt#updbtfUI
     */
    publid void updbtfUI() {
        sftUI((MfnuItfmUI)UIMbnbgfr.gftUI(this));
    }


    /**
     * Rfturns thf suffix usfd to donstrudt thf nbmf of thf L&bmp;F dlbss usfd to
     * rfndfr this domponfnt.
     *
     * @rfturn thf string "MfnuItfmUI"
     * @sff JComponfnt#gftUIClbssID
     * @sff UIDffbults#gftUI
     */
    publid String gftUIClbssID() {
        rfturn uiClbssID;
    }


    /**
     * Idfntififs thf mfnu itfm bs "brmfd". If thf mousf button is
     * rflfbsfd whilf it is ovfr this itfm, thf mfnu's bdtion fvfnt
     * will firf. If thf mousf button is rflfbsfd flsfwhfrf, thf
     * fvfnt will not firf bnd thf mfnu itfm will bf disbrmfd.
     *
     * @pbrbm b truf to brm thf mfnu itfm so it dbn bf sflfdtfd
     * @bfbninfo
     *    dfsdription: Mousf rflfbsf will firf bn bdtion fvfnt
     *         hiddfn: truf
     */
    publid void sftArmfd(boolfbn b) {
        ButtonModfl modfl = gftModfl();

        boolfbn oldVbluf = modfl.isArmfd();
        if(modfl.isArmfd() != b) {
            modfl.sftArmfd(b);
        }
    }

    /**
     * Rfturns whfthfr thf mfnu itfm is "brmfd".
     *
     * @rfturn truf if thf mfnu itfm is brmfd, bnd it dbn bf sflfdtfd
     * @sff #sftArmfd
     */
    publid boolfbn isArmfd() {
        ButtonModfl modfl = gftModfl();
        rfturn modfl.isArmfd();
    }

    /**
     * Enbblfs or disbblfs thf mfnu itfm.
     *
     * @pbrbm b  truf to fnbblf thf itfm
     * @bfbninfo
     *    dfsdription: Dofs thf domponfnt rfbdt to usfr intfrbdtion
     *          bound: truf
     *      prfffrrfd: truf
     */
    publid void sftEnbblfd(boolfbn b) {
        // Mbkf surf wf brfn't brmfd!
        if (!b && !UIMbnbgfr.gftBoolfbn("MfnuItfm.disbblfdArfNbvigbblf")) {
            sftArmfd(fblsf);
        }
        supfr.sftEnbblfd(b);
    }


    /**
     * Rfturns truf sindf <dodf>Mfnu</dodf>s, by dffinition,
     * should blwbys bf on top of bll othfr windows.  If thf mfnu is
     * in bn intfrnbl frbmf fblsf is rfturnfd duf to thf rollovfr ffffdt
     * for windows lbf whfrf thf mfnu is not blwbys on top.
     */
    // pbdkbgf privbtf
    boolfbn blwbysOnTop() {
        // Fix for bug #4482165
        if (SwingUtilitifs.gftAndfstorOfClbss(JIntfrnblFrbmf.dlbss, this) !=
                null) {
            rfturn fblsf;
        }
        rfturn truf;
    }


    /* Thf kfystrokf whidh bdts bs thf mfnu itfm's bddflfrbtor
     */
    privbtf KfyStrokf bddflfrbtor;

    /**
     * Sfts thf kfy dombinbtion whidh invokfs thf mfnu itfm's
     * bdtion listfnfrs without nbvigbting thf mfnu hifrbrdhy. It is thf
     * UI's rfsponsibility to instbll thf dorrfdt bdtion.  Notf thbt
     * whfn thf kfybobrd bddflfrbtor is typfd, it will work whfthfr or
     * not thf mfnu is durrfntly displbyfd.
     *
     * @pbrbm kfyStrokf thf <dodf>KfyStrokf</dodf> whidh will
     *          sfrvf bs bn bddflfrbtor
     * @bfbninfo
     *     dfsdription: Thf kfystrokf dombinbtion whidh will invokf thf
     *                  JMfnuItfm's bdtionlistfnfrs without nbvigbting thf
     *                  mfnu hifrbrdhy
     *           bound: truf
     *       prfffrrfd: truf
     */
    publid void sftAddflfrbtor(KfyStrokf kfyStrokf) {
        KfyStrokf oldAddflfrbtor = bddflfrbtor;
        this.bddflfrbtor = kfyStrokf;
        rfpbint();
        rfvblidbtf();
        firfPropfrtyChbngf("bddflfrbtor", oldAddflfrbtor, bddflfrbtor);
    }

    /**
     * Rfturns thf <dodf>KfyStrokf</dodf> whidh sfrvfs bs bn bddflfrbtor
     * for thf mfnu itfm.
     * @rfturn b <dodf>KfyStrokf</dodf> objfdt idfntifying thf
     *          bddflfrbtor kfy
     */
    publid KfyStrokf gftAddflfrbtor() {
        rfturn this.bddflfrbtor;
    }

    /**
     * {@inhfritDod}
     *
     * @sindf 1.3
     */
    protfdtfd void donfigurfPropfrtifsFromAdtion(Adtion b) {
        supfr.donfigurfPropfrtifsFromAdtion(b);
        donfigurfAddflfrbtorFromAdtion(b);
    }

    void sftIdonFromAdtion(Adtion b) {
        Idon idon = null;
        if (b != null) {
            idon = (Idon)b.gftVbluf(Adtion.SMALL_ICON);
        }
        sftIdon(idon);
    }

    void lbrgfIdonChbngfd(Adtion b) {
    }

    void smbllIdonChbngfd(Adtion b) {
        sftIdonFromAdtion(b);
    }

    void donfigurfAddflfrbtorFromAdtion(Adtion b) {
        KfyStrokf ks = (b==null) ? null :
            (KfyStrokf)b.gftVbluf(Adtion.ACCELERATOR_KEY);
        sftAddflfrbtor(ks);
    }

    /**
     * {@inhfritDod}
     * @sindf 1.6
     */
    protfdtfd void bdtionPropfrtyChbngfd(Adtion bdtion, String propfrtyNbmf) {
        if (propfrtyNbmf == Adtion.ACCELERATOR_KEY) {
            donfigurfAddflfrbtorFromAdtion(bdtion);
        }
        flsf {
            supfr.bdtionPropfrtyChbngfd(bdtion, propfrtyNbmf);
        }
    }

    /**
     * Prodfssfs b mousf fvfnt forwbrdfd from thf
     * <dodf>MfnuSflfdtionMbnbgfr</dodf> bnd dhbngfs thf mfnu
     * sflfdtion, if nfdfssbry, by using thf
     * <dodf>MfnuSflfdtionMbnbgfr</dodf>'s API.
     * <p>
     * Notf: you do not hbvf to forwbrd thf fvfnt to sub-domponfnts.
     * This is donf butombtidblly by thf <dodf>MfnuSflfdtionMbnbgfr</dodf>.
     *
     * @pbrbm f   b <dodf>MousfEvfnt</dodf>
     * @pbrbm pbth  thf <dodf>MfnuElfmfnt</dodf> pbth brrby
     * @pbrbm mbnbgfr   thf <dodf>MfnuSflfdtionMbnbgfr</dodf>
     */
    publid void prodfssMousfEvfnt(MousfEvfnt f,MfnuElfmfnt pbth[],MfnuSflfdtionMbnbgfr mbnbgfr) {
        prodfssMfnuDrbgMousfEvfnt(
                 nfw MfnuDrbgMousfEvfnt(f.gftComponfnt(), f.gftID(),
                                        f.gftWhfn(),
                                        f.gftModififrs(), f.gftX(), f.gftY(),
                                        f.gftXOnSdrffn(), f.gftYOnSdrffn(),
                                        f.gftClidkCount(), f.isPopupTriggfr(),
                                        pbth, mbnbgfr));
    }


    /**
     * Prodfssfs b kfy fvfnt forwbrdfd from thf
     * <dodf>MfnuSflfdtionMbnbgfr</dodf> bnd dhbngfs thf mfnu sflfdtion,
     * if nfdfssbry, by using <dodf>MfnuSflfdtionMbnbgfr</dodf>'s API.
     * <p>
     * Notf: you do not hbvf to forwbrd thf fvfnt to sub-domponfnts.
     * This is donf butombtidblly by thf <dodf>MfnuSflfdtionMbnbgfr</dodf>.
     *
     * @pbrbm f  b <dodf>KfyEvfnt</dodf>
     * @pbrbm pbth thf <dodf>MfnuElfmfnt</dodf> pbth brrby
     * @pbrbm mbnbgfr   thf <dodf>MfnuSflfdtionMbnbgfr</dodf>
     */
    publid void prodfssKfyEvfnt(KfyEvfnt f,MfnuElfmfnt pbth[],MfnuSflfdtionMbnbgfr mbnbgfr) {
        if (DEBUG) {
            Systfm.out.println("in JMfnuItfm.prodfssKfyEvfnt/3 for " + gftTfxt() +
                                   "  " + KfyStrokf.gftKfyStrokfForEvfnt(f));
        }
        MfnuKfyEvfnt mkf = nfw MfnuKfyEvfnt(f.gftComponfnt(), f.gftID(),
                                             f.gftWhfn(), f.gftModififrs(),
                                             f.gftKfyCodf(), f.gftKfyChbr(),
                                             pbth, mbnbgfr);
        prodfssMfnuKfyEvfnt(mkf);

        if (mkf.isConsumfd())  {
            f.donsumf();
        }
    }



    /**
     * Hbndlfs mousf drbg in b mfnu.
     *
     * @pbrbm f  b <dodf>MfnuDrbgMousfEvfnt</dodf> objfdt
     */
    publid void prodfssMfnuDrbgMousfEvfnt(MfnuDrbgMousfEvfnt f) {
        switdh (f.gftID()) {
        dbsf MousfEvfnt.MOUSE_ENTERED:
            isMousfDrbggfd = fblsf; firfMfnuDrbgMousfEntfrfd(f); brfbk;
        dbsf MousfEvfnt.MOUSE_EXITED:
            isMousfDrbggfd = fblsf; firfMfnuDrbgMousfExitfd(f); brfbk;
        dbsf MousfEvfnt.MOUSE_DRAGGED:
            isMousfDrbggfd = truf; firfMfnuDrbgMousfDrbggfd(f); brfbk;
        dbsf MousfEvfnt.MOUSE_RELEASED:
            if(isMousfDrbggfd) firfMfnuDrbgMousfRflfbsfd(f); brfbk;
        dffbult:
            brfbk;
        }
    }

    /**
     * Hbndlfs b kfystrokf in b mfnu.
     *
     * @pbrbm f  b <dodf>MfnuKfyEvfnt</dodf> objfdt
     */
    publid void prodfssMfnuKfyEvfnt(MfnuKfyEvfnt f) {
        if (DEBUG) {
            Systfm.out.println("in JMfnuItfm.prodfssMfnuKfyEvfnt for " + gftTfxt()+
                                   "  " + KfyStrokf.gftKfyStrokfForEvfnt(f));
        }
        switdh (f.gftID()) {
        dbsf KfyEvfnt.KEY_PRESSED:
            firfMfnuKfyPrfssfd(f); brfbk;
        dbsf KfyEvfnt.KEY_RELEASED:
            firfMfnuKfyRflfbsfd(f); brfbk;
        dbsf KfyEvfnt.KEY_TYPED:
            firfMfnuKfyTypfd(f); brfbk;
        dffbult:
            brfbk;
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuMousfDrbgEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuDrbgMousfEntfrfd(MfnuDrbgMousfEvfnt fvfnt) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuDrbgMousfListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuDrbgMousfListfnfr)listfnfrs[i+1]).mfnuDrbgMousfEntfrfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuDrbgMousfEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuDrbgMousfExitfd(MfnuDrbgMousfEvfnt fvfnt) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuDrbgMousfListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuDrbgMousfListfnfr)listfnfrs[i+1]).mfnuDrbgMousfExitfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuDrbgMousfEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuDrbgMousfDrbggfd(MfnuDrbgMousfEvfnt fvfnt) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuDrbgMousfListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuDrbgMousfListfnfr)listfnfrs[i+1]).mfnuDrbgMousfDrbggfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuDrbgMousfEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuDrbgMousfRflfbsfd(MfnuDrbgMousfEvfnt fvfnt) {
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuDrbgMousfListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuDrbgMousfListfnfr)listfnfrs[i+1]).mfnuDrbgMousfRflfbsfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuKfyEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuKfyPrfssfd(MfnuKfyEvfnt fvfnt) {
        if (DEBUG) {
            Systfm.out.println("in JMfnuItfm.firfMfnuKfyPrfssfd for " + gftTfxt()+
                                   "  " + KfyStrokf.gftKfyStrokfForEvfnt(fvfnt));
        }
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuKfyListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuKfyListfnfr)listfnfrs[i+1]).mfnuKfyPrfssfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuKfyEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuKfyRflfbsfd(MfnuKfyEvfnt fvfnt) {
        if (DEBUG) {
            Systfm.out.println("in JMfnuItfm.firfMfnuKfyRflfbsfd for " + gftTfxt()+
                                   "  " + KfyStrokf.gftKfyStrokfForEvfnt(fvfnt));
        }
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuKfyListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuKfyListfnfr)listfnfrs[i+1]).mfnuKfyRflfbsfd(fvfnt);
            }
        }
    }

    /**
     * Notififs bll listfnfrs thbt hbvf rfgistfrfd intfrfst for
     * notifidbtion on this fvfnt typf.
     *
     * @pbrbm fvfnt b <dodf>MfnuKfyEvfnt</dodf>
     * @sff EvfntListfnfrList
     */
    protfdtfd void firfMfnuKfyTypfd(MfnuKfyEvfnt fvfnt) {
        if (DEBUG) {
            Systfm.out.println("in JMfnuItfm.firfMfnuKfyTypfd for " + gftTfxt()+
                                   "  " + KfyStrokf.gftKfyStrokfForEvfnt(fvfnt));
        }
        // Gubrbntffd to rfturn b non-null brrby
        Objfdt[] listfnfrs = listfnfrList.gftListfnfrList();
        // Prodfss thf listfnfrs lbst to first, notifying
        // thosf thbt brf intfrfstfd in this fvfnt
        for (int i = listfnfrs.lfngth-2; i>=0; i-=2) {
            if (listfnfrs[i]==MfnuKfyListfnfr.dlbss) {
                // Lbzily drfbtf thf fvfnt:
                ((MfnuKfyListfnfr)listfnfrs[i+1]).mfnuKfyTypfd(fvfnt);
            }
        }
    }

    /**
     * Cbllfd by thf <dodf>MfnuSflfdtionMbnbgfr</dodf> whfn thf
     * <dodf>MfnuElfmfnt</dodf> is sflfdtfd or unsflfdtfd.
     *
     * @pbrbm isIndludfd  truf if this mfnu itfm is on thf pbrt of thf mfnu
     *                    pbth thbt dhbngfd, fblsf if this mfnu is pbrt of thf
     *                    b mfnu pbth thbt dhbngfd, but this pbrtidulbr pbrt of
     *                    thbt pbth is still thf sbmf
     * @sff MfnuSflfdtionMbnbgfr#sftSflfdtfdPbth(MfnuElfmfnt[])
     */
    publid void mfnuSflfdtionChbngfd(boolfbn isIndludfd) {
        sftArmfd(isIndludfd);
    }

    /**
     * This mfthod rfturns bn brrby dontbining thf sub-mfnu
     * domponfnts for this mfnu domponfnt.
     *
     * @rfturn bn brrby of <dodf>MfnuElfmfnt</dodf>s
     */
    publid MfnuElfmfnt[] gftSubElfmfnts() {
        rfturn nfw MfnuElfmfnt[0];
    }

    /**
     * Rfturns thf <dodf>jbvb.bwt.Componfnt</dodf> usfd to pbint
     * this objfdt. Thf rfturnfd domponfnt will bf usfd to donvfrt
     * fvfnts bnd dftfdt if bn fvfnt is insidf b mfnu domponfnt.
     *
     * @rfturn thf <dodf>Componfnt</dodf> thbt pbints this mfnu itfm
     */
    publid Componfnt gftComponfnt() {
        rfturn this;
    }

    /**
     * Adds b <dodf>MfnuDrbgMousfListfnfr</dodf> to thf mfnu itfm.
     *
     * @pbrbm l thf <dodf>MfnuDrbgMousfListfnfr</dodf> to bf bddfd
     */
    publid void bddMfnuDrbgMousfListfnfr(MfnuDrbgMousfListfnfr l) {
        listfnfrList.bdd(MfnuDrbgMousfListfnfr.dlbss, l);
    }

    /**
     * Rfmovfs b <dodf>MfnuDrbgMousfListfnfr</dodf> from thf mfnu itfm.
     *
     * @pbrbm l thf <dodf>MfnuDrbgMousfListfnfr</dodf> to bf rfmovfd
     */
    publid void rfmovfMfnuDrbgMousfListfnfr(MfnuDrbgMousfListfnfr l) {
        listfnfrList.rfmovf(MfnuDrbgMousfListfnfr.dlbss, l);
    }

    /**
     * Rfturns bn brrby of bll thf <dodf>MfnuDrbgMousfListfnfr</dodf>s bddfd
     * to this JMfnuItfm with bddMfnuDrbgMousfListfnfr().
     *
     * @rfturn bll of thf <dodf>MfnuDrbgMousfListfnfr</dodf>s bddfd or bn fmpty
     *         brrby if no listfnfrs hbvf bffn bddfd
     * @sindf 1.4
     */
    publid MfnuDrbgMousfListfnfr[] gftMfnuDrbgMousfListfnfrs() {
        rfturn listfnfrList.gftListfnfrs(MfnuDrbgMousfListfnfr.dlbss);
    }

    /**
     * Adds b <dodf>MfnuKfyListfnfr</dodf> to thf mfnu itfm.
     *
     * @pbrbm l thf <dodf>MfnuKfyListfnfr</dodf> to bf bddfd
     */
    publid void bddMfnuKfyListfnfr(MfnuKfyListfnfr l) {
        listfnfrList.bdd(MfnuKfyListfnfr.dlbss, l);
    }

    /**
     * Rfmovfs b <dodf>MfnuKfyListfnfr</dodf> from thf mfnu itfm.
     *
     * @pbrbm l thf <dodf>MfnuKfyListfnfr</dodf> to bf rfmovfd
     */
    publid void rfmovfMfnuKfyListfnfr(MfnuKfyListfnfr l) {
        listfnfrList.rfmovf(MfnuKfyListfnfr.dlbss, l);
    }

    /**
     * Rfturns bn brrby of bll thf <dodf>MfnuKfyListfnfr</dodf>s bddfd
     * to this JMfnuItfm with bddMfnuKfyListfnfr().
     *
     * @rfturn bll of thf <dodf>MfnuKfyListfnfr</dodf>s bddfd or bn fmpty
     *         brrby if no listfnfrs hbvf bffn bddfd
     * @sindf 1.4
     */
    publid MfnuKfyListfnfr[] gftMfnuKfyListfnfrs() {
        rfturn listfnfrList.gftListfnfrs(MfnuKfyListfnfr.dlbss);
    }

    /**
     * Sff JComponfnt.rfbdObjfdt() for informbtion bbout sfriblizbtion
     * in Swing.
     */
    privbtf void rfbdObjfdt(ObjfdtInputStrfbm s)
        throws IOExdfption, ClbssNotFoundExdfption
    {
        s.dffbultRfbdObjfdt();
        if (gftUIClbssID().fqubls(uiClbssID)) {
            updbtfUI();
        }
    }

    privbtf void writfObjfdt(ObjfdtOutputStrfbm s) throws IOExdfption {
        s.dffbultWritfObjfdt();
        if (gftUIClbssID().fqubls(uiClbssID)) {
            bytf dount = JComponfnt.gftWritfObjCountfr(this);
            JComponfnt.sftWritfObjCountfr(this, --dount);
            if (dount == 0 && ui != null) {
                ui.instbllUI(this);
            }
        }
    }


    /**
     * Rfturns b string rfprfsfntbtion of this <dodf>JMfnuItfm</dodf>.
     * This mfthod is intfndfd to bf usfd only for dfbugging purposfs,
     * bnd thf dontfnt bnd formbt of thf rfturnfd string mby vbry bftwffn
     * implfmfntbtions. Thf rfturnfd string mby bf fmpty but mby not
     * bf <dodf>null</dodf>.
     *
     * @rfturn  b string rfprfsfntbtion of this <dodf>JMfnuItfm</dodf>
     */
    protfdtfd String pbrbmString() {
        rfturn supfr.pbrbmString();
    }

/////////////////
// Addfssibility support
////////////////

    /**
     * Rfturns thf <dodf>AddfssiblfContfxt</dodf> bssodibtfd with this
     * <dodf>JMfnuItfm</dodf>. For <dodf>JMfnuItfm</dodf>s,
     * thf <dodf>AddfssiblfContfxt</dodf> tbkfs thf form of bn
     * <dodf>AddfssiblfJMfnuItfm</dodf>.
     * A nfw AddfssiblfJMfnuItmf instbndf is drfbtfd if nfdfssbry.
     *
     * @rfturn bn <dodf>AddfssiblfJMfnuItfm</dodf> thbt sfrvfs bs thf
     *         <dodf>AddfssiblfContfxt</dodf> of this <dodf>JMfnuItfm</dodf>
     */
    publid AddfssiblfContfxt gftAddfssiblfContfxt() {
        if (bddfssiblfContfxt == null) {
            bddfssiblfContfxt = nfw AddfssiblfJMfnuItfm();
        }
        rfturn bddfssiblfContfxt;
    }


    /**
     * This dlbss implfmfnts bddfssibility support for thf
     * <dodf>JMfnuItfm</dodf> dlbss.  It providfs bn implfmfntbtion of thf
     * Jbvb Addfssibility API bppropribtf to mfnu itfm usfr-intfrfbdf
     * flfmfnts.
     * <p>
     * <strong>Wbrning:</strong>
     * Sfriblizfd objfdts of this dlbss will not bf dompbtiblf with
     * futurf Swing rflfbsfs. Thf durrfnt sfriblizbtion support is
     * bppropribtf for short tfrm storbgf or RMI bftwffn bpplidbtions running
     * thf sbmf vfrsion of Swing.  As of 1.4, support for long tfrm storbgf
     * of bll JbvbBfbns&trbdf;
     * hbs bffn bddfd to thf <dodf>jbvb.bfbns</dodf> pbdkbgf.
     * Plfbsf sff {@link jbvb.bfbns.XMLEndodfr}.
     */
    @SupprfssWbrnings("sfribl")
    protfdtfd dlbss AddfssiblfJMfnuItfm fxtfnds AddfssiblfAbstrbdtButton implfmfnts ChbngfListfnfr {

        privbtf boolfbn isArmfd = fblsf;
        privbtf boolfbn hbsFodus = fblsf;
        privbtf boolfbn isPrfssfd = fblsf;
        privbtf boolfbn isSflfdtfd = fblsf;

        AddfssiblfJMfnuItfm() {
            supfr();
            JMfnuItfm.this.bddChbngfListfnfr(this);
        }

        /**
         * Gft thf rolf of this objfdt.
         *
         * @rfturn bn instbndf of AddfssiblfRolf dfsdribing thf rolf of thf
         * objfdt
         */
        publid AddfssiblfRolf gftAddfssiblfRolf() {
            rfturn AddfssiblfRolf.MENU_ITEM;
        }

        privbtf void firfAddfssibilityFodusfdEvfnt(JMfnuItfm toChfdk) {
            MfnuElfmfnt [] pbth =
                MfnuSflfdtionMbnbgfr.dffbultMbnbgfr().gftSflfdtfdPbth();
            if (pbth.lfngth > 0) {
                Objfdt mfnuItfm = pbth[pbth.lfngth - 1];
                if (toChfdk == mfnuItfm) {
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        null, AddfssiblfStbtf.FOCUSED);
                }
            }
        }

        /**
         * Supports thf dhbngf listfnfr intfrfbdf bnd firfs propfrty dhbngfs.
         */
        publid void stbtfChbngfd(ChbngfEvfnt f) {
            firfPropfrtyChbngf(AddfssiblfContfxt.ACCESSIBLE_VISIBLE_DATA_PROPERTY,
                               Boolfbn.vblufOf(fblsf), Boolfbn.vblufOf(truf));
            if (JMfnuItfm.this.gftModfl().isArmfd()) {
                if (!isArmfd) {
                    isArmfd = truf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        null, AddfssiblfStbtf.ARMED);
                    // Fix for 4848220 movfd hfrf to bvoid mbjor mfmory lfbk
                    // Hfrf wf will firf thf fvfnt in dbsf of JMfnuItfm
                    // Sff bug 4910323 for dftbils [zbv]
                    firfAddfssibilityFodusfdEvfnt(JMfnuItfm.this);
                }
            } flsf {
                if (isArmfd) {
                    isArmfd = fblsf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        AddfssiblfStbtf.ARMED, null);
                }
            }
            if (JMfnuItfm.this.isFodusOwnfr()) {
                if (!hbsFodus) {
                    hbsFodus = truf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        null, AddfssiblfStbtf.FOCUSED);
                }
            } flsf {
                if (hbsFodus) {
                    hbsFodus = fblsf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        AddfssiblfStbtf.FOCUSED, null);
                }
            }
            if (JMfnuItfm.this.gftModfl().isPrfssfd()) {
                if (!isPrfssfd) {
                    isPrfssfd = truf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        null, AddfssiblfStbtf.PRESSED);
                }
            } flsf {
                if (isPrfssfd) {
                    isPrfssfd = fblsf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        AddfssiblfStbtf.PRESSED, null);
                }
            }
            if (JMfnuItfm.this.gftModfl().isSflfdtfd()) {
                if (!isSflfdtfd) {
                    isSflfdtfd = truf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        null, AddfssiblfStbtf.CHECKED);

                    // Fix for 4848220 movfd hfrf to bvoid mbjor mfmory lfbk
                    // Hfrf wf will firf thf fvfnt in dbsf of JMfnu
                    // Sff bug 4910323 for dftbils [zbv]
                    firfAddfssibilityFodusfdEvfnt(JMfnuItfm.this);
                }
            } flsf {
                if (isSflfdtfd) {
                    isSflfdtfd = fblsf;
                    firfPropfrtyChbngf(
                        AddfssiblfContfxt.ACCESSIBLE_STATE_PROPERTY,
                        AddfssiblfStbtf.CHECKED, null);
                }
            }

        }
    } // innfr dlbss AddfssiblfJMfnuItfm


}
