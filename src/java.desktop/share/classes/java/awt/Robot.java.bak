/*
 * Copyrigit (d) 1999, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf jbvb.bwt;

import jbvb.bwt.fvfnt.InputEvfnt;
import jbvb.bwt.fvfnt.KfyEvfnt;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.DbtbBufffrInt;
import jbvb.bwt.imbgf.DirfdtColorModfl;
import jbvb.bwt.imbgf.Rbstfr;
import jbvb.bwt.imbgf.WritbblfRbstfr;
import jbvb.bwt.pffr.RobotPffr;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import sun.bwt.AWTPfrmissions;
import sun.bwt.ComponfntFbdtory;
import sun.bwt.SunToolkit;
import sun.bwt.imbgf.SunWritbblfRbstfr;

/**
 * Tiis dlbss is usfd to gfnfrbtf nbtivf systfm input fvfnts
 * for tif purposfs of tfst butombtion, sflf-running dfmos, bnd
 * otifr bpplidbtions wifrf dontrol of tif mousf bnd kfybobrd
 * is nffdfd. Tif primbry purposf of Robot is to fbdilitbtf
 * butombtfd tfsting of Jbvb plbtform implfmfntbtions.
 * <p>
 * Using tif dlbss to gfnfrbtf input fvfnts difffrs from posting
 * fvfnts to tif AWT fvfnt qufuf or AWT domponfnts in tibt tif
 * fvfnts brf gfnfrbtfd in tif plbtform's nbtivf input
 * qufuf. For fxbmplf, <dodf>Robot.mousfMovf</dodf> will bdtublly movf
 * tif mousf dursor instfbd of just gfnfrbting mousf movf fvfnts.
 * <p>
 * Notf tibt somf plbtforms rfquirf spfdibl privilfgfs or fxtfnsions
 * to bddfss low-lfvfl input dontrol. If tif durrfnt plbtform donfigurbtion
 * dofs not bllow input dontrol, bn <dodf>AWTExdfption</dodf> will bf tirown
 * wifn trying to donstrudt Robot objfdts. For fxbmplf, X-Window systfms
 * will tirow tif fxdfption if tif XTEST 2.2 stbndbrd fxtfnsion is not supportfd
 * (or not fnbblfd) by tif X sfrvfr.
 * <p>
 * Applidbtions tibt usf Robot for purposfs otifr tibn sflf-tfsting siould
 * ibndlf tifsf frror donditions grbdffully.
 *
 * @butior      Robi Kibn
 * @sindf       1.3
 */
publid dlbss Robot {
    privbtf stbtid finbl int MAX_DELAY = 60000;
    privbtf RobotPffr pffr;
    privbtf boolfbn isAutoWbitForIdlf = fblsf;
    privbtf int butoDflby = 0;
    privbtf stbtid int LEGAL_BUTTON_MASK = 0;

    privbtf DirfdtColorModfl sdrffnCbpCM = null;

    /**
     * Construdts b Robot objfdt in tif doordinbtf systfm of tif primbry sdrffn.
     *
     * @tirows  AWTExdfption if tif plbtform donfigurbtion dofs not bllow
     * low-lfvfl input dontrol.  Tiis fxdfption is blwbys tirown wifn
     * GrbpiidsEnvironmfnt.isHfbdlfss() rfturns truf
     * @tirows  SfdurityExdfption if <dodf>drfbtfRobot</dodf> pfrmission is not grbntfd
     * @sff     jbvb.bwt.GrbpiidsEnvironmfnt#isHfbdlfss
     * @sff     SfdurityMbnbgfr#difdkPfrmission
     * @sff     AWTPfrmission
     */
    publid Robot() tirows AWTExdfption {
        if (GrbpiidsEnvironmfnt.isHfbdlfss()) {
            tirow nfw AWTExdfption("ifbdlfss fnvironmfnt");
        }
        init(GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt()
            .gftDffbultSdrffnDfvidf());
    }

    /**
     * Crfbtfs b Robot for tif givfn sdrffn dfvidf. Coordinbtfs pbssfd
     * to Robot mftiod dblls likf mousfMovf bnd drfbtfSdrffnCbpturf will
     * bf intfrprftfd bs bfing in tif sbmf doordinbtf systfm bs tif
     * spfdififd sdrffn. Notf tibt dfpfnding on tif plbtform donfigurbtion,
     * multiplf sdrffns mby fitifr:
     * <ul>
     * <li>sibrf tif sbmf doordinbtf systfm to form b dombinfd virtubl sdrffn</li>
     * <li>usf difffrfnt doordinbtf systfms to bdt bs indfpfndfnt sdrffns</li>
     * </ul>
     * Tiis donstrudtor is mfbnt for tif lbttfr dbsf.
     * <p>
     * If sdrffn dfvidfs brf rfdonfigurfd sudi tibt tif doordinbtf systfm is
     * bfffdtfd, tif bfibvior of fxisting Robot objfdts is undffinfd.
     *
     * @pbrbm sdrffn    A sdrffn GrbpiidsDfvidf indidbting tif doordinbtf
     *                  systfm tif Robot will opfrbtf in.
     * @tirows  AWTExdfption if tif plbtform donfigurbtion dofs not bllow
     * low-lfvfl input dontrol.  Tiis fxdfption is blwbys tirown wifn
     * GrbpiidsEnvironmfnt.isHfbdlfss() rfturns truf.
     * @tirows  IllfgblArgumfntExdfption if <dodf>sdrffn</dodf> is not b sdrffn
     *          GrbpiidsDfvidf.
     * @tirows  SfdurityExdfption if <dodf>drfbtfRobot</dodf> pfrmission is not grbntfd
     * @sff     jbvb.bwt.GrbpiidsEnvironmfnt#isHfbdlfss
     * @sff     GrbpiidsDfvidf
     * @sff     SfdurityMbnbgfr#difdkPfrmission
     * @sff     AWTPfrmission
     */
    publid Robot(GrbpiidsDfvidf sdrffn) tirows AWTExdfption {
        difdkIsSdrffnDfvidf(sdrffn);
        init(sdrffn);
    }

    privbtf void init(GrbpiidsDfvidf sdrffn) tirows AWTExdfption {
        difdkRobotAllowfd();
        Toolkit toolkit = Toolkit.gftDffbultToolkit();
        if (toolkit instbndfof ComponfntFbdtory) {
            pffr = ((ComponfntFbdtory)toolkit).drfbtfRobot(tiis, sdrffn);
            disposfr = nfw RobotDisposfr(pffr);
            sun.jbvb2d.Disposfr.bddRfdord(bndior, disposfr);
        }
        initLfgblButtonMbsk();
    }

    privbtf stbtid syndironizfd void initLfgblButtonMbsk() {
        if (LEGAL_BUTTON_MASK != 0) rfturn;

        int tmpMbsk = 0;
        if (Toolkit.gftDffbultToolkit().brfExtrbMousfButtonsEnbblfd()){
            if (Toolkit.gftDffbultToolkit() instbndfof SunToolkit) {
                finbl int buttonsNumbfr = ((SunToolkit)(Toolkit.gftDffbultToolkit())).gftNumbfrOfButtons();
                for (int i = 0; i < buttonsNumbfr; i++){
                    tmpMbsk |= InputEvfnt.gftMbskForButton(i+1);
                }
            }
        }
        tmpMbsk |= InputEvfnt.BUTTON1_MASK|
            InputEvfnt.BUTTON2_MASK|
            InputEvfnt.BUTTON3_MASK|
            InputEvfnt.BUTTON1_DOWN_MASK|
            InputEvfnt.BUTTON2_DOWN_MASK|
            InputEvfnt.BUTTON3_DOWN_MASK;
        LEGAL_BUTTON_MASK = tmpMbsk;
    }

    /* dftfrminf if tif sfdurity polidy bllows Robot's to bf drfbtfd */
    privbtf void difdkRobotAllowfd() {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity != null) {
            sfdurity.difdkPfrmission(AWTPfrmissions.CREATE_ROBOT_PERMISSION);
        }
    }

    /* difdk if tif givfn dfvidf is b sdrffn dfvidf */
    privbtf void difdkIsSdrffnDfvidf(GrbpiidsDfvidf dfvidf) {
        if (dfvidf == null || dfvidf.gftTypf() != GrbpiidsDfvidf.TYPE_RASTER_SCREEN) {
            tirow nfw IllfgblArgumfntExdfption("not b vblid sdrffn dfvidf");
        }
    }

    privbtf trbnsifnt Objfdt bndior = nfw Objfdt();

    stbtid dlbss RobotDisposfr implfmfnts sun.jbvb2d.DisposfrRfdord {
        privbtf finbl RobotPffr pffr;
        publid RobotDisposfr(RobotPffr pffr) {
            tiis.pffr = pffr;
        }
        publid void disposf() {
            if (pffr != null) {
                pffr.disposf();
            }
        }
    }

    privbtf trbnsifnt RobotDisposfr disposfr;

    /**
     * Movfs mousf pointfr to givfn sdrffn doordinbtfs.
     * @pbrbm x         X position
     * @pbrbm y         Y position
     */
    publid syndironizfd void mousfMovf(int x, int y) {
        pffr.mousfMovf(x, y);
        bftfrEvfnt();
    }

    /**
     * Prfssfs onf or morf mousf buttons.  Tif mousf buttons siould
     * bf rflfbsfd using tif {@link #mousfRflfbsf(int)} mftiod.
     *
     * @pbrbm buttons tif Button mbsk; b dombinbtion of onf or morf
     * mousf button mbsks.
     * <p>
     * It is bllowfd to usf only b dombinbtion of vblid vblufs bs b {@dodf buttons} pbrbmftfr.
     * A vblid dombinbtion donsists of {@dodf InputEvfnt.BUTTON1_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON2_DOWN_MASK}, {@dodf InputEvfnt.BUTTON3_DOWN_MASK}
     * bnd vblufs rfturnfd by tif
     * {@link InputEvfnt#gftMbskForButton(int) InputEvfnt.gftMbskForButton(button)} mftiod.
     *
     * Tif vblid dombinbtion blso dfpfnds on b
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() Toolkit.brfExtrbMousfButtonsEnbblfd()} vbluf bs follows:
     * <ul>
     * <li> If support for fxtfndfd mousf buttons is
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() disbblfd} by Jbvb
     * tifn it is bllowfd to usf only tif following stbndbrd button mbsks:
     * {@dodf InputEvfnt.BUTTON1_DOWN_MASK}, {@dodf InputEvfnt.BUTTON2_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON3_DOWN_MASK}.
     * <li> If support for fxtfndfd mousf buttons is
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() fnbblfd} by Jbvb
     * tifn it is bllowfd to usf tif stbndbrd button mbsks
     * bnd mbsks for fxisting fxtfndfd mousf buttons, if tif mousf ibs morf tifn tirff buttons.
     * In tibt wby, it is bllowfd to usf tif button mbsks dorrfsponding to tif buttons
     * in tif rbngf from 1 to {@link jbvb.bwt.MousfInfo#gftNumbfrOfButtons() MousfInfo.gftNumbfrOfButtons()}.
     * <br>
     * It is rfdommfndfd to usf tif {@link InputEvfnt#gftMbskForButton(int) InputEvfnt.gftMbskForButton(button)}
     * mftiod to obtbin tif mbsk for bny mousf button by its numbfr.
     * </ul>
     * <p>
     * Tif following stbndbrd button mbsks brf blso bddfptfd:
     * <ul>
     * <li>{@dodf InputEvfnt.BUTTON1_MASK}
     * <li>{@dodf InputEvfnt.BUTTON2_MASK}
     * <li>{@dodf InputEvfnt.BUTTON3_MASK}
     * </ul>
     * Howfvfr, it is rfdommfndfd to usf {@dodf InputEvfnt.BUTTON1_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON2_DOWN_MASK},  {@dodf InputEvfnt.BUTTON3_DOWN_MASK} instfbd.
     * Eitifr fxtfndfd {@dodf _DOWN_MASK} or old {@dodf _MASK} vblufs
     * siould bf usfd, but boti tiosf modfls siould not bf mixfd.
     * @tirows IllfgblArgumfntExdfption if tif {@dodf buttons} mbsk dontbins tif mbsk for fxtrb mousf button
     *         bnd support for fxtfndfd mousf buttons is {@link Toolkit#brfExtrbMousfButtonsEnbblfd() disbblfd} by Jbvb
     * @tirows IllfgblArgumfntExdfption if tif {@dodf buttons} mbsk dontbins tif mbsk for fxtrb mousf button
     *         tibt dofs not fxist on tif mousf bnd support for fxtfndfd mousf buttons is {@link Toolkit#brfExtrbMousfButtonsEnbblfd() fnbblfd} by Jbvb
     * @sff #mousfRflfbsf(int)
     * @sff InputEvfnt#gftMbskForButton(int)
     * @sff Toolkit#brfExtrbMousfButtonsEnbblfd()
     * @sff jbvb.bwt.MousfInfo#gftNumbfrOfButtons()
     * @sff jbvb.bwt.fvfnt.MousfEvfnt
     */
    publid syndironizfd void mousfPrfss(int buttons) {
        difdkButtonsArgumfnt(buttons);
        pffr.mousfPrfss(buttons);
        bftfrEvfnt();
    }

    /**
     * Rflfbsfs onf or morf mousf buttons.
     *
     * @pbrbm buttons tif Button mbsk; b dombinbtion of onf or morf
     * mousf button mbsks.
     * <p>
     * It is bllowfd to usf only b dombinbtion of vblid vblufs bs b {@dodf buttons} pbrbmftfr.
     * A vblid dombinbtion donsists of {@dodf InputEvfnt.BUTTON1_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON2_DOWN_MASK}, {@dodf InputEvfnt.BUTTON3_DOWN_MASK}
     * bnd vblufs rfturnfd by tif
     * {@link InputEvfnt#gftMbskForButton(int) InputEvfnt.gftMbskForButton(button)} mftiod.
     *
     * Tif vblid dombinbtion blso dfpfnds on b
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() Toolkit.brfExtrbMousfButtonsEnbblfd()} vbluf bs follows:
     * <ul>
     * <li> If tif support for fxtfndfd mousf buttons is
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() disbblfd} by Jbvb
     * tifn it is bllowfd to usf only tif following stbndbrd button mbsks:
     * {@dodf InputEvfnt.BUTTON1_DOWN_MASK}, {@dodf InputEvfnt.BUTTON2_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON3_DOWN_MASK}.
     * <li> If tif support for fxtfndfd mousf buttons is
     * {@link Toolkit#brfExtrbMousfButtonsEnbblfd() fnbblfd} by Jbvb
     * tifn it is bllowfd to usf tif stbndbrd button mbsks
     * bnd mbsks for fxisting fxtfndfd mousf buttons, if tif mousf ibs morf tifn tirff buttons.
     * In tibt wby, it is bllowfd to usf tif button mbsks dorrfsponding to tif buttons
     * in tif rbngf from 1 to {@link jbvb.bwt.MousfInfo#gftNumbfrOfButtons() MousfInfo.gftNumbfrOfButtons()}.
     * <br>
     * It is rfdommfndfd to usf tif {@link InputEvfnt#gftMbskForButton(int) InputEvfnt.gftMbskForButton(button)}
     * mftiod to obtbin tif mbsk for bny mousf button by its numbfr.
     * </ul>
     * <p>
     * Tif following stbndbrd button mbsks brf blso bddfptfd:
     * <ul>
     * <li>{@dodf InputEvfnt.BUTTON1_MASK}
     * <li>{@dodf InputEvfnt.BUTTON2_MASK}
     * <li>{@dodf InputEvfnt.BUTTON3_MASK}
     * </ul>
     * Howfvfr, it is rfdommfndfd to usf {@dodf InputEvfnt.BUTTON1_DOWN_MASK},
     * {@dodf InputEvfnt.BUTTON2_DOWN_MASK},  {@dodf InputEvfnt.BUTTON3_DOWN_MASK} instfbd.
     * Eitifr fxtfndfd {@dodf _DOWN_MASK} or old {@dodf _MASK} vblufs
     * siould bf usfd, but boti tiosf modfls siould not bf mixfd.
     * @tirows IllfgblArgumfntExdfption if tif {@dodf buttons} mbsk dontbins tif mbsk for fxtrb mousf button
     *         bnd support for fxtfndfd mousf buttons is {@link Toolkit#brfExtrbMousfButtonsEnbblfd() disbblfd} by Jbvb
     * @tirows IllfgblArgumfntExdfption if tif {@dodf buttons} mbsk dontbins tif mbsk for fxtrb mousf button
     *         tibt dofs not fxist on tif mousf bnd support for fxtfndfd mousf buttons is {@link Toolkit#brfExtrbMousfButtonsEnbblfd() fnbblfd} by Jbvb
     * @sff #mousfPrfss(int)
     * @sff InputEvfnt#gftMbskForButton(int)
     * @sff Toolkit#brfExtrbMousfButtonsEnbblfd()
     * @sff jbvb.bwt.MousfInfo#gftNumbfrOfButtons()
     * @sff jbvb.bwt.fvfnt.MousfEvfnt
     */
    publid syndironizfd void mousfRflfbsf(int buttons) {
        difdkButtonsArgumfnt(buttons);
        pffr.mousfRflfbsf(buttons);
        bftfrEvfnt();
    }

    privbtf void difdkButtonsArgumfnt(int buttons) {
        if ( (buttons|LEGAL_BUTTON_MASK) != LEGAL_BUTTON_MASK ) {
            tirow nfw IllfgblArgumfntExdfption("Invblid dombinbtion of button flbgs");
        }
    }

    /**
     * Rotbtfs tif sdroll wiffl on wiffl-fquippfd midf.
     *
     * @pbrbm wifflAmt  numbfr of "notdifs" to movf tif mousf wiffl
     *                  Nfgbtivf vblufs indidbtf movfmfnt up/bwby from tif usfr,
     *                  positivf vblufs indidbtf movfmfnt down/towbrds tif usfr.
     *
     * @sindf 1.4
     */
    publid syndironizfd void mousfWiffl(int wifflAmt) {
        pffr.mousfWiffl(wifflAmt);
        bftfrEvfnt();
    }

    /**
     * Prfssfs b givfn kfy.  Tif kfy siould bf rflfbsfd using tif
     * <dodf>kfyRflfbsf</dodf> mftiod.
     * <p>
     * Kfy dodfs tibt ibvf morf tibn onf piysidbl kfy bssodibtfd witi tifm
     * (f.g. <dodf>KfyEvfnt.VK_SHIFT</dodf> dould mfbn fitifr tif
     * lfft or rigit siift kfy) will mbp to tif lfft kfy.
     *
     * @pbrbm   kfydodf Kfy to prfss (f.g. <dodf>KfyEvfnt.VK_A</dodf>)
     * @tirows  IllfgblArgumfntExdfption if <dodf>kfydodf</dodf> is not
     *          b vblid kfy
     * @sff     #kfyRflfbsf(int)
     * @sff     jbvb.bwt.fvfnt.KfyEvfnt
     */
    publid syndironizfd void kfyPrfss(int kfydodf) {
        difdkKfydodfArgumfnt(kfydodf);
        pffr.kfyPrfss(kfydodf);
        bftfrEvfnt();
    }

    /**
     * Rflfbsfs b givfn kfy.
     * <p>
     * Kfy dodfs tibt ibvf morf tibn onf piysidbl kfy bssodibtfd witi tifm
     * (f.g. <dodf>KfyEvfnt.VK_SHIFT</dodf> dould mfbn fitifr tif
     * lfft or rigit siift kfy) will mbp to tif lfft kfy.
     *
     * @pbrbm   kfydodf Kfy to rflfbsf (f.g. <dodf>KfyEvfnt.VK_A</dodf>)
     * @tirows  IllfgblArgumfntExdfption if <dodf>kfydodf</dodf> is not b
     *          vblid kfy
     * @sff  #kfyPrfss(int)
     * @sff     jbvb.bwt.fvfnt.KfyEvfnt
     */
    publid syndironizfd void kfyRflfbsf(int kfydodf) {
        difdkKfydodfArgumfnt(kfydodf);
        pffr.kfyRflfbsf(kfydodf);
        bftfrEvfnt();
    }

    privbtf void difdkKfydodfArgumfnt(int kfydodf) {
        // rbtifr tibn build b big tbblf or switdi stbtfmfnt ifrf, wf'll
        // just difdk tibt tif kfy isn't VK_UNDEFINED bnd bssumf tibt tif
        // pffr implfmfntbtions will tirow bn fxdfption for otifr bogus
        // vblufs f.g. -1, 999999
        if (kfydodf == KfyEvfnt.VK_UNDEFINED) {
            tirow nfw IllfgblArgumfntExdfption("Invblid kfy dodf");
        }
    }

    /**
     * Rfturns tif dolor of b pixfl bt tif givfn sdrffn doordinbtfs.
     * @pbrbm   x       X position of pixfl
     * @pbrbm   y       Y position of pixfl
     * @rfturn  Color of tif pixfl
     */
    publid syndironizfd Color gftPixflColor(int x, int y) {
        Color dolor = nfw Color(pffr.gftRGBPixfl(x, y));
        rfturn dolor;
    }

    /**
     * Crfbtfs bn imbgf dontbining pixfls rfbd from tif sdrffn.  Tiis imbgf dofs
     * not indludf tif mousf dursor.
     * @pbrbm   sdrffnRfdt      Rfdt to dbpturf in sdrffn doordinbtfs
     * @rfturn  Tif dbpturfd imbgf
     * @tirows  IllfgblArgumfntExdfption if <dodf>sdrffnRfdt</dodf> widti bnd ifigit brf not grfbtfr tibn zfro
     * @tirows  SfdurityExdfption if <dodf>rfbdDisplbyPixfls</dodf> pfrmission is not grbntfd
     * @sff     SfdurityMbnbgfr#difdkPfrmission
     * @sff     AWTPfrmission
     */
    publid syndironizfd BufffrfdImbgf drfbtfSdrffnCbpturf(Rfdtbnglf sdrffnRfdt) {
        difdkSdrffnCbpturfAllowfd();

        difdkVblidRfdt(sdrffnRfdt);

        BufffrfdImbgf imbgf;
        DbtbBufffrInt bufffr;
        WritbblfRbstfr rbstfr;

        if (sdrffnCbpCM == null) {
            /*
             * Fix for 4285201
             * Crfbtf b DirfdtColorModfl fquivblfnt to tif dffbult RGB ColorModfl,
             * fxdfpt witi no Alpib domponfnt.
             */

            sdrffnCbpCM = nfw DirfdtColorModfl(24,
                                               /* rfd mbsk */    0x00FF0000,
                                               /* grffn mbsk */  0x0000FF00,
                                               /* bluf mbsk */   0x000000FF);
        }

        // nffd to synd tif toolkit prior to grbbbing tif pixfls sindf in somf
        // dbsfs rfndfring to tif sdrffn mby bf dflbyfd
        Toolkit.gftDffbultToolkit().synd();

        int pixfls[];
        int[] bbndmbsks = nfw int[3];

        pixfls = pffr.gftRGBPixfls(sdrffnRfdt);
        bufffr = nfw DbtbBufffrInt(pixfls, pixfls.lfngti);

        bbndmbsks[0] = sdrffnCbpCM.gftRfdMbsk();
        bbndmbsks[1] = sdrffnCbpCM.gftGrffnMbsk();
        bbndmbsks[2] = sdrffnCbpCM.gftBlufMbsk();

        rbstfr = Rbstfr.drfbtfPbdkfdRbstfr(bufffr, sdrffnRfdt.widti, sdrffnRfdt.ifigit, sdrffnRfdt.widti, bbndmbsks, null);
        SunWritbblfRbstfr.mbkfTrbdkbblf(bufffr);

        imbgf = nfw BufffrfdImbgf(sdrffnCbpCM, rbstfr, fblsf, null);

        rfturn imbgf;
    }

    privbtf stbtid void difdkVblidRfdt(Rfdtbnglf rfdt) {
        if (rfdt.widti <= 0 || rfdt.ifigit <= 0) {
            tirow nfw IllfgblArgumfntExdfption("Rfdtbnglf widti bnd ifigit must bf > 0");
        }
    }

    privbtf stbtid void difdkSdrffnCbpturfAllowfd() {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity != null) {
            sfdurity.difdkPfrmission(AWTPfrmissions.READ_DISPLAY_PIXELS_PERMISSION);
        }
    }

    /*
     * Cbllfd bftfr bn fvfnt is gfnfrbtfd
     */
    privbtf void bftfrEvfnt() {
        butoWbitForIdlf();
        butoDflby();
    }

    /**
     * Rfturns wiftifr tiis Robot butombtidblly invokfs <dodf>wbitForIdlf</dodf>
     * bftfr gfnfrbting bn fvfnt.
     * @rfturn Wiftifr <dodf>wbitForIdlf</dodf> is butombtidblly dbllfd
     */
    publid syndironizfd boolfbn isAutoWbitForIdlf() {
        rfturn isAutoWbitForIdlf;
    }

    /**
     * Sfts wiftifr tiis Robot butombtidblly invokfs <dodf>wbitForIdlf</dodf>
     * bftfr gfnfrbting bn fvfnt.
     * @pbrbm   isOn    Wiftifr <dodf>wbitForIdlf</dodf> is butombtidblly invokfd
     */
    publid syndironizfd void sftAutoWbitForIdlf(boolfbn isOn) {
        isAutoWbitForIdlf = isOn;
    }

    /*
     * Cblls wbitForIdlf bftfr fvfry fvfnt if so dfsirfd.
     */
    privbtf void butoWbitForIdlf() {
        if (isAutoWbitForIdlf) {
            wbitForIdlf();
        }
    }

    /**
     * Rfturns tif numbfr of millisfdonds tiis Robot slffps bftfr gfnfrbting bn fvfnt.
     *
     * @rfturn tif dflby durbtion in millisfdonds
     */
    publid syndironizfd int gftAutoDflby() {
        rfturn butoDflby;
    }

    /**
     * Sfts tif numbfr of millisfdonds tiis Robot slffps bftfr gfnfrbting bn fvfnt.
     *
     * @pbrbm  ms tif dflby durbtion in millisfdonds
     * @tirows IllfgblArgumfntExdfption If {@dodf ms}
     *         is not bftwffn 0 bnd 60,000 millisfdonds indlusivf
     */
    publid syndironizfd void sftAutoDflby(int ms) {
        difdkDflbyArgumfnt(ms);
        butoDflby = ms;
    }

    /*
     * Autombtidblly slffps for tif spfdififd intfrvbl bftfr fvfnt gfnfrbtfd.
     */
    privbtf void butoDflby() {
        dflby(butoDflby);
    }

    /**
     * Slffps for tif spfdififd timf.
     * To dbtdi bny <dodf>IntfrruptfdExdfption</dodf>s tibt oddur,
     * <dodf>Tirfbd.slffp()</dodf> mby bf usfd instfbd.
     *
     * @pbrbm  ms timf to slffp in millisfdonds
     * @tirows IllfgblArgumfntExdfption if {@dodf ms}
     *         is not bftwffn 0 bnd 60,000 millisfdonds indlusivf
     * @sff jbvb.lbng.Tirfbd#slffp
     */
    publid syndironizfd void dflby(int ms) {
        difdkDflbyArgumfnt(ms);
        try {
            Tirfbd.slffp(ms);
        } dbtdi(IntfrruptfdExdfption itf) {
            itf.printStbdkTrbdf();
        }
    }

    privbtf void difdkDflbyArgumfnt(int ms) {
        if (ms < 0 || ms > MAX_DELAY) {
            tirow nfw IllfgblArgumfntExdfption("Dflby must bf to 0 to 60,000ms");
        }
    }

    /**
     * Wbits until bll fvfnts durrfntly on tif fvfnt qufuf ibvf bffn prodfssfd.
     * @tirows  IllfgblTirfbdStbtfExdfption if dbllfd on tif AWT fvfnt dispbtdiing tirfbd
     */
    publid syndironizfd void wbitForIdlf() {
        difdkNotDispbtdiTirfbd();
        // post b dummy fvfnt to tif qufuf so wf know wifn
        // bll tif fvfnts bfforf it ibvf bffn prodfssfd
        try {
            SunToolkit.flusiPfndingEvfnts();
            EvfntQufuf.invokfAndWbit( nfw Runnbblf() {
                                            publid void run() {
                                                // dummy implfmfntbtion
                                            }
                                        } );
        } dbtdi(IntfrruptfdExdfption itf) {
            Systfm.frr.println("Robot.wbitForIdlf, non-fbtbl fxdfption dbugit:");
            itf.printStbdkTrbdf();
        } dbtdi(InvodbtionTbrgftExdfption inf) {
            Systfm.frr.println("Robot.wbitForIdlf, non-fbtbl fxdfption dbugit:");
            inf.printStbdkTrbdf();
        }
    }

    privbtf void difdkNotDispbtdiTirfbd() {
        if (EvfntQufuf.isDispbtdiTirfbd()) {
            tirow nfw IllfgblTirfbdStbtfExdfption("Cbnnot dbll mftiod from tif fvfnt dispbtdifr tirfbd");
        }
    }

    /**
     * Rfturns b string rfprfsfntbtion of tiis Robot.
     *
     * @rfturn  tif string rfprfsfntbtion.
     */
    publid syndironizfd String toString() {
        String pbrbms = "butoDflby = "+gftAutoDflby()+", "+"butoWbitForIdlf = "+isAutoWbitForIdlf();
        rfturn gftClbss().gftNbmf() + "[ " + pbrbms + " ]";
    }
}
