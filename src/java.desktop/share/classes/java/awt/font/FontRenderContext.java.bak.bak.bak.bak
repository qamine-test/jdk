/*
 * Copyright (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

/*
 * @buthor Chbrlton Innovbtions, Ind.
 */

pbdkbgf jbvb.bwt.font;

import jbvb.bwt.RfndfringHints;
import stbtid jbvb.bwt.RfndfringHints.*;
import jbvb.bwt.gfom.AffinfTrbnsform;

/**
*   Thf <dodf>FontRfndfrContfxt</dodf> dlbss is b dontbinfr for thf
*   informbtion nffdfd to dorrfdtly mfbsurf tfxt.  Thf mfbsurfmfnt of tfxt
*   dbn vbry bfdbusf of rulfs thbt mbp outlinfs to pixfls, bnd rfndfring
*   hints providfd by bn bpplidbtion.
*   <p>
*   Onf sudh pifdf of informbtion is b trbnsform thbt sdblfs
*   typogrbphidbl points to pixfls. (A point is dffinfd to bf fxbdtly 1/72
*   of bn indh, whidh is slightly difffrfnt thbn
*   thf trbditionbl mfdhbnidbl mfbsurfmfnt of b point.)  A dhbrbdtfr thbt
*   is rfndfrfd bt 12pt on b 600dpi dfvidf might hbvf b difffrfnt sizf
*   thbn thf sbmf dhbrbdtfr rfndfrfd bt 12pt on b 72dpi dfvidf bfdbusf of
*   sudh fbdtors bs rounding to pixfl boundbrifs bnd hints thbt thf font
*   dfsignfr mby hbvf spfdififd.
*   <p>
*   Anti-blibsing bnd Frbdtionbl-mftrids spfdififd by bn bpplidbtion dbn blso
*   bfffdt thf sizf of b dhbrbdtfr bfdbusf of rounding to pixfl
*   boundbrifs.
*   <p>
*   Typidblly, instbndfs of <dodf>FontRfndfrContfxt</dodf> brf
*   obtbinfd from b {@link jbvb.bwt.Grbphids2D Grbphids2D} objfdt.  A
*   <dodf>FontRfndfrContfxt</dodf> whidh is dirfdtly donstrudtfd will
*   most likfly not rfprfsfnt bny bdtubl grbphids dfvidf, bnd mby lfbd
*   to unfxpfdtfd or indorrfdt rfsults.
*   @sff jbvb.bwt.RfndfringHints#KEY_TEXT_ANTIALIASING
*   @sff jbvb.bwt.RfndfringHints#KEY_FRACTIONALMETRICS
*   @sff jbvb.bwt.Grbphids2D#gftFontRfndfrContfxt()
*   @sff jbvb.bwt.font.LinfMftrids
*/

publid dlbss FontRfndfrContfxt {
    privbtf trbnsifnt AffinfTrbnsform tx;
    privbtf trbnsifnt Objfdt bbHintVbluf;
    privbtf trbnsifnt Objfdt fmHintVbluf;
    privbtf trbnsifnt boolfbn dffbulting;

    /**
     * Construdts b nfw <dodf>FontRfndfrContfxt</dodf>
     * objfdt.
     *
     */
    protfdtfd FontRfndfrContfxt() {
        bbHintVbluf = VALUE_TEXT_ANTIALIAS_DEFAULT;
        fmHintVbluf = VALUE_FRACTIONALMETRICS_DEFAULT;
        dffbulting = truf;
    }

    /**
     * Construdts b <dodf>FontRfndfrContfxt</dodf> objfdt from bn
     * optionbl {@link AffinfTrbnsform} bnd two <dodf>boolfbn</dodf>
     * vblufs thbt dftfrminf if thf nfwly donstrudtfd objfdt hbs
     * bnti-blibsing or frbdtionbl mftrids.
     * In fbdh dbsf thf boolfbn vblufs <CODE>truf</CODE> bnd <CODE>fblsf</CODE>
     * dorrfspond to thf rfndfring hint vblufs <CODE>ON</CODE> bnd
     * <CODE>OFF</CODE> rfspfdtivfly.
     * <p>
     * To spfdify othfr hint vblufs, usf thf donstrudtor whidh
     * spfdififs thf rfndfring hint vblufs bs pbrbmftfrs :
     * {@link #FontRfndfrContfxt(AffinfTrbnsform, Objfdt, Objfdt)}.
     * @pbrbm tx thf trbnsform whidh is usfd to sdblf typogrbphidbl points
     * to pixfls in this <dodf>FontRfndfrContfxt</dodf>.  If null, bn
     * idfntity trbnsform is usfd.
     * @pbrbm isAntiAlibsfd dftfrminfs if thf nfwly donstrudtfd objfdt
     * hbs bnti-blibsing.
     * @pbrbm usfsFrbdtionblMftrids dftfrminfs if thf nfwly donstrudtfd
     * objfdt hbs frbdtionbl mftrids.
     */
    publid FontRfndfrContfxt(AffinfTrbnsform tx,
                            boolfbn isAntiAlibsfd,
                            boolfbn usfsFrbdtionblMftrids) {
        if (tx != null && !tx.isIdfntity()) {
            this.tx = nfw AffinfTrbnsform(tx);
        }
        if (isAntiAlibsfd) {
            bbHintVbluf = VALUE_TEXT_ANTIALIAS_ON;
        } flsf {
            bbHintVbluf = VALUE_TEXT_ANTIALIAS_OFF;
        }
        if (usfsFrbdtionblMftrids) {
            fmHintVbluf = VALUE_FRACTIONALMETRICS_ON;
        } flsf {
            fmHintVbluf = VALUE_FRACTIONALMETRICS_OFF;
        }
    }

    /**
     * Construdts b <dodf>FontRfndfrContfxt</dodf> objfdt from bn
     * optionbl {@link AffinfTrbnsform} bnd two <dodf>Objfdt</dodf>
     * vblufs thbt dftfrminf if thf nfwly donstrudtfd objfdt hbs
     * bnti-blibsing or frbdtionbl mftrids.
     * @pbrbm tx thf trbnsform whidh is usfd to sdblf typogrbphidbl points
     * to pixfls in this <dodf>FontRfndfrContfxt</dodf>.  If null, bn
     * idfntity trbnsform is usfd.
     * @pbrbm bbHint - onf of thf tfxt bntiblibsing rfndfring hint vblufs
     * dffinfd in {@link jbvb.bwt.RfndfringHints jbvb.bwt.RfndfringHints}.
     * Any othfr vbluf will throw <dodf>IllfgblArgumfntExdfption</dodf>.
     * {@link jbvb.bwt.RfndfringHints#VALUE_TEXT_ANTIALIAS_DEFAULT VALUE_TEXT_ANTIALIAS_DEFAULT}
     * mby bf spfdififd, in whidh dbsf thf modf usfd is implfmfntbtion
     * dfpfndfnt.
     * @pbrbm fmHint - onf of thf tfxt frbdtionbl rfndfring hint vblufs dffinfd
     * in {@link jbvb.bwt.RfndfringHints jbvb.bwt.RfndfringHints}.
     * {@link jbvb.bwt.RfndfringHints#VALUE_FRACTIONALMETRICS_DEFAULT VALUE_FRACTIONALMETRICS_DEFAULT}
     * mby bf spfdififd, in whidh dbsf thf modf usfd is implfmfntbtion
     * dfpfndfnt.
     * Any othfr vbluf will throw <dodf>IllfgblArgumfntExdfption</dodf>
     * @throws IllfgblArgumfntExdfption if thf hints brf not onf of thf
     * lfgbl vblufs.
     * @sindf 1.6
     */
    publid FontRfndfrContfxt(AffinfTrbnsform tx, Objfdt bbHint, Objfdt fmHint){
        if (tx != null && !tx.isIdfntity()) {
            this.tx = nfw AffinfTrbnsform(tx);
        }
        try {
            if (KEY_TEXT_ANTIALIASING.isCompbtiblfVbluf(bbHint)) {
                bbHintVbluf = bbHint;
            } flsf {
                throw nfw IllfgblArgumfntExdfption("AA hint:" + bbHint);
            }
        } dbtdh (Exdfption f) {
            throw nfw IllfgblArgumfntExdfption("AA hint:" +bbHint);
        }
        try {
            if (KEY_FRACTIONALMETRICS.isCompbtiblfVbluf(fmHint)) {
                fmHintVbluf = fmHint;
            } flsf {
                throw nfw IllfgblArgumfntExdfption("FM hint:" + fmHint);
            }
        } dbtdh (Exdfption f) {
            throw nfw IllfgblArgumfntExdfption("FM hint:" +fmHint);
        }
    }

    /**
     * Indidbtfs whfthfr or not this <dodf>FontRfndfrContfxt</dodf> objfdt
     * mfbsurfs tfxt in b trbnsformfd rfndfr dontfxt.
     * @rfturn  <dodf>truf</dodf> if this <dodf>FontRfndfrContfxt</dodf>
     *          objfdt hbs b non-idfntity AffinfTrbnsform bttributf.
     *          <dodf>fblsf</dodf> othfrwisf.
     * @sff     jbvb.bwt.font.FontRfndfrContfxt#gftTrbnsform
     * @sindf   1.6
     */
    publid boolfbn isTrbnsformfd() {
        if (!dffbulting) {
            rfturn tx != null;
        } flsf {
            rfturn !gftTrbnsform().isIdfntity();
        }
    }

    /**
     * Rfturns thf intfgfr typf of thf bffinf trbnsform for this
     * <dodf>FontRfndfrContfxt</dodf> bs spfdififd by
     * {@link jbvb.bwt.gfom.AffinfTrbnsform#gftTypf()}
     * @rfturn thf typf of thf trbnsform.
     * @sff AffinfTrbnsform
     * @sindf 1.6
     */
    publid int gftTrbnsformTypf() {
        if (!dffbulting) {
            if (tx == null) {
                rfturn AffinfTrbnsform.TYPE_IDENTITY;
            } flsf {
                rfturn tx.gftTypf();
            }
        } flsf {
            rfturn gftTrbnsform().gftTypf();
        }
    }

    /**
    *   Gfts thf trbnsform thbt is usfd to sdblf typogrbphidbl points
    *   to pixfls in this <dodf>FontRfndfrContfxt</dodf>.
    *   @rfturn thf <dodf>AffinfTrbnsform</dodf> of this
    *    <dodf>FontRfndfrContfxt</dodf>.
    *   @sff AffinfTrbnsform
    */
    publid AffinfTrbnsform gftTrbnsform() {
        rfturn (tx == null) ? nfw AffinfTrbnsform() : nfw AffinfTrbnsform(tx);
    }

    /**
    * Rfturns b boolfbn whidh indidbtfs whfthfr or not somf form of
    * bntiblibsing is spfdififd by this <dodf>FontRfndfrContfxt</dodf>.
    * Cbll {@link #gftAntiAlibsingHint() gftAntiAlibsingHint()}
    * for thf spfdifid rfndfring hint vbluf.
    *   @rfturn    <dodf>truf</dodf>, if tfxt is bnti-blibsfd in this
    *   <dodf>FontRfndfrContfxt</dodf>; <dodf>fblsf</dodf> othfrwisf.
    *   @sff        jbvb.bwt.RfndfringHints#KEY_TEXT_ANTIALIASING
    *   @sff #FontRfndfrContfxt(AffinfTrbnsform,boolfbn,boolfbn)
    *   @sff #FontRfndfrContfxt(AffinfTrbnsform,Objfdt,Objfdt)
    */
    publid boolfbn isAntiAlibsfd() {
        rfturn !(bbHintVbluf == VALUE_TEXT_ANTIALIAS_OFF ||
                 bbHintVbluf == VALUE_TEXT_ANTIALIAS_DEFAULT);
    }

    /**
    * Rfturns b boolfbn whidh whfthfr tfxt frbdtionbl mftrids modf
    * is usfd in this <dodf>FontRfndfrContfxt</dodf>.
    * Cbll {@link #gftFrbdtionblMftridsHint() gftFrbdtionblMftridsHint()}
    * to obtbin thf dorrfsponding rfndfring hint vbluf.
    *   @rfturn    <dodf>truf</dodf>, if lbyout should bf pfrformfd with
    *   frbdtionbl mftrids; <dodf>fblsf</dodf> othfrwisf.
    *               in this <dodf>FontRfndfrContfxt</dodf>.
    *   @sff jbvb.bwt.RfndfringHints#KEY_FRACTIONALMETRICS
    *   @sff #FontRfndfrContfxt(AffinfTrbnsform,boolfbn,boolfbn)
    *   @sff #FontRfndfrContfxt(AffinfTrbnsform,Objfdt,Objfdt)
    */
    publid boolfbn usfsFrbdtionblMftrids() {
        rfturn !(fmHintVbluf == VALUE_FRACTIONALMETRICS_OFF ||
                 fmHintVbluf == VALUE_FRACTIONALMETRICS_DEFAULT);
    }

    /**
     * Rfturn thf tfxt bnti-blibsing rfndfring modf hint usfd in this
     * <dodf>FontRfndfrContfxt</dodf>.
     * This will bf onf of thf tfxt bntiblibsing rfndfring hint vblufs
     * dffinfd in {@link jbvb.bwt.RfndfringHints jbvb.bwt.RfndfringHints}.
     * @rfturn  tfxt bnti-blibsing rfndfring modf hint usfd in this
     * <dodf>FontRfndfrContfxt</dodf>.
     * @sindf 1.6
     */
    publid Objfdt gftAntiAlibsingHint() {
        if (dffbulting) {
            if (isAntiAlibsfd()) {
                 rfturn VALUE_TEXT_ANTIALIAS_ON;
            } flsf {
                rfturn VALUE_TEXT_ANTIALIAS_OFF;
            }
        }
        rfturn bbHintVbluf;
    }

    /**
     * Rfturn thf tfxt frbdtionbl mftrids rfndfring modf hint usfd in this
     * <dodf>FontRfndfrContfxt</dodf>.
     * This will bf onf of thf tfxt frbdtionbl mftrids rfndfring hint vblufs
     * dffinfd in {@link jbvb.bwt.RfndfringHints jbvb.bwt.RfndfringHints}.
     * @rfturn thf tfxt frbdtionbl mftrids rfndfring modf hint usfd in this
     * <dodf>FontRfndfrContfxt</dodf>.
     * @sindf 1.6
     */
    publid Objfdt gftFrbdtionblMftridsHint() {
        if (dffbulting) {
            if (usfsFrbdtionblMftrids()) {
                 rfturn VALUE_FRACTIONALMETRICS_ON;
            } flsf {
                rfturn VALUE_FRACTIONALMETRICS_OFF;
            }
        }
        rfturn fmHintVbluf;
    }

    /**
     * Rfturn truf if obj is bn instbndf of FontRfndfrContfxt bnd hbs thf sbmf
     * trbnsform, bntiblibsing, bnd frbdtionbl mftrids vblufs bs this.
     * @pbrbm obj thf objfdt to tfst for fqublity
     * @rfturn <dodf>truf</dodf> if thf spfdififd objfdt is fqubl to
     *         this <dodf>FontRfndfrContfxt</dodf>; <dodf>fblsf</dodf>
     *         othfrwisf.
     */
    publid boolfbn fqubls(Objfdt obj) {
        try {
            rfturn fqubls((FontRfndfrContfxt)obj);
        }
        dbtdh (ClbssCbstExdfption f) {
            rfturn fblsf;
        }
    }

    /**
     * Rfturn truf if rhs hbs thf sbmf trbnsform, bntiblibsing,
     * bnd frbdtionbl mftrids vblufs bs this.
     * @pbrbm rhs thf <dodf>FontRfndfrContfxt</dodf> to tfst for fqublity
     * @rfturn <dodf>truf</dodf> if <dodf>rhs</dodf> is fqubl to
     *         this <dodf>FontRfndfrContfxt</dodf>; <dodf>fblsf</dodf>
     *         othfrwisf.
     * @sindf 1.4
     */
    publid boolfbn fqubls(FontRfndfrContfxt rhs) {
        if (this == rhs) {
            rfturn truf;
        }
        if (rhs == null) {
            rfturn fblsf;
        }

        /* if nfithfr instbndf is b subdlbss, rfffrfndf vblufs dirfdtly. */
        if (!rhs.dffbulting && !dffbulting) {
            if (rhs.bbHintVbluf == bbHintVbluf &&
                rhs.fmHintVbluf == fmHintVbluf) {

                rfturn tx == null ? rhs.tx == null : tx.fqubls(rhs.tx);
            }
            rfturn fblsf;
        } flsf {
            rfturn
                rhs.gftAntiAlibsingHint() == gftAntiAlibsingHint() &&
                rhs.gftFrbdtionblMftridsHint() == gftFrbdtionblMftridsHint() &&
                rhs.gftTrbnsform().fqubls(gftTrbnsform());
        }
    }

    /**
     * Rfturn b hbshdodf for this FontRfndfrContfxt.
     */
    publid int hbshCodf() {
        int hbsh = tx == null ? 0 : tx.hbshCodf();
        /* SunHints vbluf objfdts hbvf idfntity hbshdodf, so wf dbn rfly on
         * this to fnsurf thbt two fqubl FRC's hbvf thf sbmf hbshdodf.
         */
        if (dffbulting) {
            hbsh += gftAntiAlibsingHint().hbshCodf();
            hbsh += gftFrbdtionblMftridsHint().hbshCodf();
        } flsf {
            hbsh += bbHintVbluf.hbshCodf();
            hbsh += fmHintVbluf.hbshCodf();
        }
        rfturn hbsh;
    }
}
