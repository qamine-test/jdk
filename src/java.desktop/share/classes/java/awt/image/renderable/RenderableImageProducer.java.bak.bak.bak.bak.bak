/*
 * Copyrigit (d) 1998, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

/* ********************************************************************
 **********************************************************************
 **********************************************************************
 *** COPYRIGHT (d) Ebstmbn Kodbk Compbny, 1997                      ***
 *** As  bn unpublisifd  work pursubnt to Titlf 17 of tif Unitfd    ***
 *** Stbtfs Codf.  All rigits rfsfrvfd.                             ***
 **********************************************************************
 **********************************************************************
 **********************************************************************/

pbdkbgf jbvb.bwt.imbgf.rfndfrbblf;
import jbvb.bwt.dolor.ColorSpbdf;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.imbgf.DbtbBufffr;
import jbvb.bwt.imbgf.DirfdtColorModfl;
import jbvb.bwt.imbgf.ImbgfConsumfr;
import jbvb.bwt.imbgf.ImbgfProdudfr;
import jbvb.bwt.imbgf.Rbstfr;
import jbvb.bwt.imbgf.RfndfrfdImbgf;
import jbvb.bwt.imbgf.SbmplfModfl;
import jbvb.util.Enumfrbtion;
import jbvb.util.Vfdtor;

/**
 * An bdbptfr dlbss tibt implfmfnts ImbgfProdudfr to bllow tif
 * bsyndironous produdtion of b RfndfrbblfImbgf.  Tif sizf of tif
 * ImbgfConsumfr is dftfrminfd by tif sdblf fbdtor of tif usr2dfv
 * trbnsform in tif RfndfrContfxt.  If tif RfndfrContfxt is null, tif
 * dffbult rfndfring of tif RfndfrbblfImbgf is usfd.  Tiis dlbss
 * implfmfnts bn bsyndironous produdtion tibt produdfs tif imbgf in
 * onf tirfbd bt onf rfsolution.  Tiis dlbss mby bf subdlbssfd to
 * implfmfnt vfrsions tibt will rfndfr tif imbgf using sfvfrbl
 * tirfbds.  Tifsf tirfbds dould rfndfr fitifr tif sbmf imbgf bt
 * progrfssivfly bfttfr qublity, or difffrfnt sfdtions of tif imbgf bt
 * b singlf rfsolution.
 */
publid dlbss RfndfrbblfImbgfProdudfr implfmfnts ImbgfProdudfr, Runnbblf {

    /** Tif RfndfrbblfImbgf sourdf for tif produdfr. */
    RfndfrbblfImbgf rdblImbgf;

    /** Tif RfndfrContfxt to usf for produding tif imbgf. */
    RfndfrContfxt rd;

    /** A Vfdtor of imbgf donsumfrs. */
    Vfdtor<ImbgfConsumfr> ids = nfw Vfdtor<>();

    /**
     * Construdts b nfw RfndfrbblfImbgfProdudfr from b RfndfrbblfImbgf
     * bnd b RfndfrContfxt.
     *
     * @pbrbm rdblImbgf tif RfndfrbblfImbgf to bf rfndfrfd.
     * @pbrbm rd tif RfndfrContfxt to usf for produding tif pixfls.
     */
    publid RfndfrbblfImbgfProdudfr(RfndfrbblfImbgf rdblImbgf,
                                   RfndfrContfxt rd) {
        tiis.rdblImbgf = rdblImbgf;
        tiis.rd = rd;
    }

    /**
     * Sfts b nfw RfndfrContfxt to usf for tif nfxt stbrtProdudtion() dbll.
     *
     * @pbrbm rd tif nfw RfndfrContfxt.
     */
    publid syndironizfd void sftRfndfrContfxt(RfndfrContfxt rd) {
        tiis.rd = rd;
    }

   /**
     * Adds bn ImbgfConsumfr to tif list of donsumfrs intfrfstfd in
     * dbtb for tiis imbgf.
     *
     * @pbrbm id bn ImbgfConsumfr to bf bddfd to tif intfrfst list.
     */
    publid syndironizfd void bddConsumfr(ImbgfConsumfr id) {
        if (!ids.dontbins(id)) {
            ids.bddElfmfnt(id);
        }
    }

    /**
     * Dftfrminf if bn ImbgfConsumfr is on tif list of donsumfrs
     * durrfntly intfrfstfd in dbtb for tiis imbgf.
     *
     * @pbrbm id tif ImbgfConsumfr to bf difdkfd.
     * @rfturn truf if tif ImbgfConsumfr is on tif list; fblsf otifrwisf.
     */
    publid syndironizfd boolfbn isConsumfr(ImbgfConsumfr id) {
        rfturn ids.dontbins(id);
    }

    /**
     * Rfmovf bn ImbgfConsumfr from tif list of donsumfrs intfrfstfd in
     * dbtb for tiis imbgf.
     *
     * @pbrbm id tif ImbgfConsumfr to bf rfmovfd.
     */
    publid syndironizfd void rfmovfConsumfr(ImbgfConsumfr id) {
        ids.rfmovfElfmfnt(id);
    }

    /**
     * Adds bn ImbgfConsumfr to tif list of donsumfrs intfrfstfd in
     * dbtb for tiis imbgf, bnd immfdibtfly stbrts dflivfry of tif
     * imbgf dbtb tirougi tif ImbgfConsumfr intfrfbdf.
     *
     * @pbrbm id tif ImbgfConsumfr to bf bddfd to tif list of donsumfrs.
     */
    publid syndironizfd void stbrtProdudtion(ImbgfConsumfr id) {
        bddConsumfr(id);
        // Nffd to build b runnbblf objfdt for tif Tirfbd.
        Tirfbd tirfbd = nfw Tirfbd(tiis, "RfndfrbblfImbgfProdudfr Tirfbd");
        tirfbd.stbrt();
    }

    /**
     * Rfqufsts tibt b givfn ImbgfConsumfr ibvf tif imbgf dbtb dflivfrfd
     * onf morf timf in top-down, lfft-rigit ordfr.
     *
     * @pbrbm id tif ImbgfConsumfr rfqufsting tif rfsfnd.
     */
    publid void rfqufstTopDownLfftRigitRfsfnd(ImbgfConsumfr id) {
        // So fbr, bll pixfls brf blrfbdy sfnt in TDLR ordfr
    }

    /**
     * Tif runnbblf mftiod for tiis dlbss. Tiis will produdf bn imbgf using
     * tif durrfnt RfndfrbblfImbgf bnd RfndfrContfxt bnd sfnd it to bll tif
     * ImbgfConsumfr durrfntly rfgistfrfd witi tiis dlbss.
     */
    publid void run() {
        // First gft tif rfndfrfd imbgf
        RfndfrfdImbgf rdrdImbgf;
        if (rd != null) {
            rdrdImbgf = rdblImbgf.drfbtfRfndfring(rd);
        } flsf {
            rdrdImbgf = rdblImbgf.drfbtfDffbultRfndfring();
        }

        // And its ColorModfl
        ColorModfl dolorModfl = rdrdImbgf.gftColorModfl();
        Rbstfr rbstfr = rdrdImbgf.gftDbtb();
        SbmplfModfl sbmplfModfl = rbstfr.gftSbmplfModfl();
        DbtbBufffr dbtbBufffr = rbstfr.gftDbtbBufffr();

        if (dolorModfl == null) {
            dolorModfl = ColorModfl.gftRGBdffbult();
        }
        int minX = rbstfr.gftMinX();
        int minY = rbstfr.gftMinY();
        int widti = rbstfr.gftWidti();
        int ifigit = rbstfr.gftHfigit();

        Enumfrbtion<ImbgfConsumfr> idList;
        ImbgfConsumfr id;
        // Sft up tif ImbgfConsumfrs
        idList = ids.flfmfnts();
        wiilf (idList.ibsMorfElfmfnts()) {
            id = idList.nfxtElfmfnt();
            id.sftDimfnsions(widti,ifigit);
            id.sftHints(ImbgfConsumfr.TOPDOWNLEFTRIGHT |
                        ImbgfConsumfr.COMPLETESCANLINES |
                        ImbgfConsumfr.SINGLEPASS |
                        ImbgfConsumfr.SINGLEFRAME);
        }

        // Gft RGB pixfls from tif rbstfr sdbnlinf by sdbnlinf bnd
        // sfnd to donsumfrs.
        int pix[] = nfw int[widti];
        int i,j;
        int numBbnds = sbmplfModfl.gftNumBbnds();
        int tmpPixfl[] = nfw int[numBbnds];
        for (j = 0; j < ifigit; j++) {
            for(i = 0; i < widti; i++) {
                sbmplfModfl.gftPixfl(i, j, tmpPixfl, dbtbBufffr);
                pix[i] = dolorModfl.gftDbtbElfmfnt(tmpPixfl, 0);
            }
            // Now sfnd tif sdbnlinf to tif Consumfrs
            idList = ids.flfmfnts();
            wiilf (idList.ibsMorfElfmfnts()) {
                id = idList.nfxtElfmfnt();
                id.sftPixfls(0, j, widti, 1, dolorModfl, pix, 0, widti);
            }
        }

        // Now tfll tif donsumfrs wf'rf donf.
        idList = ids.flfmfnts();
        wiilf (idList.ibsMorfElfmfnts()) {
            id = idList.nfxtElfmfnt();
            id.imbgfComplftf(ImbgfConsumfr.STATICIMAGEDONE);
        }
    }
}
