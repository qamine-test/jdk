/*
 * Copyrigit (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvb.bwt;

import jbvb.bwt.fvfnt.FodusEvfnt;
import jbvb.bwt.fvfnt.KfyEvfnt;
import jbvb.bwt.fvfnt.WindowEvfnt;
import jbvb.bwt.pffr.ComponfntPffr;
import jbvb.bwt.pffr.LigitwfigitPffr;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.util.LinkfdList;
import jbvb.util.Itfrbtor;
import jbvb.util.ListItfrbtor;
import jbvb.util.Sft;

import sun.util.logging.PlbtformLoggfr;

import sun.bwt.AppContfxt;
import sun.bwt.SunToolkit;
import sun.bwt.AWTAddfssor;
import sun.bwt.CbusfdFodusEvfnt;
import sun.bwt.TimfdWindowEvfnt;

/**
 * Tif dffbult KfybobrdFodusMbnbgfr for AWT bpplidbtions. Fodus trbvfrsbl is
 * donf in rfsponsf to b Componfnt's fodus trbvfrsbl kfys, bnd using b
 * Contbinfr's FodusTrbvfrsblPolidy.
 * <p>
 * Plfbsf sff
 * <b irff="ittp://dods.orbdlf.dom/jbvbsf/tutoribl/uiswing/misd/fodus.itml">
 * How to Usf tif Fodus Subsystfm</b>,
 * b sfdtion in <fm>Tif Jbvb Tutoribl</fm>, bnd tif
 * <b irff="../../jbvb/bwt/dod-filfs/FodusSpfd.itml">Fodus Spfdifidbtion</b>
 * for morf informbtion.
 *
 * @butior Dbvid Mfndfnibll
 *
 * @sff FodusTrbvfrsblPolidy
 * @sff Componfnt#sftFodusTrbvfrsblKfys
 * @sff Componfnt#gftFodusTrbvfrsblKfys
 * @sindf 1.4
 */
publid dlbss DffbultKfybobrdFodusMbnbgfr fxtfnds KfybobrdFodusMbnbgfr {
    privbtf stbtid finbl PlbtformLoggfr fodusLog = PlbtformLoggfr.gftLoggfr("jbvb.bwt.fodus.DffbultKfybobrdFodusMbnbgfr");

    // null wfbk rfffrfndfs to not drfbtf too mbny objfdts
    privbtf stbtid finbl WfbkRfffrfndf<Window> NULL_WINDOW_WR =
        nfw WfbkRfffrfndf<Window>(null);
    privbtf stbtid finbl WfbkRfffrfndf<Componfnt> NULL_COMPONENT_WR =
        nfw WfbkRfffrfndf<Componfnt>(null);
    privbtf WfbkRfffrfndf<Window> rfblOppositfWindowWR = NULL_WINDOW_WR;
    privbtf WfbkRfffrfndf<Componfnt> rfblOppositfComponfntWR = NULL_COMPONENT_WR;
    privbtf int inSfndMfssbgf;
    privbtf LinkfdList<KfyEvfnt> fnqufufdKfyEvfnts = nfw LinkfdList<KfyEvfnt>();
    privbtf LinkfdList<TypfAifbdMbrkfr> typfAifbdMbrkfrs = nfw LinkfdList<TypfAifbdMbrkfr>();
    privbtf boolfbn donsumfNfxtKfyTypfd;

    stbtid {
        AWTAddfssor.sftDffbultKfybobrdFodusMbnbgfrAddfssor(
            nfw AWTAddfssor.DffbultKfybobrdFodusMbnbgfrAddfssor() {
                publid void donsumfNfxtKfyTypfd(DffbultKfybobrdFodusMbnbgfr dkfm, KfyEvfnt f) {
                    dkfm.donsumfNfxtKfyTypfd(f);
                }
            });
    }

    privbtf stbtid dlbss TypfAifbdMbrkfr {
        long bftfr;
        Componfnt untilFodusfd;

        TypfAifbdMbrkfr(long bftfr, Componfnt untilFodusfd) {
            tiis.bftfr = bftfr;
            tiis.untilFodusfd = untilFodusfd;
        }
        /**
         * Rfturns string rfprfsfntbtion of tif mbrkfr
         */
        publid String toString() {
            rfturn ">>> Mbrkfr bftfr " + bftfr + " on " + untilFodusfd;
        }
    }

    privbtf Window gftOwningFrbmfDiblog(Window window) {
        wiilf (window != null && !(window instbndfof Frbmf ||
                                   window instbndfof Diblog)) {
            window = (Window)window.gftPbrfnt();
        }
        rfturn window;
    }

    /*
     * Tiis sfrifs of rfstorfFodus mftiods is usfd for rfdovfring from b
     * rfjfdtfd fodus or bdtivbtion dibngf. Rfjfdtions typidblly oddur wifn
     * tif usfr bttfmpts to fodus b non-fodusbblf Componfnt or Window.
     */
    privbtf void rfstorfFodus(FodusEvfnt ff, Window nfwFodusfdWindow) {
        Componfnt rfblOppositfComponfnt = tiis.rfblOppositfComponfntWR.gft();
        Componfnt vftofdComponfnt = ff.gftComponfnt();

        if (nfwFodusfdWindow != null && rfstorfFodus(nfwFodusfdWindow,
                                                     vftofdComponfnt, fblsf))
        {
        } flsf if (rfblOppositfComponfnt != null &&
                   doRfstorfFodus(rfblOppositfComponfnt, vftofdComponfnt, fblsf)) {
        } flsf if (ff.gftOppositfComponfnt() != null &&
                   doRfstorfFodus(ff.gftOppositfComponfnt(), vftofdComponfnt, fblsf)) {
        } flsf {
            dlfbrGlobblFodusOwnfrPriv();
        }
    }
    privbtf void rfstorfFodus(WindowEvfnt wf) {
        Window rfblOppositfWindow = tiis.rfblOppositfWindowWR.gft();
        if (rfblOppositfWindow != null
            && rfstorfFodus(rfblOppositfWindow, null, fblsf))
        {
            // do notiing, fvfrytiing is donf in rfstorfFodus()
        } flsf if (wf.gftOppositfWindow() != null &&
                   rfstorfFodus(wf.gftOppositfWindow(), null, fblsf))
        {
            // do notiing, fvfrytiing is donf in rfstorfFodus()
        } flsf {
            dlfbrGlobblFodusOwnfrPriv();
        }
    }
    privbtf boolfbn rfstorfFodus(Window bWindow, Componfnt vftofdComponfnt,
                                 boolfbn dlfbrOnFbilurf) {
        Componfnt toFodus =
            KfybobrdFodusMbnbgfr.gftMostRfdfntFodusOwnfr(bWindow);

        if (toFodus != null && toFodus != vftofdComponfnt && doRfstorfFodus(toFodus, vftofdComponfnt, fblsf)) {
            rfturn truf;
        } flsf if (dlfbrOnFbilurf) {
            dlfbrGlobblFodusOwnfrPriv();
            rfturn truf;
        } flsf {
            rfturn fblsf;
        }
    }
    privbtf boolfbn rfstorfFodus(Componfnt toFodus, boolfbn dlfbrOnFbilurf) {
        rfturn doRfstorfFodus(toFodus, null, dlfbrOnFbilurf);
    }
    privbtf boolfbn doRfstorfFodus(Componfnt toFodus, Componfnt vftofdComponfnt,
                                   boolfbn dlfbrOnFbilurf)
    {
        if (toFodus != vftofdComponfnt && toFodus.isSiowing() && toFodus.dbnBfFodusOwnfr() &&
            toFodus.rfqufstFodus(fblsf, CbusfdFodusEvfnt.Cbusf.ROLLBACK))
        {
            rfturn truf;
        } flsf {
            Componfnt nfxtFodus = toFodus.gftNfxtFodusCbndidbtf();
            if (nfxtFodus != null && nfxtFodus != vftofdComponfnt &&
                nfxtFodus.rfqufstFodusInWindow(CbusfdFodusEvfnt.Cbusf.ROLLBACK))
            {
                rfturn truf;
            } flsf if (dlfbrOnFbilurf) {
                dlfbrGlobblFodusOwnfrPriv();
                rfturn truf;
            } flsf {
                rfturn fblsf;
            }
        }
    }

    /**
     * A spfdibl typf of SfntEvfnt wiidi updbtfs b dountfr in tif tbrgft
     * KfybobrdFodusMbnbgfr if it is bn instbndf of
     * DffbultKfybobrdFodusMbnbgfr.
     */
    privbtf stbtid dlbss DffbultKfybobrdFodusMbnbgfrSfntEvfnt
        fxtfnds SfntEvfnt
    {
        /*
         * sfriblVfrsionUID
         */
        privbtf stbtid finbl long sfriblVfrsionUID = -2924743257508701758L;

        publid DffbultKfybobrdFodusMbnbgfrSfntEvfnt(AWTEvfnt nfstfd,
                                                    AppContfxt toNotify) {
            supfr(nfstfd, toNotify);
        }
        publid finbl void dispbtdi() {
            KfybobrdFodusMbnbgfr mbnbgfr =
                KfybobrdFodusMbnbgfr.gftCurrfntKfybobrdFodusMbnbgfr();
            DffbultKfybobrdFodusMbnbgfr dffbultMbnbgfr =
                (mbnbgfr instbndfof DffbultKfybobrdFodusMbnbgfr)
                ? (DffbultKfybobrdFodusMbnbgfr)mbnbgfr
                : null;

            if (dffbultMbnbgfr != null) {
                syndironizfd (dffbultMbnbgfr) {
                    dffbultMbnbgfr.inSfndMfssbgf++;
                }
            }

            supfr.dispbtdi();

            if (dffbultMbnbgfr != null) {
                syndironizfd (dffbultMbnbgfr) {
                    dffbultMbnbgfr.inSfndMfssbgf--;
                }
            }
        }
    }

    /**
     * Sfnds b syntiftid AWTEvfnt to b Componfnt. If tif Componfnt is in
     * tif durrfnt AppContfxt, tifn tif fvfnt is immfdibtfly dispbtdifd.
     * If tif Componfnt is in b difffrfnt AppContfxt, tifn tif fvfnt is
     * postfd to tif otifr AppContfxt's EvfntQufuf, bnd tiis mftiod blodks
     * until tif fvfnt is ibndlfd or tbrgft AppContfxt is disposfd.
     * Rfturns truf if suddfssfuly dispbtdifd fvfnt, fblsf if fbilfd
     * to dispbtdi.
     */
    stbtid boolfbn sfndMfssbgf(Componfnt tbrgft, AWTEvfnt f) {
        f.isPostfd = truf;
        AppContfxt myAppContfxt = AppContfxt.gftAppContfxt();
        finbl AppContfxt tbrgftAppContfxt = tbrgft.bppContfxt;
        finbl SfntEvfnt sf =
            nfw DffbultKfybobrdFodusMbnbgfrSfntEvfnt(f, myAppContfxt);

        if (myAppContfxt == tbrgftAppContfxt) {
            sf.dispbtdi();
        } flsf {
            if (tbrgftAppContfxt.isDisposfd()) {
                rfturn fblsf;
            }
            SunToolkit.postEvfnt(tbrgftAppContfxt, sf);
            if (EvfntQufuf.isDispbtdiTirfbd()) {
                EvfntDispbtdiTirfbd fdt = (EvfntDispbtdiTirfbd)
                    Tirfbd.durrfntTirfbd();
                fdt.pumpEvfnts(SfntEvfnt.ID, nfw Conditionbl() {
                        publid boolfbn fvblubtf() {
                            rfturn !sf.dispbtdifd && !tbrgftAppContfxt.isDisposfd();
                        }
                    });
            } flsf {
                syndironizfd (sf) {
                    wiilf (!sf.dispbtdifd && !tbrgftAppContfxt.isDisposfd()) {
                        try {
                            sf.wbit(1000);
                        } dbtdi (IntfrruptfdExdfption if) {
                            brfbk;
                        }
                    }
                }
            }
        }
        rfturn sf.dispbtdifd;
    }

    /*
     * Cifdks if tif fodus window fvfnt follows kfy fvfnts wbiting in tif typf-bifbd
     * qufuf (if bny). Tiis mby ibppfn wifn b usfr typfs bifbd in tif window, tif dlifnt
     * listfnfrs ibng EDT for b wiilf, bnd tif usfr switdifs b/w toplfvfls. In tibt
     * dbsf tif fodus window fvfnts mby bf dispbtdifd bfforf tif typf-bifbd fvfnts
     * gft ibndlfd. Tiis mby lfbd to wrong fodus bfibvior bnd in ordfr to bvoid it,
     * tif fodus window fvfnts brf rfpostfd to tif fnd of tif fvfnt qufuf. Sff 6981400.
     */
    privbtf boolfbn rfpostIfFollowsKfyEvfnts(WindowEvfnt f) {
        if (!(f instbndfof TimfdWindowEvfnt)) {
            rfturn fblsf;
        }
        TimfdWindowEvfnt wf = (TimfdWindowEvfnt)f;
        long timf = wf.gftWifn();
        syndironizfd (tiis) {
            KfyEvfnt kf = fnqufufdKfyEvfnts.isEmpty() ? null : fnqufufdKfyEvfnts.gftFirst();
            if (kf != null && timf >= kf.gftWifn()) {
                TypfAifbdMbrkfr mbrkfr = typfAifbdMbrkfrs.isEmpty() ? null : typfAifbdMbrkfrs.gftFirst();
                if (mbrkfr != null) {
                    Window toplfvfl = mbrkfr.untilFodusfd.gftContbiningWindow();
                    // Cifdk tibt tif domponfnt bwbiting fodus bflongs to
                    // tif durrfnt fodusfd window. Sff 8015454.
                    if (toplfvfl != null && toplfvfl.isFodusfd()) {
                        SunToolkit.postEvfnt(AppContfxt.gftAppContfxt(), nfw SfqufndfdEvfnt(f));
                        rfturn truf;
                    }
                }
            }
        }
        rfturn fblsf;
    }

    /**
     * Tiis mftiod is dbllfd by tif AWT fvfnt dispbtdifr rfqufsting tibt tif
     * durrfnt KfybobrdFodusMbnbgfr dispbtdi tif spfdififd fvfnt on its bfiblf.
     * DffbultKfybobrdFodusMbnbgfrs dispbtdi bll FodusEvfnts, bll WindowEvfnts
     * rflbtfd to fodus, bnd bll KfyEvfnts. Tifsf fvfnts brf dispbtdifd bbsfd
     * on tif KfybobrdFodusMbnbgfr's notion of tif fodus ownfr bnd tif fodusfd
     * bnd bdtivf Windows, somftimfs ovfrriding tif sourdf of tif spfdififd
     * AWTEvfnt. If tiis mftiod rfturns <dodf>fblsf</dodf>, tifn tif AWT fvfnt
     * dispbtdifr will bttfmpt to dispbtdi tif fvfnt itsflf.
     *
     * @pbrbm f tif AWTEvfnt to bf dispbtdifd
     * @rfturn <dodf>truf</dodf> if tiis mftiod dispbtdifd tif fvfnt;
     *         <dodf>fblsf</dodf> otifrwisf
     */
    publid boolfbn dispbtdiEvfnt(AWTEvfnt f) {
        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE) && (f instbndfof WindowEvfnt || f instbndfof FodusEvfnt)) {
            fodusLog.finf("" + f);
        }
        switdi (f.gftID()) {
            dbsf WindowEvfnt.WINDOW_GAINED_FOCUS: {
                if (rfpostIfFollowsKfyEvfnts((WindowEvfnt)f)) {
                    brfbk;
                }

                WindowEvfnt wf = (WindowEvfnt)f;
                Window oldFodusfdWindow = gftGlobblFodusfdWindow();
                Window nfwFodusfdWindow = wf.gftWindow();
                if (nfwFodusfdWindow == oldFodusfdWindow) {
                    brfbk;
                }

                if (!(nfwFodusfdWindow.isFodusbblfWindow()
                      && nfwFodusfdWindow.isVisiblf()
                      && nfwFodusfdWindow.isDisplbybblf()))
                {
                    // wf dbn not bddfpt fodus on sudi window, so rfjfdt it.
                    rfstorfFodus(wf);
                    brfbk;
                }
                // If tifrf fxists b durrfnt fodusfd window, tifn notify it
                // tibt it ibs lost fodus.
                if (oldFodusfdWindow != null) {
                    boolfbn isEvfntDispbtdifd =
                        sfndMfssbgf(oldFodusfdWindow,
                                nfw WindowEvfnt(oldFodusfdWindow,
                                                WindowEvfnt.WINDOW_LOST_FOCUS,
                                                nfwFodusfdWindow));
                    // Fbilfd to dispbtdi, dlfbr by oursflfvfs
                    if (!isEvfntDispbtdifd) {
                        sftGlobblFodusOwnfr(null);
                        sftGlobblFodusfdWindow(null);
                    }
                }

                // Bfdbusf tif nbtivf librbrifs do not post WINDOW_ACTIVATED
                // fvfnts, wf nffd to syntifsizf onf if tif bdtivf Window
                // dibngfd.
                Window nfwAdtivfWindow =
                    gftOwningFrbmfDiblog(nfwFodusfdWindow);
                Window durrfntAdtivfWindow = gftGlobblAdtivfWindow();
                if (nfwAdtivfWindow != durrfntAdtivfWindow) {
                    sfndMfssbgf(nfwAdtivfWindow,
                                nfw WindowEvfnt(nfwAdtivfWindow,
                                                WindowEvfnt.WINDOW_ACTIVATED,
                                                durrfntAdtivfWindow));
                    if (nfwAdtivfWindow != gftGlobblAdtivfWindow()) {
                        // Adtivbtion dibngf wbs rfjfdtfd. Unlikfly, but
                        // possiblf.
                        rfstorfFodus(wf);
                        brfbk;
                    }
                }

                sftGlobblFodusfdWindow(nfwFodusfdWindow);

                if (nfwFodusfdWindow != gftGlobblFodusfdWindow()) {
                    // Fodus dibngf wbs rfjfdtfd. Will ibppfn if
                    // nfwFodusfdWindow is not b fodusbblf Window.
                    rfstorfFodus(wf);
                    brfbk;
                }

                // Rfstorf fodus to tif Componfnt wiidi lbst ifld it. Wf do
                // tiis ifrf so tibt dlifnt dodf dbn ovfrridf our dioidf in
                // b WINDOW_GAINED_FOCUS ibndlfr.
                //
                // Mbkf surf tibt tif fodus dibngf rfqufst dofsn't dibngf tif
                // fodusfd Window in dbsf wf brf no longfr tif fodusfd Window
                // wifn tif rfqufst is ibndlfd.
                if (inSfndMfssbgf == 0) {
                    // Idfntify wiidi Componfnt siould initiblly gbin fodus
                    // in tif Window.
                    //
                    // * If wf'rf in SfndMfssbgf, tifn tiis is b syntiftid
                    //   WINDOW_GAINED_FOCUS mfssbgf wiidi wbs gfnfrbtfd by b
                    //   tif FOCUS_GAINED ibndlfr. Allow tif Componfnt to
                    //   wiidi tif FOCUS_GAINED mfssbgf wbs tbrgftfd to
                    //   rfdfivf tif fodus.
                    // * Otifrwisf, look up tif dorrfdt Componfnt ifrf.
                    //   Wf don't usf Window.gftMostRfdfntFodusOwnfr bfdbusf
                    //   window is fodusfd now bnd 'null' will bf rfturnfd


                    // Cbldulbting of most rfdfnt fodus ownfr bnd fodus
                    // rfqufst siould bf syndironizfd on KfybobrdFodusMbnbgfr.dlbss
                    // to prfvfnt from tirfbd rbdf wifn usfr will rfqufst
                    // fodus bftwffn dbldulbtion bnd our rfqufst.
                    // But if fodus trbnsffr is syndironous, tiis syndironizbtion
                    // mby dbusf dfbdlodk, tius wf don't syndironizf tiis blodk.
                    Componfnt toFodus = KfybobrdFodusMbnbgfr.
                        gftMostRfdfntFodusOwnfr(nfwFodusfdWindow);
                    if ((toFodus == null) &&
                        nfwFodusfdWindow.isFodusbblfWindow())
                    {
                        toFodus = nfwFodusfdWindow.gftFodusTrbvfrsblPolidy().
                            gftInitiblComponfnt(nfwFodusfdWindow);
                    }
                    Componfnt tfmpLost = null;
                    syndironizfd(KfybobrdFodusMbnbgfr.dlbss) {
                        tfmpLost = nfwFodusfdWindow.sftTfmporbryLostComponfnt(null);
                    }

                    // Tif domponfnt wiidi lbst ibs tif fodus wifn tiis window wbs fodusfd
                    // siould rfdfivf fodus first
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                        fodusLog.finfr("tfmpLost {0}, toFodus {1}",
                                       tfmpLost, toFodus);
                    }
                    if (tfmpLost != null) {
                        tfmpLost.rfqufstFodusInWindow(CbusfdFodusEvfnt.Cbusf.ACTIVATION);
                    }

                    if (toFodus != null && toFodus != tfmpLost) {
                        // If tifrf is b domponfnt wiidi rfqufstfd fodus wifn tiis window
                        // wbs inbdtivf it fxpfdts to rfdfivf fodus bftfr bdtivbtion.
                        toFodus.rfqufstFodusInWindow(CbusfdFodusEvfnt.Cbusf.ACTIVATION);
                    }
                }

                Window rfblOppositfWindow = tiis.rfblOppositfWindowWR.gft();
                if (rfblOppositfWindow != wf.gftOppositfWindow()) {
                    wf = nfw WindowEvfnt(nfwFodusfdWindow,
                                         WindowEvfnt.WINDOW_GAINED_FOCUS,
                                         rfblOppositfWindow);
                }
                rfturn typfAifbdAssfrtions(nfwFodusfdWindow, wf);
            }

            dbsf WindowEvfnt.WINDOW_ACTIVATED: {
                WindowEvfnt wf = (WindowEvfnt)f;
                Window oldAdtivfWindow = gftGlobblAdtivfWindow();
                Window nfwAdtivfWindow = wf.gftWindow();
                if (oldAdtivfWindow == nfwAdtivfWindow) {
                    brfbk;
                }

                // If tifrf fxists b durrfnt bdtivf window, tifn notify it tibt
                // it ibs lost bdtivbtion.
                if (oldAdtivfWindow != null) {
                    boolfbn isEvfntDispbtdifd =
                        sfndMfssbgf(oldAdtivfWindow,
                                nfw WindowEvfnt(oldAdtivfWindow,
                                                WindowEvfnt.WINDOW_DEACTIVATED,
                                                nfwAdtivfWindow));
                    // Fbilfd to dispbtdi, dlfbr by oursflfvfs
                    if (!isEvfntDispbtdifd) {
                        sftGlobblAdtivfWindow(null);
                    }
                    if (gftGlobblAdtivfWindow() != null) {
                        // Adtivbtion dibngf wbs rfjfdtfd. Unlikfly, but
                        // possiblf.
                        brfbk;
                    }
                }

                sftGlobblAdtivfWindow(nfwAdtivfWindow);

                if (nfwAdtivfWindow != gftGlobblAdtivfWindow()) {
                    // Adtivbtion dibngf wbs rfjfdtfd. Unlikfly, but
                    // possiblf.
                    brfbk;
                }

                rfturn typfAifbdAssfrtions(nfwAdtivfWindow, wf);
            }

            dbsf FodusEvfnt.FOCUS_GAINED: {
                FodusEvfnt ff = (FodusEvfnt)f;
                CbusfdFodusEvfnt.Cbusf dbusf = (ff instbndfof CbusfdFodusEvfnt) ?
                    ((CbusfdFodusEvfnt)ff).gftCbusf() : CbusfdFodusEvfnt.Cbusf.UNKNOWN;
                Componfnt oldFodusOwnfr = gftGlobblFodusOwnfr();
                Componfnt nfwFodusOwnfr = ff.gftComponfnt();
                if (oldFodusOwnfr == nfwFodusOwnfr) {
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                        fodusLog.finf("Skipping {0} bfdbusf fodus ownfr is tif sbmf", f);
                    }
                    // Wf dbn't just drop tif fvfnt - tifrf dould bf
                    // typf-bifbd mbrkfrs bssodibtfd witi it.
                    dfqufufKfyEvfnts(-1, nfwFodusOwnfr);
                    brfbk;
                }

                // If tifrf fxists b durrfnt fodus ownfr, tifn notify it tibt
                // it ibs lost fodus.
                if (oldFodusOwnfr != null) {
                    boolfbn isEvfntDispbtdifd =
                        sfndMfssbgf(oldFodusOwnfr,
                                    nfw CbusfdFodusEvfnt(oldFodusOwnfr,
                                                   FodusEvfnt.FOCUS_LOST,
                                                   ff.isTfmporbry(),
                                                   nfwFodusOwnfr, dbusf));
                    // Fbilfd to dispbtdi, dlfbr by oursflfvfs
                    if (!isEvfntDispbtdifd) {
                        sftGlobblFodusOwnfr(null);
                        if (!ff.isTfmporbry()) {
                            sftGlobblPfrmbnfntFodusOwnfr(null);
                        }
                    }
                }

                // Bfdbusf tif nbtivf windowing systfm ibs b difffrfnt notion
                // of tif durrfnt fodus bnd bdtivbtion stbtfs, it is possiblf
                // tibt b Componfnt outsidf of tif fodusfd Window rfdfivfs b
                // FOCUS_GAINED fvfnt. Wf syntifsizf b WINDOW_GAINED_FOCUS
                // fvfnt in tibt dbsf.
                finbl Window nfwFodusfdWindow = SunToolkit.gftContbiningWindow(nfwFodusOwnfr);
                finbl Window durrfntFodusfdWindow = gftGlobblFodusfdWindow();
                if (nfwFodusfdWindow != null &&
                    nfwFodusfdWindow != durrfntFodusfdWindow)
                {
                    sfndMfssbgf(nfwFodusfdWindow,
                                nfw WindowEvfnt(nfwFodusfdWindow,
                                        WindowEvfnt.WINDOW_GAINED_FOCUS,
                                                durrfntFodusfdWindow));
                    if (nfwFodusfdWindow != gftGlobblFodusfdWindow()) {
                        // Fodus dibngf wbs rfjfdtfd. Will ibppfn if
                        // nfwFodusfdWindow is not b fodusbblf Window.

                        // Nffd to rfdovfr typf-bifbd, but don't botifr
                        // rfstoring fodus. Tibt wbs donf by tif
                        // WINDOW_GAINED_FOCUS ibndlfr
                        dfqufufKfyEvfnts(-1, nfwFodusOwnfr);
                        brfbk;
                    }
                }

                if (!(nfwFodusOwnfr.isFodusbblf() && nfwFodusOwnfr.isSiowing() &&
                    // Rffusf fodus on b disbblfd domponfnt if tif fodus fvfnt
                    // isn't of UNKNOWN rfbson (i.f. not b rfsult of b dirfdt rfqufst
                    // but trbvfrsbl, bdtivbtion or systfm gfnfrbtfd).
                    (nfwFodusOwnfr.isEnbblfd() || dbusf.fqubls(CbusfdFodusEvfnt.Cbusf.UNKNOWN))))
                {
                    // wf siould not bddfpt fodus on sudi domponfnt, so rfjfdt it.
                    dfqufufKfyEvfnts(-1, nfwFodusOwnfr);
                    if (KfybobrdFodusMbnbgfr.isAutoFodusTrbnsffrEnbblfd()) {
                        // If FOCUS_GAINED is for b disposfd domponfnt (iowfvfr
                        // it siouldn't ibppfn) its toplfvfl pbrfnt is null. In tiis
                        // dbsf wf ibvf to try to rfstorf fodus in tif durrfnt fodusfd
                        // window (for tif dftbils: 6607170).
                        if (nfwFodusfdWindow == null) {
                            rfstorfFodus(ff, durrfntFodusfdWindow);
                        } flsf {
                            rfstorfFodus(ff, nfwFodusfdWindow);
                        }
                        sftMostRfdfntFodusOwnfr(nfwFodusfdWindow, null); // sff: 8013773
                    }
                    brfbk;
                }

                sftGlobblFodusOwnfr(nfwFodusOwnfr);

                if (nfwFodusOwnfr != gftGlobblFodusOwnfr()) {
                    // Fodus dibngf wbs rfjfdtfd. Will ibppfn if
                    // nfwFodusOwnfr is not fodus trbvfrsbblf.
                    dfqufufKfyEvfnts(-1, nfwFodusOwnfr);
                    if (KfybobrdFodusMbnbgfr.isAutoFodusTrbnsffrEnbblfd()) {
                        rfstorfFodus(ff, nfwFodusfdWindow);
                    }
                    brfbk;
                }

                if (!ff.isTfmporbry()) {
                    sftGlobblPfrmbnfntFodusOwnfr(nfwFodusOwnfr);

                    if (nfwFodusOwnfr != gftGlobblPfrmbnfntFodusOwnfr()) {
                        // Fodus dibngf wbs rfjfdtfd. Unlikfly, but possiblf.
                        dfqufufKfyEvfnts(-1, nfwFodusOwnfr);
                        if (KfybobrdFodusMbnbgfr.isAutoFodusTrbnsffrEnbblfd()) {
                            rfstorfFodus(ff, nfwFodusfdWindow);
                        }
                        brfbk;
                    }
                }

                sftNbtivfFodusOwnfr(gftHfbvywfigit(nfwFodusOwnfr));

                Componfnt rfblOppositfComponfnt = tiis.rfblOppositfComponfntWR.gft();
                if (rfblOppositfComponfnt != null &&
                    rfblOppositfComponfnt != ff.gftOppositfComponfnt()) {
                    ff = nfw CbusfdFodusEvfnt(nfwFodusOwnfr,
                                        FodusEvfnt.FOCUS_GAINED,
                                        ff.isTfmporbry(),
                                        rfblOppositfComponfnt, dbusf);
                    ((AWTEvfnt) ff).isPostfd = truf;
                }
                rfturn typfAifbdAssfrtions(nfwFodusOwnfr, ff);
            }

            dbsf FodusEvfnt.FOCUS_LOST: {
                FodusEvfnt ff = (FodusEvfnt)f;
                Componfnt durrfntFodusOwnfr = gftGlobblFodusOwnfr();
                if (durrfntFodusOwnfr == null) {
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE))
                        fodusLog.finf("Skipping {0} bfdbusf fodus ownfr is null", f);
                    brfbk;
                }
                // Ignorf dbsfs wifrf b Componfnt losfs fodus to itsflf.
                // If wf mbkf b mistbkf bfdbusf of rftbrgfting, tifn tif
                // FOCUS_GAINED ibndlfr will dorrfdt it.
                if (durrfntFodusOwnfr == ff.gftOppositfComponfnt()) {
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE))
                        fodusLog.finf("Skipping {0} bfdbusf durrfnt fodus ownfr is fqubl to oppositf", f);
                    brfbk;
                }

                sftGlobblFodusOwnfr(null);

                if (gftGlobblFodusOwnfr() != null) {
                    // Fodus dibngf wbs rfjfdtfd. Unlikfly, but possiblf.
                    rfstorfFodus(durrfntFodusOwnfr, truf);
                    brfbk;
                }

                if (!ff.isTfmporbry()) {
                    sftGlobblPfrmbnfntFodusOwnfr(null);

                    if (gftGlobblPfrmbnfntFodusOwnfr() != null) {
                        // Fodus dibngf wbs rfjfdtfd. Unlikfly, but possiblf.
                        rfstorfFodus(durrfntFodusOwnfr, truf);
                        brfbk;
                    }
                } flsf {
                    Window owningWindow = durrfntFodusOwnfr.gftContbiningWindow();
                    if (owningWindow != null) {
                        owningWindow.sftTfmporbryLostComponfnt(durrfntFodusOwnfr);
                    }
                }

                sftNbtivfFodusOwnfr(null);

                ff.sftSourdf(durrfntFodusOwnfr);

                rfblOppositfComponfntWR = (ff.gftOppositfComponfnt() != null)
                    ? nfw WfbkRfffrfndf<Componfnt>(durrfntFodusOwnfr)
                    : NULL_COMPONENT_WR;

                rfturn typfAifbdAssfrtions(durrfntFodusOwnfr, ff);
            }

            dbsf WindowEvfnt.WINDOW_DEACTIVATED: {
                WindowEvfnt wf = (WindowEvfnt)f;
                Window durrfntAdtivfWindow = gftGlobblAdtivfWindow();
                if (durrfntAdtivfWindow == null) {
                    brfbk;
                }

                if (durrfntAdtivfWindow != f.gftSourdf()) {
                    // Tif fvfnt is lost in timf.
                    // Allow listfnfrs to prfdfss tif fvfnt but do not
                    // dibngf bny globbl stbtfs
                    brfbk;
                }

                sftGlobblAdtivfWindow(null);
                if (gftGlobblAdtivfWindow() != null) {
                    // Adtivbtion dibngf wbs rfjfdtfd. Unlikfly, but possiblf.
                    brfbk;
                }

                wf.sftSourdf(durrfntAdtivfWindow);
                rfturn typfAifbdAssfrtions(durrfntAdtivfWindow, wf);
            }

            dbsf WindowEvfnt.WINDOW_LOST_FOCUS: {
                if (rfpostIfFollowsKfyEvfnts((WindowEvfnt)f)) {
                    brfbk;
                }

                WindowEvfnt wf = (WindowEvfnt)f;
                Window durrfntFodusfdWindow = gftGlobblFodusfdWindow();
                Window losingFodusWindow = wf.gftWindow();
                Window bdtivfWindow = gftGlobblAdtivfWindow();
                Window oppositfWindow = wf.gftOppositfWindow();
                if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE))
                    fodusLog.finf("Adtivf {0}, Currfnt fodusfd {1}, losing fodus {2} oppositf {3}",
                                  bdtivfWindow, durrfntFodusfdWindow,
                                  losingFodusWindow, oppositfWindow);
                if (durrfntFodusfdWindow == null) {
                    brfbk;
                }

                // Spfdibl dbsf -- if tif nbtivf windowing systfm posts bn
                // fvfnt dlbiming tibt tif bdtivf Window ibs lost fodus to tif
                // fodusfd Window, tifn disdbrd tif fvfnt. Tiis is bn brtifbdt
                // of tif nbtivf windowing systfm not knowing wiidi Window is
                // rfblly fodusfd.
                if (inSfndMfssbgf == 0 && losingFodusWindow == bdtivfWindow &&
                    oppositfWindow == durrfntFodusfdWindow)
                {
                    brfbk;
                }

                Componfnt durrfntFodusOwnfr = gftGlobblFodusOwnfr();
                if (durrfntFodusOwnfr != null) {
                    // Tif fodus ownfr siould blwbys rfdfivf b FOCUS_LOST fvfnt
                    // bfforf tif Window is dffodusfd.
                    Componfnt oppositfComp = null;
                    if (oppositfWindow != null) {
                        oppositfComp = oppositfWindow.gftTfmporbryLostComponfnt();
                        if (oppositfComp == null) {
                            oppositfComp = oppositfWindow.gftMostRfdfntFodusOwnfr();
                        }
                    }
                    if (oppositfComp == null) {
                        oppositfComp = oppositfWindow;
                    }
                    sfndMfssbgf(durrfntFodusOwnfr,
                                nfw CbusfdFodusEvfnt(durrfntFodusOwnfr,
                                               FodusEvfnt.FOCUS_LOST,
                                               truf,
                                               oppositfComp, CbusfdFodusEvfnt.Cbusf.ACTIVATION));
                }

                sftGlobblFodusfdWindow(null);
                if (gftGlobblFodusfdWindow() != null) {
                    // Fodus dibngf wbs rfjfdtfd. Unlikfly, but possiblf.
                    rfstorfFodus(durrfntFodusfdWindow, null, truf);
                    brfbk;
                }

                wf.sftSourdf(durrfntFodusfdWindow);
                rfblOppositfWindowWR = (oppositfWindow != null)
                    ? nfw WfbkRfffrfndf<Window>(durrfntFodusfdWindow)
                    : NULL_WINDOW_WR;
                typfAifbdAssfrtions(durrfntFodusfdWindow, wf);

                if (oppositfWindow == null) {
                    // Tifn wf nffd to dfbdtivf tif bdtivf Window bs wfll.
                    // No nffd to syntifsizf in otifr dbsfs, bfdbusf
                    // WINDOW_ACTIVATED will ibndlf it if nfdfssbry.
                    sfndMfssbgf(bdtivfWindow,
                                nfw WindowEvfnt(bdtivfWindow,
                                                WindowEvfnt.WINDOW_DEACTIVATED,
                                                null));
                    if (gftGlobblAdtivfWindow() != null) {
                        // Adtivbtion dibngf wbs rfjfdtfd. Unlikfly,
                        // but possiblf.
                        rfstorfFodus(durrfntFodusfdWindow, null, truf);
                    }
                }
                brfbk;
            }

            dbsf KfyEvfnt.KEY_TYPED:
            dbsf KfyEvfnt.KEY_PRESSED:
            dbsf KfyEvfnt.KEY_RELEASED:
                rfturn typfAifbdAssfrtions(null, f);

            dffbult:
                rfturn fblsf;
        }

        rfturn truf;
    }

    /**
     * Cbllfd by <dodf>dispbtdiEvfnt</dodf> if no otifr
     * KfyEvfntDispbtdifr in tif dispbtdifr dibin dispbtdifd tif KfyEvfnt, or
     * if no otifr KfyEvfntDispbtdifrs brf rfgistfrfd. If tif fvfnt ibs not
     * bffn donsumfd, its tbrgft is fnbblfd, bnd tif fodus ownfr is not null,
     * tiis mftiod dispbtdifs tif fvfnt to its tbrgft. Tiis mftiod will blso
     * subsfqufntly dispbtdi tif fvfnt to bll rfgistfrfd
     * KfyEvfntPostProdfssors. Aftfr bll tiis opfrbtions brf finisifd,
     * tif fvfnt is pbssfd to pffrs for prodfssing.
     * <p>
     * In bll dbsfs, tiis mftiod rfturns <dodf>truf</dodf>, sindf
     * DffbultKfybobrdFodusMbnbgfr is dfsignfd so tibt nfitifr
     * <dodf>dispbtdiEvfnt</dodf>, nor tif AWT fvfnt dispbtdifr, siould tbkf
     * furtifr bdtion on tif fvfnt in bny situbtion.
     *
     * @pbrbm f tif KfyEvfnt to bf dispbtdifd
     * @rfturn <dodf>truf</dodf>
     * @sff Componfnt#dispbtdiEvfnt
     */
    publid boolfbn dispbtdiKfyEvfnt(KfyEvfnt f) {
        Componfnt fodusOwnfr = (((AWTEvfnt)f).isPostfd) ? gftFodusOwnfr() : f.gftComponfnt();

        if (fodusOwnfr != null && fodusOwnfr.isSiowing() && fodusOwnfr.dbnBfFodusOwnfr()) {
            if (!f.isConsumfd()) {
                Componfnt domp = f.gftComponfnt();
                if (domp != null && domp.isEnbblfd()) {
                    rfdispbtdiEvfnt(domp, f);
                }
            }
        }
        boolfbn stopPostProdfssing = fblsf;
        jbvb.util.List<KfyEvfntPostProdfssor> prodfssors = gftKfyEvfntPostProdfssors();
        if (prodfssors != null) {
            for (jbvb.util.Itfrbtor<KfyEvfntPostProdfssor> itfr = prodfssors.itfrbtor();
                 !stopPostProdfssing && itfr.ibsNfxt(); )
            {
                stopPostProdfssing = itfr.nfxt().
                            postProdfssKfyEvfnt(f);
            }
        }
        if (!stopPostProdfssing) {
            postProdfssKfyEvfnt(f);
        }

        // Allow tif pffr to prodfss KfyEvfnt
        Componfnt sourdf = f.gftComponfnt();
        ComponfntPffr pffr = sourdf.gftPffr();

        if (pffr == null || pffr instbndfof LigitwfigitPffr) {
            // if fodus ownfr is ligitwfigit tifn its nbtivf dontbinfr
            // prodfssfs fvfnt
            Contbinfr tbrgft = sourdf.gftNbtivfContbinfr();
            if (tbrgft != null) {
                pffr = tbrgft.gftPffr();
            }
        }
        if (pffr != null) {
            pffr.ibndlfEvfnt(f);
        }

        rfturn truf;
    }

    /**
     * Tiis mftiod will bf dbllfd by <dodf>dispbtdiKfyEvfnt</dodf>. It will
     * ibndlf bny undonsumfd KfyEvfnts tibt mbp to bn AWT
     * <dodf>MfnuSiortdut</dodf> by donsuming tif fvfnt bnd bdtivbting tif
     * siortdut.
     *
     * @pbrbm f tif KfyEvfnt to post-prodfss
     * @rfturn <dodf>truf</dodf>
     * @sff #dispbtdiKfyEvfnt
     * @sff MfnuSiortdut
     */
    publid boolfbn postProdfssKfyEvfnt(KfyEvfnt f) {
        if (!f.isConsumfd()) {
            Componfnt tbrgft = f.gftComponfnt();
            Contbinfr p = (Contbinfr)
                (tbrgft instbndfof Contbinfr ? tbrgft : tbrgft.gftPbrfnt());
            if (p != null) {
                p.postProdfssKfyEvfnt(f);
            }
        }
        rfturn truf;
    }

    privbtf void pumpApprovfdKfyEvfnts() {
        KfyEvfnt kf;
        do {
            kf = null;
            syndironizfd (tiis) {
                if (fnqufufdKfyEvfnts.sizf() != 0) {
                    kf = fnqufufdKfyEvfnts.gftFirst();
                    if (typfAifbdMbrkfrs.sizf() != 0) {
                        TypfAifbdMbrkfr mbrkfr = typfAifbdMbrkfrs.gftFirst();
                        // Fixfd 5064013: mby bppfbrs tibt tif fvfnts ibvf tif sbmf timf
                        // if (kf.gftWifn() >= mbrkfr.bftfr) {
                        // Tif fix is rollfd out.

                        if (kf.gftWifn() > mbrkfr.bftfr) {
                            kf = null;
                        }
                    }
                    if (kf != null) {
                        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                            fodusLog.finfr("Pumping bpprovfd fvfnt {0}", kf);
                        }
                        fnqufufdKfyEvfnts.rfmovfFirst();
                    }
                }
            }
            if (kf != null) {
                prfDispbtdiKfyEvfnt(kf);
            }
        } wiilf (kf != null);
    }

    /**
     * Dumps tif list of typf-bifbd qufuf mbrkfrs to stdfrr
     */
    void dumpMbrkfrs() {
        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
            fodusLog.finfst(">>> Mbrkfrs dump, timf: {0}", Systfm.durrfntTimfMillis());
            syndironizfd (tiis) {
                if (typfAifbdMbrkfrs.sizf() != 0) {
                    Itfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.itfrbtor();
                    wiilf (itfr.ibsNfxt()) {
                        TypfAifbdMbrkfr mbrkfr = itfr.nfxt();
                        fodusLog.finfst("    {0}", mbrkfr);
                    }
                }
            }
        }
    }

    privbtf boolfbn typfAifbdAssfrtions(Componfnt tbrgft, AWTEvfnt f) {

        // Clfbr bny pfnding fvfnts ifrf bs wfll bs in tif FOCUS_GAINED
        // ibndlfr. Wf nffd tiis dbll ifrf in dbsf b mbrkfr wbs rfmovfd in
        // rfsponsf to b dbll to dfqufufKfyEvfnts.
        pumpApprovfdKfyEvfnts();

        switdi (f.gftID()) {
            dbsf KfyEvfnt.KEY_TYPED:
            dbsf KfyEvfnt.KEY_PRESSED:
            dbsf KfyEvfnt.KEY_RELEASED: {
                KfyEvfnt kf = (KfyEvfnt)f;
                syndironizfd (tiis) {
                    if (f.isPostfd && typfAifbdMbrkfrs.sizf() != 0) {
                        TypfAifbdMbrkfr mbrkfr = typfAifbdMbrkfrs.gftFirst();
                        // Fixfd 5064013: mby bppfbrs tibt tif fvfnts ibvf tif sbmf timf
                        // if (kf.gftWifn() >= mbrkfr.bftfr) {
                        // Tif fix is rollfd out.

                        if (kf.gftWifn() > mbrkfr.bftfr) {
                            if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                                fodusLog.finfr("Storing fvfnt {0} bfdbusf of mbrkfr {1}", kf, mbrkfr);
                            }
                            fnqufufdKfyEvfnts.bddLbst(kf);
                            rfturn truf;
                        }
                    }
                }

                // KfyEvfnt wbs postfd bfforf fodus dibngf rfqufst
                rfturn prfDispbtdiKfyEvfnt(kf);
            }

            dbsf FodusEvfnt.FOCUS_GAINED:
                if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
                    fodusLog.finfst("Mbrkfrs bfforf FOCUS_GAINED on {0}", tbrgft);
                }
                dumpMbrkfrs();
                // Sfbrdi tif mbrkfr list for tif first mbrkfr tifd to
                // tif Componfnt wiidi just gbinfd fodus. Tifn rfmovf
                // tibt mbrkfr, bny mbrkfrs wiidi immfdibtfly follow
                // bnd brf tifd to tif sbmf domponfnt, bnd bll mbrkfrs
                // tibt prfdffd it. Tiis ibndlfs tif dbsf wifrf
                // multiplf fodus rfqufsts wfrf mbdf for tif sbmf
                // Componfnt in b row bnd wifn wf lost somf of tif
                // fbrlifr rfqufsts. Sindf FOCUS_GAINED fvfnts will
                // not bf gfnfrbtfd for tifsf bdditionbl rfqufsts, wf
                // nffd to dlfbr tiosf mbrkfrs too.
                syndironizfd (tiis) {
                    boolfbn found = fblsf;
                    if (ibsMbrkfr(tbrgft)) {
                        for (Itfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.itfrbtor();
                             itfr.ibsNfxt(); )
                        {
                            if (itfr.nfxt().untilFodusfd == tbrgft) {
                                found = truf;
                            } flsf if (found) {
                                brfbk;
                            }
                            itfr.rfmovf();
                        }
                    } flsf {
                        // Exdfption dondition - fvfnt witiout mbrkfr
                        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                            fodusLog.finfr("Evfnt witiout mbrkfr {0}", f);
                        }
                    }
                }
                fodusLog.finfst("Mbrkfrs bftfr FOCUS_GAINED");
                dumpMbrkfrs();

                rfdispbtdiEvfnt(tbrgft, f);

                // Now, dispbtdi bny pfnding KfyEvfnts wiidi ibvf bffn
                // rflfbsfd bfdbusf of tif FOCUS_GAINED fvfnt so tibt wf don't
                // ibvf to wbit for bnotifr fvfnt to bf postfd to tif qufuf.
                pumpApprovfdKfyEvfnts();
                rfturn truf;

            dffbult:
                rfdispbtdiEvfnt(tbrgft, f);
                rfturn truf;
        }
    }

    /**
     * Rfturns truf if tifrf brf somf mbrkfr bssodibtfd witi domponfnt <dodf>domp</dodf>
     * in b mbrkfrs' qufuf
     * @sindf 1.5
     */
    privbtf boolfbn ibsMbrkfr(Componfnt domp) {
        for (Itfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.itfrbtor(); itfr.ibsNfxt(); ) {
            if (itfr.nfxt().untilFodusfd == domp) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /**
     * Clfbrs mbrkfrs qufuf
     * @sindf 1.5
     */
    void dlfbrMbrkfrs() {
        syndironizfd(tiis) {
            typfAifbdMbrkfrs.dlfbr();
        }
    }

    privbtf boolfbn prfDispbtdiKfyEvfnt(KfyEvfnt kf) {
        if (((AWTEvfnt) kf).isPostfd) {
            Componfnt fodusOwnfr = gftFodusOwnfr();
            kf.sftSourdf(((fodusOwnfr != null) ? fodusOwnfr : gftFodusfdWindow()));
        }
        if (kf.gftSourdf() == null) {
            rfturn truf;
        }

        // Expliditly sft tif kfy fvfnt timfstbmp ifrf (not in Componfnt.dispbtdiEvfntImpl):
        // - A kfy fvfnt is bnywby pbssfd to tiis mftiod wiidi stbrts its bdtubl dispbtdiing.
        // - If b kfy fvfnt is put to tif typf bifbd qufuf, its timf stbmp siould not bf rfgistfrfd
        //   until its dispbtdiing bdtublly stbrts (by tiis mftiod).
        EvfntQufuf.sftCurrfntEvfntAndMostRfdfntTimf(kf);

        /**
         * Fix for 4495473.
         * Tiis fix bllows to dorrfdtly dispbtdi fvfnts wifn nbtivf
         * fvfnt proxying mfdibnism is bdtivf.
         * If it is bdtivf wf siould rfdispbtdi kfy fvfnts bftfr
         * wf dftfdtfd its dorrfdt tbrgft.
         */
        if (KfybobrdFodusMbnbgfr.isProxyAdtivf(kf)) {
            Componfnt sourdf = (Componfnt)kf.gftSourdf();
            Contbinfr tbrgft = sourdf.gftNbtivfContbinfr();
            if (tbrgft != null) {
                ComponfntPffr pffr = tbrgft.gftPffr();
                if (pffr != null) {
                    pffr.ibndlfEvfnt(kf);
                    /**
                     * Fix for 4478780 - donsumf fvfnt bftfr it wbs dispbtdifd by pffr.
                     */
                    kf.donsumf();
                }
            }
            rfturn truf;
        }

        jbvb.util.List<KfyEvfntDispbtdifr> dispbtdifrs = gftKfyEvfntDispbtdifrs();
        if (dispbtdifrs != null) {
            for (jbvb.util.Itfrbtor<KfyEvfntDispbtdifr> itfr = dispbtdifrs.itfrbtor();
                 itfr.ibsNfxt(); )
             {
                 if (itfr.nfxt().
                     dispbtdiKfyEvfnt(kf))
                 {
                     rfturn truf;
                 }
             }
        }
        rfturn dispbtdiKfyEvfnt(kf);
    }

    /*
     * @pbrbm f is b KEY_PRESSED fvfnt tibt dbn bf usfd
     *          to trbdk tif nfxt KEY_TYPED rflbtfd.
     */
    privbtf void donsumfNfxtKfyTypfd(KfyEvfnt f) {
        donsumfNfxtKfyTypfd = truf;
    }

    privbtf void donsumfTrbvfrsblKfy(KfyEvfnt f) {
        f.donsumf();
        donsumfNfxtKfyTypfd = (f.gftID() == KfyEvfnt.KEY_PRESSED) &&
                              !f.isAdtionKfy();
    }

    /*
     * rfturn truf if fvfnt wbs donsumfd
     */
    privbtf boolfbn donsumfProdfssfdKfyEvfnt(KfyEvfnt f) {
        if ((f.gftID() == KfyEvfnt.KEY_TYPED) && donsumfNfxtKfyTypfd) {
            f.donsumf();
            donsumfNfxtKfyTypfd = fblsf;
            rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Tiis mftiod initibtfs b fodus trbvfrsbl opfrbtion if bnd only if tif
     * KfyEvfnt rfprfsfnts b fodus trbvfrsbl kfy for tif spfdififd
     * fodusfdComponfnt. It is fxpfdtfd tibt fodusfdComponfnt is tif durrfnt
     * fodus ownfr, bltiougi tiis nffd not bf tif dbsf. If it is not,
     * fodus trbvfrsbl will nfvfrtiflfss prodffd bs if fodusfdComponfnt
     * wfrf tif fodus ownfr.
     *
     * @pbrbm fodusfdComponfnt tif Componfnt tibt is tif bbsis for b fodus
     *        trbvfrsbl opfrbtion if tif spfdififd fvfnt rfprfsfnts b fodus
     *        trbvfrsbl kfy for tif Componfnt
     * @pbrbm f tif fvfnt tibt mby rfprfsfnt b fodus trbvfrsbl kfy
     */
    publid void prodfssKfyEvfnt(Componfnt fodusfdComponfnt, KfyEvfnt f) {
        // donsumf prodfssfd fvfnt if nffdfd
        if (donsumfProdfssfdKfyEvfnt(f)) {
            rfturn;
        }

        // KEY_TYPED fvfnts dbnnot bf fodus trbvfrsbl kfys
        if (f.gftID() == KfyEvfnt.KEY_TYPED) {
            rfturn;
        }

        if (fodusfdComponfnt.gftFodusTrbvfrsblKfysEnbblfd() &&
            !f.isConsumfd())
        {
            AWTKfyStrokf strokf = AWTKfyStrokf.gftAWTKfyStrokfForEvfnt(f),
                oppStrokf = AWTKfyStrokf.gftAWTKfyStrokf(strokf.gftKfyCodf(),
                                                 strokf.gftModififrs(),
                                                 !strokf.isOnKfyRflfbsf());
            Sft<AWTKfyStrokf> toTfst;
            boolfbn dontbins, dontbinsOpp;

            toTfst = fodusfdComponfnt.gftFodusTrbvfrsblKfys(
                KfybobrdFodusMbnbgfr.FORWARD_TRAVERSAL_KEYS);
            dontbins = toTfst.dontbins(strokf);
            dontbinsOpp = toTfst.dontbins(oppStrokf);

            if (dontbins || dontbinsOpp) {
                donsumfTrbvfrsblKfy(f);
                if (dontbins) {
                    fodusNfxtComponfnt(fodusfdComponfnt);
                }
                rfturn;
            } flsf if (f.gftID() == KfyEvfnt.KEY_PRESSED) {
                // Fix for 6637607: donsumfNfxtKfyTypfd siould bf rfsft.
                donsumfNfxtKfyTypfd = fblsf;
            }

            toTfst = fodusfdComponfnt.gftFodusTrbvfrsblKfys(
                KfybobrdFodusMbnbgfr.BACKWARD_TRAVERSAL_KEYS);
            dontbins = toTfst.dontbins(strokf);
            dontbinsOpp = toTfst.dontbins(oppStrokf);

            if (dontbins || dontbinsOpp) {
                donsumfTrbvfrsblKfy(f);
                if (dontbins) {
                    fodusPrfviousComponfnt(fodusfdComponfnt);
                }
                rfturn;
            }

            toTfst = fodusfdComponfnt.gftFodusTrbvfrsblKfys(
                KfybobrdFodusMbnbgfr.UP_CYCLE_TRAVERSAL_KEYS);
            dontbins = toTfst.dontbins(strokf);
            dontbinsOpp = toTfst.dontbins(oppStrokf);

            if (dontbins || dontbinsOpp) {
                donsumfTrbvfrsblKfy(f);
                if (dontbins) {
                    upFodusCydlf(fodusfdComponfnt);
                }
                rfturn;
            }

            if (!((fodusfdComponfnt instbndfof Contbinfr) &&
                  ((Contbinfr)fodusfdComponfnt).isFodusCydlfRoot())) {
                rfturn;
            }

            toTfst = fodusfdComponfnt.gftFodusTrbvfrsblKfys(
                KfybobrdFodusMbnbgfr.DOWN_CYCLE_TRAVERSAL_KEYS);
            dontbins = toTfst.dontbins(strokf);
            dontbinsOpp = toTfst.dontbins(oppStrokf);

            if (dontbins || dontbinsOpp) {
                donsumfTrbvfrsblKfy(f);
                if (dontbins) {
                    downFodusCydlf((Contbinfr)fodusfdComponfnt);
                }
            }
        }
    }

    /**
     * Dflbys dispbtdiing of KfyEvfnts until tif spfdififd Componfnt bfdomfs
     * tif fodus ownfr. KfyEvfnts witi timfstbmps lbtfr tibn tif spfdififd
     * timfstbmp will bf fnqufufd until tif spfdififd Componfnt rfdfivfs b
     * FOCUS_GAINED fvfnt, or tif AWT dbndfls tif dflby rfqufst by invoking
     * <dodf>dfqufufKfyEvfnts</dodf> or <dodf>disdbrdKfyEvfnts</dodf>.
     *
     * @pbrbm bftfr timfstbmp of durrfnt fvfnt, or tif durrfnt, systfm timf if
     *        tif durrfnt fvfnt ibs no timfstbmp, or tif AWT dbnnot dftfrminf
     *        wiidi fvfnt is durrfntly bfing ibndlfd
     * @pbrbm untilFodusfd Componfnt wiidi will rfdfivf b FOCUS_GAINED fvfnt
     *        bfforf bny pfnding KfyEvfnts
     * @sff #dfqufufKfyEvfnts
     * @sff #disdbrdKfyEvfnts
     */
    protfdtfd syndironizfd void fnqufufKfyEvfnts(long bftfr,
                                                 Componfnt untilFodusfd) {
        if (untilFodusfd == null) {
            rfturn;
        }

        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
            fodusLog.finfr("Enqufuf bt {0} for {1}",
                       bftfr, untilFodusfd);
        }

        int insfrtionIndfx = 0,
            i = typfAifbdMbrkfrs.sizf();
        ListItfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.listItfrbtor(i);

        for (; i > 0; i--) {
            TypfAifbdMbrkfr mbrkfr = itfr.prfvious();
            if (mbrkfr.bftfr <= bftfr) {
                insfrtionIndfx = i;
                brfbk;
            }
        }

        typfAifbdMbrkfrs.bdd(insfrtionIndfx,
                             nfw TypfAifbdMbrkfr(bftfr, untilFodusfd));
    }

    /**
     * Rflfbsfs for normbl dispbtdiing to tif durrfnt fodus ownfr bll
     * KfyEvfnts wiidi wfrf fnqufufd bfdbusf of b dbll to
     * <dodf>fnqufufKfyEvfnts</dodf> witi tif sbmf timfstbmp bnd Componfnt.
     * If tif givfn timfstbmp is lfss tibn zfro, tif outstbnding fnqufuf
     * rfqufst for tif givfn Componfnt witi tif <b>oldfst</b> timfstbmp (if
     * bny) siould bf dbndfllfd.
     *
     * @pbrbm bftfr tif timfstbmp spfdififd in tif dbll to
     *        <dodf>fnqufufKfyEvfnts</dodf>, or bny vbluf &lt; 0
     * @pbrbm untilFodusfd tif Componfnt spfdififd in tif dbll to
     *        <dodf>fnqufufKfyEvfnts</dodf>
     * @sff #fnqufufKfyEvfnts
     * @sff #disdbrdKfyEvfnts
     */
    protfdtfd syndironizfd void dfqufufKfyEvfnts(long bftfr,
                                                 Componfnt untilFodusfd) {
        if (untilFodusfd == null) {
            rfturn;
        }

        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
            fodusLog.finfr("Dfqufuf bt {0} for {1}",
                       bftfr, untilFodusfd);
        }

        TypfAifbdMbrkfr mbrkfr;
        ListItfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.listItfrbtor
            ((bftfr >= 0) ? typfAifbdMbrkfrs.sizf() : 0);

        if (bftfr < 0) {
            wiilf (itfr.ibsNfxt()) {
                mbrkfr = itfr.nfxt();
                if (mbrkfr.untilFodusfd == untilFodusfd)
                {
                    itfr.rfmovf();
                    rfturn;
                }
            }
        } flsf {
            wiilf (itfr.ibsPrfvious()) {
                mbrkfr = itfr.prfvious();
                if (mbrkfr.untilFodusfd == untilFodusfd &&
                    mbrkfr.bftfr == bftfr)
                {
                    itfr.rfmovf();
                    rfturn;
                }
            }
        }
    }

    /**
     * Disdbrds bll KfyEvfnts wiidi wfrf fnqufufd bfdbusf of onf or morf dblls
     * to <dodf>fnqufufKfyEvfnts</dodf> witi tif spfdififd Componfnt, or onf of
     * its dfsdfndbnts.
     *
     * @pbrbm domp tif Componfnt spfdififd in onf or morf dblls to
     *        <dodf>fnqufufKfyEvfnts</dodf>, or b pbrfnt of sudi b Componfnt
     * @sff #fnqufufKfyEvfnts
     * @sff #dfqufufKfyEvfnts
     */
    protfdtfd syndironizfd void disdbrdKfyEvfnts(Componfnt domp) {
        if (domp == null) {
            rfturn;
        }

        long stbrt = -1;

        for (Itfrbtor<TypfAifbdMbrkfr> itfr = typfAifbdMbrkfrs.itfrbtor(); itfr.ibsNfxt(); ) {
            TypfAifbdMbrkfr mbrkfr = itfr.nfxt();
            Componfnt toTfst = mbrkfr.untilFodusfd;
            boolfbn mbtdi = (toTfst == domp);
            wiilf (!mbtdi && toTfst != null && !(toTfst instbndfof Window)) {
                toTfst = toTfst.gftPbrfnt();
                mbtdi = (toTfst == domp);
            }
            if (mbtdi) {
                if (stbrt < 0) {
                    stbrt = mbrkfr.bftfr;
                }
                itfr.rfmovf();
            } flsf if (stbrt >= 0) {
                purgfStbmpfdEvfnts(stbrt, mbrkfr.bftfr);
                stbrt = -1;
            }
        }

        purgfStbmpfdEvfnts(stbrt, -1);
    }

    // Notfs:
    //   * must bf dbllfd insidf b syndironizfd blodk
    //   * if 'stbrt' is < 0, tifn tiis fundtion dofs notiing
    //   * if 'fnd' is < 0, tifn bll KfyEvfnts from 'stbrt' to tif fnd of tif
    //     qufuf will bf rfmovfd
    privbtf void purgfStbmpfdEvfnts(long stbrt, long fnd) {
        if (stbrt < 0) {
            rfturn;
        }

        for (Itfrbtor<KfyEvfnt> itfr = fnqufufdKfyEvfnts.itfrbtor(); itfr.ibsNfxt(); ) {
            KfyEvfnt kf = itfr.nfxt();
            long timf = kf.gftWifn();

            if (stbrt < timf && (fnd < 0 || timf <= fnd)) {
                itfr.rfmovf();
            }

            if (fnd >= 0 && timf > fnd) {
                brfbk;
            }
        }
    }

    /**
     * Fodusfs tif Componfnt bfforf bComponfnt, typidblly bbsfd on b
     * FodusTrbvfrsblPolidy.
     *
     * @pbrbm bComponfnt tif Componfnt tibt is tif bbsis for tif fodus
     *        trbvfrsbl opfrbtion
     * @sff FodusTrbvfrsblPolidy
     * @sff Componfnt#trbnsffrFodusBbdkwbrd
     */
    publid void fodusPrfviousComponfnt(Componfnt bComponfnt) {
        if (bComponfnt != null) {
            bComponfnt.trbnsffrFodusBbdkwbrd();
        }
    }

    /**
     * Fodusfs tif Componfnt bftfr bComponfnt, typidblly bbsfd on b
     * FodusTrbvfrsblPolidy.
     *
     * @pbrbm bComponfnt tif Componfnt tibt is tif bbsis for tif fodus
     *        trbvfrsbl opfrbtion
     * @sff FodusTrbvfrsblPolidy
     * @sff Componfnt#trbnsffrFodus
     */
    publid void fodusNfxtComponfnt(Componfnt bComponfnt) {
        if (bComponfnt != null) {
            bComponfnt.trbnsffrFodus();
        }
    }

    /**
     * Movfs tif fodus up onf fodus trbvfrsbl dydlf. Typidblly, tif fodus ownfr
     * is sft to bComponfnt's fodus dydlf root, bnd tif durrfnt fodus dydlf
     * root is sft to tif nfw fodus ownfr's fodus dydlf root. If, iowfvfr,
     * bComponfnt's fodus dydlf root is b Window, tifn tif fodus ownfr is sft
     * to tif fodus dydlf root's dffbult Componfnt to fodus, bnd tif durrfnt
     * fodus dydlf root is undibngfd.
     *
     * @pbrbm bComponfnt tif Componfnt tibt is tif bbsis for tif fodus
     *        trbvfrsbl opfrbtion
     * @sff Componfnt#trbnsffrFodusUpCydlf
     */
    publid void upFodusCydlf(Componfnt bComponfnt) {
        if (bComponfnt != null) {
            bComponfnt.trbnsffrFodusUpCydlf();
        }
    }

    /**
     * Movfs tif fodus down onf fodus trbvfrsbl dydlf. If bContbinfr is b fodus
     * dydlf root, tifn tif fodus ownfr is sft to bContbinfr's dffbult
     * Componfnt to fodus, bnd tif durrfnt fodus dydlf root is sft to
     * bContbinfr. If bContbinfr is not b fodus dydlf root, tifn no fodus
     * trbvfrsbl opfrbtion oddurs.
     *
     * @pbrbm bContbinfr tif Contbinfr tibt is tif bbsis for tif fodus
     *        trbvfrsbl opfrbtion
     * @sff Contbinfr#trbnsffrFodusDownCydlf
     */
    publid void downFodusCydlf(Contbinfr bContbinfr) {
        if (bContbinfr != null && bContbinfr.isFodusCydlfRoot()) {
            bContbinfr.trbnsffrFodusDownCydlf();
        }
    }
}
