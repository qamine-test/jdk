/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvb.bfbns;

/**
 * Tif PfrsistfndfDflfgbtf dlbss tbkfs tif rfsponsibility
 * for fxprfssing tif stbtf of bn instbndf of b givfn dlbss
 * in tfrms of tif mftiods in tif dlbss's publid API. Instfbd
 * of bssodibting tif rfsponsibility of pfrsistfndf witi
 * tif dlbss itsflf bs is donf, for fxbmplf, by tif
 * <dodf>rfbdObjfdt</dodf> bnd <dodf>writfObjfdt</dodf>
 * mftiods usfd by tif <dodf>ObjfdtOutputStrfbm</dodf>, strfbms likf
 * tif <dodf>XMLEndodfr</dodf> wiidi
 * usf tiis dflfgbtion modfl dbn ibvf tifir bfibvior dontrollfd
 * indfpfndfntly of tif dlbssfs tifmsflvfs. Normblly, tif dlbss
 * is tif bfst plbdf to put sudi informbtion bnd donvfntions
 * dbn fbsily bf fxprfssfd in tiis dflfgbtion sdifmf to do just tibt.
 * Somftimfs iowfvfr, it is tif dbsf tibt b minor problfm
 * in b singlf dlbss prfvfnts bn fntirf objfdt grbpi from
 * bfing writtfn bnd tiis dbn lfbvf tif bpplidbtion
 * dfvflopfr witi no rfdoursf but to bttfmpt to sibdow
 * tif problfmbtid dlbssfs lodblly or usf bltfrnbtivf
 * pfrsistfndf tfdiniqufs. In situbtions likf tifsf, tif
 * dflfgbtion modfl givfs b rflbtivfly dlfbn mfdibnism for
 * tif bpplidbtion dfvflopfr to intfrvfnf in bll pbrts of tif
 * sfriblizbtion prodfss witiout rfquiring tibt modifidbtions
 * bf mbdf to tif implfmfntbtion of dlbssfs wiidi brf not pbrt
 * of tif bpplidbtion itsflf.
 * <p>
 * In bddition to using b dflfgbtion modfl, tiis pfrsistfndf
 * sdifmf difffrs from trbditionbl sfriblizbtion sdifmfs
 * in rfquiring bn bnblog of tif <dodf>writfObjfdt</dodf>
 * mftiod witiout b dorrfsponding <dodf>rfbdObjfdt</dodf>
 * mftiod. Tif <dodf>writfObjfdt</dodf> bnblog fndodfs fbdi
 * instbndf in tfrms of its publid API bnd tifrf is no nffd to
 * dffinf b <dodf>rfbdObjfdt</dodf> bnblog
 * sindf tif prodfdurf for rfbding tif sfriblizfd form
 * is dffinfd by tif sfmbntids of mftiod invodbtion bs lbid
 * out in tif Jbvb Lbngubgf Spfdifidbtion.
 * Brfbking tif dfpfndfndy bftwffn <dodf>writfObjfdt</dodf>
 * bnd <dodf>rfbdObjfdt</dodf> implfmfntbtions, wiidi mby
 * dibngf from vfrsion to vfrsion, is tif kfy fbdtor
 * in mbking tif brdiivfs produdfd by tiis tfdiniquf immunf
 * to dibngfs in tif privbtf implfmfntbtions of tif dlbssfs
 * to wiidi tify rfffr.
 * <p>
 * A pfrsistfndf dflfgbtf, mby tbkf dontrol of bll
 * bspfdts of tif pfrsistfndf of bn objfdt indluding:
 * <ul>
 * <li>
 * Dfdiding wiftifr or not bn instbndf dbn bf mutbtfd
 * into bnotifr instbndf of tif sbmf dlbss.
 * <li>
 * Instbntibting tif objfdt, fitifr by dblling b
 * publid donstrudtor or b publid fbdtory mftiod.
 * <li>
 * Pfrforming tif initiblizbtion of tif objfdt.
 * </ul>
 * @sff XMLEndodfr
 *
 * @sindf 1.4
 *
 * @butior Piilip Milnf
 */

publid bbstrbdt dlbss PfrsistfndfDflfgbtf {

    /**
     * Tif <dodf>writfObjfdt</dodf> is b singlf fntry point to tif pfrsistfndf
     * bnd is usfd by b <dodf>Endodfr</dodf> in tif trbditionbl
     * modf of dflfgbtion. Altiougi tiis mftiod is not finbl,
     * it siould not nffd to bf subdlbssfd undfr normbl dirdumstbndfs.
     * <p>
     * Tiis implfmfntbtion first difdks to sff if tif strfbm
     * ibs blrfbdy fndountfrfd tiis objfdt. Nfxt tif
     * <dodf>mutbtfsTo</dodf> mftiod is dbllfd to sff if
     * tibt dbndidbtf rfturnfd from tif strfbm dbn
     * bf mutbtfd into bn bddurbtf dopy of <dodf>oldInstbndf</dodf>.
     * If it dbn, tif <dodf>initiblizf</dodf> mftiod is dbllfd to
     * pfrform tif initiblizbtion. If not, tif dbndidbtf is rfmovfd
     * from tif strfbm, bnd tif <dodf>instbntibtf</dodf> mftiod
     * is dbllfd to drfbtf b nfw dbndidbtf for tiis objfdt.
     *
     * @pbrbm oldInstbndf Tif instbndf tibt will bf drfbtfd by tiis fxprfssion.
     * @pbrbm out Tif strfbm to wiidi tiis fxprfssion will bf writtfn.
     *
     * @tirows NullPointfrExdfption if {@dodf out} is {@dodf null}
     */
    publid void writfObjfdt(Objfdt oldInstbndf, Endodfr out) {
        Objfdt nfwInstbndf = out.gft(oldInstbndf);
        if (!mutbtfsTo(oldInstbndf, nfwInstbndf)) {
            out.rfmovf(oldInstbndf);
            out.writfExprfssion(instbntibtf(oldInstbndf, out));
        }
        flsf {
            initiblizf(oldInstbndf.gftClbss(), oldInstbndf, nfwInstbndf, out);
        }
    }

    /**
     * Rfturns truf if bn <fm>fquivblfnt</fm> dopy of <dodf>oldInstbndf</dodf> mby bf
     * drfbtfd by bpplying b sfrifs of stbtfmfnts to <dodf>nfwInstbndf</dodf>.
     * In tif spfdifidbtion of tiis mftiod, wf mfbn by fquivblfnt tibt tif modififd instbndf
     * is indistinguisibblf from <dodf>oldInstbndf</dodf> in tif bfibvior
     * of tif rflfvbnt mftiods in its publid API. [Notf: wf usf tif
     * pirbsf <fm>rflfvbnt</fm> mftiods rbtifr tibn <fm>bll</fm> mftiods
     * ifrf only bfdbusf, to bf stridtly dorrfdt, mftiods likf <dodf>ibsiCodf</dodf>
     * bnd <dodf>toString</dodf> prfvfnt most dlbssfs from produding truly
     * indistinguisibblf dopifs of tifir instbndfs].
     * <p>
     * Tif dffbult bfibvior rfturns <dodf>truf</dodf>
     * if tif dlbssfs of tif two instbndfs brf tif sbmf.
     *
     * @pbrbm oldInstbndf Tif instbndf to bf dopifd.
     * @pbrbm nfwInstbndf Tif instbndf tibt is to bf modififd.
     * @rfturn Truf if bn fquivblfnt dopy of <dodf>nfwInstbndf</dodf> mby bf
     *         drfbtfd by bpplying b sfrifs of mutbtions to <dodf>oldInstbndf</dodf>.
     */
    protfdtfd boolfbn mutbtfsTo(Objfdt oldInstbndf, Objfdt nfwInstbndf) {
        rfturn (nfwInstbndf != null && oldInstbndf != null &&
                oldInstbndf.gftClbss() == nfwInstbndf.gftClbss());
    }

    /**
     * Rfturns bn fxprfssion wiosf vbluf is <dodf>oldInstbndf</dodf>.
     * Tiis mftiod is usfd to dibrbdtfrizf tif donstrudtor
     * or fbdtory mftiod tibt siould bf usfd to drfbtf tif givfn objfdt.
     * For fxbmplf, tif <dodf>instbntibtf</dodf> mftiod of tif pfrsistfndf
     * dflfgbtf for tif <dodf>Fifld</dodf> dlbss dould bf dffinfd bs follows:
     * <prf>
     * Fifld f = (Fifld)oldInstbndf;
     * rfturn nfw Exprfssion(f, f.gftDfdlbringClbss(), "gftFifld", nfw Objfdt[]{f.gftNbmf()});
     * </prf>
     * Notf tibt wf dfdlbrf tif vbluf of tif rfturnfd fxprfssion so tibt
     * tif vbluf of tif fxprfssion (bs rfturnfd by <dodf>gftVbluf</dodf>)
     * will bf idfntidbl to <dodf>oldInstbndf</dodf>.
     *
     * @pbrbm oldInstbndf Tif instbndf tibt will bf drfbtfd by tiis fxprfssion.
     * @pbrbm out Tif strfbm to wiidi tiis fxprfssion will bf writtfn.
     * @rfturn An fxprfssion wiosf vbluf is <dodf>oldInstbndf</dodf>.
     *
     * @tirows NullPointfrExdfption if {@dodf out} is {@dodf null}
     *                              bnd tiis vbluf is usfd in tif mftiod
     */
    protfdtfd bbstrbdt Exprfssion instbntibtf(Objfdt oldInstbndf, Endodfr out);

    /**
     * Produdf b sfrifs of stbtfmfnts witi sidf ffffdts on <dodf>nfwInstbndf</dodf>
     * so tibt tif nfw instbndf bfdomfs <fm>fquivblfnt</fm> to <dodf>oldInstbndf</dodf>.
     * In tif spfdifidbtion of tiis mftiod, wf mfbn by fquivblfnt tibt, bftfr tif mftiod
     * rfturns, tif modififd instbndf is indistinguisibblf from
     * <dodf>nfwInstbndf</dodf> in tif bfibvior of bll mftiods in its
     * publid API.
     * <p>
     * Tif implfmfntbtion typidblly bdiifvfs tiis gobl by produding b sfrifs of
     * "wibt ibppfnfd" stbtfmfnts involving tif <dodf>oldInstbndf</dodf>
     * bnd its publidly bvbilbblf stbtf. Tifsf stbtfmfnts brf sfnt
     * to tif output strfbm using its <dodf>writfExprfssion</dodf>
     * mftiod wiidi rfturns bn fxprfssion involving flfmfnts in
     * b dlonfd fnvironmfnt simulbting tif stbtf of bn input strfbm during
     * rfbding. Ebdi stbtfmfnt rfturnfd will ibvf ibd bll instbndfs
     * tif old fnvironmfnt rfplbdfd witi objfdts wiidi fxist in tif nfw
     * onf. In pbrtidulbr, rfffrfndfs to tif tbrgft of tifsf stbtfmfnts,
     * wiidi stbrt out bs rfffrfndfs to <dodf>oldInstbndf</dodf> brf rfturnfd
     * bs rfffrfndfs to tif <dodf>nfwInstbndf</dodf> instfbd.
     * Exfduting tifsf stbtfmfnts ffffdts bn indrfmfntbl
     * blignmfnt of tif stbtf of tif two objfdts bs b sfrifs of
     * modifidbtions to tif objfdts in tif nfw fnvironmfnt.
     * By tif timf tif initiblizf mftiod rfturns it siould bf impossiblf
     * to tfll tif two instbndfs bpbrt by using tifir publid APIs.
     * Most importbntly, tif sfqufndf of stfps tibt wfrf usfd to mbkf
     * tifsf objfdts bppfbr fquivblfnt will ibvf bffn rfdordfd
     * by tif output strfbm bnd will form tif bdtubl output wifn
     * tif strfbm is flusifd.
     * <p>
     * Tif dffbult implfmfntbtion, dblls tif <dodf>initiblizf</dodf>
     * mftiod of tif typf's supfrdlbss.
     *
     * @pbrbm typf tif typf of tif instbndfs
     * @pbrbm oldInstbndf Tif instbndf to bf dopifd.
     * @pbrbm nfwInstbndf Tif instbndf tibt is to bf modififd.
     * @pbrbm out Tif strfbm to wiidi bny initiblizbtion stbtfmfnts siould bf writtfn.
     *
     * @tirows NullPointfrExdfption if {@dodf out} is {@dodf null}
     */
    protfdtfd void initiblizf(Clbss<?> typf,
                              Objfdt oldInstbndf, Objfdt nfwInstbndf,
                              Endodfr out)
    {
        Clbss<?> supfrTypf = typf.gftSupfrdlbss();
        PfrsistfndfDflfgbtf info = out.gftPfrsistfndfDflfgbtf(supfrTypf);
        info.initiblizf(supfrTypf, oldInstbndf, nfwInstbndf, out);
    }
}
