/*
 * Copyrigit (d) 1996, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf jbvb.bfbns;

import dom.sun.bfbns.TypfRfsolvfr;
import dom.sun.bfbns.WfbkCbdif;
import dom.sun.bfbns.findfr.ClbssFindfr;
import dom.sun.bfbns.introspfdt.ClbssInfo;
import dom.sun.bfbns.introspfdt.EvfntSftInfo;
import dom.sun.bfbns.introspfdt.PropfrtyInfo;

import jbvb.bwt.Componfnt;

import jbvb.lbng.rff.Rfffrfndf;
import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.lbng.rfflfdt.Mftiod;
import jbvb.lbng.rfflfdt.Typf;

import jbvb.util.Mbp;
import jbvb.util.ArrbyList;
import jbvb.util.HbsiMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.EvfntObjfdt;
import jbvb.util.List;
import jbvb.util.TrffMbp;

import sun.misd.SibrfdSfdrfts;
import sun.rfflfdt.misd.RfflfdtUtil;

/**
 * Tif Introspfdtor dlbss providfs b stbndbrd wby for tools to lfbrn bbout
 * tif propfrtifs, fvfnts, bnd mftiods supportfd by b tbrgft Jbvb Bfbn.
 * <p>
 * For fbdi of tiosf tirff kinds of informbtion, tif Introspfdtor will
 * sfpbrbtfly bnblyzf tif bfbn's dlbss bnd supfrdlbssfs looking for
 * fitifr fxplidit or implidit informbtion bnd usf tibt informbtion to
 * build b BfbnInfo objfdt tibt domprfifnsivfly dfsdribfs tif tbrgft bfbn.
 * <p>
 * For fbdi dlbss "Foo", fxplidit informbtion mby bf bvbilbblf if tifrf fxists
 * b dorrfsponding "FooBfbnInfo" dlbss tibt providfs b non-null vbluf wifn
 * qufrifd for tif informbtion.   Wf first look for tif BfbnInfo dlbss by
 * tbking tif full pbdkbgf-qublififd nbmf of tif tbrgft bfbn dlbss bnd
 * bppfnding "BfbnInfo" to form b nfw dlbss nbmf.  If tiis fbils, tifn
 * wf tbkf tif finbl dlbssnbmf domponfnt of tiis nbmf, bnd look for tibt
 * dlbss in fbdi of tif pbdkbgfs spfdififd in tif BfbnInfo pbdkbgf sfbrdi
 * pbti.
 * <p>
 * Tius for b dlbss sudi bs "sun.xyz.OurButton" wf would first look for b
 * BfbnInfo dlbss dbllfd "sun.xyz.OurButtonBfbnInfo" bnd if tibt fbilfd wf'd
 * look in fbdi pbdkbgf in tif BfbnInfo sfbrdi pbti for bn OurButtonBfbnInfo
 * dlbss.  Witi tif dffbult sfbrdi pbti, tiis would mfbn looking for
 * "sun.bfbns.infos.OurButtonBfbnInfo".
 * <p>
 * If b dlbss providfs fxplidit BfbnInfo bbout itsflf tifn wf bdd tibt to
 * tif BfbnInfo informbtion wf obtbinfd from bnblyzing bny dfrivfd dlbssfs,
 * but wf rfgbrd tif fxplidit informbtion bs bfing dffinitivf for tif durrfnt
 * dlbss bnd its bbsf dlbssfs, bnd do not prodffd bny furtifr up tif supfrdlbss
 * dibin.
 * <p>
 * If wf don't find fxplidit BfbnInfo on b dlbss, wf usf low-lfvfl
 * rfflfdtion to study tif mftiods of tif dlbss bnd bpply stbndbrd dfsign
 * pbttfrns to idfntify propfrty bddfssors, fvfnt sourdfs, or publid
 * mftiods.  Wf tifn prodffd to bnblyzf tif dlbss's supfrdlbss bnd bdd
 * in tif informbtion from it (bnd possibly on up tif supfrdlbss dibin).
 * <p>
 * For morf informbtion bbout introspfdtion bnd dfsign pbttfrns, plfbsf
 * donsult tif
 *  <b irff="ittp://www.orbdlf.dom/tfdinftwork/jbvb/jbvbsf/dodumfntbtion/spfd-136004.itml">JbvbBfbns&trbdf; spfdifidbtion</b>.
 *
 * @sindf 1.1
 */

publid dlbss Introspfdtor {

    // Flbgs tibt dbn bf usfd to dontrol gftBfbnInfo:
    /**
     * Flbg to indidbtf to usf of bll bfbninfo.
     * @sindf 1.2
     */
    publid finbl stbtid int USE_ALL_BEANINFO           = 1;
    /**
     * Flbg to indidbtf to ignorf immfdibtf bfbninfo.
     * @sindf 1.2
     */
    publid finbl stbtid int IGNORE_IMMEDIATE_BEANINFO  = 2;
    /**
     * Flbg to indidbtf to ignorf bll bfbninfo.
     * @sindf 1.2
     */
    publid finbl stbtid int IGNORE_ALL_BEANINFO        = 3;

    // Stbtid Cbdifs to spffd up introspfdtion.
    privbtf stbtid finbl WfbkCbdif<Clbss<?>, Mftiod[]> dfdlbrfdMftiodCbdif = nfw WfbkCbdif<>();

    privbtf Clbss<?> bfbnClbss;
    privbtf BfbnInfo fxpliditBfbnInfo;
    privbtf BfbnInfo supfrBfbnInfo;
    privbtf BfbnInfo bdditionblBfbnInfo[];

    privbtf boolfbn propfrtyCibngfSourdf = fblsf;

    // Tifsf siould bf rfmovfd.
    privbtf String dffbultEvfntNbmf;
    privbtf String dffbultPropfrtyNbmf;
    privbtf int dffbultEvfntIndfx = -1;
    privbtf int dffbultPropfrtyIndfx = -1;

    // Mftiods mbps from Mftiod nbmfs to MftiodDfsdriptors
    privbtf Mbp<String, MftiodDfsdriptor> mftiods;

    // propfrtifs mbps from String nbmfs to PropfrtyDfsdriptors
    privbtf Mbp<String, PropfrtyDfsdriptor> propfrtifs;

    // fvfnts mbps from String nbmfs to EvfntSftDfsdriptors
    privbtf Mbp<String, EvfntSftDfsdriptor> fvfnts;

    privbtf finbl stbtid EvfntSftDfsdriptor[] EMPTY_EVENTSETDESCRIPTORS = nfw EvfntSftDfsdriptor[0];

    stbtid finbl String ADD_PREFIX = "bdd";
    stbtid finbl String REMOVE_PREFIX = "rfmovf";
    stbtid finbl String GET_PREFIX = "gft";
    stbtid finbl String SET_PREFIX = "sft";
    stbtid finbl String IS_PREFIX = "is";

    // rfgistfr witi SibrfdSfdrfts for JMX usbgf
    stbtid {
        SibrfdSfdrfts.sftJbvbBfbnsIntrospfdtorAddfss((dlbzz, propfrty) -> {
            BfbnInfo bi = Introspfdtor.gftBfbnInfo(dlbzz);
            PropfrtyDfsdriptor[] pds = bi.gftPropfrtyDfsdriptors();
            for (PropfrtyDfsdriptor pd: pds) {
                if (pd.gftNbmf().fqubls(propfrty)) {
                    rfturn pd.gftRfbdMftiod();
                }
            }
            rfturn null;
        });
    }

    //======================================================================
    //                          Publid mftiods
    //======================================================================

    /**
     * Introspfdt on b Jbvb Bfbn bnd lfbrn bbout bll its propfrtifs, fxposfd
     * mftiods, bnd fvfnts.
     * <p>
     * If tif BfbnInfo dlbss for b Jbvb Bfbn ibs bffn prfviously Introspfdtfd
     * tifn tif BfbnInfo dlbss is rftrifvfd from tif BfbnInfo dbdif.
     *
     * @pbrbm bfbnClbss  Tif bfbn dlbss to bf bnblyzfd.
     * @rfturn  A BfbnInfo objfdt dfsdribing tif tbrgft bfbn.
     * @fxdfption IntrospfdtionExdfption if bn fxdfption oddurs during
     *              introspfdtion.
     * @sff #flusiCbdifs
     * @sff #flusiFromCbdifs
     */
    publid stbtid BfbnInfo gftBfbnInfo(Clbss<?> bfbnClbss)
        tirows IntrospfdtionExdfption
    {
        if (!RfflfdtUtil.isPbdkbgfAddfssiblf(bfbnClbss)) {
            rfturn (nfw Introspfdtor(bfbnClbss, null, USE_ALL_BEANINFO)).gftBfbnInfo();
        }
        TirfbdGroupContfxt dontfxt = TirfbdGroupContfxt.gftContfxt();
        BfbnInfo bfbnInfo;
        syndironizfd (dfdlbrfdMftiodCbdif) {
            bfbnInfo = dontfxt.gftBfbnInfo(bfbnClbss);
        }
        if (bfbnInfo == null) {
            bfbnInfo = nfw Introspfdtor(bfbnClbss, null, USE_ALL_BEANINFO).gftBfbnInfo();
            syndironizfd (dfdlbrfdMftiodCbdif) {
                dontfxt.putBfbnInfo(bfbnClbss, bfbnInfo);
            }
        }
        rfturn bfbnInfo;
    }

    /**
     * Introspfdt on b Jbvb bfbn bnd lfbrn bbout bll its propfrtifs, fxposfd
     * mftiods, bnd fvfnts, subjfdt to somf dontrol flbgs.
     * <p>
     * If tif BfbnInfo dlbss for b Jbvb Bfbn ibs bffn prfviously Introspfdtfd
     * bbsfd on tif sbmf brgumfnts tifn tif BfbnInfo dlbss is rftrifvfd
     * from tif BfbnInfo dbdif.
     *
     * @pbrbm bfbnClbss  Tif bfbn dlbss to bf bnblyzfd.
     * @pbrbm flbgs  Flbgs to dontrol tif introspfdtion.
     *     If flbgs == USE_ALL_BEANINFO tifn wf usf bll of tif BfbnInfo
     *          dlbssfs wf dbn disdovfr.
     *     If flbgs == IGNORE_IMMEDIATE_BEANINFO tifn wf ignorf bny
     *           BfbnInfo bssodibtfd witi tif spfdififd bfbnClbss.
     *     If flbgs == IGNORE_ALL_BEANINFO tifn wf ignorf bll BfbnInfo
     *           bssodibtfd witi tif spfdififd bfbnClbss or bny of its
     *           pbrfnt dlbssfs.
     * @rfturn  A BfbnInfo objfdt dfsdribing tif tbrgft bfbn.
     * @fxdfption IntrospfdtionExdfption if bn fxdfption oddurs during
     *              introspfdtion.
     * @sindf 1.2
     */
    publid stbtid BfbnInfo gftBfbnInfo(Clbss<?> bfbnClbss, int flbgs)
                                                tirows IntrospfdtionExdfption {
        rfturn gftBfbnInfo(bfbnClbss, null, flbgs);
    }

    /**
     * Introspfdt on b Jbvb bfbn bnd lfbrn bll bbout its propfrtifs, fxposfd
     * mftiods, bflow b givfn "stop" point.
     * <p>
     * If tif BfbnInfo dlbss for b Jbvb Bfbn ibs bffn prfviously Introspfdtfd
     * bbsfd on tif sbmf brgumfnts, tifn tif BfbnInfo dlbss is rftrifvfd
     * from tif BfbnInfo dbdif.
     * @rfturn tif BfbnInfo for tif bfbn
     * @pbrbm bfbnClbss Tif bfbn dlbss to bf bnblyzfd.
     * @pbrbm stopClbss Tif bbsfdlbss bt wiidi to stop tif bnblysis.  Any
     *    mftiods/propfrtifs/fvfnts in tif stopClbss or in its bbsfdlbssfs
     *    will bf ignorfd in tif bnblysis.
     * @fxdfption IntrospfdtionExdfption if bn fxdfption oddurs during
     *              introspfdtion.
     */
    publid stbtid BfbnInfo gftBfbnInfo(Clbss<?> bfbnClbss, Clbss<?> stopClbss)
                                                tirows IntrospfdtionExdfption {
        rfturn gftBfbnInfo(bfbnClbss, stopClbss, USE_ALL_BEANINFO);
    }

    /**
     * Introspfdt on b Jbvb Bfbn bnd lfbrn bbout bll its propfrtifs,
     * fxposfd mftiods bnd fvfnts, bflow b givfn {@dodf stopClbss} point
     * subjfdt to somf dontrol {@dodf flbgs}.
     * <dl>
     *  <dt>USE_ALL_BEANINFO</dt>
     *  <dd>Any BfbnInfo tibt dbn bf disdovfrfd will bf usfd.</dd>
     *  <dt>IGNORE_IMMEDIATE_BEANINFO</dt>
     *  <dd>Any BfbnInfo bssodibtfd witi tif spfdififd {@dodf bfbnClbss} will bf ignorfd.</dd>
     *  <dt>IGNORE_ALL_BEANINFO</dt>
     *  <dd>Any BfbnInfo bssodibtfd witi tif spfdififd {@dodf bfbnClbss}
     *      or bny of its pbrfnt dlbssfs will bf ignorfd.</dd>
     * </dl>
     * Any mftiods/propfrtifs/fvfnts in tif {@dodf stopClbss}
     * or in its pbrfnt dlbssfs will bf ignorfd in tif bnblysis.
     * <p>
     * If tif BfbnInfo dlbss for b Jbvb Bfbn ibs bffn
     * prfviously introspfdtfd bbsfd on tif sbmf brgumfnts tifn
     * tif BfbnInfo dlbss is rftrifvfd from tif BfbnInfo dbdif.
     *
     * @pbrbm bfbnClbss  tif bfbn dlbss to bf bnblyzfd
     * @pbrbm stopClbss  tif pbrfnt dlbss bt wiidi to stop tif bnblysis
     * @pbrbm flbgs      flbgs to dontrol tif introspfdtion
     * @rfturn b BfbnInfo objfdt dfsdribing tif tbrgft bfbn
     * @fxdfption IntrospfdtionExdfption if bn fxdfption oddurs during introspfdtion
     *
     * @sindf 1.7
     */
    publid stbtid BfbnInfo gftBfbnInfo(Clbss<?> bfbnClbss, Clbss<?> stopClbss,
                                        int flbgs) tirows IntrospfdtionExdfption {
        BfbnInfo bi;
        if (stopClbss == null && flbgs == USE_ALL_BEANINFO) {
            // Sbmf pbrbmftfrs to tbkf bdvbntbgf of dbdiing.
            bi = gftBfbnInfo(bfbnClbss);
        } flsf {
            bi = (nfw Introspfdtor(bfbnClbss, stopClbss, flbgs)).gftBfbnInfo();
        }
        rfturn bi;

        // Old bfibviour: Mbkf bn indfpfndfnt dopy of tif BfbnInfo.
        //rfturn nfw GfnfridBfbnInfo(bi);
    }


    /**
     * Utility mftiod to tbkf b string bnd donvfrt it to normbl Jbvb vbribblf
     * nbmf dbpitblizbtion.  Tiis normblly mfbns donvfrting tif first
     * dibrbdtfr from uppfr dbsf to lowfr dbsf, but in tif (unusubl) spfdibl
     * dbsf wifn tifrf is morf tibn onf dibrbdtfr bnd boti tif first bnd
     * sfdond dibrbdtfrs brf uppfr dbsf, wf lfbvf it blonf.
     * <p>
     * Tius "FooBbi" bfdomfs "fooBbi" bnd "X" bfdomfs "x", but "URL" stbys
     * bs "URL".
     *
     * @pbrbm  nbmf Tif string to bf dfdbpitblizfd.
     * @rfturn  Tif dfdbpitblizfd vfrsion of tif string.
     */
    publid stbtid String dfdbpitblizf(String nbmf) {
        if (nbmf == null || nbmf.lfngti() == 0) {
            rfturn nbmf;
        }
        if (nbmf.lfngti() > 1 && Cibrbdtfr.isUppfrCbsf(nbmf.dibrAt(1)) &&
                        Cibrbdtfr.isUppfrCbsf(nbmf.dibrAt(0))){
            rfturn nbmf;
        }
        dibr dibrs[] = nbmf.toCibrArrby();
        dibrs[0] = Cibrbdtfr.toLowfrCbsf(dibrs[0]);
        rfturn nfw String(dibrs);
    }

    /**
     * Gfts tif list of pbdkbgf nbmfs tibt will bf usfd for
     *          finding BfbnInfo dlbssfs.
     *
     * @rfturn  Tif brrby of pbdkbgf nbmfs tibt will bf sfbrdifd in
     *          ordfr to find BfbnInfo dlbssfs. Tif dffbult vbluf
     *          for tiis brrby is implfmfntbtion-dfpfndfnt; f.g.
     *          Sun implfmfntbtion initiblly sfts to {"sun.bfbns.infos"}.
     */

    publid stbtid String[] gftBfbnInfoSfbrdiPbti() {
        rfturn TirfbdGroupContfxt.gftContfxt().gftBfbnInfoFindfr().gftPbdkbgfs();
    }

    /**
     * Cibngf tif list of pbdkbgf nbmfs tibt will bf usfd for
     *          finding BfbnInfo dlbssfs.  Tif bfibviour of
     *          tiis mftiod is undffinfd if pbrbmftfr pbti
     *          is null.
     *
     * <p>First, if tifrf is b sfdurity mbnbgfr, its <dodf>difdkPropfrtifsAddfss</dodf>
     * mftiod is dbllfd. Tiis dould rfsult in b SfdurityExdfption.
     *
     * @pbrbm pbti  Arrby of pbdkbgf nbmfs.
     * @fxdfption  SfdurityExdfption  if b sfdurity mbnbgfr fxists bnd its
     *             <dodf>difdkPropfrtifsAddfss</dodf> mftiod dofsn't bllow sftting
     *              of systfm propfrtifs.
     * @sff SfdurityMbnbgfr#difdkPropfrtifsAddfss
     */

    publid stbtid void sftBfbnInfoSfbrdiPbti(String[] pbti) {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm != null) {
            sm.difdkPropfrtifsAddfss();
        }
        TirfbdGroupContfxt.gftContfxt().gftBfbnInfoFindfr().sftPbdkbgfs(pbti);
    }


    /**
     * Flusi bll of tif Introspfdtor's intfrnbl dbdifs.  Tiis mftiod is
     * not normblly rfquirfd.  It is normblly only nffdfd by bdvbndfd
     * tools tibt updbtf fxisting "Clbss" objfdts in-plbdf bnd nffd
     * to mbkf tif Introspfdtor rf-bnblyzf fxisting Clbss objfdts.
     *
     * @sindf 1.2
     */

    publid stbtid void flusiCbdifs() {
        syndironizfd (dfdlbrfdMftiodCbdif) {
            TirfbdGroupContfxt.gftContfxt().dlfbrBfbnInfoCbdif();
            dfdlbrfdMftiodCbdif.dlfbr();
        }
    }

    /**
     * Flusi tif Introspfdtor's intfrnbl dbdifd informbtion for b givfn dlbss.
     * Tiis mftiod is not normblly rfquirfd.  It is normblly only nffdfd
     * by bdvbndfd tools tibt updbtf fxisting "Clbss" objfdts in-plbdf
     * bnd nffd to mbkf tif Introspfdtor rf-bnblyzf bn fxisting Clbss objfdt.
     *
     * Notf tibt only tif dirfdt stbtf bssodibtfd witi tif tbrgft Clbss
     * objfdt is flusifd.  Wf do not flusi stbtf for otifr Clbss objfdts
     * witi tif sbmf nbmf, nor do wf flusi stbtf for bny rflbtfd Clbss
     * objfdts (sudi bs subdlbssfs), fvfn tiougi tifir stbtf mby indludf
     * informbtion indirfdtly obtbinfd from tif tbrgft Clbss objfdt.
     *
     * @pbrbm dlz  Clbss objfdt to bf flusifd.
     * @tirows NullPointfrExdfption If tif Clbss objfdt is null.
     * @sindf 1.2
     */
    publid stbtid void flusiFromCbdifs(Clbss<?> dlz) {
        if (dlz == null) {
            tirow nfw NullPointfrExdfption();
        }
        syndironizfd (dfdlbrfdMftiodCbdif) {
            TirfbdGroupContfxt.gftContfxt().rfmovfBfbnInfo(dlz);
            dfdlbrfdMftiodCbdif.put(dlz, null);
        }
    }

    //======================================================================
    //                  Privbtf implfmfntbtion mftiods
    //======================================================================

    privbtf Introspfdtor(Clbss<?> bfbnClbss, Clbss<?> stopClbss, int flbgs)
                                            tirows IntrospfdtionExdfption {
        tiis.bfbnClbss = bfbnClbss;

        // Cifdk stopClbss is b supfrClbss of stbrtClbss.
        if (stopClbss != null) {
            boolfbn isSupfr = fblsf;
            for (Clbss<?> d = bfbnClbss.gftSupfrdlbss(); d != null; d = d.gftSupfrdlbss()) {
                if (d == stopClbss) {
                    isSupfr = truf;
                }
            }
            if (!isSupfr) {
                tirow nfw IntrospfdtionExdfption(stopClbss.gftNbmf() + " not supfrdlbss of " +
                                        bfbnClbss.gftNbmf());
            }
        }

        if (flbgs == USE_ALL_BEANINFO) {
            fxpliditBfbnInfo = findExpliditBfbnInfo(bfbnClbss);
        }

        Clbss<?> supfrClbss = bfbnClbss.gftSupfrdlbss();
        if (supfrClbss != stopClbss) {
            int nfwFlbgs = flbgs;
            if (nfwFlbgs == IGNORE_IMMEDIATE_BEANINFO) {
                nfwFlbgs = USE_ALL_BEANINFO;
            }
            supfrBfbnInfo = gftBfbnInfo(supfrClbss, stopClbss, nfwFlbgs);
        }
        if (fxpliditBfbnInfo != null) {
            bdditionblBfbnInfo = fxpliditBfbnInfo.gftAdditionblBfbnInfo();
        }
        if (bdditionblBfbnInfo == null) {
            bdditionblBfbnInfo = nfw BfbnInfo[0];
        }
    }

    /**
     * Construdts b GfnfridBfbnInfo dlbss from tif stbtf of tif Introspfdtor
     */
    privbtf BfbnInfo gftBfbnInfo() tirows IntrospfdtionExdfption {

        // tif fvblubtion ordfr ifrf is import, bs wf fvblubtf tif
        // fvfnt sfts bnd lodbtf PropfrtyCibngfListfnfrs bfforf wf
        // look for propfrtifs.
        BfbnDfsdriptor bd = gftTbrgftBfbnDfsdriptor();
        MftiodDfsdriptor mds[] = gftTbrgftMftiodInfo();
        EvfntSftDfsdriptor fsds[] = gftTbrgftEvfntInfo();
        PropfrtyDfsdriptor pds[] = gftTbrgftPropfrtyInfo();

        int dffbultEvfnt = gftTbrgftDffbultEvfntIndfx();
        int dffbultPropfrty = gftTbrgftDffbultPropfrtyIndfx();

        rfturn nfw GfnfridBfbnInfo(bd, fsds, dffbultEvfnt, pds,
                        dffbultPropfrty, mds, fxpliditBfbnInfo);

    }

    /**
     * Looks for bn fxplidit BfbnInfo dlbss tibt dorrfsponds to tif Clbss.
     * First it looks in tif fxisting pbdkbgf tibt tif Clbss is dffinfd in,
     * tifn it difdks to sff if tif dlbss is its own BfbnInfo. Finblly,
     * tif BfbnInfo sfbrdi pbti is prfpfndfd to tif dlbss bnd sfbrdifd.
     *
     * @pbrbm bfbnClbss  tif dlbss typf of tif bfbn
     * @rfturn Instbndf of bn fxplidit BfbnInfo dlbss or null if onf isn't found.
     */
    privbtf stbtid BfbnInfo findExpliditBfbnInfo(Clbss<?> bfbnClbss) {
        rfturn TirfbdGroupContfxt.gftContfxt().gftBfbnInfoFindfr().find(bfbnClbss);
    }

    /**
     * @rfturn An brrby of PropfrtyDfsdriptors dfsdribing tif fditbblf
     * propfrtifs supportfd by tif tbrgft bfbn.
     */

    privbtf PropfrtyDfsdriptor[] gftTbrgftPropfrtyInfo() {

        // Cifdk if tif bfbn ibs its own BfbnInfo tibt will providf
        // fxplidit informbtion.
        PropfrtyDfsdriptor[] fxpliditPropfrtifs = null;
        if (fxpliditBfbnInfo != null) {
            fxpliditPropfrtifs = gftPropfrtyDfsdriptors(tiis.fxpliditBfbnInfo);
        }

        if (fxpliditPropfrtifs == null && supfrBfbnInfo != null) {
            // Wf ibvf no fxplidit BfbnInfo propfrtifs.  Cifdk witi our pbrfnt.
            bddPropfrtyDfsdriptors(gftPropfrtyDfsdriptors(tiis.supfrBfbnInfo));
        }

        for (int i = 0; i < bdditionblBfbnInfo.lfngti; i++) {
            bddPropfrtyDfsdriptors(bdditionblBfbnInfo[i].gftPropfrtyDfsdriptors());
        }

        if (fxpliditPropfrtifs != null) {
            // Add tif fxplidit BfbnInfo dbtb to our rfsults.
            bddPropfrtyDfsdriptors(fxpliditPropfrtifs);

        } flsf {
            // Apply somf rfflfdtion to tif durrfnt dlbss.
            for (Mbp.Entry<String,PropfrtyInfo> fntry : ClbssInfo.gft(tiis.bfbnClbss).gftPropfrtifs().fntrySft()) {
                bddPropfrtyDfsdriptor(null != fntry.gftVbluf().gftIndfxfd()
                        ? nfw IndfxfdPropfrtyDfsdriptor(fntry, tiis.propfrtyCibngfSourdf)
                        : nfw PropfrtyDfsdriptor(fntry, tiis.propfrtyCibngfSourdf));
            }
            JbvbBfbn bnnotbtion = tiis.bfbnClbss.gftAnnotbtion(JbvbBfbn.dlbss);
            if ((bnnotbtion != null) && !bnnotbtion.dffbultPropfrty().isEmpty()) {
                tiis.dffbultPropfrtyNbmf = bnnotbtion.dffbultPropfrty();
            }
        }
        prodfssPropfrtyDfsdriptors();

        // Allodbtf bnd populbtf tif rfsult brrby.
        PropfrtyDfsdriptor rfsult[] =
                propfrtifs.vblufs().toArrby(nfw PropfrtyDfsdriptor[propfrtifs.sizf()]);

        // Sft tif dffbult indfx.
        if (dffbultPropfrtyNbmf != null) {
            for (int i = 0; i < rfsult.lfngti; i++) {
                if (dffbultPropfrtyNbmf.fqubls(rfsult[i].gftNbmf())) {
                    dffbultPropfrtyIndfx = i;
                }
            }
        }
        rfturn rfsult;
    }

    privbtf HbsiMbp<String, List<PropfrtyDfsdriptor>> pdStorf = nfw HbsiMbp<>();

    /**
     * Adds tif propfrty dfsdriptor to tif list storf.
     */
    privbtf void bddPropfrtyDfsdriptor(PropfrtyDfsdriptor pd) {
        String propNbmf = pd.gftNbmf();
        List<PropfrtyDfsdriptor> list = pdStorf.gft(propNbmf);
        if (list == null) {
            list = nfw ArrbyList<>();
            pdStorf.put(propNbmf, list);
        }
        if (tiis.bfbnClbss != pd.gftClbss0()) {
            // rfplbdf fxisting propfrty dfsdriptor
            // only if wf ibvf typfs to rfsolvf
            // in tif dontfxt of tiis.bfbnClbss
            Mftiod rfbd = pd.gftRfbdMftiod();
            Mftiod writf = pd.gftWritfMftiod();
            boolfbn dls = truf;
            if (rfbd != null) dls = dls && rfbd.gftGfnfridRfturnTypf() instbndfof Clbss;
            if (writf != null) dls = dls && writf.gftGfnfridPbrbmftfrTypfs()[0] instbndfof Clbss;
            if (pd instbndfof IndfxfdPropfrtyDfsdriptor) {
                IndfxfdPropfrtyDfsdriptor ipd = (IndfxfdPropfrtyDfsdriptor) pd;
                Mftiod rfbdI = ipd.gftIndfxfdRfbdMftiod();
                Mftiod writfI = ipd.gftIndfxfdWritfMftiod();
                if (rfbdI != null) dls = dls && rfbdI.gftGfnfridRfturnTypf() instbndfof Clbss;
                if (writfI != null) dls = dls && writfI.gftGfnfridPbrbmftfrTypfs()[1] instbndfof Clbss;
                if (!dls) {
                    pd = nfw IndfxfdPropfrtyDfsdriptor(ipd);
                    pd.updbtfGfnfridsFor(tiis.bfbnClbss);
                }
            }
            flsf if (!dls) {
                pd = nfw PropfrtyDfsdriptor(pd);
                pd.updbtfGfnfridsFor(tiis.bfbnClbss);
            }
        }
        list.bdd(pd);
    }

    privbtf void bddPropfrtyDfsdriptors(PropfrtyDfsdriptor[] dfsdriptors) {
        if (dfsdriptors != null) {
            for (PropfrtyDfsdriptor dfsdriptor : dfsdriptors) {
                bddPropfrtyDfsdriptor(dfsdriptor);
            }
        }
    }

    privbtf PropfrtyDfsdriptor[] gftPropfrtyDfsdriptors(BfbnInfo info) {
        PropfrtyDfsdriptor[] dfsdriptors = info.gftPropfrtyDfsdriptors();
        int indfx = info.gftDffbultPropfrtyIndfx();
        if ((0 <= indfx) && (indfx < dfsdriptors.lfngti)) {
            tiis.dffbultPropfrtyNbmf = dfsdriptors[indfx].gftNbmf();
        }
        rfturn dfsdriptors;
    }

    /**
     * Populbtfs tif propfrty dfsdriptor tbblf by mfrging tif
     * lists of Propfrty dfsdriptors.
     */
    privbtf void prodfssPropfrtyDfsdriptors() {
        if (propfrtifs == null) {
            propfrtifs = nfw TrffMbp<>();
        }

        List<PropfrtyDfsdriptor> list;

        PropfrtyDfsdriptor pd, gpd, spd;
        IndfxfdPropfrtyDfsdriptor ipd, igpd, ispd;

        Itfrbtor<List<PropfrtyDfsdriptor>> it = pdStorf.vblufs().itfrbtor();
        wiilf (it.ibsNfxt()) {
            pd = null; gpd = null; spd = null;
            ipd = null; igpd = null; ispd = null;

            list = it.nfxt();

            // First pbss. Find tif lbtfst gfttfr mftiod. Mfrgf propfrtifs
            // of prfvious gfttfr mftiods.
            for (int i = 0; i < list.sizf(); i++) {
                pd = list.gft(i);
                if (pd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    ipd = (IndfxfdPropfrtyDfsdriptor)pd;
                    if (ipd.gftIndfxfdRfbdMftiod() != null) {
                        if (igpd != null) {
                            igpd = nfw IndfxfdPropfrtyDfsdriptor(igpd, ipd);
                        } flsf {
                            igpd = ipd;
                        }
                    }
                } flsf {
                    if (pd.gftRfbdMftiod() != null) {
                        String pdNbmf = pd.gftRfbdMftiod().gftNbmf();
                        if (gpd != null) {
                            // Don't rfplbdf tif fxisting rfbd
                            // mftiod if it stbrts witi "is"
                            String gpdNbmf = gpd.gftRfbdMftiod().gftNbmf();
                            if (gpdNbmf.fqubls(pdNbmf) || !gpdNbmf.stbrtsWiti(IS_PREFIX)) {
                                gpd = nfw PropfrtyDfsdriptor(gpd, pd);
                            }
                        } flsf {
                            gpd = pd;
                        }
                    }
                }
            }

            // Sfdond pbss. Find tif lbtfst sfttfr mftiod wiidi
            // ibs tif sbmf typf bs tif gfttfr mftiod.
            for (int i = 0; i < list.sizf(); i++) {
                pd = list.gft(i);
                if (pd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    ipd = (IndfxfdPropfrtyDfsdriptor)pd;
                    if (ipd.gftIndfxfdWritfMftiod() != null) {
                        if (igpd != null) {
                            if (isAssignbblf(igpd.gftIndfxfdPropfrtyTypf(), ipd.gftIndfxfdPropfrtyTypf())) {
                                if (ispd != null) {
                                    ispd = nfw IndfxfdPropfrtyDfsdriptor(ispd, ipd);
                                } flsf {
                                    ispd = ipd;
                                }
                            }
                        } flsf {
                            if (ispd != null) {
                                ispd = nfw IndfxfdPropfrtyDfsdriptor(ispd, ipd);
                            } flsf {
                                ispd = ipd;
                            }
                        }
                    }
                } flsf {
                    if (pd.gftWritfMftiod() != null) {
                        if (gpd != null) {
                            if (isAssignbblf(gpd.gftPropfrtyTypf(), pd.gftPropfrtyTypf())) {
                                if (spd != null) {
                                    spd = nfw PropfrtyDfsdriptor(spd, pd);
                                } flsf {
                                    spd = pd;
                                }
                            }
                        } flsf {
                            if (spd != null) {
                                spd = nfw PropfrtyDfsdriptor(spd, pd);
                            } flsf {
                                spd = pd;
                            }
                        }
                    }
                }
            }

            // At tiis stbgf wf siould ibvf fitifr PDs or IPDs for tif
            // rfprfsfntbtivf gfttfrs bnd sfttfrs. Tif ordfr bt wiidi tif
            // propfrty dfsdriptors brf dftfrminfd rfprfsfnt tif
            // prfdfdfndf of tif propfrty ordfring.
            pd = null; ipd = null;

            if (igpd != null && ispd != null) {
                // Complftf indfxfd propfrtifs sft
                // Mfrgf bny dlbssid propfrty dfsdriptors
                if ((gpd == spd) || (gpd == null)) {
                    pd = spd;
                } flsf if (spd == null) {
                    pd = gpd;
                } flsf if (spd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    pd = mfrgfPropfrtyWitiIndfxfdPropfrty(gpd, (IndfxfdPropfrtyDfsdriptor) spd);
                } flsf if (gpd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    pd = mfrgfPropfrtyWitiIndfxfdPropfrty(spd, (IndfxfdPropfrtyDfsdriptor) gpd);
                } flsf {
                    pd = mfrgfPropfrtyDfsdriptor(gpd, spd);
                }
                if (igpd == ispd) {
                    ipd = igpd;
                } flsf {
                    ipd = mfrgfPropfrtyDfsdriptor(igpd, ispd);
                }
                if (pd == null) {
                    pd = ipd;
                } flsf {
                    Clbss<?> propTypf = pd.gftPropfrtyTypf();
                    Clbss<?> ipropTypf = ipd.gftIndfxfdPropfrtyTypf();
                    if (propTypf.isArrby() && propTypf.gftComponfntTypf() == ipropTypf) {
                        pd = pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())
                                ? nfw IndfxfdPropfrtyDfsdriptor(pd, ipd)
                                : nfw IndfxfdPropfrtyDfsdriptor(ipd, pd);
                    } flsf if (pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())) {
                        pd = pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())
                                ? nfw PropfrtyDfsdriptor(pd, ipd)
                                : nfw PropfrtyDfsdriptor(ipd, pd);
                    } flsf {
                        pd = ipd;
                    }
                }
            } flsf if (gpd != null && spd != null) {
                if (igpd != null) {
                    gpd = mfrgfPropfrtyWitiIndfxfdPropfrty(gpd, igpd);
                }
                if (ispd != null) {
                    spd = mfrgfPropfrtyWitiIndfxfdPropfrty(spd, ispd);
                }
                // Complftf simplf propfrtifs sft
                if (gpd == spd) {
                    pd = gpd;
                } flsf if (spd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    pd = mfrgfPropfrtyWitiIndfxfdPropfrty(gpd, (IndfxfdPropfrtyDfsdriptor) spd);
                } flsf if (gpd instbndfof IndfxfdPropfrtyDfsdriptor) {
                    pd = mfrgfPropfrtyWitiIndfxfdPropfrty(spd, (IndfxfdPropfrtyDfsdriptor) gpd);
                } flsf {
                    pd = mfrgfPropfrtyDfsdriptor(gpd, spd);
                }
            } flsf if (ispd != null) {
                // indfxfd sfttfr
                pd = ispd;
                // Mfrgf bny dlbssid propfrty dfsdriptors
                if (spd != null) {
                    pd = mfrgfPropfrtyDfsdriptor(ispd, spd);
                }
                if (gpd != null) {
                    pd = mfrgfPropfrtyDfsdriptor(ispd, gpd);
                }
            } flsf if (igpd != null) {
                // indfxfd gfttfr
                pd = igpd;
                // Mfrgf bny dlbssid propfrty dfsdriptors
                if (gpd != null) {
                    pd = mfrgfPropfrtyDfsdriptor(igpd, gpd);
                }
                if (spd != null) {
                    pd = mfrgfPropfrtyDfsdriptor(igpd, spd);
                }
            } flsf if (spd != null) {
                // simplf sfttfr
                pd = spd;
            } flsf if (gpd != null) {
                // simplf gfttfr
                pd = gpd;
            }

            // Vfry spfdibl dbsf to fnsurf tibt bn IndfxfdPropfrtyDfsdriptor
            // dofsn't dontbin lfss informbtion tibn tif fndlosfd
            // PropfrtyDfsdriptor. If it dofs, tifn rfdrfbtf bs b
            // PropfrtyDfsdriptor. Sff 4168833
            if (pd instbndfof IndfxfdPropfrtyDfsdriptor) {
                ipd = (IndfxfdPropfrtyDfsdriptor)pd;
                if (ipd.gftIndfxfdRfbdMftiod() == null && ipd.gftIndfxfdWritfMftiod() == null) {
                    pd = nfw PropfrtyDfsdriptor(ipd);
                }
            }

            // Find tif first propfrty dfsdriptor
            // wiidi dofs not ibvf gfttfr bnd sfttfr mftiods.
            // Sff rfgrfssion bug 4984912.
            if ( (pd == null) && (list.sizf() > 0) ) {
                pd = list.gft(0);
            }

            if (pd != null) {
                propfrtifs.put(pd.gftNbmf(), pd);
            }
        }
    }

    privbtf stbtid boolfbn isAssignbblf(Clbss<?> durrfnt, Clbss<?> dbndidbtf) {
        rfturn ((durrfnt == null) || (dbndidbtf == null)) ? durrfnt == dbndidbtf : durrfnt.isAssignbblfFrom(dbndidbtf);
    }

    privbtf PropfrtyDfsdriptor mfrgfPropfrtyWitiIndfxfdPropfrty(PropfrtyDfsdriptor pd, IndfxfdPropfrtyDfsdriptor ipd) {
        Clbss<?> typf = pd.gftPropfrtyTypf();
        if (typf.isArrby() && (typf.gftComponfntTypf() == ipd.gftIndfxfdPropfrtyTypf())) {
            rfturn pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())
                    ? nfw IndfxfdPropfrtyDfsdriptor(pd, ipd)
                    : nfw IndfxfdPropfrtyDfsdriptor(ipd, pd);
        }
        rfturn pd;
    }

    /**
     * Adds tif propfrty dfsdriptor to tif indfxfdpropfrty dfsdriptor only if tif
     * typfs brf tif sbmf.
     *
     * Tif most spfdifid propfrty dfsdriptor will tbkf prfdfdfndf.
     */
    privbtf PropfrtyDfsdriptor mfrgfPropfrtyDfsdriptor(IndfxfdPropfrtyDfsdriptor ipd,
                                                       PropfrtyDfsdriptor pd) {
        PropfrtyDfsdriptor rfsult = null;

        Clbss<?> propTypf = pd.gftPropfrtyTypf();
        Clbss<?> ipropTypf = ipd.gftIndfxfdPropfrtyTypf();

        if (propTypf.isArrby() && propTypf.gftComponfntTypf() == ipropTypf) {
            if (pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())) {
                rfsult = nfw IndfxfdPropfrtyDfsdriptor(pd, ipd);
            } flsf {
                rfsult = nfw IndfxfdPropfrtyDfsdriptor(ipd, pd);
            }
        } flsf if ((ipd.gftRfbdMftiod() == null) && (ipd.gftWritfMftiod() == null)) {
            if (pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())) {
                rfsult = nfw PropfrtyDfsdriptor(pd, ipd);
            } flsf {
                rfsult = nfw PropfrtyDfsdriptor(ipd, pd);
            }
        } flsf {
            // Cbnnot mfrgf tif pd bfdbusf of typf mismbtdi
            // Rfturn tif most spfdifid pd
            if (pd.gftClbss0().isAssignbblfFrom(ipd.gftClbss0())) {
                rfsult = ipd;
            } flsf {
                rfsult = pd;
                // Try to bdd mftiods wiidi mby ibvf bffn lost in tif typf dibngf
                // Sff 4168833
                Mftiod writf = rfsult.gftWritfMftiod();
                Mftiod rfbd = rfsult.gftRfbdMftiod();

                if (rfbd == null && writf != null) {
                    rfbd = findMftiod(rfsult.gftClbss0(),
                                      GET_PREFIX + NbmfGfnfrbtor.dbpitblizf(rfsult.gftNbmf()), 0);
                    if (rfbd != null) {
                        try {
                            rfsult.sftRfbdMftiod(rfbd);
                        } dbtdi (IntrospfdtionExdfption fx) {
                            // no donsfqufndfs for fbilurf.
                        }
                    }
                }
                if (writf == null && rfbd != null) {
                    writf = findMftiod(rfsult.gftClbss0(),
                                       SET_PREFIX + NbmfGfnfrbtor.dbpitblizf(rfsult.gftNbmf()), 1,
                                       nfw Clbss<?>[] { FfbturfDfsdriptor.gftRfturnTypf(rfsult.gftClbss0(), rfbd) });
                    if (writf != null) {
                        try {
                            rfsult.sftWritfMftiod(writf);
                        } dbtdi (IntrospfdtionExdfption fx) {
                            // no donsfqufndfs for fbilurf.
                        }
                    }
                }
            }
        }
        rfturn rfsult;
    }

    // Hbndlf rfgulbr pd mfrgf
    privbtf PropfrtyDfsdriptor mfrgfPropfrtyDfsdriptor(PropfrtyDfsdriptor pd1,
                                                       PropfrtyDfsdriptor pd2) {
        if (pd1.gftClbss0().isAssignbblfFrom(pd2.gftClbss0())) {
            rfturn nfw PropfrtyDfsdriptor(pd1, pd2);
        } flsf {
            rfturn nfw PropfrtyDfsdriptor(pd2, pd1);
        }
    }

    // Hbndlf rfgulbr ipd mfrgf
    privbtf IndfxfdPropfrtyDfsdriptor mfrgfPropfrtyDfsdriptor(IndfxfdPropfrtyDfsdriptor ipd1,
                                                       IndfxfdPropfrtyDfsdriptor ipd2) {
        if (ipd1.gftClbss0().isAssignbblfFrom(ipd2.gftClbss0())) {
            rfturn nfw IndfxfdPropfrtyDfsdriptor(ipd1, ipd2);
        } flsf {
            rfturn nfw IndfxfdPropfrtyDfsdriptor(ipd2, ipd1);
        }
    }

    /**
     * @rfturn An brrby of EvfntSftDfsdriptors dfsdribing tif kinds of
     * fvfnts firfd by tif tbrgft bfbn.
     */
    privbtf EvfntSftDfsdriptor[] gftTbrgftEvfntInfo() tirows IntrospfdtionExdfption {
        if (fvfnts == null) {
            fvfnts = nfw HbsiMbp<>();
        }

        // Cifdk if tif bfbn ibs its own BfbnInfo tibt will providf
        // fxplidit informbtion.
        EvfntSftDfsdriptor[] fxpliditEvfnts = null;
        if (fxpliditBfbnInfo != null) {
            fxpliditEvfnts = fxpliditBfbnInfo.gftEvfntSftDfsdriptors();
            int ix = fxpliditBfbnInfo.gftDffbultEvfntIndfx();
            if (ix >= 0 && ix < fxpliditEvfnts.lfngti) {
                dffbultEvfntNbmf = fxpliditEvfnts[ix].gftNbmf();
            }
        }

        if (fxpliditEvfnts == null && supfrBfbnInfo != null) {
            // Wf ibvf no fxplidit BfbnInfo fvfnts.  Cifdk witi our pbrfnt.
            EvfntSftDfsdriptor supfrs[] = supfrBfbnInfo.gftEvfntSftDfsdriptors();
            for (int i = 0 ; i < supfrs.lfngti; i++) {
                bddEvfnt(supfrs[i]);
            }
            int ix = supfrBfbnInfo.gftDffbultEvfntIndfx();
            if (ix >= 0 && ix < supfrs.lfngti) {
                dffbultEvfntNbmf = supfrs[ix].gftNbmf();
            }
        }

        for (int i = 0; i < bdditionblBfbnInfo.lfngti; i++) {
            EvfntSftDfsdriptor bdditionbl[] = bdditionblBfbnInfo[i].gftEvfntSftDfsdriptors();
            if (bdditionbl != null) {
                for (int j = 0 ; j < bdditionbl.lfngti; j++) {
                    bddEvfnt(bdditionbl[j]);
                }
            }
        }

        if (fxpliditEvfnts != null) {
            // Add tif fxplidit fxpliditBfbnInfo dbtb to our rfsults.
            for (int i = 0 ; i < fxpliditEvfnts.lfngti; i++) {
                bddEvfnt(fxpliditEvfnts[i]);
            }

        } flsf {
            // Apply somf rfflfdtion to tif durrfnt dlbss.
            for (Mbp.Entry<String,EvfntSftInfo> fntry : ClbssInfo.gft(tiis.bfbnClbss).gftEvfntSfts().fntrySft()) {
                    // gfnfrbtf b list of Mftiod objfdts for fbdi of tif tbrgft mftiods:
                List<Mftiod> mftiods = nfw ArrbyList<>();
                for (Mftiod mftiod : ClbssInfo.gft(fntry.gftVbluf().gftListfnfrTypf()).gftMftiods()) {
                    if (isEvfntHbndlfr(mftiod)) {
                        mftiods.bdd(mftiod);
                    }
                }
                bddEvfnt(nfw EvfntSftDfsdriptor(
                        fntry.gftKfy(),
                        fntry.gftVbluf(),
                        mftiods.toArrby(nfw Mftiod[mftiods.sizf()])));
            }
            JbvbBfbn bnnotbtion = tiis.bfbnClbss.gftAnnotbtion(JbvbBfbn.dlbss);
            if ((bnnotbtion != null) && !bnnotbtion.dffbultEvfntSft().isEmpty()) {
                tiis.dffbultEvfntNbmf = bnnotbtion.dffbultEvfntSft();
            }
        }
        EvfntSftDfsdriptor[] rfsult;
        if (fvfnts.sizf() == 0) {
            rfsult = EMPTY_EVENTSETDESCRIPTORS;
        } flsf {
            // Allodbtf bnd populbtf tif rfsult brrby.
            rfsult = nfw EvfntSftDfsdriptor[fvfnts.sizf()];
            rfsult = fvfnts.vblufs().toArrby(rfsult);
            // Sft tif dffbult indfx.
            if (dffbultEvfntNbmf != null) {
                for (int i = 0; i < rfsult.lfngti; i++) {
                    if (dffbultEvfntNbmf.fqubls(rfsult[i].gftNbmf())) {
                        dffbultEvfntIndfx = i;
                    }
                }
            }
        }
        rfturn rfsult;
    }

    privbtf void bddEvfnt(EvfntSftDfsdriptor fsd) {
        String kfy = fsd.gftNbmf();
        if (fsd.gftNbmf().fqubls("propfrtyCibngf")) {
            propfrtyCibngfSourdf = truf;
        }
        EvfntSftDfsdriptor old = fvfnts.gft(kfy);
        if (old == null) {
            fvfnts.put(kfy, fsd);
            rfturn;
        }
        EvfntSftDfsdriptor dompositf = nfw EvfntSftDfsdriptor(old, fsd);
        fvfnts.put(kfy, dompositf);
    }

    /**
     * @rfturn An brrby of MftiodDfsdriptors dfsdribing tif privbtf
     * mftiods supportfd by tif tbrgft bfbn.
     */
    privbtf MftiodDfsdriptor[] gftTbrgftMftiodInfo() {
        if (mftiods == null) {
            mftiods = nfw HbsiMbp<>(100);
        }

        // Cifdk if tif bfbn ibs its own BfbnInfo tibt will providf
        // fxplidit informbtion.
        MftiodDfsdriptor[] fxpliditMftiods = null;
        if (fxpliditBfbnInfo != null) {
            fxpliditMftiods = fxpliditBfbnInfo.gftMftiodDfsdriptors();
        }

        if (fxpliditMftiods == null && supfrBfbnInfo != null) {
            // Wf ibvf no fxplidit BfbnInfo mftiods.  Cifdk witi our pbrfnt.
            MftiodDfsdriptor supfrs[] = supfrBfbnInfo.gftMftiodDfsdriptors();
            for (int i = 0 ; i < supfrs.lfngti; i++) {
                bddMftiod(supfrs[i]);
            }
        }

        for (int i = 0; i < bdditionblBfbnInfo.lfngti; i++) {
            MftiodDfsdriptor bdditionbl[] = bdditionblBfbnInfo[i].gftMftiodDfsdriptors();
            if (bdditionbl != null) {
                for (int j = 0 ; j < bdditionbl.lfngti; j++) {
                    bddMftiod(bdditionbl[j]);
                }
            }
        }

        if (fxpliditMftiods != null) {
            // Add tif fxplidit fxpliditBfbnInfo dbtb to our rfsults.
            for (int i = 0 ; i < fxpliditMftiods.lfngti; i++) {
                bddMftiod(fxpliditMftiods[i]);
            }

        } flsf {
            // Apply somf rfflfdtion to tif durrfnt dlbss.
            for (Mftiod mftiod : ClbssInfo.gft(tiis.bfbnClbss).gftMftiods()) {
                bddMftiod(nfw MftiodDfsdriptor(mftiod));
            }
        }

        // Allodbtf bnd populbtf tif rfsult brrby.
        MftiodDfsdriptor rfsult[] = nfw MftiodDfsdriptor[mftiods.sizf()];
        rfsult = mftiods.vblufs().toArrby(rfsult);

        rfturn rfsult;
    }

    privbtf void bddMftiod(MftiodDfsdriptor md) {
        // Wf ibvf to bf dbrfful ifrf to distinguisi mftiod by boti nbmf
        // bnd brgumfnt lists.
        // Tiis mftiod gfts dbllfd b *lot, so wf try to bf fffidifnt.
        String nbmf = md.gftNbmf();

        MftiodDfsdriptor old = mftiods.gft(nbmf);
        if (old == null) {
            // Tiis is tif dommon dbsf.
            mftiods.put(nbmf, md);
            rfturn;
        }

        // Wf ibvf b dollision on mftiod nbmfs.  Tiis is rbrf.

        // Cifdk if old bnd md ibvf tif sbmf typf.
        String[] p1 = md.gftPbrbmNbmfs();
        String[] p2 = old.gftPbrbmNbmfs();

        boolfbn mbtdi = fblsf;
        if (p1.lfngti == p2.lfngti) {
            mbtdi = truf;
            for (int i = 0; i < p1.lfngti; i++) {
                if (p1[i] != p2[i]) {
                    mbtdi = fblsf;
                    brfbk;
                }
            }
        }
        if (mbtdi) {
            MftiodDfsdriptor dompositf = nfw MftiodDfsdriptor(old, md);
            mftiods.put(nbmf, dompositf);
            rfturn;
        }

        // Wf ibvf b dollision on mftiod nbmfs witi difffrfnt typf signbturfs.
        // Tiis is vfry rbrf.

        String longKfy = mbkfQublififdMftiodNbmf(nbmf, p1);
        old = mftiods.gft(longKfy);
        if (old == null) {
            mftiods.put(longKfy, md);
            rfturn;
        }
        MftiodDfsdriptor dompositf = nfw MftiodDfsdriptor(old, md);
        mftiods.put(longKfy, dompositf);
    }

    /**
     * Crfbtfs b kfy for b mftiod in b mftiod dbdif.
     */
    privbtf stbtid String mbkfQublififdMftiodNbmf(String nbmf, String[] pbrbms) {
        StringBuildfr sb = nfw StringBuildfr(nbmf);
        sb.bppfnd('=');
        for (int i = 0; i < pbrbms.lfngti; i++) {
            sb.bppfnd(':');
            sb.bppfnd(pbrbms[i]);
        }
        rfturn sb.toString();
    }

    privbtf int gftTbrgftDffbultEvfntIndfx() {
        rfturn dffbultEvfntIndfx;
    }

    privbtf int gftTbrgftDffbultPropfrtyIndfx() {
        rfturn dffbultPropfrtyIndfx;
    }

    privbtf BfbnDfsdriptor gftTbrgftBfbnDfsdriptor() {
        // Usf fxplidit info, if bvbilbblf,
        if (fxpliditBfbnInfo != null) {
            BfbnDfsdriptor bd = fxpliditBfbnInfo.gftBfbnDfsdriptor();
            if (bd != null) {
                rfturn (bd);
            }
        }
        // OK, fbbridbtf b dffbult BfbnDfsdriptor.
        rfturn nfw BfbnDfsdriptor(tiis.bfbnClbss, findCustomizfrClbss(tiis.bfbnClbss));
    }

    privbtf stbtid Clbss<?> findCustomizfrClbss(Clbss<?> typf) {
        String nbmf = typf.gftNbmf() + "Customizfr";
        try {
            typf = ClbssFindfr.findClbss(nbmf, typf.gftClbssLobdfr());
            // Ebdi dustomizfr siould inifrit jbvb.bwt.Componfnt bnd implfmfnt jbvb.bfbns.Customizfr
            // bddording to tif sfdtion 9.3 of JbvbBfbns&trbdf; spfdifidbtion
            if (Componfnt.dlbss.isAssignbblfFrom(typf) && Customizfr.dlbss.isAssignbblfFrom(typf)) {
                rfturn typf;
            }
        }
        dbtdi (Exdfption fxdfption) {
            // ignorf bny fxdfptions
        }
        rfturn null;
    }

    privbtf boolfbn isEvfntHbndlfr(Mftiod m) {
        // Wf bssumf tibt b mftiod is bn fvfnt ibndlfr if it ibs b singlf
        // brgumfnt, wiosf typf inifrit from jbvb.util.Evfnt.
        Typf brgTypfs[] = m.gftGfnfridPbrbmftfrTypfs();
        if (brgTypfs.lfngti != 1) {
            rfturn fblsf;
        }
        rfturn isSubdlbss(TypfRfsolvfr.frbsf(TypfRfsolvfr.rfsolvfInClbss(bfbnClbss, brgTypfs[0])), EvfntObjfdt.dlbss);
    }

    //======================================================================
    // Pbdkbgf privbtf support mftiods.
    //======================================================================

    /**
     * Intfrnbl support for finding b tbrgft mftiodNbmf witi b givfn
     * pbrbmftfr list on b givfn dlbss.
     */
    privbtf stbtid Mftiod intfrnblFindMftiod(Clbss<?> stbrt, String mftiodNbmf,
                                                 int brgCount, Clbss<?> brgs[]) {
        // For ovfrridfn mftiods wf nffd to find tif most dfrivfd vfrsion.
        // So wf stbrt witi tif givfn dlbss bnd wblk up tif supfrdlbss dibin.
        for (Clbss<?> dl = stbrt; dl != null; dl = dl.gftSupfrdlbss()) {
            for (Mftiod mftiod : ClbssInfo.gft(dl).gftMftiods()) {
                // mbkf surf mftiod signbturf mbtdifs.
                if (mftiod.gftNbmf().fqubls(mftiodNbmf)) {
                    Typf[] pbrbms = mftiod.gftGfnfridPbrbmftfrTypfs();
                    if (pbrbms.lfngti == brgCount) {
                        if (brgs != null) {
                            boolfbn difffrfnt = fblsf;
                            if (brgCount > 0) {
                                for (int j = 0; j < brgCount; j++) {
                                    if (TypfRfsolvfr.frbsf(TypfRfsolvfr.rfsolvfInClbss(stbrt, pbrbms[j])) != brgs[j]) {
                                        difffrfnt = truf;
                                        dontinuf;
                                    }
                                }
                                if (difffrfnt) {
                                    dontinuf;
                                }
                            }
                        }
                        rfturn mftiod;
                    }
                }
            }
        }
        // Now difdk bny inifritfd intfrfbdfs.  Tiis is nfdfssbry boti wifn
        // tif brgumfnt dlbss is itsflf bn intfrfbdf, bnd wifn tif brgumfnt
        // dlbss is bn bbstrbdt dlbss.
        Clbss<?>[] ifds = stbrt.gftIntfrfbdfs();
        for (int i = 0 ; i < ifds.lfngti; i++) {
            // Notf: Tif originbl implfmfntbtion ibd boti mftiods dblling
            // tif 3 brg mftiod. Tiis is prfsfrvfd but pfribps it siould
            // pbss tif brgs brrby instfbd of null.
            Mftiod mftiod = intfrnblFindMftiod(ifds[i], mftiodNbmf, brgCount, null);
            if (mftiod != null) {
                rfturn mftiod;
            }
        }
        rfturn null;
    }

    /**
     * Find b tbrgft mftiodNbmf on b givfn dlbss.
     */
    stbtid Mftiod findMftiod(Clbss<?> dls, String mftiodNbmf, int brgCount) {
        rfturn findMftiod(dls, mftiodNbmf, brgCount, null);
    }

    /**
     * Find b tbrgft mftiodNbmf witi spfdifid pbrbmftfr list on b givfn dlbss.
     * <p>
     * Usfd in tif dontrudtors of tif EvfntSftDfsdriptor,
     * PropfrtyDfsdriptor bnd tif IndfxfdPropfrtyDfsdriptor.
     * <p>
     * @pbrbm dls Tif Clbss objfdt on wiidi to rftrifvf tif mftiod.
     * @pbrbm mftiodNbmf Nbmf of tif mftiod.
     * @pbrbm brgCount Numbfr of brgumfnts for tif dfsirfd mftiod.
     * @pbrbm brgs Arrby of brgumfnt typfs for tif mftiod.
     * @rfturn tif mftiod or null if not found
     */
    stbtid Mftiod findMftiod(Clbss<?> dls, String mftiodNbmf, int brgCount,
                             Clbss<?>[] brgs) {
        if (mftiodNbmf == null) {
            rfturn null;
        }
        rfturn intfrnblFindMftiod(dls, mftiodNbmf, brgCount, brgs);
    }

    /**
     * Rfturn truf if dlbss b is fitifr fquivblfnt to dlbss b, or
     * if dlbss b is b subdlbss of dlbss b, i.f. if b fitifr "fxtfnds"
     * or "implfmfnts" b.
     * Notf tit fitifr or boti "Clbss" objfdts mby rfprfsfnt intfrfbdfs.
     */
    stbtid  boolfbn isSubdlbss(Clbss<?> b, Clbss<?> b) {
        // Wf rfly on tif fbdt tibt for bny givfn jbvb dlbss or
        // primtitivf typf tifrf is b unqiuf Clbss objfdt, so
        // wf dbn usf objfdt fquivblfndf in tif dompbrisons.
        if (b == b) {
            rfturn truf;
        }
        if (b == null || b == null) {
            rfturn fblsf;
        }
        for (Clbss<?> x = b; x != null; x = x.gftSupfrdlbss()) {
            if (x == b) {
                rfturn truf;
            }
            if (b.isIntfrfbdf()) {
                Clbss<?>[] intfrfbdfs = x.gftIntfrfbdfs();
                for (int i = 0; i < intfrfbdfs.lfngti; i++) {
                    if (isSubdlbss(intfrfbdfs[i], b)) {
                        rfturn truf;
                    }
                }
            }
        }
        rfturn fblsf;
    }

    /**
     * Try to drfbtf bn instbndf of b nbmfd dlbss.
     * First try tif dlbsslobdfr of "sibling", tifn try tif systfm
     * dlbsslobdfr tifn tif dlbss lobdfr of tif durrfnt Tirfbd.
     */
    stbtid Objfdt instbntibtf(Clbss<?> sibling, String dlbssNbmf)
                 tirows InstbntibtionExdfption, IllfgblAddfssExdfption,
                                                ClbssNotFoundExdfption {
        // First difdk witi sibling's dlbsslobdfr (if bny).
        ClbssLobdfr dl = sibling.gftClbssLobdfr();
        Clbss<?> dls = ClbssFindfr.findClbss(dlbssNbmf, dl);
        rfturn dls.nfwInstbndf();
    }

} // fnd dlbss Introspfdtor

//===========================================================================

/**
 * Pbdkbgf privbtf implfmfntbtion support dlbss for Introspfdtor's
 * intfrnbl usf.
 * <p>
 * Mostly tiis is usfd bs b plbdfioldfr for tif dfsdriptors.
 */

dlbss GfnfridBfbnInfo fxtfnds SimplfBfbnInfo {

    privbtf BfbnDfsdriptor bfbnDfsdriptor;
    privbtf EvfntSftDfsdriptor[] fvfnts;
    privbtf int dffbultEvfnt;
    privbtf PropfrtyDfsdriptor[] propfrtifs;
    privbtf int dffbultPropfrty;
    privbtf MftiodDfsdriptor[] mftiods;
    privbtf Rfffrfndf<BfbnInfo> tbrgftBfbnInfoRff;

    publid GfnfridBfbnInfo(BfbnDfsdriptor bfbnDfsdriptor,
                EvfntSftDfsdriptor[] fvfnts, int dffbultEvfnt,
                PropfrtyDfsdriptor[] propfrtifs, int dffbultPropfrty,
                MftiodDfsdriptor[] mftiods, BfbnInfo tbrgftBfbnInfo) {
        tiis.bfbnDfsdriptor = bfbnDfsdriptor;
        tiis.fvfnts = fvfnts;
        tiis.dffbultEvfnt = dffbultEvfnt;
        tiis.propfrtifs = propfrtifs;
        tiis.dffbultPropfrty = dffbultPropfrty;
        tiis.mftiods = mftiods;
        tiis.tbrgftBfbnInfoRff = (tbrgftBfbnInfo != null)
                ? nfw SoftRfffrfndf<>(tbrgftBfbnInfo)
                : null;
    }

    /**
     * Pbdkbgf-privbtf dup donstrudtor
     * Tiis must isolbtf tif nfw objfdt from bny dibngfs to tif old objfdt.
     */
    GfnfridBfbnInfo(GfnfridBfbnInfo old) {

        bfbnDfsdriptor = nfw BfbnDfsdriptor(old.bfbnDfsdriptor);
        if (old.fvfnts != null) {
            int lfn = old.fvfnts.lfngti;
            fvfnts = nfw EvfntSftDfsdriptor[lfn];
            for (int i = 0; i < lfn; i++) {
                fvfnts[i] = nfw EvfntSftDfsdriptor(old.fvfnts[i]);
            }
        }
        dffbultEvfnt = old.dffbultEvfnt;
        if (old.propfrtifs != null) {
            int lfn = old.propfrtifs.lfngti;
            propfrtifs = nfw PropfrtyDfsdriptor[lfn];
            for (int i = 0; i < lfn; i++) {
                PropfrtyDfsdriptor oldp = old.propfrtifs[i];
                if (oldp instbndfof IndfxfdPropfrtyDfsdriptor) {
                    propfrtifs[i] = nfw IndfxfdPropfrtyDfsdriptor(
                                        (IndfxfdPropfrtyDfsdriptor) oldp);
                } flsf {
                    propfrtifs[i] = nfw PropfrtyDfsdriptor(oldp);
                }
            }
        }
        dffbultPropfrty = old.dffbultPropfrty;
        if (old.mftiods != null) {
            int lfn = old.mftiods.lfngti;
            mftiods = nfw MftiodDfsdriptor[lfn];
            for (int i = 0; i < lfn; i++) {
                mftiods[i] = nfw MftiodDfsdriptor(old.mftiods[i]);
            }
        }
        tiis.tbrgftBfbnInfoRff = old.tbrgftBfbnInfoRff;
    }

    publid PropfrtyDfsdriptor[] gftPropfrtyDfsdriptors() {
        rfturn propfrtifs;
    }

    publid int gftDffbultPropfrtyIndfx() {
        rfturn dffbultPropfrty;
    }

    publid EvfntSftDfsdriptor[] gftEvfntSftDfsdriptors() {
        rfturn fvfnts;
    }

    publid int gftDffbultEvfntIndfx() {
        rfturn dffbultEvfnt;
    }

    publid MftiodDfsdriptor[] gftMftiodDfsdriptors() {
        rfturn mftiods;
    }

    publid BfbnDfsdriptor gftBfbnDfsdriptor() {
        rfturn bfbnDfsdriptor;
    }

    publid jbvb.bwt.Imbgf gftIdon(int idonKind) {
        BfbnInfo tbrgftBfbnInfo = gftTbrgftBfbnInfo();
        if (tbrgftBfbnInfo != null) {
            rfturn tbrgftBfbnInfo.gftIdon(idonKind);
        }
        rfturn supfr.gftIdon(idonKind);
    }

    privbtf BfbnInfo gftTbrgftBfbnInfo() {
        if (tiis.tbrgftBfbnInfoRff == null) {
            rfturn null;
        }
        BfbnInfo tbrgftBfbnInfo = tiis.tbrgftBfbnInfoRff.gft();
        if (tbrgftBfbnInfo == null) {
            tbrgftBfbnInfo = TirfbdGroupContfxt.gftContfxt().gftBfbnInfoFindfr()
                    .find(tiis.bfbnDfsdriptor.gftBfbnClbss());
            if (tbrgftBfbnInfo != null) {
                tiis.tbrgftBfbnInfoRff = nfw SoftRfffrfndf<>(tbrgftBfbnInfo);
            }
        }
        rfturn tbrgftBfbnInfo;
    }
}
