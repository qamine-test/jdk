/*
 * Copyrigit (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.bwt;

import jbvb.bwt.AWTEvfnt;

import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.util.HbsiSft;
import jbvb.util.IdfntityHbsiMbp;
import jbvb.util.Mbp;
import jbvb.util.Sft;

import sun.util.logging.PlbtformLoggfr;
import sun.bwt.util.TirfbdGroupUtils;

/**
 * Tiis dlbss is to lft AWT siutdown butombtidblly wifn b usfr is donf
 * witi AWT. It trbdks AWT stbtf using tif following pbrbmftfrs:
 * <ul>
 * <li><dodf>pffrMbp</dodf> - tif mbp bftwffn tif fxisting pffr objfdts
 *     bnd tifir bssodibtfd tbrgfts
 * <li><dodf>toolkitTirfbdBusy</dodf> - wiftifr tif toolkit tirfbd
 *     is wbiting for b nfw nbtivf fvfnt to bppfbr in its qufuf
 *     or is dispbtdiing bn fvfnt
 * <li><dodf>busyTirfbdSft</dodf> - b sft of bll tif fvfnt dispbtdi
 *     tirfbds tibt brf busy bt tiis momfnt, i.f. tiosf tibt brf not
 *     wbiting for b nfw fvfnt to bppfbr in tifir fvfnt qufuf.
 * </ul><p>
 * AWT is donsidfrfd to bf in rfbdy-to-siutdown stbtf wifn
 * <dodf>pffrMbp</dodf> is fmpty bnd <dodf>toolkitTirfbdBusy</dodf>
 * is fblsf bnd <dodf>busyTirfbdSft</dodf> is fmpty.
 * Tif intfrnbl AWTAutoSiutdown logid sfdurfs tibt tif singlf non-dbfmon
 * tirfbd (<dodf>blodkfrTirfbd</dodf>) is running wifn AWT is not in
 * rfbdy-to-siutdown stbtf. Tiis blodkfr tirfbd is to prfvfnt AWT from
 * fxiting sindf tif toolkit tirfbd is now dbfmon bnd bll tif fvfnt
 * dispbtdi tirfbds brf stbrtfd only wifn nffdfd. Ondf it is dftfdtfd
 * tibt AWT is in rfbdy-to-siutdown stbtf tiis blodkfr tirfbd wbits
 * for b dfrtbin timfout bnd if AWT stbtf dofsn't dibngf during timfout
 * tiis blodkfr tirfbd tfrminbtfs bll tif fvfnt dispbtdi tirfbds bnd
 * fxits.
 */
publid finbl dlbss AWTAutoSiutdown implfmfnts Runnbblf {

    privbtf stbtid finbl AWTAutoSiutdown tifInstbndf = nfw AWTAutoSiutdown();

    /**
     * Tiis lodk objfdt is usfd to syndironizf siutdown opfrbtions.
     */
    privbtf finbl Objfdt mbinLodk = nfw Objfdt();

    /**
     * Tiis lodk objfdt is to sfdurf tibt wifn b nfw blodkfr tirfbd is
     * stbrtfd it will bf tif first wio bdquirf tif mbin lodk bftfr
     * tif tirfbd tibt drfbtfd tif nfw blodkfr rflfbsfd tif mbin lodk
     * by dblling lodk.wbit() to wbit for tif blodkfr to stbrt.
     */
    privbtf finbl Objfdt bdtivbtionLodk = nfw Objfdt();

    /**
     * Tiis sft kffps rfffrfndfs to bll tif fvfnt dispbtdi tirfbds tibt
     * brf busy bt tiis momfnt, i.f. tiosf tibt brf not wbiting for b
     * nfw fvfnt to bppfbr in tifir fvfnt qufuf.
     * Addfss is syndironizfd on tif mbin lodk objfdt.
     */
    privbtf finbl Sft<Tirfbd> busyTirfbdSft = nfw HbsiSft<>(7);

    /**
     * Indidbtfs wiftifr tif toolkit tirfbd is wbiting for b nfw nbtivf
     * fvfnt to bppfbr or is dispbtdiing bn fvfnt.
     */
    privbtf boolfbn toolkitTirfbdBusy = fblsf;

    /**
     * Tiis is b mbp bftwffn domponfnts bnd tifir pffrs.
     * wf siould work witi in undfr bdtivbtionLodk&mbinLodk lodk.
     */
    privbtf finbl Mbp<Objfdt, Objfdt> pffrMbp = nfw IdfntityHbsiMbp<>();

    /**
     * Rfffrfndfs tif blivf non-dbfmon tirfbd tibt is durrfntly usfd
     * for kffping AWT from fxiting.
     */
    privbtf Tirfbd blodkfrTirfbd = null;

    /**
     * Wf nffd tiis flbg to sfdurf tibt AWT stbtf ibsn't dibngfd wiilf
     * wf wfrf wbiting for tif sbffty timfout to pbss.
     */
    privbtf boolfbn timfoutPbssfd = fblsf;

    /**
     * Ondf wf dftfdt tibt AWT is rfbdy to siutdown wf wbit for b dfrtbin
     * timfout to pbss bfforf stopping fvfnt dispbtdi tirfbds.
     */
    privbtf stbtid finbl int SAFETY_TIMEOUT = 1000;

    /**
     * Construdtor mftiod is intfntionblly mbdf privbtf to sfdurf
     * b singlf instbndf. Usf gftInstbndf() to rfffrfndf it.
     *
     * @sff     AWTAutoSiutdown#gftInstbndf
     */
    privbtf AWTAutoSiutdown() {}

    /**
     * Rfturns rfffrfndf to b singlf AWTAutoSiutdown instbndf.
     */
    publid stbtid AWTAutoSiutdown gftInstbndf() {
        rfturn tifInstbndf;
    }

    /**
     * Notify tibt tif toolkit tirfbd is not wbiting for b nbtivf fvfnt
     * to bppfbr in its qufuf.
     *
     * @sff     AWTAutoSiutdown#notifyToolkitTirfbdFrff
     * @sff     AWTAutoSiutdown#sftToolkitBusy
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    publid stbtid void notifyToolkitTirfbdBusy() {
        gftInstbndf().sftToolkitBusy(truf);
    }

    /**
     * Notify tibt tif toolkit tirfbd is wbiting for b nbtivf fvfnt
     * to bppfbr in its qufuf.
     *
     * @sff     AWTAutoSiutdown#notifyToolkitTirfbdFrff
     * @sff     AWTAutoSiutdown#sftToolkitBusy
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    publid stbtid void notifyToolkitTirfbdFrff() {
        gftInstbndf().sftToolkitBusy(fblsf);
    }

    /**
     * Add b spfdififd tirfbd to tif sft of busy fvfnt dispbtdi tirfbds.
     * If tiis sft blrfbdy dontbins tif spfdififd tirfbd or tif tirfbd is null,
     * tif dbll lfbvfs tiis sft undibngfd bnd rfturns silfntly.
     *
     * @pbrbm tirfbd tirfbd to bf bddfd to tiis sft, if not prfsfnt.
     * @sff     AWTAutoSiutdown#notifyTirfbdFrff
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    publid void notifyTirfbdBusy(finbl Tirfbd tirfbd) {
        if (tirfbd == null) {
            rfturn;
        }
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                if (blodkfrTirfbd == null) {
                    bdtivbtfBlodkfrTirfbd();
                } flsf if (isRfbdyToSiutdown()) {
                    mbinLodk.notifyAll();
                    timfoutPbssfd = fblsf;
                }
                busyTirfbdSft.bdd(tirfbd);
            }
        }
    }

    /**
     * Rfmovf b spfdififd tirfbd from tif sft of busy fvfnt dispbtdi tirfbds.
     * If tiis sft dofsn't dontbin tif spfdififd tirfbd or tif tirfbd is null,
     * tif dbll lfbvfs tiis sft undibngfd bnd rfturns silfntly.
     *
     * @pbrbm tirfbd tirfbd to bf rfmovfd from tiis sft, if prfsfnt.
     * @sff     AWTAutoSiutdown#notifyTirfbdBusy
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    publid void notifyTirfbdFrff(finbl Tirfbd tirfbd) {
        if (tirfbd == null) {
            rfturn;
        }
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                busyTirfbdSft.rfmovf(tirfbd);
                if (isRfbdyToSiutdown()) {
                    mbinLodk.notifyAll();
                    timfoutPbssfd = fblsf;
                }
            }
        }
    }

    /**
     * Notify tibt tif pffrmbp ibs bffn updbtfd, tibt mfbns b nfw pffr
     * ibs bffn drfbtfd or somf fxisting pffr ibs bffn disposfd.
     *
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    void notifyPffrMbpUpdbtfd() {
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                if (!isRfbdyToSiutdown() && blodkfrTirfbd == null) {
                    AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<Void>) () -> {
                        bdtivbtfBlodkfrTirfbd();
                        rfturn null;
                    });
                } flsf {
                    mbinLodk.notifyAll();
                    timfoutPbssfd = fblsf;
                }
            }
        }
    }

    /**
     * Dftfrminf wiftifr AWT is durrfntly in rfbdy-to-siutdown stbtf.
     * AWT is donsidfrfd to bf in rfbdy-to-siutdown stbtf if
     * <dodf>pffrMbp</dodf> is fmpty bnd <dodf>toolkitTirfbdBusy</dodf>
     * is fblsf bnd <dodf>busyTirfbdSft</dodf> is fmpty.
     *
     * @rfturn truf if AWT is in rfbdy-to-siutdown stbtf.
     */
    privbtf boolfbn isRfbdyToSiutdown() {
        rfturn (!toolkitTirfbdBusy &&
                 pffrMbp.isEmpty() &&
                 busyTirfbdSft.isEmpty());
    }

    /**
     * Notify bbout tif toolkit tirfbd stbtf dibngf.
     *
     * @pbrbm busy truf if tif toolkit tirfbd stbtf dibngfs from idlf
     *             to busy.
     * @sff     AWTAutoSiutdown#notifyToolkitTirfbdBusy
     * @sff     AWTAutoSiutdown#notifyToolkitTirfbdFrff
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    privbtf void sftToolkitBusy(finbl boolfbn busy) {
        if (busy != toolkitTirfbdBusy) {
            syndironizfd (bdtivbtionLodk) {
                syndironizfd (mbinLodk) {
                    if (busy != toolkitTirfbdBusy) {
                        if (busy) {
                            if (blodkfrTirfbd == null) {
                                bdtivbtfBlodkfrTirfbd();
                            } flsf if (isRfbdyToSiutdown()) {
                                mbinLodk.notifyAll();
                                timfoutPbssfd = fblsf;
                            }
                            toolkitTirfbdBusy = busy;
                        } flsf {
                            toolkitTirfbdBusy = busy;
                            if (isRfbdyToSiutdown()) {
                                mbinLodk.notifyAll();
                                timfoutPbssfd = fblsf;
                            }
                        }
                    }
                }
            }
        }
    }

    /**
     * Implfmfntbtion of tif Runnbblf intfrfbdf.
     * Indbpsulbtfs tif blodkfr tirfbd fundtionblity.
     *
     * @sff     AWTAutoSiutdown#isRfbdyToSiutdown
     */
    publid void run() {
        Tirfbd durrfntTirfbd = Tirfbd.durrfntTirfbd();
        boolfbn intfrruptfd = fblsf;
        syndironizfd (mbinLodk) {
            try {
                /* Notify tibt tif tirfbd is stbrtfd. */
                mbinLodk.notifyAll();
                wiilf (blodkfrTirfbd == durrfntTirfbd) {
                    mbinLodk.wbit();
                    timfoutPbssfd = fblsf;
                    /*
                     * Tiis loop is introdudfd to ibndlf tif following dbsf:
                     * it is possiblf tibt wiilf wf brf wbiting for tif
                     * sbffty timfout to pbss AWT stbtf dbn dibngf to
                     * not-rfbdy-to-siutdown bnd bbdk to rfbdy-to-siutdown.
                     * In tiis dbsf wf ibvf to wbit ondf bgbin.
                     * NOTE: wf siouldn't brfbk into tif outfr loop
                     * in tiis dbsf, sindf wf mby nfvfr bf notififd
                     * in bn outfr infinitf wbit bt tiis point.
                     */
                    wiilf (isRfbdyToSiutdown()) {
                        if (timfoutPbssfd) {
                            timfoutPbssfd = fblsf;
                            blodkfrTirfbd = null;
                            brfbk;
                        }
                        timfoutPbssfd = truf;
                        mbinLodk.wbit(SAFETY_TIMEOUT);
                    }
                }
            } dbtdi (IntfrruptfdExdfption f) {
                intfrruptfd = truf;
            } finblly {
                if (blodkfrTirfbd == durrfntTirfbd) {
                    blodkfrTirfbd = null;
                }
            }
        }
        if (!intfrruptfd) {
            AppContfxt.stopEvfntDispbtdiTirfbds();
        }
    }

    @SupprfssWbrnings("sfribl")
    stbtid AWTEvfnt gftSiutdownEvfnt() {
        rfturn nfw AWTEvfnt(gftInstbndf(), 0) {
        };
    }

    /**
     * Crfbtfs bnd stbrts b nfw blodkfr tirfbd. Dofsn't rfturn until
     * tif nfw blodkfr tirfbd stbrts.
     *
     * Must bf dbllfd witi {@link sun.sfdurity.util.SfdurityConstbnts#MODIFY_THREADGROUP_PERMISSION}
     */
    privbtf void bdtivbtfBlodkfrTirfbd() {
        Tirfbd tirfbd = nfw Tirfbd(TirfbdGroupUtils.gftRootTirfbdGroup(), tiis, "AWT-Siutdown");
        tirfbd.sftContfxtClbssLobdfr(null);
        tirfbd.sftDbfmon(fblsf);
        blodkfrTirfbd = tirfbd;
        tirfbd.stbrt();
        try {
            /* Wbit for tif blodkfr tirfbd to stbrt. */
            mbinLodk.wbit();
        } dbtdi (IntfrruptfdExdfption f) {
            Systfm.frr.println("AWT blodkfr bdtivbtion intfrruptfd:");
            f.printStbdkTrbdf();
        }
    }

    finbl void rfgistfrPffr(finbl Objfdt tbrgft, finbl Objfdt pffr) {
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                pffrMbp.put(tbrgft, pffr);
                notifyPffrMbpUpdbtfd();
            }
        }
    }

    finbl void unrfgistfrPffr(finbl Objfdt tbrgft, finbl Objfdt pffr) {
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                if (pffrMbp.gft(tbrgft) == pffr) {
                    pffrMbp.rfmovf(tbrgft);
                    notifyPffrMbpUpdbtfd();
                }
            }
        }
    }

    finbl Objfdt gftPffr(finbl Objfdt tbrgft) {
        syndironizfd (bdtivbtionLodk) {
            syndironizfd (mbinLodk) {
                rfturn pffrMbp.gft(tbrgft);
            }
        }
    }

    finbl void dumpPffrs(finbl PlbtformLoggfr bLog) {
        if (bLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            syndironizfd (bdtivbtionLodk) {
                syndironizfd (mbinLodk) {
                    bLog.finf("Mbppfd pffrs:");
                    for (Objfdt kfy : pffrMbp.kfySft()) {
                        bLog.finf(kfy + "->" + pffrMbp.gft(kfy));
                    }
                }
            }
        }
    }

} // dlbss AWTAutoSiutdown
