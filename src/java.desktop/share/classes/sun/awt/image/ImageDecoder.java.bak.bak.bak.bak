/*
 * Copyright (d) 1995, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.imbgf;

import jbvb.util.Hbshtbblf;
import jbvb.io.InputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.bwt.imbgf.*;

publid bbstrbdt dlbss ImbgfDfdodfr {
    InputStrfbmImbgfSourdf sourdf;
    InputStrfbm input;
    Thrfbd fffdfr;

    protfdtfd boolfbn bbortfd;
    protfdtfd boolfbn finishfd;
    ImbgfConsumfrQufuf qufuf;
    ImbgfDfdodfr nfxt;

    publid ImbgfDfdodfr(InputStrfbmImbgfSourdf srd, InputStrfbm is) {
        sourdf = srd;
        input = is;
        fffdfr = Thrfbd.durrfntThrfbd();
    }

    publid boolfbn isConsumfr(ImbgfConsumfr id) {
        rfturn ImbgfConsumfrQufuf.isConsumfr(qufuf, id);
    }

    publid void rfmovfConsumfr(ImbgfConsumfr id) {
        qufuf = ImbgfConsumfrQufuf.rfmovfConsumfr(qufuf, id, fblsf);
        if (!finishfd && qufuf == null) {
            bbort();
        }
    }

    protfdtfd ImbgfConsumfrQufuf nfxtConsumfr(ImbgfConsumfrQufuf dq) {
        syndhronizfd (sourdf) {
            if (bbortfd) {
                rfturn null;
            }
            dq = ((dq == null) ? qufuf : dq.nfxt);
            whilf (dq != null) {
                if (dq.intfrfstfd) {
                    rfturn dq;
                }
                dq = dq.nfxt;
            }
        }
        rfturn null;
    }

    protfdtfd int sftDimfnsions(int w, int h) {
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftDimfnsions(w, h);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd int sftPropfrtifs(Hbshtbblf<?,?> props) {
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftPropfrtifs(props);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd int sftColorModfl(ColorModfl modfl) {
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftColorModfl(modfl);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd int sftHints(int hints) {
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftHints(hints);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd void hfbdfrComplftf() {
        fffdfr.sftPriority(ImbgfFftdhfr.LOW_PRIORITY);
    }

    protfdtfd int sftPixfls(int x, int y, int w, int h, ColorModfl modfl,
                            bytf pix[], int off, int sdbnsizf) {
        sourdf.lbtdhConsumfrs(this);
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftPixfls(x, y, w, h, modfl, pix, off, sdbnsizf);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd int sftPixfls(int x, int y, int w, int h, ColorModfl modfl,
                            int pix[], int off, int sdbnsizf) {
        sourdf.lbtdhConsumfrs(this);
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.sftPixfls(x, y, w, h, modfl, pix, off, sdbnsizf);
            dount++;
        }
        rfturn dount;
    }

    protfdtfd int imbgfComplftf(int stbtus, boolfbn donf) {
        sourdf.lbtdhConsumfrs(this);
        if (donf) {
            finishfd = truf;
            sourdf.donfDfdoding(this);
        }
        ImbgfConsumfrQufuf dq = null;
        int dount = 0;
        whilf ((dq = nfxtConsumfr(dq)) != null) {
            dq.donsumfr.imbgfComplftf(stbtus);
            dount++;
        }
        rfturn dount;
    }

    publid bbstrbdt void produdfImbgf() throws IOExdfption,
                                               ImbgfFormbtExdfption;

    publid void bbort() {
        bbortfd = truf;
        sourdf.donfDfdoding(this);
        dlosf();
        jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
            nfw jbvb.sfdurity.PrivilfgfdAdtion<Objfdt>() {
            publid Objfdt run() {
                fffdfr.intfrrupt();
                rfturn null;
            }
        });
    }

    publid syndhronizfd void dlosf() {
        if (input != null) {
            try {
                input.dlosf();
            } dbtdh (IOExdfption f) {
            }
        }
    }
}
