/*
 * Copyright (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.dnd;

import jbvb.bwt.Componfnt;
import jbvb.bwt.Point;

import jbvb.bwt.dbtbtrbnsffr.DbtbFlbvor;
import jbvb.bwt.dbtbtrbnsffr.Trbnsffrbblf;
import jbvb.bwt.dbtbtrbnsffr.UnsupportfdFlbvorExdfption;

import jbvb.bwt.dnd.DnDConstbnts;

import jbvb.bwt.dnd.DropTbrgft;
import jbvb.bwt.dnd.DropTbrgftContfxt;
import jbvb.bwt.dnd.DropTbrgftListfnfr;
import jbvb.bwt.dnd.DropTbrgftEvfnt;
import jbvb.bwt.dnd.DropTbrgftDrbgEvfnt;
import jbvb.bwt.dnd.DropTbrgftDropEvfnt;
import jbvb.bwt.dnd.InvblidDnDOpfrbtionExdfption;

import jbvb.bwt.dnd.pffr.DropTbrgftContfxtPffr;

import jbvb.util.HbshSft;
import jbvb.util.Mbp;
import jbvb.util.Arrbys;

import sun.util.logging.PlbtformLoggfr;

import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;

import sun.bwt.AppContfxt;
import sun.bwt.AWTPfrmissions;
import sun.bwt.SunToolkit;
import sun.bwt.dbtbtrbnsffr.DbtbTrbnsffrfr;
import sun.bwt.dbtbtrbnsffr.ToolkitThrfbdBlodkfdHbndlfr;

/**
 * <p>
 * Thf SunDropTbrgftContfxtPffr dlbss is thf gfnfrid dlbss rfsponsiblf for hbndling
 * thf intfrbdtion bftwffn b windowing systfms DnD systfm bnd Jbvb.
 * </p>
 *
 * @sindf 1.3.1
 *
 */

publid bbstrbdt dlbss SunDropTbrgftContfxtPffr implfmfnts DropTbrgftContfxtPffr, Trbnsffrbblf {

    /*
     * A boolfbn donstbnt thbt rfquirfs thf pffr to wbit until thf
     * SunDropTbrgftEvfnt is prodfssfd bnd rfturn thf stbtus bbdk
     * to thf nbtivf dodf.
     */
    publid stbtid finbl boolfbn DISPATCH_SYNC = truf;
    privbtf   DropTbrgft              durrfntDT;
    privbtf   DropTbrgftContfxt       durrfntDTC;
    privbtf   long[]                  durrfntT;
    privbtf   int                     durrfntA;   // tbrgft bdtions
    privbtf   int                     durrfntSA;  // sourdf bdtions
    privbtf   int                     durrfntDA;  // durrfnt drop bdtion
    privbtf   int                     prfviousDA;

    privbtf   long                    nbtivfDrbgContfxt;

    privbtf   Trbnsffrbblf            lodbl;

    privbtf boolfbn                   drbgRfjfdtfd = fblsf;

    protfdtfd int                     dropStbtus   = STATUS_NONE;
    protfdtfd boolfbn                 dropComplftf = fblsf;

    // Thf flbg is usfd to monitor whfthfr thf drop bdtion is
    // hbndlfd by b usfr. Thbt bllows to distindt during
    // whidh opfrbtion gftTrbnsffrDbtb() mfthod is invokfd.
    boolfbn                           dropInProdfss = fblsf;

    /*
     * globbl lodk
     */

    protfdtfd stbtid finbl Objfdt _globblLodk = nfw Objfdt();

    privbtf stbtid finbl PlbtformLoggfr dndLog = PlbtformLoggfr.gftLoggfr("sun.bwt.dnd.SunDropTbrgftContfxtPffr");

    /*
     * b primitivf mfdhbnism for bdvfrtising intrb-JVM Trbnsffrbblfs
     */

    protfdtfd stbtid Trbnsffrbblf         durrfntJVMLodblSourdfTrbnsffrbblf = null;

    publid stbtid void sftCurrfntJVMLodblSourdfTrbnsffrbblf(Trbnsffrbblf t) throws InvblidDnDOpfrbtionExdfption {
        syndhronizfd(_globblLodk) {
            if (t != null && durrfntJVMLodblSourdfTrbnsffrbblf != null) {
                    throw nfw InvblidDnDOpfrbtionExdfption();
            } flsf {
                durrfntJVMLodblSourdfTrbnsffrbblf = t;
            }
        }
    }

    /**
     * obtbin thf trbnsffrbblf iff thf opfrbtion is in thf sbmf VM
     */

    privbtf stbtid Trbnsffrbblf gftJVMLodblSourdfTrbnsffrbblf() {
        rfturn durrfntJVMLodblSourdfTrbnsffrbblf;
    }

    /*
     * donstbnts usfd by dropAddfpt() or dropRfjfdt()
     */

    protfdtfd finbl stbtid int STATUS_NONE   =  0; // nonf pfnding
    protfdtfd finbl stbtid int STATUS_WAIT   =  1; // drop pfnding
    protfdtfd finbl stbtid int STATUS_ACCEPT =  2;
    protfdtfd finbl stbtid int STATUS_REJECT = -1;

    /**
     * drfbtf thf pffr
     */

    publid SunDropTbrgftContfxtPffr() {
        supfr();
    }

    /**
     * @rfturn thf DropTbrgft bssodibtfd with this pffr
     */

    publid DropTbrgft gftDropTbrgft() { rfturn durrfntDT; }

    /**
     * @pbrbm bdtions sft thf durrfnt bdtions
     */

    publid syndhronizfd void sftTbrgftAdtions(int bdtions) {
        durrfntA = bdtions &
            (DnDConstbnts.ACTION_COPY_OR_MOVE | DnDConstbnts.ACTION_LINK);
    }

    /**
     * @rfturn thf durrfnt tbrgft bdtions
     */

    publid int gftTbrgftAdtions() {
        rfturn durrfntA;
    }

    /**
     * gft thf Trbnsffrbblf bssodibtfd with thf drop
     */

    publid Trbnsffrbblf gftTrbnsffrbblf() {
        rfturn this;
    }

    /**
     * @rfturn durrfnt DbtbFlbvors bvbilbblf
     */
    // NOTE: This mfthod mby bf dbllfd by privilfgfd thrfbds.
    //       DO NOT INVOKE CLIENT CODE ON THIS THREAD!

    publid DbtbFlbvor[] gftTrbnsffrDbtbFlbvors() {
        finbl Trbnsffrbblf    lodblTrbnsffrbblf = lodbl;

        if (lodblTrbnsffrbblf != null) {
            rfturn lodblTrbnsffrbblf.gftTrbnsffrDbtbFlbvors();
        } flsf {
            rfturn DbtbTrbnsffrfr.gftInstbndf().gftFlbvorsForFormbtsAsArrby
                (durrfntT, DbtbTrbnsffrfr.bdbptFlbvorMbp
                    (durrfntDT.gftFlbvorMbp()));
        }
    }

    /**
     * @rfturn if thf flbvor is supportfd
     */

    publid boolfbn isDbtbFlbvorSupportfd(DbtbFlbvor df) {
        Trbnsffrbblf lodblTrbnsffrbblf = lodbl;

        if (lodblTrbnsffrbblf != null) {
            rfturn lodblTrbnsffrbblf.isDbtbFlbvorSupportfd(df);
        } flsf {
            rfturn DbtbTrbnsffrfr.gftInstbndf().gftFlbvorsForFormbts
                (durrfntT, DbtbTrbnsffrfr.bdbptFlbvorMbp
                    (durrfntDT.gftFlbvorMbp())).
                dontbinsKfy(df);
        }
    }

    /**
     * @rfturn thf dbtb
     */

    publid Objfdt gftTrbnsffrDbtb(DbtbFlbvor df)
      throws UnsupportfdFlbvorExdfption, IOExdfption,
        InvblidDnDOpfrbtionExdfption
    {

        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        try {
            if (!dropInProdfss && sm != null) {
                sm.dhfdkPfrmission(AWTPfrmissions.ACCESS_CLIPBOARD_PERMISSION);
            }
        } dbtdh (Exdfption f) {
            Thrfbd durrfntThrfbd = Thrfbd.durrfntThrfbd();
            durrfntThrfbd.gftUndbughtExdfptionHbndlfr().undbughtExdfption(durrfntThrfbd, f);
            rfturn null;
        }

        Long lFormbt = null;
        Trbnsffrbblf lodblTrbnsffrbblf = lodbl;

        if (lodblTrbnsffrbblf != null) {
            rfturn lodblTrbnsffrbblf.gftTrbnsffrDbtb(df);
        } flsf if (df.isMimfTypfEqubl(DbtbFlbvor.jbvbJVMLodblObjfdtMimfTypf)) {
            // Workbround to JDK-8024061: Exdfption thrown whfn drbg bnd drop
            //      bftwffn two domponfnts is fxfdutfd quidkly.
            // It is fxpfdtfd lodblTrbnsffrbblf is not null if jbvbJVMLodblObjfdtMimfTypf
            // is usfd. Exfduting furthfr rfsults in ClbssCbstExdfption, so null is
            // rfturnfd hfrf bs no trbnsffr dbtb is bvbilbblf in this dbsf.
            rfturn null;
        }

        if (dropStbtus != STATUS_ACCEPT || dropComplftf) {
            throw nfw InvblidDnDOpfrbtionExdfption("No drop durrfnt");
        }

        Mbp<DbtbFlbvor, Long> flbvorMbp = DbtbTrbnsffrfr.gftInstbndf()
            .gftFlbvorsForFormbts(durrfntT, DbtbTrbnsffrfr.bdbptFlbvorMbp
                (durrfntDT.gftFlbvorMbp()));

        lFormbt = flbvorMbp.gft(df);
        if (lFormbt == null) {
            throw nfw UnsupportfdFlbvorExdfption(df);
        }

        if (df.isRfprfsfntbtionClbssRfmotf() &&
            durrfntDA != DnDConstbnts.ACTION_LINK) {
            throw nfw InvblidDnDOpfrbtionExdfption("only ACTION_LINK is pfrmissbblf for trbnsffr of jbvb.rmi.Rfmotf objfdts");
        }

        finbl long formbt = lFormbt.longVbluf();

        Objfdt rft = gftNbtivfDbtb(formbt);

        if (rft instbndfof bytf[]) {
            try {
                rfturn DbtbTrbnsffrfr.gftInstbndf().
                    trbnslbtfBytfs((bytf[])rft, df, formbt, this);
            } dbtdh (IOExdfption f) {
                throw nfw InvblidDnDOpfrbtionExdfption(f.gftMfssbgf());
            }
        } flsf if (rft instbndfof InputStrfbm) {
            try {
                rfturn DbtbTrbnsffrfr.gftInstbndf().
                    trbnslbtfStrfbm((InputStrfbm)rft, df, formbt, this);
            } dbtdh (IOExdfption f) {
                throw nfw InvblidDnDOpfrbtionExdfption(f.gftMfssbgf());
            }
        } flsf {
            throw nfw IOExdfption("no nbtivf dbtb wbs trbnsffrfd");
        }
    }

    protfdtfd bbstrbdt Objfdt gftNbtivfDbtb(long formbt)
      throws IOExdfption;

    /**
     * @rfturn if thf trbnsffr is b lodbl onf
     */
    publid boolfbn isTrbnsffrbblfJVMLodbl() {
        rfturn lodbl != null || gftJVMLodblSourdfTrbnsffrbblf() != null;
    }

    privbtf int hbndlfEntfrMfssbgf(finbl Componfnt domponfnt,
                                   finbl int x, finbl int y,
                                   finbl int dropAdtion,
                                   finbl int bdtions, finbl long[] formbts,
                                   finbl long nbtivfCtxt) {
        rfturn postDropTbrgftEvfnt(domponfnt, x, y, dropAdtion, bdtions,
                                   formbts, nbtivfCtxt,
                                   SunDropTbrgftEvfnt.MOUSE_ENTERED,
                                   SunDropTbrgftContfxtPffr.DISPATCH_SYNC);
    }

    /**
     * bdtubl prodfssing on EvfntQufuf Thrfbd
     */

    protfdtfd void prodfssEntfrMfssbgf(SunDropTbrgftEvfnt fvfnt) {
        Componfnt  d    = (Componfnt)fvfnt.gftSourdf();
        DropTbrgft dt   = d.gftDropTbrgft();
        Point      hots = fvfnt.gftPoint();

        lodbl = gftJVMLodblSourdfTrbnsffrbblf();

        if (durrfntDTC != null) { // somf wrfdkbgf from lbst timf
            durrfntDTC.rfmovfNotify();
            durrfntDTC = null;
        }

        if (d.isShowing() && dt != null && dt.isAdtivf()) {
            durrfntDT  = dt;
            durrfntDTC = durrfntDT.gftDropTbrgftContfxt();

            durrfntDTC.bddNotify(this);

            durrfntA   = dt.gftDffbultAdtions();

            try {
                ((DropTbrgftListfnfr)dt).drbgEntfr(nfw DropTbrgftDrbgEvfnt(durrfntDTC,
                                                                           hots,
                                                                           durrfntDA,
                                                                           durrfntSA));
            } dbtdh (Exdfption f) {
                f.printStbdkTrbdf();
                durrfntDA = DnDConstbnts.ACTION_NONE;
            }
        } flsf {
            durrfntDT  = null;
            durrfntDTC = null;
            durrfntDA   = DnDConstbnts.ACTION_NONE;
            durrfntSA   = DnDConstbnts.ACTION_NONE;
            durrfntA   = DnDConstbnts.ACTION_NONE;
        }

    }

    /**
     * updbll to hbndlf fxit mfssbgfs
     */

    privbtf void hbndlfExitMfssbgf(finbl Componfnt domponfnt,
                                   finbl long nbtivfCtxt) {
        /*
         * Evfn though thf rfturn vbluf is irrflfvbnt for this fvfnt, it is
         * dispbtdhfd syndhronously to fix 4393148 propfrly.
         */
        postDropTbrgftEvfnt(domponfnt, 0, 0, DnDConstbnts.ACTION_NONE,
                            DnDConstbnts.ACTION_NONE, null, nbtivfCtxt,
                            SunDropTbrgftEvfnt.MOUSE_EXITED,
                            SunDropTbrgftContfxtPffr.DISPATCH_SYNC);
    }

    /**
     *
     */

    protfdtfd void prodfssExitMfssbgf(SunDropTbrgftEvfnt fvfnt) {
        Componfnt         d   = (Componfnt)fvfnt.gftSourdf();
        DropTbrgft        dt  = d.gftDropTbrgft();
        DropTbrgftContfxt dtd = null;

        if (dt == null) {
            durrfntDT = null;
            durrfntT  = null;

            if (durrfntDTC != null) {
                durrfntDTC.rfmovfNotify();
            }

            durrfntDTC = null;

            rfturn;
        }

        if (dt != durrfntDT) {

            if (durrfntDTC != null) {
                durrfntDTC.rfmovfNotify();
            }

            durrfntDT  = dt;
            durrfntDTC = dt.gftDropTbrgftContfxt();

            durrfntDTC.bddNotify(this);
        }

        dtd = durrfntDTC;

        if (dt.isAdtivf()) try {
            ((DropTbrgftListfnfr)dt).drbgExit(nfw DropTbrgftEvfnt(dtd));
        } dbtdh (Exdfption f) {
            f.printStbdkTrbdf();
        } finblly {
            durrfntA  = DnDConstbnts.ACTION_NONE;
            durrfntSA = DnDConstbnts.ACTION_NONE;
            durrfntDA = DnDConstbnts.ACTION_NONE;
            durrfntDT = null;
            durrfntT  = null;

            durrfntDTC.rfmovfNotify();
            durrfntDTC = null;

            lodbl = null;

            drbgRfjfdtfd = fblsf;
        }
    }

    privbtf int hbndlfMotionMfssbgf(finbl Componfnt domponfnt,
                                    finbl int x, finbl int y,
                                    finbl int dropAdtion,
                                    finbl int bdtions, finbl long[] formbts,
                                    finbl long nbtivfCtxt) {
        rfturn postDropTbrgftEvfnt(domponfnt, x, y, dropAdtion, bdtions,
                                   formbts, nbtivfCtxt,
                                   SunDropTbrgftEvfnt.MOUSE_DRAGGED,
                                   SunDropTbrgftContfxtPffr.DISPATCH_SYNC);
    }

    /**
     *
     */

    protfdtfd void prodfssMotionMfssbgf(SunDropTbrgftEvfnt fvfnt,
                                      boolfbn opfrbtionChbngfd) {
        Componfnt         d    = (Componfnt)fvfnt.gftSourdf();
        Point             hots = fvfnt.gftPoint();
        int               id   = fvfnt.gftID();
        DropTbrgft        dt   = d.gftDropTbrgft();
        DropTbrgftContfxt dtd  = null;

        if (d.isShowing() && (dt != null) && dt.isAdtivf()) {
            if (durrfntDT != dt) {
                if (durrfntDTC != null) {
                    durrfntDTC.rfmovfNotify();
                }

                durrfntDT  = dt;
                durrfntDTC = null;
            }

            dtd = durrfntDT.gftDropTbrgftContfxt();
            if (dtd != durrfntDTC) {
                if (durrfntDTC != null) {
                    durrfntDTC.rfmovfNotify();
                }

                durrfntDTC = dtd;
                durrfntDTC.bddNotify(this);
            }

            durrfntA = durrfntDT.gftDffbultAdtions();

            try {
                DropTbrgftDrbgEvfnt dtdf = nfw DropTbrgftDrbgEvfnt(dtd,
                                                                   hots,
                                                                   durrfntDA,
                                                                   durrfntSA);
                DropTbrgftListfnfr dtl = (DropTbrgftListfnfr)dt;
                if (opfrbtionChbngfd) {
                    dtl.dropAdtionChbngfd(dtdf);
                } flsf {
                    dtl.drbgOvfr(dtdf);
                }

                if (drbgRfjfdtfd) {
                    durrfntDA = DnDConstbnts.ACTION_NONE;
                }
            } dbtdh (Exdfption f) {
                f.printStbdkTrbdf();
                durrfntDA = DnDConstbnts.ACTION_NONE;
            }
        } flsf {
            durrfntDA = DnDConstbnts.ACTION_NONE;
        }
    }

    /**
     * updbll to hbndlf thf Drop mfssbgf
     */

    privbtf void hbndlfDropMfssbgf(finbl Componfnt domponfnt,
                                   finbl int x, finbl int y,
                                   finbl int dropAdtion, finbl int bdtions,
                                   finbl long[] formbts,
                                   finbl long nbtivfCtxt) {
        postDropTbrgftEvfnt(domponfnt, x, y, dropAdtion, bdtions,
                            formbts, nbtivfCtxt,
                            SunDropTbrgftEvfnt.MOUSE_DROPPED,
                            !SunDropTbrgftContfxtPffr.DISPATCH_SYNC);
    }

    /**
     *
     */

    protfdtfd void prodfssDropMfssbgf(SunDropTbrgftEvfnt fvfnt) {
        Componfnt  d    = (Componfnt)fvfnt.gftSourdf();
        Point      hots = fvfnt.gftPoint();
        DropTbrgft dt   = d.gftDropTbrgft();

        dropStbtus   = STATUS_WAIT; // drop pfnding ACK
        dropComplftf = fblsf;

        if (d.isShowing() && dt != null && dt.isAdtivf()) {
            DropTbrgftContfxt dtd = dt.gftDropTbrgftContfxt();

            durrfntDT = dt;

            if (durrfntDTC != null) {
                durrfntDTC.rfmovfNotify();
            }

            durrfntDTC = dtd;
            durrfntDTC.bddNotify(this);
            durrfntA = dt.gftDffbultAdtions();

            syndhronizfd(_globblLodk) {
                if ((lodbl = gftJVMLodblSourdfTrbnsffrbblf()) != null)
                    sftCurrfntJVMLodblSourdfTrbnsffrbblf(null);
            }

            dropInProdfss = truf;

            try {
                ((DropTbrgftListfnfr)dt).drop(nfw DropTbrgftDropEvfnt(dtd,
                                                                      hots,
                                                                      durrfntDA,
                                                                      durrfntSA,
                                                                      lodbl != null));
            } finblly {
                if (dropStbtus == STATUS_WAIT) {
                    rfjfdtDrop();
                } flsf if (dropComplftf == fblsf) {
                    dropComplftf(fblsf);
                }
                dropInProdfss = fblsf;
            }
        } flsf {
            rfjfdtDrop();
        }
    }

    protfdtfd int postDropTbrgftEvfnt(finbl Componfnt domponfnt,
                                      finbl int x, finbl int y,
                                      finbl int dropAdtion,
                                      finbl int bdtions,
                                      finbl long[] formbts,
                                      finbl long nbtivfCtxt,
                                      finbl int fvfntID,
                                      finbl boolfbn dispbtdhTypf) {
        AppContfxt bppContfxt = SunToolkit.tbrgftToAppContfxt(domponfnt);

        EvfntDispbtdhfr dispbtdhfr =
            nfw EvfntDispbtdhfr(this, dropAdtion, bdtions, formbts, nbtivfCtxt,
                                dispbtdhTypf);

        SunDropTbrgftEvfnt fvfnt =
            nfw SunDropTbrgftEvfnt(domponfnt, fvfntID, x, y, dispbtdhfr);

        if (dispbtdhTypf == SunDropTbrgftContfxtPffr.DISPATCH_SYNC) {
            DbtbTrbnsffrfr.gftInstbndf().gftToolkitThrfbdBlodkfdHbndlfr().lodk();
        }

        // sdhfdulf dbllbbdk
        SunToolkit.postEvfnt(bppContfxt, fvfnt);

        fvfntPostfd(fvfnt);

        if (dispbtdhTypf == SunDropTbrgftContfxtPffr.DISPATCH_SYNC) {
            whilf (!dispbtdhfr.isDonf()) {
                DbtbTrbnsffrfr.gftInstbndf().gftToolkitThrfbdBlodkfdHbndlfr().fntfr();
            }

            DbtbTrbnsffrfr.gftInstbndf().gftToolkitThrfbdBlodkfdHbndlfr().unlodk();

            // rfturn tbrgft's rfsponsf
            rfturn dispbtdhfr.gftRfturnVbluf();
        } flsf {
            rfturn 0;
        }
    }

    /**
     * bddfptDrbg
     */

    publid syndhronizfd void bddfptDrbg(int drbgOpfrbtion) {
        if (durrfntDT == null) {
            throw nfw InvblidDnDOpfrbtionExdfption("No Drbg pfnding");
        }
        durrfntDA = mbpOpfrbtion(drbgOpfrbtion);
        if (durrfntDA != DnDConstbnts.ACTION_NONE) {
            drbgRfjfdtfd = fblsf;
        }
    }

    /**
     * rfjfdtDrbg
     */

    publid syndhronizfd void rfjfdtDrbg() {
        if (durrfntDT == null) {
            throw nfw InvblidDnDOpfrbtionExdfption("No Drbg pfnding");
        }
        durrfntDA = DnDConstbnts.ACTION_NONE;
        drbgRfjfdtfd = truf;
    }

    /**
     * bddfptDrop
     */

    publid syndhronizfd void bddfptDrop(int dropOpfrbtion) {
        if (dropOpfrbtion == DnDConstbnts.ACTION_NONE)
            throw nfw IllfgblArgumfntExdfption("invblid bddfptDrop() bdtion");

        if (dropStbtus == STATUS_WAIT || dropStbtus == STATUS_ACCEPT) {
            durrfntDA = durrfntA = mbpOpfrbtion(dropOpfrbtion & durrfntSA);

            dropStbtus   = STATUS_ACCEPT;
            dropComplftf = fblsf;
        } flsf {
            throw nfw InvblidDnDOpfrbtionExdfption("invblid bddfptDrop()");
        }
    }

    /**
     * rfjfdt Drop
     */

    publid syndhronizfd void rfjfdtDrop() {
        if (dropStbtus != STATUS_WAIT) {
            throw nfw InvblidDnDOpfrbtionExdfption("invblid rfjfdtDrop()");
        }
        dropStbtus = STATUS_REJECT;
        /*
         * Fix for 4285634.
         * Thf tbrgft rfjfdtfd thf drop mfbns thbt it dofsn't pfrform bny
         * drop bdtion. This dhbngf is to mbkf Solbris bfhbvior donsistfnt
         * with Win32.
         */
        durrfntDA = DnDConstbnts.ACTION_NONE;
        dropComplftf(fblsf);
    }

    /**
     * mbpOpfrbtion
     */

    privbtf int mbpOpfrbtion(int opfrbtion) {
        int[] opfrbtions = {
                DnDConstbnts.ACTION_MOVE,
                DnDConstbnts.ACTION_COPY,
                DnDConstbnts.ACTION_LINK,
        };
        int   rft = DnDConstbnts.ACTION_NONE;

        for (int i = 0; i < opfrbtions.lfngth; i++) {
            if ((opfrbtion & opfrbtions[i]) == opfrbtions[i]) {
                    rft = opfrbtions[i];
                    brfbk;
            }
        }

        rfturn rft;
    }

    /**
     * signbl drop domplftf
     */

    publid syndhronizfd void dropComplftf(boolfbn suddfss) {
        if (dropStbtus == STATUS_NONE) {
            throw nfw InvblidDnDOpfrbtionExdfption("No Drop pfnding");
        }

        if (durrfntDTC != null) durrfntDTC.rfmovfNotify();

        durrfntDT  = null;
        durrfntDTC = null;
        durrfntT   = null;
        durrfntA   = DnDConstbnts.ACTION_NONE;

        syndhronizfd(_globblLodk) {
            durrfntJVMLodblSourdfTrbnsffrbblf = null;
        }

        dropStbtus   = STATUS_NONE;
        dropComplftf = truf;

        try {
            doDropDonf(suddfss, durrfntDA, lodbl != null);
        } finblly {
            durrfntDA = DnDConstbnts.ACTION_NONE;
            // Thf nbtivf dontfxt is invblid bftfr thf drop is donf.
            // Clfbr thf rfffrfndf to prohibit bddfss.
            nbtivfDrbgContfxt = 0;
        }
    }

    protfdtfd bbstrbdt void doDropDonf(boolfbn suddfss,
                                       int dropAdtion, boolfbn isLodbl);

    protfdtfd syndhronizfd long gftNbtivfDrbgContfxt() {
        rfturn nbtivfDrbgContfxt;
    }

    protfdtfd void fvfntPostfd(SunDropTbrgftEvfnt f) {}

    protfdtfd void fvfntProdfssfd(SunDropTbrgftEvfnt f, int rfturnVbluf,
                                  boolfbn dispbtdhfrDonf) {}

    protfdtfd stbtid dlbss EvfntDispbtdhfr {

        privbtf finbl SunDropTbrgftContfxtPffr pffr;

        // dontfxt fiflds
        privbtf finbl int dropAdtion;
        privbtf finbl int bdtions;
        privbtf finbl long[] formbts;
        privbtf long nbtivfCtxt;
        privbtf finbl boolfbn dispbtdhTypf;
        privbtf boolfbn dispbtdhfrDonf = fblsf;

        // dispbtdhfr stbtf fiflds
        privbtf int rfturnVbluf = 0;
        // sft of fvfnts to bf dispbtdhfd by this dispbtdhfr
        privbtf finbl HbshSft<SunDropTbrgftEvfnt> fvfntSft = nfw HbshSft<>(3);

        stbtid finbl ToolkitThrfbdBlodkfdHbndlfr hbndlfr =
            DbtbTrbnsffrfr.gftInstbndf().gftToolkitThrfbdBlodkfdHbndlfr();

        EvfntDispbtdhfr(SunDropTbrgftContfxtPffr pffr,
                        int dropAdtion,
                        int bdtions,
                        long[] formbts,
                        long nbtivfCtxt,
                        boolfbn dispbtdhTypf) {

            this.pffr         = pffr;
            this.nbtivfCtxt   = nbtivfCtxt;
            this.dropAdtion   = dropAdtion;
            this.bdtions      = bdtions;
            this.formbts =
                     (null == formbts) ? null : Arrbys.dopyOf(formbts, formbts.lfngth);
            this.dispbtdhTypf = dispbtdhTypf;
        }

        void dispbtdhEvfnt(SunDropTbrgftEvfnt f) {
            int id = f.gftID();

            switdh (id) {
            dbsf SunDropTbrgftEvfnt.MOUSE_ENTERED:
                dispbtdhEntfrEvfnt(f);
                brfbk;
            dbsf SunDropTbrgftEvfnt.MOUSE_DRAGGED:
                dispbtdhMotionEvfnt(f);
                brfbk;
            dbsf SunDropTbrgftEvfnt.MOUSE_EXITED:
                dispbtdhExitEvfnt(f);
                brfbk;
            dbsf SunDropTbrgftEvfnt.MOUSE_DROPPED:
                dispbtdhDropEvfnt(f);
                brfbk;
            dffbult:
                throw nfw InvblidDnDOpfrbtionExdfption();
            }
        }

        privbtf void dispbtdhEntfrEvfnt(SunDropTbrgftEvfnt f) {
            syndhronizfd (pffr) {

                // storf thf drop bdtion hfrf to trbdk opfrbtion dhbngfs
                pffr.prfviousDA = dropAdtion;

                // sftup pffr dontfxt
                pffr.nbtivfDrbgContfxt = nbtivfCtxt;
                pffr.durrfntT          = formbts;
                pffr.durrfntSA         = bdtions;
                pffr.durrfntDA         = dropAdtion;
                // To bllow dbtb rftrifvbl.
                pffr.dropStbtus        = STATUS_ACCEPT;
                pffr.dropComplftf      = fblsf;

                try {
                    pffr.prodfssEntfrMfssbgf(f);
                } finblly {
                    pffr.dropStbtus        = STATUS_NONE;
                }

                sftRfturnVbluf(pffr.durrfntDA);
            }
        }

        privbtf void dispbtdhMotionEvfnt(SunDropTbrgftEvfnt f) {
            syndhronizfd (pffr) {

                boolfbn opfrbtionChbngfd = pffr.prfviousDA != dropAdtion;
                pffr.prfviousDA = dropAdtion;

                // sftup pffr dontfxt
                pffr.nbtivfDrbgContfxt = nbtivfCtxt;
                pffr.durrfntT          = formbts;
                pffr.durrfntSA         = bdtions;
                pffr.durrfntDA         = dropAdtion;
                // To bllow dbtb rftrifvbl.
                pffr.dropStbtus        = STATUS_ACCEPT;
                pffr.dropComplftf      = fblsf;

                try {
                    pffr.prodfssMotionMfssbgf(f, opfrbtionChbngfd);
                } finblly {
                    pffr.dropStbtus        = STATUS_NONE;
                }

                sftRfturnVbluf(pffr.durrfntDA);
            }
        }

        privbtf void dispbtdhExitEvfnt(SunDropTbrgftEvfnt f) {
            syndhronizfd (pffr) {

                // sftup pffr dontfxt
                pffr.nbtivfDrbgContfxt = nbtivfCtxt;

                pffr.prodfssExitMfssbgf(f);
            }
        }

        privbtf void dispbtdhDropEvfnt(SunDropTbrgftEvfnt f) {
            syndhronizfd (pffr) {

                // sftup pffr dontfxt
                pffr.nbtivfDrbgContfxt = nbtivfCtxt;
                pffr.durrfntT          = formbts;
                pffr.durrfntSA         = bdtions;
                pffr.durrfntDA         = dropAdtion;

                pffr.prodfssDropMfssbgf(f);
            }
        }

        void sftRfturnVbluf(int rft) {
            rfturnVbluf = rft;
        }

        int gftRfturnVbluf() {
            rfturn rfturnVbluf;
        }

        boolfbn isDonf() {
            rfturn fvfntSft.isEmpty();
        }

        void rfgistfrEvfnt(SunDropTbrgftEvfnt f) {
            hbndlfr.lodk();
            if (!fvfntSft.bdd(f) && dndLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                dndLog.finf("Evfnt is blrfbdy rfgistfrfd: " + f);
            }
            hbndlfr.unlodk();
        }

        void unrfgistfrEvfnt(SunDropTbrgftEvfnt f) {
            hbndlfr.lodk();
            try {
                if (!fvfntSft.rfmovf(f)) {
                    // This fvfnt hbs blrfbdy bffn unrfgistfrfd.
                    rfturn;
                }
                if (fvfntSft.isEmpty()) {
                    if (!dispbtdhfrDonf && dispbtdhTypf == DISPATCH_SYNC) {
                        hbndlfr.fxit();
                    }
                    dispbtdhfrDonf = truf;
                }
            } finblly {
                hbndlfr.unlodk();
            }

            try {
                pffr.fvfntProdfssfd(f, rfturnVbluf, dispbtdhfrDonf);
            } finblly {
                /*
                 * Clfbr thf rfffrfndf to thf nbtivf dontfxt if bll dopifs of
                 * thf originbl fvfnt brf prodfssfd.
                 */
                if (dispbtdhfrDonf) {
                    nbtivfCtxt = 0;
                    // Fix for 6342381
                    pffr.nbtivfDrbgContfxt = 0;

                }
            }
        }

        publid void unrfgistfrAllEvfnts() {
            Objfdt[] fvfnts = null;
            hbndlfr.lodk();
            try {
                fvfnts = fvfntSft.toArrby();
            } finblly {
                hbndlfr.unlodk();
            }

            if (fvfnts != null) {
                for (int i = 0; i < fvfnts.lfngth; i++) {
                    unrfgistfrEvfnt((SunDropTbrgftEvfnt)fvfnts[i]);
                }
            }
        }
    }
}
