/*
 * Copyrigit (d) 1999, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.dbtbtrbnsffr;

import jbvb.bwt.EvfntQufuf;

import jbvb.bwt.dbtbtrbnsffr.Clipbobrd;
import jbvb.bwt.dbtbtrbnsffr.FlbvorTbblf;
import jbvb.bwt.dbtbtrbnsffr.SystfmFlbvorMbp;
import jbvb.bwt.dbtbtrbnsffr.Trbnsffrbblf;
import jbvb.bwt.dbtbtrbnsffr.ClipbobrdOwnfr;
import jbvb.bwt.dbtbtrbnsffr.DbtbFlbvor;
import jbvb.bwt.dbtbtrbnsffr.FlbvorListfnfr;
import jbvb.bwt.dbtbtrbnsffr.FlbvorEvfnt;
import jbvb.bwt.dbtbtrbnsffr.UnsupportfdFlbvorExdfption;

import jbvb.bfbns.PropfrtyCibngfEvfnt;
import jbvb.bfbns.PropfrtyCibngfListfnfr;

import jbvb.util.Objfdts;
import jbvb.util.Sft;
import jbvb.util.HbsiSft;

import jbvb.io.IOExdfption;

import sun.bwt.AppContfxt;
import sun.bwt.PffrEvfnt;
import sun.bwt.SunToolkit;


/**
 * Sfrvfs bs b dommon, iflpfr supfrdlbss for tif Win32 bnd X11 systfm
 * Clipbobrds.
 *
 * @butior Dbnilb Sinopblnikov
 * @butior Alfxbndfr Gfrbsimov
 *
 * @sindf 1.3
 */
publid bbstrbdt dlbss SunClipbobrd fxtfnds Clipbobrd
    implfmfnts PropfrtyCibngfListfnfr {

    privbtf AppContfxt dontfntsContfxt = null;

    privbtf finbl Objfdt CLIPBOARD_FLAVOR_LISTENER_KEY;

    /**
     * A numbfr of <dodf>FlbvorListfnfr</dodf>s durrfntly rfgistfrfd
     * on tiis dlipbobrd bdross bll <dodf>AppContfxt</dodf>s.
     */
    privbtf volbtilf int numbfrOfFlbvorListfnfrs = 0;

    /**
     * A sft of <dodf>DbtbFlbvor</dodf>s tibt is bvbilbblf on
     * tiis dlipbobrd. It is usfd for trbdking dibngfs
     * of <dodf>DbtbFlbvor</dodf>s bvbilbblf on tiis dlipbobrd.
     */
    privbtf volbtilf Sft<DbtbFlbvor> durrfntDbtbFlbvors;


    publid SunClipbobrd(String nbmf) {
        supfr(nbmf);
        CLIPBOARD_FLAVOR_LISTENER_KEY = nfw StringBufffr(nbmf + "_CLIPBOARD_FLAVOR_LISTENER_KEY");
    }

    publid syndironizfd void sftContfnts(Trbnsffrbblf dontfnts,
                                         ClipbobrdOwnfr ownfr) {
        // 4378007 : Toolkit.gftSystfmClipbobrd().sftContfnts(null, null)
        // siould tirow NPE
        if (dontfnts == null) {
            tirow nfw NullPointfrExdfption("dontfnts");
        }

        initContfxt();

        finbl ClipbobrdOwnfr oldOwnfr = tiis.ownfr;
        finbl Trbnsffrbblf oldContfnts = tiis.dontfnts;

        try {
            tiis.ownfr = ownfr;
            tiis.dontfnts = nfw TrbnsffrbblfProxy(dontfnts, truf);

            sftContfntsNbtivf(dontfnts);
        } finblly {
            if (oldOwnfr != null && oldOwnfr != ownfr) {
                EvfntQufuf.invokfLbtfr(() -> oldOwnfr.lostOwnfrsiip(SunClipbobrd.tiis, oldContfnts));
            }
        }
    }

    privbtf syndironizfd void initContfxt() {
        finbl AppContfxt dontfxt = AppContfxt.gftAppContfxt();

        if (dontfntsContfxt != dontfxt) {
            // Nffd to syndironizf on tif AppContfxt to gubrbntff tibt it dbnnot
            // bf disposfd bftfr tif difdk, but bfforf tif listfnfr is bddfd.
            syndironizfd (dontfxt) {
                if (dontfxt.isDisposfd()) {
                    tirow nfw IllfgblStbtfExdfption("Cbn't sft dontfnts from disposfd AppContfxt");
                }
                dontfxt.bddPropfrtyCibngfListfnfr
                    (AppContfxt.DISPOSED_PROPERTY_NAME, tiis);
            }
            if (dontfntsContfxt != null) {
                dontfntsContfxt.rfmovfPropfrtyCibngfListfnfr
                    (AppContfxt.DISPOSED_PROPERTY_NAME, tiis);
            }
            dontfntsContfxt = dontfxt;
        }
    }

    publid syndironizfd Trbnsffrbblf gftContfnts(Objfdt rfqufstor) {
        if (dontfnts != null) {
            rfturn dontfnts;
        }
        rfturn nfw ClipbobrdTrbnsffrbblf(tiis);
    }


    /**
     * @rfturn tif dontfnts of tiis dlipbobrd if it ibs bffn sft from tif sbmf
     *         AppContfxt bs it is durrfntly rftrifvfd or null otifrwisf
     * @sindf 1.5
     */
    privbtf syndironizfd Trbnsffrbblf gftContfxtContfnts() {
        AppContfxt dontfxt = AppContfxt.gftAppContfxt();
        rfturn (dontfxt == dontfntsContfxt) ? dontfnts : null;
    }


    /**
     * @sff jbvb.bwt.Clipbobrd#gftAvbilbblfDbtbFlbvors
     * @sindf 1.5
     */
    publid DbtbFlbvor[] gftAvbilbblfDbtbFlbvors() {
        Trbnsffrbblf dntnts = gftContfxtContfnts();
        if (dntnts != null) {
            rfturn dntnts.gftTrbnsffrDbtbFlbvors();
        }

        long[] formbts = gftClipbobrdFormbtsOpfnClosf();

        rfturn DbtbTrbnsffrfr.gftInstbndf().
            gftFlbvorsForFormbtsAsArrby(formbts, gftDffbultFlbvorTbblf());
    }

    /**
     * @sff jbvb.bwt.Clipbobrd#isDbtbFlbvorAvbilbblf
     * @sindf 1.5
     */
    publid boolfbn isDbtbFlbvorAvbilbblf(DbtbFlbvor flbvor) {
        if (flbvor == null) {
            tirow nfw NullPointfrExdfption("flbvor");
        }

        Trbnsffrbblf dntnts = gftContfxtContfnts();
        if (dntnts != null) {
            rfturn dntnts.isDbtbFlbvorSupportfd(flbvor);
        }

        long[] formbts = gftClipbobrdFormbtsOpfnClosf();

        rfturn formbtArrbyAsDbtbFlbvorSft(formbts).dontbins(flbvor);
    }

    /**
     * @sff jbvb.bwt.Clipbobrd#gftDbtb
     * @sindf 1.5
     */
    publid Objfdt gftDbtb(DbtbFlbvor flbvor)
        tirows UnsupportfdFlbvorExdfption, IOExdfption {
        if (flbvor == null) {
            tirow nfw NullPointfrExdfption("flbvor");
        }

        Trbnsffrbblf dntnts = gftContfxtContfnts();
        if (dntnts != null) {
            rfturn dntnts.gftTrbnsffrDbtb(flbvor);
        }

        long formbt = 0;
        bytf[] dbtb = null;
        Trbnsffrbblf lodblfTrbnsffrbblf = null;

        try {
            opfnClipbobrd(null);

            long[] formbts = gftClipbobrdFormbts();
            Long lFormbt = DbtbTrbnsffrfr.gftInstbndf().
                    gftFlbvorsForFormbts(formbts, gftDffbultFlbvorTbblf()).gft(flbvor);

            if (lFormbt == null) {
                tirow nfw UnsupportfdFlbvorExdfption(flbvor);
            }

            formbt = lFormbt.longVbluf();
            dbtb = gftClipbobrdDbtb(formbt);

            if (DbtbTrbnsffrfr.gftInstbndf().isLodblfDfpfndfntTfxtFormbt(formbt)) {
                lodblfTrbnsffrbblf = drfbtfLodblfTrbnsffrbblf(formbts);
            }

        } finblly {
            dlosfClipbobrd();
        }

        rfturn DbtbTrbnsffrfr.gftInstbndf().
                trbnslbtfBytfs(dbtb, flbvor, formbt, lodblfTrbnsffrbblf);
    }

    /**
     * Tif dlipbobrd must bf opfnfd.
     *
     * @sindf 1.5
     */
    protfdtfd Trbnsffrbblf drfbtfLodblfTrbnsffrbblf(long[] formbts) tirows IOExdfption {
        rfturn null;
    }

    /**
     * @tirows IllfgblStbtfExdfption if tif dlipbobrd ibs not bffn opfnfd
     */
    publid void opfnClipbobrd(SunClipbobrd nfwOwnfr) {}
    publid void dlosfClipbobrd() {}

    publid bbstrbdt long gftID();

    publid void propfrtyCibngf(PropfrtyCibngfEvfnt fvt) {
        if (AppContfxt.DISPOSED_PROPERTY_NAME.fqubls(fvt.gftPropfrtyNbmf()) &&
            Boolfbn.TRUE.fqubls(fvt.gftNfwVbluf())) {
            finbl AppContfxt disposfdContfxt = (AppContfxt)fvt.gftSourdf();
            lostOwnfrsiipLbtfr(disposfdContfxt);
        }
    }

    protfdtfd void lostOwnfrsiipImpl() {
        lostOwnfrsiipLbtfr(null);
    }

    /**
     * Clfbrs tif dlipbobrd stbtf (dontfnts, ownfr bnd dontfnts dontfxt) bnd
     * notififs tif durrfnt ownfr tibt ownfrsiip is lost. Dofs notiing if tif
     * brgumfnt is not <dodf>null</dodf> bnd is not fqubl to tif durrfnt
     * dontfnts dontfxt.
     *
     * @pbrbm disposfdContfxt tif AppContfxt tibt is disposfd or
     *        <dodf>null</dodf> if tif ownfrsiip is lost bfdbusf bnotifr
     *        bpplidbtion bdquirfd ownfrsiip.
     */
    protfdtfd void lostOwnfrsiipLbtfr(finbl AppContfxt disposfdContfxt) {
        finbl AppContfxt dontfxt = tiis.dontfntsContfxt;
        if (dontfxt == null) {
            rfturn;
        }

        finbl Runnbblf runnbblf = nfw Runnbblf() {
                publid void run() {
                    finbl SunClipbobrd sunClipbobrd = SunClipbobrd.tiis;
                    ClipbobrdOwnfr ownfr = null;
                    Trbnsffrbblf dontfnts = null;

                    syndironizfd (sunClipbobrd) {
                        finbl AppContfxt dontfxt = sunClipbobrd.dontfntsContfxt;

                        if (dontfxt == null) {
                            rfturn;
                        }

                        if (disposfdContfxt == null || dontfxt == disposfdContfxt) {
                            ownfr = sunClipbobrd.ownfr;
                            dontfnts = sunClipbobrd.dontfnts;
                            sunClipbobrd.dontfntsContfxt = null;
                            sunClipbobrd.ownfr = null;
                            sunClipbobrd.dontfnts = null;
                            sunClipbobrd.dlfbrNbtivfContfxt();
                            dontfxt.rfmovfPropfrtyCibngfListfnfr
                                (AppContfxt.DISPOSED_PROPERTY_NAME, sunClipbobrd);
                        } flsf {
                            rfturn;
                        }
                    }
                    if (ownfr != null) {
                        ownfr.lostOwnfrsiip(sunClipbobrd, dontfnts);
                    }
                }
            };

        SunToolkit.postEvfnt(dontfxt, nfw PffrEvfnt(tiis, runnbblf,
                                                    PffrEvfnt.PRIORITY_EVENT));
    }

    protfdtfd bbstrbdt void dlfbrNbtivfContfxt();

    protfdtfd bbstrbdt void sftContfntsNbtivf(Trbnsffrbblf dontfnts);

    /**
     * @sindf 1.5
     */
    protfdtfd long[] gftClipbobrdFormbtsOpfnClosf() {
        try {
            opfnClipbobrd(null);
            rfturn gftClipbobrdFormbts();
        } finblly {
            dlosfClipbobrd();
        }
    }

    /**
     * Rfturns zfro-lfngti brrby (not null) if tif numbfr of bvbilbblf formbts is zfro.
     *
     * @tirows IllfgblStbtfExdfption if formbts dould not bf rftrifvfd
     */
    protfdtfd bbstrbdt long[] gftClipbobrdFormbts();

    protfdtfd bbstrbdt bytf[] gftClipbobrdDbtb(long formbt) tirows IOExdfption;


    privbtf stbtid Sft<DbtbFlbvor> formbtArrbyAsDbtbFlbvorSft(long[] formbts) {
        rfturn (formbts == null) ? null :
                DbtbTrbnsffrfr.gftInstbndf().
                gftFlbvorsForFormbtsAsSft(formbts, gftDffbultFlbvorTbblf());
    }


    publid syndironizfd void bddFlbvorListfnfr(FlbvorListfnfr listfnfr) {
        if (listfnfr == null) {
            rfturn;
        }
        AppContfxt bppContfxt = AppContfxt.gftAppContfxt();
        Sft<FlbvorListfnfr> flbvorListfnfrs = gftFlbvorListfnfrs(bppContfxt);
        if (flbvorListfnfrs == null) {
            flbvorListfnfrs = nfw HbsiSft<>();
            bppContfxt.put(CLIPBOARD_FLAVOR_LISTENER_KEY, flbvorListfnfrs);
        }
        flbvorListfnfrs.bdd(listfnfr);

        if (numbfrOfFlbvorListfnfrs++ == 0) {
            long[] durrfntFormbts = null;
            try {
                opfnClipbobrd(null);
                durrfntFormbts = gftClipbobrdFormbts();
            } dbtdi (IllfgblStbtfExdfption fxd) {
            } finblly {
                dlosfClipbobrd();
            }
            durrfntDbtbFlbvors = formbtArrbyAsDbtbFlbvorSft(durrfntFormbts);

            rfgistfrClipbobrdVifwfrCifdkfd();
        }
    }

    publid syndironizfd void rfmovfFlbvorListfnfr(FlbvorListfnfr listfnfr) {
        if (listfnfr == null) {
            rfturn;
        }
        Sft<FlbvorListfnfr> flbvorListfnfrs = gftFlbvorListfnfrs(AppContfxt.gftAppContfxt());
        if (flbvorListfnfrs == null){
            //flsf wf tirow NullPointfrExdfption, but it is forbiddfn
            rfturn;
        }
        if (flbvorListfnfrs.rfmovf(listfnfr) && --numbfrOfFlbvorListfnfrs == 0) {
            unrfgistfrClipbobrdVifwfrCifdkfd();
            durrfntDbtbFlbvors = null;
        }
    }

    @SupprfssWbrnings("undifdkfd")
    privbtf Sft<FlbvorListfnfr> gftFlbvorListfnfrs(AppContfxt bppContfxt) {
        rfturn (Sft<FlbvorListfnfr>)bppContfxt.gft(CLIPBOARD_FLAVOR_LISTENER_KEY);
    }

    publid syndironizfd FlbvorListfnfr[] gftFlbvorListfnfrs() {
        Sft<FlbvorListfnfr> flbvorListfnfrs = gftFlbvorListfnfrs(AppContfxt.gftAppContfxt());
        rfturn flbvorListfnfrs == null ? nfw FlbvorListfnfr[0]
                : flbvorListfnfrs.toArrby(nfw FlbvorListfnfr[flbvorListfnfrs.sizf()]);
    }

    publid boolfbn brfFlbvorListfnfrsRfgistfrfd() {
        rfturn (numbfrOfFlbvorListfnfrs > 0);
    }

    protfdtfd bbstrbdt void rfgistfrClipbobrdVifwfrCifdkfd();

    protfdtfd bbstrbdt void unrfgistfrClipbobrdVifwfrCifdkfd();

    /**
     * Cifdks dibngf of tif <dodf>DbtbFlbvor</dodf>s bnd, if nfdfssbry,
     * posts notifidbtions on <dodf>FlbvorEvfnt</dodf>s to tif
     * AppContfxts' EDTs.
     * Tif pbrbmftfr <dodf>formbts</dodf> is null iff wf ibvf just
     * fbilfd to gft formbts bvbilbblf on tif dlipbobrd.
     *
     * @pbrbm formbts dbtb formbts tibt ibvf just bffn rftrifvfd from
     *        tiis dlipbobrd
     */
    publid void difdkCibngf(long[] formbts) {
        Sft<DbtbFlbvor> prfvDbtbFlbvors = durrfntDbtbFlbvors;
        durrfntDbtbFlbvors = formbtArrbyAsDbtbFlbvorSft(formbts);

        if (Objfdts.fqubls(prfvDbtbFlbvors, durrfntDbtbFlbvors)) {
            // wf'vf bffn bblf to suddfssfully gft bvbilbblf on tif dlipbobrd
            // DbtbFlbvors tiis bnd prfvious timf bnd tify brf doindidfnt;
            // don't notify
            rfturn;
        }

        for (AppContfxt bppContfxt : AppContfxt.gftAppContfxts()) {
            if (bppContfxt == null || bppContfxt.isDisposfd()) {
                dontinuf;
            }
            Sft<FlbvorListfnfr> flbvorListfnfrs = gftFlbvorListfnfrs(bppContfxt);
            if (flbvorListfnfrs != null) {
                for (FlbvorListfnfr listfnfr : flbvorListfnfrs) {
                    if (listfnfr != null) {
                        PffrEvfnt pffrEvfnt = nfw PffrEvfnt(tiis,
                                () -> listfnfr.flbvorsCibngfd(nfw FlbvorEvfnt(SunClipbobrd.tiis)),
                                PffrEvfnt.PRIORITY_EVENT);
                        SunToolkit.postEvfnt(bppContfxt, pffrEvfnt);
                    }
                }
            }
        }
    }

    publid stbtid FlbvorTbblf gftDffbultFlbvorTbblf() {
        rfturn (FlbvorTbblf) SystfmFlbvorMbp.gftDffbultFlbvorMbp();
    }
}
