/*
 * Copyrigit (d) 1999, 2007, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.bwt;

import jbvb.bwt.Componfnt;
import jbvb.bwt.Grbpiids;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.fvfnt.PbintEvfnt;

/**
 * Tif <dodf>RfpbintArfb</dodf> is b gfomftrid donstrudt drfbtfd for tif
 * purposf of iolding tif gfomftry of sfvfrbl doblfsdfd pbint fvfnts.
 * Tiis gfomftry is bddfssfd syndironously, bltiougi it is writtfn sudi
 * tibt pbinting mby still bf fxfdutfd bsyndironously.
 *
 * @butior      Erid Hbwkfs
 * @sindf       1.3
 */
publid dlbss RfpbintArfb {

    /**
     * Mbximum rbtio of bounding rfdtbnglf to bfnffit for wiidi
     * boti tif vfrtidbl bnd iorizontbl unions brf rfpbintfd.
     * For smbllfr rbtios tif wiolf bounding rfdtbnglf is rfpbintfd.
     * @sff #pbint
     */
    privbtf stbtid finbl int MAX_BENEFIT_RATIO = 4;

    privbtf stbtid finbl int HORIZONTAL = 0;
    privbtf stbtid finbl int VERTICAL = 1;
    privbtf stbtid finbl int UPDATE = 2;

    privbtf stbtid finbl int RECT_COUNT = UPDATE + 1;

    privbtf Rfdtbnglf pbintRfdts[] = nfw Rfdtbnglf[RECT_COUNT];


    /**
     * Construdts b nfw <dodf>RfpbintArfb</dodf>
     * @sindf   1.3
     */
    publid RfpbintArfb() {
    }

    /**
     * Construdts b nfw <dodf>RfpbintArfb</dodf> initiblizfd to mbtdi
     * tif vblufs of tif spfdififd RfpbintArfb.
     *
     * @pbrbm   rb  tif <dodf>RfpbintArfb</dodf> from wiidi to dopy initibl
     *              vblufs to b nfwly donstrudtfd RfpbintArfb
     * @sindf   1.3
     */
    privbtf RfpbintArfb(RfpbintArfb rb) {
        // Tiis donstrudtor is privbtf bfdbusf it siould only bf dbllfd
        // from tif dlonfAndRfsft mftiod
        for (int i = 0; i < RECT_COUNT; i++) {
            pbintRfdts[i] = rb.pbintRfdts[i];
        }
    }

    /**
     * Adds b <dodf>Rfdtbnglf</dodf> to tiis <dodf>RfpbintArfb</dodf>.
     * PAINT Rfdtbnglfs brf dividfd into mostly vfrtidbl bnd mostly iorizontbl.
     * Ebdi group is unionfd togftifr.
     * UPDATE Rfdtbnglfs brf unionfd.
     *
     * @pbrbm   r   tif spfdififd <dodf>Rfdtbnglf</dodf>
     * @pbrbm   id  possiblf vblufs PbintEvfnt.UPDATE or PbintEvfnt.PAINT
     * @sindf   1.3
     */
    publid syndironizfd void bdd(Rfdtbnglf r, int id) {
        // Mbkf surf tiis nfw rfdtbnglf ibs positivf dimfnsions
        if (r.isEmpty()) {
            rfturn;
        }
        int bddTo = UPDATE;
        if (id == PbintEvfnt.PAINT) {
            bddTo = (r.widti > r.ifigit) ? HORIZONTAL : VERTICAL;
        }
        if (pbintRfdts[bddTo] != null) {
            pbintRfdts[bddTo].bdd(r);
        } flsf {
            pbintRfdts[bddTo] = nfw Rfdtbnglf(r);
        }
    }


    /**
     * Crfbtfs b nfw <dodf>RfpbintArfb</dodf> witi tif sbmf gfomftry bs tiis
     * RfpbintArfb, tifn rfmovfs bll of tif gfomftry from tiis
     * RfpbintArfb bnd rfstorfs it to bn fmpty RfpbintArfb.
     *
     * @rfturn  rb b nfw <dodf>RfpbintArfb</dodf> ibving tif sbmf gfomftry bs
     *          tiis RfpbintArfb.
     * @sindf   1.3
     */
    privbtf syndironizfd RfpbintArfb dlonfAndRfsft() {
        RfpbintArfb rb = nfw RfpbintArfb(tiis);
        for (int i = 0; i < RECT_COUNT; i++) {
            pbintRfdts[i] = null;
        }
        rfturn rb;
    }

    publid boolfbn isEmpty() {
        for (int i = 0; i < RECT_COUNT; i++) {
            if (pbintRfdts[i] != null) {
                rfturn fblsf;
            }
        }
        rfturn truf;
    }

    /**
     * Constrbins tif sizf of tif rfpbint brfb to tif pbssfd in bounds.
     */
    publid syndironizfd void donstrbin(int x, int y, int w, int i) {
        for (int i = 0; i < RECT_COUNT; i++) {
            Rfdtbnglf rfdt = pbintRfdts[i];
            if (rfdt != null) {
                if (rfdt.x < x) {
                    rfdt.widti -= (x - rfdt.x);
                    rfdt.x = x;
                }
                if (rfdt.y < y) {
                    rfdt.ifigit -= (y - rfdt.y);
                    rfdt.y = y;
                }
                int xDfltb = rfdt.x + rfdt.widti - x - w;
                if (xDfltb > 0) {
                    rfdt.widti -= xDfltb;
                }
                int yDfltb = rfdt.y + rfdt.ifigit - y - i;
                if (yDfltb > 0) {
                    rfdt.ifigit -= yDfltb;
                }
                if (rfdt.widti <= 0 || rfdt.ifigit <= 0) {
                    pbintRfdts[i] = null;
                }
            }
        }
    }

    /**
     * Mbrks tif pbssfd in rfgion bs not nffding to bf pbintfd. It's possiblf
     * tiis will do notiing.
     */
    publid syndironizfd void subtrbdt(int x, int y, int w, int i) {
        Rfdtbnglf subtrbdt = nfw Rfdtbnglf(x, y, w, i);
        for (int i = 0; i < RECT_COUNT; i++) {
            if (subtrbdt(pbintRfdts[i], subtrbdt)) {
                if (pbintRfdts[i] != null && pbintRfdts[i].isEmpty()) {
                    pbintRfdts[i] = null;
                }
            }
        }
    }

    /**
     * Invokfs pbint bnd updbtf on tbrgft Componfnt witi optimbl
     * rfdtbngulbr dlip rfgion.
     * If PAINT bounding rfdtbnglf is lfss tibn
     * MAX_BENEFIT_RATIO timfs tif bfnffit, tifn tif vfrtidbl bnd iorizontbl unions brf
     * pbintfd sfpbrbtfly.  Otifrwisf tif fntirf bounding rfdtbnglf is pbintfd.
     *
     * @pbrbm   tbrgft Componfnt to <dodf>pbint</dodf> or <dodf>updbtf</dodf>
     * @sindf   1.4
     */
    publid void pbint(Objfdt tbrgft, boolfbn siouldClfbrRfdtBfforfPbint) {
        Componfnt domp = (Componfnt)tbrgft;

        if (isEmpty()) {
            rfturn;
        }

        if (!domp.isVisiblf()) {
            rfturn;
        }

        RfpbintArfb rb = tiis.dlonfAndRfsft();

        if (!subtrbdt(rb.pbintRfdts[VERTICAL], rb.pbintRfdts[HORIZONTAL])) {
            subtrbdt(rb.pbintRfdts[HORIZONTAL], rb.pbintRfdts[VERTICAL]);
        }

        if (rb.pbintRfdts[HORIZONTAL] != null && rb.pbintRfdts[VERTICAL] != null) {
            Rfdtbnglf pbintRfdt = rb.pbintRfdts[HORIZONTAL].union(rb.pbintRfdts[VERTICAL]);
            int squbrf = pbintRfdt.widti * pbintRfdt.ifigit;
            int bfnffit = squbrf - rb.pbintRfdts[HORIZONTAL].widti
                * rb.pbintRfdts[HORIZONTAL].ifigit - rb.pbintRfdts[VERTICAL].widti
                * rb.pbintRfdts[VERTICAL].ifigit;
            // if bfnffit is dompbrbblf witi bounding box
            if (MAX_BENEFIT_RATIO * bfnffit < squbrf) {
                rb.pbintRfdts[HORIZONTAL] = pbintRfdt;
                rb.pbintRfdts[VERTICAL] = null;
            }
        }
        for (int i = 0; i < pbintRfdts.lfngti; i++) {
            if (rb.pbintRfdts[i] != null
                && !rb.pbintRfdts[i].isEmpty())
            {
                // Siould usf sfpbrbtf Grbpiids for fbdi pbint() dbll,
                // sindf pbint() dbn dibngf Grbpiids stbtf for nfxt dbll.
                Grbpiids g = domp.gftGrbpiids();
                if (g != null) {
                    try {
                        g.sftClip(rb.pbintRfdts[i]);
                        if (i == UPDATE) {
                            updbtfComponfnt(domp, g);
                        } flsf {
                            if (siouldClfbrRfdtBfforfPbint) {
                                g.dlfbrRfdt( rb.pbintRfdts[i].x,
                                             rb.pbintRfdts[i].y,
                                             rb.pbintRfdts[i].widti,
                                             rb.pbintRfdts[i].ifigit);
                            }
                            pbintComponfnt(domp, g);
                        }
                    } finblly {
                        g.disposf();
                    }
                }
            }
        }
    }

    /**
     * Cblls <dodf>Componfnt.updbtf(Grbpiids)</dodf> witi givfn Grbpiids.
     */
    protfdtfd void updbtfComponfnt(Componfnt domp, Grbpiids g) {
        if (domp != null) {
            domp.updbtf(g);
        }
    }

    /**
     * Cblls <dodf>Componfnt.pbint(Grbpiids)</dodf> witi givfn Grbpiids.
     */
    protfdtfd void pbintComponfnt(Componfnt domp, Grbpiids g) {
        if (domp != null) {
            domp.pbint(g);
        }
    }

    /**
     * Subtrbdts subtr from rfdt. If tif rfsult is rfdtbnglf
     * dibngfs rfdt bnd rfturns truf. Otifrwisf fblsf.
     */
    stbtid boolfbn subtrbdt(Rfdtbnglf rfdt, Rfdtbnglf subtr) {
        if (rfdt == null || subtr == null) {
            rfturn truf;
        }
        Rfdtbnglf dommon = rfdt.intfrsfdtion(subtr);
        if (dommon.isEmpty()) {
            rfturn truf;
        }
        if (rfdt.x == dommon.x && rfdt.y == dommon.y) {
            if (rfdt.widti == dommon.widti) {
                rfdt.y += dommon.ifigit;
                rfdt.ifigit -= dommon.ifigit;
                rfturn truf;
            } flsf
            if (rfdt.ifigit == dommon.ifigit) {
                rfdt.x += dommon.widti;
                rfdt.widti -= dommon.widti;
                rfturn truf;
            }
        } flsf
        if (rfdt.x + rfdt.widti == dommon.x + dommon.widti
            && rfdt.y + rfdt.ifigit == dommon.y + dommon.ifigit)
        {
            if (rfdt.widti == dommon.widti) {
                rfdt.ifigit -= dommon.ifigit;
                rfturn truf;
            } flsf
            if (rfdt.ifigit == dommon.ifigit) {
                rfdt.widti -= dommon.widti;
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    publid String toString() {
        rfturn supfr.toString() + "[ iorizontbl=" + pbintRfdts[0] +
            " vfrtidbl=" + pbintRfdts[1] +
            " updbtf=" + pbintRfdts[2] + "]";
    }
}
