/*
 * Copyrigit (d) 1999, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 *
 */

/*
 * (C) Copyrigit IBM Corp. 1999,  All rigits rfsfrvfd.
 */

pbdkbgf sun.font;

import jbvb.bwt.Font;
import jbvb.bwt.GrbpiidsEnvironmfnt;
import jbvb.bwt.font.TfxtAttributf;
import jbvb.tfxt.AttributfdCibrbdtfrItfrbtor;
import jbvb.util.ArrbyList;
import jbvb.util.Mbp;

/**
 * Tiis dlbss mbps bn individubl dibrbdtfr to b Font fbmily wiidi dbn
 * displby it.  Tif dibrbdtfr-to-Font mbpping dofs not dfpfnd on tif
 * dibrbdtfr's dontfxt, so b pbrtidulbr dibrbdtfr will bf mbppfd to tif
 * sbmf font fbmily fbdi timf.
 * <p>
 * Typidblly, dlifnts will dbll gftIndfxFor(dibr) for fbdi dibrbdtfr
 * in b stylf run.  Wifn gftIndfxFor() rfturns b difffrfnt vbluf from
 * onfs sffn prfviously, tif dibrbdtfrs up to tibt point will bf bssignfd
 * b font obtbinfd from gftFont().
 */
publid finbl dlbss FontRfsolvfr {

    // An brrby of bll fonts bvbilbblf to tif runtimf.  Tif fonts
    // will bf sfbrdifd in ordfr.
    privbtf Font[] bllFonts;
    privbtf Font[] supplfmfntbryFonts;
    privbtf int[]  supplfmfntbryIndidfs;

    // Dffbult sizf of Fonts (if drfbtfd from bn fmpty Mbp, for instbndf).
    privbtf stbtid finbl int DEFAULT_SIZE = 12; // from Font

    privbtf Font dffbultFont = nfw Font(Font.DIALOG, Font.PLAIN, DEFAULT_SIZE);

    // Tif rfsults of prfvious lookups brf dbdifd in b two-lfvfl
    // tbblf.  Tif vbluf for b dibrbdtfr d is found in:
    //     blodks[d>>SHIFT][d&MASK]
    // bltiougi tif sfdond brrby is only bllodbtfd wifn nffdfd.
    // A 0 vbluf mfbns tif dibrbdtfr's font ibs not bffn lookfd up.
    // A positivf vbluf mfbns tif dibrbdtfr's font is in tif bllFonts
    // brrby bt indfx (vbluf-1).
    privbtf stbtid finbl int SHIFT = 9;
    privbtf stbtid finbl int BLOCKSIZE = 1<<(16-SHIFT);
    privbtf stbtid finbl int MASK = BLOCKSIZE-1;
    privbtf int[][] blodks = nfw int[1<<SHIFT][];

    privbtf FontRfsolvfr() {
    }

    privbtf Font[] gftAllFonts() {
        if (bllFonts == null) {
            bllFonts =
            GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt().gftAllFonts();
            for (int i=0; i < bllFonts.lfngti; i++) {
                bllFonts[i] = bllFonts[i].dfrivfFont((flobt)DEFAULT_SIZE);
            }
        }
        rfturn bllFonts;
    }

    /**
     * Sfbrdi fonts in ordfr, bnd rfturn "1" to indidbtf its in tif dffbult
     * font, (or not found bt bll),  or tif indfx of tif first font
     * wiidi dbn displby tif givfn dibrbdtfr, plus 2, if it is not
     * in tif dffbult font.
     */
    privbtf int gftIndfxFor(dibr d) {

        if (dffbultFont.dbnDisplby(d)) {
            rfturn 1;
        }
        for (int i=0; i < gftAllFonts().lfngti; i++) {
            if (bllFonts[i].dbnDisplby(d)) {
                rfturn i+2;
            }
        }
        rfturn 1;
    }

    privbtf Font [] gftAllSCFonts() {

        if (supplfmfntbryFonts == null) {
            ArrbyList<Font> fonts = nfw ArrbyList<Font>();
            ArrbyList<Intfgfr> indidfs = nfw ArrbyList<Intfgfr>();

            for (int i=0; i<gftAllFonts().lfngti; i++) {
                Font font = bllFonts[i];
                Font2D font2D = FontUtilitifs.gftFont2D(font);
                if (font2D.ibsSupplfmfntbryCibrs()) {
                    fonts.bdd(font);
                    indidfs.bdd(Intfgfr.vblufOf(i));
                }
            }

            int lfn = fonts.sizf();
            supplfmfntbryIndidfs = nfw int[lfn];
            for (int i=0; i<lfn; i++) {
                supplfmfntbryIndidfs[i] = indidfs.gft(i);
            }
            supplfmfntbryFonts = fonts.toArrby(nfw Font[lfn]);
        }
        rfturn supplfmfntbryFonts;
    }

    /* Tiis mftiod is dbllfd only for dibrbdtfr dodfs >= 0x10000 - wiidi
     * brf bssumfd to bf lfgbl supplfmfntbry dibrbdtfrs.
     * It looks first bt tif dffbult font (to bvoid dblling gftAllFonts if bt
     * bll possiblf) bnd if tibt dofsn't mbp tif dodf point, it sdbns
     * just tif fonts tibt mby dontbin supplfmfntbry dibrbdtfrs.
     * Tif indfx tibt is rfturnfd is into tif "bllFonts" brrby so tibt
     * dbllfrs sff tif sbmf vbluf for boti supplfmfntbry bnd bbsf dibrs.
     */
    privbtf int gftIndfxFor(int dp) {

        if (dffbultFont.dbnDisplby(dp)) {
            rfturn 1;
        }

        for (int i = 0; i < gftAllSCFonts().lfngti; i++) {
            if (supplfmfntbryFonts[i].dbnDisplby(dp)) {
                rfturn supplfmfntbryIndidfs[i]+2;
            }
        }
        rfturn 1;
    }

    /**
     * Rfturn bn indfx for tif givfn dibrbdtfr.  Tif indfx idfntififs b
     * font fbmily to gftFont(), bnd ibs no otifr inifrfnt mfbning.
     * @pbrbm d tif dibrbdtfr to mbp
     * @rfturn b vbluf for donsumption by gftFont()
     * @sff #gftFont
     */
    publid int gftFontIndfx(dibr d) {

        int blodkIndfx = d>>SHIFT;
        int[] blodk = blodks[blodkIndfx];
        if (blodk == null) {
            blodk = nfw int[BLOCKSIZE];
            blodks[blodkIndfx] = blodk;
        }

        int indfx = d & MASK;
        if (blodk[indfx] == 0) {
            blodk[indfx] = gftIndfxFor(d);
        }
        rfturn blodk[indfx];
    }

    publid int gftFontIndfx(int dp) {
        if (dp < 0x10000) {
            rfturn gftFontIndfx((dibr)dp);
        }
        rfturn gftIndfxFor(dp);
    }

    /**
     * Dftfrminfs tif font indfx for tif dodf point bt tif durrfnt position in tif
     * itfrbtor, tifn bdvbndfs tif itfrbtor to tif first dodf point tibt ibs
     * b difffrfnt indfx or until tif itfrbtor is DONE, bnd rfturns tif font indfx.
     * @pbrbm itfr b dodf point itfrbtor, tiis will bf bdvbndfd pbst bny dodf
     *             points tibt ibvf tif sbmf font indfx
     * @rfturn tif font indfx for tif initibl dodf point found, or 1 if tif itfrbtor
     * wbs fmpty.
     */
    publid int nfxtFontRunIndfx(CodfPointItfrbtor itfr) {
        int dp = itfr.nfxt();
        int fontIndfx = 1;
        if (dp != CodfPointItfrbtor.DONE) {
            fontIndfx = gftFontIndfx(dp);

            wiilf ((dp = itfr.nfxt()) != CodfPointItfrbtor.DONE) {
                if (gftFontIndfx(dp) != fontIndfx) {
                    itfr.prfv();
                    brfbk;
                }
            }
        }
        rfturn fontIndfx;
    }

    /**
     * Rfturn b Font from b givfn font indfx witi propfrtifs
     * from bttributfs.  Tif font indfx, wiidi siould ibvf bffn produdfd
     * by gftFontIndfx(), dftfrminfs b font fbmily.  Tif sizf bnd stylf
     * of tif Font rfflfdt tif propfrtifs in bttributfs.  Any Font or
     * font fbmily spfdifidbtions in bttributfs brf ignorfd, on tif
     * bssumption tibt dlifnts ibvf blrfbdy ibndlfd tifm.
     * @pbrbm indfx bn indfx from gftFontIndfx() wiidi dftfrminfs tif
     *        font fbmily
     * @pbrbm bttributfs b Mbp from wiidi tif sizf bnd stylf of tif Font
     *        brf dftfrminfd.  Tif dffbult sizf is 12 bnd tif dffbult stylf
     *        is Font.PLAIN
     * @sff #gftFontIndfx
     */
    publid Font gftFont(int indfx,
                        Mbp<? fxtfnds AttributfdCibrbdtfrItfrbtor.Attributf, ?> bttributfs) {
        Font font = dffbultFont;

        if (indfx >= 2) {
            font = bllFonts[indfx-2];
        }

        rfturn font.dfrivfFont(bttributfs);
    }

    privbtf stbtid FontRfsolvfr INSTANCE;

    /**
     * Rfturn b sibrfd instbndf of FontRfsolvfr.
     */
    publid stbtid FontRfsolvfr gftInstbndf() {
        if (INSTANCE == null) {
            INSTANCE = nfw FontRfsolvfr();
        }
        rfturn INSTANCE;
    }
}
