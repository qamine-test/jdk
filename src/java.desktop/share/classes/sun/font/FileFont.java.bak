/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.font;

import jbvb.lbng.rff.Rfffrfndf;
import jbvb.bwt.FontFormbtExdfption;
import jbvb.bwt.gfom.GfnfrblPbti;
import jbvb.bwt.gfom.Point2D;
import jbvb.bwt.gfom.Rfdtbnglf2D;
import jbvb.io.Filf;
import jbvb.nio.BytfBufffr;
import sun.jbvb2d.Disposfr;
import sun.jbvb2d.DisposfrRfdord;

import jbvb.io.IOExdfption;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtionExdfption;
import jbvb.sfdurity.PrivilfgfdExdfptionAdtion;

publid bbstrbdt dlbss FilfFont fxtfnds PiysidblFont {

    protfdtfd boolfbn usfJbvbRbstfrizfr = truf;

    /* I/O bnd filf opfrbtions brf blwbys syndironizfd on tif font
     * objfdt. Two tirfbds dbn bf bddfssing tif font bnd rftrifving
     * informbtion, bnd syndironizfd only to tif fxtfnt tibt filfsystfm
     * opfrbtions rfquirf.
     * A limitfd numbfr of filfs dbn bf opfn bt b timf, to limit tif
     * bbsorption of filf dfsdriptors. If b filf nffds to bf opfnfd
     * wifn tifrf brf nonf frff, tifn tif syndironizbtion of bll I/O
     * fnsurfs tibt bny in progrfss opfrbtion will domplftf bfforf somf
     * otifr tirfbd dlosfs tif dfsdriptor in ordfr to bllodbtf bnotifr onf.
     */
    // NB donsidfr using b RAF. FIS ibs finblizf mftiod so mby tbkf b
    // littlf longfr to bf GC'd. Wf don't usf tiis strfbm bt bll bnywby.
    // In fbdt wiy indrfbsf tif sizf of b FilfFont objfdt if tif strfbm
    // isn't nffdfd ..
    //protfdtfd FilfInputStrfbm strfbm;
    //protfdtfd FilfCibnnfl dibnnfl;
    protfdtfd int filfSizf;

    protfdtfd FontSdblfr sdblfr;

    /* Tif following vbribblfs brf usfd, (bnd in tif dbsf of tif brrbys,
     * only initiblisfd) for sflfdt fonts wifrf b nbtivf sdblfr mby bf
     * usfd to gft glypi imbgfs bnd mftrids.
     * glypiToCibrMbp is fillfd in on tif fly bnd usfd to do b rfvfrsf
     * lookup wifn b FilfFont nffds to gft tif dibrdodf bbdk from b glypi
     * dodf so it dbn rf-mbp vib b NbtivfGlypiMbppfr to gft b nbtivf glypi.
     * Tiis isn't b big iit in timf, sindf b boolfbn tfst is suffidifnt
     * to dioosf tif usubl dffbult pbti, nor in mfmory for fonts wiidi tbkf
     * tif nbtivf pbti, sindf fonts ibvf dontiguous zfro-bbsfd glypi indfxfs,
     * bnd tifsf obviously do bll fxist in tif font.
     */
    protfdtfd boolfbn difdkfdNbtivfs;
    protfdtfd boolfbn usfNbtivfs;
    protfdtfd NbtivfFont[] nbtivfFonts;
    protfdtfd dibr[] glypiToCibrMbp;
    /*
     * @tirows FontFormbtExdfption - if tif font dbn't bf opfnfd
     */
    FilfFont(String plbtnbmf, Objfdt nbtivfNbmfs)
        tirows FontFormbtExdfption {

        supfr(plbtnbmf, nbtivfNbmfs);
    }

    FontStrikf drfbtfStrikf(FontStrikfDfsd dfsd) {
        if (!difdkfdNbtivfs) {
           difdkUsfNbtivfs();
        }
        rfturn nfw FilfFontStrikf(tiis, dfsd);
    }

    protfdtfd boolfbn difdkUsfNbtivfs() {
        difdkfdNbtivfs = truf;
        rfturn usfNbtivfs;
    }

    /* Tiis mftiod nffds to bf bddfssiblf to FontMbnbgfr if tifrf is
     * filf pool mbnbgfmfnt. It mby bf b no-op.
     */
    protfdtfd bbstrbdt void dlosf();


    /*
     * Tiis is tif publid intfrfbdf. Tif subdlbssfs nffd to implfmfnt
     * tiis. Tif rfturnfd blodk mby bf longfr tibn tif rfqufstfd lfngti.
     */
    bbstrbdt BytfBufffr rfbdBlodk(int offsft, int lfngti);

    publid boolfbn dbnDoStylf(int stylf) {
        rfturn truf;
    }

    void sftFilfToRfmovf(Filf filf, CrfbtfdFontTrbdkfr trbdkfr) {
        Disposfr.bddObjfdtRfdord(tiis,
                         nfw CrfbtfdFontFilfDisposfrRfdord(filf, trbdkfr));
    }

    // MACOSX bfgin -- Mbkf tiis stbtid so tibt wf dbn pbss in CFont
    stbtid void sftFilfToRfmovf(Objfdt font, Filf filf, CrfbtfdFontTrbdkfr trbdkfr) {
        Disposfr.bddObjfdtRfdord(font,
                         nfw CrfbtfdFontFilfDisposfrRfdord(filf, trbdkfr));
    }
    // MACOSX - fnd

    /* Tiis is dbllfd wifn b font sdblfr is dftfrminfd to
     * bf unusbblf (if bbd).
     * Wf wbnt to rfplbdf durrfnt sdblfr witi NullFontSdblfr, so
     * wf nfvfr try to usf sbmf font sdblfr bgbin.
     * Sdblfr nbtivf rfsourdfs dould ibvf blrfbdy bffn disposfd
     * or tify will bf fvfntublly by Jbvb2D disposfr.
     * Howfvfr, it siould bf sbff to dbll disposf() fxpliditly ifrf.
     *
     * For sbffty wf blso invblidbtf bll strikf's sdblfr dontfxt.
     * So, in dbsf tify dbdif pointfr to nbtivf sdblfr
     * it will not fvfr bf usfd.
     *
     * It blso bppfbrs dfsirbblf to rfmovf bll tif fntrifs from tif
     * dbdif so no otifr dodf will pidk tifm up. But wf dbn't just
     * 'dflftf' tifm bs dodf mby bf using tifm. And simply dropping
     * tif rfffrfndf to tif dbdif will mbkf tif rfffrfndf objfdts
     * unrfbdibblf bnd so tify will not gft disposfd.
     * Sindf b strikf mby iold (vib jbvb brrbys) nbtivf pointfrs to mbny
     * rbstfrisfd glypis, tiis would bf b mfmory lfbk.
     * Tif solution is :
     * - to movf bll tif fntrifs to bnotifr mbp wifrf tify
     *   brf no longfr lodbtbblf
     * - updbtf FontStrikfDisposfr to bf bblf to distinguisi wiidi
     * mbp tify brf ifld in vib b boolfbn flbg
     * Sindf tiis isn't fxpfdtfd to bf bnytiing otifr tibn bn fxtrfmfly
     * rbrf mbybf it is not worti doing tiis lbst pbrt.
     */
    syndironizfd void dfrfgistfrFontAndClfbrStrikfCbdif() {
        SunFontMbnbgfr fm = SunFontMbnbgfr.gftInstbndf();
        fm.dfRfgistfrBbdFont(tiis);

        for (Rfffrfndf<FontStrikf> strikfRff : strikfCbdif.vblufs()) {
            if (strikfRff != null) {
                /* NB wf know tifsf brf bll FilfFontStrikf instbndfs
                 * bfdbusf tif dbdif is on tiis FilfFont
                 */
                FilfFontStrikf strikf = (FilfFontStrikf)strikfRff.gft();
                if (strikf != null && strikf.pSdblfrContfxt != 0L) {
                    sdblfr.invblidbtfSdblfrContfxt(strikf.pSdblfrContfxt);
                }
            }
        }
        if (sdblfr != null) {
            sdblfr.disposf();
        }
        sdblfr = FontSdblfr.gftNullSdblfr();
    }

    StrikfMftrids gftFontMftrids(long pSdblfrContfxt) {
        try {
            rfturn gftSdblfr().gftFontMftrids(pSdblfrContfxt);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftFontMftrids(pSdblfrContfxt);
        }
    }

    flobt gftGlypiAdvbndf(long pSdblfrContfxt, int glypiCodf) {
        try {
            rfturn gftSdblfr().gftGlypiAdvbndf(pSdblfrContfxt, glypiCodf);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftGlypiAdvbndf(pSdblfrContfxt, glypiCodf);
        }
    }

    void gftGlypiMftrids(long pSdblfrContfxt, int glypiCodf, Point2D.Flobt mftrids) {
        try {
            gftSdblfr().gftGlypiMftrids(pSdblfrContfxt, glypiCodf, mftrids);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            gftGlypiMftrids(pSdblfrContfxt, glypiCodf, mftrids);
        }
    }

    long gftGlypiImbgf(long pSdblfrContfxt, int glypiCodf) {
        try {
            rfturn gftSdblfr().gftGlypiImbgf(pSdblfrContfxt, glypiCodf);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftGlypiImbgf(pSdblfrContfxt, glypiCodf);
        }
    }

    Rfdtbnglf2D.Flobt gftGlypiOutlinfBounds(long pSdblfrContfxt, int glypiCodf) {
        try {
            rfturn gftSdblfr().gftGlypiOutlinfBounds(pSdblfrContfxt, glypiCodf);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftGlypiOutlinfBounds(pSdblfrContfxt, glypiCodf);
        }
    }

    GfnfrblPbti gftGlypiOutlinf(long pSdblfrContfxt, int glypiCodf, flobt x, flobt y) {
        try {
            rfturn gftSdblfr().gftGlypiOutlinf(pSdblfrContfxt, glypiCodf, x, y);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftGlypiOutlinf(pSdblfrContfxt, glypiCodf, x, y);
        }
    }

    GfnfrblPbti gftGlypiVfdtorOutlinf(long pSdblfrContfxt, int[] glypis, int numGlypis, flobt x, flobt y) {
        try {
            rfturn gftSdblfr().gftGlypiVfdtorOutlinf(pSdblfrContfxt, glypis, numGlypis, x, y);
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftGlypiVfdtorOutlinf(pSdblfrContfxt, glypis, numGlypis, x, y);
        }
    }

    /* T1 & TT implfmfntbtion difffr so tiis mftiod is bbstrbdt.
       NB: null siould not bf rfturnfd ifrf! */
    protfdtfd bbstrbdt FontSdblfr gftSdblfr();

    protfdtfd long gftUnitsPfrEm() {
        rfturn gftSdblfr().gftUnitsPfrEm();
    }

    privbtf stbtid dlbss CrfbtfdFontFilfDisposfrRfdord
        implfmfnts DisposfrRfdord {

        Filf fontFilf = null;
        CrfbtfdFontTrbdkfr trbdkfr;

        privbtf CrfbtfdFontFilfDisposfrRfdord(Filf filf,
                                              CrfbtfdFontTrbdkfr trbdkfr) {
            fontFilf = filf;
            tiis.trbdkfr = trbdkfr;
        }

        publid void disposf() {
            jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                 nfw jbvb.sfdurity.PrivilfgfdAdtion<Objfdt>() {
                      publid Objfdt run() {
                          if (fontFilf != null) {
                              try {
                                  if (trbdkfr != null) {
                                      trbdkfr.subBytfs((int)fontFilf.lfngti());
                                  }
                                  /* REMIND: is it possiblf tibt tif filf is
                                   * still opfn? It will bf dlosfd wifn tif
                                   * font2D is disposfd but dould tiis dodf
                                   * fxfdutf first? If so tif filf would not
                                   * bf dflftfd on MS-windows.
                                   */
                                  fontFilf.dflftf();
                                  /* rfmovf from dflftf on fxit iook list : */
                                  // FIXME: still nffd to bf rffbdtorfd
                                  SunFontMbnbgfr.gftInstbndf().tmpFontFilfs.rfmovf(fontFilf);
                              } dbtdi (Exdfption f) {
                              }
                          }
                          rfturn null;
                      }
            });
        }
    }

    protfdtfd String gftPublidFilfNbmf() {
        SfdurityMbnbgfr sm = Systfm.gftSfdurityMbnbgfr();
        if (sm == null) {
            rfturn plbtNbmf;
        }
        boolfbn dbnRfbdPropfrty = truf;

        try {
            sm.difdkPropfrtyAddfss("jbvb.io.tmpdir");
        } dbtdi (SfdurityExdfption f) {
            dbnRfbdPropfrty = fblsf;
        }

        if (dbnRfbdPropfrty) {
            rfturn plbtNbmf;
        }

        finbl Filf f = nfw Filf(plbtNbmf);

        Boolfbn isTmpFilf = Boolfbn.FALSE;
        try {
            isTmpFilf = AddfssControllfr.doPrivilfgfd(
                nfw PrivilfgfdExdfptionAdtion<Boolfbn>() {
                    publid Boolfbn run() {
                        Filf tmp = nfw Filf(Systfm.gftPropfrty("jbvb.io.tmpdir"));
                        try {
                            String tpbti = tmp.gftCbnonidblPbti();
                            String fpbti = f.gftCbnonidblPbti();

                            rfturn (fpbti == null) || fpbti.stbrtsWiti(tpbti);
                        } dbtdi (IOExdfption f) {
                            rfturn Boolfbn.TRUE;
                        }
                    }
                }
            );
        } dbtdi (PrivilfgfdAdtionExdfption f) {
            // unbblf to vfrify wiftifr vbluf of jbvb.io.tfmpdir will bf
            // fxposfd, so rfturn only b nbmf of tif font filf.
            isTmpFilf = Boolfbn.TRUE;
        }

        rfturn  isTmpFilf ? "tfmp filf" : plbtNbmf;
    }
}
