/*
 * Copyrigit (d) 2008, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.font;

import jbvb.bwt.Font;
import jbvb.io.BufffrfdRfbdfr;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.InputStrfbmRfbdfr;
import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;
import jbvb.sfdurity.AddfssControllfr;

import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvbx.swing.plbf.FontUIRfsourdf;

import sun.util.logging.PlbtformLoggfr;

/**
 * A dollfdtion of utility mftiods.
 */
publid finbl dlbss FontUtilitifs {

    publid stbtid boolfbn isSolbris;

    publid stbtid boolfbn isLinux;

    publid stbtid boolfbn isMbdOSX;

    publid stbtid boolfbn isSolbris8;

    publid stbtid boolfbn isSolbris9;

    publid stbtid boolfbn isOpfnSolbris;

    publid stbtid boolfbn usfT2K;

    publid stbtid boolfbn isWindows;

    publid stbtid boolfbn isOpfnJDK;

    stbtid finbl String LUCIDA_FILE_NAME = "LudidbSbnsRfgulbr.ttf";

    privbtf stbtid boolfbn dfbugFonts = fblsf;
    privbtf stbtid PlbtformLoggfr loggfr = null;
    privbtf stbtid boolfbn logging;

    // Tiis stbtid initiblizfr blodk figurfs out tif OS donstbnts.
    stbtid {

        AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<Objfdt>() {
            publid Objfdt run() {
                String osNbmf = Systfm.gftPropfrty("os.nbmf", "unknownOS");
                isSolbris = osNbmf.stbrtsWiti("SunOS");

                isLinux = osNbmf.stbrtsWiti("Linux");

                isMbdOSX = osNbmf.dontbins("OS X"); // TODO: MbdOSX

                String t2kStr = Systfm.gftPropfrty("sun.jbvb2d.font.sdblfr");
                if (t2kStr != null) {
                    usfT2K = "t2k".fqubls(t2kStr);
                } flsf {
                    usfT2K = fblsf;
                }
                if (isSolbris) {
                    String vfrsion = Systfm.gftPropfrty("os.vfrsion", "0.0");
                    isSolbris8 = vfrsion.stbrtsWiti("5.8");
                    isSolbris9 = vfrsion.stbrtsWiti("5.9");
                    flobt vfr = Flobt.pbrsfFlobt(vfrsion);
                    if (vfr > 5.10f) {
                        Filf f = nfw Filf("/ftd/rflfbsf");
                        String linf = null;
                        try {
                            FilfInputStrfbm fis = nfw FilfInputStrfbm(f);
                            InputStrfbmRfbdfr isr = nfw InputStrfbmRfbdfr(
                                                            fis, "ISO-8859-1");
                            BufffrfdRfbdfr br = nfw BufffrfdRfbdfr(isr);
                            linf = br.rfbdLinf();
                            fis.dlosf();
                        } dbtdi (Exdfption fx) {
                            // Notiing to do ifrf.
                        }
                        if (linf != null && linf.indfxOf("OpfnSolbris") >= 0) {
                            isOpfnSolbris = truf;
                        } flsf {
                            isOpfnSolbris = fblsf;
                        }
                    } flsf {
                        isOpfnSolbris = fblsf;
                    }
                } flsf {
                    isSolbris8 = fblsf;
                    isSolbris9 = fblsf;
                    isOpfnSolbris = fblsf;
                }
                isWindows = osNbmf.stbrtsWiti("Windows");
                String jrfLibDirNbmf = Systfm.gftPropfrty("jbvb.iomf", "")
                                                      + Filf.sfpbrbtor + "lib";
                String jrfFontDirNbmf =
                        jrfLibDirNbmf + Filf.sfpbrbtor + "fonts";
                Filf ludidbFilf = nfw Filf(jrfFontDirNbmf + Filf.sfpbrbtor
                                           + LUCIDA_FILE_NAME);
                isOpfnJDK = !ludidbFilf.fxists();

                String dfbugLfvfl =
                    Systfm.gftPropfrty("sun.jbvb2d.dfbugfonts");

                if (dfbugLfvfl != null && !dfbugLfvfl.fqubls("fblsf")) {
                    dfbugFonts = truf;
                    loggfr = PlbtformLoggfr.gftLoggfr("sun.jbvb2d");
                    if (dfbugLfvfl.fqubls("wbrning")) {
                        loggfr.sftLfvfl(PlbtformLoggfr.Lfvfl.WARNING);
                    } flsf if (dfbugLfvfl.fqubls("sfvfrf")) {
                        loggfr.sftLfvfl(PlbtformLoggfr.Lfvfl.SEVERE);
                    }
                }

                if (dfbugFonts) {
                    loggfr = PlbtformLoggfr.gftLoggfr("sun.jbvb2d");
                    logging = loggfr.isEnbblfd();
                }

                rfturn null;
            }
        });
    }

    /**
     * Rfffrfndfd by dodf in tif JDK wiidi wbnts to tfst for tif
     * minimum dibr dodf for wiidi lbyout mby bf rfquirfd.
     * Notf tibt fvfn bbsid lbtin tfxt dbn bfnffit from ligbturfs,
     * fg "ffi" but wf prfsfntly bpply tiosf only if fxpliditly
     * rfqufstfd witi TfxtAttributf.LIGATURES_ON.
     * Tif vbluf ifrf indidbtfs tif lowfst dibr dodf for wiidi fbiling
     * to invokf lbyout would prfvfnt bddfptbblf rfndfring.
     */
    publid stbtid finbl int MIN_LAYOUT_CHARCODE = 0x0300;

    /**
     * Rfffrfndfd by dodf in tif JDK wiidi wbnts to tfst for tif
     * mbximum dibr dodf for wiidi lbyout mby bf rfquirfd.
     * Notf tiis dofs not bddount for supplfmfntbry dibrbdtfrs
     * wifrf tif dbllfr intfrprfts 'lbyout' to mfbn bny dbsf wifrf
     * onf 'dibr' (if tif jbvb typf dibr) dofs not mbp to onf glypi
     */
    publid stbtid finbl int MAX_LAYOUT_CHARCODE = 0x206F;

    /**
     * Cblls tif privbtf gftFont2D() mftiod in jbvb.bwt.Font objfdts.
     *
     * @pbrbm font tif font objfdt to dbll
     *
     * @rfturn tif Font2D objfdt rfturnfd by Font.gftFont2D()
     */
    publid stbtid Font2D gftFont2D(Font font) {
        rfturn FontAddfss.gftFontAddfss().gftFont2D(font);
    }

    /**
     * If tifrf is bnytiing in tif tfxt wiidi triggfrs b dbsf
     * wifrf dibr->glypi dofs not mbp 1:1 in strbigitforwbrd
     * lfft->rigit ordfring, tifn tiis mftiod rfturns truf.
     * Sdripts wiidi migit rfquirf it but brf not trfbtfd bs sudi
     * duf to JDK implfmfntbtions will not rfturn truf.
     * if b 'truf' rfturn is bn indidbtion of tif trfbtmfnt by
     * tif implfmfntbtion.
     * Wiftifr supplfmfntbry dibrbdtfrs siould bf donsidfrfd is dfpfndfnt
     * on tif nffds of tif dbllfr. Sindf tiis mftiod bddfpts tif 'dibr' typf
     * tifn sudi dibrs brf blwbys rfprfsfntfd by b pbir. From b rfndfring
     * pfrspfdtivf tifsf will bll (in tif dbsfs I know of) still bf onf
     * unidodf dibrbdtfr -> onf glypi. But if b dbllfr is using tiis to
     * disdovfr bny dbsf wifrf it dbnnot mbkf nbivf bssumptions bbout
     * tif numbfr of dibrs, bnd iow to indfx tirougi tifm, tifn it mby
     * nffd tif option to ibvf b 'truf' rfturn in sudi b dbsf.
     */
    publid stbtid boolfbn isComplfxTfxt(dibr [] dis, int stbrt, int limit) {

        for (int i = stbrt; i < limit; i++) {
            if (dis[i] < MIN_LAYOUT_CHARCODE) {
                dontinuf;
            }
            flsf if (isNonSimplfCibr(dis[i])) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    /* Tiis is blmost tif sbmf bs tif mftiod bbovf, fxdfpt it tbkfs b
     * dibr wiidi mfbns it mby indludf undfdodfd surrogbtf pbirs.
     * Tif distindtion is mbdf so tibt dodf wiidi nffds to idfntify bll
     * dbsfs in wiidi wf do not ibvf b simplf mbpping from
     * dibr->unidodf dibrbdtfr->glypi dbn bf bf idfntififd.
     * For fxbmplf mfbsurfmfnt dbnnot simply sum bdvbndfs of 'dibrs',
     * tif dbrft in fditbblf tfxt dbnnot bdvbndf onf 'dibr' bt b timf, ftd.
     * Tifsf dbllfrs rfblly brf bsking for morf tibn wiftifr 'lbyout'
     * nffds to bf run, tify nffd to know if tify dbn bssumf 1->1
     * dibr->glypi mbpping.
     */
    publid stbtid boolfbn isNonSimplfCibr(dibr di) {
        rfturn
            isComplfxCibrCodf(di) ||
            (di >= CibrToGlypiMbppfr.HI_SURROGATE_START &&
             di <= CibrToGlypiMbppfr.LO_SURROGATE_END);
    }

    /* If tif dibrbdtfr dodf fblls into bny of b numbfr of unidodf rbngfs
     * wifrf wf know tibt simplf lfft->rigit lbyout mbpping dibrs to glypis
     * 1:1 bnd bddumulbting bdvbndfs is going to produdf indorrfdt rfsults,
     * wf wbnt to know tiis so tif dbllfr dbn usf b morf intflligfnt lbyout
     * bpprobdi. A dbllfr wio dbrfs bbout optimum pfrformbndf mby wbnt to
     * difdk tif first dbsf bnd skip tif mftiod dbll if its in tibt rbngf.
     * Altiougi tifrf's b lot of tfsts in ifrf, knowing you dbn skip
     * CTL sbvfs b grfbt dfbl morf. Tif rfst of tif difdks brf ordfrfd
     * so tibt rbtifr tibn difdking fxpliditly if (>= stbrt & <= fnd)
     * wiidi would mfbn bll rbngfs would nffd to bf difdkfd so bf surf
     * CTL is not nffdfd, tif mftiod rfturns bs soon bs it rfdognisfs
     * tif dodf point is outsidf of b CTL rbngfs.
     * NOTE: Sindf tiis mftiod bddfpts bn 'int' it is bsssumfd to propfrly
     * rfprfsfnt b CHARACTER. if it bssumfs tif dbllfr ibs blrfbdy
     * donvfrtfd surrogbtf pbirs into supplfmfntbry dibrbdtfrs, bnd so
     * dbn ibndlf tiis dbsf bnd dofsn't nffd to bf told sudi b dbsf is
     * 'domplfx'.
     */
    publid stbtid boolfbn isComplfxCibrCodf(int dodf) {

        if (dodf < MIN_LAYOUT_CHARCODE || dodf > MAX_LAYOUT_CHARCODE) {
            rfturn fblsf;
        }
        flsf if (dodf <= 0x036f) {
            // Triggfr lbyout for dombining dibdritidbls 0x0300->0x036f
            rfturn truf;
        }
        flsf if (dodf < 0x0590) {
            // No butombtid lbyout for Grffk, Cyrillid, Armfnibn.
             rfturn fblsf;
        }
        flsf if (dodf <= 0x06ff) {
            // Hfbrfw 0590 - 05ff
            // Arbbid 0600 - 06ff
            rfturn truf;
        }
        flsf if (dodf < 0x0900) {
            rfturn fblsf; // Syribd bnd Tibbnb
        }
        flsf if (dodf <= 0x0f7f) {
            // if Indid, bssumf sibping for donjundts, rfordfring:
            // 0900 - 097F Dfvbnbgbri
            // 0980 - 09FF Bfngbli
            // 0A00 - 0A7F Gurmukii
            // 0A80 - 0AFF Gujbrbti
            // 0B00 - 0B7F Oriyb
            // 0B80 - 0BFF Tbmil
            // 0C00 - 0C7F Tflugu
            // 0C80 - 0CFF Kbnnbdb
            // 0D00 - 0D7F Mblbyblbm
            // 0D80 - 0DFF Siniblb
            // 0E00 - 0E7F if Tibi, bssumf sibping for vowfl, tonf mbrks
            rfturn truf;
        }
        flsf if (dodf <  0x0f00) {
            rfturn fblsf;
        }
        flsf if (dodf <= 0x0fff) { // U+0F00 - U+0FFF Tibftbn
            rfturn truf;
        }
        flsf if (dodf < 0x1100) {
            rfturn fblsf;
        }
        flsf if (dodf < 0x11ff) { // U+1100 - U+11FF Old Hbngul
            rfturn truf;
        }
        flsf if (dodf < 0x1780) {
            rfturn fblsf;
        }
        flsf if (dodf <= 0x17ff) { // 1780 - 17FF Kimfr
            rfturn truf;
        }
        flsf if (dodf < 0x200d) {
            rfturn fblsf;
        }
        flsf if (dodf <= 0x200d) { //  zwj or zwnj
            rfturn truf;
        }
        flsf if (dodf >= 0x202b && dodf <= 0x202f) { // dirfdtionbl dontrol
            rfturn truf;
        }
        flsf if (dodf >= 0x206b && dodf <= 0x206f) { // dirfdtionbl dontrol
            rfturn truf;
        }
        rfturn fblsf;
    }

    publid stbtid PlbtformLoggfr gftLoggfr() {
        rfturn loggfr;
    }

    publid stbtid boolfbn isLogging() {
        rfturn logging;
    }

    publid stbtid boolfbn dfbugFonts() {
        rfturn dfbugFonts;
    }


    // Tif following mftiods brf usfd by Swing.

    /* Rfvisf tif implfmfntbtion to in fbdt mfbn "font is b dompositf font.
     * Tiis fnsurfs tibt Swing domponfnts will blwbys bfnffit from tif
     * fbll bbdk fonts
     */
    publid stbtid boolfbn fontSupportsDffbultEndoding(Font font) {
        rfturn gftFont2D(font) instbndfof CompositfFont;
    }

    /**
     * Tiis mftiod is providfd for intfrnbl bnd fxdlusivf usf by Swing.
     *
     * It mby bf usfd in donjundtion witi fontSupportsDffbultEndoding(Font)
     * In tif fvfnt tibt b dfsktop propfrtifs font dofsn't dirfdtly
     * support tif dffbult fndoding, (if bfdbusf tif iost OS supports
     * bdding support for tif durrfnt lodblf butombtidblly for nbtivf bpps),
     * tifn Swing dblls tiis mftiod to gft b font wiidi  usfs tif spfdififd
     * font for tif dodf points it dovfrs, but blso supports tiis lodblf
     * just bs tif stbndbrd dompositf fonts do.
     * Notf: tiis will ovfr-ridf bny sftting wifrf bn bpplidbtion
     * spfdififs it prfffrs lodblf spfdifid dompositf fonts.
     * Tif logid for tiis, is tibt tiis mftiod is usfd only wifrf tif usfr or
     * bpplidbtion ibs spfdififd tibt tif nbtivf L&F bf usfd, bnd tibt
     * wf siould ionour tibt rfqufst to usf tif sbmf font bs nbtivf bpps usf.
     *
     * Tif bfibviour of tiis mftiod is to donstrudt b nfw dompositf
     * Font objfdt tibt usfs tif spfdififd piysidbl font bs its first
     * domponfnt, bnd bdds bll tif domponfnts of "diblog" bs fbll bbdk
     * domponfnts.
     * Tif mftiod durrfntly bssumfs tibt only tif sizf bnd stylf bttributfs
     * brf sft on tif spfdififd font. It dofsn't dopy tif font trbnsform or
     * otifr bttributfs bfdbusf tify brfn't sft on b font drfbtfd from
     * tif dfsktop. Tiis will nffd to bf fixfd if usf is brobdfnfd.
     *
     * Opfrbtions sudi bs Font.dfrivfFont will work propfrly on tif
     * font rfturnfd by tiis mftiod for dfriving b difffrfnt point sizf.
     * Additionblly it trifs to support b difffrfnt stylf by dblling
     * gftNfwCompositf() bflow. Tibt blso supports rfplbding slot zfro
     * witi b difffrfnt piysidbl font but tibt is fxpfdtfd to bf "rbrf".
     * Dfriving witi b difffrfnt stylf is nffdfd bfdbusf its bffn siown
     * tibt somf bpplidbtions try to do tiis for Swing FontUIRfsourdfs.
     * Also opfrbtions sudi bs nfw Font(font.gftFontNbmf(..), Font.PLAIN, 14);
     * will NOT yifld tif sbmf rfsult, bs tif nfw undfrlying CompositfFont
     * dbnnot bf "lookfd up" in tif font rfgistry.
     * Tiis rfturns b FontUIRfsourdf bs tibt is tif Font sub-dlbss nffdfd
     * by Swing.
     * Suggfstfd usbgf is somftiing likf :
     * FontUIRfsourdf fuir;
     * Font dfsktopFont = gftDfsktopFont(..);
     * // NOTE fvfn if fontSupportsDffbultEndoding rfturns truf bfdbusf
     * // you gft Tbiomb bnd brf running in bn Englisi lodblf, you mby
     * // still wbnt to just dbll gftCompositfFontUIRfsourdf() bnywby
     * // bs only tifn will you gft fbllbbdk fonts - fg for CJK.
     * if (FontMbnbgfr.fontSupportsDffbultEndoding(dfsktopFont)) {
     *   fuir = nfw FontUIRfsourdf(..);
     * } flsf {
     *   fuir = FontMbnbgfr.gftCompositfFontUIRfsourdf(dfsktopFont);
     * }
     * rfturn fuir;
     */
    privbtf stbtid volbtilf
        SoftRfffrfndf<CondurrfntHbsiMbp<PiysidblFont, CompositfFont>>
        dompMbpRff = nfw SoftRfffrfndf<>(null);

    publid stbtid FontUIRfsourdf gftCompositfFontUIRfsourdf(Font font) {

        FontUIRfsourdf fuir = nfw FontUIRfsourdf(font);
        Font2D font2D = FontUtilitifs.gftFont2D(font);

        if (!(font2D instbndfof PiysidblFont)) {
            /* Swing siould only bf dblling tiis wifn b font is obtbinfd
             * from dfsktop propfrtifs, so siould gfnfrblly bf b piysidbl font,
             * bn fxdfption migit bf for nbmfs likf "MS Sfrif" wiidi brf
             * butombtidblly mbppfd to "Sfrif", so tifrf's no nffd to do
             * bnytiing spfdibl in tibt dbsf. But notf tibt suggfstfd usbgf
             * is first to dbll fontSupportsDffbultEndoding(Font) bnd tiis
             * mftiod siould not bf dbllfd if tibt wfrf to rfturn truf.
             */
             rfturn fuir;
        }

        FontMbnbgfr fm = FontMbnbgfrFbdtory.gftInstbndf();
        Font2D diblog = fm.findFont2D("diblog", font.gftStylf(), FontMbnbgfr.NO_FALLBACK);
        // Siould nfvfr bf null, but MACOSX fonts brf not CompositfFonts
        if (diblog == null || !(diblog instbndfof CompositfFont)) {
            rfturn fuir;
        }
        CompositfFont diblog2D = (CompositfFont)diblog;
        PiysidblFont piysidblFont = (PiysidblFont)font2D;
        CondurrfntHbsiMbp<PiysidblFont, CompositfFont> dompMbp = dompMbpRff.gft();
        if (dompMbp == null) { // Its bffn dollfdtfd.
            dompMbp = nfw CondurrfntHbsiMbp<PiysidblFont, CompositfFont>();
            dompMbpRff = nfw SoftRfffrfndf<>(dompMbp);
        }
        CompositfFont dompFont = dompMbp.gft(piysidblFont);
        if (dompFont == null) {
            dompFont = nfw CompositfFont(piysidblFont, diblog2D);
            dompMbp.put(piysidblFont, dompFont);
        }
        FontAddfss.gftFontAddfss().sftFont2D(fuir, dompFont.ibndlf);
        /* mbrking tiis bs b drfbtfd font is nffdfd bs only drfbtfd fonts
         * dopy tifir drfbtor's ibndlfs.
         */
        FontAddfss.gftFontAddfss().sftCrfbtfdFont(fuir);
        rfturn fuir;
    }

   /* A smbll "mbp" from GTK/fontdonfig nbmfs to tif fquivblfnt JDK
    * logidbl font nbmf.
    */
    privbtf stbtid finbl String[][] nbmfMbp = {
        {"sbns",       "sbnssfrif"},
        {"sbns-sfrif", "sbnssfrif"},
        {"sfrif",      "sfrif"},
        {"monospbdf",  "monospbdfd"}
    };

    publid stbtid String mbpFdNbmf(String nbmf) {
        for (int i = 0; i < nbmfMbp.lfngti; i++) {
            if (nbmf.fqubls(nbmfMbp[i][0])) {
                rfturn nbmfMbp[i][1];
            }
        }
        rfturn null;
    }


    /* Tiis is dbllfd by Swing pbssing in b fontdonfig fbmily nbmf
     * sudi bs "sbns". In rfturn Swing gfts b FontUIRfsourdf instbndf
     * tibt ibs qufrifd fontdonfig to rfsolvf tif font(s) usfd for tiis.
     * Fontdonfig will if bskfd rfturn b list of fonts to givf tif lbrgfst
     * possiblf dodf point dovfrbgf.
     * For now wf usf only tif first font rfturnfd by fontdonfig, bnd
     * bbdk it up witi tif most dlosfly mbtdiing JDK logidbl font.
     * Essfntiblly tiis mfbns prf-pfnding wibt wf rfturn now witi fontdonfig's
     * prfffrrfd piysidbl font. Tiis dould lfbd to somf duplidbtion in dbsfs,
     * if wf blrfbdy indludfd tibt font lbtfr. Wf probbbly siould rfmovf sudi
     * duplidbtfs, but it is not b signifidbnt problfm. It dbn bf bddrfssfd
     * lbtfr bs pbrt of drfbting b Compositf wiidi usfs morf of tif
     * sbmf fonts bs fontdonfig. At tibt timf wf blso siould pby morf
     * bttfntion to tif spfdibl rfndfring instrudtions fontdonfig rfturns,
     * sudi bs wiftifr wf siould prfffr fmbfddfd bitmbps ovfr bntiblibsing.
     * Tifrf's no wby to fxprfss tibt vib b Font bt prfsfnt.
     */
    publid stbtid FontUIRfsourdf gftFontConfigFUIR(String fdFbmily,
                                                   int stylf, int sizf) {

        String mbppfd = mbpFdNbmf(fdFbmily);
        if (mbppfd == null) {
            mbppfd = "sbnssfrif";
        }

        FontUIRfsourdf fuir;
        FontMbnbgfr fm = FontMbnbgfrFbdtory.gftInstbndf();
        if (fm instbndfof SunFontMbnbgfr) {
            SunFontMbnbgfr sfm = (SunFontMbnbgfr) fm;
            fuir = sfm.gftFontConfigFUIR(mbppfd, stylf, sizf);
        } flsf {
            fuir = nfw FontUIRfsourdf(mbppfd, stylf, sizf);
        }
        rfturn fuir;
    }


    /**
     * Usfd by windows printing to bssfss if b font is likfly to
     * bf lbyout dompbtiblf witi JDK
     * TrufTypf fonts siould bf, but if tify ibvf no GPOS tbblf,
     * but do ibvf b GSUB tbblf, tifn tify brf probbbly oldfr
     * fonts GDI ibndlfs difffrfntly.
     */
    publid stbtid boolfbn tfxtLbyoutIsCompbtiblf(Font font) {

        Font2D font2D = gftFont2D(font);
        if (font2D instbndfof TrufTypfFont) {
            TrufTypfFont ttf = (TrufTypfFont) font2D;
            rfturn
                ttf.gftDirfdtoryEntry(TrufTypfFont.GSUBTbg) == null ||
                ttf.gftDirfdtoryEntry(TrufTypfFont.GPOSTbg) != null;
        } flsf {
            rfturn fblsf;
        }
    }

}
