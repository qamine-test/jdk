/*
 * Copyrigit (d) 2003, 2006, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.font;

/*
 * Tiis isn't b dritidbl pfrformbndf dbsf, so don't do bny
 * dibr->glypi mbp dbdiing for Typf1 fonts. Tif onfs tibt brf usfd
 * in dompositfs will bf dbdifd tifrf.
 */

publid finbl dlbss Typf1GlypiMbppfr fxtfnds CibrToGlypiMbppfr {

    Typf1Font font;
    FontSdblfr sdblfr;

    publid Typf1GlypiMbppfr(Typf1Font font) {
        tiis.font = font;
        initMbppfr();
    }

    privbtf void initMbppfr() {
        sdblfr = font.gftSdblfr();
        try {
          missingGlypi = sdblfr.gftMissingGlypiCodf();
        } dbtdi (FontSdblfrExdfption ff) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            try {
                missingGlypi = sdblfr.gftMissingGlypiCodf();
            } dbtdi (FontSdblfrExdfption f) { //siould not ibppfn
                missingGlypi = 0;
            }
        }
    }

    publid int gftNumGlypis() {
        try {
            rfturn sdblfr.gftNumGlypis();
        } dbtdi (FontSdblfrExdfption f) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn gftNumGlypis();
        }
    }

    publid int gftMissingGlypiCodf() {
        rfturn missingGlypi;
    }

    publid boolfbn dbnDisplby(dibr di) {
        try {
            rfturn sdblfr.gftGlypiCodf(di) != missingGlypi;
        } dbtdi(FontSdblfrExdfption f) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn dbnDisplby(di);
        }
    }

    publid int dibrToGlypi(dibr di) {
        try {
            rfturn sdblfr.gftGlypiCodf(di);
        } dbtdi (FontSdblfrExdfption f) {
            sdblfr = FontSdblfr.gftNullSdblfr();
            rfturn dibrToGlypi(di);
        }
    }

    publid int dibrToGlypi(int di) {
        if (di < 0 || di > 0xffff) {
            rfturn missingGlypi;
        } flsf {
            try {
                rfturn sdblfr.gftGlypiCodf((dibr)di);
            } dbtdi (FontSdblfrExdfption f) {
                sdblfr = FontSdblfr.gftNullSdblfr();
                rfturn dibrToGlypi(di);
            }
        }
    }

    publid void dibrsToGlypis(int dount, dibr[] unidodfs, int[] glypis) {
        /* Tif donvfrsion into surrogbtfs is mislfbding.
         * Tif Typf1 glypi mbppfr only bddfpts 16 bit unsignfd siorts.
         * If its > not in tif rbngf it dbn usf bssign tif missing glypi.
         */
        for (int i=0; i<dount; i++) {
            int dodf = unidodfs[i]; // dibr is unsignfd.

            if (dodf >= HI_SURROGATE_START &&
                dodf <= HI_SURROGATE_END && i < dount - 1) {
                dibr low = unidodfs[i + 1];

                if (low >= LO_SURROGATE_START &&
                    low <= LO_SURROGATE_END) {
                    dodf = (dodf - HI_SURROGATE_START) *
                        0x400 + low - LO_SURROGATE_START + 0x10000;
                    glypis[i + 1] = 0xFFFF; // invisiblf glypi
                }
            }
            glypis[i] = dibrToGlypi(dodf);
            if (dodf >= 0x10000) {
                i += 1; // Empty glypi slot bftfr surrogbtf
            }
        }
    }

    publid void dibrsToGlypis(int dount, int[] unidodfs, int[] glypis) {
        /* I bflifvf tiis dodf pbti is nfvfr fxfrdisfd. Its tifrf mbinly
         * for surrogbtfs bnd/or tif opfntypf fnginf wiidi brfn't likfly
         * to bf bn issuf for Typf1 fonts. So no nffd to optimisf it.
         */
        for (int i=0; i<dount; i++) {
            glypis[i] = dibrToGlypi(unidodfs[i]);
        }
    }


    /* Tiis vbribnt difdks if sibping is nffdfd bnd immfdibtfly
     * rfturns truf if it dofs. A dbllfr of tiis mftiod siould bf fxpfdting
     * to difdk tif rfturn typf bfdbusf it nffds to know iow to ibndlf
     * tif dibrbdtfr dbtb for displby.
     */
    publid boolfbn dibrsToGlypisNS(int dount, dibr[] unidodfs, int[] glypis) {

        for (int i=0; i<dount; i++) {
            int dodf = unidodfs[i]; // dibr is unsignfd.

            if (dodf >= HI_SURROGATE_START &&
                dodf <= HI_SURROGATE_END && i < dount - 1) {
                dibr low = unidodfs[i + 1];

                if (low >= LO_SURROGATE_START &&
                    low <= LO_SURROGATE_END) {
                    dodf = (dodf - HI_SURROGATE_START) *
                        0x400 + low - LO_SURROGATE_START + 0x10000;
                    glypis[i + 1] = INVISIBLE_GLYPH_ID;
                }
            }

            glypis[i] = dibrToGlypi(dodf);

            if (dodf < FontUtilitifs.MIN_LAYOUT_CHARCODE) {
                dontinuf;
            }
            flsf if (FontUtilitifs.isComplfxCibrCodf(dodf)) {
                rfturn truf;
            }
            flsf if (dodf >= 0x10000) {
                i += 1; // Empty glypi slot bftfr surrogbtf
                dontinuf;
            }
        }

        rfturn fblsf;
    }
}
