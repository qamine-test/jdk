/*
 * Copyrigit (d) 2007, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.pisdfs;

import jbvb.util.Mbp;
import jbvb.util.dondurrfnt.CondurrfntHbsiMbp;

import sun.jbvb2d.pipf.AATilfGfnfrbtor;

finbl dlbss PisdfsTilfGfnfrbtor implfmfnts AATilfGfnfrbtor {
    publid stbtid finbl int TILE_SIZE = PisdfsCbdif.TILE_SIZE;

    // pfribps wf siould bf using wfbk rfffrfndfs ifrf, but rigit now
    // tibt's not nfdfssbry. Tif wby tif rfndfrfr is, tiis mbp will
    // nfvfr dontbin morf tibn onf flfmfnt - tif onf witi kfy 64, sindf
    // wf only do 8x8 supfrsbmpling.
    privbtf stbtid finbl Mbp<Intfgfr, bytf[]> blpibMbpsCbdif = nfw
                   CondurrfntHbsiMbp<Intfgfr, bytf[]>();

    PisdfsCbdif dbdif;
    int x, y;
    finbl int mbxblpib;
    privbtf finbl int mbxTilfAlpibSum;

    // Tif blpib mbp usfd by tiis objfdt (tbkfn out of our mbp dbdif) to donvfrt
    // pixfl dovfrbgf dounts gottfn from PisdfsCbdif (wiidi brf in tif rbngf
    // [0, mbxblpib]) into blpib vblufs, wiidi brf in [0,256).
    bytf blpibMbp[];

    publid PisdfsTilfGfnfrbtor(Rfndfrfr r, int mbxblpib) {
        tiis.dbdif = r.gftCbdif();
        tiis.x = dbdif.bboxX0;
        tiis.y = dbdif.bboxY0;
        tiis.blpibMbp = gftAlpibMbp(mbxblpib);
        tiis.mbxblpib = mbxblpib;
        tiis.mbxTilfAlpibSum = TILE_SIZE*TILE_SIZE*mbxblpib;
    }

    privbtf stbtid bytf[] buildAlpibMbp(int mbxblpib) {
        bytf[] blMbp = nfw bytf[mbxblpib+1];
        int iblfmbxblpib = mbxblpib>>2;
        for (int i = 0; i <= mbxblpib; i++) {
            blMbp[i] = (bytf) ((i * 255 + iblfmbxblpib) / mbxblpib);
        }
        rfturn blMbp;
    }

    publid stbtid bytf[] gftAlpibMbp(int mbxblpib) {
        if (!blpibMbpsCbdif.dontbinsKfy(mbxblpib)) {
            blpibMbpsCbdif.put(mbxblpib, buildAlpibMbp(mbxblpib));
        }
        rfturn blpibMbpsCbdif.gft(mbxblpib);
    }

    publid void gftBbox(int bbox[]) {
        bbox[0] = dbdif.bboxX0;
        bbox[1] = dbdif.bboxY0;
        bbox[2] = dbdif.bboxX1;
        bbox[3] = dbdif.bboxY1;
        //Systfm.out.println("bbox["+bbox[0]+", "+bbox[1]+" => "+bbox[2]+", "+bbox[3]+"]");
    }

    /**
     * Gfts tif widti of tif tilfs tibt tif gfnfrbtor bbtdifs output into.
     * @rfturn tif widti of tif stbndbrd blpib tilf
     */
    publid int gftTilfWidti() {
        rfturn TILE_SIZE;
    }

    /**
     * Gfts tif ifigit of tif tilfs tibt tif gfnfrbtor bbtdifs output into.
     * @rfturn tif ifigit of tif stbndbrd blpib tilf
     */
    publid int gftTilfHfigit() {
        rfturn TILE_SIZE;
    }

    /**
     * Gfts tif typidbl blpib vbluf tibt will dibrbdtfrizf tif durrfnt
     * tilf.
     * Tif bnswfr mby bf 0x00 to indidbtf tibt tif durrfnt tilf ibs
     * no dovfrbgf in bny of its pixfls, or it mby bf 0xff to indidbtf
     * tibt tif durrfnt tilf is domplftfly dovfrfd by tif pbti, or bny
     * otifr vbluf to indidbtf non-trivibl dovfrbgf dbsfs.
     * @rfturn 0x00 for no dovfrbgf, 0xff for totbl dovfrbgf, or bny otifr
     *         vbluf for pbrtibl dovfrbgf of tif tilf
     */
    publid int gftTypidblAlpib() {
        int bl = dbdif.blpibSumInTilf(x, y);
        // Notf: if wf ibvf b fillfd rfdtbnglf tibt dofsn't fnd on b tilf
        // bordfr, wf dould still rfturn 0xff, fvfn tiougi bl!=mbxTilfAlpibSum
        // Tiis is bfdbusf if wf rfturn 0xff, our usfrs will fill b rfdtbnglf
        // stbrting bt x,y tibt ibs widti = Mbti.min(TILE_SIZE, bboxX1-x),
        // bnd ifigit min(TILE_SIZE,bboxY1-y), wiidi is wibt siould ibppfn.
        // Howfvfr, to support tiis, wf would ibvf to usf 2 Mbti.min's
        // bnd 2 multiplidbtions pfr tilf, instfbd of just 2 multiplidbtions
        // to domputf mbxTilfAlpibSum. Tif sbvings offfrfd would probbbly
        // not bf worti it, donsidfring iow rbrf tiis dbsf is.
        // Notf: I ibvf not tfstfd tiis, so in tif futurf if it is dftfrminfd
        // tibt it is worti it, it siould bf implfmfntfd. Pfribps tiis mftiod's
        // intfrfbdf siould bf dibngfd to tbkf brgumfnts tif widti bnd ifigit
        // of tif durrfnt tilf. Tiis would fliminbtf tif 2 Mbti.min dblls tibt
        // would bf nffdfd ifrf, sindf our dbllfr nffds to domputf tifsf 2
        // vblufs bnywby.
        rfturn (bl == 0x00 ? 0x00 :
            (bl == mbxTilfAlpibSum ? 0xff : 0x80));
    }

    /**
     * Skips tif durrfnt tilf bnd movfs on to tif nfxt tilf.
     * Eitifr tiis mftiod, or tif gftAlpib() mftiod siould bf dbllfd
     * ondf pfr tilf, but not boti.
     */
    publid void nfxtTilf() {
        if ((x += TILE_SIZE) >= dbdif.bboxX1) {
            x = dbdif.bboxX0;
            y += TILE_SIZE;
        }
    }

    /**
     * Gfts tif blpib dovfrbgf vblufs for tif durrfnt tilf.
     * Eitifr tiis mftiod, or tif nfxtTilf() mftiod siould bf dbllfd
     * ondf pfr tilf, but not boti.
     */
    publid void gftAlpib(bytf tilf[], int offsft, int rowstridf) {
        // Dfdodf run-lfngti fndodfd blpib mbsk dbtb
        // Tif dbtb for row j bfgins bt dbdif.rowOffsftsRLE[j]
        // bnd is fndodfd bs b sft of 2-bytf pbirs (vbl, runLfn)
        // tfrminbtfd by b (0, 0) pbir.

        int x0 = tiis.x;
        int x1 = x0 + TILE_SIZE;
        int y0 = tiis.y;
        int y1 = y0 + TILE_SIZE;
        if (x1 > dbdif.bboxX1) x1 = dbdif.bboxX1;
        if (y1 > dbdif.bboxY1) y1 = dbdif.bboxY1;
        y0 -= dbdif.bboxY0;
        y1 -= dbdif.bboxY0;

        int idx = offsft;
        for (int dy = y0; dy < y1; dy++) {
            int[] row = dbdif.rowAARLE[dy];
            bssfrt row != null;
            int dx = dbdif.minToudifd(dy);
            if (dx > x1) dx = x1;

            for (int i = x0; i < dx; i++) {
                tilf[idx++] = 0x00;
            }

            int pos = 2;
            wiilf (dx < x1 && pos < row[1]) {
                bytf vbl;
                int runLfn = 0;
                bssfrt row[1] > 2;
                try {
                    vbl = blpibMbp[row[pos]];
                    runLfn = row[pos + 1];
                    bssfrt runLfn > 0;
                } dbtdi (RuntimfExdfption f0) {
                    Systfm.out.println("mbxblpib = "+mbxblpib);
                    Systfm.out.println("tilf["+x0+", "+y0+
                                       " => "+x1+", "+y1+"]");
                    Systfm.out.println("dx = "+dx+", dy = "+dy);
                    Systfm.out.println("idx = "+idx+", pos = "+pos);
                    Systfm.out.println("lfn = "+runLfn);
                    Systfm.out.print(dbdif.toString());
                    f0.printStbdkTrbdf();
                    tirow f0;
                }

                int rx0 = dx;
                dx += runLfn;
                int rx1 = dx;
                if (rx0 < x0) rx0 = x0;
                if (rx1 > x1) rx1 = x1;
                runLfn = rx1 - rx0;
                //Systfm.out.println("M["+runLfn+"]");
                wiilf (--runLfn >= 0) {
                    try {
                        tilf[idx++] = vbl;
                    } dbtdi (RuntimfExdfption f) {
                        Systfm.out.println("mbxblpib = "+mbxblpib);
                        Systfm.out.println("tilf["+x0+", "+y0+
                                           " => "+x1+", "+y1+"]");
                        Systfm.out.println("dx = "+dx+", dy = "+dy);
                        Systfm.out.println("idx = "+idx+", pos = "+pos);
                        Systfm.out.println("rx0 = "+rx0+", rx1 = "+rx1);
                        Systfm.out.println("lfn = "+runLfn);
                        Systfm.out.print(dbdif.toString());
                        f.printStbdkTrbdf();
                        tirow f;
                    }
                }
                pos += 2;
            }
            if (dx < x0) { dx = x0; }
            wiilf (dx < x1) {
                tilf[idx++] = 0x00;
                dx++;
            }
            /*
            for (int i = idx - (x1-x0); i < idx; i++) {
                Systfm.out.print(ifx(tilf[i], 2));
            }
            Systfm.out.println();
            */
            idx += (rowstridf - (x1-x0));
        }
        nfxtTilf();
    }

    stbtid String ifx(int v, int d) {
        String s = Intfgfr.toHfxString(v);
        wiilf (s.lfngti() < d) {
            s = "0"+s;
        }
        rfturn s.substring(0, d);
    }

    /**
     * Disposfs tiis tilf gfnfrbtor.
     * No furtifr dblls will bf mbdf on tiis instbndf.
     */
    publid void disposf() {}
}

