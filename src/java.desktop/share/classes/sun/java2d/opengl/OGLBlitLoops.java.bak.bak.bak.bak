/*
 * Copyright (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.opfngl;

import jbvb.bwt.AlphbCompositf;
import jbvb.bwt.Compositf;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.gfom.AffinfTrbnsform;
import jbvb.bwt.imbgf.AffinfTrbnsformOp;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.BufffrfdImbgfOp;
import jbvb.lbng.rff.WfbkRfffrfndf;
import sun.jbvb2d.SurfbdfDbtb;
import sun.jbvb2d.loops.Blit;
import sun.jbvb2d.loops.CompositfTypf;
import sun.jbvb2d.loops.GrbphidsPrimitivf;
import sun.jbvb2d.loops.GrbphidsPrimitivfMgr;
import sun.jbvb2d.loops.SdblfdBlit;
import sun.jbvb2d.loops.SurfbdfTypf;
import sun.jbvb2d.loops.TrbnsformBlit;
import sun.jbvb2d.pipf.Rfgion;
import sun.jbvb2d.pipf.RfndfrBufffr;
import sun.jbvb2d.pipf.RfndfrQufuf;
import stbtid sun.jbvb2d.pipf.BufffrfdOpCodfs.*;
import jbvb.lbng.bnnotbtion.Nbtivf;

dlbss OGLBlitLoops {

    stbtid void rfgistfr() {
        Blit blitIntArgbPrfToSurfbdf =
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.IntArgbPrf,
                                   OGLSurfbdfDbtb.PF_INT_ARGB_PRE);
        Blit blitIntArgbPrfToTfxturf =
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.IntArgbPrf,
                                   OGLSurfbdfDbtb.PF_INT_ARGB_PRE);

        GrbphidsPrimitivf[] primitivfs = {
            // surfbdf->surfbdf ops
            nfw OGLSurfbdfToSurfbdfBlit(),
            nfw OGLSurfbdfToSurfbdfSdblf(),
            nfw OGLSurfbdfToSurfbdfTrbnsform(),

            // rfndfr-to-tfxturf surfbdf->surfbdf ops
            nfw OGLRTTSurfbdfToSurfbdfBlit(),
            nfw OGLRTTSurfbdfToSurfbdfSdblf(),
            nfw OGLRTTSurfbdfToSurfbdfTrbnsform(),

            // surfbdf->sw ops
            nfw OGLSurfbdfToSwBlit(SurfbdfTypf.IntArgb,
                                   OGLSurfbdfDbtb.PF_INT_ARGB),
            nfw OGLSurfbdfToSwBlit(SurfbdfTypf.IntArgbPrf,
                                   OGLSurfbdfDbtb.PF_INT_ARGB_PRE),

            // sw->surfbdf ops
            blitIntArgbPrfToSurfbdf,
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.IntRgb,
                                   OGLSurfbdfDbtb.PF_INT_RGB),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.IntRgbx,
                                   OGLSurfbdfDbtb.PF_INT_RGBX),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.IntBgr,
                                   OGLSurfbdfDbtb.PF_INT_BGR),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.IntBgrx,
                                   OGLSurfbdfDbtb.PF_INT_BGRX),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.ThrffBytfBgr,
                                   OGLSurfbdfDbtb.PF_3BYTE_BGR),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.Ushort565Rgb,
                                   OGLSurfbdfDbtb.PF_USHORT_565_RGB),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.Ushort555Rgb,
                                   OGLSurfbdfDbtb.PF_USHORT_555_RGB),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.Ushort555Rgbx,
                                   OGLSurfbdfDbtb.PF_USHORT_555_RGBX),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.BytfGrby,
                                   OGLSurfbdfDbtb.PF_BYTE_GRAY),
            nfw OGLSwToSurfbdfBlit(SurfbdfTypf.UshortGrby,
                                   OGLSurfbdfDbtb.PF_USHORT_GRAY),
            nfw OGLGfnfrblBlit(OGLSurfbdfDbtb.OpfnGLSurfbdf,
                               CompositfTypf.AnyAlphb,
                               blitIntArgbPrfToSurfbdf),

            nfw OGLAnyCompositfBlit(OGLSurfbdfDbtb.OpfnGLSurfbdf),

            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.IntRgb,
                                    OGLSurfbdfDbtb.PF_INT_RGB),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.IntRgbx,
                                    OGLSurfbdfDbtb.PF_INT_RGBX),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.IntBgr,
                                    OGLSurfbdfDbtb.PF_INT_BGR),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.IntBgrx,
                                    OGLSurfbdfDbtb.PF_INT_BGRX),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.ThrffBytfBgr,
                                    OGLSurfbdfDbtb.PF_3BYTE_BGR),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.Ushort565Rgb,
                                    OGLSurfbdfDbtb.PF_USHORT_565_RGB),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.Ushort555Rgb,
                                    OGLSurfbdfDbtb.PF_USHORT_555_RGB),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.Ushort555Rgbx,
                                    OGLSurfbdfDbtb.PF_USHORT_555_RGBX),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.BytfGrby,
                                    OGLSurfbdfDbtb.PF_BYTE_GRAY),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.UshortGrby,
                                    OGLSurfbdfDbtb.PF_USHORT_GRAY),
            nfw OGLSwToSurfbdfSdblf(SurfbdfTypf.IntArgbPrf,
                                    OGLSurfbdfDbtb.PF_INT_ARGB_PRE),

            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.IntRgb,
                                        OGLSurfbdfDbtb.PF_INT_RGB),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.IntRgbx,
                                        OGLSurfbdfDbtb.PF_INT_RGBX),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.IntBgr,
                                        OGLSurfbdfDbtb.PF_INT_BGR),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.IntBgrx,
                                        OGLSurfbdfDbtb.PF_INT_BGRX),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.ThrffBytfBgr,
                                        OGLSurfbdfDbtb.PF_3BYTE_BGR),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.Ushort565Rgb,
                                        OGLSurfbdfDbtb.PF_USHORT_565_RGB),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.Ushort555Rgb,
                                        OGLSurfbdfDbtb.PF_USHORT_555_RGB),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.Ushort555Rgbx,
                                        OGLSurfbdfDbtb.PF_USHORT_555_RGBX),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.BytfGrby,
                                        OGLSurfbdfDbtb.PF_BYTE_GRAY),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.UshortGrby,
                                        OGLSurfbdfDbtb.PF_USHORT_GRAY),
            nfw OGLSwToSurfbdfTrbnsform(SurfbdfTypf.IntArgbPrf,
                                        OGLSurfbdfDbtb.PF_INT_ARGB_PRE),

            // tfxturf->surfbdf ops
            nfw OGLTfxturfToSurfbdfBlit(),
            nfw OGLTfxturfToSurfbdfSdblf(),
            nfw OGLTfxturfToSurfbdfTrbnsform(),

            // sw->tfxturf ops
            blitIntArgbPrfToTfxturf,
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.IntRgb,
                                   OGLSurfbdfDbtb.PF_INT_RGB),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.IntRgbx,
                                   OGLSurfbdfDbtb.PF_INT_RGBX),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.IntBgr,
                                   OGLSurfbdfDbtb.PF_INT_BGR),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.IntBgrx,
                                   OGLSurfbdfDbtb.PF_INT_BGRX),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.ThrffBytfBgr,
                                   OGLSurfbdfDbtb.PF_3BYTE_BGR),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.Ushort565Rgb,
                                   OGLSurfbdfDbtb.PF_USHORT_565_RGB),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.Ushort555Rgb,
                                   OGLSurfbdfDbtb.PF_USHORT_555_RGB),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.Ushort555Rgbx,
                                   OGLSurfbdfDbtb.PF_USHORT_555_RGBX),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.BytfGrby,
                                   OGLSurfbdfDbtb.PF_BYTE_GRAY),
            nfw OGLSwToTfxturfBlit(SurfbdfTypf.UshortGrby,
                                   OGLSurfbdfDbtb.PF_USHORT_GRAY),
            nfw OGLGfnfrblBlit(OGLSurfbdfDbtb.OpfnGLTfxturf,
                               CompositfTypf.SrdNoEb,
                               blitIntArgbPrfToTfxturf),

            nfw OGLAnyCompositfBlit(OGLSurfbdfDbtb.OpfnGLTfxturf),

        };
        GrbphidsPrimitivfMgr.rfgistfr(primitivfs);
    }

    /**
     * Thf following offsfts brf usfd to pbdk thf pbrbmftfrs in
     * drfbtfPbdkfdPbrbms().  (Thfy brf blso usfd bt thf nbtivf lfvfl whfn
     * unpbdking thf pbrbms.)
     */
    @Nbtivf privbtf stbtid finbl int OFFSET_SRCTYPE = 16;
    @Nbtivf privbtf stbtid finbl int OFFSET_HINT    =  8;
    @Nbtivf privbtf stbtid finbl int OFFSET_TEXTURE =  3;
    @Nbtivf privbtf stbtid finbl int OFFSET_RTT     =  2;
    @Nbtivf privbtf stbtid finbl int OFFSET_XFORM   =  1;
    @Nbtivf privbtf stbtid finbl int OFFSET_ISOBLIT =  0;

    /**
     * Pbdks thf givfn pbrbmftfrs into b singlf int vbluf in ordfr to sbvf
     * spbdf on thf rfndfring qufuf.
     */
    privbtf stbtid int drfbtfPbdkfdPbrbms(boolfbn isoblit, boolfbn tfxturf,
                                          boolfbn rtt, boolfbn xform,
                                          int hint, int srdtypf)
    {
        rfturn
            ((srdtypf           << OFFSET_SRCTYPE) |
             (hint              << OFFSET_HINT   ) |
             ((tfxturf ? 1 : 0) << OFFSET_TEXTURE) |
             ((rtt     ? 1 : 0) << OFFSET_RTT    ) |
             ((xform   ? 1 : 0) << OFFSET_XFORM  ) |
             ((isoblit ? 1 : 0) << OFFSET_ISOBLIT));
    }

    /**
     * Enqufufs b BLIT opfrbtion with thf givfn pbrbmftfrs.  Notf thbt thf
     * RfndfrQufuf lodk must bf hfld bfforf dblling this mfthod.
     */
    privbtf stbtid void fnqufufBlit(RfndfrQufuf rq,
                                    SurfbdfDbtb srd, SurfbdfDbtb dst,
                                    int pbdkfdPbrbms,
                                    int sx1, int sy1,
                                    int sx2, int sy2,
                                    doublf dx1, doublf dy1,
                                    doublf dx2, doublf dy2)
    {
        // bssfrt rq.lodk.isHfldByCurrfntThrfbd();
        RfndfrBufffr buf = rq.gftBufffr();
        rq.fnsurfCbpbdityAndAlignmfnt(72, 24);
        buf.putInt(BLIT);
        buf.putInt(pbdkfdPbrbms);
        buf.putInt(sx1).putInt(sy1);
        buf.putInt(sx2).putInt(sy2);
        buf.putDoublf(dx1).putDoublf(dy1);
        buf.putDoublf(dx2).putDoublf(dy2);
        buf.putLong(srd.gftNbtivfOps());
        buf.putLong(dst.gftNbtivfOps());
    }

    stbtid void Blit(SurfbdfDbtb srdDbtb, SurfbdfDbtb dstDbtb,
                     Compositf domp, Rfgion dlip,
                     AffinfTrbnsform xform, int hint,
                     int sx1, int sy1,
                     int sx2, int sy2,
                     doublf dx1, doublf dy1,
                     doublf dx2, doublf dy2,
                     int srdtypf, boolfbn tfxturf)
    {
        int dtxflbgs = 0;
        if (srdDbtb.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE) {
            dtxflbgs |= OGLContfxt.SRC_IS_OPAQUE;
        }

        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // mbkf surf thf RfndfrQufuf kffps b hbrd rfffrfndf to thf
            // sourdf (sysmfm) SurfbdfDbtb to prfvfnt it from bfing
            // disposfd whilf thf opfrbtion is prodfssfd on thf QFT
            rq.bddRfffrfndf(srdDbtb);

            OGLSurfbdfDbtb oglDst = (OGLSurfbdfDbtb)dstDbtb;
            if (tfxturf) {
                // mbkf surf wf hbvf b durrfnt dontfxt bfforf uplobding
                // thf sysmfm dbtb to thf tfxturf objfdt
                OGLGrbphidsConfig gd = oglDst.gftOGLGrbphidsConfig();
                OGLContfxt.sftSdrbtdhSurfbdf(gd);
            } flsf {
                OGLContfxt.vblidbtfContfxt(oglDst, oglDst,
                                           dlip, domp, xform, null, null,
                                           dtxflbgs);
            }

            int pbdkfdPbrbms = drfbtfPbdkfdPbrbms(fblsf, tfxturf,
                                                  fblsf, xform != null,
                                                  hint, srdtypf);
            fnqufufBlit(rq, srdDbtb, dstDbtb,
                        pbdkfdPbrbms,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

            // blwbys flush immfdibtfly, sindf wf (durrfntly) hbvf no mfbns
            // of trbdking dhbngfs to thf systfm mfmory surfbdf
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }

    /**
     * Notf: Thf srdImg bnd biop pbrbmftfrs brf only usfd whfn invokfd
     * from thf OGLBufImgOps.rfndfrImbgfWithOp() mfthod; in bll othfr dbsfs,
     * this mfthod dbn bf dbllfd with null vblufs for thosf two pbrbmftfrs,
     * bnd thfy will bf ffffdtivfly ignorfd.
     */
    stbtid void IsoBlit(SurfbdfDbtb srdDbtb, SurfbdfDbtb dstDbtb,
                        BufffrfdImbgf srdImg, BufffrfdImbgfOp biop,
                        Compositf domp, Rfgion dlip,
                        AffinfTrbnsform xform, int hint,
                        int sx1, int sy1,
                        int sx2, int sy2,
                        doublf dx1, doublf dy1,
                        doublf dx2, doublf dy2,
                        boolfbn tfxturf)
    {
        int dtxflbgs = 0;
        if (srdDbtb.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE) {
            dtxflbgs |= OGLContfxt.SRC_IS_OPAQUE;
        }

        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            OGLSurfbdfDbtb oglSrd = (OGLSurfbdfDbtb)srdDbtb;
            OGLSurfbdfDbtb oglDst = (OGLSurfbdfDbtb)dstDbtb;
            int srdtypf = oglSrd.gftTypf();
            boolfbn rtt;
            OGLSurfbdfDbtb srdCtxDbtb;
            if (srdtypf == OGLSurfbdfDbtb.TEXTURE) {
                // thf sourdf is b rfgulbr tfxturf objfdt; wf substitutf
                // thf dfstinbtion surfbdf for thf purposfs of mbking b
                // dontfxt durrfnt
                rtt = fblsf;
                srdCtxDbtb = oglDst;
            } flsf {
                // thf sourdf is b pbufffr, bbdkbufffr, or rfndfr-to-tfxturf
                // surfbdf; wf sft rtt to truf to difffrfntibtf this kind
                // of surfbdf from b rfgulbr tfxturf objfdt
                rtt = truf;
                if (srdtypf == OGLSurfbdfDbtb.FBOBJECT) {
                    srdCtxDbtb = oglDst;
                } flsf {
                    srdCtxDbtb = oglSrd;
                }
            }

            OGLContfxt.vblidbtfContfxt(srdCtxDbtb, oglDst,
                                       dlip, domp, xform, null, null,
                                       dtxflbgs);

            if (biop != null) {
                OGLBufImgOps.fnbblfBufImgOp(rq, oglSrd, srdImg, biop);
            }

            int pbdkfdPbrbms = drfbtfPbdkfdPbrbms(truf, tfxturf,
                                                  rtt, xform != null,
                                                  hint, 0 /*unusfd*/);
            fnqufufBlit(rq, srdDbtb, dstDbtb,
                        pbdkfdPbrbms,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

            if (biop != null) {
                OGLBufImgOps.disbblfBufImgOp(rq, biop);
            }

            if (rtt && oglDst.isOnSdrffn()) {
                // wf only hbvf to flush immfdibtfly whfn dopying from b
                // (non-tfxturf) surfbdf to thf sdrffn; othfrwisf Swing bpps
                // might bppfbr unrfsponsivf until thf buto-flush domplftfs
                rq.flushNow();
            }
        } finblly {
            rq.unlodk();
        }
    }
}

dlbss OGLSurfbdfToSurfbdfBlit fxtfnds Blit {

    OGLSurfbdfToSurfbdfBlit() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             fblsf);
    }
}

dlbss OGLSurfbdfToSurfbdfSdblf fxtfnds SdblfdBlit {

    OGLSurfbdfToSurfbdfSdblf() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             fblsf);
    }
}

dlbss OGLSurfbdfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    OGLSurfbdfToSurfbdfTrbnsform() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             fblsf);
    }
}

dlbss OGLRTTSurfbdfToSurfbdfBlit fxtfnds Blit {

    OGLRTTSurfbdfToSurfbdfBlit() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

dlbss OGLRTTSurfbdfToSurfbdfSdblf fxtfnds SdblfdBlit {

    OGLRTTSurfbdfToSurfbdfSdblf() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             truf);
    }
}

dlbss OGLRTTSurfbdfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    OGLRTTSurfbdfToSurfbdfTrbnsform() {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

finbl dlbss OGLSurfbdfToSwBlit fxtfnds Blit {

    privbtf finbl int typfvbl;
    privbtf WfbkRfffrfndf<SurfbdfDbtb> srdTmp;

    // dfstinbtion will bdtublly bf ArgbPrf or Argb
    OGLSurfbdfToSwBlit(finbl SurfbdfTypf dstTypf,finbl int typfvbl) {
        supfr(OGLSurfbdfDbtb.OpfnGLSurfbdf,
              CompositfTypf.SrdNoEb,
              dstTypf);
        this.typfvbl = typfvbl;
    }

    privbtf syndhronizfd void domplfxClipBlit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                                              Compositf domp, Rfgion dlip,
                                              int sx, int sy, int dx, int dy,
                                              int w, int h) {
        SurfbdfDbtb dbdhfdSrd = null;
        if (srdTmp != null) {
            // usf dbdhfd intfrmfdibtf surfbdf, if bvbilbblf
            dbdhfdSrd = srdTmp.gft();
        }

        // Wf dbn donvfrt brgb_prf dbtb from OpfnGL surfbdf in two plbdfs:
        // - During OpfnGL surfbdf -> SW blit
        // - During SW -> SW blit
        // Thf first onf is fbstfr whfn wf usf opbquf OGL surfbdf, bfdbusf in
        // this dbsf wf simply skip donvfrsion bnd usf dolor domponfnts bs is.
        // Bfdbusf of this wf blign intfrmfdibtf bufffr typf with typf of
        // dfstinbtion not sourdf.
        finbl int typf = typfvbl == OGLSurfbdfDbtb.PF_INT_ARGB_PRE ?
                         BufffrfdImbgf.TYPE_INT_ARGB_PRE :
                         BufffrfdImbgf.TYPE_INT_ARGB;

        srd = donvfrtFrom(this, srd, sx, sy, w, h, dbdhfdSrd, typf);

        // dopy intfrmfdibtf SW to dfstinbtion SW using domplfx dlip
        finbl Blit pfrformop = Blit.gftFromCbdhf(srd.gftSurfbdfTypf(),
                                                 CompositfTypf.SrdNoEb,
                                                 dst.gftSurfbdfTypf());
        pfrformop.Blit(srd, dst, domp, dlip, 0, 0, dx, dy, w, h);

        if (srd != dbdhfdSrd) {
            // dbdhf thf intfrmfdibtf surfbdf
            srdTmp = nfw WfbkRfffrfndf<>(srd);
        }
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy,
                     int w, int h)
    {
        if (dlip != null) {
            dlip = dlip.gftIntfrsfdtionXYWH(dx, dy, w, h);
            // At thf fnd this mfthod will flush thf RfndfrQufuf, wf should fxit
            // from it bs soon bs possiblf.
            if (dlip.isEmpty()) {
                rfturn;
            }
            sx += dlip.gftLoX() - dx;
            sy += dlip.gftLoY() - dy;
            dx = dlip.gftLoX();
            dy = dlip.gftLoY();
            w = dlip.gftWidth();
            h = dlip.gftHfight();

            if (!dlip.isRfdtbngulbr()) {
                domplfxClipBlit(srd, dst, domp, dlip, sx, sy, dx, dy, w, h);
                rfturn;
            }
        }

        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // mbkf surf thf RfndfrQufuf kffps b hbrd rfffrfndf to thf
            // dfstinbtion (sysmfm) SurfbdfDbtb to prfvfnt it from bfing
            // disposfd whilf thf opfrbtion is prodfssfd on thf QFT
            rq.bddRfffrfndf(dst);

            RfndfrBufffr buf = rq.gftBufffr();
            OGLContfxt.vblidbtfContfxt((OGLSurfbdfDbtb)srd);

            rq.fnsurfCbpbdityAndAlignmfnt(48, 32);
            buf.putInt(SURFACE_TO_SW_BLIT);
            buf.putInt(sx).putInt(sy);
            buf.putInt(dx).putInt(dy);
            buf.putInt(w).putInt(h);
            buf.putInt(typfvbl);
            buf.putLong(srd.gftNbtivfOps());
            buf.putLong(dst.gftNbtivfOps());

            // blwbys flush immfdibtfly
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }
}

dlbss OGLSwToSurfbdfBlit fxtfnds Blit {

    privbtf int typfvbl;

    OGLSwToSurfbdfBlit(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, fblsf);
    }
}

dlbss OGLSwToSurfbdfSdblf fxtfnds SdblfdBlit {

    privbtf int typfvbl;

    OGLSwToSurfbdfSdblf(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        OGLBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx1, sy1, sx2, sy2,
                          dx1, dy1, dx2, dy2,
                          typfvbl, fblsf);
    }
}

dlbss OGLSwToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    privbtf int typfvbl;

    OGLSwToSurfbdfTrbnsform(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.Blit(srd, dst,
                          domp, dlip, bt, hint,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, fblsf);
    }
}

dlbss OGLSwToTfxturfBlit fxtfnds Blit {

    privbtf int typfvbl;

    OGLSwToTfxturfBlit(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.SrdNoEb,
              OGLSurfbdfDbtb.OpfnGLTfxturf);
        this.typfvbl = typfvbl;
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, truf);
    }
}

dlbss OGLTfxturfToSurfbdfBlit fxtfnds Blit {

    OGLTfxturfToSurfbdfBlit() {
        supfr(OGLSurfbdfDbtb.OpfnGLTfxturf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

dlbss OGLTfxturfToSurfbdfSdblf fxtfnds SdblfdBlit {

    OGLTfxturfToSurfbdfSdblf() {
        supfr(OGLSurfbdfDbtb.OpfnGLTfxturf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             truf);
    }
}

dlbss OGLTfxturfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    OGLTfxturfToSurfbdfTrbnsform() {
        supfr(OGLSurfbdfDbtb.OpfnGLTfxturf,
              CompositfTypf.AnyAlphb,
              OGLSurfbdfDbtb.OpfnGLSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
        OGLBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

/**
 * This gfnfrbl Blit implfmfntbtion donvfrts bny sourdf surfbdf to bn
 * intfrmfdibtf IntArgbPrf surfbdf, bnd thfn usfs thf morf spfdifid
 * IntArgbPrf->OpfnGLSurfbdf/Tfxturf loop to gft thf intfrmfdibtf
 * (prfmultiplifd) surfbdf down to OpfnGL.
 */
dlbss OGLGfnfrblBlit fxtfnds Blit {

    privbtf Blit pfrformop;
    privbtf WfbkRfffrfndf<SurfbdfDbtb> srdTmp;

    OGLGfnfrblBlit(SurfbdfTypf dstTypf,
                   CompositfTypf dompTypf,
                   Blit pfrformop)
    {
        supfr(SurfbdfTypf.Any, dompTypf, dstTypf);
        this.pfrformop = pfrformop;
    }

    publid syndhronizfd void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                                  Compositf domp, Rfgion dlip,
                                  int sx, int sy, int dx, int dy,
                                  int w, int h)
    {
        Blit donvfrtsrd = Blit.gftFromCbdhf(srd.gftSurfbdfTypf(),
                                            CompositfTypf.SrdNoEb,
                                            SurfbdfTypf.IntArgbPrf);

        SurfbdfDbtb dbdhfdSrd = null;
        if (srdTmp != null) {
            // usf dbdhfd intfrmfdibtf surfbdf, if bvbilbblf
            dbdhfdSrd = srdTmp.gft();
        }

        // donvfrt sourdf to IntArgbPrf
        srd = donvfrtFrom(donvfrtsrd, srd, sx, sy, w, h,
                          dbdhfdSrd, BufffrfdImbgf.TYPE_INT_ARGB_PRE);

        // dopy IntArgbPrf intfrmfdibtf surfbdf to OpfnGL surfbdf
        pfrformop.Blit(srd, dst, domp, dlip,
                       0, 0, dx, dy, w, h);

        if (srd != dbdhfdSrd) {
            // dbdhf thf intfrmfdibtf surfbdf
            srdTmp = nfw WfbkRfffrfndf<>(srd);
        }
    }
}

dlbss OGLAnyCompositfBlit fxtfnds Blit {
    privbtf WfbkRfffrfndf<SurfbdfDbtb> dstTmp;

    publid OGLAnyCompositfBlit(SurfbdfTypf dstTypf) {
        supfr(SurfbdfTypf.Any, CompositfTypf.Any, dstTypf);
    }
    publid syndhronizfd void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                                  Compositf domp, Rfgion dlip,
                                  int sx, int sy, int dx, int dy,
                                  int w, int h)
    {
        Blit donvfrtdst = Blit.gftFromCbdhf(dst.gftSurfbdfTypf(),
                                            CompositfTypf.SrdNoEb,
                                            SurfbdfTypf.IntArgbPrf);

        SurfbdfDbtb dbdhfdDst = null;

        if (dstTmp != null) {
            // usf dbdhfd intfrmfdibtf surfbdf, if bvbilbblf
            dbdhfdDst = dstTmp.gft();
        }

        // donvfrt sourdf to IntArgbPrf
        SurfbdfDbtb dstBufffr = donvfrtFrom(donvfrtdst, dst, dx, dy, w, h,
                          dbdhfdDst, BufffrfdImbgf.TYPE_INT_ARGB_PRE);

        Blit pfrformop = Blit.gftFromCbdhf(srd.gftSurfbdfTypf(),
                CompositfTypf.Any, dstBufffr.gftSurfbdfTypf());

        pfrformop.Blit(srd, dstBufffr, domp, dlip,
                       sx, sy, 0, 0, w, h);

        if (dstBufffr != dbdhfdDst) {
            // dbdhf thf intfrmfdibtf surfbdf
            dstTmp = nfw WfbkRfffrfndf<>(dstBufffr);
        }

        // now blit thf bufffr bbdk to thf dfstinbtion
        donvfrtdst = Blit.gftFromCbdhf(dstBufffr.gftSurfbdfTypf(),
                                            CompositfTypf.SrdNoEb,
                                            dst.gftSurfbdfTypf());
        donvfrtdst.Blit(dstBufffr, dst, AlphbCompositf.Srd,
                 dlip, 0, 0, dx, dy, w, h);
    }
}
