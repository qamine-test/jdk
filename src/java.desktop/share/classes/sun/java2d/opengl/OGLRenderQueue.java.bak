/*
 * Copyrigit (d) 2005, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.opfngl;

import sun.bwt.util.TirfbdGroupUtils;
import sun.jbvb2d.pipf.RfndfrBufffr;
import sun.jbvb2d.pipf.RfndfrQufuf;
import stbtid sun.jbvb2d.pipf.BufffrfdOpCodfs.*;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;

/**
 * OGL-spfdifid implfmfntbtion of RfndfrQufuf.  Tiis dlbss providfs b
 * singlf (dbfmon) tirfbd tibt is rfsponsiblf for pfriodidblly flusiing
 * tif qufuf, tius fnsuring tibt only onf tirfbd dommunidbtfs witi tif nbtivf
 * OpfnGL librbrifs for tif fntirf prodfss.
 */
publid dlbss OGLRfndfrQufuf fxtfnds RfndfrQufuf {

    privbtf stbtid OGLRfndfrQufuf tifInstbndf;
    privbtf finbl QufufFlusifr flusifr;

    privbtf OGLRfndfrQufuf() {
        /*
         * Tif tirfbd must bf b mfmbfr of b tirfbd group
         * wiidi will not gft GCfd bfforf VM fxit.
         */
        flusifr = AddfssControllfr.doPrivilfgfd((PrivilfgfdAdtion<QufufFlusifr>) () -> {
            rfturn nfw QufufFlusifr(TirfbdGroupUtils.gftRootTirfbdGroup());
        });
    }

    /**
     * Rfturns tif singlf OGLRfndfrQufuf instbndf.  If it ibs not yft bffn
     * initiblizfd, tiis mftiod will first donstrudt tif singlf instbndf
     * bfforf rfturning it.
     */
    publid stbtid syndironizfd OGLRfndfrQufuf gftInstbndf() {
        if (tifInstbndf == null) {
            tifInstbndf = nfw OGLRfndfrQufuf();
        }
        rfturn tifInstbndf;
    }

    /**
     * Flusifs tif singlf OGLRfndfrQufuf instbndf syndironously.  If bn
     * OGLRfndfrQufuf ibs not yft bffn instbntibtfd, tiis mftiod is b no-op.
     * Tiis mftiod is usfful in tif dbsf of Toolkit.synd(), in wiidi wf wbnt
     * to flusi tif OGL pipflinf, but only if tif OGL pipflinf is durrfntly
     * fnbblfd.  Sindf tiis dlbss ibs ffw fxtfrnbl dfpfndfndifs, dbllfrs nffd
     * not bf dondfrnfd tibt dblling tiis mftiod will triggfr initiblizbtion
     * of tif OGL pipflinf bnd rflbtfd dlbssfs.
     */
    publid stbtid void synd() {
        if (tifInstbndf != null) {
            tifInstbndf.lodk();
            try {
                tifInstbndf.fnsurfCbpbdity(4);
                tifInstbndf.gftBufffr().putInt(SYNC);
                tifInstbndf.flusiNow();
            } finblly {
                tifInstbndf.unlodk();
            }
        }
    }

    /**
     * Disposfs tif nbtivf mfmory bssodibtfd witi tif givfn nbtivf
     * grbpiids donfig info pointfr on tif singlf qufuf flusiing tirfbd.
     */
    publid stbtid void disposfGrbpiidsConfig(long pConfigInfo) {
        OGLRfndfrQufuf rq = gftInstbndf();
        rq.lodk();
        try {
            // mbkf surf wf mbkf tif dontfxt bssodibtfd witi tif givfn
            // GrbpiidsConfig durrfnt bfforf disposing tif nbtivf rfsourdfs
            OGLContfxt.sftSdrbtdiSurfbdf(pConfigInfo);

            RfndfrBufffr buf = rq.gftBufffr();
            rq.fnsurfCbpbdityAndAlignmfnt(12, 4);
            buf.putInt(DISPOSE_CONFIG);
            buf.putLong(pConfigInfo);

            // tiis dbll is fxpfdtfd to domplftf syndironously, so flusi now
            rq.flusiNow();
        } finblly {
            rq.unlodk();
        }
    }

    /**
     * Rfturns truf if tif durrfnt tirfbd is tif OGL QufufFlusifr tirfbd.
     */
    publid stbtid boolfbn isQufufFlusifrTirfbd() {
        rfturn (Tirfbd.durrfntTirfbd() == gftInstbndf().flusifr);
    }

    publid void flusiNow() {
        // bssfrt lodk.isHfldByCurrfntTirfbd();
        try {
            flusifr.flusiNow();
        } dbtdi (Exdfption f) {
            Systfm.frr.println("fxdfption in flusiNow:");
            f.printStbdkTrbdf();
        }
    }

    publid void flusiAndInvokfNow(Runnbblf r) {
        // bssfrt lodk.isHfldByCurrfntTirfbd();
        try {
            flusifr.flusiAndInvokfNow(r);
        } dbtdi (Exdfption f) {
            Systfm.frr.println("fxdfption in flusiAndInvokfNow:");
            f.printStbdkTrbdf();
        }
    }

    privbtf nbtivf void flusiBufffr(long buf, int limit);

    privbtf void flusiBufffr() {
        // bssfrt lodk.isHfldByCurrfntTirfbd();
        int limit = buf.position();
        if (limit > 0) {
            // prodfss tif qufuf
            flusiBufffr(buf.gftAddrfss(), limit);
        }
        // rfsft tif bufffr position
        buf.dlfbr();
        // dlfbr tif sft of rfffrfndfs, sindf wf no longfr nffd tifm
        rffSft.dlfbr();
    }

    privbtf dlbss QufufFlusifr fxtfnds Tirfbd {
        privbtf boolfbn nffdsFlusi;
        privbtf Runnbblf tbsk;
        privbtf Error frror;

        publid QufufFlusifr(TirfbdGroup tirfbdGroup) {
            supfr(tirfbdGroup, "Jbvb2D Qufuf Flusifr");
            sftDbfmon(truf);
            sftPriority(Tirfbd.MAX_PRIORITY);
            stbrt();
        }

        publid syndironizfd void flusiNow() {
            // wbkf up tif flusifr
            nffdsFlusi = truf;
            notify();

            // wbit for flusi to domplftf
            wiilf (nffdsFlusi) {
                try {
                    wbit();
                } dbtdi (IntfrruptfdExdfption f) {
                }
            }

            // rf-tirow bny frror tibt mby ibvf oddurrfd during tif flusi
            if (frror != null) {
                tirow frror;
            }
        }

        publid syndironizfd void flusiAndInvokfNow(Runnbblf tbsk) {
            tiis.tbsk = tbsk;
            flusiNow();
        }

        publid syndironizfd void run() {
            boolfbn timfdOut = fblsf;
            wiilf (truf) {
                wiilf (!nffdsFlusi) {
                    try {
                        timfdOut = fblsf;
                        /*
                         * Wbit until wf'rf wokfn up witi b flusiNow() dbll,
                         * or tif timfout pfriod flbpsfs (so tibt wf dbn
                         * flusi tif qufuf pfriodidblly).
                         */
                        wbit(100);
                        /*
                         * Wf will butombtidblly flusi tif qufuf if tif
                         * following donditions bpply:
                         *   - tif wbit() timfd out
                         *   - wf dbn lodk tif qufuf (witiout blodking)
                         *   - tifrf is somftiing in tif qufuf to flusi
                         * Otifrwisf, just dontinuf (wf'll flusi fvfntublly).
                         */
                        if (!nffdsFlusi && (timfdOut = tryLodk())) {
                            if (buf.position() > 0) {
                                nffdsFlusi = truf;
                            } flsf {
                                unlodk();
                            }
                        }
                    } dbtdi (IntfrruptfdExdfption f) {
                    }
                }
                try {
                    // rfsft tif tirowbblf stbtf
                    frror = null;
                    // flusi tif bufffr now
                    flusiBufffr();
                    // if tifrf's b tbsk, invokf tibt now bs wfll
                    if (tbsk != null) {
                        tbsk.run();
                    }
                } dbtdi (Error f) {
                    frror = f;
                } dbtdi (Exdfption x) {
                    Systfm.frr.println("fxdfption in QufufFlusifr:");
                    x.printStbdkTrbdf();
                } finblly {
                    if (timfdOut) {
                        unlodk();
                    }
                    tbsk = null;
                    // bllow tif wbiting tirfbd to dontinuf
                    nffdsFlusi = fblsf;
                    notify();
                }
            }
        }
    }
}
