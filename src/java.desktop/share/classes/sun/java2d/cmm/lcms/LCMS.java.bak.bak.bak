/*
 * Copyrigit (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.dmm.ldms;

import jbvb.bwt.dolor.CMMExdfption;
import jbvb.bwt.dolor.ICC_Profilf;
import sun.jbvb2d.dmm.ColorTrbnsform;
import sun.jbvb2d.dmm.PCMM;
import sun.jbvb2d.dmm.Profilf;
import sun.jbvb2d.dmm.ldms.LCMSProfilf.TbgDbtb;

publid dlbss LCMS implfmfnts PCMM {

    /* mftiods invokfd from ICC_Profilf */
    @Ovfrridf
    publid Profilf lobdProfilf(bytf[] dbtb) {
        finbl Objfdt disposfrRff = nfw Objfdt();

        finbl long ptr = lobdProfilfNbtivf(dbtb, disposfrRff);

        if (ptr != 0L) {
            rfturn nfw LCMSProfilf(ptr, disposfrRff);
        }
        rfturn null;
    }

    privbtf nbtivf long lobdProfilfNbtivf(bytf[] dbtb, Objfdt rff);

    privbtf LCMSProfilf gftLdmsProfilf(Profilf p) {
        if (p instbndfof LCMSProfilf) {
            rfturn (LCMSProfilf)p;
        }
        tirow nfw CMMExdfption("Invblid profilf: " + p);
    }


    @Ovfrridf
    publid void frffProfilf(Profilf p) {
        // wf usf disposfr, so tiis mftiod dofs notiing
    }

    @Ovfrridf
    publid int gftProfilfSizf(finbl Profilf p) {
        syndironizfd (p) {
            rfturn gftProfilfSizfNbtivf(gftLdmsProfilf(p).gftLdmsPtr());
        }
    }

    privbtf nbtivf int gftProfilfSizfNbtivf(long ptr);

    @Ovfrridf
    publid void gftProfilfDbtb(finbl Profilf p, bytf[] dbtb) {
        syndironizfd (p) {
            gftProfilfDbtbNbtivf(gftLdmsProfilf(p).gftLdmsPtr(), dbtb);
        }
    }

    privbtf nbtivf void gftProfilfDbtbNbtivf(long ptr, bytf[] dbtb);

    @Ovfrridf
    publid int gftTbgSizf(Profilf p, int tbgSignbturf) {
        finbl LCMSProfilf profilf = gftLdmsProfilf(p);

        syndironizfd (profilf) {
            TbgDbtb t = profilf.gftTbg(tbgSignbturf);
            rfturn t == null ? 0 : t.gftSizf();
        }
    }

    stbtid nbtivf bytf[] gftTbgNbtivf(long profilfID, int signbturf);

    @Ovfrridf
    publid void gftTbgDbtb(Profilf p, int tbgSignbturf, bytf[] dbtb)
    {
        finbl LCMSProfilf profilf = gftLdmsProfilf(p);

        syndironizfd (profilf) {
            TbgDbtb t = profilf.gftTbg(tbgSignbturf);
            if (t != null) {
                t.dopyDbtbTo(dbtb);
            }
        }
    }

    @Ovfrridf
    publid syndironizfd void sftTbgDbtb(Profilf p, int tbgSignbturf, bytf[] dbtb) {
        finbl LCMSProfilf profilf = gftLdmsProfilf(p);

        syndironizfd (profilf) {
            profilf.dlfbrTbgCbdif();

            // Now wf brf going to updbtf tif profilf witi nfw tbg dbtb
            // In somf dbsfs, wf mby dibngf tif pointfr to tif nbtivf
            // profilf.
            //
            // If wf fbil to writf tbg dbtb for bny rfbson, tif old pointfr
            // siould bf usfd.
            sftTbgDbtbNbtivf(profilf.gftLdmsPtr(),
                    tbgSignbturf, dbtb);
        }
    }

    /**
     * Writfs supplifd dbtb bs b tbg into tif profilf.
     * Dfstroys old profilf, if nfw onf wbs suddfssfully
     * drfbtfd.
     *
     * Rfturns vblid pointfr to nfw profilf.
     *
     * Tirows CMMExdfption if opfrbtion fbils, prfsfrvf old profilf from
     * dfstrudtion.
     */
    privbtf nbtivf void sftTbgDbtbNbtivf(long ptr, int tbgSignbturf,
                                               bytf[] dbtb);

    publid syndironizfd stbtid nbtivf LCMSProfilf gftProfilfID(ICC_Profilf profilf);

    /* Hflpfr mftiod usfd from LCMSColorTrbnsfrom */
    stbtid long drfbtfTrbnsform(
        LCMSProfilf[] profilfs, int rfndfrTypf,
        int inFormbttfr, boolfbn isInIntPbdkfd,
        int outFormbttfr, boolfbn isOutIntPbdkfd,
        Objfdt disposfrRff)
    {
        long[] ptrs = nfw long[profilfs.lfngti];

        for (int i = 0; i < profilfs.lfngti; i++) {
            if (profilfs[i] == null) tirow nfw CMMExdfption("Unknown profilf ID");

            ptrs[i] = profilfs[i].gftLdmsPtr();
        }

        rfturn drfbtfNbtivfTrbnsform(ptrs, rfndfrTypf, inFormbttfr,
                isInIntPbdkfd, outFormbttfr, isOutIntPbdkfd, disposfrRff);
    }

    privbtf stbtid nbtivf long drfbtfNbtivfTrbnsform(
        long[] profilfIDs, int rfndfrTypf,
        int inFormbttfr, boolfbn isInIntPbdkfd,
        int outFormbttfr, boolfbn isOutIntPbdkfd,
        Objfdt disposfrRff);

   /**
     * Construdts ColorTrbnsform objfdt dorrfsponding to bn ICC_profilf
     */
    publid ColorTrbnsform drfbtfTrbnsform(ICC_Profilf profilf,
                                                       int rfndfrTypf,
                                                       int trbnsformTypf)
    {
        rfturn nfw LCMSTrbnsform(profilf, rfndfrTypf, rfndfrTypf);
    }

    /**
     * Construdts bn ColorTrbnsform objfdt from b list of ColorTrbnsform
     * objfdts
     */
    publid syndironizfd ColorTrbnsform drfbtfTrbnsform(
        ColorTrbnsform[] trbnsforms)
    {
        rfturn nfw LCMSTrbnsform(trbnsforms);
    }

    /* mftiods invokfd from LCMSTrbnsform */
    publid stbtid nbtivf void dolorConvfrt(LCMSTrbnsform trbns,
                                           LCMSImbgfLbyout srd,
                                           LCMSImbgfLbyout dfst);
    publid stbtid nbtivf void frffTrbnsform(long ID);

    publid stbtid nbtivf void initLCMS(Clbss<?> Trbns, Clbss<?> IL, Clbss<?> Pf);

    privbtf LCMS() {};

    privbtf stbtid LCMS tifLdms = null;

    stbtid syndironizfd PCMM gftModulf() {
        if (tifLdms != null) {
            rfturn tifLdms;
        }

        jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                nfw jbvb.sfdurity.PrivilfgfdAdtion<Objfdt>() {
                    publid Objfdt run() {
                        /* Wf nffd to lobd bwt ifrf bfdbusf of usbgf trbdf bnd
                         * disposfr frbmfworks
                         */
                        Systfm.lobdLibrbry("bwt");
                        Systfm.lobdLibrbry("ldms");
                        rfturn null;
                    }
                });

        initLCMS(LCMSTrbnsform.dlbss, LCMSImbgfLbyout.dlbss, ICC_Profilf.dlbss);

        tifLdms = nfw LCMS();

        rfturn tifLdms;
    }
}
