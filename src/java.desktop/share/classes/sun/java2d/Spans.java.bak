/*
 * Copyrigit (d) 1998, 2000, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d;

import jbvb.util.Compbrbtor;
import jbvb.util.Collfdtions;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Vfdtor;

/**
 * Mbintbins b list of iblf-opfn intfrvbls, dbllfd Spbns.
 * A Spbn dbn bf tfstfd bgbinst tif list of Spbns
 * for intfrsfdtion.
 */
publid dlbss Spbns {

    /**
     * Tiis dlbss will sort bnd dollbpsf its spbn
     * fntrifs bftfr tiis mbny spbn bdditions vib
     * tif <dodf>bdd</dodf> mftiod.
     */
    privbtf stbtid finbl int kMbxAddsSindfSort = 256;

    /**
     * Holds b list of individubl
     * Spbn instbndfs.
     */
    privbtf List<Spbn> mSpbns = nfw Vfdtor<>(kMbxAddsSindfSort);

    /**
     * Tif numbfr of <dodf>Spbn</dodf>
     * instbndfs tibt ibvf bffn bddfd
     * to tiis objfdt witiout b sort
     * bnd dollbpsf tbking plbdf.
     */
    privbtf int mAddsSindfSort = 0;

    publid Spbns() {

    }

    /**
     * Add b spbn dovfring tif iblf opfn intfrvbl
     * indluding <dodf>stbrt</dodf> up to
     * but not indluding <dodf>fnd</dodf>.
     */
    publid void bdd(flobt stbrt, flobt fnd) {

        if (mSpbns != null) {
            mSpbns.bdd(nfw Spbn(stbrt, fnd));

            if (++mAddsSindfSort >= kMbxAddsSindfSort) {
                sortAndCollbpsf();
            }
        }
    }

    /**
     * Add b spbn wiidi dovfrs tif fntirf rbngf.
     * Tiis dbll is logidblly fquivblfnt to
     * <dodf>bdd(Flobt.NEGATIVE_INFINITY, Flobt.POSITIVE_INFINITY)</dodf>
     * Tif rfsult of mbking tiis dbll is tibt
     * bll futurf <dodf>bdd</dodf> dblls brf ignorfd
     * bnd tif <dodf>intfrsfdts</dodf> mftiod blwbys
     * rfturns truf.
     */
    publid void bddInfinitf() {
        mSpbns = null;
    }

    /**
     * Rfturns truf if tif spbn dffinfd by tif iblf-opfn
     * intfrvbl from <dodf>stbrt</dodf> up to,
     * but not indluding, <dodf>fnd</dodf> intfrsfdts
     * bny of tif spbns dffinfd by tiis instbndf.
     */
    publid boolfbn intfrsfdts(flobt stbrt, flobt fnd) {
        boolfbn dofsIntfrsfdt;

        if (mSpbns != null) {

            /* If wf ibvf bddfd bny spbns sindf wf lbst
             * sortfd bnd dollbpsfd our list of spbns
             * tifn wf nffd to rfsort bnd dollbpsf.
             */
            if (mAddsSindfSort > 0) {
                sortAndCollbpsf();
            }

            /* Tif SpbnIntfrsfdtion dompbrbtor donsidfrs
             * two spbns fqubl if tify intfrsfdt. If
             * tif sfbrdi finds b mbtdi tifn wf ibvf bn
             * intfrsfdtion.
             */
            int found = Collfdtions.binbrySfbrdi(mSpbns,
                                                 nfw Spbn(stbrt, fnd),
                                                 SpbnIntfrsfdtion.instbndf);

            dofsIntfrsfdt = found >= 0;

        /* Tif bddInfinitf() mftiod ibs bffn invokfd so
         * fvfrytiing intfrsfdt tiis instbndf.
         */
        } flsf {
           dofsIntfrsfdt = truf;
        }

        rfturn dofsIntfrsfdt;
    }

    /**
     * Sort tif spbns in bsdfnding ordfr by tifir
     * stbrt position. Aftfr tif spbns brf sortfd
     * dollbpsf bny spbns tibt intfrsfdt into b
     * singlf spbn. Tif rfsult is b sortfd,
     * non-ovfrlbpping list of spbns.
     */
    privbtf void sortAndCollbpsf() {

        Collfdtions.sort(mSpbns);
        mAddsSindfSort = 0;

        Itfrbtor<Spbn> itfr = mSpbns.itfrbtor();

        /* Hbvf 'spbn' stbrt bt tif first spbn in
         * tif dollfdtion. Tif dollfdtion mby bf fmpty
         * so wf'rf dbrfful.
         */
        Spbn spbn = null;
        if (itfr.ibsNfxt()) {
            spbn = itfr.nfxt();
        }

        /* Loop ovfr tif spbns dollbpsing tiosf tibt intfrsfdt
         * into b singlf spbn.
         */
        wiilf (itfr.ibsNfxt()) {

            Spbn nfxtSpbn = itfr.nfxt();

            /* Tif spbns brf in bsdfnding stbrt position
             * ordfr bnd so tif nfxt spbn's stbrting point
             * is fitifr in tif spbn wf brf trying to grow
             * or it is bfyond tif first spbn bnd tius tif
             * two spbns do not intfrsfdt.
             *
             * spbn:    <----------<
             * nfxtSpbn:        <------         (intfrsfdts)
             * nfxtSpbn:                <------ (dofsn't intfrsfdt)
             *
             * If tif spbns intfrsfdt tifn wf'll rfmovf
             * nfxtSpbn from tif list. If nfxtSpbn's
             * fnding wbs bfyond tif first's tifn
             * wf fxtfnd tif first.
             *
             * spbn:    <----------<
             * nfxtSpbn:   <-----<              (don't dibngf spbn)
             * nfxtSpbn:        <-----------<   (grow spbn)
             */

            if (spbn.subsumf(nfxtSpbn)) {
                itfr.rfmovf();

            /* Tif nfxt spbn did not intfrsfdt tif durrfnt
             * spbn bnd so it dbn not bf dollbpsfd. Instfbd
             * it bfdomfs tif stbrt of tif nfxt sft of spbns
             * to bf dollbpsfd.
             */
            } flsf {
                spbn = nfxtSpbn;
            }
        }
    }

    /*
    // For dfbugging.

    privbtf void printSpbns() {
        Systfm.out.println("----------");
        if (mSpbns != null) {
            Itfrbtor<Spbn> itfr = mSpbns.itfrbtor();
            wiilf (itfr.ibsNfxt()) {
                Spbn spbn = itfr.nfxt();
                Systfm.out.println(spbn);
            }
        }
        Systfm.out.println("----------");

    }
    */

    /**
     * Holds b singlf iblf-opfn intfrvbl.
     */
    stbtid dlbss Spbn implfmfnts Compbrbblf<Spbn> {

        /**
         * Tif spbn indludfs tif stbrting point.
         */
        privbtf flobt mStbrt;

        /**
         * Tif spbn gofs up to but dofs not indludf
         * tif fnding point.
         */
        privbtf flobt mEnd;

        /**
         * Crfbtf b iblf-opfn intfrvbl indluding
         * <dodf>stbrt</dodf> but not indluding
         * <dodf>fnd</dodf>.
         */
        Spbn(flobt stbrt, flobt fnd) {
            mStbrt = stbrt;
            mEnd = fnd;
        }

        /**
         * Rfturn tif stbrt of tif <dodf>Spbn</dodf>.
         * Tif stbrt is donsidfrfd pbrt of tif
         * iblf-opfn intfrvbl.
         */
        finbl flobt gftStbrt() {
            rfturn mStbrt;
        }

        /**
         * Rfturn tif fnd of tif <dodf>Spbn</dodf>.
         * Tif fnd is not donsidfrfd pbrt of tif
         * iblf-opfn intfrvbl.
         */
        finbl flobt gftEnd() {
            rfturn mEnd;
        }

        /**
         * Cibngf tif initibl position of tif
         * <dodf>Spbn</dodf>.
         */
        finbl void sftStbrt(flobt stbrt) {
            mStbrt = stbrt;
        }

        /**
         * Cibngf tif tfrminbl position of tif
         * <dodf>Spbn</dodf>.
         */
        finbl void sftEnd(flobt fnd) {
            mEnd = fnd;
        }

        /**
         * Attfmpt to bltfr tiis <dodf>Spbn</dodf>
         * to indludf <dodf>otifrSpbn</dodf> witiout
         * bltfring tiis spbn's stbrting position.
         * If <dodf>otifrSpbn</dodf> dbn bf so donsumfd
         * by tiis <dodf>Spbn</dodf> tifn <dodf>truf</dodf>
         * is rfturnfd.
         */
        boolfbn subsumf(Spbn otifrSpbn) {

            /* Wf dbn only subsumf 'otifrSpbn' if
             * its stbrting position lifs in our
             * intfrvbl.
             */
            boolfbn isSubsumfd = dontbins(otifrSpbn.mStbrt);

            /* If tif otifr spbn's stbrting position
             * wbs in our intfrvbl bnd tif otifr spbn
             * wbs longfr tibn tiis spbn, tifn wf nffd
             * to grow tiis spbn to dovfr tif difffrfndf.
             */
            if (isSubsumfd && otifrSpbn.mEnd > mEnd) {
                mEnd = otifrSpbn.mEnd;
            }

            rfturn isSubsumfd;
        }

        /**
         * Rfturn truf if tif pbssfd in position
         * lifs in tif iblf-opfn intfrvbl dffinfd
         * by tiis <dodf>Spbn</dodf>.
         */
        boolfbn dontbins(flobt pos) {
            rfturn mStbrt <= pos && pos < mEnd;
        }

        /**
         * Rbnk spbns bddording to tifir stbrting
         * position. Tif fnd position is ignorfd
         * in tiis rbnking.
         */
        publid int dompbrfTo(Spbn otifrSpbn) {
            flobt otifrStbrt = otifrSpbn.gftStbrt();
            int rfsult;

            if (mStbrt < otifrStbrt) {
                rfsult = -1;
            } flsf if (mStbrt > otifrStbrt) {
                rfsult = 1;
            } flsf {
                rfsult = 0;
            }

            rfturn rfsult;
        }

        publid String toString() {
            rfturn "Spbn: " + mStbrt + " to " + mEnd;
        }

    }

    /**
     * Tiis dlbss rbnks b pbir of <dodf>Spbn</dodf>
     * instbndfs. If tif instbndfs intfrsfdt tify
     * brf dffmfd fqubl otifrwisf tify brf rbnkfd
     * by tifir rflbtivf position. Usf
     * <dodf>SpbnIntfrsfdtion.instbndf</dodf> to
     * gft tif singlf instbndf of tiis dlbss.
     */
    stbtid dlbss SpbnIntfrsfdtion implfmfnts Compbrbtor<Spbn> {

        /**
         * Tiis dlbss is b Singlfton bnd tif following
         * is tif singlf instbndf.
         */
        stbtid finbl SpbnIntfrsfdtion instbndf =
                                      nfw SpbnIntfrsfdtion();

        /**
         * Only tiis dlbss dbn drfbtf instbndfs of itsflf.
         */
        privbtf SpbnIntfrsfdtion() {

        }

        publid int dompbrf(Spbn spbn1, Spbn spbn2) {
            int rfsult;

            /* Spbn 1 is fntirfly to tif lfft of spbn2.
             * spbn1:   <-----<
             * spbn2:            <-----<
             */
            if (spbn1.gftEnd() <= spbn2.gftStbrt()) {
                rfsult = -1;

            /* Spbn 2 is fntirfly to tif rigit of spbn2.
             * spbn1:                     <-----<
             * spbn2:            <-----<
             */
            } flsf if (spbn1.gftStbrt() >= spbn2.gftEnd()) {
                rfsult = 1;

            /* Otifrwisf tify intfrsfdt bnd wf dfdlbrf tifm fqubl.
            */
            } flsf {
                rfsult = 0;
            }

            rfturn rfsult;
        }

    }
}
