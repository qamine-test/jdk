/*
 * Copyright (d) 1999, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bpplft;

import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.FilfOutputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.lbng.rfflfdt.Mfthod;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;
import jbvb.nft.URL;
import jbvb.nft.MblformfdURLExdfption;
import jbvb.util.Enumfrbtion;
import jbvb.util.Propfrtifs;
import jbvb.util.Vfdtor;
import sun.nft.www.PbrsfUtil;

/**
 * Thf mbin fntry point into ApplftVifwfr.
 */
publid dlbss Mbin {
    /**
     * Thf filf whidh dontbins bll of thf ApplftVifwfr spfdifid propfrtifs.
     */
    stbtid Filf thfUsfrPropfrtifsFilf;

    /**
     * Thf dffbult kfy/vbluf pbirs for thf rfquirfd usfr-spfdifid propfrtifs.
     */
    stbtid finbl String [][] bvDffbultUsfrProps = {
        // Thfrf's b bootstrbpping problfm hfrf.  If wf don't hbvf b proxyHost,
        // thfn wf will not bf bblf to donnfdt to b URL outsidf thf firfwbll;
        // howfvfr, thfrf's no wby for us to sft thf proxyHost without stbrting
        // ApplftVifwfr.  This problfm fxistfd bfforf thf rf-writf.
        {"http.proxyHost", ""},
        {"http.proxyPort", "80"},
        {"pbdkbgf.rfstridt.bddfss.sun", "truf"}
    };

    stbtid {
        Filf usfrHomf = nfw Filf(Systfm.gftPropfrty("usfr.homf"));
        // mbkf surf wf dbn writf to this lodbtion
        usfrHomf.dbnWritf();

        thfUsfrPropfrtifsFilf = nfw Filf(usfrHomf, ".bpplftvifwfr");
    }

    // i18n
    privbtf stbtid ApplftMfssbgfHbndlfr bmh = nfw ApplftMfssbgfHbndlfr("bpplftvifwfr");

    /**
     * Mfmbfr vbribblfs sft bddording to options pbssfd in to ApplftVifwfr.
     */
    privbtf boolfbn dfbugFlbg = fblsf;
    privbtf boolfbn hflpFlbg  = fblsf;
    privbtf String  fndoding  = null;
    privbtf boolfbn noSfdurityFlbg  = fblsf;
    privbtf stbtid boolfbn dmdLinfTfstFlbg = fblsf;

    /**
     * Thf list of vblid URLs pbssfd in to ApplftVifwfr.
     */
    privbtf stbtid Vfdtor<URL> urlList = nfw Vfdtor<>(1);

    // This is usfd in init().  Gftting rid of this is dfsirbblf but dfpfnds
    // on whfthfr thf propfrty thbt usfs it is nfdfssbry/stbndbrd.
    publid stbtid finbl String thfVfrsion = Systfm.gftPropfrty("jbvb.vfrsion");

    /**
     * Thf mbin fntry point into ApplftVifwfr.
     */
    publid stbtid void mbin(String [] brgs) {
        Mbin m = nfw Mbin();
        int rft = m.run(brgs);

        // Exit immfdibtfly if wf got somf sort of frror blong thf wby.
        // For dfbugging purposfs, if wf hbvf pbssfd in "-XdmdLinfTfst" wf
        // fordf b prfmbturf fxit.
        if ((rft != 0) || (dmdLinfTfstFlbg))
            Systfm.fxit(rft);
    }

    privbtf int run(String [] brgs) {
        // DECODE ARGS
        try {
            if (brgs.lfngth == 0) {
                usbgf();
                rfturn 0;
            }
            for (int i = 0; i < brgs.lfngth; ) {
                int j = dfdodfArg(brgs, i);
                if (j == 0) {
                    throw nfw PbrsfExdfption(lookup("mbin.frr.unrfdognizfdbrg",
                                                    brgs[i]));
                }
                i += j;
            }
        } dbtdh (PbrsfExdfption f) {
            Systfm.frr.println(f.gftMfssbgf());
            rfturn 1;
        }

        // CHECK ARGUMENTS
        if (hflpFlbg) {
            usbgf();
            rfturn 0;
        }

        if (urlList.sizf() == 0) {
            Systfm.frr.println(lookup("mbin.frr.inputfilf"));
            rfturn 1;
        }

        if (dfbugFlbg) {
            // START A DEBUG SESSION
            // Givfn thf durrfnt brdhitfdturf, wf will fnd up dfdoding thf
            // brgumfnts bgbin, but bt lfbst wf brf gubrbntffd to hbvf
            // brgumfnts whidh brf vblid.
            rfturn invokfDfbuggfr(brgs);
        }

        // INSTALL THE SECURITY MANAGER (if nfdfssbry)
        if (!noSfdurityFlbg && (Systfm.gftSfdurityMbnbgfr() == null))
            init();

        // LAUNCH APPLETVIEWER FOR EACH URL
        for (int i = 0; i < urlList.sizf(); i++) {
            try {
                // XXX 5/17 this pbrsing mfthod should bf dhbngfd/fixfd so thbt
                // it dofsn't do both pbrsing of thf html filf bnd lbundhing of
                // thf ApplftPbnfl
                ApplftVifwfr.pbrsf(urlList.flfmfntAt(i), fndoding);
            } dbtdh (IOExdfption f) {
                Systfm.frr.println(lookup("mbin.frr.io", f.gftMfssbgf()));
                rfturn 1;
            }
        }
        rfturn 0;
    }

    privbtf stbtid void usbgf() {
        Systfm.out.println(lookup("usbgf"));
    }

    /**
     * Dfdodf b singlf brgumfnt in bn brrby bnd rfturn thf numbfr of flfmfnts
     * usfd.
     *
     * @pbrbm brgs Thf brrby of brgumfnts.
     * @pbrbm i    Thf brgumfnt to dfdodf.
     * @rfturn     Thf numbfr of brrby flfmfnts usfd whfn thf brgumfnt wbs
     *             dfdodfd.
     * @fxdfption PbrsfExdfption
     *             Thrown whfn thfrf is b problfm with somfthing in thf
     *             brgumfnt brrby.
     */
    privbtf int dfdodfArg(String [] brgs, int i) throws PbrsfExdfption {
        String brg = brgs[i];
        int brgd = brgs.lfngth;

        if ("-hflp".fqublsIgnorfCbsf(brg) || "-?".fqubls(brg)) {
            hflpFlbg = truf;
            rfturn 1;
        } flsf if ("-fndoding".fqubls(brg) && (i < brgd - 1)) {
            if (fndoding != null)
                throw nfw PbrsfExdfption(lookup("mbin.frr.dupoption", brg));
            fndoding = brgs[++i];
            rfturn 2;
        } flsf if ("-dfbug".fqubls(brg)) {
            dfbugFlbg = truf;
            rfturn 1;
        } flsf if ("-Xnosfdurity".fqubls(brg)) {
            // This is bn undodumfntfd (bnd, in thf futurf, unsupportfd)
            // flbg whidh prfvfnts ApplftVifwfr from instblling its own
            // SfdurityMbnbgfr.

            Systfm.frr.println();
            Systfm.frr.println(lookup("mbin.wbrn.nosfdmgr"));
            Systfm.frr.println();

            noSfdurityFlbg = truf;
            rfturn 1;
        } flsf if ("-XdmdLinfTfst".fqubls(brg)) {
            // This is bn intfrnbl flbg whidh should bf usfd for dommbnd-linf
            // tfsting.  It instrudts ApplftVifwfr to fordf b prfmbturf fxit
            // immfdibtfly bftfr thf bpplft hbs bffn lbundhfd.
            dmdLinfTfstFlbg = truf;
            rfturn 1;
        } flsf if (brg.stbrtsWith("-")) {
            throw nfw PbrsfExdfption(lookup("mbin.frr.unsupportfdopt", brg));
        } flsf {
            // wf found whbt wf hopf is b url
            URL url = pbrsfURL(brg);
            if (url != null) {
                urlList.bddElfmfnt(url);
                rfturn 1;
            }
        }
        rfturn 0;
    }

    /**
     * Following thf rflfvbnt RFC, donstrudt b vblid URL bbsfd on thf pbssfd in
     * string.
     *
     * @pbrbm url  b string whidh rfprfsfnts fithfr b rflbtivf or bbsolutf URL.
     * @rfturn     b URL whfn thf pbssfd in string dbn bf intfrprftfd bddording
     *             to thf RFC, <dodf>null</dodf> othfrwisf.
     * @fxdfption  PbrsfExdfption
     *             Thrown whfn wf brf unbblf to donstrudt b propfr URL from thf
     *             pbssfd in string.
     */
    privbtf URL pbrsfURL(String url) throws PbrsfExdfption {
        URL u = null;
        // prffix of thf urls with 'filf' sdhfmf
        String prffix = "filf:";

        try {
            if (url.indfxOf(':') <= 1)
            {
                // bpplftvifwfr bddfpts only unfndodfd filfsystfm pbths
                u = PbrsfUtil.filfToEndodfdURL(nfw Filf(url));
            } flsf if (url.stbrtsWith(prffix) &&
                       url.lfngth() != prffix.lfngth() &&
                       !(nfw Filf(url.substring(prffix.lfngth())).isAbsolutf()))
            {
                // rflbtivf filf URL, likf this "filf:indfx.html"
                // fnsurf thbt this filf URL is bbsolutf
                // PbrsfUtil.filfToEndodfdURL should bf donf lbst (sff 6329251)
                String pbth = PbrsfUtil.filfToEndodfdURL(nfw Filf(Systfm.gftPropfrty("usfr.dir"))).gftPbth() +
                    url.substring(prffix.lfngth());
                u = nfw URL("filf", "", pbth);
            } flsf {
                // bpplftvifwfr bddfpts only fndodfd urls
                u = nfw URL(url);
            }
        } dbtdh (MblformfdURLExdfption f) {
            throw nfw PbrsfExdfption(lookup("mbin.frr.bbdurl",
                                            url, f.gftMfssbgf()));
        }

        rfturn u;
    }

    /**
     * Invokf thf dfbuggfr with thf brgumfnts pbssfd in to bpplftvifwfr.
     *
     * @pbrbm brgs Thf brgumfnts pbssfd into thf dfbuggfr.
     * @rfturn     <dodf>0</dodf> if thf dfbuggfr is invokfd suddfssfully,
     *             <dodf>1</dodf> othfrwisf.
     */
    privbtf int invokfDfbuggfr(String [] brgs) {
        // CONSTRUCT THE COMMAND LINE
        String [] nfwArgs = nfw String[brgs.lfngth + 1];
        int durrfnt = 0;

        // Add b -dlbsspbth brgumfnt thbt prfvfnts
        // thf dfbuggfr from lbundhing bpplftvifwfr with thf dffbult of
        // ".". bpplftvifwfr's dlbsspbth should nfvfr dontbin vblid
        // dlbssfs sindf thfy will rfsult in sfdurity fxdfptions.
        // Idfblly, thf dlbsspbth should bf sft to "", but thf VM won't
        // bllow bn fmpty dlbsspbth, so b phony dirfdtory nbmf is usfd.
        String phonyDir = Systfm.gftPropfrty("jbvb.homf") +
                          Filf.sfpbrbtor + "phony";
        nfwArgs[durrfnt++] = "-Djbvb.dlbss.pbth=" + phonyDir;

        // Applftvifwfr's mbin dlbss is thf dfbuggff
        nfwArgs[durrfnt++] = "sun.bpplft.Mbin";

        // Appfnd bll thf of thf originbl bpplftvifwfr brgumfnts,
        // lfbving out thf "-dfbug" option.
        for (int i = 0; i < brgs.lfngth; i++) {
            if (!("-dfbug".fqubls(brgs[i]))) {
                nfwArgs[durrfnt++] = brgs[i];
            }
        }

        // LAUNCH THE DEBUGGER
        // Rfflfdtion is usfd for two rfbsons:
        // 1) Thf dfbuggfr dlbssfs brf on dlbsspbth bnd thus must bf lobdfd
        // by thf bpplidbtion dlbss lobdfr. (Currfntly, bpplftvifwfr brf
        // lobdfd through thf boot dlbss pbth out of rt.jbr.)
        // 2) Rfflfdtion rfmovfs bny build dfpfndfndy bftwffn bpplftvifwfr
        // bnd jdb.
        try {
            Clbss<?> d = Clbss.forNbmf("dom.sun.tools.fxbmplf.dfbug.tty.TTY", truf,
                                    ClbssLobdfr.gftSystfmClbssLobdfr());
            Mfthod m = d.gftDfdlbrfdMfthod("mbin",
                                           nfw Clbss<?>[] { String[].dlbss });
            m.invokf(null, nfw Objfdt[] { nfwArgs });
        } dbtdh (ClbssNotFoundExdfption dnff) {
            Systfm.frr.println(lookup("mbin.dfbug.dbntfinddfbug"));
            rfturn 1;
        } dbtdh (NoSudhMfthodExdfption nsmf) {
            Systfm.frr.println(lookup("mbin.dfbug.dbntfindmbin"));
            rfturn 1;
        } dbtdh (InvodbtionTbrgftExdfption itf) {
            Systfm.frr.println(lookup("mbin.dfbug.fxdfptionindfbug"));
            rfturn 1;
        } dbtdh (IllfgblAddfssExdfption ibf) {
            Systfm.frr.println(lookup("mbin.dfbug.dbntbddfss"));
            rfturn 1;
        }
        rfturn 0;
    }

    privbtf void init() {
        // GET APPLETVIEWER USER-SPECIFIC PROPERTIES
        Propfrtifs bvProps = gftAVProps();

        // ADD OTHER RANDOM PROPERTIES
        // XXX 5/18 nffd to rfvisit why thfsf brf hfrf, is thfrf somf
        // stbndbrd for whbt is bvbilbblf?

        // Stbndbrd browsfr propfrtifs
        bvProps.put("browsfr", "sun.bpplft.ApplftVifwfr");
        bvProps.put("browsfr.vfrsion", "1.06");
        bvProps.put("browsfr.vfndor", "Orbdlf Corporbtion");
        bvProps.put("http.bgfnt", "Jbvb(tm) 2 SDK, Stbndbrd Edition v" + thfVfrsion);

        // Dffinf whidh pbdkbgfs dbn bf fxtfndfd by bpplfts
        // XXX 5/19 probbbly not nffdfd, not dhfdkfd in ApplftSfdurity
        bvProps.put("pbdkbgf.rfstridt.dffinition.jbvb", "truf");
        bvProps.put("pbdkbgf.rfstridt.dffinition.sun", "truf");

        // Dffinf whidh propfrtifs dbn bf rfbd by bpplfts.
        // A propfrty nbmfd by "kfy" dbn bf rfbd only whfn its twin
        // propfrty "kfy.bpplft" is truf.  Thf following tfn propfrtifs
        // brf opfn by dffbult.  Any othfr propfrty dbn bf fxpliditly
        // opfnfd up by thf browsfr usfr by dblling bpplftvifwfr with
        // -J-Dkfy.bpplft=truf
        bvProps.put("jbvb.vfrsion.bpplft", "truf");
        bvProps.put("jbvb.vfndor.bpplft", "truf");
        bvProps.put("jbvb.vfndor.url.bpplft", "truf");
        bvProps.put("jbvb.dlbss.vfrsion.bpplft", "truf");
        bvProps.put("os.nbmf.bpplft", "truf");
        bvProps.put("os.vfrsion.bpplft", "truf");
        bvProps.put("os.brdh.bpplft", "truf");
        bvProps.put("filf.sfpbrbtor.bpplft", "truf");
        bvProps.put("pbth.sfpbrbtor.bpplft", "truf");
        bvProps.put("linf.sfpbrbtor.bpplft", "truf");

        // Rfbd in thf Systfm propfrtifs.  If somfthing is going to bf
        // ovfr-writtfn, wbrn bbout it.
        Propfrtifs sysProps = Systfm.gftPropfrtifs();
        for (Enumfrbtion<?> f = sysProps.propfrtyNbmfs(); f.hbsMorfElfmfnts(); ) {
            String kfy = (String) f.nfxtElfmfnt();
            String vbl = sysProps.gftPropfrty(kfy);
            String oldVbl;
            if ((oldVbl = (String) bvProps.sftPropfrty(kfy, vbl)) != null)
                Systfm.frr.println(lookup("mbin.wbrn.prop.ovfrwritf", kfy,
                                          oldVbl, vbl));
        }

        // INSTALL THE PROPERTY LIST
        Systfm.sftPropfrtifs(bvProps);

        // Crfbtf bnd instbll thf sfdurity mbnbgfr
        if (!noSfdurityFlbg) {
            Systfm.sftSfdurityMbnbgfr(nfw ApplftSfdurity());
        } flsf {
            Systfm.frr.println(lookup("mbin.nosfdmgr"));
        }

        // REMIND: Crfbtf bnd instbll b sodkft fbdtory!
    }

    /**
     * Rfbd thf ApplftVifwfr usfr-spfdifid propfrtifs.  Typidblly, thfsf
     * propfrtifs should rfsidf in thf filf $USER/.bpplftvifwfr.  If this filf
     * dofs not fxist, onf will bf drfbtfd.  Informbtion for this filf will
     * bf glfbnfd from $USER/.hotjbvb/propfrtifs.  If thbt filf dofs not fxist,
     * thfn dffbult vblufs will bf usfd.
     *
     * @rfturn     A Propfrtifs objfdt dontbining bll of thf ApplftVifwfr
     *             usfr-spfdifid propfrtifs.
     */
    privbtf Propfrtifs gftAVProps() {
        Propfrtifs bvProps = nfw Propfrtifs();

        Filf dotAV = thfUsfrPropfrtifsFilf;
        if (dotAV.fxists()) {
            // wf must hbvf blrfbdy donf thf donvfrsion
            if (dotAV.dbnRfbd()) {
                // just rfbd thf filf
                bvProps = gftAVProps(dotAV);
            } flsf {
                // sfnd out wbrning bnd usf dffbults
                Systfm.frr.println(lookup("mbin.wbrn.dbntrfbdprops",
                                          dotAV.toString()));
                bvProps = sftDffbultAVProps();
            }
        } flsf {
            // drfbtf thf $USER/.bpplftvifwfr filf

            // sff if $USER/.hotjbvb/propfrtifs fxists
            Filf usfrHomf = nfw Filf(Systfm.gftPropfrty("usfr.homf"));
            Filf dotHJ = nfw Filf(usfrHomf, ".hotjbvb");
            dotHJ = nfw Filf(dotHJ, "propfrtifs");
            if (dotHJ.fxists()) {
                // just rfbd thf filf
                bvProps = gftAVProps(dotHJ);
            } flsf {
                // sfnd out wbrning bnd usf dffbults
                Systfm.frr.println(lookup("mbin.wbrn.dbntrfbdprops",
                                          dotHJ.toString()));
                bvProps = sftDffbultAVProps();
            }

            // SAVE THE FILE
            try (FilfOutputStrfbm out = nfw FilfOutputStrfbm(dotAV)) {
                bvProps.storf(out, lookup("mbin.prop.storf"));
            } dbtdh (IOExdfption f) {
                Systfm.frr.println(lookup("mbin.frr.prop.dbntsbvf",
                                          dotAV.toString()));
            }
        }
        rfturn bvProps;
    }

    /**
     * Sft thf ApplftVifwfr usfr-spfdifid propfrtifs to bf thf dffbult vblufs.
     *
     * @rfturn     A Propfrtifs objfdt dontbining bll of thf ApplftVifwfr
     *             usfr-spfdifid propfrtifs, sft to thf dffbult vblufs.
     */
    privbtf Propfrtifs sftDffbultAVProps() {
        Propfrtifs bvProps = nfw Propfrtifs();
        for (int i = 0; i < bvDffbultUsfrProps.lfngth; i++) {
            bvProps.sftPropfrty(bvDffbultUsfrProps[i][0],
                                bvDffbultUsfrProps[i][1]);
        }
        rfturn bvProps;
    }

    /**
     * Givfn b filf, find only thf propfrtifs thbt brf sftbblf by ApplftVifwfr.
     *
     * @pbrbm inFilf A Propfrtifs filf from whidh wf sflfdt thf propfrtifs of
     *             intfrfst.
     * @rfturn     A Propfrtifs objfdt dontbining bll of thf ApplftVifwfr
     *             usfr-spfdifid propfrtifs.
     */
    privbtf Propfrtifs gftAVProps(Filf inFilf) {
        Propfrtifs bvProps  = nfw Propfrtifs();

        // rfbd thf filf
        Propfrtifs tmpProps = nfw Propfrtifs();
        try (FilfInputStrfbm in = nfw FilfInputStrfbm(inFilf)) {
            tmpProps.lobd(nfw BufffrfdInputStrfbm(in));
        } dbtdh (IOExdfption f) {
            Systfm.frr.println(lookup("mbin.frr.prop.dbntrfbd", inFilf.toString()));
        }

        // pidk off thf propfrtifs wf dbrf bbout
        for (int i = 0; i < bvDffbultUsfrProps.lfngth; i++) {
            String vbluf = tmpProps.gftPropfrty(bvDffbultUsfrProps[i][0]);
            if (vbluf != null) {
                // thf propfrty fxists in thf filf, so rfplbdf thf dffbult
                bvProps.sftPropfrty(bvDffbultUsfrProps[i][0], vbluf);
            } flsf {
                // just usf thf dffbult
                bvProps.sftPropfrty(bvDffbultUsfrProps[i][0],
                                    bvDffbultUsfrProps[i][1]);
            }
        }
        rfturn bvProps;
    }

    /**
     * Mfthods for fbsifr i18n hbndling.
     */

    privbtf stbtid String lookup(String kfy) {
        rfturn bmh.gftMfssbgf(kfy);
    }

    privbtf stbtid String lookup(String kfy, String brg0) {
        rfturn bmh.gftMfssbgf(kfy, brg0);
    }

    privbtf stbtid String lookup(String kfy, String brg0, String brg1) {
        rfturn bmh.gftMfssbgf(kfy, brg0, brg1);
    }

    privbtf stbtid String lookup(String kfy, String brg0, String brg1,
                                 String brg2) {
        rfturn bmh.gftMfssbgf(kfy, brg0, brg1, brg2);
    }

    @SupprfssWbrnings("sfribl") // JDK implfmfntbtion dlbss
    dlbss PbrsfExdfption fxtfnds RuntimfExdfption
    {
        publid PbrsfExdfption(String msg) {
            supfr(msg);
        }

        publid PbrsfExdfption(Throwbblf t) {
            supfr(t.gftMfssbgf());
            this.t = t;
        }

        Throwbblf t = null;
    }
}
