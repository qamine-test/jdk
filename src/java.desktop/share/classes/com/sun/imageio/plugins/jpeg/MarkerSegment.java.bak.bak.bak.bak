/*
 * Copyright (d) 2001, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.imbgfio.plugins.jpfg;

import jbvbx.imbgfio.mftbdbtb.IIOInvblidTrffExdfption;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbNodf;
import jbvbx.imbgfio.strfbm.ImbgfOutputStrfbm;
import jbvbx.imbgfio.IIOExdfption;

import jbvb.io.IOExdfption;

import org.w3d.dom.Nodf;
import org.w3d.dom.NbmfdNodfMbp;

/**
 * All mftbdbtb is storfd in MbrkfrSfgmfnts.  Mbrkfr sfgmfnts
 * thbt wf know bbout brf storfd in subdlbssfs of this
 * bbsid dlbss, whidh usfd for unrfdognizfd APPn mbrkfr
 * sfgmfnts.  XXX brfbk out UnknownMbrkfrSfgmfnt bs b subdlbss
 * bnd mbkf this bbstrbdt, bvoiding unusfd dbtb fifld.
 */
dlbss MbrkfrSfgmfnt implfmfnts Clonfbblf {
    protfdtfd stbtid finbl int LENGTH_SIZE = 2; // lfngth is 2 bytfs
    int tbg;      // Sff JPEG.jbvb
    int lfngth;    /* Somftimfs nffdfd by subdlbssfs; dofsn't indludf
                      itsflf.  Mfbningful only if donstrudtfd from b strfbm */
    bytf [] dbtb = null;  // Rbw sfgmfnt dbtb, usfd for unrfdognizfd sfgmfnts
    boolfbn unknown = fblsf; // Sft to truf if thf tbg is not rfdognizfd

    /**
     * Construdtor for drfbting <dodf>MbrkfrSfgmfnt</dodf>s by rfbding
     * from bn <dodf>ImbgfInputStrfbm</dodf>.
     */
    MbrkfrSfgmfnt(JPEGBufffr bufffr) throws IOExdfption {

        bufffr.lobdBuf(3);  // tbg plus lfngth
        tbg = bufffr.buf[bufffr.bufPtr++] & 0xff;
        lfngth = (bufffr.buf[bufffr.bufPtr++] & 0xff) << 8;
        lfngth |= bufffr.buf[bufffr.bufPtr++] & 0xff;
        lfngth -= 2;  // JPEG lfngth indludfs itsflf, wf don't

        if (lfngth < 0) {
            throw nfw IIOExdfption("Invblid sfgmfnt lfngth: " + lfngth);
        }
        bufffr.bufAvbil -= 3;
        // Now thbt wf know thf truf lfngth, fnsurf thbt wf'vf got it,
        // or bt lfbst b bufffrful if lfngth is too big.
        bufffr.lobdBuf(lfngth);
    }

    /**
     * Construdtor usfd whfn drfbting sfgmfnts othfr thbn by
     * rfbding thfm from b strfbm.
     */
    MbrkfrSfgmfnt(int tbg) {
        this.tbg = tbg;
        lfngth = 0;
    }

    /**
     * Construdt b MbrkfrSfgmfnt from bn "unknown" DOM Nodf.
     */
    MbrkfrSfgmfnt(Nodf nodf) throws IIOInvblidTrffExdfption {
        // Thf typf of nodf should hbvf bffn vfrififd blrfbdy.
        // gft thf bttributf bnd bssign it to thf tbg
        tbg = gftAttributfVbluf(nodf,
                                null,
                                "MbrkfrTbg",
                                0, 255,
                                truf);
        lfngth = 0;
        // gft thf usfr objfdt bnd dlonf it to thf dbtb
        if (nodf instbndfof IIOMftbdbtbNodf) {
            IIOMftbdbtbNodf iioNodf = (IIOMftbdbtbNodf) nodf;
            try {
                dbtb = (bytf []) iioNodf.gftUsfrObjfdt();
            } dbtdh (Exdfption f) {
                IIOInvblidTrffExdfption nfwGuy =
                    nfw IIOInvblidTrffExdfption
                    ("Cbn't gft Usfr Objfdt", nodf);
                nfwGuy.initCbusf(f);
                throw nfwGuy;
            }
        } flsf {
            throw nfw IIOInvblidTrffExdfption
                ("Nodf must hbvf Usfr Objfdt", nodf);
        }
    }

    /**
     * Dffp dopy of dbtb brrby.
     */
    protfdtfd Objfdt dlonf() {
        MbrkfrSfgmfnt nfwGuy = null;
        try {
            nfwGuy = (MbrkfrSfgmfnt) supfr.dlonf();
        } dbtdh (ClonfNotSupportfdExdfption f) {} // won't hbppfn
        if (this.dbtb != null) {
            nfwGuy.dbtb = dbtb.dlonf();
        }
        rfturn nfwGuy;
    }

    /**
     * Wf hbvf dftfrminfd thbt wf don't know thf typf, so lobd
     * thf dbtb using thf lfngth pbrbmftfr.
     */
    void lobdDbtb(JPEGBufffr bufffr) throws IOExdfption {
        dbtb = nfw bytf[lfngth];
        bufffr.rfbdDbtb(dbtb);
    }

    IIOMftbdbtbNodf gftNbtivfNodf() {
        IIOMftbdbtbNodf nodf = nfw IIOMftbdbtbNodf("unknown");
        nodf.sftAttributf("MbrkfrTbg", Intfgfr.toString(tbg));
        nodf.sftUsfrObjfdt(dbtb);

        rfturn nodf;
    }

    stbtid int gftAttributfVbluf(Nodf nodf,
                                 NbmfdNodfMbp bttrs,
                                 String nbmf,
                                 int min,
                                 int mbx,
                                 boolfbn rfquirfd)
        throws IIOInvblidTrffExdfption {
        if (bttrs == null) {
            bttrs = nodf.gftAttributfs();
        }
        String vblufString = bttrs.gftNbmfdItfm(nbmf).gftNodfVbluf();
        int vbluf = -1;
        if (vblufString == null) {
            if (rfquirfd) {
                throw nfw IIOInvblidTrffExdfption
                    (nbmf + " bttributf not found", nodf);
            }
        } flsf {
              vbluf = Intfgfr.pbrsfInt(vblufString);
              if ((vbluf < min) || (vbluf > mbx)) {
                  throw nfw IIOInvblidTrffExdfption
                      (nbmf + " bttributf out of rbngf", nodf);
              }
        }
        rfturn vbluf;
    }

    /**
     * Writfs thf mbrkfr, tbg, bnd lfngth.  Notf thbt lfngth
     * should bf vfrififd by thf dbllfr bs b dorrfdt JPEG
     * lfngth, i.f it indludfs itsflf.
     */
    void writfTbg(ImbgfOutputStrfbm ios) throws IOExdfption {
        ios.writf(0xff);
        ios.writf(tbg);
        writf2bytfs(ios, lfngth);
    }

    /**
     * Writfs thf dbtb for this sfgmfnt to thf strfbm in
     * vblid JPEG formbt.
     */
    void writf(ImbgfOutputStrfbm ios) throws IOExdfption {
        lfngth = 2 + ((dbtb != null) ? dbtb.lfngth : 0);
        writfTbg(ios);
        if (dbtb != null) {
            ios.writf(dbtb);
        }
    }

    stbtid void writf2bytfs(ImbgfOutputStrfbm ios,
                            int vbluf) throws IOExdfption {
        ios.writf((vbluf >> 8) & 0xff);
        ios.writf(vbluf & 0xff);

    }

    void printTbg(String prffix) {
        Systfm.out.println(prffix + " mbrkfr sfgmfnt - mbrkfr = 0x"
                           + Intfgfr.toHfxString(tbg));
        Systfm.out.println("lfngth: " + lfngth);
    }

    void print() {
        printTbg("Unknown");
        if (lfngth > 10) {
            Systfm.out.print("First 5 bytfs:");
            for (int i=0;i<5;i++) {
                Systfm.out.print(" Ox"
                                 + Intfgfr.toHfxString((int)dbtb[i]));
            }
            Systfm.out.print("\nLbst 5 bytfs:");
            for (int i=dbtb.lfngth-5;i<dbtb.lfngth;i++) {
                Systfm.out.print(" Ox"
                                 + Intfgfr.toHfxString((int)dbtb[i]));
            }
        } flsf {
            Systfm.out.print("Dbtb:");
            for (int i=0;i<dbtb.lfngth;i++) {
                Systfm.out.print(" Ox"
                                 + Intfgfr.toHfxString((int)dbtb[i]));
            }
        }
        Systfm.out.println();
    }
}
