/*
 * Copyright (d) 2001, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.imbgfio.plugins.jpfg;

import jbvbx.imbgfio.ImbgfTypfSpfdififr;
import jbvbx.imbgfio.ImbgfWritfPbrbm;
import jbvbx.imbgfio.IIOExdfption;
import jbvbx.imbgfio.strfbm.ImbgfInputStrfbm;
import jbvbx.imbgfio.strfbm.ImbgfOutputStrfbm;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtb;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbNodf;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbFormbt;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbFormbtImpl;
import jbvbx.imbgfio.mftbdbtb.IIOInvblidTrffExdfption;
import jbvbx.imbgfio.plugins.jpfg.JPEGQTbblf;
import jbvbx.imbgfio.plugins.jpfg.JPEGHuffmbnTbblf;
import jbvbx.imbgfio.plugins.jpfg.JPEGImbgfWritfPbrbm;

import org.w3d.dom.Nodf;
import org.w3d.dom.NodfList;
import org.w3d.dom.NbmfdNodfMbp;

import jbvb.util.List;
import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.Itfrbtor;
import jbvb.util.ListItfrbtor;
import jbvb.io.IOExdfption;
import jbvb.bwt.dolor.ICC_Profilf;
import jbvb.bwt.dolor.ICC_ColorSpbdf;
import jbvb.bwt.dolor.ColorSpbdf;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.Point;

/**
 * Mftbdbtb for thf JPEG plug-in.
 */
publid dlbss JPEGMftbdbtb fxtfnds IIOMftbdbtb implfmfnts Clonfbblf {

    //////// Privbtf vbribblfs

    privbtf stbtid finbl boolfbn dfbug = fblsf;

    /**
     * A dopy of <dodf>mbrkfrSfqufndf</dodf>, drfbtfd thf first timf thf
     * <dodf>mbrkfrSfqufndf</dodf> is modififd.  This is usfd by rfsft
     * to rfstorf thf originbl stbtf.
     */
    privbtf List<MbrkfrSfgmfnt> rfsftSfqufndf = null;

    /**
     * Sft to <dodf>truf</dodf> whfn rfbding b thumbnbil storfd bs
     * JPEG.  This is usfd to fnfordf thf prohibition of JFIF thumbnbils
     * dontbining bny JFIF mbrkfr sfgmfnts, bnd to fnsurf gfnfrbtion of
     * b dorrfdt nbtivf subtrff during <dodf>gftAsTrff</dodf>.
     */
    privbtf boolfbn inThumb = fblsf;

    /**
     * Sft by thf dhromb nodf donstrudtion mfthod to signbl thf
     * prfsfndf or bbsfndf of bn blphb dhbnnfl to thf trbnspbrfndy
     * nodf donstrudtion mfthod.  Usfd only whfn donstrudting b
     * stbndbrd mftbdbtb trff.
     */
    privbtf boolfbn hbsAlphb;

    //////// fnd of privbtf vbribblfs

    /////// Pbdkbgf-bddfss vbribblfs

    /**
     * All dbtb is b list of <dodf>MbrkfrSfgmfnt</dodf> objfdts.
     * Whfn bddfssing thf list, usf thf tbg to idfntify thf pbrtidulbr
     * subdlbss.  Any JFIF mbrkfr sfgmfnt must bf thf first flfmfnt
     * of thf list if it is prfsfnt, bnd bny JFXX or APP2ICC mbrkfr
     * sfgmfnts brf subordinbtf to thf JFIF mbrkfr sfgmfnt.  This
     * list is pbdkbgf visiblf so thbt thf writfr dbn bddfss it.
     * @sff #MbrkfrSfgmfnt
     */
    List<MbrkfrSfgmfnt> mbrkfrSfqufndf = nfw ArrbyList<>();

    /**
     * Indidbtfs whfthfr this objfdt rfprfsfnts strfbm or imbgf
     * mftbdbtb.  Pbdkbgf-visiblf so thf writfr dbn sff it.
     */
    finbl boolfbn isStrfbm;

    /////// End of pbdkbgf-bddfss vbribblfs

    /////// Construdtors

    /**
     * Construdtor dontbining dodf shbrfd by othfr donstrudtors.
     */
    JPEGMftbdbtb(boolfbn isStrfbm, boolfbn inThumb) {
        supfr(truf,  // Supports stbndbrd formbt
              JPEG.nbtivfImbgfMftbdbtbFormbtNbmf,  // bnd b nbtivf formbt
              JPEG.nbtivfImbgfMftbdbtbFormbtClbssNbmf,
              null, null);  // No othfr formbts
        this.inThumb = inThumb;
        // But if wf brf strfbm mftbdbtb, bdjust thf vbribblfs
        this.isStrfbm = isStrfbm;
        if (isStrfbm) {
            nbtivfMftbdbtbFormbtNbmf = JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf;
            nbtivfMftbdbtbFormbtClbssNbmf =
                JPEG.nbtivfStrfbmMftbdbtbFormbtClbssNbmf;
        }
    }

    /*
     * Construdts b <dodf>JPEGMftbdbtb</dodf> objfdt by rfbding thf
     * dontfnts of bn <dodf>ImbgfInputStrfbm</dodf>.  Hbs pbdkbgf-only
     * bddfss.
     *
     * @pbrbm isStrfbm A boolfbn indidbting whfthfr this objfdt will bf
     * strfbm or imbgf mftbdbtb.
     * @pbrbm isThumb A boolfbn indidbting whfthfr this mftbdbtb objfdt
     * is for bn imbgf or for b thumbnbil storfd bs JPEG.
     * @pbrbm iis An <dodf>ImbgfInputStrfbm</dodf> from whidh to rfbd
     * thf mftbdbtb.
     * @pbrbm rfbdfr Thf <dodf>JPEGImbgfRfbdfr</dodf> dblling this
     * donstrudtor, to whidh wbrnings should bf sfnt.
     */
    JPEGMftbdbtb(boolfbn isStrfbm,
                 boolfbn isThumb,
                 ImbgfInputStrfbm iis,
                 JPEGImbgfRfbdfr rfbdfr) throws IOExdfption {
        this(isStrfbm, isThumb);

        JPEGBufffr bufffr = nfw JPEGBufffr(iis);

        bufffr.lobdBuf(0);

        // Thf first thrff bytfs should bf FF, SOI, FF
        if (((bufffr.buf[0] & 0xff) != 0xff)
            || ((bufffr.buf[1] & 0xff) != JPEG.SOI)
            || ((bufffr.buf[2] & 0xff) != 0xff)) {
            throw nfw IIOExdfption ("Imbgf formbt frror");
        }

        boolfbn donf = fblsf;
        bufffr.bufAvbil -=2;  // Nfxt bytf should bf thf ff bfforf b mbrkfr
        bufffr.bufPtr = 2;
        MbrkfrSfgmfnt nfwGuy = null;
        whilf (!donf) {
            bytf [] buf;
            int ptr;
            bufffr.lobdBuf(1);
            if (dfbug) {
                Systfm.out.println("top of loop");
                bufffr.print(10);
            }
            bufffr.sdbnForFF(rfbdfr);
            switdh (bufffr.buf[bufffr.bufPtr] & 0xff) {
            dbsf 0:
                if (dfbug) {
                    Systfm.out.println("Skipping 0");
                }
                bufffr.bufAvbil--;
                bufffr.bufPtr++;
                brfbk;
            dbsf JPEG.SOF0:
            dbsf JPEG.SOF1:
            dbsf JPEG.SOF2:
                if (isStrfbm) {
                    throw nfw IIOExdfption
                        ("SOF not pfrmittfd in strfbm mftbdbtb");
                }
                nfwGuy = nfw SOFMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.DQT:
                nfwGuy = nfw DQTMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.DHT:
                nfwGuy = nfw DHTMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.DRI:
                nfwGuy = nfw DRIMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.APP0:
                // Eithfr JFIF, JFXX, or unknown APP0
                bufffr.lobdBuf(8); // tbg, lfngth, id
                buf = bufffr.buf;
                ptr = bufffr.bufPtr;
                if ((buf[ptr+3] == 'J')
                    && (buf[ptr+4] == 'F')
                    && (buf[ptr+5] == 'I')
                    && (buf[ptr+6] == 'F')
                    && (buf[ptr+7] == 0)) {
                    if (inThumb) {
                        rfbdfr.wbrningOddurrfd
                            (JPEGImbgfRfbdfr.WARNING_NO_JFIF_IN_THUMB);
                        // Lfbvf nfwGuy null
                        // Rfbd b dummy to skip thf sfgmfnt
                        JFIFMbrkfrSfgmfnt dummy =
                            nfw JFIFMbrkfrSfgmfnt(bufffr);
                    } flsf if (isStrfbm) {
                        throw nfw IIOExdfption
                            ("JFIF not pfrmittfd in strfbm mftbdbtb");
                    } flsf if (mbrkfrSfqufndf.isEmpty() == fblsf) {
                        throw nfw IIOExdfption
                            ("JFIF APP0 must bf first mbrkfr bftfr SOI");
                    } flsf {
                        nfwGuy = nfw JFIFMbrkfrSfgmfnt(bufffr);
                    }
                } flsf if ((buf[ptr+3] == 'J')
                           && (buf[ptr+4] == 'F')
                           && (buf[ptr+5] == 'X')
                           && (buf[ptr+6] == 'X')
                           && (buf[ptr+7] == 0)) {
                    if (isStrfbm) {
                        throw nfw IIOExdfption
                            ("JFXX not pfrmittfd in strfbm mftbdbtb");
                    }
                    if (inThumb) {
                        throw nfw IIOExdfption
                          ("JFXX mbrkfrs not bllowfd in JFIF JPEG thumbnbil");
                    }
                    JFIFMbrkfrSfgmfnt jfif =
                        (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                               (JFIFMbrkfrSfgmfnt.dlbss, truf);
                    if (jfif == null) {
                        throw nfw IIOExdfption
                            ("JFXX fndountfrfd without prior JFIF!");
                    }
                    jfif.bddJFXX(bufffr, rfbdfr);
                    // nfwGuy rfmbins null
                } flsf {
                    nfwGuy = nfw MbrkfrSfgmfnt(bufffr);
                    nfwGuy.lobdDbtb(bufffr);
                }
                brfbk;
            dbsf JPEG.APP2:
                // Eithfr bn ICC profilf or unknown APP2
                bufffr.lobdBuf(15); // tbg, lfngth, id
                if ((bufffr.buf[bufffr.bufPtr+3] == 'I')
                    && (bufffr.buf[bufffr.bufPtr+4] == 'C')
                    && (bufffr.buf[bufffr.bufPtr+5] == 'C')
                    && (bufffr.buf[bufffr.bufPtr+6] == '_')
                    && (bufffr.buf[bufffr.bufPtr+7] == 'P')
                    && (bufffr.buf[bufffr.bufPtr+8] == 'R')
                    && (bufffr.buf[bufffr.bufPtr+9] == 'O')
                    && (bufffr.buf[bufffr.bufPtr+10] == 'F')
                    && (bufffr.buf[bufffr.bufPtr+11] == 'I')
                    && (bufffr.buf[bufffr.bufPtr+12] == 'L')
                    && (bufffr.buf[bufffr.bufPtr+13] == 'E')
                    && (bufffr.buf[bufffr.bufPtr+14] == 0)
                    ) {
                    if (isStrfbm) {
                        throw nfw IIOExdfption
                            ("ICC profilfs not pfrmittfd in strfbm mftbdbtb");
                    }

                    JFIFMbrkfrSfgmfnt jfif =
                        (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                        (JFIFMbrkfrSfgmfnt.dlbss, truf);
                    if (jfif == null) {
                        nfwGuy = nfw MbrkfrSfgmfnt(bufffr);
                        nfwGuy.lobdDbtb(bufffr);
                    } flsf {
                        jfif.bddICC(bufffr);
                    }
                    // nfwGuy rfmbins null
                } flsf {
                    nfwGuy = nfw MbrkfrSfgmfnt(bufffr);
                    nfwGuy.lobdDbtb(bufffr);
                }
                brfbk;
            dbsf JPEG.APP14:
                // Eithfr Adobf or unknown APP14
                bufffr.lobdBuf(8); // tbg, lfngth, id
                if ((bufffr.buf[bufffr.bufPtr+3] == 'A')
                    && (bufffr.buf[bufffr.bufPtr+4] == 'd')
                    && (bufffr.buf[bufffr.bufPtr+5] == 'o')
                    && (bufffr.buf[bufffr.bufPtr+6] == 'b')
                    && (bufffr.buf[bufffr.bufPtr+7] == 'f')) {
                    if (isStrfbm) {
                        throw nfw IIOExdfption
                      ("Adobf APP14 mbrkfrs not pfrmittfd in strfbm mftbdbtb");
                    }
                    nfwGuy = nfw AdobfMbrkfrSfgmfnt(bufffr);
                } flsf {
                    nfwGuy = nfw MbrkfrSfgmfnt(bufffr);
                    nfwGuy.lobdDbtb(bufffr);
                }

                brfbk;
            dbsf JPEG.COM:
                nfwGuy = nfw COMMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.SOS:
                if (isStrfbm) {
                    throw nfw IIOExdfption
                        ("SOS not pfrmittfd in strfbm mftbdbtb");
                }
                nfwGuy = nfw SOSMbrkfrSfgmfnt(bufffr);
                brfbk;
            dbsf JPEG.RST0:
            dbsf JPEG.RST1:
            dbsf JPEG.RST2:
            dbsf JPEG.RST3:
            dbsf JPEG.RST4:
            dbsf JPEG.RST5:
            dbsf JPEG.RST6:
            dbsf JPEG.RST7:
                if (dfbug) {
                    Systfm.out.println("Rfstbrt Mbrkfr");
                }
                bufffr.bufPtr++; // Just skip it
                bufffr.bufAvbil--;
                brfbk;
            dbsf JPEG.EOI:
                donf = truf;
                bufffr.bufPtr++;
                bufffr.bufAvbil--;
                brfbk;
            dffbult:
                nfwGuy = nfw MbrkfrSfgmfnt(bufffr);
                nfwGuy.lobdDbtb(bufffr);
                nfwGuy.unknown = truf;
                brfbk;
            }
            if (nfwGuy != null) {
                mbrkfrSfqufndf.bdd(nfwGuy);
                if (dfbug) {
                    nfwGuy.print();
                }
                nfwGuy = null;
            }
        }

        // Now thbt wf'vf rfbd up to thf EOI, wf nffd to push bbdk
        // whbtfvfr is lfft in thf bufffr, so thbt thf nfxt rfbd
        // in thf nbtivf dodf will work.

        bufffr.pushBbdk();

        if (!isConsistfnt()) {
            throw nfw IIOExdfption("Indonsistfnt mftbdbtb rfbd from strfbm");
        }
    }

    /**
     * Construdts b dffbult strfbm <dodf>JPEGMftbdbtb</dodf> objfdt bppropribtf
     * for thf givfn writf pbrbmftfrs.
     */
    JPEGMftbdbtb(ImbgfWritfPbrbm pbrbm, JPEGImbgfWritfr writfr) {
        this(truf, fblsf);

        JPEGImbgfWritfPbrbm jpbrbm = null;

        if ((pbrbm != null) && (pbrbm instbndfof JPEGImbgfWritfPbrbm)) {
            jpbrbm = (JPEGImbgfWritfPbrbm) pbrbm;
            if (!jpbrbm.brfTbblfsSft()) {
                jpbrbm = null;
            }
        }
        if (jpbrbm != null) {
            mbrkfrSfqufndf.bdd(nfw DQTMbrkfrSfgmfnt(jpbrbm.gftQTbblfs()));
            mbrkfrSfqufndf.bdd
                (nfw DHTMbrkfrSfgmfnt(jpbrbm.gftDCHuffmbnTbblfs(),
                                      jpbrbm.gftACHuffmbnTbblfs()));
        } flsf {
            // dffbult tbblfs.
            mbrkfrSfqufndf.bdd(nfw DQTMbrkfrSfgmfnt(JPEG.gftDffbultQTbblfs()));
            mbrkfrSfqufndf.bdd(nfw DHTMbrkfrSfgmfnt(JPEG.gftDffbultHuffmbnTbblfs(truf),
                                                    JPEG.gftDffbultHuffmbnTbblfs(fblsf)));
        }

        // Dfffnsivf progrbmming
        if (!isConsistfnt()) {
            throw nfw IntfrnblError("Dffbult strfbm mftbdbtb is indonsistfnt");
        }
    }

    /**
     * Construdts b dffbult imbgf <dodf>JPEGMftbdbtb</dodf> objfdt bppropribtf
     * for thf givfn imbgf typf bnd writf pbrbmftfrs.
     */
    JPEGMftbdbtb(ImbgfTypfSpfdififr imbgfTypf,
                 ImbgfWritfPbrbm pbrbm,
                 JPEGImbgfWritfr writfr) {
        this(fblsf, fblsf);

        boolfbn wbntJFIF = truf;
        boolfbn wbntAdobf = fblsf;
        int trbnsform = JPEG.ADOBE_UNKNOWN;
        boolfbn willSubsbmplf = truf;
        boolfbn wbntICC = fblsf;
        boolfbn wbntProg = fblsf;
        boolfbn wbntOptimizfd = fblsf;
        boolfbn wbntExtfndfd = fblsf;
        boolfbn wbntQTbblfs = truf;
        boolfbn wbntHTbblfs = truf;
        flobt qublity = JPEG.DEFAULT_QUALITY;
        bytf[] domponfntIDs = { 1, 2, 3, 4};
        int numComponfnts = 0;

        ImbgfTypfSpfdififr dfstTypf = null;

        if (pbrbm != null) {
            dfstTypf = pbrbm.gftDfstinbtionTypf();
            if (dfstTypf != null) {
                if (imbgfTypf != null) {
                    // Ignorf thf dfstinbtion typf.
                    writfr.wbrningOddurrfd
                        (JPEGImbgfWritfr.WARNING_DEST_IGNORED);
                    dfstTypf = null;
                }
            }
            // Thf only progrfssivf modf thbt mbkfs sfnsf hfrf is MODE_DEFAULT
            if (pbrbm.dbnWritfProgrfssivf()) {
                // thf pbrbm mby not bf onf of ours, so it mby rfturn fblsf.
                // If so, thf following would throw bn fxdfption
                if (pbrbm.gftProgrfssivfModf() == ImbgfWritfPbrbm.MODE_DEFAULT) {
                    wbntProg = truf;
                    wbntOptimizfd = truf;
                    wbntHTbblfs = fblsf;
                }
            }

            if (pbrbm instbndfof JPEGImbgfWritfPbrbm) {
                JPEGImbgfWritfPbrbm jpbrbm = (JPEGImbgfWritfPbrbm) pbrbm;
                if (jpbrbm.brfTbblfsSft()) {
                    wbntQTbblfs = fblsf;  // If thf pbrbm hbs thfm, mftbdbtb shouldn't
                    wbntHTbblfs = fblsf;
                    if ((jpbrbm.gftDCHuffmbnTbblfs().lfngth > 2)
                            || (jpbrbm.gftACHuffmbnTbblfs().lfngth > 2)) {
                        wbntExtfndfd = truf;
                    }
                }
                // Progrfssivf fordfs optimizfd, rfgbrdlfss of pbrbm sftting
                // so donsult thf pbrbm rf optimizfd only if not progrfssivf
                if (!wbntProg) {
                    wbntOptimizfd = jpbrbm.gftOptimizfHuffmbnTbblfs();
                    if (wbntOptimizfd) {
                        wbntHTbblfs = fblsf;
                    }
                }
            }

            // domprfssion qublity should dftfrminf thf q tbblfs.  Notf thbt this
            // will bf ignorfd if wf blrfbdy dfdidfd not to drfbtf bny.
            // Agbin, thf pbrbm mby not bf onf of ours, so wf must dhfdk thbt it
            // supports domprfssion sfttings
            if (pbrbm.dbnWritfComprfssfd()) {
                if (pbrbm.gftComprfssionModf() == ImbgfWritfPbrbm.MODE_EXPLICIT) {
                    qublity = pbrbm.gftComprfssionQublity();
                }
            }
        }

        // Wf brf donf with thf pbrbm, now for thf imbgf typfs

        ColorSpbdf ds = null;
        if (dfstTypf != null) {
            ColorModfl dm = dfstTypf.gftColorModfl();
            numComponfnts = dm.gftNumComponfnts();
            boolfbn hbsExtrbComponfnts = (dm.gftNumColorComponfnts() != numComponfnts);
            boolfbn hbsAlphb = dm.hbsAlphb();
            ds = dm.gftColorSpbdf();
            int typf = ds.gftTypf();
            switdh(typf) {
            dbsf ColorSpbdf.TYPE_GRAY:
                willSubsbmplf = fblsf;
                if (hbsExtrbComponfnts) {  // f.g. blphb
                    wbntJFIF = fblsf;
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_3CLR:
                if (ds == JPEG.JCS.gftYCC()) {
                    wbntJFIF = fblsf;
                    domponfntIDs[0] = (bytf) 'Y';
                    domponfntIDs[1] = (bytf) 'C';
                    domponfntIDs[2] = (bytf) 'd';
                    if (hbsAlphb) {
                        domponfntIDs[3] = (bytf) 'A';
                    }
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_YCbCr:
                if (hbsExtrbComponfnts) { // f.g. K or blphb
                    wbntJFIF = fblsf;
                    if (!hbsAlphb) { // Not blphb, so must bf K
                        wbntAdobf = truf;
                        trbnsform = JPEG.ADOBE_YCCK;
                    }
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_RGB:  // with or without blphb
                wbntJFIF = fblsf;
                wbntAdobf = truf;
                willSubsbmplf = fblsf;
                domponfntIDs[0] = (bytf) 'R';
                domponfntIDs[1] = (bytf) 'G';
                domponfntIDs[2] = (bytf) 'B';
                if (hbsAlphb) {
                    domponfntIDs[3] = (bytf) 'A';
                }
                brfbk;
            dffbult:
                // Evfrything flsf is not subsbmplfd, gfts no spfdibl mbrkfr,
                // bnd domponfnt ids brf 1 - N
                wbntJFIF = fblsf;
                willSubsbmplf = fblsf;
            }
        } flsf if (imbgfTypf != null) {
            ColorModfl dm = imbgfTypf.gftColorModfl();
            numComponfnts = dm.gftNumComponfnts();
            boolfbn hbsExtrbComponfnts = (dm.gftNumColorComponfnts() != numComponfnts);
            boolfbn hbsAlphb = dm.hbsAlphb();
            ds = dm.gftColorSpbdf();
            int typf = ds.gftTypf();
            switdh(typf) {
            dbsf ColorSpbdf.TYPE_GRAY:
                willSubsbmplf = fblsf;
                if (hbsExtrbComponfnts) {  // f.g. blphb
                    wbntJFIF = fblsf;
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_RGB:  // with or without blphb
                // without blphb wf just bddfpt thf JFIF dffbults
                if (hbsAlphb) {
                    wbntJFIF = fblsf;
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_3CLR:
                wbntJFIF = fblsf;
                willSubsbmplf = fblsf;
                if (ds.fqubls(ColorSpbdf.gftInstbndf(ColorSpbdf.CS_PYCC))) {
                    willSubsbmplf = truf;
                    wbntAdobf = truf;
                    domponfntIDs[0] = (bytf) 'Y';
                    domponfntIDs[1] = (bytf) 'C';
                    domponfntIDs[2] = (bytf) 'd';
                    if (hbsAlphb) {
                        domponfntIDs[3] = (bytf) 'A';
                    }
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_YCbCr:
                if (hbsExtrbComponfnts) { // f.g. K or blphb
                    wbntJFIF = fblsf;
                    if (!hbsAlphb) {  // thfn it must bf K
                        wbntAdobf = truf;
                        trbnsform = JPEG.ADOBE_YCCK;
                    }
                }
                brfbk;
            dbsf ColorSpbdf.TYPE_CMYK:
                wbntJFIF = fblsf;
                wbntAdobf = truf;
                trbnsform = JPEG.ADOBE_YCCK;
                brfbk;

            dffbult:
                // Evfrything flsf is not subsbmplfd, gfts no spfdibl mbrkfr,
                // bnd domponfnt ids brf 0 - N
                wbntJFIF = fblsf;
                willSubsbmplf = fblsf;
            }

        }

        // do wf wbnt bn ICC profilf?
        if (wbntJFIF && JPEG.isNonStbndbrdICC(ds)) {
            wbntICC = truf;
        }

        // Now stfp through thf mbrkfrs, donsulting our vbribblfs.
        if (wbntJFIF) {
            JFIFMbrkfrSfgmfnt jfif = nfw JFIFMbrkfrSfgmfnt();
            mbrkfrSfqufndf.bdd(jfif);
            if (wbntICC) {
                try {
                    jfif.bddICC((ICC_ColorSpbdf)ds);
                } dbtdh (IOExdfption f) {} // Cbn't hbppfn hfrf
            }
        }
        // Adobf
        if (wbntAdobf) {
            mbrkfrSfqufndf.bdd(nfw AdobfMbrkfrSfgmfnt(trbnsform));
        }

        // dqt
        if (wbntQTbblfs) {
            mbrkfrSfqufndf.bdd(nfw DQTMbrkfrSfgmfnt(qublity, willSubsbmplf));
        }

        // dht
        if (wbntHTbblfs) {
            mbrkfrSfqufndf.bdd(nfw DHTMbrkfrSfgmfnt(willSubsbmplf));
        }

        // sof
        mbrkfrSfqufndf.bdd(nfw SOFMbrkfrSfgmfnt(wbntProg,
                                                wbntExtfndfd,
                                                willSubsbmplf,
                                                domponfntIDs,
                                                numComponfnts));

        // sos
        if (!wbntProg) {  // Dffbult progrfssion sdbns brf donf in thf writfr
            mbrkfrSfqufndf.bdd(nfw SOSMbrkfrSfgmfnt(willSubsbmplf,
                                                    domponfntIDs,
                                                    numComponfnts));
        }

        // Dfffnsivf progrbmming
        if (!isConsistfnt()) {
            throw nfw IntfrnblError("Dffbult imbgf mftbdbtb is indonsistfnt");
        }
    }

    ////// End of donstrudtors

    // Utilitifs for dfbling with thf mbrkfr sfqufndf.
    // Thf first onfs hbvf pbdkbgf bddfss for bddfss from thf writfr.

    /**
     * Rfturns thf first MbrkfrSfgmfnt objfdt in thf list
     * with thf givfn tbg, or null if nonf is found.
     */
    MbrkfrSfgmfnt findMbrkfrSfgmfnt(int tbg) {
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf (itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            if (sfg.tbg == tbg) {
                rfturn sfg;
            }
        }
        rfturn null;
    }

    /**
     * Rfturns thf first or lbst MbrkfrSfgmfnt objfdt in thf list
     * of thf givfn dlbss, or null if nonf is found.
     */
    MbrkfrSfgmfnt findMbrkfrSfgmfnt(Clbss<? fxtfnds MbrkfrSfgmfnt> dls, boolfbn first) {
        if (first) {
            Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
            whilf (itfr.hbsNfxt()) {
                MbrkfrSfgmfnt sfg = itfr.nfxt();
                if (dls.isInstbndf(sfg)) {
                    rfturn sfg;
                }
            }
        } flsf {
            ListItfrbtor<MbrkfrSfgmfnt> itfr =
                mbrkfrSfqufndf.listItfrbtor(mbrkfrSfqufndf.sizf());
            whilf (itfr.hbsPrfvious()) {
                MbrkfrSfgmfnt sfg = itfr.prfvious();
                if (dls.isInstbndf(sfg)) {
                    rfturn sfg;
                }
            }
        }
        rfturn null;
    }

    /**
     * Rfturns thf indfx of thf first or lbst MbrkfrSfgmfnt in thf list
     * of thf givfn dlbss, or -1 if nonf is found.
     */
    privbtf int findMbrkfrSfgmfntPosition(Clbss<? fxtfnds MbrkfrSfgmfnt> dls,
                                          boolfbn first) {
        if (first) {
            ListItfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.listItfrbtor();
            for (int i = 0; itfr.hbsNfxt(); i++) {
                MbrkfrSfgmfnt sfg = itfr.nfxt();
                if (dls.isInstbndf(sfg)) {
                    rfturn i;
                }
            }
        } flsf {
            ListItfrbtor<MbrkfrSfgmfnt> itfr =
                    mbrkfrSfqufndf.listItfrbtor(mbrkfrSfqufndf.sizf());
            for (int i = mbrkfrSfqufndf.sizf()-1; itfr.hbsPrfvious(); i--) {
                MbrkfrSfgmfnt sfg = itfr.prfvious();
                if (dls.isInstbndf(sfg)) {
                    rfturn i;
                }
            }
        }
        rfturn -1;
    }

    privbtf int findLbstUnknownMbrkfrSfgmfntPosition() {
        ListItfrbtor<MbrkfrSfgmfnt> itfr =
            mbrkfrSfqufndf.listItfrbtor(mbrkfrSfqufndf.sizf());
        for (int i = mbrkfrSfqufndf.sizf()-1; itfr.hbsPrfvious(); i--) {
            MbrkfrSfgmfnt sfg = itfr.prfvious();
            if (sfg.unknown == truf) {
                rfturn i;
            }
        }
        rfturn -1;
    }

    // Implfmfnt Clonfbblf, but rfstridt bddfss

    protfdtfd Objfdt dlonf() {
        JPEGMftbdbtb nfwGuy = null;
        try {
            nfwGuy = (JPEGMftbdbtb) supfr.dlonf();
        } dbtdh (ClonfNotSupportfdExdfption f) {} // won't hbppfn
        if (mbrkfrSfqufndf != null) {
            nfwGuy.mbrkfrSfqufndf = dlonfSfqufndf();
        }
        nfwGuy.rfsftSfqufndf = null;
        rfturn nfwGuy;
    }

    /**
     * Rfturns b dffp dopy of thf durrfnt mbrkfr sfqufndf.
     */
    privbtf List<MbrkfrSfgmfnt> dlonfSfqufndf() {
        if (mbrkfrSfqufndf == null) {
            rfturn null;
        }
        List<MbrkfrSfgmfnt> rftvbl = nfw ArrbyList<>(mbrkfrSfqufndf.sizf());
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf(itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            rftvbl.bdd((MbrkfrSfgmfnt) sfg.dlonf());
        }

        rfturn rftvbl;
    }


    // Trff mfthods

    publid Nodf gftAsTrff(String formbtNbmf) {
        if (formbtNbmf == null) {
            throw nfw IllfgblArgumfntExdfption("null formbtNbmf!");
        }
        if (isStrfbm) {
            if (formbtNbmf.fqubls(JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf)) {
                rfturn gftNbtivfTrff();
            }
        } flsf {
            if (formbtNbmf.fqubls(JPEG.nbtivfImbgfMftbdbtbFormbtNbmf)) {
                rfturn gftNbtivfTrff();
            }
            if (formbtNbmf.fqubls
                    (IIOMftbdbtbFormbtImpl.stbndbrdMftbdbtbFormbtNbmf)) {
                rfturn gftStbndbrdTrff();
            }
        }
        throw  nfw IllfgblArgumfntExdfption("Unsupportfd formbt nbmf: "
                                                + formbtNbmf);
    }

    IIOMftbdbtbNodf gftNbtivfTrff() {
        IIOMftbdbtbNodf root;
        IIOMftbdbtbNodf top;
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        if (isStrfbm) {
            root = nfw IIOMftbdbtbNodf(JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf);
            top = root;
        } flsf {
            IIOMftbdbtbNodf sfqufndf = nfw IIOMftbdbtbNodf("mbrkfrSfqufndf");
            if (!inThumb) {
                root = nfw IIOMftbdbtbNodf(JPEG.nbtivfImbgfMftbdbtbFormbtNbmf);
                IIOMftbdbtbNodf hfbdfr = nfw IIOMftbdbtbNodf("JPEGvbrifty");
                root.bppfndChild(hfbdfr);
                JFIFMbrkfrSfgmfnt jfif = (JFIFMbrkfrSfgmfnt)
                    findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf);
                if (jfif != null) {
                    itfr.nfxt();  // JFIF must bf first, so this skips it
                    hfbdfr.bppfndChild(jfif.gftNbtivfNodf());
                }
                root.bppfndChild(sfqufndf);
            } flsf {
                root = sfqufndf;
            }
            top = sfqufndf;
        }
        whilf(itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            top.bppfndChild(sfg.gftNbtivfNodf());
        }
        rfturn root;
    }

    // Stbndbrd trff nodf mfthods

    protfdtfd IIOMftbdbtbNodf gftStbndbrdChrombNodf() {
        hbsAlphb = fblsf;  // Unlfss wf find othfrwisf

        // Colorspbdf typf - follow thf rulfs in thf spfd
        // First gft thf SOF mbrkfr sfgmfnt, if thfrf is onf
        SOFMbrkfrSfgmfnt sof = (SOFMbrkfrSfgmfnt)
            findMbrkfrSfgmfnt(SOFMbrkfrSfgmfnt.dlbss, truf);
        if (sof == null) {
            // No imbgf, so no dhromb
            rfturn null;
        }

        IIOMftbdbtbNodf dhromb = nfw IIOMftbdbtbNodf("Chromb");
        IIOMftbdbtbNodf dsTypf = nfw IIOMftbdbtbNodf("ColorSpbdfTypf");
        dhromb.bppfndChild(dsTypf);

        // gft thf numbfr of dhbnnfls
        int numChbnnfls = sof.domponfntSpfds.lfngth;

        IIOMftbdbtbNodf numChbnNodf = nfw IIOMftbdbtbNodf("NumChbnnfls");
        dhromb.bppfndChild(numChbnNodf);
        numChbnNodf.sftAttributf("vbluf", Intfgfr.toString(numChbnnfls));

        // is thfrf b JFIF mbrkfr sfgmfnt?
        if (findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf) != null) {
            if (numChbnnfls == 1) {
                dsTypf.sftAttributf("nbmf", "GRAY");
            } flsf {
                dsTypf.sftAttributf("nbmf", "YCbCr");
            }
            rfturn dhromb;
        }

        // How bbout bn Adobf mbrkfr sfgmfnt?
        AdobfMbrkfrSfgmfnt bdobf =
            (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt.dlbss, truf);
        if (bdobf != null){
            switdh (bdobf.trbnsform) {
            dbsf JPEG.ADOBE_YCCK:
                dsTypf.sftAttributf("nbmf", "YCCK");
                brfbk;
            dbsf JPEG.ADOBE_YCC:
                dsTypf.sftAttributf("nbmf", "YCbCr");
                brfbk;
            dbsf JPEG.ADOBE_UNKNOWN:
                if (numChbnnfls == 3) {
                    dsTypf.sftAttributf("nbmf", "RGB");
                } flsf if (numChbnnfls == 4) {
                    dsTypf.sftAttributf("nbmf", "CMYK");
                }
                brfbk;
            }
            rfturn dhromb;
        }

        // Nfithfr mbrkfr.  Chfdk domponfnts
        if (numChbnnfls < 3) {
            dsTypf.sftAttributf("nbmf", "GRAY");
            if (numChbnnfls == 2) {
                hbsAlphb = truf;
            }
            rfturn dhromb;
        }

        boolfbn idsArfJFIF = truf;

        for (int i = 0; i < sof.domponfntSpfds.lfngth; i++) {
            int id = sof.domponfntSpfds[i].domponfntId;
            if ((id < 1) || (id >= sof.domponfntSpfds.lfngth)) {
                idsArfJFIF = fblsf;
            }
        }

        if (idsArfJFIF) {
            dsTypf.sftAttributf("nbmf", "YCbCr");
            if (numChbnnfls == 4) {
                hbsAlphb = truf;
            }
            rfturn dhromb;
        }

        // Chfdk bgbinst thf lfttfrs
        if ((sof.domponfntSpfds[0].domponfntId == 'R')
            && (sof.domponfntSpfds[1].domponfntId == 'G')
            && (sof.domponfntSpfds[2].domponfntId == 'B')){

            dsTypf.sftAttributf("nbmf", "RGB");
            if ((numChbnnfls == 4)
                && (sof.domponfntSpfds[3].domponfntId == 'A')) {
                hbsAlphb = truf;
            }
            rfturn dhromb;
        }

        if ((sof.domponfntSpfds[0].domponfntId == 'Y')
            && (sof.domponfntSpfds[1].domponfntId == 'C')
            && (sof.domponfntSpfds[2].domponfntId == 'd')){

            dsTypf.sftAttributf("nbmf", "PhotoYCC");
            if ((numChbnnfls == 4)
                && (sof.domponfntSpfds[3].domponfntId == 'A')) {
                hbsAlphb = truf;
            }
            rfturn dhromb;
        }

        // Finblly, 3-dhbnnfl subsbmplfd brf YCbCr, unsubsbmplfd brf RGB
        // 4-dhbnnfl subsbmplfd brf YCbCrA, unsubsbmplfd brf CMYK

        boolfbn subsbmplfd = fblsf;

        int hfbdtor = sof.domponfntSpfds[0].HsbmplingFbdtor;
        int vfbdtor = sof.domponfntSpfds[0].VsbmplingFbdtor;

        for (int i = 1; i<sof.domponfntSpfds.lfngth; i++) {
            if ((sof.domponfntSpfds[i].HsbmplingFbdtor != hfbdtor)
                || (sof.domponfntSpfds[i].VsbmplingFbdtor != vfbdtor)){
                subsbmplfd = truf;
                brfbk;
            }
        }

        if (subsbmplfd) {
            dsTypf.sftAttributf("nbmf", "YCbCr");
            if (numChbnnfls == 4) {
                hbsAlphb = truf;
            }
            rfturn dhromb;
        }

        // Not subsbmplfd.  numChbnnfls < 3 is tbkfn dbrf of bbovf
        if (numChbnnfls == 3) {
            dsTypf.sftAttributf("nbmf", "RGB");
        } flsf {
            dsTypf.sftAttributf("nbmf", "CMYK");
        }

        rfturn dhromb;
    }

    protfdtfd IIOMftbdbtbNodf gftStbndbrdComprfssionNodf() {

        IIOMftbdbtbNodf domprfssion = nfw IIOMftbdbtbNodf("Comprfssion");

        // ComprfssionTypfNbmf
        IIOMftbdbtbNodf nbmf = nfw IIOMftbdbtbNodf("ComprfssionTypfNbmf");
        nbmf.sftAttributf("vbluf", "JPEG");
        domprfssion.bppfndChild(nbmf);

        // Losslfss - fblsf
        IIOMftbdbtbNodf losslfss = nfw IIOMftbdbtbNodf("Losslfss");
        losslfss.sftAttributf("vbluf", "FALSE");
        domprfssion.bppfndChild(losslfss);

        // NumProgrfssivfSdbns - dount sos sfgmfnts
        int sosCount = 0;
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf (itfr.hbsNfxt()) {
            MbrkfrSfgmfnt ms = itfr.nfxt();
            if (ms.tbg == JPEG.SOS) {
                sosCount++;
            }
        }
        if (sosCount != 0) {
            IIOMftbdbtbNodf prog = nfw IIOMftbdbtbNodf("NumProgrfssivfSdbns");
            prog.sftAttributf("vbluf", Intfgfr.toString(sosCount));
            domprfssion.bppfndChild(prog);
        }

        rfturn domprfssion;
    }

    protfdtfd IIOMftbdbtbNodf gftStbndbrdDimfnsionNodf() {
        // If wf hbvf b JFIF mbrkfr sfgmfnt, wf know b littlf
        // othfrwisf bll wf know is thf orifntbtion, whidh is blwbys normbl
        IIOMftbdbtbNodf dim = nfw IIOMftbdbtbNodf("Dimfnsion");
        IIOMftbdbtbNodf orifnt = nfw IIOMftbdbtbNodf("ImbgfOrifntbtion");
        orifnt.sftAttributf("vbluf", "normbl");
        dim.bppfndChild(orifnt);

        JFIFMbrkfrSfgmfnt jfif =
            (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf);
        if (jfif != null) {

            // Aspfdt Rbtio is width of pixfl / hfight of pixfl
            flobt bspfdtRbtio;
            if (jfif.rfsUnits == 0) {
                // In this dbsf thfy just fndodf bspfdt rbtio dirfdtly
                bspfdtRbtio = ((flobt) jfif.Xdfnsity)/jfif.Ydfnsity;
            } flsf {
                // Thfy brf truf dfnsitifs (f.g. dpi) bnd must bf invfrtfd
                bspfdtRbtio = ((flobt) jfif.Ydfnsity)/jfif.Xdfnsity;
            }
            IIOMftbdbtbNodf bspfdt = nfw IIOMftbdbtbNodf("PixflAspfdtRbtio");
            bspfdt.sftAttributf("vbluf", Flobt.toString(bspfdtRbtio));
            dim.insfrtBfforf(bspfdt, orifnt);

            // Pixfl sizf
            if (jfif.rfsUnits != 0) {
                // 1 == dpi, 2 == dpd
                flobt sdblf = (jfif.rfsUnits == 1) ? 25.4F : 10.0F;

                IIOMftbdbtbNodf horiz =
                    nfw IIOMftbdbtbNodf("HorizontblPixflSizf");
                horiz.sftAttributf("vbluf",
                                   Flobt.toString(sdblf/jfif.Xdfnsity));
                dim.bppfndChild(horiz);

                IIOMftbdbtbNodf vfrt =
                    nfw IIOMftbdbtbNodf("VfrtidblPixflSizf");
                vfrt.sftAttributf("vbluf",
                                  Flobt.toString(sdblf/jfif.Ydfnsity));
                dim.bppfndChild(vfrt);
            }
        }
        rfturn dim;
    }

    protfdtfd IIOMftbdbtbNodf gftStbndbrdTfxtNodf() {
        IIOMftbdbtbNodf tfxt = null;
        // Add b tfxt fntry for fbdh COM Mbrkfr Sfgmfnt
        if (findMbrkfrSfgmfnt(JPEG.COM) != null) {
            tfxt = nfw IIOMftbdbtbNodf("Tfxt");
            Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
            whilf (itfr.hbsNfxt()) {
                MbrkfrSfgmfnt sfg = itfr.nfxt();
                if (sfg.tbg == JPEG.COM) {
                    COMMbrkfrSfgmfnt dom = (COMMbrkfrSfgmfnt) sfg;
                    IIOMftbdbtbNodf fntry = nfw IIOMftbdbtbNodf("TfxtEntry");
                    fntry.sftAttributf("kfyword", "dommfnt");
                    fntry.sftAttributf("vbluf", dom.gftCommfnt());
                tfxt.bppfndChild(fntry);
                }
            }
        }
        rfturn tfxt;
    }

    protfdtfd IIOMftbdbtbNodf gftStbndbrdTrbnspbrfndyNodf() {
        IIOMftbdbtbNodf trbns = null;
        if (hbsAlphb == truf) {
            trbns = nfw IIOMftbdbtbNodf("Trbnspbrfndy");
            IIOMftbdbtbNodf blphb = nfw IIOMftbdbtbNodf("Alphb");
            blphb.sftAttributf("vbluf", "nonprfmultiplifd"); // Alwbys bssumf
            trbns.bppfndChild(blphb);
        }
        rfturn trbns;
    }

    // Editing

    publid boolfbn isRfbdOnly() {
        rfturn fblsf;
    }

    publid void mfrgfTrff(String formbtNbmf, Nodf root)
        throws IIOInvblidTrffExdfption {
        if (formbtNbmf == null) {
            throw nfw IllfgblArgumfntExdfption("null formbtNbmf!");
        }
        if (root == null) {
            throw nfw IllfgblArgumfntExdfption("null root!");
        }
        List<MbrkfrSfgmfnt> dopy = null;
        if (rfsftSfqufndf == null) {
            rfsftSfqufndf = dlonfSfqufndf();  // Dffp dopy
            dopy = rfsftSfqufndf;  // Avoid dloning twidf
        } flsf {
            dopy = dlonfSfqufndf();
        }
        if (isStrfbm &&
            (formbtNbmf.fqubls(JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf))) {
                mfrgfNbtivfTrff(root);
        } flsf if (!isStrfbm &&
                   (formbtNbmf.fqubls(JPEG.nbtivfImbgfMftbdbtbFormbtNbmf))) {
            mfrgfNbtivfTrff(root);
        } flsf if (!isStrfbm &&
                   (formbtNbmf.fqubls
                    (IIOMftbdbtbFormbtImpl.stbndbrdMftbdbtbFormbtNbmf))) {
            mfrgfStbndbrdTrff(root);
        } flsf {
            throw  nfw IllfgblArgumfntExdfption("Unsupportfd formbt nbmf: "
                                                + formbtNbmf);
        }
        if (!isConsistfnt()) {
            mbrkfrSfqufndf = dopy;
            throw nfw IIOInvblidTrffExdfption
                ("Mfrgfd trff is invblid; originbl rfstorfd", root);
        }
    }

    privbtf void mfrgfNbtivfTrff(Nodf root) throws IIOInvblidTrffExdfption {
        String nbmf = root.gftNodfNbmf();
        if (nbmf != ((isStrfbm) ? JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf
                                : JPEG.nbtivfImbgfMftbdbtbFormbtNbmf)) {
            throw nfw IIOInvblidTrffExdfption("Invblid root nodf nbmf: " + nbmf,
                                              root);
        }
        if (root.gftChildNodfs().gftLfngth() != 2) { // JPEGvbrifty bnd mbrkfrSfqufndf
            throw nfw IIOInvblidTrffExdfption(
                "JPEGvbrifty bnd mbrkfrSfqufndf nodfs must bf prfsfnt", root);
        }
        mfrgfJFIFsubtrff(root.gftFirstChild());
        mfrgfSfqufndfSubtrff(root.gftLbstChild());
    }

    /**
     * Mfrgf b JFIF subtrff into thf mbrkfr sfqufndf, if thf subtrff
     * is non-fmpty.
     * If b JFIF mbrkfr fxists, updbtf it from thf subtrff.
     * If nonf fxists, drfbtf onf from thf subtrff bnd insfrt it bt thf
     * bfginning of thf mbrkfr sfqufndf.
     */
    privbtf void mfrgfJFIFsubtrff(Nodf JPEGvbrifty)
        throws IIOInvblidTrffExdfption {
        if (JPEGvbrifty.gftChildNodfs().gftLfngth() != 0) {
            Nodf jfifNodf = JPEGvbrifty.gftFirstChild();
            // is thfrf blrfbdy b jfif mbrkfr sfgmfnt?
            JFIFMbrkfrSfgmfnt jfifSfg =
                (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf);
            if (jfifSfg != null) {
                jfifSfg.updbtfFromNbtivfNodf(jfifNodf, fblsf);
            } flsf {
                // Add it bs thf first flfmfnt in thf list.
                mbrkfrSfqufndf.bdd(0, nfw JFIFMbrkfrSfgmfnt(jfifNodf));
            }
        }
    }

    privbtf void mfrgfSfqufndfSubtrff(Nodf sfqufndfTrff)
        throws IIOInvblidTrffExdfption {
        NodfList dhildrfn = sfqufndfTrff.gftChildNodfs();
        for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
            Nodf nodf = dhildrfn.itfm(i);
            String nbmf = nodf.gftNodfNbmf();
            if (nbmf.fqubls("dqt")) {
                mfrgfDQTNodf(nodf);
            } flsf if (nbmf.fqubls("dht")) {
                mfrgfDHTNodf(nodf);
            } flsf if (nbmf.fqubls("dri")) {
                mfrgfDRINodf(nodf);
            } flsf if (nbmf.fqubls("dom")) {
                mfrgfCOMNodf(nodf);
            } flsf if (nbmf.fqubls("bpp14Adobf")) {
                mfrgfAdobfNodf(nodf);
            } flsf if (nbmf.fqubls("unknown")) {
                mfrgfUnknownNodf(nodf);
            } flsf if (nbmf.fqubls("sof")) {
                mfrgfSOFNodf(nodf);
            } flsf if (nbmf.fqubls("sos")) {
                mfrgfSOSNodf(nodf);
            } flsf {
                throw nfw IIOInvblidTrffExdfption("Invblid nodf: " + nbmf, nodf);
            }
        }
    }

    /**
     * Mfrgf thf givfn DQT nodf into thf mbrkfr sfqufndf.  If thfrf blrfbdy
     * fxist DQT mbrkfr sfgmfnts in thf sfqufndf, thfn fbdh tbblf in thf
     * nodf rfplbdfs thf first tbblf, in bny DQT sfgmfnt, with thf sbmf
     * tbblf id.  If nonf of thf fxisting DQT sfgmfnts dontbin b tbblf with
     * thf sbmf id, thfn thf tbblf is bddfd to thf lbst fxisting DQT sfgmfnt.
     * If thfrf brf no DQT sfgmfnts, thfn b nfw onf is drfbtfd bnd bddfd
     * bs follows:
     * If thfrf brf DHT sfgmfnts, thf nfw DQT sfgmfnt is insfrtfd bfforf thf
     * first onf.
     * If thfrf brf no DHT sfgmfnts, thf nfw DQT sfgmfnt is insfrtfd bfforf
     * bn SOF sfgmfnt, if thfrf is onf.
     * If thfrf is no SOF sfgmfnt, thf nfw DQT sfgmfnt is insfrtfd bfforf
     * thf first SOS sfgmfnt, if thfrf is onf.
     * If thfrf is no SOS sfgmfnt, thf nfw DQT sfgmfnt is bddfd to thf fnd
     * of thf sfqufndf.
     */
    privbtf void mfrgfDQTNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        // First dollfdt bny fxisting DQT nodfs into b lodbl list
        ArrbyList<DQTMbrkfrSfgmfnt> oldDQTs = nfw ArrbyList<>();
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf (itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            if (sfg instbndfof DQTMbrkfrSfgmfnt) {
                oldDQTs.bdd((DQTMbrkfrSfgmfnt) sfg);
            }
        }
        if (!oldDQTs.isEmpty()) {
            NodfList dhildrfn = nodf.gftChildNodfs();
            for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
                Nodf dhild = dhildrfn.itfm(i);
                int dhildID = MbrkfrSfgmfnt.gftAttributfVbluf(dhild,
                                                              null,
                                                              "qtbblfId",
                                                              0, 3,
                                                              truf);
                DQTMbrkfrSfgmfnt dqt = null;
                int tbblfIndfx = -1;
                for (int j = 0; j < oldDQTs.sizf(); j++) {
                    DQTMbrkfrSfgmfnt tfstDQT = oldDQTs.gft(j);
                    for (int k = 0; k < tfstDQT.tbblfs.sizf(); k++) {
                        DQTMbrkfrSfgmfnt.Qtbblf tfstTbblf = tfstDQT.tbblfs.gft(k);
                        if (dhildID == tfstTbblf.tbblfID) {
                            dqt = tfstDQT;
                            tbblfIndfx = k;
                            brfbk;
                        }
                    }
                    if (dqt != null) brfbk;
                }
                if (dqt != null) {
                    dqt.tbblfs.sft(tbblfIndfx, dqt.gftQtbblfFromNodf(dhild));
                } flsf {
                    dqt = oldDQTs.gft(oldDQTs.sizf()-1);
                    dqt.tbblfs.bdd(dqt.gftQtbblfFromNodf(dhild));
                }
            }
        } flsf {
            DQTMbrkfrSfgmfnt nfwGuy = nfw DQTMbrkfrSfgmfnt(nodf);
            int firstDHT = findMbrkfrSfgmfntPosition(DHTMbrkfrSfgmfnt.dlbss, truf);
            int firstSOF = findMbrkfrSfgmfntPosition(SOFMbrkfrSfgmfnt.dlbss, truf);
            int firstSOS = findMbrkfrSfgmfntPosition(SOSMbrkfrSfgmfnt.dlbss, truf);
            if (firstDHT != -1) {
                mbrkfrSfqufndf.bdd(firstDHT, nfwGuy);
            } flsf if (firstSOF != -1) {
                mbrkfrSfqufndf.bdd(firstSOF, nfwGuy);
            } flsf if (firstSOS != -1) {
                mbrkfrSfqufndf.bdd(firstSOS, nfwGuy);
            } flsf {
                mbrkfrSfqufndf.bdd(nfwGuy);
            }
        }
    }

    /**
     * Mfrgf thf givfn DHT nodf into thf mbrkfr sfqufndf.  If thfrf blrfbdy
     * fxist DHT mbrkfr sfgmfnts in thf sfqufndf, thfn fbdh tbblf in thf
     * nodf rfplbdfs thf first tbblf, in bny DHT sfgmfnt, with thf sbmf
     * tbblf dlbss bnd tbblf id.  If nonf of thf fxisting DHT sfgmfnts dontbin
     * b tbblf with thf sbmf dlbss bnd id, thfn thf tbblf is bddfd to thf lbst
     * fxisting DHT sfgmfnt.
     * If thfrf brf no DHT sfgmfnts, thfn b nfw onf is drfbtfd bnd bddfd
     * bs follows:
     * If thfrf brf DQT sfgmfnts, thf nfw DHT sfgmfnt is insfrtfd immfdibtfly
     * following thf lbst DQT sfgmfnt.
     * If thfrf brf no DQT sfgmfnts, thf nfw DHT sfgmfnt is insfrtfd bfforf
     * bn SOF sfgmfnt, if thfrf is onf.
     * If thfrf is no SOF sfgmfnt, thf nfw DHT sfgmfnt is insfrtfd bfforf
     * thf first SOS sfgmfnt, if thfrf is onf.
     * If thfrf is no SOS sfgmfnt, thf nfw DHT sfgmfnt is bddfd to thf fnd
     * of thf sfqufndf.
     */
    privbtf void mfrgfDHTNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        // First dollfdt bny fxisting DQT nodfs into b lodbl list
        ArrbyList<DHTMbrkfrSfgmfnt> oldDHTs = nfw ArrbyList<>();
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf (itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            if (sfg instbndfof DHTMbrkfrSfgmfnt) {
                oldDHTs.bdd((DHTMbrkfrSfgmfnt) sfg);
            }
        }
        if (!oldDHTs.isEmpty()) {
            NodfList dhildrfn = nodf.gftChildNodfs();
            for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
                Nodf dhild = dhildrfn.itfm(i);
                NbmfdNodfMbp bttrs = dhild.gftAttributfs();
                int dhildID = MbrkfrSfgmfnt.gftAttributfVbluf(dhild,
                                                              bttrs,
                                                              "htbblfId",
                                                              0, 3,
                                                              truf);
                int dhildClbss = MbrkfrSfgmfnt.gftAttributfVbluf(dhild,
                                                                 bttrs,
                                                                 "dlbss",
                                                                 0, 1,
                                                                 truf);
                DHTMbrkfrSfgmfnt dht = null;
                int tbblfIndfx = -1;
                for (int j = 0; j < oldDHTs.sizf(); j++) {
                    DHTMbrkfrSfgmfnt tfstDHT = oldDHTs.gft(j);
                    for (int k = 0; k < tfstDHT.tbblfs.sizf(); k++) {
                        DHTMbrkfrSfgmfnt.Htbblf tfstTbblf = tfstDHT.tbblfs.gft(k);
                        if ((dhildID == tfstTbblf.tbblfID) &&
                            (dhildClbss == tfstTbblf.tbblfClbss)) {
                            dht = tfstDHT;
                            tbblfIndfx = k;
                            brfbk;
                        }
                    }
                    if (dht != null) brfbk;
                }
                if (dht != null) {
                    dht.tbblfs.sft(tbblfIndfx, dht.gftHtbblfFromNodf(dhild));
                } flsf {
                    dht = oldDHTs.gft(oldDHTs.sizf()-1);
                    dht.tbblfs.bdd(dht.gftHtbblfFromNodf(dhild));
                }
            }
        } flsf {
            DHTMbrkfrSfgmfnt nfwGuy = nfw DHTMbrkfrSfgmfnt(nodf);
            int lbstDQT = findMbrkfrSfgmfntPosition(DQTMbrkfrSfgmfnt.dlbss, fblsf);
            int firstSOF = findMbrkfrSfgmfntPosition(SOFMbrkfrSfgmfnt.dlbss, truf);
            int firstSOS = findMbrkfrSfgmfntPosition(SOSMbrkfrSfgmfnt.dlbss, truf);
            if (lbstDQT != -1) {
                mbrkfrSfqufndf.bdd(lbstDQT+1, nfwGuy);
            } flsf if (firstSOF != -1) {
                mbrkfrSfqufndf.bdd(firstSOF, nfwGuy);
            } flsf if (firstSOS != -1) {
                mbrkfrSfqufndf.bdd(firstSOS, nfwGuy);
            } flsf {
                mbrkfrSfqufndf.bdd(nfwGuy);
            }
        }
    }

    /**
     * Mfrgf thf givfn DRI nodf into thf mbrkfr sfqufndf.
     * If thfrf blrfbdy fxists b DRI mbrkfr sfgmfnt, thf rfstbrt intfrvbl
     * vbluf is updbtfd.
     * If thfrf is no DRI sfgmfnt, thfn b nfw onf is drfbtfd bnd bddfd bs
     * follows:
     * If thfrf is bn SOF sfgmfnt, thf nfw DRI sfgmfnt is insfrtfd bfforf
     * it.
     * If thfrf is no SOF sfgmfnt, thf nfw DRI sfgmfnt is insfrtfd bfforf
     * thf first SOS sfgmfnt, if thfrf is onf.
     * If thfrf is no SOS sfgmfnt, thf nfw DRI sfgmfnt is bddfd to thf fnd
     * of thf sfqufndf.
     */
    privbtf void mfrgfDRINodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        DRIMbrkfrSfgmfnt dri =
            (DRIMbrkfrSfgmfnt) findMbrkfrSfgmfnt(DRIMbrkfrSfgmfnt.dlbss, truf);
        if (dri != null) {
            dri.updbtfFromNbtivfNodf(nodf, fblsf);
        } flsf {
            DRIMbrkfrSfgmfnt nfwGuy = nfw DRIMbrkfrSfgmfnt(nodf);
            int firstSOF = findMbrkfrSfgmfntPosition(SOFMbrkfrSfgmfnt.dlbss, truf);
            int firstSOS = findMbrkfrSfgmfntPosition(SOSMbrkfrSfgmfnt.dlbss, truf);
            if (firstSOF != -1) {
                mbrkfrSfqufndf.bdd(firstSOF, nfwGuy);
            } flsf if (firstSOS != -1) {
                mbrkfrSfqufndf.bdd(firstSOS, nfwGuy);
            } flsf {
                mbrkfrSfqufndf.bdd(nfwGuy);
            }
        }
    }

    /**
     * Mfrgf thf givfn COM nodf into thf mbrkfr sfqufndf.
     * A nfw COM mbrkfr sfgmfnt is drfbtfd bnd bddfd to thf sfqufndf
     * using insfrtCOMMbrkfrSfgmfnt.
     */
    privbtf void mfrgfCOMNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        COMMbrkfrSfgmfnt nfwGuy = nfw COMMbrkfrSfgmfnt(nodf);
        insfrtCOMMbrkfrSfgmfnt(nfwGuy);
    }

     /**
      * Insfrt b nfw COM mbrkfr sfgmfnt into bn bppropribtf plbdf in thf
      * mbrkfr sfqufndf, bs follows:
      * If thfrf blrfbdy fxist COM mbrkfr sfgmfnts, thf nfw onf is insfrtfd
      * bftfr thf lbst onf.
      * If thfrf brf no COM sfgmfnts, thf nfw COM sfgmfnt is insfrtfd bftfr thf
      * JFIF sfgmfnt, if thfrf is onf.
      * If thfrf is no JFIF sfgmfnt, thf nfw COM sfgmfnt is insfrtfd bftfr thf
      * Adobf mbrkfr sfgmfnt, if thfrf is onf.
      * If thfrf is no Adobf sfgmfnt, thf nfw COM sfgmfnt is insfrtfd
      * bt thf bfginning of thf sfqufndf.
      */
    privbtf void insfrtCOMMbrkfrSfgmfnt(COMMbrkfrSfgmfnt nfwGuy) {
        int lbstCOM = findMbrkfrSfgmfntPosition(COMMbrkfrSfgmfnt.dlbss, fblsf);
        boolfbn hbsJFIF = (findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf) != null);
        int firstAdobf = findMbrkfrSfgmfntPosition(AdobfMbrkfrSfgmfnt.dlbss, truf);
        if (lbstCOM != -1) {
            mbrkfrSfqufndf.bdd(lbstCOM+1, nfwGuy);
        } flsf if (hbsJFIF) {
            mbrkfrSfqufndf.bdd(1, nfwGuy);  // JFIF is blwbys 0
        } flsf if (firstAdobf != -1) {
            mbrkfrSfqufndf.bdd(firstAdobf+1, nfwGuy);
        } flsf {
            mbrkfrSfqufndf.bdd(0, nfwGuy);
        }
    }

    /**
     * Mfrgf thf givfn Adobf APP14 nodf into thf mbrkfr sfqufndf.
     * If thfrf blrfbdy fxists bn Adobf mbrkfr sfgmfnt, thfn its bttributfs
     * brf updbtfd from thf nodf.
     * If thfrf is no Adobf sfgmfnt, thfn b nfw onf is drfbtfd bnd bddfd
     * using insfrtAdobfMbrkfrSfgmfnt.
     */
    privbtf void mfrgfAdobfNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        AdobfMbrkfrSfgmfnt bdobf =
            (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt.dlbss, truf);
        if (bdobf != null) {
            bdobf.updbtfFromNbtivfNodf(nodf, fblsf);
        } flsf {
            AdobfMbrkfrSfgmfnt nfwGuy = nfw AdobfMbrkfrSfgmfnt(nodf);
            insfrtAdobfMbrkfrSfgmfnt(nfwGuy);
        }
    }

    /**
     * Insfrt thf givfn AdobfMbrkfrSfgmfnt into thf mbrkfr sfqufndf, bs
     * follows (wf bssumf thfrf is no Adobf sfgmfnt yft):
     * If thfrf is b JFIF sfgmfnt, thfn thf nfw Adobf sfgmfnt is insfrtfd
     * bftfr it.
     * If thfrf is no JFIF sfgmfnt, thf nfw Adobf sfgmfnt is insfrtfd bftfr thf
     * lbst Unknown sfgmfnt, if thfrf brf bny.
     * If thfrf brf no Unknown sfgmfnts, thf nfw Adobf sfgmfnt is insfrtfd
     * bt thf bfginning of thf sfqufndf.
     */
    privbtf void insfrtAdobfMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt nfwGuy) {
        boolfbn hbsJFIF =
            (findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf) != null);
        int lbstUnknown = findLbstUnknownMbrkfrSfgmfntPosition();
        if (hbsJFIF) {
            mbrkfrSfqufndf.bdd(1, nfwGuy);  // JFIF is blwbys 0
        } flsf if (lbstUnknown != -1) {
            mbrkfrSfqufndf.bdd(lbstUnknown+1, nfwGuy);
        } flsf {
            mbrkfrSfqufndf.bdd(0, nfwGuy);
        }
    }

    /**
     * Mfrgf thf givfn Unknown nodf into thf mbrkfr sfqufndf.
     * A nfw Unknown mbrkfr sfgmfnt is drfbtfd bnd bddfd to thf sfqufndf bs
     * follows:
     * If thfrf blrfbdy fxist Unknown mbrkfr sfgmfnts, thf nfw onf is insfrtfd
     * bftfr thf lbst onf.
     * If thfrf brf no Unknown mbrkfr sfgmfnts, thf nfw Unknown mbrkfr sfgmfnt
     * is insfrtfd bftfr thf JFIF sfgmfnt, if thfrf is onf.
     * If thfrf is no JFIF sfgmfnt, thf nfw Unknown sfgmfnt is insfrtfd bfforf
     * thf Adobf mbrkfr sfgmfnt, if thfrf is onf.
     * If thfrf is no Adobf sfgmfnt, thf nfw Unknown sfgmfnt is insfrtfd
     * bt thf bfginning of thf sfqufndf.
     */
    privbtf void mfrgfUnknownNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        MbrkfrSfgmfnt nfwGuy = nfw MbrkfrSfgmfnt(nodf);
        int lbstUnknown = findLbstUnknownMbrkfrSfgmfntPosition();
        boolfbn hbsJFIF = (findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf) != null);
        int firstAdobf = findMbrkfrSfgmfntPosition(AdobfMbrkfrSfgmfnt.dlbss, truf);
        if (lbstUnknown != -1) {
            mbrkfrSfqufndf.bdd(lbstUnknown+1, nfwGuy);
        } flsf if (hbsJFIF) {
            mbrkfrSfqufndf.bdd(1, nfwGuy);  // JFIF is blwbys 0
        } if (firstAdobf != -1) {
            mbrkfrSfqufndf.bdd(firstAdobf, nfwGuy);
        } flsf {
            mbrkfrSfqufndf.bdd(0, nfwGuy);
        }
    }

    /**
     * Mfrgf thf givfn SOF nodf into thf mbrkfr sfqufndf.
     * If thfrf blrfbdy fxists bn SOF mbrkfr sfgmfnt in thf sfqufndf, thfn
     * its vblufs brf updbtfd from thf nodf.
     * If thfrf is no SOF sfgmfnt, thfn b nfw onf is drfbtfd bnd bddfd bs
     * follows:
     * If thfrf brf bny SOS sfgmfnts, thf nfw SOF sfgmfnt is insfrtfd bfforf
     * thf first onf.
     * If thfrf is no SOS sfgmfnt, thf nfw SOF sfgmfnt is bddfd to thf fnd
     * of thf sfqufndf.
     *
     */
    privbtf void mfrgfSOFNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        SOFMbrkfrSfgmfnt sof =
            (SOFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOFMbrkfrSfgmfnt.dlbss, truf);
        if (sof != null) {
            sof.updbtfFromNbtivfNodf(nodf, fblsf);
        } flsf {
            SOFMbrkfrSfgmfnt nfwGuy = nfw SOFMbrkfrSfgmfnt(nodf);
            int firstSOS = findMbrkfrSfgmfntPosition(SOSMbrkfrSfgmfnt.dlbss, truf);
            if (firstSOS != -1) {
                mbrkfrSfqufndf.bdd(firstSOS, nfwGuy);
            } flsf {
                mbrkfrSfqufndf.bdd(nfwGuy);
            }
        }
    }

    /**
     * Mfrgf thf givfn SOS nodf into thf mbrkfr sfqufndf.
     * If thfrf blrfbdy fxists b singlf SOS mbrkfr sfgmfnt, thfn thf vblufs
     * brf updbtfd from thf nodf.
     * If thfrf brf morf thbn onf fxisting SOS mbrkfr sfgmfnts, thfn bn
     * IIOInvblidTrffExdfption is thrown, bs SOS sfgmfnts dbnnot bf mfrgfd
     * into b sft of progrfssivf sdbns.
     * If thfrf brf no SOS mbrkfr sfgmfnts, b nfw onf is drfbtfd bnd bddfd
     * to thf fnd of thf sfqufndf.
     */
    privbtf void mfrgfSOSNodf(Nodf nodf) throws IIOInvblidTrffExdfption {
        SOSMbrkfrSfgmfnt firstSOS =
            (SOSMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOSMbrkfrSfgmfnt.dlbss, truf);
        SOSMbrkfrSfgmfnt lbstSOS =
            (SOSMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOSMbrkfrSfgmfnt.dlbss, fblsf);
        if (firstSOS != null) {
            if (firstSOS != lbstSOS) {
                throw nfw IIOInvblidTrffExdfption
                    ("Cbn't mfrgf SOS nodf into b trff with > 1 SOS nodf", nodf);
            }
            firstSOS.updbtfFromNbtivfNodf(nodf, fblsf);
        } flsf {
            mbrkfrSfqufndf.bdd(nfw SOSMbrkfrSfgmfnt(nodf));
        }
    }

    privbtf boolfbn trbnspbrfndyDonf;

    privbtf void mfrgfStbndbrdTrff(Nodf root) throws IIOInvblidTrffExdfption {
        trbnspbrfndyDonf = fblsf;
        NodfList dhildrfn = root.gftChildNodfs();
        for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
            Nodf nodf = dhildrfn.itfm(i);
            String nbmf = nodf.gftNodfNbmf();
            if (nbmf.fqubls("Chromb")) {
                mfrgfStbndbrdChrombNodf(nodf, dhildrfn);
            } flsf if (nbmf.fqubls("Comprfssion")) {
                mfrgfStbndbrdComprfssionNodf(nodf);
            } flsf if (nbmf.fqubls("Dbtb")) {
                mfrgfStbndbrdDbtbNodf(nodf);
            } flsf if (nbmf.fqubls("Dimfnsion")) {
                mfrgfStbndbrdDimfnsionNodf(nodf);
            } flsf if (nbmf.fqubls("Dodumfnt")) {
                mfrgfStbndbrdDodumfntNodf(nodf);
            } flsf if (nbmf.fqubls("Tfxt")) {
                mfrgfStbndbrdTfxtNodf(nodf);
            } flsf if (nbmf.fqubls("Trbnspbrfndy")) {
                mfrgfStbndbrdTrbnspbrfndyNodf(nodf);
            } flsf {
                throw nfw IIOInvblidTrffExdfption("Invblid nodf: " + nbmf, nodf);
            }
        }
    }

    /*
     * In gfnfrbl, it dould bf possiblf to donvfrt bll non-pixfl dbtb to somf
     * tfxtubl form bnd indludf it in dommfnts, but thfn this would drfbtf thf
     * fxpfdtbtion thbt thfsf dommfnt forms bf rfdognizfd by thf rfbdfr, thus
     * drfbting b dffbdto fxtfnsion to JPEG mftbdbtb dbpbbilitifs.  This is
     * probbbly bfst bvoidfd, so thf following donvfrt only tfxt nodfs to
     * dommfnts, bnd losf thf kfywords bs wfll.
     */

    privbtf void mfrgfStbndbrdChrombNodf(Nodf nodf, NodfList siblings)
        throws IIOInvblidTrffExdfption {
        // ColorSpbdfTypf dbn dhbngf thf tbrgft dolorspbdf for domprfssion
        // This must tbkf bny trbnspbrfndy nodf into bddount bs wfll, bs
        // thbt bfffdts thf numbfr of dhbnnfls (if blphb is prfsfnt).  If
        // b trbnspbrfndy nodf is dfblt with hfrf, sft b flbg to indidbtf
        // this to thf trbnspbrfndy prodfssor bflow.  If wf disdovfr thbt
        // thf nodfs brf not in ordfr, throw bn fxdfption bs thf trff is
        // invblid.

        if (trbnspbrfndyDonf) {
            throw nfw IIOInvblidTrffExdfption
                ("Trbnspbrfndy nodf must follow Chromb nodf", nodf);
        }

        Nodf dsTypf = nodf.gftFirstChild();
        if ((dsTypf == null) || !dsTypf.gftNodfNbmf().fqubls("ColorSpbdfTypf")) {
            // If thfrf is no ColorSpbdfTypf nodf, wf hbvf nothing to do
            rfturn;
        }

        String dsNbmf = dsTypf.gftAttributfs().gftNbmfdItfm("nbmf").gftNodfVbluf();

        int numChbnnfls = 0;
        boolfbn wbntJFIF = fblsf;
        boolfbn wbntAdobf = fblsf;
        int trbnsform = 0;
        boolfbn willSubsbmplf = fblsf;
        bytf [] ids = {1, 2, 3, 4};  // JFIF dompbtiblf
        if (dsNbmf.fqubls("GRAY")) {
            numChbnnfls = 1;
            wbntJFIF = truf;
        } flsf if (dsNbmf.fqubls("YCbCr")) {
            numChbnnfls = 3;
            wbntJFIF = truf;
            willSubsbmplf = truf;
        } flsf if (dsNbmf.fqubls("PhotoYCC")) {
            numChbnnfls = 3;
            wbntAdobf = truf;
            trbnsform = JPEG.ADOBE_YCC;
            ids[0] = (bytf) 'Y';
            ids[1] = (bytf) 'C';
            ids[2] = (bytf) 'd';
        } flsf if (dsNbmf.fqubls("RGB")) {
            numChbnnfls = 3;
            wbntAdobf = truf;
            trbnsform = JPEG.ADOBE_UNKNOWN;
            ids[0] = (bytf) 'R';
            ids[1] = (bytf) 'G';
            ids[2] = (bytf) 'B';
        } flsf if ((dsNbmf.fqubls("XYZ"))
                   || (dsNbmf.fqubls("Lbb"))
                   || (dsNbmf.fqubls("Luv"))
                   || (dsNbmf.fqubls("YxY"))
                   || (dsNbmf.fqubls("HSV"))
                   || (dsNbmf.fqubls("HLS"))
                   || (dsNbmf.fqubls("CMY"))
                   || (dsNbmf.fqubls("3CLR"))) {
            numChbnnfls = 3;
        } flsf if (dsNbmf.fqubls("YCCK")) {
            numChbnnfls = 4;
            wbntAdobf = truf;
            trbnsform = JPEG.ADOBE_YCCK;
            willSubsbmplf = truf;
        } flsf if (dsNbmf.fqubls("CMYK")) {
            numChbnnfls = 4;
            wbntAdobf = truf;
            trbnsform = JPEG.ADOBE_UNKNOWN;
        } flsf if (dsNbmf.fqubls("4CLR")) {
            numChbnnfls = 4;
        } flsf { // Wf dbn't hbndlf thfm, so don't modify bny mftbdbtb
            rfturn;
        }

        boolfbn wbntAlphb = fblsf;
        for (int i = 0; i < siblings.gftLfngth(); i++) {
            Nodf trbns = siblings.itfm(i);
            if (trbns.gftNodfNbmf().fqubls("Trbnspbrfndy")) {
                wbntAlphb = wbntAlphb(trbns);
                brfbk;  // out of for
            }
        }

        if (wbntAlphb) {
            numChbnnfls++;
            wbntJFIF = fblsf;
            if (ids[0] == (bytf) 'R') {
                ids[3] = (bytf) 'A';
                wbntAdobf = fblsf;
            }
        }

        JFIFMbrkfrSfgmfnt jfif =
            (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf);
        AdobfMbrkfrSfgmfnt bdobf =
            (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt.dlbss, truf);
        SOFMbrkfrSfgmfnt sof =
            (SOFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOFMbrkfrSfgmfnt.dlbss, truf);
        SOSMbrkfrSfgmfnt sos =
            (SOSMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOSMbrkfrSfgmfnt.dlbss, truf);

        // If thf mftbdbtb spfdififs progrfssivf, thfn thf numbfr of dhbnnfls
        // must mbtdh, so thbt wf dbn modify bll thf fxisting SOS mbrkfr sfgmfnts.
        // If thfy don't mbtdh, wf don't know whbt to do with SOS so wf dbn't do
        // thf mfrgf.  Wf thfn just rfturn silfntly.
        // An fxdfption would not bf bppropribtf.  A wbrning might, but wf hbvf
        // nowhfrf to sfnd it to.
        if ((sof != null) && (sof.tbg == JPEG.SOF2)) { // Progrfssivf
            if ((sof.domponfntSpfds.lfngth != numChbnnfls) && (sos != null)) {
                rfturn;
            }
        }

        // JFIF hfbdfr might bf rfmovfd
        if (!wbntJFIF && (jfif != null)) {
            mbrkfrSfqufndf.rfmovf(jfif);
        }

        // Now bdd b JFIF if wf do wbnt onf, but only if it isn't strfbm mftbdbtb
        if (wbntJFIF && !isStrfbm) {
            mbrkfrSfqufndf.bdd(0, nfw JFIFMbrkfrSfgmfnt());
        }

        // Adobf hfbdfr might bf rfmovfd or thf trbnsform modififd, if it isn't
        // strfbm mftbdbtb
        if (wbntAdobf) {
            if ((bdobf == null) && !isStrfbm) {
                bdobf = nfw AdobfMbrkfrSfgmfnt(trbnsform);
                insfrtAdobfMbrkfrSfgmfnt(bdobf);
            } flsf {
                bdobf.trbnsform = trbnsform;
            }
        } flsf if (bdobf != null) {
            mbrkfrSfqufndf.rfmovf(bdobf);
        }

        boolfbn updbtfQtbblfs = fblsf;
        boolfbn updbtfHtbblfs = fblsf;

        boolfbn progrfssivf = fblsf;

        int [] subsbmplfdSflfdtors = {0, 1, 1, 0 } ;
        int [] nonSubsbmplfdSflfdtors = { 0, 0, 0, 0};

        int [] nfwTbblfSflfdtors = willSubsbmplf
                                   ? subsbmplfdSflfdtors
                                   : nonSubsbmplfdSflfdtors;

        // Kffp thf old domponfntSpfds brrby
        SOFMbrkfrSfgmfnt.ComponfntSpfd [] oldCompSpfds = null;
        // SOF might bf modififd
        if (sof != null) {
            oldCompSpfds = sof.domponfntSpfds;
            progrfssivf = (sof.tbg == JPEG.SOF2);
            // Now rfplbdf thf SOF with b nfw onf; it might bf thf sbmf, but
            // this is fbsifr.
            mbrkfrSfqufndf.sft(mbrkfrSfqufndf.indfxOf(sof),
                               nfw SOFMbrkfrSfgmfnt(progrfssivf,
                                                    fblsf, // wf nfvfr nffd fxtfndfd
                                                    willSubsbmplf,
                                                    ids,
                                                    numChbnnfls));

            // Now suss out if subsbmpling dhbngfd bnd sft thf boolfbn for
            // updbting thf q tbblfs
            // if thf old domponfntSpfd q tbblf sflfdtors don't mbtdh
            // thf nfw onfs, updbtf thf qtbblfs.  Thf nfw sflfdtors brf blrfbdy
            // in plbdf in thf nfw SOF sfgmfnt bbovf.
            for (int i = 0; i < oldCompSpfds.lfngth; i++) {
                if (oldCompSpfds[i].QtbblfSflfdtor != nfwTbblfSflfdtors[i]) {
                    updbtfQtbblfs = truf;
                }
            }

            if (progrfssivf) {
                // if thf domponfnt ids brf difffrfnt, updbtf bll thf fxisting sdbns
                // ignorf Huffmbn tbblfs
                boolfbn idsDifffr = fblsf;
                for (int i = 0; i < oldCompSpfds.lfngth; i++) {
                    if (ids[i] != oldCompSpfds[i].domponfntId) {
                        idsDifffr = truf;
                    }
                }
                if (idsDifffr) {
                    // updbtf thf ids in fbdh SOS mbrkfr sfgmfnt
                    for (Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
                            itfr.hbsNfxt();) {
                        MbrkfrSfgmfnt sfg = itfr.nfxt();
                        if (sfg instbndfof SOSMbrkfrSfgmfnt) {
                            SOSMbrkfrSfgmfnt tbrgft = (SOSMbrkfrSfgmfnt) sfg;
                            for (int i = 0; i < tbrgft.domponfntSpfds.lfngth; i++) {
                                int oldSflfdtor =
                                    tbrgft.domponfntSpfds[i].domponfntSflfdtor;
                                // Find thf position in thf old domponfntSpfds brrby
                                // of thf old domponfnt with thf old sflfdtor
                                // bnd rfplbdf thf domponfnt sflfdtor with thf
                                // nfw id bt thf sbmf position, bs thfsf mbtdh
                                // thf nfw domponfnt spfds brrby in thf SOF drfbtfd
                                // bbovf.
                                for (int j = 0; j < oldCompSpfds.lfngth; j++) {
                                    if (oldCompSpfds[j].domponfntId == oldSflfdtor) {
                                        tbrgft.domponfntSpfds[i].domponfntSflfdtor =
                                            ids[j];
                                    }
                                }
                            }
                        }
                    }
                }
            } flsf {
                if (sos != null) {
                    // htbblfs - if thf old htbblf sflfdtors don't mbtdh thf nfw onfs,
                    // updbtf thf tbblfs.
                    for (int i = 0; i < sos.domponfntSpfds.lfngth; i++) {
                        if ((sos.domponfntSpfds[i].ddHuffTbblf
                             != nfwTbblfSflfdtors[i])
                            || (sos.domponfntSpfds[i].bdHuffTbblf
                                != nfwTbblfSflfdtors[i])) {
                            updbtfHtbblfs = truf;
                        }
                    }

                    // Might bf thf sbmf bs thf old onf, but this is fbsifr.
                    mbrkfrSfqufndf.sft(mbrkfrSfqufndf.indfxOf(sos),
                               nfw SOSMbrkfrSfgmfnt(willSubsbmplf,
                                                    ids,
                                                    numChbnnfls));
                }
            }
        } flsf {
            // should bf strfbm mftbdbtb if thfrf isn't bn SOF, but dhfdk it bnywby
            if (isStrfbm) {
                // updbtf tbblfs - routinfs bflow dhfdk if it's rfblly nfdfssbry
                updbtfQtbblfs = truf;
                updbtfHtbblfs = truf;
            }
        }

        if (updbtfQtbblfs) {
            List<DQTMbrkfrSfgmfnt> tbblfSfgmfnts = nfw ArrbyList<>();
            for (Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
                    itfr.hbsNfxt();) {
                MbrkfrSfgmfnt sfg = itfr.nfxt();
                if (sfg instbndfof DQTMbrkfrSfgmfnt) {
                    tbblfSfgmfnts.bdd((DQTMbrkfrSfgmfnt) sfg);
                }
            }
            // If thfrf brf no tbblfs, don't bdd thfm, bs thf mftbdbtb fndodfs bn
            // bbbrfvibtfd strfbm.
            // If wf brf not subsbmpling, wf just nffd onf, so don't do bnything
            if (!tbblfSfgmfnts.isEmpty() && willSubsbmplf) {
                // Is it rfblly nfdfssbry?  Thfrf should bf bt lfbst 2 tbblfs.
                // If thfrf is only onf, bssumf it's b sdblfd "stbndbrd"
                // luminbndf tbblf, fxtrbdt thf sdbling fbdtor, bnd gfnfrbtf b
                // sdblfd "stbndbrd" dhrominbndf tbblf.

                // Find thf tbblf with sflfdtor 1.
                boolfbn found = fblsf;
                for (Itfrbtor<DQTMbrkfrSfgmfnt> itfr = tbblfSfgmfnts.itfrbtor();
                        itfr.hbsNfxt();) {
                    DQTMbrkfrSfgmfnt tfstdqt = itfr.nfxt();
                    for (Itfrbtor<DQTMbrkfrSfgmfnt.Qtbblf> tbbitfr =
                            tfstdqt.tbblfs.itfrbtor(); tbbitfr.hbsNfxt();) {
                        DQTMbrkfrSfgmfnt.Qtbblf tbb = tbbitfr.nfxt();
                        if (tbb.tbblfID == 1) {
                            found = truf;
                        }
                    }
                }
                if (!found) {
                    //    find thf tbblf with sflfdtor 0.  Thfrf should bf onf.
                    DQTMbrkfrSfgmfnt.Qtbblf tbblf0 = null;
                    for (Itfrbtor<DQTMbrkfrSfgmfnt> itfr =
                            tbblfSfgmfnts.itfrbtor(); itfr.hbsNfxt();) {
                        DQTMbrkfrSfgmfnt tfstdqt = itfr.nfxt();
                        for (Itfrbtor<DQTMbrkfrSfgmfnt.Qtbblf> tbbitfr =
                                tfstdqt.tbblfs.itfrbtor(); tbbitfr.hbsNfxt();) {
                            DQTMbrkfrSfgmfnt.Qtbblf tbb = tbbitfr.nfxt();
                            if (tbb.tbblfID == 0) {
                                tbblf0 = tbb;
                            }
                        }
                    }

                    // Assuming thbt thf tbblf with id 0 is b luminbndf tbblf,
                    // domputf b nfw dhrominbndf tbblf of thf sbmf qublity bnd
                    // bdd it to thf lbst DQT sfgmfnt
                    DQTMbrkfrSfgmfnt dqt = tbblfSfgmfnts.gft(tbblfSfgmfnts.sizf()-1);
                    dqt.tbblfs.bdd(dqt.gftChrombForLumb(tbblf0));
                }
            }
        }

        if (updbtfHtbblfs) {
            List<DHTMbrkfrSfgmfnt> tbblfSfgmfnts = nfw ArrbyList<>();
            for (Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
                    itfr.hbsNfxt();) {
                MbrkfrSfgmfnt sfg = itfr.nfxt();
                if (sfg instbndfof DHTMbrkfrSfgmfnt) {
                    tbblfSfgmfnts.bdd((DHTMbrkfrSfgmfnt) sfg);
                }
            }
            // If thfrf brf no tbblfs, don't bdd thfm, bs thf mftbdbtb fndodfs bn
            // bbbrfvibtfd strfbm.
            // If wf brf not subsbmpling, wf just nffd onf, so don't do bnything
            if (!tbblfSfgmfnts.isEmpty() && willSubsbmplf) {
                // Is it rfblly nfdfssbry?  Thfrf should bf bt lfbst 2 dd bnd 2 bd
                // tbblfs.  If thfrf is only onf, bdd b
                // "stbndbrd " dhrominbndf tbblf.

                // find b tbblf with sflfdtor 1. AC/DC is irrflfvbnt
                boolfbn found = fblsf;
                for (Itfrbtor<DHTMbrkfrSfgmfnt> itfr = tbblfSfgmfnts.itfrbtor();
                        itfr.hbsNfxt();) {
                    DHTMbrkfrSfgmfnt tfstdht = itfr.nfxt();
                    for (Itfrbtor<DHTMbrkfrSfgmfnt.Htbblf> tbbitfr =
                            tfstdht.tbblfs.itfrbtor(); tbbitfr.hbsNfxt();) {
                        DHTMbrkfrSfgmfnt.Htbblf tbb = tbbitfr.nfxt();
                        if (tbb.tbblfID == 1) {
                            found = truf;
                        }
                    }
                }
                if (!found) {
                    // Crfbtf nfw stbndbrd dd bnd bd dhrominbndf tbblfs bnd bdd thfm
                    // to thf lbst DHT sfgmfnt
                    DHTMbrkfrSfgmfnt lbstDHT =
                        tbblfSfgmfnts.gft(tbblfSfgmfnts.sizf()-1);
                    lbstDHT.bddHtbblf(JPEGHuffmbnTbblf.StdDCLuminbndf, truf, 1);
                    lbstDHT.bddHtbblf(JPEGHuffmbnTbblf.StdACLuminbndf, truf, 1);
                }
            }
        }
    }

    privbtf boolfbn wbntAlphb(Nodf trbnspbrfndy) {
        boolfbn rfturnVbluf = fblsf;
        Nodf blphb = trbnspbrfndy.gftFirstChild();  // Alphb must bf first if prfsfnt
        if (blphb.gftNodfNbmf().fqubls("Alphb")) {
            if (blphb.hbsAttributfs()) {
                String vbluf =
                    blphb.gftAttributfs().gftNbmfdItfm("vbluf").gftNodfVbluf();
                if (!vbluf.fqubls("nonf")) {
                    rfturnVbluf = truf;
                }
            }
        }
        trbnspbrfndyDonf = truf;
        rfturn rfturnVbluf;
    }

    privbtf void mfrgfStbndbrdComprfssionNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // NumProgrfssivfSdbns is ignorfd.  Progrfssion must bf fnbblfd on thf
        // ImbgfWritfPbrbm.
        // No-op
    }

    privbtf void mfrgfStbndbrdDbtbNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // No-op
    }

    privbtf void mfrgfStbndbrdDimfnsionNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // Pixfl Aspfdt Rbtio or pixfl sizf dbn bf indorporbtfd if thfrf is,
        // or dbn bf, b JFIF sfgmfnt
        JFIFMbrkfrSfgmfnt jfif =
            (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss, truf);
        if (jfif == null) {
            // Cbn thfrf bf onf?
            // Critfrib:
            // SOF must bf prfsfnt with 1 or 3 dhbnnfls, (strfbm mftbdbtb fbils this)
            //     Componfnt ids must bf JFIF dompbtiblf.
            boolfbn dbnHbvfJFIF = fblsf;
            SOFMbrkfrSfgmfnt sof =
                (SOFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOFMbrkfrSfgmfnt.dlbss, truf);
            if (sof != null) {
                int numChbnnfls = sof.domponfntSpfds.lfngth;
                if ((numChbnnfls == 1) || (numChbnnfls == 3)) {
                    dbnHbvfJFIF = truf; // rfmbining tfsts brf nfgbtivf
                    for (int i = 0; i < sof.domponfntSpfds.lfngth; i++) {
                        if (sof.domponfntSpfds[i].domponfntId != i+1)
                            dbnHbvfJFIF = fblsf;
                    }
                    // if Adobf prfsfnt, trbnsform = ADOBE_UNKNOWN for 1-dhbnnfl,
                    //     ADOBE_YCC for 3-dhbnnfl.
                    AdobfMbrkfrSfgmfnt bdobf =
                        (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt.dlbss,
                                                               truf);
                    if (bdobf != null) {
                        if (bdobf.trbnsform != ((numChbnnfls == 1)
                                                ? JPEG.ADOBE_UNKNOWN
                                                : JPEG.ADOBE_YCC)) {
                            dbnHbvfJFIF = fblsf;
                        }
                    }
                }
            }
            // If so, drfbtf onf bnd insfrt it into thf sfqufndf.  Notf thbt
            // dffbult is just pixfl rbtio bt 1:1
            if (dbnHbvfJFIF) {
                jfif = nfw JFIFMbrkfrSfgmfnt();
                mbrkfrSfqufndf.bdd(0, jfif);
            }
        }
        if (jfif != null) {
            NodfList dhildrfn = nodf.gftChildNodfs();
            for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
                Nodf dhild = dhildrfn.itfm(i);
                NbmfdNodfMbp bttrs = dhild.gftAttributfs();
                String nbmf = dhild.gftNodfNbmf();
                if (nbmf.fqubls("PixflAspfdtRbtio")) {
                    String vblufString = bttrs.gftNbmfdItfm("vbluf").gftNodfVbluf();
                    flobt vbluf = Flobt.pbrsfFlobt(vblufString);
                    Point p = findIntfgfrRbtio(vbluf);
                    jfif.rfsUnits = JPEG.DENSITY_UNIT_ASPECT_RATIO;
                    jfif.Xdfnsity = p.x;
                    jfif.Xdfnsity = p.y;
                } flsf if (nbmf.fqubls("HorizontblPixflSizf")) {
                    String vblufString = bttrs.gftNbmfdItfm("vbluf").gftNodfVbluf();
                    flobt vbluf = Flobt.pbrsfFlobt(vblufString);
                    // Convfrt from mm/dot to dots/dm
                    int dpdm = (int) Mbth.round(1.0/(vbluf*10.0));
                    jfif.rfsUnits = JPEG.DENSITY_UNIT_DOTS_CM;
                    jfif.Xdfnsity = dpdm;
                } flsf if (nbmf.fqubls("VfrtidblPixflSizf")) {
                    String vblufString = bttrs.gftNbmfdItfm("vbluf").gftNodfVbluf();
                    flobt vbluf = Flobt.pbrsfFlobt(vblufString);
                    // Convfrt from mm/dot to dots/dm
                    int dpdm = (int) Mbth.round(1.0/(vbluf*10.0));
                    jfif.rfsUnits = JPEG.DENSITY_UNIT_DOTS_CM;
                    jfif.Ydfnsity = dpdm;
                }

            }
        }
    }

    /*
     * Rfturn b pbir of intfgfrs whosf rbtio (x/y) bpproximbtfs thf givfn
     * flobt vbluf.
     */
    privbtf stbtid Point findIntfgfrRbtio(flobt vbluf) {
        flobt fpsilon = 0.005F;

        // Normblizf
        vbluf = Mbth.bbs(vbluf);

        // Dfbl with min dbsf
        if (vbluf <= fpsilon) {
            rfturn nfw Point(1, 255);
        }

        // Dfbl with mbx dbsf
        if (vbluf >= 255) {
            rfturn nfw Point(255, 1);
        }

        // Rfmfmbfr if wf invfrt
        boolfbn invfrtfd = fblsf;
        if (vbluf < 1.0) {
            vbluf = 1.0F/vbluf;
            invfrtfd = truf;
        }

        // First bpproximbtion
        int y = 1;
        int x = Mbth.round(vbluf);

        flobt rbtio = (flobt) x;
        flobt dfltb = Mbth.bbs(vbluf - rbtio);
        whilf (dfltb > fpsilon) { // not dlosf fnough
            // Indrfmfnt y bnd domputf b nfw x
            y++;
            x = Mbth.round(y*vbluf);
            rbtio = (flobt)x/(flobt)y;
            dfltb = Mbth.bbs(vbluf - rbtio);
        }
        rfturn invfrtfd ? nfw Point(y, x) : nfw Point(x, y);
    }

    privbtf void mfrgfStbndbrdDodumfntNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // No-op
    }

    privbtf void mfrgfStbndbrdTfxtNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // Convfrt to dommfnts.  For thf momfnt ignorf thf fndoding issuf.
        // Ignorf kfywords, lbngubgf, bnd fndoding (for thf momfnt).
        // If domprfssion tbg is prfsfnt, usf only fntrifs with "nonf".
        NodfList dhildrfn = nodf.gftChildNodfs();
        for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
            Nodf dhild = dhildrfn.itfm(i);
            NbmfdNodfMbp bttrs = dhild.gftAttributfs();
            Nodf domp = bttrs.gftNbmfdItfm("domprfssion");
            boolfbn dopyIt = truf;
            if (domp != null) {
                String dompString = domp.gftNodfVbluf();
                if (!dompString.fqubls("nonf")) {
                    dopyIt = fblsf;
                }
            }
            if (dopyIt) {
                String vbluf = bttrs.gftNbmfdItfm("vbluf").gftNodfVbluf();
                COMMbrkfrSfgmfnt dom = nfw COMMbrkfrSfgmfnt(vbluf);
                insfrtCOMMbrkfrSfgmfnt(dom);
            }
        }
    }

    privbtf void mfrgfStbndbrdTrbnspbrfndyNodf(Nodf nodf)
        throws IIOInvblidTrffExdfption {
        // This might indidbtf thbt bn blphb dhbnnfl is bfing bddfd or rfmovfd.
        // Thf nodfs must bppfbr in ordfr, bnd b Chromb nodf will prodfss bny
        // trbnspbrfndy, so prodfss it hfrf only if thfrf wbs no Chromb nodf
        // Do nothing for strfbm mftbdbtb
        if (!trbnspbrfndyDonf && !isStrfbm) {
            boolfbn wbntAlphb = wbntAlphb(nodf);
            // do wf hbvf blphb blrfbdy?  If thf numbfr of dhbnnfls is 2 or 4,
            // wf do, bs wf don't support CMYK, nor dbn wf bdd blphb to it
            // Thf numbfr of dhbnnfls dbn bf dftfrminfd from thf SOF
            JFIFMbrkfrSfgmfnt jfif = (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                (JFIFMbrkfrSfgmfnt.dlbss, truf);
            AdobfMbrkfrSfgmfnt bdobf = (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                (AdobfMbrkfrSfgmfnt.dlbss, truf);
            SOFMbrkfrSfgmfnt sof = (SOFMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                (SOFMbrkfrSfgmfnt.dlbss, truf);
            SOSMbrkfrSfgmfnt sos = (SOSMbrkfrSfgmfnt) findMbrkfrSfgmfnt
                (SOSMbrkfrSfgmfnt.dlbss, truf);

            // Wf dbn do nothing for progrfssivf, bs wf don't know how to
            // modify thf sdbns.
            if ((sof != null) && (sof.tbg == JPEG.SOF2)) { // Progrfssivf
                rfturn;
            }

            // Do wf blrfbdy hbvf blphb?  Wf dbn tfll by thf numbfr of dhbnnfls
            // Wf must hbvf bn sof, or wf dbn't do bnything furthfr
            if (sof != null) {
                int numChbnnfls = sof.domponfntSpfds.lfngth;
                boolfbn hbdAlphb = (numChbnnfls == 2) || (numChbnnfls == 4);
                // prodffd only if thf old stbtf bnd thf nfw stbtf difffr
                if (hbdAlphb != wbntAlphb) {
                    if (wbntAlphb) {  // Adding blphb
                        numChbnnfls++;
                        if (jfif != null) {
                            mbrkfrSfqufndf.rfmovf(jfif);
                        }

                        // If bn bdobf mbrkfr is prfsfnt, trbnsform must bf UNKNOWN
                        if (bdobf != null) {
                            bdobf.trbnsform = JPEG.ADOBE_UNKNOWN;
                        }

                        // Add b domponfnt spfd with bppropribtf pbrbmftfrs to SOF
                        SOFMbrkfrSfgmfnt.ComponfntSpfd [] nfwSpfds =
                            nfw SOFMbrkfrSfgmfnt.ComponfntSpfd[numChbnnfls];
                        for (int i = 0; i < sof.domponfntSpfds.lfngth; i++) {
                            nfwSpfds[i] = sof.domponfntSpfds[i];
                        }
                        bytf oldFirstID = (bytf) sof.domponfntSpfds[0].domponfntId;
                        bytf nfwID = (bytf) ((oldFirstID > 1) ? 'A' : 4);
                        nfwSpfds[numChbnnfls-1] =
                            sof.gftComponfntSpfd(nfwID,
                                sof.domponfntSpfds[0].HsbmplingFbdtor,
                                sof.domponfntSpfds[0].QtbblfSflfdtor);

                        sof.domponfntSpfds = nfwSpfds;

                        // Add b domponfnt spfd with bppropribtf pbrbmftfrs to SOS
                        SOSMbrkfrSfgmfnt.SdbnComponfntSpfd [] nfwSdbnSpfds =
                            nfw SOSMbrkfrSfgmfnt.SdbnComponfntSpfd [numChbnnfls];
                        for (int i = 0; i < sos.domponfntSpfds.lfngth; i++) {
                            nfwSdbnSpfds[i] = sos.domponfntSpfds[i];
                        }
                        nfwSdbnSpfds[numChbnnfls-1] =
                            sos.gftSdbnComponfntSpfd (nfwID, 0);
                        sos.domponfntSpfds = nfwSdbnSpfds;
                    } flsf {  // Rfmoving blphb
                        numChbnnfls--;
                        // Rfmovf b domponfnt spfd from SOF
                        SOFMbrkfrSfgmfnt.ComponfntSpfd [] nfwSpfds =
                            nfw SOFMbrkfrSfgmfnt.ComponfntSpfd[numChbnnfls];
                        for (int i = 0; i < numChbnnfls; i++) {
                            nfwSpfds[i] = sof.domponfntSpfds[i];
                        }
                        sof.domponfntSpfds = nfwSpfds;

                        // Rfmovf b domponfnt spfd from SOS
                        SOSMbrkfrSfgmfnt.SdbnComponfntSpfd [] nfwSdbnSpfds =
                            nfw SOSMbrkfrSfgmfnt.SdbnComponfntSpfd [numChbnnfls];
                        for (int i = 0; i < numChbnnfls; i++) {
                            nfwSdbnSpfds[i] = sos.domponfntSpfds[i];
                        }
                        sos.domponfntSpfds = nfwSdbnSpfds;
                    }
                }
            }
        }
    }


    publid void sftFromTrff(String formbtNbmf, Nodf root)
        throws IIOInvblidTrffExdfption {
        if (formbtNbmf == null) {
            throw nfw IllfgblArgumfntExdfption("null formbtNbmf!");
        }
        if (root == null) {
            throw nfw IllfgblArgumfntExdfption("null root!");
        }
        if (isStrfbm &&
            (formbtNbmf.fqubls(JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf))) {
            sftFromNbtivfTrff(root);
        } flsf if (!isStrfbm &&
                   (formbtNbmf.fqubls(JPEG.nbtivfImbgfMftbdbtbFormbtNbmf))) {
            sftFromNbtivfTrff(root);
        } flsf if (!isStrfbm &&
                   (formbtNbmf.fqubls
                    (IIOMftbdbtbFormbtImpl.stbndbrdMftbdbtbFormbtNbmf))) {
            // In this dbsf b rfsft followfd by b mfrgf is dorrfdt
            supfr.sftFromTrff(formbtNbmf, root);
        } flsf {
            throw  nfw IllfgblArgumfntExdfption("Unsupportfd formbt nbmf: "
                                                + formbtNbmf);
        }
    }

    privbtf void sftFromNbtivfTrff(Nodf root) throws IIOInvblidTrffExdfption {
        if (rfsftSfqufndf == null) {
            rfsftSfqufndf = mbrkfrSfqufndf;
        }
        mbrkfrSfqufndf = nfw ArrbyList<>();

        // Build b wholf nfw mbrkfr sfqufndf from thf trff

        String nbmf = root.gftNodfNbmf();
        if (nbmf != ((isStrfbm) ? JPEG.nbtivfStrfbmMftbdbtbFormbtNbmf
                                : JPEG.nbtivfImbgfMftbdbtbFormbtNbmf)) {
            throw nfw IIOInvblidTrffExdfption("Invblid root nodf nbmf: " + nbmf,
                                              root);
        }
        if (!isStrfbm) {
            if (root.gftChildNodfs().gftLfngth() != 2) { // JPEGvbrifty bnd mbrkfrSfqufndf
                throw nfw IIOInvblidTrffExdfption(
                    "JPEGvbrifty bnd mbrkfrSfqufndf nodfs must bf prfsfnt", root);
            }

            Nodf JPEGvbrifty = root.gftFirstChild();

            if (JPEGvbrifty.gftChildNodfs().gftLfngth() != 0) {
                mbrkfrSfqufndf.bdd(nfw JFIFMbrkfrSfgmfnt(JPEGvbrifty.gftFirstChild()));
            }
        }

        Nodf mbrkfrSfqufndfNodf = isStrfbm ? root : root.gftLbstChild();
        sftFromMbrkfrSfqufndfNodf(mbrkfrSfqufndfNodf);

    }

    void sftFromMbrkfrSfqufndfNodf(Nodf mbrkfrSfqufndfNodf)
        throws IIOInvblidTrffExdfption{

        NodfList dhildrfn = mbrkfrSfqufndfNodf.gftChildNodfs();
        // for bll thf dhildrfn, bdd b mbrkfr sfgmfnt
        for (int i = 0; i < dhildrfn.gftLfngth(); i++) {
            Nodf nodf = dhildrfn.itfm(i);
            String dhildNbmf = nodf.gftNodfNbmf();
            if (dhildNbmf.fqubls("dqt")) {
                mbrkfrSfqufndf.bdd(nfw DQTMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("dht")) {
                mbrkfrSfqufndf.bdd(nfw DHTMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("dri")) {
                mbrkfrSfqufndf.bdd(nfw DRIMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("dom")) {
                mbrkfrSfqufndf.bdd(nfw COMMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("bpp14Adobf")) {
                mbrkfrSfqufndf.bdd(nfw AdobfMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("unknown")) {
                mbrkfrSfqufndf.bdd(nfw MbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("sof")) {
                mbrkfrSfqufndf.bdd(nfw SOFMbrkfrSfgmfnt(nodf));
            } flsf if (dhildNbmf.fqubls("sos")) {
                mbrkfrSfqufndf.bdd(nfw SOSMbrkfrSfgmfnt(nodf));
            } flsf {
                throw nfw IIOInvblidTrffExdfption("Invblid "
                    + (isStrfbm ? "strfbm " : "imbgf ") + "dhild: "
                    + dhildNbmf, nodf);
            }
        }
    }

    /**
     * Chfdk thbt this mftbdbtb objfdt is in b donsistfnt stbtf bnd
     * rfturn <dodf>truf</dodf> if it is or <dodf>fblsf</dodf>
     * othfrwisf.  All thf donstrudtors bnd modififrs should dbll
     * this mfthod bt thf fnd to gubrbntff thbt thf dbtb is blwbys
     * donsistfnt, bs thf writfr rflifs on this.
     */
    privbtf boolfbn isConsistfnt() {
        SOFMbrkfrSfgmfnt sof =
            (SOFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOFMbrkfrSfgmfnt.dlbss,
                                                 truf);
        JFIFMbrkfrSfgmfnt jfif =
            (JFIFMbrkfrSfgmfnt) findMbrkfrSfgmfnt(JFIFMbrkfrSfgmfnt.dlbss,
                                                  truf);
        AdobfMbrkfrSfgmfnt bdobf =
            (AdobfMbrkfrSfgmfnt) findMbrkfrSfgmfnt(AdobfMbrkfrSfgmfnt.dlbss,
                                                   truf);
        boolfbn rftvbl = truf;
        if (!isStrfbm) {
            if (sof != null) {
                // SOF numBbnds = totbl sdbn bbnds
                int numSOFBbnds = sof.domponfntSpfds.lfngth;
                int numSdbnBbnds = dountSdbnBbnds();
                if (numSdbnBbnds != 0) {  // No SOS is OK
                    if (numSdbnBbnds != numSOFBbnds) {
                        rftvbl = fblsf;
                    }
                }
                // If JFIF is prfsfnt, domponfnt ids brf 1-3, bbnds brf 1 or 3
                if (jfif != null) {
                    if ((numSOFBbnds != 1) && (numSOFBbnds != 3)) {
                        rftvbl = fblsf;
                    }
                    for (int i = 0; i < numSOFBbnds; i++) {
                        if (sof.domponfntSpfds[i].domponfntId != i+1) {
                            rftvbl = fblsf;
                        }
                    }

                    // If both JFIF bnd Adobf brf prfsfnt,
                    // Adobf trbnsform == unknown for grby,
                    // YCC for 3-dhbn.
                    if ((bdobf != null)
                        && (((numSOFBbnds == 1)
                             && (bdobf.trbnsform != JPEG.ADOBE_UNKNOWN))
                            || ((numSOFBbnds == 3)
                                && (bdobf.trbnsform != JPEG.ADOBE_YCC)))) {
                        rftvbl = fblsf;
                    }
                }
            } flsf {
                // strfbm dbn't hbvf jfif, bdobf, sof, or sos
                SOSMbrkfrSfgmfnt sos =
                    (SOSMbrkfrSfgmfnt) findMbrkfrSfgmfnt(SOSMbrkfrSfgmfnt.dlbss,
                                                         truf);
                if ((jfif != null) || (bdobf != null)
                    || (sof != null) || (sos != null)) {
                    rftvbl = fblsf;
                }
            }
        }
        rfturn rftvbl;
    }

    /**
     * Rfturns thf totbl numbfr of bbnds rfffrfndfd in bll SOS mbrkfr
     * sfgmfnts, indluding 0 if thfrf brf no SOS mbrkfr sfgmfnts.
     */
    privbtf int dountSdbnBbnds() {
        List<Intfgfr> ids = nfw ArrbyList<>();
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf(itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            if (sfg instbndfof SOSMbrkfrSfgmfnt) {
                SOSMbrkfrSfgmfnt sos = (SOSMbrkfrSfgmfnt) sfg;
                SOSMbrkfrSfgmfnt.SdbnComponfntSpfd [] spfds = sos.domponfntSpfds;
                for (int i = 0; i < spfds.lfngth; i++) {
                    Intfgfr id = spfds[i].domponfntSflfdtor;
                    if (!ids.dontbins(id)) {
                        ids.bdd(id);
                    }
                }
            }
        }

        rfturn ids.sizf();
    }

    ///// Writfr support

    void writfToStrfbm(ImbgfOutputStrfbm ios,
                       boolfbn ignorfJFIF,
                       boolfbn fordfJFIF,
                       List<? fxtfnds BufffrfdImbgf> thumbnbils,
                       ICC_Profilf iddProfilf,
                       boolfbn ignorfAdobf,
                       int nfwAdobfTrbnsform,
                       JPEGImbgfWritfr writfr)
        throws IOExdfption {
        if (fordfJFIF) {
            // Writf b dffbult JFIF sfgmfnt, indluding thumbnbils
            // This won't bf duplidbtfd bflow bfdbusf fordfJFIF will bf
            // sft only if thfrf is no JFIF prfsfnt blrfbdy.
            JFIFMbrkfrSfgmfnt.writfDffbultJFIF(ios,
                                               thumbnbils,
                                               iddProfilf,
                                               writfr);
            if ((ignorfAdobf == fblsf)
                && (nfwAdobfTrbnsform != JPEG.ADOBE_IMPOSSIBLE)) {
                if ((nfwAdobfTrbnsform != JPEG.ADOBE_UNKNOWN)
                    && (nfwAdobfTrbnsform != JPEG.ADOBE_YCC)) {
                    // Not dompbtiblf, so ignorf Adobf.
                    ignorfAdobf = truf;
                    writfr.wbrningOddurrfd
                        (JPEGImbgfWritfr.WARNING_METADATA_ADJUSTED_FOR_THUMB);
                }
            }
        }
        // Itfrbtf ovfr fbdh MbrkfrSfgmfnt
        Itfrbtor<MbrkfrSfgmfnt> itfr = mbrkfrSfqufndf.itfrbtor();
        whilf(itfr.hbsNfxt()) {
            MbrkfrSfgmfnt sfg = itfr.nfxt();
            if (sfg instbndfof JFIFMbrkfrSfgmfnt) {
                if (ignorfJFIF == fblsf) {
                    JFIFMbrkfrSfgmfnt jfif = (JFIFMbrkfrSfgmfnt) sfg;
                    jfif.writfWithThumbs(ios, thumbnbils, writfr);
                    if (iddProfilf != null) {
                        JFIFMbrkfrSfgmfnt.writfICC(iddProfilf, ios);
                    }
                } // Othfrwisf ignorf it, bs rfqufstfd
            } flsf if (sfg instbndfof AdobfMbrkfrSfgmfnt) {
                if (ignorfAdobf == fblsf) {
                    if (nfwAdobfTrbnsform != JPEG.ADOBE_IMPOSSIBLE) {
                        AdobfMbrkfrSfgmfnt nfwAdobf =
                            (AdobfMbrkfrSfgmfnt) sfg.dlonf();
                        nfwAdobf.trbnsform = nfwAdobfTrbnsform;
                        nfwAdobf.writf(ios);
                    } flsf if (fordfJFIF) {
                        // If bdobf isn't JFIF dompbtiblf, ignorf it
                        AdobfMbrkfrSfgmfnt bdobf = (AdobfMbrkfrSfgmfnt) sfg;
                        if ((bdobf.trbnsform == JPEG.ADOBE_UNKNOWN)
                            || (bdobf.trbnsform == JPEG.ADOBE_YCC)) {
                            bdobf.writf(ios);
                        } flsf {
                            writfr.wbrningOddurrfd
                         (JPEGImbgfWritfr.WARNING_METADATA_ADJUSTED_FOR_THUMB);
                        }
                    } flsf {
                        sfg.writf(ios);
                    }
                } // Othfrwisf ignorf it, bs rfqufstfd
            } flsf {
                sfg.writf(ios);
            }
        }
    }

    //// End of writfr support

    publid void rfsft() {
        if (rfsftSfqufndf != null) {  // Othfrwisf no nffd to rfsft
            mbrkfrSfqufndf = rfsftSfqufndf;
            rfsftSfqufndf = null;
        }
    }

    publid void print() {
        for (int i = 0; i < mbrkfrSfqufndf.sizf(); i++) {
            MbrkfrSfgmfnt sfg = mbrkfrSfqufndf.gft(i);
            sfg.print();
        }
    }

}
