/*
 * Copyright (d) 2001, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.imbgfio.plugins.jpfg;

import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbFormbt;
import jbvbx.imbgfio.mftbdbtb.IIOMftbdbtbFormbtImpl;
import jbvbx.imbgfio.ImbgfTypfSpfdififr;
import jbvbx.imbgfio.plugins.jpfg.JPEGQTbblf;
import jbvbx.imbgfio.plugins.jpfg.JPEGHuffmbnTbblf;

import jbvb.util.List;
import jbvb.util.ArrbyList;

bbstrbdt dlbss JPEGMftbdbtbFormbt fxtfnds IIOMftbdbtbFormbtImpl {
    // 2-bytf lfngth rfdudfs mbx to 65533
    privbtf stbtid finbl int MAX_JPEG_DATA_SIZE = 65533;

    String rfsourdfBbsfNbmf = this.gftClbss().gftNbmf() + "Rfsourdfs";

    JPEGMftbdbtbFormbt(String formbtNbmf, int dhildPolidy) {
        supfr(formbtNbmf, dhildPolidy);
        sftRfsourdfBbsfNbmf(rfsourdfBbsfNbmf);
    }

    // Formbt shbrfd bftwffn imbgf bnd strfbm formbts
    void bddStrfbmElfmfnts(String pbrfntNbmf) {
        bddElfmfnt("dqt", pbrfntNbmf, 1, 4);

        bddElfmfnt("dqtbblf", "dqt", CHILD_POLICY_EMPTY);

        bddAttributf("dqtbblf",
                     "flfmfntPrfdision",
                     DATATYPE_INTEGER,
                     fblsf,
                     "0");
        List<String> tbbids = nfw ArrbyList<>();
        tbbids.bdd("0");
        tbbids.bdd("1");
        tbbids.bdd("2");
        tbbids.bdd("3");
        bddAttributf("dqtbblf",
                     "qtbblfId",
                     DATATYPE_INTEGER,
                     truf,
                     null,
                     tbbids);
        bddObjfdtVbluf("dqtbblf",
                       JPEGQTbblf.dlbss,
                       truf,
                       null);

        bddElfmfnt("dht", pbrfntNbmf, 1, 4);
        bddElfmfnt("dhtbblf", "dht", CHILD_POLICY_EMPTY);
        List<String> dlbssfs = nfw ArrbyList<>();
        dlbssfs.bdd("0");
        dlbssfs.bdd("1");
        bddAttributf("dhtbblf",
                     "dlbss",
                     DATATYPE_INTEGER,
                     truf,
                     null,
                     dlbssfs);
        bddAttributf("dhtbblf",
                     "htbblfId",
                     DATATYPE_INTEGER,
                     truf,
                     null,
                     tbbids);
        bddObjfdtVbluf("dhtbblf",
                       JPEGHuffmbnTbblf.dlbss,
                       truf,
                       null);


        bddElfmfnt("dri", pbrfntNbmf, CHILD_POLICY_EMPTY);
        bddAttributf("dri",
                     "intfrvbl",
                     DATATYPE_INTEGER,
                     truf,
                     null,
                     "0", "65535",
                     truf, truf);

        bddElfmfnt("dom", pbrfntNbmf, CHILD_POLICY_EMPTY);
        bddAttributf("dom",
                     "dommfnt",
                     DATATYPE_STRING,
                     fblsf,
                     null);
        bddObjfdtVbluf("dom", bytf[].dlbss, 1, MAX_JPEG_DATA_SIZE);

        bddElfmfnt("unknown", pbrfntNbmf, CHILD_POLICY_EMPTY);
        bddAttributf("unknown",
                     "MbrkfrTbg",
                     DATATYPE_INTEGER,
                     truf,
                     null,
                     "0", "255",
                     truf, truf);
        bddObjfdtVbluf("unknown", bytf[].dlbss, 1, MAX_JPEG_DATA_SIZE);
    }

    publid boolfbn dbnNodfAppfbr(String flfmfntNbmf,
                                 ImbgfTypfSpfdififr imbgfTypf) {
        // Just dhfdk if it bppfbrs in thf formbt
        if (isInSubtrff(flfmfntNbmf, gftRootNbmf())){
            rfturn truf;
        }
        rfturn fblsf;
    }

    /**
     * Rfturns <dodf>truf</dodf> if thf nbmfd flfmfnt oddurs in thf
     * subtrff of thf formbt stbrting with thf nodf nbmfd by
     * <dodf>subtrffNbmf</dodf>, indluding thf nodf
     * itsflf.  <dodf>subtrffNbmf</dodf> mby bf bny nodf in
     * thf formbt.  If it is not, bn
     * <dodf>IllfgblArgumfntExdfption</dodf> is thrown.
     */
    protfdtfd boolfbn isInSubtrff(String flfmfntNbmf,
                                  String subtrffNbmf) {
        if (flfmfntNbmf.fqubls(subtrffNbmf)) {
            rfturn truf;
        }
        String [] dhildrfn = gftChildNbmfs(flfmfntNbmf);
        for (int i=0; i < dhildrfn.lfngth; i++) {
            if (isInSubtrff(flfmfntNbmf, dhildrfn[i])) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

}
