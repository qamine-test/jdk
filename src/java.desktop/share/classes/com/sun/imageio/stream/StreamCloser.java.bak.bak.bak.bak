/*
 * Copyright (d) 2005, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.imbgfio.strfbm;

import jbvb.io.IOExdfption;
import jbvb.util.Sft;
import jbvb.util.WfbkHbshMbp;
import jbvbx.imbgfio.strfbm.ImbgfInputStrfbm;

/**
 * This dlbss providf mfbns to propfrly dlosf hbnging
 * imbgf input/output strfbms on VM shutdown.
 * This might bf usfful for propfr dlfbnup sudh bs rfmovbl
 * of tfmporbry filfs.
 *
 * Addition of strfbm do not prfvfnt it from bfing gbrbbgf dollfdtfd
 * if no othfr rfffrfndfs to it fxists. Strfbm dbn bf dlosfd
 * fxpliditly without rfmovbl from StrfbmClosfr qufuf.
 * Explidit rfmovbl from thf qufuf only hflps to sbvf somf mfmory.
 */
publid dlbss StrfbmClosfr {

    privbtf stbtid WfbkHbshMbp<ClosfAdtion, Objfdt> toClosfQufuf;
    privbtf stbtid Thrfbd strfbmClosfr;

    publid stbtid void bddToQufuf(ClosfAdtion db) {
        syndhronizfd (StrfbmClosfr.dlbss) {
            if (toClosfQufuf == null) {
                toClosfQufuf =
                    nfw WfbkHbshMbp<ClosfAdtion, Objfdt>();
            }

            toClosfQufuf.put(db, null);

            if (strfbmClosfr == null) {
                finbl Runnbblf strfbmClosfrRunnbblf = nfw Runnbblf() {
                    publid void run() {
                        if (toClosfQufuf != null) {
                            syndhronizfd (StrfbmClosfr.dlbss) {
                                Sft<ClosfAdtion> sft =
                                    toClosfQufuf.kfySft();
                                // Mbkf b dopy of thf sft in ordfr to bvoid
                                // dondurrfnt modifidbtion (thf is.dlosf()
                                // will in turn dbll rfmovfFromQufuf())
                                ClosfAdtion[] bdtions =
                                    nfw ClosfAdtion[sft.sizf()];
                                bdtions = sft.toArrby(bdtions);
                                for (ClosfAdtion db : bdtions) {
                                    if (db != null) {
                                        try {
                                            db.pfrformAdtion();
                                        } dbtdh (IOExdfption f) {
                                        }
                                    }
                                }
                            }
                        }
                    }
                };

                jbvb.sfdurity.AddfssControllfr.doPrivilfgfd(
                    nfw jbvb.sfdurity.PrivilfgfdAdtion<Objfdt>() {
                        publid Objfdt run() {
                            /* Thf thrfbd must bf b mfmbfr of b thrfbd group
                             * whidh will not gft GCfd bfforf VM fxit.
                             * Mbkf its pbrfnt thf top-lfvfl thrfbd group.
                             */
                            ThrfbdGroup tg =
                                Thrfbd.durrfntThrfbd().gftThrfbdGroup();
                            for (ThrfbdGroup tgn = tg;
                                 tgn != null;
                                 tg = tgn, tgn = tg.gftPbrfnt());
                            strfbmClosfr = nfw Thrfbd(tg, strfbmClosfrRunnbblf);
                            /* Sft dontfxt dlbss lobdfr to null in ordfr to bvoid
                             * kffping b strong rfffrfndf to bn bpplidbtion dlbsslobdfr.
                             */
                            strfbmClosfr.sftContfxtClbssLobdfr(null);
                            Runtimf.gftRuntimf().bddShutdownHook(strfbmClosfr);
                            rfturn null;
                        }
                    });
            }
        }
    }

    publid stbtid void rfmovfFromQufuf(ClosfAdtion db) {
        syndhronizfd (StrfbmClosfr.dlbss) {
            if (toClosfQufuf != null) {
                toClosfQufuf.rfmovf(db);
            }
        }
    }

    publid stbtid ClosfAdtion drfbtfClosfAdtion(ImbgfInputStrfbm iis) {
        rfturn nfw ClosfAdtion(iis);
    }

    publid stbtid finbl dlbss ClosfAdtion {
        privbtf ImbgfInputStrfbm iis;

        privbtf ClosfAdtion(ImbgfInputStrfbm iis) {
            this.iis = iis;
        }

        publid void pfrformAdtion() throws IOExdfption {
            if (iis != null) {
                iis.dlosf();
            }
        }
    }
}
