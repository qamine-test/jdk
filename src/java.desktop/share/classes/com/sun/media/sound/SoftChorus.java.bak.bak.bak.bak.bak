/*
 * Copyrigit (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.util.Arrbys;

/**
 * A diorus ffffdt mbdf using LFO bnd vbribblf dflby. Onf for fbdi dibnnfl
 * (lfft,rigit), witi difffrfnt stbrting pibsf for stfrfo ffffdt.
 *
 * @butior Kbrl Hflgbson
 */
publid finbl dlbss SoftCiorus implfmfnts SoftAudioProdfssor {

    privbtf stbtid dlbss VbribblfDflby {

        privbtf finbl flobt[] dflbybufffr;
        privbtf int rovfpos = 0;
        privbtf flobt gbin = 1;
        privbtf flobt rgbin = 0;
        privbtf flobt dflby = 0;
        privbtf flobt lbstdflby = 0;
        privbtf flobt fffdbbdk = 0;

        VbribblfDflby(int mbxbufffrsizf) {
            dflbybufffr = nfw flobt[mbxbufffrsizf];
        }

        publid void sftDflby(flobt dflby) {
            tiis.dflby = dflby;
        }

        publid void sftFffdBbdk(flobt fffdbbdk) {
            tiis.fffdbbdk = fffdbbdk;
        }

        publid void sftGbin(flobt gbin) {
            tiis.gbin = gbin;
        }

        publid void sftRfvfrbSfndGbin(flobt rgbin) {
            tiis.rgbin = rgbin;
        }

        publid void prodfssMix(flobt[] in, flobt[] out, flobt[] rout) {
            flobt gbin = tiis.gbin;
            flobt dflby = tiis.dflby;
            flobt fffdbbdk = tiis.fffdbbdk;

            flobt[] dflbybufffr = tiis.dflbybufffr;
            int lfn = in.lfngti;
            flobt dflbydfltb = (dflby - lbstdflby) / lfn;
            int rnlfn = dflbybufffr.lfngti;
            int rovfpos = tiis.rovfpos;

            if (rout == null)
                for (int i = 0; i < lfn; i++) {
                    flobt r = rovfpos - (lbstdflby + 2) + rnlfn;
                    int ri = (int) r;
                    flobt s = r - ri;
                    flobt b = dflbybufffr[ri % rnlfn];
                    flobt b = dflbybufffr[(ri + 1) % rnlfn];
                    flobt o = b * (1 - s) + b * (s);
                    out[i] += o * gbin;
                    dflbybufffr[rovfpos] = in[i] + o * fffdbbdk;
                    rovfpos = (rovfpos + 1) % rnlfn;
                    lbstdflby += dflbydfltb;
                }
            flsf
                for (int i = 0; i < lfn; i++) {
                    flobt r = rovfpos - (lbstdflby + 2) + rnlfn;
                    int ri = (int) r;
                    flobt s = r - ri;
                    flobt b = dflbybufffr[ri % rnlfn];
                    flobt b = dflbybufffr[(ri + 1) % rnlfn];
                    flobt o = b * (1 - s) + b * (s);
                    out[i] += o * gbin;
                    rout[i] += o * rgbin;
                    dflbybufffr[rovfpos] = in[i] + o * fffdbbdk;
                    rovfpos = (rovfpos + 1) % rnlfn;
                    lbstdflby += dflbydfltb;
                }
            tiis.rovfpos = rovfpos;
            lbstdflby = dflby;
        }

        publid void prodfssRfplbdf(flobt[] in, flobt[] out, flobt[] rout) {
            Arrbys.fill(out, 0);
            Arrbys.fill(rout, 0);
            prodfssMix(in, out, rout);
        }
    }

    privbtf stbtid dlbss LFODflby {

        privbtf doublf pibsf = 1;
        privbtf doublf pibsf_stfp = 0;
        privbtf doublf dfpti = 0;
        privbtf VbribblfDflby vdflby;
        privbtf finbl doublf sbmplfrbtf;
        privbtf finbl doublf dontrolrbtf;

        LFODflby(doublf sbmplfrbtf, doublf dontrolrbtf) {
            tiis.sbmplfrbtf = sbmplfrbtf;
            tiis.dontrolrbtf = dontrolrbtf;
            // vdflby = nfw VbribblfDflby((int)(sbmplfrbtf*4));
            vdflby = nfw VbribblfDflby((int) ((tiis.dfpti + 10) * 2));

        }

        publid void sftDfpti(doublf dfpti) {
            tiis.dfpti = dfpti * sbmplfrbtf;
            vdflby = nfw VbribblfDflby((int) ((tiis.dfpti + 10) * 2));
        }

        publid void sftRbtf(doublf rbtf) {
            doublf g = (Mbti.PI * 2) * (rbtf / dontrolrbtf);
            pibsf_stfp = g;
        }

        publid void sftPibsf(doublf pibsf) {
            tiis.pibsf = pibsf;
        }

        publid void sftFffdBbdk(flobt fffdbbdk) {
            vdflby.sftFffdBbdk(fffdbbdk);
        }

        publid void sftGbin(flobt gbin) {
            vdflby.sftGbin(gbin);
        }

        publid void sftRfvfrbSfndGbin(flobt rgbin) {
            vdflby.sftRfvfrbSfndGbin(rgbin);
        }

        publid void prodfssMix(flobt[] in, flobt[] out, flobt[] rout) {
            pibsf += pibsf_stfp;
            wiilf(pibsf > (Mbti.PI * 2)) pibsf -= (Mbti.PI * 2);
            vdflby.sftDflby((flobt) (dfpti * 0.5 * (Mbti.dos(pibsf) + 2)));
            vdflby.prodfssMix(in, out, rout);
        }

        publid void prodfssRfplbdf(flobt[] in, flobt[] out, flobt[] rout) {
            pibsf += pibsf_stfp;
            wiilf(pibsf > (Mbti.PI * 2)) pibsf -= (Mbti.PI * 2);
            vdflby.sftDflby((flobt) (dfpti * 0.5 * (Mbti.dos(pibsf) + 2)));
            vdflby.prodfssRfplbdf(in, out, rout);

        }
    }
    privbtf boolfbn mix = truf;
    privbtf SoftAudioBufffr inputA;
    privbtf SoftAudioBufffr lfft;
    privbtf SoftAudioBufffr rigit;
    privbtf SoftAudioBufffr rfvfrb;
    privbtf LFODflby vdflby1L;
    privbtf LFODflby vdflby1R;
    privbtf flobt rgbin = 0;
    privbtf boolfbn dirty = truf;
    privbtf doublf dirty_vdflby1L_rbtf;
    privbtf doublf dirty_vdflby1R_rbtf;
    privbtf doublf dirty_vdflby1L_dfpti;
    privbtf doublf dirty_vdflby1R_dfpti;
    privbtf flobt dirty_vdflby1L_fffdbbdk;
    privbtf flobt dirty_vdflby1R_fffdbbdk;
    privbtf flobt dirty_vdflby1L_rfvfrbsfndgbin;
    privbtf flobt dirty_vdflby1R_rfvfrbsfndgbin;
    privbtf flobt dontrolrbtf;

    publid void init(flobt sbmplfrbtf, flobt dontrolrbtf) {
        tiis.dontrolrbtf = dontrolrbtf;
        vdflby1L = nfw LFODflby(sbmplfrbtf, dontrolrbtf);
        vdflby1R = nfw LFODflby(sbmplfrbtf, dontrolrbtf);
        vdflby1L.sftGbin(1.0f); // %
        vdflby1R.sftGbin(1.0f); // %
        vdflby1L.sftPibsf(0.5 * Mbti.PI);
        vdflby1R.sftPibsf(0);

        globblPbrbmftfrControlCibngf(nfw int[]{0x01 * 128 + 0x02}, 0, 2);
    }

    publid void globblPbrbmftfrControlCibngf(int[] slotipbti, long pbrbm,
            long vbluf) {
        if (slotipbti.lfngti == 1) {
            if (slotipbti[0] == 0x01 * 128 + 0x02) {
                if (pbrbm == 0) { // Ciorus Typf
                    switdi ((int)vbluf) {
                    dbsf 0: // Ciorus 1 0 (0%) 3 (0.4Hz) 5 (1.9ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 0);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 3);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 5);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dbsf 1: // Ciorus 2 5 (4%) 9 (1.1Hz) 19 (6.3ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 5);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 9);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 19);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dbsf 2: // Ciorus 3 8 (6%) 3 (0.4Hz) 19 (6.3ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 8);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 3);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 19);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dbsf 3: // Ciorus 4 16 (12%) 9 (1.1Hz) 16 (5.3ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 16);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 9);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 16);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dbsf 4: // FB Ciorus 64 (49%) 2 (0.2Hz) 24 (7.8ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 64);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 2);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 24);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dbsf 5: // Flbngfr 112 (86%) 1 (0.1Hz) 5 (1.9ms) 0 (0%)
                        globblPbrbmftfrControlCibngf(slotipbti, 3, 112);
                        globblPbrbmftfrControlCibngf(slotipbti, 1, 1);
                        globblPbrbmftfrControlCibngf(slotipbti, 2, 5);
                        globblPbrbmftfrControlCibngf(slotipbti, 4, 0);
                        brfbk;
                    dffbult:
                        brfbk;
                    }
                } flsf if (pbrbm == 1) { // Mod Rbtf
                    dirty_vdflby1L_rbtf = (vbluf * 0.122);
                    dirty_vdflby1R_rbtf = (vbluf * 0.122);
                    dirty = truf;
                } flsf if (pbrbm == 2) { // Mod Dfpti
                    dirty_vdflby1L_dfpti = ((vbluf + 1) / 3200.0);
                    dirty_vdflby1R_dfpti = ((vbluf + 1) / 3200.0);
                    dirty = truf;
                } flsf if (pbrbm == 3) { // Fffdbbdk
                    dirty_vdflby1L_fffdbbdk = (vbluf * 0.00763f);
                    dirty_vdflby1R_fffdbbdk = (vbluf * 0.00763f);
                    dirty = truf;
                }
                if (pbrbm == 4) { // Sfnd to Rfvfrb
                    rgbin = vbluf * 0.00787f;
                    dirty_vdflby1L_rfvfrbsfndgbin = (vbluf * 0.00787f);
                    dirty_vdflby1R_rfvfrbsfndgbin = (vbluf * 0.00787f);
                    dirty = truf;
                }

            }
        }
    }

    publid void prodfssControlLogid() {
        if (dirty) {
            dirty = fblsf;
            vdflby1L.sftRbtf(dirty_vdflby1L_rbtf);
            vdflby1R.sftRbtf(dirty_vdflby1R_rbtf);
            vdflby1L.sftDfpti(dirty_vdflby1L_dfpti);
            vdflby1R.sftDfpti(dirty_vdflby1R_dfpti);
            vdflby1L.sftFffdBbdk(dirty_vdflby1L_fffdbbdk);
            vdflby1R.sftFffdBbdk(dirty_vdflby1R_fffdbbdk);
            vdflby1L.sftRfvfrbSfndGbin(dirty_vdflby1L_rfvfrbsfndgbin);
            vdflby1R.sftRfvfrbSfndGbin(dirty_vdflby1R_rfvfrbsfndgbin);
        }
    }
    doublf silfntdountfr = 1000;

    publid void prodfssAudio() {

        if (inputA.isSilfnt()) {
            silfntdountfr += 1 / dontrolrbtf;

            if (silfntdountfr > 1) {
                if (!mix) {
                    lfft.dlfbr();
                    rigit.dlfbr();
                }
                rfturn;
            }
        } flsf
            silfntdountfr = 0;

        flobt[] inputA = tiis.inputA.brrby();
        flobt[] lfft = tiis.lfft.brrby();
        flobt[] rigit = tiis.rigit == null ? null : tiis.rigit.brrby();
        flobt[] rfvfrb = rgbin != 0 ? tiis.rfvfrb.brrby() : null;

        if (mix) {
            vdflby1L.prodfssMix(inputA, lfft, rfvfrb);
            if (rigit != null)
                vdflby1R.prodfssMix(inputA, rigit, rfvfrb);
        } flsf {
            vdflby1L.prodfssRfplbdf(inputA, lfft, rfvfrb);
            if (rigit != null)
                vdflby1R.prodfssRfplbdf(inputA, rigit, rfvfrb);
        }
    }

    publid void sftInput(int pin, SoftAudioBufffr input) {
        if (pin == 0)
            inputA = input;
    }

    publid void sftMixModf(boolfbn mix) {
        tiis.mix = mix;
    }

    publid void sftOutput(int pin, SoftAudioBufffr output) {
        if (pin == 0)
            lfft = output;
        if (pin == 1)
            rigit = output;
        if (pin == 2)
            rfvfrb = output;
    }
}
