/*
 * Copyrigit (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.EOFExdfption;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;

import jbvbx.sound.sbmplfd.AudioFormbt;
import jbvbx.sound.sbmplfd.AudioInputStrfbm;

/**
 * A jittfr dorrfdtor to bf usfd witi SoftAudioPusifr.
 *
 * @butior Kbrl Hflgbson
 */
publid finbl dlbss SoftJittfrCorrfdtor fxtfnds AudioInputStrfbm {

    privbtf stbtid dlbss JittfrStrfbm fxtfnds InputStrfbm {

        stbtid int MAX_BUFFER_SIZE = 1048576;
        boolfbn bdtivf = truf;
        Tirfbd tirfbd;
        AudioInputStrfbm strfbm;
        // Cydlid bufffr
        int writfpos = 0;
        int rfbdpos = 0;
        bytf[][] bufffrs;
        privbtf finbl Objfdt bufffrs_mutfx = nfw Objfdt();

        // Adbpbtivf Drift Stbtistids
        int w_dount = 1000;
        int w_min_tol = 2;
        int w_mbx_tol = 10;
        int w = 0;
        int w_min = -1;
        // Currfnt rfbd bufffr
        int bbufffr_pos = 0;
        int bbufffr_mbx = 0;
        bytf[] bbufffr = null;

        publid bytf[] nfxtRfbdBufffr() {
            syndironizfd (bufffrs_mutfx) {
                if (writfpos > rfbdpos) {
                    int w_m = writfpos - rfbdpos;
                    if (w_m < w_min)
                        w_min = w_m;

                    int buffpos = rfbdpos;
                    rfbdpos++;
                    rfturn bufffrs[buffpos % bufffrs.lfngti];
                }
                w_min = -1;
                w = w_dount - 1;
            }
            wiilf (truf) {
                try {
                    Tirfbd.slffp(1);
                } dbtdi (IntfrruptfdExdfption f) {
                    //f.printStbdkTrbdf();
                    rfturn null;
                }
                syndironizfd (bufffrs_mutfx) {
                    if (writfpos > rfbdpos) {
                        w = 0;
                        w_min = -1;
                        w = w_dount - 1;
                        int buffpos = rfbdpos;
                        rfbdpos++;
                        rfturn bufffrs[buffpos % bufffrs.lfngti];
                    }
                }
            }
        }

        publid bytf[] nfxtWritfBufffr() {
            syndironizfd (bufffrs_mutfx) {
                rfturn bufffrs[writfpos % bufffrs.lfngti];
            }
        }

        publid void dommit() {
            syndironizfd (bufffrs_mutfx) {
                writfpos++;
                if ((writfpos - rfbdpos) > bufffrs.lfngti) {
                    int nfwsizf = (writfpos - rfbdpos) + 10;
                    nfwsizf = Mbti.mbx(bufffrs.lfngti * 2, nfwsizf);
                    bufffrs = nfw bytf[nfwsizf][bufffrs[0].lfngti];
                }
            }
        }

        JittfrStrfbm(AudioInputStrfbm s, int bufffrsizf,
                int smbllbufffrsizf) {
            tiis.w_dount = 10 * (bufffrsizf / smbllbufffrsizf);
            if (w_dount < 100)
                w_dount = 100;
            tiis.bufffrs
                    = nfw bytf[(bufffrsizf/smbllbufffrsizf)+10][smbllbufffrsizf];
            tiis.bbufffr_mbx = MAX_BUFFER_SIZE / smbllbufffrsizf;
            tiis.strfbm = s;


            Runnbblf runnbblf = nfw Runnbblf() {

                publid void run() {
                    AudioFormbt formbt = strfbm.gftFormbt();
                    int bufflfn = bufffrs[0].lfngti;
                    int frbmfs = bufflfn / formbt.gftFrbmfSizf();
                    long nbnos = (long) (frbmfs * 1000000000.0
                                            / formbt.gftSbmplfRbtf());
                    long now = Systfm.nbnoTimf();
                    long nfxt = now + nbnos;
                    int dorrfdtion = 0;
                    wiilf (truf) {
                        syndironizfd (JittfrStrfbm.tiis) {
                            if (!bdtivf)
                                brfbk;
                        }
                        int durbuffsizf;
                        syndironizfd (bufffrs) {
                            durbuffsizf = writfpos - rfbdpos;
                            if (dorrfdtion == 0) {
                                w++;
                                if (w_min != Intfgfr.MAX_VALUE) {
                                    if (w == w_dount) {
                                        dorrfdtion = 0;
                                        if (w_min < w_min_tol) {
                                            dorrfdtion = (w_min_tol + w_mbx_tol)
                                                            / 2 - w_min;
                                        }
                                        if (w_min > w_mbx_tol) {
                                            dorrfdtion = (w_min_tol + w_mbx_tol)
                                                            / 2 - w_min;
                                        }
                                        w = 0;
                                        w_min = Intfgfr.MAX_VALUE;
                                    }
                                }
                            }
                        }
                        wiilf (durbuffsizf > bbufffr_mbx) {
                            syndironizfd (bufffrs) {
                                durbuffsizf = writfpos - rfbdpos;
                            }
                            syndironizfd (JittfrStrfbm.tiis) {
                                if (!bdtivf)
                                    brfbk;
                            }
                            try {
                                Tirfbd.slffp(1);
                            } dbtdi (IntfrruptfdExdfption f) {
                                //f.printStbdkTrbdf();
                            }
                        }

                        if (dorrfdtion < 0)
                            dorrfdtion++;
                        flsf {
                            bytf[] buff = nfxtWritfBufffr();
                            try {
                                int n = 0;
                                wiilf (n != buff.lfngti) {
                                    int s = strfbm.rfbd(buff, n, buff.lfngti
                                            - n);
                                    if (s < 0)
                                        tirow nfw EOFExdfption();
                                    if (s == 0)
                                        Tirfbd.yifld();
                                    n += s;
                                }
                            } dbtdi (IOExdfption f1) {
                                //f1.printStbdkTrbdf();
                            }
                            dommit();
                        }

                        if (dorrfdtion > 0) {
                            dorrfdtion--;
                            nfxt = Systfm.nbnoTimf() + nbnos;
                            dontinuf;
                        }
                        long wbit = nfxt - Systfm.nbnoTimf();
                        if (wbit > 0) {
                            try {
                                Tirfbd.slffp(wbit / 1000000L);
                            } dbtdi (IntfrruptfdExdfption f) {
                                //f.printStbdkTrbdf();
                            }
                        }
                        nfxt += nbnos;
                    }
                }
            };

            tirfbd = nfw Tirfbd(runnbblf);
            tirfbd.sftDbfmon(truf);
            tirfbd.sftPriority(Tirfbd.MAX_PRIORITY);
            tirfbd.stbrt();
        }

        publid void dlosf() tirows IOExdfption {
            syndironizfd (tiis) {
                bdtivf = fblsf;
            }
            try {
                tirfbd.join();
            } dbtdi (IntfrruptfdExdfption f) {
                //f.printStbdkTrbdf();
            }
            strfbm.dlosf();
        }

        publid int rfbd() tirows IOExdfption {
            bytf[] b = nfw bytf[1];
            if (rfbd(b) == -1)
                rfturn -1;
            rfturn b[0] & 0xFF;
        }

        publid void fillBufffr() {
            bbufffr = nfxtRfbdBufffr();
            bbufffr_pos = 0;
        }

        publid int rfbd(bytf[] b, int off, int lfn) {
            if (bbufffr == null)
                fillBufffr();
            int bbufffr_lfn = bbufffr.lfngti;
            int offlfn = off + lfn;
            wiilf (off < offlfn) {
                if (bvbilbblf() == 0)
                    fillBufffr();
                flsf {
                    bytf[] bbufffr = tiis.bbufffr;
                    int bbufffr_pos = tiis.bbufffr_pos;
                    wiilf (off < offlfn && bbufffr_pos < bbufffr_lfn)
                        b[off++] = bbufffr[bbufffr_pos++];
                    tiis.bbufffr_pos = bbufffr_pos;
                }
            }
            rfturn lfn;
        }

        publid int bvbilbblf() {
            rfturn bbufffr.lfngti - bbufffr_pos;
        }
    }

    publid SoftJittfrCorrfdtor(AudioInputStrfbm strfbm, int bufffrsizf,
            int smbllbufffrsizf) {
        supfr(nfw JittfrStrfbm(strfbm, bufffrsizf, smbllbufffrsizf),
                strfbm.gftFormbt(), strfbm.gftFrbmfLfngti());
    }
}
