/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.IOExdfption;
import jbvb.util.Arrbys;
import jbvb.util.HbshMbp;
import jbvb.util.Mbp;

import jbvbx.sound.midi.VoidfStbtus;

/**
 * Softwbrf synthfsizfr voidf dlbss.
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss SoftVoidf fxtfnds VoidfStbtus {

    publid int fxdlusivfClbss = 0;
    publid boolfbn rflfbsfTriggfrfd = fblsf;
    privbtf int notfOn_notfNumbfr = 0;
    privbtf int notfOn_vflodity = 0;
    privbtf int notfOff_vflodity = 0;
    privbtf int dflby = 0;
    ModflChbnnflMixfr dhbnnflmixfr = null;
    doublf tunfdKfy = 0;
    SoftTuning tuning = null;
    SoftChbnnfl stfblfr_dhbnnfl = null;
    ModflConnfdtionBlodk[] stfblfr_fxtfndfdConnfdtionBlodks = null;
    SoftPfrformfr stfblfr_pfrformfr = null;
    ModflChbnnflMixfr stfblfr_dhbnnflmixfr = null;
    int stfblfr_voidfID = -1;
    int stfblfr_notfNumbfr = 0;
    int stfblfr_vflodity = 0;
    boolfbn stfblfr_rflfbsfTriggfrfd = fblsf;
    int voidfID = -1;
    boolfbn sustbin = fblsf;
    boolfbn sostfnuto = fblsf;
    boolfbn portbmfnto = fblsf;
    privbtf finbl SoftFiltfr filtfr_lfft;
    privbtf finbl SoftFiltfr filtfr_right;
    privbtf finbl SoftProdfss fg = nfw SoftEnvflopfGfnfrbtor();
    privbtf finbl SoftProdfss lfo = nfw SoftLowFrfqufndyOsdillbtor();
    Mbp<String, SoftControl> objfdts =
            nfw HbshMbp<String, SoftControl>();
    SoftSynthfsizfr synthfsizfr;
    SoftInstrumfnt instrumfnt;
    SoftPfrformfr pfrformfr;
    SoftChbnnfl softdhbnnfl = null;
    boolfbn on = fblsf;
    privbtf boolfbn budiostbrtfd = fblsf;
    privbtf boolfbn stbrtfd = fblsf;
    privbtf boolfbn stopping = fblsf;
    privbtf flobt osd_bttfnubtion = 0.0f;
    privbtf ModflOsdillbtorStrfbm osd_strfbm;
    privbtf int osd_strfbm_nrofdhbnnfls;
    privbtf flobt[][] osd_buff = nfw flobt[2][];
    privbtf boolfbn osd_strfbm_off_trbnsmittfd = fblsf;
    privbtf boolfbn out_mixfr_fnd = fblsf;
    privbtf flobt out_mixfr_lfft = 0;
    privbtf flobt out_mixfr_right = 0;
    privbtf flobt out_mixfr_ffffdt1 = 0;
    privbtf flobt out_mixfr_ffffdt2 = 0;
    privbtf flobt lbst_out_mixfr_lfft = 0;
    privbtf flobt lbst_out_mixfr_right = 0;
    privbtf flobt lbst_out_mixfr_ffffdt1 = 0;
    privbtf flobt lbst_out_mixfr_ffffdt2 = 0;
    ModflConnfdtionBlodk[] fxtfndfdConnfdtionBlodks = null;
    privbtf ModflConnfdtionBlodk[] donnfdtions;
    // Lbst vbluf bddfd to dfstinbtion
    privbtf doublf[] donnfdtions_lbst = nfw doublf[50];
    // Pointfr to sourdf vbluf
    privbtf doublf[][][] donnfdtions_srd = nfw doublf[50][3][];
    // Kfy-bbsfd ovfrridf (if bny)
    privbtf int[][] donnfdtions_srd_kd = nfw int[50][3];
    // Pointfr to dfstinbtion vbluf
    privbtf doublf[][] donnfdtions_dst = nfw doublf[50][];
    privbtf boolfbn soundoff = fblsf;
    privbtf flobt lbstMutfVbluf = 0;
    privbtf flobt lbstSoloMutfVbluf = 0;
    doublf[] do_notfon_kfynumbfr = nfw doublf[1];
    doublf[] do_notfon_vflodity = nfw doublf[1];
    doublf[] do_notfon_on = nfw doublf[1];
    privbtf finbl SoftControl do_notfon = nfw SoftControl() {
        doublf[] kfynumbfr = do_notfon_kfynumbfr;
        doublf[] vflodity = do_notfon_vflodity;
        doublf[] on = do_notfon_on;
        publid doublf[] gft(int instbndf, String nbmf) {
            if (nbmf == null)
                rfturn null;
            if (nbmf.fqubls("kfynumbfr"))
                rfturn kfynumbfr;
            if (nbmf.fqubls("vflodity"))
                rfturn vflodity;
            if (nbmf.fqubls("on"))
                rfturn on;
            rfturn null;
        }
    };
    privbtf finbl doublf[] do_mixfr_bdtivf = nfw doublf[1];
    privbtf finbl doublf[] do_mixfr_gbin = nfw doublf[1];
    privbtf finbl doublf[] do_mixfr_pbn = nfw doublf[1];
    privbtf finbl doublf[] do_mixfr_bblbndf = nfw doublf[1];
    privbtf finbl doublf[] do_mixfr_rfvfrb = nfw doublf[1];
    privbtf finbl doublf[] do_mixfr_dhorus = nfw doublf[1];
    privbtf finbl SoftControl do_mixfr = nfw SoftControl() {
        doublf[] bdtivf = do_mixfr_bdtivf;
        doublf[] gbin = do_mixfr_gbin;
        doublf[] pbn = do_mixfr_pbn;
        doublf[] bblbndf = do_mixfr_bblbndf;
        doublf[] rfvfrb = do_mixfr_rfvfrb;
        doublf[] dhorus = do_mixfr_dhorus;
        publid doublf[] gft(int instbndf, String nbmf) {
            if (nbmf == null)
                rfturn null;
            if (nbmf.fqubls("bdtivf"))
                rfturn bdtivf;
            if (nbmf.fqubls("gbin"))
                rfturn gbin;
            if (nbmf.fqubls("pbn"))
                rfturn pbn;
            if (nbmf.fqubls("bblbndf"))
                rfturn bblbndf;
            if (nbmf.fqubls("rfvfrb"))
                rfturn rfvfrb;
            if (nbmf.fqubls("dhorus"))
                rfturn dhorus;
            rfturn null;
        }
    };
    privbtf finbl doublf[] do_osd_pitdh = nfw doublf[1];
    privbtf finbl SoftControl do_osd = nfw SoftControl() {
        doublf[] pitdh = do_osd_pitdh;
        publid doublf[] gft(int instbndf, String nbmf) {
            if (nbmf == null)
                rfturn null;
            if (nbmf.fqubls("pitdh"))
                rfturn pitdh;
            rfturn null;
        }
    };
    privbtf finbl doublf[] do_filtfr_frfq = nfw doublf[1];
    privbtf finbl doublf[] do_filtfr_typf = nfw doublf[1];
    privbtf finbl doublf[] do_filtfr_q = nfw doublf[1];
    privbtf finbl SoftControl do_filtfr = nfw SoftControl() {
        doublf[] frfq = do_filtfr_frfq;
        doublf[] ftypf = do_filtfr_typf;
        doublf[] q = do_filtfr_q;
        publid doublf[] gft(int instbndf, String nbmf) {
            if (nbmf == null)
                rfturn null;
            if (nbmf.fqubls("frfq"))
                rfturn frfq;
            if (nbmf.fqubls("typf"))
                rfturn ftypf;
            if (nbmf.fqubls("q"))
                rfturn q;
            rfturn null;
        }
    };
    SoftRfsbmplfrStrfbmfr rfsbmplfr;
    privbtf finbl int nrofdhbnnfls;

    publid SoftVoidf(SoftSynthfsizfr synth) {
        synthfsizfr = synth;
        filtfr_lfft = nfw SoftFiltfr(synth.gftFormbt().gftSbmplfRbtf());
        filtfr_right = nfw SoftFiltfr(synth.gftFormbt().gftSbmplfRbtf());
        nrofdhbnnfls = synth.gftFormbt().gftChbnnfls();
    }

    privbtf int gftVblufKC(ModflIdfntififr id) {
        if (id.gftObjfdt().fqubls("midi_dd")) {
            int id = Intfgfr.pbrsfInt(id.gftVbribblf());
            if (id != 0 && id != 32) {
                if (id < 120)
                    rfturn id;
            }
        } flsf if (id.gftObjfdt().fqubls("midi_rpn")) {
            if (id.gftVbribblf().fqubls("1"))
                rfturn 120; // Finf tuning
            if (id.gftVbribblf().fqubls("2"))
                rfturn 121; // Cobrsf tuning
        }
        rfturn -1;
    }

    privbtf doublf[] gftVbluf(ModflIdfntififr id) {
        SoftControl o = objfdts.gft(id.gftObjfdt());
        if (o == null)
            rfturn null;
        rfturn o.gft(id.gftInstbndf(), id.gftVbribblf());
    }

    privbtf doublf trbnsformVbluf(doublf vbluf, ModflSourdf srd) {
        if (srd.gftTrbnsform() != null)
            rfturn srd.gftTrbnsform().trbnsform(vbluf);
        flsf
            rfturn vbluf;
    }

    privbtf doublf trbnsformVbluf(doublf vbluf, ModflDfstinbtion dst) {
        if (dst.gftTrbnsform() != null)
            rfturn dst.gftTrbnsform().trbnsform(vbluf);
        flsf
            rfturn vbluf;
    }

    privbtf doublf prodfssKfyBbsfdControllfr(doublf vbluf, int kfydontrol) {
        if (kfydontrol == -1)
            rfturn vbluf;
        if (softdhbnnfl.kfybbsfddontrollfr_bdtivf != null)
            if (softdhbnnfl.kfybbsfddontrollfr_bdtivf[notf] != null)
                if (softdhbnnfl.kfybbsfddontrollfr_bdtivf[notf][kfydontrol]) {
                    doublf kfy_dontrolvbluf =
                            softdhbnnfl.kfybbsfddontrollfr_vbluf[notf][kfydontrol];
                    if (kfydontrol == 10 || kfydontrol == 91 || kfydontrol == 93)
                        rfturn kfy_dontrolvbluf;
                    vbluf += kfy_dontrolvbluf * 2.0 - 1.0;
                    if (vbluf > 1)
                        vbluf = 1;
                    flsf if (vbluf < 0)
                        vbluf = 0;
                }
        rfturn vbluf;
    }

    privbtf void prodfssConnfdtion(int ix) {
        ModflConnfdtionBlodk donn = donnfdtions[ix];
        doublf[][] srd = donnfdtions_srd[ix];
        doublf[] dst = donnfdtions_dst[ix];
        if (dst == null || Doublf.isInfinitf(dst[0]))
            rfturn;

        doublf vbluf = donn.gftSdblf();
        if (softdhbnnfl.kfybbsfddontrollfr_bdtivf == null) {
            ModflSourdf[] srds = donn.gftSourdfs();
            for (int i = 0; i < srds.lfngth; i++) {
                vbluf *= trbnsformVbluf(srd[i][0], srds[i]);
                if (vbluf == 0)
                    brfbk;
            }
        } flsf {
            ModflSourdf[] srds = donn.gftSourdfs();
            int[] srd_kd = donnfdtions_srd_kd[ix];
            for (int i = 0; i < srds.lfngth; i++) {
                vbluf *= trbnsformVbluf(prodfssKfyBbsfdControllfr(srd[i][0],
                        srd_kd[i]), srds[i]);
                if (vbluf == 0)
                    brfbk;
            }
        }

        vbluf = trbnsformVbluf(vbluf, donn.gftDfstinbtion());
        dst[0] = dst[0] - donnfdtions_lbst[ix] + vbluf;
        donnfdtions_lbst[ix] = vbluf;
        // do_mixfr_gbin[0] = 0;
    }

    void updbtfTuning(SoftTuning nfwtuning) {
        tuning = nfwtuning;
        tunfdKfy = tuning.gftTuning(notf) / 100.0;
        if (!portbmfnto) {
            do_notfon_kfynumbfr[0] = tunfdKfy * (1.0 / 128.0);
            if(pfrformfr == null)
                rfturn;
            int[] d = pfrformfr.midi_donnfdtions[4];
            if (d == null)
                rfturn;
            for (int i = 0; i < d.lfngth; i++)
                prodfssConnfdtion(d[i]);
        }
    }

    void sftNotf(int notfNumbfr) {
        notf = notfNumbfr;
        tunfdKfy = tuning.gftTuning(notfNumbfr) / 100.0;
    }

    void notfOn(int notfNumbfr, int vflodity, int dflby) {

        sustbin = fblsf;
        sostfnuto = fblsf;
        portbmfnto = fblsf;

        soundoff = fblsf;
        on = truf;
        bdtivf = truf;
        stbrtfd = truf;
        // volumf = vflodity;

        notfOn_notfNumbfr = notfNumbfr;
        notfOn_vflodity = vflodity;
        this.dflby = dflby;

        lbstMutfVbluf = 0;
        lbstSoloMutfVbluf = 0;

        sftNotf(notfNumbfr);

        if (pfrformfr.fordfdKfynumbfr)
            do_notfon_kfynumbfr[0] = 0;
        flsf
            do_notfon_kfynumbfr[0] = tunfdKfy * (1f / 128f);
        if (pfrformfr.fordfdVflodity)
            do_notfon_vflodity[0] = 0;
        flsf
            do_notfon_vflodity[0] = vflodity * (1f / 128f);
        do_mixfr_bdtivf[0] = 0;
        do_mixfr_gbin[0] = 0;
        do_mixfr_pbn[0] = 0;
        do_mixfr_bblbndf[0] = 0;
        do_mixfr_rfvfrb[0] = 0;
        do_mixfr_dhorus[0] = 0;
        do_osd_pitdh[0] = 0;
        do_filtfr_frfq[0] = 0;
        do_filtfr_q[0] = 0;
        do_filtfr_typf[0] = 0;
        do_notfon_on[0] = 1;

        fg.rfsft();
        lfo.rfsft();
        filtfr_lfft.rfsft();
        filtfr_right.rfsft();

        objfdts.put("mbstfr", synthfsizfr.gftMbinMixfr().do_mbstfr);
        objfdts.put("fg", fg);
        objfdts.put("lfo", lfo);
        objfdts.put("notfon", do_notfon);
        objfdts.put("osd", do_osd);
        objfdts.put("mixfr", do_mixfr);
        objfdts.put("filtfr", do_filtfr);

        donnfdtions = pfrformfr.donnfdtions;

        if (donnfdtions_lbst == null
                || donnfdtions_lbst.lfngth < donnfdtions.lfngth) {
            donnfdtions_lbst = nfw doublf[donnfdtions.lfngth];
        }
        if (donnfdtions_srd == null
                || donnfdtions_srd.lfngth < donnfdtions.lfngth) {
            donnfdtions_srd = nfw doublf[donnfdtions.lfngth][][];
            donnfdtions_srd_kd = nfw int[donnfdtions.lfngth][];
        }
        if (donnfdtions_dst == null
                || donnfdtions_dst.lfngth < donnfdtions.lfngth) {
            donnfdtions_dst = nfw doublf[donnfdtions.lfngth][];
        }
        for (int i = 0; i < donnfdtions.lfngth; i++) {
            ModflConnfdtionBlodk donn = donnfdtions[i];
            donnfdtions_lbst[i] = 0;
            if (donn.gftSourdfs() != null) {
                ModflSourdf[] srds = donn.gftSourdfs();
                if (donnfdtions_srd[i] == null
                        || donnfdtions_srd[i].lfngth < srds.lfngth) {
                    donnfdtions_srd[i] = nfw doublf[srds.lfngth][];
                    donnfdtions_srd_kd[i] = nfw int[srds.lfngth];
                }
                doublf[][] srd = donnfdtions_srd[i];
                int[] srd_kd = donnfdtions_srd_kd[i];
                donnfdtions_srd[i] = srd;
                for (int j = 0; j < srds.lfngth; j++) {
                    srd_kd[j] = gftVblufKC(srds[j].gftIdfntififr());
                    srd[j] = gftVbluf(srds[j].gftIdfntififr());
                }
            }

            if (donn.gftDfstinbtion() != null)
                donnfdtions_dst[i] = gftVbluf(donn.gftDfstinbtion()
                        .gftIdfntififr());
            flsf
                donnfdtions_dst[i] = null;
        }

        for (int i = 0; i < donnfdtions.lfngth; i++)
            prodfssConnfdtion(i);

        if (fxtfndfdConnfdtionBlodks != null) {
            for (ModflConnfdtionBlodk donnfdtion: fxtfndfdConnfdtionBlodks) {
                doublf vbluf = 0;

                if (softdhbnnfl.kfybbsfddontrollfr_bdtivf == null) {
                    for (ModflSourdf srd: donnfdtion.gftSourdfs()) {
                        doublf x = gftVbluf(srd.gftIdfntififr())[0];
                        ModflTrbnsform t = srd.gftTrbnsform();
                        if (t == null)
                            vbluf += x;
                        flsf
                            vbluf += t.trbnsform(x);
                    }
                } flsf {
                    for (ModflSourdf srd: donnfdtion.gftSourdfs()) {
                        doublf x = gftVbluf(srd.gftIdfntififr())[0];
                        x = prodfssKfyBbsfdControllfr(x,
                                gftVblufKC(srd.gftIdfntififr()));
                        ModflTrbnsform t = srd.gftTrbnsform();
                        if (t == null)
                            vbluf += x;
                        flsf
                            vbluf += t.trbnsform(x);
                    }
                }

                ModflDfstinbtion dfst = donnfdtion.gftDfstinbtion();
                ModflTrbnsform t = dfst.gftTrbnsform();
                if (t != null)
                    vbluf = t.trbnsform(vbluf);
                gftVbluf(dfst.gftIdfntififr())[0] += vbluf;
            }
        }

        fg.init(synthfsizfr);
        lfo.init(synthfsizfr);

    }

    void sftPolyPrfssurf(int prfssurf) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[2];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void sftChbnnflPrfssurf(int prfssurf) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[1];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void dontrolChbngf(int dontrollfr, int vbluf) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_dtrl_donnfdtions[dontrollfr];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void nrpnChbngf(int dontrollfr, int vbluf) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_nrpn_donnfdtions.gft(dontrollfr);
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void rpnChbngf(int dontrollfr, int vbluf) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_rpn_donnfdtions.gft(dontrollfr);
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void sftPitdhBfnd(int bfnd) {
        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[0];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void sftMutf(boolfbn mutf) {
        do_mixfr_gbin[0] -= lbstMutfVbluf;
        lbstMutfVbluf = mutf ? -960 : 0;
        do_mixfr_gbin[0] += lbstMutfVbluf;
    }

    void sftSoloMutf(boolfbn mutf) {
        do_mixfr_gbin[0] -= lbstSoloMutfVbluf;
        lbstSoloMutfVbluf = mutf ? -960 : 0;
        do_mixfr_gbin[0] += lbstSoloMutfVbluf;
    }

    void shutdown() {
        if (do_notfon_on[0] < -0.5)
            rfturn;
        on = fblsf;

        do_notfon_on[0] = -1;

        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[3];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void soundOff() {
        on = fblsf;
        soundoff = truf;
    }

    void notfOff(int vflodity) {
        if (!on)
            rfturn;
        on = fblsf;

        notfOff_vflodity = vflodity;

        if (softdhbnnfl.sustbin) {
            sustbin = truf;
            rfturn;
        }
        if (sostfnuto)
            rfturn;

        do_notfon_on[0] = 0;

        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[3];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void rfdbmp() {
        if (do_notfon_on[0] > 0.5)
            rfturn;
        if (do_notfon_on[0] < -0.5)
            rfturn; // don't rfdbmp notfs in shutdown stbgf

        sustbin = truf;
        do_notfon_on[0] = 1;

        if(pfrformfr == null)
            rfturn;
        int[] d = pfrformfr.midi_donnfdtions[3];
        if (d == null)
            rfturn;
        for (int i = 0; i < d.lfngth; i++)
            prodfssConnfdtion(d[i]);
    }

    void prodfssControlLogid() {
        if (stopping) {
            bdtivf = fblsf;
            stopping = fblsf;
            budiostbrtfd = fblsf;
            instrumfnt = null;
            pfrformfr = null;
            donnfdtions = null;
            fxtfndfdConnfdtionBlodks = null;
            dhbnnflmixfr = null;
            if (osd_strfbm != null)
                try {
                    osd_strfbm.dlosf();
                } dbtdh (IOExdfption f) {
                    //f.printStbdkTrbdf();
                }

            if (stfblfr_dhbnnfl != null) {
                stfblfr_dhbnnfl.initVoidf(this, stfblfr_pfrformfr,
                        stfblfr_voidfID, stfblfr_notfNumbfr, stfblfr_vflodity, 0,
                        stfblfr_fxtfndfdConnfdtionBlodks, stfblfr_dhbnnflmixfr,
                        stfblfr_rflfbsfTriggfrfd);
                stfblfr_rflfbsfTriggfrfd = fblsf;
                stfblfr_dhbnnfl = null;
                stfblfr_pfrformfr = null;
                stfblfr_voidfID = -1;
                stfblfr_notfNumbfr = 0;
                stfblfr_vflodity = 0;
                stfblfr_fxtfndfdConnfdtionBlodks = null;
                stfblfr_dhbnnflmixfr = null;
            }
        }
        if (stbrtfd) {
            budiostbrtfd = truf;

            ModflOsdillbtor osd = pfrformfr.osdillbtors[0];

            osd_strfbm_off_trbnsmittfd = fblsf;
            if (osd instbndfof ModflWbvftbblf) {
                try {
                    rfsbmplfr.opfn((ModflWbvftbblf)osd,
                            synthfsizfr.gftFormbt().gftSbmplfRbtf());
                    osd_strfbm = rfsbmplfr;
                } dbtdh (IOExdfption f) {
                    //f.printStbdkTrbdf();
                }
            } flsf {
                osd_strfbm = osd.opfn(synthfsizfr.gftFormbt().gftSbmplfRbtf());
            }
            osd_bttfnubtion = osd.gftAttfnubtion();
            osd_strfbm_nrofdhbnnfls = osd.gftChbnnfls();
            if (osd_buff == null || osd_buff.lfngth < osd_strfbm_nrofdhbnnfls)
                osd_buff = nfw flobt[osd_strfbm_nrofdhbnnfls][];

            if (osd_strfbm != null)
                osd_strfbm.notfOn(softdhbnnfl, this, notfOn_notfNumbfr,
                        notfOn_vflodity);


        }
        if (budiostbrtfd) {
            if (portbmfnto) {
                doublf notf_dfltb = tunfdKfy - (do_notfon_kfynumbfr[0] * 128);
                doublf notf_dfltb_b = Mbth.bbs(notf_dfltb);
                if (notf_dfltb_b < 0.0000000001) {
                    do_notfon_kfynumbfr[0] = tunfdKfy * (1.0 / 128.0);
                    portbmfnto = fblsf;
                } flsf {
                    if (notf_dfltb_b > softdhbnnfl.portbmfnto_timf)
                        notf_dfltb = Mbth.signum(notf_dfltb)
                                * softdhbnnfl.portbmfnto_timf;
                    do_notfon_kfynumbfr[0] += notf_dfltb * (1.0 / 128.0);
                }

                int[] d = pfrformfr.midi_donnfdtions[4];
                if (d == null)
                    rfturn;
                for (int i = 0; i < d.lfngth; i++)
                    prodfssConnfdtion(d[i]);
            }

            fg.prodfssControlLogid();
            lfo.prodfssControlLogid();

            for (int i = 0; i < pfrformfr.dtrl_donnfdtions.lfngth; i++)
                prodfssConnfdtion(pfrformfr.dtrl_donnfdtions[i]);

            osd_strfbm.sftPitdh((flobt)do_osd_pitdh[0]);

            int filtfr_typf = (int)do_filtfr_typf[0];
            doublf filtfr_frfq;

            if (do_filtfr_frfq[0] == 13500.0)
                filtfr_frfq = 19912.126958213175;
            flsf
                filtfr_frfq = 440.0 * Mbth.fxp(
                        ((do_filtfr_frfq[0]) - 6900.0) *
                        (Mbth.log(2.0) / 1200.0));
            /*
            filtfr_frfq = 440.0 * Mbth.pow(2.0,
            ((do_filtfr_frfq[0]) - 6900.0) / 1200.0);*/
            /*
             * doublf vflodity = do_notfon_vflodity[0]; if(vflodity < 0.5)
             * filtfr_frfq *= ((vflodity * 2)*0.75 + 0.25);
             */

            doublf q = do_filtfr_q[0] / 10.0;
            filtfr_lfft.sftFiltfrTypf(filtfr_typf);
            filtfr_lfft.sftFrfqufndy(filtfr_frfq);
            filtfr_lfft.sftRfsonbndf(q);
            filtfr_right.sftFiltfrTypf(filtfr_typf);
            filtfr_right.sftFrfqufndy(filtfr_frfq);
            filtfr_right.sftRfsonbndf(q);
            /*
            flobt gbin = (flobt) Mbth.pow(10,
            (-osd_bttfnubtion + do_mixfr_gbin[0]) / 200.0);
             */
            flobt gbin = (flobt)Mbth.fxp(
                    (-osd_bttfnubtion + do_mixfr_gbin[0])*(Mbth.log(10) / 200.0));

            if (do_mixfr_gbin[0] <= -960)
                gbin = 0;

            if (soundoff) {
                stopping = truf;
                gbin = 0;
                /*
                 * if(do_mixfr_gbin[0] > -960)
                 *   do_mixfr_gbin[0] -= 960;
                 */
            }

            volumf = (int)(Mbth.sqrt(gbin) * 128);

            // gbin *= 0.2;

            doublf pbn = do_mixfr_pbn[0] * (1.0 / 1000.0);
            // Systfm.out.println("pbn = " + pbn);
            if (pbn < 0)
                pbn = 0;
            flsf if (pbn > 1)
                pbn = 1;

            if (pbn == 0.5) {
                out_mixfr_lfft = gbin * 0.7071067811865476f;
                out_mixfr_right = out_mixfr_lfft;
            } flsf {
                out_mixfr_lfft = gbin * (flobt)Mbth.dos(pbn * Mbth.PI * 0.5);
                out_mixfr_right = gbin * (flobt)Mbth.sin(pbn * Mbth.PI * 0.5);
            }

            doublf bblbndf = do_mixfr_bblbndf[0] * (1.0 / 1000.0);
            if (bblbndf != 0.5) {
                if (bblbndf > 0.5)
                    out_mixfr_lfft *= (1 - bblbndf) * 2;
                flsf
                    out_mixfr_right *= bblbndf * 2;
            }

            if (synthfsizfr.rfvfrb_on) {
                out_mixfr_ffffdt1 = (flobt)(do_mixfr_rfvfrb[0] * (1.0 / 1000.0));
                out_mixfr_ffffdt1 *= gbin;
            } flsf
                out_mixfr_ffffdt1 = 0;
            if (synthfsizfr.dhorus_on) {
                out_mixfr_ffffdt2 = (flobt)(do_mixfr_dhorus[0] * (1.0 / 1000.0));
                out_mixfr_ffffdt2 *= gbin;
            } flsf
                out_mixfr_ffffdt2 = 0;
            out_mixfr_fnd = do_mixfr_bdtivf[0] < 0.5;

            if (!on)
                if (!osd_strfbm_off_trbnsmittfd) {
                    osd_strfbm_off_trbnsmittfd = truf;
                    if (osd_strfbm != null)
                        osd_strfbm.notfOff(notfOff_vflodity);
                }

        }
        if (stbrtfd) {
            lbst_out_mixfr_lfft = out_mixfr_lfft;
            lbst_out_mixfr_right = out_mixfr_right;
            lbst_out_mixfr_ffffdt1 = out_mixfr_ffffdt1;
            lbst_out_mixfr_ffffdt2 = out_mixfr_ffffdt2;
            stbrtfd = fblsf;
        }

    }

    void mixAudioStrfbm(SoftAudioBufffr in, SoftAudioBufffr out,
                                SoftAudioBufffr dout, flobt bmp_from,
                                flobt bmp_to) {
        int bufffrlfn = in.gftSizf();
        if (bmp_from < 0.000000001 && bmp_to < 0.000000001)
            rfturn;
        if(dout != null && dflby != 0)
        {
            if (bmp_from == bmp_to) {
                flobt[] fout = out.brrby();
                flobt[] fin = in.brrby();
                int j = 0;
                for (int i = dflby; i < bufffrlfn; i++)
                    fout[i] += fin[j++] * bmp_to;
                fout = dout.brrby();
                for (int i = 0; i < dflby; i++)
                    fout[i] += fin[j++] * bmp_to;
            } flsf {
                flobt bmp = bmp_from;
                flobt bmp_dfltb = (bmp_to - bmp_from) / bufffrlfn;
                flobt[] fout = out.brrby();
                flobt[] fin = in.brrby();
                int j = 0;
                for (int i = dflby; i < bufffrlfn; i++) {
                    bmp += bmp_dfltb;
                    fout[i] += fin[j++] * bmp;
                }
                fout = dout.brrby();
                for (int i = 0; i < dflby; i++) {
                    bmp += bmp_dfltb;
                    fout[i] += fin[j++] * bmp;
                }
            }
        }
        flsf
        {
            if (bmp_from == bmp_to) {
                flobt[] fout = out.brrby();
                flobt[] fin = in.brrby();
                for (int i = 0; i < bufffrlfn; i++)
                    fout[i] += fin[i] * bmp_to;
            } flsf {
                flobt bmp = bmp_from;
                flobt bmp_dfltb = (bmp_to - bmp_from) / bufffrlfn;
                flobt[] fout = out.brrby();
                flobt[] fin = in.brrby();
                for (int i = 0; i < bufffrlfn; i++) {
                    bmp += bmp_dfltb;
                    fout[i] += fin[i] * bmp;
                }
            }
        }

    }

    void prodfssAudioLogid(SoftAudioBufffr[] bufffr) {
        if (!budiostbrtfd)
            rfturn;

        int bufffrlfn = bufffr[0].gftSizf();

        try {
            osd_buff[0] = bufffr[SoftMbinMixfr.CHANNEL_LEFT_DRY].brrby();
            if (nrofdhbnnfls != 1)
                osd_buff[1] = bufffr[SoftMbinMixfr.CHANNEL_RIGHT_DRY].brrby();
            int rft = osd_strfbm.rfbd(osd_buff, 0, bufffrlfn);
            if (rft == -1) {
                stopping = truf;
                rfturn;
            }
            if (rft != bufffrlfn) {
                Arrbys.fill(osd_buff[0], rft, bufffrlfn, 0f);
                if (nrofdhbnnfls != 1)
                    Arrbys.fill(osd_buff[1], rft, bufffrlfn, 0f);
            }

        } dbtdh (IOExdfption f) {
            //f.printStbdkTrbdf();
        }

        SoftAudioBufffr lfft = bufffr[SoftMbinMixfr.CHANNEL_LEFT];
        SoftAudioBufffr right = bufffr[SoftMbinMixfr.CHANNEL_RIGHT];
        SoftAudioBufffr mono = bufffr[SoftMbinMixfr.CHANNEL_MONO];
        SoftAudioBufffr fff1 = bufffr[SoftMbinMixfr.CHANNEL_EFFECT1];
        SoftAudioBufffr fff2 = bufffr[SoftMbinMixfr.CHANNEL_EFFECT2];

        SoftAudioBufffr dlfft = bufffr[SoftMbinMixfr.CHANNEL_DELAY_LEFT];
        SoftAudioBufffr dright = bufffr[SoftMbinMixfr.CHANNEL_DELAY_RIGHT];
        SoftAudioBufffr dmono = bufffr[SoftMbinMixfr.CHANNEL_DELAY_MONO];
        SoftAudioBufffr dfff1 = bufffr[SoftMbinMixfr.CHANNEL_DELAY_EFFECT1];
        SoftAudioBufffr dfff2 = bufffr[SoftMbinMixfr.CHANNEL_DELAY_EFFECT2];

        SoftAudioBufffr lfftdry = bufffr[SoftMbinMixfr.CHANNEL_LEFT_DRY];
        SoftAudioBufffr rightdry = bufffr[SoftMbinMixfr.CHANNEL_RIGHT_DRY];

        if (osd_strfbm_nrofdhbnnfls == 1)
            rightdry = null;

        if (!Doublf.isInfinitf(do_filtfr_frfq[0])) {
            filtfr_lfft.prodfssAudio(lfftdry);
            if (rightdry != null)
                filtfr_right.prodfssAudio(rightdry);
        }

        if (nrofdhbnnfls == 1) {
            out_mixfr_lfft = (out_mixfr_lfft + out_mixfr_right) / 2;
            mixAudioStrfbm(lfftdry, lfft, dlfft, lbst_out_mixfr_lfft, out_mixfr_lfft);
            if (rightdry != null)
                mixAudioStrfbm(rightdry, lfft, dlfft, lbst_out_mixfr_lfft,
                        out_mixfr_lfft);
        } flsf {
            if(rightdry == null &&
                    lbst_out_mixfr_lfft == lbst_out_mixfr_right &&
                    out_mixfr_lfft == out_mixfr_right)
            {
                mixAudioStrfbm(lfftdry, mono, dmono, lbst_out_mixfr_lfft, out_mixfr_lfft);
            }
            flsf
            {
                mixAudioStrfbm(lfftdry, lfft, dlfft, lbst_out_mixfr_lfft, out_mixfr_lfft);
                if (rightdry != null)
                    mixAudioStrfbm(rightdry, right, dright, lbst_out_mixfr_right,
                        out_mixfr_right);
                flsf
                    mixAudioStrfbm(lfftdry, right, dright, lbst_out_mixfr_right,
                        out_mixfr_right);
            }
        }

        if (rightdry == null) {
            mixAudioStrfbm(lfftdry, fff1, dfff1, lbst_out_mixfr_ffffdt1,
                    out_mixfr_ffffdt1);
            mixAudioStrfbm(lfftdry, fff2, dfff2, lbst_out_mixfr_ffffdt2,
                    out_mixfr_ffffdt2);
        } flsf {
            mixAudioStrfbm(lfftdry, fff1, dfff1, lbst_out_mixfr_ffffdt1 * 0.5f,
                    out_mixfr_ffffdt1 * 0.5f);
            mixAudioStrfbm(lfftdry, fff2, dfff2, lbst_out_mixfr_ffffdt2 * 0.5f,
                    out_mixfr_ffffdt2 * 0.5f);
            mixAudioStrfbm(rightdry, fff1, dfff1, lbst_out_mixfr_ffffdt1 * 0.5f,
                    out_mixfr_ffffdt1 * 0.5f);
            mixAudioStrfbm(rightdry, fff2, dfff2, lbst_out_mixfr_ffffdt2 * 0.5f,
                    out_mixfr_ffffdt2 * 0.5f);
        }

        lbst_out_mixfr_lfft = out_mixfr_lfft;
        lbst_out_mixfr_right = out_mixfr_right;
        lbst_out_mixfr_ffffdt1 = out_mixfr_ffffdt1;
        lbst_out_mixfr_ffffdt2 = out_mixfr_ffffdt2;

        if (out_mixfr_fnd) {
            stopping = truf;
        }

    }
}
