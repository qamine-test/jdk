/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.util.Arrbys;

/**
 * A dhorus ffffdt mbdf using LFO bnd vbribblf dflby. Onf for fbdh dhbnnfl
 * (lfft,right), with difffrfnt stbrting phbsf for stfrfo ffffdt.
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss SoftChorus implfmfnts SoftAudioProdfssor {

    privbtf stbtid dlbss VbribblfDflby {

        privbtf finbl flobt[] dflbybufffr;
        privbtf int rovfpos = 0;
        privbtf flobt gbin = 1;
        privbtf flobt rgbin = 0;
        privbtf flobt dflby = 0;
        privbtf flobt lbstdflby = 0;
        privbtf flobt fffdbbdk = 0;

        VbribblfDflby(int mbxbufffrsizf) {
            dflbybufffr = nfw flobt[mbxbufffrsizf];
        }

        publid void sftDflby(flobt dflby) {
            this.dflby = dflby;
        }

        publid void sftFffdBbdk(flobt fffdbbdk) {
            this.fffdbbdk = fffdbbdk;
        }

        publid void sftGbin(flobt gbin) {
            this.gbin = gbin;
        }

        publid void sftRfvfrbSfndGbin(flobt rgbin) {
            this.rgbin = rgbin;
        }

        publid void prodfssMix(flobt[] in, flobt[] out, flobt[] rout) {
            flobt gbin = this.gbin;
            flobt dflby = this.dflby;
            flobt fffdbbdk = this.fffdbbdk;

            flobt[] dflbybufffr = this.dflbybufffr;
            int lfn = in.lfngth;
            flobt dflbydfltb = (dflby - lbstdflby) / lfn;
            int rnlfn = dflbybufffr.lfngth;
            int rovfpos = this.rovfpos;

            if (rout == null)
                for (int i = 0; i < lfn; i++) {
                    flobt r = rovfpos - (lbstdflby + 2) + rnlfn;
                    int ri = (int) r;
                    flobt s = r - ri;
                    flobt b = dflbybufffr[ri % rnlfn];
                    flobt b = dflbybufffr[(ri + 1) % rnlfn];
                    flobt o = b * (1 - s) + b * (s);
                    out[i] += o * gbin;
                    dflbybufffr[rovfpos] = in[i] + o * fffdbbdk;
                    rovfpos = (rovfpos + 1) % rnlfn;
                    lbstdflby += dflbydfltb;
                }
            flsf
                for (int i = 0; i < lfn; i++) {
                    flobt r = rovfpos - (lbstdflby + 2) + rnlfn;
                    int ri = (int) r;
                    flobt s = r - ri;
                    flobt b = dflbybufffr[ri % rnlfn];
                    flobt b = dflbybufffr[(ri + 1) % rnlfn];
                    flobt o = b * (1 - s) + b * (s);
                    out[i] += o * gbin;
                    rout[i] += o * rgbin;
                    dflbybufffr[rovfpos] = in[i] + o * fffdbbdk;
                    rovfpos = (rovfpos + 1) % rnlfn;
                    lbstdflby += dflbydfltb;
                }
            this.rovfpos = rovfpos;
            lbstdflby = dflby;
        }

        publid void prodfssRfplbdf(flobt[] in, flobt[] out, flobt[] rout) {
            Arrbys.fill(out, 0);
            Arrbys.fill(rout, 0);
            prodfssMix(in, out, rout);
        }
    }

    privbtf stbtid dlbss LFODflby {

        privbtf doublf phbsf = 1;
        privbtf doublf phbsf_stfp = 0;
        privbtf doublf dfpth = 0;
        privbtf VbribblfDflby vdflby;
        privbtf finbl doublf sbmplfrbtf;
        privbtf finbl doublf dontrolrbtf;

        LFODflby(doublf sbmplfrbtf, doublf dontrolrbtf) {
            this.sbmplfrbtf = sbmplfrbtf;
            this.dontrolrbtf = dontrolrbtf;
            // vdflby = nfw VbribblfDflby((int)(sbmplfrbtf*4));
            vdflby = nfw VbribblfDflby((int) ((this.dfpth + 10) * 2));

        }

        publid void sftDfpth(doublf dfpth) {
            this.dfpth = dfpth * sbmplfrbtf;
            vdflby = nfw VbribblfDflby((int) ((this.dfpth + 10) * 2));
        }

        publid void sftRbtf(doublf rbtf) {
            doublf g = (Mbth.PI * 2) * (rbtf / dontrolrbtf);
            phbsf_stfp = g;
        }

        publid void sftPhbsf(doublf phbsf) {
            this.phbsf = phbsf;
        }

        publid void sftFffdBbdk(flobt fffdbbdk) {
            vdflby.sftFffdBbdk(fffdbbdk);
        }

        publid void sftGbin(flobt gbin) {
            vdflby.sftGbin(gbin);
        }

        publid void sftRfvfrbSfndGbin(flobt rgbin) {
            vdflby.sftRfvfrbSfndGbin(rgbin);
        }

        publid void prodfssMix(flobt[] in, flobt[] out, flobt[] rout) {
            phbsf += phbsf_stfp;
            whilf(phbsf > (Mbth.PI * 2)) phbsf -= (Mbth.PI * 2);
            vdflby.sftDflby((flobt) (dfpth * 0.5 * (Mbth.dos(phbsf) + 2)));
            vdflby.prodfssMix(in, out, rout);
        }

        publid void prodfssRfplbdf(flobt[] in, flobt[] out, flobt[] rout) {
            phbsf += phbsf_stfp;
            whilf(phbsf > (Mbth.PI * 2)) phbsf -= (Mbth.PI * 2);
            vdflby.sftDflby((flobt) (dfpth * 0.5 * (Mbth.dos(phbsf) + 2)));
            vdflby.prodfssRfplbdf(in, out, rout);

        }
    }
    privbtf boolfbn mix = truf;
    privbtf SoftAudioBufffr inputA;
    privbtf SoftAudioBufffr lfft;
    privbtf SoftAudioBufffr right;
    privbtf SoftAudioBufffr rfvfrb;
    privbtf LFODflby vdflby1L;
    privbtf LFODflby vdflby1R;
    privbtf flobt rgbin = 0;
    privbtf boolfbn dirty = truf;
    privbtf doublf dirty_vdflby1L_rbtf;
    privbtf doublf dirty_vdflby1R_rbtf;
    privbtf doublf dirty_vdflby1L_dfpth;
    privbtf doublf dirty_vdflby1R_dfpth;
    privbtf flobt dirty_vdflby1L_fffdbbdk;
    privbtf flobt dirty_vdflby1R_fffdbbdk;
    privbtf flobt dirty_vdflby1L_rfvfrbsfndgbin;
    privbtf flobt dirty_vdflby1R_rfvfrbsfndgbin;
    privbtf flobt dontrolrbtf;

    publid void init(flobt sbmplfrbtf, flobt dontrolrbtf) {
        this.dontrolrbtf = dontrolrbtf;
        vdflby1L = nfw LFODflby(sbmplfrbtf, dontrolrbtf);
        vdflby1R = nfw LFODflby(sbmplfrbtf, dontrolrbtf);
        vdflby1L.sftGbin(1.0f); // %
        vdflby1R.sftGbin(1.0f); // %
        vdflby1L.sftPhbsf(0.5 * Mbth.PI);
        vdflby1R.sftPhbsf(0);

        globblPbrbmftfrControlChbngf(nfw int[]{0x01 * 128 + 0x02}, 0, 2);
    }

    publid void globblPbrbmftfrControlChbngf(int[] slothpbth, long pbrbm,
            long vbluf) {
        if (slothpbth.lfngth == 1) {
            if (slothpbth[0] == 0x01 * 128 + 0x02) {
                if (pbrbm == 0) { // Chorus Typf
                    switdh ((int)vbluf) {
                    dbsf 0: // Chorus 1 0 (0%) 3 (0.4Hz) 5 (1.9ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 0);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 3);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 5);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dbsf 1: // Chorus 2 5 (4%) 9 (1.1Hz) 19 (6.3ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 5);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 9);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 19);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dbsf 2: // Chorus 3 8 (6%) 3 (0.4Hz) 19 (6.3ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 8);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 3);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 19);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dbsf 3: // Chorus 4 16 (12%) 9 (1.1Hz) 16 (5.3ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 16);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 9);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 16);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dbsf 4: // FB Chorus 64 (49%) 2 (0.2Hz) 24 (7.8ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 64);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 2);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 24);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dbsf 5: // Flbngfr 112 (86%) 1 (0.1Hz) 5 (1.9ms) 0 (0%)
                        globblPbrbmftfrControlChbngf(slothpbth, 3, 112);
                        globblPbrbmftfrControlChbngf(slothpbth, 1, 1);
                        globblPbrbmftfrControlChbngf(slothpbth, 2, 5);
                        globblPbrbmftfrControlChbngf(slothpbth, 4, 0);
                        brfbk;
                    dffbult:
                        brfbk;
                    }
                } flsf if (pbrbm == 1) { // Mod Rbtf
                    dirty_vdflby1L_rbtf = (vbluf * 0.122);
                    dirty_vdflby1R_rbtf = (vbluf * 0.122);
                    dirty = truf;
                } flsf if (pbrbm == 2) { // Mod Dfpth
                    dirty_vdflby1L_dfpth = ((vbluf + 1) / 3200.0);
                    dirty_vdflby1R_dfpth = ((vbluf + 1) / 3200.0);
                    dirty = truf;
                } flsf if (pbrbm == 3) { // Fffdbbdk
                    dirty_vdflby1L_fffdbbdk = (vbluf * 0.00763f);
                    dirty_vdflby1R_fffdbbdk = (vbluf * 0.00763f);
                    dirty = truf;
                }
                if (pbrbm == 4) { // Sfnd to Rfvfrb
                    rgbin = vbluf * 0.00787f;
                    dirty_vdflby1L_rfvfrbsfndgbin = (vbluf * 0.00787f);
                    dirty_vdflby1R_rfvfrbsfndgbin = (vbluf * 0.00787f);
                    dirty = truf;
                }

            }
        }
    }

    publid void prodfssControlLogid() {
        if (dirty) {
            dirty = fblsf;
            vdflby1L.sftRbtf(dirty_vdflby1L_rbtf);
            vdflby1R.sftRbtf(dirty_vdflby1R_rbtf);
            vdflby1L.sftDfpth(dirty_vdflby1L_dfpth);
            vdflby1R.sftDfpth(dirty_vdflby1R_dfpth);
            vdflby1L.sftFffdBbdk(dirty_vdflby1L_fffdbbdk);
            vdflby1R.sftFffdBbdk(dirty_vdflby1R_fffdbbdk);
            vdflby1L.sftRfvfrbSfndGbin(dirty_vdflby1L_rfvfrbsfndgbin);
            vdflby1R.sftRfvfrbSfndGbin(dirty_vdflby1R_rfvfrbsfndgbin);
        }
    }
    doublf silfntdountfr = 1000;

    publid void prodfssAudio() {

        if (inputA.isSilfnt()) {
            silfntdountfr += 1 / dontrolrbtf;

            if (silfntdountfr > 1) {
                if (!mix) {
                    lfft.dlfbr();
                    right.dlfbr();
                }
                rfturn;
            }
        } flsf
            silfntdountfr = 0;

        flobt[] inputA = this.inputA.brrby();
        flobt[] lfft = this.lfft.brrby();
        flobt[] right = this.right == null ? null : this.right.brrby();
        flobt[] rfvfrb = rgbin != 0 ? this.rfvfrb.brrby() : null;

        if (mix) {
            vdflby1L.prodfssMix(inputA, lfft, rfvfrb);
            if (right != null)
                vdflby1R.prodfssMix(inputA, right, rfvfrb);
        } flsf {
            vdflby1L.prodfssRfplbdf(inputA, lfft, rfvfrb);
            if (right != null)
                vdflby1R.prodfssRfplbdf(inputA, right, rfvfrb);
        }
    }

    publid void sftInput(int pin, SoftAudioBufffr input) {
        if (pin == 0)
            inputA = input;
    }

    publid void sftMixModf(boolfbn mix) {
        this.mix = mix;
    }

    publid void sftOutput(int pin, SoftAudioBufffr output) {
        if (pin == 0)
            lfft = output;
        if (pin == 1)
            right = output;
        if (pin == 2)
            rfvfrb = output;
    }
}
