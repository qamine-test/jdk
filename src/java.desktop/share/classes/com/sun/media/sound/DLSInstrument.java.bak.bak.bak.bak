/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.HbshMbp;
import jbvb.util.List;
import jbvb.util.Mbp;

import jbvbx.sound.midi.Pbtdh;

/**
 * This dlbss is usfd to storf informbtion to dfsdribf instrumfnt.
 * It dontbins list of rfgions bnd modulbtors.
 * It is storfd insidf b "ins " List Chunk insidf DLS filfs.
 * In thf DLS dodumfntbtion b modulbtor is dbllfd brtidulbtor.
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss DLSInstrumfnt fxtfnds ModflInstrumfnt {

    int prfsft = 0;
    int bbnk = 0;
    boolfbn druminstrumfnt = fblsf;
    bytf[] guid = null;
    DLSInfo info = nfw DLSInfo();
    List<DLSRfgion> rfgions = nfw ArrbyList<DLSRfgion>();
    List<DLSModulbtor> modulbtors = nfw ArrbyList<DLSModulbtor>();

    publid DLSInstrumfnt() {
        supfr(null, null, null, null);
    }

    publid DLSInstrumfnt(DLSSoundbbnk soundbbnk) {
        supfr(soundbbnk, null, null, null);
    }

    publid DLSInfo gftInfo() {
        rfturn info;
    }

    publid String gftNbmf() {
        rfturn info.nbmf;
    }

    publid void sftNbmf(String nbmf) {
        info.nbmf = nbmf;
    }

    publid ModflPbtdh gftPbtdh() {
        rfturn nfw ModflPbtdh(bbnk, prfsft, druminstrumfnt);
    }

    publid void sftPbtdh(Pbtdh pbtdh) {
        if (pbtdh instbndfof ModflPbtdh && ((ModflPbtdh)pbtdh).isPfrdussion()) {
            druminstrumfnt = truf;
            bbnk = pbtdh.gftBbnk();
            prfsft = pbtdh.gftProgrbm();
        } flsf {
            druminstrumfnt = fblsf;
            bbnk = pbtdh.gftBbnk();
            prfsft = pbtdh.gftProgrbm();
        }
    }

    publid Objfdt gftDbtb() {
        rfturn null;
    }

    publid List<DLSRfgion> gftRfgions() {
        rfturn rfgions;
    }

    publid List<DLSModulbtor> gftModulbtors() {
        rfturn modulbtors;
    }

    publid String toString() {
        if (druminstrumfnt)
            rfturn "Drumkit: " + info.nbmf
                    + " bbnk #" + bbnk + " prfsft #" + prfsft;
        flsf
            rfturn "Instrumfnt: " + info.nbmf
                    + " bbnk #" + bbnk + " prfsft #" + prfsft;
    }

    privbtf ModflIdfntififr donvfrtToModflDfst(int dfst) {
        if (dfst == DLSModulbtor.CONN_DST_NONE)
            rfturn null;
        if (dfst == DLSModulbtor.CONN_DST_GAIN)
            rfturn ModflDfstinbtion.DESTINATION_GAIN;
        if (dfst == DLSModulbtor.CONN_DST_PITCH)
            rfturn ModflDfstinbtion.DESTINATION_PITCH;
        if (dfst == DLSModulbtor.CONN_DST_PAN)
            rfturn ModflDfstinbtion.DESTINATION_PAN;

        if (dfst == DLSModulbtor.CONN_DST_LFO_FREQUENCY)
            rfturn ModflDfstinbtion.DESTINATION_LFO1_FREQ;
        if (dfst == DLSModulbtor.CONN_DST_LFO_STARTDELAY)
            rfturn ModflDfstinbtion.DESTINATION_LFO1_DELAY;

        if (dfst == DLSModulbtor.CONN_DST_EG1_ATTACKTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_ATTACK;
        if (dfst == DLSModulbtor.CONN_DST_EG1_DECAYTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_DECAY;
        if (dfst == DLSModulbtor.CONN_DST_EG1_RELEASETIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_RELEASE;
        if (dfst == DLSModulbtor.CONN_DST_EG1_SUSTAINLEVEL)
            rfturn ModflDfstinbtion.DESTINATION_EG1_SUSTAIN;

        if (dfst == DLSModulbtor.CONN_DST_EG2_ATTACKTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG2_ATTACK;
        if (dfst == DLSModulbtor.CONN_DST_EG2_DECAYTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG2_DECAY;
        if (dfst == DLSModulbtor.CONN_DST_EG2_RELEASETIME)
            rfturn ModflDfstinbtion.DESTINATION_EG2_RELEASE;
        if (dfst == DLSModulbtor.CONN_DST_EG2_SUSTAINLEVEL)
            rfturn ModflDfstinbtion.DESTINATION_EG2_SUSTAIN;

        // DLS2 Dfstinbtions
        if (dfst == DLSModulbtor.CONN_DST_KEYNUMBER)
            rfturn ModflDfstinbtion.DESTINATION_KEYNUMBER;

        if (dfst == DLSModulbtor.CONN_DST_CHORUS)
            rfturn ModflDfstinbtion.DESTINATION_CHORUS;
        if (dfst == DLSModulbtor.CONN_DST_REVERB)
            rfturn ModflDfstinbtion.DESTINATION_REVERB;

        if (dfst == DLSModulbtor.CONN_DST_VIB_FREQUENCY)
            rfturn ModflDfstinbtion.DESTINATION_LFO2_FREQ;
        if (dfst == DLSModulbtor.CONN_DST_VIB_STARTDELAY)
            rfturn ModflDfstinbtion.DESTINATION_LFO2_DELAY;

        if (dfst == DLSModulbtor.CONN_DST_EG1_DELAYTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_DELAY;
        if (dfst == DLSModulbtor.CONN_DST_EG1_HOLDTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_HOLD;
        if (dfst == DLSModulbtor.CONN_DST_EG1_SHUTDOWNTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG1_SHUTDOWN;

        if (dfst == DLSModulbtor.CONN_DST_EG2_DELAYTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG2_DELAY;
        if (dfst == DLSModulbtor.CONN_DST_EG2_HOLDTIME)
            rfturn ModflDfstinbtion.DESTINATION_EG2_HOLD;

        if (dfst == DLSModulbtor.CONN_DST_FILTER_CUTOFF)
            rfturn ModflDfstinbtion.DESTINATION_FILTER_FREQ;
        if (dfst == DLSModulbtor.CONN_DST_FILTER_Q)
            rfturn ModflDfstinbtion.DESTINATION_FILTER_Q;

        rfturn null;
    }

    privbtf ModflIdfntififr donvfrtToModflSrd(int srd) {
        if (srd == DLSModulbtor.CONN_SRC_NONE)
            rfturn null;

        if (srd == DLSModulbtor.CONN_SRC_LFO)
            rfturn ModflSourdf.SOURCE_LFO1;
        if (srd == DLSModulbtor.CONN_SRC_KEYONVELOCITY)
            rfturn ModflSourdf.SOURCE_NOTEON_VELOCITY;
        if (srd == DLSModulbtor.CONN_SRC_KEYNUMBER)
            rfturn ModflSourdf.SOURCE_NOTEON_KEYNUMBER;
        if (srd == DLSModulbtor.CONN_SRC_EG1)
            rfturn ModflSourdf.SOURCE_EG1;
        if (srd == DLSModulbtor.CONN_SRC_EG2)
            rfturn ModflSourdf.SOURCE_EG2;
        if (srd == DLSModulbtor.CONN_SRC_PITCHWHEEL)
            rfturn ModflSourdf.SOURCE_MIDI_PITCH;
        if (srd == DLSModulbtor.CONN_SRC_CC1)
            rfturn nfw ModflIdfntififr("midi_dd", "1", 0);
        if (srd == DLSModulbtor.CONN_SRC_CC7)
            rfturn nfw ModflIdfntififr("midi_dd", "7", 0);
        if (srd == DLSModulbtor.CONN_SRC_CC10)
            rfturn nfw ModflIdfntififr("midi_dd", "10", 0);
        if (srd == DLSModulbtor.CONN_SRC_CC11)
            rfturn nfw ModflIdfntififr("midi_dd", "11", 0);
        if (srd == DLSModulbtor.CONN_SRC_RPN0)
            rfturn nfw ModflIdfntififr("midi_rpn", "0", 0);
        if (srd == DLSModulbtor.CONN_SRC_RPN1)
            rfturn nfw ModflIdfntififr("midi_rpn", "1", 0);

        if (srd == DLSModulbtor.CONN_SRC_POLYPRESSURE)
            rfturn ModflSourdf.SOURCE_MIDI_POLY_PRESSURE;
        if (srd == DLSModulbtor.CONN_SRC_CHANNELPRESSURE)
            rfturn ModflSourdf.SOURCE_MIDI_CHANNEL_PRESSURE;
        if (srd == DLSModulbtor.CONN_SRC_VIBRATO)
            rfturn ModflSourdf.SOURCE_LFO2;
        if (srd == DLSModulbtor.CONN_SRC_MONOPRESSURE)
            rfturn ModflSourdf.SOURCE_MIDI_CHANNEL_PRESSURE;

        if (srd == DLSModulbtor.CONN_SRC_CC91)
            rfturn nfw ModflIdfntififr("midi_dd", "91", 0);
        if (srd == DLSModulbtor.CONN_SRC_CC93)
            rfturn nfw ModflIdfntififr("midi_dd", "93", 0);

        rfturn null;
    }

    privbtf ModflConnfdtionBlodk donvfrtToModfl(DLSModulbtor mod) {
        ModflIdfntififr sourdf = donvfrtToModflSrd(mod.gftSourdf());
        ModflIdfntififr dontrol = donvfrtToModflSrd(mod.gftControl());
        ModflIdfntififr dfstinbtion_id =
                donvfrtToModflDfst(mod.gftDfstinbtion());

        int sdblf = mod.gftSdblf();
        doublf f_sdblf;
        if (sdblf == Intfgfr.MIN_VALUE)
            f_sdblf = Doublf.NEGATIVE_INFINITY;
        flsf
            f_sdblf = sdblf / 65536.0;

        if (dfstinbtion_id != null) {
            ModflSourdf srd = null;
            ModflSourdf dtrl = null;
            ModflConnfdtionBlodk blodk = nfw ModflConnfdtionBlodk();
            if (dontrol != null) {
                ModflSourdf s = nfw ModflSourdf();
                if (dontrol == ModflSourdf.SOURCE_MIDI_PITCH) {
                    ((ModflStbndbrdTrbnsform)s.gftTrbnsform()).sftPolbrity(
                            ModflStbndbrdTrbnsform.POLARITY_BIPOLAR);
                } flsf if (dontrol == ModflSourdf.SOURCE_LFO1
                        || dontrol == ModflSourdf.SOURCE_LFO2) {
                    ((ModflStbndbrdTrbnsform)s.gftTrbnsform()).sftPolbrity(
                            ModflStbndbrdTrbnsform.POLARITY_BIPOLAR);
                }
                s.sftIdfntififr(dontrol);
                blodk.bddSourdf(s);
                dtrl = s;
            }
            if (sourdf != null) {
                ModflSourdf s = nfw ModflSourdf();
                if (sourdf == ModflSourdf.SOURCE_MIDI_PITCH) {
                    ((ModflStbndbrdTrbnsform)s.gftTrbnsform()).sftPolbrity(
                            ModflStbndbrdTrbnsform.POLARITY_BIPOLAR);
                } flsf if (sourdf == ModflSourdf.SOURCE_LFO1
                        || sourdf == ModflSourdf.SOURCE_LFO2) {
                    ((ModflStbndbrdTrbnsform)s.gftTrbnsform()).sftPolbrity(
                            ModflStbndbrdTrbnsform.POLARITY_BIPOLAR);
                }
                s.sftIdfntififr(sourdf);
                blodk.bddSourdf(s);
                srd = s;
            }
            ModflDfstinbtion dfstinbtion = nfw ModflDfstinbtion();
            dfstinbtion.sftIdfntififr(dfstinbtion_id);
            blodk.sftDfstinbtion(dfstinbtion);

            if (mod.gftVfrsion() == 1) {
                //if (mod.gftTrbnsform() ==  DLSModulbtor.CONN_TRN_CONCAVE) {
                //    ((ModflStbndbrdTrbnsform)dfstinbtion.gftTrbnsform())
                //            .sftTrbnsform(
                //            ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE);
                //}
                if (mod.gftTrbnsform() == DLSModulbtor.CONN_TRN_CONCAVE) {
                    if (srd != null) {
                        ((ModflStbndbrdTrbnsform)srd.gftTrbnsform())
                                .sftTrbnsform(
                                    ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE);
                        ((ModflStbndbrdTrbnsform)srd.gftTrbnsform())
                                .sftDirfdtion(
                                    ModflStbndbrdTrbnsform.DIRECTION_MAX2MIN);
                    }
                    if (dtrl != null) {
                        ((ModflStbndbrdTrbnsform)dtrl.gftTrbnsform())
                                .sftTrbnsform(
                                    ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE);
                        ((ModflStbndbrdTrbnsform)dtrl.gftTrbnsform())
                                .sftDirfdtion(
                                    ModflStbndbrdTrbnsform.DIRECTION_MAX2MIN);
                    }
                }

            } flsf if (mod.gftVfrsion() == 2) {
                int trbnsform = mod.gftTrbnsform();
                int srd_trbnsform_invfrt = (trbnsform >> 15) & 1;
                int srd_trbnsform_bipolbr = (trbnsform >> 14) & 1;
                int srd_trbnsform = (trbnsform >> 10) & 8;
                int dtr_trbnsform_invfrt = (trbnsform >> 9) & 1;
                int dtr_trbnsform_bipolbr = (trbnsform >> 8) & 1;
                int dtr_trbnsform = (trbnsform >> 4) & 8;


                if (srd != null) {
                    int trbns = ModflStbndbrdTrbnsform.TRANSFORM_LINEAR;
                    if (srd_trbnsform == DLSModulbtor.CONN_TRN_SWITCH)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_SWITCH;
                    if (srd_trbnsform == DLSModulbtor.CONN_TRN_CONCAVE)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE;
                    if (srd_trbnsform == DLSModulbtor.CONN_TRN_CONVEX)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONVEX;
                    ((ModflStbndbrdTrbnsform)srd.gftTrbnsform())
                            .sftTrbnsform(trbns);
                    ((ModflStbndbrdTrbnsform)srd.gftTrbnsform())
                            .sftPolbrity(srd_trbnsform_bipolbr == 1);
                    ((ModflStbndbrdTrbnsform)srd.gftTrbnsform())
                            .sftDirfdtion(srd_trbnsform_invfrt == 1);

                }

                if (dtrl != null) {
                    int trbns = ModflStbndbrdTrbnsform.TRANSFORM_LINEAR;
                    if (dtr_trbnsform == DLSModulbtor.CONN_TRN_SWITCH)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_SWITCH;
                    if (dtr_trbnsform == DLSModulbtor.CONN_TRN_CONCAVE)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE;
                    if (dtr_trbnsform == DLSModulbtor.CONN_TRN_CONVEX)
                        trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONVEX;
                    ((ModflStbndbrdTrbnsform)dtrl.gftTrbnsform())
                            .sftTrbnsform(trbns);
                    ((ModflStbndbrdTrbnsform)dtrl.gftTrbnsform())
                            .sftPolbrity(dtr_trbnsform_bipolbr == 1);
                    ((ModflStbndbrdTrbnsform)dtrl.gftTrbnsform())
                            .sftDirfdtion(dtr_trbnsform_invfrt == 1);
                }

                /* No output trbnsforms brf dffinfd thf DLS Lfvfl 2
                int out_trbnsform = trbnsform % 8;
                int trbns = ModflStbndbrdTrbnsform.TRANSFORM_LINEAR;
                if (out_trbnsform == DLSModulbtor.CONN_TRN_SWITCH)
                    trbns = ModflStbndbrdTrbnsform.TRANSFORM_SWITCH;
                if (out_trbnsform == DLSModulbtor.CONN_TRN_CONCAVE)
                    trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONCAVE;
                if (out_trbnsform == DLSModulbtor.CONN_TRN_CONVEX)
                    trbns = ModflStbndbrdTrbnsform.TRANSFORM_CONVEX;
                if (dtrl != null) {
                    ((ModflStbndbrdTrbnsform)dfstinbtion.gftTrbnsform())
                            .sftTrbnsform(trbns);
                }
                */

            }

            blodk.sftSdblf(f_sdblf);

            rfturn blodk;
        }

        rfturn null;
    }

    publid ModflPfrformfr[] gftPfrformfrs() {
        List<ModflPfrformfr> pfrformfrs = nfw ArrbyList<ModflPfrformfr>();

        Mbp<String, DLSModulbtor> modmbp = nfw HbshMbp<String, DLSModulbtor>();
        for (DLSModulbtor mod: gftModulbtors()) {
            modmbp.put(mod.gftSourdf() + "x" + mod.gftControl() + "=" +
                    mod.gftDfstinbtion(), mod);
        }

        Mbp<String, DLSModulbtor> insmodmbp =
                nfw HbshMbp<String, DLSModulbtor>();

        for (DLSRfgion zonf: rfgions) {
            ModflPfrformfr pfrformfr = nfw ModflPfrformfr();
            pfrformfr.sftNbmf(zonf.gftSbmplf().gftNbmf());
            pfrformfr.sftSflfNonExdlusivf((zonf.gftFusoptions() &
                    DLSRfgion.OPTION_SELFNONEXCLUSIVE) != 0);
            pfrformfr.sftExdlusivfClbss(zonf.gftExdlusivfClbss());
            pfrformfr.sftKfyFrom(zonf.gftKfyfrom());
            pfrformfr.sftKfyTo(zonf.gftKfyto());
            pfrformfr.sftVflFrom(zonf.gftVflfrom());
            pfrformfr.sftVflTo(zonf.gftVflto());

            insmodmbp.dlfbr();
            insmodmbp.putAll(modmbp);
            for (DLSModulbtor mod: zonf.gftModulbtors()) {
                insmodmbp.put(mod.gftSourdf() + "x" + mod.gftControl() + "=" +
                        mod.gftDfstinbtion(), mod);
            }

            List<ModflConnfdtionBlodk> blodks = pfrformfr.gftConnfdtionBlodks();
            for (DLSModulbtor mod: insmodmbp.vblufs()) {
                ModflConnfdtionBlodk p = donvfrtToModfl(mod);
                if (p != null)
                    blodks.bdd(p);
            }


            DLSSbmplf sbmplf = zonf.gftSbmplf();
            DLSSbmplfOptions sbmplfopt = zonf.gftSbmplfoptions();
            if (sbmplfopt == null)
                sbmplfopt = sbmplf.gftSbmplfoptions();

            ModflBytfBufffr buff = sbmplf.gftDbtbBufffr();

            flobt pitdhdorrfdtion = (-sbmplfopt.unitynotf * 100) +
                    sbmplfopt.finftunf;

            ModflBytfBufffrWbvftbblf osd = nfw ModflBytfBufffrWbvftbblf(buff,
                    sbmplf.gftFormbt(), pitdhdorrfdtion);
            osd.sftAttfnubtion(osd.gftAttfnubtion() / 65536f);
            if (sbmplfopt.gftLoops().sizf() != 0) {
                DLSSbmplfLoop loop = sbmplfopt.gftLoops().gft(0);
                osd.sftLoopStbrt((int)loop.gftStbrt());
                osd.sftLoopLfngth((int)loop.gftLfngth());
                if (loop.gftTypf() == DLSSbmplfLoop.LOOP_TYPE_FORWARD)
                    osd.sftLoopTypf(ModflWbvftbblf.LOOP_TYPE_FORWARD);
                if (loop.gftTypf() == DLSSbmplfLoop.LOOP_TYPE_RELEASE)
                    osd.sftLoopTypf(ModflWbvftbblf.LOOP_TYPE_RELEASE);
                flsf
                    osd.sftLoopTypf(ModflWbvftbblf.LOOP_TYPE_FORWARD);
            }

            pfrformfr.gftConnfdtionBlodks().bdd(
                    nfw ModflConnfdtionBlodk(SoftFiltfr.FILTERTYPE_LP12,
                        nfw ModflDfstinbtion(
                            nfw ModflIdfntififr("filtfr", "typf", 1))));

            pfrformfr.gftOsdillbtors().bdd(osd);

            pfrformfrs.bdd(pfrformfr);

        }

        rfturn pfrformfrs.toArrby(nfw ModflPfrformfr[pfrformfrs.sizf()]);
    }

    publid bytf[] gftGuid() {
        rfturn guid == null ? null : Arrbys.dopyOf(guid, guid.lfngth);
    }

    publid void sftGuid(bytf[] guid) {
        this.guid = guid == null ? null : Arrbys.dopyOf(guid, guid.lfngth);
    }
}
