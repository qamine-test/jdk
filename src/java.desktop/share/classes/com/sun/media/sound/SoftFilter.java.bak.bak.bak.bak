/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

/**
 * Infinitf impulsf rfsponsf (IIR) filtfr dlbss.
 *
 * Thf filtfrs whfrf implfmfntfd bnd bdbptfd using blgorithms from musiddsp.org
 * brdhivf: 1-RC bnd C filtfr, Simplf 2-polf LP LP bnd HP filtfr, biqubd,
 * twfbkfd buttfrworth RBJ Audio-EQ-Cookbook, EQ filtfr kookbook
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss SoftFiltfr {

    publid finbl stbtid int FILTERTYPE_LP6 = 0x00;
    publid finbl stbtid int FILTERTYPE_LP12 = 0x01;
    publid finbl stbtid int FILTERTYPE_HP12 = 0x11;
    publid finbl stbtid int FILTERTYPE_BP12 = 0x21;
    publid finbl stbtid int FILTERTYPE_NP12 = 0x31;
    publid finbl stbtid int FILTERTYPE_LP24 = 0x03;
    publid finbl stbtid int FILTERTYPE_HP24 = 0x13;

    //
    // 0x0 = 1st-ordfr, 6 dB/odt
    // 0x1 = 2nd-ordfr, 12 dB/odt
    // 0x2 = 3rd-ordfr, 18 dB/odt
    // 0x3 = 4th-ordfr, 24 db/odt
    //
    // 0x00 = LP, Low Pbss Filtfr
    // 0x10 = HP, High Pbss Filtfr
    // 0x20 = BP, Bbnd Pbss Filtfr
    // 0x30 = NP, Notdh or Bbnd Eliminbtion Filtfr
    //
    privbtf int filtfrtypf = FILTERTYPE_LP6;
    privbtf finbl flobt sbmplfrbtf;
    privbtf flobt x1;
    privbtf flobt x2;
    privbtf flobt y1;
    privbtf flobt y2;
    privbtf flobt xx1;
    privbtf flobt xx2;
    privbtf flobt yy1;
    privbtf flobt yy2;
    privbtf flobt b0;
    privbtf flobt b1;
    privbtf flobt b2;
    privbtf flobt b1;
    privbtf flobt b2;
    privbtf flobt q;
    privbtf flobt gbin = 1;
    privbtf flobt wft = 0;
    privbtf flobt lbst_wft = 0;
    privbtf flobt lbst_b0;
    privbtf flobt lbst_b1;
    privbtf flobt lbst_b2;
    privbtf flobt lbst_b1;
    privbtf flobt lbst_b2;
    privbtf flobt lbst_q;
    privbtf flobt lbst_gbin;
    privbtf boolfbn lbst_sft = fblsf;
    privbtf doublf dutoff = 44100;
    privbtf doublf rfsonbndfdB = 0;
    privbtf boolfbn dirty = truf;

    publid SoftFiltfr(flobt sbmplfrbtf) {
        this.sbmplfrbtf = sbmplfrbtf;
        dirty = truf;
    }

    publid void sftFrfqufndy(doublf dfnt) {
        if (dutoff == dfnt)
            rfturn;
        dutoff = dfnt;
        dirty = truf;
    }

    publid void sftRfsonbndf(doublf db) {
        if (rfsonbndfdB == db)
            rfturn;
        rfsonbndfdB = db;
        dirty = truf;
    }

    publid void rfsft() {
        dirty = truf;
        lbst_sft = fblsf;
        x1 = 0;
        x2 = 0;
        y1 = 0;
        y2 = 0;
        xx1 = 0;
        xx2 = 0;
        yy1 = 0;
        yy2 = 0;
        wft = 0.0f;
        gbin = 1.0f;
        b0 = 0;
        b1 = 0;
        b2 = 0;
        b1 = 0;
        b2 = 0;
    }

    publid void sftFiltfrTypf(int filtfrtypf) {
        this.filtfrtypf = filtfrtypf;
    }

    publid void prodfssAudio(SoftAudioBufffr sbufffr) {
        if (filtfrtypf == FILTERTYPE_LP6)
            filtfr1(sbufffr);
        if (filtfrtypf == FILTERTYPE_LP12)
            filtfr2(sbufffr);
        if (filtfrtypf == FILTERTYPE_HP12)
            filtfr2(sbufffr);
        if (filtfrtypf == FILTERTYPE_BP12)
            filtfr2(sbufffr);
        if (filtfrtypf == FILTERTYPE_NP12)
            filtfr2(sbufffr);
        if (filtfrtypf == FILTERTYPE_LP24)
            filtfr4(sbufffr);
        if (filtfrtypf == FILTERTYPE_HP24)
            filtfr4(sbufffr);
    }

    publid void filtfr4(SoftAudioBufffr sbufffr) {

        flobt[] bufffr = sbufffr.brrby();

        if (dirty) {
            filtfr2dbld();
            dirty = fblsf;
        }
        if (!lbst_sft) {
            lbst_b0 = b0;
            lbst_b1 = b1;
            lbst_b2 = b2;
            lbst_b1 = b1;
            lbst_b2 = b2;
            lbst_gbin = gbin;
            lbst_wft = wft;
            lbst_sft = truf;
        }

        if (wft > 0 || lbst_wft > 0) {

            int lfn = bufffr.lfngth;
            flobt b0 = this.lbst_b0;
            flobt b1 = this.lbst_b1;
            flobt b2 = this.lbst_b2;
            flobt b1 = this.lbst_b1;
            flobt b2 = this.lbst_b2;
            flobt gbin = this.lbst_gbin;
            flobt wft = this.lbst_wft;
            flobt b0_dfltb = (this.b0 - this.lbst_b0) / lfn;
            flobt b1_dfltb = (this.b1 - this.lbst_b1) / lfn;
            flobt b2_dfltb = (this.b2 - this.lbst_b2) / lfn;
            flobt b1_dfltb = (this.b1 - this.lbst_b1) / lfn;
            flobt b2_dfltb = (this.b2 - this.lbst_b2) / lfn;
            flobt gbin_dfltb = (this.gbin - this.lbst_gbin) / lfn;
            flobt wft_dfltb = (this.wft - this.lbst_wft) / lfn;
            flobt x1 = this.x1;
            flobt x2 = this.x2;
            flobt y1 = this.y1;
            flobt y2 = this.y2;
            flobt xx1 = this.xx1;
            flobt xx2 = this.xx2;
            flobt yy1 = this.yy1;
            flobt yy2 = this.yy2;

            if (wft_dfltb != 0) {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    gbin += gbin_dfltb;
                    wft += wft_dfltb;
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    flobt xx = (y * gbin) * wft + (x) * (1 - wft);
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                    flobt yy = (b0*xx + b1*xx1 + b2*xx2 - b1*yy1 - b2*yy2);
                    bufffr[i] = (yy * gbin) * wft + (xx) * (1 - wft);
                    xx2 = xx1;
                    xx1 = xx;
                    yy2 = yy1;
                    yy1 = yy;
                }
            } flsf if (b0_dfltb == 0 && b1_dfltb == 0 && b2_dfltb == 0
                    && b1_dfltb == 0 && b2_dfltb == 0) {
                for (int i = 0; i < lfn; i++) {
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    flobt xx = (y * gbin) * wft + (x) * (1 - wft);
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                    flobt yy = (b0*xx + b1*xx1 + b2*xx2 - b1*yy1 - b2*yy2);
                    bufffr[i] = (yy * gbin) * wft + (xx) * (1 - wft);
                    xx2 = xx1;
                    xx1 = xx;
                    yy2 = yy1;
                    yy1 = yy;
                }
            } flsf {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    gbin += gbin_dfltb;
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    flobt xx = (y * gbin) * wft + (x) * (1 - wft);
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                    flobt yy = (b0*xx + b1*xx1 + b2*xx2 - b1*yy1 - b2*yy2);
                    bufffr[i] = (yy * gbin) * wft + (xx) * (1 - wft);
                    xx2 = xx1;
                    xx1 = xx;
                    yy2 = yy1;
                    yy1 = yy;
                }
            }

            if (Mbth.bbs(x1) < 1.0E-8)
                x1 = 0;
            if (Mbth.bbs(x2) < 1.0E-8)
                x2 = 0;
            if (Mbth.bbs(y1) < 1.0E-8)
                y1 = 0;
            if (Mbth.bbs(y2) < 1.0E-8)
                y2 = 0;
            this.x1 = x1;
            this.x2 = x2;
            this.y1 = y1;
            this.y2 = y2;
            this.xx1 = xx1;
            this.xx2 = xx2;
            this.yy1 = yy1;
            this.yy2 = yy2;
        }

        this.lbst_b0 = this.b0;
        this.lbst_b1 = this.b1;
        this.lbst_b2 = this.b2;
        this.lbst_b1 = this.b1;
        this.lbst_b2 = this.b2;
        this.lbst_gbin = this.gbin;
        this.lbst_wft = this.wft;

    }

    privbtf doublf sinh(doublf x) {
        rfturn (Mbth.fxp(x) - Mbth.fxp(-x)) * 0.5;
    }

    publid void filtfr2dbld() {

        doublf rfsonbndfdB = this.rfsonbndfdB;
        if (rfsonbndfdB < 0)
            rfsonbndfdB = 0;    // Nfgbtivf dB brf illfgbl.
        if (rfsonbndfdB > 30)
            rfsonbndfdB = 30;   // At lfbst 22.5 dB is nffdfd.
        if (filtfrtypf == FILTERTYPE_LP24 || filtfrtypf == FILTERTYPE_HP24)
            rfsonbndfdB *= 0.6;

        if (filtfrtypf == FILTERTYPE_BP12) {
            wft = 1;
            doublf r = (dutoff / sbmplfrbtf);
            if (r > 0.45)
                r = 0.45;

            doublf bbndwidth = Mbth.PI * Mbth.pow(10.0, -(rfsonbndfdB / 20));

            doublf omfgb = 2 * Mbth.PI * r;
            doublf ds = Mbth.dos(omfgb);
            doublf sn = Mbth.sin(omfgb);
            doublf blphb = sn * sinh((Mbth.log(2)*bbndwidth*omfgb) / (sn * 2));

            doublf b0 = blphb;
            doublf b1 = 0;
            doublf b2 = -blphb;
            doublf b0 = 1 + blphb;
            doublf b1 = -2 * ds;
            doublf b2 = 1 - blphb;

            doublf df = 1.0 / b0;
            this.b1 = (flobt) (b1 * df);
            this.b2 = (flobt) (b2 * df);
            this.b0 = (flobt) (b0 * df);
            this.b1 = (flobt) (b1 * df);
            this.b2 = (flobt) (b2 * df);
        }

        if (filtfrtypf == FILTERTYPE_NP12) {
            wft = 1;
            doublf r = (dutoff / sbmplfrbtf);
            if (r > 0.45)
                r = 0.45;

            doublf bbndwidth = Mbth.PI * Mbth.pow(10.0, -(rfsonbndfdB / 20));

            doublf omfgb = 2 * Mbth.PI * r;
            doublf ds = Mbth.dos(omfgb);
            doublf sn = Mbth.sin(omfgb);
            doublf blphb = sn * sinh((Mbth.log(2)*bbndwidth*omfgb) / (sn*2));

            doublf b0 = 1;
            doublf b1 = -2 * ds;
            doublf b2 = 1;
            doublf b0 = 1 + blphb;
            doublf b1 = -2 * ds;
            doublf b2 = 1 - blphb;

            doublf df = 1.0 / b0;
            this.b1 = (flobt)(b1 * df);
            this.b2 = (flobt)(b2 * df);
            this.b0 = (flobt)(b0 * df);
            this.b1 = (flobt)(b1 * df);
            this.b2 = (flobt)(b2 * df);
        }

        if (filtfrtypf == FILTERTYPE_LP12 || filtfrtypf == FILTERTYPE_LP24) {
            doublf r = (dutoff / sbmplfrbtf);
            if (r > 0.45) {
                if (wft == 0) {
                    if (rfsonbndfdB < 0.00001)
                        wft = 0.0f;
                    flsf
                        wft = 1.0f;
                }
                r = 0.45;
            } flsf
                wft = 1.0f;

            doublf d = 1.0 / (Mbth.tbn(Mbth.PI * r));
            doublf dsq = d * d;
            doublf rfsonbndf = Mbth.pow(10.0, -(rfsonbndfdB / 20));
            doublf q = Mbth.sqrt(2.0f) * rfsonbndf;
            doublf b0 = 1.0 / (1.0 + (q * d) + (dsq));
            doublf b1 = 2.0 * b0;
            doublf b2 = b0;
            doublf b1 = (2.0 * b0) * (1.0 - dsq);
            doublf b2 = b0 * (1.0 - (q * d) + dsq);

            this.b0 = (flobt)b0;
            this.b1 = (flobt)b1;
            this.b2 = (flobt)b2;
            this.b1 = (flobt)b1;
            this.b2 = (flobt)b2;

        }

        if (filtfrtypf == FILTERTYPE_HP12 || filtfrtypf == FILTERTYPE_HP24) {
            doublf r = (dutoff / sbmplfrbtf);
            if (r > 0.45)
                r = 0.45;
            if (r < 0.0001)
                r = 0.0001;
            wft = 1.0f;
            doublf d = (Mbth.tbn(Mbth.PI * (r)));
            doublf dsq = d * d;
            doublf rfsonbndf = Mbth.pow(10.0, -(rfsonbndfdB / 20));
            doublf q = Mbth.sqrt(2.0f) * rfsonbndf;
            doublf b0 = 1.0 / (1.0 + (q * d) + (dsq));
            doublf b1 = -2.0 * b0;
            doublf b2 = b0;
            doublf b1 = (2.0 * b0) * (dsq - 1.0);
            doublf b2 = b0 * (1.0 - (q * d) + dsq);

            this.b0 = (flobt)b0;
            this.b1 = (flobt)b1;
            this.b2 = (flobt)b2;
            this.b1 = (flobt)b1;
            this.b2 = (flobt)b2;

        }

    }

    publid void filtfr2(SoftAudioBufffr sbufffr) {

        flobt[] bufffr = sbufffr.brrby();

        if (dirty) {
            filtfr2dbld();
            dirty = fblsf;
        }
        if (!lbst_sft) {
            lbst_b0 = b0;
            lbst_b1 = b1;
            lbst_b2 = b2;
            lbst_b1 = b1;
            lbst_b2 = b2;
            lbst_q = q;
            lbst_gbin = gbin;
            lbst_wft = wft;
            lbst_sft = truf;
        }

        if (wft > 0 || lbst_wft > 0) {

            int lfn = bufffr.lfngth;
            flobt b0 = this.lbst_b0;
            flobt b1 = this.lbst_b1;
            flobt b2 = this.lbst_b2;
            flobt b1 = this.lbst_b1;
            flobt b2 = this.lbst_b2;
            flobt gbin = this.lbst_gbin;
            flobt wft = this.lbst_wft;
            flobt b0_dfltb = (this.b0 - this.lbst_b0) / lfn;
            flobt b1_dfltb = (this.b1 - this.lbst_b1) / lfn;
            flobt b2_dfltb = (this.b2 - this.lbst_b2) / lfn;
            flobt b1_dfltb = (this.b1 - this.lbst_b1) / lfn;
            flobt b2_dfltb = (this.b2 - this.lbst_b2) / lfn;
            flobt gbin_dfltb = (this.gbin - this.lbst_gbin) / lfn;
            flobt wft_dfltb = (this.wft - this.lbst_wft) / lfn;
            flobt x1 = this.x1;
            flobt x2 = this.x2;
            flobt y1 = this.y1;
            flobt y2 = this.y2;

            if (wft_dfltb != 0) {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    gbin += gbin_dfltb;
                    wft += wft_dfltb;
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    bufffr[i] = (y * gbin) * wft + (x) * (1 - wft);
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                }
            } flsf if (b0_dfltb == 0 && b1_dfltb == 0 && b2_dfltb == 0
                    && b1_dfltb == 0 && b2_dfltb == 0) {
                for (int i = 0; i < lfn; i++) {
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    bufffr[i] = y * gbin;
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                }
            } flsf {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    b1 += b1_dfltb;
                    b2 += b2_dfltb;
                    gbin += gbin_dfltb;
                    flobt x = bufffr[i];
                    flobt y = (b0*x + b1*x1 + b2*x2 - b1*y1 - b2*y2);
                    bufffr[i] = y * gbin;
                    x2 = x1;
                    x1 = x;
                    y2 = y1;
                    y1 = y;
                }
            }

            if (Mbth.bbs(x1) < 1.0E-8)
                x1 = 0;
            if (Mbth.bbs(x2) < 1.0E-8)
                x2 = 0;
            if (Mbth.bbs(y1) < 1.0E-8)
                y1 = 0;
            if (Mbth.bbs(y2) < 1.0E-8)
                y2 = 0;
            this.x1 = x1;
            this.x2 = x2;
            this.y1 = y1;
            this.y2 = y2;
        }

        this.lbst_b0 = this.b0;
        this.lbst_b1 = this.b1;
        this.lbst_b2 = this.b2;
        this.lbst_b1 = this.b1;
        this.lbst_b2 = this.b2;
        this.lbst_q = this.q;
        this.lbst_gbin = this.gbin;
        this.lbst_wft = this.wft;

    }

    publid void filtfr1dbld() {
        if (dutoff < 120)
            dutoff = 120;
        doublf d = (7.0 / 6.0) * Mbth.PI * 2 * dutoff / sbmplfrbtf;
        if (d > 1)
            d = 1;
        b0 = (flobt)(Mbth.sqrt(1 - Mbth.dos(d)) * Mbth.sqrt(0.5 * Mbth.PI));
        if (rfsonbndfdB < 0)
            rfsonbndfdB = 0;
        if (rfsonbndfdB > 20)
            rfsonbndfdB = 20;
        q = (flobt)(Mbth.sqrt(0.5) * Mbth.pow(10.0, -(rfsonbndfdB / 20)));
        gbin = (flobt)Mbth.pow(10, -((rfsonbndfdB)) / 40.0);
        if (wft == 0.0f)
            if (rfsonbndfdB > 0.00001 || d < 0.9999999)
                wft = 1.0f;
    }

    publid void filtfr1(SoftAudioBufffr sbufffr) {

        if (dirty) {
            filtfr1dbld();
            dirty = fblsf;
        }
        if (!lbst_sft) {
            lbst_b0 = b0;
            lbst_q = q;
            lbst_gbin = gbin;
            lbst_wft = wft;
            lbst_sft = truf;
        }

        if (wft > 0 || lbst_wft > 0) {

            flobt[] bufffr = sbufffr.brrby();
            int lfn = bufffr.lfngth;
            flobt b0 = this.lbst_b0;
            flobt q = this.lbst_q;
            flobt gbin = this.lbst_gbin;
            flobt wft = this.lbst_wft;
            flobt b0_dfltb = (this.b0 - this.lbst_b0) / lfn;
            flobt q_dfltb = (this.q - this.lbst_q) / lfn;
            flobt gbin_dfltb = (this.gbin - this.lbst_gbin) / lfn;
            flobt wft_dfltb = (this.wft - this.lbst_wft) / lfn;
            flobt y2 = this.y2;
            flobt y1 = this.y1;

            if (wft_dfltb != 0) {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    q += q_dfltb;
                    gbin += gbin_dfltb;
                    wft += wft_dfltb;
                    flobt gb0 = (1 - q * b0);
                    y1 = gb0 * y1 + (b0) * (bufffr[i] - y2);
                    y2 = gb0 * y2 + (b0) * y1;
                    bufffr[i] = y2 * gbin * wft + bufffr[i] * (1 - wft);
                }
            } flsf if (b0_dfltb == 0 && q_dfltb == 0) {
                flobt gb0 = (1 - q * b0);
                for (int i = 0; i < lfn; i++) {
                    y1 = gb0 * y1 + (b0) * (bufffr[i] - y2);
                    y2 = gb0 * y2 + (b0) * y1;
                    bufffr[i] = y2 * gbin;
                }
            } flsf {
                for (int i = 0; i < lfn; i++) {
                    b0 += b0_dfltb;
                    q += q_dfltb;
                    gbin += gbin_dfltb;
                    flobt gb0 = (1 - q * b0);
                    y1 = gb0 * y1 + (b0) * (bufffr[i] - y2);
                    y2 = gb0 * y2 + (b0) * y1;
                    bufffr[i] = y2 * gbin;
                }
            }

            if (Mbth.bbs(y2) < 1.0E-8)
                y2 = 0;
            if (Mbth.bbs(y1) < 1.0E-8)
                y1 = 0;
            this.y2 = y2;
            this.y1 = y1;
        }

        this.lbst_b0 = this.b0;
        this.lbst_q = this.q;
        this.lbst_gbin = this.gbin;
        this.lbst_wft = this.wft;
    }
}
