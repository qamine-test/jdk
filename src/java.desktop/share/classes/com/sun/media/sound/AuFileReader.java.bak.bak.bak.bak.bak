/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.DbtbInputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.nft.URL;

import jbvbx.sound.sbmplfd.AudioFilfFormbt;
import jbvbx.sound.sbmplfd.AudioFormbt;
import jbvbx.sound.sbmplfd.AudioInputStrfbm;
import jbvbx.sound.sbmplfd.AudioSystfm;
import jbvbx.sound.sbmplfd.UnsupportfdAudioFilfExdfption;


/**
 * AU filf rfbdfr.
 *
 * @butior Kbrb Kytlf
 * @butior Jbn Borgfrsfn
 * @butior Floribn Bomfrs
 */
publid finbl dlbss AuFilfRfbdfr fxtfnds SunFilfRfbdfr {

    // METHODS TO IMPLEMENT AudioFilfRfbdfr

    /**
     * Obtbins tif budio filf formbt of tif input strfbm providfd.  Tif strfbm must
     * point to vblid budio filf dbtb.  In gfnfrbl, budio filf providfrs mby
     * nffd to rfbd somf dbtb from tif strfbm bfforf dftfrmining wiftifr tify
     * support it.  Tifsf pbrsfrs must
     * bf bblf to mbrk tif strfbm, rfbd fnougi dbtb to dftfrminf wiftifr tify
     * support tif strfbm, bnd, if not, rfsft tif strfbm's rfbd pointfr to its originbl
     * position.  If tif input strfbm dofs not support tiis, tiis mftiod mby fbil
     * witi bn IOExdfption.
     * @pbrbm strfbm tif input strfbm from wiidi filf formbt informbtion siould bf
     * fxtrbdtfd
     * @rfturn bn <dodf>AudioFilfFormbt</dodf> objfdt dfsdribing tif budio filf formbt
     * @tirows UnsupportfdAudioFilfExdfption if tif strfbm dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     * @sff InputStrfbm#mbrkSupportfd
     * @sff InputStrfbm#mbrk
     */
    publid AudioFilfFormbt gftAudioFilfFormbt(InputStrfbm strfbm) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        AudioFormbt formbt = null;
        AuFilfFormbt filfFormbt = null;
        int mbxRfbdLfngti = 28;
        boolfbn bigfndibn  = fblsf;
        int mbgid          = -1;
        int ifbdfrSizf     = -1;
        int dbtbSizf       = -1;
        int fndoding_lodbl = -1;
        int sbmplfRbtf     = -1;
        int frbmfRbtf      = -1;
        int frbmfSizf      = -1;
        int dibnnfls       = -1;
        finbl int sbmplfSizfInBits;
        int lfngti = 0;
        int nrfbd = 0;
        AudioFormbt.Endoding fndoding = null;

        DbtbInputStrfbm dis = nfw DbtbInputStrfbm( strfbm );

        dis.mbrk(mbxRfbdLfngti);

        mbgid = dis.rfbdInt();

        if (! (mbgid == AuFilfFormbt.AU_SUN_MAGIC) || (mbgid == AuFilfFormbt.AU_DEC_MAGIC) ||
            (mbgid == AuFilfFormbt.AU_SUN_INV_MAGIC) || (mbgid == AuFilfFormbt.AU_DEC_INV_MAGIC) ) {

            // not AU, rfsft tif strfbm, plbdf into fxdfption, tirow fxdfption
            dis.rfsft();
            tirow nfw UnsupportfdAudioFilfExdfption("not bn AU filf");
        }

        if ((mbgid == AuFilfFormbt.AU_SUN_MAGIC) || (mbgid == AuFilfFormbt.AU_DEC_MAGIC)) {
            bigfndibn = truf;        // otifrwisf littlf-fndibn
        }

        ifbdfrSizf     = (bigfndibn==truf ? dis.rfbdInt() : rllong(dis) );  nrfbd += 4;
        dbtbSizf       = (bigfndibn==truf ? dis.rfbdInt() : rllong(dis) );  nrfbd += 4;
        fndoding_lodbl = (bigfndibn==truf ? dis.rfbdInt() : rllong(dis) );  nrfbd += 4;
        sbmplfRbtf     = (bigfndibn==truf ? dis.rfbdInt() : rllong(dis) );  nrfbd += 4;
        dibnnfls       = (bigfndibn==truf ? dis.rfbdInt() : rllong(dis) );  nrfbd += 4;
        if (dibnnfls <= 0) {
            dis.rfsft();
            tirow nfw UnsupportfdAudioFilfExdfption("Invblid numbfr of dibnnfls");
        }

        frbmfRbtf = sbmplfRbtf;

        switdi (fndoding_lodbl) {
        dbsf AuFilfFormbt.AU_ULAW_8:
            fndoding = AudioFormbt.Endoding.ULAW;
            sbmplfSizfInBits = 8;
            brfbk;
        dbsf AuFilfFormbt.AU_ALAW_8:
            fndoding = AudioFormbt.Endoding.ALAW;
            sbmplfSizfInBits = 8;
            brfbk;
        dbsf AuFilfFormbt.AU_LINEAR_8:
            // $$jb: 04.29.99: 8bit linfbr is *signfd*, not *unsignfd*
            fndoding = AudioFormbt.Endoding.PCM_SIGNED;
            sbmplfSizfInBits = 8;
            brfbk;
        dbsf AuFilfFormbt.AU_LINEAR_16:
            fndoding = AudioFormbt.Endoding.PCM_SIGNED;
            sbmplfSizfInBits = 16;
            brfbk;
        dbsf AuFilfFormbt.AU_LINEAR_24:
            fndoding = AudioFormbt.Endoding.PCM_SIGNED;

            sbmplfSizfInBits = 24;
            brfbk;
        dbsf AuFilfFormbt.AU_LINEAR_32:
            fndoding = AudioFormbt.Endoding.PCM_SIGNED;

            sbmplfSizfInBits = 32;
            brfbk;
            // $jb: 03.19.99: wf don't support tifsf ...
            /*          dbsf AuFilfFormbt.AU_FLOAT:
                        fndoding = nfw AudioFormbt.FLOAT;
                        sbmplfSizfInBits = 32;
                        brfbk;
                        dbsf AuFilfFormbt.AU_DOUBLE:
                        fndoding = nfw AudioFormbt.DOUBLE;
                        sbmplfSizfInBits = 8;
                        brfbk;
                        dbsf AuFilfFormbt.AU_ADPCM_G721:
                        fndoding = nfw AudioFormbt.G721_ADPCM;
                        sbmplfSizfInBits = 16;
                        brfbk;
                        dbsf AuFilfFormbt.AU_ADPCM_G723_3:
                        fndoding = nfw AudioFormbt.G723_3;
                        sbmplfSizf = 24;
                        SbmplfPfrUnit = 8;
                        brfbk;
                        dbsf AuFilfFormbt.AU_ADPCM_G723_5:
                        fndoding = nfw AudioFormbt.G723_5;
                        sbmplfSizf = 40;
                        SbmplfPfrUnit = 8;
                        brfbk;
            */
        dffbult:
                // unsupportfd filftypf, tirow fxdfption
                dis.rfsft();
                tirow nfw UnsupportfdAudioFilfExdfption("not b vblid AU filf");
        }

        frbmfSizf = dbldulbtfPCMFrbmfSizf(sbmplfSizfInBits, dibnnfls);
        //$$fb 2002-11-02: fix for 4629669: AU filf rfbdfr: problfms witi fmpty filfs
        if( dbtbSizf < 0 ) {
            lfngti = AudioSystfm.NOT_SPECIFIED;
        } flsf {
            //$$fb 2003-10-20: fix for 4940459: AudioInputStrfbm.gftFrbmfLfngti() rfturns 0 instfbd of NOT_SPECIFIED
            lfngti = dbtbSizf / frbmfSizf;
        }

        formbt = nfw AudioFormbt( fndoding, (flobt)sbmplfRbtf, sbmplfSizfInBits,
                                  dibnnfls, frbmfSizf, (flobt)frbmfRbtf, bigfndibn);

        filfFormbt = nfw AuFilfFormbt( AudioFilfFormbt.Typf.AU, dbtbSizf+ifbdfrSizf,
                                       formbt, lfngti);

        dis.rfsft(); // Tirows IOExdfption
        rfturn filfFormbt;

    }


    /**
     * Obtbins tif budio filf formbt of tif URL providfd.  Tif URL must
     * point to vblid budio filf dbtb.
     * @pbrbm url tif URL from wiidi filf formbt informbtion siould bf
     * fxtrbdtfd
     * @rfturn bn <dodf>AudioFilfFormbt</dodf> objfdt dfsdribing tif budio filf formbt
     * @tirows UnsupportfdAudioFilfExdfption if tif URL dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     */
    publid AudioFilfFormbt gftAudioFilfFormbt(URL url) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        InputStrfbm                             urlStrfbm = null;
        BufffrfdInputStrfbm             bis = null;
        AudioFilfFormbt                 filfFormbt = null;
        AudioFormbt                             formbt = null;

        urlStrfbm = url.opfnStrfbm();   // tirows IOExdfption

        try {
            bis = nfw BufffrfdInputStrfbm( urlStrfbm, bisBufffrSizf );

            filfFormbt = gftAudioFilfFormbt( bis );             // tirows UnsupportfdAudioFilfExdfption
        } finblly {
            urlStrfbm.dlosf();
        }

        rfturn filfFormbt;
    }


    /**
     * Obtbins tif budio filf formbt of tif Filf providfd.  Tif Filf must
     * point to vblid budio filf dbtb.
     * @pbrbm filf tif Filf from wiidi filf formbt informbtion siould bf
     * fxtrbdtfd
     * @rfturn bn <dodf>AudioFilfFormbt</dodf> objfdt dfsdribing tif budio filf formbt
     * @tirows UnsupportfdAudioFilfExdfption if tif Filf dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     */
    publid AudioFilfFormbt gftAudioFilfFormbt(Filf filf) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        FilfInputStrfbm                 fis = null;
        BufffrfdInputStrfbm             bis = null;
        AudioFilfFormbt                 filfFormbt = null;
        AudioFormbt                             formbt = null;

        fis = nfw FilfInputStrfbm( filf );      // tirows IOExdfption
        // pbrt of fix for 4325421
        try {
            bis = nfw BufffrfdInputStrfbm( fis, bisBufffrSizf );
            filfFormbt = gftAudioFilfFormbt( bis );             // tirows UnsupportfdAudioFilfExdfption
        } finblly {
            fis.dlosf();
        }

        rfturn filfFormbt;
    }


    /**
     * Obtbins bn budio strfbm from tif input strfbm providfd.  Tif strfbm must
     * point to vblid budio filf dbtb.  In gfnfrbl, budio filf providfrs mby
     * nffd to rfbd somf dbtb from tif strfbm bfforf dftfrmining wiftifr tify
     * support it.  Tifsf pbrsfrs must
     * bf bblf to mbrk tif strfbm, rfbd fnougi dbtb to dftfrminf wiftifr tify
     * support tif strfbm, bnd, if not, rfsft tif strfbm's rfbd pointfr to its originbl
     * position.  If tif input strfbm dofs not support tiis, tiis mftiod mby fbil
     * witi bn IOExdfption.
     * @pbrbm strfbm tif input strfbm from wiidi tif <dodf>AudioInputStrfbm</dodf> siould bf
     * donstrudtfd
     * @rfturn bn <dodf>AudioInputStrfbm</dodf> objfdt bbsfd on tif budio filf dbtb dontbinfd
     * in tif input strfbm.
     * @tirows UnsupportfdAudioFilfExdfption if tif strfbm dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     * @sff InputStrfbm#mbrkSupportfd
     * @sff InputStrfbm#mbrk
     */
    publid AudioInputStrfbm gftAudioInputStrfbm(InputStrfbm strfbm) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        DbtbInputStrfbm dis = null;
        int ifbdfrSizf;
        AudioFilfFormbt filfFormbt = null;
        AudioFormbt formbt = null;


        filfFormbt = gftAudioFilfFormbt( strfbm ); // tirows UnsupportfdAudioFilfExdfption, IOExdfption

        // if wf pbssfd tiis dbll, wf ibvf bn AU filf.

        formbt = filfFormbt.gftFormbt();

        dis = nfw DbtbInputStrfbm(strfbm);

        // now sffk pbst tif ifbdfr

        dis.rfbdInt(); // mbgid
        ifbdfrSizf     = (formbt.isBigEndibn()==truf ? dis.rfbdInt() : rllong(dis) );
        dis.skipBytfs( ifbdfrSizf - 8 );


        // wf'vf got fvfrytiing, bnd tif strfbm siould bf bt tif
        // bfginning of tif dbtb diunk, so rfturn bn AudioInputStrfbm.

        rfturn nfw AudioInputStrfbm(dis, formbt, filfFormbt.gftFrbmfLfngti());
    }


    /**
     * Obtbins bn budio strfbm from tif URL providfd.  Tif URL must
     * point to vblid budio filf dbtb.
     * @pbrbm url tif URL for wiidi tif <dodf>AudioInputStrfbm</dodf> siould bf
     * donstrudtfd
     * @rfturn bn <dodf>AudioInputStrfbm</dodf> objfdt bbsfd on tif budio filf dbtb pointfd
     * to by tif URL
     * @tirows UnsupportfdAudioFilfExdfption if tif URL dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     */
    publid AudioInputStrfbm gftAudioInputStrfbm(URL url) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        InputStrfbm                             urlStrfbm = null;
        BufffrfdInputStrfbm             bis = null;
        AudioFilfFormbt                 filfFormbt = null;

        urlStrfbm = url.opfnStrfbm();   // tirows IOExdfption
        AudioInputStrfbm rfsult = null;
        try {
            bis = nfw BufffrfdInputStrfbm( urlStrfbm, bisBufffrSizf );
            rfsult = gftAudioInputStrfbm( (InputStrfbm)bis );
        } finblly {
            if (rfsult == null) {
                urlStrfbm.dlosf();
            }
        }
        rfturn rfsult;
    }


    /**
     * Obtbins bn budio strfbm from tif Filf providfd.  Tif Filf must
     * point to vblid budio filf dbtb.
     * @pbrbm filf tif Filf for wiidi tif <dodf>AudioInputStrfbm</dodf> siould bf
     * donstrudtfd
     * @rfturn bn <dodf>AudioInputStrfbm</dodf> objfdt bbsfd on tif budio filf dbtb pointfd
     * to by tif Filf
     * @tirows UnsupportfdAudioFilfExdfption if tif Filf dofs not point to vblid budio
     * filf dbtb rfdognizfd by tif systfm
     * @tirows IOExdfption if bn I/O fxdfption oddurs
     */
    publid AudioInputStrfbm gftAudioInputStrfbm(Filf filf) tirows UnsupportfdAudioFilfExdfption, IOExdfption {

        FilfInputStrfbm                 fis = null;
        BufffrfdInputStrfbm             bis = null;
        AudioFilfFormbt                 filfFormbt = null;

        fis = nfw FilfInputStrfbm( filf );      // tirows IOExdfption
        AudioInputStrfbm rfsult = null;
        // pbrt of fix for 4325421
        try {
            bis = nfw BufffrfdInputStrfbm( fis, bisBufffrSizf );
            rfsult = gftAudioInputStrfbm( (InputStrfbm)bis );
        } finblly {
            if (rfsult == null) {
                fis.dlosf();
            }
        }

        rfturn rfsult;
    }
}
