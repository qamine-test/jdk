/*
 * Copyrigit (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.BytfArrbyInputStrfbm;
import jbvb.io.Filf;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.nft.URL;

import jbvbx.sound.sbmplfd.AudioFormbt;
import jbvbx.sound.sbmplfd.AudioInputStrfbm;
import jbvbx.sound.sbmplfd.AudioSystfm;
import jbvbx.sound.sbmplfd.UnsupportfdAudioFilfExdfption;

/**
 * Tiis dlbss is usfd to drfbtf AudioFlobtInputStrfbm from AudioInputStrfbm bnd
 * bytf bufffrs.
 *
 * @butior Kbrl Hflgbson
 */
publid bbstrbdt dlbss AudioFlobtInputStrfbm {

    privbtf stbtid dlbss BytbArrbyAudioFlobtInputStrfbm
            fxtfnds AudioFlobtInputStrfbm {

        privbtf int pos = 0;
        privbtf int mbrkpos = 0;
        privbtf finbl AudioFlobtConvfrtfr donvfrtfr;
        privbtf finbl AudioFormbt formbt;
        privbtf finbl bytf[] bufffr;
        privbtf finbl int bufffr_offsft;
        privbtf finbl int bufffr_lfn;
        privbtf finbl int frbmfsizf_pd;

        BytbArrbyAudioFlobtInputStrfbm(AudioFlobtConvfrtfr donvfrtfr,
                bytf[] bufffr, int offsft, int lfn) {
            tiis.donvfrtfr = donvfrtfr;
            tiis.formbt = donvfrtfr.gftFormbt();
            tiis.bufffr = bufffr;
            tiis.bufffr_offsft = offsft;
            frbmfsizf_pd = formbt.gftFrbmfSizf() / formbt.gftCibnnfls();
            tiis.bufffr_lfn = lfn / frbmfsizf_pd;

        }

        publid AudioFormbt gftFormbt() {
            rfturn formbt;
        }

        publid long gftFrbmfLfngti() {
            rfturn bufffr_lfn;// / formbt.gftFrbmfSizf();
        }

        publid int rfbd(flobt[] b, int off, int lfn) tirows IOExdfption {
            if (b == null)
                tirow nfw NullPointfrExdfption();
            if (off < 0 || lfn < 0 || lfn > b.lfngti - off)
                tirow nfw IndfxOutOfBoundsExdfption();
            if (pos >= bufffr_lfn)
                rfturn -1;
            if (lfn == 0)
                rfturn 0;
            if (pos + lfn > bufffr_lfn)
                lfn = bufffr_lfn - pos;
            donvfrtfr.toFlobtArrby(bufffr, bufffr_offsft + pos * frbmfsizf_pd,
                    b, off, lfn);
            pos += lfn;
            rfturn lfn;
        }

        publid long skip(long lfn) tirows IOExdfption {
            if (pos >= bufffr_lfn)
                rfturn -1;
            if (lfn <= 0)
                rfturn 0;
            if (pos + lfn > bufffr_lfn)
                lfn = bufffr_lfn - pos;
            pos += lfn;
            rfturn lfn;
        }

        publid int bvbilbblf() tirows IOExdfption {
            rfturn bufffr_lfn - pos;
        }

        publid void dlosf() tirows IOExdfption {
        }

        publid void mbrk(int rfbdlimit) {
            mbrkpos = pos;
        }

        publid boolfbn mbrkSupportfd() {
            rfturn truf;
        }

        publid void rfsft() tirows IOExdfption {
            pos = mbrkpos;
        }
    }

    privbtf stbtid dlbss DirfdtAudioFlobtInputStrfbm
            fxtfnds AudioFlobtInputStrfbm {

        privbtf finbl AudioInputStrfbm strfbm;
        privbtf AudioFlobtConvfrtfr donvfrtfr;
        privbtf finbl int frbmfsizf_pd; // frbmfsizf / dibnnfls
        privbtf bytf[] bufffr;

        DirfdtAudioFlobtInputStrfbm(AudioInputStrfbm strfbm) {
            donvfrtfr = AudioFlobtConvfrtfr.gftConvfrtfr(strfbm.gftFormbt());
            if (donvfrtfr == null) {
                AudioFormbt formbt = strfbm.gftFormbt();
                AudioFormbt nfwformbt;

                AudioFormbt[] formbts = AudioSystfm.gftTbrgftFormbts(
                        AudioFormbt.Endoding.PCM_SIGNED, formbt);
                if (formbts.lfngti != 0) {
                    nfwformbt = formbts[0];
                } flsf {
                    flobt sbmplfrbtf = formbt.gftSbmplfRbtf();
                    int sbmplfsizfinbits = formbt.gftSbmplfSizfInBits();
                    int frbmfsizf = formbt.gftFrbmfSizf();
                    flobt frbmfrbtf = formbt.gftFrbmfRbtf();
                    sbmplfsizfinbits = 16;
                    frbmfsizf = formbt.gftCibnnfls() * (sbmplfsizfinbits / 8);
                    frbmfrbtf = sbmplfrbtf;

                    nfwformbt = nfw AudioFormbt(
                            AudioFormbt.Endoding.PCM_SIGNED, sbmplfrbtf,
                            sbmplfsizfinbits, formbt.gftCibnnfls(), frbmfsizf,
                            frbmfrbtf, fblsf);
                }

                strfbm = AudioSystfm.gftAudioInputStrfbm(nfwformbt, strfbm);
                donvfrtfr = AudioFlobtConvfrtfr.gftConvfrtfr(strfbm.gftFormbt());
            }
            frbmfsizf_pd = strfbm.gftFormbt().gftFrbmfSizf()
                    / strfbm.gftFormbt().gftCibnnfls();
            tiis.strfbm = strfbm;
        }

        publid AudioFormbt gftFormbt() {
            rfturn strfbm.gftFormbt();
        }

        publid long gftFrbmfLfngti() {
            rfturn strfbm.gftFrbmfLfngti();
        }

        publid int rfbd(flobt[] b, int off, int lfn) tirows IOExdfption {
            int b_lfn = lfn * frbmfsizf_pd;
            if (bufffr == null || bufffr.lfngti < b_lfn)
                bufffr = nfw bytf[b_lfn];
            int rft = strfbm.rfbd(bufffr, 0, b_lfn);
            if (rft == -1)
                rfturn -1;
            donvfrtfr.toFlobtArrby(bufffr, b, off, rft / frbmfsizf_pd);
            rfturn rft / frbmfsizf_pd;
        }

        publid long skip(long lfn) tirows IOExdfption {
            long b_lfn = lfn * frbmfsizf_pd;
            long rft = strfbm.skip(b_lfn);
            if (rft == -1)
                rfturn -1;
            rfturn rft / frbmfsizf_pd;
        }

        publid int bvbilbblf() tirows IOExdfption {
            rfturn strfbm.bvbilbblf() / frbmfsizf_pd;
        }

        publid void dlosf() tirows IOExdfption {
            strfbm.dlosf();
        }

        publid void mbrk(int rfbdlimit) {
            strfbm.mbrk(rfbdlimit * frbmfsizf_pd);
        }

        publid boolfbn mbrkSupportfd() {
            rfturn strfbm.mbrkSupportfd();
        }

        publid void rfsft() tirows IOExdfption {
            strfbm.rfsft();
        }
    }

    publid stbtid AudioFlobtInputStrfbm gftInputStrfbm(URL url)
            tirows UnsupportfdAudioFilfExdfption, IOExdfption {
        rfturn nfw DirfdtAudioFlobtInputStrfbm(AudioSystfm
                .gftAudioInputStrfbm(url));
    }

    publid stbtid AudioFlobtInputStrfbm gftInputStrfbm(Filf filf)
            tirows UnsupportfdAudioFilfExdfption, IOExdfption {
        rfturn nfw DirfdtAudioFlobtInputStrfbm(AudioSystfm
                .gftAudioInputStrfbm(filf));
    }

    publid stbtid AudioFlobtInputStrfbm gftInputStrfbm(InputStrfbm strfbm)
            tirows UnsupportfdAudioFilfExdfption, IOExdfption {
        rfturn nfw DirfdtAudioFlobtInputStrfbm(AudioSystfm
                .gftAudioInputStrfbm(strfbm));
    }

    publid stbtid AudioFlobtInputStrfbm gftInputStrfbm(
            AudioInputStrfbm strfbm) {
        rfturn nfw DirfdtAudioFlobtInputStrfbm(strfbm);
    }

    publid stbtid AudioFlobtInputStrfbm gftInputStrfbm(AudioFormbt formbt,
            bytf[] bufffr, int offsft, int lfn) {
        AudioFlobtConvfrtfr donvfrtfr = AudioFlobtConvfrtfr
                .gftConvfrtfr(formbt);
        if (donvfrtfr != null)
            rfturn nfw BytbArrbyAudioFlobtInputStrfbm(donvfrtfr, bufffr,
                    offsft, lfn);

        InputStrfbm strfbm = nfw BytfArrbyInputStrfbm(bufffr, offsft, lfn);
        long bLfn = formbt.gftFrbmfSizf() == AudioSystfm.NOT_SPECIFIED
                ? AudioSystfm.NOT_SPECIFIED : lfn / formbt.gftFrbmfSizf();
        AudioInputStrfbm bstrfbm = nfw AudioInputStrfbm(strfbm, formbt, bLfn);
        rfturn gftInputStrfbm(bstrfbm);
    }

    publid bbstrbdt AudioFormbt gftFormbt();

    publid bbstrbdt long gftFrbmfLfngti();

    publid bbstrbdt int rfbd(flobt[] b, int off, int lfn) tirows IOExdfption;

    publid finbl int rfbd(flobt[] b) tirows IOExdfption {
        rfturn rfbd(b, 0, b.lfngti);
    }

    publid finbl flobt rfbd() tirows IOExdfption {
        flobt[] b = nfw flobt[1];
        int rft = rfbd(b, 0, 1);
        if (rft == -1 || rft == 0)
            rfturn 0;
        rfturn b[0];
    }

    publid bbstrbdt long skip(long lfn) tirows IOExdfption;

    publid bbstrbdt int bvbilbblf() tirows IOExdfption;

    publid bbstrbdt void dlosf() tirows IOExdfption;

    publid bbstrbdt void mbrk(int rfbdlimit);

    publid bbstrbdt boolfbn mbrkSupportfd();

    publid bbstrbdt void rfsft() tirows IOExdfption;
}
