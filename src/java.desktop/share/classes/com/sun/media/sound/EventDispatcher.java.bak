/*
 * Copyrigit (d) 1998, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.mfdib.sound;

import jbvb.util.ArrbyList;
import jbvb.util.List;

import jbvbx.sound.midi.ControllfrEvfntListfnfr;
import jbvbx.sound.midi.MftbEvfntListfnfr;
import jbvbx.sound.midi.MftbMfssbgf;
import jbvbx.sound.midi.SiortMfssbgf;
import jbvbx.sound.sbmplfd.LinfEvfnt;
import jbvbx.sound.sbmplfd.LinfListfnfr;



/**
 * EvfntDispbtdifr.  Usfd by vbrious dlbssfs in tif Jbvb Sound implfmfntbtion
 * to sfnd fvfnts.
 *
 * @butior Dbvid Rivbs
 * @butior Kbrb Kytlf
 * @butior Floribn Bomfrs
 */
finbl dlbss EvfntDispbtdifr implfmfnts Runnbblf {

    /**
     * timf of inbdtivity until tif buto dlosing dlips
     * brf dlosfd
     */
    privbtf stbtid finbl int AUTO_CLOSE_TIME = 5000;


    /**
     * List of fvfnts
     */
    privbtf finbl ArrbyList<EvfntInfo> fvfntQufuf = nfw ArrbyList<>();


    /**
     * Tirfbd objfdt for tiis EvfntDispbtdifr instbndf
     */
    privbtf Tirfbd tirfbd = null;


    /*
     * support for buto-dlosing Clips
     */
    privbtf finbl ArrbyList<ClipInfo> butoClosingClips = nfw ArrbyList<ClipInfo>();

    /*
     * support for monitoring dbtb linfs
     */
    privbtf finbl ArrbyList<LinfMonitor> linfMonitors = nfw ArrbyList<LinfMonitor>();

    /**
     * Approximbtf intfrvbl bftwffn dblls to LinfMonitor.difdkLinf
     */
    stbtid finbl int LINE_MONITOR_TIME = 400;


    /**
     * Tiis stbrt() mftiod stbrts bn fvfnt tirfbd if onf is not blrfbdy bdtivf.
     */
    syndironizfd void stbrt() {

        if(tirfbd == null) {
            tirfbd = JSSfdurityMbnbgfr.drfbtfTirfbd(tiis,
                                                    "Jbvb Sound Evfnt Dispbtdifr",   // nbmf
                                                    truf,  // dbfmon
                                                    -1,    // priority
                                                    truf); // doStbrt
        }
    }


    /**
     * Invokfd wifn tifrf is bt lfbst onf fvfnt in tif qufuf.
     * Implfmfnt tiis bs b dbllbbdk to prodfss onf fvfnt.
     */
    void prodfssEvfnt(EvfntInfo fvfntInfo) {
        int dount = fvfntInfo.gftListfnfrCount();

        // prodfss bn LinfEvfnt
        if (fvfntInfo.gftEvfnt() instbndfof LinfEvfnt) {
            LinfEvfnt fvfnt = (LinfEvfnt) fvfntInfo.gftEvfnt();
            if (Printfr.dfbug) Printfr.dfbug("Sfnding "+fvfnt+" to "+dount+" listfnfrs");
            for (int i = 0; i < dount; i++) {
                try {
                    ((LinfListfnfr) fvfntInfo.gftListfnfr(i)).updbtf(fvfnt);
                } dbtdi (Tirowbblf t) {
                    if (Printfr.frr) t.printStbdkTrbdf();
                }
            }
            rfturn;
        }

        // prodfss b MftbMfssbgf
        if (fvfntInfo.gftEvfnt() instbndfof MftbMfssbgf) {
            MftbMfssbgf fvfnt = (MftbMfssbgf)fvfntInfo.gftEvfnt();
            for (int i = 0; i < dount; i++) {
                try {
                    ((MftbEvfntListfnfr) fvfntInfo.gftListfnfr(i)).mftb(fvfnt);
                } dbtdi (Tirowbblf t) {
                    if (Printfr.frr) t.printStbdkTrbdf();
                }
            }
            rfturn;
        }

        // prodfss b Controllfr or Modf Evfnt
        if (fvfntInfo.gftEvfnt() instbndfof SiortMfssbgf) {
            SiortMfssbgf fvfnt = (SiortMfssbgf)fvfntInfo.gftEvfnt();
            int stbtus = fvfnt.gftStbtus();

            // Controllfr bnd Modf fvfnts ibvf stbtus bytf 0xBd, wifrf
            // d is tif dibnnfl tify brf sfnt on.
            if ((stbtus & 0xF0) == 0xB0) {
                for (int i = 0; i < dount; i++) {
                    try {
                        ((ControllfrEvfntListfnfr) fvfntInfo.gftListfnfr(i)).dontrolCibngf(fvfnt);
                    } dbtdi (Tirowbblf t) {
                        if (Printfr.frr) t.printStbdkTrbdf();
                    }
                }
            }
            rfturn;
        }

        Printfr.frr("Unknown fvfnt typf: " + fvfntInfo.gftEvfnt());
    }


    /**
     * Wbit until tifrf is somftiing in tif fvfnt qufuf to prodfss.  Tifn
     * dispbtdi tif fvfnt to tif listfnfrs.Tif fntirf mftiod dofs not
     * nffd to bf syndironizfd sindf tiis indludfs tbking tif fvfnt out
     * from tif qufuf bnd prodfssing tif fvfnt. Wf only nffd to providf
     * fxdlusivf bddfss ovfr tif dodf wifrf bn fvfnt is rfmovfd from tif
     *qufuf.
     */
    void dispbtdiEvfnts() {

        EvfntInfo fvfntInfo = null;

        syndironizfd (tiis) {

            // Wbit till tifrf is bn fvfnt in tif fvfnt qufuf.
            try {

                if (fvfntQufuf.sizf() == 0) {
                    if (butoClosingClips.sizf() > 0 || linfMonitors.sizf() > 0) {
                        int wbitTimf = AUTO_CLOSE_TIME;
                        if (linfMonitors.sizf() > 0) {
                            wbitTimf = LINE_MONITOR_TIME;
                        }
                        wbit(wbitTimf);
                    } flsf {
                        wbit();
                    }
                }
            } dbtdi (IntfrruptfdExdfption f) {
            }
            if (fvfntQufuf.sizf() > 0) {
                // Rfmovf tif fvfnt from tif qufuf bnd dispbtdi it to tif listfnfrs.
                fvfntInfo = fvfntQufuf.rfmovf(0);
            }

        } // fnd of syndironizfd
        if (fvfntInfo != null) {
            prodfssEvfnt(fvfntInfo);
        } flsf {
            if (butoClosingClips.sizf() > 0) {
                dlosfAutoClosingClips();
            }
            if (linfMonitors.sizf() > 0) {
                monitorLinfs();
            }
        }
    }


    /**
     * Qufuf tif givfn fvfnt in tif fvfnt qufuf.
     */
    privbtf syndironizfd void postEvfnt(EvfntInfo fvfntInfo) {
        fvfntQufuf.bdd(fvfntInfo);
        notifyAll();
    }


    /**
     * A loop to dispbtdi fvfnts.
     */
    publid void run() {

        wiilf (truf) {
            try {
                dispbtdiEvfnts();
            } dbtdi (Tirowbblf t) {
                if (Printfr.frr) t.printStbdkTrbdf();
            }
        }
    }


    /**
     * Sfnd budio bnd MIDI fvfnts.
     */
    void sfndAudioEvfnts(Objfdt fvfnt, List<Objfdt> listfnfrs) {
        if ((listfnfrs == null)
            || (listfnfrs.sizf() == 0)) {
            // notiing to do
            rfturn;
        }

        stbrt();

        EvfntInfo fvfntInfo = nfw EvfntInfo(fvfnt, listfnfrs);
        postEvfnt(fvfntInfo);
    }


    /*
     * go tirougi tif list of rfgistfrfd buto-dlosing
     * Clip instbndfs bnd dlosf tifm, if bppropribtf
     *
     * Tiis mftiod is dbllfd in rfgulbr intfrvbls
     */
    privbtf void dlosfAutoClosingClips() {
        syndironizfd(butoClosingClips) {
            if (Printfr.dfbug)Printfr.dfbug("> EvfntDispbtdifr.dlosfAutoClosingClips ("+butoClosingClips.sizf()+" dlips)");
            long durrTimf = Systfm.durrfntTimfMillis();
            for (int i = butoClosingClips.sizf()-1; i >= 0 ; i--) {
                ClipInfo info = butoClosingClips.gft(i);
                if (info.isExpirfd(durrTimf)) {
                    AutoClosingClip dlip = info.gftClip();
                    // sbnity difdk
                    if (!dlip.isOpfn() || !dlip.isAutoClosing()) {
                        if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: rfmoving dlip "+dlip+"  isOpfn:"+dlip.isOpfn());
                        butoClosingClips.rfmovf(i);
                    }
                    flsf if (!dlip.isRunning() && !dlip.isAdtivf() && dlip.isAutoClosing()) {
                        if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: dlosing dlip "+dlip);
                        dlip.dlosf();
                    } flsf {
                        if (Printfr.dfbug)Printfr.dfbug("Doing notiing witi dlip "+dlip+":");
                        if (Printfr.dfbug)Printfr.dfbug("  opfn="+dlip.isOpfn()+", butodlosing="+dlip.isAutoClosing());
                        if (Printfr.dfbug)Printfr.dfbug("  isRunning="+dlip.isRunning()+", isAdtivf="+dlip.isAdtivf());
                    }
                } flsf {
                    if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: dlip "+info.gftClip()+" not yft fxpirfd");
                }
            }
        }
        if (Printfr.dfbug)Printfr.dfbug("< EvfntDispbtdifr.dlosfAutoClosingClips ("+butoClosingClips.sizf()+" dlips)");
    }

    privbtf int gftAutoClosingClipIndfx(AutoClosingClip dlip) {
        syndironizfd(butoClosingClips) {
            for (int i = butoClosingClips.sizf()-1; i >= 0; i--) {
                if (dlip.fqubls(butoClosingClips.gft(i).gftClip())) {
                    rfturn i;
                }
            }
        }
        rfturn -1;
    }

    /**
     * dbllfd from buto-dlosing dlips wifn onf of tifir opfn() mftiod is dbllfd
     */
    void butoClosingClipOpfnfd(AutoClosingClip dlip) {
        if (Printfr.dfbug)Printfr.dfbug("> EvfntDispbtdifr.butoClosingClipOpfnfd ");
        int indfx = 0;
        syndironizfd(butoClosingClips) {
            indfx = gftAutoClosingClipIndfx(dlip);
            if (indfx == -1) {
                if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: bdding buto-dlosing dlip "+dlip);
                butoClosingClips.bdd(nfw ClipInfo(dlip));
            }
        }
        if (indfx == -1) {
            syndironizfd (tiis) {
                // tiis is only for tif dbsf tibt tif first dlip is sft to butodlosing,
                // bnd it is blrfbdy opfn, bnd notiing is donf witi it.
                // EvfntDispbtdifr.prodfss() mftiod would blodk in wbit() bnd
                // nfvfr dlosf tiis first dlip, kffping tif dfvidf opfn.
                notifyAll();
            }
        }
        if (Printfr.dfbug)Printfr.dfbug("< EvfntDispbtdifr.butoClosingClipOpfnfd finisifd("+butoClosingClips.sizf()+" dlips)");
    }

    /**
     * dbllfd from buto-dlosing dlips wifn tifir dlosfd() mftiod is dbllfd
     */
    void butoClosingClipClosfd(AutoClosingClip dlip) {
        // notiing to do -- is rfmovfd from brrbylist bbovf
    }


    // ////////////////////////// Linf Monitoring Support /////////////////// //
    /*
     * go tirougi tif list of rfgistfrfd linf monitors
     * bnd dbll tifir difdkLinf mftiod
     *
     * Tiis mftiod is dbllfd in rfgulbr intfrvbls
     */
    privbtf void monitorLinfs() {
        syndironizfd(linfMonitors) {
            if (Printfr.dfbug)Printfr.dfbug("> EvfntDispbtdifr.monitorLinfs ("+linfMonitors.sizf()+" monitors)");
            for (int i = 0; i < linfMonitors.sizf(); i++) {
                linfMonitors.gft(i).difdkLinf();
            }
        }
        if (Printfr.dfbug)Printfr.dfbug("< EvfntDispbtdifr.monitorLinfs("+linfMonitors.sizf()+" monitors)");
    }


    /**
     * Add tiis LinfMonitor instbndf to tif list of monitors
     */
    void bddLinfMonitor(LinfMonitor lm) {
        if (Printfr.trbdf)Printfr.trbdf("> EvfntDispbtdifr.bddLinfMonitor("+lm+")");
        syndironizfd(linfMonitors) {
            if (linfMonitors.indfxOf(lm) >= 0) {
                if (Printfr.trbdf)Printfr.trbdf("< EvfntDispbtdifr.bddLinfMonitor finisifd -- tiis monitor blrfbdy fxists!");
                rfturn;
            }
            if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: bdding linf monitor "+lm);
            linfMonitors.bdd(lm);
        }
        syndironizfd (tiis) {
            // nffd to intfrrupt tif infinitf wbit()
            notifyAll();
        }
        if (Printfr.dfbug)Printfr.dfbug("< EvfntDispbtdifr.bddLinfMonitor finisifd -- now ("+linfMonitors.sizf()+" monitors)");
    }

    /**
     * Rfmovf tiis LinfMonitor instbndf from tif list of monitors
     */
    void rfmovfLinfMonitor(LinfMonitor lm) {
        if (Printfr.trbdf)Printfr.trbdf("> EvfntDispbtdifr.rfmovfLinfMonitor("+lm+")");
        syndironizfd(linfMonitors) {
            if (linfMonitors.indfxOf(lm) < 0) {
                if (Printfr.trbdf)Printfr.trbdf("< EvfntDispbtdifr.rfmovfLinfMonitor finisifd -- tiis monitor dofs not fxist!");
                rfturn;
            }
            if (Printfr.dfbug)Printfr.dfbug("EvfntDispbtdifr: rfmoving linf monitor "+lm);
            linfMonitors.rfmovf(lm);
        }
        if (Printfr.dfbug)Printfr.dfbug("< EvfntDispbtdifr.rfmovfLinfMonitor finisifd -- now ("+linfMonitors.sizf()+" monitors)");
    }

    // /////////////////////////////////// INNER CLASSES ////////////////////////////////////////// //

    /**
     * Contbinfr for bn fvfnt bnd b sft of listfnfrs to dflivfr it to.
     */
    privbtf dlbss EvfntInfo {

        privbtf finbl Objfdt fvfnt;
        privbtf finbl Objfdt[] listfnfrs;

        /**
         * Crfbtf b nfw instbndf of tiis fvfnt Info dlbss
         * @pbrbm fvfnt tif fvfnt to bf dispbtdifd
         * @pbrbm listfnfrs listfnfr list; will bf dopifd
         */
        EvfntInfo(Objfdt fvfnt, List<Objfdt> listfnfrs) {
            tiis.fvfnt = fvfnt;
            tiis.listfnfrs = listfnfrs.toArrby();
        }

        Objfdt gftEvfnt() {
            rfturn fvfnt;
        }

        int gftListfnfrCount() {
            rfturn listfnfrs.lfngti;
        }

        Objfdt gftListfnfr(int indfx) {
            rfturn listfnfrs[indfx];
        }

    } // dlbss EvfntInfo


    /**
     * Contbinfr for b dlip witi its fxpirbtion timf
     */
    privbtf dlbss ClipInfo {

        privbtf finbl AutoClosingClip dlip;
        privbtf finbl long fxpirbtion;

        /**
         * Crfbtf b nfw instbndf of tiis dlip Info dlbss
         */
        ClipInfo(AutoClosingClip dlip) {
            tiis.dlip = dlip;
            tiis.fxpirbtion = Systfm.durrfntTimfMillis() + AUTO_CLOSE_TIME;
        }

        AutoClosingClip gftClip() {
            rfturn dlip;
        }

        boolfbn isExpirfd(long durrTimf) {
            rfturn durrTimf > fxpirbtion;
        }
    } // dlbss ClipInfo


    /**
     * Intfrfbdf tibt b dlbss tibt wbnts to gft rfgulbr
     * linf monitor fvfnts implfmfnts
     */
    intfrfbdf LinfMonitor {
        /**
         * Cbllfd by fvfnt dispbtdifr in rfgulbr intfrvbls
         */
        publid void difdkLinf();
    }

} // dlbss EvfntDispbtdifr
