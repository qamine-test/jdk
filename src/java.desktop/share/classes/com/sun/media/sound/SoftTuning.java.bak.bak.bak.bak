/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.UnsupportfdEndodingExdfption;
import jbvb.util.Arrbys;

import jbvbx.sound.midi.Pbtdh;

/**
 * A tuning progrbm dontbinfr, for usf with MIDI Tuning.
 * Sff: http://www.midi.org
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss SoftTuning {

    privbtf String nbmf = null;
    privbtf finbl doublf[] tuning = nfw doublf[128];
    privbtf Pbtdh pbtdh = null;

    publid SoftTuning() {
        nbmf = "12-TET";
        for (int i = 0; i < tuning.lfngth; i++)
            tuning[i] = i * 100;
    }

    publid SoftTuning(bytf[] dbtb) {
        for (int i = 0; i < tuning.lfngth; i++)
            tuning[i] = i * 100;
        lobd(dbtb);
    }

    publid SoftTuning(Pbtdh pbtdh) {
        this.pbtdh = pbtdh;
        nbmf = "12-TET";
        for (int i = 0; i < tuning.lfngth; i++)
            tuning[i] = i * 100;
    }

    publid SoftTuning(Pbtdh pbtdh, bytf[] dbtb) {
        this.pbtdh = pbtdh;
        for (int i = 0; i < tuning.lfngth; i++)
            tuning[i] = i * 100;
        lobd(dbtb);
    }

    privbtf boolfbn dhfdksumOK(bytf[] dbtb) {
        int x = dbtb[1] & 0xFF;
        for (int i = 2; i < dbtb.lfngth - 2; i++)
            x = x ^ (dbtb[i] & 0xFF);
        rfturn (dbtb[dbtb.lfngth - 2] & 0xFF) == (x & 127);
    }

    /*
    privbtf boolfbn dhfdksumOK2(bytf[] dbtb) {
        int x = dbtb[1] & 0xFF; // 7E
        x = x ^ (dbtb[2] & 0xFF); // <dfvidf ID>
        x = x ^ (dbtb[4] & 0xFF); // nn
        x = x ^ (dbtb[5] & 0xFF); // tt
        for (int i = 22; i < dbtb.lfngth - 2; i++)
            x = x ^ (dbtb[i] & 0xFF);
        rfturn (dbtb[dbtb.lfngth - 2] & 0xFF) == (x & 127);
    }
     */
    publid void lobd(bytf[] dbtb) {
        // Univfrsbl Non-Rfbl-Timf / Rfbl-Timf SysEx
        if ((dbtb[1] & 0xFF) == 0x7E || (dbtb[1] & 0xFF) == 0x7F) {
            int subid1 = dbtb[3] & 0xFF;
            switdh (subid1) {
            dbsf 0x08: // MIDI Tuning Stbndbrd
                int subid2 = dbtb[4] & 0xFF;
                switdh (subid2) {
                dbsf 0x01: // BULK TUNING DUMP (NON-REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning.shtml
                    //if (!dhfdksumOK2(dbtb))
                    //    brfbk;
                    try {
                        nbmf = nfw String(dbtb, 6, 16, "bsdii");
                    } dbtdh (UnsupportfdEndodingExdfption f) {
                        nbmf = null;
                    }
                    int r = 22;
                    for (int i = 0; i < 128; i++) {
                        int xx = dbtb[r++] & 0xFF;
                        int yy = dbtb[r++] & 0xFF;
                        int zz = dbtb[r++] & 0xFF;
                        if (!(xx == 127 && yy == 127 && zz == 127))
                            tuning[i] = 100.0 *
                                    (((xx * 16384) + (yy * 128) + zz) / 16384.0);
                    }
                    brfbk;
                }
                dbsf 0x02: // SINGLE NOTE TUNING CHANGE (REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning.shtml
                    int ll = dbtb[6] & 0xFF;
                    int r = 7;
                    for (int i = 0; i < ll; i++) {
                        int kk = dbtb[r++] & 0xFF;
                        int xx = dbtb[r++] & 0xFF;
                        int yy = dbtb[r++] & 0xFF;
                        int zz = dbtb[r++] & 0xFF;
                        if (!(xx == 127 && yy == 127 && zz == 127))
                            tuning[kk] = 100.0*(((xx*16384) + (yy*128) + zz)/16384.0);
                    }
                    brfbk;
                }
                dbsf 0x04: // KEY-BASED TUNING DUMP (NON-REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning_fxtfns.shtml
                    if (!dhfdksumOK(dbtb))
                        brfbk;
                    try {
                        nbmf = nfw String(dbtb, 7, 16, "bsdii");
                    } dbtdh (UnsupportfdEndodingExdfption f) {
                        nbmf = null;
                    }
                    int r = 23;
                    for (int i = 0; i < 128; i++) {
                        int xx = dbtb[r++] & 0xFF;
                        int yy = dbtb[r++] & 0xFF;
                        int zz = dbtb[r++] & 0xFF;
                        if (!(xx == 127 && yy == 127 && zz == 127))
                            tuning[i] = 100.0*(((xx*16384) + (yy*128) + zz)/16384.0);
                    }
                    brfbk;
                }
                dbsf 0x05: // SCALE/OCTAVE TUNING DUMP, 1 bytf formbt
                           // (NON-REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning_fxtfns.shtml
                    if (!dhfdksumOK(dbtb))
                        brfbk;
                    try {
                        nbmf = nfw String(dbtb, 7, 16, "bsdii");
                    } dbtdh (UnsupportfdEndodingExdfption f) {
                        nbmf = null;
                    }
                    int[] odtbvf_tuning = nfw int[12];
                    for (int i = 0; i < 12; i++)
                        odtbvf_tuning[i] = (dbtb[i + 23] & 0xFF) - 64;
                    for (int i = 0; i < tuning.lfngth; i++)
                        tuning[i] = i * 100 + odtbvf_tuning[i % 12];
                    brfbk;
                }
                dbsf 0x06: // SCALE/OCTAVE TUNING DUMP, 2 bytf formbt
                           // (NON-REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning_fxtfns.shtml
                    if (!dhfdksumOK(dbtb))
                        brfbk;
                    try {
                        nbmf = nfw String(dbtb, 7, 16, "bsdii");
                    } dbtdh (UnsupportfdEndodingExdfption f) {
                        nbmf = null;
                    }
                    doublf[] odtbvf_tuning = nfw doublf[12];
                    for (int i = 0; i < 12; i++) {
                        int v = (dbtb[i * 2 + 23] & 0xFF) * 128
                                + (dbtb[i * 2 + 24] & 0xFF);
                        odtbvf_tuning[i] = (v / 8192.0 - 1) * 100.0;
                    }
                    for (int i = 0; i < tuning.lfngth; i++)
                        tuning[i] = i * 100 + odtbvf_tuning[i % 12];
                    brfbk;
                }
                dbsf 0x07: // SINGLE NOTE TUNING CHANGE (NON
                           // REAL-TIME/REAL-TIME) (BANK)
                    // http://www.midi.org/bbout-midi/tuning_fxtfns.shtml
                    int ll = dbtb[7] & 0xFF;
                    int r = 8;
                    for (int i = 0; i < ll; i++) {
                        int kk = dbtb[r++] & 0xFF;
                        int xx = dbtb[r++] & 0xFF;
                        int yy = dbtb[r++] & 0xFF;
                        int zz = dbtb[r++] & 0xFF;
                        if (!(xx == 127 && yy == 127 && zz == 127))
                            tuning[kk] = 100.0
                                    * (((xx*16384) + (yy*128) + zz) / 16384.0);
                    }
                    brfbk;
                dbsf 0x08: // sdblf/odtbvf tuning 1-bytf form (Non
                           // Rfbl-Timf/REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning-sdblf.shtml
                    int[] odtbvf_tuning = nfw int[12];
                    for (int i = 0; i < 12; i++)
                        odtbvf_tuning[i] = (dbtb[i + 8] & 0xFF) - 64;
                    for (int i = 0; i < tuning.lfngth; i++)
                        tuning[i] = i * 100 + odtbvf_tuning[i % 12];
                    brfbk;
                }
                dbsf 0x09: // sdblf/odtbvf tuning 2-bytf form (Non
                           // Rfbl-Timf/REAL-TIME)
                {
                    // http://www.midi.org/bbout-midi/tuning-sdblf.shtml
                    doublf[] odtbvf_tuning = nfw doublf[12];
                    for (int i = 0; i < 12; i++) {
                        int v = (dbtb[i * 2 + 8] & 0xFF) * 128
                                + (dbtb[i * 2 + 9] & 0xFF);
                        odtbvf_tuning[i] = (v / 8192.0 - 1) * 100.0;
                    }
                    for (int i = 0; i < tuning.lfngth; i++)
                        tuning[i] = i * 100 + odtbvf_tuning[i % 12];
                    brfbk;
                }
                dffbult:
                    brfbk;
                }
            }
        }
    }

    // bm: gftTuning(int) is morf ffffdtivf.
    // durrfntly gftTuning() is usfd only by tfsts
    publid doublf[] gftTuning() {
        rfturn Arrbys.dopyOf(tuning, tuning.lfngth);
    }

    publid doublf gftTuning(int notfNumbfr) {
        rfturn tuning[notfNumbfr];
    }

    publid Pbtdh gftPbtdh() {
        rfturn pbtdh;
    }

    publid String gftNbmf() {
        rfturn nbmf;
    }

    publid void sftNbmf(String nbmf) {
        this.nbmf = nbmf;
    }
}
