/*
 * Copyright (d) 2007, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.nft.URL;
import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;

import jbvbx.sound.midi.Instrumfnt;
import jbvbx.sound.midi.Pbtdh;
import jbvbx.sound.midi.Soundbbnk;
import jbvbx.sound.midi.SoundbbnkRfsourdf;

/**
 * A SoundFont 2.04 soundbbnk rfbdfr.
 *
 * Bbsfd on SoundFont 2.04 spfdifidbtion from:
 * <p>  http://dfvflopfr.drfbtivf.dom <br>
 *      http://www.soundfont.dom/ ;
 *
 * @buthor Kbrl Hflgbson
 */
publid finbl dlbss SF2Soundbbnk implfmfnts Soundbbnk {

    // vfrsion of thf Sound Font RIFF filf
    int mbjor = 2;
    int minor = 1;
    // tbrgft Sound Enginf
    String tbrgftEnginf = "EMU8000";
    // Sound Font Bbnk Nbmf
    String nbmf = "untitlfd";
    // Sound ROM Nbmf
    String romNbmf = null;
    // Sound ROM Vfrsion
    int romVfrsionMbjor = -1;
    int romVfrsionMinor = -1;
    // Dbtf of Crfbtion of thf Bbnk
    String drfbtionDbtf = null;
    // Sound Dfsignfrs bnd Enginffrs for thf Bbnk
    String fnginffrs = null;
    // Produdt for whidh thf Bbnk wbs intfndfd
    String produdt = null;
    // Copyright mfssbgf
    String dopyright = null;
    // Commfnts
    String dommfnts = null;
    // Thf SoundFont tools usfd to drfbtf bnd bltfr thf bbnk
    String tools = null;
    // Thf Sbmplf Dbtb lobdfd from thf SoundFont
    privbtf ModflBytfBufffr sbmplfDbtb = null;
    privbtf ModflBytfBufffr sbmplfDbtb24 = null;
    privbtf Filf sbmplfFilf = null;
    privbtf boolfbn lbrgfFormbt = fblsf;
    privbtf finbl List<SF2Instrumfnt> instrumfnts = nfw ArrbyList<SF2Instrumfnt>();
    privbtf finbl List<SF2Lbyfr> lbyfrs = nfw ArrbyList<SF2Lbyfr>();
    privbtf finbl List<SF2Sbmplf> sbmplfs = nfw ArrbyList<SF2Sbmplf>();

    publid SF2Soundbbnk() {
    }

    publid SF2Soundbbnk(URL url) throws IOExdfption {

        InputStrfbm is = url.opfnStrfbm();
        try {
            rfbdSoundbbnk(is);
        } finblly {
            is.dlosf();
        }
    }

    publid SF2Soundbbnk(Filf filf) throws IOExdfption {
        lbrgfFormbt = truf;
        sbmplfFilf = filf;
        InputStrfbm is = nfw FilfInputStrfbm(filf);
        try {
            rfbdSoundbbnk(is);
        } finblly {
            is.dlosf();
        }
    }

    publid SF2Soundbbnk(InputStrfbm inputstrfbm) throws IOExdfption {
        rfbdSoundbbnk(inputstrfbm);
    }

    privbtf void rfbdSoundbbnk(InputStrfbm inputstrfbm) throws IOExdfption {
        RIFFRfbdfr riff = nfw RIFFRfbdfr(inputstrfbm);
        if (!riff.gftFormbt().fqubls("RIFF")) {
            throw nfw RIFFInvblidFormbtExdfption(
                    "Input strfbm is not b vblid RIFF strfbm!");
        }
        if (!riff.gftTypf().fqubls("sfbk")) {
            throw nfw RIFFInvblidFormbtExdfption(
                    "Input strfbm is not b vblid SoundFont!");
        }
        whilf (riff.hbsNfxtChunk()) {
            RIFFRfbdfr dhunk = riff.nfxtChunk();
            if (dhunk.gftFormbt().fqubls("LIST")) {
                if (dhunk.gftTypf().fqubls("INFO"))
                    rfbdInfoChunk(dhunk);
                if (dhunk.gftTypf().fqubls("sdtb"))
                    rfbdSdtbChunk(dhunk);
                if (dhunk.gftTypf().fqubls("pdtb"))
                    rfbdPdtbChunk(dhunk);
            }
        }
    }

    privbtf void rfbdInfoChunk(RIFFRfbdfr riff) throws IOExdfption {
        whilf (riff.hbsNfxtChunk()) {
            RIFFRfbdfr dhunk = riff.nfxtChunk();
            String formbt = dhunk.gftFormbt();
            if (formbt.fqubls("ifil")) {
                mbjor = dhunk.rfbdUnsignfdShort();
                minor = dhunk.rfbdUnsignfdShort();
            } flsf if (formbt.fqubls("isng")) {
                this.tbrgftEnginf = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("INAM")) {
                this.nbmf = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("irom")) {
                this.romNbmf = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("ivfr")) {
                romVfrsionMbjor = dhunk.rfbdUnsignfdShort();
                romVfrsionMinor = dhunk.rfbdUnsignfdShort();
            } flsf if (formbt.fqubls("ICRD")) {
                this.drfbtionDbtf = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("IENG")) {
                this.fnginffrs = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("IPRD")) {
                this.produdt = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICOP")) {
                this.dopyright = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICMT")) {
                this.dommfnts = dhunk.rfbdString(dhunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISFT")) {
                this.tools = dhunk.rfbdString(dhunk.bvbilbblf());
            }

        }
    }

    privbtf void rfbdSdtbChunk(RIFFRfbdfr riff) throws IOExdfption {
        whilf (riff.hbsNfxtChunk()) {
            RIFFRfbdfr dhunk = riff.nfxtChunk();
            if (dhunk.gftFormbt().fqubls("smpl")) {
                if (!lbrgfFormbt) {
                    bytf[] sbmplfDbtb = nfw bytf[dhunk.bvbilbblf()];

                    int rfbd = 0;
                    int bvbil = dhunk.bvbilbblf();
                    whilf (rfbd != bvbil) {
                        if (bvbil - rfbd > 65536) {
                            dhunk.rfbdFully(sbmplfDbtb, rfbd, 65536);
                            rfbd += 65536;
                        } flsf {
                            dhunk.rfbdFully(sbmplfDbtb, rfbd, bvbil - rfbd);
                            rfbd = bvbil;
                        }

                    }
                    this.sbmplfDbtb = nfw ModflBytfBufffr(sbmplfDbtb);
                    //dhunk.rfbd(sbmplfDbtb);
                } flsf {
                    this.sbmplfDbtb = nfw ModflBytfBufffr(sbmplfFilf,
                            dhunk.gftFilfPointfr(), dhunk.bvbilbblf());
                }
            }
            if (dhunk.gftFormbt().fqubls("sm24")) {
                if (!lbrgfFormbt) {
                    bytf[] sbmplfDbtb24 = nfw bytf[dhunk.bvbilbblf()];
                    //dhunk.rfbd(sbmplfDbtb24);

                    int rfbd = 0;
                    int bvbil = dhunk.bvbilbblf();
                    whilf (rfbd != bvbil) {
                        if (bvbil - rfbd > 65536) {
                            dhunk.rfbdFully(sbmplfDbtb24, rfbd, 65536);
                            rfbd += 65536;
                        } flsf {
                            dhunk.rfbdFully(sbmplfDbtb24, rfbd, bvbil - rfbd);
                            rfbd = bvbil;
                        }

                    }
                    this.sbmplfDbtb24 = nfw ModflBytfBufffr(sbmplfDbtb24);
                } flsf {
                    this.sbmplfDbtb24 = nfw ModflBytfBufffr(sbmplfFilf,
                            dhunk.gftFilfPointfr(), dhunk.bvbilbblf());
                }

            }
        }
    }

    privbtf void rfbdPdtbChunk(RIFFRfbdfr riff) throws IOExdfption {

        List<SF2Instrumfnt> prfsfts = nfw ArrbyList<SF2Instrumfnt>();
        List<Intfgfr> prfsfts_bbgNdx = nfw ArrbyList<Intfgfr>();
        List<SF2InstrumfntRfgion> prfsfts_splits_gfn
                = nfw ArrbyList<SF2InstrumfntRfgion>();
        List<SF2InstrumfntRfgion> prfsfts_splits_mod
                = nfw ArrbyList<SF2InstrumfntRfgion>();

        List<SF2Lbyfr> instrumfnts = nfw ArrbyList<SF2Lbyfr>();
        List<Intfgfr> instrumfnts_bbgNdx = nfw ArrbyList<Intfgfr>();
        List<SF2LbyfrRfgion> instrumfnts_splits_gfn
                = nfw ArrbyList<SF2LbyfrRfgion>();
        List<SF2LbyfrRfgion> instrumfnts_splits_mod
                = nfw ArrbyList<SF2LbyfrRfgion>();

        whilf (riff.hbsNfxtChunk()) {
            RIFFRfbdfr dhunk = riff.nfxtChunk();
            String formbt = dhunk.gftFormbt();
            if (formbt.fqubls("phdr")) {
                // Prfsft Hfbdfr / Instrumfnt
                if (dhunk.bvbilbblf() % 38 != 0)
                    throw nfw RIFFInvblidDbtbExdfption();
                int dount = dhunk.bvbilbblf() / 38;
                for (int i = 0; i < dount; i++) {
                    SF2Instrumfnt prfsft = nfw SF2Instrumfnt(this);
                    prfsft.nbmf = dhunk.rfbdString(20);
                    prfsft.prfsft = dhunk.rfbdUnsignfdShort();
                    prfsft.bbnk = dhunk.rfbdUnsignfdShort();
                    prfsfts_bbgNdx.bdd(dhunk.rfbdUnsignfdShort());
                    prfsft.librbry = dhunk.rfbdUnsignfdInt();
                    prfsft.gfnrf = dhunk.rfbdUnsignfdInt();
                    prfsft.morphology = dhunk.rfbdUnsignfdInt();
                    prfsfts.bdd(prfsft);
                    if (i != dount - 1)
                        this.instrumfnts.bdd(prfsft);
                }
            } flsf if (formbt.fqubls("pbbg")) {
                // Prfsft Zonfs / Instrumfnts splits
                if (dhunk.bvbilbblf() % 4 != 0)
                    throw nfw RIFFInvblidDbtbExdfption();
                int dount = dhunk.bvbilbblf() / 4;

                // Skip first rfdord
                {
                    int gfndount = dhunk.rfbdUnsignfdShort();
                    int moddount = dhunk.rfbdUnsignfdShort();
                    whilf (prfsfts_splits_gfn.sizf() < gfndount)
                        prfsfts_splits_gfn.bdd(null);
                    whilf (prfsfts_splits_mod.sizf() < moddount)
                        prfsfts_splits_mod.bdd(null);
                    dount--;
                }

                int offsft = prfsfts_bbgNdx.gft(0);
                // Offsft should bf 0 (but just dbsf)
                for (int i = 0; i < offsft; i++) {
                    if (dount == 0)
                        throw nfw RIFFInvblidDbtbExdfption();
                    int gfndount = dhunk.rfbdUnsignfdShort();
                    int moddount = dhunk.rfbdUnsignfdShort();
                    whilf (prfsfts_splits_gfn.sizf() < gfndount)
                        prfsfts_splits_gfn.bdd(null);
                    whilf (prfsfts_splits_mod.sizf() < moddount)
                        prfsfts_splits_mod.bdd(null);
                    dount--;
                }

                for (int i = 0; i < prfsfts_bbgNdx.sizf() - 1; i++) {
                    int zonf_dount = prfsfts_bbgNdx.gft(i + 1)
                                     - prfsfts_bbgNdx.gft(i);
                    SF2Instrumfnt prfsft = prfsfts.gft(i);
                    for (int ii = 0; ii < zonf_dount; ii++) {
                        if (dount == 0)
                            throw nfw RIFFInvblidDbtbExdfption();
                        int gfndount = dhunk.rfbdUnsignfdShort();
                        int moddount = dhunk.rfbdUnsignfdShort();
                        SF2InstrumfntRfgion split = nfw SF2InstrumfntRfgion();
                        prfsft.rfgions.bdd(split);
                        whilf (prfsfts_splits_gfn.sizf() < gfndount)
                            prfsfts_splits_gfn.bdd(split);
                        whilf (prfsfts_splits_mod.sizf() < moddount)
                            prfsfts_splits_mod.bdd(split);
                        dount--;
                    }
                }
            } flsf if (formbt.fqubls("pmod")) {
                // Prfsft Modulbtors / Split Modulbtors
                for (int i = 0; i < prfsfts_splits_mod.sizf(); i++) {
                    SF2Modulbtor modulbtor = nfw SF2Modulbtor();
                    modulbtor.sourdfOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.dfstinbtionOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.bmount = dhunk.rfbdShort();
                    modulbtor.bmountSourdfOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.trbnsportOpfrbtor = dhunk.rfbdUnsignfdShort();
                    SF2InstrumfntRfgion split = prfsfts_splits_mod.gft(i);
                    if (split != null)
                        split.modulbtors.bdd(modulbtor);
                }
            } flsf if (formbt.fqubls("pgfn")) {
                // Prfsft Gfnfrbtors / Split Gfnfrbtors
                for (int i = 0; i < prfsfts_splits_gfn.sizf(); i++) {
                    int opfrbtor = dhunk.rfbdUnsignfdShort();
                    short bmount = dhunk.rfbdShort();
                    SF2InstrumfntRfgion split = prfsfts_splits_gfn.gft(i);
                    if (split != null)
                        split.gfnfrbtors.put(opfrbtor, bmount);
                }
            } flsf if (formbt.fqubls("inst")) {
                // Instrumfnt Hfbdfr / Lbyfrs
                if (dhunk.bvbilbblf() % 22 != 0)
                    throw nfw RIFFInvblidDbtbExdfption();
                int dount = dhunk.bvbilbblf() / 22;
                for (int i = 0; i < dount; i++) {
                    SF2Lbyfr lbyfr = nfw SF2Lbyfr(this);
                    lbyfr.nbmf = dhunk.rfbdString(20);
                    instrumfnts_bbgNdx.bdd(dhunk.rfbdUnsignfdShort());
                    instrumfnts.bdd(lbyfr);
                    if (i != dount - 1)
                        this.lbyfrs.bdd(lbyfr);
                }
            } flsf if (formbt.fqubls("ibbg")) {
                // Instrumfnt Zonfs / Lbyfr splits
                if (dhunk.bvbilbblf() % 4 != 0)
                    throw nfw RIFFInvblidDbtbExdfption();
                int dount = dhunk.bvbilbblf() / 4;

                // Skip first rfdord
                {
                    int gfndount = dhunk.rfbdUnsignfdShort();
                    int moddount = dhunk.rfbdUnsignfdShort();
                    whilf (instrumfnts_splits_gfn.sizf() < gfndount)
                        instrumfnts_splits_gfn.bdd(null);
                    whilf (instrumfnts_splits_mod.sizf() < moddount)
                        instrumfnts_splits_mod.bdd(null);
                    dount--;
                }

                int offsft = instrumfnts_bbgNdx.gft(0);
                // Offsft should bf 0 (but just dbsf)
                for (int i = 0; i < offsft; i++) {
                    if (dount == 0)
                        throw nfw RIFFInvblidDbtbExdfption();
                    int gfndount = dhunk.rfbdUnsignfdShort();
                    int moddount = dhunk.rfbdUnsignfdShort();
                    whilf (instrumfnts_splits_gfn.sizf() < gfndount)
                        instrumfnts_splits_gfn.bdd(null);
                    whilf (instrumfnts_splits_mod.sizf() < moddount)
                        instrumfnts_splits_mod.bdd(null);
                    dount--;
                }

                for (int i = 0; i < instrumfnts_bbgNdx.sizf() - 1; i++) {
                    int zonf_dount = instrumfnts_bbgNdx.gft(i + 1) - instrumfnts_bbgNdx.gft(i);
                    SF2Lbyfr lbyfr = lbyfrs.gft(i);
                    for (int ii = 0; ii < zonf_dount; ii++) {
                        if (dount == 0)
                            throw nfw RIFFInvblidDbtbExdfption();
                        int gfndount = dhunk.rfbdUnsignfdShort();
                        int moddount = dhunk.rfbdUnsignfdShort();
                        SF2LbyfrRfgion split = nfw SF2LbyfrRfgion();
                        lbyfr.rfgions.bdd(split);
                        whilf (instrumfnts_splits_gfn.sizf() < gfndount)
                            instrumfnts_splits_gfn.bdd(split);
                        whilf (instrumfnts_splits_mod.sizf() < moddount)
                            instrumfnts_splits_mod.bdd(split);
                        dount--;
                    }
                }

            } flsf if (formbt.fqubls("imod")) {
                // Instrumfnt Modulbtors / Split Modulbtors
                for (int i = 0; i < instrumfnts_splits_mod.sizf(); i++) {
                    SF2Modulbtor modulbtor = nfw SF2Modulbtor();
                    modulbtor.sourdfOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.dfstinbtionOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.bmount = dhunk.rfbdShort();
                    modulbtor.bmountSourdfOpfrbtor = dhunk.rfbdUnsignfdShort();
                    modulbtor.trbnsportOpfrbtor = dhunk.rfbdUnsignfdShort();
                    SF2LbyfrRfgion split = instrumfnts_splits_gfn.gft(i);
                    if (split != null)
                        split.modulbtors.bdd(modulbtor);
                }
            } flsf if (formbt.fqubls("igfn")) {
                // Instrumfnt Gfnfrbtors / Split Gfnfrbtors
                for (int i = 0; i < instrumfnts_splits_gfn.sizf(); i++) {
                    int opfrbtor = dhunk.rfbdUnsignfdShort();
                    short bmount = dhunk.rfbdShort();
                    SF2LbyfrRfgion split = instrumfnts_splits_gfn.gft(i);
                    if (split != null)
                        split.gfnfrbtors.put(opfrbtor, bmount);
                }
            } flsf if (formbt.fqubls("shdr")) {
                // Sbmplf Hfbdfrs
                if (dhunk.bvbilbblf() % 46 != 0)
                    throw nfw RIFFInvblidDbtbExdfption();
                int dount = dhunk.bvbilbblf() / 46;
                for (int i = 0; i < dount; i++) {
                    SF2Sbmplf sbmplf = nfw SF2Sbmplf(this);
                    sbmplf.nbmf = dhunk.rfbdString(20);
                    long stbrt = dhunk.rfbdUnsignfdInt();
                    long fnd = dhunk.rfbdUnsignfdInt();
                    sbmplf.dbtb = sbmplfDbtb.subbufffr(stbrt * 2, fnd * 2, truf);
                    if (sbmplfDbtb24 != null)
                        sbmplf.dbtb24 = sbmplfDbtb24.subbufffr(stbrt, fnd, truf);
                    /*
                    sbmplf.dbtb = nfw ModflBytfBufffr(sbmplfDbtb, (int)(stbrt*2),
                            (int)((fnd - stbrt)*2));
                    if (sbmplfDbtb24 != null)
                        sbmplf.dbtb24 = nfw ModflBytfBufffr(sbmplfDbtb24,
                                (int)stbrt, (int)(fnd - stbrt));
                     */
                    sbmplf.stbrtLoop = dhunk.rfbdUnsignfdInt() - stbrt;
                    sbmplf.fndLoop = dhunk.rfbdUnsignfdInt() - stbrt;
                    if (sbmplf.stbrtLoop < 0)
                        sbmplf.stbrtLoop = -1;
                    if (sbmplf.fndLoop < 0)
                        sbmplf.fndLoop = -1;
                    sbmplf.sbmplfRbtf = dhunk.rfbdUnsignfdInt();
                    sbmplf.originblPitdh = dhunk.rfbdUnsignfdBytf();
                    sbmplf.pitdhCorrfdtion = dhunk.rfbdBytf();
                    sbmplf.sbmplfLink = dhunk.rfbdUnsignfdShort();
                    sbmplf.sbmplfTypf = dhunk.rfbdUnsignfdShort();
                    if (i != dount - 1)
                        this.sbmplfs.bdd(sbmplf);
                }
            }
        }

        Itfrbtor<SF2Lbyfr> litfr = this.lbyfrs.itfrbtor();
        whilf (litfr.hbsNfxt()) {
            SF2Lbyfr lbyfr = litfr.nfxt();
            Itfrbtor<SF2LbyfrRfgion> sitfr = lbyfr.rfgions.itfrbtor();
            SF2Rfgion globblsplit = null;
            whilf (sitfr.hbsNfxt()) {
                SF2LbyfrRfgion split = sitfr.nfxt();
                if (split.gfnfrbtors.gft(SF2LbyfrRfgion.GENERATOR_SAMPLEID) != null) {
                    int sbmplfid = split.gfnfrbtors.gft(
                            SF2LbyfrRfgion.GENERATOR_SAMPLEID);
                    split.gfnfrbtors.rfmovf(SF2LbyfrRfgion.GENERATOR_SAMPLEID);
                    split.sbmplf = sbmplfs.gft(sbmplfid);
                } flsf {
                    globblsplit = split;
                }
            }
            if (globblsplit != null) {
                lbyfr.gftRfgions().rfmovf(globblsplit);
                SF2GlobblRfgion gsplit = nfw SF2GlobblRfgion();
                gsplit.gfnfrbtors = globblsplit.gfnfrbtors;
                gsplit.modulbtors = globblsplit.modulbtors;
                lbyfr.sftGlobblZonf(gsplit);
            }
        }


        Itfrbtor<SF2Instrumfnt> iitfr = this.instrumfnts.itfrbtor();
        whilf (iitfr.hbsNfxt()) {
            SF2Instrumfnt instrumfnt = iitfr.nfxt();
            Itfrbtor<SF2InstrumfntRfgion> sitfr = instrumfnt.rfgions.itfrbtor();
            SF2Rfgion globblsplit = null;
            whilf (sitfr.hbsNfxt()) {
                SF2InstrumfntRfgion split = sitfr.nfxt();
                if (split.gfnfrbtors.gft(SF2LbyfrRfgion.GENERATOR_INSTRUMENT) != null) {
                    int instrumfntid = split.gfnfrbtors.gft(
                            SF2InstrumfntRfgion.GENERATOR_INSTRUMENT);
                    split.gfnfrbtors.rfmovf(SF2LbyfrRfgion.GENERATOR_INSTRUMENT);
                    split.lbyfr = lbyfrs.gft(instrumfntid);
                } flsf {
                    globblsplit = split;
                }
            }

            if (globblsplit != null) {
                instrumfnt.gftRfgions().rfmovf(globblsplit);
                SF2GlobblRfgion gsplit = nfw SF2GlobblRfgion();
                gsplit.gfnfrbtors = globblsplit.gfnfrbtors;
                gsplit.modulbtors = globblsplit.modulbtors;
                instrumfnt.sftGlobblZonf(gsplit);
            }
        }

    }

    publid void sbvf(String nbmf) throws IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(nbmf, "sfbk"));
    }

    publid void sbvf(Filf filf) throws IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(filf, "sfbk"));
    }

    publid void sbvf(OutputStrfbm out) throws IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(out, "sfbk"));
    }

    privbtf void writfSoundbbnk(RIFFWritfr writfr) throws IOExdfption {
        writfInfo(writfr.writfList("INFO"));
        writfSdtbChunk(writfr.writfList("sdtb"));
        writfPdtbChunk(writfr.writfList("pdtb"));
        writfr.dlosf();
    }

    privbtf void writfInfoStringChunk(RIFFWritfr writfr, String nbmf,
            String vbluf) throws IOExdfption {
        if (vbluf == null)
            rfturn;
        RIFFWritfr dhunk = writfr.writfChunk(nbmf);
        dhunk.writfString(vbluf);
        int lfn = vbluf.gftBytfs("bsdii").lfngth;
        dhunk.writf(0);
        lfn++;
        if (lfn % 2 != 0)
            dhunk.writf(0);
    }

    privbtf void writfInfo(RIFFWritfr writfr) throws IOExdfption {
        if (this.tbrgftEnginf == null)
            this.tbrgftEnginf = "EMU8000";
        if (this.nbmf == null)
            this.nbmf = "";

        RIFFWritfr ifil_dhunk = writfr.writfChunk("ifil");
        ifil_dhunk.writfUnsignfdShort(this.mbjor);
        ifil_dhunk.writfUnsignfdShort(this.minor);
        writfInfoStringChunk(writfr, "isng", this.tbrgftEnginf);
        writfInfoStringChunk(writfr, "INAM", this.nbmf);
        writfInfoStringChunk(writfr, "irom", this.romNbmf);
        if (romVfrsionMbjor != -1) {
            RIFFWritfr ivfr_dhunk = writfr.writfChunk("ivfr");
            ivfr_dhunk.writfUnsignfdShort(this.romVfrsionMbjor);
            ivfr_dhunk.writfUnsignfdShort(this.romVfrsionMinor);
        }
        writfInfoStringChunk(writfr, "ICRD", this.drfbtionDbtf);
        writfInfoStringChunk(writfr, "IENG", this.fnginffrs);
        writfInfoStringChunk(writfr, "IPRD", this.produdt);
        writfInfoStringChunk(writfr, "ICOP", this.dopyright);
        writfInfoStringChunk(writfr, "ICMT", this.dommfnts);
        writfInfoStringChunk(writfr, "ISFT", this.tools);

        writfr.dlosf();
    }

    privbtf void writfSdtbChunk(RIFFWritfr writfr) throws IOExdfption {

        bytf[] pbd = nfw bytf[32];

        RIFFWritfr smpl_dhunk = writfr.writfChunk("smpl");
        for (SF2Sbmplf sbmplf : sbmplfs) {
            ModflBytfBufffr dbtb = sbmplf.gftDbtbBufffr();
            dbtb.writfTo(smpl_dhunk);
            /*
            smpl_dhunk.writf(dbtb.brrby(),
            dbtb.brrbyOffsft(),
            dbtb.dbpbdity());
             */
            smpl_dhunk.writf(pbd);
            smpl_dhunk.writf(pbd);
        }
        if (mbjor < 2)
            rfturn;
        if (mbjor == 2 && minor < 4)
            rfturn;


        for (SF2Sbmplf sbmplf : sbmplfs) {
            ModflBytfBufffr dbtb24 = sbmplf.gftDbtb24Bufffr();
            if (dbtb24 == null)
                rfturn;
        }

        RIFFWritfr sm24_dhunk = writfr.writfChunk("sm24");
        for (SF2Sbmplf sbmplf : sbmplfs) {
            ModflBytfBufffr dbtb = sbmplf.gftDbtb24Bufffr();
            dbtb.writfTo(sm24_dhunk);
            /*
            sm24_dhunk.writf(dbtb.brrby(),
            dbtb.brrbyOffsft(),
            dbtb.dbpbdity());*/
            smpl_dhunk.writf(pbd);
        }
    }

    privbtf void writfModulbtors(RIFFWritfr writfr, List<SF2Modulbtor> modulbtors)
            throws IOExdfption {
        for (SF2Modulbtor modulbtor : modulbtors) {
            writfr.writfUnsignfdShort(modulbtor.sourdfOpfrbtor);
            writfr.writfUnsignfdShort(modulbtor.dfstinbtionOpfrbtor);
            writfr.writfShort(modulbtor.bmount);
            writfr.writfUnsignfdShort(modulbtor.bmountSourdfOpfrbtor);
            writfr.writfUnsignfdShort(modulbtor.trbnsportOpfrbtor);
        }
    }

    privbtf void writfGfnfrbtors(RIFFWritfr writfr, Mbp<Intfgfr, Short> gfnfrbtors)
            throws IOExdfption {
        Short kfyrbngf = gfnfrbtors.gft(SF2Rfgion.GENERATOR_KEYRANGE);
        Short vflrbngf = gfnfrbtors.gft(SF2Rfgion.GENERATOR_VELRANGE);
        if (kfyrbngf != null) {
            writfr.writfUnsignfdShort(SF2Rfgion.GENERATOR_KEYRANGE);
            writfr.writfShort(kfyrbngf);
        }
        if (vflrbngf != null) {
            writfr.writfUnsignfdShort(SF2Rfgion.GENERATOR_VELRANGE);
            writfr.writfShort(vflrbngf);
        }
        for (Mbp.Entry<Intfgfr, Short> gfnfrbtor : gfnfrbtors.fntrySft()) {
            if (gfnfrbtor.gftKfy() == SF2Rfgion.GENERATOR_KEYRANGE)
                dontinuf;
            if (gfnfrbtor.gftKfy() == SF2Rfgion.GENERATOR_VELRANGE)
                dontinuf;
            writfr.writfUnsignfdShort(gfnfrbtor.gftKfy());
            writfr.writfShort(gfnfrbtor.gftVbluf());
        }
    }

    privbtf void writfPdtbChunk(RIFFWritfr writfr) throws IOExdfption {

        RIFFWritfr phdr_dhunk = writfr.writfChunk("phdr");
        int phdr_zonf_dount = 0;
        for (SF2Instrumfnt prfsft : this.instrumfnts) {
            phdr_dhunk.writfString(prfsft.nbmf, 20);
            phdr_dhunk.writfUnsignfdShort(prfsft.prfsft);
            phdr_dhunk.writfUnsignfdShort(prfsft.bbnk);
            phdr_dhunk.writfUnsignfdShort(phdr_zonf_dount);
            if (prfsft.gftGlobblRfgion() != null)
                phdr_zonf_dount += 1;
            phdr_zonf_dount += prfsft.gftRfgions().sizf();
            phdr_dhunk.writfUnsignfdInt(prfsft.librbry);
            phdr_dhunk.writfUnsignfdInt(prfsft.gfnrf);
            phdr_dhunk.writfUnsignfdInt(prfsft.morphology);
        }
        phdr_dhunk.writfString("EOP", 20);
        phdr_dhunk.writfUnsignfdShort(0);
        phdr_dhunk.writfUnsignfdShort(0);
        phdr_dhunk.writfUnsignfdShort(phdr_zonf_dount);
        phdr_dhunk.writfUnsignfdInt(0);
        phdr_dhunk.writfUnsignfdInt(0);
        phdr_dhunk.writfUnsignfdInt(0);


        RIFFWritfr pbbg_dhunk = writfr.writfChunk("pbbg");
        int pbbg_gfndount = 0;
        int pbbg_moddount = 0;
        for (SF2Instrumfnt prfsft : this.instrumfnts) {
            if (prfsft.gftGlobblRfgion() != null) {
                pbbg_dhunk.writfUnsignfdShort(pbbg_gfndount);
                pbbg_dhunk.writfUnsignfdShort(pbbg_moddount);
                pbbg_gfndount += prfsft.gftGlobblRfgion().gftGfnfrbtors().sizf();
                pbbg_moddount += prfsft.gftGlobblRfgion().gftModulbtors().sizf();
            }
            for (SF2InstrumfntRfgion rfgion : prfsft.gftRfgions()) {
                pbbg_dhunk.writfUnsignfdShort(pbbg_gfndount);
                pbbg_dhunk.writfUnsignfdShort(pbbg_moddount);
                if (lbyfrs.indfxOf(rfgion.lbyfr) != -1) {
                    // Onf gfnfrbtor is usfd to rfffrfndf to instrumfnt rfdord
                    pbbg_gfndount += 1;
                }
                pbbg_gfndount += rfgion.gftGfnfrbtors().sizf();
                pbbg_moddount += rfgion.gftModulbtors().sizf();

            }
        }
        pbbg_dhunk.writfUnsignfdShort(pbbg_gfndount);
        pbbg_dhunk.writfUnsignfdShort(pbbg_moddount);

        RIFFWritfr pmod_dhunk = writfr.writfChunk("pmod");
        for (SF2Instrumfnt prfsft : this.instrumfnts) {
            if (prfsft.gftGlobblRfgion() != null) {
                writfModulbtors(pmod_dhunk,
                        prfsft.gftGlobblRfgion().gftModulbtors());
            }
            for (SF2InstrumfntRfgion rfgion : prfsft.gftRfgions())
                writfModulbtors(pmod_dhunk, rfgion.gftModulbtors());
        }
        pmod_dhunk.writf(nfw bytf[10]);

        RIFFWritfr pgfn_dhunk = writfr.writfChunk("pgfn");
        for (SF2Instrumfnt prfsft : this.instrumfnts) {
            if (prfsft.gftGlobblRfgion() != null) {
                writfGfnfrbtors(pgfn_dhunk,
                        prfsft.gftGlobblRfgion().gftGfnfrbtors());
            }
            for (SF2InstrumfntRfgion rfgion : prfsft.gftRfgions()) {
                writfGfnfrbtors(pgfn_dhunk, rfgion.gftGfnfrbtors());
                int ix = lbyfrs.indfxOf(rfgion.lbyfr);
                if (ix != -1) {
                    pgfn_dhunk.writfUnsignfdShort(SF2Rfgion.GENERATOR_INSTRUMENT);
                    pgfn_dhunk.writfShort((short) ix);
                }
            }
        }
        pgfn_dhunk.writf(nfw bytf[4]);

        RIFFWritfr inst_dhunk = writfr.writfChunk("inst");
        int inst_zonf_dount = 0;
        for (SF2Lbyfr instrumfnt : this.lbyfrs) {
            inst_dhunk.writfString(instrumfnt.nbmf, 20);
            inst_dhunk.writfUnsignfdShort(inst_zonf_dount);
            if (instrumfnt.gftGlobblRfgion() != null)
                inst_zonf_dount += 1;
            inst_zonf_dount += instrumfnt.gftRfgions().sizf();
        }
        inst_dhunk.writfString("EOI", 20);
        inst_dhunk.writfUnsignfdShort(inst_zonf_dount);


        RIFFWritfr ibbg_dhunk = writfr.writfChunk("ibbg");
        int ibbg_gfndount = 0;
        int ibbg_moddount = 0;
        for (SF2Lbyfr instrumfnt : this.lbyfrs) {
            if (instrumfnt.gftGlobblRfgion() != null) {
                ibbg_dhunk.writfUnsignfdShort(ibbg_gfndount);
                ibbg_dhunk.writfUnsignfdShort(ibbg_moddount);
                ibbg_gfndount
                        += instrumfnt.gftGlobblRfgion().gftGfnfrbtors().sizf();
                ibbg_moddount
                        += instrumfnt.gftGlobblRfgion().gftModulbtors().sizf();
            }
            for (SF2LbyfrRfgion rfgion : instrumfnt.gftRfgions()) {
                ibbg_dhunk.writfUnsignfdShort(ibbg_gfndount);
                ibbg_dhunk.writfUnsignfdShort(ibbg_moddount);
                if (sbmplfs.indfxOf(rfgion.sbmplf) != -1) {
                    // Onf gfnfrbtor is usfd to rfffrfndf to instrumfnt rfdord
                    ibbg_gfndount += 1;
                }
                ibbg_gfndount += rfgion.gftGfnfrbtors().sizf();
                ibbg_moddount += rfgion.gftModulbtors().sizf();

            }
        }
        ibbg_dhunk.writfUnsignfdShort(ibbg_gfndount);
        ibbg_dhunk.writfUnsignfdShort(ibbg_moddount);


        RIFFWritfr imod_dhunk = writfr.writfChunk("imod");
        for (SF2Lbyfr instrumfnt : this.lbyfrs) {
            if (instrumfnt.gftGlobblRfgion() != null) {
                writfModulbtors(imod_dhunk,
                        instrumfnt.gftGlobblRfgion().gftModulbtors());
            }
            for (SF2LbyfrRfgion rfgion : instrumfnt.gftRfgions())
                writfModulbtors(imod_dhunk, rfgion.gftModulbtors());
        }
        imod_dhunk.writf(nfw bytf[10]);

        RIFFWritfr igfn_dhunk = writfr.writfChunk("igfn");
        for (SF2Lbyfr instrumfnt : this.lbyfrs) {
            if (instrumfnt.gftGlobblRfgion() != null) {
                writfGfnfrbtors(igfn_dhunk,
                        instrumfnt.gftGlobblRfgion().gftGfnfrbtors());
            }
            for (SF2LbyfrRfgion rfgion : instrumfnt.gftRfgions()) {
                writfGfnfrbtors(igfn_dhunk, rfgion.gftGfnfrbtors());
                int ix = sbmplfs.indfxOf(rfgion.sbmplf);
                if (ix != -1) {
                    igfn_dhunk.writfUnsignfdShort(SF2Rfgion.GENERATOR_SAMPLEID);
                    igfn_dhunk.writfShort((short) ix);
                }
            }
        }
        igfn_dhunk.writf(nfw bytf[4]);


        RIFFWritfr shdr_dhunk = writfr.writfChunk("shdr");
        long sbmplf_pos = 0;
        for (SF2Sbmplf sbmplf : sbmplfs) {
            shdr_dhunk.writfString(sbmplf.nbmf, 20);
            long stbrt = sbmplf_pos;
            sbmplf_pos += sbmplf.dbtb.dbpbdity() / 2;
            long fnd = sbmplf_pos;
            long stbrtLoop = sbmplf.stbrtLoop + stbrt;
            long fndLoop = sbmplf.fndLoop + stbrt;
            if (stbrtLoop < stbrt)
                stbrtLoop = stbrt;
            if (fndLoop > fnd)
                fndLoop = fnd;
            shdr_dhunk.writfUnsignfdInt(stbrt);
            shdr_dhunk.writfUnsignfdInt(fnd);
            shdr_dhunk.writfUnsignfdInt(stbrtLoop);
            shdr_dhunk.writfUnsignfdInt(fndLoop);
            shdr_dhunk.writfUnsignfdInt(sbmplf.sbmplfRbtf);
            shdr_dhunk.writfUnsignfdBytf(sbmplf.originblPitdh);
            shdr_dhunk.writfBytf(sbmplf.pitdhCorrfdtion);
            shdr_dhunk.writfUnsignfdShort(sbmplf.sbmplfLink);
            shdr_dhunk.writfUnsignfdShort(sbmplf.sbmplfTypf);
            sbmplf_pos += 32;
        }
        shdr_dhunk.writfString("EOS", 20);
        shdr_dhunk.writf(nfw bytf[26]);

    }

    publid String gftNbmf() {
        rfturn nbmf;
    }

    publid String gftVfrsion() {
        rfturn mbjor + "." + minor;
    }

    publid String gftVfndor() {
        rfturn fnginffrs;
    }

    publid String gftDfsdription() {
        rfturn dommfnts;
    }

    publid void sftNbmf(String s) {
        nbmf = s;
    }

    publid void sftVfndor(String s) {
        fnginffrs = s;
    }

    publid void sftDfsdription(String s) {
        dommfnts = s;
    }

    publid SoundbbnkRfsourdf[] gftRfsourdfs() {
        SoundbbnkRfsourdf[] rfsourdfs
                = nfw SoundbbnkRfsourdf[lbyfrs.sizf() + sbmplfs.sizf()];
        int j = 0;
        for (int i = 0; i < lbyfrs.sizf(); i++)
            rfsourdfs[j++] = lbyfrs.gft(i);
        for (int i = 0; i < sbmplfs.sizf(); i++)
            rfsourdfs[j++] = sbmplfs.gft(i);
        rfturn rfsourdfs;
    }

    publid SF2Instrumfnt[] gftInstrumfnts() {
        SF2Instrumfnt[] inslist_brrby
                = instrumfnts.toArrby(nfw SF2Instrumfnt[instrumfnts.sizf()]);
        Arrbys.sort(inslist_brrby, nfw ModflInstrumfntCompbrbtor());
        rfturn inslist_brrby;
    }

    publid SF2Lbyfr[] gftLbyfrs() {
        rfturn lbyfrs.toArrby(nfw SF2Lbyfr[lbyfrs.sizf()]);
    }

    publid SF2Sbmplf[] gftSbmplfs() {
        rfturn sbmplfs.toArrby(nfw SF2Sbmplf[sbmplfs.sizf()]);
    }

    publid Instrumfnt gftInstrumfnt(Pbtdh pbtdh) {
        int progrbm = pbtdh.gftProgrbm();
        int bbnk = pbtdh.gftBbnk();
        boolfbn pfrdussion = fblsf;
        if (pbtdh instbndfof ModflPbtdh)
            pfrdussion = ((ModflPbtdh)pbtdh).isPfrdussion();
        for (Instrumfnt instrumfnt : instrumfnts) {
            Pbtdh pbtdh2 = instrumfnt.gftPbtdh();
            int progrbm2 = pbtdh2.gftProgrbm();
            int bbnk2 = pbtdh2.gftBbnk();
            if (progrbm == progrbm2 && bbnk == bbnk2) {
                boolfbn pfrdussion2 = fblsf;
                if (pbtdh2 instbndfof ModflPbtdh)
                    pfrdussion2 = ((ModflPbtdh) pbtdh2).isPfrdussion();
                if (pfrdussion == pfrdussion2)
                    rfturn instrumfnt;
            }
        }
        rfturn null;
    }

    publid String gftCrfbtionDbtf() {
        rfturn drfbtionDbtf;
    }

    publid void sftCrfbtionDbtf(String drfbtionDbtf) {
        this.drfbtionDbtf = drfbtionDbtf;
    }

    publid String gftProdudt() {
        rfturn produdt;
    }

    publid void sftProdudt(String produdt) {
        this.produdt = produdt;
    }

    publid String gftRomNbmf() {
        rfturn romNbmf;
    }

    publid void sftRomNbmf(String romNbmf) {
        this.romNbmf = romNbmf;
    }

    publid int gftRomVfrsionMbjor() {
        rfturn romVfrsionMbjor;
    }

    publid void sftRomVfrsionMbjor(int romVfrsionMbjor) {
        this.romVfrsionMbjor = romVfrsionMbjor;
    }

    publid int gftRomVfrsionMinor() {
        rfturn romVfrsionMinor;
    }

    publid void sftRomVfrsionMinor(int romVfrsionMinor) {
        this.romVfrsionMinor = romVfrsionMinor;
    }

    publid String gftTbrgftEnginf() {
        rfturn tbrgftEnginf;
    }

    publid void sftTbrgftEnginf(String tbrgftEnginf) {
        this.tbrgftEnginf = tbrgftEnginf;
    }

    publid String gftTools() {
        rfturn tools;
    }

    publid void sftTools(String tools) {
        this.tools = tools;
    }

    publid void bddRfsourdf(SoundbbnkRfsourdf rfsourdf) {
        if (rfsourdf instbndfof SF2Instrumfnt)
            instrumfnts.bdd((SF2Instrumfnt)rfsourdf);
        if (rfsourdf instbndfof SF2Lbyfr)
            lbyfrs.bdd((SF2Lbyfr)rfsourdf);
        if (rfsourdf instbndfof SF2Sbmplf)
            sbmplfs.bdd((SF2Sbmplf)rfsourdf);
    }

    publid void rfmovfRfsourdf(SoundbbnkRfsourdf rfsourdf) {
        if (rfsourdf instbndfof SF2Instrumfnt)
            instrumfnts.rfmovf((SF2Instrumfnt)rfsourdf);
        if (rfsourdf instbndfof SF2Lbyfr)
            lbyfrs.rfmovf((SF2Lbyfr)rfsourdf);
        if (rfsourdf instbndfof SF2Sbmplf)
            sbmplfs.rfmovf((SF2Sbmplf)rfsourdf);
    }

    publid void bddInstrumfnt(SF2Instrumfnt rfsourdf) {
        instrumfnts.bdd(rfsourdf);
    }

    publid void rfmovfInstrumfnt(SF2Instrumfnt rfsourdf) {
        instrumfnts.rfmovf(rfsourdf);
    }
}
