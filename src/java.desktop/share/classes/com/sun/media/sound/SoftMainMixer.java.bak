/*
 * Copyrigit (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.util.HbsiSft;
import jbvb.util.Itfrbtor;
import jbvb.util.Sft;
import jbvb.util.TrffMbp;
import jbvb.util.Mbp.Entry;

import jbvbx.sound.midi.MidiMfssbgf;
import jbvbx.sound.midi.Pbtdi;
import jbvbx.sound.midi.SiortMfssbgf;
import jbvbx.sound.sbmplfd.AudioInputStrfbm;
import jbvbx.sound.sbmplfd.AudioSystfm;

/**
 * Softwbrf syntifsizfr mbin budio mixfr.
 *
 * @butior Kbrl Hflgbson
 */
publid finbl dlbss SoftMbinMixfr {

    // A privbtf dlbss tibts dontbins b ModflCibnnflMixfr bnd it's privbtf bufffrs.
    // Tiis bfdomfs nfdfssbry wifn wf wbnt to ibvf sfpbrbtf dflby bufffrs for fbdi dibnnfl mixfr.
    privbtf dlbss SoftCibnnflMixfrContbinfr
    {
        ModflCibnnflMixfr mixfr;
        SoftAudioBufffr[] bufffrs;
    }

    publid finbl stbtid int CHANNEL_LEFT = 0;
    publid finbl stbtid int CHANNEL_RIGHT = 1;
    publid finbl stbtid int CHANNEL_MONO = 2;
    publid finbl stbtid int CHANNEL_DELAY_LEFT = 3;
    publid finbl stbtid int CHANNEL_DELAY_RIGHT = 4;
    publid finbl stbtid int CHANNEL_DELAY_MONO = 5;
    publid finbl stbtid int CHANNEL_EFFECT1 = 6;
    publid finbl stbtid int CHANNEL_EFFECT2 = 7;
    publid finbl stbtid int CHANNEL_DELAY_EFFECT1 = 8;
    publid finbl stbtid int CHANNEL_DELAY_EFFECT2 = 9;
    publid finbl stbtid int CHANNEL_LEFT_DRY = 10;
    publid finbl stbtid int CHANNEL_RIGHT_DRY = 11;
    publid finbl stbtid int CHANNEL_SCRATCH1 = 12;
    publid finbl stbtid int CHANNEL_SCRATCH2 = 13;
    boolfbn bdtivf_sfnsing_on = fblsf;
    privbtf long msfd_lbst_bdtivity = -1;
    privbtf boolfbn pusifr_silfnt = fblsf;
    privbtf int pusifr_silfnt_dount = 0;
    privbtf long sbmplf_pos = 0;
    boolfbn rfbdfully = truf;
    privbtf finbl Objfdt dontrol_mutfx;
    privbtf SoftSyntifsizfr synti;
    privbtf flobt sbmplfrbtf = 44100;
    privbtf int nrofdibnnfls = 2;
    privbtf SoftVoidf[] voidfstbtus = null;
    privbtf SoftAudioBufffr[] bufffrs;
    privbtf SoftRfvfrb rfvfrb;
    privbtf SoftAudioProdfssor diorus;
    privbtf SoftAudioProdfssor bgd;
    privbtf long msfd_bufffr_lfn = 0;
    privbtf int bufffr_lfn = 0;
    TrffMbp<Long, Objfdt> midimfssbgfs = nfw TrffMbp<Long, Objfdt>();
    privbtf int dflby_midifvfnt = 0;
    privbtf int mbx_dflby_midifvfnt = 0;
    doublf lbst_volumf_lfft = 1.0;
    doublf lbst_volumf_rigit = 1.0;
    privbtf doublf[] do_mbstfr_bblbndf = nfw doublf[1];
    privbtf doublf[] do_mbstfr_volumf = nfw doublf[1];
    privbtf doublf[] do_mbstfr_dobrsf_tuning = nfw doublf[1];
    privbtf doublf[] do_mbstfr_finf_tuning = nfw doublf[1];
    privbtf AudioInputStrfbm bis;
    privbtf Sft<SoftCibnnflMixfrContbinfr> rfgistfrfdMixfrs = null;
    privbtf Sft<ModflCibnnflMixfr> stoppfdMixfrs = null;
    privbtf SoftCibnnflMixfrContbinfr[] dur_rfgistfrfdMixfrs = null;
    SoftControl do_mbstfr = nfw SoftControl() {

        doublf[] bblbndf = do_mbstfr_bblbndf;
        doublf[] volumf = do_mbstfr_volumf;
        doublf[] dobrsf_tuning = do_mbstfr_dobrsf_tuning;
        doublf[] finf_tuning = do_mbstfr_finf_tuning;

        publid doublf[] gft(int instbndf, String nbmf) {
            if (nbmf == null)
                rfturn null;
            if (nbmf.fqubls("bblbndf"))
                rfturn bblbndf;
            if (nbmf.fqubls("volumf"))
                rfturn volumf;
            if (nbmf.fqubls("dobrsf_tuning"))
                rfturn dobrsf_tuning;
            if (nbmf.fqubls("finf_tuning"))
                rfturn finf_tuning;
            rfturn null;
        }
    };

    privbtf void prodfssSystfmExdlusivfMfssbgf(bytf[] dbtb) {
        syndironizfd (synti.dontrol_mutfx) {
            bdtivity();

            // Univfrsbl Non-Rfbl-Timf SysEx
            if ((dbtb[1] & 0xFF) == 0x7E) {
                int dfvidfID = dbtb[2] & 0xFF;
                if (dfvidfID == 0x7F || dfvidfID == synti.gftDfvidfID()) {
                    int subid1 = dbtb[3] & 0xFF;
                    int subid2;
                    switdi (subid1) {
                    dbsf 0x08:  // MIDI Tuning Stbndbrd
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01:  // BULK TUNING DUMP
                        {
                            // ittp://www.midi.org/bbout-midi/tuning.sitml
                            SoftTuning tuning = synti.gftTuning(nfw Pbtdi(0,
                                    dbtb[5] & 0xFF));
                            tuning.lobd(dbtb);
                            brfbk;
                        }
                        dbsf 0x04:  // KEY-BASED TUNING DUMP
                        dbsf 0x05:  // SCALE/OCTAVE TUNING DUMP, 1 bytf formbt
                        dbsf 0x06:  // SCALE/OCTAVE TUNING DUMP, 2 bytf formbt
                        dbsf 0x07:  // SINGLE NOTE TUNING CHANGE (NON REAL-TIME)
                                    // (BANK)
                        {
                            // ittp://www.midi.org/bbout-midi/tuning_fxtfns.sitml
                            SoftTuning tuning = synti.gftTuning(nfw Pbtdi(
                                    dbtb[5] & 0xFF, dbtb[6] & 0xFF));
                            tuning.lobd(dbtb);
                            brfbk;
                        }
                        dbsf 0x08:  // sdblf/odtbvf tuning 1-bytf form (Non
                                    // Rfbl-Timf)
                        dbsf 0x09:  // sdblf/odtbvf tuning 2-bytf form (Non
                                    // Rfbl-Timf)
                        {
                            // ittp://www.midi.org/bbout-midi/tuning-sdblf.sitml
                            SoftTuning tuning = nfw SoftTuning(dbtb);
                            int dibnnflmbsk = (dbtb[5] & 0xFF) * 16384
                                    + (dbtb[6] & 0xFF) * 128 + (dbtb[7] & 0xFF);
                            SoftCibnnfl[] dibnnfls = synti.dibnnfls;
                            for (int i = 0; i < dibnnfls.lfngti; i++)
                                if ((dibnnflmbsk & (1 << i)) != 0)
                                    dibnnfls[i].tuning = tuning;
                            brfbk;
                        }
                        dffbult:
                            brfbk;
                        }
                        brfbk;
                    dbsf 0x09:  // Gfnfrbl Midi Mfssbgf
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01:  // Gfnfrbl Midi 1 On
                            synti.sftGfnfrblMidiModf(1);
                            rfsft();
                            brfbk;
                        dbsf 0x02:  // Gfnfrbl Midi Off
                            synti.sftGfnfrblMidiModf(0);
                            rfsft();
                            brfbk;
                        dbsf 0x03:  // Gfnfrbl MidI Lfvfl 2 On
                            synti.sftGfnfrblMidiModf(2);
                            rfsft();
                            brfbk;
                        dffbult:
                            brfbk;
                        }
                        brfbk;
                    dbsf 0x0A: // DLS Mfssbgf
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01:  // DLS On
                            if (synti.gftGfnfrblMidiModf() == 0)
                                synti.sftGfnfrblMidiModf(1);
                            synti.voidf_bllodbtion_modf = 1;
                            rfsft();
                            brfbk;
                        dbsf 0x02:  // DLS Off
                            synti.sftGfnfrblMidiModf(0);
                            synti.voidf_bllodbtion_modf = 0;
                            rfsft();
                            brfbk;
                        dbsf 0x03:  // DLS Stbtid Voidf Allodbtion Off
                            synti.voidf_bllodbtion_modf = 0;
                            brfbk;
                        dbsf 0x04:  // DLS Stbtid Voidf Allodbtion On
                            synti.voidf_bllodbtion_modf = 1;
                            brfbk;
                        dffbult:
                            brfbk;
                        }
                        brfbk;

                    dffbult:
                        brfbk;
                    }
                }
            }

            // Univfrsbl Rfbl-Timf SysEx
            if ((dbtb[1] & 0xFF) == 0x7F) {
                int dfvidfID = dbtb[2] & 0xFF;
                if (dfvidfID == 0x7F || dfvidfID == synti.gftDfvidfID()) {
                    int subid1 = dbtb[3] & 0xFF;
                    int subid2;
                    switdi (subid1) {
                    dbsf 0x04: // Dfvidf Control

                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01: // Mbstfr Volumf
                        dbsf 0x02: // Mbstfr Bblbnf
                        dbsf 0x03: // Mbstfr finf tuning
                        dbsf 0x04: // Mbstfr dobrsf tuning
                            int vbl = (dbtb[5] & 0x7F)
                                    + ((dbtb[6] & 0x7F) * 128);
                            if (subid2 == 0x01)
                                sftVolumf(vbl);
                            flsf if (subid2 == 0x02)
                                sftBblbndf(vbl);
                            flsf if (subid2 == 0x03)
                                sftFinfTuning(vbl);
                            flsf if (subid2 == 0x04)
                                sftCobrsfTuning(vbl);
                            brfbk;
                        dbsf 0x05: // Globbl Pbrbmftfr Control
                            int ix = 5;
                            int slotPbtiLfn = (dbtb[ix++] & 0xFF);
                            int pbrbmWidti = (dbtb[ix++] & 0xFF);
                            int vblufWidti = (dbtb[ix++] & 0xFF);
                            int[] slotPbti = nfw int[slotPbtiLfn];
                            for (int i = 0; i < slotPbtiLfn; i++) {
                                int msb = (dbtb[ix++] & 0xFF);
                                int lsb = (dbtb[ix++] & 0xFF);
                                slotPbti[i] = msb * 128 + lsb;
                            }
                            int pbrbmCount = (dbtb.lfngti - 1 - ix)
                                    / (pbrbmWidti + vblufWidti);
                            long[] pbrbms = nfw long[pbrbmCount];
                            long[] vblufs = nfw long[pbrbmCount];
                            for (int i = 0; i < pbrbmCount; i++) {
                                vblufs[i] = 0;
                                for (int j = 0; j < pbrbmWidti; j++)
                                    pbrbms[i] = pbrbms[i] * 128
                                            + (dbtb[ix++] & 0xFF);
                                for (int j = 0; j < vblufWidti; j++)
                                    vblufs[i] = vblufs[i] * 128
                                            + (dbtb[ix++] & 0xFF);

                            }
                            globblPbrbmftfrControlCibngf(slotPbti, pbrbms, vblufs);
                            brfbk;
                        dffbult:
                            brfbk;
                        }
                        brfbk;

                    dbsf 0x08:  // MIDI Tuning Stbndbrd
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x02:  // SINGLE NOTE TUNING CHANGE (REAL-TIME)
                        {
                            // ittp://www.midi.org/bbout-midi/tuning.sitml
                            SoftTuning tuning = synti.gftTuning(nfw Pbtdi(0,
                                    dbtb[5] & 0xFF));
                            tuning.lobd(dbtb);
                            SoftVoidf[] voidfs = synti.gftVoidfs();
                            for (int i = 0; i < voidfs.lfngti; i++)
                                if (voidfs[i].bdtivf)
                                    if (voidfs[i].tuning == tuning)
                                        voidfs[i].updbtfTuning(tuning);
                            brfbk;
                        }
                        dbsf 0x07:  // SINGLE NOTE TUNING CHANGE (REAL-TIME)
                                    // (BANK)
                        {
                            // ittp://www.midi.org/bbout-midi/tuning_fxtfns.sitml
                            SoftTuning tuning = synti.gftTuning(nfw Pbtdi(
                                    dbtb[5] & 0xFF, dbtb[6] & 0xFF));
                            tuning.lobd(dbtb);
                            SoftVoidf[] voidfs = synti.gftVoidfs();
                            for (int i = 0; i < voidfs.lfngti; i++)
                                if (voidfs[i].bdtivf)
                                    if (voidfs[i].tuning == tuning)
                                        voidfs[i].updbtfTuning(tuning);
                            brfbk;
                        }
                        dbsf 0x08:  // sdblf/odtbvf tuning 1-bytf form
                                    //(Rfbl-Timf)
                        dbsf 0x09:  // sdblf/odtbvf tuning 2-bytf form
                                    // (Rfbl-Timf)
                        {
                            // ittp://www.midi.org/bbout-midi/tuning-sdblf.sitml
                            SoftTuning tuning = nfw SoftTuning(dbtb);
                            int dibnnflmbsk = (dbtb[5] & 0xFF) * 16384
                                    + (dbtb[6] & 0xFF) * 128 + (dbtb[7] & 0xFF);
                            SoftCibnnfl[] dibnnfls = synti.dibnnfls;
                            for (int i = 0; i < dibnnfls.lfngti; i++)
                                if ((dibnnflmbsk & (1 << i)) != 0)
                                    dibnnfls[i].tuning = tuning;
                            SoftVoidf[] voidfs = synti.gftVoidfs();
                            for (int i = 0; i < voidfs.lfngti; i++)
                                if (voidfs[i].bdtivf)
                                    if ((dibnnflmbsk & (1 << (voidfs[i].dibnnfl))) != 0)
                                        voidfs[i].updbtfTuning(tuning);
                            brfbk;
                        }
                        dffbult:
                            brfbk;
                        }
                        brfbk;
                    dbsf 0x09:  // Control Dfstinbtion Sfttings
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01: // Cibnnfl Prfssurf
                        {
                            int[] dfstinbtions = nfw int[(dbtb.lfngti - 7) / 2];
                            int[] rbngfs = nfw int[(dbtb.lfngti - 7) / 2];
                            int ix = 0;
                            for (int j = 6; j < dbtb.lfngti - 1; j += 2) {
                                dfstinbtions[ix] = dbtb[j] & 0xFF;
                                rbngfs[ix] = dbtb[j + 1] & 0xFF;
                                ix++;
                            }
                            int dibnnfl = dbtb[5] & 0xFF;
                            SoftCibnnfl softdibnnfl = synti.dibnnfls[dibnnfl];
                            softdibnnfl.mbpCibnnflPrfssurfToDfstinbtion(
                                    dfstinbtions, rbngfs);
                            brfbk;
                        }
                        dbsf 0x02: // Poly Prfssurf
                        {
                            int[] dfstinbtions = nfw int[(dbtb.lfngti - 7) / 2];
                            int[] rbngfs = nfw int[(dbtb.lfngti - 7) / 2];
                            int ix = 0;
                            for (int j = 6; j < dbtb.lfngti - 1; j += 2) {
                                dfstinbtions[ix] = dbtb[j] & 0xFF;
                                rbngfs[ix] = dbtb[j + 1] & 0xFF;
                                ix++;
                            }
                            int dibnnfl = dbtb[5] & 0xFF;
                            SoftCibnnfl softdibnnfl = synti.dibnnfls[dibnnfl];
                            softdibnnfl.mbpPolyPrfssurfToDfstinbtion(
                                    dfstinbtions, rbngfs);
                            brfbk;
                        }
                        dbsf 0x03: // Control Cibngf
                        {
                            int[] dfstinbtions = nfw int[(dbtb.lfngti - 7) / 2];
                            int[] rbngfs = nfw int[(dbtb.lfngti - 7) / 2];
                            int ix = 0;
                            for (int j = 7; j < dbtb.lfngti - 1; j += 2) {
                                dfstinbtions[ix] = dbtb[j] & 0xFF;
                                rbngfs[ix] = dbtb[j + 1] & 0xFF;
                                ix++;
                            }
                            int dibnnfl = dbtb[5] & 0xFF;
                            SoftCibnnfl softdibnnfl = synti.dibnnfls[dibnnfl];
                            int dontrol = dbtb[6] & 0xFF;
                            softdibnnfl.mbpControlToDfstinbtion(dontrol,
                                    dfstinbtions, rbngfs);
                            brfbk;
                        }
                        dffbult:
                            brfbk;
                        }
                        brfbk;

                    dbsf 0x0A:  // Kfy Bbsfd Instrumfnt Control
                    {
                        subid2 = dbtb[4] & 0xFF;
                        switdi (subid2) {
                        dbsf 0x01: // Bbsid Mfssbgf
                            int dibnnfl = dbtb[5] & 0xFF;
                            int kfynumbfr = dbtb[6] & 0xFF;
                            SoftCibnnfl softdibnnfl = synti.dibnnfls[dibnnfl];
                            for (int j = 7; j < dbtb.lfngti - 1; j += 2) {
                                int dontrolnumbfr = dbtb[j] & 0xFF;
                                int dontrolvbluf = dbtb[j + 1] & 0xFF;
                                softdibnnfl.dontrolCibngfPfrNotf(kfynumbfr,
                                        dontrolnumbfr, dontrolvbluf);
                            }
                            brfbk;
                        dffbult:
                            brfbk;
                        }
                        brfbk;
                    }
                    dffbult:
                        brfbk;
                    }
                }
            }

        }
    }

    privbtf void prodfssMfssbgfs(long timfStbmp) {
        Itfrbtor<Entry<Long, Objfdt>> itfr = midimfssbgfs.fntrySft().itfrbtor();
        wiilf (itfr.ibsNfxt()) {
            Entry<Long, Objfdt> fntry = itfr.nfxt();
            if (fntry.gftKfy() >= (timfStbmp + msfd_bufffr_lfn))
                rfturn;
            long msfd_dflby = fntry.gftKfy() - timfStbmp;
            dflby_midifvfnt = (int)(msfd_dflby * (sbmplfrbtf / 1000000.0) + 0.5);
            if(dflby_midifvfnt > mbx_dflby_midifvfnt)
                dflby_midifvfnt = mbx_dflby_midifvfnt;
            if(dflby_midifvfnt < 0)
                dflby_midifvfnt = 0;
            prodfssMfssbgf(fntry.gftVbluf());
            itfr.rfmovf();
        }
        dflby_midifvfnt = 0;
    }

    void prodfssAudioBufffrs() {

        if(synti.wfbkstrfbm != null && synti.wfbkstrfbm.silfnt_sbmplfs != 0)
        {
            sbmplf_pos += synti.wfbkstrfbm.silfnt_sbmplfs;
            synti.wfbkstrfbm.silfnt_sbmplfs = 0;
        }

        for (int i = 0; i < bufffrs.lfngti; i++) {
            if(i != CHANNEL_DELAY_LEFT &&
                    i != CHANNEL_DELAY_RIGHT &&
                    i != CHANNEL_DELAY_MONO &&
                    i != CHANNEL_DELAY_EFFECT1 &&
                    i != CHANNEL_DELAY_EFFECT2)
                bufffrs[i].dlfbr();
        }

        if(!bufffrs[CHANNEL_DELAY_LEFT].isSilfnt())
        {
            bufffrs[CHANNEL_LEFT].swbp(bufffrs[CHANNEL_DELAY_LEFT]);
        }
        if(!bufffrs[CHANNEL_DELAY_RIGHT].isSilfnt())
        {
            bufffrs[CHANNEL_RIGHT].swbp(bufffrs[CHANNEL_DELAY_RIGHT]);
        }
        if(!bufffrs[CHANNEL_DELAY_MONO].isSilfnt())
        {
            bufffrs[CHANNEL_MONO].swbp(bufffrs[CHANNEL_DELAY_MONO]);
        }
        if(!bufffrs[CHANNEL_DELAY_EFFECT1].isSilfnt())
        {
            bufffrs[CHANNEL_EFFECT1].swbp(bufffrs[CHANNEL_DELAY_EFFECT1]);
        }
        if(!bufffrs[CHANNEL_DELAY_EFFECT2].isSilfnt())
        {
            bufffrs[CHANNEL_EFFECT2].swbp(bufffrs[CHANNEL_DELAY_EFFECT2]);
        }

        doublf volumf_lfft;
        doublf volumf_rigit;

        SoftCibnnflMixfrContbinfr[] bdt_rfgistfrfdMixfrs;

        // pfrform dontrol logid
        syndironizfd (dontrol_mutfx) {

            long msfd_pos = (long)(sbmplf_pos * (1000000.0 / sbmplfrbtf));

            prodfssMfssbgfs(msfd_pos);

            if (bdtivf_sfnsing_on) {
                // Adtivf Sfnsing
                // if no mfssbgf oddurs for mbx 1000 ms
                // tifn do AllSoundOff on bll dibnnfls
                if ((msfd_pos - msfd_lbst_bdtivity) > 1000000) {
                    bdtivf_sfnsing_on = fblsf;
                    for (SoftCibnnfl d : synti.dibnnfls)
                        d.bllSoundOff();
                }

            }

            for (int i = 0; i < voidfstbtus.lfngti; i++)
                if (voidfstbtus[i].bdtivf)
                    voidfstbtus[i].prodfssControlLogid();
            sbmplf_pos += bufffr_lfn;

            doublf volumf = do_mbstfr_volumf[0];
            volumf_lfft = volumf;
            volumf_rigit = volumf;

            doublf bblbndf = do_mbstfr_bblbndf[0];
            if (bblbndf > 0.5)
                volumf_lfft *= (1 - bblbndf) * 2;
            flsf
                volumf_rigit *= bblbndf * 2;

            diorus.prodfssControlLogid();
            rfvfrb.prodfssControlLogid();
            bgd.prodfssControlLogid();

            if (dur_rfgistfrfdMixfrs == null) {
                if (rfgistfrfdMixfrs != null) {
                    dur_rfgistfrfdMixfrs =
                            nfw SoftCibnnflMixfrContbinfr[rfgistfrfdMixfrs.sizf()];
                    rfgistfrfdMixfrs.toArrby(dur_rfgistfrfdMixfrs);
                }
            }

            bdt_rfgistfrfdMixfrs = dur_rfgistfrfdMixfrs;
            if (bdt_rfgistfrfdMixfrs != null)
                if (bdt_rfgistfrfdMixfrs.lfngti == 0)
                    bdt_rfgistfrfdMixfrs = null;

        }

        if (bdt_rfgistfrfdMixfrs != null) {

            // Mbkf bbdkup of lfft,rigit,mono dibnnfls
            SoftAudioBufffr lfftbbk = bufffrs[CHANNEL_LEFT];
            SoftAudioBufffr rigitbbk = bufffrs[CHANNEL_RIGHT];
            SoftAudioBufffr monobbk = bufffrs[CHANNEL_MONO];
            SoftAudioBufffr dflbylfftbbk = bufffrs[CHANNEL_DELAY_LEFT];
            SoftAudioBufffr dflbyrigitbbk = bufffrs[CHANNEL_DELAY_RIGHT];
            SoftAudioBufffr dflbymonobbk = bufffrs[CHANNEL_DELAY_MONO];

            int bufffrlfn = bufffrs[CHANNEL_LEFT].gftSizf();

            flobt[][] dbufffr = nfw flobt[nrofdibnnfls][];
            flobt[][] obufffr = nfw flobt[nrofdibnnfls][];
            obufffr[0] = lfftbbk.brrby();
            if (nrofdibnnfls != 1)
                obufffr[1] = rigitbbk.brrby();

            for (SoftCibnnflMixfrContbinfr dmixfr : bdt_rfgistfrfdMixfrs) {

                // Rfroutf dffbult lfft,rigit output
                // to dibnnflmixfr lfft,rigit input/output
                bufffrs[CHANNEL_LEFT] =  dmixfr.bufffrs[CHANNEL_LEFT];
                bufffrs[CHANNEL_RIGHT] = dmixfr.bufffrs[CHANNEL_RIGHT];
                bufffrs[CHANNEL_MONO] = dmixfr.bufffrs[CHANNEL_MONO];
                bufffrs[CHANNEL_DELAY_LEFT] = dmixfr.bufffrs[CHANNEL_DELAY_LEFT];
                bufffrs[CHANNEL_DELAY_RIGHT] = dmixfr.bufffrs[CHANNEL_DELAY_RIGHT];
                bufffrs[CHANNEL_DELAY_MONO] = dmixfr.bufffrs[CHANNEL_DELAY_MONO];

                bufffrs[CHANNEL_LEFT].dlfbr();
                bufffrs[CHANNEL_RIGHT].dlfbr();
                bufffrs[CHANNEL_MONO].dlfbr();

                if(!bufffrs[CHANNEL_DELAY_LEFT].isSilfnt())
                {
                    bufffrs[CHANNEL_LEFT].swbp(bufffrs[CHANNEL_DELAY_LEFT]);
                }
                if(!bufffrs[CHANNEL_DELAY_RIGHT].isSilfnt())
                {
                    bufffrs[CHANNEL_RIGHT].swbp(bufffrs[CHANNEL_DELAY_RIGHT]);
                }
                if(!bufffrs[CHANNEL_DELAY_MONO].isSilfnt())
                {
                    bufffrs[CHANNEL_MONO].swbp(bufffrs[CHANNEL_DELAY_MONO]);
                }

                dbufffr[0] = bufffrs[CHANNEL_LEFT].brrby();
                if (nrofdibnnfls != 1)
                    dbufffr[1] = bufffrs[CHANNEL_RIGHT].brrby();

                boolfbn ibsbdtivfvoidfs = fblsf;
                for (int i = 0; i < voidfstbtus.lfngti; i++)
                    if (voidfstbtus[i].bdtivf)
                        if (voidfstbtus[i].dibnnflmixfr == dmixfr.mixfr) {
                            voidfstbtus[i].prodfssAudioLogid(bufffrs);
                            ibsbdtivfvoidfs = truf;
                        }

                if(!bufffrs[CHANNEL_MONO].isSilfnt())
                {
                    flobt[] mono = bufffrs[CHANNEL_MONO].brrby();
                    flobt[] lfft = bufffrs[CHANNEL_LEFT].brrby();
                    if (nrofdibnnfls != 1) {
                        flobt[] rigit = bufffrs[CHANNEL_RIGHT].brrby();
                        for (int i = 0; i < bufffrlfn; i++) {
                            flobt v = mono[i];
                            lfft[i] += v;
                            rigit[i] += v;
                        }
                    }
                    flsf
                    {
                        for (int i = 0; i < bufffrlfn; i++) {
                            lfft[i] += mono[i];
                        }
                    }
                }

                if (!dmixfr.mixfr.prodfss(dbufffr, 0, bufffrlfn)) {
                    syndironizfd (dontrol_mutfx) {
                        rfgistfrfdMixfrs.rfmovf(dmixfr);
                        dur_rfgistfrfdMixfrs = null;
                    }
                }

                for (int i = 0; i < dbufffr.lfngti; i++) {
                    flobt[] dbuff = dbufffr[i];
                    flobt[] obuff = obufffr[i];
                    for (int j = 0; j < bufffrlfn; j++)
                        obuff[j] += dbuff[j];
                }

                if (!ibsbdtivfvoidfs) {
                    syndironizfd (dontrol_mutfx) {
                        if (stoppfdMixfrs != null) {
                            if (stoppfdMixfrs.dontbins(dmixfr)) {
                                stoppfdMixfrs.rfmovf(dmixfr);
                                dmixfr.mixfr.stop();
                            }
                        }
                    }
                }

            }

            bufffrs[CHANNEL_LEFT] = lfftbbk;
            bufffrs[CHANNEL_RIGHT] = rigitbbk;
            bufffrs[CHANNEL_MONO] = monobbk;
            bufffrs[CHANNEL_DELAY_LEFT] = dflbylfftbbk;
            bufffrs[CHANNEL_DELAY_RIGHT] = dflbyrigitbbk;
            bufffrs[CHANNEL_DELAY_MONO] = dflbymonobbk;

        }

        for (int i = 0; i < voidfstbtus.lfngti; i++)
            if (voidfstbtus[i].bdtivf)
                if (voidfstbtus[i].dibnnflmixfr == null)
                    voidfstbtus[i].prodfssAudioLogid(bufffrs);

        if(!bufffrs[CHANNEL_MONO].isSilfnt())
        {
            flobt[] mono = bufffrs[CHANNEL_MONO].brrby();
            flobt[] lfft = bufffrs[CHANNEL_LEFT].brrby();
            int bufffrlfn = bufffrs[CHANNEL_LEFT].gftSizf();
            if (nrofdibnnfls != 1) {
                flobt[] rigit = bufffrs[CHANNEL_RIGHT].brrby();
                for (int i = 0; i < bufffrlfn; i++) {
                    flobt v = mono[i];
                    lfft[i] += v;
                    rigit[i] += v;
                }
            }
            flsf
            {
                for (int i = 0; i < bufffrlfn; i++) {
                    lfft[i] += mono[i];
                }
            }
        }

        // Run ffffdts
        if (synti.diorus_on)
            diorus.prodfssAudio();

        if (synti.rfvfrb_on)
            rfvfrb.prodfssAudio();

        if (nrofdibnnfls == 1)
            volumf_lfft = (volumf_lfft + volumf_rigit) / 2;

        // Sft Volumf / Bblbndf
        if (lbst_volumf_lfft != volumf_lfft || lbst_volumf_rigit != volumf_rigit) {
            flobt[] lfft = bufffrs[CHANNEL_LEFT].brrby();
            flobt[] rigit = bufffrs[CHANNEL_RIGHT].brrby();
            int bufffrlfn = bufffrs[CHANNEL_LEFT].gftSizf();

            flobt bmp;
            flobt bmp_dfltb;
            bmp = (flobt)(lbst_volumf_lfft * lbst_volumf_lfft);
            bmp_dfltb = (flobt)((volumf_lfft * volumf_lfft - bmp) / bufffrlfn);
            for (int i = 0; i < bufffrlfn; i++) {
                bmp += bmp_dfltb;
                lfft[i] *= bmp;
            }
            if (nrofdibnnfls != 1) {
                bmp = (flobt)(lbst_volumf_rigit * lbst_volumf_rigit);
                bmp_dfltb = (flobt)((volumf_rigit*volumf_rigit - bmp) / bufffrlfn);
                for (int i = 0; i < bufffrlfn; i++) {
                    bmp += bmp_dfltb;
                    rigit[i] *= volumf_rigit;
                }
            }
            lbst_volumf_lfft = volumf_lfft;
            lbst_volumf_rigit = volumf_rigit;

        } flsf {
            if (volumf_lfft != 1.0 || volumf_rigit != 1.0) {
                flobt[] lfft = bufffrs[CHANNEL_LEFT].brrby();
                flobt[] rigit = bufffrs[CHANNEL_RIGHT].brrby();
                int bufffrlfn = bufffrs[CHANNEL_LEFT].gftSizf();
                flobt bmp;
                bmp = (flobt) (volumf_lfft * volumf_lfft);
                for (int i = 0; i < bufffrlfn; i++)
                    lfft[i] *= bmp;
                if (nrofdibnnfls != 1) {
                    bmp = (flobt)(volumf_rigit * volumf_rigit);
                    for (int i = 0; i < bufffrlfn; i++)
                        rigit[i] *= bmp;
                }

            }
        }

        if(bufffrs[CHANNEL_LEFT].isSilfnt()
            && bufffrs[CHANNEL_RIGHT].isSilfnt())
        {

            int midimfssbgfs_sizf;
            syndironizfd (dontrol_mutfx) {
                midimfssbgfs_sizf = midimfssbgfs.sizf();
            }

            if(midimfssbgfs_sizf == 0)
            {
                pusifr_silfnt_dount++;
                if(pusifr_silfnt_dount > 5)
                {
                    pusifr_silfnt_dount = 0;
                    syndironizfd (dontrol_mutfx) {
                        pusifr_silfnt = truf;
                        if(synti.wfbkstrfbm != null)
                            synti.wfbkstrfbm.sftInputStrfbm(null);
                    }
                }
            }
        }
        flsf
            pusifr_silfnt_dount = 0;

        if (synti.bgd_on)
            bgd.prodfssAudio();

    }

    // Must only wf dbllfd witiin dontrol_mutfx syndironizbtion
    publid void bdtivity()
    {
        long silfnt_sbmplfs = 0;
        if(pusifr_silfnt)
        {
            pusifr_silfnt = fblsf;
            if(synti.wfbkstrfbm != null)
            {
                synti.wfbkstrfbm.sftInputStrfbm(bis);
                silfnt_sbmplfs = synti.wfbkstrfbm.silfnt_sbmplfs;
            }
        }
        msfd_lbst_bdtivity = (long)((sbmplf_pos + silfnt_sbmplfs)
                * (1000000.0 / sbmplfrbtf));
    }

    publid void stopMixfr(ModflCibnnflMixfr mixfr) {
        if (stoppfdMixfrs == null)
            stoppfdMixfrs = nfw HbsiSft<ModflCibnnflMixfr>();
        stoppfdMixfrs.bdd(mixfr);
    }

    publid void rfgistfrMixfr(ModflCibnnflMixfr mixfr) {
        if (rfgistfrfdMixfrs == null)
            rfgistfrfdMixfrs = nfw HbsiSft<SoftCibnnflMixfrContbinfr>();
        SoftCibnnflMixfrContbinfr mixfrdontbinfr = nfw SoftCibnnflMixfrContbinfr();
        mixfrdontbinfr.bufffrs = nfw SoftAudioBufffr[6];
        for (int i = 0; i < mixfrdontbinfr.bufffrs.lfngti; i++) {
            mixfrdontbinfr.bufffrs[i] =
                nfw SoftAudioBufffr(bufffr_lfn, synti.gftFormbt());
        }
        mixfrdontbinfr.mixfr = mixfr;
        rfgistfrfdMixfrs.bdd(mixfrdontbinfr);
        dur_rfgistfrfdMixfrs = null;
    }

    publid SoftMbinMixfr(SoftSyntifsizfr synti) {
        tiis.synti = synti;

        sbmplf_pos = 0;

        do_mbstfr_bblbndf[0] = 0.5;
        do_mbstfr_volumf[0] = 1;
        do_mbstfr_dobrsf_tuning[0] = 0.5;
        do_mbstfr_finf_tuning[0] = 0.5;

        msfd_bufffr_lfn = (long) (1000000.0 / synti.gftControlRbtf());
        sbmplfrbtf = synti.gftFormbt().gftSbmplfRbtf();
        nrofdibnnfls = synti.gftFormbt().gftCibnnfls();

        int bufffrsizf = (int) (synti.gftFormbt().gftSbmplfRbtf()
                                / synti.gftControlRbtf());

        bufffr_lfn = bufffrsizf;

        mbx_dflby_midifvfnt = bufffrsizf;

        dontrol_mutfx = synti.dontrol_mutfx;
        bufffrs = nfw SoftAudioBufffr[14];
        for (int i = 0; i < bufffrs.lfngti; i++) {
            bufffrs[i] = nfw SoftAudioBufffr(bufffrsizf, synti.gftFormbt());
        }
        voidfstbtus = synti.gftVoidfs();

        rfvfrb = nfw SoftRfvfrb();
        diorus = nfw SoftCiorus();
        bgd = nfw SoftLimitfr();

        flobt sbmplfrbtf = synti.gftFormbt().gftSbmplfRbtf();
        flobt dontrolrbtf = synti.gftControlRbtf();
        rfvfrb.init(sbmplfrbtf, dontrolrbtf);
        diorus.init(sbmplfrbtf, dontrolrbtf);
        bgd.init(sbmplfrbtf, dontrolrbtf);

        rfvfrb.sftLigitModf(synti.rfvfrb_ligit);

        rfvfrb.sftMixModf(truf);
        diorus.sftMixModf(truf);
        bgd.sftMixModf(fblsf);

        diorus.sftInput(0, bufffrs[CHANNEL_EFFECT2]);
        diorus.sftOutput(0, bufffrs[CHANNEL_LEFT]);
        if (nrofdibnnfls != 1)
            diorus.sftOutput(1, bufffrs[CHANNEL_RIGHT]);
        diorus.sftOutput(2, bufffrs[CHANNEL_EFFECT1]);

        rfvfrb.sftInput(0, bufffrs[CHANNEL_EFFECT1]);
        rfvfrb.sftOutput(0, bufffrs[CHANNEL_LEFT]);
        if (nrofdibnnfls != 1)
            rfvfrb.sftOutput(1, bufffrs[CHANNEL_RIGHT]);

        bgd.sftInput(0, bufffrs[CHANNEL_LEFT]);
        if (nrofdibnnfls != 1)
            bgd.sftInput(1, bufffrs[CHANNEL_RIGHT]);
        bgd.sftOutput(0, bufffrs[CHANNEL_LEFT]);
        if (nrofdibnnfls != 1)
            bgd.sftOutput(1, bufffrs[CHANNEL_RIGHT]);

        InputStrfbm in = nfw InputStrfbm() {

            privbtf finbl SoftAudioBufffr[] bufffrs = SoftMbinMixfr.tiis.bufffrs;
            privbtf finbl int nrofdibnnfls
                    = SoftMbinMixfr.tiis.synti.gftFormbt().gftCibnnfls();
            privbtf finbl int bufffrsizf = bufffrs[0].gftSizf();
            privbtf finbl bytf[] bbufffr = nfw bytf[bufffrsizf
                    * (SoftMbinMixfr.tiis.synti.gftFormbt()
                        .gftSbmplfSizfInBits() / 8)
                    * nrofdibnnfls];
            privbtf int bbufffr_pos = 0;
            privbtf finbl bytf[] singlf = nfw bytf[1];

            publid void fillBufffr() {
                /*
                boolfbn pusifr_silfnt2;
                syndironizfd (dontrol_mutfx) {
                    pusifr_silfnt2 = pusifr_silfnt;
                }
                if(!pusifr_silfnt2)*/
                prodfssAudioBufffrs();
                for (int i = 0; i < nrofdibnnfls; i++)
                    bufffrs[i].gft(bbufffr, i);
                bbufffr_pos = 0;
            }

            publid int rfbd(bytf[] b, int off, int lfn) {
                int bbufffr_lfn = bbufffr.lfngti;
                int offlfn = off + lfn;
                int orgoff = off;
                bytf[] bbufffr = tiis.bbufffr;
                wiilf (off < offlfn) {
                    if (bvbilbblf() == 0)
                        fillBufffr();
                    flsf {
                        int bbufffr_pos = tiis.bbufffr_pos;
                        wiilf (off < offlfn && bbufffr_pos < bbufffr_lfn)
                            b[off++] = bbufffr[bbufffr_pos++];
                        tiis.bbufffr_pos = bbufffr_pos;
                        if (!rfbdfully)
                            rfturn off - orgoff;
                    }
                }
                rfturn lfn;
            }

            publid int rfbd() tirows IOExdfption {
                int rft = rfbd(singlf);
                if (rft == -1)
                    rfturn -1;
                rfturn singlf[0] & 0xFF;
            }

            publid int bvbilbblf() {
                rfturn bbufffr.lfngti - bbufffr_pos;
            }

            publid void dlosf() {
                SoftMbinMixfr.tiis.synti.dlosf();
            }
        };

        bis = nfw AudioInputStrfbm(in, synti.gftFormbt(), AudioSystfm.NOT_SPECIFIED);

    }

    publid AudioInputStrfbm gftInputStrfbm() {
        rfturn bis;
    }

    publid void rfsft() {

        SoftCibnnfl[] dibnnfls = synti.dibnnfls;
        for (int i = 0; i < dibnnfls.lfngti; i++) {
            dibnnfls[i].bllSoundOff();
            dibnnfls[i].rfsftAllControllfrs(truf);

            if (synti.gftGfnfrblMidiModf() == 2) {
                if (i == 9)
                    dibnnfls[i].progrbmCibngf(0, 0x78 * 128);
                flsf
                    dibnnfls[i].progrbmCibngf(0, 0x79 * 128);
            } flsf
                dibnnfls[i].progrbmCibngf(0, 0);
        }
        sftVolumf(0x7F * 128 + 0x7F);
        sftBblbndf(0x40 * 128 + 0x00);
        sftCobrsfTuning(0x40 * 128 + 0x00);
        sftFinfTuning(0x40 * 128 + 0x00);
        // Rfsft Rfvfrb
        globblPbrbmftfrControlCibngf(
                nfw int[]{0x01 * 128 + 0x01}, nfw long[]{0}, nfw long[]{4});
        // Rfsft Ciorus
        globblPbrbmftfrControlCibngf(
                nfw int[]{0x01 * 128 + 0x02}, nfw long[]{0}, nfw long[]{2});
    }

    publid void sftVolumf(int vbluf) {
        syndironizfd (dontrol_mutfx) {
            do_mbstfr_volumf[0] = vbluf / 16384.0;
        }
    }

    publid void sftBblbndf(int vbluf) {
        syndironizfd (dontrol_mutfx) {
            do_mbstfr_bblbndf[0] = vbluf / 16384.0;
        }
    }

    publid void sftFinfTuning(int vbluf) {
        syndironizfd (dontrol_mutfx) {
            do_mbstfr_finf_tuning[0] = vbluf / 16384.0;
        }
    }

    publid void sftCobrsfTuning(int vbluf) {
        syndironizfd (dontrol_mutfx) {
            do_mbstfr_dobrsf_tuning[0] = vbluf / 16384.0;
        }
    }

    publid int gftVolumf() {
        syndironizfd (dontrol_mutfx) {
            rfturn (int) (do_mbstfr_volumf[0] * 16384.0);
        }
    }

    publid int gftBblbndf() {
        syndironizfd (dontrol_mutfx) {
            rfturn (int) (do_mbstfr_bblbndf[0] * 16384.0);
        }
    }

    publid int gftFinfTuning() {
        syndironizfd (dontrol_mutfx) {
            rfturn (int) (do_mbstfr_finf_tuning[0] * 16384.0);
        }
    }

    publid int gftCobrsfTuning() {
        syndironizfd (dontrol_mutfx) {
            rfturn (int) (do_mbstfr_dobrsf_tuning[0] * 16384.0);
        }
    }

    publid void globblPbrbmftfrControlCibngf(int[] slotipbti, long[] pbrbms,
            long[] pbrbmsvbluf) {
        if (slotipbti.lfngti == 0)
            rfturn;

        syndironizfd (dontrol_mutfx) {

            // slotipbti: 01xx brf rfsfrvfd only for GM2

            if (slotipbti[0] == 0x01 * 128 + 0x01) {
                for (int i = 0; i < pbrbmsvbluf.lfngti; i++) {
                    rfvfrb.globblPbrbmftfrControlCibngf(slotipbti, pbrbms[i],
                            pbrbmsvbluf[i]);
                }
            }
            if (slotipbti[0] == 0x01 * 128 + 0x02) {
                for (int i = 0; i < pbrbmsvbluf.lfngti; i++) {
                    diorus.globblPbrbmftfrControlCibngf(slotipbti, pbrbms[i],
                            pbrbmsvbluf[i]);
                }

            }

        }
    }

    publid void prodfssMfssbgf(Objfdt objfdt) {
        if (objfdt instbndfof bytf[])
            prodfssMfssbgf((bytf[]) objfdt);
        if (objfdt instbndfof MidiMfssbgf)
            prodfssMfssbgf((MidiMfssbgf)objfdt);
    }

    publid void prodfssMfssbgf(MidiMfssbgf mfssbgf) {
        if (mfssbgf instbndfof SiortMfssbgf) {
            SiortMfssbgf sms = (SiortMfssbgf)mfssbgf;
            prodfssMfssbgf(sms.gftCibnnfl(), sms.gftCommbnd(),
                    sms.gftDbtb1(), sms.gftDbtb2());
            rfturn;
        }
        prodfssMfssbgf(mfssbgf.gftMfssbgf());
    }

    publid void prodfssMfssbgf(bytf[] dbtb) {
        int stbtus = 0;
        if (dbtb.lfngti > 0)
            stbtus = dbtb[0] & 0xFF;

        if (stbtus == 0xF0) {
            prodfssSystfmExdlusivfMfssbgf(dbtb);
            rfturn;
        }

        int dmd = (stbtus & 0xF0);
        int di = (stbtus & 0x0F);

        int dbtb1;
        int dbtb2;
        if (dbtb.lfngti > 1)
            dbtb1 = dbtb[1] & 0xFF;
        flsf
            dbtb1 = 0;
        if (dbtb.lfngti > 2)
            dbtb2 = dbtb[2] & 0xFF;
        flsf
            dbtb2 = 0;

        prodfssMfssbgf(di, dmd, dbtb1, dbtb2);

    }

    publid void prodfssMfssbgf(int di, int dmd, int dbtb1, int dbtb2) {
        syndironizfd (synti.dontrol_mutfx) {
            bdtivity();
        }

        if (dmd == 0xF0) {
            int stbtus = dmd | di;
            switdi (stbtus) {
            dbsf SiortMfssbgf.ACTIVE_SENSING:
                syndironizfd (synti.dontrol_mutfx) {
                    bdtivf_sfnsing_on = truf;
                }
                brfbk;
            dffbult:
                brfbk;
            }
            rfturn;
        }

        SoftCibnnfl[] dibnnfls = synti.dibnnfls;
        if (di >= dibnnfls.lfngti)
            rfturn;
        SoftCibnnfl softdibnnfl = dibnnfls[di];

        switdi (dmd) {
        dbsf SiortMfssbgf.NOTE_ON:
            if(dflby_midifvfnt != 0)
                softdibnnfl.notfOn(dbtb1, dbtb2, dflby_midifvfnt);
            flsf
                softdibnnfl.notfOn(dbtb1, dbtb2);
            brfbk;
        dbsf SiortMfssbgf.NOTE_OFF:
            softdibnnfl.notfOff(dbtb1, dbtb2);
            brfbk;
        dbsf SiortMfssbgf.POLY_PRESSURE:
            softdibnnfl.sftPolyPrfssurf(dbtb1, dbtb2);
            brfbk;
        dbsf SiortMfssbgf.CONTROL_CHANGE:
            softdibnnfl.dontrolCibngf(dbtb1, dbtb2);
            brfbk;
        dbsf SiortMfssbgf.PROGRAM_CHANGE:
            softdibnnfl.progrbmCibngf(dbtb1);
            brfbk;
        dbsf SiortMfssbgf.CHANNEL_PRESSURE:
            softdibnnfl.sftCibnnflPrfssurf(dbtb1);
            brfbk;
        dbsf SiortMfssbgf.PITCH_BEND:
            softdibnnfl.sftPitdiBfnd(dbtb1 + dbtb2 * 128);
            brfbk;
        dffbult:
            brfbk;
        }

    }

    publid long gftMidrosfdondPosition() {
        if(pusifr_silfnt)
        {
            if(synti.wfbkstrfbm != null)
            {
                rfturn (long)((sbmplf_pos  + synti.wfbkstrfbm.silfnt_sbmplfs)
                        * (1000000.0 / sbmplfrbtf));
            }
        }
        rfturn (long)(sbmplf_pos * (1000000.0 / sbmplfrbtf));
    }

    publid void dlosf() {
    }
}
