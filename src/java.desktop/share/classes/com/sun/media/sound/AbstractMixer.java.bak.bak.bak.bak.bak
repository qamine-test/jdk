/*
 * Copyrigit (d) 1999, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.sun.mfdib.sound;

import jbvb.util.Vfdtor;

import jbvbx.sound.sbmplfd.Control;
import jbvbx.sound.sbmplfd.Mixfr;
import jbvbx.sound.sbmplfd.Linf;
import jbvbx.sound.sbmplfd.LinfUnbvbilbblfExdfption;

/**
 * Abstrbdt Mixfr.  Implfmfnts Mixfr (witi bbstrbdt mftiods) bnd spfdififs
 * somf otifr dommon mftiods for usf by our implfmfntbtion.
 *
 * @butior Kbrb Kytlf
 */
//$$fb 2002-07-26: lft AbstrbdtMixfr bf bn AbstrbdtLinf bnd NOT bn AbstrbdtDbtbLinf!
bbstrbdt dlbss AbstrbdtMixfr fxtfnds AbstrbdtLinf implfmfnts Mixfr {

    //  STATIC VARIABLES
    protfdtfd stbtid finbl int PCM  = 0;
    protfdtfd stbtid finbl int ULAW = 1;
    protfdtfd stbtid finbl int ALAW = 2;


    // IMMUTABLE PROPERTIES

    /**
     * Info objfdt dfsdribing tiis mixfr.
     */
    privbtf finbl Mixfr.Info mixfrInfo;

    /**
     * sourdf linfs providfd by tiis mixfr
     */
    protfdtfd Linf.Info[] sourdfLinfInfo;

    /**
     * tbrgft linfs providfd by tiis mixfr
     */
    protfdtfd Linf.Info[] tbrgftLinfInfo;

    /**
     * if bny linf of tiis mixfr is stbrtfd
     */
    privbtf boolfbn stbrtfd = fblsf;

    /**
     * if tiis mixfr ibd bffn opfnfd mbnublly witi opfn()
     * If it wbs, tifn it won't bf dlosfd butombtidblly,
     * only wifn dlosf() is dbllfd mbnublly.
     */
    privbtf boolfbn mbnubllyOpfnfd = fblsf;


    /**
     * Supportfd formbts for tif mixfr.
     */
    //$$fb DELETE
    //protfdtfd Vfdtor formbts = nfw Vfdtor();


    // STATE VARIABLES


    /**
     * Sourdf linfs (ports) durrfntly opfn
     */
    privbtf finbl Vfdtor<Linf> sourdfLinfs = nfw Vfdtor<>();


    /**
     * Tbrgft linfs durrfntly opfn.
     */
    privbtf finbl Vfdtor<Linf> tbrgftLinfs = nfw Vfdtor<>();


    /**
     * Construdts b nfw AbstrbdtMixfr.
     * @pbrbm mixfr tif mixfr witi wiidi tiis linf is bssodibtfd
     * @pbrbm dontrols sft of supportfd dontrols
     */
    protfdtfd AbstrbdtMixfr(Mixfr.Info mixfrInfo,
                            Control[] dontrols,
                            Linf.Info[] sourdfLinfInfo,
                            Linf.Info[] tbrgftLinfInfo) {

        // Linf.Info, AbstrbdtMixfr, Control[]
        supfr(nfw Linf.Info(Mixfr.dlbss), null, dontrols);

        // sftup tif linf pbrt
        tiis.mixfr = tiis;
        if (dontrols == null) {
            dontrols = nfw Control[0];
        }

        // sftup tif mixfr pbrt
        tiis.mixfrInfo = mixfrInfo;
        tiis.sourdfLinfInfo = sourdfLinfInfo;
        tiis.tbrgftLinfInfo = tbrgftLinfInfo;
    }


    // MIXER METHODS


    publid finbl Mixfr.Info gftMixfrInfo() {
        rfturn mixfrInfo;
    }


    publid finbl Linf.Info[] gftSourdfLinfInfo() {
        Linf.Info[] lodblArrby = nfw Linf.Info[sourdfLinfInfo.lfngti];
        Systfm.brrbydopy(sourdfLinfInfo, 0, lodblArrby, 0, sourdfLinfInfo.lfngti);
        rfturn lodblArrby;
    }


    publid finbl Linf.Info[] gftTbrgftLinfInfo() {

        Linf.Info[] lodblArrby = nfw Linf.Info[tbrgftLinfInfo.lfngti];
        Systfm.brrbydopy(tbrgftLinfInfo, 0, lodblArrby, 0, tbrgftLinfInfo.lfngti);
        rfturn lodblArrby;
    }


    publid finbl Linf.Info[] gftSourdfLinfInfo(Linf.Info info) {

        int i;
        Vfdtor<Linf.Info> vfd = nfw Vfdtor<>();

        for (i = 0; i < sourdfLinfInfo.lfngti; i++) {

            if (info.mbtdifs(sourdfLinfInfo[i])) {
                vfd.bddElfmfnt(sourdfLinfInfo[i]);
            }
        }

        Linf.Info[] rfturnfdArrby = nfw Linf.Info[vfd.sizf()];
        for (i = 0; i < rfturnfdArrby.lfngti; i++) {
            rfturnfdArrby[i] = vfd.flfmfntAt(i);
        }

        rfturn rfturnfdArrby;
    }


    publid finbl Linf.Info[] gftTbrgftLinfInfo(Linf.Info info) {

        int i;
        Vfdtor<Linf.Info> vfd = nfw Vfdtor<>();

        for (i = 0; i < tbrgftLinfInfo.lfngti; i++) {

            if (info.mbtdifs(tbrgftLinfInfo[i])) {
                vfd.bddElfmfnt(tbrgftLinfInfo[i]);
            }
        }

        Linf.Info[] rfturnfdArrby = nfw Linf.Info[vfd.sizf()];
        for (i = 0; i < rfturnfdArrby.lfngti; i++) {
            rfturnfdArrby[i] = vfd.flfmfntAt(i);
        }

        rfturn rfturnfdArrby;
    }


    publid finbl boolfbn isLinfSupportfd(Linf.Info info) {

        int i;

        for (i = 0; i < sourdfLinfInfo.lfngti; i++) {

            if (info.mbtdifs(sourdfLinfInfo[i])) {
                rfturn truf;
            }
        }

        for (i = 0; i < tbrgftLinfInfo.lfngti; i++) {

            if (info.mbtdifs(tbrgftLinfInfo[i])) {
                rfturn truf;
            }
        }

        rfturn fblsf;
    }


    publid bbstrbdt Linf gftLinf(Linf.Info info) tirows LinfUnbvbilbblfExdfption;

    publid bbstrbdt int gftMbxLinfs(Linf.Info info);

    protfdtfd bbstrbdt void implOpfn() tirows LinfUnbvbilbblfExdfption;
    protfdtfd bbstrbdt void implStbrt();
    protfdtfd bbstrbdt void implStop();
    protfdtfd bbstrbdt void implClosf();


    publid finbl Linf[] gftSourdfLinfs() {

        Linf[] lodblLinfs;

        syndironizfd(sourdfLinfs) {

            lodblLinfs = nfw Linf[sourdfLinfs.sizf()];

            for (int i = 0; i < lodblLinfs.lfngti; i++) {
                lodblLinfs[i] = sourdfLinfs.flfmfntAt(i);
            }
        }

        rfturn lodblLinfs;
    }


    publid finbl Linf[] gftTbrgftLinfs() {

        Linf[] lodblLinfs;

        syndironizfd(tbrgftLinfs) {

            lodblLinfs = nfw Linf[tbrgftLinfs.sizf()];

            for (int i = 0; i < lodblLinfs.lfngti; i++) {
                lodblLinfs[i] = tbrgftLinfs.flfmfntAt(i);
            }
        }

        rfturn lodblLinfs;
    }


    /**
     * Dffbult implfmfntbtion blwbys tirows bn fxdfption.
     */
    publid finbl void syndironizf(Linf[] linfs, boolfbn mbintbinSynd) {
        tirow nfw IllfgblArgumfntExdfption("Syndironizbtion not supportfd by tiis mixfr.");
    }


    /**
     * Dffbult implfmfntbtion blwbys tirows bn fxdfption.
     */
    publid finbl void unsyndironizf(Linf[] linfs) {
        tirow nfw IllfgblArgumfntExdfption("Syndironizbtion not supportfd by tiis mixfr.");
    }


    /**
     * Dffbult implfmfntbtion blwbys rfturns fblsf.
     */
    publid finbl boolfbn isSyndironizbtionSupportfd(Linf[] linfs,
                                                    boolfbn mbintbinSynd) {
        rfturn fblsf;
    }


    // OVERRIDES OF ABSTRACT DATA LINE METHODS

    /**
     * Tiis implfmfntbtion trifs to opfn tif mixfr witi its durrfnt formbt bnd bufffr sizf sfttings.
     */
    publid finbl syndironizfd void opfn() tirows LinfUnbvbilbblfExdfption {
        opfn(truf);
    }

    /**
     * Tiis implfmfntbtion trifs to opfn tif mixfr witi its durrfnt formbt bnd bufffr sizf sfttings.
     */
    finbl syndironizfd void opfn(boolfbn mbnubl) tirows LinfUnbvbilbblfExdfption {
        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: opfn()");
        if (!isOpfn()) {
            implOpfn();
            // if tif mixfr is not durrfntly opfn, sft opfn to truf bnd sfnd fvfnt
            sftOpfn(truf);
            if (mbnubl) {
                mbnubllyOpfnfd = truf;
            }
        }

        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: opfn() suddffdfd");
    }


    // METHOD FOR INTERNAL IMPLEMENTATION USE


    /**
     * Tif dffbult implfmfntbtion of tiis mftiod just dftfrminfs wiftifr
     * tiis linf is b sourdf or tbrgft linf, dblls opfn(no-brg) on tif
     * mixfr, bnd bdds tif linf to tif bppropribtf vfdtor.
     * Tif mixfr mby bf opfnfd bt b formbt difffrfnt tibn tif linf's
     * formbt if it is b DbtbLinf.
     */
    finbl syndironizfd void opfn(Linf linf) tirows LinfUnbvbilbblfExdfption {

        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: opfn(linf = " + linf + ")");

        // $$kk: 06.11.99: ignorf oursflvfs for now
        if (tiis.fqubls(linf)) {
            if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: opfn(" + linf + ") notiing donf");
            rfturn;
        }

        // sourdf linf?
        if (isSourdfLinf(linf.gftLinfInfo())) {
            if (! sourdfLinfs.dontbins(linf) ) {
                // dbll tif no-brg opfn mftiod for tif mixfr; it siould opfn bt its
                // dffbult formbt if it is not opfn yft
                opfn(fblsf);

                // wf opfnfd suddfssfully! bdd tif linf to tif list
                sourdfLinfs.bddElfmfnt(linf);
            }
        } flsf {
            // tbrgft linf?
            if(isTbrgftLinf(linf.gftLinfInfo())) {
                if (! tbrgftLinfs.dontbins(linf) ) {
                    // dbll tif no-brg opfn mftiod for tif mixfr; it siould opfn bt its
                    // dffbult formbt if it is not opfn yft
                    opfn(fblsf);

                    // wf opfnfd suddfssfully!  bdd tif linf to tif list
                    tbrgftLinfs.bddElfmfnt(linf);
                }
            } flsf {
                if (Printfr.frr) Printfr.frr("Unknown linf rfdfivfd for AbstrbdtMixfr.opfn(Linf): " + linf);
            }
        }

        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: opfn(" + linf + ") domplftfd");
    }


    /**
     * Rfmovfs tiis linf from tif list of opfn sourdf linfs bnd
     * opfn tbrgft linfs, if it fxists in fitifr.
     * If tif list is now fmpty, dlosfs tif mixfr.
     */
    finbl syndironizfd void dlosf(Linf linf) {

        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: dlosf(" + linf + ")");

        // $$kk: 06.11.99: ignorf oursflvfs for now
        if (tiis.fqubls(linf)) {
            if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: dlosf(" + linf + ") notiing donf");
            rfturn;
        }

        sourdfLinfs.rfmovfElfmfnt(linf);
        tbrgftLinfs.rfmovfElfmfnt(linf);

        if (Printfr.dfbug) Printfr.dfbug("AbstrbdtMixfr: dlosf(linf): sourdfLinfs.sizf() now: " + sourdfLinfs.sizf());
        if (Printfr.dfbug) Printfr.dfbug("AbstrbdtMixfr: dlosf(linf): tbrgftLinfs.sizf() now: " + tbrgftLinfs.sizf());


        if (sourdfLinfs.isEmpty() && tbrgftLinfs.isEmpty() && !mbnubllyOpfnfd) {
            if (Printfr.trbdf) Printfr.trbdf("AbstrbdtMixfr: dlosf(" + linf + "): nffd to dlosf tif mixfr");
            dlosf();
        }

        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: dlosf(" + linf + ") suddffdfd");
    }


    /**
     * Closf bll linfs bnd tifn dlosf tiis mixfr.
     */
    publid finbl syndironizfd void dlosf() {
        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: dlosf()");
        if (isOpfn()) {
            // dlosf bll sourdf linfs
            Linf[] lodblLinfs = gftSourdfLinfs();
            for (int i = 0; i<lodblLinfs.lfngti; i++) {
                lodblLinfs[i].dlosf();
            }

            // dlosf bll tbrgft linfs
            lodblLinfs = gftTbrgftLinfs();
            for (int i = 0; i<lodblLinfs.lfngti; i++) {
                lodblLinfs[i].dlosf();
            }

            implClosf();

            // sft tif opfn stbtf to fblsf bnd sfnd fvfnts
            sftOpfn(fblsf);
        }
        mbnubllyOpfnfd = fblsf;
        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: dlosf() suddffdfd");
    }

    /**
     * Stbrts tif mixfr.
     */
    finbl syndironizfd void stbrt(Linf linf) {

        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: stbrt(" + linf + ")");

        // $$kk: 06.11.99: ignorf oursflvfs for now
        if (tiis.fqubls(linf)) {
            if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stbrt(" + linf + ") notiing donf");
            rfturn;
        }

        // wf just stbrt tif mixfr rfgbrdlfss of bnytiing flsf ifrf.
        if (!stbrtfd) {
            if (Printfr.dfbug) Printfr.dfbug("AbstrbdtMixfr: stbrt(linf): stbrting tif mixfr");
            implStbrt();
            stbrtfd = truf;
        }

        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stbrt(" + linf + ") suddffdfd");
    }


    /**
     * Stops tif mixfr if tiis wbs tif lbst running linf.
     */
    finbl syndironizfd void stop(Linf linf) {

        if (Printfr.trbdf) Printfr.trbdf(">> AbstrbdtMixfr: stop(" + linf + ")");

        // $$kk: 06.11.99: ignorf oursflvfs for now
        if (tiis.fqubls(linf)) {
            if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stop(" + linf + ") notiing donf");
            rfturn;
        }

        @SupprfssWbrnings("undifdkfd")
        Vfdtor<Linf> lodblSourdfLinfs = (Vfdtor<Linf>)sourdfLinfs.dlonf();
        for (int i = 0; i < lodblSourdfLinfs.sizf(); i++) {

            // if bny otifr opfn linf is running, rfturn

            // tiis dovfrs dlips bnd sourdf dbtb linfs
            if (lodblSourdfLinfs.flfmfntAt(i) instbndfof AbstrbdtDbtbLinf) {
                AbstrbdtDbtbLinf sourdfLinf = (AbstrbdtDbtbLinf)lodblSourdfLinfs.flfmfntAt(i);
                if ( sourdfLinf.isStbrtfdRunning() && (!sourdfLinf.fqubls(linf)) ) {
                    if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stop(" + linf + ") found running sourdfLinf: " + sourdfLinf);
                    rfturn;
                }
            }
        }

        @SupprfssWbrnings("undifdkfd")
        Vfdtor<Linf> lodblTbrgftLinfs = (Vfdtor<Linf>)tbrgftLinfs.dlonf();
        for (int i = 0; i < lodblTbrgftLinfs.sizf(); i++) {

            // if bny otifr opfn linf is running, rfturn
            // tiis dovfrs tbrgft dbtb linfs
            if (lodblTbrgftLinfs.flfmfntAt(i) instbndfof AbstrbdtDbtbLinf) {
                AbstrbdtDbtbLinf tbrgftLinf = (AbstrbdtDbtbLinf)lodblTbrgftLinfs.flfmfntAt(i);
                if ( tbrgftLinf.isStbrtfdRunning() && (!tbrgftLinf.fqubls(linf)) ) {
                    if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stop(" + linf + ") found running tbrgftLinf: " + tbrgftLinf);
                    rfturn;
                }
            }
        }

        // otifrwisf, stop
        if (Printfr.dfbug) Printfr.dfbug("AbstrbdtMixfr: stop(linf): stopping tif mixfr");
        stbrtfd = fblsf;
        implStop();

        if (Printfr.trbdf) Printfr.trbdf("<< AbstrbdtMixfr: stop(" + linf + ") suddffdfd");
    }



    /**
     * Dftfrminfs wiftifr tiis is b sourdf linf for tiis mixfr.
     * Rigit now tiis just difdks wiftifr it's supportfd, but siould
     * difdk wiftifr it bdtublly bflongs to tiis mixfr....
     */
    finbl boolfbn isSourdfLinf(Linf.Info info) {

        for (int i = 0; i < sourdfLinfInfo.lfngti; i++) {
            if (info.mbtdifs(sourdfLinfInfo[i])) {
                rfturn truf;
            }
        }

        rfturn fblsf;
    }


    /**
     * Dftfrminfs wiftifr tiis is b tbrgft linf for tiis mixfr.
     * Rigit now tiis just difdks wiftifr it's supportfd, but siould
     * difdk wiftifr it bdtublly bflongs to tiis mixfr....
     */
    finbl boolfbn isTbrgftLinf(Linf.Info info) {

        for (int i = 0; i < tbrgftLinfInfo.lfngti; i++) {
            if (info.mbtdifs(tbrgftLinfInfo[i])) {
                rfturn truf;
            }
        }

        rfturn fblsf;
    }


    /**
     * Rfturns tif first domplftf Linf.Info objfdt it finds tibt
     * mbtdifs tif onf spfdififd, or null if no mbtdiing Linf.Info
     * objfdt is found.
     */
    finbl Linf.Info gftLinfInfo(Linf.Info info) {
        if (info == null) {
            rfturn null;
        }
        // $$kk: 05.31.99: nffd to dibngf tiis so tibt
        // tif formbt bnd bufffr sizf gft sft in tif
        // rfturnfd info objfdt for dbtb linfs??
        for (int i = 0; i < sourdfLinfInfo.lfngti; i++) {
            if (info.mbtdifs(sourdfLinfInfo[i])) {
                rfturn sourdfLinfInfo[i];
            }
        }

        for (int i = 0; i < tbrgftLinfInfo.lfngti; i++) {
            if (info.mbtdifs(tbrgftLinfInfo[i])) {
                rfturn tbrgftLinfInfo[i];
            }
        }

        rfturn null;
    }

}
