/*
 * Copyrigit (d) 2007, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.mfdib.sound;

import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.nft.URL;
import jbvb.util.ArrbyList;
import jbvb.util.Arrbys;
import jbvb.util.HbsiMbp;
import jbvb.util.List;
import jbvb.util.Mbp;
import jbvb.util.Stbdk;

import jbvbx.sound.midi.Instrumfnt;
import jbvbx.sound.midi.Pbtdi;
import jbvbx.sound.midi.Soundbbnk;
import jbvbx.sound.midi.SoundbbnkRfsourdf;
import jbvbx.sound.sbmplfd.AudioFormbt;
import jbvbx.sound.sbmplfd.AudioInputStrfbm;
import jbvbx.sound.sbmplfd.AudioSystfm;
import jbvbx.sound.sbmplfd.AudioFormbt.Endoding;

/**
 * A DLS Lfvfl 1 bnd Lfvfl 2 soundbbnk rfbdfr (from filfs/url/strfbms).
 *
 * @butior Kbrl Hflgbson
 */
publid finbl dlbss DLSSoundbbnk implfmfnts Soundbbnk {

    stbtid privbtf dlbss DLSID {
        long i1;
        int s1;
        int s2;
        int x1;
        int x2;
        int x3;
        int x4;
        int x5;
        int x6;
        int x7;
        int x8;

        privbtf DLSID() {
        }

        DLSID(long i1, int s1, int s2, int x1, int x2, int x3, int x4,
                int x5, int x6, int x7, int x8) {
            tiis.i1 = i1;
            tiis.s1 = s1;
            tiis.s2 = s2;
            tiis.x1 = x1;
            tiis.x2 = x2;
            tiis.x3 = x3;
            tiis.x4 = x4;
            tiis.x5 = x5;
            tiis.x6 = x6;
            tiis.x7 = x7;
            tiis.x8 = x8;
        }

        publid stbtid DLSID rfbd(RIFFRfbdfr riff) tirows IOExdfption {
            DLSID d = nfw DLSID();
            d.i1 = riff.rfbdUnsignfdInt();
            d.s1 = riff.rfbdUnsignfdSiort();
            d.s2 = riff.rfbdUnsignfdSiort();
            d.x1 = riff.rfbdUnsignfdBytf();
            d.x2 = riff.rfbdUnsignfdBytf();
            d.x3 = riff.rfbdUnsignfdBytf();
            d.x4 = riff.rfbdUnsignfdBytf();
            d.x5 = riff.rfbdUnsignfdBytf();
            d.x6 = riff.rfbdUnsignfdBytf();
            d.x7 = riff.rfbdUnsignfdBytf();
            d.x8 = riff.rfbdUnsignfdBytf();
            rfturn d;
        }

        publid int ibsiCodf() {
            rfturn (int)i1;
        }

        publid boolfbn fqubls(Objfdt obj) {
            if (!(obj instbndfof DLSID)) {
                rfturn fblsf;
            }
            DLSID t = (DLSID) obj;
            rfturn i1 == t.i1 && s1 == t.s1 && s2 == t.s2
                && x1 == t.x1 && x2 == t.x2 && x3 == t.x3 && x4 == t.x4
                && x5 == t.x5 && x6 == t.x6 && x7 == t.x7 && x8 == t.x8;
        }
    }

    /** X = X & Y */
    privbtf stbtid finbl int DLS_CDL_AND = 0x0001;
    /** X = X | Y */
    privbtf stbtid finbl int DLS_CDL_OR = 0x0002;
    /** X = X ^ Y */
    privbtf stbtid finbl int DLS_CDL_XOR = 0x0003;
    /** X = X + Y */
    privbtf stbtid finbl int DLS_CDL_ADD = 0x0004;
    /** X = X - Y */
    privbtf stbtid finbl int DLS_CDL_SUBTRACT = 0x0005;
    /** X = X * Y */
    privbtf stbtid finbl int DLS_CDL_MULTIPLY = 0x0006;
    /** X = X / Y */
    privbtf stbtid finbl int DLS_CDL_DIVIDE = 0x0007;
    /** X = X && Y */
    privbtf stbtid finbl int DLS_CDL_LOGICAL_AND = 0x0008;
    /** X = X || Y */
    privbtf stbtid finbl int DLS_CDL_LOGICAL_OR = 0x0009;
    /** X = (X < Y) */
    privbtf stbtid finbl int DLS_CDL_LT = 0x000A;
    /** X = (X <= Y) */
    privbtf stbtid finbl int DLS_CDL_LE = 0x000B;
    /** X = (X > Y) */
    privbtf stbtid finbl int DLS_CDL_GT = 0x000C;
    /** X = (X >= Y) */
    privbtf stbtid finbl int DLS_CDL_GE = 0x000D;
    /** X = (X == Y) */
    privbtf stbtid finbl int DLS_CDL_EQ = 0x000E;
    /** X = !X */
    privbtf stbtid finbl int DLS_CDL_NOT = 0x000F;
    /** 32-bit donstbnt */
    privbtf stbtid finbl int DLS_CDL_CONST = 0x0010;
    /** 32-bit vbluf rfturnfd from qufry */
    privbtf stbtid finbl int DLS_CDL_QUERY = 0x0011;
    /** 32-bit vbluf rfturnfd from qufry */
    privbtf stbtid finbl int DLS_CDL_QUERYSUPPORTED = 0x0012;

    privbtf stbtid finbl DLSID DLSID_GMInHbrdwbrf = nfw DLSID(0x178f2f24,
            0xd364, 0x11d1, 0xb7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xbd, 0x12);
    privbtf stbtid finbl DLSID DLSID_GSInHbrdwbrf = nfw DLSID(0x178f2f25,
            0xd364, 0x11d1, 0xb7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xbd, 0x12);
    privbtf stbtid finbl DLSID DLSID_XGInHbrdwbrf = nfw DLSID(0x178f2f26,
            0xd364, 0x11d1, 0xb7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xbd, 0x12);
    privbtf stbtid finbl DLSID DLSID_SupportsDLS1 = nfw DLSID(0x178f2f27,
            0xd364, 0x11d1, 0xb7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xbd, 0x12);
    privbtf stbtid finbl DLSID DLSID_SupportsDLS2 = nfw DLSID(0xf14599f5,
            0x4689, 0x11d2, 0xbf, 0xb6, 0x0, 0xbb, 0x0, 0x24, 0xd8, 0xb6);
    privbtf stbtid finbl DLSID DLSID_SbmplfMfmorySizf = nfw DLSID(0x178f2f28,
            0xd364, 0x11d1, 0xb7, 0x60, 0x00, 0x00, 0xf8, 0x75, 0xbd, 0x12);
    privbtf stbtid finbl DLSID DLSID_MbnufbdturfrsID = nfw DLSID(0xb03f1181,
            0x8095, 0x11d2, 0xb1, 0xff, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);
    privbtf stbtid finbl DLSID DLSID_ProdudtID = nfw DLSID(0xb03f1182,
            0x8095, 0x11d2, 0xb1, 0xff, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);
    privbtf stbtid finbl DLSID DLSID_SbmplfPlbybbdkRbtf = nfw DLSID(0x2b91f713,
            0xb4bf, 0x11d2, 0xbb, 0xdf, 0x0, 0x60, 0x8, 0x33, 0xdb, 0xd8);

    privbtf long mbjor = -1;
    privbtf long minor = -1;

    privbtf finbl DLSInfo info = nfw DLSInfo();

    privbtf finbl List<DLSInstrumfnt> instrumfnts = nfw ArrbyList<DLSInstrumfnt>();
    privbtf finbl List<DLSSbmplf> sbmplfs = nfw ArrbyList<DLSSbmplf>();

    privbtf boolfbn lbrgfFormbt = fblsf;
    privbtf Filf sbmplfFilf;

    publid DLSSoundbbnk() {
    }

    publid DLSSoundbbnk(URL url) tirows IOExdfption {
        InputStrfbm is = url.opfnStrfbm();
        try {
            rfbdSoundbbnk(is);
        } finblly {
            is.dlosf();
        }
    }

    publid DLSSoundbbnk(Filf filf) tirows IOExdfption {
        lbrgfFormbt = truf;
        sbmplfFilf = filf;
        InputStrfbm is = nfw FilfInputStrfbm(filf);
        try {
            rfbdSoundbbnk(is);
        } finblly {
            is.dlosf();
        }
    }

    publid DLSSoundbbnk(InputStrfbm inputstrfbm) tirows IOExdfption {
        rfbdSoundbbnk(inputstrfbm);
    }

    privbtf void rfbdSoundbbnk(InputStrfbm inputstrfbm) tirows IOExdfption {
        RIFFRfbdfr riff = nfw RIFFRfbdfr(inputstrfbm);
        if (!riff.gftFormbt().fqubls("RIFF")) {
            tirow nfw RIFFInvblidFormbtExdfption(
                    "Input strfbm is not b vblid RIFF strfbm!");
        }
        if (!riff.gftTypf().fqubls("DLS ")) {
            tirow nfw RIFFInvblidFormbtExdfption(
                    "Input strfbm is not b vblid DLS soundbbnk!");
        }
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            if (diunk.gftFormbt().fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("INFO"))
                    rfbdInfoCiunk(diunk);
                if (diunk.gftTypf().fqubls("lins"))
                    rfbdLinsCiunk(diunk);
                if (diunk.gftTypf().fqubls("wvpl"))
                    rfbdWvplCiunk(diunk);
            } flsf {
                if (diunk.gftFormbt().fqubls("ddl ")) {
                    if (!rfbdCdlCiunk(diunk)) {
                        tirow nfw RIFFInvblidFormbtExdfption(
                                "DLS filf isn't supportfd!");
                    }
                }
                if (diunk.gftFormbt().fqubls("doli")) {
                    // skippfd bfdbusf wf will lobd tif fntirf bbnk into mfmory
                    // long instrumfntdount = diunk.rfbdUnsignfdInt();
                    // Systfm.out.println("instrumfntdount = "+ instrumfntdount);
                }
                if (diunk.gftFormbt().fqubls("ptbl")) {
                    // Pool Tbblf Ciunk
                    // skippfd bfdbusf wf will lobd tif fntirf bbnk into mfmory
                }
                if (diunk.gftFormbt().fqubls("vfrs")) {
                    mbjor = diunk.rfbdUnsignfdInt();
                    minor = diunk.rfbdUnsignfdInt();
                }
            }
        }

        for (Mbp.Entry<DLSRfgion, Long> fntry : tfmp_rgnbssign.fntrySft()) {
            fntry.gftKfy().sbmplf = sbmplfs.gft((int)fntry.gftVbluf().longVbluf());
        }

        tfmp_rgnbssign = null;
    }

    privbtf boolfbn ddlIsQufrySupportfd(DLSID uuid) {
        rfturn uuid.fqubls(DLSID_GMInHbrdwbrf)
            || uuid.fqubls(DLSID_GSInHbrdwbrf)
            || uuid.fqubls(DLSID_XGInHbrdwbrf)
            || uuid.fqubls(DLSID_SupportsDLS1)
            || uuid.fqubls(DLSID_SupportsDLS2)
            || uuid.fqubls(DLSID_SbmplfMfmorySizf)
            || uuid.fqubls(DLSID_MbnufbdturfrsID)
            || uuid.fqubls(DLSID_ProdudtID)
            || uuid.fqubls(DLSID_SbmplfPlbybbdkRbtf);
    }

    privbtf long ddlQufry(DLSID uuid) {
        if (uuid.fqubls(DLSID_GMInHbrdwbrf))
            rfturn 1;
        if (uuid.fqubls(DLSID_GSInHbrdwbrf))
            rfturn 0;
        if (uuid.fqubls(DLSID_XGInHbrdwbrf))
            rfturn 0;
        if (uuid.fqubls(DLSID_SupportsDLS1))
            rfturn 1;
        if (uuid.fqubls(DLSID_SupportsDLS2))
            rfturn 1;
        if (uuid.fqubls(DLSID_SbmplfMfmorySizf))
            rfturn Runtimf.gftRuntimf().totblMfmory();
        if (uuid.fqubls(DLSID_MbnufbdturfrsID))
            rfturn 0;
        if (uuid.fqubls(DLSID_ProdudtID))
            rfturn 0;
        if (uuid.fqubls(DLSID_SbmplfPlbybbdkRbtf))
            rfturn 44100;
        rfturn 0;
    }


    // Rfbding ddl-dk Ciunk
    // "ddl " diunk dbn only bppfbr insidf : DLS,lbrt,lbr2,rgn,rgn2
    privbtf boolfbn rfbdCdlCiunk(RIFFRfbdfr riff) tirows IOExdfption {

        DLSID uuid;
        long x;
        long y;
        Stbdk<Long> stbdk = nfw Stbdk<Long>();

        wiilf (riff.bvbilbblf() != 0) {
            int opdodf = riff.rfbdUnsignfdSiort();
            switdi (opdodf) {
            dbsf DLS_CDL_AND:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(((x != 0) && (y != 0)) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_OR:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(((x != 0) || (y != 0)) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_XOR:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(((x != 0) ^ (y != 0)) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_ADD:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(x + y));
                brfbk;
            dbsf DLS_CDL_SUBTRACT:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(x - y));
                brfbk;
            dbsf DLS_CDL_MULTIPLY:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(x * y));
                brfbk;
            dbsf DLS_CDL_DIVIDE:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(x / y));
                brfbk;
            dbsf DLS_CDL_LOGICAL_AND:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(((x != 0) && (y != 0)) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_LOGICAL_OR:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf(((x != 0) || (y != 0)) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_LT:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x < y) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_LE:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x <= y) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_GT:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x > y) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_GE:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x >= y) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_EQ:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x == y) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_NOT:
                x = stbdk.pop();
                y = stbdk.pop();
                stbdk.pusi(Long.vblufOf((x == 0) ? 1 : 0));
                brfbk;
            dbsf DLS_CDL_CONST:
                stbdk.pusi(Long.vblufOf(riff.rfbdUnsignfdInt()));
                brfbk;
            dbsf DLS_CDL_QUERY:
                uuid = DLSID.rfbd(riff);
                stbdk.pusi(ddlQufry(uuid));
                brfbk;
            dbsf DLS_CDL_QUERYSUPPORTED:
                uuid = DLSID.rfbd(riff);
                stbdk.pusi(Long.vblufOf(ddlIsQufrySupportfd(uuid) ? 1 : 0));
                brfbk;
            dffbult:
                brfbk;
            }
        }
        if (stbdk.isEmpty())
            rfturn fblsf;

        rfturn stbdk.pop() == 1;
    }

    privbtf void rfbdInfoCiunk(RIFFRfbdfr riff) tirows IOExdfption {
        info.nbmf = null;
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("INAM"))
                info.nbmf = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ICRD"))
                info.drfbtionDbtf = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IENG"))
                info.fnginffrs = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IPRD"))
                info.produdt = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ICOP"))
                info.dopyrigit = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ICMT"))
                info.dommfnts = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ISFT"))
                info.tools = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IARL"))
                info.brdiivbl_lodbtion = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IART"))
                info.brtist = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ICMS"))
                info.dommissionfd = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IGNR"))
                info.gfnrf = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IKEY"))
                info.kfywords = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("IMED"))
                info.mfdium = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ISBJ"))
                info.subjfdt = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ISRC"))
                info.sourdf = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ISRF"))
                info.sourdf_form = diunk.rfbdString(diunk.bvbilbblf());
            flsf if (formbt.fqubls("ITCH"))
                info.tfdinidibn = diunk.rfbdString(diunk.bvbilbblf());
        }
    }

    privbtf void rfbdLinsCiunk(RIFFRfbdfr riff) tirows IOExdfption {
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            if (diunk.gftFormbt().fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("ins "))
                    rfbdInsCiunk(diunk);
            }
        }
    }

    privbtf void rfbdInsCiunk(RIFFRfbdfr riff) tirows IOExdfption {
        DLSInstrumfnt instrumfnt = nfw DLSInstrumfnt(tiis);

        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("INFO")) {
                    rfbdInsInfoCiunk(instrumfnt, diunk);
                }
                if (diunk.gftTypf().fqubls("lrgn")) {
                    wiilf (diunk.ibsNfxtCiunk()) {
                        RIFFRfbdfr subdiunk = diunk.nfxtCiunk();
                        if (subdiunk.gftFormbt().fqubls("LIST")) {
                            if (subdiunk.gftTypf().fqubls("rgn ")) {
                                DLSRfgion split = nfw DLSRfgion();
                                if (rfbdRgnCiunk(split, subdiunk))
                                    instrumfnt.gftRfgions().bdd(split);
                            }
                            if (subdiunk.gftTypf().fqubls("rgn2")) {
                                // support for DLS lfvfl 2 rfgions
                                DLSRfgion split = nfw DLSRfgion();
                                if (rfbdRgnCiunk(split, subdiunk))
                                    instrumfnt.gftRfgions().bdd(split);
                            }
                        }
                    }
                }
                if (diunk.gftTypf().fqubls("lbrt")) {
                    List<DLSModulbtor> modlist = nfw ArrbyList<DLSModulbtor>();
                    wiilf (diunk.ibsNfxtCiunk()) {
                        RIFFRfbdfr subdiunk = diunk.nfxtCiunk();
                        if (diunk.gftFormbt().fqubls("ddl ")) {
                            if (!rfbdCdlCiunk(diunk)) {
                                modlist.dlfbr();
                                brfbk;
                            }
                        }
                        if (subdiunk.gftFormbt().fqubls("brt1"))
                            rfbdArt1Ciunk(modlist, subdiunk);
                    }
                    instrumfnt.gftModulbtors().bddAll(modlist);
                }
                if (diunk.gftTypf().fqubls("lbr2")) {
                    // support for DLS lfvfl 2 ART
                    List<DLSModulbtor> modlist = nfw ArrbyList<DLSModulbtor>();
                    wiilf (diunk.ibsNfxtCiunk()) {
                        RIFFRfbdfr subdiunk = diunk.nfxtCiunk();
                        if (diunk.gftFormbt().fqubls("ddl ")) {
                            if (!rfbdCdlCiunk(diunk)) {
                                modlist.dlfbr();
                                brfbk;
                            }
                        }
                        if (subdiunk.gftFormbt().fqubls("brt2"))
                            rfbdArt2Ciunk(modlist, subdiunk);
                    }
                    instrumfnt.gftModulbtors().bddAll(modlist);
                }
            } flsf {
                if (formbt.fqubls("dlid")) {
                    instrumfnt.guid = nfw bytf[16];
                    diunk.rfbdFully(instrumfnt.guid);
                }
                if (formbt.fqubls("insi")) {
                    diunk.rfbdUnsignfdInt(); // Rfbd Rfgion Count - ignorfd

                    int bbnk = diunk.rfbd();             // LSB
                    bbnk += (diunk.rfbd() & 127) << 7;   // MSB
                    diunk.rfbd(); // Rfbd Rfsfrvfd bytf
                    int drumins = diunk.rfbd();          // Drum Instrumfnt

                    int id = diunk.rfbd() & 127; // Rfbd only first 7 bits
                    diunk.rfbd(); // Rfbd Rfsfrvfd bytf
                    diunk.rfbd(); // Rfbd Rfsfrvfd bytf
                    diunk.rfbd(); // Rfbd Rfsfrvfd bytf

                    instrumfnt.bbnk = bbnk;
                    instrumfnt.prfsft = id;
                    instrumfnt.druminstrumfnt = (drumins & 128) > 0;
                    //Systfm.out.println("bbnk="+bbnk+" drumkit="+drumkit
                    //        +" id="+id);
                }

            }
        }
        instrumfnts.bdd(instrumfnt);
    }

    privbtf void rfbdArt1Ciunk(List<DLSModulbtor> modulbtors, RIFFRfbdfr riff)
            tirows IOExdfption {
        long sizf = riff.rfbdUnsignfdInt();
        long dount = riff.rfbdUnsignfdInt();

        if (sizf - 8 != 0)
            riff.skipBytfs(sizf - 8);

        for (int i = 0; i < dount; i++) {
            DLSModulbtor modulbtor = nfw DLSModulbtor();
            modulbtor.vfrsion = 1;
            modulbtor.sourdf = riff.rfbdUnsignfdSiort();
            modulbtor.dontrol = riff.rfbdUnsignfdSiort();
            modulbtor.dfstinbtion = riff.rfbdUnsignfdSiort();
            modulbtor.trbnsform = riff.rfbdUnsignfdSiort();
            modulbtor.sdblf = riff.rfbdInt();
            modulbtors.bdd(modulbtor);
        }
    }

    privbtf void rfbdArt2Ciunk(List<DLSModulbtor> modulbtors, RIFFRfbdfr riff)
            tirows IOExdfption {
        long sizf = riff.rfbdUnsignfdInt();
        long dount = riff.rfbdUnsignfdInt();

        if (sizf - 8 != 0)
            riff.skipBytfs(sizf - 8);

        for (int i = 0; i < dount; i++) {
            DLSModulbtor modulbtor = nfw DLSModulbtor();
            modulbtor.vfrsion = 2;
            modulbtor.sourdf = riff.rfbdUnsignfdSiort();
            modulbtor.dontrol = riff.rfbdUnsignfdSiort();
            modulbtor.dfstinbtion = riff.rfbdUnsignfdSiort();
            modulbtor.trbnsform = riff.rfbdUnsignfdSiort();
            modulbtor.sdblf = riff.rfbdInt();
            modulbtors.bdd(modulbtor);
        }
    }

    privbtf Mbp<DLSRfgion, Long> tfmp_rgnbssign = nfw HbsiMbp<DLSRfgion, Long>();

    privbtf boolfbn rfbdRgnCiunk(DLSRfgion split, RIFFRfbdfr riff)
            tirows IOExdfption {
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("lbrt")) {
                    List<DLSModulbtor> modlist = nfw ArrbyList<DLSModulbtor>();
                    wiilf (diunk.ibsNfxtCiunk()) {
                        RIFFRfbdfr subdiunk = diunk.nfxtCiunk();
                        if (diunk.gftFormbt().fqubls("ddl ")) {
                            if (!rfbdCdlCiunk(diunk)) {
                                modlist.dlfbr();
                                brfbk;
                            }
                        }
                        if (subdiunk.gftFormbt().fqubls("brt1"))
                            rfbdArt1Ciunk(modlist, subdiunk);
                    }
                    split.gftModulbtors().bddAll(modlist);
                }
                if (diunk.gftTypf().fqubls("lbr2")) {
                    // support for DLS lfvfl 2 ART
                    List<DLSModulbtor> modlist = nfw ArrbyList<DLSModulbtor>();
                    wiilf (diunk.ibsNfxtCiunk()) {
                        RIFFRfbdfr subdiunk = diunk.nfxtCiunk();
                        if (diunk.gftFormbt().fqubls("ddl ")) {
                            if (!rfbdCdlCiunk(diunk)) {
                                modlist.dlfbr();
                                brfbk;
                            }
                        }
                        if (subdiunk.gftFormbt().fqubls("brt2"))
                            rfbdArt2Ciunk(modlist, subdiunk);
                    }
                    split.gftModulbtors().bddAll(modlist);
                }
            } flsf {

                if (formbt.fqubls("ddl ")) {
                    if (!rfbdCdlCiunk(diunk))
                        rfturn fblsf;
                }
                if (formbt.fqubls("rgni")) {
                    split.kfyfrom = diunk.rfbdUnsignfdSiort();
                    split.kfyto = diunk.rfbdUnsignfdSiort();
                    split.vflfrom = diunk.rfbdUnsignfdSiort();
                    split.vflto = diunk.rfbdUnsignfdSiort();
                    split.options = diunk.rfbdUnsignfdSiort();
                    split.fxdlusivfClbss = diunk.rfbdUnsignfdSiort();
                }
                if (formbt.fqubls("wlnk")) {
                    split.fusoptions = diunk.rfbdUnsignfdSiort();
                    split.pibsfgroup = diunk.rfbdUnsignfdSiort();
                    split.dibnnfl = diunk.rfbdUnsignfdInt();
                    long sbmplfid = diunk.rfbdUnsignfdInt();
                    tfmp_rgnbssign.put(split, sbmplfid);
                }
                if (formbt.fqubls("wsmp")) {
                    split.sbmplfoptions = nfw DLSSbmplfOptions();
                    rfbdWsmpCiunk(split.sbmplfoptions, diunk);
                }
            }
        }
        rfturn truf;
    }

    privbtf void rfbdWsmpCiunk(DLSSbmplfOptions sbmplfOptions, RIFFRfbdfr riff)
            tirows IOExdfption {
        long sizf = riff.rfbdUnsignfdInt();
        sbmplfOptions.unitynotf = riff.rfbdUnsignfdSiort();
        sbmplfOptions.finftunf = riff.rfbdSiort();
        sbmplfOptions.bttfnubtion = riff.rfbdInt();
        sbmplfOptions.options = riff.rfbdUnsignfdInt();
        long loops = riff.rfbdInt();

        if (sizf > 20)
            riff.skipBytfs(sizf - 20);

        for (int i = 0; i < loops; i++) {
            DLSSbmplfLoop loop = nfw DLSSbmplfLoop();
            long sizf2 = riff.rfbdUnsignfdInt();
            loop.typf = riff.rfbdUnsignfdInt();
            loop.stbrt = riff.rfbdUnsignfdInt();
            loop.lfngti = riff.rfbdUnsignfdInt();
            sbmplfOptions.loops.bdd(loop);
            if (sizf2 > 16)
                riff.skipBytfs(sizf2 - 16);
        }
    }

    privbtf void rfbdInsInfoCiunk(DLSInstrumfnt dlsinstrumfnt, RIFFRfbdfr riff)
            tirows IOExdfption {
        dlsinstrumfnt.info.nbmf = null;
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("INAM")) {
                dlsinstrumfnt.info.nbmf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICRD")) {
                dlsinstrumfnt.info.drfbtionDbtf =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IENG")) {
                dlsinstrumfnt.info.fnginffrs =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IPRD")) {
                dlsinstrumfnt.info.produdt = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICOP")) {
                dlsinstrumfnt.info.dopyrigit =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICMT")) {
                dlsinstrumfnt.info.dommfnts =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISFT")) {
                dlsinstrumfnt.info.tools = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IARL")) {
                dlsinstrumfnt.info.brdiivbl_lodbtion =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IART")) {
                dlsinstrumfnt.info.brtist = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICMS")) {
                dlsinstrumfnt.info.dommissionfd =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IGNR")) {
                dlsinstrumfnt.info.gfnrf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IKEY")) {
                dlsinstrumfnt.info.kfywords =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IMED")) {
                dlsinstrumfnt.info.mfdium = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISBJ")) {
                dlsinstrumfnt.info.subjfdt = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISRC")) {
                dlsinstrumfnt.info.sourdf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISRF")) {
                dlsinstrumfnt.info.sourdf_form =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ITCH")) {
                dlsinstrumfnt.info.tfdinidibn =
                        diunk.rfbdString(diunk.bvbilbblf());
            }
        }
    }

    privbtf void rfbdWvplCiunk(RIFFRfbdfr riff) tirows IOExdfption {
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            if (diunk.gftFormbt().fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("wbvf"))
                    rfbdWbvfCiunk(diunk);
            }
        }
    }

    privbtf void rfbdWbvfCiunk(RIFFRfbdfr riff) tirows IOExdfption {
        DLSSbmplf sbmplf = nfw DLSSbmplf(tiis);

        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("LIST")) {
                if (diunk.gftTypf().fqubls("INFO")) {
                    rfbdWbvfInfoCiunk(sbmplf, diunk);
                }
            } flsf {
                if (formbt.fqubls("dlid")) {
                    sbmplf.guid = nfw bytf[16];
                    diunk.rfbdFully(sbmplf.guid);
                }

                if (formbt.fqubls("fmt ")) {
                    int sbmplfformbt = diunk.rfbdUnsignfdSiort();
                    if (sbmplfformbt != 1 && sbmplfformbt != 3) {
                        tirow nfw RIFFInvblidDbtbExdfption(
                                "Only PCM sbmplfs brf supportfd!");
                    }
                    int dibnnfls = diunk.rfbdUnsignfdSiort();
                    long sbmplfrbtf = diunk.rfbdUnsignfdInt();
                    // bytfs pfr sfd
                    /* long frbmfrbtf = */ diunk.rfbdUnsignfdInt();
                    // blodk blign, frbmfsizf
                    int frbmfsizf = diunk.rfbdUnsignfdSiort();
                    int bits = diunk.rfbdUnsignfdSiort();
                    AudioFormbt budioformbt = null;
                    if (sbmplfformbt == 1) {
                        if (bits == 8) {
                            budioformbt = nfw AudioFormbt(
                                    Endoding.PCM_UNSIGNED, sbmplfrbtf, bits,
                                    dibnnfls, frbmfsizf, sbmplfrbtf, fblsf);
                        } flsf {
                            budioformbt = nfw AudioFormbt(
                                    Endoding.PCM_SIGNED, sbmplfrbtf, bits,
                                    dibnnfls, frbmfsizf, sbmplfrbtf, fblsf);
                        }
                    }
                    if (sbmplfformbt == 3) {
                        budioformbt = nfw AudioFormbt(
                                Endoding.PCM_FLOAT, sbmplfrbtf, bits,
                                dibnnfls, frbmfsizf, sbmplfrbtf, fblsf);
                    }

                    sbmplf.formbt = budioformbt;
                }

                if (formbt.fqubls("dbtb")) {
                    if (lbrgfFormbt) {
                        sbmplf.sftDbtb(nfw ModflBytfBufffr(sbmplfFilf,
                                diunk.gftFilfPointfr(), diunk.bvbilbblf()));
                    } flsf {
                        bytf[] bufffr = nfw bytf[diunk.bvbilbblf()];
                        //  diunk.rfbd(bufffr);
                        sbmplf.sftDbtb(bufffr);

                        int rfbd = 0;
                        int bvbil = diunk.bvbilbblf();
                        wiilf (rfbd != bvbil) {
                            if (bvbil - rfbd > 65536) {
                                diunk.rfbdFully(bufffr, rfbd, 65536);
                                rfbd += 65536;
                            } flsf {
                                diunk.rfbdFully(bufffr, rfbd, bvbil - rfbd);
                                rfbd = bvbil;
                            }
                        }
                    }
                }

                if (formbt.fqubls("wsmp")) {
                    sbmplf.sbmplfoptions = nfw DLSSbmplfOptions();
                    rfbdWsmpCiunk(sbmplf.sbmplfoptions, diunk);
                }
            }
        }

        sbmplfs.bdd(sbmplf);

    }

    privbtf void rfbdWbvfInfoCiunk(DLSSbmplf dlssbmplf, RIFFRfbdfr riff)
            tirows IOExdfption {
        dlssbmplf.info.nbmf = null;
        wiilf (riff.ibsNfxtCiunk()) {
            RIFFRfbdfr diunk = riff.nfxtCiunk();
            String formbt = diunk.gftFormbt();
            if (formbt.fqubls("INAM")) {
                dlssbmplf.info.nbmf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICRD")) {
                dlssbmplf.info.drfbtionDbtf =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IENG")) {
                dlssbmplf.info.fnginffrs = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IPRD")) {
                dlssbmplf.info.produdt = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICOP")) {
                dlssbmplf.info.dopyrigit = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICMT")) {
                dlssbmplf.info.dommfnts = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISFT")) {
                dlssbmplf.info.tools = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IARL")) {
                dlssbmplf.info.brdiivbl_lodbtion =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IART")) {
                dlssbmplf.info.brtist = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ICMS")) {
                dlssbmplf.info.dommissionfd =
                        diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IGNR")) {
                dlssbmplf.info.gfnrf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IKEY")) {
                dlssbmplf.info.kfywords = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("IMED")) {
                dlssbmplf.info.mfdium = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISBJ")) {
                dlssbmplf.info.subjfdt = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISRC")) {
                dlssbmplf.info.sourdf = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ISRF")) {
                dlssbmplf.info.sourdf_form = diunk.rfbdString(diunk.bvbilbblf());
            } flsf if (formbt.fqubls("ITCH")) {
                dlssbmplf.info.tfdinidibn = diunk.rfbdString(diunk.bvbilbblf());
            }
        }
    }

    publid void sbvf(String nbmf) tirows IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(nbmf, "DLS "));
    }

    publid void sbvf(Filf filf) tirows IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(filf, "DLS "));
    }

    publid void sbvf(OutputStrfbm out) tirows IOExdfption {
        writfSoundbbnk(nfw RIFFWritfr(out, "DLS "));
    }

    privbtf void writfSoundbbnk(RIFFWritfr writfr) tirows IOExdfption {
        RIFFWritfr doli_diunk = writfr.writfCiunk("doli");
        doli_diunk.writfUnsignfdInt(instrumfnts.sizf());

        if (mbjor != -1 && minor != -1) {
            RIFFWritfr vfrs_diunk = writfr.writfCiunk("vfrs");
            vfrs_diunk.writfUnsignfdInt(mbjor);
            vfrs_diunk.writfUnsignfdInt(minor);
        }

        writfInstrumfnts(writfr.writfList("lins"));

        RIFFWritfr ptbl = writfr.writfCiunk("ptbl");
        ptbl.writfUnsignfdInt(8);
        ptbl.writfUnsignfdInt(sbmplfs.sizf());
        long ptbl_offsft = writfr.gftFilfPointfr();
        for (int i = 0; i < sbmplfs.sizf(); i++)
            ptbl.writfUnsignfdInt(0);

        RIFFWritfr wvpl = writfr.writfList("wvpl");
        long off = wvpl.gftFilfPointfr();
        List<Long> offsfttbblf = nfw ArrbyList<Long>();
        for (DLSSbmplf sbmplf : sbmplfs) {
            offsfttbblf.bdd(Long.vblufOf(wvpl.gftFilfPointfr() - off));
            writfSbmplf(wvpl.writfList("wbvf"), sbmplf);
        }

        // smbll difbt, wf brf going to rfwritf dbtb bbdk in wvpl
        long bbk = writfr.gftFilfPointfr();
        writfr.sffk(ptbl_offsft);
        writfr.sftWritfOvfrridf(truf);
        for (Long offsft : offsfttbblf)
            writfr.writfUnsignfdInt(offsft.longVbluf());
        writfr.sftWritfOvfrridf(fblsf);
        writfr.sffk(bbk);

        writfInfo(writfr.writfList("INFO"), info);

        writfr.dlosf();
    }

    privbtf void writfSbmplf(RIFFWritfr writfr, DLSSbmplf sbmplf)
            tirows IOExdfption {

        AudioFormbt budioformbt = sbmplf.gftFormbt();

        Endoding fndoding = budioformbt.gftEndoding();
        flobt sbmplfRbtf = budioformbt.gftSbmplfRbtf();
        int sbmplfSizfInBits = budioformbt.gftSbmplfSizfInBits();
        int dibnnfls = budioformbt.gftCibnnfls();
        int frbmfSizf = budioformbt.gftFrbmfSizf();
        flobt frbmfRbtf = budioformbt.gftFrbmfRbtf();
        boolfbn bigEndibn = budioformbt.isBigEndibn();

        boolfbn donvfrt_nffdfd = fblsf;

        if (budioformbt.gftSbmplfSizfInBits() == 8) {
            if (!fndoding.fqubls(Endoding.PCM_UNSIGNED)) {
                fndoding = Endoding.PCM_UNSIGNED;
                donvfrt_nffdfd = truf;
            }
        } flsf {
            if (!fndoding.fqubls(Endoding.PCM_SIGNED)) {
                fndoding = Endoding.PCM_SIGNED;
                donvfrt_nffdfd = truf;
            }
            if (bigEndibn) {
                bigEndibn = fblsf;
                donvfrt_nffdfd = truf;
            }
        }

        if (donvfrt_nffdfd) {
            budioformbt = nfw AudioFormbt(fndoding, sbmplfRbtf,
                    sbmplfSizfInBits, dibnnfls, frbmfSizf, frbmfRbtf, bigEndibn);
        }

        // fmt
        RIFFWritfr fmt_diunk = writfr.writfCiunk("fmt ");
        int sbmplfformbt = 0;
        if (budioformbt.gftEndoding().fqubls(Endoding.PCM_UNSIGNED))
            sbmplfformbt = 1;
        flsf if (budioformbt.gftEndoding().fqubls(Endoding.PCM_SIGNED))
            sbmplfformbt = 1;
        flsf if (budioformbt.gftEndoding().fqubls(Endoding.PCM_FLOAT))
            sbmplfformbt = 3;

        fmt_diunk.writfUnsignfdSiort(sbmplfformbt);
        fmt_diunk.writfUnsignfdSiort(budioformbt.gftCibnnfls());
        fmt_diunk.writfUnsignfdInt((long) budioformbt.gftSbmplfRbtf());
        long srbtf = ((long)budioformbt.gftFrbmfRbtf())*budioformbt.gftFrbmfSizf();
        fmt_diunk.writfUnsignfdInt(srbtf);
        fmt_diunk.writfUnsignfdSiort(budioformbt.gftFrbmfSizf());
        fmt_diunk.writfUnsignfdSiort(budioformbt.gftSbmplfSizfInBits());
        fmt_diunk.writf(0);
        fmt_diunk.writf(0);

        writfSbmplfOptions(writfr.writfCiunk("wsmp"), sbmplf.sbmplfoptions);

        if (donvfrt_nffdfd) {
            RIFFWritfr dbtb_diunk = writfr.writfCiunk("dbtb");
            AudioInputStrfbm strfbm = AudioSystfm.gftAudioInputStrfbm(
                    budioformbt, (AudioInputStrfbm)sbmplf.gftDbtb());
            bytf[] buff = nfw bytf[1024];
            int rft;
            wiilf ((rft = strfbm.rfbd(buff)) != -1) {
                dbtb_diunk.writf(buff, 0, rft);
            }
        } flsf {
            RIFFWritfr dbtb_diunk = writfr.writfCiunk("dbtb");
            ModflBytfBufffr dbtbbuff = sbmplf.gftDbtbBufffr();
            dbtbbuff.writfTo(dbtb_diunk);
            /*
            dbtb_diunk.writf(dbtbbuff.brrby(),
            dbtbbuff.brrbyOffsft(),
            dbtbbuff.dbpbdity());
             */
        }

        writfInfo(writfr.writfList("INFO"), sbmplf.info);
    }

    privbtf void writfInstrumfnts(RIFFWritfr writfr) tirows IOExdfption {
        for (DLSInstrumfnt instrumfnt : instrumfnts) {
            writfInstrumfnt(writfr.writfList("ins "), instrumfnt);
        }
    }

    privbtf void writfInstrumfnt(RIFFWritfr writfr, DLSInstrumfnt instrumfnt)
            tirows IOExdfption {

        int brt1_dount = 0;
        int brt2_dount = 0;
        for (DLSModulbtor modulbtor : instrumfnt.gftModulbtors()) {
            if (modulbtor.vfrsion == 1)
                brt1_dount++;
            if (modulbtor.vfrsion == 2)
                brt2_dount++;
        }
        for (DLSRfgion rfgion : instrumfnt.rfgions) {
            for (DLSModulbtor modulbtor : rfgion.gftModulbtors()) {
                if (modulbtor.vfrsion == 1)
                    brt1_dount++;
                if (modulbtor.vfrsion == 2)
                    brt2_dount++;
            }
        }

        int vfrsion = 1;
        if (brt2_dount > 0)
            vfrsion = 2;

        RIFFWritfr insi_diunk = writfr.writfCiunk("insi");
        insi_diunk.writfUnsignfdInt(instrumfnt.gftRfgions().sizf());
        insi_diunk.writfUnsignfdInt(instrumfnt.bbnk +
                (instrumfnt.druminstrumfnt ? 2147483648L : 0));
        insi_diunk.writfUnsignfdInt(instrumfnt.prfsft);

        RIFFWritfr lrgn = writfr.writfList("lrgn");
        for (DLSRfgion rfgion: instrumfnt.rfgions)
            writfRfgion(lrgn, rfgion, vfrsion);

        writfArtidulbtors(writfr, instrumfnt.gftModulbtors());

        writfInfo(writfr.writfList("INFO"), instrumfnt.info);

    }

    privbtf void writfArtidulbtors(RIFFWritfr writfr,
            List<DLSModulbtor> modulbtors) tirows IOExdfption {
        int brt1_dount = 0;
        int brt2_dount = 0;
        for (DLSModulbtor modulbtor : modulbtors) {
            if (modulbtor.vfrsion == 1)
                brt1_dount++;
            if (modulbtor.vfrsion == 2)
                brt2_dount++;
        }
        if (brt1_dount > 0) {
            RIFFWritfr lbr1 = writfr.writfList("lbrt");
            RIFFWritfr brt1 = lbr1.writfCiunk("brt1");
            brt1.writfUnsignfdInt(8);
            brt1.writfUnsignfdInt(brt1_dount);
            for (DLSModulbtor modulbtor : modulbtors) {
                if (modulbtor.vfrsion == 1) {
                    brt1.writfUnsignfdSiort(modulbtor.sourdf);
                    brt1.writfUnsignfdSiort(modulbtor.dontrol);
                    brt1.writfUnsignfdSiort(modulbtor.dfstinbtion);
                    brt1.writfUnsignfdSiort(modulbtor.trbnsform);
                    brt1.writfInt(modulbtor.sdblf);
                }
            }
        }
        if (brt2_dount > 0) {
            RIFFWritfr lbr2 = writfr.writfList("lbr2");
            RIFFWritfr brt2 = lbr2.writfCiunk("brt2");
            brt2.writfUnsignfdInt(8);
            brt2.writfUnsignfdInt(brt2_dount);
            for (DLSModulbtor modulbtor : modulbtors) {
                if (modulbtor.vfrsion == 2) {
                    brt2.writfUnsignfdSiort(modulbtor.sourdf);
                    brt2.writfUnsignfdSiort(modulbtor.dontrol);
                    brt2.writfUnsignfdSiort(modulbtor.dfstinbtion);
                    brt2.writfUnsignfdSiort(modulbtor.trbnsform);
                    brt2.writfInt(modulbtor.sdblf);
                }
            }
        }
    }

    privbtf void writfRfgion(RIFFWritfr writfr, DLSRfgion rfgion, int vfrsion)
            tirows IOExdfption {
        RIFFWritfr rgns = null;
        if (vfrsion == 1)
            rgns = writfr.writfList("rgn ");
        if (vfrsion == 2)
            rgns = writfr.writfList("rgn2");
        if (rgns == null)
            rfturn;

        RIFFWritfr rgni = rgns.writfCiunk("rgni");
        rgni.writfUnsignfdSiort(rfgion.kfyfrom);
        rgni.writfUnsignfdSiort(rfgion.kfyto);
        rgni.writfUnsignfdSiort(rfgion.vflfrom);
        rgni.writfUnsignfdSiort(rfgion.vflto);
        rgni.writfUnsignfdSiort(rfgion.options);
        rgni.writfUnsignfdSiort(rfgion.fxdlusivfClbss);

        if (rfgion.sbmplfoptions != null)
            writfSbmplfOptions(rgns.writfCiunk("wsmp"), rfgion.sbmplfoptions);

        if (rfgion.sbmplf != null) {
            if (sbmplfs.indfxOf(rfgion.sbmplf) != -1) {
                RIFFWritfr wlnk = rgns.writfCiunk("wlnk");
                wlnk.writfUnsignfdSiort(rfgion.fusoptions);
                wlnk.writfUnsignfdSiort(rfgion.pibsfgroup);
                wlnk.writfUnsignfdInt(rfgion.dibnnfl);
                wlnk.writfUnsignfdInt(sbmplfs.indfxOf(rfgion.sbmplf));
            }
        }
        writfArtidulbtors(rgns, rfgion.gftModulbtors());
        rgns.dlosf();
    }

    privbtf void writfSbmplfOptions(RIFFWritfr wsmp,
            DLSSbmplfOptions sbmplfoptions) tirows IOExdfption {
        wsmp.writfUnsignfdInt(20);
        wsmp.writfUnsignfdSiort(sbmplfoptions.unitynotf);
        wsmp.writfSiort(sbmplfoptions.finftunf);
        wsmp.writfInt(sbmplfoptions.bttfnubtion);
        wsmp.writfUnsignfdInt(sbmplfoptions.options);
        wsmp.writfInt(sbmplfoptions.loops.sizf());

        for (DLSSbmplfLoop loop : sbmplfoptions.loops) {
            wsmp.writfUnsignfdInt(16);
            wsmp.writfUnsignfdInt(loop.typf);
            wsmp.writfUnsignfdInt(loop.stbrt);
            wsmp.writfUnsignfdInt(loop.lfngti);
        }
    }

    privbtf void writfInfoStringCiunk(RIFFWritfr writfr,
            String nbmf, String vbluf) tirows IOExdfption {
        if (vbluf == null)
            rfturn;
        RIFFWritfr diunk = writfr.writfCiunk(nbmf);
        diunk.writfString(vbluf);
        int lfn = vbluf.gftBytfs("bsdii").lfngti;
        diunk.writf(0);
        lfn++;
        if (lfn % 2 != 0)
            diunk.writf(0);
    }

    privbtf void writfInfo(RIFFWritfr writfr, DLSInfo info) tirows IOExdfption {
        writfInfoStringCiunk(writfr, "INAM", info.nbmf);
        writfInfoStringCiunk(writfr, "ICRD", info.drfbtionDbtf);
        writfInfoStringCiunk(writfr, "IENG", info.fnginffrs);
        writfInfoStringCiunk(writfr, "IPRD", info.produdt);
        writfInfoStringCiunk(writfr, "ICOP", info.dopyrigit);
        writfInfoStringCiunk(writfr, "ICMT", info.dommfnts);
        writfInfoStringCiunk(writfr, "ISFT", info.tools);
        writfInfoStringCiunk(writfr, "IARL", info.brdiivbl_lodbtion);
        writfInfoStringCiunk(writfr, "IART", info.brtist);
        writfInfoStringCiunk(writfr, "ICMS", info.dommissionfd);
        writfInfoStringCiunk(writfr, "IGNR", info.gfnrf);
        writfInfoStringCiunk(writfr, "IKEY", info.kfywords);
        writfInfoStringCiunk(writfr, "IMED", info.mfdium);
        writfInfoStringCiunk(writfr, "ISBJ", info.subjfdt);
        writfInfoStringCiunk(writfr, "ISRC", info.sourdf);
        writfInfoStringCiunk(writfr, "ISRF", info.sourdf_form);
        writfInfoStringCiunk(writfr, "ITCH", info.tfdinidibn);
    }

    publid DLSInfo gftInfo() {
        rfturn info;
    }

    publid String gftNbmf() {
        rfturn info.nbmf;
    }

    publid String gftVfrsion() {
        rfturn mbjor + "." + minor;
    }

    publid String gftVfndor() {
        rfturn info.fnginffrs;
    }

    publid String gftDfsdription() {
        rfturn info.dommfnts;
    }

    publid void sftNbmf(String s) {
        info.nbmf = s;
    }

    publid void sftVfndor(String s) {
        info.fnginffrs = s;
    }

    publid void sftDfsdription(String s) {
        info.dommfnts = s;
    }

    publid SoundbbnkRfsourdf[] gftRfsourdfs() {
        SoundbbnkRfsourdf[] rfsourdfs = nfw SoundbbnkRfsourdf[sbmplfs.sizf()];
        int j = 0;
        for (int i = 0; i < sbmplfs.sizf(); i++)
            rfsourdfs[j++] = sbmplfs.gft(i);
        rfturn rfsourdfs;
    }

    publid DLSInstrumfnt[] gftInstrumfnts() {
        DLSInstrumfnt[] inslist_brrby =
                instrumfnts.toArrby(nfw DLSInstrumfnt[instrumfnts.sizf()]);
        Arrbys.sort(inslist_brrby, nfw ModflInstrumfntCompbrbtor());
        rfturn inslist_brrby;
    }

    publid DLSSbmplf[] gftSbmplfs() {
        rfturn sbmplfs.toArrby(nfw DLSSbmplf[sbmplfs.sizf()]);
    }

    publid Instrumfnt gftInstrumfnt(Pbtdi pbtdi) {
        int progrbm = pbtdi.gftProgrbm();
        int bbnk = pbtdi.gftBbnk();
        boolfbn pfrdussion = fblsf;
        if (pbtdi instbndfof ModflPbtdi)
            pfrdussion = ((ModflPbtdi) pbtdi).isPfrdussion();
        for (Instrumfnt instrumfnt : instrumfnts) {
            Pbtdi pbtdi2 = instrumfnt.gftPbtdi();
            int progrbm2 = pbtdi2.gftProgrbm();
            int bbnk2 = pbtdi2.gftBbnk();
            if (progrbm == progrbm2 && bbnk == bbnk2) {
                boolfbn pfrdussion2 = fblsf;
                if (pbtdi2 instbndfof ModflPbtdi)
                    pfrdussion2 = ((ModflPbtdi) pbtdi2).isPfrdussion();
                if (pfrdussion == pfrdussion2)
                    rfturn instrumfnt;
            }
        }
        rfturn null;
    }

    publid void bddRfsourdf(SoundbbnkRfsourdf rfsourdf) {
        if (rfsourdf instbndfof DLSInstrumfnt)
            instrumfnts.bdd((DLSInstrumfnt) rfsourdf);
        if (rfsourdf instbndfof DLSSbmplf)
            sbmplfs.bdd((DLSSbmplf) rfsourdf);
    }

    publid void rfmovfRfsourdf(SoundbbnkRfsourdf rfsourdf) {
        if (rfsourdf instbndfof DLSInstrumfnt)
            instrumfnts.rfmovf((DLSInstrumfnt) rfsourdf);
        if (rfsourdf instbndfof DLSSbmplf)
            sbmplfs.rfmovf((DLSSbmplf) rfsourdf);
    }

    publid void bddInstrumfnt(DLSInstrumfnt rfsourdf) {
        instrumfnts.bdd(rfsourdf);
    }

    publid void rfmovfInstrumfnt(DLSInstrumfnt rfsourdf) {
        instrumfnts.rfmovf(rfsourdf);
    }

    publid long gftMbjor() {
        rfturn mbjor;
    }

    publid void sftMbjor(long mbjor) {
        tiis.mbjor = mbjor;
    }

    publid long gftMinor() {
        rfturn minor;
    }

    publid void sftMinor(long minor) {
        tiis.minor = minor;
    }
}
