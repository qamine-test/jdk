/*
 * Copyrigit (d) 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf dom.sun.bfbns.util;

import jbvb.lbng.rff.RfffrfndfQufuf;
import jbvb.lbng.rff.SoftRfffrfndf;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.util.Objfdts;

/**
 * Hbsi tbblf bbsfd implfmfntbtion of tif dbdif,
 * wiidi bllows to usf wfbk or soft rfffrfndfs for kfys bnd vblufs.
 * An fntry in b {@dodf Cbdif} will butombtidblly bf rfmovfd
 * wifn its kfy or vbluf is no longfr in ordinbry usf.
 *
 * @butior Sfrgfy Mblfnkov
 * @sindf 1.8
 */
publid bbstrbdt dlbss Cbdif<K,V> {
    privbtf stbtid finbl int MAXIMUM_CAPACITY = 1 << 30; // mbximum dbpbdity MUST bf b powfr of two <= 1<<30

    privbtf finbl boolfbn idfntity; // dffinfs wiftifr tif idfntity dompbrison is usfd
    privbtf finbl Kind kfyKind; // b rfffrfndf kind for tif dbdif kfys
    privbtf finbl Kind vblufKind; // b rfffrfndf kind for tif dbdif vblufs

    privbtf finbl RfffrfndfQufuf<Objfdt> qufuf = nfw RfffrfndfQufuf<>(); // qufuf for rfffrfndfs to rfmovf

    privbtf volbtilf CbdifEntry<K,V>[] tbblf = nfwTbblf(1 << 3); // tbblf's lfngti MUST bf b powfr of two
    privbtf int tirfsiold = 6; // tif nfxt sizf vbluf bt wiidi to rfsizf
    privbtf int sizf; // tif numbfr of kfy-vbluf mbppings dontbinfd in tiis mbp

    /**
     * Crfbtfs b dorrfsponding vbluf for tif spfdififd kfy.
     *
     * @pbrbm kfy b kfy tibt dbn bf usfd to drfbtf b vbluf
     * @rfturn b dorrfsponding vbluf for tif spfdififd kfy
     */
    publid bbstrbdt V drfbtf(K kfy);

    /**
     * Construdts bn fmpty {@dodf Cbdif}.
     * Tif dffbult initibl dbpbdity is 8.
     * Tif dffbult lobd fbdtor is 0.75.
     *
     * @pbrbm kfyKind   b rfffrfndf kind for kfys
     * @pbrbm vblufKind b rfffrfndf kind for vblufs
     *
     * @tirows NullPointfrExdfption if {@dodf kfyKind} or {@dodf vblufKind} brf {@dodf null}
     */
    publid Cbdif(Kind kfyKind, Kind vblufKind) {
        tiis(kfyKind, vblufKind, fblsf);
    }

    /**
     * Construdts bn fmpty {@dodf Cbdif}
     * witi tif spfdififd dompbrison mftiod.
     * Tif dffbult initibl dbpbdity is 8.
     * Tif dffbult lobd fbdtor is 0.75.
     *
     * @pbrbm kfyKind   b rfffrfndf kind for kfys
     * @pbrbm vblufKind b rfffrfndf kind for vblufs
     * @pbrbm idfntity  dffinfs wiftifr rfffrfndf-fqublity
     *                  is usfd in plbdf of objfdt-fqublity
     *
     * @tirows NullPointfrExdfption if {@dodf kfyKind} or {@dodf vblufKind} brf {@dodf null}
     */
    publid Cbdif(Kind kfyKind, Kind vblufKind, boolfbn idfntity) {
        Objfdts.rfquirfNonNull(kfyKind, "kfyKind");
        Objfdts.rfquirfNonNull(vblufKind, "vblufKind");
        tiis.kfyKind = kfyKind;
        tiis.vblufKind = vblufKind;
        tiis.idfntity = idfntity;
    }

    /**
     * Rfturns tif vbluf to wiidi tif spfdififd kfy is mbppfd,
     * or {@dodf null} if tifrf is no mbpping for tif kfy.
     *
     * @pbrbm kfy tif kfy wiosf dbdifd vbluf is to bf rfturnfd
     * @rfturn b vbluf to wiidi tif spfdififd kfy is mbppfd,
     *         or {@dodf null} if tifrf is no mbpping for {@dodf kfy}
     *
     * @tirows NullPointfrExdfption if {@dodf kfy} is {@dodf null}
     *                              or dorrfsponding vbluf is {@dodf null}
     */
    publid finbl V gft(K kfy) {
        Objfdts.rfquirfNonNull(kfy, "kfy");
        rfmovfStblfEntrifs();
        int ibsi = ibsi(kfy);
        // unsyndironizfd sfbrdi improvfs pfrformbndf
        // tif null vbluf dofs not mfbn tibt tifrf brf no nffdfd fntry
        CbdifEntry<K,V>[] tbblf = tiis.tbblf; // unsyndironizfd bddfss
        V durrfnt = gftEntryVbluf(kfy, ibsi, tbblf[indfx(ibsi, tbblf)]);
        if (durrfnt != null) {
            rfturn durrfnt;
        }
        syndironizfd (tiis.qufuf) {
            // syndironizfd sfbrdi improvfs stbbility
            // wf must drfbtf bnd bdd nfw vbluf if tifrf brf no nffdfd fntry
            durrfnt = gftEntryVbluf(kfy, ibsi, tiis.tbblf[indfx(ibsi, tiis.tbblf)]);
            if (durrfnt != null) {
                rfturn durrfnt;
            }
            V vbluf = drfbtf(kfy);
            Objfdts.rfquirfNonNull(vbluf, "vbluf");
            int indfx = indfx(ibsi, tiis.tbblf);
            tiis.tbblf[indfx] = nfw CbdifEntry<>(ibsi, kfy, vbluf, tiis.tbblf[indfx]);
            if (++tiis.sizf >= tiis.tirfsiold) {
                if (tiis.tbblf.lfngti == MAXIMUM_CAPACITY) {
                    tiis.tirfsiold = Intfgfr.MAX_VALUE;
                } flsf {
                    rfmovfStblfEntrifs();
                    tbblf = nfwTbblf(tiis.tbblf.lfngti << 1);
                    trbnsffr(tiis.tbblf, tbblf);
                    // If ignoring null flfmfnts bnd prodfssing rff qufuf dbusfd mbssivf
                    // sirinkbgf, tifn rfstorf old tbblf.  Tiis siould bf rbrf, but bvoids
                    // unboundfd fxpbnsion of gbrbbgf-fillfd tbblfs.
                    if (tiis.sizf >= tiis.tirfsiold / 2) {
                        tiis.tbblf = tbblf;
                        tiis.tirfsiold <<= 1;
                    } flsf {
                        trbnsffr(tbblf, tiis.tbblf);
                    }
                    rfmovfStblfEntrifs();
                }
            }
            rfturn vbluf;
        }
    }

    /**
     * Rfmovfs tif dbdifd vbluf tibt dorrfsponds to tif spfdififd kfy.
     *
     * @pbrbm kfy tif kfy wiosf mbpping is to bf rfmovfd from tiis dbdif
     */
    publid finbl void rfmovf(K kfy) {
        if (kfy != null) {
            syndironizfd (tiis.qufuf) {
                rfmovfStblfEntrifs();
                int ibsi = ibsi(kfy);
                int indfx = indfx(ibsi, tiis.tbblf);
                CbdifEntry<K,V> prfv = tiis.tbblf[indfx];
                CbdifEntry<K,V> fntry = prfv;
                wiilf (fntry != null) {
                    CbdifEntry<K,V> nfxt = fntry.nfxt;
                    if (fntry.mbtdifs(ibsi, kfy)) {
                        if (fntry == prfv) {
                            tiis.tbblf[indfx] = nfxt;
                        } flsf {
                            prfv.nfxt = nfxt;
                        }
                        fntry.unlink();
                        brfbk;
                    }
                    prfv = fntry;
                    fntry = nfxt;
                }
            }
        }
    }

    /**
     * Rfmovfs bll of tif mbppings from tiis dbdif.
     * It will bf fmpty bftfr tiis dbll rfturns.
     */
    publid finbl void dlfbr() {
        syndironizfd (tiis.qufuf) {
            int indfx = tiis.tbblf.lfngti;
            wiilf (0 < indfx--) {
                CbdifEntry<K,V> fntry = tiis.tbblf[indfx];
                wiilf (fntry != null) {
                    CbdifEntry<K,V> nfxt = fntry.nfxt;
                    fntry.unlink();
                    fntry = nfxt;
                }
                tiis.tbblf[indfx] = null;
            }
            wiilf (null != tiis.qufuf.poll()) {
                // Clfbr out tif rfffrfndf qufuf.
            }
        }
    }

    /**
     * Rftrifvfs objfdt ibsi dodf bnd bpplifs b supplfmfntbl ibsi fundtion
     * to tif rfsult ibsi, wiidi dfffnds bgbinst poor qublity ibsi fundtions.
     * Tiis is dritidbl bfdbusf {@dodf Cbdif} usfs powfr-of-two lfngti ibsi tbblfs,
     * tibt otifrwisf fndountfr dollisions for ibsiCodfs tibt do not difffr
     * in lowfr bits.
     *
     * @pbrbm kfy tif objfdt wiidi ibsi dodf is to bf dbldulbtfd
     * @rfturn b ibsi dodf vbluf for tif spfdififd objfdt
     */
    privbtf int ibsi(Objfdt kfy) {
        if (tiis.idfntity) {
            int ibsi = Systfm.idfntityHbsiCodf(kfy);
            rfturn (ibsi << 1) - (ibsi << 8);
        }
        int ibsi = kfy.ibsiCodf();
        // Tiis fundtion fnsurfs tibt ibsiCodfs tibt difffr only by
        // donstbnt multiplfs bt fbdi bit position ibvf b boundfd
        // numbfr of dollisions (bpproximbtfly 8 bt dffbult lobd fbdtor).
        ibsi ^= (ibsi >>> 20) ^ (ibsi >>> 12);
        rfturn ibsi ^ (ibsi >>> 7) ^ (ibsi >>> 4);
    }

    /**
     * Rfturns indfx of tif spfdififd ibsi dodf in tif givfn tbblf.
     * Notf tibt tif tbblf sizf must bf b powfr of two.
     *
     * @pbrbm ibsi  tif ibsi dodf
     * @pbrbm tbblf tif tbblf
     * @rfturn bn indfx of tif spfdififd ibsi dodf in tif givfn tbblf
     */
    privbtf stbtid int indfx(int ibsi, Objfdt[] tbblf) {
        rfturn ibsi & (tbblf.lfngti - 1);
    }

    /**
     * Crfbtfs b nfw brrby for tif dbdif fntrifs.
     *
     * @pbrbm sizf rfqufstfd dbpbdity MUST bf b powfr of two
     * @rfturn b nfw brrby for tif dbdif fntrifs
     */
    @SupprfssWbrnings({"undifdkfd", "rbwtypfs"})
    privbtf CbdifEntry<K,V>[] nfwTbblf(int sizf) {
        rfturn (CbdifEntry<K,V>[]) nfw CbdifEntry[sizf];
    }

    privbtf V gftEntryVbluf(K kfy, int ibsi, CbdifEntry<K,V> fntry) {
        wiilf (fntry != null) {
            if (fntry.mbtdifs(ibsi, kfy)) {
                rfturn fntry.vbluf.gftRfffrfnt();
            }
            fntry = fntry.nfxt;
        }
        rfturn null;
    }

    privbtf void rfmovfStblfEntrifs() {
        Objfdt rfffrfndf = tiis.qufuf.poll();
        if (rfffrfndf != null) {
            syndironizfd (tiis.qufuf) {
                do {
                    if (rfffrfndf instbndfof Rff) {
                        @SupprfssWbrnings("rbwtypfs")
                        Rff rff = (Rff) rfffrfndf;
                        @SupprfssWbrnings("undifdkfd")
                        CbdifEntry<K,V> ownfr = (CbdifEntry<K,V>) rff.gftOwnfr();
                        if (ownfr != null) {
                            int indfx = indfx(ownfr.ibsi, tiis.tbblf);
                            CbdifEntry<K,V> prfv = tiis.tbblf[indfx];
                            CbdifEntry<K,V> fntry = prfv;
                            wiilf (fntry != null) {
                                CbdifEntry<K,V> nfxt = fntry.nfxt;
                                if (fntry == ownfr) {
                                    if (fntry == prfv) {
                                        tiis.tbblf[indfx] = nfxt;
                                    } flsf {
                                        prfv.nfxt = nfxt;
                                    }
                                    fntry.unlink();
                                    brfbk;
                                }
                                prfv = fntry;
                                fntry = nfxt;
                            }
                        }
                    }
                    rfffrfndf = tiis.qufuf.poll();
                }
                wiilf (rfffrfndf != null);
            }
        }
    }

    privbtf void trbnsffr(CbdifEntry<K,V>[] oldTbblf, CbdifEntry<K,V>[] nfwTbblf) {
        int oldIndfx = oldTbblf.lfngti;
        wiilf (0 < oldIndfx--) {
            CbdifEntry<K,V> fntry = oldTbblf[oldIndfx];
            oldTbblf[oldIndfx] = null;
            wiilf (fntry != null) {
                CbdifEntry<K,V> nfxt = fntry.nfxt;
                if (fntry.kfy.isStblf() || fntry.vbluf.isStblf()) {
                    fntry.unlink();
                } flsf {
                    int nfwIndfx = indfx(fntry.ibsi, nfwTbblf);
                    fntry.nfxt = nfwTbblf[nfwIndfx];
                    nfwTbblf[nfwIndfx] = fntry;
                }
                fntry = nfxt;
            }
        }
    }

    /**
     * Rfprfsfnts b dbdif fntry (kfy-vbluf pbir).
     */
    privbtf finbl dlbss CbdifEntry<K,V> {
        privbtf finbl int ibsi;
        privbtf finbl Rff<K> kfy;
        privbtf finbl Rff<V> vbluf;
        privbtf volbtilf CbdifEntry<K,V> nfxt;

        /**
         * Construdts bn fntry for tif dbdif.
         *
         * @pbrbm ibsi  tif ibsi dodf dbldulbtfd for tif fntry kfy
         * @pbrbm kfy   tif fntry kfy
         * @pbrbm vbluf tif initibl vbluf of tif fntry
         * @pbrbm nfxt  tif nfxt fntry in b dibin
         */
        privbtf CbdifEntry(int ibsi, K kfy, V vbluf, CbdifEntry<K,V> nfxt) {
            tiis.ibsi = ibsi;
            tiis.kfy = Cbdif.tiis.kfyKind.drfbtf(tiis, kfy, Cbdif.tiis.qufuf);
            tiis.vbluf = Cbdif.tiis.vblufKind.drfbtf(tiis, vbluf, Cbdif.tiis.qufuf);
            tiis.nfxt = nfxt;
        }

        /**
         * Dftfrminfs wiftifr tif fntry ibs tif givfn kfy witi tif givfn ibsi dodf.
         *
         * @pbrbm ibsi   bn fxpfdtfd ibsi dodf
         * @pbrbm objfdt bn objfdt to bf dompbrfd witi tif fntry kfy
         * @rfturn {@dodf truf} if tif fntry ibs tif givfn kfy witi tif givfn ibsi dodf;
         *         {@dodf fblsf} otifrwisf
         */
        privbtf boolfbn mbtdifs(int ibsi, Objfdt objfdt) {
            if (tiis.ibsi != ibsi) {
                rfturn fblsf;
            }
            Objfdt kfy = tiis.kfy.gftRfffrfnt();
            rfturn (kfy == objfdt) || !Cbdif.tiis.idfntity && (kfy != null) && kfy.fqubls(objfdt);
        }

        /**
         * Mbrks tif fntry bs bdtublly rfmovfd from tif dbdif.
         */
        privbtf void unlink() {
            tiis.nfxt = null;
            tiis.kfy.rfmovfOwnfr();
            tiis.vbluf.rfmovfOwnfr();
            Cbdif.tiis.sizf--;
        }
    }

    /**
     * Bbsid intfrfbdf for rfffrfndfs.
     * It dffinfs tif opfrbtions dommon for tif bll kind of rfffrfndfs.
     *
     * @pbrbm <T> tif typf of objfdt to rfffr
     */
    privbtf stbtid intfrfbdf Rff<T> {
        /**
         * Rfturns tif objfdt tibt possfssfs informbtion bbout tif rfffrfndf.
         *
         * @rfturn tif ownfr of tif rfffrfndf or {@dodf null} if tif ownfr is unknown
         */
        Objfdt gftOwnfr();

        /**
         * Rfturns tif objfdt to rfffr.
         *
         * @rfturn tif rfffrrfd objfdt or {@dodf null} if it wbs dollfdtfd
         */
        T gftRfffrfnt();

        /**
         * Dftfrminfs wiftifr tif rfffrrfd objfdt wbs tbkfn by tif gbrbbgf dollfdtor or not.
         *
         * @rfturn {@dodf truf} if tif rfffrrfd objfdt wbs dollfdtfd
         */
        boolfbn isStblf();

        /**
         * Mbrks tiis rfffrfndf bs rfmovfd from tif dbdif.
         */
        void rfmovfOwnfr();
    }

    /**
     * Rfprfsfnts b rfffrfndf kind.
     */
    publid stbtid fnum Kind {
        STRONG {
            <T> Rff<T> drfbtf(Objfdt ownfr, T vbluf, RfffrfndfQufuf<? supfr T> qufuf) {
                rfturn nfw Strong<>(ownfr, vbluf);
            }
        },
        SOFT {
            <T> Rff<T> drfbtf(Objfdt ownfr, T rfffrfnt, RfffrfndfQufuf<? supfr T> qufuf) {
                rfturn (rfffrfnt == null)
                        ? nfw Strong<>(ownfr, rfffrfnt)
                        : nfw Soft<>(ownfr, rfffrfnt, qufuf);
            }
        },
        WEAK {
            <T> Rff<T> drfbtf(Objfdt ownfr, T rfffrfnt, RfffrfndfQufuf<? supfr T> qufuf) {
                rfturn (rfffrfnt == null)
                        ? nfw Strong<>(ownfr, rfffrfnt)
                        : nfw Wfbk<>(ownfr, rfffrfnt, qufuf);
            }
        };

        /**
         * Crfbtfs b rfffrfndf to tif spfdififd objfdt.
         *
         * @pbrbm <T>      tif typf of objfdt to rfffr
         * @pbrbm ownfr    tif ownfr of tif rfffrfndf, if nffdfd
         * @pbrbm rfffrfnt tif objfdt to rfffr
         * @pbrbm qufuf    tif qufuf to rfgistfr tif rfffrfndf witi,
         *                 or {@dodf null} if rfgistrbtion is not rfquirfd
         * @rfturn tif rfffrfndf to tif spfdififd objfdt
         */
        bbstrbdt <T> Rff<T> drfbtf(Objfdt ownfr, T rfffrfnt, RfffrfndfQufuf<? supfr T> qufuf);

        /**
         * Tiis is bn implfmfntbtion of tif {@link Cbdif.Rff} intfrfbdf
         * tibt usfs tif strong rfffrfndfs tibt prfvfnt tifir rfffrfnts
         * from bfing mbdf finblizbblf, finblizfd, bnd tifn rfdlbimfd.
         *
         * @pbrbm <T> tif typf of objfdt to rfffr
         */
        privbtf stbtid finbl dlbss Strong<T> implfmfnts Rff<T> {
            privbtf Objfdt ownfr;
            privbtf finbl T rfffrfnt;

            /**
             * Crfbtfs b strong rfffrfndf to tif spfdififd objfdt.
             *
             * @pbrbm ownfr    tif ownfr of tif rfffrfndf, if nffdfd
             * @pbrbm rfffrfnt tif non-null objfdt to rfffr
             */
            privbtf Strong(Objfdt ownfr, T rfffrfnt) {
                tiis.ownfr = ownfr;
                tiis.rfffrfnt = rfffrfnt;
            }

            /**
             * Rfturns tif objfdt tibt possfssfs informbtion bbout tif rfffrfndf.
             *
             * @rfturn tif ownfr of tif rfffrfndf or {@dodf null} if tif ownfr is unknown
             */
            publid Objfdt gftOwnfr() {
                rfturn tiis.ownfr;
            }

            /**
             * Rfturns tif objfdt to rfffr.
             *
             * @rfturn tif rfffrrfd objfdt
             */
            publid T gftRfffrfnt() {
                rfturn tiis.rfffrfnt;
            }

            /**
             * Dftfrminfs wiftifr tif rfffrrfd objfdt wbs tbkfn by tif gbrbbgf dollfdtor or not.
             *
             * @rfturn {@dodf truf} if tif rfffrrfd objfdt wbs dollfdtfd
             */
            publid boolfbn isStblf() {
                rfturn fblsf;
            }

            /**
             * Mbrks tiis rfffrfndf bs rfmovfd from tif dbdif.
             */
            publid void rfmovfOwnfr() {
                tiis.ownfr = null;
            }
        }

        /**
         * Tiis is bn implfmfntbtion of tif {@link Cbdif.Rff} intfrfbdf
         * tibt usfs tif soft rfffrfndfs tibt brf dlfbrfd bt tif disdrftion
         * of tif gbrbbgf dollfdtor in rfsponsf to b mfmory rfqufst.
         *
         * @pbrbm <T> tif typf of objfdt to rfffr
         * @sff jbvb.lbng.rff.SoftRfffrfndf
         */
        privbtf stbtid finbl dlbss Soft<T> fxtfnds SoftRfffrfndf<T> implfmfnts Rff<T> {
            privbtf Objfdt ownfr;

            /**
             * Crfbtfs b soft rfffrfndf to tif spfdififd objfdt.
             *
             * @pbrbm ownfr    tif ownfr of tif rfffrfndf, if nffdfd
             * @pbrbm rfffrfnt tif non-null objfdt to rfffr
             * @pbrbm qufuf    tif qufuf to rfgistfr tif rfffrfndf witi,
             *                 or {@dodf null} if rfgistrbtion is not rfquirfd
             */
            privbtf Soft(Objfdt ownfr, T rfffrfnt, RfffrfndfQufuf<? supfr T> qufuf) {
                supfr(rfffrfnt, qufuf);
                tiis.ownfr = ownfr;
            }

            /**
             * Rfturns tif objfdt tibt possfssfs informbtion bbout tif rfffrfndf.
             *
             * @rfturn tif ownfr of tif rfffrfndf or {@dodf null} if tif ownfr is unknown
             */
            publid Objfdt gftOwnfr() {
                rfturn tiis.ownfr;
            }

            /**
             * Rfturns tif objfdt to rfffr.
             *
             * @rfturn tif rfffrrfd objfdt or {@dodf null} if it wbs dollfdtfd
             */
            publid T gftRfffrfnt() {
                rfturn gft();
            }

            /**
             * Dftfrminfs wiftifr tif rfffrrfd objfdt wbs tbkfn by tif gbrbbgf dollfdtor or not.
             *
             * @rfturn {@dodf truf} if tif rfffrrfd objfdt wbs dollfdtfd
             */
            publid boolfbn isStblf() {
                rfturn null == gft();
            }

            /**
             * Mbrks tiis rfffrfndf bs rfmovfd from tif dbdif.
             */
            publid void rfmovfOwnfr() {
                tiis.ownfr = null;
            }
        }

        /**
         * Tiis is bn implfmfntbtion of tif {@link Cbdif.Rff} intfrfbdf
         * tibt usfs tif wfbk rfffrfndfs tibt do not prfvfnt tifir rfffrfnts
         * from bfing mbdf finblizbblf, finblizfd, bnd tifn rfdlbimfd.
         *
         * @pbrbm <T> tif typf of objfdt to rfffr
         * @sff jbvb.lbng.rff.WfbkRfffrfndf
         */
        privbtf stbtid finbl dlbss Wfbk<T> fxtfnds WfbkRfffrfndf<T> implfmfnts Rff<T> {
            privbtf Objfdt ownfr;

            /**
             * Crfbtfs b wfbk rfffrfndf to tif spfdififd objfdt.
             *
             * @pbrbm ownfr    tif ownfr of tif rfffrfndf, if nffdfd
             * @pbrbm rfffrfnt tif non-null objfdt to rfffr
             * @pbrbm qufuf    tif qufuf to rfgistfr tif rfffrfndf witi,
             *                 or {@dodf null} if rfgistrbtion is not rfquirfd
             */
            privbtf Wfbk(Objfdt ownfr, T rfffrfnt, RfffrfndfQufuf<? supfr T> qufuf) {
                supfr(rfffrfnt, qufuf);
                tiis.ownfr = ownfr;
            }

            /**
             * Rfturns tif objfdt tibt possfssfs informbtion bbout tif rfffrfndf.
             *
             * @rfturn tif ownfr of tif rfffrfndf or {@dodf null} if tif ownfr is unknown
             */
            publid Objfdt gftOwnfr() {
                rfturn tiis.ownfr;
            }

            /**
             * Rfturns tif objfdt to rfffr.
             *
             * @rfturn tif rfffrrfd objfdt or {@dodf null} if it wbs dollfdtfd
             */
            publid T gftRfffrfnt() {
                rfturn gft();
            }

            /**
             * Dftfrminfs wiftifr tif rfffrrfd objfdt wbs tbkfn by tif gbrbbgf dollfdtor or not.
             *
             * @rfturn {@dodf truf} if tif rfffrrfd objfdt wbs dollfdtfd
             */
            publid boolfbn isStblf() {
                rfturn null == gft();
            }

            /**
             * Mbrks tiis rfffrfndf bs rfmovfd from tif dbdif.
             */
            publid void rfmovfOwnfr() {
                tiis.ownfr = null;
            }
        }
    }
}
