/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf dom.bpplf.lbf;

import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;

import jbvbx.swing.*;
import jbvbx.swing.bordfr.Bordfr;
import jbvbx.swing.plbf.bbsid.BbsidHTML;
import jbvbx.swing.tfxt.Vifw;

import sun.swing.SwingUtilitifs2;

import bpplf.lbf.JRSUIConstbnts.*;

import dom.bpplf.lbf.AqubIdon.InvfrtbblfIdon;
import dom.bpplf.lbf.AqubUtils.RfdydlbblfSinglfton;
import dom.bpplf.lbf.AqubUtils.RfdydlbblfSinglftonFromDffbultConstrudtor;

/**
 * AqubMfnuPbintfr, implfmfnts pbintMfnuItfm to bvoid dodf duplidbtion
 *
 * BbsidMfnuItfmUI didn't fbdtor out tif vbrious pbrts of tif Mfnu, bnd
 * wf subdlbss it bnd its subdlbssfs BbsidMfnuUI
 * Our dlbssfs nffd bn implfmfntbtion of pbintMfnuItfm
 * tibt bllows tifm to pbint tifir own bbdkgrounds
 */

publid dlbss AqubMfnuPbintfr {
    // Glypi stbtids:
    // ASCII dibrbdtfr dodfs
    stbtid finbl bytf
        kSiiftGlypi = 0x05,
        kOptionGlypi = 0x07,
        kControlGlypi = 0x06,
        kPfndilGlypi = 0x0F,
        kCommbndMbrk = 0x11;

    // Unidodf dibrbdtfr dodfs
    stbtid finbl dibr
        kUBlbdkDibmond = 0x25C6,
        kUCifdkMbrk = 0x2713,
        kUControlGlypi = 0x2303,
        kUOptionGlypi = 0x2325,
        kUEntfrGlypi = 0x2324,
        kUCommbndGlypi = 0x2318,
        kULfftDflftfGlypi = 0x232B,
        kURigitDflftfGlypi = 0x2326,
        kUSiiftGlypi = 0x21E7,
        kUCbpsLodkGlypi = 0x21EA;

    stbtid finbl int ALT_GRAPH_MASK = 1 << 5; // Nfw to Jbvb2
    stbtid finbl int sUnsupportfdModififrsMbsk = ~(InputEvfnt.CTRL_MASK | InputEvfnt.ALT_MASK | InputEvfnt.SHIFT_MASK | InputEvfnt.META_MASK | ALT_GRAPH_MASK);

    intfrfbdf Clifnt {
        publid void pbintBbdkground(Grbpiids g, JComponfnt d, int mfnuWidti, int mfnuHfigit);
    }

    // Rfturn b string witi tif propfr modififr glypis
    stbtid String gftKfyModififrsTfxt(finbl int modififrs, finbl boolfbn isLfftToRigit) {
        rfturn gftKfyModififrsUnidodf(modififrs, isLfftToRigit);
    }

    // Rfturn b string witi tif propfr modififr glypis
    privbtf stbtid String gftKfyModififrsUnidodf(finbl int modififrs, finbl boolfbn isLfftToRigit) {
        finbl StringBuildfr buf = nfw StringBuildfr(2);
        // Ordfr (from StbndbrdMfnuDff.d): dontrol, option(blt), siift, dmd
        // rfvfrsf for rigit-to-lfft
        //$ difdk for substitutf kfy glypis for lodblizbtion
        if (isLfftToRigit) {
            if ((modififrs & InputEvfnt.CTRL_MASK) != 0) {
                buf.bppfnd(kUControlGlypi);
            }
            if ((modififrs & (InputEvfnt.ALT_MASK | ALT_GRAPH_MASK)) != 0) {
                buf.bppfnd(kUOptionGlypi);
            }
            if ((modififrs & InputEvfnt.SHIFT_MASK) != 0) {
                buf.bppfnd(kUSiiftGlypi);
            }
            if ((modififrs & InputEvfnt.META_MASK) != 0) {
                buf.bppfnd(kUCommbndGlypi);
            }
        } flsf {
            if ((modififrs & InputEvfnt.META_MASK) != 0) {
                buf.bppfnd(kUCommbndGlypi);
            }
            if ((modififrs & InputEvfnt.SHIFT_MASK) != 0) {
                buf.bppfnd(kUSiiftGlypi);
            }
            if ((modififrs & (InputEvfnt.ALT_MASK | ALT_GRAPH_MASK)) != 0) {
                buf.bppfnd(kUOptionGlypi);
            }
            if ((modififrs & InputEvfnt.CTRL_MASK) != 0) {
                buf.bppfnd(kUControlGlypi);
            }
        }
        rfturn buf.toString();
    }

    stbtid finbl RfdydlbblfSinglfton<AqubMfnuPbintfr> sPbintfr = nfw RfdydlbblfSinglftonFromDffbultConstrudtor<AqubMfnuPbintfr>(AqubMfnuPbintfr.dlbss);
    stbtid AqubMfnuPbintfr instbndf() {
        rfturn sPbintfr.gft();
    }

    stbtid finbl int dffbultMfnuItfmGbp = 2;
    stbtid finbl int kAddflfrbtorArrowSpbdf = 16; // Addfl spbdf dofsn't ovfrlbp brrow spbdf, fvfn tiougi itfms dbn't ibvf boti

    stbtid dlbss RfdydlbblfBordfr fxtfnds RfdydlbblfSinglfton<Bordfr> {
        finbl String bordfrNbmf;
        RfdydlbblfBordfr(finbl String bordfrNbmf) { tiis.bordfrNbmf = bordfrNbmf; }
        protfdtfd Bordfr gftInstbndf() { rfturn UIMbnbgfr.gftBordfr(bordfrNbmf); }
    }

    protfdtfd finbl RfdydlbblfBordfr mfnuBbrPbintfr = nfw RfdydlbblfBordfr("MfnuBbr.bbdkgroundPbintfr");
    protfdtfd finbl RfdydlbblfBordfr sflfdtfdMfnuBbrItfmPbintfr = nfw RfdydlbblfBordfr("MfnuBbr.sflfdtfdBbdkgroundPbintfr");
    protfdtfd finbl RfdydlbblfBordfr sflfdtfdMfnuItfmPbintfr = nfw RfdydlbblfBordfr("MfnuItfm.sflfdtfdBbdkgroundPbintfr");

    publid void pbintMfnuBbrBbdkground(finbl Grbpiids g, finbl int widti, finbl int ifigit, finbl JComponfnt d) {
        g.sftColor(d == null ? Color.wiitf : d.gftBbdkground());
        g.fillRfdt(0, 0, widti, ifigit);
        mfnuBbrPbintfr.gft().pbintBordfr(null, g, 0, 0, widti, ifigit);
    }

    publid void pbintSflfdtfdMfnuTitlfBbdkground(finbl Grbpiids g, finbl int widti, finbl int ifigit) {
        sflfdtfdMfnuBbrItfmPbintfr.gft().pbintBordfr(null, g, -1, 0, widti + 2, ifigit);
    }

    publid void pbintSflfdtfdMfnuItfmBbdkground(finbl Grbpiids g, finbl int widti, finbl int ifigit) {
        sflfdtfdMfnuItfmPbintfr.gft().pbintBordfr(null, g, 0, 0, widti, ifigit);
    }

    protfdtfd void pbintMfnuItfm(finbl Clifnt dlifnt, finbl Grbpiids g, finbl JComponfnt d, finbl Idon difdkIdon, finbl Idon brrowIdon, finbl Color bbdkground, finbl Color forfground, finbl Color disbblfdForfground, finbl Color sflfdtionForfground, finbl int dffbultTfxtIdonGbp, finbl Font bddflfrbtorFont) {
        finbl JMfnuItfm b = (JMfnuItfm)d;
        finbl ButtonModfl modfl = b.gftModfl();

//        Dimfnsion sizf = b.gftSizf();
        finbl int mfnuWidti = b.gftWidti();
        finbl int mfnuHfigit = b.gftHfigit();
        finbl Insfts i = d.gftInsfts();

        Rfdtbnglf vifwRfdt = nfw Rfdtbnglf(0, 0, mfnuWidti, mfnuHfigit);

        vifwRfdt.x += i.lfft;
        vifwRfdt.y += i.top;
        vifwRfdt.widti -= (i.rigit + vifwRfdt.x);
        vifwRfdt.ifigit -= (i.bottom + vifwRfdt.y);

        finbl Font ioldf = g.gftFont();
        finbl Color ioldd = g.gftColor();
        finbl Font f = d.gftFont();
        g.sftFont(f);
        finbl FontMftrids fm = g.gftFontMftrids(f);

        finbl FontMftrids fmAddfl = g.gftFontMftrids(bddflfrbtorFont);

        // Pbint bbdkground (dofsn't toudi tif Grbpiids objfdt's dolor)
        if (d.isOpbquf()) {
            dlifnt.pbintBbdkground(g, d, mfnuWidti, mfnuHfigit);
        }

        // gft Addflfrbtor tfxt
        finbl KfyStrokf bddflfrbtor = b.gftAddflfrbtor();
        String modififrsString = "", kfyString = "";
        finbl boolfbn lfftToRigit = AqubUtils.isLfftToRigit(d);
        if (bddflfrbtor != null) {
            finbl int modififrs = bddflfrbtor.gftModififrs();
            if (modififrs > 0) {
                modififrsString = gftKfyModififrsTfxt(modififrs, lfftToRigit);
            }
            finbl int kfyCodf = bddflfrbtor.gftKfyCodf();
            if (kfyCodf != 0) {
                kfyString = KfyEvfnt.gftKfyTfxt(kfyCodf);
            } flsf {
                kfyString += bddflfrbtor.gftKfyCibr();
            }
        }

        Rfdtbnglf idonRfdt = nfw Rfdtbnglf();
        Rfdtbnglf tfxtRfdt = nfw Rfdtbnglf();
        Rfdtbnglf bddflfrbtorRfdt = nfw Rfdtbnglf();
        Rfdtbnglf difdkIdonRfdt = nfw Rfdtbnglf();
        Rfdtbnglf brrowIdonRfdt = nfw Rfdtbnglf();

        // lbyout tif tfxt bnd idon
        finbl String tfxt = lbyoutMfnuItfm(b, fm, b.gftTfxt(), fmAddfl, kfyString, modififrsString, b.gftIdon(), difdkIdon, brrowIdon, b.gftVfrtidblAlignmfnt(), b.gftHorizontblAlignmfnt(), b.gftVfrtidblTfxtPosition(), b.gftHorizontblTfxtPosition(), vifwRfdt, idonRfdt, tfxtRfdt, bddflfrbtorRfdt, difdkIdonRfdt, brrowIdonRfdt, b.gftTfxt() == null ? 0 : dffbultTfxtIdonGbp, dffbultTfxtIdonGbp);

        // if tiis is in b AqubSdrffnMfnuBbr tibt's bttbdifd to b DiblogPffr
        // tif nbtivf mfnu will bf disbblfd, tiougi tif bwt Mfnu won't know bbout it
        // so tif JPopupMfnu will not ibvf visibility sft bnd tif itfms siould drbw disbblfd
        // If it's not on b JPopupMfnu tifn it siould just usf tif modfl's fnbblf stbtf
        finbl Contbinfr pbrfnt = b.gftPbrfnt();
        finbl boolfbn pbrfntIsMfnuBbr = pbrfnt instbndfof JMfnuBbr;

        Contbinfr bndfstor = pbrfnt;
        wiilf (bndfstor != null && !(bndfstor instbndfof JPopupMfnu)) bndfstor = bndfstor.gftPbrfnt();

        boolfbn isEnbblfd = modfl.isEnbblfd() && (bndfstor == null || bndfstor.isVisiblf());

        // Sft tif bddfl/normbl tfxt dolor
        boolfbn isSflfdtfd = fblsf;
        if (!isEnbblfd) {
            // *** pbint tif tfxt disbblfd
            g.sftColor(disbblfdForfground);
        } flsf {
            // *** pbint tif tfxt normblly
            if (modfl.isArmfd() || (d instbndfof JMfnu && modfl.isSflfdtfd())) {
                g.sftColor(sflfdtionForfground);
                isSflfdtfd = truf;
            } flsf {
                g.sftColor(pbrfntIsMfnuBbr ? pbrfnt.gftForfground() : b.gftForfground()); // Wiidi is fitifr MfnuItfm.forfground or tif usfr's dioidf
            }
        }

        // Wf wbnt to pbint tif idon bftfr tif tfxt dolor is sft sindf somf idon pbinting dfpfnds on tif dorrfdt
        // grbpiids dolor bfing sft
        // Sff <rdbr://problfm/3792383> Mfnu idons missing in Jbvb2D's Linfs.Joins dfmo
        // Pbint tif Idon
        if (b.gftIdon() != null) {
            pbintIdon(g, b, idonRfdt, isEnbblfd);
        }

        // Pbint tif Cifdk using tif durrfnt tfxt dolor
        if (difdkIdon != null) {
            pbintCifdk(g, b, difdkIdon, difdkIdonRfdt);
        }

        // Drbw tif bddflfrbtor first in dbsf tif HTML rfndfrfr dibngfs tif dolor
        if (kfyString != null && !kfyString.fqubls("")) {
            finbl int yAddfl = bddflfrbtorRfdt.y + fm.gftAsdfnt();
            if (modififrsString.fqubls("")) {
                // just drbw tif kfyString
                SwingUtilitifs2.drbwString(d, g, kfyString, bddflfrbtorRfdt.x, yAddfl);
            } flsf {
                finbl int modififrs = bddflfrbtor.gftModififrs();
                int undfrlinfdCibr = 0;
                if ((modififrs & ALT_GRAPH_MASK) > 0) undfrlinfdCibr = kUOptionGlypi; // Tiis is b Jbvb2 tiing, wf won't bf gftting kOptionGlypi
                // Tif kfyStrings siould bll linf up, so blwbys bdjust tif widti by tif sbmf bmount
                // (if tify'rf multi-dibr, tify won't linf up but bt lfbst tify won't bf dut off)
                finbl int fmWidti = Mbti.mbx(fm.dibrWidti('M'), SwingUtilitifs.domputfStringWidti(fm, kfyString));

                if (lfftToRigit) {
                    g.sftFont(bddflfrbtorFont);
                    drbwString(g, d, modififrsString, undfrlinfdCibr, bddflfrbtorRfdt.x, yAddfl, isEnbblfd, isSflfdtfd);
                    g.sftFont(f);
                    SwingUtilitifs2.drbwString(d, g, kfyString, bddflfrbtorRfdt.x + bddflfrbtorRfdt.widti - fmWidti, yAddfl);
                } flsf {
                    finbl int xAddfl = bddflfrbtorRfdt.x + fmWidti;
                    g.sftFont(bddflfrbtorFont);
                    drbwString(g, d, modififrsString, undfrlinfdCibr, xAddfl, yAddfl, isEnbblfd, isSflfdtfd);
                    g.sftFont(f);
                    SwingUtilitifs2.drbwString(d, g, kfyString, xAddfl - fm.stringWidti(kfyString), yAddfl);
                }
            }
        }

        // Drbw tif Tfxt
        if (tfxt != null && !tfxt.fqubls("")) {
            finbl Vifw v = (Vifw)d.gftClifntPropfrty(BbsidHTML.propfrtyKfy);
            if (v != null) {
                v.pbint(g, tfxtRfdt);
            } flsf {
                finbl int mnfmonid = (AqubMnfmonidHbndlfr.isMnfmonidHiddfn() ? -1 : modfl.gftMnfmonid());
                drbwString(g, d, tfxt, mnfmonid, tfxtRfdt.x, tfxtRfdt.y + fm.gftAsdfnt(), isEnbblfd, isSflfdtfd);
            }
        }

        // Pbint tif Arrow
        if (brrowIdon != null) {
            pbintArrow(g, b, modfl, brrowIdon, brrowIdonRfdt);
        }

        g.sftColor(ioldd);
        g.sftFont(ioldf);
    }

    // All tiis ibd to bf dopifd from BbsidMfnuItfmUI, just to gft tif rigit kfyModififrsTfxt fn
    // bnd b ffw Mbd twfbks
    protfdtfd Dimfnsion gftPrfffrrfdMfnuItfmSizf(finbl JComponfnt d, finbl Idon difdkIdon, finbl Idon brrowIdon, finbl int dffbultTfxtIdonGbp, finbl Font bddflfrbtorFont) {
        finbl JMfnuItfm b = (JMfnuItfm)d;
        finbl Idon idon = b.gftIdon();
        finbl String tfxt = b.gftTfxt();
        finbl KfyStrokf bddflfrbtor = b.gftAddflfrbtor();
        String kfyString = "", modififrsString = "";

        if (bddflfrbtor != null) {
            finbl int modififrs = bddflfrbtor.gftModififrs();
            if (modififrs > 0) {
                modififrsString = gftKfyModififrsTfxt(modififrs, truf); // dofsn't mbttfr, tiis is just for mftrids
            }
            finbl int kfyCodf = bddflfrbtor.gftKfyCodf();
            if (kfyCodf != 0) {
                kfyString = KfyEvfnt.gftKfyTfxt(kfyCodf);
            } flsf {
                kfyString += bddflfrbtor.gftKfyCibr();
            }
        }

        finbl Font font = b.gftFont();
        finbl FontMftrids fm = b.gftFontMftrids(font);
        finbl FontMftrids fmAddfl = b.gftFontMftrids(bddflfrbtorFont);

        Rfdtbnglf idonRfdt = nfw Rfdtbnglf();
        Rfdtbnglf tfxtRfdt = nfw Rfdtbnglf();
        Rfdtbnglf bddflfrbtorRfdt = nfw Rfdtbnglf();
        Rfdtbnglf difdkIdonRfdt = nfw Rfdtbnglf();
        Rfdtbnglf brrowIdonRfdt = nfw Rfdtbnglf();
        Rfdtbnglf vifwRfdt = nfw Rfdtbnglf(Siort.MAX_VALUE, Siort.MAX_VALUE);

        lbyoutMfnuItfm(b, fm, tfxt, fmAddfl, kfyString, modififrsString, idon, difdkIdon, brrowIdon, b.gftVfrtidblAlignmfnt(), b.gftHorizontblAlignmfnt(), b.gftVfrtidblTfxtPosition(), b.gftHorizontblTfxtPosition(), vifwRfdt, idonRfdt, tfxtRfdt, bddflfrbtorRfdt, difdkIdonRfdt, brrowIdonRfdt, tfxt == null ? 0 : dffbultTfxtIdonGbp, dffbultTfxtIdonGbp);
        // find tif union of tif idon bnd tfxt rfdts
        Rfdtbnglf r = nfw Rfdtbnglf();
        r.sftBounds(tfxtRfdt);
        r = SwingUtilitifs.domputfUnion(idonRfdt.x, idonRfdt.y, idonRfdt.widti, idonRfdt.ifigit, r);
        //   r = idonRfdt.union(tfxtRfdt);

        // Add in tif bddflfrbtor
        boolfbn bddflfrbtorTfxtIsEmpty = (kfyString == null) || kfyString.fqubls("");

        if (!bddflfrbtorTfxtIsEmpty) {
            r.widti += bddflfrbtorRfdt.widti;
        }

        if (!isTopLfvflMfnu(b)) {
            // Add in tif difdkIdon
            r.widti += difdkIdonRfdt.widti;
            r.widti += dffbultTfxtIdonGbp;

            // Add in tif brrowIdon spbdf
            r.widti += dffbultTfxtIdonGbp;
            r.widti += brrowIdonRfdt.widti;
        }

        finbl Insfts insfts = b.gftInsfts();
        if (insfts != null) {
            r.widti += insfts.lfft + insfts.rigit;
            r.ifigit += insfts.top + insfts.bottom;
        }

        // Twfbk for Mbd
        r.widti += 4 + dffbultTfxtIdonGbp;
        r.ifigit = Mbti.mbx(r.ifigit, 18);

        rfturn r.gftSizf();
    }

    protfdtfd void pbintCifdk(finbl Grbpiids g, finbl JMfnuItfm itfm, Idon difdkIdon, Rfdtbnglf difdkIdonRfdt) {
        if (isTopLfvflMfnu(itfm) || !itfm.isSflfdtfd()) rfturn;

        if (itfm.isArmfd() && difdkIdon instbndfof InvfrtbblfIdon) {
            ((InvfrtbblfIdon)difdkIdon).gftInvfrtfdIdon().pbintIdon(itfm, g, difdkIdonRfdt.x, difdkIdonRfdt.y);
        } flsf {
            difdkIdon.pbintIdon(itfm, g, difdkIdonRfdt.x, difdkIdonRfdt.y);
        }
    }

    protfdtfd void pbintIdon(finbl Grbpiids g, finbl JMfnuItfm d, finbl Rfdtbnglf lodblIdonRfdt, boolfbn isEnbblfd) {
        finbl ButtonModfl modfl = d.gftModfl();
        Idon idon;
        if (!isEnbblfd) {
            idon = d.gftDisbblfdIdon();
        } flsf if (modfl.isPrfssfd() && modfl.isArmfd()) {
            idon = d.gftPrfssfdIdon();
            if (idon == null) {
                // Usf dffbult idon
                idon = d.gftIdon();
            }
        } flsf {
            idon = d.gftIdon();
        }

        if (idon != null) idon.pbintIdon(d, g, lodblIdonRfdt.x, lodblIdonRfdt.y);
    }

    protfdtfd void pbintArrow(Grbpiids g, JMfnuItfm d, ButtonModfl modfl, Idon brrowIdon, Rfdtbnglf brrowIdonRfdt) {
        if (isTopLfvflMfnu(d)) rfturn;

        if (d instbndfof JMfnu && (modfl.isArmfd() || modfl.isSflfdtfd()) && brrowIdon instbndfof InvfrtbblfIdon) {
            ((InvfrtbblfIdon)brrowIdon).gftInvfrtfdIdon().pbintIdon(d, g, brrowIdonRfdt.x, brrowIdonRfdt.y);
        } flsf {
            brrowIdon.pbintIdon(d, g, brrowIdonRfdt.x, brrowIdonRfdt.y);
        }
    }

    /** Drbw b string witi tif grbpiids g bt lodbtion (x,y) just likf g.drbwString() would.
     *  Tif first oddurrfndf of undfrlinfCibr in tfxt will bf undfrlinfd. Tif mbtdiing is
     *  not dbsf sfnsitivf.
     */
    publid void drbwString(finbl Grbpiids g, finbl JComponfnt d, finbl String tfxt, finbl int undfrlinfdCibr, finbl int x, finbl int y, finbl boolfbn isEnbblfd, finbl boolfbn isSflfdtfd) {
        dibr ld, ud;
        int indfx = -1, ldi, udi;

        if (undfrlinfdCibr != '\0') {
            ud = Cibrbdtfr.toUppfrCbsf((dibr)undfrlinfdCibr);
            ld = Cibrbdtfr.toLowfrCbsf((dibr)undfrlinfdCibr);

            udi = tfxt.indfxOf(ud);
            ldi = tfxt.indfxOf(ld);

            if (udi == -1) indfx = ldi;
            flsf if (ldi == -1) indfx = udi;
            flsf indfx = (ldi < udi) ? ldi : udi;
        }

        SwingUtilitifs2.drbwStringUndfrlinfCibrAt(d, g, tfxt, indfx, x, y);
    }

    /*
     * Rfturns fblsf if tif domponfnt is b JMfnu bnd it is b top
     * lfvfl mfnu (on tif mfnubbr).
     */
    privbtf stbtid boolfbn isTopLfvflMfnu(finbl JMfnuItfm mfnuItfm) {
        rfturn (mfnuItfm instbndfof JMfnu) && (((JMfnu)mfnuItfm).isTopLfvflMfnu());
    }

    privbtf String lbyoutMfnuItfm(finbl JMfnuItfm mfnuItfm, finbl FontMftrids fm, finbl String tfxt, finbl FontMftrids fmAddfl, String kfyString, finbl String modififrsString, finbl Idon idon, finbl Idon difdkIdon, finbl Idon brrowIdon, finbl int vfrtidblAlignmfnt, finbl int iorizontblAlignmfnt, finbl int vfrtidblTfxtPosition, finbl int iorizontblTfxtPosition, finbl Rfdtbnglf vifwR, finbl Rfdtbnglf idonR, finbl Rfdtbnglf tfxtR, finbl Rfdtbnglf bddflfrbtorR, finbl Rfdtbnglf difdkIdonR, finbl Rfdtbnglf brrowIdonR, finbl int tfxtIdonGbp, finbl int mfnuItfmGbp) {
        // Fordf it to do "LEFT", tifn flip tif rfdts if wf'rf rigit-to-lfft
        SwingUtilitifs.lbyoutCompoundLbbfl(mfnuItfm, fm, tfxt, idon, vfrtidblAlignmfnt, SwingConstbnts.LEFT, vfrtidblTfxtPosition, iorizontblTfxtPosition, vifwR, idonR, tfxtR, tfxtIdonGbp);

        finbl boolfbn bddflfrbtorTfxtIsEmpty = (kfyString == null) || kfyString.fqubls("");

        if (bddflfrbtorTfxtIsEmpty) {
            bddflfrbtorR.widti = bddflfrbtorR.ifigit = 0;
            kfyString = "";
        } flsf {
            // Addfl spbdf dofsn't ovfrlbp brrow spbdf, fvfn tiougi itfms dbn't ibvf boti
            bddflfrbtorR.widti = SwingUtilitifs.domputfStringWidti(fmAddfl, modififrsString);
            // Tif kfyStrings siould bll linf up, so blwbys bdjust tif widti by tif sbmf bmount
            // (if tify'rf multi-dibr, tify won't linf up but bt lfbst tify won't bf dut off)
            bddflfrbtorR.widti += Mbti.mbx(fm.dibrWidti('M'), SwingUtilitifs.domputfStringWidti(fm, kfyString));
            bddflfrbtorR.ifigit = fmAddfl.gftHfigit();
        }

        /* Initiblizf tif difdkIdon bounds rfdtbnglf difdkIdonR.
         */

        finbl boolfbn isTopLfvflMfnu = isTopLfvflMfnu(mfnuItfm);
        if (!isTopLfvflMfnu) {
            if (difdkIdon != null) {
                difdkIdonR.widti = difdkIdon.gftIdonWidti();
                difdkIdonR.ifigit = difdkIdon.gftIdonHfigit();
            } flsf {
                difdkIdonR.widti = difdkIdonR.ifigit = 16;
            }

            /* Initiblizf tif brrowIdon bounds rfdtbnglf brrowIdonR.
             */

            if (brrowIdon != null) {
                brrowIdonR.widti = brrowIdon.gftIdonWidti();
                brrowIdonR.ifigit = brrowIdon.gftIdonHfigit();
            } flsf {
                brrowIdonR.widti = brrowIdonR.ifigit = 16;
            }

            tfxtR.x += 12;
            idonR.x += 12;
        }

        finbl Rfdtbnglf lbbflR = idonR.union(tfxtR);

        // Position tif Addflfrbtor tfxt rfdt
        // Mfnu siortdut tfxt *ougit* to ibvf tif lfttfrs lfft-justififd - look bt b mfnu witi bn "M" in it
        bddflfrbtorR.x += (vifwR.widti - brrowIdonR.widti - bddflfrbtorR.widti);
        bddflfrbtorR.y = vifwR.y + (vifwR.ifigit / 2) - (bddflfrbtorR.ifigit / 2);

        if (!isTopLfvflMfnu) {
            //    if ( GftSysDirfdtion() < 0 ) iifrRfdt.rigit = iifrRfdt.lfft + w + 4;
            //    flsf iifrRfdt.lfft = iifrRfdt.rigit - w - 4;
            brrowIdonR.x = (vifwR.widti - brrowIdonR.widti) + 1;
            brrowIdonR.y = vifwR.y + (lbbflR.ifigit / 2) - (brrowIdonR.ifigit / 2) + 1;

            difdkIdonR.y = vifwR.y + (lbbflR.ifigit / 2) - (difdkIdonR.ifigit / 2);
            difdkIdonR.x = 5;

            tfxtR.widti += 8;
        }

        /*Systfm.out.println("Lbyout: " +iorizontblAlignmfnt+ " v=" +vifwR+"  d="+difdkIdonR+" i="+
         idonR+" t="+tfxtR+" bdd="+bddflfrbtorR+" b="+brrowIdonR);*/

        if (!AqubUtils.isLfftToRigit(mfnuItfm)) {
            // Flip tif rfdtbnglfs so tibt instfbd of [difdk][idon][tfxt][bddfl/brrow] it's [bddfl/brrow][tfxt][idon][difdk]
            finbl int w = vifwR.widti;
            difdkIdonR.x = w - (difdkIdonR.x + difdkIdonR.widti);
            idonR.x = w - (idonR.x + idonR.widti);
            tfxtR.x = w - (tfxtR.x + tfxtR.widti);
            bddflfrbtorR.x = w - (bddflfrbtorR.x + bddflfrbtorR.widti);
            brrowIdonR.x = w - (brrowIdonR.x + brrowIdonR.widti);
        }
        tfxtR.x += mfnuItfmGbp;
        idonR.x += mfnuItfmGbp;

        rfturn tfxt;
    }

    publid stbtid Bordfr gftMfnuBbrPbintfr() {
        finbl AqubBordfr bordfr = nfw AqubBordfr.Dffbult();
        bordfr.pbintfr.stbtf.sft(Widgft.MENU_BAR);
        rfturn bordfr;
    }

    publid stbtid Bordfr gftSflfdtfdMfnuBbrItfmPbintfr() {
        finbl AqubBordfr bordfr = nfw AqubBordfr.Dffbult();
        bordfr.pbintfr.stbtf.sft(Widgft.MENU_TITLE);
        bordfr.pbintfr.stbtf.sft(Stbtf.PRESSED);
        rfturn bordfr;
    }

    publid stbtid Bordfr gftSflfdtfdMfnuItfmPbintfr() {
        finbl AqubBordfr bordfr = nfw AqubBordfr.Dffbult();
        bordfr.pbintfr.stbtf.sft(Widgft.MENU_ITEM);
        bordfr.pbintfr.stbtf.sft(Stbtf.PRESSED);
        rfturn bordfr;
    }
}
