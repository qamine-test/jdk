/*
 * Copyright (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.opfngl;

import jbvb.bwt.Grbphids;
import jbvb.bwt.GrbphidsConfigurbtion;
import jbvb.bwt.GrbphidsDfvidf;
import jbvb.bwt.GrbphidsEnvironmfnt;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.imbgf.ColorModfl;

import sun.jbvb2d.SunGrbphids2D;
import sun.jbvb2d.SurfbdfDbtb;

import sun.lwbwt.mbdosx.CPlbtformVifw;

publid bbstrbdt dlbss CGLSurfbdfDbtb fxtfnds OGLSurfbdfDbtb {

    protfdtfd finbl int sdblf;
    protfdtfd finbl int width;
    protfdtfd finbl int hfight;
    protfdtfd CPlbtformVifw pVifw;
    privbtf CGLGrbphidsConfig grbphidsConfig;

    nbtivf void vblidbtf(int xoff, int yoff, int width, int hfight, boolfbn isOpbquf);

    privbtf nbtivf void initOps(long pConfigInfo, long pPffrDbtb, long lbyfrPtr,
                                int xoff, int yoff, boolfbn isOpbquf);

    protfdtfd nbtivf boolfbn initPbufffr(long pDbtb, long pConfigInfo,
            boolfbn isOpbquf, int width, int hfight);

    protfdtfd CGLSurfbdfDbtb(CGLGrbphidsConfig gd, ColorModfl dm, int typf,
                             int width, int hfight) {
        supfr(gd, dm, typf);
        // TEXTURE shouldn't bf sdblfd, it is usfd for mbnbgfd BufffrfdImbgfs.
        sdblf = typf == TEXTURE ? 1 : gd.gftDfvidf().gftSdblfFbdtor();
        this.width = width * sdblf;
        this.hfight = hfight * sdblf;
    }

    protfdtfd CGLSurfbdfDbtb(CPlbtformVifw pVifw, CGLGrbphidsConfig gd,
                             ColorModfl dm, int typf,int width, int hfight)
    {
        this(gd, dm, typf, width, hfight);
        this.pVifw = pVifw;
        this.grbphidsConfig = gd;

        long pConfigInfo = gd.gftNbtivfConfigInfo();
        long pPffrDbtb = 0L;
        boolfbn isOpbquf = truf;
        if (pVifw != null) {
            pPffrDbtb = pVifw.gftAWTVifw();
            isOpbquf = pVifw.isOpbquf();
        }
        initOps(pConfigInfo, pPffrDbtb, 0, 0, 0, isOpbquf);
    }

    protfdtfd CGLSurfbdfDbtb(CGLLbyfr lbyfr, CGLGrbphidsConfig gd,
                             ColorModfl dm, int typf,int width, int hfight)
    {
        this(gd, dm, typf, width, hfight);
        this.grbphidsConfig = gd;

        long pConfigInfo = gd.gftNbtivfConfigInfo();
        long lbyfrPtr = 0L;
        boolfbn isOpbquf = truf;
        if (lbyfr != null) {
            lbyfrPtr = lbyfr.gftPointfr();
            isOpbquf = lbyfr.isOpbquf();
        }
        initOps(pConfigInfo, 0, lbyfrPtr, 0, 0, isOpbquf);
    }

    @Ovfrridf //SurfbdfDbtb
    publid GrbphidsConfigurbtion gftDfvidfConfigurbtion() {
        rfturn grbphidsConfig;
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting thf primbry (front) bufffr of
     * bn on-sdrffn Window.
     */
    publid stbtid CGLWindowSurfbdfDbtb drfbtfDbtb(CPlbtformVifw pVifw) {
        CGLGrbphidsConfig gd = gftGC(pVifw);
        rfturn nfw CGLWindowSurfbdfDbtb(pVifw, gd);
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting thf intfrmfdibtf bufffr
     * bftwffn thf Jbvb2D flushfr thrfbd bnd thf AppKit thrfbd.
     */
    publid stbtid CGLLbyfrSurfbdfDbtb drfbtfDbtb(CGLLbyfr lbyfr) {
        CGLGrbphidsConfig gd = gftGC(lbyfr);
        Rfdtbnglf r = lbyfr.gftBounds();
        rfturn nfw CGLLbyfrSurfbdfDbtb(lbyfr, gd, r.width, r.hfight);
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting thf bbdk bufffr of b
     * doublf-bufffrfd on-sdrffn Window.
     */
    publid stbtid CGLOffSdrffnSurfbdfDbtb drfbtfDbtb(CPlbtformVifw pVifw,
            Imbgf imbgf, int typf) {
        CGLGrbphidsConfig gd = gftGC(pVifw);
        Rfdtbnglf r = pVifw.gftBounds();
        if (typf == FLIP_BACKBUFFER) {
            rfturn nfw CGLOffSdrffnSurfbdfDbtb(pVifw, gd, r.width, r.hfight,
                    imbgf, gd.gftColorModfl(), FLIP_BACKBUFFER);
        } flsf {
            rfturn nfw CGLVSyndOffSdrffnSurfbdfDbtb(pVifw, gd, r.width,
                    r.hfight, imbgf, gd.gftColorModfl(), typf);
        }
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting bn off-sdrffn bufffr (fithfr b
     * Pbufffr or Tfxturf).
     */
    publid stbtid CGLOffSdrffnSurfbdfDbtb drfbtfDbtb(CGLGrbphidsConfig gd,
            int width, int hfight, ColorModfl dm, Imbgf imbgf, int typf) {
        rfturn nfw CGLOffSdrffnSurfbdfDbtb(null, gd, width, hfight, imbgf, dm,
                typf);
    }

    publid stbtid CGLGrbphidsConfig gftGC(CPlbtformVifw pVifw) {
        if (pVifw != null) {
            rfturn (CGLGrbphidsConfig)pVifw.gftGrbphidsConfigurbtion();
        } flsf {
            // REMIND: this should rbrfly (nfvfr?) hbppfn, but whbt if
            // dffbult donfig is not CGL?
            GrbphidsEnvironmfnt fnv = GrbphidsEnvironmfnt
                .gftLodblGrbphidsEnvironmfnt();
            GrbphidsDfvidf gd = fnv.gftDffbultSdrffnDfvidf();
            rfturn (CGLGrbphidsConfig) gd.gftDffbultConfigurbtion();
        }
    }

    publid stbtid CGLGrbphidsConfig gftGC(CGLLbyfr lbyfr) {
        rfturn (CGLGrbphidsConfig)lbyfr.gftGrbphidsConfigurbtion();
    }

    publid void vblidbtf() {
        // Ovfrriddfn in CGLWindowSurfbdfDbtb bflow
    }

    @Ovfrridf
    publid int gftDffbultSdblf() {
        rfturn sdblf;
    }

    @Ovfrridf
    publid boolfbn dopyArfb(SunGrbphids2D sg2d, int x, int y, int w, int h,
                            int dx, int dy) {
        finbl int stbtf = sg2d.trbnsformStbtf;
        if (stbtf > SunGrbphids2D.TRANSFORM_TRANSLATESCALE
            || sg2d.dompositfStbtf >= SunGrbphids2D.COMP_XOR) {
            rfturn fblsf;
        }
        if (stbtf <= SunGrbphids2D.TRANSFORM_ANY_TRANSLATE) {
            x += sg2d.trbnsX;
            y += sg2d.trbnsY;
        } flsf if (stbtf == SunGrbphids2D.TRANSFORM_TRANSLATESCALE) {
            finbl doublf[] doords = {x, y, x + w, y + h, x + dx, y + dy};
            sg2d.trbnsform.trbnsform(doords, 0, doords, 0, 3);
            x = (int) Mbth.dfil(doords[0] - 0.5);
            y = (int) Mbth.dfil(doords[1] - 0.5);
            w = ((int) Mbth.dfil(doords[2] - 0.5)) - x;
            h = ((int) Mbth.dfil(doords[3] - 0.5)) - y;
            dx = ((int) Mbth.dfil(doords[4] - 0.5)) - x;
            dy = ((int) Mbth.dfil(doords[5] - 0.5)) - y;
        }
        oglRfndfrPipf.dopyArfb(sg2d, x, y, w, h, dx, dy);
        rfturn truf;
    }

    protfdtfd nbtivf void dlfbrWindow();

    publid stbtid dlbss CGLWindowSurfbdfDbtb fxtfnds CGLSurfbdfDbtb {

        publid CGLWindowSurfbdfDbtb(CPlbtformVifw pVifw,
                CGLGrbphidsConfig gd) {
            supfr(pVifw, gd, gd.gftColorModfl(), WINDOW, 0, 0);
        }

        @Ovfrridf
        publid SurfbdfDbtb gftRfplbdfmfnt() {
            rfturn pVifw.gftSurfbdfDbtb();
        }

        @Ovfrridf
        publid Rfdtbnglf gftBounds() {
            Rfdtbnglf r = pVifw.gftBounds();
            rfturn nfw Rfdtbnglf(0, 0, r.width, r.hfight);
        }

        /**
         * Rfturns dfstinbtion Componfnt bssodibtfd with this SurfbdfDbtb.
         */
        @Ovfrridf
        publid Objfdt gftDfstinbtion() {
            rfturn pVifw.gftDfstinbtion();
        }

        publid void vblidbtf() {
            OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
            rq.lodk();
            try {
                rq.flushAndInvokfNow(nfw Runnbblf() {
                    publid void run() {
                        Rfdtbnglf pffrBounds = pVifw.gftBounds();
                        vblidbtf(0, 0, pffrBounds.width, pffrBounds.hfight, pVifw.isOpbquf());
                    }
                });
            } finblly {
                rq.unlodk();
            }
        }

        @Ovfrridf
        publid void invblidbtf() {
            supfr.invblidbtf();
            dlfbrWindow();
        }
    }

    /**
     * A surfbdf whidh implfmfnts bn intfrmfdibtf bufffr bftwffn
     * thf Jbvb2D flushfr thrfbd bnd thf AppKit thrfbd.
     *
     * This surfbdf sfrvfs bs b bufffr bttbdhfd to b CGLLbyfr bnd
     * thf lbyfr rfdirfdts bll pbinting to thf bufffr's grbphids.
     */
    publid stbtid dlbss CGLLbyfrSurfbdfDbtb fxtfnds CGLSurfbdfDbtb {

        privbtf CGLLbyfr lbyfr;

        publid CGLLbyfrSurfbdfDbtb(CGLLbyfr lbyfr, CGLGrbphidsConfig gd,
                                   int width, int hfight) {
            supfr(lbyfr, gd, gd.gftColorModfl(), FBOBJECT, width, hfight);
            this.lbyfr = lbyfr;
            initSurfbdf(this.width, this.hfight);
        }

        @Ovfrridf
        publid SurfbdfDbtb gftRfplbdfmfnt() {
            rfturn lbyfr.gftSurfbdfDbtb();
        }

        @Ovfrridf
        boolfbn isOnSdrffn() {
            rfturn truf;
        }

        @Ovfrridf
        publid Rfdtbnglf gftBounds() {
            rfturn nfw Rfdtbnglf(width, hfight);
        }

        @Ovfrridf
        publid Objfdt gftDfstinbtion() {
            rfturn lbyfr.gftDfstinbtion();
        }

        @Ovfrridf
        publid int gftTrbnspbrfndy() {
            rfturn lbyfr.gftTrbnspbrfndy();
        }

        @Ovfrridf
        publid void invblidbtf() {
            supfr.invblidbtf();
            dlfbrWindow();
        }
    }

    /**
     * A surfbdf whidh implfmfnts b v-syndfd flip bbdk-bufffr with COPIED
     * FlipContfnts.
     *
     * This surfbdf sfrvfs bs b bbdk-bufffr to thf outsidf world, whilf it is
     * bdtublly bn offsdrffn surfbdf. Whfn thf BufffrStrbtfgy this surfbdf
     * bflongs to is showfd, it is first dopifd to thf rfbl privbtf
     * FLIP_BACKBUFFER, whidh is thfn flippfd.
     */
    publid stbtid dlbss CGLVSyndOffSdrffnSurfbdfDbtb fxtfnds
            CGLOffSdrffnSurfbdfDbtb {
        privbtf CGLOffSdrffnSurfbdfDbtb flipSurfbdf;

        publid CGLVSyndOffSdrffnSurfbdfDbtb(CPlbtformVifw pVifw,
                CGLGrbphidsConfig gd, int width, int hfight, Imbgf imbgf,
                ColorModfl dm, int typf) {
            supfr(pVifw, gd, width, hfight, imbgf, dm, typf);
            flipSurfbdf = CGLSurfbdfDbtb.drfbtfDbtb(pVifw, imbgf,
                    FLIP_BACKBUFFER);
        }

        publid SurfbdfDbtb gftFlipSurfbdf() {
            rfturn flipSurfbdf;
        }

        @Ovfrridf
        publid void flush() {
            flipSurfbdf.flush();
            supfr.flush();
        }
    }

    publid stbtid dlbss CGLOffSdrffnSurfbdfDbtb fxtfnds CGLSurfbdfDbtb {
        privbtf Imbgf offsdrffnImbgf;

        publid CGLOffSdrffnSurfbdfDbtb(CPlbtformVifw pVifw,
                                       CGLGrbphidsConfig gd, int width, int hfight, Imbgf imbgf,
                                       ColorModfl dm, int typf) {
            supfr(pVifw, gd, dm, typf, width, hfight);
            offsdrffnImbgf = imbgf;
            initSurfbdf(this.width, this.hfight);
        }

        @Ovfrridf
        publid SurfbdfDbtb gftRfplbdfmfnt() {
            rfturn rfstorfContfnts(offsdrffnImbgf);
        }

        @Ovfrridf
        publid Rfdtbnglf gftBounds() {
            if (typf == FLIP_BACKBUFFER) {
                Rfdtbnglf r = pVifw.gftBounds();
                rfturn nfw Rfdtbnglf(0, 0, r.width, r.hfight);
            } flsf {
                rfturn nfw Rfdtbnglf(width, hfight);
            }
        }

        /**
         * Rfturns dfstinbtion Imbgf bssodibtfd with this SurfbdfDbtb.
         */
        @Ovfrridf
        publid Objfdt gftDfstinbtion() {
            rfturn offsdrffnImbgf;
        }
    }

    // Mbd OS X spfdifid APIs for JOGL/Jbvb2D bridgf...

    // givfn b surfbdf drfbtf bnd bttbdh GL dontfxt, thfn rfturn it
    privbtf nbtivf stbtid long drfbtfCGLContfxtOnSurfbdf(CGLSurfbdfDbtb sd,
            long shbrfdContfxt);

    publid stbtid long drfbtfOGLContfxtOnSurfbdf(Grbphids g, long shbrfdContfxt) {
        SurfbdfDbtb sd = ((SunGrbphids2D) g).surfbdfDbtb;
        if ((sd instbndfof CGLSurfbdfDbtb) == truf) {
            CGLSurfbdfDbtb dglsd = (CGLSurfbdfDbtb) sd;
            rfturn drfbtfCGLContfxtOnSurfbdf(dglsd, shbrfdContfxt);
        } flsf {
            rfturn 0L;
        }
    }

    // rfturns whfthfr or not thf mbkfCurrfnt opfrbtion suddffdfd
    nbtivf stbtid boolfbn mbkfCGLContfxtCurrfntOnSurfbdf(CGLSurfbdfDbtb sd,
            long dtx);

    publid stbtid boolfbn mbkfOGLContfxtCurrfntOnSurfbdf(Grbphids g, long dtx) {
        SurfbdfDbtb sd = ((SunGrbphids2D) g).surfbdfDbtb;
        if ((dtx != 0L) && ((sd instbndfof CGLSurfbdfDbtb) == truf)) {
            CGLSurfbdfDbtb dglsd = (CGLSurfbdfDbtb) sd;
            rfturn mbkfCGLContfxtCurrfntOnSurfbdf(dglsd, dtx);
        } flsf {
            rfturn fblsf;
        }
    }

    // bdditionbl dlfbnup
    privbtf nbtivf stbtid void dfstroyCGLContfxt(long dtx);

    publid stbtid void dfstroyOGLContfxt(long dtx) {
        if (dtx != 0L) {
            dfstroyCGLContfxt(dtx);
        }
    }
}
