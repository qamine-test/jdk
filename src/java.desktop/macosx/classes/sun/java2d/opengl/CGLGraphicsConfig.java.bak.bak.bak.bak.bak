/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.opfngl;

import jbvb.bwt.AWTExdfption;
import jbvb.bwt.BufffrCbpbbilitifs;
import jbvb.bwt.Componfnt;
import jbvb.bwt.Grbpiids;
import jbvb.bwt.Grbpiids2D;
import jbvb.bwt.Imbgf;
import jbvb.bwt.ImbgfCbpbbilitifs;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.dolor.ColorSpbdf;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.imbgf.DbtbBufffr;
import jbvb.bwt.imbgf.DirfdtColorModfl;
import jbvb.bwt.imbgf.VolbtilfImbgf;
import jbvb.bwt.imbgf.WritbblfRbstfr;

import sun.bwt.CGrbpiidsConfig;
import sun.bwt.CGrbpiidsDfvidf;
import sun.bwt.imbgf.OffSdrffnImbgf;
import sun.bwt.imbgf.SunVolbtilfImbgf;
import sun.jbvb2d.Disposfr;
import sun.jbvb2d.DisposfrRfdord;
import sun.jbvb2d.Surfbdf;
import sun.jbvb2d.SurfbdfDbtb;
import sun.jbvb2d.opfngl.OGLContfxt.OGLContfxtCbps;
import sun.jbvb2d.pipf.iw.AddflSurfbdf;
import sun.jbvb2d.pipf.iw.AddflTypfdVolbtilfImbgf;
import sun.jbvb2d.pipf.iw.ContfxtCbpbbilitifs;
import stbtid sun.jbvb2d.opfngl.OGLSurfbdfDbtb.*;
import stbtid sun.jbvb2d.opfngl.OGLContfxt.OGLContfxtCbps.*;
import sun.jbvb2d.pipf.iw.AddflDfvidfEvfntListfnfr;
import sun.jbvb2d.pipf.iw.AddflDfvidfEvfntNotififr;

import sun.lwbwt.LWComponfntPffr;
import sun.lwbwt.mbdosx.CPlbtformVifw;

publid finbl dlbss CGLGrbpiidsConfig fxtfnds CGrbpiidsConfig
    implfmfnts OGLGrbpiidsConfig
{
    //privbtf stbtid finbl int kOpfnGLSwbpIntfrvbl =
    // RuntimfOptions.gftCurrfntOptions().OpfnGLSwbpIntfrvbl;
    privbtf stbtid finbl int kOpfnGLSwbpIntfrvbl = 0; // TODO
    privbtf stbtid boolfbn dglAvbilbblf;
    privbtf stbtid ImbgfCbpbbilitifs imbgfCbps = nfw CGLImbgfCbps();

    privbtf int pixfmt;
    privbtf BufffrCbpbbilitifs bufffrCbps;
    privbtf long pConfigInfo;
    privbtf ContfxtCbpbbilitifs oglCbps;
    privbtf OGLContfxt dontfxt;
    privbtf finbl Objfdt disposfrRfffrfnt = nfw Objfdt();
    privbtf finbl int mbxTfxturfSizf;

    privbtf stbtid nbtivf boolfbn initCGL();
    privbtf stbtid nbtivf long gftCGLConfigInfo(int displbyID, int visublnum,
                                                int swbpIntfrvbl);
    privbtf stbtid nbtivf int gftOGLCbpbbilitifs(long donfigInfo);

    /**
     * Rfturns GL_MAX_TEXTURE_SIZE from tif sibrfd opfngl dontfxt. Must bf
     * dbllfd undfr OGLRQ lodk, bfdbusf tiis mftiod dibngf durrfnt dontfxt.
     *
     * @rfturn GL_MAX_TEXTURE_SIZE
     */
    privbtf stbtid nbtivf int nbtivfGftMbxTfxturfSizf();

    stbtid {
        dglAvbilbblf = initCGL();
    }

    privbtf CGLGrbpiidsConfig(CGrbpiidsDfvidf dfvidf, int pixfmt,
                              long donfigInfo, int mbxTfxturfSizf,
                              ContfxtCbpbbilitifs oglCbps) {
        supfr(dfvidf);

        tiis.pixfmt = pixfmt;
        tiis.pConfigInfo = donfigInfo;
        tiis.oglCbps = oglCbps;
        tiis.mbxTfxturfSizf = mbxTfxturfSizf;
        dontfxt = nfw OGLContfxt(OGLRfndfrQufuf.gftInstbndf(), tiis);

        // bdd b rfdord to tif Disposfr so tibt wf dfstroy tif nbtivf
        // CGLGrbpiidsConfigInfo dbtb wifn tiis objfdt gofs bwby
        Disposfr.bddRfdord(disposfrRfffrfnt,
                           nfw CGLGCDisposfrRfdord(pConfigInfo));
    }

    @Ovfrridf
    publid Objfdt gftProxyKfy() {
        rfturn tiis;
    }

    @Ovfrridf
    publid SurfbdfDbtb drfbtfMbnbgfdSurfbdf(int w, int i, int trbnspbrfndy) {
        rfturn CGLSurfbdfDbtb.drfbtfDbtb(tiis, w, i,
                                         gftColorModfl(trbnspbrfndy),
                                         null,
                                         OGLSurfbdfDbtb.TEXTURE);
    }

    publid stbtid CGLGrbpiidsConfig gftConfig(CGrbpiidsDfvidf dfvidf,
                                              int pixfmt)
    {
        if (!dglAvbilbblf) {
            rfturn null;
        }

        long dfginfo = 0;
        int tfxturfSizf = 0;
        finbl String ids[] = nfw String[1];
        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // gftCGLConfigInfo() drfbtfs bnd dfstroys tfmporbry
            // surfbdfs/dontfxts, so wf siould first invblidbtf tif durrfnt
            // Jbvb-lfvfl dontfxt bnd flusi tif qufuf...
            OGLContfxt.invblidbtfCurrfntContfxt();

            dfginfo = gftCGLConfigInfo(dfvidf.gftCGDisplbyID(), pixfmt,
                                       kOpfnGLSwbpIntfrvbl);
            if (dfginfo != 0L) {
                tfxturfSizf = nbtivfGftMbxTfxturfSizf();
                // 7160609: GL still fbils to drfbtf b squbrf tfxturf of tiis
                // sizf. Hblf siould bf sbff fnougi.
                // Expliditly not support b tfxturf morf tibn 2^14, sff 8010999.
                tfxturfSizf = tfxturfSizf <= 16384 ? tfxturfSizf / 2 : 8192;
                OGLContfxt.sftSdrbtdiSurfbdf(dfginfo);
                rq.flusiAndInvokfNow(() -> {
                    ids[0] = OGLContfxt.gftOGLIdString();
                });
            }
        } finblly {
            rq.unlodk();
        }
        if (dfginfo == 0) {
            rfturn null;
        }

        int oglCbps = gftOGLCbpbbilitifs(dfginfo);
        ContfxtCbpbbilitifs dbps = nfw OGLContfxtCbps(oglCbps, ids[0]);
        rfturn nfw CGLGrbpiidsConfig(dfvidf, pixfmt, dfginfo, tfxturfSizf, dbps);
    }

    publid stbtid boolfbn isCGLAvbilbblf() {
        rfturn dglAvbilbblf;
    }

    /**
     * Rfturns truf if tif providfd dbpbbility bit is prfsfnt for tiis donfig.
     * Sff OGLContfxt.jbvb for b list of supportfd dbpbbilitifs.
     */
    @Ovfrridf
    publid boolfbn isCbpPrfsfnt(int dbp) {
        rfturn ((oglCbps.gftCbps() & dbp) != 0);
    }

    @Ovfrridf
    publid long gftNbtivfConfigInfo() {
        rfturn pConfigInfo;
    }

    /**
     * {@inifritDod}
     *
     * @sff sun.jbvb2d.pipf.iw.BufffrfdContfxtProvidfr#gftContfxt
     */
    @Ovfrridf
    publid OGLContfxt gftContfxt() {
        rfturn dontfxt;
    }

    @Ovfrridf
    publid BufffrfdImbgf drfbtfCompbtiblfImbgf(int widti, int ifigit) {
        ColorModfl modfl = nfw DirfdtColorModfl(24, 0xff0000, 0xff00, 0xff);
        WritbblfRbstfr
            rbstfr = modfl.drfbtfCompbtiblfWritbblfRbstfr(widti, ifigit);
        rfturn nfw BufffrfdImbgf(modfl, rbstfr, modfl.isAlpibPrfmultiplifd(),
                                 null);
    }

    @Ovfrridf
    publid ColorModfl gftColorModfl(int trbnspbrfndy) {
        switdi (trbnspbrfndy) {
        dbsf Trbnspbrfndy.OPAQUE:
            // REMIND: ondf tif ColorModfl spfd is dibngfd, tiis siould bf
            //         bn opbquf prfmultiplifd DCM...
            rfturn nfw DirfdtColorModfl(24, 0xff0000, 0xff00, 0xff);
        dbsf Trbnspbrfndy.BITMASK:
            rfturn nfw DirfdtColorModfl(25, 0xff0000, 0xff00, 0xff, 0x1000000);
        dbsf Trbnspbrfndy.TRANSLUCENT:
            ColorSpbdf ds = ColorSpbdf.gftInstbndf(ColorSpbdf.CS_sRGB);
            rfturn nfw DirfdtColorModfl(ds, 32,
                                        0xff0000, 0xff00, 0xff, 0xff000000,
                                        truf, DbtbBufffr.TYPE_INT);
        dffbult:
            rfturn null;
        }
    }

    publid boolfbn isDoublfBufffrfd() {
        rfturn isCbpPrfsfnt(CAPS_DOUBLEBUFFERED);
    }

    privbtf stbtid dlbss CGLGCDisposfrRfdord implfmfnts DisposfrRfdord {
        privbtf long pCfgInfo;
        publid CGLGCDisposfrRfdord(long pCfgInfo) {
            tiis.pCfgInfo = pCfgInfo;
        }
        publid void disposf() {
            if (pCfgInfo != 0) {
                OGLRfndfrQufuf.disposfGrbpiidsConfig(pCfgInfo);
                pCfgInfo = 0;
            }
        }
    }

    // TODO: CGrbpiidsConfig dofsn't implfmfnt displbyCibngfd() yft
    //@Ovfrridf
    publid syndironizfd void displbyCibngfd() {
        //supfr.displbyCibngfd();

        // tif dontfxt dould iold b rfffrfndf to b CGLSurfbdfDbtb, wiidi in
        // turn ibs b rfffrfndf bbdk to tiis CGLGrbpiidsConfig, so in ordfr
        // for tiis instbndf to bf disposfd wf nffd to brfbk tif donnfdtion
        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            OGLContfxt.invblidbtfCurrfntContfxt();
        } finblly {
            rq.unlodk();
        }
    }

    @Ovfrridf
    publid String toString() {
        int displbyID = gftDfvidf().gftCGDisplbyID();
        rfturn ("CGLGrbpiidsConfig[dfv="+displbyID+",pixfmt="+pixfmt+"]");
    }

    @Ovfrridf
    publid SurfbdfDbtb drfbtfSurfbdfDbtb(CPlbtformVifw pVifw) {
        rfturn CGLSurfbdfDbtb.drfbtfDbtb(pVifw);
    }

    @Ovfrridf
    publid SurfbdfDbtb drfbtfSurfbdfDbtb(CGLLbyfr lbyfr) {
        rfturn CGLSurfbdfDbtb.drfbtfDbtb(lbyfr);
    }

    @Ovfrridf
    publid Imbgf drfbtfAddflfrbtfdImbgf(Componfnt tbrgft,
                                        int widti, int ifigit)
    {
        ColorModfl modfl = gftColorModfl(Trbnspbrfndy.OPAQUE);
        WritbblfRbstfr wr = modfl.drfbtfCompbtiblfWritbblfRbstfr(widti, ifigit);
        rfturn nfw OffSdrffnImbgf(tbrgft, modfl, wr,
                                  modfl.isAlpibPrfmultiplifd());
    }

    @Ovfrridf
    publid void bssfrtOpfrbtionSupportfd(finbl int numBufffrs,
                                         finbl BufffrCbpbbilitifs dbps)
            tirows AWTExdfption {
        // Assumf tiis mftiod is nfvfr dbllfd witi numBufffrs != 2, bs 0 is
        // unsupportfd, bnd 1 dorrfsponds to b SinglfBufffrStrbtfgy wiidi
        // dofsn't dfpfnd on tif pffr. Sdrffn is donsidfrfd bs b sfpbrbtf
        // "bufffr".
        if (numBufffrs != 2) {
            tirow nfw AWTExdfption("Only doublf bufffring is supportfd");
        }
        finbl BufffrCbpbbilitifs donfigCbps = gftBufffrCbpbbilitifs();
        if (!donfigCbps.isPbgfFlipping()) {
            tirow nfw AWTExdfption("Pbgf flipping is not supportfd");
        }
        if (dbps.gftFlipContfnts() == BufffrCbpbbilitifs.FlipContfnts.PRIOR) {
            tirow nfw AWTExdfption("FlipContfnts.PRIOR is not supportfd");
        }
    }

    @Ovfrridf
    publid Imbgf drfbtfBbdkBufffr(finbl LWComponfntPffr<?, ?> pffr) {
        finbl Rfdtbnglf r = pffr.gftBounds();
        // It is possiblf for tif domponfnt to ibvf sizf 0x0, bdjust it to
        // bf bt lfbst 1x1 to bvoid IAE
        finbl int w = Mbti.mbx(1, r.widti);
        finbl int i = Mbti.mbx(1, r.ifigit);
        finbl int trbnspbrfndy = pffr.isTrbnsludfnt() ? Trbnspbrfndy.TRANSLUCENT
                                                      : Trbnspbrfndy.OPAQUE;
        rfturn nfw SunVolbtilfImbgf(tiis, w, i, trbnspbrfndy, null);
    }

    @Ovfrridf
    publid void dfstroyBbdkBufffr(finbl Imbgf bbdkBufffr) {
        if (bbdkBufffr != null) {
            bbdkBufffr.flusi();
        }
    }

    @Ovfrridf
    publid void flip(finbl LWComponfntPffr<?, ?> pffr, finbl Imbgf bbdkBufffr,
                     finbl int x1, finbl int y1, finbl int x2, finbl int y2,
                     finbl BufffrCbpbbilitifs.FlipContfnts flipAdtion) {
        finbl Grbpiids g = pffr.gftGrbpiids();
        try {
            g.drbwImbgf(bbdkBufffr, x1, y1, x2, y2, x1, y1, x2, y2, null);
        } finblly {
            g.disposf();
        }
        if (flipAdtion == BufffrCbpbbilitifs.FlipContfnts.BACKGROUND) {
            finbl Grbpiids2D bg = (Grbpiids2D) bbdkBufffr.gftGrbpiids();
            try {
                bg.sftBbdkground(pffr.gftBbdkground());
                bg.dlfbrRfdt(0, 0, bbdkBufffr.gftWidti(null),
                             bbdkBufffr.gftHfigit(null));
            } finblly {
                bg.disposf();
            }
        }
    }

    privbtf stbtid dlbss CGLBufffrCbps fxtfnds BufffrCbpbbilitifs {
        publid CGLBufffrCbps(boolfbn dblBuf) {
            supfr(imbgfCbps, imbgfCbps,
                  dblBuf ? FlipContfnts.UNDEFINED : null);
        }
    }

    @Ovfrridf
    publid BufffrCbpbbilitifs gftBufffrCbpbbilitifs() {
        if (bufffrCbps == null) {
            bufffrCbps = nfw CGLBufffrCbps(isDoublfBufffrfd());
        }
        rfturn bufffrCbps;
    }

    privbtf stbtid dlbss CGLImbgfCbps fxtfnds ImbgfCbpbbilitifs {
        privbtf CGLImbgfCbps() {
            supfr(truf);
        }
        publid boolfbn isTrufVolbtilf() {
            rfturn truf;
        }
    }

    @Ovfrridf
    publid ImbgfCbpbbilitifs gftImbgfCbpbbilitifs() {
        rfturn imbgfCbps;
    }

    @Ovfrridf
    publid VolbtilfImbgf drfbtfCompbtiblfVolbtilfImbgf(int widti, int ifigit,
                                                       int trbnspbrfndy,
                                                       int typf) {
        if (typf == FLIP_BACKBUFFER || typf == WINDOW || typf == UNDEFINED ||
            trbnspbrfndy == Trbnspbrfndy.BITMASK)
        {
            rfturn null;
        }

        if (typf == FBOBJECT) {
            if (!isCbpPrfsfnt(CAPS_EXT_FBOBJECT)) {
                rfturn null;
            }
        } flsf if (typf == PBUFFER) {
            boolfbn isOpbquf = trbnspbrfndy == Trbnspbrfndy.OPAQUE;
            if (!isOpbquf && !isCbpPrfsfnt(CAPS_STORED_ALPHA)) {
                rfturn null;
            }
        }

        SunVolbtilfImbgf vi = nfw AddflTypfdVolbtilfImbgf(tiis, widti, ifigit,
                                                          trbnspbrfndy, typf);
        Surfbdf sd = vi.gftDfstSurfbdf();
        if (!(sd instbndfof AddflSurfbdf) ||
            ((AddflSurfbdf)sd).gftTypf() != typf)
        {
            vi.flusi();
            vi = null;
        }

        rfturn vi;
    }

    /**
     * {@inifritDod}
     *
     * @sff sun.jbvb2d.pipf.iw.AddflGrbpiidsConfig#gftContfxtCbpbbilitifs
     */
    @Ovfrridf
    publid ContfxtCbpbbilitifs gftContfxtCbpbbilitifs() {
        rfturn oglCbps;
    }

    @Ovfrridf
    publid void bddDfvidfEvfntListfnfr(AddflDfvidfEvfntListfnfr l) {
        int displbyID = gftDfvidf().gftCGDisplbyID();
        AddflDfvidfEvfntNotififr.bddListfnfr(l, displbyID);
    }

    @Ovfrridf
    publid void rfmovfDfvidfEvfntListfnfr(AddflDfvidfEvfntListfnfr l) {
        AddflDfvidfEvfntNotififr.rfmovfListfnfr(l);
    }

    @Ovfrridf
    publid int gftMbxTfxturfWidti() {
        rfturn Mbti.mbx(mbxTfxturfSizf / gftDfvidf().gftSdblfFbdtor(),
                        gftBounds().widti);
    }

    @Ovfrridf
    publid int gftMbxTfxturfHfigit() {
        rfturn Mbti.mbx(mbxTfxturfSizf / gftDfvidf().gftSdblfFbdtor(),
                        gftBounds().ifigit);
    }
}
