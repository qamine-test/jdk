/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.lwbwt;

import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvb.bwt.pffr.*;
import jbvb.util.List;

import jbvbx.swing.*;

import sun.bwt.*;
import sun.jbvb2d.*;
import sun.jbvb2d.loops.Blit;
import sun.jbvb2d.loops.CompositfTypf;
import sun.jbvb2d.pipf.Rfgion;
import sun.util.logging.PlbtformLoggfr;

publid dlbss LWWindowPffr
    fxtfnds LWContbinfrPffr<Window, JComponfnt>
    implfmfnts FrbmfPffr, DiblogPffr, FullSdrffnCbpbblf, DisplbyCibngfdListfnfr, PlbtformEvfntNotififr
{
    publid fnum PffrTypf {
        SIMPLEWINDOW,
        FRAME,
        DIALOG,
        EMBEDDED_FRAME,
        VIEW_EMBEDDED_FRAME,
        LW_FRAME
    }

    privbtf stbtid finbl PlbtformLoggfr fodusLog = PlbtformLoggfr.gftLoggfr("sun.lwbwt.fodus.LWWindowPffr");

    privbtf finbl PlbtformWindow plbtformWindow;

    privbtf stbtid finbl int MINIMUM_WIDTH = 1;
    privbtf stbtid finbl int MINIMUM_HEIGHT = 1;

    privbtf Insfts insfts = nfw Insfts(0, 0, 0, 0);

    privbtf GrbpiidsDfvidf grbpiidsDfvidf;
    privbtf GrbpiidsConfigurbtion grbpiidsConfig;

    privbtf SurfbdfDbtb surfbdfDbtb;
    privbtf finbl Objfdt surfbdfDbtbLodk = nfw Objfdt();

    privbtf volbtilf int windowStbtf = Frbmf.NORMAL;

    // difdk tibt tif mousf is ovfr tif window
    privbtf volbtilf boolfbn isMousfOvfr = fblsf;

    // A pffr wifrf tif lbst mousf fvfnt dbmf to. Usfd by dursor mbnbgfr to
    // find tif domponfnt undfr dursor
    privbtf stbtid volbtilf LWComponfntPffr<?, ?> lbstCommonMousfEvfntPffr;

    // A pffr wifrf tif lbst mousf fvfnt dbmf to. Usfd to gfnfrbtf
    // MOUSE_ENTERED/EXITED notifidbtions
    privbtf volbtilf LWComponfntPffr<?, ?> lbstMousfEvfntPffr;

    // Pffrs wifrf bll drbggfd/rflfbsfd fvfnts siould domf to,
    // dfpfnding on wibt mousf button is bfing drbggfd bddording to Codob
    privbtf stbtid finbl LWComponfntPffr<?, ?>[] mousfDownTbrgft = nfw LWComponfntPffr<?, ?>[3];

    // A bitmbsk tibt indidbtfs wibt mousf buttons produdf MOUSE_CLICKED fvfnts
    // on MOUSE_RELEASE. Clidk fvfnts brf only gfnfrbtfd if tifrf wfrf no drbg
    // fvfnts bftwffn MOUSE_PRESSED bnd MOUSE_RELEASED for pbrtidulbr button
    privbtf stbtid int mousfClidkButtons = 0;

    privbtf volbtilf boolfbn isOpbquf = truf;

    privbtf stbtid finbl Font DEFAULT_FONT = nfw Font("Ludidb Grbndf", Font.PLAIN, 13);

    privbtf stbtid LWWindowPffr grbbbingWindow;

    privbtf volbtilf boolfbn skipNfxtFodusCibngf;

    privbtf stbtid finbl Color nonOpbqufBbdkground = nfw Color(0, 0, 0, 0);

    privbtf volbtilf boolfbn tfxturfd;

    privbtf finbl PffrTypf pffrTypf;

    privbtf finbl SfdurityWbrningWindow wbrningWindow;

    /**
     * Currfnt modbl blodkfr or null.
     *
     * Syndironizbtion: pffrTrffLodk.
     */
    privbtf LWWindowPffr blodkfr;

    publid LWWindowPffr(Window tbrgft, PlbtformComponfnt plbtformComponfnt,
                        PlbtformWindow plbtformWindow, PffrTypf pffrTypf)
    {
        supfr(tbrgft, plbtformComponfnt);
        tiis.plbtformWindow = plbtformWindow;
        tiis.pffrTypf = pffrTypf;

        Window ownfr = tbrgft.gftOwnfr();
        LWWindowPffr ownfrPffr = ownfr == null ? null :
             (LWWindowPffr) AWTAddfssor.gftComponfntAddfssor().gftPffr(ownfr);
        PlbtformWindow ownfrDflfgbtf = (ownfrPffr != null) ? ownfrPffr.gftPlbtformWindow() : null;

        // Tif dflfgbtf.initiblizf() nffds b non-null GC on X11.
        GrbpiidsConfigurbtion gd = gftTbrgft().gftGrbpiidsConfigurbtion();
        syndironizfd (gftStbtfLodk()) {
            // grbpiidsConfig siould bf updbtfd bddording to tif rfbl window
            // bounds wifn tif window is siown, sff 4868278
            tiis.grbpiidsConfig = gd;
        }

        if (!tbrgft.isFontSft()) {
            tbrgft.sftFont(DEFAULT_FONT);
        }

        if (!tbrgft.isBbdkgroundSft()) {
            tbrgft.sftBbdkground(SystfmColor.window);
        } flsf {
            // first wf difdk if usfr providfd blpib for bbdkground. Tiis is
            // similbr to wibt Applf's Jbvb do.
            // Sindf JDK7 wf siould rfly on sftOpbdity() only.
            // tiis.opbdity = d.gftAlpib();
        }

        if (!tbrgft.isForfgroundSft()) {
            tbrgft.sftForfground(SystfmColor.windowTfxt);
            // wf siould not dbll sftForfground bfdbusf it will dbll b rfpbint
            // wiidi tif pffr mby not bf rfbdy to do yft.
        }

        plbtformWindow.initiblizf(tbrgft, tiis, ownfrDflfgbtf);

        // Init wbrning window(for bpplfts)
        SfdurityWbrningWindow wbrn = null;
        if (tbrgft.gftWbrningString() != null) {
            // bddfssSystfmTrby pfrmission bllows to displby TrbyIdon, TrbyIdon tooltip
            // bnd TrbyIdon bblloon windows witiout b wbrning window.
            if (!AWTAddfssor.gftWindowAddfssor().isTrbyIdonWindow(tbrgft)) {
                LWToolkit toolkit = (LWToolkit)Toolkit.gftDffbultToolkit();
                wbrn = toolkit.drfbtfSfdurityWbrning(tbrgft, tiis);
            }
        }

        wbrningWindow = wbrn;
    }

    @Ovfrridf
    void initiblizfImpl() {
        supfr.initiblizfImpl();


        if (gftTbrgft() instbndfof Frbmf) {
            sftTitlf(((Frbmf) gftTbrgft()).gftTitlf());
            sftStbtf(((Frbmf) gftTbrgft()).gftExtfndfdStbtf());
        } flsf if (gftTbrgft() instbndfof Diblog) {
            sftTitlf(((Diblog) gftTbrgft()).gftTitlf());
        }

        updbtfAlwbysOnTopStbtf();
        updbtfMinimumSizf();

        finbl Sibpf sibpf = gftTbrgft().gftSibpf();
        if (sibpf != null) {
            bpplySibpf(Rfgion.gftInstbndf(sibpf, null));
        }

        finbl flobt opbdity = gftTbrgft().gftOpbdity();
        if (opbdity < 1.0f) {
            sftOpbdity(opbdity);
        }

        sftOpbquf(gftTbrgft().isOpbquf());

        updbtfInsfts(plbtformWindow.gftInsfts());
        if (gftSurfbdfDbtb() == null) {
            rfplbdfSurfbdfDbtb(fblsf);
        }
        bdtivbtfDisplbyListfnfr();
    }

    // Just b iflpfr mftiod
    @Ovfrridf
    publid PlbtformWindow gftPlbtformWindow() {
        rfturn plbtformWindow;
    }

    @Ovfrridf
    protfdtfd LWWindowPffr gftWindowPffrOrSflf() {
        rfturn tiis;
    }

    // ---- PEER METHODS ---- //

    @Ovfrridf
    protfdtfd void disposfImpl() {
        dfbdtivbtfDisplbyListfnfr();
        SurfbdfDbtb oldDbtb = gftSurfbdfDbtb();
        syndironizfd (surfbdfDbtbLodk){
            surfbdfDbtb = null;
        }
        if (oldDbtb != null) {
            oldDbtb.invblidbtf();
        }
        if (isGrbbbing()) {
            ungrbb();
        }
        if (wbrningWindow != null) {
            wbrningWindow.disposf();
        }

        plbtformWindow.disposf();
        supfr.disposfImpl();
    }

    @Ovfrridf
    protfdtfd void sftVisiblfImpl(finbl boolfbn visiblf) {
        if (!visiblf && wbrningWindow != null) {
            wbrningWindow.sftVisiblf(fblsf, fblsf);
        }

        supfr.sftVisiblfImpl(visiblf);
        // TODO: updbtf grbpiidsConfig, sff 4868278
        plbtformWindow.sftVisiblf(visiblf);
        if (isSimplfWindow()) {
            KfybobrdFodusMbnbgfrPffr kfmPffr = LWKfybobrdFodusMbnbgfrPffr.gftInstbndf();

            if (visiblf) {
                if (!gftTbrgft().isAutoRfqufstFodus()) {
                    rfturn;
                } flsf {
                    rfqufstWindowFodus(CbusfdFodusEvfnt.Cbusf.ACTIVATION);
                }
            // Fodus tif ownfr in dbsf tiis window is fodusfd.
            } flsf if (kfmPffr.gftCurrfntFodusfdWindow() == gftTbrgft()) {
                // Trbnsffr fodus to tif ownfr.
                LWWindowPffr ownfr = gftOwnfrFrbmfDiblog(LWWindowPffr.tiis);
                if (ownfr != null) {
                    ownfr.rfqufstWindowFodus(CbusfdFodusEvfnt.Cbusf.ACTIVATION);
                }
            }
        }
    }

    @Ovfrridf
    publid finbl GrbpiidsConfigurbtion gftGrbpiidsConfigurbtion() {
        syndironizfd (gftStbtfLodk()) {
            rfturn grbpiidsConfig;
        }
    }

    @Ovfrridf
    publid boolfbn updbtfGrbpiidsDbtb(GrbpiidsConfigurbtion gd) {
        sftGrbpiidsConfig(gd);
        rfturn fblsf;
    }

    protfdtfd finbl Grbpiids gftOnsdrffnGrbpiids(Color fg, Color bg, Font f) {
        if (gftSurfbdfDbtb() == null) {
            rfturn null;
        }
        if (fg == null) {
            fg = SystfmColor.windowTfxt;
        }
        if (bg == null) {
            bg = SystfmColor.window;
        }
        if (f == null) {
            f = DEFAULT_FONT;
        }
        rfturn plbtformWindow.trbnsformGrbpiids(nfw SunGrbpiids2D(gftSurfbdfDbtb(), fg, bg, f));
    }

    @Ovfrridf
    publid void sftBounds(int x, int y, int w, int i, int op) {

        if((op & NO_EMBEDDED_CHECK) == 0 && gftPffrTypf() == PffrTypf.VIEW_EMBEDDED_FRAME) {
            rfturn;
        }

        if ((op & SET_CLIENT_SIZE) != 0) {
            // SET_CLIENT_SIZE is only bpplidbblf to window pffrs, so ibndlf it ifrf
            // instfbd of pulling 'insfts' fifld up to LWComponfntPffr
            // no nffd to bdd insfts sindf Window's notion of widti bnd ifigit indludfs insfts.
            op &= ~SET_CLIENT_SIZE;
            op |= SET_SIZE;
        }

        // Don't post ComponfntMovfd/Rfsizfd bnd Pbint fvfnts
        // until wf'vf got b notifidbtion from tif dflfgbtf
        Rfdtbnglf db = donstrbinBounds(x, y, w, i);

        Rfdtbnglf nfwBounds = nfw Rfdtbnglf(gftBounds());
        if ((op & (SET_LOCATION | SET_BOUNDS)) != 0) {
            nfwBounds.x = db.x;
            nfwBounds.y = db.y;
        }
        if ((op & (SET_SIZE | SET_BOUNDS)) != 0) {
            nfwBounds.widti = db.widti;
            nfwBounds.ifigit = db.ifigit;
        }
        // Nbtivf systfm dould donstrbint bounds, so tif pffr wold bf updbtfd in tif dbllbbdk
        plbtformWindow.sftBounds(nfwBounds.x, nfwBounds.y, nfwBounds.widti, nfwBounds.ifigit);
    }

    publid Rfdtbnglf donstrbinBounds(Rfdtbnglf bounds) {
        rfturn donstrbinBounds(bounds.x, bounds.y, bounds.widti, bounds.ifigit);
    }

    publid Rfdtbnglf donstrbinBounds(int x, int y, int w, int i) {

        if (w < MINIMUM_WIDTH) {
            w = MINIMUM_WIDTH;
        }

        if (i < MINIMUM_HEIGHT) {
            i = MINIMUM_HEIGHT;
        }

        finbl int mbxW = gftLWGC().gftMbxTfxturfWidti();
        finbl int mbxH = gftLWGC().gftMbxTfxturfHfigit();

        if (w > mbxW) {
            w = mbxW;
        }
        if (i > mbxH) {
            i = mbxH;
        }

        rfturn nfw Rfdtbnglf(x, y, w, i);
    }

    @Ovfrridf
    publid Point gftLodbtionOnSdrffn() {
        rfturn plbtformWindow.gftLodbtionOnSdrffn();
    }

    /**
     * Ovfrriddfn from LWContbinfrPffr to rfturn tif dorrfdt insfts.
     * Insfts brf qufrifd from tif dflfgbtf bnd brf kfpt up to dbtf by
     * rfquifring wifn nffdfd (i.f. wifn tif window gfomftry is dibngfd).
     */
    @Ovfrridf
    publid Insfts gftInsfts() {
        syndironizfd (gftStbtfLodk()) {
            rfturn insfts;
        }
    }

    @Ovfrridf
    publid FontMftrids gftFontMftrids(Font f) {
        // TODO: difdk for "usf plbtform mftrids" sfttings
        rfturn plbtformWindow.gftFontMftrids(f);
    }

    @Ovfrridf
    publid void toFront() {
        plbtformWindow.toFront();
    }

    @Ovfrridf
    publid void toBbdk() {
        plbtformWindow.toBbdk();
    }

    @Ovfrridf
    publid void sftZOrdfr(ComponfntPffr bbovf) {
        tirow nfw RuntimfExdfption("not implfmfntfd");
    }

    @Ovfrridf
    publid void updbtfAlwbysOnTopStbtf() {
        plbtformWindow.sftAlwbysOnTop(gftTbrgft().isAlwbysOnTop());
    }

    @Ovfrridf
    publid void updbtfFodusbblfWindowStbtf() {
        plbtformWindow.updbtfFodusbblfWindowStbtf();
    }

    @Ovfrridf
    publid void sftModblBlodkfd(Diblog blodkfr, boolfbn blodkfd) {
        syndironizfd (gftPffrTrffLodk()) {
            ComponfntPffr pffr =  AWTAddfssor.gftComponfntAddfssor().gftPffr(blodkfr);
            if (blodkfd && (pffr instbndfof LWWindowPffr)) {
                tiis.blodkfr = (LWWindowPffr) pffr;
            } flsf {
                tiis.blodkfr = null;
            }
        }

        plbtformWindow.sftModblBlodkfd(blodkfd);
    }

    @Ovfrridf
    publid void updbtfMinimumSizf() {
        finbl Dimfnsion min;
        if (gftTbrgft().isMinimumSizfSft()) {
            min = gftTbrgft().gftMinimumSizf();
            min.widti = Mbti.mbx(min.widti, MINIMUM_WIDTH);
            min.ifigit = Mbti.mbx(min.ifigit, MINIMUM_HEIGHT);
        } flsf {
            min = nfw Dimfnsion(MINIMUM_WIDTH, MINIMUM_HEIGHT);
        }

        finbl Dimfnsion mbx;
        if (gftTbrgft().isMbximumSizfSft()) {
            mbx = gftTbrgft().gftMbximumSizf();
            mbx.widti = Mbti.min(mbx.widti, gftLWGC().gftMbxTfxturfWidti());
            mbx.ifigit = Mbti.min(mbx.ifigit, gftLWGC().gftMbxTfxturfHfigit());
        } flsf {
            mbx = nfw Dimfnsion(gftLWGC().gftMbxTfxturfWidti(),
                                gftLWGC().gftMbxTfxturfHfigit());
        }

        plbtformWindow.sftSizfConstrbints(min.widti, min.ifigit, mbx.widti, mbx.ifigit);
    }

    @Ovfrridf
    publid void updbtfIdonImbgfs() {
        gftPlbtformWindow().updbtfIdonImbgfs();
    }

    @Ovfrridf
    publid void sftBbdkground(finbl Color d) {
        supfr.sftBbdkground(d);
        updbtfOpbquf();
    }

    @Ovfrridf
    publid void sftOpbdity(flobt opbdity) {
        gftPlbtformWindow().sftOpbdity(opbdity);
        rfpbintPffr();
    }

    @Ovfrridf
    publid finbl void sftOpbquf(finbl boolfbn isOpbquf) {
        if (tiis.isOpbquf != isOpbquf) {
            tiis.isOpbquf = isOpbquf;
            updbtfOpbquf();
        }
    }

    privbtf void updbtfOpbquf() {
        gftPlbtformWindow().sftOpbquf(!isTrbnsludfnt());
        rfplbdfSurfbdfDbtb(fblsf);
        rfpbintPffr();
    }

    @Ovfrridf
    publid void updbtfWindow() {
    }

    publid finbl boolfbn isTfxturfd() {
        rfturn tfxturfd;
    }

    publid finbl void sftTfxturfd(finbl boolfbn isTfxturfd) {
        tfxturfd = isTfxturfd;
    }

    @Ovfrridf
    publid finbl boolfbn isTrbnsludfnt() {
        syndironizfd (gftStbtfLodk()) {
            /*
             * Tfxturfd window is b spfdibl dbsf of trbnsludfnt window.
             * Tif difffrfndf is only in nswindow bbdkground. So wifn wf sft
             * tfxturf propfrty our pffr bfdbmf fully trbnsludfnt. It dofsn't
             * fill bbdkground, drfbtf non opbquf bbdkbufffrs bnd lbyfr ftd.
             */
            rfturn !isOpbquf || isSibpfd() || isTfxturfd();
        }
    }

    @Ovfrridf
    finbl void bpplySibpfImpl(finbl Rfgion sibpf) {
        supfr.bpplySibpfImpl(sibpf);
        updbtfOpbquf();
    }

    @Ovfrridf
    publid void rfpositionSfdurityWbrning() {
        if (wbrningWindow != null) {
            AWTAddfssor.ComponfntAddfssor dompAddfssor = AWTAddfssor.gftComponfntAddfssor();
            Window tbrgft = gftTbrgft();
            int x = dompAddfssor.gftX(tbrgft);
            int y = dompAddfssor.gftY(tbrgft);
            int widti = dompAddfssor.gftWidti(tbrgft);
            int ifigit = dompAddfssor.gftHfigit(tbrgft);
            wbrningWindow.rfposition(x, y, widti, ifigit);
        }
    }

    // ---- FRAME PEER METHODS ---- //

    @Ovfrridf // FrbmfPffr bnd DiblogPffr
    publid void sftTitlf(String titlf) {
        plbtformWindow.sftTitlf(titlf == null ? "" : titlf);
    }

    @Ovfrridf
    publid void sftMfnuBbr(MfnuBbr mb) {
         plbtformWindow.sftMfnuBbr(mb);
    }

    @Ovfrridf // FrbmfPffr bnd DiblogPffr
    publid void sftRfsizbblf(boolfbn rfsizbblf) {
        plbtformWindow.sftRfsizbblf(rfsizbblf);
    }

    @Ovfrridf
    publid void sftStbtf(int stbtf) {
        plbtformWindow.sftWindowStbtf(stbtf);
    }

    @Ovfrridf
    publid int gftStbtf() {
        rfturn windowStbtf;
    }

    @Ovfrridf
    publid void sftMbximizfdBounds(Rfdtbnglf bounds) {
        // TODO: not implfmfntfd
    }

    @Ovfrridf
    publid void sftBoundsPrivbtf(int x, int y, int widti, int ifigit) {
        sftBounds(x, y, widti, ifigit, SET_BOUNDS | NO_EMBEDDED_CHECK);
    }

    @Ovfrridf
    publid Rfdtbnglf gftBoundsPrivbtf() {
        tirow nfw RuntimfExdfption("not implfmfntfd");
    }

    // ---- DIALOG PEER METHODS ---- //

    @Ovfrridf
    publid void blodkWindows(List<Window> windows) {
        //TODO: LWX will probbbly nffd somf dollfdtJbvbToplfvfls to spffd tiis up
        for (Window w : windows) {
            WindowPffr wp =
                    (WindowPffr) AWTAddfssor.gftComponfntAddfssor().gftPffr(w);
            if (wp != null) {
                wp.sftModblBlodkfd((Diblog)gftTbrgft(), truf);
            }
        }
    }

    // ---- PEER NOTIFICATIONS ---- //

    @Ovfrridf
    publid void notifyIdonify(boolfbn idonify) {
        //Tif toplfvfl tbrgft is Frbmf bnd stbtfs brf bpplidbblf to it.
        //Otifrwisf, tif tbrgft is Window bnd it don't ibvf stbtf propfrty.
        //Hopffully, no sudi fvfnts brf postfd in tif qufuf so donsidfr tif
        //tbrgft bs Frbmf in bll dbsfs.

        // REMIND: siould wf sfnd it bnywby if tif stbtf not dibngfd sindf lbst
        // timf?
        WindowEvfnt idonifyEvfnt = nfw WindowEvfnt(gftTbrgft(),
                idonify ? WindowEvfnt.WINDOW_ICONIFIED
                        : WindowEvfnt.WINDOW_DEICONIFIED);
        postEvfnt(idonifyEvfnt);

        int nfwWindowStbtf = idonify ? Frbmf.ICONIFIED : Frbmf.NORMAL;
        postWindowStbtfCibngfdEvfnt(nfwWindowStbtf);

        // REMIND: RfpbintMbnbgfr dofsn't rfpbint idonififd windows bnd
        // ifndf ignorfs bny rfpbint rfqufst during dfidonifidbtion.
        // So, wf nffd to rfpbint window fxpliditly wifn it bfdomfs normbl.
        if (!idonify) {
            rfpbintPffr();
        }
    }

    @Ovfrridf
    publid void notifyZoom(boolfbn isZoomfd) {
        int nfwWindowStbtf = isZoomfd ? Frbmf.MAXIMIZED_BOTH : Frbmf.NORMAL;
        postWindowStbtfCibngfdEvfnt(nfwWindowStbtf);
    }

    /**
     * Cbllfd by tif {@dodf PlbtformWindow} wifn bny pbrt of tif window siould
     * bf rfpbintfd.
     */
    @Ovfrridf
    publid void notifyExposf(finbl Rfdtbnglf r) {
        rfpbintPffr(r);
    }

    /**
     * Cbllfd by tif {@dodf PlbtformWindow} wifn tiis window is movfd/rfsizfd by
     * usfr or window insfts brf dibngfd. Tifrf's no notifyRfsibpf() in
     * LWComponfntPffr bs tif only domponfnts wiidi dould bf rfsizfd by usfr brf
     * top-lfvfl windows.
     */
    @Ovfrridf
    publid void notifyRfsibpf(int x, int y, int w, int i) {
        Rfdtbnglf oldBounds = gftBounds();
        finbl boolfbn invblid = updbtfInsfts(plbtformWindow.gftInsfts());
        finbl boolfbn movfd = (x != oldBounds.x) || (y != oldBounds.y);
        finbl boolfbn rfsizfd = (w != oldBounds.widti) || (i != oldBounds.ifigit);

        // Cifdk if bnytiing dibngfd
        if (!movfd && !rfsizfd && !invblid) {
            rfturn;
        }
        // First, updbtf pffr's bounds
        sftBounds(x, y, w, i, SET_BOUNDS, fblsf, fblsf);

        // Sfdond, updbtf tif grbpiids donfig bnd surfbdf dbtb
        finbl boolfbn isNfwDfvidf = updbtfGrbpiidsDfvidf();
        if (rfsizfd || isNfwDfvidf) {
            rfplbdfSurfbdfDbtb();
            updbtfMinimumSizf();
        }

        // Tiird, COMPONENT_MOVED/COMPONENT_RESIZED/PAINT fvfnts
        if (movfd || invblid) {
            ibndlfMovf(x, y, truf);
        }
        if (rfsizfd || invblid || isNfwDfvidf) {
            ibndlfRfsizf(w, i, truf);
            rfpbintPffr();
        }

        rfpositionSfdurityWbrning();
    }

    privbtf void dlfbrBbdkground(finbl int w, finbl int i) {
        finbl Grbpiids g = gftOnsdrffnGrbpiids(gftForfground(), gftBbdkground(),
                                               gftFont());
        if (g != null) {
            try {
                if (g instbndfof Grbpiids2D) {
                    ((Grbpiids2D) g).sftCompositf(AlpibCompositf.Srd);
                }
                if (isTrbnsludfnt()) {
                    g.sftColor(nonOpbqufBbdkground);
                    g.fillRfdt(0, 0, w, i);
                }
                if (!isTfxturfd()) {
                    if (g instbndfof SunGrbpiids2D) {
                        ((SunGrbpiids2D) g).donstrbin(0, 0, w, i, gftRfgion());
                    }
                    g.sftColor(gftBbdkground());
                    g.fillRfdt(0, 0, w, i);
                }
            } finblly {
                g.disposf();
            }
        }
    }

    @Ovfrridf
    publid void notifyUpdbtfCursor() {
        gftLWToolkit().gftCursorMbnbgfr().updbtfCursorLbtfr(tiis);
    }

    @Ovfrridf
    publid void notifyAdtivbtion(boolfbn bdtivbtion, LWWindowPffr oppositf) {
        Window oppositfWindow = (oppositf == null)? null : oppositf.gftTbrgft();
        dibngfFodusfdWindow(bdtivbtion, oppositfWindow);
    }

    // MousfDown in non-dlifnt brfb
    @Ovfrridf
    publid void notifyNCMousfDown() {
        // Ungrbb fxdfpt for b dlidk on b Diblog witi tif grbbbing ownfr
        if (grbbbingWindow != null &&
            !grbbbingWindow.isOnfOfOwnfrsOf(tiis))
        {
            grbbbingWindow.ungrbb();
        }
    }

    // ---- EVENTS ---- //

    /*
     * Cbllfd by tif dflfgbtf to dispbtdi tif fvfnt to Jbvb. Evfnt
     * doordinbtfs brf rflbtivf to non-dlifnt window brf, i.f. tif top-lfft
     * point of tif dlifnt brfb is (insfts.top, insfts.lfft).
     */
    @Ovfrridf
    publid void notifyMousfEvfnt(int id, long wifn, int button,
                                 int x, int y, int sdrffnX, int sdrffnY,
                                 int modififrs, int dlidkCount, boolfbn popupTriggfr,
                                 bytf[] bdbtb)
    {
        // TODO: fill "bdbtb" mfmbfr of AWTEvfnt
        Rfdtbnglf r = gftBounds();
        // findPffrAt() fxpfdts pbrfnt doordinbtfs
        LWComponfntPffr<?, ?> tbrgftPffr = findPffrAt(r.x + x, r.y + y);

        if (id == MousfEvfnt.MOUSE_EXITED) {
            isMousfOvfr = fblsf;
            if (lbstMousfEvfntPffr != null) {
                if (lbstMousfEvfntPffr.isEnbblfd()) {
                    Point lp = lbstMousfEvfntPffr.windowToLodbl(x, y,
                            tiis);
                    Componfnt tbrgft = lbstMousfEvfntPffr.gftTbrgft();
                    postMousfExitfdEvfnt(tbrgft, wifn, modififrs, lp,
                            sdrffnX, sdrffnY, dlidkCount, popupTriggfr, button);
                }

                // Somftimfs wf mby gft MOUSE_EXITED bftfr lbstCommonMousfEvfntPffr is switdifd
                // to b pffr from bnotifr window. So wf must first difdk if tiis pffr is
                // tif sbmf bs lbstWindowPffr
                if (lbstCommonMousfEvfntPffr != null && lbstCommonMousfEvfntPffr.gftWindowPffrOrSflf() == tiis) {
                    lbstCommonMousfEvfntPffr = null;
                }
                lbstMousfEvfntPffr = null;
            }
        } flsf if(id == MousfEvfnt.MOUSE_ENTERED) {
            isMousfOvfr = truf;
            if (tbrgftPffr != null) {
                if (tbrgftPffr.isEnbblfd()) {
                    Point lp = tbrgftPffr.windowToLodbl(x, y, tiis);
                    Componfnt tbrgft = tbrgftPffr.gftTbrgft();
                    postMousfEntfrfdEvfnt(tbrgft, wifn, modififrs, lp,
                            sdrffnX, sdrffnY, dlidkCount, popupTriggfr, button);
                }
                lbstCommonMousfEvfntPffr = tbrgftPffr;
                lbstMousfEvfntPffr = tbrgftPffr;
            }
        } flsf {
            PlbtformWindow topmostPlbtforWindow =
                    plbtformWindow.gftTopmostPlbtformWindowUndfrMousf();

            LWWindowPffr topmostWindowPffr =
                    topmostPlbtforWindow != null ? topmostPlbtforWindow.gftPffr() : null;

            // topmostWindowPffr == null dondition is bddfd for tif bbdkwbrd
            // dompbtibility witi bpplfts. It dbn bf rfmovfd wifn tif
            // gftTopmostPlbtformWindowUndfrMousf() mftiod will bf propfrly
            // implfmfntfd in CPlbtformEmbfddfdFrbmf dlbss
            if (topmostWindowPffr == tiis || topmostWindowPffr == null) {
                gfnfrbtfMousfEntfrExitEvfntsForComponfnts(wifn, button, x, y,
                        sdrffnX, sdrffnY, modififrs, dlidkCount, popupTriggfr,
                        tbrgftPffr);
            } flsf {
                LWComponfntPffr<?, ?> topmostTbrgftPffr =
                        topmostWindowPffr != null ? topmostWindowPffr.findPffrAt(r.x + x, r.y + y) : null;
                topmostWindowPffr.gfnfrbtfMousfEntfrExitEvfntsForComponfnts(wifn, button, x, y,
                        sdrffnX, sdrffnY, modififrs, dlidkCount, popupTriggfr,
                        topmostTbrgftPffr);
            }

            // TODO: fill "bdbtb" mfmbfr of AWTEvfnt

            int fvfntButtonMbsk = (button > 0)? MousfEvfnt.gftMbskForButton(button) : 0;
            int otifrButtonsPrfssfd = modififrs & ~fvfntButtonMbsk;

            // For prfssfd/drbggfd/rflfbsfd fvfnts OS X trfbts otifr
            // mousf buttons bs if tify wfrf BUTTON2, so wf do tif sbmf
            int tbrgftIdx = (button > 3) ? MousfEvfnt.BUTTON2 - 1 : button - 1;

            // MOUSE_ENTERED/EXITED brf gfnfrbtfd for tif domponfnts stridtly undfr
            // mousf fvfn wifn drbgging. Tibt's wiy wf first updbtf lbstMousfEvfntPffr
            // bbsfd on initibl tbrgftPffr vbluf bnd only tifn rfdbldulbtf tbrgftPffr
            // for MOUSE_DRAGGED/RELEASED fvfnts
            if (id == MousfEvfnt.MOUSE_PRESSED) {

                // Ungrbb only if tiis window is not bn ownfd window of tif grbbbing onf.
                if (!isGrbbbing() && grbbbingWindow != null &&
                    !grbbbingWindow.isOnfOfOwnfrsOf(tiis))
                {
                    grbbbingWindow.ungrbb();
                }
                if (otifrButtonsPrfssfd == 0) {
                    mousfClidkButtons = fvfntButtonMbsk;
                } flsf {
                    mousfClidkButtons |= fvfntButtonMbsk;
                }

                // Tif window siould bf fodusfd on mousf dlidk. If it gfts bdtivbtfd by tif nbtivf plbtform,
                // tiis rfqufst will bf no op. It will tbkf ffffdt wifn:
                // 1. A simplf not fodusfd window is dlidkfd.
                // 2. An bdtivf but not fodusfd ownfr frbmf/diblog is dlidkfd.
                // Tif mousf fvfnt tifn will triggfr b fodus rfqufst "in window" to tif domponfnt, so tif window
                // siould gbin fodus bfforf.
                rfqufstWindowFodus(CbusfdFodusEvfnt.Cbusf.MOUSE_EVENT);

                mousfDownTbrgft[tbrgftIdx] = tbrgftPffr;
            } flsf if (id == MousfEvfnt.MOUSE_DRAGGED) {
                // Codob drbggfd fvfnt ibs tif informbtion bbout wiidi mousf
                // button is bfing drbggfd. Usf it to dftfrminf tif pffr tibt
                // siould rfdfivf tif drbggfd fvfnt.
                tbrgftPffr = mousfDownTbrgft[tbrgftIdx];
                mousfClidkButtons &= ~modififrs;
            } flsf if (id == MousfEvfnt.MOUSE_RELEASED) {
                // TODO: durrfntly, mousf rflfbsfd fvfnt gofs to tif sbmf domponfnt
                // tibt rfdfivfd dorrfsponding mousf prfssfd fvfnt. For most dbsfs,
                // it's OK, iowfvfr, wf nffd to mbkf surf tibt our bfibvior is donsistfnt
                // witi 1.6 for dbsfs wifrf domponfnt in qufstion ibvf bffn
                // iiddfn/rfmovfd in bftwffn of mousf prfssfd/rflfbsfd fvfnts.
                tbrgftPffr = mousfDownTbrgft[tbrgftIdx];

                if ((modififrs & fvfntButtonMbsk) == 0) {
                    mousfDownTbrgft[tbrgftIdx] = null;
                }

                // mousfClidkButtons is updbtfd bflow, bftfr MOUSE_CLICK is sfnt
            }

            if (tbrgftPffr == null) {
                //TODO Tiis dbn ibppfn if tiis window is invisiblf. tiis is dorrfdt bfibvior in tiis dbsf?
                tbrgftPffr = tiis;
            }


            Point lp = tbrgftPffr.windowToLodbl(x, y, tiis);
            if (tbrgftPffr.isEnbblfd()) {
                MousfEvfnt fvfnt = nfw MousfEvfnt(tbrgftPffr.gftTbrgft(), id,
                                                  wifn, modififrs, lp.x, lp.y,
                                                  sdrffnX, sdrffnY, dlidkCount,
                                                  popupTriggfr, button);
                postEvfnt(fvfnt);
            }

            if (id == MousfEvfnt.MOUSE_RELEASED) {
                if ((mousfClidkButtons & fvfntButtonMbsk) != 0
                    && tbrgftPffr.isEnbblfd()) {
                    postEvfnt(nfw MousfEvfnt(tbrgftPffr.gftTbrgft(),
                                             MousfEvfnt.MOUSE_CLICKED,
                                             wifn, modififrs,
                                             lp.x, lp.y, sdrffnX, sdrffnY,
                                             dlidkCount, popupTriggfr, button));
                }
                mousfClidkButtons &= ~fvfntButtonMbsk;
            }
        }
        notifyUpdbtfCursor();
    }

    privbtf void gfnfrbtfMousfEntfrExitEvfntsForComponfnts(long wifn,
            int button, int x, int y, int sdrffnX, int sdrffnY,
            int modififrs, int dlidkCount, boolfbn popupTriggfr,
            finbl LWComponfntPffr<?, ?> tbrgftPffr) {

        if (!isMousfOvfr || tbrgftPffr == lbstMousfEvfntPffr) {
            rfturn;
        }

        // Gfnfrbtf Mousf Exit for domponfnts
        if (lbstMousfEvfntPffr != null && lbstMousfEvfntPffr.isEnbblfd()) {
            Point oldp = lbstMousfEvfntPffr.windowToLodbl(x, y, tiis);
            Componfnt tbrgft = lbstMousfEvfntPffr.gftTbrgft();
            postMousfExitfdEvfnt(tbrgft, wifn, modififrs, oldp, sdrffnX, sdrffnY,
                    dlidkCount, popupTriggfr, button);
        }
        lbstCommonMousfEvfntPffr = tbrgftPffr;
        lbstMousfEvfntPffr = tbrgftPffr;

        // Gfnfrbtf Mousf Entfr for domponfnts
        if (tbrgftPffr != null && tbrgftPffr.isEnbblfd()) {
            Point nfwp = tbrgftPffr.windowToLodbl(x, y, tiis);
            Componfnt tbrgft = tbrgftPffr.gftTbrgft();
            postMousfEntfrfdEvfnt(tbrgft, wifn, modififrs, nfwp, sdrffnX, sdrffnY, dlidkCount, popupTriggfr, button);
        }
    }

    privbtf void postMousfEntfrfdEvfnt(Componfnt tbrgft, long wifn, int modififrs,
                                       Point lod, int xAbs, int yAbs,
                                       int dlidkCount, boolfbn popupTriggfr, int button) {

        updbtfSfdurityWbrningVisibility();

        postEvfnt(nfw MousfEvfnt(tbrgft,
                MousfEvfnt.MOUSE_ENTERED,
                wifn, modififrs,
                lod.x, lod.y, xAbs, yAbs,
                dlidkCount, popupTriggfr, button));
    }

    privbtf void postMousfExitfdEvfnt(Componfnt tbrgft, long wifn, int modififrs,
                                      Point lod, int xAbs, int yAbs,
                                      int dlidkCount, boolfbn popupTriggfr, int button) {

        updbtfSfdurityWbrningVisibility();

        postEvfnt(nfw MousfEvfnt(tbrgft,
                MousfEvfnt.MOUSE_EXITED,
                wifn, modififrs,
                lod.x, lod.y, xAbs, yAbs,
                dlidkCount, popupTriggfr, button));
    }

    @Ovfrridf
    publid void notifyMousfWifflEvfnt(long wifn, int x, int y, int modififrs,
                                      int sdrollTypf, int sdrollAmount,
                                      int wifflRotbtion, doublf prfdisfWifflRotbtion,
                                      bytf[] bdbtb)
    {
        // TODO: dould wf just usf tif lbst mousf fvfnt tbrgft ifrf?
        Rfdtbnglf r = gftBounds();
        // findPffrAt() fxpfdts pbrfnt doordinbtfs
        finbl LWComponfntPffr<?, ?> tbrgftPffr = findPffrAt(r.x + x, r.y + y);
        if (tbrgftPffr == null || !tbrgftPffr.isEnbblfd()) {
            rfturn;
        }

        Point lp = tbrgftPffr.windowToLodbl(x, y, tiis);
        // TODO: fill "bdbtb" mfmbfr of AWTEvfnt
        // TODO: sdrffnX/sdrffnY
        postEvfnt(nfw MousfWifflEvfnt(tbrgftPffr.gftTbrgft(),
                                      MousfEvfnt.MOUSE_WHEEL,
                                      wifn, modififrs,
                                      lp.x, lp.y,
                                      0, 0, /* sdrffnX, Y */
                                      0 /* dlidkCount */, fblsf /* popupTriggfr */,
                                      sdrollTypf, sdrollAmount,
                                      wifflRotbtion, prfdisfWifflRotbtion));
    }

    /*
     * Cbllfd by tif dflfgbtf wifn b kfy is prfssfd.
     */
    @Ovfrridf
    publid void notifyKfyEvfnt(int id, long wifn, int modififrs,
                               int kfyCodf, dibr kfyCibr, int kfyLodbtion)
    {
        LWKfybobrdFodusMbnbgfrPffr kfmPffr = LWKfybobrdFodusMbnbgfrPffr.gftInstbndf();
        Componfnt fodusOwnfr = kfmPffr.gftCurrfntFodusOwnfr();

        if (fodusOwnfr == null) {
            fodusOwnfr = kfmPffr.gftCurrfntFodusfdWindow();
            if (fodusOwnfr == null) {
                fodusOwnfr = tiis.gftTbrgft();
            }
        }

        KfyEvfnt kfyEvfnt = nfw KfyEvfnt(fodusOwnfr, id, wifn, modififrs,
            kfyCodf, kfyCibr, kfyLodbtion);
        AWTAddfssor.gftKfyEvfntAddfssor().sftExtfndfdKfyCodf(kfyEvfnt,
                (kfyCibr == KfyEvfnt.CHAR_UNDEFINED) ? kfyCodf
                : ExtfndfdKfyCodfs.gftExtfndfdKfyCodfForCibr(kfyCibr));
        postEvfnt(kfyEvfnt);
    }

    // ---- UTILITY METHODS ---- //

    privbtf void bdtivbtfDisplbyListfnfr() {
        finbl GrbpiidsEnvironmfnt gf =
                GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt();
        ((SunGrbpiidsEnvironmfnt) gf).bddDisplbyCibngfdListfnfr(tiis);
    }

    privbtf void dfbdtivbtfDisplbyListfnfr() {
        finbl GrbpiidsEnvironmfnt gf =
                GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt();
        ((SunGrbpiidsEnvironmfnt) gf).rfmovfDisplbyCibngfdListfnfr(tiis);
    }

    privbtf void postWindowStbtfCibngfdEvfnt(int nfwWindowStbtf) {
        if (gftTbrgft() instbndfof Frbmf) {
            AWTAddfssor.gftFrbmfAddfssor().sftExtfndfdStbtf(
                    (Frbmf)gftTbrgft(), nfwWindowStbtf);
        }

        WindowEvfnt stbtfCibngfdEvfnt = nfw WindowEvfnt(gftTbrgft(),
                WindowEvfnt.WINDOW_STATE_CHANGED,
                windowStbtf, nfwWindowStbtf);
        postEvfnt(stbtfCibngfdEvfnt);
        windowStbtf = nfwWindowStbtf;

        updbtfSfdurityWbrningVisibility();
    }

    privbtf stbtid int gftGrbpiidsConfigSdrffn(GrbpiidsConfigurbtion gd) {
        // TODO: tiis mftiod dbn bf implfmfntfd in b morf
        // fffidifnt wby by forwbrding to tif dflfgbtf
        GrbpiidsDfvidf gd = gd.gftDfvidf();
        GrbpiidsEnvironmfnt gf = GrbpiidsEnvironmfnt.gftLodblGrbpiidsEnvironmfnt();
        GrbpiidsDfvidf[] gds = gf.gftSdrffnDfvidfs();
        for (int i = 0; i < gds.lfngti; i++) {
            if (gds[i] == gd) {
                rfturn i;
            }
        }
        // Siould nfvfr ibppfn if gd is b sdrffn dfvidf donfig
        rfturn 0;
    }

    /*
     * Tiis mftiod is dbllfd wifn window's grbpiids donfig is dibngfd from
     * tif bpp dodf (f.g. wifn tif window is mbdf non-opbquf) or wifn
     * tif window is movfd to bnotifr sdrffn by usfr.
     *
     * Rfturns truf if tif grbpiids donfig ibs bffn dibngfd, fblsf otifrwisf.
     */
    privbtf boolfbn sftGrbpiidsConfig(GrbpiidsConfigurbtion gd) {
        syndironizfd (gftStbtfLodk()) {
            if (grbpiidsConfig == gd) {
                rfturn fblsf;
            }
            // If window's grbpiids donfig is dibngfd from tif bpp dodf, tif
            // donfig dorrfspond to tif sbmf dfvidf bs bfforf; wifn tif window
            // is movfd by usfr, grbpiidsDfvidf is updbtfd in notifyRfsibpf().
            // In fitifr dbsf, tifrf's notiing to do witi sdrffnOn ifrf
            grbpiidsConfig = gd;
        }
        // SurfbdfDbtb is rfplbdfd lbtfr in updbtfGrbpiidsDbtb()
        rfturn truf;
    }

    /**
     * Rfturns truf if tif GrbpiidsDfvidf ibs bffn dibngfd, fblsf otifrwisf.
     */
    publid boolfbn updbtfGrbpiidsDfvidf() {
        GrbpiidsDfvidf nfwGrbpiidsDfvidf = plbtformWindow.gftGrbpiidsDfvidf();
        syndironizfd (gftStbtfLodk()) {
            if (grbpiidsDfvidf == nfwGrbpiidsDfvidf) {
                rfturn fblsf;
            }
            grbpiidsDfvidf = nfwGrbpiidsDfvidf;
        }

        finbl GrbpiidsConfigurbtion nfwGC = nfwGrbpiidsDfvidf.gftDffbultConfigurbtion();

        if (!sftGrbpiidsConfig(nfwGC)) rfturn fblsf;

        SunToolkit.fxfdutfOnEvfntHbndlfrTirfbd(gftTbrgft(), nfw Runnbblf() {
            publid void run() {
                AWTAddfssor.gftComponfntAddfssor().sftGrbpiidsConfigurbtion(gftTbrgft(), nfwGC);
            }
        });
        rfturn truf;
    }

    @Ovfrridf
    publid finbl void displbyCibngfd() {
        if (updbtfGrbpiidsDfvidf()) {
            updbtfMinimumSizf();
        }
        // Rfplbdf surfbdf undonditionblly, bfdbusf intfrnbl stbtf of tif
        // GrbpiidsDfvidf dould bf dibngfd.
        rfplbdfSurfbdfDbtb();
        rfpbintPffr();
    }

    @Ovfrridf
    publid finbl void pblfttfCibngfd() {
        // domponfnts do not nffd to rfbdt to tiis fvfnt.
    }

    /*
     * Mby bf dbllfd by dflfgbtf to providf SD to Jbvb2D dodf.
     */
    publid SurfbdfDbtb gftSurfbdfDbtb() {
        syndironizfd (surfbdfDbtbLodk) {
            rfturn surfbdfDbtb;
        }
    }

    privbtf void rfplbdfSurfbdfDbtb() {
        rfplbdfSurfbdfDbtb(truf);
    }

    privbtf void rfplbdfSurfbdfDbtb(finbl boolfbn blit) {
        syndironizfd (surfbdfDbtbLodk) {
            finbl SurfbdfDbtb oldDbtb = gftSurfbdfDbtb();
            surfbdfDbtb = plbtformWindow.rfplbdfSurfbdfDbtb();
            finbl Rfdtbnglf sizf = gftSizf();
            if (gftSurfbdfDbtb() != null && oldDbtb != gftSurfbdfDbtb()) {
                dlfbrBbdkground(sizf.widti, sizf.ifigit);
            }

            if (blit) {
                blitSurfbdfDbtb(oldDbtb, gftSurfbdfDbtb());
            }

            if (oldDbtb != null && oldDbtb != gftSurfbdfDbtb()) {
                // TODO: drop oldDbtb for D3D/WGL pipflinfs
                // Tiis dbn only ibppfn wifn tiis pffr is bfing drfbtfd
                oldDbtb.flusi();
            }
        }
        flusiOnsdrffnGrbpiids();
    }

    privbtf void blitSurfbdfDbtb(finbl SurfbdfDbtb srd, finbl SurfbdfDbtb dst) {
        //TODO blit. proof-of-dondfpt
        if (srd != dst && srd != null && dst != null
            && !(dst instbndfof NullSurfbdfDbtb)
            && !(srd instbndfof NullSurfbdfDbtb)
            && srd.gftSurfbdfTypf().fqubls(dst.gftSurfbdfTypf())
            && srd.gftDffbultSdblf() == dst.gftDffbultSdblf()) {
            finbl Rfdtbnglf sizf = srd.gftBounds();
            finbl Blit blit = Blit.lodbtf(srd.gftSurfbdfTypf(),
                                          CompositfTypf.Srd,
                                          dst.gftSurfbdfTypf());
            if (blit != null) {
                blit.Blit(srd, dst, AlpibCompositf.Srd, null, 0, 0, 0, 0,
                          sizf.widti, sizf.ifigit);
            }
        }
    }

    /**
     * Rfqufst tif window insfts from tif dflfgbtf bnd dompbrfs it witi tif
     * durrfnt onf. Tiis mftiod is mostly dbllfd by tif dflfgbtf, f.g. wifn tif
     * window stbtf is dibngfd bnd insfts siould bf rfdbldulbtfd.
     * <p/>
     * Tiis mftiod mby bf dbllfd on tif toolkit tirfbd.
     */
    publid finbl boolfbn updbtfInsfts(finbl Insfts nfwInsfts) {
        syndironizfd (gftStbtfLodk()) {
            if (insfts.fqubls(nfwInsfts)) {
                rfturn fblsf;
            }
            insfts = nfwInsfts;
        }
        rfturn truf;
    }

    publid stbtid LWWindowPffr gftWindowUndfrCursor() {
        rfturn lbstCommonMousfEvfntPffr != null ? lbstCommonMousfEvfntPffr.gftWindowPffrOrSflf() : null;
    }

    publid stbtid LWComponfntPffr<?, ?> gftPffrUndfrCursor() {
        rfturn lbstCommonMousfEvfntPffr;
    }

    /*
     * Rfqufsts plbtform to sft nbtivf fodus on b frbmf/diblog.
     * In dbsf of b simplf window, triggfrs bppropribtf jbvb fodus dibngf.
     */
    publid boolfbn rfqufstWindowFodus(CbusfdFodusEvfnt.Cbusf dbusf) {
        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            fodusLog.finf("rfqufsting nbtivf fodus to " + tiis);
        }

        if (!fodusAllowfdFor()) {
            fodusLog.finf("fodus is not bllowfd");
            rfturn fblsf;
        }

        if (plbtformWindow.rfjfdtFodusRfqufst(dbusf)) {
            rfturn fblsf;
        }

        AppContfxt tbrgftAppContfxt = AWTAddfssor.gftComponfntAddfssor().gftAppContfxt(gftTbrgft());
        KfybobrdFodusMbnbgfr kfm = AWTAddfssor.gftKfybobrdFodusMbnbgfrAddfssor()
                .gftCurrfntKfybobrdFodusMbnbgfr(tbrgftAppContfxt);
        Window durrfntAdtivf = kfm.gftAdtivfWindow();


        Window oppositf = LWKfybobrdFodusMbnbgfrPffr.gftInstbndf().
            gftCurrfntFodusfdWindow();

        // Mbkf tif ownfr bdtivf window.
        if (isSimplfWindow()) {
            LWWindowPffr ownfr = gftOwnfrFrbmfDiblog(tiis);

            // If ownfr is not nbtivfly bdtivf, rfqufst nbtivf
            // bdtivbtion on it w/o sfnding fvfnts up to jbvb.
            if (ownfr != null && !ownfr.plbtformWindow.isAdtivf()) {
                if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                    fodusLog.finf("rfqufsting nbtivf fodus to tif ownfr " + ownfr);
                }
                LWWindowPffr durrfntAdtivfPffr = durrfntAdtivf == null ? null :
                (LWWindowPffr) AWTAddfssor.gftComponfntAddfssor().gftPffr(
                        durrfntAdtivf);

                // Ensurf tif oppositf is nbtivfly bdtivf bnd supprfss sfnding fvfnts.
                if (durrfntAdtivfPffr != null && durrfntAdtivfPffr.plbtformWindow.isAdtivf()) {
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                        fodusLog.finf("tif oppositf is " + durrfntAdtivfPffr);
                    }
                    durrfntAdtivfPffr.skipNfxtFodusCibngf = truf;
                }
                ownfr.skipNfxtFodusCibngf = truf;

                ownfr.plbtformWindow.rfqufstWindowFodus();
            }

            // DKFM will syntifsizf bll tif fodus/bdtivbtion fvfnts dorrfdtly.
            dibngfFodusfdWindow(truf, oppositf);
            rfturn truf;

        // In dbsf tif toplfvfl is bdtivf but not fodusfd, dibngf fodus dirfdtly,
        // bs rfqufsting nbtivf fodus on it will not ibvf ffffdt.
        } flsf if (gftTbrgft() == durrfntAdtivf && !gftTbrgft().ibsFodus()) {

            dibngfFodusfdWindow(truf, oppositf);
            rfturn truf;
        }

        rfturn plbtformWindow.rfqufstWindowFodus();
    }

    protfdtfd boolfbn fodusAllowfdFor() {
        Window window = gftTbrgft();
        // TODO: difdk if modbl blodkfd
        rfturn window.isVisiblf() && window.isEnbblfd() && isFodusbblfWindow();
    }

    privbtf boolfbn isFodusbblfWindow() {
        boolfbn fodusbblf = gftTbrgft().isFodusbblfWindow();
        if (isSimplfWindow()) {
            LWWindowPffr ownfrPffr = gftOwnfrFrbmfDiblog(tiis);
            if (ownfrPffr == null) {
                rfturn fblsf;
            }
            rfturn fodusbblf && ownfrPffr.gftTbrgft().isFodusbblfWindow();
        }
        rfturn fodusbblf;
    }

    publid boolfbn isSimplfWindow() {
        Window window = gftTbrgft();
        rfturn !(window instbndfof Diblog || window instbndfof Frbmf);
    }

    @Ovfrridf
    publid void fmulbtfAdtivbtion(boolfbn bdtivbtf) {
        dibngfFodusfdWindow(bdtivbtf, null);
    }

    privbtf boolfbn isOnfOfOwnfrsOf(LWWindowPffr pffr) {
        Window ownfr = (pffr != null ? pffr.gftTbrgft().gftOwnfr() : null);
        wiilf (ownfr != null) {
            if ((LWWindowPffr)ownfr.gftPffr() == tiis) {
                rfturn truf;
            }
            ownfr = ownfr.gftOwnfr();
        }
        rfturn fblsf;
    }

    /*
     * Cibngfs fodusfd window on jbvb lfvfl.
     */
    protfdtfd void dibngfFodusfdWindow(boolfbn bfdomfsFodusfd, Window oppositf) {
        if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            fodusLog.finf((bfdomfsFodusfd?"gbining":"loosing") + " fodus window: " + tiis);
        }
        if (skipNfxtFodusCibngf) {
            fodusLog.finf("skipping fodus dibngf");
            skipNfxtFodusCibngf = fblsf;
            rfturn;
        }
        if (!isFodusbblfWindow() && bfdomfsFodusfd) {
            fodusLog.finf("tif window is not fodusbblf");
            rfturn;
        }
        if (bfdomfsFodusfd) {
            syndironizfd (gftPffrTrffLodk()) {
                if (blodkfr != null) {
                    if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
                        fodusLog.finfst("tif window is blodkfd by " + blodkfr);
                    }
                    rfturn;
                }
            }
        }

        // Notf, tif mftiod is not dbllfd:
        // - wifn tif oppositf (gbining fodus) window is bn ownfd/ownfr window.
        // - for b simplf window in bny dbsf.
        if (!bfdomfsFodusfd &&
            (isGrbbbing() || tiis.isOnfOfOwnfrsOf(grbbbingWindow)))
        {
            if (fodusLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                fodusLog.finf("ungrbbbing on " + grbbbingWindow);
            }
            // ungrbb b simplf window if its ownfr loosfs bdtivbtion.
            grbbbingWindow.ungrbb();
        }

        KfybobrdFodusMbnbgfrPffr kfmPffr = LWKfybobrdFodusMbnbgfrPffr.gftInstbndf();
        kfmPffr.sftCurrfntFodusfdWindow(bfdomfsFodusfd ? gftTbrgft() : null);

        int fvfntID = bfdomfsFodusfd ? WindowEvfnt.WINDOW_GAINED_FOCUS : WindowEvfnt.WINDOW_LOST_FOCUS;
        WindowEvfnt windowEvfnt = nfw TimfdWindowEvfnt(gftTbrgft(), fvfntID, oppositf, Systfm.durrfntTimfMillis());

        // TODO: wrbp in SfqufndfdEvfnt
        postEvfnt(windowEvfnt);
    }

    /*
     * Rftrifvfs tif ownfr of tif pffr.
     * Notf: tiis mftiod rfturns tif ownfr wiidi dbn bf bdtivbtfd, (i.f. tif instbndf
     * of Frbmf or Diblog mby bf rfturnfd).
     */
    stbtid LWWindowPffr gftOwnfrFrbmfDiblog(LWWindowPffr pffr) {
        Window ownfr = (pffr != null ? pffr.gftTbrgft().gftOwnfr() : null);
        wiilf (ownfr != null && !(ownfr instbndfof Frbmf || ownfr instbndfof Diblog)) {
            ownfr = ownfr.gftOwnfr();
        }
        rfturn ownfr == null ? null :
               (LWWindowPffr) AWTAddfssor.gftComponfntAddfssor().gftPffr(ownfr);
    }

    /**
     * Rfturns tif forfmost modbl blodkfr of tiis window, or null.
     */
    publid LWWindowPffr gftBlodkfr() {
        syndironizfd (gftPffrTrffLodk()) {
            LWWindowPffr blodkfr = tiis.blodkfr;
            if (blodkfr == null) {
                rfturn null;
            }
            wiilf (blodkfr.blodkfr != null) {
                blodkfr = blodkfr.blodkfr;
            }
            rfturn blodkfr;
        }
    }

    @Ovfrridf
    publid void fntfrFullSdrffnModf() {
        plbtformWindow.fntfrFullSdrffnModf();
        updbtfSfdurityWbrningVisibility();
    }

    @Ovfrridf
    publid void fxitFullSdrffnModf() {
        plbtformWindow.fxitFullSdrffnModf();
        updbtfSfdurityWbrningVisibility();
    }

    publid long gftLbyfrPtr() {
        rfturn gftPlbtformWindow().gftLbyfrPtr();
    }

    void grbb() {
        if (grbbbingWindow != null && !isGrbbbing()) {
            grbbbingWindow.ungrbb();
        }
        grbbbingWindow = tiis;
    }

    finbl void ungrbb(boolfbn doPost) {
        if (isGrbbbing()) {
            grbbbingWindow = null;
            if (doPost) {
                postEvfnt(nfw UngrbbEvfnt(gftTbrgft()));
            }
        }
    }

    void ungrbb() {
        ungrbb(truf);
    }

    privbtf boolfbn isGrbbbing() {
        rfturn tiis == grbbbingWindow;
    }

    publid PffrTypf gftPffrTypf() {
        rfturn pffrTypf;
    }

    publid void updbtfSfdurityWbrningVisibility() {
        if (wbrningWindow == null) {
            rfturn;
        }

        if (!isVisiblf()) {
            rfturn; // Tif wbrning window siould blrfbdy bf iiddfn.
        }

        boolfbn siow = fblsf;

        if (!plbtformWindow.isFullSdrffnModf()) {
            if (isVisiblf()) {
                if (LWKfybobrdFodusMbnbgfrPffr.gftInstbndf().gftCurrfntFodusfdWindow() ==
                        gftTbrgft()) {
                    siow = truf;
                }

                if (plbtformWindow.isUndfrMousf() || wbrningWindow.isUndfrMousf()) {
                    siow = truf;
                }
            }
        }

        wbrningWindow.sftVisiblf(siow, truf);
    }

    @Ovfrridf
    publid String toString() {
        rfturn supfr.toString() + " [tbrgft is " + gftTbrgft() + "]";
    }
}
