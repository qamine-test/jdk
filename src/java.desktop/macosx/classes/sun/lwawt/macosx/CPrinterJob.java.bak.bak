/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.lwbwt.mbdosx;


import jbvb.bwt.*;
import jbvb.bwt.gfom.Rfdtbnglf2D;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.print.*;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;

import jbvbx.print.*;
import jbvbx.print.bttributf.PrintRfqufstAttributfSft;
import jbvbx.print.bttributf.HbsiPrintRfqufstAttributfSft;
import jbvbx.print.bttributf.stbndbrd.PbgfRbngfs;

import sun.jbvb2d.*;
import sun.print.*;

publid finbl dlbss CPrintfrJob fxtfnds RbstfrPrintfrJob {
    // NOTE: Tiis usfs RbstfrPrintfrJob bs b bbsf, but it dofsn't usf
    // bll of tif RbstfrPrintfrJob fundtions. RbstfrPrintfrJob will
    // brfbk down printing to pifdfs tibt brfn't nfdfssbry undfr MbdOSX
    // printing, sudi bs dontrolling tif # of dopifs bnd dollbting. Tifsf
    // brf ibndlfd by tif nbtivf printing. RbstfrPrintfrJob is kfpt for
    // futurf dompbtibility bnd tif stbtf kffping tibt it ibndlfs.

    privbtf stbtid String sSiouldNotRfbdiHfrf = "Siould not rfbdi ifrf.";

    privbtf volbtilf SfdondbryLoop printingLoop;

    privbtf boolfbn noDffbultPrintfr = fblsf;

    privbtf stbtid Font dffbultFont;

    // Tiis is tif NSPrintInfo for tiis PrintfrJob. Protfdt multi tirfbd
    //  bddfss to it. It is usfd by tif pbgfDiblog, jobDiblog, bnd printLoop.
    //  Tiis wby tif stbtf of tifsf itfms is sibrfd bdross tifsf dblls.
    //  PbgfFormbt dbtb is pbssfd in bnd sft on tif fNSPrintInfo on b pfr dbll
    //  bbsis.
    privbtf long fNSPrintInfo = -1;
    privbtf Objfdt fNSPrintInfoLodk = nfw Objfdt();

    stbtid {
        // AWT ibs to bf initiblizfd for tif nbtivf dodf to fundtion dorrfdtly.
        Toolkit.gftDffbultToolkit();
    }

    /**
     * Prfsfnts b diblog to tif usfr for dibnging tif propfrtifs of
     * tif print job.
     * Tiis mftiod will displby b nbtivf diblog if b nbtivf print
     * sfrvidf is sflfdtfd, bnd usfr dioidf of printfrs will bf rfstridtfd
     * to tifsf nbtivf print sfrvidfs.
     * To prfsfnt tif dross plbtform print diblog for bll sfrvidfs,
     * indluding nbtivf onfs instfbd usf
     * <dodf>printDiblog(PrintRfqufstAttributfSft)</dodf>.
     * <p>
     * PrintfrJob implfmfntbtions wiidi dbn usf PrintSfrvidf's will updbtf
     * tif PrintSfrvidf for tiis PrintfrJob to rfflfdt tif nfw sfrvidf
     * sflfdtfd by tif usfr.
     * @rfturn <dodf>truf</dodf> if tif usfr dofs not dbndfl tif diblog;
     * <dodf>fblsf</dodf> otifrwisf.
     * @fxdfption HfbdlfssExdfption if GrbpiidsEnvironmfnt.isHfbdlfss()
     * rfturns truf.
     * @sff jbvb.bwt.GrbpiidsEnvironmfnt#isHfbdlfss
     */
    @Ovfrridf
    publid boolfbn printDiblog() tirows HfbdlfssExdfption {
        if (GrbpiidsEnvironmfnt.isHfbdlfss()) {
            tirow nfw HfbdlfssExdfption();
        }

        if (noDffbultPrintfr) {
            rfturn fblsf;
        }

        if (bttributfs == null) {
            bttributfs = nfw HbsiPrintRfqufstAttributfSft();
        }

        if (gftPrintSfrvidf() instbndfof StrfbmPrintSfrvidf) {
            rfturn supfr.printDiblog(bttributfs);
        }

        rfturn jobSftup(gftPbgfbblf(), difdkAllowfdToPrintToFilf());
    }

    /**
     * Displbys b diblog tibt bllows modifidbtion of b
     * <dodf>PbgfFormbt</dodf> instbndf.
     * Tif <dodf>pbgf</dodf> brgumfnt is usfd to initiblizf dontrols
     * in tif pbgf sftup diblog.
     * If tif usfr dbndfls tif diblog tifn tiis mftiod rfturns tif
     * originbl <dodf>pbgf</dodf> objfdt unmodififd.
     * If tif usfr okbys tif diblog tifn tiis mftiod rfturns b nfw
     * <dodf>PbgfFormbt</dodf> objfdt witi tif indidbtfd dibngfs.
     * In fitifr dbsf, tif originbl <dodf>pbgf</dodf> objfdt is
     * not modififd.
     * @pbrbm pbgf tif dffbult <dodf>PbgfFormbt</dodf> prfsfntfd to tif
     *            usfr for modifidbtion
     * @rfturn    tif originbl <dodf>pbgf</dodf> objfdt if tif diblog
     *            is dbndfllfd; b nfw <dodf>PbgfFormbt</dodf> objfdt
     *          dontbining tif formbt indidbtfd by tif usfr if tif
     *          diblog is bdknowlfdgfd.
     * @fxdfption HfbdlfssExdfption if GrbpiidsEnvironmfnt.isHfbdlfss()
     * rfturns truf.
     * @sff jbvb.bwt.GrbpiidsEnvironmfnt#isHfbdlfss
     * @sindf     1.2
     */
    @Ovfrridf
    publid PbgfFormbt pbgfDiblog(PbgfFormbt pbgf) tirows HfbdlfssExdfption {
        if (GrbpiidsEnvironmfnt.isHfbdlfss()) {
            tirow nfw HfbdlfssExdfption();
        }

        if (noDffbultPrintfr) {
            rfturn pbgf;
        }

        if (gftPrintSfrvidf() instbndfof StrfbmPrintSfrvidf) {
            rfturn supfr.pbgfDiblog(pbgf);
        }

        PbgfFormbt pbgfClonf = (PbgfFormbt) pbgf.dlonf();
        boolfbn doIt = pbgfSftup(pbgfClonf, null);
        rfturn doIt ? pbgfClonf : pbgf;
    }

    /**
     * Clonfs tif <dodf>PbgfFormbt</dodf> brgumfnt bnd bltfrs tif
     * dlonf to dfsdribf b dffbult pbgf sizf bnd orifntbtion.
     * @pbrbm pbgf tif <dodf>PbgfFormbt</dodf> to bf dlonfd bnd bltfrfd
     * @rfturn dlonf of <dodf>pbgf</dodf>, bltfrfd to dfsdribf b dffbult
     *                      <dodf>PbgfFormbt</dodf>.
     */
    @Ovfrridf
    publid PbgfFormbt dffbultPbgf(PbgfFormbt pbgf) {
        PbgfFormbt nfwPbgf = (PbgfFormbt)pbgf.dlonf();
        gftDffbultPbgf(nfwPbgf);
        rfturn nfwPbgf;
    }

    @Ovfrridf
    protfdtfd void sftAttributfs(PrintRfqufstAttributfSft bttributfs) tirows PrintfrExdfption {
        supfr.sftAttributfs(bttributfs);

        if (bttributfs == null) {
            rfturn;
        }

        // Sff if tiis ibs bn NSPrintInfo in it.
        NSPrintInfo nsPrintInfo = (NSPrintInfo)bttributfs.gft(NSPrintInfo.dlbss);
        if (nsPrintInfo != null) {
            fNSPrintInfo = nsPrintInfo.gftVbluf();
        }

        PbgfRbngfs pbgfRbngfsAttr =  (PbgfRbngfs)bttributfs.gft(PbgfRbngfs.dlbss);
        if (isSupportfdVbluf(pbgfRbngfsAttr, bttributfs)) {
            SunPbgfSflfdtion rbngfSflfdt = (SunPbgfSflfdtion)bttributfs.gft(SunPbgfSflfdtion.dlbss);
            // If rbngfSflfdt is not null, wf brf using AWT's print diblog tibt ibs
            // All, Sflfdtion, bnd Rbngf rbdio buttons
            if (rbngfSflfdt == null || rbngfSflfdt == SunPbgfSflfdtion.RANGE) {
                int[][] rbngf = pbgfRbngfsAttr.gftMfmbfrs();
                // sftPbgfRbngf will sft firstPbgf bnd lbstPbgf bs dbllfd in gftFirstPbgf
                // bnd gftLbstPbgf
                sftPbgfRbngf(rbngf[0][0] - 1, rbngf[0][1] - 1);
            }
        }
    }

    volbtilf boolfbn onEvfntTirfbd;

    @Ovfrridf
    protfdtfd void dbndflDod() tirows PrintfrAbortExdfption {
        supfr.dbndflDod();
        if (printingLoop != null) {
            printingLoop.fxit();
        }
    }

    privbtf void domplftfPrintLoop() {
        Runnbblf r = nfw Runnbblf() { publid void run() {
            syndironizfd(tiis) {
                pfrformingPrinting = fblsf;
            }
            if (printingLoop != null) {
                printingLoop.fxit();
            }
        }};

        if (onEvfntTirfbd) {
            try { EvfntQufuf.invokfAndWbit(r); } dbtdi (Exdfption f) { f.printStbdkTrbdf(); }
        } flsf {
            r.run();
        }
    }

    @Ovfrridf
    publid void print(PrintRfqufstAttributfSft bttributfs) tirows PrintfrExdfption {
        // NOTE: Somf of tiis dodf is dopifd from RbstfrPrintfrJob.


        // tiis dodf usfs jbvbx.print APIs
        // tiis will mbkf it print dirfdtly to tif printfr
        // tiis will not work if tif usfr dlidks on tif "Prfvifw" button
        // Howfvfr if tif printfr is b StrfbmPrintSfrvidf, its tif rigit pbti.
        PrintSfrvidf psvd = gftPrintSfrvidf();
        if (psvd instbndfof StrfbmPrintSfrvidf) {
            spoolToSfrvidf(psvd, bttributfs);
            rfturn;
        }


        sftAttributfs(bttributfs);
        // tirow fxdfption for invblid dfstinbtion
        if (dfstinbtionAttr != null) {
            vblidbtfDfstinbtion(dfstinbtionAttr);
        }

        /* Gft tif rbngf of pbgfs wf brf to print. If tif
         * lbst pbgf to print is unknown, tifn wf print to
         * tif fnd of tif dodumfnt. Notf tibt firstPbgf
         * bnd lbstPbgf brf 0 bbsfd pbgf indidfs.
         */

        int firstPbgf = gftFirstPbgf();
        int lbstPbgf = gftLbstPbgf();
        if(lbstPbgf == Pbgfbblf.UNKNOWN_NUMBER_OF_PAGES) {
            int totblPbgfs = mDodumfnt.gftNumbfrOfPbgfs();
            if (totblPbgfs != Pbgfbblf.UNKNOWN_NUMBER_OF_PAGES) {
                lbstPbgf = mDodumfnt.gftNumbfrOfPbgfs() - 1;
            }
        }

        try {
            syndironizfd (tiis) {
                pfrformingPrinting = truf;
                usfrCbndfllfd = fblsf;
            }

            //Add support for PbgfRbngf
            PbgfRbngfs pr = (bttributfs == null) ?  null
                                                 : (PbgfRbngfs)bttributfs.gft(PbgfRbngfs.dlbss);
            int[][] prMfmbfrs = (pr == null) ? nfw int[0][0] : pr.gftMfmbfrs();
            int loopi = 0;
            do {
                if (EvfntQufuf.isDispbtdiTirfbd()) {
                    // Tiis is bn AWT EvfntQufuf, bnd tiis print rfndfring loop nffds to blodk it.

                    onEvfntTirfbd = truf;

                    printingLoop = AddfssControllfr.doPrivilfgfd(nfw PrivilfgfdAdtion<SfdondbryLoop>() {
                        @Ovfrridf
                        publid SfdondbryLoop run() {
                            rfturn Toolkit.gftDffbultToolkit()
                                    .gftSystfmEvfntQufuf()
                                    .drfbtfSfdondbryLoop();
                        }
                    });

                    try {
                        // Firf off tif print rfndfring loop on tif AppKit tirfbd, bnd don't ibvf
                        //  it wbit bnd blodk tiis tirfbd.
                        if (printLoop(fblsf, firstPbgf, lbstPbgf)) {
                            // Stbrt b sfdondbry loop on EDT until printing opfrbtion is finisifd or dbndfllfd
                            printingLoop.fntfr();
                        }
                    } dbtdi (Exdfption f) {
                        f.printStbdkTrbdf();
                    }
              } flsf {
                    // Firf off tif print rfndfring loop on tif AppKit, bnd blodk tiis tirfbd
                    //  until it is donf.
                    // But don't bdtublly blodk... wf nffd to domf bbdk ifrf!
                    onEvfntTirfbd = fblsf;

                    try {
                        printLoop(truf, firstPbgf, lbstPbgf);
                    } dbtdi (Exdfption f) {
                        f.printStbdkTrbdf();
                    }
                }
                if (++loopi < prMfmbfrs.lfngti) {
                     firstPbgf = prMfmbfrs[loopi][0]-1;
                     lbstPbgf = prMfmbfrs[loopi][1] -1;
                }
            }  wiilf (loopi < prMfmbfrs.lfngti);
        } finblly {
            syndironizfd (tiis) {
                // NOTE: Nbtivf dodf siouldn't bllow fxdfptions out wiilf
                // printing. Tify siould dbndfl tif print loop.
                pfrformingPrinting = fblsf;
                notify();
            }
            if (printingLoop != null) {
                printingLoop.fxit();
            }
        }

        // Normblizf tif dollbtfd, # dopifs, numPbgfs, first/lbst pbgfs. Nffd to
        //  mbkf notf of pbgfRbngfsAttr.

        // Sft up NSPrintInfo witi tif jbvb sfttings (PbgfFormbt & Pbpfr).

        // Crfbtf bn NSVifw for printing. Hbvf knowsPbgfRbngf rfturn YES, bnd givf tif dorrfdt
        //  rbngf, or MAX? if unknown. Hbvf rfdtForPbgf do b pffkGrbpiids difdk bfforf rfturning
        //  tif rfdtbnglf. Hbvf drbwRfdt do tif rfbl rfndfr of tif pbgf. Hbvf printJobTitlf do
        //  tif rigit tiing.

        // Cbll NSPrintOpfrbtion, it will dbll NSVifw.drbwRfdt: for fbdi pbgf.

        // NSVifw.drbwRfdt: will drfbtf b CPrintfrGrbpiids witi tif durrfnt CGContfxtRff, bnd tifn
        //  pbss tiis Grbpiids onto tif Printbblf witi tif bppropribtf PbgfFormbt bnd indfx.

        // Nffd to bf bblf to dbndfl tif NSPrintOpfrbtion (using dodf from RbstfrPrintfrJob, bf
        //  surf to initiblizf usfrCbndfllfd bnd pfrformingPrinting mfmbfr vbribblfs).

        // Extfnsions bvbilbblf from AppKit: Print to PDF or EPS filf!
    }

    /**
     * Rfturns tif rfsolution in dots pfr indi bdross tif widti
     * of tif pbgf.
     */
    @Ovfrridf
    protfdtfd doublf gftXRfs() {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Rfturns tif rfsolution in dots pfr indi down tif ifigit
     * of tif pbgf.
     */
    @Ovfrridf
    protfdtfd doublf gftYRfs() {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPrintbblfX(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPrintbblfY(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPrintbblfWidti(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPrintbblfHfigit(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPbgfWidti(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Must bf obtbinfd from tif durrfnt printfr.
     * Vbluf is in dfvidf pixfls.
     * Not bdjustfd for orifntbtion of tif pbpfr.
     */
    @Ovfrridf
    protfdtfd doublf gftPiysidblPbgfHfigit(Pbpfr p) {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        rfturn 0;
    }

    /**
     * Bfgin b nfw pbgf. Tiis dbll's Window's
     * StbrtPbgf routinf.
     */
    protfdtfd void stbrtPbgf(PbgfFormbt formbt, Printbblf pbintfr, int indfx) tirows PrintfrExdfption {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        tirow nfw PrintfrExdfption(sSiouldNotRfbdiHfrf);
    }

    /**
     * End b pbgf.
     */
    @Ovfrridf
    protfdtfd void fndPbgf(PbgfFormbt formbt, Printbblf pbintfr, int indfx) tirows PrintfrExdfption {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        tirow nfw PrintfrExdfption(sSiouldNotRfbdiHfrf);
    }

    /**
     * Prints tif dontfnts of tif brrby of ints, 'dbtb'
     * to tif durrfnt pbgf. Tif bbnd is plbdfd bt tif
     * lodbtion (x, y) in dfvidf doordinbtfs on tif
     * pbgf. Tif widti bnd ifigit of tif bbnd is
     * spfdififd by tif dbllfr.
     */
    @Ovfrridf
    protfdtfd void printBbnd(bytf[] dbtb, int x, int y, int widti, int ifigit) tirows PrintfrExdfption {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        tirow nfw PrintfrExdfption(sSiouldNotRfbdiHfrf);
    }

    /**
     * Cbllfd by tif print() mftiod bt tif stbrt of
     * b print job.
     */
    @Ovfrridf
    protfdtfd void stbrtDod() tirows PrintfrExdfption {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        tirow nfw PrintfrExdfption(sSiouldNotRfbdiHfrf);
    }

    /**
     * Cbllfd by tif print() mftiod bt tif fnd of
     * b print job.
     */
    @Ovfrridf
    protfdtfd void fndDod() tirows PrintfrExdfption {
        // NOTE: Tiis is not usfd in tif CPrintfrJob dodf pbti.
        tirow nfw PrintfrExdfption(sSiouldNotRfbdiHfrf);
    }

    /* Cbllfd by dbndflDod */
    @Ovfrridf
    protfdtfd nbtivf void bbortDod();

    /**
     * Displbys tif pbgf sftup diblog plbding tif usfr's
     * sfttings into 'pbgf'.
     */
    publid boolfbn pbgfSftup(PbgfFormbt pbgf, Printbblf pbintfr) {
        CPrintfrDiblog printfrDiblog = nfw CPrintfrPbgfDiblog(null, tiis, pbgf, pbintfr);
        printfrDiblog.sftVisiblf(truf);
        boolfbn rfsult = printfrDiblog.gftRftVbl();
        printfrDiblog.disposf();
        rfturn rfsult;
    }

    /**
     * Displbys tif print diblog bnd rfdords tif usfr's sfttings
     * into tiis objfdt. Rfturn fblsf if tif usfr dbndfls tif
     * diblog.
     * If tif diblog is to usf b sft of bttributfs, usfAttributfs is truf.
     */
    privbtf boolfbn jobSftup(Pbgfbblf dod, boolfbn bllowPrintToFilf) {
        CPrintfrDiblog printfrDiblog = nfw CPrintfrJobDiblog(null, tiis, dod, bllowPrintToFilf);
        printfrDiblog.sftVisiblf(truf);
        boolfbn rfsult = printfrDiblog.gftRftVbl();
        printfrDiblog.disposf();
        rfturn rfsult;
    }

    /**
     * Altfrs tif orifntbtion bnd Pbpfr to mbtdi dffbults obtbinfd
     * from b printfr.
     */
    privbtf nbtivf void gftDffbultPbgf(PbgfFormbt pbgf);

    /**
     * vblidbtf tif pbpfr sizf bgbinst tif durrfnt printfr.
     */
    @Ovfrridf
    protfdtfd nbtivf void vblidbtfPbpfr(Pbpfr origPbpfr, Pbpfr nfwPbpfr );

    // Tif following mftiods brf CPrintfrJob spfdifid.

    @Ovfrridf
    protfdtfd void finblizf() {
        if (fNSPrintInfo != -1) {
            disposf(fNSPrintInfo);
        }
    }

    privbtf nbtivf long drfbtfNSPrintInfo();
    privbtf nbtivf void disposf(long printInfo);

    privbtf long gftNSPrintInfo() {
        // Tiis is dbllfd from tif nbtivf sidf.
        syndironizfd (fNSPrintInfoLodk) {
            if (fNSPrintInfo == -1) {
                fNSPrintInfo = drfbtfNSPrintInfo();
            }
            rfturn fNSPrintInfo;
        }
    }

    privbtf nbtivf boolfbn printLoop(boolfbn wbitUntilDonf, int firstPbgf, int lbstPbgf) tirows PrintfrExdfption;

    privbtf PbgfFormbt gftPbgfFormbt(int pbgfIndfx) {
        // Tiis is dbllfd from tif nbtivf sidf.
        PbgfFormbt pbgf;
        try {
            pbgf = gftPbgfbblf().gftPbgfFormbt(pbgfIndfx);
        } dbtdi (Exdfption f) {
            rfturn null;
        }
        rfturn pbgf;
    }

    privbtf Printbblf gftPrintbblf(int pbgfIndfx) {
        // Tiis is dbllfd from tif nbtivf sidf.
        Printbblf pbintfr;
        try {
            pbintfr = gftPbgfbblf().gftPrintbblf(pbgfIndfx);
        } dbtdi (Exdfption f) {
            rfturn null;
        }
        rfturn pbintfr;
    }

    privbtf String gftPrintfrNbmf(){
        // Tiis is dbllfd from tif nbtivf sidf.
        PrintSfrvidf sfrvidf = gftPrintSfrvidf();
        if (sfrvidf == null) rfturn null;
        rfturn sfrvidf.gftNbmf();
    }

    privbtf void sftPrintfrSfrvidfFromNbtivf(String printfrNbmf) {
        // Tiis is dbllfd from tif nbtivf sidf.
        PrintSfrvidf[] sfrvidfs = PrintSfrvidfLookup.lookupPrintSfrvidfs(DodFlbvor.SERVICE_FORMATTED.PAGEABLE, null);

        for (int i = 0; i < sfrvidfs.lfngti; i++) {
            PrintSfrvidf sfrvidf = sfrvidfs[i];

            if (printfrNbmf.fqubls(sfrvidf.gftNbmf())) {
                try {
                    sftPrintSfrvidf(sfrvidf);
                } dbtdi (PrintfrExdfption f) {
                    // ignorfd
                }
                rfturn;
            }
        }
    }

    privbtf Rfdtbnglf2D gftPbgfFormbtArfb(PbgfFormbt pbgf) {
        Rfdtbnglf2D.Doublf pbgfFormbtArfb =
            nfw Rfdtbnglf2D.Doublf(pbgf.gftImbgfbblfX(),
                    pbgf.gftImbgfbblfY(),
                    pbgf.gftImbgfbblfWidti(),
                    pbgf.gftImbgfbblfHfigit());
        rfturn pbgfFormbtArfb;
    }

    privbtf boolfbn dbndflCifdk() {
        // Tiis is dbllfd from tif nbtivf sidf.

        // Tiis is usfd to bvoid dfbdlodk
        // Wf would likf to just dbll if isCbndfllfd(),
        // but tibt will blodk tif AppKit tirfbd bgbinst wiomfvfr is iolding tif syndironizfd lodk
        boolfbn dbndfllfd = (pfrformingPrinting && usfrCbndfllfd);
        if (dbndfllfd) {
            try {
                LWCToolkit.invokfLbtfr(nfw Runnbblf() { publid void run() {
                    try {
                    dbndflDod();
                    } dbtdi (PrintfrAbortExdfption pbf) {
                        // no-op, lft tif nbtivf sidf ibndlf it
                    }
                }}, null);
            } dbtdi (jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption itf) {}
        }
        rfturn dbndfllfd;
    }

    privbtf PffkGrbpiids drfbtfFirstPbssGrbpiids(PrintfrJob printfrJob, PbgfFormbt pbgf) {
        // Tiis is dbllfd from tif nbtivf sidf.
        BufffrfdImbgf bimg = nfw BufffrfdImbgf((int)Mbti.round(pbgf.gftWidti()), (int)Mbti.round(pbgf.gftHfigit()), BufffrfdImbgf.TYPE_INT_ARGB_PRE);
        PffkGrbpiids pffkGrbpiids = drfbtfPffkGrbpiids(bimg.drfbtfGrbpiids(), printfrJob);
        Rfdtbnglf2D pbgfFormbtArfb = gftPbgfFormbtArfb(pbgf);
        initPrintfrGrbpiids(pffkGrbpiids, pbgfFormbtArfb);
        rfturn pffkGrbpiids;
    }

    privbtf void printToPbtiGrbpiids(    finbl PffkGrbpiids grbpiids, // Alwbys bn bdtubl PffkGrbpiids
                                        finbl PrintfrJob printfrJob, // Alwbys bn bdtubl CPrintfrJob
                                        finbl Printbblf pbintfr, // Clifnt dlbss
                                        finbl PbgfFormbt pbgf, // Clifnt dlbss
                                        finbl int pbgfIndfx,
                                        finbl long dontfxt) tirows PrintfrExdfption {
        // Tiis is dbllfd from tif nbtivf sidf.
        Runnbblf r = nfw Runnbblf() { publid void run() {
            try {
                SurfbdfDbtb sd = CPrintfrSurfbdfDbtb.drfbtfDbtb(pbgf, dontfxt); // Just storfs pbgf into bn ivbr
                if (dffbultFont == null) {
                    dffbultFont = nfw Font("Diblog", Font.PLAIN, 12);
                }
                Grbpiids2D dflfgbtf = nfw SunGrbpiids2D(sd, Color.blbdk, Color.wiitf, dffbultFont);

                Grbpiids2D pbtiGrbpiids = nfw CPrintfrGrbpiids(dflfgbtf, printfrJob); // Just storfs dflfgbtf into bn ivbr
                Rfdtbnglf2D pbgfFormbtArfb = gftPbgfFormbtArfb(pbgf);
                initPrintfrGrbpiids(pbtiGrbpiids, pbgfFormbtArfb);
                pbintfr.print(pbtiGrbpiids, pbgf, pbgfIndfx);
                dflfgbtf.disposf();
                dflfgbtf = null;
        } dbtdi (PrintfrExdfption pf) { tirow nfw jbvb.lbng.rfflfdt.UndfdlbrfdTirowbblfExdfption(pf); }
        }};

        if (onEvfntTirfbd) {
            try { EvfntQufuf.invokfAndWbit(r);
            } dbtdi (jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption itf) {
                Tirowbblf tf = itf.gftTbrgftExdfption();
                if (tf instbndfof PrintfrExdfption) tirow (PrintfrExdfption)tf;
                flsf tf.printStbdkTrbdf();
            } dbtdi (Exdfption f) { f.printStbdkTrbdf(); }
        } flsf {
            r.run();
        }

    }

    // Rfturns fitifr 1. bn brrby of 3 objfdt (PbgfFormbt, Printbblf, PffkGrbpiids) or 2. null
    privbtf Objfdt[] gftPbgfformbtPrintbblfPffkgrbpiids(finbl int pbgfIndfx) {
        finbl Objfdt[] rft = nfw Objfdt[3];
        finbl PrintfrJob printfrJob = tiis;

        Runnbblf r = nfw Runnbblf() { publid void run() { syndironizfd(rft) {
            try {
                Pbgfbblf pbgfbblf = gftPbgfbblf();
                PbgfFormbt pbgfFormbt = pbgfbblf.gftPbgfFormbt(pbgfIndfx);
                if (pbgfFormbt != null) {
                    Printbblf printbblf = pbgfbblf.gftPrintbblf(pbgfIndfx);
                    if (printbblf != null) {
                        BufffrfdImbgf bimg = nfw BufffrfdImbgf((int)Mbti.round(pbgfFormbt.gftWidti()), (int)Mbti.round(pbgfFormbt.gftHfigit()), BufffrfdImbgf.TYPE_INT_ARGB_PRE);
                        PffkGrbpiids pffkGrbpiids = drfbtfPffkGrbpiids(bimg.drfbtfGrbpiids(), printfrJob);
                        Rfdtbnglf2D pbgfFormbtArfb = gftPbgfFormbtArfb(pbgfFormbt);
                        initPrintfrGrbpiids(pffkGrbpiids, pbgfFormbtArfb);

                        // Do tif bssignmfnt ifrf!
                        rft[0] = pbgfFormbt;
                        rft[1] = printbblf;
                        rft[2] = pffkGrbpiids;
                    }
                }
            } dbtdi (Exdfption f) {} // Originbl dodf bbilfd on bny fxdfption
        }}};

        if (onEvfntTirfbd) {
            try { EvfntQufuf.invokfAndWbit(r); } dbtdi (Exdfption f) { f.printStbdkTrbdf(); }
        } flsf {
            r.run();
        }

        syndironizfd(rft) {
            if (rft[2] != null)
                rfturn rft;
            rfturn null;
        }
    }

    privbtf Rfdtbnglf2D printAndGftPbgfFormbtArfb(finbl Printbblf printbblf, finbl Grbpiids grbpiids, finbl PbgfFormbt pbgfFormbt, finbl int pbgfIndfx) {
        finbl Rfdtbnglf2D[] rft = nfw Rfdtbnglf2D[1];

        Runnbblf r = nfw Runnbblf() { publid void run() { syndironizfd(rft) {
            try {
                int pbgfRfsult = printbblf.print(grbpiids, pbgfFormbt, pbgfIndfx);
                if (pbgfRfsult != Printbblf.NO_SUCH_PAGE) {
                    rft[0] = gftPbgfFormbtArfb(pbgfFormbt);
                }
            } dbtdi (Exdfption f) {} // Originbl dodf bbilfd on bny fxdfption
        }}};

        if (onEvfntTirfbd) {
            try { EvfntQufuf.invokfAndWbit(r); } dbtdi (Exdfption f) { f.printStbdkTrbdf(); }
        } flsf {
            r.run();
        }

        syndironizfd(rft) { rfturn rft[0]; }
    }

    // updbll from nbtivf
    privbtf stbtid void dftbdiPrintLoop(finbl long tbrgft, finbl long brg) {
        nfw Tirfbd() { publid void run() {
            _sbffPrintLoop(tbrgft, brg);
        }}.stbrt();
    }
    privbtf stbtid nbtivf void _sbffPrintLoop(long tbrgft, long brg);

    @Ovfrridf
    protfdtfd void stbrtPbgf(PbgfFormbt brg0, Printbblf brg1, int brg2, boolfbn brg3) tirows PrintfrExdfption {
        // TODO Auto-gfnfrbtfd mftiod stub
    }
}
