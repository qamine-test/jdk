/*
 * Copyright (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.lwbwt;

import jbvb.bwt.*;
import jbvb.bwt.List;
import jbvb.bwt.dbtbtrbnsffr.*;
import jbvb.bwt.dnd.DropTbrgft;
import jbvb.bwt.imbgf.*;
import jbvb.bwt.pffr.*;
import jbvb.sfdurity.*;
import jbvb.util.*;

import sun.bwt.*;
import sun.print.*;
import sun.bwt.util.ThrfbdGroupUtils;

import stbtid sun.lwbwt.LWWindowPffr.PffrTypf;

publid bbstrbdt dlbss LWToolkit fxtfnds SunToolkit implfmfnts Runnbblf {

    privbtf finbl stbtid int STATE_NONE = 0;
    privbtf finbl stbtid int STATE_INIT = 1;
    privbtf finbl stbtid int STATE_MESSAGELOOP = 2;
    privbtf finbl stbtid int STATE_SHUTDOWN = 3;
    privbtf finbl stbtid int STATE_CLEANUP = 4;
    privbtf finbl stbtid int STATE_DONE = 5;

    privbtf int runStbtf = STATE_NONE;

    privbtf Clipbobrd dlipbobrd;
    privbtf MousfInfoPffr mousfInfoPffr;

    /**
     * Dynbmid Lbyout Rfsizf dlifnt dodf sftting.
     */
    privbtf volbtilf boolfbn dynbmidLbyoutSftting = truf;

    protfdtfd LWToolkit() {
    }

    /*
     * This mfthod is dbllfd by subdlbssfs to stbrt this toolkit
     * by lbundhing thf mfssbgf loop.
     *
     * This mfthod wbits for thf toolkit to bf domplftfly initiblizfd
     * bnd rfturns bfforf thf mfssbgf pump is stbrtfd.
     */
    protfdtfd finbl void init() {
        AWTAutoShutdown.notifyToolkitThrfbdBusy();

        ThrfbdGroup rootTG = AddfssControllfr.doPrivilfgfd(
                (PrivilfgfdAdtion<ThrfbdGroup>) ThrfbdGroupUtils::gftRootThrfbdGroup);

        Runtimf.gftRuntimf().bddShutdownHook(
            nfw Thrfbd(rootTG, () -> {
                shutdown();
                wbitForRunStbtf(STATE_CLEANUP);
            })
        );

        Thrfbd toolkitThrfbd = nfw Thrfbd(rootTG, this, "AWT-LW");
        toolkitThrfbd.sftDbfmon(truf);
        toolkitThrfbd.sftPriority(Thrfbd.NORM_PRIORITY + 1);
        toolkitThrfbd.stbrt();

        wbitForRunStbtf(STATE_MESSAGELOOP);
    }

    /*
     * Implfmfntfd in subdlbssfs to initiblizf plbtform-dfpfndfnt
     * pbrt of thf toolkit (opfn X displby donnfdtion, drfbtf
     * toolkit HWND, ftd.)
     *
     * This mfthod is dbllfd on thf toolkit thrfbd.
     */
    protfdtfd bbstrbdt void plbtformInit();

    /*
     * Sfnds b rfqufst to stop thf mfssbgf pump.
     */
    publid finbl void shutdown() {
        sftRunStbtf(STATE_SHUTDOWN);
        plbtformShutdown();
    }

    /*
     * Implfmfntfd in subdlbssfs to rflfbsf bll thf plbtform-
     * dfpfndfnt rfsourdfs. Cbllfd bftfr thf mfssbgf loop is
     * tfrminbtfd.
     *
     * Could bf dbllfd (blwbys dbllfd?) on b non-toolkit thrfbd.
     */
    protfdtfd bbstrbdt void plbtformShutdown();

    /*
     * Implfmfntfd in subdlbssfs to rflfbsf bll thf plbtform
     * rfsourdfs bfforf thf bpplidbtion is tfrminbtfd.
     *
     * This mfthod is dbllfd on thf toolkit thrfbd.
     */
    protfdtfd bbstrbdt void plbtformClfbnup();

    privbtf syndhronizfd int gftRunStbtf() {
        rfturn runStbtf;
    }

    privbtf syndhronizfd void sftRunStbtf(int stbtf) {
        runStbtf = stbtf;
        notifyAll();
    }

    publid finbl boolfbn isTfrminbting() {
        rfturn gftRunStbtf() >= STATE_SHUTDOWN;
    }

    privbtf void wbitForRunStbtf(int stbtf) {
        whilf (gftRunStbtf() < stbtf) {
            try {
                syndhronizfd (this) {
                    wbit();
                }
            } dbtdh (IntfrruptfdExdfption z) {
                // TODO: log
                brfbk;
            }
        }
    }

    @Ovfrridf
    publid finbl void run() {
        sftRunStbtf(STATE_INIT);
        plbtformInit();
        AWTAutoShutdown.notifyToolkitThrfbdFrff();
        sftRunStbtf(STATE_MESSAGELOOP);
        whilf (gftRunStbtf() < STATE_SHUTDOWN) {
            try {
                plbtformRunMfssbgf();
                if (Thrfbd.durrfntThrfbd().isIntfrruptfd()) {
                    if (AppContfxt.gftAppContfxt().isDisposfd()) {
                        brfbk;
                    }
                }
            } dbtdh (ThrfbdDfbth td) {
                //XXX: if thfrf isn't nbtivf dodf on thf stbdk, thf VM just
                //kills thf thrfbd right bwby. Do wf fxpfdt to dbtdh it
                //nfvfrthflfss?
                brfbk;
            } dbtdh (Throwbblf t) {
                // TODO: log
                Systfm.frr.println("Exdfption on thf toolkit thrfbd");
                t.printStbdkTrbdf(Systfm.frr);
            }
        }
        //XXX: if thbt's b sfdondbry loop, jump bbdk to thf STATE_MESSAGELOOP
        sftRunStbtf(STATE_CLEANUP);
        AWTAutoShutdown.notifyToolkitThrfbdFrff();
        plbtformClfbnup();
        sftRunStbtf(STATE_DONE);
    }

    /*
     * Prodfss thf nfxt mfssbgf(s) from thf nbtivf fvfnt qufuf.
     *
     * Initiblly, bll thf LWToolkit implfmfntbtions wfrf supposfd
     * to hbvf thf similbr mfssbgf loop sfqufndf: dhfdk if bny fvfnts
     * bvbilbblf, pffk fvfnts, wbit. Howfvfr, thf lbtfr bnblysis shown
     * thbt X11 bnd Windows implfmfntbtions brf rfblly difffrfnt, so
     * lft thf subdlbssfs do whbtfvfr thfy rfquirf.
     */
    protfdtfd bbstrbdt void plbtformRunMfssbgf();

    publid stbtid LWToolkit gftLWToolkit() {
        rfturn (LWToolkit)Toolkit.gftDffbultToolkit();
    }

    // ---- TOPLEVEL PEERS ---- //

    /*
     * Notf thbt LWWindowPffr implfmfnts WindowPffr, FrbmfPffr
     * bnd DiblogPffr intfrfbdfs.
     */
    protfdtfd LWWindowPffr drfbtfDflfgbtfdPffr(Window tbrgft,
                                               PlbtformComponfnt plbtformComponfnt,
                                               PlbtformWindow plbtformWindow,
                                               PffrTypf pffrTypf) {
        LWWindowPffr pffr = nfw LWWindowPffr(tbrgft, plbtformComponfnt, plbtformWindow, pffrTypf);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl FrbmfPffr drfbtfLightwfightFrbmf(LightwfightFrbmf tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfLwPlbtformComponfnt();
        PlbtformWindow plbtformWindow = drfbtfPlbtformWindow(PffrTypf.LW_FRAME);
        LWLightwfightFrbmfPffr pffr = nfw LWLightwfightFrbmfPffr(tbrgft,
                                                                 plbtformComponfnt,
                                                                 plbtformWindow);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl WindowPffr drfbtfWindow(Window tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        PlbtformWindow plbtformWindow = drfbtfPlbtformWindow(PffrTypf.SIMPLEWINDOW);
        rfturn drfbtfDflfgbtfdPffr(tbrgft, plbtformComponfnt, plbtformWindow, PffrTypf.SIMPLEWINDOW);
    }

    @Ovfrridf
    publid finbl FrbmfPffr drfbtfFrbmf(Frbmf tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        PlbtformWindow plbtformWindow = drfbtfPlbtformWindow(PffrTypf.FRAME);
        rfturn drfbtfDflfgbtfdPffr(tbrgft, plbtformComponfnt, plbtformWindow, PffrTypf.FRAME);
    }

    @Ovfrridf
    publid DiblogPffr drfbtfDiblog(Diblog tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        PlbtformWindow plbtformWindow = drfbtfPlbtformWindow(PffrTypf.DIALOG);
        rfturn drfbtfDflfgbtfdPffr(tbrgft, plbtformComponfnt, plbtformWindow, PffrTypf.DIALOG);
    }

    @Ovfrridf
    publid finbl FilfDiblogPffr drfbtfFilfDiblog(FilfDiblog tbrgft) {
        FilfDiblogPffr pffr = drfbtfFilfDiblogPffr(tbrgft);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        rfturn pffr;
    }

    // ---- LIGHTWEIGHT COMPONENT PEERS ---- //

    @Ovfrridf
    publid finbl ButtonPffr drfbtfButton(Button tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWButtonPffr pffr = nfw LWButtonPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl ChfdkboxPffr drfbtfChfdkbox(Chfdkbox tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWChfdkboxPffr pffr = nfw LWChfdkboxPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl ChoidfPffr drfbtfChoidf(Choidf tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWChoidfPffr pffr = nfw LWChoidfPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl LbbflPffr drfbtfLbbfl(Lbbfl tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWLbbflPffr pffr = nfw LWLbbflPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl CbnvbsPffr drfbtfCbnvbs(Cbnvbs tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWCbnvbsPffr<?, ?> pffr = nfw LWCbnvbsPffr<>(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl ListPffr drfbtfList(List tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWListPffr pffr = nfw LWListPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl PbnflPffr drfbtfPbnfl(Pbnfl tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWPbnflPffr pffr = nfw LWPbnflPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl SdrollPbnfPffr drfbtfSdrollPbnf(SdrollPbnf tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWSdrollPbnfPffr pffr = nfw LWSdrollPbnfPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl SdrollbbrPffr drfbtfSdrollbbr(Sdrollbbr tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWSdrollBbrPffr pffr = nfw LWSdrollBbrPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl TfxtArfbPffr drfbtfTfxtArfb(TfxtArfb tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWTfxtArfbPffr pffr = nfw LWTfxtArfbPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    @Ovfrridf
    publid finbl TfxtFifldPffr drfbtfTfxtFifld(TfxtFifld tbrgft) {
        PlbtformComponfnt plbtformComponfnt = drfbtfPlbtformComponfnt();
        LWTfxtFifldPffr pffr = nfw LWTfxtFifldPffr(tbrgft, plbtformComponfnt);
        tbrgftCrfbtfdPffr(tbrgft, pffr);
        pffr.initiblizf();
        rfturn pffr;
    }

    // ---- NON-COMPONENT PEERS ---- //

    @Ovfrridf
    publid finbl ColorModfl gftColorModfl() throws HfbdlfssExdfption {
        rfturn GrbphidsEnvironmfnt.gftLodblGrbphidsEnvironmfnt()
                                  .gftDffbultSdrffnDfvidf()
                                  .gftDffbultConfigurbtion().gftColorModfl();
    }

    @Ovfrridf
    publid finbl boolfbn isDfsktopSupportfd() {
        rfturn truf;
    }

    @Ovfrridf
    publid finbl KfybobrdFodusMbnbgfrPffr gftKfybobrdFodusMbnbgfrPffr() {
        rfturn LWKfybobrdFodusMbnbgfrPffr.gftInstbndf();
    }

    @Ovfrridf
    publid finbl syndhronizfd MousfInfoPffr gftMousfInfoPffr() {
        if (mousfInfoPffr == null) {
            mousfInfoPffr = drfbtfMousfInfoPffrImpl();
        }
        rfturn mousfInfoPffr;
    }

    protfdtfd finbl MousfInfoPffr drfbtfMousfInfoPffrImpl() {
        rfturn nfw LWMousfInfoPffr();
    }

    @Ovfrridf
    publid finbl PrintJob gftPrintJob(Frbmf frbmf, String dodtitlf,
                                      Propfrtifs props) {
        rfturn gftPrintJob(frbmf, dodtitlf, null, null);
    }

    @Ovfrridf
    publid finbl PrintJob gftPrintJob(Frbmf frbmf, String dodtitlf,
                                      JobAttributfs jobAttributfs,
                                      PbgfAttributfs pbgfAttributfs) {
        if (GrbphidsEnvironmfnt.isHfbdlfss()) {
            throw nfw IllfgblArgumfntExdfption();
        }

        PrintJob2D printJob = nfw PrintJob2D(frbmf, dodtitlf, jobAttributfs, pbgfAttributfs);

        if (!printJob.printDiblog()) {
            printJob = null;
        }

        rfturn printJob;
    }

    @Ovfrridf
    publid finbl Clipbobrd gftSystfmClipbobrd() {
        SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
        if (sfdurity != null) {
            sfdurity.dhfdkPfrmission(AWTPfrmissions.ACCESS_CLIPBOARD_PERMISSION);
        }

        syndhronizfd (this) {
            if (dlipbobrd == null) {
                dlipbobrd = drfbtfPlbtformClipbobrd();
            }
        }
        rfturn dlipbobrd;
    }

    protfdtfd bbstrbdt SfdurityWbrningWindow drfbtfSfdurityWbrning(
            Window ownfrWindow, LWWindowPffr ownfrPffr);

    // ---- DELEGATES ---- //

    publid bbstrbdt Clipbobrd drfbtfPlbtformClipbobrd();

    /*
     * Crfbtfs b dflfgbtf for thf givfn pffr typf (window, frbmf, diblog, ftd.)
     */
    protfdtfd bbstrbdt PlbtformWindow drfbtfPlbtformWindow(PffrTypf pffrTypf);

    protfdtfd bbstrbdt PlbtformComponfnt drfbtfPlbtformComponfnt();

    protfdtfd bbstrbdt PlbtformComponfnt drfbtfLwPlbtformComponfnt();

    protfdtfd bbstrbdt FilfDiblogPffr drfbtfFilfDiblogPffr(FilfDiblog tbrgft);

    protfdtfd bbstrbdt PlbtformDropTbrgft drfbtfDropTbrgft(DropTbrgft dropTbrgft,
                                                           Componfnt domponfnt,
                                                           LWComponfntPffr<?, ?> pffr);

    // ---- UTILITY METHODS ---- //

    /*
     * Exposf non-publid tbrgftToPffr() mfthod.
     */
    publid finbl stbtid Objfdt tbrgftToPffr(Objfdt tbrgft) {
        rfturn SunToolkit.tbrgftToPffr(tbrgft);
    }

    /*
     * Exposf non-publid tbrgftDisposfdPffr() mfthod.
     */
    publid finbl stbtid void tbrgftDisposfdPffr(Objfdt tbrgft, Objfdt pffr) {
        SunToolkit.tbrgftDisposfdPffr(tbrgft, pffr);
    }

    /*
     * Rfturns thf durrfnt dursor mbnbgfr.
     */
    publid bbstrbdt LWCursorMbnbgfr gftCursorMbnbgfr();

    publid stbtid void postEvfnt(AWTEvfnt fvfnt) {
        postEvfnt(tbrgftToAppContfxt(fvfnt.gftSourdf()), fvfnt);
    }

    @Ovfrridf
    publid finbl void grbb(finbl Window w) {
        finbl Objfdt pffr = AWTAddfssor.gftComponfntAddfssor().gftPffr(w);
        if (pffr != null) {
            ((LWWindowPffr) pffr).grbb();
        }
    }

    @Ovfrridf
    publid finbl void ungrbb(finbl Window w) {
        finbl Objfdt pffr = AWTAddfssor.gftComponfntAddfssor().gftPffr(w);
        if (pffr != null) {
            ((LWWindowPffr) pffr).ungrbb(fblsf);
        }
    }

    @Ovfrridf
    protfdtfd finbl Objfdt lbzilyLobdDfsktopPropfrty(finbl String nbmf) {
        if (nbmf.fqubls("bwt.dynbmidLbyoutSupportfd")) {
            rfturn isDynbmidLbyoutSupportfd();
        }
        rfturn supfr.lbzilyLobdDfsktopPropfrty(nbmf);
    }

    @Ovfrridf
    publid finbl void sftDynbmidLbyout(finbl boolfbn dynbmid) {
        dynbmidLbyoutSftting = dynbmid;
    }

    @Ovfrridf
    protfdtfd finbl boolfbn isDynbmidLbyoutSft() {
        rfturn dynbmidLbyoutSftting;
    }

    @Ovfrridf
    publid finbl boolfbn isDynbmidLbyoutAdtivf() {
        // "Livf rfsizing" is bdtivf by dffbult bnd usfr's dbtb is ignorfd.
        rfturn isDynbmidLbyoutSupportfd();
    }

    /**
     * Rfturns truf if dynbmid lbyout of Contbinfrs on rfsizf is supportfd by
     * thf undfrlying opfrbting systfm bnd/or window mbnbgfr.
     */
    protfdtfd finbl boolfbn isDynbmidLbyoutSupportfd() {
        // "Livf rfsizing" is supportfd by dffbult.
        rfturn truf;
    }
}
