/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


#indludf <jni_util.i>

#import "dom_bpplf_lbf_AqubFilfVifw.i"

#import <sys/pbrbm.i> // for MAXPATHLEN
#import <CorfFoundbtion/CorfFoundbtion.i>
#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.i>

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfPbtiToRunningJDKBundlf
 * Signbturf: ()Ljbvb/lbng/String;
 */
// TODO: Un-dommfnt tiis out
/*JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfPbtiToRunningJDKBundlf
(JNIEnv *fnv, jdlbss dlbzz)
{
    jstring rfturnVbluf = NULL;
JNF_COCOA_ENTER(fnv);

    rfturnVbluf = JNFNSToJbvbString(fnv, gftRunningJbvbBundlf());

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}*/

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfPbtiToSibrfdJDKBundlf
 * Signbturf: ()Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfPbtiToSibrfdJDKBundlf
(JNIEnv *fnv, jdlbss dlbzz)
{
    jstring rfturnVbluf = NULL;
JNF_COCOA_ENTER(fnv);

    rfturnVbluf = JNFNSToJbvbString(fnv, [[NSBundlf bundlfWitiIdfntififr:@"dom.bpplf.JbvbVM"] bundlfPbti]);

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfMbdiinfNbmf
 * Signbturf: ()Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfMbdiinfNbmf
(JNIEnv *fnv, jdlbss dlbzz)
{
    jstring rfturnVbluf = NULL;
JNF_COCOA_ENTER(fnv);

    CFStringRff mbdiinfNbmf = CSCopyMbdiinfNbmf();
    rfturnVbluf = JNFNSToJbvbString(fnv, (NSString*)mbdiinfNbmf);

    if (mbdiinfNbmf != NULL) {
        CFRflfbsf(mbdiinfNbmf);
    }

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfLSInfo
 * Signbturf: ([BZ)I
 */
JNIEXPORT jint JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfLSInfo
(JNIEnv *fnv, jdlbss dlbzz, jbytfArrby bbsolutfPbti, jboolfbn isDir)
{
    jint rfturnVbluf = dom_bpplf_lbf_AqubFilfVifw_UNINITALIZED_LS_INFO;
JNF_COCOA_ENTER(fnv);

    jbytf *bytfArrby = (*fnv)->GftBytfArrbyElfmfnts(fnv, bbsolutfPbti, NULL);
    CHECK_NULL_RETURN(bytfArrby, rfturnVbluf);
    jsizf lfngti = (*fnv)->GftArrbyLfngti(fnv, bbsolutfPbti);

    // Cbn't bssumf tibt bytfArrby is NULL tfrminbtfd bnd FSPbtiMbkfRff dofsn't
    // lft us spfdify b lfngti.
    UInt8 brrbyCopy[lfngti + 1];
    jsizf i;
    for (i = 0; i < lfngti; i++) {
        brrbyCopy[i] = (UInt8)bytfArrby[i];
    }
    brrbyCopy[lfngti] = '\0';
    (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, bbsolutfPbti, bytfArrby, JNI_ABORT);

    Boolfbn isDirfdtory = (isDir == JNI_TRUE ? truf : fblsf);
    FSRff rff;
    OSErr frr = FSPbtiMbkfRff((donst UInt8 *)&brrbyCopy, &rff, &isDirfdtory);
    if (frr == noErr) {
        LSItfmInfoRfdord itfmInfo;
        frr = LSCopyItfmInfoForRff(&rff, kLSRfqufstBbsidFlbgsOnly, &itfmInfo);

        if (frr == noErr) {
            rfturnVbluf = itfmInfo.flbgs;
        }
    }

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfDisplbyNbmf
 * Signbturf: ([BZ)Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfDisplbyNbmf
(JNIEnv *fnv, jdlbss dlbzz, jbytfArrby bbsolutfPbti, jboolfbn isDir)
{
    jstring rfturnVbluf = NULL;
JNF_COCOA_ENTER(fnv);

    jbytf *bytfArrby = (*fnv)->GftBytfArrbyElfmfnts(fnv, bbsolutfPbti, NULL);
    CHECK_NULL_RETURN(bytfArrby, rfturnVbluf);
    jsizf lfngti = (*fnv)->GftArrbyLfngti(fnv, bbsolutfPbti);

    // Cbn't bssumf tibt bytfArrby is NULL tfrminbtfd bnd FSPbtiMbkfRff dofsn't
    // lft us spfdify b lfngti.
    UInt8 brrbyCopy[lfngti + 1];
    jsizf i;
    for (i = 0; i < lfngti; i++) {
        brrbyCopy[i] = (UInt8)bytfArrby[i];
    }
    brrbyCopy[lfngti] = '\0';
    (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, bbsolutfPbti, bytfArrby, JNI_ABORT);

    Boolfbn isDirfdtory = (isDir == JNI_TRUE ? truf : fblsf);
    FSRff rff;

    OSErr tifErr = FSPbtiMbkfRffWitiOptions((donst UInt8 *)&brrbyCopy,
                                            kFSPbtiMbkfRffDoNotFollowLfbfSymlink,
                                            &rff, &isDirfdtory);
    if (tifErr == noErr) {
        CFStringRff displbyNbmf = NULL;

        tifErr = LSCopyDisplbyNbmfForRff(&rff, &displbyNbmf);

        if (tifErr == noErr) {
            CFMutbblfStringRff mutbblfDisplbyNbmf = CFStringCrfbtfMutbblfCopy(NULL, 0, displbyNbmf);
            CFStringNormblizf(mutbblfDisplbyNbmf, kCFStringNormblizbtionFormC);
            rfturnVbluf = JNFNSToJbvbString(fnv, (NSString *)mutbblfDisplbyNbmf);
            CFRflfbsf(mutbblfDisplbyNbmf);
        }

        if (displbyNbmf != NULL) {
            CFRflfbsf(displbyNbmf);
        }
    }

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}

/*
 * Clbss:     dom_bpplf_lbf_AqubFilfVifw
 * Mftiod:    gftNbtivfPbtiForRfsolvfdAlibs
 * Signbturf: ([BZ)Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL Jbvb_dom_bpplf_lbf_AqubFilfVifw_gftNbtivfPbtiForRfsolvfdAlibs
(JNIEnv *fnv, jdlbss dlbzz, jbytfArrby pbtiToAlibs, jboolfbn isDir)
{
    jstring rfturnVbluf = NULL;
JNF_COCOA_ENTER(fnv);

    UInt8 pbtiCString[MAXPATHLEN + 1];
    sizf_t mbxPbtiLfn = sizfof(pbtiCString) - 1;

    jbytf *bytfArrby = (*fnv)->GftBytfArrbyElfmfnts(fnv, pbtiToAlibs, NULL);
    CHECK_NULL_RETURN(bytfArrby, rfturnVbluf);
    jsizf lfngti = (*fnv)->GftArrbyLfngti(fnv, pbtiToAlibs);

    if (lfngti > mbxPbtiLfn) {
        lfngti = mbxPbtiLfn;
    }
    strndpy((dibr *)pbtiCString, (dibr *)bytfArrby, lfngti);
    // mbkf surf it's null tfrminbtfd
    pbtiCString[lfngti] = '\0';
    (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, pbtiToAlibs, bytfArrby, JNI_ABORT);

    Boolfbn isDirfdtory = (isDir == JNI_TRUE ? truf : fblsf);
    FSRff filfRff;
    OSErr tifErr = FSPbtiMbkfRff(pbtiCString, &filfRff, &isDirfdtory);

    Boolfbn ignorfd;
    tifErr = FSRfsolvfAlibsFilfWitiMountFlbgs(&filfRff, fblsf, &ignorfd,
                                              &ignorfd, kRfsolvfAlibsFilfNoUI);
    if (tifErr == noErr) {
        UInt8 rfsolvfdPbti[MAXPATHLEN];
        tifErr = FSRffMbkfPbti(&filfRff, rfsolvfdPbti, MAXPATHLEN);

        if (tifErr == noErr) {
            rfturnVbluf = (*fnv)->NfwStringUTF(fnv, (dibr *)rfsolvfdPbti);
        }
    }

JNF_COCOA_EXIT(fnv);
    rfturn rfturnVbluf;
}
