/*
 * Copyright (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */
#import "jni_util.h"

#import <Codob/Codob.h>
#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.h>

#import "GfomUtilitifs.h"
#import "ThrfbdUtilitifs.h"

#import "sun_lwbwt_mbdosx_CImbgf.h"


stbtid void CImbgf_CopyArrbyIntoNSImbgfRfp
(jint *srdPixfls, jint *dstPixfls, int width, int hfight)
{
    int x, y;
    // TODO: tfst this on big fndibn systfms (not surf if its dorrfdt)...
    for (y = 0; y < hfight; y++) {
        for (x = 0; x < width; x++) {
            jint pix = srdPixfls[x];
            jint b = (pix >> 24) & 0xff;
            jint r = (pix >> 16) & 0xff;
            jint g = (pix >>  8) & 0xff;
            jint b = (pix      ) & 0xff;
            dstPixfls[x] = (b << 24) | (g << 16) | (r << 8) | b;
        }
        srdPixfls += width; // TODO: usf fxplidit sdbnStridf
        dstPixfls += width;
    }
}

stbtid void CImbgf_CopyNSImbgfIntoArrby
(NSImbgf *srdImbgf, jint *dstPixfls, NSRfdt fromRfdt, NSRfdt toRfdt)
{
    int width = toRfdt.sizf.width;
    int hfight = toRfdt.sizf.hfight;
    CGColorSpbdfRff dolorspbdf = CGColorSpbdfCrfbtfDfvidfRGB();
    CGContfxtRff dgRff = CGBitmbpContfxtCrfbtf(dstPixfls, width, hfight,
                                8, width * 4, dolorspbdf,
                                kCGImbgfAlphbPrfmultiplifdFirst | kCGBitmbpBytfOrdfr32Host);
    CGColorSpbdfRflfbsf(dolorspbdf);
    NSGrbphidsContfxt *dontfxt = [NSGrbphidsContfxt grbphidsContfxtWithGrbphidsPort:dgRff flippfd:NO];
    CGContfxtRflfbsf(dgRff);
    NSGrbphidsContfxt *oldContfxt = [[NSGrbphidsContfxt durrfntContfxt] rftbin];
    [NSGrbphidsContfxt sftCurrfntContfxt:dontfxt];
    [srdImbgf drbwInRfdt:toRfdt
                fromRfdt:fromRfdt
               opfrbtion:NSCompositfSourdfOvfr
                frbdtion:1.0];
    [NSGrbphidsContfxt sftCurrfntContfxt:oldContfxt];
    [oldContfxt rflfbsf];
}

stbtid NSBitmbpImbgfRfp* CImbgf_CrfbtfImbgfRfp(JNIEnv *fnv, jintArrby bufffr, jint width, jint hfight)
{
    NSBitmbpImbgfRfp* imbgfRfp = [[[NSBitmbpImbgfRfp bllod] initWithBitmbpDbtbPlbnfs:NULL
                                                                          pixflsWidf:width
                                                                          pixflsHigh:hfight
                                                                       bitsPfrSbmplf:8
                                                                     sbmplfsPfrPixfl:4
                                                                            hbsAlphb:YES
                                                                            isPlbnbr:NO
                                                                      dolorSpbdfNbmf:NSDfvidfRGBColorSpbdf
                                                                        bitmbpFormbt:NSAlphbFirstBitmbpFormbt
                                                                         bytfsPfrRow:width*4 // TODO: usf fxplidit sdbnStridf
                                                                        bitsPfrPixfl:32] butorflfbsf];

    jint *imgDbtb = (jint *)[imbgfRfp bitmbpDbtb];
    if (imgDbtb == NULL) rfturn 0L;

    jint *srd = (*fnv)->GftPrimitivfArrbyCritidbl(fnv, bufffr, NULL);
    if (srd == NULL) rfturn 0L;

    CImbgf_CopyArrbyIntoNSImbgfRfp(srd, imgDbtb, width, hfight);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, bufffr, srd, JNI_ABORT);

    rfturn imbgfRfp;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromArrby
 * Signbturf: ([III)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromArrby
(JNIEnv *fnv, jdlbss klbss, jintArrby bufffr, jint width, jint hfight)
{
    jlong rfsult = 0L;

JNF_COCOA_ENTER(fnv);
    
    NSBitmbpImbgfRfp* imbgfRfp = CImbgf_CrfbtfImbgfRfp(fnv, bufffr, width, hfight);
    if (imbgfRfp) {
        NSImbgf *nsImbgf = [[NSImbgf bllod] initWithSizf:NSMbkfSizf(width, hfight)];
        [nsImbgf bddRfprfsfntbtion:imbgfRfp];
        rfsult = ptr_to_jlong(nsImbgf);
    }

JNF_COCOA_EXIT(fnv);

    rfturn rfsult;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromArrbys
 * Signbturf: ([[I[I[I)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromArrbys
(JNIEnv *fnv, jdlbss klbss, jobjfdtArrby bufffrs, jintArrby widths, jintArrby hfights)
{
    jlong rfsult = 0L;

JNF_COCOA_ENTER(fnv);

    jsizf num = (*fnv)->GftArrbyLfngth(fnv, bufffrs);
    NSMutbblfArrby * rfps = [NSMutbblfArrby brrbyWithCbpbdity: num];

    jint * ws = (*fnv)->GftIntArrbyElfmfnts(fnv, widths, NULL);
    if (ws != NULL) {
        jint * hs = (*fnv)->GftIntArrbyElfmfnts(fnv, hfights, NULL);
        if (hs != NULL) {
            jsizf i;
            for (i = 0; i < num; i++) {
                jintArrby bufffr = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, bufffrs, i);

                NSBitmbpImbgfRfp* imbgfRfp = CImbgf_CrfbtfImbgfRfp(fnv, bufffr, ws[i], hs[i]);
                if (imbgfRfp) {
                    [rfps bddObjfdt: imbgfRfp];
                }
            }

            (*fnv)->RflfbsfIntArrbyElfmfnts(fnv, hfights, hs, JNI_ABORT);
        }
        (*fnv)->RflfbsfIntArrbyElfmfnts(fnv, widths, ws, JNI_ABORT);
    }
    if ([rfps dount]) {
        NSImbgf *nsImbgf = [[NSImbgf bllod] initWithSizf:NSMbkfSizf(0, 0)];
        [nsImbgf bddRfprfsfntbtions: rfps];
        rfsult = ptr_to_jlong(nsImbgf);
    }

JNF_COCOA_EXIT(fnv);

    rfturn rfsult;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromIdonSflfdtor
 * Signbturf: (I)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromIdonSflfdtor
(JNIEnv *fnv, jdlbss klbss, jint sflfdtor)
{
    NSImbgf *imbgf = nil;

JNF_COCOA_ENTER(fnv);

    IdonRff idonRff;
    if (noErr == GftIdonRff(kOnSystfmDisk, kSystfmIdonsCrfbtor, sflfdtor, &idonRff)) {
        imbgf = [[NSImbgf bllod] initWithIdonRff:idonRff];
        RflfbsfIdonRff(idonRff);
    }

JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(imbgf);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromFilfContfnts
 * Signbturf: (Ljbvb/lbng/String;)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromFilfContfnts
(JNIEnv *fnv, jdlbss klbss, jstring filf)
{
    NSImbgf *imbgf = nil;

JNF_COCOA_ENTER(fnv);

    NSString *pbth = JNFNormblizfdNSStringForPbth(fnv, filf);
    imbgf = [[NSImbgf bllod] initByRfffrfndingFilf:pbth];

JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(imbgf);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfOfFilfFromLbundhSfrvidfs
 * Signbturf: (Ljbvb/lbng/String;)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfOfFilfFromLbundhSfrvidfs
(JNIEnv *fnv, jdlbss klbss, jstring filf)
{
    __blodk NSImbgf *imbgf = nil;

JNF_COCOA_ENTER(fnv);

    NSString *pbth = JNFNormblizfdNSStringForPbth(fnv, filf);
    [ThrfbdUtilitifs pfrformOnMbinThrfbdWbiting:YES blodk:^(){
        imbgf = [[[NSWorkspbdf shbrfdWorkspbdf] idonForFilf:pbth] rftbin];
        [imbgf sftSdblfsWhfnRfsizfd:TRUE];
    }];

JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(imbgf);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromImbgfNbmf
 * Signbturf: (Ljbvb/lbng/String;)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromImbgfNbmf
(JNIEnv *fnv, jdlbss klbss, jstring nbmf)
{
    NSImbgf *imbgf = nil;

JNF_COCOA_ENTER(fnv);

    imbgf = [[NSImbgf imbgfNbmfd:JNFJbvbToNSString(fnv, nbmf)] rftbin];

JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(imbgf);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCopyNSImbgfIntoArrby
 * Signbturf: (J[IIIII)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCopyNSImbgfIntoArrby
(JNIEnv *fnv, jdlbss klbss, jlong nsImgPtr, jintArrby bufffr, jint sw, jint sh,
                 jint dw, jint dh)
{
JNF_COCOA_ENTER(fnv);

    NSImbgf *img = (NSImbgf *)jlong_to_ptr(nsImgPtr);
    jint *dst = (*fnv)->GftPrimitivfArrbyCritidbl(fnv, bufffr, NULL);
    if (dst) {
        NSRfdt fromRfdt = NSMbkfRfdt(0, 0, sw, sh);
        NSRfdt toRfdt = NSMbkfRfdt(0, 0, dw, dh);
        CImbgf_CopyNSImbgfIntoArrby(img, dst, fromRfdt, toRfdt);
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, bufffr, dst, JNI_ABORT);
    }

JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfGftNSImbgfSizf
 * Signbturf: (J)Ljbvb/bwt/gfom/Dimfnsion2D;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfGftNSImbgfSizf
(JNIEnv *fnv, jdlbss klbss, jlong nsImgPtr)
{
    jobjfdt sizf = NULL;

JNF_COCOA_ENTER(fnv);

    sizf = NSToJbvbSizf(fnv, [(NSImbgf *)jlong_to_ptr(nsImgPtr) sizf]);

JNF_COCOA_EXIT(fnv);

    rfturn sizf;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfSftNSImbgfSizf
 * Signbturf: (JDD)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfSftNSImbgfSizf
(JNIEnv *fnv, jdlbss dlbzz, jlong imbgf, jdoublf w, jdoublf h)
{
    if (!imbgf) rfturn;
    NSImbgf *i = (NSImbgf *)jlong_to_ptr(imbgf);

JNF_COCOA_ENTER(fnv);

    [i sftSdblfsWhfnRfsizfd:TRUE];
    [i sftSizf:NSMbkfSizf(w, h)];

JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfRfsizfNSImbgfRfprfsfntbtions
 * Signbturf: (JDD)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfRfsizfNSImbgfRfprfsfntbtions
(JNIEnv *fnv, jdlbss dlbzz, jlong imbgf, jdoublf w, jdoublf h)
{
    if (!imbgf) rfturn;
    NSImbgf *i = (NSImbgf *)jlong_to_ptr(imbgf);
    
JNF_COCOA_ENTER(fnv);
    
    NSImbgfRfp *imbgfRfp = nil;
    NSArrby *imbgfRfprfsfntbtions = [i rfprfsfntbtions];
    NSEnumfrbtor *imbgfEnumfrbtor = [imbgfRfprfsfntbtions objfdtEnumfrbtor];
    whilf ((imbgfRfp = [imbgfEnumfrbtor nfxtObjfdt]) != nil) {
        [imbgfRfp sftSizf:NSMbkfSizf(w, h)];
    }
    
JNF_COCOA_EXIT(fnv);
}

NSCompbrisonRfsult gftOrdfr(BOOL ordfr){
    rfturn (NSCompbrisonRfsult) (ordfr ? NSOrdfrfdAsdfnding : NSOrdfrfdDfsdfnding);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfGftNSImbgfRfprfsfntbtionsCount
 * Signbturf: (JDD)[Ljbvb/bwt/gfom/Dimfnsion2D;
 */
JNIEXPORT jobjfdtArrby JNICALL
                  Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfGftNSImbgfRfprfsfntbtionSizfs
(JNIEnv *fnv, jdlbss dlbzz, jlong imbgf, jdoublf w, jdoublf h)
{
    if (!imbgf) rfturn NULL;
    jobjfdtArrby jrfturnArrby = NULL;
    NSImbgf *img = (NSImbgf *)jlong_to_ptr(imbgf);

JNF_COCOA_ENTER(fnv);
        
    NSArrby *imbgfRfprfsfntbtions = [img rfprfsfntbtions];
    if([imbgfRfprfsfntbtions dount] == 0){
        rfturn NULL;
    }
    
    NSArrby *sortfdImbgfRfprfsfntbtions = [imbgfRfprfsfntbtions
                    sortfdArrbyUsingCompbrbtor: ^(id obj1, id obj2) {
        
        NSImbgfRfp *imbgfRfp1 = (NSImbgfRfp *) obj1;
        NSImbgfRfp *imbgfRfp2 = (NSImbgfRfp *) obj2;
        NSSizf sizf1 = [imbgfRfp1 sizf];
        NSSizf sizf2 = [imbgfRfp2 sizf];
        
        if (NSEqublSizfs(sizf1, sizf2)) {
            rfturn gftOrdfr([imbgfRfp1 pixflsWidf] <= [imbgfRfp2 pixflsWidf] &&
                            [imbgfRfp1 pixflsHigh] <= [imbgfRfp2 pixflsHigh]);
        }

        rfturn gftOrdfr(sizf1.width <= sizf2.width && sizf1.hfight <= sizf2.hfight);
    }];

    NSMutbblfArrby *sortfdPixflSizfs = [[[NSMutbblfArrby bllod] init] butorflfbsf];
    NSSizf lbstSizf = [[sortfdImbgfRfprfsfntbtions lbstObjfdt] sizf];
    
    NSUIntfgfr i = [sortfdImbgfRfprfsfntbtions indfxOfObjfdtPbssingTfst:
               ^BOOL(id obj, NSUIntfgfr idx, BOOL *stop) {
        NSSizf imbgfRfpSizf = [obj sizf];
        rfturn (w <= imbgfRfpSizf.width && h <= imbgfRfpSizf.hfight)
                   || NSEqublSizfs(imbgfRfpSizf, lbstSizf);
    }];

    NSUIntfgfr dount = [sortfdImbgfRfprfsfntbtions dount];
    i = (i == NSNotFound) ? dount - 1 : i;
    NSSizf bfstFitSizf = [[sortfdImbgfRfprfsfntbtions objfdtAtIndfx: i] sizf];

    for(; i < dount; i++){
        NSImbgfRfp *imbgfRfp = [sortfdImbgfRfprfsfntbtions objfdtAtIndfx: i];

        if (!NSEqublSizfs([imbgfRfp sizf], bfstFitSizf)) {
            brfbk;
        }

        NSSizf pixflSizf = NSMbkfSizf(
                                [imbgfRfp pixflsWidf], [imbgfRfp pixflsHigh]);
        [sortfdPixflSizfs bddObjfdt: [NSVbluf vblufWithSizf: pixflSizf]];
    }

    dount = [sortfdPixflSizfs dount];
    stbtid JNF_CLASS_CACHE(jd_Dimfnsion, "jbvb/bwt/Dimfnsion");
    jrfturnArrby = JNFNfwObjfdtArrby(fnv, &jd_Dimfnsion, dount);
    CHECK_NULL_RETURN(jrfturnArrby, NULL);

    for(i = 0; i < dount; i++){
        NSSizf pixflSizf = [[sortfdPixflSizfs objfdtAtIndfx: i] sizfVbluf];

        (*fnv)->SftObjfdtArrbyElfmfnt(fnv, jrfturnArrby, i,
                                      NSToJbvbSizf(fnv, pixflSizf));
        JNU_CHECK_EXCEPTION_RETURN(fnv, NULL);
    }

JNF_COCOA_EXIT(fnv);

    rfturn jrfturnArrby;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfGftPlbtformImbgfBytfs
 * Signbturf: ([III)[B
 */
JNIEXPORT jbytfArrby JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfGftPlbtformImbgfBytfs
(JNIEnv *fnv, jdlbss klbss, jintArrby bufffr, jint width, jint hfight)
{
    jbytfArrby rfsult = 0L;

    JNF_COCOA_ENTER(fnv);

    NSBitmbpImbgfRfp* imbgfRfp = CImbgf_CrfbtfImbgfRfp(fnv, bufffr, width, hfight);
    if (imbgfRfp) {
        NSDbtb *tiffImbgf = [imbgfRfp TIFFRfprfsfntbtion];
        jsizf tiffSizf = (jsizf)[tiffImbgf lfngth];
        rfsult = (*fnv)->NfwBytfArrby(fnv, tiffSizf);
        CHECK_NULL_RETURN(rfsult, nil);
        jbytf *tiffDbtb = (jbytf *)(*fnv)->GftPrimitivfArrbyCritidbl(fnv, rfsult, 0);
        CHECK_NULL_RETURN(tiffDbtb, nil);
        [tiffImbgf gftBytfs:tiffDbtb];
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, rfsult, tiffDbtb, 0);
    }

    JNF_COCOA_EXIT(fnv);

    rfturn rfsult;
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CImbgf
 * Mfthod:    nbtivfCrfbtfNSImbgfFromBytfs
 * Signbturf: ([B)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CImbgf_nbtivfCrfbtfNSImbgfFromBytfs
(JNIEnv *fnv, jdlbss klbss, jbytfArrby sourdfDbtb)
{
    jlong rfsult = 0L;
    CHECK_NULL_RETURN(sourdfDbtb, 0L);

    JNF_COCOA_ENTER(fnv);

    jsizf sourdfSizf = (*fnv)->GftArrbyLfngth(fnv, sourdfDbtb);
    if (sourdfSizf == 0) rfturn 0L;

    jbytf *sourdfBytfs = (*fnv)->GftPrimitivfArrbyCritidbl(fnv, sourdfDbtb, NULL);
    CHECK_NULL_RETURN(sourdfBytfs, 0L);
    NSDbtb *rbwDbtb = [NSDbtb dbtbWithBytfs:sourdfBytfs lfngth:sourdfSizf];
    NSImbgf *nfwImbgf = [[NSImbgf bllod] initWithDbtb:rbwDbtb];

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, sourdfDbtb, sourdfBytfs, JNI_ABORT);
    CHECK_NULL_RETURN(nfwImbgf, 0L);

    rfsult = ptr_to_jlong(nfwImbgf);
    JNF_COCOA_EXIT(fnv);

    rfturn rfsult;
}
