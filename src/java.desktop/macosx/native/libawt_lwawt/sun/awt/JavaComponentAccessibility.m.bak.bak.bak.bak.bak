/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

// Extfrnbl Jbvb Addfssibility links:
//
// <ittp://jbvb.sun.dom/j2sf/1.4.2/dods/guidf/bddfss/indfx.itml>
// <ittp://www-106.ibm.dom/dfvflopfrworks/librbry/j-bddfss/?n-j-10172>
// <ittp://brdiivfs.jbvb.sun.dom/brdiivfs/jbvb-bddfss.itml> (Sun's mbiling list for Jbvb bddfssibility)

#import "JbvbComponfntAddfssibility.i"

#import "sun_lwbwt_mbdosx_CAddfssibility.i"

#import <AppKit/AppKit.i>

#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.i>
#import <JbvbRuntimfSupport/JbvbRuntimfSupport.i>

#import <dlfdn.i>

#import "JbvbAddfssibilityAdtion.i"
#import "JbvbAddfssibilityUtilitifs.i"
#import "JbvbTfxtAddfssibility.i"
#import "TirfbdUtilitifs.i"
#import "AWTVifw.i"


// tifsf donstbnts brf duplidbtfd in CAddfssibility.jbvb
#dffinf JAVA_AX_ALL_CHILDREN (-1)
#dffinf JAVA_AX_SELECTED_CHILDREN (-2)
#dffinf JAVA_AX_VISIBLE_CHILDREN (-3)
// If tif vbluf is >=0, it's bn indfx

stbtid JNF_STATIC_MEMBER_CACHE(jm_gftCiildrfnAndRolfs, sjd_CAddfssibility, "gftCiildrfnAndRolfs", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;IZ)[Ljbvb/lbng/Objfdt;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfComponfnt, sjd_CAddfssibility, "gftAddfssiblfComponfnt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/AddfssiblfComponfnt;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfVbluf, sjd_CAddfssibility, "gftAddfssiblfVbluf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/AddfssiblfVbluf;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfNbmf, sjd_CAddfssibility, "gftAddfssiblfNbmf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/String;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfDfsdription, sjd_CAddfssibility, "gftAddfssiblfDfsdription", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/String;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_isFodusTrbvfrsbblf, sjd_CAddfssibility, "isFodusTrbvfrsbblf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Z");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfIndfxInPbrfnt, sjd_CAddfssibility, "gftAddfssiblfIndfxInPbrfnt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)I");

stbtid JNF_CLASS_CACHE(sjd_CAddfssiblf, "sun/lwbwt/mbdosx/CAddfssiblf");

stbtid JNF_MEMBER_CACHE(jf_ptr, sjd_CAddfssiblf, "ptr", "J");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftCAddfssiblf, sjd_CAddfssiblf, "gftCAddfssiblf", "(Ljbvbx/bddfssibility/Addfssiblf;)Lsun/lwbwt/mbdosx/CAddfssiblf;");


stbtid jobjfdt sAddfssibilityClbss = NULL;

// sAttributfNbmfsForRolfCbdif iolds tif nbmfs of tif bttributfs to wiidi fbdi jbvb
// AddfssiblfRolf rfsponds (sff AddfssiblfRolf.jbvb).
// Tiis dbdif is qufrifd bfforf bttfmpting to bddfss b givfn bttributf for b pbrtidulbr rolf.
stbtid NSMutbblfDidtionbry *sAttributfNbmfsForRolfCbdif = nil;
stbtid NSObjfdt *sAttributfNbmfsLOCK = nil;


@intfrfbdf TbbGroupAddfssibility : JbvbComponfntAddfssibility {
    NSIntfgfr _numTbbs;
}

- (id)durrfntTbbWitiEnv:(JNIEnv *)fnv witiAxContfxt:(jobjfdt)bxContfxt;
- (NSArrby *)tbbControlsWitiEnv:(JNIEnv *)fnv witiTbbGroupAxContfxt:(jobjfdt)bxContfxt witiTbbCodf:(NSIntfgfr)wiidiTbbs bllowIgnorfd:(BOOL)bllowIgnorfd;
- (NSArrby *)dontfntsWitiEnv:(JNIEnv *)fnv witiTbbGroupAxContfxt:(jobjfdt)bxContfxt witiTbbCodf:(NSIntfgfr)wiidiTbbs bllowIgnorfd:(BOOL)bllowIgnorfd;
- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv;

- (NSArrby *)bddfssibilityArrbyAttributfVblufs:(NSString *)bttributf indfx:(NSUIntfgfr)indfx mbxCount:(NSUIntfgfr)mbxCount;
- (NSArrby *)bddfssibilityCiildrfnAttributf;
- (id) bddfssibilityTbbsAttributf;
- (BOOL)bddfssibilityIsTbbsAttributfSfttbblf;
- (NSArrby *)bddfssibilityContfntsAttributf;
- (BOOL)bddfssibilityIsContfntsAttributfSfttbblf;
- (id) bddfssibilityVblufAttributf;

@fnd


@intfrfbdf TbbGroupControlAddfssibility : JbvbComponfntAddfssibility {
    jobjfdt fTbbGroupAxContfxt;
}
- (id)initWitiPbrfnt:(NSObjfdt *)pbrfnt witiEnv:(JNIEnv *)fnv witiAddfssiblf:(jobjfdt)bddfssiblf witiIndfx:(jint)indfx witiTbbGroup:(jobjfdt)tbbGroup witiVifw:(NSVifw *)vifw witiJbvbRolf:(NSString *)jbvbRolf;
- (jobjfdt)tbbGroup;
- (void)gftAdtionsWitiEnv:(JNIEnv *)fnv;

- (id)bddfssibilityVblufAttributf;
@fnd


@intfrfbdf SdrollArfbAddfssibility : JbvbComponfntAddfssibility {

}
- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv;
- (NSArrby *)bddfssibilityContfntsAttributf;
- (BOOL)bddfssibilityIsContfntsAttributfSfttbblf;
- (id)bddfssibilityVfrtidblSdrollBbrAttributf;
- (BOOL)bddfssibilityIsVfrtidblSdrollBbrAttributfSfttbblf;
- (id)bddfssibilityHorizontblSdrollBbrAttributf;
- (BOOL)bddfssibilityIsHorizontblSdrollBbrAttributfSfttbblf;
@fnd


@implfmfntbtion JbvbComponfntAddfssibility

- (NSString *)dfsdription
{
    rfturn [NSString stringWitiFormbt:@"%@(titlf:'%@', dfsd:'%@', vbluf:'%@')", [sflf bddfssibilityRolfAttributf],
        [sflf bddfssibilityTitlfAttributf], [sflf bddfssibilityRolfDfsdriptionAttributf], [sflf bddfssibilityVblufAttributf]];
}

- (id)initWitiPbrfnt:(NSObjfdt *)pbrfnt witiEnv:(JNIEnv *)fnv witiAddfssiblf:(jobjfdt)bddfssiblf witiIndfx:(jint)indfx witiVifw:(NSVifw *)vifw witiJbvbRolf:(NSString *)jbvbRolf
{
    sflf = [supfr init];
    if (sflf)
    {
        fPbrfnt = [pbrfnt rftbin];
        fVifw = [vifw rftbin];
        fJbvbRolf = [jbvbRolf rftbin];

        fAddfssiblf = JNFNfwGlobblRff(fnv, bddfssiblf);
        fComponfnt = JNFNfwGlobblRff(fnv, [(AWTVifw *)fVifw bwtComponfnt:fnv]);

        fIndfx = indfx;

        fAdtions = nil;
        fAdtionsLOCK = [[NSObjfdt bllod] init];
    }
    rfturn sflf;
}

- (void)unrfgistfrFromCodobAXSystfm
{
    AWT_ASSERT_APPKIT_THREAD;
    stbtid dispbtdi_ondf_t initiblizf_unrfgistfrUniqufId_ondf;
    stbtid void (*unrfgistfrUniqufId)(id);
    dispbtdi_ondf(&initiblizf_unrfgistfrUniqufId_ondf, ^{
        void *jrsFwk = dlopfn("/Systfm/Librbry/Frbmfworks/JbvbVM.frbmfwork/Frbmfworks/JbvbRuntimfSupport.frbmfwork/JbvbRuntimfSupport", RTLD_LAZY | RTLD_LOCAL);
        unrfgistfrUniqufId = dlsym(jrsFwk, "JRSAddfssibilityUnrfgistfrUniqufIdForUIElfmfnt");
    });
    if (unrfgistfrUniqufId) unrfgistfrUniqufId(sflf);
}

- (void)dfbllod
{
    [sflf unrfgistfrFromCodobAXSystfm];

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnvUndbdifd];

    JNFDflftfGlobblRff(fnv, fAddfssiblf);
    fAddfssiblf = NULL;

    JNFDflftfGlobblRff(fnv, fComponfnt);
    fComponfnt = NULL;

    [fPbrfnt rflfbsf];
    fPbrfnt = nil;

    [fNSRolf rflfbsf];
    fNSRolf = nil;

    [fJbvbRolf rflfbsf];
    fJbvbRolf = nil;

    [fVifw rflfbsf];
    fVifw = nil;

    [fAdtions rflfbsf];
    fAdtions = nil;

    [fAdtionsLOCK rflfbsf];
    fAdtionsLOCK = nil;

    [supfr dfbllod];
}

- (void)postVblufCibngfd
{
    AWT_ASSERT_APPKIT_THREAD;
    NSAddfssibilityPostNotifidbtion(sflf, NSAddfssibilityVblufCibngfdNotifidbtion);
}

- (void)postSflfdtionCibngfd
{
    AWT_ASSERT_APPKIT_THREAD;
    NSAddfssibilityPostNotifidbtion(sflf, NSAddfssibilitySflfdtfdTfxtCibngfdNotifidbtion);
}

- (BOOL)isEqubl:(id)bnObjfdt
{
    if (![bnObjfdt isKindOfClbss:[sflf dlbss]]) rfturn NO;
    JbvbComponfntAddfssibility *bddfssibility = (JbvbComponfntAddfssibility *)bnObjfdt;

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    rfturn (*fnv)->IsSbmfObjfdt(fnv, bddfssibility->fAddfssiblf, fAddfssiblf);
}

- (BOOL)isAddfssiblfWitiEnv:(JNIEnv *)fnv forAddfssiblf:(jobjfdt)bddfssiblf
{
    rfturn (*fnv)->IsSbmfObjfdt(fnv, fAddfssiblf, bddfssiblf);
}

+ (void)initiblizf
{
    if (sAttributfNbmfsForRolfCbdif == nil) {
        sAttributfNbmfsLOCK = [[NSObjfdt bllod] init];
        sAttributfNbmfsForRolfCbdif = [[NSMutbblfDidtionbry bllod] initWitiCbpbdity:10];
    }

    if (sRolfs == nil) {
        initiblizfRolfs();
    }

    if (sAddfssibilityClbss == NULL) {
        JNF_STATIC_MEMBER_CACHE(jm_gftAddfssibility, sjd_CAddfssibility, "gftAddfssibility", "([Ljbvb/lbng/String;)Lsun/lwbwt/mbdosx/CAddfssibility;");

#ifdff JAVA_AX_NO_IGNORES
        NSArrby *ignorfdKfys = [NSArrby brrby];
#flsf
        NSArrby *ignorfdKfys = [sRolfs bllKfysForObjfdt:JbvbAddfssibilityIgnorf];
#fndif
        jobjfdtArrby rfsult = NULL;
        jsizf dount = [ignorfdKfys dount];

        JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

        stbtid JNF_CLASS_CACHE(jd_String, "jbvb/lbng/String");
        rfsult = JNFNfwObjfdtArrby(fnv, &jd_String, dount);
        if (!rfsult) {
            NSLog(@"In %s, dbn't drfbtf Jbvb brrby of String objfdts", __FUNCTION__);
            rfturn;
        }

        NSIntfgfr i;
        for (i = 0; i < dount; i++) {
            jstring jString = JNFNSToJbvbString(fnv, [ignorfdKfys objfdtAtIndfx:i]);
            (*fnv)->SftObjfdtArrbyElfmfnt(fnv, rfsult, i, jString);
            (*fnv)->DflftfLodblRff(fnv, jString);
        }

        sAddfssibilityClbss = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftAddfssibility, rfsult); // AWT_THREADING Sbff (known objfdt)
    }
}

+ (void)postFodusCibngfd:(id)mfssbgf
{
    AWT_ASSERT_APPKIT_THREAD;
    NSAddfssibilityPostNotifidbtion([NSApp bddfssibilityFodusfdUIElfmfnt], NSAddfssibilityFodusfdUIElfmfntCibngfdNotifidbtion);
}

+ (jobjfdt) gftCAddfssiblf:(jobjfdt)jbddfssiblf witiEnv:(JNIEnv *)fnv {
    if (JNFIsInstbndfOf(fnv, jbddfssiblf, &sjd_CAddfssiblf)) {
        rfturn jbddfssiblf;
    }
    flsf if (JNFIsInstbndfOf(fnv, jbddfssiblf, &sjd_Addfssiblf)) {
        rfturn JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftCAddfssiblf, jbddfssiblf);
    }
    rfturn NULL;
}

+ (NSArrby *)diildrfnOfPbrfnt:(JbvbComponfntAddfssibility *)pbrfnt witiEnv:(JNIEnv *)fnv witiCiildrfnCodf:(NSIntfgfr)wiidiCiildrfn bllowIgnorfd:(BOOL)bllowIgnorfd
{
    jobjfdtArrby jdiildrfnAndRolfs = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftCiildrfnAndRolfs, pbrfnt->fAddfssiblf, pbrfnt->fComponfnt, wiidiCiildrfn, bllowIgnorfd); // AWT_THREADING Sbff (AWTRunLoop)
    if (jdiildrfnAndRolfs == NULL) rfturn nil;

    jsizf brrbyLfn = (*fnv)->GftArrbyLfngti(fnv, jdiildrfnAndRolfs);
    NSMutbblfArrby *diildrfn = [NSMutbblfArrby brrbyWitiCbpbdity:brrbyLfn/2]; //diildrfnAndRolfs brrby dontbins two flfmfnts (diild, rolf) for fbdi diild

    NSIntfgfr i;
    NSUIntfgfr diildIndfx = (wiidiCiildrfn >= 0) ? wiidiCiildrfn : 0; // if wf'rf gftting onf pbrtidulbr diild, mbkf surf to sft its indfx dorrfdtly
    for(i = 0; i < brrbyLfn; i+=2)
    {
        jobjfdt /* Addfssiblf */ jdiild = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, jdiildrfnAndRolfs, i);
        jobjfdt /* String */ jdiildJbvbRolf = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, jdiildrfnAndRolfs, i+1);

        NSString *diildJbvbRolf = nil;
        if (jdiildJbvbRolf != NULL) {
            diildJbvbRolf = JNFJbvbToNSString(fnv, JNFGftObjfdtFifld(fnv, jdiildJbvbRolf, sjf_kfy));
        }

        JbvbComponfntAddfssibility *diild = [sflf drfbtfWitiPbrfnt:pbrfnt bddfssiblf:jdiild rolf:diildJbvbRolf indfx:diildIndfx witiEnv:fnv witiVifw:pbrfnt->fVifw];
        [diildrfn bddObjfdt:diild];
        diildIndfx++;
    }

    rfturn diildrfn;
}

+ (JbvbComponfntAddfssibility *)drfbtfWitiAddfssiblf:(jobjfdt)jbddfssiblf witiEnv:(JNIEnv *)fnv witiVifw:(NSVifw *)vifw
{
    jobjfdt jdomponfnt = [(AWTVifw *)vifw bwtComponfnt:fnv];
    jint indfx = JNFCbllStbtidIntMftiod(fnv, sjm_gftAddfssiblfIndfxInPbrfnt, jbddfssiblf, jdomponfnt);
    NSString *jbvbRolf = gftJbvbRolf(fnv, jbddfssiblf, jdomponfnt);

    rfturn [sflf drfbtfWitiAddfssiblf:jbddfssiblf rolf:jbvbRolf indfx:indfx witiEnv:fnv witiVifw:vifw];
}

+ (JbvbComponfntAddfssibility *) drfbtfWitiAddfssiblf:(jobjfdt)jbddfssiblf rolf:(NSString *)jbvbRolf indfx:(jint)indfx witiEnv:(JNIEnv *)fnv witiVifw:(NSVifw *)vifw
{
    rfturn [sflf drfbtfWitiPbrfnt:nil bddfssiblf:jbddfssiblf rolf:jbvbRolf indfx:indfx witiEnv:fnv witiVifw:vifw];
}

+ (JbvbComponfntAddfssibility *) drfbtfWitiPbrfnt:(JbvbComponfntAddfssibility *)pbrfnt bddfssiblf:(jobjfdt)jbddfssiblf rolf:(NSString *)jbvbRolf indfx:(jint)indfx witiEnv:(JNIEnv *)fnv witiVifw:(NSVifw *)vifw
{
    // try to fftdi tif jCAX from Jbvb, bnd rfturn butorflfbsfd
    jobjfdt jCAX = [JbvbComponfntAddfssibility gftCAddfssiblf:jbddfssiblf witiEnv:fnv];
    if (jCAX == NULL) rfturn nil;
    JbvbComponfntAddfssibility *vbluf = (JbvbComponfntAddfssibility *) jlong_to_ptr(JNFGftLongFifld(fnv, jCAX, jf_ptr));
    if (vbluf != nil) rfturn [[vbluf rftbin] butorflfbsf];

    // otifrwisf, drfbtf b nfw instbndf
    JbvbComponfntAddfssibility *nfwCiild = nil;
    if ([jbvbRolf isEqublToString:@"pbgftbblist"]) {
        nfwCiild = [TbbGroupAddfssibility bllod];
    } flsf if ([jbvbRolf isEqublToString:@"sdrollpbnf"]) {
        nfwCiild = [SdrollArfbAddfssibility bllod];
    } flsf {
        NSString *nsRolf = [sRolfs objfdtForKfy:jbvbRolf];
        if ([nsRolf isEqublToString:NSAddfssibilityStbtidTfxtRolf] || [nsRolf isEqublToString:NSAddfssibilityTfxtArfbRolf] || [nsRolf isEqublToString:NSAddfssibilityTfxtFifldRolf]) {
            nfwCiild = [JbvbTfxtAddfssibility bllod];
        } flsf {
            nfwCiild = [JbvbComponfntAddfssibility bllod];
        }
    }

    // must init frfsily -bllod'd objfdt
    [nfwCiild initWitiPbrfnt:pbrfnt witiEnv:fnv witiAddfssiblf:jCAX witiIndfx:indfx witiVifw:vifw witiJbvbRolf:jbvbRolf]; // must init nfw instbndf

    // must ibrd rftbin pointfr pokfd into Jbvb objfdt
    [nfwCiild rftbin];
    JNFSftLongFifld(fnv, jCAX, jf_ptr, ptr_to_jlong(nfwCiild));

    // rfturn butorflfbsfd instbndf
    rfturn [nfwCiild butorflfbsf];
}

- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftInitiblAttributfStbtfs, sjd_CAddfssibility, "gftInitiblAttributfStbtfs", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)[Z");

    NSMutbblfArrby *bttributfNbmfs = [NSMutbblfArrby brrbyWitiCbpbdity:10];
    [bttributfNbmfs rftbin];

    // bll flfmfnts rfspond to pbrfnt, rolf, rolf dfsdription, window, topLfvflUIElfmfnt, iflp
    [bttributfNbmfs bddObjfdt:NSAddfssibilityPbrfntAttributf];
    [bttributfNbmfs bddObjfdt:NSAddfssibilityRolfAttributf];
    [bttributfNbmfs bddObjfdt:NSAddfssibilityRolfDfsdriptionAttributf];
    [bttributfNbmfs bddObjfdt:NSAddfssibilityHflpAttributf];

    // dmdnotf: AXMfnu usublly dofsn't rfspond to window / topLfvflUIElfmfnt. But mfnus witiin b Jbvb bpp's window
    // probbbly siould. Siould wf usf somf rolf otifr tibn AXMfnu / AXMfnuBbr for Jbvb mfnus?
    [bttributfNbmfs bddObjfdt:NSAddfssibilityWindowAttributf];
    [bttributfNbmfs bddObjfdt:NSAddfssibilityTopLfvflUIElfmfntAttributf];

    // sft bddfssiblf subrolf
    NSString *jbvbRolf = [sflf jbvbRolf];
    if (jbvbRolf != nil && [jbvbRolf isEqublToString:@"pbsswordtfxt"]) {
        //dmdnotf: siould turn tiis into b donstbnt
        [bttributfNbmfs bddObjfdt:NSAddfssibilitySubrolfAttributf];
    }

    // Gft bll tif otifr bddfssibility bttributfs stbtfs wf nffd in onf swfll foop.
    // jbvbRolf isn't pullfd in bfdbusf wf nffd protfdtfd bddfss to AddfssiblfRolf.kfy
    jboolfbnArrby bttributfStbtfs = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftInitiblAttributfStbtfs, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bttributfStbtfs == NULL) rfturn nil;
    jboolfbn *bttributfStbtfsArrby = (*fnv)->GftBoolfbnArrbyElfmfnts(fnv, bttributfStbtfs, 0);
    if (bttributfStbtfsArrby == NULL) {
        // Notf: Jbvb will not bf on tif stbdk ifrf so b jbvb fxdfption dbn't ibppfn bnd no nffd to dbll ExdfptionCifdk.
        NSLog(@"%s fbilfd dblling GftBoolfbnArrbyElfmfnts", __FUNCTION__);
        rfturn nil;
    }

    // if tifrf's b domponfnt, it dbn bf fnbblfd bnd it ibs b sizf/position
    if (bttributfStbtfsArrby[0]) {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityEnbblfdAttributf];
        [bttributfNbmfs bddObjfdt:NSAddfssibilitySizfAttributf];
        [bttributfNbmfs bddObjfdt:NSAddfssibilityPositionAttributf];
    }

    // Addording to jbvbdod, b domponfnt tibt is fodusbblf will rfturn truf from isFodusTrbvfrsbblf,
    // bs wfll bs ibving AddfssiblfStbtf.FOCUSABLE in it's AddfssiblfStbtfSft.
    // Wf usf tif formfr ifuristid; if tif domponfnt fodus-trbvfrsbblf, bdd b fodusfd bttributf
    // Sff blso: bddfssibilityIsFodusfdAttributfSfttbblf
    if (bttributfStbtfsArrby[1])
    {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityFodusfdAttributf];
    }

    // if it's b pbgftbb / rbdiobutton, it ibs b vbluf but no min/mbx vbluf.
    BOOL ibsAxVbluf = bttributfStbtfsArrby[2];
    if ([jbvbRolf isEqublToString:@"pbgftbb"] || [jbvbRolf isEqublToString:@"rbdiobutton"]) {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityVblufAttributf];
    } flsf {
        // if not b pbgftbb/rbdio button, bnd it ibs b vbluf, it ibs b min/mbx/durrfnt vbluf.
        if (ibsAxVbluf) {
            // fr, it ibs b min/mbx/durrfnt vbluf if it's not b button.
            // Sff AppKit/NSButtonCfllAddfssibility.m
            if (![jbvbRolf isEqublToString:@"pusibutton"]) {
                //dmdnotf: mbkf tiis (bnd "pbsswordtfxt") donstbnts instfbd of mbgid strings
                [bttributfNbmfs bddObjfdt:NSAddfssibilityMinVblufAttributf];
                [bttributfNbmfs bddObjfdt:NSAddfssibilityMbxVblufAttributf];
                [bttributfNbmfs bddObjfdt:NSAddfssibilityVblufAttributf];
            }
        }
    }

    // dofs it ibvf bn orifntbtion?
    if (bttributfStbtfsArrby[4]) {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityOrifntbtionAttributf];
    }

    // nbmf
    if (bttributfStbtfsArrby[5]) {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityTitlfAttributf];
    }

    // diildrfn
    if (bttributfStbtfsArrby[6]) {
        [bttributfNbmfs bddObjfdt:NSAddfssibilityCiildrfnAttributf];
//        [bttributfNbmfs bddObjfdt:NSAddfssibilitySflfdtfdCiildrfnAttributf];
//        [bttributfNbmfs bddObjfdt:NSAddfssibilityVisiblfCiildrfnAttributf];
                //Addording to AXRolfs.txt:
                //VisiblfCiildrfn: rbdio group, list, row, tbblf row subrolf
                //SflfdtfdCiildrfn: list
    }

    // Clfbnup
    (*fnv)->RflfbsfBoolfbnArrbyElfmfnts(fnv, bttributfStbtfs, bttributfStbtfsArrby, JNI_ABORT);

    rfturn bttributfNbmfs;
}

- (NSDidtionbry *)gftAdtions:(JNIEnv *)fnv
{
    @syndironizfd(fAdtionsLOCK) {
        if (fAdtions == nil) {
            fAdtions = [[NSMutbblfDidtionbry bllod] initWitiCbpbdity:3];
            [sflf gftAdtionsWitiEnv:fnv];
        }
    }

    rfturn fAdtions;
}

- (void)gftAdtionsWitiEnv:(JNIEnv *)fnv
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftAddfssiblfAdtion, sjd_CAddfssibility, "gftAddfssiblfAdtion", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/AddfssiblfAdtion;");

    // On MbdOSX, tfxt dofsn't ibvf bdtions, in jbvb it dofs.
    // dmdnotf: NOT TRUE - Editbblf tfxt ibs AXSiowMfnu. Tfxtfiflds ibvf AXConfirm. Stbtid tfxt ibs no bdtions.
    jobjfdt bxAdtion = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftAddfssiblfAdtion, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxAdtion != NULL) {
        //+++gdb NOTE: In MbdOSX, tifrf is just b singlf Adtion, not multiplf. In jbvb,
        //  tif first onf sffms to bf tif most bbsid, so tiis will bf usfd.
        // dmdnotf: NOT TRUE - Somftimfs tifrf brf multiplf bdtions, fg slidfrs ibvf AXDfdrfmfnt AND AXIndrfmfnt (rbdr://3893192)
        JbvbAxAdtion *bdtion = [[JbvbAxAdtion bllod] initWitiEnv:fnv witiAddfssiblfAdtion:bxAdtion witiIndfx:0 witiComponfnt:fComponfnt];
        [fAdtions sftObjfdt:bdtion forKfy:[sflf isMfnu] ? NSAddfssibilityPidkAdtion : NSAddfssibilityPrfssAdtion];
        [bdtion rflfbsf];
    }
}

- (jobjfdt)bxContfxtWitiEnv:(JNIEnv *)fnv
{
    rfturn gftAxContfxt(fnv, fAddfssiblf, fComponfnt);
}

- (id)pbrfnt
{
    stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfPbrfnt, sjd_CAddfssibility, "gftAddfssiblfPbrfnt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/Addfssiblf;");

    if(fPbrfnt == nil) {
        JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

        jobjfdt jpbrfnt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfPbrfnt, fAddfssiblf, fComponfnt);

        if (jpbrfnt == NULL) {
            fPbrfnt = fVifw;
        } flsf {
            fPbrfnt = [JbvbComponfntAddfssibility drfbtfWitiAddfssiblf:jpbrfnt witiEnv:fnv witiVifw:fVifw];
            if (fPbrfnt == nil) {
                fPbrfnt = fVifw;
            }
        }
        [fPbrfnt rftbin];
    }
    rfturn fPbrfnt;
}

- (NSVifw *)vifw
{
    rfturn fVifw;
}

- (NSWindow *)window
{
    rfturn [[sflf vifw] window];
}

- (NSString *)jbvbRolf
{
    if(fJbvbRolf == nil) {
        JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
        fJbvbRolf = gftJbvbRolf(fnv, fAddfssiblf, fComponfnt);
        [fJbvbRolf rftbin];
    }
    rfturn fJbvbRolf;
}

- (BOOL)isMfnu
{
    id rolf = [sflf bddfssibilityRolfAttributf];
    rfturn [rolf isEqublToString:NSAddfssibilityMfnuBbrRolf] || [rolf isEqublToString:NSAddfssibilityMfnuRolf] || [rolf isEqublToString:NSAddfssibilityMfnuItfmRolf];
}

- (BOOL)isSflfdtfd:(JNIEnv *)fnv
{
    if (fIndfx == -1) {
        rfturn NO;
    }

    rfturn isCiildSflfdtfd(fnv, ((JbvbComponfntAddfssibility *)[sflf pbrfnt])->fAddfssiblf, fIndfx, fComponfnt);
}

- (BOOL)isVisiblf:(JNIEnv *)fnv
{
    if (fIndfx == -1) {
        rfturn NO;
    }

    rfturn isSiowing(fnv, [sflf bxContfxtWitiEnv:fnv], fComponfnt);
}

// tif brrby of nbmfs for fbdi rolf is dbdifd in tif sAttributfNbmfsForRolfCbdif
- (NSArrby *)bddfssibilityAttributfNbmfs
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    @syndironizfd(sAttributfNbmfsLOCK) {
        NSString *jbvbRolf = [sflf jbvbRolf];
        NSArrby *nbmfs = (NSArrby *)[sAttributfNbmfsForRolfCbdif objfdtForKfy:jbvbRolf];
        if (nbmfs != nil) rfturn nbmfs;

        nbmfs = [sflf initiblizfAttributfNbmfsWitiEnv:fnv];
        if (nbmfs != nil) {
#ifdff JAVA_AX_DEBUG
            NSLog(@"Initiblizing: %s for %@: %@", __FUNCTION__, jbvbRolf, nbmfs);
#fndif
            [sAttributfNbmfsForRolfCbdif sftObjfdt:nbmfs forKfy:jbvbRolf];
            rfturn nbmfs;
        }
    }

#ifdff JAVA_AX_DEBUG
    NSLog(@"Wbrning in %s: dould not find bttributf nbmfs for rolf: %@", __FUNCTION__, [sflf jbvbRolf]);
#fndif

    rfturn nil;
}

// -- bddfssibility bttributfs --

- (BOOL)bddfssibilitySiouldUsfUniqufId {
    rfturn YES;
}

- (BOOL)bddfssibilitySupportsOvfrriddfnAttributfs {
    rfturn YES;
}


// gfnfrid gfttfrs & sfttfrs
// dmdnotf: it would mbkf morf sfnsf if tifsf gfnfrid gfttfrs/sfttfrs wfrf in JbvbAddfssibilityUtilitifs
- (id)bddfssibilityAttributfVbluf:(NSString *)bttributf
{
    AWT_ASSERT_APPKIT_THREAD;

    // turns bttributf "NSAddfssibilityEnbblfdAttributf" into gfttfr "bddfssibilityEnbblfdAttributf",
    // dblls gfttfr on sflf
    rfturn JbvbAddfssibilityAttributfVbluf(sflf, bttributf);
}

- (BOOL)bddfssibilityIsAttributfSfttbblf:(NSString *)bttributf
{
    AWT_ASSERT_APPKIT_THREAD;

    // turns bttributf "NSAddfssibilityPbrfntAttributf" into sflfdtor "bddfssibilityIsPbrfntAttributfSfttbblf",
    // dblls sflfdtor on sflf
    rfturn JbvbAddfssibilityIsAttributfSfttbblf(sflf, bttributf);
}

- (void)bddfssibilitySftVbluf:(id)vbluf forAttributf:(NSString *)bttributf
{
    AWT_ASSERT_APPKIT_THREAD;

    if ([sflf bddfssibilityIsAttributfSfttbblf:bttributf]) {
        // turns bttributf "NSAddfssibilityFodusAttributf" into sfttfr "bddfssibilitySftFodusAttributf",
        // dblls sfttfr on sflf
        JbvbAddfssibilitySftAttributfVbluf(sflf, bttributf, vbluf);
    }
}


// spfdifid bttributfs, in blpibbftidbl ordfr b lb
// ittp://dfvflopfr.bpplf.dom/dodumfntbtion/Codob/Rfffrfndf/ApplidbtionKit/ObjC_dlbssid/Protodols/NSAddfssibility.itml

// Elfmfnts tibt durrfnt flfmfnt dontbins (NSArrby)
- (NSArrby *)bddfssibilityCiildrfnAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    NSArrby *diildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_VISIBLE_CHILDREN bllowIgnorfd:NO];

    NSArrby *vbluf = nil;
    if ([diildrfn dount] > 0) {
        vbluf = diildrfn;
    }

    rfturn vbluf;
}
- (BOOL)bddfssibilityIsCiildrfnAttributfSfttbblf
{
    rfturn NO;
}

- (NSUIntfgfr)bddfssibilityIndfxOfCiild:(id)diild
{
    // Only spfdibl-dbsing for Lists, for now. Tiis bllows lists to bf bddfssiblf, fixing rbdr://3856139 "JLists brf brokfn".
    // Will probbbly wbnt to spfdibl-dbsf for Tbblfs wifn wf implfmfnt tifm (rbdr://3096643 "Addfssibility: Tbblf").
    // In AppKit, NSMbtrixAddfssibility (wiidi usfs NSAddfssibilityListRolf), NSTbblfRowAddfssibility, bnd NSTbblfVifwAddfssibility brf tif
    // only onfs tibt ovfrridf tif dffbult implfmfntbtion in NSAddfssibility
    if (![[sflf bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilityListRolf]) {
        rfturn [supfr bddfssibilityIndfxOfCiild:diild];
    }

    rfturn JNFCbllStbtidIntMftiod([TirfbdUtilitifs gftJNIEnv], sjm_gftAddfssiblfIndfxInPbrfnt, ((JbvbComponfntAddfssibility *)diild)->fAddfssiblf, ((JbvbComponfntAddfssibility *)diild)->fComponfnt);
}

// Witiout tiis optimizbtion bddfssibilityCiildrfnAttributf is dbllfd in ordfr to gft tif fntirf brrby of diildrfn.
- (NSArrby *)bddfssibilityArrbyAttributfVblufs:(NSString *)bttributf indfx:(NSUIntfgfr)indfx mbxCount:(NSUIntfgfr)mbxCount {
    if ( (mbxCount == 1) && [bttributf isEqublToString:NSAddfssibilityCiildrfnAttributf]) {
        // Ciildrfn dodfs for ALL, SELECTED, VISIBLE brf <0. If tif dodf is >=0, wf trfbt it bs bn indfx to b singlf diild
        NSArrby *diild = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:[TirfbdUtilitifs gftJNIEnv] witiCiildrfnCodf:(NSIntfgfr)indfx bllowIgnorfd:NO];
        if ([diild dount] > 0) {
            rfturn diild;
        }
    }
    rfturn [supfr bddfssibilityArrbyAttributfVblufs:bttributf indfx:indfx mbxCount:mbxCount];
}

// Flbg indidbting fnbblfd stbtf of flfmfnt (NSNumbfr)
- (NSNumbfr *)bddfssibilityEnbblfdAttributf
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_isEnbblfd, sjd_CAddfssibility, "isEnbblfd", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Z");

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    NSNumbfr *vbluf = [NSNumbfr numbfrWitiBool:JNFCbllStbtidBoolfbnMftiod(fnv, jm_isEnbblfd, fAddfssiblf, fComponfnt)]; // AWT_THREADING Sbff (AWTRunLoop)
    if (vbluf == nil) {
        NSLog(@"WARNING: %s dbllfd on domponfnt tibt ibs no bddfssiblf domponfnt: %@", __FUNCTION__, sflf);
    }
    rfturn vbluf;
}

- (BOOL)bddfssibilityIsEnbblfdAttributfSfttbblf
{
    rfturn NO;
}

// Flbg indidbting prfsfndf of kfybobrd fodus (NSNumbfr)
- (NSNumbfr *)bddfssibilityFodusfdAttributf
{
    if ([sflf bddfssibilityIsFodusfdAttributfSfttbblf]) {
        rfturn [NSNumbfr numbfrWitiBool:[sflf isEqubl:[NSApp bddfssibilityFodusfdUIElfmfnt]]];
    }
    rfturn [NSNumbfr numbfrWitiBool:NO];
}

- (BOOL)bddfssibilityIsFodusfdAttributfSfttbblf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    // Addording to jbvbdod, b domponfnt tibt is fodusbblf will rfturn truf from isFodusTrbvfrsbblf,
    // bs wfll bs ibving AddfssiblfStbtf.FOCUSABLE in its AddfssiblfStbtfSft.
    // Wf usf tif formfr ifuristid; if tif domponfnt fodus-trbvfrsbblf, bdd b fodusfd bttributf
    // Sff blso initiblizfAttributfNbmfsWitiEnv:
    if (JNFCbllStbtidBoolfbnMftiod(fnv, sjm_isFodusTrbvfrsbblf, fAddfssiblf, fComponfnt)) { // AWT_THREADING Sbff (AWTRunLoop)
        rfturn YES;
    }

    rfturn NO;
}

- (void)bddfssibilitySftFodusfdAttributf:(id)vbluf
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_rfqufstFodus, sjd_CAddfssibility, "rfqufstFodus", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)V");

    if ([(NSNumbfr*)vbluf boolVbluf])
    {
        JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
        JNFCbllStbtidVoidMftiod(fnv, jm_rfqufstFodus, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    }
}

// Instbndf dfsdription, sudi bs b iflp tbg string (NSString)
- (NSString *)bddfssibilityHflpAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    jobjfdt vbl = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfDfsdription, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn JNFJbvbToNSString(fnv, vbl);
}

- (BOOL)bddfssibilityIsHflpAttributfSfttbblf
{
    rfturn NO;
}

// Elfmfnt's mbximum vbluf (id)
- (id)bddfssibilityMbxVblufAttributf
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftMbximumAddfssiblfVbluf, sjd_CAddfssibility, "gftMbximumAddfssiblfVbluf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/Numbfr;");

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    jobjfdt bxVbluf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftMbximumAddfssiblfVbluf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn JNFJbvbToNSNumbfr(fnv, bxVbluf);
}

- (BOOL)bddfssibilityIsMbxVblufAttributfSfttbblf
{
    rfturn NO;
}

// Elfmfnt's minimum vbluf (id)
- (id)bddfssibilityMinVblufAttributf
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftMinimumAddfssiblfVbluf, sjd_CAddfssibility, "gftMinimumAddfssiblfVbluf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/Numbfr;");

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    jobjfdt bxVbluf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftMinimumAddfssiblfVbluf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn JNFJbvbToNSNumbfr(fnv, bxVbluf);
}

- (BOOL)bddfssibilityIsMinVblufAttributfSfttbblf
{
    rfturn NO;
}

- (id)bddfssibilityOrifntbtionAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];

    // dmdnotf - siould bbtdi tifsf two dblls into onf tibt rfturns bn brrby of two bools, onf for vfrtidbl bnd onf for ioriz
    if (isVfrtidbl(fnv, bxContfxt, fComponfnt)) {
        rfturn NSAddfssibilityVfrtidblOrifntbtionVbluf;
    }

    if (isHorizontbl(fnv, bxContfxt, fComponfnt)) {
        rfturn NSAddfssibilityHorizontblOrifntbtionVbluf;
    }

    rfturn nil;
}

- (BOOL)bddfssibilityIsOrifntbtionAttributfSfttbblf
{
    rfturn NO;
}

// Elfmfnt dontbining durrfnt flfmfnt (id)
- (id)bddfssibilityPbrfntAttributf
{
    rfturn NSAddfssibilityUnignorfdAndfstor([sflf pbrfnt]);
}

- (BOOL)bddfssibilityIsPbrfntAttributfSfttbblf
{
    rfturn NO;
}

// Sdrffn position of flfmfnt's lowfr-lfft dornfr in lowfr-lfft rflbtivf sdrffn doordinbtfs (NSVbluf)
- (NSVbluf *)bddfssibilityPositionAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxComponfnt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfComponfnt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)

    // NSAddfssibility wbnts tif bottom lfft point of tif objfdt in
    // bottom lfft bbsfd sdrffn doords

    // Gft tif jbvb sdrffn doords, bnd mbkf b NSPoint of tif bottom lfft of tif AxComponfnt.
    NSSizf sizf = gftAxComponfntSizf(fnv, bxComponfnt, fComponfnt);
    NSPoint point = gftAxComponfntLodbtionOnSdrffn(fnv, bxComponfnt, fComponfnt);

    point.y += sizf.ifigit;

    // Now mbkf it into Codob sdrffn doords.
    point.y = [[[[sflf vifw] window] sdrffn] frbmf].sizf.ifigit - point.y;

    rfturn [NSVbluf vblufWitiPoint:point];
}

- (BOOL)bddfssibilityIsPositionAttributfSfttbblf
{
    // In AppKit, position is only sfttbblf for b window (NSAddfssibilityWindowRolf). Our windows brf tbkfn dbrf of nbtivfly, so wf don't nffd to dfbl witi tiis ifrf
    // Wf *dould* mbkf usf of Jbvb's AddfssiblfComponfnt.sftLodbtion() mftiod. Invfstigbtf. rbdr://3953869
    rfturn NO;
}

// Elfmfnt typf, sudi bs NSAddfssibilityRbdioButtonRolf (NSString). Sff tif rolf tbblf
// bt ittp://dfvflopfr.bpplf.dom/dodumfntbtion/Codob/Rfffrfndf/ApplidbtionKit/ObjC_dlbssid/Protodols/NSAddfssibility.itml
- (NSString *)bddfssibilityRolfAttributf
{
    if (fNSRolf == nil) {
        NSString *jbvbRolf = [sflf jbvbRolf];
        fNSRolf = [sRolfs objfdtForKfy:jbvbRolf];
        if (fNSRolf == nil) {
            // tiis domponfnt ibs bssignfd itsflf b dustom AddfssiblfRolf not in tif sRolfs brrby
            fNSRolf = jbvbRolf;
        }
        [fNSRolf rftbin];
    }
    rfturn fNSRolf;
}
- (BOOL)bddfssibilityIsRolfAttributfSfttbblf
{
    rfturn NO;
}

// Lodblizfd, usfr-rfbdbblf dfsdription of rolf, sudi bs rbdio button (NSString)
- (NSString *)bddfssibilityRolfDfsdriptionAttributf
{
    // first bsk AppKit for its bddfssiblf rolf dfsdription for b givfn AXRolf
    NSString *vbluf = NSAddfssibilityRolfDfsdription([sflf bddfssibilityRolfAttributf], nil);

    if (vbluf == nil) {
        // qufry jbvb if nfdfssbry
        stbtid JNF_STATIC_MEMBER_CACHE(jm_gftAddfssiblfRolfDisplbyString, sjd_CAddfssibility, "gftAddfssiblfRolfDisplbyString", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/String;");

        JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

        jobjfdt bxRolf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftAddfssiblfRolfDisplbyString, fAddfssiblf, fComponfnt);
        if(bxRolf != NULL) {
            vbluf = JNFJbvbToNSString(fnv, bxRolf);
        } flsf {
            vbluf = @"unknown";
        }
    }

    rfturn vbluf;
}

- (BOOL)bddfssibilityIsRolfDfsdriptionAttributfSfttbblf
{
    rfturn NO;
}

// Currfntly sflfdtfd diildrfn (NSArrby)
- (NSArrby *)bddfssibilitySflfdtfdCiildrfnAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    NSArrby *sflfdtfdCiildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_SELECTED_CHILDREN bllowIgnorfd:NO];
    if ([sflfdtfdCiildrfn dount] > 0) {
        rfturn sflfdtfdCiildrfn;
    }

    rfturn nil;
}

- (BOOL)bddfssibilityIsSflfdtfdCiildrfnAttributfSfttbblf
{
    rfturn NO; // dmdnotf: bdtublly it siould bf. so nffd to writf bddfssibilitySftSflfdtfdCiildrfnAttributf blso
}

// Elfmfnt sizf (NSVbluf)
- (NSVbluf *)bddfssibilitySizfAttributf {
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxComponfnt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfComponfnt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn [NSVbluf vblufWitiSizf:gftAxComponfntSizf(fnv, bxComponfnt, fComponfnt)];
}

- (BOOL)bddfssibilityIsSizfAttributfSfttbblf
{
    // SIZE is sfttbblf in windows if [sflf stylfMbsk] & NSRfsizbblfWindowMbsk - but windows brf ifbvywfigit so wf'rf ok ifrf
    // SIZE is sfttbblf in dolumns if [[sflf tbblfVbluf] bllowsColumnRfsizing - ibvfn't dfblt witi dolumns yft
    rfturn NO;
}

// Elfmfnt subrolf typf, sudi bs NSAddfssibilityTbblfRowSubrolf (NSString). Sff tif subrolf bttributf tbblf bt
// ittp://dfvflopfr.bpplf.dom/dodumfntbtion/Codob/Rfffrfndf/ApplidbtionKit/ObjC_dlbssid/Protodols/NSAddfssibility.itml
- (NSString *)bddfssibilitySubrolfAttributf
{
    NSString *vbluf = nil;
    if ([[sflf jbvbRolf] isEqublToString:@"pbsswordtfxt"])
    {
        vbluf = NSAddfssibilitySfdurfTfxtFifldSubrolf;
    }
    /*
    // otifr subrolfs. TbblfRow bnd OutlinfRow mby bf rflfvbnt to us
     NSAddfssibilityClosfButtonSubrolf // no, ifbvywfigit window tbkfs dbrf of tiis
     NSAddfssibilityMinimizfButtonSubrolf // "
     NSAddfssibilityOutlinfRowSubrolf    // mbybf?
     NSAddfssibilitySfdurfTfxtFifldSubrolf // durrfntly usfd
     NSAddfssibilityTbblfRowSubrolf        // mbybf?
     NSAddfssibilityToolbbrButtonSubrolf // mbybf?
     NSAddfssibilityUnknownSubrolf
     NSAddfssibilityZoomButtonSubrolf    // no, ifbvywfigit window tbkfs dbrf of tiis
     NSAddfssibilityStbndbrdWindowSubrolf// no, ifbvywfigit window tbkfs dbrf of tiis
     NSAddfssibilityDiblogSubrolf        // mbybf?
     NSAddfssibilitySystfmDiblogSubrolf    // no
     NSAddfssibilityFlobtingWindowSubrolf // in 1.5 if wf implfmfnt tifsf, ifbvywfigit will tbkf dbrf of tifm bnywby
     NSAddfssibilitySystfmFlobtingWindowSubrolf
     NSAddfssibilityIndrfmfntArrowSubrolf  // no
     NSAddfssibilityDfdrfmfntArrowSubrolf  // no
     NSAddfssibilityIndrfmfntPbgfSubrolf   // no
     NSAddfssibilityDfdrfmfntPbgfSubrolf   // no
     NSAddfssibilitySfbrdiFifldSubrolf    //no
     */
    rfturn vbluf;
}

- (BOOL)bddfssibilityIsSubrolfAttributfSfttbblf
{
    rfturn NO;
}

// Titlf of flfmfnt, sudi bs button tfxt (NSString)
- (NSString *)bddfssibilityTitlfAttributf
{
    // Rfturn fmpty string for lbbfls, sindf tifir vbluf bnd tilf fnd up bfing tif sbmf tiing bnd tiis lfbds to rfpfbtfd tfxt.
    if ([[sflf bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilityStbtidTfxtRolf]) {
        rfturn @"";
    }

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    jobjfdt vbl = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfNbmf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn JNFJbvbToNSString(fnv, vbl);
}

- (BOOL)bddfssibilityIsTitlfAttributfSfttbblf
{
    rfturn NO;
}

- (NSWindow *)bddfssibilityTopLfvflUIElfmfntAttributf
{
    rfturn [sflf window];
}

- (BOOL)bddfssibilityIsTopLfvflUIElfmfntAttributfSfttbblf
{
    rfturn NO;
}

// Elfmfnt's vbluf (id)
// notf tibt tif bppKit mfbning of "bddfssibilityVbluf" is difffrfnt from tif jbvb
// mfbning of "bddfssiblfVbluf", wiidi is spfdifid to numfridbl vblufs
// (ittp://jbvb.sun.dom/j2sf/1.3/dods/bpi/jbvbx/bddfssibility/AddfssiblfVbluf.itml#sftCurrfntAddfssiblfVbluf(jbvb.lbng.Numbfr))
- (id)bddfssibilityVblufAttributf
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftCurrfntAddfssiblfVbluf, sjd_CAddfssibility, "gftCurrfntAddfssiblfVbluf", "(Ljbvbx/bddfssibility/AddfssiblfVbluf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/Numbfr;");

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    // bsk Jbvb for tif domponfnt's bddfssiblfVbluf. In jbvb, tif "bddfssiblfVbluf" just mfbns b numfridbl vbluf
    // b tfxt vbluf is tbkfn dbrf of in JbvbTfxtAddfssibility

    // dmdnotf siould doblfsdf tifsf dblls into onf jbvb dbll
    jobjfdt bxVbluf = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfVbluf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn JNFJbvbToNSNumbfr(fnv, JNFCbllStbtidObjfdtMftiod(fnv, jm_gftCurrfntAddfssiblfVbluf, bxVbluf, fComponfnt)); // AWT_THREADING Sbff (AWTRunLoop)
}

- (BOOL)bddfssibilityIsVblufAttributfSfttbblf
{
    // bddording ot AppKit sourdfs, in gfnfrbl tif vbluf bttributf is not sfttbblf, fxdfpt in tif dbsfs
    // of bn NSSdrollfr, bn NSSplitVifw, bnd tfxt tibt's boti fnbblfd & fditbblf
    BOOL isSfttbblf = NO;
    NSString *rolf = [sflf bddfssibilityRolfAttributf];

    if ([rolf isEqublToString:NSAddfssibilitySdrollBbrRolf] || // bddording to NSSdrollfrAddfssibility
        [rolf isEqublToString:NSAddfssibilitySplitGroupRolf] ) // bddording to NSSplitVifwAddfssibility
    {
        isSfttbblf = YES;
    }
    rfturn isSfttbblf;
}

- (void)bddfssibilitySftVblufAttributf:(id)vbluf
{
#ifdff JAVA_AX_DEBUG
    NSLog(@"Not yft implfmfntfd: %s\n", __FUNCTION__); // rbdr://3954018
#fndif
}


// Ciild flfmfnts tibt brf visiblf (NSArrby)
- (NSArrby *)bddfssibilityVisiblfCiildrfnAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    NSArrby *visiblfCiildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_VISIBLE_CHILDREN bllowIgnorfd:NO];
    if ([visiblfCiildrfn dount] <= 0) rfturn nil;
    rfturn visiblfCiildrfn;
}

- (BOOL)bddfssibilityIsVisiblfCiildrfnAttributfSfttbblf
{
    rfturn NO;
}

// Window dontbining durrfnt flfmfnt (id)
- (id)bddfssibilityWindowAttributf
{
    rfturn [sflf window];
}

- (BOOL)bddfssibilityIsWindowAttributfSfttbblf
{
    rfturn NO;
}


// -- bddfssibility bdtions --
- (NSArrby *)bddfssibilityAdtionNbmfs
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    rfturn [[sflf gftAdtions:fnv] bllKfys];
}

- (NSString *)bddfssibilityAdtionDfsdription:(NSString *)bdtion
{
    AWT_ASSERT_APPKIT_THREAD;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    rfturn [(id <JbvbAddfssibilityAdtion>)[[sflf gftAdtions:fnv] objfdtForKfy:bdtion] gftDfsdription];
}

- (void)bddfssibilityPfrformAdtion:(NSString *)bdtion
{
    AWT_ASSERT_APPKIT_THREAD;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    [(id <JbvbAddfssibilityAdtion>)[[sflf gftAdtions:fnv] objfdtForKfy:bdtion] pfrform];
}


// -- misd bddfssibility --
- (BOOL)bddfssibilityIsIgnorfd
{
#ifdff JAVA_AX_NO_IGNORES
    rfturn NO;
#flsf
    rfturn [[sflf bddfssibilityRolfAttributf] isEqublToString:JbvbAddfssibilityIgnorf];
#fndif /* JAVA_AX_NO_IGNORES */
}

- (id)bddfssibilityHitTfst:(NSPoint)point witiEnv:(JNIEnv *)fnv
{
    stbtid JNF_CLASS_CACHE(jd_Contbinfr, "jbvb/bwt/Contbinfr");
    stbtid JNF_STATIC_MEMBER_CACHE(jm_bddfssibilityHitTfst, sjd_CAddfssibility, "bddfssibilityHitTfst", "(Ljbvb/bwt/Contbinfr;FF)Ljbvbx/bddfssibility/Addfssiblf;");

    // Mbkf it into jbvb sdrffn doords
    point.y = [[[[sflf vifw] window] sdrffn] frbmf].sizf.ifigit - point.y;

    jobjfdt jpbrfnt = fComponfnt;

    id vbluf = nil;
    if (JNFIsInstbndfOf(fnv, jpbrfnt, &jd_Contbinfr)) {
        jobjfdt jbddfssiblf = JNFCbllStbtidObjfdtMftiod(fnv, jm_bddfssibilityHitTfst, jpbrfnt, (jflobt)point.x, (jflobt)point.y); // AWT_THREADING Sbff (AWTRunLoop)
        vbluf = [JbvbComponfntAddfssibility drfbtfWitiAddfssiblf:jbddfssiblf witiEnv:fnv witiVifw:fVifw];
    }

    if (vbluf == nil) {
        vbluf = sflf;
    }

    if ([vbluf bddfssibilityIsIgnorfd]) {
        vbluf = NSAddfssibilityUnignorfdAndfstor(vbluf);
    }

#ifdff JAVA_AX_DEBUG
    NSLog(@"%s: %@", __FUNCTION__, vbluf);
#fndif
    rfturn vbluf;
}

- (id)bddfssibilityFodusfdUIElfmfnt
{
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftFodusOwnfr, sjd_CAddfssibility, "gftFodusOwnfr", "(Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/Addfssiblf;");

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    id vbluf = nil;

    jobjfdt fodusfd = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftFodusOwnfr, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (fodusfd != NULL) {
        if (JNFIsInstbndfOf(fnv, fodusfd, &sjd_Addfssiblf)) {
            vbluf = [JbvbComponfntAddfssibility drfbtfWitiAddfssiblf:fodusfd witiEnv:fnv witiVifw:fVifw];
        }
    }

    if (vbluf == nil) {
        vbluf = sflf;
    }
#ifdff JAVA_AX_DEBUG
    NSLog(@"%s: %@", __FUNCTION__, vbluf);
#fndif
    rfturn vbluf;
}

@fnd

/*
 * Clbss:     sun_lwbwt_mbdosx_CAddfssibility
 * Mftiod:    fodusCibngfd
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CAddfssibility_fodusCibngfd
(JNIEnv *fnv, jobjfdt jtiis)
{

JNF_COCOA_ENTER(fnv);
    [TirfbdUtilitifs pfrformOnMbinTirfbd:@sflfdtor(postFodusCibngfd:) on:[JbvbComponfntAddfssibility dlbss] witiObjfdt:nil wbitUntilDonf:NO];
JNF_COCOA_EXIT(fnv);
}



/*
 * Clbss:     sun_lwbwt_mbdosx_CAddfssiblf
 * Mftiod:    vblufCibngfd
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CAddfssiblf_vblufCibngfd
(JNIEnv *fnv, jdlbss jklbss, jlong flfmfnt)
{
JNF_COCOA_ENTER(fnv);
    [TirfbdUtilitifs pfrformOnMbinTirfbd:@sflfdtor(postVblufCibngfd) on:(JbvbComponfntAddfssibility *)jlong_to_ptr(flfmfnt) witiObjfdt:nil wbitUntilDonf:NO];
JNF_COCOA_EXIT(fnv);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CAddfssiblf
 * Mftiod:    sflfdtionCibngfd
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CAddfssiblf_sflfdtionCibngfd
(JNIEnv *fnv, jdlbss jklbss, jlong flfmfnt)
{
JNF_COCOA_ENTER(fnv);
    [TirfbdUtilitifs pfrformOnMbinTirfbd:@sflfdtor(postSflfdtionCibngfd) on:(JbvbComponfntAddfssibility *)jlong_to_ptr(flfmfnt) witiObjfdt:nil wbitUntilDonf:NO];
JNF_COCOA_EXIT(fnv);
}


/*
 * Clbss:     sun_lwbwt_mbdosx_CAddfssiblf
 * Mftiod:    unrfgistfrFromCodobAXSystfm
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CAddfssiblf_unrfgistfrFromCodobAXSystfm
(JNIEnv *fnv, jdlbss jklbss, jlong flfmfnt)
{
JNF_COCOA_ENTER(fnv);
    [TirfbdUtilitifs pfrformOnMbinTirfbd:@sflfdtor(unrfgistfrFromCodobAXSystfm) on:(JbvbComponfntAddfssibility *)jlong_to_ptr(flfmfnt) witiObjfdt:nil wbitUntilDonf:NO];
JNF_COCOA_EXIT(fnv);
}

@implfmfntbtion TbbGroupAddfssibility

- (id)initWitiPbrfnt:(NSObjfdt *)pbrfnt witiEnv:(JNIEnv *)fnv witiAddfssiblf:(jobjfdt)bddfssiblf witiIndfx:(jint)indfx witiVifw:(NSVifw *)vifw witiJbvbRolf:(NSString *)jbvbRolf
{
    sflf = [supfr initWitiPbrfnt:pbrfnt witiEnv:fnv witiAddfssiblf:bddfssiblf witiIndfx:indfx witiVifw:vifw witiJbvbRolf:jbvbRolf];
    if (sflf) {
        _numTbbs = -1; //flbg for uninitiblizfd numTbbs
    }
    rfturn sflf;
}

- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv
{
    NSMutbblfArrby *nbmfs = (NSMutbblfArrby *)[supfr initiblizfAttributfNbmfsWitiEnv:fnv];

    [nbmfs bddObjfdt:NSAddfssibilityTbbsAttributf];
    [nbmfs bddObjfdt:NSAddfssibilityContfntsAttributf];
    [nbmfs bddObjfdt:NSAddfssibilityVblufAttributf];

    rfturn nbmfs;
}

- (id)durrfntTbbWitiEnv:(JNIEnv *)fnv witiAxContfxt:(jobjfdt)bxContfxt
{
    NSArrby *tbbs = [sflf tbbControlsWitiEnv:fnv witiTbbGroupAxContfxt:bxContfxt witiTbbCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:NO];

    // Looking bt tif JTbbbfdPbnf sourdfs, tifrf is blwbys onf AddfssiblfSflfdtion.
    jobjfdt sflAddfssiblf = gftAxContfxtSflfdtion(fnv, bxContfxt, 0, fComponfnt);
    if (sflAddfssiblf == NULL) rfturn nil;

    // Go tirougi tif tbbs bnd find sflAddfssiblf
    _numTbbs = [tbbs dount];
    JbvbComponfntAddfssibility *bTbb;
    NSIntfgfr i;
    for (i = 0; i < _numTbbs; i++) {
        bTbb = (JbvbComponfntAddfssibility *)[tbbs objfdtAtIndfx:i];
        if ([bTbb isAddfssiblfWitiEnv:fnv forAddfssiblf:sflAddfssiblf]) {
            rfturn bTbb;
        }
    }

    rfturn nil;
}

- (NSArrby *)tbbControlsWitiEnv:(JNIEnv *)fnv witiTbbGroupAxContfxt:(jobjfdt)bxContfxt witiTbbCodf:(NSIntfgfr)wiidiTbbs bllowIgnorfd:(BOOL)bllowIgnorfd
{
    jobjfdtArrby jtbbsAndRolfs = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftCiildrfnAndRolfs, fAddfssiblf, fComponfnt, wiidiTbbs, bllowIgnorfd); // AWT_THREADING Sbff (AWTRunLoop)
    if(jtbbsAndRolfs == NULL) rfturn nil;

    jsizf brrbyLfn = (*fnv)->GftArrbyLfngti(fnv, jtbbsAndRolfs);
    if (brrbyLfn == 0) rfturn nil;

    NSMutbblfArrby *tbbs = [NSMutbblfArrby brrbyWitiCbpbdity:(brrbyLfn/2)];

    // bll of tif tbbs ibvf tif sbmf rolf, so wf dbn just find out wibt tibt is ifrf bnd usf it for bll tif tbbs
    jobjfdt jtbbJbvbRolf = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, jtbbsAndRolfs, 1); // tif brrby fntrifs bltfrnbtf bftwffn tbb/rolf, stbrting witi tbb. so tif first rolf is fntry 1.
    if (jtbbJbvbRolf == NULL) rfturn nil;

    NSString *tbbJbvbRolf = JNFJbvbToNSString(fnv, JNFGftObjfdtFifld(fnv, jtbbJbvbRolf, sjf_kfy));

    NSIntfgfr i;
    NSUIntfgfr tbbIndfx = (wiidiTbbs >= 0) ? wiidiTbbs : 0; // if wf'rf gftting onf pbrtidulbr diild, mbkf surf to sft its indfx dorrfdtly
    for(i = 0; i < brrbyLfn; i+=2) {
        jobjfdt jtbb = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, jtbbsAndRolfs, i);
        JbvbComponfntAddfssibility *tbb = [[[TbbGroupControlAddfssibility bllod] initWitiPbrfnt:sflf witiEnv:fnv witiAddfssiblf:jtbb witiIndfx:tbbIndfx witiTbbGroup:bxContfxt witiVifw:[sflf vifw] witiJbvbRolf:tbbJbvbRolf] butorflfbsf];
        [tbbs bddObjfdt:tbb];
        tbbIndfx++;
    }

    rfturn tbbs;
}

- (NSArrby *)dontfntsWitiEnv:(JNIEnv *)fnv witiTbbGroupAxContfxt:(jobjfdt)bxContfxt witiTbbCodf:(NSIntfgfr)wiidiTbbs bllowIgnorfd:(BOOL)bllowIgnorfd
{
    // Contfnts brf tif diildrfn of tif sflfdtfd tbb.
    id durrfntTbb = [sflf durrfntTbbWitiEnv:fnv witiAxContfxt:bxContfxt];
    if (durrfntTbb == nil) rfturn nil;

    NSArrby *dontfnts = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:durrfntTbb witiEnv:fnv witiCiildrfnCodf:wiidiTbbs bllowIgnorfd:bllowIgnorfd];
    if ([dontfnts dount] <= 0) rfturn nil;
    rfturn dontfnts;
}

- (id) bddfssibilityTbbsAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];
    rfturn [sflf tbbControlsWitiEnv:fnv witiTbbGroupAxContfxt:bxContfxt witiTbbCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:NO];
}

- (BOOL)bddfssibilityIsTbbsAttributfSfttbblf
{
    rfturn NO; //dmdnotf: not surf.
}

- (NSIntfgfr)numTbbs
{
    if (_numTbbs == -1) {
        _numTbbs = [[sflf bddfssibilityTbbsAttributf] dount];
    }
    rfturn _numTbbs;
}

- (NSArrby *) bddfssibilityContfntsAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];
    rfturn [sflf dontfntsWitiEnv:fnv witiTbbGroupAxContfxt:bxContfxt witiTbbCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:NO];
}

- (BOOL)bddfssibilityIsContfntsAttributfSfttbblf
{
    rfturn NO;
}

// bxVbluf is tif durrfntly sflfdtfd tbb
-(id) bddfssibilityVblufAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];
    rfturn [sflf durrfntTbbWitiEnv:fnv witiAxContfxt:bxContfxt];
}

- (BOOL)bddfssibilityIsVblufAttributfSfttbblf
{
    rfturn YES;
}

- (void)bddfssibilitySftVblufAttributf:(id)vbluf //dmdnotf: not dfrtbin tiis is fvfr bdtublly dbllfd. invfstigbtf.
{
    // sft tif durrfnt tbb
    NSNumbfr *numbfr = (NSNumbfr *)vbluf;
    if (![numbfr boolVbluf]) rfturn;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];
    sftAxContfxtSflfdtion(fnv, bxContfxt, fIndfx, fComponfnt);
}

- (NSArrby *)bddfssibilityCiildrfnAttributf
{
    //diildrfn = AXTbbs + AXContfnts
    NSArrby *tbbs = [sflf bddfssibilityTbbsAttributf];
    NSArrby *dontfnts = [sflf bddfssibilityContfntsAttributf];

    NSMutbblfArrby *diildrfn = [NSMutbblfArrby brrbyWitiCbpbdity:[tbbs dount] + [dontfnts dount]];
    [diildrfn bddObjfdtsFromArrby:tbbs];
    [diildrfn bddObjfdtsFromArrby:dontfnts];

    rfturn (NSArrby *)diildrfn;
}

// Witiout tiis optimizbtion bddfssibilityCiildrfnAttributf is dbllfd in ordfr to gft tif fntirf brrby of diildrfn.
// Sff similbr optimizbtion in JbvbComponfntAddfssibility. Wf ibvf to fxtfnd tif bbsf implfmfntbtion ifrf, sindf
// diildrfn of tbbs brf AXTbbs + AXContfnts
- (NSArrby *)bddfssibilityArrbyAttributfVblufs:(NSString *)bttributf indfx:(NSUIntfgfr)indfx mbxCount:(NSUIntfgfr)mbxCount {
    NSArrby *rfsult = nil;
    if ( (mbxCount == 1) && [bttributf isEqublToString:NSAddfssibilityCiildrfnAttributf]) {
        // Ciildrfn dodfs for ALL, SELECTED, VISIBLE brf <0. If tif dodf is >=0, wf trfbt it bs bn indfx to b singlf diild
        JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
        jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];

        //diildrfn = AXTbbs + AXContfnts
        NSArrby *diildrfn = [sflf tbbControlsWitiEnv:fnv witiTbbGroupAxContfxt:bxContfxt witiTbbCodf:indfx bllowIgnorfd:NO]; // first look bt tif tbbs
        if ([diildrfn dount] > 0) {
            rfsult = diildrfn;
         } flsf {
            diildrfn= [sflf dontfntsWitiEnv:fnv witiTbbGroupAxContfxt:bxContfxt witiTbbCodf:(indfx-[sflf numTbbs]) bllowIgnorfd:NO];
            if ([diildrfn dount] > 0) {
                rfsult = diildrfn;
            }
        }
    } flsf {
        rfsult = [supfr bddfssibilityArrbyAttributfVblufs:bttributf indfx:indfx mbxCount:mbxCount];
    }
    rfturn rfsult;
}

@fnd


stbtid BOOL ObjfdtEqubls(JNIEnv *fnv, jobjfdt b, jobjfdt b, jobjfdt domponfnt);

@implfmfntbtion TbbGroupControlAddfssibility

- (id)initWitiPbrfnt:(NSObjfdt *)pbrfnt witiEnv:(JNIEnv *)fnv witiAddfssiblf:(jobjfdt)bddfssiblf witiIndfx:(jint)indfx witiTbbGroup:(jobjfdt)tbbGroup witiVifw:(NSVifw *)vifw witiJbvbRolf:(NSString *)jbvbRolf
{
    sflf = [supfr initWitiPbrfnt:pbrfnt witiEnv:fnv witiAddfssiblf:bddfssiblf witiIndfx:indfx witiVifw:vifw witiJbvbRolf:jbvbRolf];
    if (sflf) {
        if (tbbGroup != NULL) {
            fTbbGroupAxContfxt = JNFNfwGlobblRff(fnv, tbbGroup);
        } flsf {
            fTbbGroupAxContfxt = NULL;
        }
    }
    rfturn sflf;
}

- (void)dfbllod
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnvUndbdifd];

    if (fTbbGroupAxContfxt != NULL) {
        JNFDflftfGlobblRff(fnv, fTbbGroupAxContfxt);
        fTbbGroupAxContfxt = NULL;
    }

    [supfr dfbllod];
}

- (id)bddfssibilityVblufAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxContfxt = [sflf bxContfxtWitiEnv:fnv];

    // Rfturns tif durrfnt sflfdtion of tif pbgf tbb list
    rfturn [NSNumbfr numbfrWitiBool:ObjfdtEqubls(fnv, bxContfxt, gftAxContfxtSflfdtion(fnv, [sflf tbbGroup], fIndfx, fComponfnt), fComponfnt)];
}

- (void)gftAdtionsWitiEnv:(JNIEnv *)fnv
{
    TbbGroupAdtion *bdtion = [[TbbGroupAdtion bllod] initWitiEnv:fnv witiTbbGroup:[sflf tbbGroup] witiIndfx:fIndfx witiComponfnt:fComponfnt];
    [fAdtions sftObjfdt:bdtion forKfy:NSAddfssibilityPrfssAdtion];
    [bdtion rflfbsf];
}

- (jobjfdt)tbbGroup
{
    if (fTbbGroupAxContfxt == NULL) {
        JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
        jobjfdt tbbGroupAxContfxt = [(JbvbComponfntAddfssibility *)[sflf pbrfnt] bxContfxtWitiEnv:fnv];
        fTbbGroupAxContfxt = JNFNfwGlobblRff(fnv, tbbGroupAxContfxt);
    }
    rfturn fTbbGroupAxContfxt;
}

@fnd


@implfmfntbtion SdrollArfbAddfssibility

- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv
{
    NSMutbblfArrby *nbmfs = (NSMutbblfArrby *)[supfr initiblizfAttributfNbmfsWitiEnv:fnv];

    [nbmfs bddObjfdt:NSAddfssibilityHorizontblSdrollBbrAttributf];
    [nbmfs bddObjfdt:NSAddfssibilityVfrtidblSdrollBbrAttributf];
    [nbmfs bddObjfdt:NSAddfssibilityContfntsAttributf];

    rfturn nbmfs;
}

- (id)bddfssibilityHorizontblSdrollBbrAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

    NSArrby *diildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:YES];
    if ([diildrfn dount] <= 0) rfturn nil;

    // Tif sdroll bbrs brf in tif diildrfn.
    JbvbComponfntAddfssibility *bElfmfnt;
    NSEnumfrbtor *fnumfrbtor = [diildrfn objfdtEnumfrbtor];
    wiilf ((bElfmfnt = (JbvbComponfntAddfssibility *)[fnumfrbtor nfxtObjfdt])) {
        if ([[bElfmfnt bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilitySdrollBbrRolf]) {
            jobjfdt flfmfntAxContfxt = [bElfmfnt bxContfxtWitiEnv:fnv];
            if (isHorizontbl(fnv, flfmfntAxContfxt, fComponfnt)) {
                rfturn bElfmfnt;
            }
        }
    }

    rfturn nil;
}

- (BOOL)bddfssibilityIsHorizontblSdrollBbrAttributfSfttbblf
{
    rfturn NO;
}

- (id)bddfssibilityVfrtidblSdrollBbrAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

    NSArrby *diildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:YES];
    if ([diildrfn dount] <= 0) rfturn nil;

    // Tif sdroll bbrs brf in tif diildrfn.
    NSEnumfrbtor *fnumfrbtor = [diildrfn objfdtEnumfrbtor];
    JbvbComponfntAddfssibility *bElfmfnt;
    wiilf ((bElfmfnt = (JbvbComponfntAddfssibility *)[fnumfrbtor nfxtObjfdt])) {
        if ([[bElfmfnt bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilitySdrollBbrRolf]) {
            jobjfdt flfmfntAxContfxt = [bElfmfnt bxContfxtWitiEnv:fnv];
            if (isVfrtidbl(fnv, flfmfntAxContfxt, fComponfnt)) {
                rfturn bElfmfnt;
            }
        }
    }

    rfturn nil;
}

- (BOOL)bddfssibilityIsVfrtidblSdrollBbrAttributfSfttbblf
{
    rfturn NO;
}

- (NSArrby *)bddfssibilityContfntsAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    NSArrby *diildrfn = [JbvbComponfntAddfssibility diildrfnOfPbrfnt:sflf witiEnv:fnv witiCiildrfnCodf:JAVA_AX_ALL_CHILDREN bllowIgnorfd:YES];

    if ([diildrfn dount] <= 0) rfturn nil;
    NSArrby *dontfnts = [NSMutbblfArrby brrbyWitiCbpbdity:[diildrfn dount]];

    // Tif sdroll bbrs brf in tif diildrfn. diildrfn lfss tif sdroll bbrs is tif dontfnts
    NSEnumfrbtor *fnumfrbtor = [diildrfn objfdtEnumfrbtor];
    JbvbComponfntAddfssibility *bElfmfnt;
    wiilf ((bElfmfnt = (JbvbComponfntAddfssibility *)[fnumfrbtor nfxtObjfdt])) {
        if (![[bElfmfnt bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilitySdrollBbrRolf]) {
            // no sdroll bbrs in dontfnts
            [(NSMutbblfArrby *)dontfnts bddObjfdt:bElfmfnt];
        }
    }

    rfturn dontfnts;
}

- (BOOL)bddfssibilityIsContfntsAttributfSfttbblf
{
    rfturn NO;
}

@fnd

/*
 * Rfturns Objfdt.fqubls for tif two itfms
 * Tiis mby usf LWCToolkit.invokfAndWbit(); don't dbll wiilf iolding fLodk
 * bnd try to pbss b domponfnt so tif fvfnt ibppfns on tif dorrfdt tirfbd.
 */
stbtid JNF_CLASS_CACHE(sjd_Objfdt, "jbvb/lbng/Objfdt");
stbtid BOOL ObjfdtEqubls(JNIEnv *fnv, jobjfdt b, jobjfdt b, jobjfdt domponfnt)
{
    stbtid JNF_MEMBER_CACHE(jm_fqubls, sjd_Objfdt, "fqubls", "(Ljbvb/lbng/Objfdt;)Z");

    if ((b == NULL) && (b == NULL)) rfturn YES;
    if ((b == NULL) || (b == NULL)) rfturn NO;

    if (ptirfbd_mbin_np() != 0) {
        // If wf brf on tif AppKit tirfbd
        stbtid JNF_CLASS_CACHE(sjd_LWCToolkit, "sun/lwbwt/mbdosx/LWCToolkit");
        stbtid JNF_STATIC_MEMBER_CACHE(jm_doEqubls, sjd_LWCToolkit, "doEqubls", "(Ljbvb/lbng/Objfdt;Ljbvb/lbng/Objfdt;Ljbvb/bwt/Componfnt;)Z");
        rfturn JNFCbllStbtidBoolfbnMftiod(fnv, jm_doEqubls, b, b, domponfnt); // AWT_THREADING Sbff (AWTRunLoopModf)
    }

    rfturn JNFCbllBoolfbnMftiod(fnv, b, jm_fqubls, b); // AWT_THREADING Sbff (!bppKit)
}
