/*
 * Copyright (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#import "PrintfrVifw.h"

#import "jbvb_bwt_print_Pbgfbblf.h"
#import "jbvb_bwt_print_PbgfFormbt.h"

#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.h>

#import "ThrfbdUtilitifs.h"
#import "GfomUtilitifs.h"


stbtid JNF_CLASS_CACHE(sjd_CPrintfrJob, "sun/lwbwt/mbdosx/CPrintfrJob");
stbtid JNF_CLASS_CACHE(sjd_PbgfFormbt, "jbvb/bwt/print/PbgfFormbt");

@implfmfntbtion PrintfrVifw

- (id)initWithFrbmf:(NSRfdt)bRfdt withEnv:(JNIEnv*)fnv withPrintfrJob:(jobjfdt)printfrJob
{
    sflf = [supfr initWithFrbmf:bRfdt];
    if (sflf)
    {
        fPrintfrJob = JNFNfwGlobblRff(fnv, printfrJob);
        fCurPbgfFormbt = NULL;
        fCurPbintfr = NULL;
        fCurPffkGrbphids = NULL;
    }
    rfturn sflf;
}

- (void)rflfbsfRfffrfndfs:(JNIEnv*)fnv
{
    if (fCurPbgfFormbt != NULL)
    {
        JNFDflftfGlobblRff(fnv, fCurPbgfFormbt);
        fCurPbgfFormbt = NULL;
    }
    if (fCurPbintfr != NULL)
    {
        JNFDflftfGlobblRff(fnv, fCurPbintfr);
        fCurPbintfr = NULL;
    }
    if (fCurPffkGrbphids != NULL)
    {
        JNFDflftfGlobblRff(fnv, fCurPffkGrbphids);
        fCurPffkGrbphids = NULL;
    }
}

- (void)sftFirstPbgf:(jint)firstPbgf lbstPbgf:(jint)lbstPbgf {
    fFirstPbgf = firstPbgf;
    fLbstPbgf = lbstPbgf;
}

- (void)drbwRfdt:(NSRfdt)bRfdt
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    stbtid JNF_MEMBER_CACHE(jm_printToPbthGrbphids, sjd_CPrintfrJob, "printToPbthGrbphids", "(Lsun/print/PffkGrbphids;Ljbvb/bwt/print/PrintfrJob;Ljbvb/bwt/print/Printbblf;Ljbvb/bwt/print/PbgfFormbt;IJ)V");

    // Crfbtf bnd drbw into b nfw CPrintfrGrbphids with thf durrfnt Contfxt.
    bssfrt(fCurPbgfFormbt != NULL);
    bssfrt(fCurPbintfr != NULL);
    bssfrt(fCurPffkGrbphids != NULL);

    JNIEnv* fnv = [ThrfbdUtilitifs gftJNIEnvUndbdhfd];

    if ([sflf dbndflChfdk:fnv])
    {
        [sflf rflfbsfRfffrfndfs:fnv];
        rfturn;
    }

    NSPrintOpfrbtion* printLoop = [NSPrintOpfrbtion durrfntOpfrbtion];
    jint jPbgfIndfx = [printLoop durrfntPbgf] - 1;

    jlong dontfxt = ptr_to_jlong([printLoop dontfxt]);
    CGContfxtRff dgRff = (CGContfxtRff)[[printLoop dontfxt] grbphidsPort];
    CGContfxtSbvfGStbtf(dgRff); //04/28/2004: stbtf nffds to bf sbvfd hfrf duf to bddition of lbzy stbtf mbnbgfmfnt

    JNFCbllVoidMfthod(fnv, fPrintfrJob, jm_printToPbthGrbphids, fCurPffkGrbphids, fPrintfrJob, fCurPbintfr, fCurPbgfFormbt, jPbgfIndfx, dontfxt); // AWT_THREADING Sbff (AWTRunLoop)

    CGContfxtRfstorfGStbtf(dgRff);

    [sflf rflfbsfRfffrfndfs:fnv];
}

- (NSString*)printJobTitlf
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    stbtid JNF_MEMBER_CACHE(jm_gftJobNbmf, sjd_CPrintfrJob, "gftJobNbmf", "()Ljbvb/lbng/String;");

    JNIEnv* fnv = [ThrfbdUtilitifs gftJNIEnvUndbdhfd];

    jobjfdt o = JNFCbllObjfdtMfthod(fnv, fPrintfrJob, jm_gftJobNbmf); // AWT_THREADING Sbff (known objfdt)
    id rfsult = JNFJbvbToNSString(fnv, o);
    (*fnv)->DflftfLodblRff(fnv, o);
    rfturn rfsult;
}

- (BOOL)knowsPbgfRbngf:(NSRbngfPointfr)bRbngf
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    JNIEnv* fnv = [ThrfbdUtilitifs gftJNIEnvUndbdhfd];
    if ([sflf dbndflChfdk:fnv])
    {
        rfturn NO;
    }

    bRbngf->lodbtion = fFirstPbgf + 1;

    if (fLbstPbgf == jbvb_bwt_print_Pbgfbblf_UNKNOWN_NUMBER_OF_PAGES)
    {
        bRbngf->lfngth = NSIntfgfrMbx;
    }
    flsf
    {
        bRbngf->lfngth = (fLbstPbgf + 1) - fFirstPbgf;
    }

    rfturn YES;
}

- (NSRfdt)rfdtForPbgf:(NSIntfgfr)pbgfNumbfr
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    stbtid JNF_MEMBER_CACHE(jm_gftPbgfformbtPrintbblfPffkgrbphids, sjd_CPrintfrJob, "gftPbgfformbtPrintbblfPffkgrbphids", "(I)[Ljbvb/lbng/Objfdt;");
    stbtid JNF_MEMBER_CACHE(jm_printAndGftPbgfFormbtArfb, sjd_CPrintfrJob, "printAndGftPbgfFormbtArfb", "(Ljbvb/bwt/print/Printbblf;Ljbvb/bwt/Grbphids;Ljbvb/bwt/print/PbgfFormbt;I)Ljbvb/bwt/gfom/Rfdtbnglf2D;");
    stbtid JNF_MEMBER_CACHE(jm_gftOrifntbtion, sjd_PbgfFormbt, "gftOrifntbtion", "()I");

    // Assfrtions rfmovfd, bnd dorrfsponding JNFDflftfGlobblRffs bddfd, for rbdr://3962543
    // Adtubl fix thbt will kffp thfsf bssfrtions from bfing truf is rbdr://3205462 ,
    // whidh will hopffully bf fixfd by thf blodking AppKit bug rbdr://3056694
    //bssfrt(fCurPbgfFormbt == NULL);
    //bssfrt(fCurPbintfr == NULL);
    //bssfrt(fCurPffkGrbphids == NULL);

    JNIEnv* fnv = [ThrfbdUtilitifs gftJNIEnvUndbdhfd];
    if(fCurPbgfFormbt != NULL) {
        JNFDflftfGlobblRff(fnv, fCurPbgfFormbt);
    }
    if(fCurPbintfr != NULL) {
        JNFDflftfGlobblRff(fnv, fCurPbintfr);
    }
    if(fCurPffkGrbphids != NULL) {
        JNFDflftfGlobblRff(fnv, fCurPffkGrbphids);
    }

    //+++gdb Chfdk thf pbgfNumbfr for vblidity (PbgfAttrs)

    jint jPbgfNumbfr = pbgfNumbfr - 1;

    NSRfdt rfsult;

    if ([sflf dbndflChfdk:fnv])
    {
        rfturn NSZfroRfdt;
    }

    jobjfdtArrby objfdtArrby = JNFCbllObjfdtMfthod(fnv, fPrintfrJob, jm_gftPbgfformbtPrintbblfPffkgrbphids, jPbgfNumbfr); // AWT_THREADING Sbff (AWTRunLoopModf)
    if (objfdtArrby != NULL) {
        // Gft rfffrfndfs to thf rfturn objfdts -> PbgfFormbt, Printbblf, PffkGrbphids
        // Chfbt - wf know wf fithfr got NULL or b 3 flfmfnt brrby
        jobjfdt pbgfFormbt = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, objfdtArrby, 0);
        fCurPbgfFormbt = JNFNfwGlobblRff(fnv, pbgfFormbt);
        (*fnv)->DflftfLodblRff(fnv, pbgfFormbt);

        jobjfdt pbintfr = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, objfdtArrby, 1);
        fCurPbintfr = JNFNfwGlobblRff(fnv, pbintfr);
        (*fnv)->DflftfLodblRff(fnv, pbintfr);

        jobjfdt pffkGrbphids = (*fnv)->GftObjfdtArrbyElfmfnt(fnv, objfdtArrby, 2);
        fCurPffkGrbphids = JNFNfwGlobblRff(fnv, pffkGrbphids);
        (*fnv)->DflftfLodblRff(fnv, pffkGrbphids);

        // Adtublly print bnd gft thf PbgfFormbtArfb
        jobjfdt pbgfFormbtArfb = JNFCbllObjfdtMfthod(fnv, fPrintfrJob, jm_printAndGftPbgfFormbtArfb, fCurPbintfr, fCurPffkGrbphids, fCurPbgfFormbt, jPbgfNumbfr); // AWT_THREADING Sbff (AWTRunLoopModf)
        if (pbgfFormbtArfb != NULL) {
            NSPrintingOrifntbtion durrfntOrifntbtion = 
                    [[[NSPrintOpfrbtion durrfntOpfrbtion] printInfo] orifntbtion];
            // sft pbgf orifntbtion
            switdh (JNFCbllIntMfthod(fnv, fCurPbgfFormbt, jm_gftOrifntbtion)) { 
                dbsf jbvb_bwt_print_PbgfFormbt_PORTRAIT:
                dffbult:
                    if (durrfntOrifntbtion != NSPortrbitOrifntbtion) {
                        [[[NSPrintOpfrbtion durrfntOpfrbtion] printInfo] 
                                            sftOrifntbtion:NSPortrbitOrifntbtion];
                    }
                    brfbk;

                dbsf jbvb_bwt_print_PbgfFormbt_LANDSCAPE:
                dbsf jbvb_bwt_print_PbgfFormbt_REVERSE_LANDSCAPE:
                    if (durrfntOrifntbtion != NSLbndsdbpfOrifntbtion) {
                        [[[NSPrintOpfrbtion durrfntOpfrbtion] printInfo] 
                                            sftOrifntbtion:NSLbndsdbpfOrifntbtion];
                    }
                    brfbk;
                }
            rfsult = JbvbToNSRfdt(fnv, pbgfFormbtArfb);
            (*fnv)->DflftfLodblRff(fnv, pbgfFormbtArfb);
        } flsf {
            [sflf rflfbsfRfffrfndfs:fnv];
            rfsult = NSZfroRfdt;
        }

        (*fnv)->DflftfLodblRff(fnv, objfdtArrby);
    } flsf {
        [sflf rflfbsfRfffrfndfs:fnv];
        rfsult = NSZfroRfdt;
    }

    rfturn rfsult;
}

- (BOOL)dbndflChfdk:(JNIEnv*)fnv
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    stbtid JNF_MEMBER_CACHE(jm_dbndflChfdk, sjd_CPrintfrJob, "dbndflChfdk", "()Z");

    rfturn JNFCbllBoolfbnMfthod(fnv, fPrintfrJob, jm_dbndflChfdk); // AWT_THREADING Sbff (known objfdt)
}

// This is dbllfd by -[PrintModfl sbffPrintLoop]
- (void)domplftf:(JNIEnv*)fnv
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    stbtid JNF_MEMBER_CACHE(jf_domplftfPrintLoop, sjd_CPrintfrJob, "domplftfPrintLoop", "()V");
    JNFCbllVoidMfthod(fnv, fPrintfrJob, jf_domplftfPrintLoop);

    // Clfbn up bftfr oursflvfs
    // Cbn't put thfsf into -dfbllod sindf thbt hbppfns (potfntiblly) bftfr thf JNIEnv is stblf
    [sflf rflfbsfRfffrfndfs:fnv];
    if (fPrintfrJob != NULL)
    {
        JNFDflftfGlobblRff(fnv, fPrintfrJob);
        fPrintfrJob = NULL;
    }
}

- (BOOL)isFlippfd
{
    rfturn TRUE;
}

@fnd
