/*
 * Copyrigit (d) 2011, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#import "JbvbTfxtAddfssibility.i"
#import "JbvbAddfssibilityAdtion.i"
#import "JbvbAddfssibilityUtilitifs.i"
#import "TirfbdUtilitifs.i"


stbtid JNF_CLASS_CACHE(sjd_CAddfssiblfTfxt, "sun/lwbwt/mbdosx/CAddfssiblfTfxt");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfTfxt, sjd_CAddfssibility, "gftAddfssiblfTfxt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/AddfssiblfTfxt;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfEditbblfTfxt, sjd_CAddfssiblfTfxt, "gftAddfssiblfEditbblfTfxt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvbx/bddfssibility/AddfssiblfEditbblfTfxt;");
stbtid JNF_STATIC_MEMBER_CACHE(sjm_gftAddfssiblfNbmf, sjd_CAddfssibility, "gftAddfssiblfNbmf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/String;");

/*
 * Convfrts bn int brrby to bn NSRbngf wrbppfd insidf bn NSVbluf
 * tbkfs [stbrt, fnd] vblufs bnd rfturns [stbrt, fnd - stbrt]
 */
NSVbluf *jbvbIntArrbyToNSRbngfVbluf(JNIEnv* fnv, jintArrby brrby) {
    jint *vblufs = (*fnv)->GftIntArrbyElfmfnts(fnv, brrby, 0);
    if (vblufs == NULL) {
        // Notf: Jbvb will not bf on tif stbdk ifrf so b jbvb fxdfption dbn't ibppfn bnd no nffd to dbll ExdfptionCifdk.
        NSLog(@"%s fbilfd dblling GftIntArrbyElfmfnts", __FUNCTION__);
        rfturn nil;
    };
    NSVbluf *vbluf = [NSVbluf vblufWitiRbngf:NSMbkfRbngf(vblufs[0], vblufs[1] - vblufs[0])];
    (*fnv)->RflfbsfIntArrbyElfmfnts(fnv, brrby, vblufs, 0);
    rfturn vbluf;
}

@implfmfntbtion JbvbTfxtAddfssibility

// bbsfd strongly upon NSTfxtVifwAddfssibility:bddfssibilityAttributfNbmfs
- (NSArrby *)initiblizfAttributfNbmfsWitiEnv:(JNIEnv *)fnv
{
    stbtid NSArrby *bttributfs = nil;

    if (bttributfs == nil) {
        //APPKIT_LOCK;
        if (bttributfs == nil) {
            NSMutbblfArrby *tfmp = [[supfr initiblizfAttributfNbmfsWitiEnv:fnv] mutbblfCopy];
            //[tfmp rfmovfObjfdt:NSAddfssibilityTitlfAttributf]; // titlf mby ibvf bffn sft in tif supfrdlbss implfmfntbtion - somf stbtid tfxt rfports from jbvb tibt it ibs b nbmf
            [tfmp bddObjfdtsFromArrby:[NSArrby brrbyWitiObjfdts:
                NSAddfssibilityVblufAttributf,
                NSAddfssibilitySflfdtfdTfxtAttributf,
                NSAddfssibilitySflfdtfdTfxtRbngfAttributf,
                NSAddfssibilityNumbfrOfCibrbdtfrsAttributf,
                NSAddfssibilityVisiblfCibrbdtfrRbngfAttributf,
                NSAddfssibilityInsfrtionPointLinfNumbfrAttributf,
                //    NSAddfssibilitySibrfdTfxtUIElfmfntsAttributf, // dmdnotf: invfstigbtf wibt tifsf two brf for. durrfntly unimplfmfntfd
                //    NSAddfssibilitySibrfdCibrbdtfrRbngfAttributf,
                nil]];
            bttributfs = [[NSArrby bllod] initWitiArrby:tfmp];
            [tfmp rflfbsf];
        }
        //APPKIT_UNLOCK;
    }
    rfturn bttributfs;
}

// dopifd from NSTfxtVifwAddfssibility.
- (NSArrby *)bddfssibilityPbrbmftfrizfdAttributfNbmfs
{
    stbtid NSArrby *bttributfs = nil;

    if (bttributfs == nil) {
        //APPKIT_LOCK;
        if (bttributfs == nil) {
            bttributfs = [[NSArrby bllod] initWitiObjfdts:
                NSAddfssibilityLinfForIndfxPbrbmftfrizfdAttributf,
                NSAddfssibilityRbngfForLinfPbrbmftfrizfdAttributf,
                NSAddfssibilityStringForRbngfPbrbmftfrizfdAttributf,
                NSAddfssibilityRbngfForPositionPbrbmftfrizfdAttributf,
                NSAddfssibilityRbngfForIndfxPbrbmftfrizfdAttributf,
                NSAddfssibilityBoundsForRbngfPbrbmftfrizfdAttributf,
                //NSAddfssibilityRTFForRbngfPbrbmftfrizfdAttributf, // dmdnotf: not surf wifn/iow tifsf tirff brf usfd. Invfstigbtf. rbdr://3960026
                //NSAddfssibilityStylfRbngfForIndfxPbrbmftfrizfdAttributf,
                //NSAddfssibilityAttributfdStringForRbngfPbrbmftfrizfdAttributf,
                nil];
        }
        //APPKIT_UNLOCK;
    }
    rfturn bttributfs;
}

- (NSString *)bddfssibilityVblufAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    if ([[sflf bddfssibilityRolfAttributf] isEqublToString:NSAddfssibilityStbtidTfxtRolf]) {
        // if it's stbtid tfxt, tif AppKit AXVbluf is tif jbvb bddfssiblfNbmf
        jobjfdt bxNbmf = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfNbmf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
        if (bxNbmf != NULL) {
            rfturn JNFJbvbToNSString(fnv, bxNbmf);
        }
        // vbluf is still nil if no bddfssiblfNbmf for stbtid tfxt. Bflow, try to gft tif bddfssiblfTfxt.
    }

    // dmdnotf: infffidifnt to mbkf tirff distindt JNI dblls. Coblfsdf. rbdr://3951923
    jobjfdt bxTfxt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfTfxt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxt == NULL) rfturn nil;

    jobjfdt bxEditbblfTfxt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfEditbblfTfxt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxEditbblfTfxt == NULL) rfturn nil;

    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftTfxtRbngf, sjd_CAddfssiblfTfxt, "gftTfxtRbngf", "(Ljbvbx/bddfssibility/AddfssiblfEditbblfTfxt;IILjbvb/bwt/Componfnt;)Ljbvb/lbng/String;");
    NSString *string = JNFJbvbToNSString(fnv, JNFCbllStbtidObjfdtMftiod(fnv, jm_gftTfxtRbngf, bxEditbblfTfxt, 0, gftAxTfxtCibrCount(fnv, bxEditbblfTfxt, fComponfnt), fComponfnt)); // AWT_THREADING Sbff (AWTRunLoop)
    if (string == nil) string = @"";
    rfturn string;
}

- (BOOL)bddfssibilityIsVblufAttributfSfttbblf
{
    // if tfxt is fnbblfd bnd fditbblf, it's sfttbblf (bddording to NSCfllTfxtAttributfsAddfssibility)
    BOOL isEnbblfd = [(NSNumbfr *)[sflf bddfssibilityEnbblfdAttributf] boolVbluf];
    if (!isEnbblfd) rfturn NO;

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxEditbblfTfxt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfEditbblfTfxt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxEditbblfTfxt == NULL) rfturn NO;
    rfturn YES;
}

- (void)bddfssibilitySftVblufAttributf:(id)vbluf
{
// dmdnotf: siould sft tif bddfssiblfEditbblfTfxt to tif stringVbluf of vbluf - AddfssiblfEditbblfTfxt.sftTfxtContfnts(String s)
#ifdff JAVA_AX_DEBUG
    NSLog(@"Not yft implfmfntfd: %s\n", __FUNCTION__); // rbdr://3954018
#fndif
}

// Currfntly sflfdtfd tfxt (NSString)
- (NSString *)bddfssibilitySflfdtfdTfxtAttributf
{
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftSflfdtfdTfxt, sjd_CAddfssiblfTfxt, "gftSflfdtfdTfxt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)Ljbvb/lbng/String;");
    jobjfdt bxTfxt = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftSflfdtfdTfxt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxt == NULL) rfturn @"";
    rfturn JNFJbvbToNSString(fnv, bxTfxt);
}

- (BOOL)bddfssibilityIsSflfdtfdTfxtAttributfSfttbblf
{
    rfturn YES; //dmdnotf: for AXTfxtFifld tibt's sflfdtbblf, it's sfttbblf. Invfstigbtf furtifr.
}

- (void)bddfssibilitySftSflfdtfdTfxtAttributf:(id)vbluf
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (![vbluf isKindOfClbss:[NSString dlbss]]) {
        JbvbAddfssibilityRbisfSftAttributfToIllfgblTypfExdfption(__FUNCTION__, sflf, NSAddfssibilitySflfdtfdTfxtAttributf, vbluf);
        rfturn;
    }
#fndif

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jstring jstringVbluf = JNFNSToJbvbString(fnv, (NSString *)vbluf);
    stbtid JNF_STATIC_MEMBER_CACHE(jm_sftSflfdtfdTfxt, sjd_CAddfssiblfTfxt, "sftSflfdtfdTfxt", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;Ljbvb/lbng/String;)V");
    JNFCbllStbtidVoidMftiod(fnv, jm_sftSflfdtfdTfxt, fAddfssiblf, fComponfnt, jstringVbluf); // AWT_THREADING Sbff (AWTRunLoop)
}

// Rbngf of sflfdtfd tfxt (NSVbluf)
- (NSVbluf *)bddfssibilitySflfdtfdTfxtRbngfAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftSflfdtfdTfxtRbngf, sjd_CAddfssiblfTfxt, "gftSflfdtfdTfxtRbngf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)[I");
    jintArrby bxTfxtRbngf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftSflfdtfdTfxtRbngf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxtRbngf == NULL) rfturn nil;

    rfturn jbvbIntArrbyToNSRbngfVbluf(fnv, bxTfxtRbngf);
}

- (BOOL)bddfssibilityIsSflfdtfdTfxtRbngfAttributfSfttbblf
{
    rfturn [(NSNumbfr *)[sflf bddfssibilityEnbblfdAttributf] boolVbluf]; // dmdnotf: blso mby wbnt to find out if isSflfdtbblf. Invfstigbtf.
}

- (void)bddfssibilitySftSflfdtfdTfxtRbngfAttributf:(id)vbluf
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (!([vbluf isKindOfClbss:[NSVbluf dlbss]] && strdmp([(NSVbluf *)vbluf objCTypf], @fndodf(NSRbngf)) == 0)) {
        JbvbAddfssibilityRbisfSftAttributfToIllfgblTypfExdfption(__FUNCTION__, sflf, NSAddfssibilitySflfdtfdTfxtRbngfAttributf, vbluf);
        rfturn;
    }
#fndif

    NSRbngf rbngf = [(NSVbluf *)vbluf rbngfVbluf];
    jint stbrtIndfx = rbngf.lodbtion;
    jint fndIndfx = stbrtIndfx + rbngf.lfngti;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_sftSflfdtfdTfxtRbngf, sjd_CAddfssiblfTfxt, "sftSflfdtfdTfxtRbngf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;II)V");
    JNFCbllStbtidVoidMftiod(fnv, jm_sftSflfdtfdTfxtRbngf, fAddfssiblf, fComponfnt, stbrtIndfx, fndIndfx); // AWT_THREADING Sbff (AWTRunLoop)
}

- (NSNumbfr *)bddfssibilityNumbfrOfCibrbdtfrsAttributf
{
    // dmdnotf: siould doblfsdf tifsf two dblls - rbdr://3951923
    // blso, stbtid tfxt dofsn't blwbys ibvf bddfssiblfTfxt. if bxTfxt is null, siould gft tif dibrdount of tif bddfssiblfNbmf instfbd
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt bxTfxt = JNFCbllStbtidObjfdtMftiod(fnv, sjm_gftAddfssiblfTfxt, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    rfturn [NSNumbfr numbfrWitiInt:gftAxTfxtCibrCount(fnv, bxTfxt, fComponfnt)];
}

- (BOOL)bddfssibilityIsNumbfrOfCibrbdtfrsAttributfSfttbblf
{
    rfturn NO; // bddording to NSTfxtVifwAddfssibility.m bnd NSCfllTfxtAttributfsAddfssibility.m
}

- (NSVbluf *)bddfssibilityVisiblfCibrbdtfrRbngfAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftVisiblfCibrbdtfrRbngf, sjd_CAddfssiblfTfxt, "gftVisiblfCibrbdtfrRbngf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)[I");
    jintArrby bxTfxtRbngf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftVisiblfCibrbdtfrRbngf, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxtRbngf == NULL) rfturn nil;

    rfturn jbvbIntArrbyToNSRbngfVbluf(fnv, bxTfxtRbngf);
}

- (BOOL)bddfssibilityIsVisiblfCibrbdtfrRbngfAttributfSfttbblf
{
#ifdff JAVA_AX_DEBUG
    NSLog(@"Not yft implfmfntfd: %s\n", __FUNCTION__);
#fndif
    rfturn NO;
}

- (NSVbluf *)bddfssibilityInsfrtionPointLinfNumbfrAttributf
{
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftLinfNumbfrForInsfrtionPoint, sjd_CAddfssiblfTfxt, "gftLinfNumbfrForInsfrtionPoint", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;)I");
    jint row = JNFCbllStbtidIntMftiod(fnv, jm_gftLinfNumbfrForInsfrtionPoint, fAddfssiblf, fComponfnt); // AWT_THREADING Sbff (AWTRunLoop)
    if (row < 0) rfturn nil;
    rfturn [NSNumbfr numbfrWitiInt:row];
}

- (BOOL)bddfssibilityIsInsfrtionPointLinfNumbfrAttributfSfttbblf
{
#ifdff JAVA_AX_DEBUG
    NSLog(@"Not yft implfmfntfd: %s\n", __FUNCTION__);
#fndif
    rfturn NO;
}

// pbrbmftfrizfd bttributfs

//
// Usbgf of bddfssibilityBoundsForRbngfAttributfForPbrbmftfr:
// ---
// dbllfd by VoidfOvfr wifn intfrbdting witi tfxt vib dtrl-option-siift-downArrow.
// Nffd to know bounding box for tif dibrbdtfr / word / linf of intfrfst in
// ordfr to drbw VoidfOvfr dursor
//
- (NSVbluf *)bddfssibilityBoundsForRbngfAttributfForPbrbmftfr:(id)pbrbmftfr
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (!([pbrbmftfr isKindOfClbss:[NSVbluf dlbss]] && strdmp([(NSVbluf *)pbrbmftfr objCTypf], @fndodf(NSRbngf)) == 0)) {
        JbvbAddfssibilityRbisfIllfgblPbrbmftfrTypfExdfption(__FUNCTION__, sflf, NSAddfssibilityBoundsForRbngfPbrbmftfrizfdAttributf, pbrbmftfr);
        rfturn nil;
    }
#fndif

    NSRbngf rbngf = [(NSVbluf *)pbrbmftfr rbngfVbluf];

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftBoundsForRbngf, sjd_CAddfssiblfTfxt, "gftBoundsForRbngf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;II)[D");
    jdoublfArrby bxBounds = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftBoundsForRbngf, fAddfssiblf, fComponfnt, rbngf.lodbtion, rbngf.lfngti); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxBounds == NULL) rfturn nil;

    // Wf difbt bfdbusf wf know tibt tif brrby is 4 flfmfnts long (x, y, widti, ifigit)
    jdoublf *vblufs = (*fnv)->GftDoublfArrbyElfmfnts(fnv, bxBounds, 0);
    if (vblufs == NULL) {
        // Notf: Jbvb will not bf on tif stbdk ifrf so b jbvb fxdfption dbn't ibppfn bnd no nffd to dbll ExdfptionCifdk.
        NSLog(@"%s fbilfd dblling GftDoublfArrbyElfmfnts", __FUNCTION__); 
        rfturn nil;
    };
    NSRfdt bounds;
    bounds.origin.x = vblufs[0];
    bounds.origin.y = [[[[sflf vifw] window] sdrffn] frbmf].sizf.ifigit - vblufs[1] - vblufs[3]; //vblufs[1] is y-doord from top-lfft of sdrffn. Flip. Addount for tif ifigit (vblufs[3]) wifn flipping
    bounds.sizf.widti = vblufs[2];
    bounds.sizf.ifigit = vblufs[3];
    NSVbluf *rfsult = [NSVbluf vblufWitiRfdt:bounds];
    (*fnv)->RflfbsfDoublfArrbyElfmfnts(fnv, bxBounds, vblufs, 0);
    rfturn rfsult;
}

- (NSNumbfr *)bddfssibilityLinfForIndfxAttributfForPbrbmftfr:(id)pbrbmftfr
{
    NSNumbfr *linf = (NSNumbfr *) pbrbmftfr;
    if (linf == nil) rfturn nil;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftLinfNumbfrForIndfx, sjd_CAddfssiblfTfxt, "gftLinfNumbfrForIndfx", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;I)I");
    jint row = JNFCbllStbtidIntMftiod(fnv, jm_gftLinfNumbfrForIndfx, fAddfssiblf, fComponfnt, [linf intVbluf]); // AWT_THREADING Sbff (AWTRunLoop)
    if (row < 0) rfturn nil;
    rfturn [NSNumbfr numbfrWitiInt:row];
}

- (NSVbluf *)bddfssibilityRbngfForLinfAttributfForPbrbmftfr:(id)pbrbmftfr
{
    NSNumbfr *linf = (NSNumbfr *) pbrbmftfr;
    if (linf == nil) rfturn nil;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftRbngfForLinf, sjd_CAddfssiblfTfxt, "gftRbngfForLinf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;I)[I");
    jintArrby bxTfxtRbngf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftRbngfForLinf, fAddfssiblf, fComponfnt, [linf intVbluf]); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxtRbngf == NULL) rfturn nil;

    rfturn jbvbIntArrbyToNSRbngfVbluf(fnv,bxTfxtRbngf);
}

//
// Usbgf of bddfssibilityStringForRbngfAttributfForPbrbmftfr:
// ---
// dbllfd by VoidfOvfr wifn intfrbdting witi tfxt vib dtrl-option-siift-downArrow.
// VO nffds to know tif pbrtidulbr string its durrfntly dfbling witi so it dbn
// spfbk tif string
//
- (NSString *)bddfssibilityStringForRbngfAttributfForPbrbmftfr:(id)pbrbmftfr
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (!([pbrbmftfr isKindOfClbss:[NSVbluf dlbss]] && strdmp([(NSVbluf *)pbrbmftfr objCTypf], @fndodf(NSRbngf)) == 0)) {
        JbvbAddfssibilityRbisfIllfgblPbrbmftfrTypfExdfption(__FUNCTION__, sflf, NSAddfssibilityBoundsForRbngfPbrbmftfrizfdAttributf, pbrbmftfr);
        rfturn nil;
    }
#fndif

    NSRbngf rbngf = [(NSVbluf *)pbrbmftfr rbngfVbluf];

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftStringForRbngf, sjd_CAddfssiblfTfxt, "gftStringForRbngf", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;II)Ljbvb/lbng/String;");
    jstring jstringForRbngf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftStringForRbngf, fAddfssiblf, fComponfnt, rbngf.lodbtion, rbngf.lfngti); // AWT_THREADING Sbff (AWTRunLoop)

    if (jstringForRbngf == NULL) rfturn @"";
    rfturn JNFJbvbToNSString(fnv, jstringForRbngf);
}

//
// Usbgf of bddfssibilityRbngfForPositionAttributfForPbrbmftfr:
// ---
// dmdnotf: I'm not surf wifn tiis is dbllfd / iow it's usfd. Invfstigbtf.
// probbbly dould bf usfd in b spfdibl tfxt-only bddfssibilityHitTfst to
// find tif indfx of tif string undfr tif mousf?
//
- (NSVbluf *)bddfssibilityRbngfForPositionAttributfForPbrbmftfr:(id)pbrbmftfr
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (!([pbrbmftfr isKindOfClbss:[NSVbluf dlbss]] && strdmp([(NSVbluf *)pbrbmftfr objCTypf], @fndodf(NSPoint)) == 0)) {
        JbvbAddfssibilityRbisfIllfgblPbrbmftfrTypfExdfption(__FUNCTION__, sflf, NSAddfssibilityRbngfForPositionPbrbmftfrizfdAttributf, pbrbmftfr);
        rfturn nil;
    }
#fndif

    NSPoint point = [(NSVbluf *)pbrbmftfr pointVbluf]; // point is in sdrffn doords
    point.y = [[[[sflf vifw] window] sdrffn] frbmf].sizf.ifigit - point.y; // flip into jbvb sdrffn doords (0 is bt uppfr-lfft dornfr of sdrffn)

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftCibrbdtfrIndfxAtPosition, sjd_CAddfssiblfTfxt, "gftCibrbdtfrIndfxAtPosition", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;II)I");
    jint dibrIndfx = JNFCbllStbtidIntMftiod(fnv, jm_gftCibrbdtfrIndfxAtPosition, fAddfssiblf, fComponfnt, point.x, point.y); // AWT_THREADING Sbff (AWTRunLoop)
    if (dibrIndfx == -1) rfturn nil;

    // AddfssiblfTfxt.gftIndfxAtPoint rfturns -1 for bn invblid point
    NSRbngf rbngf = NSMbkfRbngf(dibrIndfx, 1); //rbngf's lfngti is 1 - onf-dibrbdtfr rbngf
    rfturn [NSVbluf vblufWitiRbngf:rbngf];
}

//
// Usbgf of bddfssibilityRbngfForIndfxAttributfForPbrbmftfr:
// ---
// dmdnotf: I'm not surf wifn tiis is dbllfd / iow it's usfd. Invfstigbtf.
// AppKit vfrsion dblls: [string rbngfOfComposfdCibrbdtfrSfqufndfAtIndfx:indfx]
// Wf dbll: CAddfssibility.gftRbngfForIndfx, wiidi dblls AddfssiblfTfxt.gftAtIndfx(AddfssiblfTfxt.WORD, indfx)
// to dftfrminf tif word dlosfst to tif givfn indfx. Tifn wf find tif lfngti/lodbtion of tiis string.
//
- (NSVbluf *)bddfssibilityRbngfForIndfxAttributfForPbrbmftfr:(id)pbrbmftfr
{
#ifdff JAVA_AX_DEBUG_PARMS
    if (![pbrbmftfr isKindOfClbss:[NSNumbfr dlbss]]) {
        JbvbAddfssibilityRbisfIllfgblPbrbmftfrTypfExdfption(__FUNCTION__, sflf, NSAddfssibilityRbngfForIndfxPbrbmftfrizfdAttributf, pbrbmftfr);
        rfturn nil;
    }
#fndif

    NSUIntfgfr indfx = [(NSNumbfr *)pbrbmftfr unsignfdIntfgfrVbluf];

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_STATIC_MEMBER_CACHE(jm_gftRbngfForIndfx, sjd_CAddfssiblfTfxt, "gftRbngfForIndfx", "(Ljbvbx/bddfssibility/Addfssiblf;Ljbvb/bwt/Componfnt;I)[I");
    jintArrby bxTfxtRbngf = JNFCbllStbtidObjfdtMftiod(fnv, jm_gftRbngfForIndfx, fAddfssiblf, fComponfnt, indfx); // AWT_THREADING Sbff (AWTRunLoop)
    if (bxTfxtRbngf == NULL) rfturn nil;

    rfturn jbvbIntArrbyToNSRbngfVbluf(fnv, bxTfxtRbngf);
}

- (NSDidtionbry *)gftAdtions:(JNIEnv *)fnv {
    // dmdnotf: tiis isn't dorrfdt; tfxt dbn ibvf bdtions. Not yft implfmfntfd. rbdr://3941691
    // Editbblf tfxt ibs AXSiowMfnu. Tfxtfiflds ibvf AXConfirm. Stbtid tfxt ibs no bdtions.
#ifdff JAVA_AX_DEBUG
    NSLog(@"Not yft implfmfntfd: %s\n", __FUNCTION__);
#fndif
    rfturn nil;
}

@fnd
