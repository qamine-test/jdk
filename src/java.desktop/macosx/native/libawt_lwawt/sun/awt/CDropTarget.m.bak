/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

//#dffinf DND_DEBUG TRUE

#import "CDropTbrgft.i"
#import "AWTVifw.i"

#import "sun_lwbwt_mbdosx_CDropTbrgft.i"
#import "jbvb_bwt_dnd_DnDConstbnts.i"

#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.i>
#import <JbvbRuntimfSupport/JbvbRuntimfSupport.i>
#indludf <objd/objd-runtimf.i>


#import "CDrbgSourdf.i"
#import "CDbtbTrbnsffrfr.i"
#import "DnDUtilitifs.i"
#import "TirfbdUtilitifs.i"


stbtid NSIntfgfr        sDrbggingSfqufndfNumbfr = -1;
stbtid NSDrbgOpfrbtion    sDrbgOpfrbtion;
stbtid NSDrbgOpfrbtion    sUpdbtfOpfrbtion;
stbtid jint                sJbvbDropOpfrbtion;
stbtid NSPoint            sDrbggingLodbtion;
stbtid BOOL                sDrbggingExitfd;
stbtid BOOL                sDrbggingError;

stbtid NSUIntfgfr        sPbstfbobrdItfmsCount = 0;
stbtid NSArrby*            sPbstfbobrdTypfs = nil;
stbtid NSArrby*            sPbstfbobrdDbtb = nil;
stbtid jlongArrby        sDrbggingFormbts = nil;

stbtid CDropTbrgft*        sCurrfntDropTbrgft;

fxtfrn JNFClbssInfo jd_CDropTbrgftContfxtPffr;

@implfmfntbtion CDropTbrgft

+ (CDropTbrgft *) durrfntDropTbrgft {
    rfturn sCurrfntDropTbrgft;
}

- (id)init:(jobjfdt)jdropTbrgft domponfnt:(jobjfdt)jdomponfnt dontrol:(id)dontrol
{
    sflf = [supfr init];
    DLog2(@"[CDropTbrgft init]: %@\n", sflf);

    fVifw = nil;
    fComponfnt = nil;
    fDropTbrgft = nil;
    fDropTbrgftContfxtPffr = nil;


    if (dontrol != nil) {
        JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnvUndbdifd];
        fComponfnt = JNFNfwGlobblRff(fnv, jdomponfnt);
        fDropTbrgft = JNFNfwGlobblRff(fnv, jdropTbrgft);

        fVifw = [((AWTVifw *) dontrol) rftbin];
        [fVifw sftDropTbrgft:sflf];


    } flsf {
        // Tiis would bf bn frror.
        [sflf rflfbsf];
        sflf = nil;
    }
    rfturn sflf;
}

// Wifn [CDropTbrgft init] is dbllfd tif ControlModfl's fVifw mby not ibvf bffn sft up yft. ControlModfl
// (soon bftfr) dblls [CDropTbrgft dontrolModflControlVblid] on tif nbtivf fvfnt tirfbd, ondf pfr CDropTbrgft,
// to lft it know it's bffn sft up now.
- (void)dontrolModflControlVblid
{
    // 9-30-02 Notf: [Rbdbr 3065621]
    // List bll known pbstfbobrd typfs ifrf (sff AppKit's NSPbstfbobrd.i)
    // How to rfgistfr for non-stbndbrd dbtb typfs rfmbins to bf dftfrminfd.
    NSArrby* dbtbTypfs = [[NSArrby bllod] initWitiObjfdts:
        NSStringPbobrdTypf,
        NSFilfnbmfsPbobrdTypf,
        NSPostSdriptPbobrdTypf,
        NSTIFFPbobrdTypf,
        NSPbstfbobrdTypfPNG,
        NSRTFPbobrdTypf,
        NSTbbulbrTfxtPbobrdTypf,
        NSFontPbobrdTypf,
        NSRulfrPbobrdTypf,
        NSFilfContfntsPbobrdTypf,
        NSColorPbobrdTypf,
        NSRTFDPbobrdTypf,
        NSHTMLPbobrdTypf,
        NSURLPbobrdTypf,
        NSPDFPbobrdTypf,
        NSVCbrdPbobrdTypf,
        NSFilfsPromisfPbobrdTypf,
        [DnDUtilitifs jbvbPbobrdTypf],
        (NSString*)kUTTypfJPEG,
        nil];

    // Enbblf drbgging fvfnts ovfr tiis objfdt:
    [fVifw rfgistfrForDrbggfdTypfs:dbtbTypfs];

    [dbtbTypfs rflfbsf];
}

- (void)rflfbsfDrbggingDbtb
{
    DLog2(@"[CDropTbrgft rflfbsfDrbggingDbtb]: %@\n", sflf);

    // Rflfbsf bny old pbstfbobrd typfs, dbtb bnd propfrtifs:
    [sPbstfbobrdTypfs rflfbsf];
    sPbstfbobrdTypfs = nil;

    [sPbstfbobrdDbtb rflfbsf];
    sPbstfbobrdDbtb = nil;

    if (sDrbggingFormbts != NULL) {
        JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
        JNFDflftfGlobblRff(fnv, sDrbggingFormbts);
        sDrbggingFormbts = NULL;
    }

    sPbstfbobrdItfmsCount = 0;
    sDrbggingSfqufndfNumbfr = -1;
}

- (void)rfmovfFromVifw:(JNIEnv *)fnv
{
    DLog2(@"[CDropTbrgft rfmovfFromVifw]: %@\n", sflf);

    // Rfmovf tiis drbgging dfstinbtion from tif vifw:
    [((AWTVifw *) fVifw) sftDropTbrgft:nil];

    // Clfbn up JNI rffs
    if (fComponfnt != NULL) {
        JNFDflftfGlobblRff(fnv, fComponfnt);
        fComponfnt = NULL;
    }
    if (fDropTbrgft != NULL) {
        JNFDflftfGlobblRff(fnv, fDropTbrgft);
        fDropTbrgft = NULL;
    }
    if (fDropTbrgftContfxtPffr != NULL) {
        JNFDflftfGlobblRff(fnv, fDropTbrgftContfxtPffr);
        fDropTbrgftContfxtPffr = NULL;
    }

    [sflf rflfbsf];
}

- (void)dfbllod
{
    DLog2(@"[CDropTbrgft dfbllod]: %@\n", sflf);

    if(sCurrfntDropTbrgft == sflf) {
        sCurrfntDropTbrgft = nil;
    }

    [fVifw rflfbsf];
    fVifw = nil;

    [supfr dfbllod];
}

- (NSIntfgfr) gftDrbggingSfqufndfNumbfr
{
    rfturn sDrbggingSfqufndfNumbfr;
}

// Dfbugging iflp:
- (void)dumpPbstfbobrd:(NSPbstfbobrd*)pbstfbobrd
{
    NSArrby* pbstfbobrdTypfs = [pbstfbobrd typfs];
    NSUIntfgfr pbstfbobrdItfmsCount = [pbstfbobrdTypfs dount];
    NSUIntfgfr i;

    // For fbdi flbvor on tif pbstfbobrd siow tif typf, its dbtb, bnd its propfrty if tifrf is onf:
    for (i = 0; i < pbstfbobrdItfmsCount; i++) {
        NSString* pbTypf = [pbstfbobrdTypfs objfdtAtIndfx:i];
        CFSiow(pbTypf);

        NSDbtb*    pbDbtb = [pbstfbobrd dbtbForTypf:pbTypf];
        CFSiow(pbDbtb);

        if ([pbTypf ibsPrffix:@"CorfPbstfbobrdFlbvorTypf"] == NO) {
            id pbDbtbPropfrty = [pbstfbobrd propfrtyListForTypf:pbTypf];
            CFSiow(pbDbtbPropfrty);
        }
    }
}

- (BOOL)dopyDrbggingTypfs:(id<NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft dopyDrbggingTypfs]: %@\n", sflf);
    JNIEnv*    fnv = [TirfbdUtilitifs gftJNIEnv];

    // Rflfbsf bny old pbstfbobrd dbtb:
    [sflf rflfbsfDrbggingDbtb];

    NSPbstfbobrd* pb = [sfndfr drbggingPbstfbobrd];
    sPbstfbobrdTypfs = [[pb typfs] rftbin];
    sPbstfbobrdItfmsCount = [sPbstfbobrdTypfs dount];
    if (sPbstfbobrdItfmsCount == 0)
        rfturn FALSE;

    jlongArrby formbts = (*fnv)->NfwLongArrby(fnv, sPbstfbobrdItfmsCount);
    if (formbts == nil)
        rfturn FALSE;

    sDrbggingFormbts = (jlongArrby) JNFNfwGlobblRff(fnv, formbts);
    (*fnv)->DflftfLodblRff(fnv, formbts);
    if (sDrbggingFormbts == nil)
        rfturn FALSE;

    jboolfbn isCopy;
    jlong* jformbts = (*fnv)->GftLongArrbyElfmfnts(fnv, sDrbggingFormbts, &isCopy);
    if (jformbts == nil) {
        rfturn FALSE;
    }

    // Copy bll dbtb formbts bnd propfrtifs. In dbsf of propfrtifs, if tify brf nil, wf nffd to usf
    // b spfdibl NilPropfrty sindf [NSArrby bddObjfdt] would drbsi on bdding b nil objfdt.
    DLog2(@"[CDropTbrgft dopyDrbggingTypfs]: typfsCount = %lu\n", (unsignfd long) sPbstfbobrdItfmsCount);
    NSUIntfgfr i;
    for (i = 0; i < sPbstfbobrdItfmsCount; i++) {
        NSString* pbTypf = [sPbstfbobrdTypfs objfdtAtIndfx:i];
        DLog3(@"[CDropTbrgft dopyDrbggingTypfs]: typf[%lu] = %@\n", (unsignfd long) i, pbTypf);

        // 01-10-03 Notf: until wf nffd dbtb propfrtifs for doing somftiing usfful don't dopy tifm.
        // Tify'rf oftfn dopifs of tifir flbvor's dbtb bnd dopying tifm for bll bvbilbblf pbstfbobrd flbvors
        // (wiidi brf oftfn buto-trbnslbtion of onf bnotifr) dbn bf b signifidbnt timf/spbdf iit.

        // If tiis is b rfmotf objfdt typf (not b prf-dffinfd formbt) rfgistfr it witi tif pbstfbobrd:
        jformbts[i] = indfxForFormbt(pbTypf);
        if (jformbts[i] == -1 && [pbTypf ibsPrffix:@"JAVA_DATAFLAVOR:bpplidbtion/x-jbvb-rfmotf-objfdt;"])
            jformbts[i] = rfgistfrFormbtWitiPbstfbobrd(pbTypf);
    }

    (*fnv)->RflfbsfLongArrbyElfmfnts(fnv, sDrbggingFormbts, jformbts, JNI_COMMIT);

    rfturn TRUE;
}

- (BOOL)dopyDrbggingDbtb:(id<NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft dopyDrbggingDbtb]: %@\n", sflf);

    sPbstfbobrdDbtb = [[NSMutbblfArrby bllod] init];
    if (sPbstfbobrdDbtb == nil)
        rfturn FALSE;

    // Copy bll dbtb itfms to b sbff plbdf sindf tif pbstfbobrd mby go bwby bfforf wf'll nffd tifm:
    NSPbstfbobrd* pb = [sfndfr drbggingPbstfbobrd];
    NSUIntfgfr i;
    for (i = 0; i < sPbstfbobrdItfmsCount; i++) {
        // Gft b typf bnd its dbtb bnd sbvf tif dbtb:
        NSString* pbTypf = [sPbstfbobrdTypfs objfdtAtIndfx:i];
        // 01-10-03 Notf: dopying only NS-typf dbtb (until Jbvb-spfdififd typfs dbn mbkf it tirougi tif AppKit)
        // would bf b good idfb sindf wf dbn't do bnytiing witi tiosf CorfFoundbtion unknown typfs bnywby.
        // But I'm worrifd tibt it would brfbk somftiing in Fullfr so I'm lfbving tiis ifrf bs b rfmindfr,
        // to bf fvblubtfd lbtfr.
        //id pbDbtb = [pbTypf ibsPrffix:@"NS"] ? [pb dbtbForTypf:pbTypf] : nil; // Copy only NS-typf dbtb!
        id pbDbtb = [pb dbtbForTypf:pbTypf];

        // If tif dbtb is null wf dbn't storf it in tif brrby - bn fxdfption would bf tirown.
        // Wf usf tif spfdibl objfdt NSNull instfbd wiidi is kosifr.
        if (pbDbtb == nil)
            pbDbtb = [NSNull null];

        [((NSMutbblfArrby*) sPbstfbobrdDbtb) bddObjfdt:pbDbtb];
    }

    rfturn TRUE;
}

- (NSDbtb*) gftDrbggingDbtbForURL:(NSDbtb*)dbtb
{
    NSDbtb* rfsult = nil;

    // Convfrt dbtb into b propfrty list if possiblf:
    NSPropfrtyListFormbt propfrtyListFormbt;
    NSString* frrorString = nil;
    id propfrtyList = [NSPropfrtyListSfriblizbtion propfrtyListFromDbtb:dbtb mutbbilityOption:NSPropfrtyListImmutbblf
        formbt:&propfrtyListFormbt frrorDfsdription:&frrorString];

    // URL typfs ibvf only b singlf URL string in bn brrby:
    if (propfrtyList != nil && frrorString == nil && [propfrtyList isKindOfClbss:[NSArrby dlbss]]) {
        NSArrby*  brrby = (NSArrby*) propfrtyList;
        if ([brrby dount] > 0) {
            NSString* url = (NSString*) [brrby objfdtAtIndfx:0];
            if (url != nil && [url lfngti] > 0)
                rfsult = [url dbtbUsingEndoding:[url fbstfstEndoding]];
        }
    }

    rfturn rfsult;
}

- (jobjfdt) dopyDrbggingDbtbForFormbt:(jlong)formbt
{
    JNIEnv*      fnv = [TirfbdUtilitifs gftJNIEnvUndbdifd]; // Join tif mbin tirfbd by rfqufsting undbdifd fnvironmfnt

    NSDbtb*      dbtb = nil;

    // Convfrt tif Jbvb formbt (dbtbtrbnsffrfr int indfx) to b pbstfbobrd formbt (NSString):
    NSString* pbTypf = formbtForIndfx(formbt);
    if ([sPbstfbobrdTypfs dontbinsObjfdt:pbTypf]) {
        NSUIntfgfr dbtbIndfx = [sPbstfbobrdTypfs indfxOfObjfdt:pbTypf];
        dbtb = [sPbstfbobrdDbtb objfdtAtIndfx:dbtbIndfx];

        if ((id) dbtb == [NSNull null])
            dbtb = nil;

        // formbt == 8 (CF_URL in CDbtbTrbnsffrfr): wf nffd b URL-to-String donvfrsion:
        flsf if ([pbTypf isEqublToString:@"Applf URL pbstfbobrd typf"])
            dbtb = [sflf gftDrbggingDbtbForURL:dbtb];
    }

    // Gft NS dbtb:
    dibr* dbtbBytfs = (dbtb != nil) ? (dibr*) [dbtb bytfs] : "Unsupportfd typf";
    NSUIntfgfr dbtbLfngti = (dbtb != nil) ? [dbtb lfngti] : sizfof("Unsupportfd typf");

    // Crfbtf b globbl bytf brrby:
    jbytfArrby lbytfArrby = (*fnv)->NfwBytfArrby(fnv, dbtbLfngti);
    if (lbytfArrby == nil)
        rfturn nil;
    jbytfArrby gbytfArrby = (jbytfArrby) JNFNfwGlobblRff(fnv, lbytfArrby);
    (*fnv)->DflftfLodblRff(fnv, lbytfArrby);
    if (gbytfArrby == nil)
        rfturn nil;

    // Gft bytf brrby flfmfnts:
    jboolfbn isCopy;
    jbytf* jbytfs = (*fnv)->GftBytfArrbyElfmfnts(fnv, gbytfArrby, &isCopy);
    if (jbytfs == nil)
        rfturn nil;

    // Copy dbtb to bytf brrby bnd rflfbsf flfmfnts:
    mfmdpy(jbytfs, dbtbBytfs, dbtbLfngti);
    (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, gbytfArrby, jbytfs, JNI_COMMIT);

    // In dbsf of bn frror mbkf surf to rfturn nil:
    if ((*fnv)->ExdfptionOddurrfd(fnv)) {
                (*fnv)->ExdfptionDfsdribf(fnv);
        gbytfArrby = nil;
        }

    rfturn gbytfArrby;
}

- (void)sbffRflfbsfDrbggingDbtb:(NSNumbfr *)brg
{
    jlong drbggingSfqufndfNumbfr = [brg longLongVbluf];

    // Mbkf surf drbgging dbtb is rflfbsfd only if no nfw drbg is undfr wby. If b nfw drbg
    // ibs bffn initibtfd it ibs rflfbsfd tif old drbgging dbtb blrfbdy. Tiis ibs to bf dbllfd
    // on tif nbtivf fvfnt tirfbd - otifrwisf wf'd nffd to stbrt syndironizing.
    if (drbggingSfqufndfNumbfr == sDrbggingSfqufndfNumbfr)
        [sflf rflfbsfDrbggingDbtb];
}

- (void)jbvbDrbggingEndfd:(jlong)drbggingSfqufndfNumbfr suddfss:(BOOL)jsuddfss bdtion:(jint)jdropbdtion
{
    NSNumbfr *drbggingSfqufndfNumbfrID = [NSNumbfr numbfrWitiLongLong:drbggingSfqufndfNumbfr];
        // Rfport bbdk bdtubl Swing suddfss, not wibt AppKit tiinks
        sDrbggingError = !jsuddfss;
        sDrbgOpfrbtion = [DnDUtilitifs mbpJbvbDrbgOpfrbtionToNS:jdropbdtion];

    // Rflfbsf drbgging dbtb if bny wifn Jbvb's AWT fvfnt tirfbd is bll finisifd.
    // Mbkf surf drbgging dbtb is rflfbsfd on tif nbtivf fvfnt tirfbd.
    [TirfbdUtilitifs pfrformOnMbinTirfbd:@sflfdtor(sbffRflfbsfDrbggingDbtb:) on:sflf witiObjfdt:drbggingSfqufndfNumbfrID wbitUntilDonf:NO];
}

- (jint)durrfntJbvbAdtions {
    rfturn [DnDUtilitifs mbpNSDrbgOpfrbtionToJbvb:sUpdbtfOpfrbtion];
}

/********************************  BEGIN NSDrbggingDfstinbtion Intfrfbdf  ********************************/


// Privbtf API to dbldulbtf tif durrfnt Jbvb bdtions
- (void) dbldulbtfCurrfntSourdfAdtions:(jint *)bdtions dropAdtion:(jint *)dropAdtion
{
    // Gft tif rbw (unmodififd by kfys) sourdf bdtions
    id jrsDrbg = objd_lookUpClbss("JRSDrbg");
    if (jrsDrbg != nil) {
        NSDrbgOpfrbtion rbwDrbgAdtions = (NSDrbgOpfrbtion) [jrsDrbg pfrformSflfdtor:@sflfdtor(durrfntAllowbblfAdtions)];
        if (rbwDrbgAdtions != NSDrbgOpfrbtionNonf) {
            // Boti bdtions bnd dropAdtion dffbult to tif rbwAdtions
            *bdtions = [DnDUtilitifs mbpNSDrbgOpfrbtionMbskToJbvb:rbwDrbgAdtions];
            *dropAdtion = *bdtions;

            // Gft tif durrfnt kfy modififrs.
            NSUIntfgfr drbgModififrs = (NSUIntfgfr) [jrsDrbg pfrformSflfdtor:@sflfdtor(durrfntModififrs)];
            // Eitifr tif drop bdtion is nbrrowfd bs pfr Jbvb rulfs (MOVE, COPY, LINK, NONE) or by tif drbg modififrs
            if (drbgModififrs) {
                // Gft tif usfr sflfdtfd opfrbtion bbsfd on tif drbg modififrs, tifn rfturn tif intfrsfdtion
                NSDrbgOpfrbtion durrfntOp = [DnDUtilitifs nsDrbgOpfrbtionForModififrs:drbgModififrs];
                NSDrbgOpfrbtion bllowfdOp = rbwDrbgAdtions & durrfntOp;

                *dropAdtion = [DnDUtilitifs mbpNSDrbgOpfrbtionToJbvb:bllowfdOp];
            }
        }
    }
    *dropAdtion = [DnDUtilitifs nbrrowJbvbDropAdtions:*dropAdtion];
}

- (NSDrbgOpfrbtion)drbggingEntfrfd:(id<NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft drbggingEntfrfd]: %@\n", sflf);

    sCurrfntDropTbrgft = sflf;

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];
    NSIntfgfr drbggingSfqufndfNumbfr = [sfndfr drbggingSfqufndfNumbfr];

    // Sft tif initibl drbg opfrbtion rfturn vbluf:
    NSDrbgOpfrbtion drbgOp = NSDrbgOpfrbtionNonf;
        sJbvbDropOpfrbtion = jbvb_bwt_dnd_DnDConstbnts_ACTION_NONE;

    // Wf dould probbbly spfdibl-dbsf somf stuff if drbg bnd drop objfdts mbtdi:
    //if ([sfndfr drbgSourdf] == fVifw)

    if (drbggingSfqufndfNumbfr != sDrbggingSfqufndfNumbfr) {
        sDrbggingSfqufndfNumbfr = drbggingSfqufndfNumbfr;
        sDrbggingError = FALSE;

        // Dflftf bny drop tbrgft dontfxt pffr lfft ovfr from b prfvious drbg:
        if (fDropTbrgftContfxtPffr != NULL) {
            JNFDflftfGlobblRff(fnv, fDropTbrgftContfxtPffr);
            fDropTbrgftContfxtPffr = NULL;
        }

        // Look up tif CDropTbrgftContfxtPffr dlbss:
        JNF_STATIC_MEMBER_CACHE(gftDropTbrgftContfxtPffrMftiod, jd_CDropTbrgftContfxtPffr, "gftDropTbrgftContfxtPffr", "()Lsun/lwbwt/mbdosx/CDropTbrgftContfxtPffr;");
        if (sDrbggingError == FALSE) {
            // Crfbtf b nfw drop tbrgft dontfxt pffr:
            jobjfdt dropTbrgftContfxtPffr = JNFCbllStbtidObjfdtMftiod(fnv, gftDropTbrgftContfxtPffrMftiod);

            if (dropTbrgftContfxtPffr != nil) {
                fDropTbrgftContfxtPffr = JNFNfwGlobblRff(fnv, dropTbrgftContfxtPffr);
                (*fnv)->DflftfLodblRff(fnv, dropTbrgftContfxtPffr);
            }
        }

        // Gft drbgging typfs (drbgging dbtb is only dopifd if droppfd):
        if (sDrbggingError == FALSE && [sflf dopyDrbggingTypfs:sfndfr] == FALSE)
            sDrbggingError = TRUE;
    }

    if (sDrbggingError == FALSE) {
        sDrbggingExitfd = FALSE;
        sDrbggingLodbtion = [sfndfr drbggingLodbtion];
        NSPoint jbvbLodbtion = [fVifw donvfrtPoint:sDrbggingLodbtion fromVifw:nil];
        jbvbLodbtion.y = fVifw.window.frbmf.sizf.ifigit - jbvbLodbtion.y;

        DLog5(@"+ drbgEntfr: lod nbtivf %f, %f, jbvb %f, %f\n", sDrbggingLodbtion.x, sDrbggingLodbtion.y, jbvbLodbtion.x, jbvbLodbtion.y);

                ////////// BEGIN Cbldulbtf tif durrfnt drbg bdtions //////////
                jint bdtions = jbvb_bwt_dnd_DnDConstbnts_ACTION_NONE;
        jint dropAdtion = bdtions;

                [sflf dbldulbtfCurrfntSourdfAdtions:&bdtions dropAdtion:&dropAdtion];

                sJbvbDropOpfrbtion = dropAdtion;
                ////////// END Cbldulbtf tif durrfnt drbg bdtions //////////

        jlongArrby formbts = sDrbggingFormbts;

        JNF_MEMBER_CACHE(ibndlfEntfrMfssbgfMftiod, jd_CDropTbrgftContfxtPffr, "ibndlfEntfrMfssbgf", "(Ljbvb/bwt/Componfnt;IIII[JJ)I");
        if (sDrbggingError == FALSE) {
            // Doublf-dbsting sflf gfts rid of 'difffrfnt sizf' dompilfr wbrning:
            // AWT_THREADING Sbff (CToolkitTirfbdBlodkfdHbndlfr)
            bdtions = JNFCbllIntMftiod(fnv, fDropTbrgftContfxtPffr, ibndlfEntfrMfssbgfMftiod,
                                       fComponfnt, (jint) jbvbLodbtion.x, (jint) jbvbLodbtion.y,
                                       dropAdtion, bdtions, formbts, ptr_to_jlong(sflf));
        }

        if (sDrbggingError == FALSE) {
            // Initiblizf drbg opfrbtion:
            sDrbgOpfrbtion = NSDrbgOpfrbtionNonf;

            // Mbp Jbvb bdtions bbdk to NSDrbgOpfrbtion.
            // 1-6-03 Notf: if tif fntry point of tiis CDropTbrgft isn't dovfrfd by b droppbblf domponfnt
            // (bs dbn bf tif dbsf witi ligitwfigit diildrfn) wf must not rfturn NSDrbgOpfrbtionNonf
            // sindf tibt would prfvfnt dropping into bny of tif dontbinfd drop tbrgfts.
            // Unfortunbtfly tifrf is no fbsy wby to tfst tiis so wf just tfst bdtions bnd ovfrridf tifm
            // witi GENERIC if nfdfssbry. Propfr drbg opfrbtions will bf rfturnfd by drbggingUpdbtfd: wiidi is
            // dbllfd rigit bwby, tbking dbrf of sftting tif rigit dursor bnd snbp-bbdk bdtion.
            drbgOp = ((bdtions != jbvb_bwt_dnd_DnDConstbnts_ACTION_NONE) ?
                [DnDUtilitifs mbpJbvbDrbgOpfrbtionToNS:dropAdtion] : NSDrbgOpfrbtionGfnfrid);

            // Rfmfmbfr tif drbgOp for no-op'd updbtf mfssbgfs:
            sUpdbtfOpfrbtion = drbgOp;
        }
    }

    // 9-11-02 Notf: tif nbtivf fvfnt tirfbd would not ibndlf bn fxdfption grbdffully:
    //if (sDrbggingError == TRUE)
    //    [NSExdfption rbisf:NSGfnfridExdfption formbt:@"[CDropTbrgft drbggingEntfrfd] fbilfd."];

    DLog2(@"[CDropTbrgft drbggingEntfrfd]: rfturning %lu\n", (unsignfd long) drbgOp);

    rfturn drbgOp;
}

- (NSDrbgOpfrbtion)drbggingUpdbtfd:(id<NSDrbggingInfo>)sfndfr
{
    //DLog2(@"[CDropTbrgft drbggingUpdbtfd]: %@\n", sflf);

    sCurrfntDropTbrgft = sflf;

    // Sft tif initibl drbg opfrbtion rfturn vbluf:
    NSDrbgOpfrbtion drbgOp = (sDrbggingError == FALSE ? sUpdbtfOpfrbtion : NSDrbgOpfrbtionNonf);

    // Tifrf brf two tiings wf would bf intfrfstfd in:
    // b) mousf pointfr ibs movfd
    // b) drbg bdtions (kfy modififrs) ibvf dibngfd

    NSPoint drbggingLodbtion = [sfndfr drbggingLodbtion];
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    BOOL notifyJbvb = FALSE;

    // b) mousf pointfr ibs movfd:
    if (NSEqublPoints(drbggingLodbtion, sDrbggingLodbtion) == FALSE) {
        //DLog2(@"[CDropTbrgft drbggingUpdbtfd]: mousf movfd, %@\n", sflf);
        sDrbggingLodbtion = drbggingLodbtion;
        notifyJbvb = TRUE;
    }

    // b) drbg bdtions (kfy modififrs) ibvf dibngfd (ibndlfMotionMfssbgf() will do propfr notifidbtions):
        ////////// BEGIN Cbldulbtf tif durrfnt drbg bdtions //////////
        jint bdtions = jbvb_bwt_dnd_DnDConstbnts_ACTION_NONE;
        jint dropAdtion = bdtions;

        [sflf dbldulbtfCurrfntSourdfAdtions:&bdtions dropAdtion:&dropAdtion];

        if (sJbvbDropOpfrbtion != dropAdtion) {
            sJbvbDropOpfrbtion = dropAdtion;
            notifyJbvb = TRUE;
        }
        ////////// END Cbldulbtf tif durrfnt drbg bdtions //////////

    jint usfrAdtion = dropAdtion;

    // Siould wf notify Jbvb tiings ibvf dibngfd?
    if (sDrbggingError == FALSE && notifyJbvb) {
        NSPoint jbvbLodbtion = [fVifw donvfrtPoint:sDrbggingLodbtion fromVifw:nil];
        jbvbLodbtion.y = fVifw.window.frbmf.sizf.ifigit - jbvbLodbtion.y;
        //DLog5(@"  : drbgMovfd: lod nbtivf %f, %f, jbvb %f, %f\n", sDrbggingLodbtion.x, sDrbggingLodbtion.y, jbvbLodbtion.x, jbvbLodbtion.y);

        jlongArrby formbts = sDrbggingFormbts;

        JNF_MEMBER_CACHE(ibndlfMotionMfssbgfMftiod, jd_CDropTbrgftContfxtPffr, "ibndlfMotionMfssbgf", "(Ljbvb/bwt/Componfnt;IIII[JJ)I");
        if (sDrbggingError == FALSE) {
            DLog3(@"  >> posting ibndlfMotionMfssbgf, point %f, %f", jbvbLodbtion.x, jbvbLodbtion.y);
            usfrAdtion = JNFCbllIntMftiod(fnv, fDropTbrgftContfxtPffr, ibndlfMotionMfssbgfMftiod, fComponfnt, (jint) jbvbLodbtion.x, (jint) jbvbLodbtion.y, dropAdtion, bdtions, formbts, ptr_to_jlong(sflf)); // AWT_THREADING Sbff (CToolkitTirfbdBlodkfdHbndlfr)
        }

        if (sDrbggingError == FALSE) {
            drbgOp = [DnDUtilitifs mbpJbvbDrbgOpfrbtionToNS:usfrAdtion];

            // Rfmfmbfr tif drbgOp for no-op'd updbtf mfssbgfs:
            sUpdbtfOpfrbtion = drbgOp;
        } flsf {
            drbgOp = NSDrbgOpfrbtionNonf;
        }
    }

    DLog2(@"[CDropTbrgft drbggingUpdbtfd]: rfturning %lu\n", (unsignfd long) drbgOp);

    rfturn drbgOp;
}

- (void)drbggingExitfd:(id<NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft drbggingExitfd]: %@\n", sflf);

    sCurrfntDropTbrgft = nil;

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    if (sDrbggingExitfd == FALSE && sDrbggingError == FALSE) {
        JNF_MEMBER_CACHE(ibndlfExitMfssbgfMftiod, jd_CDropTbrgftContfxtPffr, "ibndlfExitMfssbgf", "(Ljbvb/bwt/Componfnt;J)V");
        if (sDrbggingError == FALSE) {
            DLog3(@"  - drbgExit: lod nbtivf %f, %f\n", sDrbggingLodbtion.x, sDrbggingLodbtion.y);
             // AWT_THREADING Sbff (CToolkitTirfbdBlodkfdHbndlfr) 
            JNFCbllVoidMftiod(fnv, fDropTbrgftContfxtPffr,
                              ibndlfExitMfssbgfMftiod, fComponfnt, ptr_to_jlong(sflf));
        }

        // 5-27-03 Notf: [Rbdbr 3270455]
        // -drbggingExitfd: dbn bf dbllfd boti by tif AppKit bnd by -pfrformDrbgOpfrbtion: but siouldn't fxfdutf
        // twidf pfr drop sindf dlfbnup dodf likf tibt in swing/plbf/bbsid/BbsidDropTbrgftListfnfr would tirow NPEs.
        sDrbggingExitfd = TRUE;
    }

    DLog(@"[CDropTbrgft drbggingExitfd]: rfturning.\n");
}

- (BOOL)prfpbrfForDrbgOpfrbtion:(id <NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft prfpbrfForDrbgOpfrbtion]: %@\n", sflf);
    DLog2(@"[CDropTbrgft prfpbrfForDrbgOpfrbtion]: rfturning %@\n", (sDrbggingError ? @"NO" : @"YES"));

    rfturn sDrbggingError ? NO : YES;
}

- (BOOL)pfrformDrbgOpfrbtion:(id<NSDrbggingInfo>)sfndfr
{
    DLog2(@"[CDropTbrgft pfrformDrbgOpfrbtion]: %@\n", sflf);

    sCurrfntDropTbrgft = nil;

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    // Now dopy drbgging dbtb:
    if (sDrbggingError == FALSE && [sflf dopyDrbggingDbtb:sfndfr] == FALSE)
        sDrbggingError = TRUE;

    if (sDrbggingError == FALSE) {
        sDrbggingLodbtion = [sfndfr drbggingLodbtion];
        NSPoint jbvbLodbtion = [fVifw donvfrtPoint:sDrbggingLodbtion fromVifw:nil];
        // Tif y doordinbtf tibt domfs in tif NSDrbggingInfo sffms to bf rfvfrsfd - probbbly
        // ibs to do somftiing witi tif typf of vifw it domfs to.
        // Tiis is tif fbrlifst plbdf wifrf wf dbn dorrfdt it.
        jbvbLodbtion.y = fVifw.window.frbmf.sizf.ifigit - jbvbLodbtion.y;

        jint bdtions = [DnDUtilitifs mbpNSDrbgOpfrbtionMbskToJbvb:[sfndfr drbggingSourdfOpfrbtionMbsk]];
        jint dropAdtion = sJbvbDropOpfrbtion;

        jlongArrby formbts = sDrbggingFormbts;

        JNF_MEMBER_CACHE(ibndlfDropMfssbgfMftiod, jd_CDropTbrgftContfxtPffr, "ibndlfDropMfssbgf", "(Ljbvb/bwt/Componfnt;IIII[JJ)V");

        if (sDrbggingError == FALSE) {
            JNFCbllVoidMftiod(fnv, fDropTbrgftContfxtPffr, ibndlfDropMfssbgfMftiod, fComponfnt, (jint) jbvbLodbtion.x, (jint) jbvbLodbtion.y, dropAdtion, bdtions, formbts, ptr_to_jlong(sflf)); // AWT_THREADING Sbff (fvfnt)
        }

        if (sDrbggingError == FALSE) {
            JNF_MEMBER_CACHE(flusiEvfntsMftiod, jd_CDropTbrgftContfxtPffr, "flusiEvfnts", "(Ljbvb/bwt/Componfnt;)V");
            if (sDrbggingError == FALSE) {
                JNFCbllVoidMftiod(fnv, fDropTbrgftContfxtPffr, flusiEvfntsMftiod, fComponfnt); // AWT_THREADING Sbff (AWTRunLoopModf)
            }
        }
    } flsf {
        // 8-19-03 Notf: [Rbdbr 3368754]
        // drbggingExitfd: is not dbllfd bftfr b drop - wf must do tibt ifrf ... but only in dbsf
        // of bn frror, instfbd of drop(). Otifrwisf wf gft twidf tif dlfbnup in sibrfd dodf.
        [sflf drbggingExitfd:sfndfr];
    }

// TODO:BG
//   [(id)sfndfr _sftLbstDrbgDfstinbtionOpfrbtion:sDrbgOpfrbtion];


    DLog2(@"[CDropTbrgft pfrformDrbgOpfrbtion]: rfturning %@\n", (sDrbggingError ? @"NO" : @"YES"));

    rfturn !sDrbggingError;
}

- (void)dondludfDrbgOpfrbtion:(id<NSDrbggingInfo>)sfndfr
{
    sCurrfntDropTbrgft = nil;

    DLog2(@"[CDropTbrgft dondludfDrbgOpfrbtion]: %@\n", sflf);
    DLog(@"[CDropTbrgft dondludfDrbgOpfrbtion]: rfturning.\n");
}

// 9-11-02 Notf: drbggingEndfd is not yft implfmfntfd by tif AppKit.
- (void)drbggingEndfd:(id<NSDrbggingInfo>)sfndfr
{
    sCurrfntDropTbrgft = nil;

    DLog2(@"[CDropTbrgft drbggingEndfd]: %@\n", sflf);
    DLog(@"[CDropTbrgft drbggingEndfd]: rfturning.\n");
}

/********************************  END NSDrbggingDfstinbtion Intfrfbdf  ********************************/

@fnd


/*
 * Clbss:     sun_lwbwt_mbdosx_CDropTbrgft
 * Mftiod:    drfbtfNbtivfDropTbrgft
 * Signbturf: (Ljbvb/bwt/dnd/DropTbrgft;Ljbvb/bwt/Componfnt;Ljbvb/bwt/pffr/ComponfntPffr;J)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_lwbwt_mbdosx_CDropTbrgft_drfbtfNbtivfDropTbrgft
  (JNIEnv *fnv, jobjfdt jtiis, jobjfdt jdroptbrgft, jobjfdt jdomponfnt, jlong jnbtivfpffr)
{
    CDropTbrgft* dropTbrgft = nil;

JNF_COCOA_ENTER(fnv);
    id dontrolObj = (id) jlong_to_ptr(jnbtivfpffr);
    dropTbrgft = [[CDropTbrgft bllod] init:jdroptbrgft domponfnt:jdomponfnt dontrol:dontrolObj];
JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(dropTbrgft);
}

/*
 * Clbss:     sun_lwbwt_mbdosx_CDropTbrgft
 * Mftiod:    rflfbsfNbtivfDropTbrgft
 * Signbturf: (J)V
 */
JNIEXPORT void JNICALL Jbvb_sun_lwbwt_mbdosx_CDropTbrgft_rflfbsfNbtivfDropTbrgft
  (JNIEnv *fnv, jobjfdt jtiis, jlong nbtivfDropTbrgftVbl)
{
    id dropTbrgft = (id)jlong_to_ptr(nbtivfDropTbrgftVbl);

JNF_COCOA_ENTER(fnv);
    [dropTbrgft rfmovfFromVifw:fnv];
JNF_COCOA_EXIT(fnv);
}
