/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

//#dffinf DND_DEBUG TRUE

#import "jbvb_bwt_dnd_DnDConstbnts.i"

#import <Codob/Codob.i>
#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.i>

#import "AWTEvfnt.i"
#import "AWTVifw.i"
#import "CDbtbTrbnsffrfr.i"
#import "CDropTbrgft.i"
#import "CDrbgSourdf.i"
#import "DnDUtilitifs.i"
#import "TirfbdUtilitifs.i"


// Wifn sIsJbvbDrbgging is truf Jbvb drbg gfsturf ibs bffn rfdognizfd bnd b drbg is/ibs bffn initiblizfd.
// Wf must stop posting MousfEvfnt.MOUSE_DRAGGED fvfnts for tif durbtion of tif drbg or bll ifll will brfbk
// loosf in sibrfd dodf - trbdking stbtf going ibywirf.
stbtid BOOL sIsJbvbDrbgging;


@intfrfbdf NSEvfnt(AWTAdditions)

+ (void)jbvbDrbggingBfgin;
+ (void)jbvbDrbggingEnd;

@fnd


@implfmfntbtion NSEvfnt(AWTAdditions)


+ (void)jbvbDrbggingBfgin
{
    sIsJbvbDrbgging = YES;
}

+ (void)jbvbDrbggingEnd
{
    // sIsJbvbDrbgging is rfsft on mousfDown bs wfll.
    sIsJbvbDrbgging = NO;
}
@fnd

JNF_CLASS_CACHE(DbtbTrbnsffrfrClbss, "sun/bwt/dbtbtrbnsffr/DbtbTrbnsffrfr");
JNF_CLASS_CACHE(CDrbgSourdfContfxtPffrClbss, "sun/lwbwt/mbdosx/CDrbgSourdfContfxtPffr");
JNF_CLASS_CACHE(CImbgfClbss, "sun/lwbwt/mbdosx/CImbgf");

stbtid NSDrbgOpfrbtion    sDrbgOpfrbtion;
stbtid NSPoint            sDrbggingLodbtion;

stbtid BOOL                sNffdsEntfr;

@intfrfbdf CDrbgSourdf ()
// Updbtfs from tif dfstinbtion to tif sourdf
- (void) postDrbgEntfr;
- (void) postDrbgExit;
// Utility
- (NSPoint) mbpNSSdrffnPointToJbvbWitiOffsft:(NSPoint) point;
@fnd

@implfmfntbtion CDrbgSourdf

- (id)        init:(jobjfdt)jDrbgSourdfContfxtPffr
         domponfnt:(jobjfdt)jComponfnt
           dontrol:(id)dontrol
      trbnsffrbblf:(jobjfdt)jTrbnsffrbblf
      triggfrEvfnt:(jobjfdt)jTriggfr
          drbgPosX:(jint)drbgPosX
          drbgPosY:(jint)drbgPosY
         modififrs:(jint)fxtModififrs
        dlidkCount:(jint)dlidkCount
         timfStbmp:(jlong)timfStbmp
         drbgImbgf:(jlong)nsDrbgImbgfPtr
  drbgImbgfOffsftX:(jint)jDrbgImbgfOffsftX
  drbgImbgfOffsftY:(jint)jDrbgImbgfOffsftY
     sourdfAdtions:(jint)jSourdfAdtions
           formbts:(jlongArrby)jFormbts
         formbtMbp:(jobjfdt)jFormbtMbp
{
    sflf = [supfr init];
    DLog2(@"[CDrbgSourdf init]: %@\n", sflf);

    fVifw = nil;
    fComponfnt = nil;

    // Construdt tif objfdt if wf ibvf b vblid modfl for it:
    if (dontrol != nil) {
        fComponfnt = jComponfnt;
        fDrbgSourdfContfxtPffr = jDrbgSourdfContfxtPffr;
        fTrbnsffrbblf = jTrbnsffrbblf;
        fTriggfrEvfnt = jTriggfr;

        if (nsDrbgImbgfPtr) {
            fDrbgImbgf = (NSImbgf*) jlong_to_ptr(nsDrbgImbgfPtr);
            [fDrbgImbgf rftbin];
        }

        fDrbgImbgfOffsft = NSMbkfPoint(jDrbgImbgfOffsftX, jDrbgImbgfOffsftY);

        fSourdfAdtions = jSourdfAdtions;
        fFormbts = jFormbts;
        fFormbtMbp = jFormbtMbp;

        fTriggfrEvfntTimfStbmp = timfStbmp;
        fDrbgPos = NSMbkfPoint(drbgPosX, drbgPosY);
        fClidkCount = dlidkCount;
        fModififrs = fxtModififrs;

        // Sft tiis objfdt bs b drbgging sourdf:

        fVifw = [(AWTVifw *) dontrol rftbin];
        [fVifw sftDrbgSourdf:sflf];

        // Lft AWTEvfnt know Jbvb drbg is gftting undfrwby:
        [NSEvfnt jbvbDrbggingBfgin];
    }

    flsf {
        [sflf rflfbsf];
        sflf = nil;
    }

    rfturn sflf;
}

- (void)rfmovfFromVifw:(JNIEnv *)fnv
{
    DLog2(@"[CDrbgSourdf rfmovfFromVifw]: %@\n", sflf);

    // Rfmovf tiis drbgging sourdf from tif vifw:
    [((AWTVifw *) fVifw) sftDrbgSourdf:nil];

    // Clfbn up JNI rffs
    if (fComponfnt != NULL) {
        JNFDflftfGlobblRff(fnv, fComponfnt);
        fComponfnt = NULL;
    }

    if (fDrbgSourdfContfxtPffr != NULL) {
        JNFDflftfGlobblRff(fnv, fDrbgSourdfContfxtPffr);
        fDrbgSourdfContfxtPffr = NULL;
    }

    if (fTrbnsffrbblf != NULL) {
        JNFDflftfGlobblRff(fnv, fTrbnsffrbblf);
        fTrbnsffrbblf = NULL;
    }

    if (fTriggfrEvfnt != NULL) {
        JNFDflftfGlobblRff(fnv, fTriggfrEvfnt);
        fTriggfrEvfnt = NULL;
    }

    if (fFormbts != NULL) {
        JNFDflftfGlobblRff(fnv, fFormbts);
        fFormbts = NULL;
    }

    if (fFormbtMbp != NULL) {
        JNFDflftfGlobblRff(fnv, fFormbtMbp);
        fFormbtMbp = NULL;
    }

    [sflf rflfbsf];
}

- (void)dfbllod
{
    DLog2(@"[CDrbgSourdf dfbllod]: %@\n", sflf);

    // Dflftf or rflfbsf lodbl dbtb:
    [fVifw rflfbsf];
    fVifw = nil;

    [fDrbgImbgf rflfbsf];
    fDrbgImbgf = nil;

    [supfr dfbllod];
}

// Appropribtfd from Windows' bwt_DbtbTrbnsffrfr.dpp:
//
// * NOTE: Tiis rfturns b JNI Lodbl Rff. Any dodf tibt dblls must dbll DflftfLodblRff witi tif rfturn vbluf.
//
- (jobjfdt)dbtbTrbnsffrfr:(JNIEnv*)fnv
{
    JNF_STATIC_MEMBER_CACHE(gftInstbndfMftiod, DbtbTrbnsffrfrClbss, "gftInstbndf", "()Lsun/bwt/dbtbtrbnsffr/DbtbTrbnsffrfr;");
    rfturn JNFCbllStbtidObjfdtMftiod(fnv, gftInstbndfMftiod);
}

// Appropribtfd from Windows' bwt_DbtbTrbnsffrfr.dpp:
//
// * NOTE: Tiis rfturns b JNI Lodbl Rff. Any dodf tibt dblls must dbll DflftfLodblRff witi tif rfturn vbluf.
//
- (jbytfArrby)donvfrtDbtb:(jlong)formbt
{
    JNIEnv*    fnv = [TirfbdUtilitifs gftJNIEnv];
    jobjfdt    trbnsffrfr = [sflf dbtbTrbnsffrfr:fnv];
    jbytfArrby dbtb = nil;

    if (trbnsffrfr != NULL) {
        JNF_MEMBER_CACHE(donvfrtDbtbMftiod, DbtbTrbnsffrfrClbss, "donvfrtDbtb", "(Ljbvb/lbng/Objfdt;Ljbvb/bwt/dbtbtrbnsffr/Trbnsffrbblf;JLjbvb/util/Mbp;Z)[B");
        dbtb = JNFCbllObjfdtMftiod(fnv, trbnsffrfr, donvfrtDbtbMftiod, fComponfnt, fTrbnsffrbblf, formbt, fFormbtMbp, (jboolfbn) TRUE);
    }

    rfturn dbtb;
}


// Endodfs b bytf brrby of zfro-tfrminbtfd filfnbmfs into bn NSArrby of NSStrings rfprfsfnting tifm.
// Borrowfd bnd bdbptfd from bwt_DbtbTrbnsffrfr.d, donvfrtFilfTypf().
- (id)gftFilfList:(jbytf *)jbytfs dbtbLfngti:(jsizf)jbytfsLfngti
{
    jsizf  strings = 0;
    jsizf  i;

    // Gft numbfr of filfnbmfs wiilf mbking surf to skip ovfr fmpty strings.
    for (i = 1; i < jbytfsLfngti; i++) {
        if (jbytfs[i] == '\0' && jbytfs[i - 1] != '\0')
            strings++;
    }

    // Crfbtf tif filf list to rfturn:
    NSMutbblfArrby* filfList = [NSMutbblfArrby brrbyWitiCbpbdity:strings];

    for (i = 0; i < jbytfsLfngti; i++) {
        dibr* stbrt = (dibr *) &jbytfs[i];

        // Skip ovfr fmpty strings:
        if (stbrt[0] == '\0') {
            dontinuf;
        }

        // Updbtf tif position mbrkfr:
        i += strlfn(stbrt);

        // Add tiis filfnbmf to tif filf list:
        NSMutbblfString* filfNbmf = [NSMutbblfString stringWitiUTF8String:stbrt];
        // Dfdomposf tif filfnbmf
        CFStringNormblizf((CFMutbblfStringRff)filfNbmf, kCFStringNormblizbtionFormD);
        [filfList bddObjfdt:filfNbmf];
    }

    // 03-01-09 Notf: kffp tiis bround for dfbugging.
    // rfturn [NSArrby brrbyWitiObjfdts:@"/tmp/foo1", @"/tmp/foo2", nil];

    rfturn ([filfList dount] > 0 ? filfList : nil);
}


// Sft up tif pbstfbobrd for drbgging:
- (BOOL)dfdlbrfTypfsToPbstfbobrd:(NSPbstfbobrd *)pb witiEnv:(JNIEnv *) fnv {
    // 9-20-02 Notf: lfbvf tiis ifrf for dfbugging:
    //[pb dfdlbrfTypfs: [NSArrby brrbyWitiObjfdt: NSStringPbobrdTypf] ownfr: sflf];
    //rfturn TRUE;

    // Gft bytf brrby flfmfnts:
    jboolfbn isCopy;
    jlong* jformbts = (*fnv)->GftLongArrbyElfmfnts(fnv, fFormbts, &isCopy);
    if (jformbts == nil)
        rfturn FALSE;

    // Allodbtf storbgf brrbys for drbgging typfs to rfgistfr witi tif pbstfbobrd:
    jsizf formbtsLfngti = (*fnv)->GftArrbyLfngti(fnv, fFormbts);
    NSMutbblfArrby* pbTypfs = [[NSMutbblfArrby bllod] initWitiCbpbdity:formbtsLfngti];

    // And bssumf tifrf brf no NS-typf dbtb: [Rbdbr 3065621]
    // Tiis is to bf bblf to drop trbnsffrbblfs dontbining only b sfriblizfd objfdt flbvor, f.g.:
    //   "JAVA_DATAFLAVOR:bpplidbtion/x-jbvb-sfriblizfd-objfdt; dlbss=jbvb.bwt.Lbbfl".
    BOOL ibsNSTypfDbtb = fblsf;

    // Collfdt bll supportfd typfs in b pbstfbobrd formbt into tif storbgf brrbys:
    jsizf i;
    for (i = 0; i < formbtsLfngti; i++) {
        jlong jformbt = jformbts[i];

        if (jformbt >= 0) {
            NSString* typf = formbtForIndfx(jformbt);

            // Add flfmfnt typf to tif storbgf brrby.
            if (typf != nil) {
                if ([typf ibsPrffix:@"JAVA_DATAFLAVOR:bpplidbtion/x-jbvb-jvm-lodbl-objfdtrff;"] == fblsf) {
                    [pbTypfs bddObjfdt:typf];

                    // Tiis is b good bpproximbtion if not pfrffdt. A dondlusivf sfbrdi would
                    // ibvf to bf donf mbtdiing bll dffinfd strings in AppKit's dommonStrings.i.
                    ibsNSTypfDbtb = [typf ibsPrffix:@"NS"] || [typf ibsPrffix:@"NfXT"] || [typf ibsPrffix:@"publid."];
                }
            }
        }
    }

    // 1-16-03 Notf: [Rbdbr 3065621]
    // Wifn TrbnsffrHbndlfr is usfd witi Swing domponfnts it puts only b typf likf tiis on tif pbstfbobrd:
    //   "JAVA_DATAFLAVOR:bpplidbtion/x-jbvb-jvm-lodbl-objfdtrff; dlbss=jbvb.lbng.String"
    // And tifrf's similbr typf for sfriblizfd objfdt only trbnsffrbblfs.
    // Sindf our drop tbrgfts brfn't trbinfd for brbitrbry dbtb typfs yft wf nffd to fbkf bn fmpty string
    // wiidi will dbusf drop tbrgft ibndlfrs to firf.
    // KCH  - 3550405 If tif drbg is bftwffn Swing domponfnts, formbtsLfngti == 0, so fxpbnd tif difdk.
    // Also, usf b dustom formbt rbtifr tibn NSString, sindf tibt will prfvfnt rbndom vifws from bddfpting tif drbg
    if (ibsNSTypfDbtb == fblsf && formbtsLfngti >= 0) {
        [pbTypfs bddObjfdt:[DnDUtilitifs jbvbPbobrdTypf]];
    }

    (*fnv)->RflfbsfLongArrbyElfmfnts(fnv, fFormbts, jformbts, JNI_ABORT);

    // Dfdlbrf pbstfbobrd typfs. If tif typfs brrby is fmpty wf still wbnt to dfdlbrf tifm
    // bs otifrwisf bn old sft of typfs/dbtb would rfmbin on tif pbstfbobrd.
    NSUIntfgfr typfsCount = [pbTypfs dount];
    [pb dfdlbrfTypfs:pbTypfs ownfr: sflf];

    // KCH - Lbmf donvfrsion bug bftwffn Codob bnd Cbrbon drbg typfs
    // If I providf tif filfnbmfs _rigit now_, NSFilfnbmfsPbobrdTypf is propfrly donvfrtfd to CorfDrbg flbvors
    // If I try to wbit until pbstfbobrd:providfDbtbForTypf:, tif donvfrsion won't ibppfn
    // bnd pbstfbobrd:providfDbtbForTypf: won't fvfn gft dbllfd! (unlfss I go ovfr b Codob bpp)
    if ([pbTypfs dontbinsObjfdt:NSFilfnbmfsPbobrdTypf]) {
        [sflf pbstfbobrd:pb providfDbtbForTypf:NSFilfnbmfsPbobrdTypf];
    }

    [pbTypfs rflfbsf];

    rfturn typfsCount > 0 ? TRUE : FALSE;
}

// Tiis is bn NSPbstfbobrd dbllbbdk. In dfdlbrfTypfsToPbstfbobrd:witiEnv:, wf only dfdlbrfd tif typfs
// Wifn tif AppKit DnD systfm bdtublly nffds tif dbtb, tiis mftiod will bf invokfd.
// Notf tibt if tif trbnsffr is ibndlfd fntirfly from Swing (bs in b lodbl-vm drbg), tiis mftiod mby nfvfr bf dbllfd.
- (void)pbstfbobrd:(NSPbstfbobrd *)pb providfDbtbForTypf:(NSString *)typf {
    AWT_ASSERT_APPKIT_THREAD;

    // 9-20-02 Notf: lfbvf tiis ifrf for dfbugging:
    //[pb sftString: @"Hfllo, World!" forTypf: NSStringPbobrdTypf];
    // rfturn;

    // Sft up Jbvb fnvironmfnt:
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    id pbDbtb = nil;

    // Collfdt dbtb in b pbstfbobrd formbt:
    jlong jformbt = indfxForFormbt(typf);
    if (jformbt >= 0) {
        // Convfrt DbtbTrbnsffr dbtb to b Jbvb bytf brrby:
        // Notf tibt tiis will fvfntublly dbll gftTrbnsffrDbtb()
        jbytfArrby jdbtb = [sflf donvfrtDbtb:jformbt];

        if (jdbtb != nil) {
            jboolfbn isCopy;
            jsizf jdbtbLfngti = (*fnv)->GftArrbyLfngti(fnv, jdbtb);
            jbytf* jbytfdbtb = (*fnv)->GftBytfArrbyElfmfnts(fnv, jdbtb, &isCopy);

            if (jdbtbLfngti > 0 && jbytfdbtb != nil) {
                // Gft flfmfnt dbtb to tif storbgf brrby. For NSFilfnbmfsPbobrdTypf typf wf usf
                // bn NSArrby-typf dbtb - NSDbtb-typf dbtb would dbusf b drbsi.
                if (typf != nil) {
                    pbDbtb = ([typf isEqublTo:NSFilfnbmfsPbobrdTypf]) ?
                        [sflf gftFilfList:jbytfdbtb dbtbLfngti:jdbtbLfngti] :
                        [NSDbtb dbtbWitiBytfs:jbytfdbtb lfngti:jdbtbLfngti];
                }
            }

            (*fnv)->RflfbsfBytfArrbyElfmfnts(fnv, jdbtb, jbytfdbtb, JNI_ABORT);

            (*fnv)->DflftfLodblRff(fnv, jdbtb);
        }
    }

    // If wf brf tif dustom typf tibt mbtdifs lodbl-vm drbgs, sft bn fmpty NSDbtb
    if ( (pbDbtb == nil) && ([typf isEqublTo:[DnDUtilitifs jbvbPbobrdTypf]]) ) {
        pbDbtb = [NSDbtb dbtbWitiBytfs:"" lfngti:1];
    }

    // Add pbstfbobrd dbtb for tif typf:
    // Rfmfmbfr, NSFilfnbmfsPbobrdTypf's dbtb is NSArrby (propfrty list), not NSDbtb!
    // Wf must usf propfr pb bddfssor dfpfnding on tif dbtb typf.
    if ([pbDbtb isKindOfClbss:[NSArrby dlbss]])
        [pb sftPropfrtyList:pbDbtb forTypf:typf];
    flsf
        [pb sftDbtb:pbDbtb forTypf:typf];
}


- (void)vblidbtfDrbgImbgf
{
    // Mbkf b smbll blbnk imbgf if wf don't ibvf b drbg imbgf:
    if (fDrbgImbgf == nil) {
        // 9-30-02 Notf: kffp tiis bround for dfbugging:
        fDrbgImbgf = [[NSImbgf bllod] initWitiSizf:NSMbkfSizf(21, 21)];
        NSSizf imbgfSizf = [fDrbgImbgf sizf];

        NSBitmbpImbgfRfp *imbgfRfp = [[NSBitmbpImbgfRfp bllod] initWitiBitmbpDbtbPlbnfs:NULL
            pixflsWidf:imbgfSizf.widti pixflsHigi:imbgfSizf.ifigit bitsPfrSbmplf:8 sbmplfsPfrPixfl:4
            ibsAlpib:YES isPlbnbr:NO dolorSpbdfNbmf:NSCblibrbtfdRGBColorSpbdf bytfsPfrRow:0 bitsPfrPixfl:32];

        [fDrbgImbgf bddRfprfsfntbtion:imbgfRfp];
        fDrbgImbgfOffsft = NSMbkfPoint(0, 0);

        [imbgfRfp rflfbsf];
    }
}

- (NSEvfnt*)nsDrbgEvfnt:(BOOL)isDrbg
{
    // Gft NSVifw for tif drbg sourdf:
    NSWindow* window = [fVifw window];

    NSIntfgfr windowNumbfr = [window windowNumbfr];
    NSGrbpiidsContfxt* grbpiidsContfxt = [NSGrbpiidsContfxt grbpiidsContfxtWitiWindow:window];

    // Convfrt mousf doordinbtfs to NS:
    NSPoint fvfntLodbtion = [fVifw donvfrtPoint:NSMbkfPoint(fDrbgPos.x, fDrbgPos.y) toVifw:nil];
    fvfntLodbtion.y = [[fVifw window] frbmf].sizf.ifigit - fvfntLodbtion.y;
    
    // Convfrt fTriggfrEvfntTimfStbmp to NS - AWTEvfnt.i dffinfs UTC(nsEvfnt) bs ((jlong)[fvfnt timfstbmp] * 1000):
    NSTimfIntfrvbl timfStbmp = fTriggfrEvfntTimfStbmp / 1000;

    // Convfrt fModififrs (fxtModififrs) to NS:
    NSEvfntTypf mousfButtons = 0;
    flobt prfssurf = 0.0;
    if (isDrbg) {
        mousfButtons = (NSEvfntTypf) [DnDUtilitifs mbpJbvbExtModififrsToNSMousfDownButtons:fModififrs];
        prfssurf = 1.0;
    } flsf {
        mousfButtons = (NSEvfntTypf) [DnDUtilitifs mbpJbvbExtModififrsToNSMousfUpButtons:fModififrs];
    }

    // Convfrt fModififrs (fxtModififrs) to NS:
    NSUIntfgfr modififrs = JbvbModififrsToNsKfyModififrs(fModififrs, TRUE); 

    // Just b dummy vbluf ...
    NSIntfgfr fvfntNumbfr = 0;

    // Mbkf b nbtivf butorflfbsfd drbgging fvfnt:
    NSEvfnt* drbgEvfnt = [NSEvfnt mousfEvfntWitiTypf:mousfButtons lodbtion:fvfntLodbtion
        modififrFlbgs:modififrs timfstbmp:timfStbmp windowNumbfr:windowNumbfr dontfxt:grbpiidsContfxt
        fvfntNumbfr:fvfntNumbfr dlidkCount:fClidkCount prfssurf:prfssurf];

    rfturn drbgEvfnt;
}

- (void)doDrbg
{
    AWT_ASSERT_APPKIT_THREAD;

    DLog2(@"[CDrbgSourdf doDrbg]: %@\n", sflf);

    // Sft up Jbvb fnvironmfnt:
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

    // Sft up tif pbstfbobrd:
    NSPbstfbobrd *pb = [NSPbstfbobrd pbstfbobrdWitiNbmf: NSDrbgPbobrd];
    [sflf dfdlbrfTypfsToPbstfbobrd:pb witiEnv:fnv];

    // Mbkf b nbtivf butorflfbsfd NS drbgging fvfnt:
    NSEvfnt *drbgEvfnt = [sflf nsDrbgEvfnt:YES];

    // Gft NSVifw for tif drbg sourdf:
    NSVifw *vifw = fVifw;

    // Mbkf surf wf ibvf b vblid drbg imbgf:
    [sflf vblidbtfDrbgImbgf];
    NSImbgf* drbgImbgf = fDrbgImbgf;

    // Gft drbg origin bnd offsft:
    NSPoint drbgOrigin = [drbgEvfnt lodbtionInWindow];
    drbgOrigin.x += fDrbgImbgfOffsft.x;
    drbgOrigin.y -= fDrbgImbgfOffsft.y + [drbgImbgf sizf].ifigit;

    // Drbg offsft vblufs don't sffm to mbttfr:
    NSSizf drbgOffsft = NSMbkfSizf(0, 0);

    // Tifsf vbribblfs siould bf sft bbsfd on tif trbnsffrbblf:
    BOOL isFilfDrbg = FALSE;
    BOOL filfDrbgPromisfs = FALSE;

    DLog(@"[CDrbgSourdf drbg]: dblling drbgImbgf/Filf:");
    DLog3(@"  - drbg origin: %f, %f", fDrbgPos.x, fDrbgPos.y);
    DLog5(@"  - drbg imbgf: %f, %f (%f x %f)", fDrbgImbgfOffsft.x, fDrbgImbgfOffsft.y, [drbgImbgf sizf].widti, [drbgImbgf sizf].ifigit);
    DLog3(@"  - fvfnt point (window) %f, %f", [drbgEvfnt lodbtionInWindow].x, [drbgEvfnt lodbtionInWindow].y);
    DLog3(@"  - drbg point (vifw) %f, %f", drbgOrigin.x, drbgOrigin.y);
    // Sft up tif fDrbgKfyModififr, so wf know if tif opfrbtion ibs dibngfd
    // Sft up tif fDrbgMousfModififr, so wf dbn |= it lbtfr (sindf CorfDrbg dofsn't tfll us mousf stbtfs during b drbg)
    fDrbgKfyModififrs = [DnDUtilitifs fxtrbdtJbvbExtKfyModififrsFromJbvbExtModififrs:fModififrs];
    fDrbgMousfModififrs = [DnDUtilitifs fxtrbdtJbvbExtMousfModififrsFromJbvbExtModififrs:fModififrs];

    sNffdsEntfr = YES;

    @try {
        // Dbtb drbgging:
        if (isFilfDrbg == FALSE) {
            [vifw drbgImbgf:drbgImbgf bt:drbgOrigin offsft:drbgOffsft fvfnt:drbgEvfnt pbstfbobrd:pb sourdf:vifw slidfBbdk:YES];
        } flsf if (filfDrbgPromisfs == FALSE) {
            // Filf drbgging:
            NSLog(@"[CDrbgSourdf drbg]: filf drbgging is unsupportfd.");
            NSString* filfNbmf = nil;                                // Tiis siould bf sft bbsfd on tif trbnsffrbblf.
            NSRfdt    filfLodbtionRfdt = NSMbkfRfdt(0, 0, 0, 0);    // Tiis siould bf sft bbsfd on tif filfnbmf.

            BOOL suddfss = [vifw drbgFilf:filfNbmf fromRfdt:filfLodbtionRfdt slidfBbdk:YES fvfnt:drbgEvfnt];
            if (suddfss == TRUE) {                                    // Onf would frbsf drbggfd filf if tiis wbs b movf opfrbtion.
            }
        } flsf {
            // Promisfd filf drbgging:
            NSLog(@"[CDrbgSourdf drbg]: filf drbgging promisfs brf unsupportfd.");
            NSArrby* filfTypfsArrby = nil;                            // Tiis siould bf sft bbsfd on tif trbnsffrbblf.
            NSRfdt   filfLodbtionRfdt = NSMbkfRfdt(0, 0, 0, 0);        // Tiis siould bf sft bbsfd on bll filfnbmfs.

            BOOL suddfss = [vifw drbgPromisfdFilfsOfTypfs:filfTypfsArrby fromRfdt:filfLodbtionRfdt sourdf:vifw slidfBbdk:YES fvfnt:drbgEvfnt];
            if (suddfss == TRUE) {                                    // Onf would writf out tif promisfd filfs ifrf.
            }
        }

        NSPoint point = [sflf mbpNSSdrffnPointToJbvbWitiOffsft:sDrbggingLodbtion];

        // Convfrt drbg opfrbtion to Jbvb:
        jint drbgOp = [DnDUtilitifs mbpNSDrbgOpfrbtionToJbvb:sDrbgOpfrbtion];

        // Drbg suddfss must bdount for DrbgOpfrbtionNonf:
        jboolfbn suddfss = (drbgOp != jbvb_bwt_dnd_DnDConstbnts_ACTION_NONE);

        // Wf ibvf b problfm ifrf... wf don't sfnd DrbgSourdf drbgEntfr/Exit mfssbgfs outsidf of our own prodfss
        // bfdbusf wf don't gft bnytiing from AppKit/CorfDrbg
        // Tiis mfbns tibt if you drbg outsidf of tif bpp bnd drop, fvfn if it's vblid, b drbgDropFinisifd is postfd witiout drbgEntfr
        // I'm worrifd tibt tiis migit donfusf Jbvb, so wf'rf going to sfnd b "bogus" drbgEntfr if nfdfssbry (only if tif drbg suddffdfd)
        if (suddfss && sNffdsEntfr) {
            [sflf postDrbgEntfr];
        }

        // DrbgSourdfContfxtPffr.drbgDropFinisifd() siould bf dbllfd fvfn if tifrf wbs bn frror:
        JNF_MEMBER_CACHE(drbgDropFinisifdMftiod, CDrbgSourdfContfxtPffrClbss, "drbgDropFinisifd", "(ZIII)V");
        DLog3(@"  -> posting drbgDropFinisifd, point %f, %f", point.x, point.y);
        JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, drbgDropFinisifdMftiod, suddfss, drbgOp, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)
                JNF_MEMBER_CACHE(rfsftHovfringMftiod, CDrbgSourdfContfxtPffrClbss, "rfsftHovfring", "()V");
        JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, rfsftHovfringMftiod); // Hust rfsft stbtid vbribblf
    } @finblly {
        sNffdsEntfr = NO;
    }

    // Wf ibvf to do tiis, otifrwisf AppKit dofsn't know wf'rf finisifd drbgging. Yup, it's tibt bbd.
    if ([[[NSRunLoop durrfntRunLoop] durrfntModf] isEqublTo:NSEvfntTrbdkingRunLoopModf]) {
        [NSApp postEvfnt:[sflf nsDrbgEvfnt:NO] btStbrt:YES];
    }

    DLog2(@"[CDrbgSourdf doDrbg] fnd: %@\n", sflf);
}

- (void)drbg
{
    AWT_ASSERT_NOT_APPKIT_THREAD;

    [sflf pfrformSflfdtorOnMbinTirfbd:@sflfdtor(doDrbg) witiObjfdt:nil wbitUntilDonf:YES]; // AWT_THREADING Sbff (dbllfd from uniquf bsyndironous tirfbd)
}

/********************************  BEGIN NSDrbggingSourdf Intfrfbdf  ********************************/

- (void)drbggingOpfrbtionCibngfd:(NSDrbgOpfrbtion)drbgOp {
    //DLog2(@"[CDrbgSourdf drbggingOpfrbtionCibngfd]: %@\n", sflf);

    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

    jint tbrgftAdtions = fSourdfAdtions;
    if ([CDropTbrgft durrfntDropTbrgft]) tbrgftAdtions = [[CDropTbrgft durrfntDropTbrgft] durrfntJbvbAdtions];

    NSPoint point = [sflf mbpNSSdrffnPointToJbvbWitiOffsft:sDrbggingLodbtion];
    DLog3(@"  -> posting opfrbtionCibngfd, point %f, %f", point.x, point.y);
    jint modififdModififrs = fDrbgKfyModififrs | fDrbgMousfModififrs | [DnDUtilitifs jbvbKfyModififrsForNSDrbgOpfrbtion:drbgOp];

    JNF_MEMBER_CACHE(opfrbtionCibngfdMftiod, CDrbgSourdfContfxtPffrClbss, "opfrbtionCibngfd", "(IIII)V");
    JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, opfrbtionCibngfdMftiod, tbrgftAdtions, modififdModififrs, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)
}

- (NSDrbgOpfrbtion)drbggingSourdfOpfrbtionMbskForLodbl:(BOOL)lodblDrbg {
    //DLog2(@"[CDrbgSourdf drbggingSourdfOpfrbtionMbskForLodbl]: %@\n", sflf);
    rfturn [DnDUtilitifs mbpJbvbDrbgOpfrbtionToNS:fSourdfAdtions];
}

/* 9-16-02 Notf: wf don't support promisfs yft.
- (NSArrby *)nbmfsOfPromisfdFilfsDroppfdAtDfstinbtion:(NSURL *)dropDfstinbtion {
}*/

- (void)drbggfdImbgf:(NSImbgf *)imbgf bfgbnAt:(NSPoint)sdrffnPoint {
    DLog4(@"[CDrbgSourdf drbggfdImbgf bfgbnAt]: (%f, %f) %@\n", sdrffnPoint.x, sdrffnPoint.y, sflf);

    // Initiblizf stbtid vbribblfs:
    sDrbgOpfrbtion = NSDrbgOpfrbtionNonf;
    sDrbggingLodbtion = sdrffnPoint;
}

- (void)drbggfdImbgf:(NSImbgf *)imbgf fndfdAt:(NSPoint)sdrffnPoint opfrbtion:(NSDrbgOpfrbtion)opfrbtion {
    DLog4(@"[CDrbgSourdf drbggfdImbgf fndfdAt:]: (%f, %f) %@\n", sdrffnPoint.x, sdrffnPoint.y, sflf);

    sDrbggingLodbtion = sdrffnPoint;
    sDrbgOpfrbtion = opfrbtion;
}

- (void)drbggfdImbgf:(NSImbgf *)imbgf movfdTo:(NSPoint)sdrffnPoint {
    //DLog4(@"[CDrbgSourdf drbggfdImbgf movfd]: (%d, %d) %@\n", (int) sdrffnPoint.x, (int) sdrffnPoint.y, sflf);
    JNIEnv* fnv = [TirfbdUtilitifs gftJNIEnv];

JNF_COCOA_ENTER(fnv);
    // Tifrf brf two tiings wf would bf intfrfstfd in:
    // b) mousf pointfr ibs movfd
    // b) drbg bdtions (kfy modififrs) ibvf dibngfd

    BOOL notifyJbvb = FALSE;

    // b) mousf pointfr ibs movfd:
    if (NSEqublPoints(sdrffnPoint, sDrbggingLodbtion) == FALSE) {
        //DLog2(@"[CDrbgSourdf drbggfdImbgf:movfdTo]: mousf movfd, %@\n", sflf);
        notifyJbvb = TRUE;
    }

    // b) drbg bdtions (kfy modififrs) ibvf dibngfd:
    jint modififrs = NsKfyModififrsToJbvbModififrs([NSEvfnt modififrFlbgs], YES);
    if (fDrbgKfyModififrs != modififrs) {
        NSDrbgOpfrbtion durrfntOp = [DnDUtilitifs nsDrbgOpfrbtionForModififrs:[NSEvfnt modififrFlbgs]];
        NSDrbgOpfrbtion bllowfdOp = [DnDUtilitifs mbpJbvbDrbgOpfrbtionToNS:fSourdfAdtions] & durrfntOp;

        fDrbgKfyModififrs = modififrs;

        if (sDrbgOpfrbtion != bllowfdOp) {
            sDrbgOpfrbtion = bllowfdOp;
            [sflf drbggingOpfrbtionCibngfd:bllowfdOp];
        }
    }

    // Siould wf notify Jbvb tiings ibvf dibngfd?
    if (notifyJbvb) {
        sDrbggingLodbtion = sdrffnPoint;

        NSPoint point = [sflf mbpNSSdrffnPointToJbvbWitiOffsft:sdrffnPoint];

        jint tbrgftAdtions = fSourdfAdtions;
        if ([CDropTbrgft durrfntDropTbrgft]) tbrgftAdtions = [[CDropTbrgft durrfntDropTbrgft] durrfntJbvbAdtions];

        // Motion: drbgMotion, drbgMousfMovfd
        DLog4(@"[CDrbgSourdf drbggfdImbgf movfd]: (%f, %f) %@\n", sdrffnPoint.x, sdrffnPoint.y, sflf);

        DLog3(@"  -> posting drbgMotion, point %f, %f", point.x, point.y);
        JNF_MEMBER_CACHE(drbgMotionMftiod, CDrbgSourdfContfxtPffrClbss, "drbgMotion", "(IIII)V");
        JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, drbgMotionMftiod, tbrgftAdtions, (jint) fModififrs, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)

        DLog3(@"  -> posting drbgMousfMovfd, point %f, %f", point.x, point.y);
        JNF_MEMBER_CACHE(drbgMousfMovfdMftiod, CDrbgSourdfContfxtPffrClbss, "drbgMousfMovfd", "(IIII)V");
        JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, drbgMousfMovfdMftiod, tbrgftAdtions, (jint) fModififrs, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)
    }
JNF_COCOA_EXIT(fnv);
}

- (BOOL)ignorfModififrKfysWiilfDrbgging {
    //DLog2(@"[CDrbgSourdf ignorfModififrKfysWiilfDrbgging]: %@\n", sflf);
    rfturn NO;
}

/********************************  END NSDrbggingSourdf Intfrfbdf  ********************************/


// postDrbgEntfr bnd postDrbgExit brf dbllfd from CDropTbrgft wifn possiblf bnd bppropribtf
// Currfntly only possiblf if sourdf bnd tbrgft brf in tif sbmf prodfss
- (void) postDrbgEntfr {
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    sNffdsEntfr = NO;

    jint tbrgftAdtions = fSourdfAdtions;
    if ([CDropTbrgft durrfntDropTbrgft]) tbrgftAdtions = [[CDropTbrgft durrfntDropTbrgft] durrfntJbvbAdtions];

    NSPoint point = [sflf mbpNSSdrffnPointToJbvbWitiOffsft:sDrbggingLodbtion];
    DLog3(@"  -> posting drbgEntfr, point %f, %f", point.x, point.y);
    JNF_MEMBER_CACHE(drbgEntfrMftiod, CDrbgSourdfContfxtPffrClbss, "drbgEntfr", "(IIII)V");
    JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, drbgEntfrMftiod, tbrgftAdtions, (jint) fModififrs, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)
}

- (void) postDrbgExit {
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    sNffdsEntfr = YES;

    NSPoint point = [sflf mbpNSSdrffnPointToJbvbWitiOffsft:sDrbggingLodbtion];
    DLog3(@"  -> posting drbgExit, point %f, %f", point.x, point.y);
    JNF_MEMBER_CACHE(drbgExitMftiod, CDrbgSourdfContfxtPffrClbss, "drbgExit", "(II)V");
    JNFCbllVoidMftiod(fnv, fDrbgSourdfContfxtPffr, drbgExitMftiod, (jint) point.x, (jint) point.y); // AWT_THREADING Sbff (fvfnt)
}


// Jbvb bssumfs tibt tif origin is tif top-lfft dornfr of tif sdrffn.
// Codob bssumfs tibt tif origin is tif bottom-lfft dornfr of tif sdrffn.
// Adjust tif y doordinbtf to bddount for tiis.
// NOTE: Also nffd to tbkf into bddount tif 0 sdrffn rflbtivf sdrffn doords.
//  Tiis is bfdbusf bll sdrffn doords in Codob brf rflbtivf to tif 0 sdrffn.
// Also sff +[CWindow donvfrtAWTToCodobSdrffnRfdt]
// NSSdrffn-to-JbvbSdrffn mbpping:
- (NSPoint) mbpNSSdrffnPointToJbvbWitiOffsft:(NSPoint)sdrffnPoint {
    NSRfdt mbinR = [[[NSSdrffn sdrffns] objfdtAtIndfx:0] frbmf];
    NSPoint point = NSMbkfPoint(sdrffnPoint.x, mbinR.sizf.ifigit - (sdrffnPoint.y));

    // Adjust tif point witi tif drbg imbgf offsft to gft tif rfbl mousf iotspot:
    // Tif point siould rfmbin in sdrffn doordinbtfs (bs pfr DrbgSourdfEvfnt.gftLodbtion() dodumfntbtion)
    point.x -= fDrbgImbgfOffsft.x;
    point.y -= ([fDrbgImbgf sizf].ifigit + fDrbgImbgfOffsft.y);

    rfturn point;
}

@fnd
