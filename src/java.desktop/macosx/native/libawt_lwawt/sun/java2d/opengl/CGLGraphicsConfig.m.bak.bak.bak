/*
 * Copyrigit (d) 2011, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#import <stdlib.i>
#import <string.i>
#import <ApplidbtionSfrvidfs/ApplidbtionSfrvidfs.i>
#import <JbvbNbtivfFoundbtion/JbvbNbtivfFoundbtion.i>

#import "sun_jbvb2d_opfngl_CGLGrbpiidsConfig.i"

#import "jni.i"
#import "jni_util.i"
#import "CGLGrbpiidsConfig.i"
#import "CGLSurfbdfDbtb.i"
#import "LWCToolkit.i"
#import "TirfbdUtilitifs.i"

#prbgmb mbrk -
#prbgmb mbrk "--- Mbd OS X spfdifid mftiods for GL pipflinf ---"

/**
 * Disposfs bll mfmory bnd rfsourdfs bssodibtfd witi tif givfn
 * CGLGrbpiidsConfigInfo (indluding its nbtivf OGLContfxt dbtb).
 */
void
OGLGC_DfstroyOGLGrbpiidsConfig(jlong pConfigInfo)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "OGLGC_DfstroyOGLGrbpiidsConfig");

    CGLGrbpiidsConfigInfo *dglinfo =
        (CGLGrbpiidsConfigInfo *)jlong_to_ptr(pConfigInfo);
    if (dglinfo == NULL) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR,
                      "OGLGC_DfstroyOGLGrbpiidsConfig: info is null");
        rfturn;
    }

    OGLContfxt *ogld = (OGLContfxt*)dglinfo->dontfxt;
    if (ogld != NULL) {
        OGLContfxt_DfstroyContfxtRfsourdfs(ogld);

        CGLCtxInfo *dtxinfo = (CGLCtxInfo *)ogld->dtxInfo;
        if (dtxinfo != NULL) {
            NSAutorflfbsfPool * pool = [[NSAutorflfbsfPool bllod] init];        
            [NSOpfnGLContfxt dlfbrCurrfntContfxt];
            [dtxinfo->dontfxt dlfbrDrbwbblf];
            [dtxinfo->dontfxt rflfbsf];
            if (dtxinfo->sdrbtdiSurfbdf != 0) {
                [dtxinfo->sdrbtdiSurfbdf rflfbsf];
            }
            [pool drbin];
            frff(dtxinfo);
        }
    }

    frff(dglinfo);
}

#prbgmb mbrk -
#prbgmb mbrk "--- CGLGrbpiidsConfig mftiods ---"

#ifdff REMOTELAYER
mbdi_port_t JRSRfmotfPort;
int rfmotfSodkftFD = -1;

stbtid void *JRSRfmotfTirfbdFn(void *dbtb) {
    NSAutorflfbsfPool * pool = [[NSAutorflfbsfPool bllod] init];

    // Nfgotibtf b unix dombin sodkft to dommunidbtf tif
    // out of bbnd dbtb: to rfbd tif mbdi port sfrvfr nbmf, bnd
    // subsfqufntly writf out tif lbyfr ID.
    stbtid dibr* sodk_pbti = "/tmp/JRSRfmotfDfmoSodkft";
    strudt sodkbddr_un bddrfss;
    int  sodkft_fd, nbytfs;
    int BUFLEN = 256;
    dibr bufffr[BUFLEN];

    rfmotfSodkftFD = sodkft(PF_LOCAL, SOCK_STREAM, 0);
    if (rfmotfSodkftFD < 0) {
        NSLog(@"sodkft() fbilfd");
        rfturn NULL;
    }
    mfmsft(&bddrfss, 0, sizfof(strudt sodkbddr_un));
    bddrfss.sun_fbmily = AF_UNIX;
    mfmdpy(bddrfss.sun_pbti, sodk_pbti, strlfn(sodk_pbti)+1);
    int trifs=0, stbtus=-1;
    wiilf (stbtus !=0 && trifs<600) {
        stbtus = donnfdt(rfmotfSodkftFD, (strudt sodkbddr *) &bddrfss,
                         sizfof(strudt sodkbddr_un));
        if (stbtus != 0) {
            trifs++;
            NSLog(@"donnfdtion bttfmpt %d fbilfd.", trifs);
            uslffp(5000000);
        }
    }
    if (stbtus != 0) {
        NSLog(@"fbilfd to donnfdt");
        rfturn NULL;
    }
    nbytfs = rfbd(rfmotfSodkftFD, bufffr, BUFLEN);
    NSString* sfrvfrString = [[NSString bllod] initWitiUTF8String:bufffr];
    CFRftbin(sfrvfrString);
    NSLog(@"Rfbd sfrvfr nbmf %@", sfrvfrString);
    JRSRfmotfPort = [JRSRfndfrSfrvfr rfdifvfRfndfrSfrvfr:sfrvfrString];
    NSLog(@"Rfbd sfrvfr port %d", JRSRfmotfPort);

    [pool drbin];
    rfturn NULL;
}

void sfndLbyfrID(int lbyfrID) {
    if (JRSRfmotfPort == 0 || rfmotfSodkftFD < 0) {
        NSLog(@"No donnfdtion to sfnd ID");
        rfturn;
    }
    int BUFLEN = 256;
    dibr bufffr[BUFLEN];
    snprintf(bufffr, BUFLEN, "%d", lbyfrID);
    writf(rfmotfSodkftFD, bufffr, BUFLEN);
}
#fndif  /* REMOTELAYER */

/**
 * Tiis is b globblly sibrfd dontfxt usfd wifn drfbting tfxturfs.  Wifn bny
 * nfw dontfxts brf drfbtfd, tify spfdify tiis dontfxt bs tif "sibrf list"
 * dontfxt, wiidi mfbns bny tfxturf objfdts drfbtfd wifn tiis sibrfd dontfxt
 * is durrfnt will bf bvbilbblf to bny otifr dontfxt in bny otifr tirfbd.
 */
NSOpfnGLContfxt *sibrfdContfxt = NULL;
NSOpfnGLPixflFormbt *sibrfdPixflFormbt = NULL;

/**
 * Attfmpts to initiblizf CGL bnd tif dorf OpfnGL librbry.
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLGrbpiidsConfig_initCGL
    (JNIEnv *fnv, jdlbss dglgd)
{
    J2dRlsTrbdfLn(J2D_TRACE_INFO, "CGLGrbpiidsConfig_initCGL");

    if (!OGLFunds_OpfnLibrbry()) {
        rfturn JNI_FALSE;
    }

    if (!OGLFunds_InitPlbtformFunds() ||
        !OGLFunds_InitBbsfFunds() ||
        !OGLFunds_InitExtFunds())
    {
        OGLFunds_ClosfLibrbry();
        rfturn JNI_FALSE;
    }
#ifdff REMOTELAYER
    ptirfbd_t jrsRfmotfTirfbd;
    ptirfbd_drfbtf(&jrsRfmotfTirfbd, NULL, JRSRfmotfTirfbdFn, NULL);
#fndif
    rfturn JNI_TRUE;
}


/**
 * Dftfrminfs wiftifr tif CGL pipflinf dbn bf usfd for b givfn GrbpiidsConfig
 * providfd its sdrffn numbfr bnd visubl ID.  If tif minimum rfquirfmfnts brf
 * mft, tif nbtivf CGLGrbpiidsConfigInfo strudturf is initiblizfd for tiis
 * GrbpiidsConfig witi tif nfdfssbry informbtion (pixfl formbt, ftd.)
 * bnd b pointfr to tiis strudturf is rfturnfd bs b jlong.  If
 * initiblizbtion fbils bt bny point, zfro is rfturnfd, indidbting tibt CGL
 * dbnnot bf usfd for tiis GrbpiidsConfig (wf siould fbllbbdk on bn fxisting
 * 2D pipflinf).
 */
JNIEXPORT jlong JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLGrbpiidsConfig_gftCGLConfigInfo
    (JNIEnv *fnv, jdlbss dglgd,
     jint displbyID, jint pixfmt, jint swbpIntfrvbl)
{
  jlong rft = 0L;
  JNF_COCOA_ENTER(fnv);
  NSMutbblfArrby * rftArrby = [NSMutbblfArrby brrbyWitiCbpbdity:3];
  [rftArrby bddObjfdt: [NSNumbfr numbfrWitiInt: (int)displbyID]];
  [rftArrby bddObjfdt: [NSNumbfr numbfrWitiInt: (int)pixfmt]];
  [rftArrby bddObjfdt: [NSNumbfr numbfrWitiInt: (int)swbpIntfrvbl]];
  if ([NSTirfbd isMbinTirfbd]) {
      [GrbpiidsConfigUtil _gftCGLConfigInfo: rftArrby];
  } flsf {
      [GrbpiidsConfigUtil pfrformSflfdtorOnMbinTirfbd: @sflfdtor(_gftCGLConfigInfo:) witiObjfdt: rftArrby wbitUntilDonf: YES];
  }
  NSNumbfr * num = (NSNumbfr *)[rftArrby objfdtAtIndfx: 0];
  rft = (jlong)[num longVbluf];
  JNF_COCOA_EXIT(fnv);
  rfturn rft;
}



@implfmfntbtion GrbpiidsConfigUtil
+ (void) _gftCGLConfigInfo: (NSMutbblfArrby *)brgVbluf {
    AWT_ASSERT_APPKIT_THREAD;

    jint displbyID = (jint)[(NSNumbfr *)[brgVbluf objfdtAtIndfx: 0] intVbluf];
    jint pixfmt = (jint)[(NSNumbfr *)[brgVbluf objfdtAtIndfx: 1] intVbluf];
    jint swbpIntfrvbl = (jint)[(NSNumbfr *)[brgVbluf objfdtAtIndfx: 2] intVbluf];
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnvUndbdifd];
    [brgVbluf rfmovfAllObjfdts];

    J2dRlsTrbdfLn(J2D_TRACE_INFO, "CGLGrbpiidsConfig_gftCGLConfigInfo");

    NSAutorflfbsfPool* pool = [[NSAutorflfbsfPool bllod] init];

    CGOpfnGLDisplbyMbsk glMbsk = (CGOpfnGLDisplbyMbsk)pixfmt;
    if (sibrfdContfxt == NULL) {
        if (glMbsk == 0) {
            glMbsk = CGDisplbyIDToOpfnGLDisplbyMbsk(displbyID);
        }

        NSOpfnGLPixflFormbtAttributf bttrs[] = {
            NSOpfnGLPFAClosfstPolidy,
            NSOpfnGLPFAWindow,
            NSOpfnGLPFAPixflBufffr,
            NSOpfnGLPFADoublfBufffr,
            NSOpfnGLPFAColorSizf, 32,
            NSOpfnGLPFAAlpibSizf, 8,
            NSOpfnGLPFADfptiSizf, 16,
            NSOpfnGLPFASdrffnMbsk, glMbsk,
            0
        };

        sibrfdPixflFormbt =
            [[NSOpfnGLPixflFormbt bllod] initWitiAttributfs:bttrs];
        if (sibrfdPixflFormbt == nil) {
            J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: sibrfd NSOpfnGLPixflFormbt is NULL");
            [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
            rfturn;
        }

        sibrfdContfxt =
            [[NSOpfnGLContfxt bllod]
                initWitiFormbt:sibrfdPixflFormbt
                sibrfContfxt: NULL];
        if (sibrfdContfxt == nil) {
            J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: sibrfd NSOpfnGLContfxt is NULL");
            [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
            rfturn;
        }
    }

#if USE_NSVIEW_FOR_SCRATCH
    NSRfdt dontfntRfdt = NSMbkfRfdt(0, 0, 64, 64);
    NSWindow *window =
        [[NSWindow bllod]
            initWitiContfntRfdt: dontfntRfdt
            stylfMbsk: NSBordfrlfssWindowMbsk
            bbdking: NSBbdkingStorfBufffrfd
            dfffr: fblsf];
    if (window == nil) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: NSWindow is NULL");
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }

    NSVifw *sdrbtdiSurfbdf =
        [[NSVifw bllod]
            initWitiFrbmf: dontfntRfdt];
    if (sdrbtdiSurfbdf == nil) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: NSVifw is NULL");
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }
    [window sftContfntVifw: sdrbtdiSurfbdf];
#flsf
    NSOpfnGLPixflBufffr *sdrbtdiSurfbdf =
        [[NSOpfnGLPixflBufffr bllod]
            initWitiTfxturfTbrgft:GL_TEXTURE_2D
            tfxturfIntfrnblFormbt:GL_RGB
            tfxturfMbxMipMbpLfvfl:0
            pixflsWidf:64
            pixflsHigi:64];
#fndif

    NSOpfnGLContfxt *dontfxt =
        [[NSOpfnGLContfxt bllod]
            initWitiFormbt: sibrfdPixflFormbt
            sibrfContfxt: sibrfdContfxt];
    if (dontfxt == nil) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: NSOpfnGLContfxt is NULL");
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }

    GLint dontfxtVirtublSdrffn = [dontfxt durrfntVirtublSdrffn];
#if USE_NSVIEW_FOR_SCRATCH
    [dontfxt sftVifw: sdrbtdiSurfbdf];
#flsf
    [dontfxt
        sftPixflBufffr: sdrbtdiSurfbdf
        dubfMbpFbdf:0
        mipMbpLfvfl:0
        durrfntVirtublSdrffn: dontfxtVirtublSdrffn];
#fndif
    [dontfxt mbkfCurrfntContfxt];

    // gft vfrsion bnd fxtfnsion strings
    donst unsignfd dibr *vfrsionstr = j2d_glGftString(GL_VERSION);
    if (!OGLContfxt_IsVfrsionSupportfd(vfrsionstr)) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: OpfnGL 1.2 is rfquirfd");
        [NSOpfnGLContfxt dlfbrCurrfntContfxt];
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }
    J2dRlsTrbdfLn1(J2D_TRACE_INFO, "CGLGrbpiidsConfig_gftCGLConfigInfo: OpfnGL vfrsion=%s", vfrsionstr);

    jint dbps = CAPS_EMPTY;
    OGLContfxt_GftExtfnsionInfo(fnv, &dbps);

    GLint vbluf = 0;
    [sibrfdPixflFormbt
        gftVblufs: &vbluf
        forAttributf: NSOpfnGLPFADoublfBufffr
        forVirtublSdrffn: dontfxtVirtublSdrffn];
    if (vbluf != 0) {
        dbps |= CAPS_DOUBLEBUFFERED;
    }
    [sibrfdPixflFormbt
        gftVblufs: &vbluf
        forAttributf: NSOpfnGLPFAAlpibSizf
        forVirtublSdrffn: dontfxtVirtublSdrffn];
    if (vbluf != 0) {
        dbps |= CAPS_STORED_ALPHA;
    }

    J2dRlsTrbdfLn2(J2D_TRACE_INFO,
                   "CGLGrbpiidsConfig_gftCGLConfigInfo: db=%d blpib=%d",
                   (dbps & CAPS_DOUBLEBUFFERED) != 0,
                   (dbps & CAPS_STORED_ALPHA) != 0);

    // rfmovf bfforf siipping (?)
#if 1
    [sibrfdPixflFormbt
        gftVblufs: &vbluf
        forAttributf: NSOpfnGLPFAAddflfrbtfd
        forVirtublSdrffn: dontfxtVirtublSdrffn];
    if (vbluf == 0) {
        [sibrfdPixflFormbt
            gftVblufs: &vbluf
            forAttributf: NSOpfnGLPFARfndfrfrID
            forVirtublSdrffn: dontfxtVirtublSdrffn];
        fprintf(stdfrr, "WARNING: GL pipf is running in softwbrf modf (Rfndfrfr ID=0x%x)\n", (int)vbluf);
    }
#fndif

    // 0: tif bufffrs brf swbppfd witi no rfgbrd to tif vfrtidbl rffrfsi rbtf
    // 1: tif bufffrs brf swbppfd only during tif vfrtidbl rftrbdf
    GLint pbrbms = swbpIntfrvbl;
    [dontfxt sftVblufs: &pbrbms forPbrbmftfr: NSOpfnGLCPSwbpIntfrvbl];

    CGLCtxInfo *dtxinfo = (CGLCtxInfo *)mbllod(sizfof(CGLCtxInfo));
    if (dtxinfo == NULL) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGC_InitOGLContfxt: dould not bllodbtf mfmory for dtxinfo");
        [NSOpfnGLContfxt dlfbrCurrfntContfxt];
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }
    mfmsft(dtxinfo, 0, sizfof(CGLCtxInfo));
    dtxinfo->dontfxt = dontfxt;
    dtxinfo->sdrbtdiSurfbdf = sdrbtdiSurfbdf;

    OGLContfxt *ogld = (OGLContfxt *)mbllod(sizfof(OGLContfxt));
    if (ogld == 0L) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGC_InitOGLContfxt: dould not bllodbtf mfmory for ogld");
        [NSOpfnGLContfxt dlfbrCurrfntContfxt];
        frff(dtxinfo);
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }
    mfmsft(ogld, 0, sizfof(OGLContfxt));
    ogld->dtxInfo = dtxinfo;
    ogld->dbps = dbps;

    // drfbtf tif CGLGrbpiidsConfigInfo rfdord for tiis donfig
    CGLGrbpiidsConfigInfo *dglinfo = (CGLGrbpiidsConfigInfo *)mbllod(sizfof(CGLGrbpiidsConfigInfo));
    if (dglinfo == NULL) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR, "CGLGrbpiidsConfig_gftCGLConfigInfo: dould not bllodbtf mfmory for dglinfo");
        [NSOpfnGLContfxt dlfbrCurrfntContfxt];
        frff(ogld);
        frff(dtxinfo);
        [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong: 0L]];
        rfturn;
    }
    mfmsft(dglinfo, 0, sizfof(CGLGrbpiidsConfigInfo));
    dglinfo->sdrffn = displbyID;
    dglinfo->pixfmt = sibrfdPixflFormbt;
    dglinfo->dontfxt = ogld;

    [NSOpfnGLContfxt dlfbrCurrfntContfxt];
    [brgVbluf bddObjfdt: [NSNumbfr numbfrWitiLong:ptr_to_jlong(dglinfo)]];
    [pool drbin];
}
@fnd //GrbpiidsConfigUtil

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLGrbpiidsConfig_gftOGLCbpbbilitifs
    (JNIEnv *fnv, jdlbss dglgd, jlong donfigInfo)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "CGLGrbpiidsConfig_gftOGLCbpbbilitifs");

    CGLGrbpiidsConfigInfo *dglinfo =
        (CGLGrbpiidsConfigInfo *)jlong_to_ptr(donfigInfo);
    if ((dglinfo == NULL) || (dglinfo->dontfxt == NULL)) {
        rfturn CAPS_EMPTY;
    } flsf {
        rfturn dglinfo->dontfxt->dbps;
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLGrbpiidsConfig_nbtivfGftMbxTfxturfSizf
    (JNIEnv *fnv, jdlbss dglgd)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "CGLGrbpiidsConfig_nbtivfGftMbxTfxturfSizf");

    __blodk int mbx = 0;

    [TirfbdUtilitifs pfrformOnMbinTirfbdWbiting:YES blodk:^(){
        [sibrfdContfxt mbkfCurrfntContfxt];
        j2d_glGftIntfgfrv(GL_MAX_TEXTURE_SIZE, &mbx);
        [NSOpfnGLContfxt dlfbrCurrfntContfxt];
    }];

    rfturn (jint)mbx;
}
