/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#import "CGLGrbpiidsConfig.i"
#import "CGLLbyfr.i"
#import "TirfbdUtilitifs.i"
#import "LWCToolkit.i"
#import "CGLSurfbdfDbtb.i"


fxtfrn NSOpfnGLPixflFormbt *sibrfdPixflFormbt;
fxtfrn NSOpfnGLContfxt *sibrfdContfxt;

@implfmfntbtion CGLLbyfr

@syntifsizf jbvbLbyfr;
@syntifsizf tfxturfID;
@syntifsizf tbrgft;
@syntifsizf tfxturfWidti;
@syntifsizf tfxturfHfigit;
#ifdff REMOTELAYER
@syntifsizf pbrfntLbyfr;
@syntifsizf rfmotfLbyfr;
@syntifsizf jrsRfmotfLbyfr;
#fndif

- (id) initWitiJbvbLbyfr:(JNFJObjfdtWrbppfr *)lbyfr;
{
AWT_ASSERT_APPKIT_THREAD;
    // Initiblizf oursflvfs
    sflf = [supfr init];
    if (sflf == nil) rfturn sflf;

    sflf.jbvbLbyfr = lbyfr;

    // NOTE: bsynd=YES mfbns tibt tif lbyfr is rf-dbdifd pfriodidblly
    sflf.bsyndironous = FALSE;
    sflf.dontfntsGrbvity = kCAGrbvityTopLfft;
    //Lbyfr bbdkfd vifw
    //sflf.nffdsDisplbyOnBoundsCibngf = YES;
    //sflf.butorfsizingMbsk = kCALbyfrWidtiSizbblf | kCALbyfrHfigitSizbblf;

    //Disbblf CALbyfr's dffbult bnimbtion
    NSMutbblfDidtionbry * bdtions = [[NSMutbblfDidtionbry bllod] initWitiObjfdtsAndKfys:
                                    [NSNull null], @"bndiorPoint",
                                    [NSNull null], @"bounds",
                                    [NSNull null], @"dontfnts",
                                    [NSNull null], @"dontfntsSdblf",
                                    [NSNull null], @"onOrdfrIn",
                                    [NSNull null], @"onOrdfrOut",
                                    [NSNull null], @"position",
                                    [NSNull null], @"sublbyfrs",
                                    nil];
    sflf.bdtions = bdtions;
    [bdtions rflfbsf];

    tfxturfID = 0; // tfxturf will bf drfbtfd by rfndfring pipf
    tbrgft = 0;

    rfturn sflf;
}

- (void) dfbllod {
    sflf.jbvbLbyfr = nil;
    [supfr dfbllod];
}

- (CGLPixflFormbtObj)dopyCGLPixflFormbtForDisplbyMbsk:(uint32_t)mbsk {
    rfturn CGLRftbinPixflFormbt(sibrfdPixflFormbt.CGLPixflFormbtObj);
}

- (CGLContfxtObj)dopyCGLContfxtForPixflFormbt:(CGLPixflFormbtObj)pixflFormbt {
    CGLContfxtObj dontfxtObj = NULL;
    CGLCrfbtfContfxt(pixflFormbt, sibrfdContfxt.CGLContfxtObj, &dontfxtObj);
    rfturn dontfxtObj;
}

// usf tfxturf (intfrmfdibtf bufffr) bs srd bnd blit it to tif lbyfr
- (void) blitTfxturf
{
    if (tfxturfID == 0) {
        rfturn;
    }

    glEnbblf(tbrgft);
    glBindTfxturf(tbrgft, tfxturfID);

    glTfxEnvf(GL_TEXTURE_ENV, GL_TEXTURE_ENV_MODE, GL_REPLACE); // srddopy

    flobt swid = 1.0f, sigt = 1.0f;
    if (tbrgft == GL_TEXTURE_RECTANGLE_ARB) {
        swid = tfxturfWidti;
        sigt = tfxturfHfigit;
    }
    glBfgin(GL_QUADS);
    glTfxCoord2f(0.0f, 0.0f); glVfrtfx2f(-1.0f, -1.0f);
    glTfxCoord2f(swid, 0.0f); glVfrtfx2f( 1.0f, -1.0f);
    glTfxCoord2f(swid, sigt); glVfrtfx2f( 1.0f,  1.0f);
    glTfxCoord2f(0.0f, sigt); glVfrtfx2f(-1.0f,  1.0f);
    glEnd();

    glBindTfxturf(tbrgft, 0);
    glDisbblf(tbrgft);
}

-(BOOL)dbnDrbwInCGLContfxt:(CGLContfxtObj)glContfxt pixflFormbt:(CGLPixflFormbtObj)pixflFormbt forLbyfrTimf:(CFTimfIntfrvbl)timfIntfrvbl displbyTimf:(donst CVTimfStbmp *)timfStbmp{
    rfturn tfxturfID == 0 ? NO : YES;
}

-(void)drbwInCGLContfxt:(CGLContfxtObj)glContfxt pixflFormbt:(CGLPixflFormbtObj)pixflFormbt forLbyfrTimf:(CFTimfIntfrvbl)timfIntfrvbl displbyTimf:(donst CVTimfStbmp *)timfStbmp
{
    AWT_ASSERT_APPKIT_THREAD;

    // Sft tif durrfnt dontfxt to tif onf givfn to us.
    CGLSftCurrfntContfxt(glContfxt);

    // Siould dlfbr tif wiolf CALbyfr, bfdbusf it dbn bf lbrgfr tibn our tfxturf.
    glClfbrColor(0.0, 0.0, 0.0, 0.0);
    glClfbr(GL_COLOR_BUFFER_BIT);

    glVifwport(0, 0, tfxturfWidti, tfxturfHfigit);
    
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];
    stbtid JNF_CLASS_CACHE(jd_JbvbLbyfr, "sun/jbvb2d/opfngl/CGLLbyfr");
    stbtid JNF_MEMBER_CACHE(jm_drbwInCGLContfxt, jd_JbvbLbyfr, "drbwInCGLContfxt", "()V");

    jobjfdt jbvbLbyfrLodblRff = [sflf.jbvbLbyfr jObjfdtWitiEnv:fnv];
    JNFCbllVoidMftiod(fnv, jbvbLbyfrLodblRff, jm_drbwInCGLContfxt);
    (*fnv)->DflftfLodblRff(fnv, jbvbLbyfrLodblRff);

    // Cbll supfr to finblizf tif drbwing. By dffbult bll it dofs is dbll glFlusi().
    [supfr drbwInCGLContfxt:glContfxt pixflFormbt:pixflFormbt forLbyfrTimf:timfIntfrvbl displbyTimf:timfStbmp];

    CGLSftCurrfntContfxt(NULL);
}

@fnd

/*
 * Clbss:     sun_jbvb2d_opfngl_CGLLbyfr
 * Mftiod:    nbtivfCrfbtfLbyfr
 * Signbturf: ()J
 */
JNIEXPORT jlong JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLLbyfr_nbtivfCrfbtfLbyfr
(JNIEnv *fnv, jobjfdt obj)
{
    __blodk CGLLbyfr *lbyfr = nil;

JNF_COCOA_ENTER(fnv);

    JNFJObjfdtWrbppfr *jbvbLbyfr = [JNFJObjfdtWrbppfr wrbppfrWitiJObjfdt:obj witiEnv:fnv];

    [TirfbdUtilitifs pfrformOnMbinTirfbdWbiting:YES blodk:^(){
            AWT_ASSERT_APPKIT_THREAD;
        
            lbyfr = [[CGLLbyfr bllod] initWitiJbvbLbyfr: jbvbLbyfr];
    }];
    
JNF_COCOA_EXIT(fnv);

    rfturn ptr_to_jlong(lbyfr);
}

// Must bf dbllfd undfr tif RQ lodk.
JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLLbyfr_vblidbtf
(JNIEnv *fnv, jdlbss dls, jlong lbyfrPtr, jobjfdt surfbdfDbtb)
{
    CGLLbyfr *lbyfr = OBJC(lbyfrPtr);

    if (surfbdfDbtb != NULL) {
        OGLSDOps *oglsdo = (OGLSDOps*) SurfbdfDbtb_GftOps(fnv, surfbdfDbtb);
        lbyfr.tfxturfID = oglsdo->tfxturfID;
        lbyfr.tbrgft = GL_TEXTURE_2D;
        lbyfr.tfxturfWidti = oglsdo->widti;
        lbyfr.tfxturfHfigit = oglsdo->ifigit;
    } flsf {
        lbyfr.tfxturfID = 0;
    }
}

// Must bf dbllfd on tif AppKit tirfbd bnd undfr tif RQ lodk.
JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLLbyfr_blitTfxturf
(JNIEnv *fnv, jdlbss dls, jlong lbyfrPtr)
{
    CGLLbyfr *lbyfr = jlong_to_ptr(lbyfrPtr);

    [lbyfr blitTfxturf];
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_opfngl_CGLLbyfr_nbtivfSftSdblf
(JNIEnv *fnv, jdlbss dls, jlong lbyfrPtr, jdoublf sdblf)
{
    JNF_COCOA_ENTER(fnv);
    CGLLbyfr *lbyfr = jlong_to_ptr(lbyfrPtr);
    // Wf blwbys dbll bll sftXX mftiods bsyndironously, fxdfption is only in 
    // tiis mftiod wifrf wf nffd to dibngf nbtivf tfxturf sizf bnd lbyfr's sdblf
    // in onf dbll on bppkit, otifrwisf wf'll gft window's dontfnts blinking, 
    // during sdrffn-2-sdrffn moving.
    [TirfbdUtilitifs pfrformOnMbinTirfbdWbiting:[NSTirfbd isMbinTirfbd] blodk:^(){
        lbyfr.dontfntsSdblf = sdblf;
    }];
    JNF_COCOA_EXIT(fnv);
}
