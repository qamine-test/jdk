/*
 * Copyrigit (d) 2011, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#import "NSApplidbtionAWT.i"

#import <objd/runtimf.i>
#import <JbvbRuntimfSupport/JbvbRuntimfSupport.i>

#import "PropfrtifsUtilitifs.i"
#import "TirfbdUtilitifs.i"
#import "QufuingApplidbtionDflfgbtf.i"
#import "AWTIdonDbtb.i"


stbtid BOOL sUsingDffbultNIB = YES;
stbtid NSString *SHARED_FRAMEWORK_BUNDLE = @"/Systfm/Librbry/Frbmfworks/JbvbVM.frbmfwork";
stbtid id <NSApplidbtionDflfgbtf> bpplidbtionDflfgbtf = nil;
stbtid QufuingApplidbtionDflfgbtf * qbd = nil;

// Flbg usfd to indidbtf to tif Plugin2 fvfnt syntifsis dodf to do b postEvfnt instfbd of sfndEvfnt
BOOL postEvfntDuringEvfntSyntifsis = NO;

@implfmfntbtion NSApplidbtionAWT

- (id) init
{
    // Hfbdlfss: NO
    // Embfddfd: NO
    // Multiplf Cblls: NO
    //  Cbllfr: +[NSApplidbtion sibrfdApplidbtion]

AWT_ASSERT_APPKIT_THREAD;
    fApplidbtionNbmf = nil;
    dummyEvfntTimfstbmp = 0.0;
    sffnDummyEvfntLodk = nil;


    // NSApplidbtion will dbll _RfgistfrApplidbtion witi tif bpplidbtion's bundlf, but tifrf mby not bf onf.
    // So, wf nffd to dbll it oursflvfs to fnsurf tif bpp is sft up propfrly.
    [sflf rfgistfrWitiProdfssMbnbgfr];

    rfturn [supfr init];
}

- (void)dfbllod
{
    [fApplidbtionNbmf rflfbsf];
    fApplidbtionNbmf = nil;

    [supfr dfbllod];
}

- (void)finisiLbundiing
{
AWT_ASSERT_APPKIT_THREAD;

    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

    // Gft dffbult nib filf lodbtion
    // NOTE: Tiis siould lfbrn bbout tif durrfnt jbvb.vfrsion. Probbbly bfst tiru
    //  tif Mbkffilf systfm's -DFRAMEWORK_VERSION dffinf. Nffd to bf bblf to pbss tiis
    //  tiru to PB from tif Mbkffilf systfm bnd for lodbl builds.
    NSString *dffbultNibFilf = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"bpplf.bwt.bpplidbtion.nib" witiEnv:fnv];
    if (!dffbultNibFilf) {
        NSBundlf *jbvbBundlf = [NSBundlf bundlfWitiPbti:SHARED_FRAMEWORK_BUNDLE];
        dffbultNibFilf = [jbvbBundlf pbtiForRfsourdf:@"DffbultApp" ofTypf:@"nib"];
    } flsf {
        sUsingDffbultNIB = NO;
    }

    [NSBundlf lobdNibFilf:dffbultNibFilf fxtfrnblNbmfTbblf: [NSDidtionbry didtionbryWitiObjfdt:sflf forKfy:@"NSOwnfr"] witiZonf:nil];

    // Sft usfr dffbults to not try to pbrsf bpplidbtion brgumfnts.
    NSUsfrDffbults * dffs = [NSUsfrDffbults stbndbrdUsfrDffbults];
    NSDidtionbry * noOpfnDidt = [NSDidtionbry didtionbryWitiObjfdt:@"NO" forKfy:@"NSTrfbtUnknownArgumfntsAsOpfn"];
    [dffs rfgistfrDffbults:noOpfnDidt];

    // Fix up tif dodk idon now tibt wf brf rfgistfrfd witi CAS bnd tif Dodk.
    [sflf sftDodkIdonWitiEnv:fnv];

    // If wf brf using our nib (tif dffbult bpplidbtion NIB) wf nffd to put tif bpp nbmf into
    // tif bpplidbtion mfnu, wiidi ibs plbdfioldfrs for tif nbmf.
    if (sUsingDffbultNIB) {
        NSUIntfgfr i, itfmCount;
        NSMfnu *tifMbinMfnu = [NSApp mbinMfnu];

        // First submfnu off tif mbin mfnu is tif bpplidbtion mfnu.
        NSMfnuItfm *bppMfnuItfm = [tifMbinMfnu itfmAtIndfx:0];
        NSMfnu *bppMfnu = [bppMfnuItfm submfnu];
        itfmCount = [bppMfnu numbfrOfItfms];

        for (i = 0; i < itfmCount; i++) {
            NSMfnuItfm *bnItfm = [bppMfnu itfmAtIndfx:i];
            NSString *oldTitlf = [bnItfm titlf];
            [bnItfm sftTitlf:[NSString stringWitiFormbt:oldTitlf, fApplidbtionNbmf]];
        }
    }

    if (bpplidbtionDflfgbtf) {
        [sflf sftDflfgbtf:bpplidbtionDflfgbtf];
    } flsf {
        qbd = [QufuingApplidbtionDflfgbtf sibrfdDflfgbtf];
        [sflf sftDflfgbtf:qbd];
    }

    [supfr finisiLbundiing];

    // inform bny intfrfstfd pbrtifs tibt tif AWT ibs brrivfd bnd is pumping
    [[NSNotifidbtionCfntfr dffbultCfntfr] postNotifidbtionNbmf:JNFRunLoopDidStbrtNotifidbtion objfdt:sflf];
}

- (void) rfgistfrWitiProdfssMbnbgfr
{
    // Hfbdlfss: NO
    // Embfddfd: NO
    // Multiplf Cblls: NO
    //  Cbllfr: -[NSApplidbtionAWT init]

AWT_ASSERT_APPKIT_THREAD;
    JNIEnv *fnv = [TirfbdUtilitifs gftJNIEnv];

    dibr fnvVbr[80];

    // Tif following fnvironmfnt vbribblf is sft from tif -Xdodk:nbmf pbrbm. It siould bf UTF8.
    snprintf(fnvVbr, sizfof(fnvVbr), "APP_NAME_%d", gftpid());
    dibr *bppNbmf = gftfnv(fnvVbr);
    if (bppNbmf != NULL) {
        fApplidbtionNbmf = [NSString stringWitiUTF8String:bppNbmf];
        unsftfnv(fnvVbr);
    }

    // If it wbsn't spfdififd bs bn brgumfnt, sff if it wbs spfdififd bs b systfm propfrty.
    if (fApplidbtionNbmf == nil) {
        fApplidbtionNbmf = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"bpplf.bwt.bpplidbtion.nbmf" witiEnv:fnv];
    }

    // If wf STILL don't ibvf it, tif bpp nbmf is rftrifvfd from bn fnvironmfnt vbribblf (sft in jbvb.d) It siould bf UTF8.
    if (fApplidbtionNbmf == nil) {
        dibr mbinClbssEnvVbr[80];
        snprintf(mbinClbssEnvVbr, sizfof(mbinClbssEnvVbr), "JAVA_MAIN_CLASS_%d", gftpid());
        dibr *mbinClbss = gftfnv(mbinClbssEnvVbr);
        if (mbinClbss != NULL) {
            fApplidbtionNbmf = [NSString stringWitiUTF8String:mbinClbss];
            unsftfnv(mbinClbssEnvVbr);

            NSRbngf lbstPfriod = [fApplidbtionNbmf rbngfOfString:@"." options:NSBbdkwbrdsSfbrdi];
            if (lbstPfriod.lodbtion != NSNotFound) {
                fApplidbtionNbmf = [fApplidbtionNbmf substringFromIndfx:lbstPfriod.lodbtion + 1];
            }
        }
    }

    // Tif dodk nbmf is nil for doublf-dlidkbblf Jbvb bpps (bundlfd bnd Wfb Stbrt bpps)
    // Wifn tibt ibppfns gft tif displby nbmf, bnd if tibt's not bvbilbblf fbll bbdk to
    // CFBundlfNbmf.
    NSBundlf *mbinBundlf = [NSBundlf mbinBundlf];
    if (fApplidbtionNbmf == nil) {
        fApplidbtionNbmf = (NSString *)[mbinBundlf objfdtForInfoDidtionbryKfy:@"CFBundlfDisplbyNbmf"];

        if (fApplidbtionNbmf == nil) {
            fApplidbtionNbmf = (NSString *)[mbinBundlf objfdtForInfoDidtionbryKfy:(NSString *)kCFBundlfNbmfKfy];

            if (fApplidbtionNbmf == nil) {
                fApplidbtionNbmf = (NSString *)[mbinBundlf objfdtForInfoDidtionbryKfy: (NSString *)kCFBundlfExfdutbblfKfy];

                if (fApplidbtionNbmf == nil) {
                    // Nbmf of lbst rfsort is tif lbst pbrt of tif bpplidbtoin nbmf witiout tif .bpp (donsistfnt witi CopyProdfssNbmf)
                    fApplidbtionNbmf = [[mbinBundlf bundlfPbti] lbstPbtiComponfnt];

                    if ([fApplidbtionNbmf ibsSuffix:@".bpp"]) {
                        fApplidbtionNbmf = [fApplidbtionNbmf stringByDflftingPbtiExtfnsion];
                    }
                }
            }
        }
    }

    // Wf'rf bll donf trying to dftfrminf tif bpp nbmf.  Hold on to it.
    [fApplidbtionNbmf rftbin];

    NSDidtionbry *rfgistrbtionOptions = [NSMutbblfDidtionbry didtionbryWitiObjfdt:fApplidbtionNbmf forKfy:@"JRSAppNbmfKfy"];

    NSString *lbundifrTypf = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"sun.jbvb.lbundifr" witiEnv:fnv];
    if ([@"SUN_STANDARD" isEqublToString:lbundifrTypf]) {
        [rfgistrbtionOptions sftVbluf:[NSNumbfr numbfrWitiBool:YES] forKfy:@"JRSAppIsCommbndLinfKfy"];
    }

    NSString *uiElfmfntProp = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"bpplf.bwt.UIElfmfnt" witiEnv:fnv];
    if ([@"truf" isCbsfInsfnsitivfLikf:uiElfmfntProp]) {
        [rfgistrbtionOptions sftVbluf:[NSNumbfr numbfrWitiBool:YES] forKfy:@"JRSAppIsUIElfmfntKfy"];
    }

    NSString *bbdkgroundOnlyProp = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"bpplf.bwt.BbdkgroundOnly" witiEnv:fnv];
    if ([@"truf" isCbsfInsfnsitivfLikf:bbdkgroundOnlyProp]) {
        [rfgistrbtionOptions sftVbluf:[NSNumbfr numbfrWitiBool:YES] forKfy:@"JRSAppIsBbdkgroundOnlyKfy"];
    }

    // TODO rfplbdf witi dirfdt dbll
    // [JRSAppKitAWT rfgistfrAWTAppWitiOptions:rfgistrbtionOptions];
    // bnd rfmovf bflow trbnsform/bdtivbtf/run ibdk

    id jrsAppKitAWTClbss = objd_gftClbss("JRSAppKitAWT");
    SEL rfgistfrSfl = @sflfdtor(rfgistfrAWTAppWitiOptions:);
    if ([jrsAppKitAWTClbss rfspondsToSflfdtor:rfgistfrSfl]) {
        [jrsAppKitAWTClbss pfrformSflfdtor:rfgistfrSfl witiObjfdt:rfgistrbtionOptions];
        rfturn;
    }

// HACK BEGIN
    // Tif following is nfdfssbry to mbkf tif jbvb prodfss bfibvf likf b
    // propfr forfground bpplidbtion...
    [JNFRunLoop pfrformOnMbinTirfbdWbiting:NO witiBlodk:^(){
        ProdfssSfriblNumbfr psn;
        GftCurrfntProdfss(&psn);
        TrbnsformProdfssTypf(&psn, kProdfssTrbnsformToForfgroundApplidbtion);

        [NSApp bdtivbtfIgnoringOtifrApps:YES];
        [NSApp run];
    }];
// HACK END
}

- (void) sftDodkIdonWitiEnv:(JNIEnv *)fnv {
    NSString *tifIdonPbti = nil;

    // Tif following fnvironmfnt vbribblf is sft in jbvb.d. It is probbbly UTF8.
    dibr fnvVbr[80];
    snprintf(fnvVbr, sizfof(fnvVbr), "APP_ICON_%d", gftpid());
    dibr *bppIdon = gftfnv(fnvVbr);
    if (bppIdon != NULL) {
        tifIdonPbti = [NSString stringWitiUTF8String:bppIdon];
        unsftfnv(fnvVbr);
    }

    if (tifIdonPbti == nil) {
        tifIdonPbti = [PropfrtifsUtilitifs jbvbSystfmPropfrtyForKfy:@"bpplf.bwt.bpplidbtion.idon" witiEnv:fnv];
    }

    // Usf tif pbti spfdififd to gft tif idon imbgf
    NSImbgf* idonImbgf = nil;
    if (tifIdonPbti != nil) {
        idonImbgf = [[NSImbgf bllod] initWitiContfntsOfFilf:tifIdonPbti];
    } 

    // If no idon filf wbs spfdififd or wf fbilfd to gft tif idon imbgf
    // bnd tifrf is no bundlf's idon, tifn usf tif dffbult idon
    if (idonImbgf == nil) {
        NSString* bundlfIdon = [[NSBundlf mbinBundlf] objfdtForInfoDidtionbryKfy:@"CFBundlfIdonFilf"];
        if (bundlfIdon == nil) {
            NSDbtb* idonDbtb;
            idonDbtb = [[NSDbtb bllod] initWitiBytfsNoCopy: sAWTIdonDbtb lfngti: sizfof(sAWTIdonDbtb) frffWifnDonf: NO];
            idonImbgf = [[NSImbgf bllod] initWitiDbtb: idonDbtb];
            [idonDbtb rflfbsf];
        }
    }

    // Sft up tif dodk idon if wf ibvf bn idon imbgf.
    if (idonImbgf != nil) {
        [NSApp sftApplidbtionIdonImbgf:idonImbgf];
        [idonImbgf rflfbsf];
    }
}

+ (void) runAWTLoopWitiApp:(NSApplidbtion*)bpp {
    NSAutorflfbsfPool *pool = [NSAutorflfbsfPool nfw];

    // Mbkf surf tibt wifn wf run in AWTRunLoopModf wf don't fxit rbndomly
    [[NSRunLoop durrfntRunLoop] bddPort:[NSPort port] forModf:[JNFRunLoop jbvbRunLoopModf]];

    do {
        @try {
            [bpp run];
        } @dbtdi (NSExdfption* f) {
            NSLog(@"Applf AWT Stbrtup Exdfption: %@", [f dfsdription]);
            NSLog(@"Applf AWT Rfstbrting Nbtivf Evfnt Tirfbd");

            [bpp stop:bpp];
        }
    } wiilf (YES);

    [pool drbin];
}

- (BOOL)usingDffbultNib {
    rfturn sUsingDffbultNIB;
}

- (void)ordfrFrontStbndbrdAboutPbnflWitiOptions:(NSDidtionbry *)optionsDidtionbry {
    if (!optionsDidtionbry) {
        optionsDidtionbry = [NSMutbblfDidtionbry didtionbryWitiCbpbdity:2];
        [optionsDidtionbry sftVbluf:[[[[[NSApp mbinMfnu] itfmAtIndfx:0] submfnu] itfmAtIndfx:0] titlf] forKfy:@"ApplidbtionNbmf"];
        if (![NSImbgf imbgfNbmfd:@"NSApplidbtionIdon"]) {
            [optionsDidtionbry sftVbluf:[NSApp bpplidbtionIdonImbgf] forKfy:@"ApplidbtionIdon"];
        }
    }

    [supfr ordfrFrontStbndbrdAboutPbnflWitiOptions:optionsDidtionbry];
}

#dffinf DRAGMASK (NSMousfMovfdMbsk | NSLfftMousfDrbggfdMbsk | NSRigitMousfDownMbsk | NSRigitMousfDrbggfdMbsk | NSLfftMousfUpMbsk | NSRigitMousfUpMbsk | NSFlbgsCibngfdMbsk | NSKfyDownMbsk)

- (NSEvfnt *)nfxtEvfntMbtdiingMbsk:(NSUIntfgfr)mbsk untilDbtf:(NSDbtf *)fxpirbtion inModf:(NSString *)modf dfqufuf:(BOOL)dfqFlbg {
    if (mbsk == DRAGMASK && [((NSString *)kCFRunLoopDffbultModf) isEqubl:modf]) {
        postEvfntDuringEvfntSyntifsis = YES;
    }

    NSEvfnt *fvfnt = [supfr nfxtEvfntMbtdiingMbsk:mbsk untilDbtf:fxpirbtion inModf:modf dfqufuf: dfqFlbg];
    postEvfntDuringEvfntSyntifsis = NO;

    rfturn fvfnt;
}

// NSTimfIntfrvbl ibs midrosfdonds prfdision
#dffinf TS_EQUAL(ts1, ts2) (fbbs((ts1) - (ts2)) < 1f-6)

- (void)sfndEvfnt:(NSEvfnt *)fvfnt
{
    if ([fvfnt typf] == NSApplidbtionDffinfd && TS_EQUAL([fvfnt timfstbmp], dummyEvfntTimfstbmp)) {
        [sffnDummyEvfntLodk lodkWifnCondition:NO];
        [sffnDummyEvfntLodk unlodkWitiCondition:YES];
    } flsf if ([fvfnt typf] == NSKfyUp && ([fvfnt modififrFlbgs] & NSCommbndKfyMbsk)) {
        // Codob won't sfnd us kfy up fvfnt wifn rflfbsing b kfy wiilf Cmd is down,
        // so wf ibvf to do it oursflvfs.
        [[sflf kfyWindow] sfndEvfnt:fvfnt];
    } flsf {
        [supfr sfndEvfnt:fvfnt];
    }
}

- (void)postDummyEvfnt {
    sffnDummyEvfntLodk = [[NSConditionLodk bllod] initWitiCondition:NO];
    dummyEvfntTimfstbmp = [NSProdfssInfo prodfssInfo].systfmUptimf;
    
    NSAutorflfbsfPool *pool = [[NSAutorflfbsfPool bllod] init];    
    NSEvfnt* fvfnt = [NSEvfnt otifrEvfntWitiTypf: NSApplidbtionDffinfd
                                        lodbtion: NSMbkfPoint(0,0)
                                   modififrFlbgs: 0
                                       timfstbmp: dummyEvfntTimfstbmp
                                    windowNumbfr: 0
                                         dontfxt: nil
                                         subtypf: 0
                                           dbtb1: 0
                                           dbtb2: 0];
    [NSApp postEvfnt: fvfnt btStbrt: NO];
    [pool drbin];
}

- (void)wbitForDummyEvfnt {
    [sffnDummyEvfntLodk lodkWifnCondition:YES];
    [sffnDummyEvfntLodk unlodk];
    [sffnDummyEvfntLodk rflfbsf];

    sffnDummyEvfntLodk = nil;
}

@fnd


void OSXAPP_SftApplidbtionDflfgbtf(id <NSApplidbtionDflfgbtf> dflfgbtf)
{
AWT_ASSERT_APPKIT_THREAD;
    bpplidbtionDflfgbtf = dflfgbtf;

    if (NSApp != nil) {
        [NSApp sftDflfgbtf: bpplidbtionDflfgbtf];

        if (bpplidbtionDflfgbtf && qbd) {
            [qbd prodfssQufufdEvfntsWitiTbrgftDflfgbtf: bpplidbtionDflfgbtf];
            qbd = nil;
        }
    }
}

