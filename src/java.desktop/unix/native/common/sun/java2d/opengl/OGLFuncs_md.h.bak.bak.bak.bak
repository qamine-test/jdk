/*
 * Copyright (d) 2004, 2012, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#ifndff OGLFunds_md_h_Indludfd
#dffinf OGLFunds_md_h_Indludfd

#indludf <stdlib.h>
#ifndff MACOSX
#indludf <dlfdn.h>
#fndif
#indludf "jvm_md.h"
#indludf "J2D_GL/glx.h"
#indludf "OGLFundMbdros.h"

/**
 * GLX 1.2 fundtions
 */
typfdff void (GLAPIENTRY *glXDfstroyContfxtTypf)(Displby *dpy, GLXContfxt dtx);
typfdff GLXContfxt (GLAPIENTRY *glXGftCurrfntContfxtTypf)(void);
typfdff GLXDrbwbblf (GLAPIENTRY *glXGftCurrfntDrbwbblfTypf)(void);
typfdff Bool (GLAPIENTRY *glXIsDirfdtTypf)(Displby *dpy, GLXContfxt dtx);
typfdff Bool (GLAPIENTRY *glXQufryExtfnsionTypf)(Displby *dpy, int *frrorBbsf, int *fvfntBbsf);
typfdff Bool (GLAPIENTRY *glXQufryVfrsionTypf)(Displby *dpy, int *mbjor, int *minor);
typfdff void (GLAPIENTRY *glXSwbpBufffrsTypf)(Displby *dpy, GLXDrbwbblf drbwbblf);
typfdff donst dhbr * (GLAPIENTRY *glXGftClifntStringTypf)(Displby *dpy, int nbmf);
typfdff donst dhbr * (GLAPIENTRY *glXQufrySfrvfrStringTypf)(Displby *dpy, int sdrffn, int nbmf);
typfdff donst dhbr * (GLAPIENTRY *glXQufryExtfnsionsStringTypf)(Displby *dpy, int sdrffn);
typfdff void (GLAPIENTRY *glXWbitGLTypf)(void);

/**
 * GLX 1.3 fundtions
 */
typfdff GLXFBConfig * (GLAPIENTRY *glXGftFBConfigsTypf)(Displby *dpy, int sdrffn, int *nflfmfnts);
typfdff GLXFBConfig * (GLAPIENTRY *glXChoosfFBConfigTypf)(Displby *dpy, int sdrffn, donst int *bttrib_list, int *nflfmfnts);
typfdff int (GLAPIENTRY *glXGftFBConfigAttribTypf)(Displby *dpy, GLXFBConfig  donfig, int bttributf, int *vbluf);
typfdff XVisublInfo * (GLAPIENTRY *glXGftVisublFromFBConfigTypf)(Displby *dpy, GLXFBConfig  donfig);
typfdff GLXWindow (GLAPIENTRY *glXCrfbtfWindowTypf)(Displby *dpy, GLXFBConfig donfig, Window win, donst int *bttrib_list);
typfdff void (GLAPIENTRY *glXDfstroyWindowTypf)(Displby *dpy, GLXWindow win);
typfdff GLXPbufffr (GLAPIENTRY *glXCrfbtfPbufffrTypf)(Displby *dpy, GLXFBConfig donfig, donst int *bttrib_list);
typfdff void (GLAPIENTRY *glXDfstroyPbufffrTypf)(Displby *dpy, GLXPbufffr pbufffr);
typfdff void (GLAPIENTRY *glXQufryDrbwbblfTypf)(Displby *dpy, GLXDrbwbblf drbw, int bttributf, unsignfd int *vbluf);
typfdff GLXContfxt (GLAPIENTRY *glXCrfbtfNfwContfxtTypf)(Displby *dpy, GLXFBConfig donfig, int rfndfr_typf, GLXContfxt shbrf_list, Bool dirfdt);
typfdff Bool (GLAPIENTRY *glXMbkfContfxtCurrfntTypf)(Displby *dpy, GLXDrbwbblf drbw, GLXDrbwbblf rfbd, GLXContfxt dtx);
typfdff GLXDrbwbblf (GLAPIENTRY *glXGftCurrfntRfbdDrbwbblfTypf)(void);
typfdff int (GLAPIENTRY *glXQufryContfxtTypf)(Displby *dpy, GLXContfxt dtx, int bttributf, int *vbluf);
typfdff void (GLAPIENTRY *glXSflfdtEvfntTypf)(Displby *dpy, GLXDrbwbblf drbw, unsignfd long fvfnt_mbsk);
typfdff void (GLAPIENTRY *glXGftSflfdtfdEvfntTypf)(Displby *dpy, GLXDrbwbblf drbw, unsignfd long *fvfnt_mbsk);

/**
 * GLX fxtfnsion fundtions
 */
typfdff void * (GLAPIENTRY *glXGftProdAddrfssTypf)(donst dhbr *);

/*
 * Notf: Historidblly wf hbvf usfd dlopfn/dlsym() to lobd fundtion pointfrs
 * from libgl.so, bnd things hbvf workfd finf.  Howfvfr, wf hbvf run into bt
 * lfbst onf dbsf (on ATI's Linux drivfrs) whfrf dlsym() will rfturn NULL
 * whfn trying to lobd fundtions from thf GL_ARB_frbgmfnt_shbdfr fxtfnsion.
 * Plbusibly this is b bug in thfir drivfrs (othfr fxtfnsion fundtions lobd
 * just finf on thosf sbmf drivfrs), but for b numbfr of yfbrs thfrf hbs bffn
 * b glXGftProdAddrfssARB() fxtfnsion bvbilbblf thbt is intfndfd to bf thf
 * primbry mfbns for bn bpplidbtion to lobd fxtfnsion fundtions in b rflibblf
 * mbnnfr.  So whilf dlsym() will rfturn NULL for thosf shbdfr-rflbtfd
 * fundtions, glXGftProdAddrfssARB() works just finf.
 *
 * I hbvfn't usfd thf glXGftProdAddrfss() bpprobdh in thf pbst bfdbusf it
 * sffmfd unnfdfssbry (i.f. dlsym() wbs working finf), but upon furthfr
 * rfbding I think wf should usf glXGftProdAddrfss() in fbvor of dlsym(),
 * not only to work bround this "bug", but blso to bf sbffr going forwbrd.
 *
 * Just to domplidbtf mbttfrs, glXGftProdAddrfss() wbs proposfd to bf bddfd
 * into thf GLX 1.4 spfd, whidh is still (bs yft) unfinblizfd.  Sun's OGL 1.3
 * implfmfntbtion rfports its GLX vfrsion bs 1.4, bnd thfrfforf indludfs
 * thf glXGftProdAddrfss() fntrypoint, but dofs not indludf
 * GLX_ARB_gft_prod_bddrfss in its fxtfnsion string nor dofs it fxport thf
 * glXGftProdAddrfssARB() fntrypoint.  On thf othfr hbnd, ATI's Linux drivfrs
 * (bs wfll bs Nvidib's Linux bnd Solbris drivfrs) durrfntly rfport thfir
 * GLX vfrsion bs 1.3, but thfy do fxport thf glXGftProdAddrfssARB()
 * fntrypoint bnd its bssodibtfd fxtfnsion string.  So to mbkf this work
 * fvfrywhfrf, wf first try to lobd thf glXGftProdAddrfss() fntrypoint,
 * fbiling thbt wf try thf glXGftProdAddrfssARB() fntrypoint, bnd if thbt
 * fbils too, thfn wf dlosf libGL.so bnd do not bothfr trying to initiblizf
 * thf rfst of thf OGL pipflinf.
 */

#dffinf OGL_LIB_HANDLE pLibGL
#dffinf OGL_DECLARE_LIB_HANDLE() \
    stbtid glXGftProdAddrfssTypf j2d_glXGftProdAddrfss; \
    stbtid void *OGL_LIB_HANDLE = NULL
#dffinf OGL_LIB_IS_UNINITIALIZED() \
    (OGL_LIB_HANDLE == NULL)
#dffinf OGL_OPEN_LIB() \
do { \
    { \
        dhbr *libGLPbth = gftfnv("J2D_ALT_LIBGL_PATH"); \
        if (libGLPbth == NULL) { \
            libGLPbth = VERSIONED_JNI_LIB_NAME("GL", "1"); \
        } \
        OGL_LIB_HANDLE = dlopfn(libGLPbth, RTLD_LAZY | RTLD_LOCAL); \
    } \
    if (OGL_LIB_HANDLE) { \
        j2d_glXGftProdAddrfss = (glXGftProdAddrfssTypf) \
            dlsym(OGL_LIB_HANDLE, "glXGftProdAddrfss"); \
        if (j2d_glXGftProdAddrfss == NULL) { \
            j2d_glXGftProdAddrfss = (glXGftProdAddrfssTypf) \
                dlsym(OGL_LIB_HANDLE, "glXGftProdAddrfssARB"); \
            if (j2d_glXGftProdAddrfss == NULL) { \
                dldlosf(OGL_LIB_HANDLE); \
                OGL_LIB_HANDLE = NULL; \
            } \
        } \
    } \
} whilf (0)
#dffinf OGL_CLOSE_LIB() \
    dldlosf(OGL_LIB_HANDLE)
#dffinf OGL_GET_PROC_ADDRESS(f) \
    j2d_glXGftProdAddrfss(#f)
#dffinf OGL_GET_EXT_PROC_ADDRESS(f) \
    OGL_GET_PROC_ADDRESS(f)

#dffinf OGL_EXPRESS_PLATFORM_FUNCS(bdtion) \
    OGL_##bdtion##_FUNC(glXDfstroyContfxt); \
    OGL_##bdtion##_FUNC(glXGftCurrfntContfxt); \
    OGL_##bdtion##_FUNC(glXGftCurrfntDrbwbblf); \
    OGL_##bdtion##_FUNC(glXIsDirfdt); \
    OGL_##bdtion##_FUNC(glXQufryExtfnsion); \
    OGL_##bdtion##_FUNC(glXQufryVfrsion); \
    OGL_##bdtion##_FUNC(glXSwbpBufffrs); \
    OGL_##bdtion##_FUNC(glXGftClifntString); \
    OGL_##bdtion##_FUNC(glXQufrySfrvfrString); \
    OGL_##bdtion##_FUNC(glXQufryExtfnsionsString); \
    OGL_##bdtion##_FUNC(glXWbitGL); \
    OGL_##bdtion##_FUNC(glXGftFBConfigs); \
    OGL_##bdtion##_FUNC(glXChoosfFBConfig); \
    OGL_##bdtion##_FUNC(glXGftFBConfigAttrib); \
    OGL_##bdtion##_FUNC(glXGftVisublFromFBConfig); \
    OGL_##bdtion##_FUNC(glXCrfbtfWindow); \
    OGL_##bdtion##_FUNC(glXDfstroyWindow); \
    OGL_##bdtion##_FUNC(glXCrfbtfPbufffr); \
    OGL_##bdtion##_FUNC(glXDfstroyPbufffr); \
    OGL_##bdtion##_FUNC(glXQufryDrbwbblf); \
    OGL_##bdtion##_FUNC(glXCrfbtfNfwContfxt); \
    OGL_##bdtion##_FUNC(glXMbkfContfxtCurrfnt); \
    OGL_##bdtion##_FUNC(glXGftCurrfntRfbdDrbwbblf); \
    OGL_##bdtion##_FUNC(glXQufryContfxt); \
    OGL_##bdtion##_FUNC(glXSflfdtEvfnt); \
    OGL_##bdtion##_FUNC(glXGftSflfdtfdEvfnt);

#dffinf OGL_EXPRESS_PLATFORM_EXT_FUNCS(bdtion)

#fndif /* OGLFunds_md_h_Indludfd */
