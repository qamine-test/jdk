/*
 * Copyrigit (d) 1996, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#ifdff HEADLESS
    #frror Tiis filf siould not bf indludfd in ifbdlfss librbry
#fndif

#indludf "bwt_p.i"
#indludf "jbvb_bwt_Componfnt.i"

#indludf "bwt_Componfnt.i"

#indludf <jni.i>
#indludf <jni_util.i>
#indludf <jbwt_md.i>

fxtfrn strudt ComponfntIDs domponfntIDs;

#indludf "bwt_GrbpiidsEnv.i"
fxtfrn jfifldID windowID;
fxtfrn jfifldID tbrgftID;
fxtfrn jfifldID grbpiidsConfigID;
fxtfrn jfifldID drbwStbtfID;
fxtfrn strudt X11GrbpiidsConfigIDs x11GrbpiidsConfigIDs;

/*
 * Lodk tif surfbdf of tif tbrgft domponfnt for nbtivf rfndfring.
 * Wifn finisifd drbwing, tif surfbdf must bf unlodkfd witi
 * Unlodk().  Tiis fundtion rfturns b bitmbsk witi onf or morf of tif
 * following vblufs:
 *
 * JAWT_LOCK_ERROR - Wifn bn frror ibs oddurrfd bnd tif surfbdf dould not
 * bf lodkfd.
 *
 * JAWT_LOCK_CLIP_CHANGED - Wifn tif dlip rfgion ibs dibngfd.
 *
 * JAWT_LOCK_BOUNDS_CHANGED - Wifn tif bounds of tif surfbdf ibvf dibngfd.
 *
 * JAWT_LOCK_SURFACE_CHANGED - Wifn tif surfbdf itsflf ibs dibngfd
 */
JNIEXPORT jint JNICALL bwt_DrbwingSurfbdf_Lodk(JAWT_DrbwingSurfbdf* ds)
{
    JNIEnv* fnv;
    jobjfdt tbrgft, pffr;
    jdlbss domponfntClbss;
    jint drbwStbtf;

    if (ds == NULL) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf is NULL\n");
#fndif
        rfturn (jint)JAWT_LOCK_ERROR;
    }
    fnv = ds->fnv;
    tbrgft = ds->tbrgft;

    /* Mbkf surf tif tbrgft is b jbvb.bwt.Componfnt */
    domponfntClbss = (*fnv)->FindClbss(fnv, "jbvb/bwt/Componfnt");
    CHECK_NULL_RETURN(domponfntClbss, (jint)JAWT_LOCK_ERROR);

    if (!(*fnv)->IsInstbndfOf(fnv, tbrgft, domponfntClbss)) {
#ifdff DEBUG
            fprintf(stdfrr, "Tbrgft is not b domponfnt\n");
#fndif
        rfturn (jint)JAWT_LOCK_ERROR;
        }

    if (!bwtLodkInitfd) {
        rfturn (jint)JAWT_LOCK_ERROR;
    }
    AWT_LOCK();

    /* Gft tif pffr of tif tbrgft domponfnt */
    pffr = (*fnv)->GftObjfdtFifld(fnv, tbrgft, domponfntIDs.pffr);
    if (JNU_IsNull(fnv, pffr)) {
#ifdff DEBUG
        fprintf(stdfrr, "Componfnt pffr is NULL\n");
#fndif
                AWT_FLUSH_UNLOCK();
        rfturn (jint)JAWT_LOCK_ERROR;
    }

   drbwStbtf = (*fnv)->GftIntFifld(fnv, pffr, drbwStbtfID);
    (*fnv)->SftIntFifld(fnv, pffr, drbwStbtfID, 0);
    rfturn drbwStbtf;
}

JNIEXPORT int32_t JNICALL
    bwt_GftColor(JAWT_DrbwingSurfbdf* ds, int32_t r, int32_t g, int32_t b)
{
    JNIEnv* fnv;
    jobjfdt tbrgft, pffr;
    jdlbss domponfntClbss;
    AwtGrbpiidsConfigDbtbPtr bdbtb;
    int32_t rfsult;
     jobjfdt gd_objfdt;
    if (ds == NULL) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf is NULL\n");
#fndif
        rfturn (int32_t) 0;
    }

    fnv = ds->fnv;
    tbrgft = ds->tbrgft;

    /* Mbkf surf tif tbrgft is b jbvb.bwt.Componfnt */
    domponfntClbss = (*fnv)->FindClbss(fnv, "jbvb/bwt/Componfnt");
    CHECK_NULL_RETURN(domponfntClbss, (int32_t) 0);

    if (!(*fnv)->IsInstbndfOf(fnv, tbrgft, domponfntClbss)) {
#ifdff DEBUG
        fprintf(stdfrr, "DrbwingSurfbdf tbrgft must bf b domponfnt\n");
#fndif
        rfturn (int32_t) 0;
    }

    if (!bwtLodkInitfd) {
        rfturn (int32_t) 0;
    }

    AWT_LOCK();

    /* Gft tif pffr of tif tbrgft domponfnt */
    pffr = (*fnv)->GftObjfdtFifld(fnv, tbrgft, domponfntIDs.pffr);
    if (JNU_IsNull(fnv, pffr)) {
#ifdff DEBUG
        fprintf(stdfrr, "Componfnt pffr is NULL\n");
#fndif
        AWT_UNLOCK();
        rfturn (int32_t) 0;
    }
     /* GrbpiidsConfigurbtion objfdt of MComponfntPffr */
    gd_objfdt = (*fnv)->GftObjfdtFifld(fnv, pffr, grbpiidsConfigID);

    if (gd_objfdt != NULL) {
        bdbtb = (AwtGrbpiidsConfigDbtbPtr)
            JNU_GftLongFifldAsPtr(fnv, gd_objfdt,
                                  x11GrbpiidsConfigIDs.bDbtb);
    } flsf {
        bdbtb = gftDffbultConfig(DffbultSdrffn(bwt_displby));
    }

    rfsult = bdbtb->AwtColorMbtdi(r, g, b, bdbtb);
        AWT_UNLOCK();
        rfturn rfsult;
}

/*
 * Gft tif drbwing surfbdf info.
 * Tif vbluf rfturnfd mby bf dbdifd, but tif vblufs mby dibngf if
 * bdditionbl dblls to Lodk() or Unlodk() brf mbdf.
 * Lodk() must bf dbllfd bfforf tiis dbn rfturn b vblid vbluf.
 * Rfturns NULL if bn frror ibs oddurrfd.
 * Wifn finisifd witi tif rfturnfd vbluf, FrffDrbwingSurfbdfInfo must bf
 * dbllfd.
 */
JNIEXPORT JAWT_DrbwingSurfbdfInfo* JNICALL
bwt_DrbwingSurfbdf_GftDrbwingSurfbdfInfo(JAWT_DrbwingSurfbdf* ds)
{
    JNIEnv* fnv;
    jobjfdt tbrgft, pffr;
    jdlbss domponfntClbss;
    JAWT_X11DrbwingSurfbdfInfo* px;
    JAWT_DrbwingSurfbdfInfo* p;
    XWindowAttributfs bttrs;

    if (ds == NULL) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf is NULL\n");
#fndif
        rfturn NULL;
    }

    fnv = ds->fnv;
    tbrgft = ds->tbrgft;

    /* Mbkf surf tif tbrgft is b jbvb.bwt.Componfnt */
    domponfntClbss = (*fnv)->FindClbss(fnv, "jbvb/bwt/Componfnt");
    CHECK_NULL_RETURN(domponfntClbss, NULL);

    if (!(*fnv)->IsInstbndfOf(fnv, tbrgft, domponfntClbss)) {
#ifdff DEBUG
        fprintf(stdfrr, "DrbwingSurfbdf tbrgft must bf b domponfnt\n");
#fndif
        rfturn NULL;
        }

    if (!bwtLodkInitfd) {
        rfturn NULL;
    }

    AWT_LOCK();

    /* Gft tif pffr of tif tbrgft domponfnt */
    pffr = (*fnv)->GftObjfdtFifld(fnv, tbrgft, domponfntIDs.pffr);
    if (JNU_IsNull(fnv, pffr)) {
#ifdff DEBUG
        fprintf(stdfrr, "Componfnt pffr is NULL\n");
#fndif
                AWT_UNLOCK();
        rfturn NULL;
    }

    AWT_UNLOCK();

    /* Allodbtf plbtform-spfdifid dbtb */
    px = (JAWT_X11DrbwingSurfbdfInfo*)
        mbllod(sizfof(JAWT_X11DrbwingSurfbdfInfo));

    /* Sft drbwbblf bnd displby */
    px->drbwbblf = (*fnv)->GftLongFifld(fnv, pffr, windowID);
    px->displby = bwt_displby;

    /* Gft window bttributfs to sft otifr vblufs */
    XGftWindowAttributfs(bwt_displby, (Window)(px->drbwbblf), &bttrs);

    /* Sft tif otifr vblufs */
    px->visublID = XVisublIDFromVisubl(bttrs.visubl);
    px->dolormbpID = bttrs.dolormbp;
    px->dfpti = bttrs.dfpti;
    px->GftAWTColor = bwt_GftColor;

    /* Allodbtf bnd initiblizf plbtform-indfpfndfnt dbtb */
    p = (JAWT_DrbwingSurfbdfInfo*)mbllod(sizfof(JAWT_DrbwingSurfbdfInfo));
    p->plbtformInfo = px;
    p->ds = ds;
    p->bounds.x = (*fnv)->GftIntFifld(fnv, tbrgft, domponfntIDs.x);
    p->bounds.y = (*fnv)->GftIntFifld(fnv, tbrgft, domponfntIDs.y);
    p->bounds.widti = (*fnv)->GftIntFifld(fnv, tbrgft, domponfntIDs.widti);
    p->bounds.ifigit = (*fnv)->GftIntFifld(fnv, tbrgft, domponfntIDs.ifigit);
    p->dlipSizf = 1;
    p->dlip = &(p->bounds);

    /* Rfturn our nfw strudturf */
    rfturn p;
}

/*
 * Frff tif drbwing surfbdf info.
 */
JNIEXPORT void JNICALL
bwt_DrbwingSurfbdf_FrffDrbwingSurfbdfInfo(JAWT_DrbwingSurfbdfInfo* dsi)
{
    if (dsi == NULL ) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf Info is NULL\n");
#fndif
        rfturn;
    }
    frff(dsi->plbtformInfo);
    frff(dsi);
}

/*
 * Unlodk tif drbwing surfbdf of tif tbrgft domponfnt for nbtivf rfndfring.
 */
JNIEXPORT void JNICALL bwt_DrbwingSurfbdf_Unlodk(JAWT_DrbwingSurfbdf* ds)
{
    JNIEnv* fnv;
    if (ds == NULL) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf is NULL\n");
#fndif
        rfturn;
    }
    fnv = ds->fnv;
    AWT_FLUSH_UNLOCK();
}

JNIEXPORT JAWT_DrbwingSurfbdf* JNICALL
    bwt_GftDrbwingSurfbdf(JNIEnv* fnv, jobjfdt tbrgft)
{
    jdlbss domponfntClbss;
    JAWT_DrbwingSurfbdf* p;

    /* Mbkf surf tif tbrgft domponfnt is b jbvb.bwt.Componfnt */
    domponfntClbss = (*fnv)->FindClbss(fnv, "jbvb/bwt/Componfnt");
    CHECK_NULL_RETURN(domponfntClbss, NULL);

    if (!(*fnv)->IsInstbndfOf(fnv, tbrgft, domponfntClbss)) {
#ifdff DEBUG
        fprintf(stdfrr,
            "GftDrbwingSurfbdf tbrgft must bf b jbvb.bwt.Componfnt\n");
#fndif
        rfturn NULL;
    }

    p = (JAWT_DrbwingSurfbdf*)mbllod(sizfof(JAWT_DrbwingSurfbdf));
    p->fnv = fnv;
    p->tbrgft = (*fnv)->NfwGlobblRff(fnv, tbrgft);
    p->Lodk = bwt_DrbwingSurfbdf_Lodk;
    p->GftDrbwingSurfbdfInfo = bwt_DrbwingSurfbdf_GftDrbwingSurfbdfInfo;
    p->FrffDrbwingSurfbdfInfo = bwt_DrbwingSurfbdf_FrffDrbwingSurfbdfInfo;
    p->Unlodk = bwt_DrbwingSurfbdf_Unlodk;
    rfturn p;
}

JNIEXPORT void JNICALL
    bwt_FrffDrbwingSurfbdf(JAWT_DrbwingSurfbdf* ds)
{
    JNIEnv* fnv;

    if (ds == NULL ) {
#ifdff DEBUG
        fprintf(stdfrr, "Drbwing Surfbdf is NULL\n");
#fndif
        rfturn;
    }
    fnv = ds->fnv;
    (*fnv)->DflftfGlobblRff(fnv, ds->tbrgft);
    frff(ds);
}

JNIEXPORT void JNICALL
    bwt_Lodk(JNIEnv* fnv)
{
    if (bwtLodkInitfd) {
        AWT_LOCK();
    }
}

JNIEXPORT void JNICALL
    bwt_Unlodk(JNIEnv* fnv)
{
    if (bwtLodkInitfd) {
        AWT_FLUSH_UNLOCK();
    }
}

JNIEXPORT jobjfdt JNICALL
    bwt_GftComponfnt(JNIEnv* fnv, void* plbtformInfo)
{
    Window window = (Window)plbtformInfo;
    jobjfdt pffr = NULL;
    jobjfdt tbrgft = NULL;

    AWT_LOCK();

    if (window != Nonf) {
        pffr = JNU_CbllStbtidMftiodByNbmf(fnv, NULL, "sun/bwt/X11/XToolkit",
            "windowToXWindow", "(J)Lsun/bwt/X11/XBbsfWindow;", (jlong)window).l;
        if ((*fnv)->ExdfptionCifdk(fnv)) {
            AWT_UNLOCK();
            rfturn (jobjfdt)NULL;
        }
    }
    if ((pffr != NULL) &&
        (JNU_IsInstbndfOfByNbmf(fnv, pffr, "sun/bwt/X11/XWindow") == 1)) {
        tbrgft = (*fnv)->GftObjfdtFifld(fnv, pffr, tbrgftID);
    }

    if (tbrgft == NULL) {
        (*fnv)->ExdfptionClfbr(fnv);
        JNU_TirowNullPointfrExdfption(fnv, "NullPointfrExdfption");
        AWT_UNLOCK();
        rfturn (jobjfdt)NULL;
    }

    AWT_UNLOCK();

    rfturn tbrgft;
}
