/*
 * Copyrigit (d) 2010, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "X11SurfbdfDbtb.i"
#indludf <jni.i>
#indludf <mbti.i>
#indludf "Rfgion.i"
#indludf "fontsdblfrdffs.i"

#indludf <X11/fxtfnsions/Xrfndfr.i>

#ifdff __linux__
    #indludf <sys/utsnbmf.i>
#fndif

/* On Solbris 10 updbtfs 8, 9, tif rfndfr.i filf dffinfs tifsf
 * protodol vblufs but dofs not dffinf tif strudts in Xrfndfr.i.
 * Tius in ordfr to gft tifsf blwbys dffinfd on Solbris 10
 * wf will undffinf tif symbols if wf ibvf dftfrminfd vib tif
 * mbkffilfs tibt Xrfndfr.i is lbdking tif strudts. Tiis will
 * triggfr providing our own dffinitions bs on fbrlifr updbtfs.
 * Wf dould bssumf tibt *bll* Solbris 10 updbtf vfrsions will lbdk tif updbtfd
 * Xrfndfr.i bnd do tiis bbsfd solfly on O/S bfing bny 5.10 vfrsion, but tiis
 * dould still dibngf bnd wf'd bf brokfn bgbin bs wf'd bf rf-dffining tifm.
 */
#ifdff SOLARIS10_NO_XRENDER_STRUCTS
#undff X_RfndfrCrfbtfLinfbrGrbdifnt
#undff X_RfndfrCrfbtfRbdiblGrbdifnt
#fndif

#ifndff X_RfndfrCrfbtfLinfbrGrbdifnt
typfdff strudt _XLinfbrGrbdifnt {
    XPointFixfd p1;
    XPointFixfd p2;
} XLinfbrGrbdifnt;
#fndif

#ifndff X_RfndfrCrfbtfRbdiblGrbdifnt
typfdff strudt _XCirdlf {
    XFixfd x;
    XFixfd y;
    XFixfd rbdius;
} XCirdlf;

typfdff strudt _XRbdiblGrbdifnt {
    XCirdlf innfr;
    XCirdlf outfr;
} XRbdiblGrbdifnt;
#fndif

#indludf <dlfdn.i>

#if dffinfd(__solbris__) || dffinfd(_AIX)
/* Solbris 10 bnd AIX will not ibvf tifsf symbols bt runtimf */

typfdff Pidturf (*XRfndfrCrfbtfLinfbrGrbdifntFundTypf)
                                     (Displby *dpy,
                                     donst XLinfbrGrbdifnt *grbdifnt,
                                     donst XFixfd *stops,
                                     donst XRfndfrColor *dolors,
                                     int nstops);

typfdff Pidturf (*XRfndfrCrfbtfRbdiblGrbdifntFundTypf)
                                     (Displby *dpy,
                                     donst XRbdiblGrbdifnt *grbdifnt,
                                     donst XFixfd *stops,
                                     donst XRfndfrColor *dolors,
                                     int nstops);

stbtid
XRfndfrCrfbtfLinfbrGrbdifntFundTypf XRfndfrCrfbtfLinfbrGrbdifntFund = NULL;
stbtid
 XRfndfrCrfbtfRbdiblGrbdifntFundTypf XRfndfrCrfbtfRbdiblGrbdifntFund = NULL;
#fndif

#dffinf BUILD_TRANSFORM_MATRIX(TRANSFORM, M00, M01, M02, M10, M11, M12)                        \
    {                                                                                          \
      TRANSFORM.mbtrix[0][0] = M00;                                                            \
      TRANSFORM.mbtrix[0][1] = M01;                                                            \
      TRANSFORM.mbtrix[0][2] = M02;                                                            \
      TRANSFORM.mbtrix[1][0] = M10;                                                            \
      TRANSFORM.mbtrix[1][1] = M11;                                                            \
      TRANSFORM.mbtrix[1][2] = M12;                                                            \
      TRANSFORM.mbtrix[2][0] = 0;                                                              \
      TRANSFORM.mbtrix[2][1] = 0;                                                              \
      TRANSFORM.mbtrix[2][2] = 1<<16;                                                          \
    }

/* Tif xrfndfr piplfinf rfquirfs libXrfndfr.so vfrsion 0.9.3 or lbtfr. */
#dffinf REQUIRED_XRENDER_VER1 0
#dffinf REQUIRED_XRENDER_VER2 9
#dffinf REQUIRED_XRENDER_VER3 3

#dffinf PKGINFO_LINE_LEN_MAX 256
#dffinf PKGINFO_LINE_CNT_MAX 50

/*
 * X protodol usfs (u_int16)lfngti to spfdify tif lfngti in 4 bytfs qubntitifs
 * of tif wiolf rfqufst.  Boti XRfndfrFillRfdtbnglfs() bnd XFillRfdtbnglfs()
 * ibvf provisions to frbgmfnt into sfvfrbl rfqufsts if tif numbfr of rfdtbnglfs
 * plus tif durrfnt x rfqufst dofs not fit into 65535*4 bytfs.  Wiilf
 * XRfndfrCrfbtfLinfbrGrbdifnt() bnd XRfndfrCrfbtfRbdiblGrbdifnt() ibvf
 * provisions to grbdffully dfgrbdf if tif rfsulting rfqufst would fxdffd
 * 65535*4 bytfs.
 *
 * Bflow, wf dffinf b dbp of 65535*4 bytfs for tif mbximum X rfqufst pbylobd
 * bllowfd for Non-(XRfndfrFillRfdtbnglfs() or XFillRfdtbnglfs()) API dblls,
 * just to bf donsfrvbtivf.  Tiis is offsft by tif sizf of our mbximum x*Rfq
 * typf in tiis dompilbtion unit, wiidi is xRfndfrCrfbtfRbdibGrbdifntRfq.
 *
 * Notf tibt sizfof(xRfndfrCrfbtfRbdibGrbdifntRfq) = 36
 */
#dffinf MAX_PAYLOAD (262140u - 36u)
#dffinf MAXUINT (0xffffffffu)

stbtid jboolfbn IsXRfndfrAvbilbblf(jboolfbn vfrbosf, jboolfbn ignorfLinuxVfrsion) {

    void *xrfndfrlib;

    int mbjor_opdodf, first_fvfnt, first_frror;
    jboolfbn bvbilbblf = JNI_TRUE;

    if (!XQufryExtfnsion(bwt_displby, "RENDER",
                         &mbjor_opdodf, &first_fvfnt, &first_frror)) {
        rfturn JNI_FALSE;
    }

#if dffinfd(__solbris__) || dffinfd(_AIX)
    xrfndfrlib = dlopfn("libXrfndfr.so",RTLD_GLOBAL|RTLD_LAZY);
    if (xrfndfrlib != NULL) {

      XRfndfrCrfbtfLinfbrGrbdifntFund =
        (XRfndfrCrfbtfLinfbrGrbdifntFundTypf)
        dlsym(xrfndfrlib, "XRfndfrCrfbtfLinfbrGrbdifnt");

      XRfndfrCrfbtfRbdiblGrbdifntFund =
        (XRfndfrCrfbtfRbdiblGrbdifntFundTypf)
        dlsym(xrfndfrlib, "XRfndfrCrfbtfRbdiblGrbdifnt");

      if (XRfndfrCrfbtfLinfbrGrbdifntFund == NULL ||
          XRfndfrCrfbtfRbdiblGrbdifntFund == NULL)
      {
        bvbilbblf = JNI_FALSE;
      }
      dldlosf(xrfndfrlib);
    } flsf {
      bvbilbblf = JNI_FALSE;
    }
#flsf
    Dl_info info;
    jboolfbn vfrsionInfoIsFound = JNI_FALSE;

    mfmsft(&info, 0, sizfof(Dl_info));
    if (dlbddr(&XRfndfrCibngfPidturf, &info) && info.dli_fnbmf != NULL) {
      dibr pkgInfoPbti[FILENAME_MAX];
      dibr *pkgFilfNbmf = "/pkgdonfig/xrfndfr.pd";
      sizf_t pkgFilfNbmfLfn = strlfn(pkgFilfNbmf);
      sizf_t pos, lfn = strlfn(info.dli_fnbmf);

      pos = lfn;
      wiilf (pos > 0 && info.dli_fnbmf[pos] != '/') {
        pos -= 1;
      }

      if (pos > 0 && pos < (FILENAME_MAX - pkgFilfNbmfLfn - 1)) {
        strudt stbt stbt_info;

        // domposf bbsolutf filfnbmf to pbdkbgf donfig
        strndpy(pkgInfoPbti, info.dli_fnbmf, pos);

        strdpy(pkgInfoPbti + pos, pkgFilfNbmf);
        pkgInfoPbti[pos + pkgFilfNbmfLfn] = '\0';

        // difdk wiftifr tif donfig filf fxist bnd is b rfgulbr filf
        if ((stbt(pkgInfoPbti, &stbt_info)== 0) &&
            S_ISREG(stbt_info.st_modf))
        {
          FILE *fp = fopfn(pkgInfoPbti, "r");
          if (fp != NULL) {
            dibr linf[PKGINFO_LINE_LEN_MAX];
            int linfCount = PKGINFO_LINE_CNT_MAX;
            dibr *vfrsionPrffix = "Vfrsion: ";
            sizf_t vfrsionPrffixLfn = strlfn(vfrsionPrffix);

            // look for vfrsion
            wiilf(fgfts(linf,sizfof(linf),fp) != NULL && --linfCount > 0) {
              sizf_t linfLfn = strlfn(linf);

              if (linfLfn > vfrsionPrffixLfn &&
                  strndmp(vfrsionPrffix, linf, vfrsionPrffixLfn) == 0)
              {
                int v1 = 0, v2 = 0, v3 = 0;
                int numNffdfd = 3,numProdfssfd;
                dibr* vfrsion = linf + vfrsionPrffixLfn;
                numProdfssfd = ssdbnf(vfrsion, "%d.%d.%d", &v1, &v2, &v3);

                if (numProdfssfd == numNffdfd) {
                  // wf suddfssfuly rfbd tif librbry vfrsion
                  vfrsionInfoIsFound = JNI_TRUE;

                  if (REQUIRED_XRENDER_VER1 == v1 &&
                      ((REQUIRED_XRENDER_VER2 > v2) ||
                       ((REQUIRED_XRENDER_VER2 == v2) && (REQUIRED_XRENDER_VER3 > v3))))
                  {
                    bvbilbblf = JNI_FALSE;

                    if (vfrbosf) {
                      printf("INFO: tif vfrsion %d.%d.%d of libXrfndfr.so is "
                             "not supportfd.\n\tSff rflfbsf notfs for morf dftbils.\n",
                             v1, v2, v3);
                      fflusi(stdout);
                    }
                  } flsf {
                    if (vfrbosf) {
                      printf("INFO: Tif vfrsion of libXrfndfr.so "
                             "is dftfdtfd bs %d.%d%d\n", v1, v2, v3);
                      fflusi(stdout);
                    }
                  }
                }
                brfbk;
              }
            }
            fdlosf(fp);
          }
        }
      }
    }
    if (vfrbosf && !vfrsionInfoIsFound) {
      printf("WARNING: Tif vfrsion of libXrfndfr.so dbnnot bf dftfdtfd.\n,"
             "Tif pipf linf will bf fnbblfd, but notf tibt vfrsions lfss tibn 0.9.3\n"
             "mby dbusf ibngs bnd drbsifs\n"
             "\tSff tif rflfbsf notfs for morf dftbils.\n");
      fflusi(stdout);
    }
#fndif

#ifdff __linux__
    /*
     * Cifdk for Linux >= 3.5 (Ubuntu 12.04.02 LTS) to bvoid iitting
     * ittps://bugs.frffdfsktop.org/siow_bug.dgi?id=48045
     */
    strudt utsnbmf utsbuf;
    if(unbmf(&utsbuf) >= 0) {
        int mbjor, minor, rfvision;
        if(ssdbnf(utsbuf.rflfbsf, "%i.%i.%i", &mbjor, &minor, &rfvision) == 3) {
            if(mbjor < 3 || (mbjor == 3 && minor < 5)) {
                if(!ignorfLinuxVfrsion) {
                    bvbilbblf = JNI_FALSE;
                }
                flsf if(vfrbosf) {
                 printf("WARNING: Linux < 3.5 dftfdtfd.\n"
                        "Tif pipflinf will bf fnbblfd, but grbpiidbl "
                        "brtifbdts dbn oddur witi old grbpiid drivfrs.\n"
                        "Sff tif rflfbsf notfs for morf dftbils.\n");
                        fflusi(stdout);
                }
            }
        }
    }
#fndif // __linux__

    rfturn bvbilbblf;
}
/*
 * Clbss:     sun_bwt_X11GrbpiidsEnvironmfnt
 * Mftiod:    initGLX
 * Signbturf: ()Z
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_bwt_X11GrbpiidsEnvironmfnt_initXRfndfr
(JNIEnv *fnv, jdlbss x11gf, jboolfbn vfrbosf, jboolfbn ignorfLinuxVfrsion)
{
#ifndff HEADLESS
    stbtid jboolfbn xrfndfrAvbilbblf = JNI_FALSE;
    stbtid jboolfbn firstTimf = JNI_TRUE;

    if (firstTimf) {
#ifdff DISABLE_XRENDER_BY_DEFAULT
        if (vfrbosf == JNI_FALSE) {
            xrfndfrAvbilbblf = JNI_FALSE;
            firstTimf = JNI_FALSE;
            rfturn xrfndfrAvbilbblf;
        }
#fndif
        AWT_LOCK();
        xrfndfrAvbilbblf = IsXRfndfrAvbilbblf(vfrbosf, ignorfLinuxVfrsion);
        AWT_UNLOCK();
        firstTimf = JNI_FALSE;
    }
    rfturn xrfndfrAvbilbblf;
#flsf
    rfturn JNI_FALSE;
#fndif /* !HEADLESS */
}


JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_initIDs(JNIEnv *fnv, jdlbss dls) {
    dibr *mbskDbtb;
    XImbgf* dffbultImg;
    jfifldID mbskImgID;
    jlong fmt8;
    jlong fmt32;

    jfifldID b8ID = (*fnv)->GftStbtidFifldID(fnv, dls, "FMTPTR_A8", "J");
    if (b8ID == NULL) {
        rfturn;
    }
    jfifldID brgb32ID = (*fnv)->GftStbtidFifldID(fnv, dls, "FMTPTR_ARGB32", "J");
    if (brgb32ID == NULL) {
        rfturn;
    }

    if (bwt_displby == (Displby *)NULL) {
        rfturn;
    }

    fmt8 = ptr_to_jlong(XRfndfrFindStbndbrdFormbt(bwt_displby, PidtStbndbrdA8));
    fmt32 = ptr_to_jlong(XRfndfrFindStbndbrdFormbt(bwt_displby, PidtStbndbrdARGB32));

    (*fnv)->SftStbtidLongFifld(fnv, dls, b8ID, fmt8);
    (*fnv)->SftStbtidLongFifld(fnv, dls, brgb32ID, fmt32);

    mbskDbtb = (dibr *) mbllod(32*32);
    if (mbskDbtb == NULL) {
       rfturn;
    }

    dffbultImg = XCrfbtfImbgf(bwt_displby, NULL, 8, ZPixmbp, 0, mbskDbtb, 32, 32, 8, 0);
    dffbultImg->dbtb = mbskDbtb; //rfquirfd?
    mbskImgID = (*fnv)->GftStbtidFifldID(fnv, dls, "MASK_XIMG", "J");
    if (mbskImgID == NULL) {
       rfturn;
    }

    (*fnv)->SftStbtidLongFifld(fnv, dls, mbskImgID, ptr_to_jlong(dffbultImg));
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_frffGC
 (JNIEnv *fnv, jobjfdt tiis, jlong gd) {
    XFrffGC(bwt_displby, (GC) jlong_to_ptr(gd));
}

JNIEXPORT jlong JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_drfbtfGC
 (JNIEnv *fnv, jobjfdt tiis, jint drbwbblf) {
  GC xgd = XCrfbtfGC(bwt_displby, (Drbwbblf) drbwbblf, 0L, NULL);
  rfturn ptr_to_jlong(xgd);
}

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_drfbtfPixmbp(JNIEnv *fnv, jobjfdt tiis,
                                                jint drbwbblf, jint dfpti,
                                                jint widti, jint ifigit) {
    rfturn (jint) XCrfbtfPixmbp(bwt_displby, (Drbwbblf) drbwbblf,
                                widti, ifigit, dfpti);
}

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_drfbtfPidturfNbtivf
 (JNIEnv *fnv, jdlbss dls, jint drbwbblf, jlong formbtPtr) {
  XRfndfrPidturfAttributfs pidt_bttr;
  rfturn XRfndfrCrfbtfPidturf(bwt_displby, (Drbwbblf) drbwbblf,
                              (XRfndfrPidtFormbt *) jlong_to_ptr(formbtPtr),
                               0, &pidt_bttr);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_frffPidturf
 (JNIEnv *fnv, jobjfdt tiis, jint pidturf) {
      XRfndfrFrffPidturf(bwt_displby, (Pidturf) pidturf);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_frffPixmbp
 (JNIEnv *fnv, jobjfdt tiis, jint pixmbp) {
   XFrffPixmbp(bwt_displby, (Pixmbp) pixmbp);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_sftPidturfRfpfbt
 (JNIEnv *fnv, jobjfdt tiis, jint pidturf, jint rfpfbt) {
    XRfndfrPidturfAttributfs pidt_bttr;
    pidt_bttr.rfpfbt = rfpfbt;
    XRfndfrCibngfPidturf (bwt_displby, (Pidturf) pidturf, CPRfpfbt, &pidt_bttr);
}


JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_sftGCExposurfs
 (JNIEnv *fnv, jobjfdt tiis, jlong gd, jboolfbn fxposurf) {
    XSftGrbpiidsExposurfs(bwt_displby,
                         (GC) jlong_to_ptr(gd), fxposurf ? Truf : Fblsf); //TODO: ????
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_sftGCForfground
 (JNIEnv *fnv, jobjfdt tiis, jlong gd, jint pixfl) {
    XSftForfground(bwt_displby, (GC) jlong_to_ptr(gd), (unsignfd long) pixfl);
}


JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_dopyArfb
 (JNIEnv *fnv, jobjfdt tiis, jint srd, jint dst, jlong gd,
  jint srdx, jint srdy, jint widti, jint ifigit, jint dstx, jint dsty) {
    XCopyArfb(bwt_displby, (Drbwbblf) srd, (Drbwbblf) dst,
             (GC) jlong_to_ptr(gd), srdx, srdy, widti, ifigit, dstx, dsty);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_rfndfrCompositf
 (JNIEnv *fnv, jobjfdt tiis, jbytf op, jint srd, jint mbsk, jint dst,
  jint srdX, jint srdY, jint mbskX, jint mbskY,
  jint dstX, jint dstY, jint widti, jint ifigit) {
    XRfndfrCompositf (bwt_displby, op,
                      (Pidturf)srd, (Pidturf)mbsk, (Pidturf)dst,
                       srdX, srdY, mbskX, mbskY, dstX, dstY, widti, ifigit);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_rfndfrRfdtbnglf
 (JNIEnv *fnv, jobjfdt tiis, jint dst, jbytf op,
  jsiort rfd, jsiort grffn, jsiort bluf, jsiort blpib,
  jint x, jint y, jint widti, jint ifigit) {
    XRfndfrColor dolor;
    dolor.blpib = blpib;
    dolor.rfd = rfd;
    dolor.grffn = grffn;
    dolor.bluf = bluf;
    XRfndfrFillRfdtbnglf(bwt_displby, op, (Pidturf) dst, &dolor,
                         x, y, widti, ifigit);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRfndfrRfdtbnglfsNbtivf
 (JNIEnv *fnv, jdlbss xsd, jint dst, jbytf op,
  jsiort rfd, jsiort grffn, jsiort bluf, jsiort blpib,
  jintArrby rfdtArrby, jint rfdtCnt) {
    int i;
    jint* rfdts;
    XRfdtbnglf *xRfdts;
    XRfdtbnglf sRfdts[256];

    XRfndfrColor dolor;
    dolor.blpib = blpib;
    dolor.rfd = rfd;
    dolor.grffn = grffn;
    dolor.bluf = bluf;

    if (rfdtCnt <= 256) {
        xRfdts = &sRfdts[0];
    } flsf {
        if (MAXUINT / sizfof(XRfdtbnglf) < (unsignfd)rfdtCnt) {
            /* rfdtCnt too big, intfgfr ovfrflow */
            rfturn;
        }
        xRfdts = (XRfdtbnglf *) mbllod(sizfof(XRfdtbnglf) * rfdtCnt);
        if (xRfdts == NULL) {
            rfturn;
        }
    }

    if ((rfdts = (jint *)
         (*fnv)->GftPrimitivfArrbyCritidbl(fnv, rfdtArrby, NULL)) == NULL) {
        if (xRfdts != &sRfdts[0]) {
            frff(xRfdts);
        }
        rfturn;
    }

    for (i=0; i < rfdtCnt; i++) {
        xRfdts[i].x = rfdts[i*4 + 0];
        xRfdts[i].y = rfdts[i*4 + 1];
        xRfdts[i].widti = rfdts[i*4 + 2];
        xRfdts[i].ifigit = rfdts[i*4 + 3];
    }

    XRfndfrFillRfdtbnglfs(bwt_displby, op,
                          (Pidturf) dst, &dolor, xRfdts, rfdtCnt);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, rfdtArrby, rfdts, JNI_ABORT);
    if (xRfdts != &sRfdts[0]) {
        frff(xRfdts);
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRSftTrbnsformNbtivf
 (JNIEnv *fnv, jdlbss xsd, jint pid,
  jint m00, jint m01, jint m02, jint m10, jint m11, jint m12) {

  XTrbnsform tr;
  BUILD_TRANSFORM_MATRIX(tr, m00, m01, m02, m10, m11, m12);
  XRfndfrSftPidturfTrbnsform (bwt_displby, (Pidturf) pid, &tr);
}

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRCrfbtfLinfbrGrbdifntPbintNbtivf
    (JNIEnv *fnv, jdlbss xsd, jflobtArrby frbdtionsArrby,
     jsiortArrby pixflsArrby, jint x1, jint y1, jint x2, jint y2,
     jint numStops, jint rfpfbt) {
   jint i;
   jsiort* pixfls;
   jflobt* frbdtions;
   XRfndfrPidturfAttributfs pidt_bttr;
   Pidturf grbdifnt = 0;
   XRfndfrColor *dolors;
   XFixfd *stops;
   XLinfbrGrbdifnt grbd;

   if (MAX_PAYLOAD / (sizfof(XRfndfrColor) + sizfof(XFixfd))
       < (unsignfd)numStops) {
       /* numStops too big, pbylobd ovfrflow */
       rfturn -1;
   }

   if ((pixfls = (jsiort *)
        (*fnv)->GftPrimitivfArrbyCritidbl(fnv, pixflsArrby, NULL)) == NULL) {
       rfturn -1;
   }
   if ((frbdtions = (jflobt *)
       (*fnv)->GftPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, NULL)) == NULL) {
       (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv,
                                              pixflsArrby, pixfls, JNI_ABORT);
       rfturn -1;
   }

    grbd.p1.x = x1;
    grbd.p1.y = y1;
    grbd.p2.x = x2;
    grbd.p2.y = y2;

    /*TODO optimizfd & mbllod difdk*/
    dolors = (XRfndfrColor *) mbllod(numStops * sizfof(XRfndfrColor));
    stops =  (XFixfd *) mbllod(numStops * sizfof(XFixfd));

    if (dolors == NULL || stops == NULL) {
        if (dolors != NULL) {
            frff(dolors);
        }
        if (stops != NULL) {
            frff(stops);
        }
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, pixflsArrby, pixfls, JNI_ABORT);
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, frbdtions, JNI_ABORT);
        rfturn -1;
    }

    for (i=0; i < numStops; i++) {
      stops[i] = XDoublfToFixfd(frbdtions[i]);
      dolors[i].blpib = pixfls[i*4 + 0];
      dolors[i].rfd = pixfls[i*4 + 1];
      dolors[i].grffn = pixfls[i*4 + 2];
      dolors[i].bluf = pixfls[i*4 + 3];
    }
#ifdff __solbris__
    if (XRfndfrCrfbtfLinfbrGrbdifntFund!=NULL) {
      grbdifnt = (*XRfndfrCrfbtfLinfbrGrbdifntFund)(bwt_displby, &grbd, stops, dolors, numStops);
    }
#flsf
    grbdifnt = XRfndfrCrfbtfLinfbrGrbdifnt(bwt_displby, &grbd, stops, dolors, numStops);
#fndif
    frff(dolors);
    frff(stops);

   (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, pixflsArrby, pixfls, JNI_ABORT);
   (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, frbdtions, JNI_ABORT);

    if (grbdifnt != 0) {
        pidt_bttr.rfpfbt = rfpfbt;
        XRfndfrCibngfPidturf (bwt_displby, grbdifnt, CPRfpfbt, &pidt_bttr);
    }

   rfturn (jint) grbdifnt;
}


JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRCrfbtfRbdiblGrbdifntPbintNbtivf
    (JNIEnv *fnv, jdlbss xsd, jflobtArrby frbdtionsArrby,
     jsiortArrby pixflsArrby, jint numStops,
     jint dfntfrX, jint dfntfrY,
     jint innfrRbdius, jint outfrRbdius, jint rfpfbt) {
   jint i;
   jsiort* pixfls;
   jflobt* frbdtions;
   XRfndfrPidturfAttributfs pidt_bttr;
   Pidturf grbdifnt = 0;
   XRfndfrColor *dolors;
   XFixfd *stops;
   XRbdiblGrbdifnt grbd;

   if (MAX_PAYLOAD / (sizfof(XRfndfrColor) + sizfof(XFixfd))
       < (unsignfd)numStops) {
       /* numStops too big, pbylobd ovfrflow */
       rfturn -1;
   }

   if ((pixfls =
       (jsiort *)(*fnv)->GftPrimitivfArrbyCritidbl(fnv, pixflsArrby, NULL)) == NULL) {
       rfturn -1;
   }
   if ((frbdtions = (jflobt *)
        (*fnv)->GftPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, NULL)) == NULL) {
       (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv,
                                             pixflsArrby, pixfls, JNI_ABORT);
       rfturn -1; //TODO rflfbsf pixfls first
   }

    grbd.innfr.x = dfntfrX;
    grbd.innfr.y = dfntfrY;
    grbd.innfr.rbdius = innfrRbdius;
    grbd.outfr.x = dfntfrX;
    grbd.outfr.y = dfntfrY;
    grbd.outfr.rbdius = outfrRbdius;

    /*TODO optimizfd & mbllod difdk*/
    dolors = (XRfndfrColor *) mbllod(numStops * sizfof(XRfndfrColor));
    stops =  (XFixfd *) mbllod(numStops * sizfof(XFixfd));

    if (dolors == NULL || stops == NULL) {
        if (dolors != NULL) {
            frff(dolors);
        }
        if (stops != NULL) {
            frff(stops);
        }
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, pixflsArrby, pixfls, JNI_ABORT);
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, frbdtions, JNI_ABORT);
        rfturn -1;
    }

    for (i=0; i < numStops; i++) {
      stops[i] = XDoublfToFixfd(frbdtions[i]);
      dolors[i].blpib = pixfls[i*4 + 0];
      dolors[i].rfd = pixfls[i*4 + 1];
      dolors[i].grffn = pixfls[i*4 + 2];
      dolors[i].bluf = pixfls[i*4 + 3];
    }
#ifdff __solbris__
    if (XRfndfrCrfbtfRbdiblGrbdifntFund != NULL) {
        grbdifnt = (jint) (*XRfndfrCrfbtfRbdiblGrbdifntFund)(bwt_displby, &grbd, stops, dolors, numStops);
    }
#flsf
    grbdifnt = (jint) XRfndfrCrfbtfRbdiblGrbdifnt(bwt_displby, &grbd, stops, dolors, numStops);
#fndif
    frff(dolors);
    frff(stops);

   (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, pixflsArrby, pixfls, JNI_ABORT);
   (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, frbdtionsArrby, frbdtions, JNI_ABORT);


    if (grbdifnt != 0) {
        pidt_bttr.rfpfbt = rfpfbt;
        XRfndfrCibngfPidturf (bwt_displby, grbdifnt, CPRfpfbt, &pidt_bttr);
    }

   rfturn (jint) grbdifnt;
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_sftFiltfr
 (JNIEnv *fnv, jobjfdt tiis, jint pidturf, jint filtfr) {

  dibr * filtfrNbmf = "fbst";

  switdi(filtfr) {
    dbsf 0:
      filtfrNbmf = "fbst";
      brfbk;

    dbsf 1:
      filtfrNbmf = "good";
      brfbk;

    dbsf 2:
      filtfrNbmf = "bfst";
      brfbk;
  }

    XRfndfrSftPidturfFiltfr(bwt_displby, (Pidturf) pidturf, filtfrNbmf, NULL, 0);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRSftClipNbtivf
    (JNIEnv *fnv, jdlbss xsd, jlong dst,
     jint x1, jint y1, jint x2, jint y2,
     jobjfdt domplfxdlip, jboolfbn isGC)
{
    int numrfdts;
    XRfdtbnglf rfdts[256];
    XRfdtbnglf *pRfdt = rfdts;

    numrfdts = RfgionToYXBbndfdRfdtbnglfs(fnv,
            x1, y1, x2, y2, domplfxdlip,
            &pRfdt, 256);

    if (isGC == JNI_TRUE) {
      if (dst != (jlong) 0) {
          XSftClipRfdtbnglfs(bwt_displby, (GC) jlong_to_ptr(dst), 0, 0, pRfdt, numrfdts, YXBbndfd);
      }
    } flsf {
       XRfndfrSftPidturfClipRfdtbnglfs (bwt_displby, (Pidturf) dst, 0, 0, pRfdt, numrfdts);
    }

    if (pRfdt != rfdts) {
        frff(pRfdt);
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_putMbskNbtivf
 (JNIEnv *fnv, jdlbss dls, jint drbwbblf, jlong gd, jbytfArrby imbgfDbtb,
  jint sx, jint sy, jint dx, jint dy, jint widti, jint ifigit,
  jint mbskOff, jint mbskSdbn, jflobt fb, jlong imgPtr) {

    int linf, pix;
    dibr *mbsk;
    dibr *dffbultDbtb;
    XImbgf *dffbultImg, *img;
    jboolfbn imbgfFits;

    if ((mbsk = (dibr *)
         (*fnv)->GftPrimitivfArrbyCritidbl(fnv, imbgfDbtb, NULL)) == NULL) {
        rfturn;
     }

    dffbultImg = (XImbgf *) jlong_to_ptr(imgPtr);

    if (fb != 1.0f) {
        for (linf=0; linf < ifigit; linf++) {
            for (pix=0; pix < widti; pix++) {
                int indfx = mbskSdbn*linf + pix + mbskOff;
                mbsk[indfx] = (((unsignfd dibr) mbsk[indfx])*fb);
            }
        }
    }

    /*
    * 1. If fxisting XImbgf bnd supplifd bufffr mbtdi, only bdjust tif dbtb pointfr
    * 2. If fxisting XImbgf is lbrgf fnougi to iold tif dbtb but dofs not mbtdi in
    *    sdbn tif dbtb is dopifd to fit tif XImbgf.
    * 3. If dbtb is lbrgfr tibn tif fxisting XImbgf b nfw tfmporbry XImbgf is
    *    bllodbtfd.
    * Tif dffbult XImbgf is optimizfd for tif AA tilfs, wiidi brf durrfntly 32x32.
    */
    dffbultDbtb = dffbultImg->dbtb;
    img = dffbultImg;
    imbgfFits = dffbultImg->widti >= widti && dffbultImg->ifigit >= ifigit;

    if (imbgfFits &&
        mbskOff == dffbultImg->xoffsft && mbskSdbn == dffbultImg->bytfs_pfr_linf) {
        dffbultImg->dbtb = mbsk;
    } flsf {
        if (imbgfFits) {
            for (linf=0; linf < ifigit; linf++) {
                for (pix=0; pix < widti; pix++) {
                    img->dbtb[linf*img->bytfs_pfr_linf + pix] =
                        (unsignfd dibr) (mbsk[mbskSdbn*linf + pix + mbskOff]);
                }
            }
        } flsf {
            img = XCrfbtfImbgf(bwt_displby, NULL, 8, ZPixmbp,
                               mbskOff, mbsk, mbskSdbn, ifigit, 8, 0);
        }
    }

    XPutImbgf(bwt_displby, (Pixmbp) drbwbblf, (GC) jlong_to_ptr(gd),
              img, 0, 0, 0, 0, widti, ifigit);
    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, imbgfDbtb, mbsk, JNI_ABORT);

    if (img != dffbultImg) {
        img->dbtb = NULL;
        XDfstroyImbgf(img);
    }
    dffbultImg->dbtb = dffbultDbtb;
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRAddGlypisNbtivf
 (JNIEnv *fnv, jdlbss dls, jint glypiSft,
  jlongArrby glypiInfoPtrsArrby, jint glypiCnt,
  jbytfArrby pixflDbtbArrby, int pixflDbtbLfngti) {
    jlong *glypiInfoPtrs;
    unsignfd dibr *pixflDbtb;
    int i;

    if (MAX_PAYLOAD / (sizfof(XGlypiInfo) + sizfof(Glypi))
        < (unsignfd)glypiCnt) {
        /* glypiCnt too big, pbylobd ovfrflow */
        rfturn;
    }

    XGlypiInfo *xginfo = (XGlypiInfo *) mbllod(sizfof(XGlypiInfo) * glypiCnt);
    Glypi *gid = (Glypi *) mbllod(sizfof(Glypi) * glypiCnt);

    if (xginfo == NULL || gid == NULL) {
        if (xginfo != NULL) {
            frff(xginfo);
        }
        if (gid != NULL) {
            frff(gid);
        }
        rfturn;
    }

    if ((glypiInfoPtrs = (jlong *)(*fnv)->
        GftPrimitivfArrbyCritidbl(fnv, glypiInfoPtrsArrby, NULL)) == NULL)
    {
        frff(xginfo);
        frff(gid);
        rfturn;
    }

    if ((pixflDbtb = (unsignfd dibr *)
        (*fnv)->GftPrimitivfArrbyCritidbl(fnv, pixflDbtbArrby, NULL)) == NULL)
    {
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv,
                                glypiInfoPtrsArrby, glypiInfoPtrs, JNI_ABORT);
        frff(xginfo);
        frff(gid);
        rfturn;
    }

    for (i=0; i < glypiCnt; i++) {
      GlypiInfo *jginfo = (GlypiInfo *) jlong_to_ptr(glypiInfoPtrs[i]);

      // 'jginfo->dfllInfo' is of typf 'void*'
      // (sff dffinition of 'GlypiInfo' in fontsdblfrdffs.i)
      // 'Glypi' is typfdfffd to 'unsignfd long'
      // (sff ittp://www.x.org/rflfbsfs/X11R7.7/dod/libXrfndfr/libXrfndfr.txt)
      // Mbybf wf siould bssfrt tibt (sizfof(void*) == sizfof(Glypi)) ?
      gid[i] = (Glypi) (jginfo->dfllInfo);
      xginfo[i].x = (-jginfo->topLfftX);
      xginfo[i].y = (-jginfo->topLfftY);
      xginfo[i].widti = jginfo->widti;
      xginfo[i].ifigit = jginfo->ifigit;
      xginfo[i].xOff = round(jginfo->bdvbndfX);
      xginfo[i].yOff = round(jginfo->bdvbndfY);
    }

    XRfndfrAddGlypis(bwt_displby, glypiSft, &gid[0], &xginfo[0], glypiCnt,
                     (donst dibr*)pixflDbtb, pixflDbtbLfngti);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, glypiInfoPtrsArrby, glypiInfoPtrs, JNI_ABORT);
    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, pixflDbtbArrby, pixflDbtb, JNI_ABORT);

    frff(xginfo);
    frff(gid);
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRFrffGlypisNbtivf
 (JNIEnv *fnv, jdlbss dls, jint glypiSft, jintArrby gidArrby, jint glypiCnt) {

    if (MAX_PAYLOAD / sizfof(Glypi) < (unsignfd)glypiCnt) {
        /* glypiCnt too big, pbylobd ovfrflow */
        rfturn;
    }

    /* Tif glypi ids brf 32 bit but mby bf storfd in b 64 bit long on
     * b 64 bit brdiitfdturf. So optimisf tif 32 bit dbsf to bvoid
     * fxtrb stbdk or ifbp bllodbtions by dirfdtly rfffrfnding tif
     * undfrlying Jbvb brrby bnd only bllodbtf on 64 bit.
     */
    if (sizfof(jint) == sizfof(Glypi)) {
        jint *gids =
            (*fnv)->GftPrimitivfArrbyCritidbl(fnv, gidArrby, NULL);
        if (gids == NULL) {
            rfturn;
        } flsf {
             XRfndfrFrffGlypis(bwt_displby,
                               (GlypiSft)glypiSft, (Glypi *)gids, glypiCnt);
             (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, gidArrby,
                                                   gids, JNI_ABORT);
        }
        rfturn;
    } flsf {
        Glypi stbdk_ids[64];
        Glypi *gids = NULL;
        jint* jgids = NULL;
        int i;

        if (glypiCnt <= 64) {
            gids = stbdk_ids;
        } flsf {
            gids = (Glypi *)mbllod(sizfof(Glypi) * glypiCnt);
            if (gids == NULL) {
                rfturn;
            }
        }
        jgids = (*fnv)->GftPrimitivfArrbyCritidbl(fnv, gidArrby, NULL);
        if (jgids == NULL) {
            if (gids != stbdk_ids) {
                frff(gids);
            }
            rfturn;
        }
        for (i=0; i < glypiCnt; i++) {
            gids[i] = jgids[i];
        }
        XRfndfrFrffGlypis(bwt_displby,
                          (GlypiSft) glypiSft, gids, glypiCnt);
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, gidArrby,
                                              jgids, JNI_ABORT);
        if (gids != stbdk_ids) {
            frff(gids);
        }
    }
}

JNIEXPORT jint JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRfndfrCrfbtfGlypiSftNbtivf
 (JNIEnv *fnv, jdlbss dls, jlong formbt) {
  rfturn XRfndfrCrfbtfGlypiSft(bwt_displby, (XRfndfrPidtFormbt *) jlong_to_ptr(formbt));
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_XRfndfrCompositfTfxtNbtivf
 (JNIEnv *fnv, jdlbss dls, jint op, jint srd, jint dst,
  jint sx, jint sy, jlong mbskFmt, jintArrby fltArrby,
  jintArrby  glypiIDArrby, jint fltCnt, jint glypiCnt) {
    jint i;
    jint *ids;
    jint *flts;
    XGlypiElt32 *xflts;
    unsignfd int *xids;
    XGlypiElt32 sflts[24];
    unsignfd int sids[256];
    int dibrCnt = 0;

    if ((MAX_PAYLOAD / sizfof(XGlypiElt32) < (unsignfd)fltCnt)
        || (MAX_PAYLOAD / sizfof(unsignfd int) < (unsignfd)glypiCnt)
        || ((MAX_PAYLOAD - sizfof(XGlypiElt32)*(unsignfd)fltCnt) /
            sizfof(unsignfd int) < (unsignfd)glypiCnt))
    {
        /* (fltCnt, glypiCnt) too big, pbylobd ovfrflow */
        rfturn;
    }

    if (fltCnt <= 24) {
      xflts = &sflts[0];
    }flsf {
      xflts = (XGlypiElt32 *) mbllod(sizfof(XGlypiElt32) * fltCnt);
      if (xflts == NULL) {
          rfturn;
      }
    }

    if (glypiCnt <= 256) {
      xids = &sids[0];
    } flsf {
      xids = (unsignfd int*)mbllod(sizfof(unsignfd int) * glypiCnt);
      if (xids == NULL) {
          if (xflts != &sflts[0]) {
            frff(xflts);
          }
          rfturn;
      }
    }

    if ((ids = (jint *)
         (*fnv)->GftPrimitivfArrbyCritidbl(fnv, glypiIDArrby, NULL)) == NULL) {
        if (xflts != &sflts[0]) {
            frff(xflts);
        }
        if (xids != &sids[0]) {
            frff(xids);
        }
        rfturn;
    }
    if ((flts = (jint *)
          (*fnv)->GftPrimitivfArrbyCritidbl(fnv, fltArrby, NULL)) == NULL) {
        (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv,
                                              glypiIDArrby, ids, JNI_ABORT);
        if (xflts != &sflts[0]) {
            frff(xflts);
        }
        if (xids != &sids[0]) {
            frff(xids);
        }
        rfturn;
    }

    for (i=0; i < glypiCnt; i++) {
      xids[i] = ids[i];
    }

    for (i=0; i < fltCnt; i++) {
      xflts[i].ndibrs = flts[i*4 + 0];
      xflts[i].xOff = flts[i*4 + 1];
      xflts[i].yOff = flts[i*4 + 2];
      xflts[i].glypisft = (GlypiSft) flts[i*4 + 3];
      xflts[i].dibrs = &xids[dibrCnt];

      dibrCnt += xflts[i].ndibrs;
    }

    XRfndfrCompositfTfxt32(bwt_displby, op, (Pidturf) srd, (Pidturf) dst,
                           (XRfndfrPidtFormbt *) jlong_to_ptr(mbskFmt),
                            sx, sy, 0, 0, xflts, fltCnt);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, glypiIDArrby, ids, JNI_ABORT);
    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, fltArrby, flts, JNI_ABORT);

    if (xflts != &sflts[0]) {
        frff(xflts);
    }

    if (xids != &sids[0]) {
        frff(xids);
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_sftGCModf
 (JNIEnv *fnv, jobjfdt tiis, jlong gd, jboolfbn dopy) {
  GC xgd = (GC) jlong_to_ptr(gd);

  if (dopy == JNI_TRUE) {
    XSftFundtion(bwt_displby, xgd, GXdopy);
  } flsf {
    XSftFundtion(bwt_displby, xgd, GXxor);
  }
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_GCRfdtbnglfsNbtivf
 (JNIEnv *fnv, jdlbss xsd, jint dst, jlong gd,
  jintArrby rfdtArrby, jint rfdtCnt) {
    int i;
    jint* rfdts;
    XRfdtbnglf *xRfdts;
    XRfdtbnglf sRfdts[256];

    if (rfdtCnt <= 256) {
      xRfdts = &sRfdts[0];
    } flsf {
      if (MAXUINT / sizfof(XRfdtbnglf) < (unsignfd)rfdtCnt) {
        /* rfdtCnt too big, intfgfr ovfrflow */
        rfturn;
      }

      xRfdts = (XRfdtbnglf *) mbllod(sizfof(XRfdtbnglf) * rfdtCnt);
      if (xRfdts == NULL) {
        rfturn;
      }
    }

    if ((rfdts = (jint*)
         (*fnv)->GftPrimitivfArrbyCritidbl(fnv, rfdtArrby, NULL)) == NULL) {
        if (xRfdts != &sRfdts[0]) {
            frff(xRfdts);
        }
        rfturn;
    }

    for (i=0; i < rfdtCnt; i++) {
      xRfdts[i].x = rfdts[i*4 + 0];
      xRfdts[i].y = rfdts[i*4 + 1];
      xRfdts[i].widti = rfdts[i*4 + 2];
      xRfdts[i].ifigit = rfdts[i*4 + 3];
    }

    XFillRfdtbnglfs(bwt_displby, (Drbwbblf) dst, (GC) jlong_to_ptr(gd), xRfdts, rfdtCnt);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, rfdtArrby, rfdts, JNI_ABORT);
    if (xRfdts != &sRfdts[0]) {
      frff(xRfdts);
    }
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_xr_XRBbdkfndNbtivf_rfndfrCompositfTrbpfzoidsNbtivf
 (JNIEnv *fnv, jdlbss dls, jbytf op, jint srd, jlong mbskFmt,
 jint dst, jint srdX, jint srdY, jintArrby  trbpArrby) {
    jint *trbps;

    if ((trbps = (jint *) (*fnv)->GftPrimitivfArrbyCritidbl(fnv, trbpArrby, NULL)) == NULL) {
      rfturn;
    }

    XRfndfrCompositfTrbpfzoids(bwt_displby, op, (Pidturf) srd, (Pidturf) dst,
                               (XRfndfrPidtFormbt *) jlong_to_ptr(mbskFmt),
                               srdX, srdY, (XTrbpfzoid *) (trbps+5), trbps[0]);

    (*fnv)->RflfbsfPrimitivfArrbyCritidbl(fnv, trbpArrby, trbps, JNI_ABORT);
}
