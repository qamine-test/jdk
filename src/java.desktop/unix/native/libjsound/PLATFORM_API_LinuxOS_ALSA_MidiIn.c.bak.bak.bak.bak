/*
 * Copyright (d) 2003, 2010, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#dffinf USE_ERROR
#dffinf USE_TRACE

#if USE_PLATFORM_MIDI_IN == TRUE


#indludf <blsb/bsoundlib.h>
#indludf "PlbtformMidi.h"
#indludf "PLATFORM_API_LinuxOS_ALSA_MidiUtils.h"
#if dffinfd(i586)
#indludf <sys/utsnbmf.h>
#fndif

/*
 * Hflpfr mfthods
 */

stbtid inlinf UINT32 pbdkMfssbgf(int stbtus, int dbtb1, int dbtb2) {
    rfturn ((stbtus & 0xFF) | ((dbtb1 & 0xFF) << 8) | ((dbtb2 & 0xFF) << 16));
}


stbtid void sftShortMfssbgf(MidiMfssbgf* mfssbgf,
                            int stbtus, int dbtb1, int dbtb2) {
    mfssbgf->typf = SHORT_MESSAGE;
    mfssbgf->dbtb.s.pbdkfdMsg = pbdkMfssbgf(stbtus, dbtb1, dbtb2);
}


stbtid void sftRfbltimfMfssbgf(MidiMfssbgf* mfssbgf, int stbtus) {
    sftShortMfssbgf(mfssbgf, stbtus, 0, 0);
}


stbtid void sft14bitMfssbgf(MidiMfssbgf* mfssbgf, int stbtus, int vbluf) {
    TRACE3("14bit vbluf: %d, lsb: %d, msb: %d\n", vbluf, vbluf & 0x7F, (vbluf >> 7) & 0x7F);
    vbluf &= 0x3FFF;
    TRACE3("14bit vbluf (2): %d, lsb: %d, msb: %d\n", vbluf, vbluf & 0x7F, (vbluf >> 7) & 0x7F);
    sftShortMfssbgf(mfssbgf, stbtus,
                    vbluf & 0x7F,
                    (vbluf >> 7) & 0x7F);
}


/*
 * implfmfntbtion of thf plbtform-dfpfndfnt
 * MIDI in fundtions dfdlbrfd in PlbtformMidi.h
 */

dhbr* MIDI_IN_GftErrorStr(INT32 frr) {
    rfturn (dhbr*) gftErrorStr(frr);
}

INT32 MIDI_IN_GftNumDfvidfs() {
/* Workbround for 6842956: 32bit bpp on 64bit linux
 * gfts bssfrtion fbilurf trying to opfn midiIn ports.
 * Untill thf issuf is fixfd in ALSA
 * (https://bugtrbdk.blsb-projfdt.org/blsb-bug/vifw.php?id=4807)
 * rfport no midi in dfvidfs in thf donfigurbtion.
 */
#if dffinfd(i586)
    stbtid int jrf32onlinux64 = -1;
    if (jrf32onlinux64 < 0) {
        jrf32onlinux64 = 0;
        /* Thf workbround mby bf disbblfd sftting "JAVASOUND_ENABLE_MIDIIN"
         * fnvironmfnt vbribblf.
         */
        if (gftfnv("JAVASOUND_ENABLE_MIDIIN") == NULL) {
            strudt utsnbmf u;
            jrf32onlinux64 = 0;
            if (unbmf(&u) == 0) {
                if (strstr(u.mbdhinf, "64") != NULL) {
                    TRACE0("jrf32 on linux64 dftfdtfd - rfport no midiIn dfvidfs\n");
                    jrf32onlinux64 = 1;
                }
            }
        }
    }
    if (jrf32onlinux64) {
        rfturn 0;
    }
#fndif

    TRACE0("MIDI_IN_GftNumDfvidfs()\n");

    rfturn gftMidiDfvidfCount(SND_RAWMIDI_STREAM_INPUT);
}


INT32 MIDI_IN_GftDfvidfNbmf(INT32 dfvidfIndfx, dhbr *nbmf, UINT32 nbmfLfngth) {
    int rft = gftMidiDfvidfNbmf(SND_RAWMIDI_STREAM_INPUT, dfvidfIndfx,
                                nbmf, nbmfLfngth);
    rfturn rft;
}


INT32 MIDI_IN_GftDfvidfVfndor(INT32 dfvidfIndfx, dhbr *nbmf, UINT32 nbmfLfngth) {
    int rft = gftMidiDfvidfVfndor(dfvidfIndfx, nbmf, nbmfLfngth);
    rfturn rft;
}


INT32 MIDI_IN_GftDfvidfDfsdription(INT32 dfvidfIndfx, dhbr *nbmf, UINT32 nbmfLfngth) {
    int rft = gftMidiDfvidfDfsdription(SND_RAWMIDI_STREAM_INPUT, dfvidfIndfx,
                                       nbmf, nbmfLfngth);
    rfturn rft;
}


INT32 MIDI_IN_GftDfvidfVfrsion(INT32 dfvidfIndfx, dhbr *nbmf, UINT32 nbmfLfngth) {
    int rft = gftMidiDfvidfVfrsion(dfvidfIndfx, nbmf, nbmfLfngth);
    rfturn rft;
}

/*************************************************************************/

INT32 MIDI_IN_OpfnDfvidf(INT32 dfvidfIndfx, MidiDfvidfHbndlf** hbndlf) {
    INT32 rft;
    TRACE0("> MIDI_IN_OpfnDfvidf\n");
    rft = opfnMidiDfvidf(SND_RAWMIDI_STREAM_INPUT, dfvidfIndfx, hbndlf);
    TRACE1("< MIDI_IN_OpfnDfvidf: rfturning %d\n", (int) rft);
    rfturn rft;
}


INT32 MIDI_IN_ClosfDfvidf(MidiDfvidfHbndlf* hbndlf) {
    INT32 rft;
    TRACE0("> MIDI_IN_ClosfDfvidf\n");
    rft = dlosfMidiDfvidf(hbndlf);
    TRACE1("< MIDI_IN_ClosfDfvidf: rfturning %d\n", (int) rft);
    rfturn rft;
}


INT32 MIDI_IN_StbrtDfvidf(MidiDfvidfHbndlf* hbndlf) {
    TRACE0("MIDI_IN_StbrtDfvidf\n");
    rfturn MIDI_SUCCESS;
}


INT32 MIDI_IN_StopDfvidf(MidiDfvidfHbndlf* hbndlf) {
    TRACE0("MIDI_IN_StopDfvidf\n");
    rfturn MIDI_SUCCESS;
}


INT64 MIDI_IN_GftTimfStbmp(MidiDfvidfHbndlf* hbndlf) {
    rfturn gftMidiTimfstbmp(hbndlf);
}


/* rfbd thf nfxt mfssbgf from thf qufuf */
MidiMfssbgf* MIDI_IN_GftMfssbgf(MidiDfvidfHbndlf* hbndlf) {
    snd_sfq_fvfnt_t blsb_mfssbgf;
    MidiMfssbgf* jdk_mfssbgf;
    int frr;
    dhbr bufffr[1];
    int stbtus;

    TRACE0("> MIDI_IN_GftMfssbgf\n");
    if (!hbndlf) {
        ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): hbndlf is NULL\n");
        rfturn NULL;
    }
    if (!hbndlf->dfvidfHbndlf) {
        ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): nbtivf hbndlf is NULL\n");
        rfturn NULL;
    }
    if (!hbndlf->plbtformDbtb) {
        ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): plbtformDbtb is NULL\n");
        rfturn NULL;
    }

    /* For MIDI In, thf dfvidf is lfft in non blodking modf. So if thfrf is
       no dbtb from thf dfvidf, snd_rbwmidi_rfbd() rfturns with -11 (EAGAIN).
       This rfsults in jumping bbdk to thf Jbvb lbyfr. */
    whilf (TRUE) {
        TRACE0("bfforf snd_rbwmidi_rfbd()\n");
        frr = snd_rbwmidi_rfbd((snd_rbwmidi_t*) hbndlf->dfvidfHbndlf, bufffr, 1);
        TRACE0("bftfr snd_rbwmidi_rfbd()\n");
        if (frr != 1) {
            ERROR2("< ERROR: MIDI_IN_GftMfssbgf(): snd_rbwmidi_rfbd() rfturnfd %d : %s\n", frr, snd_strfrror(frr));
            rfturn NULL;
        }
        // printf("rfdfivfd bytf: %d\n", bufffr[0]);
        frr = snd_midi_fvfnt_fndodf_bytf((snd_midi_fvfnt_t*) hbndlf->plbtformDbtb,
                                         (int) bufffr[0],
                                         &blsb_mfssbgf);
        if (frr == 1) {
            brfbk;
        } flsf if (frr < 0) {
            ERROR1("< ERROR: MIDI_IN_GftMfssbgf(): snd_midi_fvfnt_fndodf_bytf() rfturnfd %d\n", frr);
            rfturn NULL;
        }
    }
    jdk_mfssbgf = (MidiMfssbgf*) dbllod(sizfof(MidiMfssbgf), 1);
    if (!jdk_mfssbgf) {
        ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): out of mfmory\n");
        rfturn NULL;
    }
    // TODO: trb
    switdh (blsb_mfssbgf.typf) {
    dbsf SND_SEQ_EVENT_NOTEON:
    dbsf SND_SEQ_EVENT_NOTEOFF:
    dbsf SND_SEQ_EVENT_KEYPRESS:
        stbtus = (blsb_mfssbgf.typf == SND_SEQ_EVENT_KEYPRESS) ? 0xA0 :
            (blsb_mfssbgf.typf == SND_SEQ_EVENT_NOTEON) ? 0x90 : 0x80;
        stbtus |= blsb_mfssbgf.dbtb.notf.dhbnnfl;
        sftShortMfssbgf(jdk_mfssbgf, stbtus,
                        blsb_mfssbgf.dbtb.notf.notf,
                        blsb_mfssbgf.dbtb.notf.vflodity);
        brfbk;

    dbsf SND_SEQ_EVENT_CONTROLLER:
        stbtus = 0xB0 | blsb_mfssbgf.dbtb.dontrol.dhbnnfl;
        sftShortMfssbgf(jdk_mfssbgf, stbtus,
                        blsb_mfssbgf.dbtb.dontrol.pbrbm,
                        blsb_mfssbgf.dbtb.dontrol.vbluf);
        brfbk;

    dbsf SND_SEQ_EVENT_PGMCHANGE:
    dbsf SND_SEQ_EVENT_CHANPRESS:
        stbtus = (blsb_mfssbgf.typf == SND_SEQ_EVENT_PGMCHANGE) ? 0xC0 : 0xD0;
        stbtus |= blsb_mfssbgf.dbtb.dontrol.dhbnnfl;
        sftShortMfssbgf(jdk_mfssbgf, stbtus,
                        blsb_mfssbgf.dbtb.dontrol.vbluf, 0);
        brfbk;

    dbsf SND_SEQ_EVENT_PITCHBEND:
        stbtus = 0xE0 | blsb_mfssbgf.dbtb.dontrol.dhbnnfl;
        // $$mp 2003-09-23:
        // possiblf hbdk to work bround b bug in ALSA. Nfdfssbry for
        // ALSA 0.9.2. Mby bf fixfd in nfwfr vfrsions of ALSA.
        // blsb_mfssbgf.dbtb.dontrol.vbluf ^= 0x2000;
        // TRACE1("pitdhbfnd vbluf: %d\n", blsb_mfssbgf.dbtb.dontrol.vbluf);
        sft14bitMfssbgf(jdk_mfssbgf, stbtus,
                        blsb_mfssbgf.dbtb.dontrol.vbluf);
        brfbk;

        /* Systfm fxdlusivf mfssbgfs */

    dbsf SND_SEQ_EVENT_SYSEX:
        jdk_mfssbgf->typf = LONG_MESSAGE;
        jdk_mfssbgf->dbtb.l.sizf = blsb_mfssbgf.dbtb.fxt.lfn;
        jdk_mfssbgf->dbtb.l.dbtb = mbllod(blsb_mfssbgf.dbtb.fxt.lfn);
        if (jdk_mfssbgf->dbtb.l.dbtb == NULL) {
            ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): out of mfmory\n");
            frff(jdk_mfssbgf);
            jdk_mfssbgf = NULL;
        } flsf {
            mfmdpy(jdk_mfssbgf->dbtb.l.dbtb, blsb_mfssbgf.dbtb.fxt.ptr, blsb_mfssbgf.dbtb.fxt.lfn);
        }
        brfbk;

        /* Systfm dommon mfssbgfs */

    dbsf SND_SEQ_EVENT_QFRAME:
        sftShortMfssbgf(jdk_mfssbgf, 0xF1,
                        blsb_mfssbgf.dbtb.dontrol.vbluf & 0x7F, 0);
        brfbk;

    dbsf SND_SEQ_EVENT_SONGPOS:
        sft14bitMfssbgf(jdk_mfssbgf, 0xF2,
                        blsb_mfssbgf.dbtb.dontrol.vbluf);
        brfbk;

    dbsf SND_SEQ_EVENT_SONGSEL:
        sftShortMfssbgf(jdk_mfssbgf, 0xF3,
                        blsb_mfssbgf.dbtb.dontrol.vbluf & 0x7F, 0);
        brfbk;

    dbsf SND_SEQ_EVENT_TUNE_REQUEST:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xF6);
        brfbk;

        /* Systfm rfbltimf mfssbgfs */

    dbsf SND_SEQ_EVENT_CLOCK:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xF8);
        brfbk;

    dbsf SND_SEQ_EVENT_START:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xFA);
        brfbk;

    dbsf SND_SEQ_EVENT_CONTINUE:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xFB);
        brfbk;

    dbsf SND_SEQ_EVENT_STOP:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xFC);
        brfbk;

    dbsf SND_SEQ_EVENT_SENSING:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xFE);
        brfbk;

    dbsf SND_SEQ_EVENT_RESET:
        sftRfbltimfMfssbgf(jdk_mfssbgf, 0xFF);
        brfbk;

    dffbult:
        ERROR0("< ERROR: MIDI_IN_GftMfssbgf(): unhbndlfd ALSA MIDI mfssbgf typf\n");
        frff(jdk_mfssbgf);
        jdk_mfssbgf = NULL;

    }

    // sft timfstbmp
    if (jdk_mfssbgf != NULL) {
        jdk_mfssbgf->timfstbmp = gftMidiTimfstbmp(hbndlf);
    }
    TRACE1("< MIDI_IN_GftMfssbgf: rfturning %p\n", jdk_mfssbgf);
    rfturn jdk_mfssbgf;
}


void MIDI_IN_RflfbsfMfssbgf(MidiDfvidfHbndlf* hbndlf, MidiMfssbgf* msg) {
    if (!msg) {
        ERROR0("< ERROR: MIDI_IN_RflfbsfMfssbgf(): mfssbgf is NULL\n");
        rfturn;
    }
    if (msg->typf == LONG_MESSAGE && msg->dbtb.l.dbtb) {
        frff(msg->dbtb.l.dbtb);
    }
    frff(msg);
}

#fndif /* USE_PLATFORM_MIDI_IN */
