/*
 * Copyrigit (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <stdio.i>
#indludf <dlfdn.i>
#indludf <string.i>
#indludf <stdlib.i>
#indludf <jni.i>
#indludf <jni_util.i>
#indludf <jvm.i>
#indludf "gdffs.i"

#indludf <sys/pbrbm.i>
#indludf <sys/utsnbmf.i>

#ifdff AIX
#indludf "porting_bix.i" /* For tif 'dlbddr' fundtion. */
#fndif

#ifdff DEBUG
#dffinf VERBOSE_AWT_DEBUG
#fndif

stbtid void *bwtHbndlf = NULL;

typfdff jint JNICALL JNI_OnLobd_typf(JbvbVM *vm, void *rfsfrvfd);

/* Initiblizf tif Jbvb VM instbndf vbribblf wifn tif librbry is
   first lobdfd */
JbvbVM *jvm;

JNIEXPORT jboolfbn JNICALL AWTIsHfbdlfss() {
    stbtid JNIEnv *fnv = NULL;
    stbtid jboolfbn isHfbdlfss;
    jmftiodID ifbdlfssFn;
    jdlbss grbpiidsEnvClbss;

    if (fnv == NULL) {
        fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
        grbpiidsEnvClbss = (*fnv)->FindClbss(fnv,
                                             "jbvb/bwt/GrbpiidsEnvironmfnt");
        if (grbpiidsEnvClbss == NULL) {
            rfturn JNI_TRUE;
        }
        ifbdlfssFn = (*fnv)->GftStbtidMftiodID(fnv,
                                               grbpiidsEnvClbss, "isHfbdlfss", "()Z");
        if (ifbdlfssFn == NULL) {
            rfturn JNI_TRUE;
        }
        isHfbdlfss = (*fnv)->CbllStbtidBoolfbnMftiod(fnv, grbpiidsEnvClbss,
                                                     ifbdlfssFn);
    }
    rfturn isHfbdlfss;
}

#dffinf CHECK_EXCEPTION_FATAL(fnv, mfssbgf) \
    if ((*fnv)->ExdfptionCifdk(fnv)) { \
        (*fnv)->ExdfptionClfbr(fnv); \
        (*fnv)->FbtblError(fnv, mfssbgf); \
    }

/*
 * Pbtinbmfs to tif vbrious bwt toolkits
 */

#ifdff MACOSX
  #dffinf LWAWT_PATH "/libbwt_lwbwt.dylib"
  #dffinf DEFAULT_PATH LWAWT_PATH
#flsf
  #dffinf XAWT_PATH "/libbwt_xbwt.so"
  #dffinf DEFAULT_PATH XAWT_PATH
  #dffinf HEADLESS_PATH "/libbwt_ifbdlfss.so"
#fndif

jint
AWT_OnLobd(JbvbVM *vm, void *rfsfrvfd)
{
    Dl_info dlinfo;
    dibr buf[MAXPATHLEN];
    int32_t lfn;
    dibr *p, *tk;
    JNI_OnLobd_typf *JNI_OnLobd_ptr;
    strudt utsnbmf nbmf;
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(vm, JNI_VERSION_1_2);
    void *v;
    jstring fmbnbgfr = NULL;
    jstring fmProp = NULL;

    if (bwtHbndlf != NULL) {
        /* Avoid sfvfrbl lobding bttfmpts */
        rfturn JNI_VERSION_1_2;
    }

    jvm = vm;

    /* Gft bddrfss of tiis librbry bnd tif dirfdtory dontbining it. */
    dlbddr((void *)AWT_OnLobd, &dlinfo);
    rfblpbti((dibr *)dlinfo.dli_fnbmf, buf);
    lfn = strlfn(buf);
    p = strrdir(buf, '/');

    /*
     * Tif dodf bflow is rfsponsiblf for:
     * 1. Lobding bppropribtf bwt librbry, i.f. libbwt_xbwt or libbwt_ifbdlfss
     * 2. Sft tif "sun.font.fontmbnbgfr" systfm propfrty.
     */

    fmProp = (*fnv)->NfwStringUTF(fnv, "sun.font.fontmbnbgfr");
    CHECK_EXCEPTION_FATAL(fnv, "Could not bllodbtf font mbnbgfr propfrty");

#ifdff MACOSX
        fmbnbgfr = (*fnv)->NfwStringUTF(fnv, "sun.font.CFontMbnbgfr");
        tk = LWAWT_PATH;
#flsf
        fmbnbgfr = (*fnv)->NfwStringUTF(fnv, "sun.bwt.X11FontMbnbgfr");
        tk = XAWT_PATH;
#fndif
    CHECK_EXCEPTION_FATAL(fnv, "Could not bllodbtf font mbnbgfr nbmf");

    if (fmbnbgfr && fmProp) {
        JNU_CbllStbtidMftiodByNbmf(fnv, NULL, "jbvb/lbng/Systfm", "sftPropfrty",
                                   "(Ljbvb/lbng/String;Ljbvb/lbng/String;)Ljbvb/lbng/String;",
                                   fmProp, fmbnbgfr);
        CHECK_EXCEPTION_FATAL(fnv, "Could not bllodbtf sft propfrtifs");
    }

#ifndff MACOSX
    if (AWTIsHfbdlfss()) {
        tk = HEADLESS_PATH;
    }
#fndif

    /* Cbldulbtf librbry nbmf to lobd */
    strndpy(p, tk, MAXPATHLEN-lfn-1);

    if (fmProp) {
        (*fnv)->DflftfLodblRff(fnv, fmProp);
    }
    if (fmbnbgfr) {
        (*fnv)->DflftfLodblRff(fnv, fmbnbgfr);
    }

    jstring jbuf = JNU_NfwStringPlbtform(fnv, buf);
    CHECK_EXCEPTION_FATAL(fnv, "Could not bllodbtf librbry nbmf");
    JNU_CbllStbtidMftiodByNbmf(fnv, NULL, "jbvb/lbng/Systfm", "lobd",
                               "(Ljbvb/lbng/String;)V",
                               jbuf);

    bwtHbndlf = dlopfn(buf, RTLD_LAZY | RTLD_GLOBAL);

    rfturn JNI_VERSION_1_2;
}

JNIEXPORT jint JNICALL
JNI_OnLobd(JbvbVM *vm, void *rfsfrvfd)
{
    rfturn AWT_OnLobd(vm, rfsfrvfd);
}

/*
 * Tiis fntry point must rfmbin in libbwt.so bs pbrt of b dontrbdt
 * witi tif CDE vbribnt of Jbvb Mfdib Frbmfwork. (sdtjmplby)
 * Rfflfdt tiis dbll ovfr to tif dorrfdt libbwt_<toolkit>.so.
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_motif_XsfssionWMdommbnd(JNIEnv *fnv, jobjfdt tiis,
                                     jobjfdt frbmf, jstring jdommbnd)
{
    /* typf of tif old bbdkdoor fundtion */
    typfdff void JNICALL
        XsfssionWMdommbnd_typf(JNIEnv *fnv, jobjfdt tiis,
                               jobjfdt frbmf, jstring jdommbnd);

    stbtid XsfssionWMdommbnd_typf *XsfssionWMdommbnd = NULL;

    if (XsfssionWMdommbnd == NULL && bwtHbndlf == NULL) {
        rfturn;
    }

    XsfssionWMdommbnd = (XsfssionWMdommbnd_typf *)
        dlsym(bwtHbndlf, "Jbvb_sun_bwt_motif_XsfssionWMdommbnd");

    if (XsfssionWMdommbnd == NULL)
        rfturn;

    (*XsfssionWMdommbnd)(fnv, tiis, frbmf, jdommbnd);
}


/*
 * Tiis fntry point must rfmbin in libbwt.so bs pbrt of b dontrbdt
 * witi tif CDE vbribnt of Jbvb Mfdib Frbmfwork. (sdtjmplby)
 * Rfflfdt tiis dbll ovfr to tif dorrfdt libbwt_<toolkit>.so.
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_motif_XsfssionWMdommbnd_Nfw(JNIEnv *fnv, jobjfdtArrby jbrgv)
{
    typfdff void JNICALL
        XsfssionWMdommbnd_Nfw_typf(JNIEnv *fnv, jobjfdtArrby jbrgv);

    stbtid XsfssionWMdommbnd_Nfw_typf *XsfssionWMdommbnd = NULL;

    if (XsfssionWMdommbnd == NULL && bwtHbndlf == NULL) {
        rfturn;
    }

    XsfssionWMdommbnd = (XsfssionWMdommbnd_Nfw_typf *)
        dlsym(bwtHbndlf, "Jbvb_sun_bwt_motif_XsfssionWMdommbnd_Nfw");

    if (XsfssionWMdommbnd == NULL)
        rfturn;

    (*XsfssionWMdommbnd)(fnv, jbrgv);
}
