/*
 * Copyrigit (d) 2003, 2010, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#if !dffinfd(JAVA2D_NO_MLIB) || dffinfd(MLIB_ADD_SUFF)

#indludf "jbvb2d_Mlib.i"
#indludf "SurfbdfDbtb.i"

#indludf "mlib_ImbgfZoom.i"

/***************************************************************/

#dffinf DEFINE_ISO_COPY(FUNC, ANYTYPE)               \
void ADD_SUFF(ANYTYPE##FUNC)(BLIT_PARAMS)            \
{                                                    \
    mlib_s32 srdSdbn = pSrdInfo->sdbnStridf;         \
    mlib_s32 dstSdbn = pDstInfo->sdbnStridf;         \
    mlib_s32 xsizf = widti*ANYTYPE##PixflStridf;     \
    mlib_s32 i;                                      \
                                                     \
    if (srdSdbn == xsizf && dstSdbn == xsizf) {      \
        xsizf *= ifigit;                             \
        ifigit = 1;                                  \
    }                                                \
                                                     \
    for (i = 0; i < ifigit; i++) {                   \
        mlib_ImbgfCopy_nb(srdBbsf, dstBbsf, xsizf);  \
        srdBbsf = (mlib_u8*)srdBbsf + srdSdbn;       \
        dstBbsf = (mlib_u8*)dstBbsf + dstSdbn;       \
    }                                                \
}

DEFINE_ISO_COPY(IsomorpiidCopy, Any3Bytf)
DEFINE_ISO_COPY(IsomorpiidCopy, Any4Bytf)
DEFINE_ISO_COPY(IsomorpiidCopy, AnyBytf)
DEFINE_ISO_COPY(IsomorpiidCopy, AnyInt)
DEFINE_ISO_COPY(IsomorpiidCopy, AnySiort)

/***************************************************************/

#dffinf SET_PIX(indfx, dibn)         \
    dst_ptr[indfx] = pixfl##dibn

#dffinf W_LEVEL_1   8
#dffinf W_LEVEL_3  16
#dffinf W_LEVEL_4   8

#dffinf DEFINE_SET_RECT(FUNC, ANYTYPE, NCHAN)                       \
void ADD_SUFF(ANYTYPE##FUNC)(SurfbdfDbtbRbsInfo * pRbsInfo,         \
                             jint lox, jint loy, jint iix,          \
                             jint iiy, jint pixfl,                  \
                             NbtivfPrimitivf * pPrim,               \
                             CompositfInfo * pCompInfo)             \
{                                                                   \
    mlib_imbgf dst[1];                                              \
    mlib_s32 dstSdbn = pRbsInfo->sdbnStridf;                        \
    mlib_s32 ifigit = iiy - loy;                                    \
    mlib_s32 widti  = iix - lox;                                    \
    mlib_u8  *dstBbsf = (mlib_u8*)(pRbsInfo->rbsBbsf);              \
    mlib_s32 d_brr[4];                                              \
                                                                    \
    dstBbsf += loy*dstSdbn + lox*ANYTYPE##PixflStridf;              \
                                                                    \
    if (widti <= W_LEVEL_##NCHAN) {                                 \
        EXTRACT_CONST_##NCHAN(pixfl);                               \
                                                                    \
        LOOP_DST(ANYTYPE, NCHAN, dstBbsf, dstSdbn, SET_PIX);        \
        rfturn;                                                     \
    }                                                               \
                                                                    \
    STORE_CONST_##NCHAN(d_brr, pixfl);                              \
                                                                    \
    MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN,                      \
                   widti, ifigit, dstSdbn, dstBbsf);                \
                                                                    \
    mlib_ImbgfClfbr(dst, d_brr);                                    \
}

DEFINE_SET_RECT(SftRfdt, Any3Bytf, 3)
DEFINE_SET_RECT(SftRfdt, Any4Bytf, 4)
DEFINE_SET_RECT(SftRfdt, AnyBytf,  1)
DEFINE_SET_RECT(SftRfdt, AnyInt,   1)
DEFINE_SET_RECT(SftRfdt, AnySiort, 1)

/***************************************************************/

#dffinf XOR_PIX(indfx, dibn)         \
    dst_ptr[indfx] ^= pixfl##dibn

#dffinf DEFINE_XOR_RECT(FUNC, ANYTYPE, NCHAN)                       \
void ADD_SUFF(ANYTYPE##FUNC)(SurfbdfDbtbRbsInfo * pRbsInfo,         \
                             jint lox, jint loy, jint iix,          \
                             jint iiy, jint pixfl,                  \
                             NbtivfPrimitivf * pPrim,               \
                             CompositfInfo * pCompInfo)             \
{                                                                   \
    mlib_imbgf dst[1];                                              \
    mlib_s32 dstSdbn = pRbsInfo->sdbnStridf;                        \
    mlib_s32 ifigit = iiy - loy;                                    \
    mlib_s32 widti  = iix - lox;                                    \
    mlib_u8  *dstBbsf = (mlib_u8*)(pRbsInfo->rbsBbsf);              \
    mlib_s32 d_brr[4];                                              \
    mlib_s32 xorpixfl = pCompInfo->dftbils.xorPixfl;                \
    mlib_s32 blpibmbsk = pCompInfo->blpibMbsk;                      \
                                                                    \
    pixfl = (pixfl ^ xorpixfl) &~ blpibmbsk;                        \
                                                                    \
    dstBbsf += loy*dstSdbn + lox*ANYTYPE##PixflStridf;              \
                                                                    \
    if (widti < 8) {                                                \
        EXTRACT_CONST_##NCHAN(pixfl);                               \
                                                                    \
        LOOP_DST(ANYTYPE, NCHAN, dstBbsf, dstSdbn, XOR_PIX);        \
        rfturn;                                                     \
    }                                                               \
                                                                    \
    STORE_CONST_##NCHAN(d_brr, pixfl);                              \
                                                                    \
    MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN,                      \
                   widti, ifigit, dstSdbn, dstBbsf);                \
                                                                    \
    mlib_ImbgfConstXor(dst, dst, d_brr);                            \
}

DEFINE_XOR_RECT(XorRfdt, Any3Bytf, 3)
DEFINE_XOR_RECT(XorRfdt, Any4Bytf, 4)
DEFINE_XOR_RECT(XorRfdt, AnyBytf,  1)
DEFINE_XOR_RECT(XorRfdt, AnyInt,   1)
DEFINE_XOR_RECT(XorRfdt, AnySiort, 1)

/***************************************************************/

#dffinf XOR_COPY(indfx, dibn)         \
    dst_ptr[indfx] = dst_ptr[indfx] ^ srd_ptr[indfx] ^ pixfl##dibn

#dffinf DEFINE_XOR_COPY(FUNC, ANYTYPE, NCHAN)                  \
void ADD_SUFF(ANYTYPE##FUNC)(void *srdBbsf,                    \
                             void *dstBbsf,                    \
                             juint widti,                      \
                             juint ifigit,                     \
                             SurfbdfDbtbRbsInfo *pSrdInfo,     \
                             SurfbdfDbtbRbsInfo *pDstInfo,     \
                             NbtivfPrimitivf *pPrim,           \
                             CompositfInfo *pCompInfo)         \
{                                                              \
    mlib_imbgf srd[1], dst[1];                                 \
    mlib_s32 srdSdbn = pSrdInfo->sdbnStridf;                   \
    mlib_s32 dstSdbn = pDstInfo->sdbnStridf;                   \
    mlib_s32 d_brr[4];                                         \
    mlib_s32 pixfl  = pCompInfo->dftbils.xorPixfl;             \
                                                               \
    if (widti < 8*sizfof(ANYTYPE##DbtbTypf)) {                 \
        EXTRACT_CONST_##NCHAN(pixfl);                          \
                                                               \
        LOOP_DST_SRC(ANYTYPE, NCHAN, dstBbsf, dstSdbn,         \
                     srdBbsf, srdSdbn, XOR_COPY);              \
        rfturn;                                                \
    }                                                          \
                                                               \
    STORE_CONST_##NCHAN(d_brr, pixfl);                         \
                                                               \
    MLIB_IMAGE_SET(srd, MLIB_##ANYTYPE, NCHAN,                 \
                   widti, ifigit, srdSdbn, srdBbsf);           \
    MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN,                 \
                   widti, ifigit, dstSdbn, dstBbsf);           \
                                                               \
    mlib_ImbgfXor(dst, dst, srd);                              \
    mlib_ImbgfConstXor(dst, dst, d_brr);                       \
}

DEFINE_XOR_COPY(IsomorpiidXorCopy, Any3Bytf, 3)
DEFINE_XOR_COPY(IsomorpiidXorCopy, Any4Bytf, 4)
DEFINE_XOR_COPY(IsomorpiidXorCopy, AnyBytf,  1)
DEFINE_XOR_COPY(IsomorpiidXorCopy, AnyInt,   1)
DEFINE_XOR_COPY(IsomorpiidXorCopy, AnySiort, 1)

/***************************************************************/

#dffinf DEFINE_SET_SPANS(FUNC, ANYTYPE, NCHAN)                      \
void ADD_SUFF(ANYTYPE##FUNC)(SurfbdfDbtbRbsInfo * pRbsInfo,         \
                             SpbnItfrbtorFunds * pSpbnFunds,        \
                             void *siDbtb, jint pixfl,              \
                             NbtivfPrimitivf * pPrim,               \
                             CompositfInfo * pCompInfo)             \
{                                                                   \
    mlib_imbgf dst[1];                                              \
    mlib_s32 dstSdbn = pRbsInfo->sdbnStridf;                        \
    mlib_s32 ifigit;                                                \
    mlib_s32 widti;                                                 \
    mlib_u8  *dstBbsf = (mlib_u8*)(pRbsInfo->rbsBbsf), *pdst;       \
    mlib_s32 d_brr[4];                                              \
    jint     bbox[4];                                               \
                                                                    \
    STORE_CONST_##NCHAN(d_brr, pixfl);                              \
                                                                    \
    wiilf ((*pSpbnFunds->nfxtSpbn)(siDbtb, bbox)) {                 \
        mlib_s32 lox = bbox[0];                                     \
        mlib_s32 loy = bbox[1];                                     \
        mlib_s32 widti  = bbox[2] - lox;                            \
        mlib_s32 ifigit = bbox[3] - loy;                            \
                                                                    \
        pdst = dstBbsf + loy*dstSdbn + lox*ANYTYPE##PixflStridf;    \
                                                                    \
        MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN_##ANYTYPE,        \
                       widti, ifigit, dstSdbn, pdst);               \
                                                                    \
        mlib_ImbgfClfbr(dst, d_brr);                                \
    }                                                               \
}

DEFINE_SET_SPANS(SftSpbns, Any3Bytf, 3)
DEFINE_SET_SPANS(SftSpbns, Any4Bytf, 4)
DEFINE_SET_SPANS(SftSpbns, AnyBytf,  1)
DEFINE_SET_SPANS(SftSpbns, AnyInt,   1)
DEFINE_SET_SPANS(SftSpbns, AnySiort, 1)

/***************************************************************/

#dffinf DEFINE_XOR_SPANS(FUNC, ANYTYPE, NCHAN)                      \
void ADD_SUFF(ANYTYPE##FUNC)(SurfbdfDbtbRbsInfo * pRbsInfo,         \
                             SpbnItfrbtorFunds * pSpbnFunds,        \
                             void *siDbtb, jint pixfl,              \
                             NbtivfPrimitivf * pPrim,               \
                             CompositfInfo * pCompInfo)             \
{                                                                   \
    mlib_imbgf dst[1];                                              \
    mlib_s32 dstSdbn = pRbsInfo->sdbnStridf;                        \
    mlib_s32 ifigit;                                                \
    mlib_s32 widti;                                                 \
    mlib_u8  *dstBbsf = (mlib_u8*)(pRbsInfo->rbsBbsf), *pdst;       \
    mlib_s32 d_brr[4];                                              \
    mlib_s32 xorpixfl = pCompInfo->dftbils.xorPixfl;                \
    mlib_s32 blpibmbsk = pCompInfo->blpibMbsk;                      \
    jint     bbox[4];                                               \
                                                                    \
    pixfl = (pixfl ^ xorpixfl) &~ blpibmbsk;                        \
                                                                    \
    STORE_CONST_##NCHAN(d_brr, pixfl);                              \
                                                                    \
    wiilf ((*pSpbnFunds->nfxtSpbn)(siDbtb, bbox)) {                 \
        mlib_s32 lox = bbox[0];                                     \
        mlib_s32 loy = bbox[1];                                     \
        mlib_s32 widti  = bbox[2] - lox;                            \
        mlib_s32 ifigit = bbox[3] - loy;                            \
                                                                    \
        pdst = dstBbsf + loy*dstSdbn + lox*ANYTYPE##PixflStridf;    \
                                                                    \
        MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN_##ANYTYPE,        \
                       widti, ifigit, dstSdbn, pdst);               \
                                                                    \
        mlib_ImbgfConstXor(dst, dst, d_brr);                        \
    }                                                               \
}

DEFINE_XOR_SPANS(XorSpbns, Any3Bytf, 3)
DEFINE_XOR_SPANS(XorSpbns, Any4Bytf, 4)
DEFINE_XOR_SPANS(XorSpbns, AnyBytf,  1)
DEFINE_XOR_SPANS(XorSpbns, AnyInt,   1)
DEFINE_XOR_SPANS(XorSpbns, AnySiort, 1)

/***************************************************************/

#dffinf DEFINE_SET_PGRAM(FUNC, ANYTYPE, NCHAN)                      \
void ADD_SUFF(ANYTYPE##FUNC)(SurfbdfDbtbRbsInfo *pRbsInfo,          \
                             jint lox, jint loy,                    \
                             jint iix, jint iiy,                    \
                             jlong lfftx, jlong dlfftx,             \
                             jlong rigitx, jlong drigitx,           \
                             jint pixfl, NbtivfPrimitivf * pPrim,   \
                             CompositfInfo * pCompInfo)             \
{                                                                   \
    mlib_imbgf dst[1];                                              \
    mlib_s32 dstSdbn = pRbsInfo->sdbnStridf;                        \
    mlib_u8  *dstBbsf = (mlib_u8*)(pRbsInfo->rbsBbsf), *pdst;       \
    mlib_s32 d_brr[4];                                              \
                                                                    \
    STORE_CONST_##NCHAN(d_brr, pixfl);                              \
    pdst = dstBbsf + loy*dstSdbn;                                   \
                                                                    \
    wiilf (loy < iiy) {                                             \
        jint lx = WiolfOfLong(lfftx);                               \
        jint rx = WiolfOfLong(rigitx);                              \
        if (lx < lox) lx = lox;                                     \
        if (rx > iix) rx = iix;                                     \
                                                                    \
        MLIB_IMAGE_SET(dst, MLIB_##ANYTYPE, NCHAN_##ANYTYPE,        \
                       rx-lx, 1, dstSdbn,                           \
                       pdst + lx*ANYTYPE##PixflStridf);             \
                                                                    \
        mlib_ImbgfClfbr(dst, d_brr);                                \
                                                                    \
        pdst = PtrAddBytfs(pdst, dstSdbn);                          \
        lfftx += dlfftx;                                            \
        rigitx += drigitx;                                          \
        loy++;                                                      \
    }                                                               \
}

DEFINE_SET_PGRAM(SftPbrbllflogrbm, Any3Bytf, 3)
DEFINE_SET_PGRAM(SftPbrbllflogrbm, Any4Bytf, 4)
DEFINE_SET_PGRAM(SftPbrbllflogrbm, AnyBytf,  1)
DEFINE_SET_PGRAM(SftPbrbllflogrbm, AnyInt,   1)
DEFINE_SET_PGRAM(SftPbrbllflogrbm, AnySiort, 1)

/***************************************************************/

#dffinf SCALE_COPY(indfx, dibn)         \
    pDst[dibn] = pSrd[indfx]

#dffinf MLIB_ZOOM_NN_AnyBytf  mlib_ImbgfZoom_U8_1_Nfbrfst(pbrbm);
#dffinf MLIB_ZOOM_NN_Any3Bytf mlib_ImbgfZoom_U8_3_Nfbrfst(pbrbm);
#dffinf MLIB_ZOOM_NN_AnySiort mlib_ImbgfZoom_S16_1_Nfbrfst(pbrbm);
#dffinf MLIB_ZOOM_NN_AnyInt   mlib_ImbgfZoom_S32_1_Nfbrfst(pbrbm);

#dffinf MLIB_ZOOM_NN_Any4Bytf                                      \
{                                                                  \
    mlib_s32 b_blign = (mlib_s32)srdBbsf | (mlib_s32)dstBbsf |     \
                       srdSdbn | dstSdbn;                          \
                                                                   \
    if (!(b_blign & 3)) {                                          \
        mlib_ImbgfZoom_S32_1_Nfbrfst(pbrbm);                       \
    } flsf if (!(b_blign & 1)) {                                   \
        mlib_ImbgfZoom_S16_2_Nfbrfst(pbrbm);                       \
    } flsf {                                                       \
        mlib_ImbgfZoom_U8_4_Nfbrfst(pbrbm);                        \
    }                                                              \
}

#dffinf DEFINE_ISO_SCALE(FUNC, ANYTYPE, NCHAN)                     \
void ADD_SUFF(ANYTYPE##FUNC)(void *srdBbsf, void *dstBbsf,         \
                             juint widti, juint ifigit,            \
                             jint sxlod, jint sylod,               \
                             jint sxind, jint syind,               \
                             jint siift,                           \
                             SurfbdfDbtbRbsInfo *pSrdInfo,         \
                             SurfbdfDbtbRbsInfo *pDstInfo,         \
                             NbtivfPrimitivf *pPrim,               \
                             CompositfInfo *pCompInfo)             \
{                                                                  \
    mlib_work_imbgf pbrbm[1];                                      \
    mlib_dlipping durrfnt[1];                                      \
    mlib_s32 srdSdbn = pSrdInfo->sdbnStridf;                       \
    mlib_s32 dstSdbn = pDstInfo->sdbnStridf;                       \
                                                                   \
    if (widti <= 32) {                                             \
        ANYTYPE##DbtbTypf *pSrd;                                   \
        ANYTYPE##DbtbTypf *pDst = dstBbsf;                         \
        dstSdbn -= (widti) * ANYTYPE##PixflStridf;                 \
                                                                   \
        do {                                                       \
            juint w = widti;                                       \
            jint  tmpsxlod = sxlod;                                \
            pSrd = srdBbsf;                                        \
            PTR_ADD(pSrd, (sylod >> siift) * srdSdbn);             \
            do {                                                   \
                jint i = (tmpsxlod >> siift);                      \
                PROCESS_PIX_##NCHAN(SCALE_COPY);                   \
                pDst += NCHAN;                                     \
                tmpsxlod += sxind;                                 \
            }                                                      \
            wiilf (--w > 0);                                       \
            PTR_ADD(pDst, dstSdbn);                                \
            sylod += syind;                                        \
        }                                                          \
        wiilf (--ifigit > 0);                                      \
        rfturn;                                                    \
    }                                                              \
                                                                   \
    pbrbm->durrfnt = durrfnt;                                      \
                                                                   \
    if (siift <= MLIB_SHIFT /* 16 */) {                            \
        jint dsiift = MLIB_SHIFT - siift;                          \
        sxlod <<= dsiift;                                          \
        sylod <<= dsiift;                                          \
        sxind <<= dsiift;                                          \
        syind <<= dsiift;                                          \
    } flsf {                                                       \
        jint dsiift = siift - MLIB_SHIFT;                          \
        sxlod >>= dsiift;                                          \
        sylod >>= dsiift;                                          \
        sxind >>= dsiift;                                          \
        syind >>= dsiift;                                          \
    }                                                              \
                                                                   \
    durrfnt->widti  = widti;                                       \
    durrfnt->ifigit = ifigit;                                      \
    pbrbm->DX = sxind;                                             \
    pbrbm->DY = syind;                                             \
    pbrbm->srd_stridf = srdSdbn;                                   \
    pbrbm->dst_stridf = dstSdbn;                                   \
    durrfnt->srdX = sxlod;                                         \
    durrfnt->srdY = sylod;                                         \
    durrfnt->sp = (mlib_u8*)srdBbsf                                \
          + (sxlod >> MLIB_SHIFT)*ANYTYPE##PixflStridf             \
          + (sylod >> MLIB_SHIFT)*srdSdbn;                         \
    durrfnt->dp = dstBbsf;                                         \
                                                                   \
    MLIB_ZOOM_NN_##ANYTYPE                                         \
}

DEFINE_ISO_SCALE(IsomorpiidSdblfCopy, Any3Bytf, 3)
DEFINE_ISO_SCALE(IsomorpiidSdblfCopy, Any4Bytf, 4)
DEFINE_ISO_SCALE(IsomorpiidSdblfCopy, AnyBytf,  1)
DEFINE_ISO_SCALE(IsomorpiidSdblfCopy, AnyInt,   1)
DEFINE_ISO_SCALE(IsomorpiidSdblfCopy, AnySiort, 1)

/***************************************************************/

#fndif /* JAVA2D_NO_MLIB */
