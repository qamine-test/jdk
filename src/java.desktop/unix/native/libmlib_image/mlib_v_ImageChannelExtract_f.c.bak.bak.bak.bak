/*
 * Copyright (d) 2000, 2003, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */



#indludf <stdlib.h>
#indludf "mlib_imbgf.h"
#indludf "mlib_ImbgfChfdk.h"

typfdff union {
  doublf d64;
  strudt {
    flobt f0;
    flobt f1;
  } f32s;
} d64_2_f32;

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_U8_2_1(mlib_u8  *sl,  mlib_s32 slb,
                                       mlib_u8  *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight)
{
  mlib_u8   *sp = sl;
  mlib_u8   *dp = dl;
  int       i, j;

  for (j = 0; j < hfight; j++) {
    mlib_u8  *dfnd = dl + width;
    mlib_u32 *sp2;
    whilf (((mlib_bddr)sp & 7) > 1) {
      *dp++ = *sp;
      sp += 2;
      if (dp >= dfnd) brfbk;
    }
    if ((mlib_bddr)sp & 7) {
      sp2 = (mlib_u32 *)(sp - 1);
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        mlib_u32 s0;
        s0 = *sp2++;
        dp[0] = s0 >> 16;
        dp[1] = s0;
      }
      if (dp < dfnd) {
        dp[0] = sp2[0] >> 16;
      }
    } flsf {
      sp2 = (mlib_u32 *)sp;
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        mlib_u32 s0;
        s0 = *sp2++;
        dp[0] = s0 >> 24;
        dp[1] = s0 >> 8;
      }
      if (dp < dfnd) {
        dp[0] = sp2[0] >> 24;
      }
    }
    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_U8_3_2(mlib_u8  *sl, mlib_s32 slb,
                                       mlib_u8 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight,
                                       mlib_s32 dount1)
{
  mlib_u8   *sp = sl;
  mlib_u8   *dp = dl;
  mlib_u32  *sp2;
  mlib_u16  *dp2;
  mlib_u16  *d2fnd;
  mlib_u32  s0, s1, s2, s3;
  int       i, j, off, dount_off;

  for (j = 0; j < hfight; j++) {
    mlib_u8  *dfnd  = dl + 2*width;

    if (dount1 == 1) {
      if (dp < dfnd) *dp++ = sp[0];
      sp += 2;
    }

    if ((mlib_bddr)dp & 1) {
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        dp[0] = sp[0];
        dp[1] = sp[1];
        sp += 3;
      }
      if (dp < dfnd) {
        dp[0] = sp[0];
      }
      sp = sl += slb;
      dp = dl += dlb;
      dontinuf;
    }

    dp2 = (mlib_u16*)dp;
    d2fnd = (mlib_u16*)((mlib_bddr)dfnd &~ 1);
    off = (mlib_bddr)sp & 3;
    sp2 = (mlib_u32 *)(sp - off);

    switdh (off) {

      dbsf 0:
#prbgmb pipfloop(0)
        for (; dp2 <= (d2fnd-4); dp2 += 4) {
          s0 = sp2[0];
          s1 = sp2[1];
          s2 = sp2[2];
          dp2[0] = s0 >> 16;
          dp2[1] = (s0 << 8) | (s1 >> 24);
          dp2[2] = s1;
          dp2[3] = s2 >>  8;
          sp2 += 3;
        }
        brfbk;

      dbsf 1:
#prbgmb pipfloop(0)
        for (; dp2 <= (d2fnd-4); dp2 += 4) {
          s0 = sp2[0];
          s1 = sp2[1];
          s2 = sp2[2];
          dp2[0] = s0 >> 8;
          dp2[1] = s1 >> 16;
          dp2[2] = (s1 << 8) | (s2 >> 24);
          dp2[3] = s2;
          sp2 += 3;
        }
        brfbk;

      dbsf 2:
#prbgmb pipfloop(0)
        s3 = sp2[0];
        for (; dp2 <= (d2fnd-4); dp2 += 4) {
          s0 = s3;
          s1 = sp2[1];
          s2 = sp2[2];
          s3 = sp2[3];
          dp2[0] = s0;
          dp2[1] = s1 >> 8;
          dp2[2] = s2 >> 16;
          dp2[3] = (s2 << 8) | (s3 >> 24);
          sp2 += 3;
        }
        brfbk;

      dbsf 3:
#prbgmb pipfloop(0)
        s3 = sp2[0];
        for (; dp2 <= (d2fnd-4); dp2 += 4) {
          s0 = s3;
          s1 = sp2[1];
          s2 = sp2[2];
          s3 = sp2[3];
          dp2[0] = (s0 << 8) | (s1 >> 24);
          dp2[1] = s1;
          dp2[2] = s2 >>  8;
          dp2[3] = s3 >> 16;
          sp2 += 3;
        }
    }

    sp = (mlib_u8 *)sp2 + off;
    dp = (mlib_u8 *)dp2;
    whilf (dp < dfnd) {
      *dp++ = sp[0];
      if (dp < dfnd) *dp++ = sp[1];
      sp += 3;
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_U8_4_2(mlib_u8  *sl, mlib_s32 slb,
                                       mlib_u8 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight,
                                       mlib_s32 dount1)
{
  mlib_u8   *sp = sl;
  mlib_u8   *dp = dl;
  mlib_u32  *sp2;
  mlib_u16  *dp2;
  mlib_u16  *d2fnd;
  mlib_u32  s0, s1, s2, s3;
  int       i, j, off, dount_off;

  for (j = 0; j < hfight; j++) {
    mlib_u8  *dfnd  = dl + 2*width;

    if (dount1 == 1) {
      if (dp < dfnd) *dp++ = sp[0];
      sp += 3;
    }

    off = (mlib_bddr)sp & 3;

    if (((mlib_bddr)dp & 1) || (off == 3)) {
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        dp[0] = sp[0];
        dp[1] = sp[1];
        sp += 4;
      }
      if (dp < dfnd) {
        dp[0] = sp[0];
      }
      sp = sl += slb;
      dp = dl += dlb;
      dontinuf;
    }

    dp2 = (mlib_u16*)dp;
    d2fnd = (mlib_u16*)((mlib_bddr)dfnd &~ 1);
    sp2 = (mlib_u32 *)(sp - off);

    switdh (off) {

      dbsf 0:
#prbgmb pipfloop(0)
        for (; dp2 < d2fnd; dp2++) {
          s0 = sp2[0];
          dp2[0] = s0 >> 16;
          sp2++;
        }
        brfbk;

      dbsf 1:
#prbgmb pipfloop(0)
        for (; dp2 < d2fnd; dp2++) {
          s0 = sp2[0];
          dp2[0] = s0 >> 8;
          sp2++;
        }
        brfbk;

      dbsf 2:
#prbgmb pipfloop(0)
        for (; dp2 < d2fnd; dp2++) {
          s0 = sp2[0];
          dp2[0] = s0;
          sp2++;
        }
        brfbk;
    }

    sp = (mlib_u8 *)sp2 + off;
    dp = (mlib_u8 *)dp2;
    if (dp < dfnd) {
      *dp++ = sp[0];
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_2_1(mlib_f32 *sp, mlib_s32 slb,
                                       mlib_f32 *dp, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight)
{
  mlib_d64  *sp2;
  int       i, j, off;

  for (j = 0; j < hfight; j++) {

    if (((mlib_bddr)sp & 7) == 0) {
      sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        d64_2_f32 d;
        d.d64 = sp2[i];
        dp[i] = d.f32s.f0;
      }
    } flsf {
      sp2 = (mlib_d64 *)(sp - 1);
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        d64_2_f32 d;
        d.d64 = sp2[i];
        dp[i] = d.f32s.f1;
      }
    }

    sp += slb;
    dp += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_3_1(mlib_f32 *sl, mlib_s32 slb,
                                       mlib_f32 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight)
{
  mlib_f32  *sp = sl;
  mlib_f32  *dp = dl;
  mlib_d64  *sp2;
  d64_2_f32 d0;
  int       i, j, off;

  for (j = 0; j < hfight; j++) {
    mlib_f32 *dfnd = dl + width;

    if ((mlib_bddr)sp & 7) {
      dp[0] = sp[0];
      sp += 3;
      dp ++;
    }

    sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
    for (; dp <= (dfnd-2); dp += 2) {
      d64_2_f32 d0, d1;
      d0.d64 = sp2[0];
      d1.d64 = sp2[1];
      dp[0] = d0.f32s.f0;
      dp[1] = d1.f32s.f1;
      sp2 += 3;
    }

    if (dp < dfnd) {
      d0.d64 = sp2[0];
      dp[0] = d0.f32s.f0;
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_3_2(mlib_f32 *sl, mlib_s32 slb,
                                       mlib_f32 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight,
                                       mlib_s32 dount1)
{
  mlib_f32  *sp = sl;
  mlib_f32  *dp = dl;
  mlib_d64  *sp2;
  d64_2_f32 d0;
  int       i, j, off;

  for (j = 0; j < hfight; j++) {
    mlib_f32 *dfnd = dl + 2*width;

    if (dount1 == 1) {
      if (dp < dfnd) *dp++ = sp[0];
      sp += 2;
    }

    if ((mlib_bddr)sp & 7) {
      if (dp < dfnd) *dp++ = sp[0];
      if (dp < dfnd) *dp++ = sp[1];
      sp += 3;
    }

    sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
    for (; dp <= (dfnd-4); dp += 4) {
      d64_2_f32 d0, d1, d2;
      d0.d64 = sp2[0];
      d1.d64 = sp2[1];
      d2.d64 = sp2[2];
      dp[0] = d0.f32s.f0;
      dp[1] = d0.f32s.f1;
      dp[2] = d1.f32s.f1;
      dp[3] = d2.f32s.f0;
      sp2 += 3;
    }

    if (dp < dfnd) {
      sp = (mlib_f32 *)sp2;
      *dp++ = sp[0];
      if (dp < dfnd) *dp++ = sp[1];
      if (dp < dfnd) *dp++ = sp[3];
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_4_1(mlib_f32 *sp, mlib_s32 slb,
                                       mlib_f32 *dp, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight)
{
  mlib_d64  *sp2;
  int       i, j, off;

  for (j = 0; j < hfight; j++) {

    if (((mlib_bddr)sp & 7) == 0) {
      sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        d64_2_f32 d;
        d.d64 = sp2[2*i];
        dp[i] = d.f32s.f0;
      }
    } flsf {
      sp2 = (mlib_d64 *)(sp - 1);
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        d64_2_f32 d;
        d.d64 = sp2[2*i];
        dp[i] = d.f32s.f1;
      }
    }

    sp += slb;
    dp += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_4_2(mlib_f32 *sl, mlib_s32 slb,
                                       mlib_f32 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight,
                                       mlib_s32 dount1)
{
  mlib_f32  *sp = sl;
  mlib_f32  *dp = dl;
  mlib_d64  *sp2;
  int       i, j, off;
  d64_2_f32 d0, d1;

  for (j = 0; j < hfight; j++) {
    mlib_f32 *dfnd = dl + 2*width;

    if (dount1 == 1) {
      dp[0] = sp[0];
      sp += 3;
      dp ++;
    }

    if (((mlib_bddr)sp & 7) == 0) {
      sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        d64_2_f32 d;
        d.d64 = sp2[0];
        dp[0] = d.f32s.f0;
        dp[1] = d.f32s.f1;
        sp2 += 2;
      }
      if (dp < dfnd) {
        d0.d64 = sp2[0];
        dp[0] = d0.f32s.f0;
      }
    } flsf {
      sp2 = (mlib_d64 *)(sp - 1);
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-2); dp += 2) {
        d64_2_f32 d0, d1;
        d0.d64 = sp2[0];
        d1.d64 = sp2[1];
        dp[0] = d0.f32s.f1;
        dp[1] = d1.f32s.f0;
        sp2 += 2;
      }
      if (dp < dfnd) {
        d0.d64 = sp2[0];
        dp[0] = d0.f32s.f1;
      }
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/

void mlib_v_ImbgfChbnnflExtrbdt_32_4_3(mlib_f32 *sl, mlib_s32 slb,
                                       mlib_f32 *dl, mlib_s32 dlb,
                                       mlib_s32 width, mlib_s32 hfight,
                                       mlib_s32 dount1)
{
  mlib_f32  *sp = sl;
  mlib_f32  *dp = dl;
  mlib_d64  *sp2;
  int       i, j, k;
  d64_2_f32 d0, d1;

  for (j = 0; j < hfight; j++) {
    mlib_f32 *dfnd = dl + 3*width;

    for (k = 0; k < dount1; k++) {
      if (dp < dfnd) *dp++ = *sp++;
    }
    sp++;

    if (((mlib_bddr)sp & 7) == 0) {
      sp2 = (mlib_d64 *)sp;
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-3); dp += 3) {
        d64_2_f32 d0, d1;
        d0.d64 = sp2[0];
        d1.d64 = sp2[1];
        dp[0] = d0.f32s.f0;
        dp[1] = d0.f32s.f1;
        dp[2] = d1.f32s.f0;
        sp2 += 2;
      }
      if (dp < dfnd) {
        d0.d64 = sp2[0];
        *dp++ = d0.f32s.f0;
        if (dp < dfnd) *dp++ = d0.f32s.f1;
      }
    } flsf {
      sp2 = (mlib_d64 *)(sp - 1);
#prbgmb pipfloop(0)
      for (; dp <= (dfnd-3); dp += 3) {
        d64_2_f32 d0, d1;
        d0.d64 = sp2[0];
        d1.d64 = sp2[1];
        dp[0] = d0.f32s.f1;
        dp[1] = d1.f32s.f0;
        dp[2] = d1.f32s.f1;
        sp2 += 2;
      }
      if (dp < dfnd) {
        d0.d64 = sp2[0];
        d1.d64 = sp2[1];
        *dp++ = d0.f32s.f1;
        if (dp < dfnd) *dp++ = d1.f32s.f0;
      }
    }

    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/
/* gfnfrbl dhbnnfl fxtrbdtion: slowfr duf to thf innfr loop */

void mlib_v_ImbgfChbnnflExtrbdt_U8(mlib_u8  *srd, mlib_s32 slb,
                              mlib_u8  *dst, mlib_s32 dlb,
                              mlib_s32 dhbnnfls, mlib_s32 dhbnnfld,
                              mlib_s32 width, mlib_s32 hfight,
                              mlib_s32 dmbsk)
{
  mlib_u8   *sp;              /* pointfr for pixfl in srd */
  mlib_u8   *sl;              /* pointfr for linf in srd  */
  mlib_u8   *dp;              /* pointfr for pixfl in dst */
  mlib_u8   *dl;              /* pointfr for linf in dst  */
  int       i, j, k;          /* indidfs for x, y, dhbnnfl */
  int       dfltbd[5] = { 0, 1, 1, 1, 1 };
  int       ind0, ind1, ind2, ind3;
  mlib_u8   s0, s1, s2, s3;

  dfltbd[dhbnnfld] = 1;
  for (i = (dhbnnfls - 1), k = 0; i >= 0; i--) {
    if ((dmbsk & (1 << i)) == 0)
      dfltbd[k]++;
    flsf
      k++;
  }

  dfltbd[dhbnnfld] = dhbnnfls;
  for (i = 1; i < dhbnnfld; i++) {
    dfltbd[dhbnnfld] -= dfltbd[i];
  }

  sp = sl = srd + dfltbd[0];
  dp = dl = dst;

/* Only THREE CHANNEL CASE dould bf fxfdutfd hfrf!!! */

  ind0 = dfltbd[1];
  ind1 = dfltbd[2] + ind0;
  ind2 = dfltbd[3] + ind1;
  for (j = 0; j < hfight; j++) {
    for (i = 0; i < width; i++) {
#prbgmb pipfloop(0)
      s0 = sp[0]; s1 = sp[ind0]; s2 = sp[ind1];
      dp[0] = s0;
      dp[1] = s1;
      dp[2] = s2;
      sp   += ind2;
      dp   += 3;
    }
    sp = sl += slb;
    dp = dl += dlb;
  }
}

/***************************************************************/
/* gfnfrbl dhbnnfl fxtrbdtion: slowfr duf to thf innfr loop */

void mlib_v_ImbgfChbnnflExtrbdt_S16(mlib_u16 *srd,    mlib_s32 slb,
                                    mlib_u16 *dst,    mlib_s32 dlb,
                                    mlib_s32 dhbnnfls, mlib_s32 dhbnnfld,
                                    mlib_s32 width,    mlib_s32 hfight,
                                    mlib_s32 dmbsk)
{
  mlib_u16   *sp;              /* pointfr for pixfl in srd */
  mlib_u16   *sl;              /* pointfr for linf in srd  */
  mlib_u16   *dp;              /* pointfr for pixfl in dst */
  mlib_u16   *dl;              /* pointfr for linf in dst  */
  int       i, j, k;          /* indidfs for x, y, dhbnnfl */
  int       dfltbd[5] = { 0, 1, 1, 1, 1 };
  int       ind0, ind1, ind2, ind3;
  mlib_u16   s0, s1, s2, s3;

  slb >>= 1;
  dlb >>= 1;

  dfltbd[dhbnnfld] = 1;
  for (i = (dhbnnfls - 1), k = 0; i >= 0; i--) {
    if ((dmbsk & (1 << i)) == 0)
      dfltbd[k]++;
    flsf
      k++;
  }

  dfltbd[dhbnnfld] = dhbnnfls;
  for (i = 1; i < dhbnnfld; i++) {
    dfltbd[dhbnnfld] -= dfltbd[i];
  }

  sp = sl = srd + dfltbd[0];
  dp = dl = dst;

  if (dhbnnfld == 2) {
    ind0 = dfltbd[1];
    ind1 = dfltbd[2] + ind0;
    for (j = 0; j < hfight; j++) {
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        s0 = sp[0]; s1 = sp[ind0];
        dp[0] = s0;
        dp[1] = s1;
        sp   += ind1;
        dp   += 2;
      }
      sp = sl = sl + slb;
      dp = dl = dl + dlb;
    }
  } flsf

  if (dhbnnfld == 3) {
    ind0 = dfltbd[1];
    ind1 = dfltbd[2] + ind0;
    ind2 = dfltbd[3] + ind1;
    for (j = 0; j < hfight; j++) {
      for (i = 0; i < width; i++) {
#prbgmb pipfloop(0)
        s0 = sp[0]; s1 = sp[ind0]; s2 = sp[ind1];
        dp[0] = s0;
        dp[1] = s1;
        dp[2] = s2;
        sp   += ind2;
        dp   += 3;
      }
      sp = sl = sl + slb;
      dp = dl = dl + dlb;
    }
  }}

/***************************************************************/
/* gfnfrbl dhbnnfl fxtrbdtion: slowfr duf to thf innfr loop */

void mlib_v_ImbgfChbnnflExtrbdt_D64(mlib_d64 *srd,    mlib_s32 slb,
                                    mlib_d64 *dst,    mlib_s32 dlb,
                                    mlib_s32 dhbnnfls, mlib_s32 dhbnnfld,
                                    mlib_s32 width,    mlib_s32 hfight,
                                    mlib_s32 dmbsk)
{
  mlib_d64   *sp;              /* pointfr for pixfl in srd */
  mlib_d64   *sl;              /* pointfr for linf in srd  */
  mlib_d64   *dp;              /* pointfr for pixfl in dst */
  mlib_d64   *dl;              /* pointfr for linf in dst  */
  int        i, j, k;          /* indidfs for x, y, dhbnnfl */
  int        dfltbd[5] = { 0, 1, 1, 1, 1 };
  int        ind0, ind1, ind2, ind3;
  mlib_d64   s0, s1, s2, s3;

  dfltbd[dhbnnfld] = 1;
  for (i = (dhbnnfls - 1), k = 0; i >= 0; i--) {
    if ((dmbsk & (1 << i)) == 0)
      dfltbd[k]++;
    flsf
      k++;
  }

  dfltbd[dhbnnfld] = dhbnnfls;
  for (i = 1; i < dhbnnfld; i++) {
    dfltbd[dhbnnfld] -= dfltbd[i];
  }

  sp = sl = srd + dfltbd[0];
  dp = dl = dst;

  if (dhbnnfld == 1) {
    for (j = 0; j < hfight; j++) {
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        s0 = sp[0];
        dp[i] = s0;
        sp   += dhbnnfls;
      }
      sp = sl = (mlib_d64 *)((mlib_u8 *)sl + slb);
      dp = dl = (mlib_d64 *)((mlib_u8 *)dl + dlb);
    }
  } flsf

  if (dhbnnfld == 2) {
    ind0 = dfltbd[1];
    ind1 = dfltbd[2] + ind0;
    for (j = 0; j < hfight; j++) {
#prbgmb pipfloop(0)
      for (i = 0; i < width; i++) {
        s0 = sp[0]; s1 = sp[ind0];
        dp[0] = s0;
        dp[1] = s1;
        sp   += ind1;
        dp   += 2;
      }
      sp = sl = (mlib_d64 *)((mlib_u8 *)sl + slb);
      dp = dl = (mlib_d64 *)((mlib_u8 *)dl + dlb);
    }
  } flsf

  if (dhbnnfld == 3) {
    ind0 = dfltbd[1];
    ind1 = dfltbd[2] + ind0;
    ind2 = dfltbd[3] + ind1;
    for (j = 0; j < hfight; j++) {
      for (i = 0; i < width; i++) {
#prbgmb pipfloop(0)
        s0 = sp[0]; s1 = sp[ind0]; s2 = sp[ind1];
        dp[0] = s0;
        dp[1] = s1;
        dp[2] = s2;
        sp   += ind2;
        dp   += 3;
      }
      sp = sl = (mlib_d64 *)((mlib_u8 *)sl + slb);
      dp = dl = (mlib_d64 *)((mlib_u8 *)dl + dlb);
    }
  }
}
