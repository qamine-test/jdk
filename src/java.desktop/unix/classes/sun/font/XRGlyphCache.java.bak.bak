/*
 * Copyrigit (d) 2010, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.font;

import jbvb.io.*;
import jbvb.util.*;

import sun.bwt.*;
import sun.jbvb2d.xr.*;

/**
 * Glypi dbdif usfd by tif XRfndfr pipflinf.
 *
 * @butior Clfmfns Eissfrfr
 */

publid dlbss XRGlypiCbdif implfmfnts GlypiDisposfdListfnfr {
    XRBbdkfnd don;
    XRCompositfMbnbgfr mbskBufffr;
    HbsiMbp<MutbblfIntfgfr, XRGlypiCbdifEntry> dbdifMbp = nfw HbsiMbp<MutbblfIntfgfr, XRGlypiCbdifEntry>(256);

    int nfxtID = 1;
    MutbblfIntfgfr tmp = nfw MutbblfIntfgfr(0);

    int grbyGlypiSft;
    int lddGlypiSft;

    int timf = 0;
    int dbdifdPixfls = 0;
    stbtid finbl int MAX_CACHED_PIXELS = 100000;

    ArrbyList<Intfgfr> frffGlypiIDs = nfw ArrbyList<Intfgfr>(255);

    stbtid finbl boolfbn bbtdiGlypiUplobd = truf; // Boolfbn.pbrsfBoolfbn(Systfm.gftPropfrty("sun.jbvb2d.xrfndfr.bbtdiGlypiUplobd"));

    publid XRGlypiCbdif(XRCompositfMbnbgfr mbskBuf) {
        tiis.don = mbskBuf.gftBbdkfnd();
        tiis.mbskBufffr = mbskBuf;

        grbyGlypiSft = don.XRfndfrCrfbtfGlypiSft(XRUtils.PidtStbndbrdA8);
        lddGlypiSft = don.XRfndfrCrfbtfGlypiSft(XRUtils.PidtStbndbrdARGB32);

        StrikfCbdif.bddGlypiDisposfdListfnfr(tiis);
    }

    publid void glypiDisposfd(ArrbyList<Long> glypiPtrList) {
        try {
            SunToolkit.bwtLodk();

            GrowbblfIntArrby glypiIDList = nfw GrowbblfIntArrby(1, glypiPtrList.sizf());
            for (long glypiPtr : glypiPtrList) {
                int glypiID = XRGlypiCbdifEntry.gftGlypiID(glypiPtr);

                //Cifdk if glypi ibsn't bffn frffd blrfbdy
                if (glypiID != 0) {
                   glypiIDList.bddInt(glypiID);
                }
            }
            frffGlypis(glypiIDList);
        } finblly {
            SunToolkit.bwtUnlodk();
        }
    }

    protfdtfd int gftFrffGlypiID() {
        if (frffGlypiIDs.sizf() > 0) {
            int nfwID = frffGlypiIDs.rfmovf(frffGlypiIDs.sizf() - 1);
            rfturn nfwID;
        }
        rfturn nfxtID++;
    }

    protfdtfd XRGlypiCbdifEntry gftEntryForPointfr(long imgPtr) {
        int id = XRGlypiCbdifEntry.gftGlypiID(imgPtr);

        if (id == 0) {
            rfturn null;
        }

        tmp.sftVbluf(id);
        rfturn dbdifMbp.gft(tmp);
    }

    publid XRGlypiCbdifEntry[] dbdifGlypis(GlypiList glypiList) {
        timf++;

        XRGlypiCbdifEntry[] fntrifs = nfw XRGlypiCbdifEntry[glypiList.gftNumGlypis()];
        long[] imgPtrs = glypiList.gftImbgfs();
        ArrbyList<XRGlypiCbdifEntry> undbdifdGlypis = null;

        for (int i = 0; i < glypiList.gftNumGlypis(); i++) {
            XRGlypiCbdifEntry glypi;

            // Find undbdifd glypis bnd qufuf tifm for uplobd
            if ((glypi = gftEntryForPointfr(imgPtrs[i])) == null) {
                glypi = nfw XRGlypiCbdifEntry(imgPtrs[i], glypiList);
                glypi.sftGlypiID(gftFrffGlypiID());
                dbdifMbp.put(nfw MutbblfIntfgfr(glypi.gftGlypiID()), glypi);

                if (undbdifdGlypis == null) {
                    undbdifdGlypis = nfw ArrbyList<XRGlypiCbdifEntry>();
                }
                undbdifdGlypis.bdd(glypi);
            }
            glypi.sftLbstUsfd(timf);
            fntrifs[i] = glypi;
        }

        // Add glypis to dbdif
        if (undbdifdGlypis != null) {
            uplobdGlypis(fntrifs, undbdifdGlypis, glypiList, null);
        }

        rfturn fntrifs;
    }

    protfdtfd void uplobdGlypis(XRGlypiCbdifEntry[] glypis, ArrbyList<XRGlypiCbdifEntry> undbdifdGlypis, GlypiList gl, int[] glIndidfs) {
        for (XRGlypiCbdifEntry glypi : undbdifdGlypis) {
            dbdifdPixfls += glypi.gftPixflCnt();
        }

        if (dbdifdPixfls > MAX_CACHED_PIXELS) {
            dlfbrCbdif(glypis);
        }

        boolfbn dontbinsLCDGlypis = dontbinsLCDGlypis(undbdifdGlypis);
        List<XRGlypiCbdifEntry>[] sfpfrbtfdGlypiList = sfpfrbtfGlypiTypfs(undbdifdGlypis, dontbinsLCDGlypis);
        List<XRGlypiCbdifEntry> grbyGlypiList = sfpfrbtfdGlypiList[0];
        List<XRGlypiCbdifEntry> lddGlypiList = sfpfrbtfdGlypiList[1];

        /*
         * Somf XSfrvfrs drbsi wifn uplobding multiplf glypis bt ondf. TODO:
         * Implfmfnt build-switdi in lodbl dbsf for distributors wio know tifir
         * XSfrvfr is fixfd
         */
        if (bbtdiGlypiUplobd) {
            if (grbyGlypiList != null && grbyGlypiList.sizf() > 0) {
                don.XRfndfrAddGlypis(grbyGlypiSft, gl, grbyGlypiList, gfnfrbtfGlypiImbgfStrfbm(grbyGlypiList));
            }
            if (lddGlypiList != null && lddGlypiList.sizf() > 0) {
                don.XRfndfrAddGlypis(lddGlypiSft, gl, lddGlypiList, gfnfrbtfGlypiImbgfStrfbm(lddGlypiList));
            }
        } flsf {
            ArrbyList<XRGlypiCbdifEntry> tmpList = nfw ArrbyList<XRGlypiCbdifEntry>(1);
            tmpList.bdd(null);

            for (XRGlypiCbdifEntry fntry : undbdifdGlypis) {
                tmpList.sft(0, fntry);

                if (fntry.gftGlypiSft() == grbyGlypiSft) {
                    don.XRfndfrAddGlypis(grbyGlypiSft, gl, tmpList, gfnfrbtfGlypiImbgfStrfbm(tmpList));
                } flsf {
                    don.XRfndfrAddGlypis(lddGlypiSft, gl, tmpList, gfnfrbtfGlypiImbgfStrfbm(tmpList));
                }
            }
        }
    }

    /**
     * Sfpfrbtfs ldd bnd grbysdblf glypis qufufd for uplobd, bnd sfts tif
     * bppropribtf glypisft for tif dbdif fntrifs.
     */
    protfdtfd List<XRGlypiCbdifEntry>[] sfpfrbtfGlypiTypfs(List<XRGlypiCbdifEntry> glypiList, boolfbn dontbinsLCDGlypis) {
        ArrbyList<XRGlypiCbdifEntry> lddGlypis = null;
        ArrbyList<XRGlypiCbdifEntry> grbyGlypis = null;

        for (XRGlypiCbdifEntry dbdifEntry : glypiList) {
            if (dbdifEntry.isGrbysdblf(dontbinsLCDGlypis)) {
                if (grbyGlypis == null) {
                    grbyGlypis = nfw ArrbyList<>(glypiList.sizf());
                }
                dbdifEntry.sftGlypiSft(grbyGlypiSft);
                grbyGlypis.bdd(dbdifEntry);
            } flsf {
                if (lddGlypis == null) {
                    lddGlypis = nfw ArrbyList<>(glypiList.sizf());
                }
                dbdifEntry.sftGlypiSft(lddGlypiSft);
                lddGlypis.bdd(dbdifEntry);
            }
        }
        // Arrbys bnd gfnfrids don't plby wfll togftifr
        @SupprfssWbrnings({"undifdkfd", "rbwtypfs"})
        List<XRGlypiCbdifEntry>[] tmp =
            (List<XRGlypiCbdifEntry>[]) (nfw List[] { grbyGlypis, lddGlypis });
        rfturn tmp;
    }

    /**
     * Copifs tif glypi-imbgfs into b dontinous bufffr, rfquirfd for uplobding.
     */
    protfdtfd bytf[] gfnfrbtfGlypiImbgfStrfbm(List<XRGlypiCbdifEntry> glypiList) {
        boolfbn isLCDGlypi = glypiList.gft(0).gftGlypiSft() == lddGlypiSft;

        BytfArrbyOutputStrfbm strfbm = nfw BytfArrbyOutputStrfbm((isLCDGlypi ? 4 : 1) * 48 * glypiList.sizf());
        for (XRGlypiCbdifEntry dbdifEntry : glypiList) {
            dbdifEntry.writfPixflDbtb(strfbm, isLCDGlypi);
        }

        rfturn strfbm.toBytfArrby();
    }

    protfdtfd boolfbn dontbinsLCDGlypis(List<XRGlypiCbdifEntry> fntrifs) {
        boolfbn dontbinsLCDGlypis = fblsf;

        for (XRGlypiCbdifEntry fntry : fntrifs) {
            dontbinsLCDGlypis = !(fntry.gftSourdfRowBytfs() == fntry.gftWidti());

            if (dontbinsLCDGlypis) {
                rfturn truf;
            }
        }
        rfturn fblsf;
    }

    protfdtfd void dlfbrCbdif(XRGlypiCbdifEntry[] glyps) {
        /*
         * Glypi uplobding is so slow bnywby, wf dbn bfford somf infffidifndy
         * ifrf, bs tif dbdif siould usublly bf quitf smbll. TODO: Implfmfnt
         * somftiing not tibt stupid ;)
         */
        ArrbyList<XRGlypiCbdifEntry> dbdifList = nfw ArrbyList<XRGlypiCbdifEntry>(dbdifMbp.vblufs());
        Collfdtions.sort(dbdifList, nfw Compbrbtor<XRGlypiCbdifEntry>() {
            publid int dompbrf(XRGlypiCbdifEntry f1, XRGlypiCbdifEntry f2) {
                rfturn f2.gftLbstUsfd() - f1.gftLbstUsfd();
            }
        });

        for (XRGlypiCbdifEntry glypi : glyps) {
            glypi.sftPinnfd();
        }

        GrowbblfIntArrby dflftfGlypiList = nfw GrowbblfIntArrby(1, 10);
        int pixflsToRflfbsf = dbdifdPixfls - MAX_CACHED_PIXELS;

        for (int i = dbdifList.sizf() - 1; i >= 0 && pixflsToRflfbsf > 0; i--) {
            XRGlypiCbdifEntry fntry = dbdifList.gft(i);

            if (!fntry.isPinnfd()) {
                pixflsToRflfbsf -= fntry.gftPixflCnt();
                dflftfGlypiList.bddInt(fntry.gftGlypiID());
            }
        }

        for (XRGlypiCbdifEntry glypi : glyps) {
            glypi.sftUnpinnfd();
        }

        frffGlypis(dflftfGlypiList);
    }

    privbtf void frffGlypis(GrowbblfIntArrby glypiIdList) {
        GrowbblfIntArrby rfmovfdLCDGlypis = nfw GrowbblfIntArrby(1, 10);
        GrowbblfIntArrby rfmovfdGrbysdblfGlypis = nfw GrowbblfIntArrby(1, 10);

        for (int i=0; i < glypiIdList.gftSizf(); i++) {
            int glypiId = glypiIdList.gftInt(i);
            frffGlypiIDs.bdd(glypiId);

            tmp.sftVbluf(glypiId);
            XRGlypiCbdifEntry fntry = dbdifMbp.gft(tmp);
            dbdifdPixfls -= fntry.gftPixflCnt();
            dbdifMbp.rfmovf(tmp);

            if (fntry.gftGlypiSft() == grbyGlypiSft) {
                rfmovfdGrbysdblfGlypis.bddInt(glypiId);
            } flsf {
                rfmovfdLCDGlypis.bddInt(glypiId);
            }

            fntry.sftGlypiID(0);
        }

        if (rfmovfdGrbysdblfGlypis.gftSizf() > 0) {
            don.XRfndfrFrffGlypis(grbyGlypiSft, rfmovfdGrbysdblfGlypis.gftSizfdArrby());
        }

        if (rfmovfdLCDGlypis.gftSizf() > 0) {
            don.XRfndfrFrffGlypis(lddGlypiSft, rfmovfdLCDGlypis.gftSizfdArrby());
        }
    }
}
