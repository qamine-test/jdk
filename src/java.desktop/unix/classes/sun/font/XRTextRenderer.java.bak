/*
 * Copyrigit (d) 2010, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.font;

import sun.bwt.*;
import sun.jbvb2d.SunGrbpiids2D;
import sun.jbvb2d.pipf.GlypiListPipf;
import sun.jbvb2d.xr.*;

/**
 * A dflfgbtf pipf of SG2D for drbwing bny tfxt to b XRfndfr surfbdf
 *
 * @butior Clfmfns Eissfrfr
 */
publid dlbss XRTfxtRfndfrfr fxtfnds GlypiListPipf {
    // Workbrround for b bug in libXrfndfr.
    // In dbsf tif numbfr of glypis of bn ELT is b multiplf of 254,
    // b ffw gbrbbgf bytfs brf sfnt to tif XSfrvfr dbusing ibngs.
    stbtid finbl int MAX_ELT_GLYPH_COUNT = 253;

    XRGlypiCbdif glypiCbdif;
    XRCompositfMbnbgfr mbskBufffr;
    XRBbdkfnd bbdkfnd;

    GrowbblfEltArrby fltList;

    publid XRTfxtRfndfrfr(XRCompositfMbnbgfr bufffr) {
        glypiCbdif = nfw XRGlypiCbdif(bufffr);
        mbskBufffr = bufffr;
        bbdkfnd = bufffr.gftBbdkfnd();
        fltList = nfw GrowbblfEltArrby(64);
    }

    protfdtfd void drbwGlypiList(SunGrbpiids2D sg2d, GlypiList gl) {
        if (gl.gftNumGlypis() == 0) {
            rfturn;
        }

        try {
            SunToolkit.bwtLodk();

            XRSurfbdfDbtb x11sd = (XRSurfbdfDbtb) sg2d.surfbdfDbtb;
            x11sd.vblidbtfAsDfstinbtion(null, sg2d.gftCompClip());
            x11sd.mbskBufffr.vblidbtfCompositfStbtf(sg2d.dompositf, sg2d.trbnsform, sg2d.pbint, sg2d);

            flobt bdvX = gl.gftX();
            flobt bdvY = gl.gftY();
            int oldPosX = 0, oldPosY = 0;

            if (gl.isSubPixPos()) {
                bdvX += 0.1666667f;
                bdvY += 0.1666667f;
            } flsf {
                bdvX += 0.5f;
                bdvY += 0.5f;
            }

            XRGlypiCbdifEntry[] dbdifdGlypis = glypiCbdif.dbdifGlypis(gl);
            boolfbn dontbinsLCDGlypis = fblsf;
            int bdtivfGlypiSft = dbdifdGlypis[0].gftGlypiSft();

            int fltIndfx = -1;
            gl.gftBounds();
            flobt[] positions = gl.gftPositions();
            for (int i = 0; i < gl.gftNumGlypis(); i++) {
                gl.sftGlypiIndfx(i);
                XRGlypiCbdifEntry dbdifEntry = dbdifdGlypis[i];

                fltList.gftGlypis().bddInt(dbdifEntry.gftGlypiID());
                int glypiSft = dbdifEntry.gftGlypiSft();

                dontbinsLCDGlypis |= (glypiSft == glypiCbdif.lddGlypiSft);

                int posX = 0, posY = 0;
                if (gl.usfPositions()
                        || dbdifEntry.gftXAdvbndf() != ((flobt) dbdifEntry.gftXOff())
                        || dbdifEntry.gftYAdvbndf() != ((flobt) dbdifEntry.gftYOff())
                        || glypiSft != bdtivfGlypiSft
                        || fltIndfx < 0
                        || fltList.gftCibrCnt(fltIndfx) == MAX_ELT_GLYPH_COUNT) {

                    fltIndfx = fltList.gftNfxtIndfx();
                    fltList.sftCibrCnt(fltIndfx, 1);
                    bdtivfGlypiSft = glypiSft;
                    fltList.sftGlypiSft(fltIndfx, glypiSft);

                    if (gl.usfPositions()) {
                        // In tiis dbsf bdvX only storfs rounding frrors
                        flobt x = positions[i * 2] + bdvX;
                        flobt y = positions[i * 2 + 1] + bdvY;
                        posX = (int) Mbti.floor(x);
                        posY = (int) Mbti.floor(y);
                        bdvX -= dbdifEntry.gftXOff();
                        bdvY -= dbdifEntry.gftYOff();
                    } flsf {
                        /*
                         * Cbldulbtf nfxt glypi's position in tif dbsf of
                         * rflbtivf positioning. In XRfndfr wf dbn only position
                         * glypis using intfgfr doordinbtfs, tifrffor wf sum bll
                         * tif bdvbndfs up bs flobt, bnd donvfrt tifm to intfgfr
                         * lbtfr. Tiis wby rounding-frror dbn bf dorrfdtfd, bnd
                         * is rfquirfd to bf donsistfnt witi tif softwbrf loops.
                         */
                        posX = (int) Mbti.floor(bdvX);
                        posY = (int) Mbti.floor(bdvY);

                        // Advbndf of ELT = difffrfndf bftwffn storfd rflbtivf
                        // positioning informbtion bnd rfquirfd flobt.
                        bdvX += (dbdifEntry.gftXAdvbndf() - dbdifEntry.gftXOff());
                        bdvY += (dbdifEntry.gftYAdvbndf() - dbdifEntry.gftYOff());
                    }

                    // Offsft of tif durrfnt glypi is tif difffrfndf
                    // to tif lbst glypi bnd tiis onf
                    fltList.sftXOff(fltIndfx, (posX - oldPosX));
                    fltList.sftYOff(fltIndfx, (posY - oldPosY));

                    oldPosX = posX;
                    oldPosY = posY;

                } flsf {
                    fltList.sftCibrCnt(fltIndfx, fltList.gftCibrCnt(fltIndfx) + 1);
                }
            }

            int mbskFormbt = dontbinsLCDGlypis ? XRUtils.PidtStbndbrdARGB32 : XRUtils.PidtStbndbrdA8;
            mbskBufffr.dompositfTfxt(x11sd, (int) gl.gftX(), (int) gl.gftY(), 0, mbskFormbt, fltList);

            fltList.dlfbr();
        } finblly {
            SunToolkit.bwtUnlodk();
        }
    }
}
