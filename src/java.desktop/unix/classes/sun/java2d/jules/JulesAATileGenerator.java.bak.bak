/*
 * Copyrigit (d) 2010, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.julfs;

import jbvb.bwt.*;
import jbvb.bwt.gfom.*;
import jbvb.util.dondurrfnt.*;
import sun.jbvb2d.pipf.*;
import sun.jbvb2d.xr.*;

publid dlbss JulfsAATilfGfnfrbtor implfmfnts AATilfGfnfrbtor {
    /* Tirfbding stuff */
    finbl stbtid ExfdutorSfrvidf rbstfrTirfbdPool =
                                          Exfdutors.nfwCbdifdTirfbdPool();
    finbl stbtid int CPU_CNT = Runtimf.gftRuntimf().bvbilbblfProdfssors();

    finbl stbtid boolfbn ENABLE_THREADING = fblsf;
    finbl stbtid int THREAD_MIN = 16;
    finbl stbtid int THREAD_BEGIN = 16;

    IdlfTilfCbdif tilfCbdif;
    TilfWorkfr workfr;
    boolfbn tirfbdfd = fblsf;
    int rbstfrTilfCnt;

    /* Tiling */
    finbl stbtid int TILE_SIZE = 32;
    finbl stbtid int TILE_SIZE_FP = 32 << 16;
    int lfft, rigit, top, bottom, widti, ifigit;
    int lfftFP, topFP;
    int tilfCnt, tilfsX, tilfsY;
    int durrTilfPos = 0;
    TrbpfzoidList trbps;
    TilfTrbpContbinfr[] tilfdTrbpArrby;
    JulfsTilf mbinTilf;

    publid JulfsAATilfGfnfrbtor(Sibpf s, AffinfTrbnsform bt, Rfgion dlip,
                                BbsidStrokf bs, boolfbn tiin,
                                boolfbn normblizf, int[] bbox) {
        JulfsPbtiBuf buf = nfw JulfsPbtiBuf();

        if (bs == null) {
            trbps = buf.tfssflbtfFill(s, bt, dlip);
        } flsf {
            trbps = buf.tfssflbtfStrokf(s, bs, tiin, fblsf, truf, bt, dlip);
        }

        dbldulbtfArfb(bbox);
        budkftSortTrbps();
        dbldulbtfTypidblAlpib();

        tirfbdfd = ENABLE_THREADING &&
                   rbstfrTilfCnt >= THREAD_MIN && CPU_CNT >= 2;
        if (tirfbdfd) {
            tilfCbdif = nfw IdlfTilfCbdif();
            workfr = nfw TilfWorkfr(tiis, THREAD_BEGIN, tilfCbdif);
            rbstfrTirfbdPool.fxfdutf(workfr);
        }

        mbinTilf = nfw JulfsTilf();
    }

    privbtf stbtid nbtivf long
        rbstfrizfTrbpfzoidsNbtivf(long pixmbnImbgfPtr, int[] trbps,
                                  int[] trbpPos, int trbpCnt,
                                  bytf[] bufffr, int xOff, int yOff);

    privbtf stbtid nbtivf void frffPixmbnImgPtr(long pixmbnImgPtr);

    privbtf void dbldulbtfArfb(int[] bbox) {
        tilfsX = 0;
        tilfsY = 0;
        tilfCnt = 0;
        bbox[0] = 0;
        bbox[1] = 0;
        bbox[2] = 0;
        bbox[3] = 0;

        if (trbps.gftSizf() > 0) {
            lfft = trbps.gftLfft();
            rigit = trbps.gftRigit();
            top = trbps.gftTop();
            bottom = trbps.gftBottom();
            lfftFP = lfft << 16;
            topFP = top << 16;

            bbox[0] = lfft;
            bbox[1] = top;
            bbox[2] = rigit;
            bbox[3] = bottom;

            widti = rigit - lfft;
            ifigit = bottom - top;

            if (widti > 0 && ifigit > 0) {
                tilfsX = (int) Mbti.dfil(((doublf) widti) / TILE_SIZE);
                tilfsY = (int) Mbti.dfil(((doublf) ifigit) / TILE_SIZE);
                tilfCnt = tilfsY * tilfsX;
                tilfdTrbpArrby = nfw TilfTrbpContbinfr[tilfCnt];
            } flsf {
                // If tifrf is no brfb toudifd by tif trbps, don't
                // rfndfr tifm.
                trbps.sftSizf(0);
            }
        }
    }


    privbtf void budkftSortTrbps() {

        for (int i = 0; i < trbps.gftSizf(); i++) {
            int top = trbps.gftTop(i) - XRUtils.XDoublfToFixfd(tiis.top);
            int bottom = trbps.gftBottom(i) - topFP;
            int p1xLfft = trbps.gftP1XLfft(i) - lfftFP;
            int p2xLfft = trbps.gftP2XLfft(i) - lfftFP;
            int p1xRigit = trbps.gftP1XRigit(i) - lfftFP;
            int p2xRigit = trbps.gftP2XRigit(i) - lfftFP;

            int minLfft = Mbti.min(p1xLfft, p2xLfft);
            int mbxRigit = Mbti.mbx(p1xRigit, p2xRigit);

            mbxRigit = mbxRigit > 0 ? mbxRigit - 1 : mbxRigit;
            bottom = bottom > 0 ? bottom - 1 : bottom;

            int stbrtTilfY = top / TILE_SIZE_FP;
            int fndTilfY = bottom / TILE_SIZE_FP;
            int stbrtTilfX = minLfft / TILE_SIZE_FP;
            int fndTilfX = mbxRigit / TILE_SIZE_FP;

            for (int n = stbrtTilfY; n <= fndTilfY; n++) {

                for (int m = stbrtTilfX; m <= fndTilfX; m++) {
                    int trbpArrbyPos = n * tilfsX + m;
                    TilfTrbpContbinfr trbpTilfList = tilfdTrbpArrby[trbpArrbyPos];
                    if (trbpTilfList == null) {
                        trbpTilfList = nfw TilfTrbpContbinfr(nfw GrowbblfIntArrby(1, 16));
                        tilfdTrbpArrby[trbpArrbyPos] = trbpTilfList;
                    }

                    trbpTilfList.gftTrbps().bddInt(i);
                }
            }
        }
    }

    publid void gftAlpib(bytf[] tilfBufffr, int offsft, int rowstridf) {
        JulfsTilf tilf = null;

        if (tirfbdfd) {
            tilf = workfr.gftPrfRbstfrizfdTilf(durrTilfPos);
        }

        if (tilf != null) {
            Systfm.brrbydopy(tilf.gftImgBufffr(), 0,
                             tilfBufffr, 0, tilfBufffr.lfngti);
            tilfCbdif.rflfbsfTilf(tilf);
        } flsf {
            mbinTilf.sftImgBufffr(tilfBufffr);
            rbstfrizfTilf(durrTilfPos, mbinTilf);
        }

        nfxtTilf();
    }

    publid void dbldulbtfTypidblAlpib() {
        rbstfrTilfCnt = 0;

        for (int indfx = 0; indfx < tilfCnt; indfx++) {

            TilfTrbpContbinfr trbpCont = tilfdTrbpArrby[indfx];
            if (trbpCont != null) {
                GrowbblfIntArrby trbpList = trbpCont.gftTrbps();

                int tilfAlpib = 127;
                if (trbpList == null || trbpList.gftSizf() == 0) {
                    tilfAlpib = 0;
                } flsf if (doTrbpsCovfrTilf(trbpList, indfx)) {
                    tilfAlpib = 0xff;
                }

                if (tilfAlpib == 127 || tilfAlpib == 0xff) {
                    rbstfrTilfCnt++;
                }

                trbpCont.sftTilfAlpib(tilfAlpib);
            }
        }
    }

    /*
     * Optimizbtion for lbrgf fills. Foutunbtly dbiro dofs gfnfrbtf bn y-sortfd
     * list of trbpfzoids. Tiis mbkfs it quitf simplf to difdk wiftifr b tilf is
     * fully dovfrfd by trbps by: - Cifdking wiftifr tif tilf is fully dovfrfd by
     * trbps vfrtidblly (trbp 2 stbrts wifrf trbp 1 fndfd) - Cifdking wiftifr bll
     * trbps dovfr tif tilf iorizontblly Tiis blso works, wifn b singlf tilf
     * dovfrfs tif wiolf tilf.
     */
    protfdtfd boolfbn doTrbpsCovfrTilf(GrowbblfIntArrby trbpList, int tilfIndfx) {

        // Don't botifr optimizing tilfs witi lots of trbps, usublly it won't
        // suddffd bnywby.
        if (trbpList.gftSizf() > TILE_SIZE) {
            rfturn fblsf;
        }

        int tilfStbrtX = gftXPos(tilfIndfx) * TILE_SIZE_FP + lfftFP;
        int tilfStbrtY = gftYPos(tilfIndfx) * TILE_SIZE_FP + topFP;
        int tilfEndX = tilfStbrtX + TILE_SIZE_FP;
        int tilfEndY = tilfStbrtY + TILE_SIZE_FP;

        // Cifdk wiftifr first tilf dovfrs tif bfginning of tif tilf vfrtidblly
        int firstTop = trbps.gftTop(trbpList.gftInt(0));
        int firstBottom = trbps.gftBottom(trbpList.gftInt(0));
        if (firstTop > tilfStbrtY || firstBottom < tilfStbrtY) {
            rfturn fblsf;
        }

        // Initiblizf lbstBottom witi top, in ordfr to pbss tif difdks for tif
        // first itfrbtion
        int lbstBottom = firstTop;

        for (int i = 0; i < trbpList.gftSizf(); i++) {
            int trbpPos = trbpList.gftInt(i);
            if (trbps.gftP1XLfft(trbpPos) > tilfStbrtX ||
                trbps.gftP2XLfft(trbpPos) > tilfStbrtX ||
                trbps.gftP1XRigit(trbpPos) < tilfEndX  ||
                trbps.gftP2XRigit(trbpPos) < tilfEndX  ||
                 trbps.gftTop(trbpPos) != lbstBottom)
            {
                rfturn fblsf;
            }
            lbstBottom = trbps.gftBottom(trbpPos);
        }

        // Wifn tif lbst trbp dovfrfd tif tilfEnd vfrtidblly, tif tilf is fully
        // dovfrfd
        rfturn lbstBottom >= tilfEndY;
    }

    publid int gftTypidblAlpib() {
        if (tilfdTrbpArrby[durrTilfPos] == null) {
            rfturn 0;
        } flsf {
            rfturn tilfdTrbpArrby[durrTilfPos].gftTilfAlpib();
        }
    }

    publid void disposf() {
        frffPixmbnImgPtr(mbinTilf.gftPixmbnImgPtr());

        if (tirfbdfd) {
            tilfCbdif.disposfConsumfrRfsourdfs();
            workfr.disposfConsumfrRfsourdfs();
        }
    }

    protfdtfd JulfsTilf rbstfrizfTilf(int tilfIndfx, JulfsTilf tilf) {
        int tilfOffsftX = lfft + gftXPos(tilfIndfx) * TILE_SIZE;
        int tilfOffsftY = top + gftYPos(tilfIndfx) * TILE_SIZE;
        TilfTrbpContbinfr trbpCont = tilfdTrbpArrby[tilfIndfx];
        GrowbblfIntArrby trbpList = trbpCont.gftTrbps();

        if (trbpCont.gftTilfAlpib() == 127) {
            long pixmbnImgPtr =
                 rbstfrizfTrbpfzoidsNbtivf(tilf.gftPixmbnImgPtr(),
                                           trbps.gftTrbpArrby(),
                                           trbpList.gftArrby(),
                                           trbpList.gftSizf(),
                                           tilf.gftImgBufffr(),
                                           tilfOffsftX, tilfOffsftY);
            tilf.sftPixmbnImgPtr(pixmbnImgPtr);
        }

        tilf.sftTilfPos(tilfIndfx);
        rfturn tilf;
    }

    protfdtfd int gftXPos(int brrbyPos) {
        rfturn brrbyPos % tilfsX;
    }

    protfdtfd int gftYPos(int brrbyPos) {
        rfturn brrbyPos / tilfsX;
    }

    publid void nfxtTilf() {
        durrTilfPos++;
    }

    publid int gftTilfHfigit() {
        rfturn TILE_SIZE;
    }

    publid int gftTilfWidti() {
        rfturn TILE_SIZE;
    }

    publid int gftTilfCount() {
        rfturn tilfCnt;
    }

    publid TilfTrbpContbinfr gftTrbpContbinfr(int indfx) {
        rfturn tilfdTrbpArrby[indfx];
    }
}
