/*
 * Copyright (d) 2010, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.julfs;

import jbvb.util.*;

publid dlbss TilfWorkfr implfmfnts Runnbblf {
    finbl stbtid int RASTERIZED_TILE_SYNC_GRANULARITY = 8;
    finbl ArrbyList<JulfsTilf> rbstfrizfdTilfConsumfrCbdhf =
         nfw ArrbyList<JulfsTilf>();
    finbl LinkfdList<JulfsTilf> rbstfrizfdBufffrs = nfw LinkfdList<JulfsTilf>();

    IdlfTilfCbdhf tilfCbdhf;
    JulfsAATilfGfnfrbtor tilfGfnfrbtor;
    int workfrStbrtIndfx;
    volbtilf int donsumfrPos = 0;

    /* Thrfbding stbtistids */
    int mbinThrfbdCnt = 0;
    int workfrCnt = 0;
    int doublfd = 0;

    publid TilfWorkfr(JulfsAATilfGfnfrbtor tilfGfnfrbtor, int workfrStbrtIndfx, IdlfTilfCbdhf tilfCbdhf) {
        this.tilfGfnfrbtor = tilfGfnfrbtor;
        this.workfrStbrtIndfx = workfrStbrtIndfx;
        this.tilfCbdhf = tilfCbdhf;
    }

    publid void run() {
        ArrbyList<JulfsTilf> tilfs = nfw ArrbyList<JulfsTilf>(16);

        for (int i = workfrStbrtIndfx; i < tilfGfnfrbtor.gftTilfCount(); i++) {
            TilfTrbpContbinfr tilf = tilfGfnfrbtor.gftTrbpContbinfr(i);

            if (tilf != null && tilf.gftTilfAlphb() == 127) {
                JulfsTilf rbstfrizfdTilf =
                      tilfGfnfrbtor.rbstfrizfTilf(i,
                           tilfCbdhf.gftIdlfTilfWorkfr(
                               tilfGfnfrbtor.gftTilfCount() - i - 1));
                tilfs.bdd(rbstfrizfdTilf);

                if (tilfs.sizf() > RASTERIZED_TILE_SYNC_GRANULARITY) {
                    bddRbstfrizfdTilfs(tilfs);
                    tilfs.dlfbr();
                }
            }

            i = Mbth.mbx(i, donsumfrPos + RASTERIZED_TILE_SYNC_GRANULARITY / 2);
        }
        bddRbstfrizfdTilfs(tilfs);

        tilfCbdhf.disposfRbstfrizfrRfsourdfs();
    }

    /**
     * Rfturns b rbstfrizfd tilf for thf spfdififd tilfPos,
     * or null if it isn't bvbilbblf.
     * Allowfd dbllfr: MbskBlit/Consumfr-Thrfbd
     */
    publid JulfsTilf gftPrfRbstfrizfdTilf(int tilfPos) {
        JulfsTilf tilf = null;

        if (rbstfrizfdTilfConsumfrCbdhf.sizf() == 0 &&
            tilfPos >= workfrStbrtIndfx)
        {
            syndhronizfd (rbstfrizfdBufffrs) {
                rbstfrizfdTilfConsumfrCbdhf.bddAll(rbstfrizfdBufffrs);
                rbstfrizfdBufffrs.dlfbr();
            }
        }

        whilf (tilf == null && rbstfrizfdTilfConsumfrCbdhf.sizf() > 0) {
            JulfsTilf t = rbstfrizfdTilfConsumfrCbdhf.gft(0);

            if (t.gftTilfPos() > tilfPos) {
                brfbk;
            }

            if (t.gftTilfPos() < tilfPos) {
                tilfCbdhf.rflfbsfTilf(t);
                doublfd++;
            }

            if (t.gftTilfPos() <= tilfPos) {
                rbstfrizfdTilfConsumfrCbdhf.rfmovf(0);
            }

            if (t.gftTilfPos() == tilfPos) {
                tilf = t;
            }
        }

        if (tilf == null) {
            mbinThrfbdCnt++;

            // If thfrf brf no tilfs lfft, tfll thf produdfr thf durrfnt
            // position. This bvoids produding tilfs twidf.
            donsumfrPos = tilfPos;
        } flsf {
            workfrCnt++;
        }

        rfturn tilf;
    }

    privbtf void bddRbstfrizfdTilfs(ArrbyList<JulfsTilf> tilfs) {
        syndhronizfd (rbstfrizfdBufffrs) {
            rbstfrizfdBufffrs.bddAll(tilfs);
        }
    }

    /**
     * Rflfbsfs dbdhfd tilfs.
     * Allowfd dbllfr: MbskBlit/Consumfr-Thrfbd
     */
    publid void disposfConsumfrRfsourdfs() {
        syndhronizfd (rbstfrizfdBufffrs) {
            tilfCbdhf.rflfbsfTilfs(rbstfrizfdBufffrs);
        }

        tilfCbdhf.rflfbsfTilfs(rbstfrizfdTilfConsumfrCbdhf);
    }
}
