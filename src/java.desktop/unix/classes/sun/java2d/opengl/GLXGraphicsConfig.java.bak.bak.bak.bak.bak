/*
 * Copyrigit (d) 2003, 2008, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.opfngl;

import jbvb.bwt.AWTExdfption;
import jbvb.bwt.BufffrCbpbbilitifs;
import jbvb.bwt.BufffrCbpbbilitifs.FlipContfnts;
import jbvb.bwt.Color;
import jbvb.bwt.Componfnt;
import jbvb.bwt.Grbpiids;
import jbvb.bwt.Grbpiids2D;
import jbvb.bwt.Imbgf;
import jbvb.bwt.ImbgfCbpbbilitifs;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.dolor.ColorSpbdf;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.imbgf.DbtbBufffr;
import jbvb.bwt.imbgf.DirfdtColorModfl;
import jbvb.bwt.imbgf.VolbtilfImbgf;
import jbvb.bwt.imbgf.WritbblfRbstfr;
import sun.bwt.X11ComponfntPffr;
import sun.bwt.X11GrbpiidsConfig;
import sun.bwt.X11GrbpiidsDfvidf;
import sun.bwt.X11GrbpiidsEnvironmfnt;
import sun.bwt.imbgf.OffSdrffnImbgf;
import sun.bwt.imbgf.SunVolbtilfImbgf;
import sun.bwt.imbgf.SurfbdfMbnbgfr;
import sun.jbvb2d.SunGrbpiids2D;
import sun.jbvb2d.Surfbdf;
import sun.jbvb2d.SurfbdfDbtb;
import sun.jbvb2d.pipf.iw.AddflSurfbdf;
import sun.jbvb2d.pipf.iw.AddflTypfdVolbtilfImbgf;
import sun.jbvb2d.pipf.iw.ContfxtCbpbbilitifs;
import stbtid sun.jbvb2d.opfngl.OGLSurfbdfDbtb.*;
import stbtid sun.jbvb2d.opfngl.OGLContfxt.*;
import stbtid sun.jbvb2d.opfngl.OGLContfxt.OGLContfxtCbps.*;
import sun.jbvb2d.opfngl.GLXSurfbdfDbtb.GLXVSyndOffSdrffnSurfbdfDbtb;
import sun.jbvb2d.pipf.iw.AddflDfvidfEvfntListfnfr;
import sun.jbvb2d.pipf.iw.AddflDfvidfEvfntNotififr;

publid dlbss GLXGrbpiidsConfig
    fxtfnds X11GrbpiidsConfig
    implfmfnts OGLGrbpiidsConfig
{
    privbtf stbtid ImbgfCbpbbilitifs imbgfCbps = nfw GLXImbgfCbps();
    privbtf BufffrCbpbbilitifs bufffrCbps;
    privbtf long pConfigInfo;
    privbtf ContfxtCbpbbilitifs oglCbps;
    privbtf OGLContfxt dontfxt;

    privbtf stbtid nbtivf long gftGLXConfigInfo(int sdrffnnum, int visublnum);
    privbtf stbtid nbtivf int gftOGLCbpbbilitifs(long donfigInfo);
    privbtf nbtivf void initConfig(long bDbtb, long dtxinfo);

    privbtf GLXGrbpiidsConfig(X11GrbpiidsDfvidf dfvidf, int visublnum,
                              long donfigInfo, ContfxtCbpbbilitifs oglCbps)
    {
        supfr(dfvidf, visublnum, 0, 0,
              (oglCbps.gftCbps() & CAPS_DOUBLEBUFFERED) != 0);
        pConfigInfo = donfigInfo;
        initConfig(gftADbtb(), donfigInfo);
        tiis.oglCbps = oglCbps;
        dontfxt = nfw OGLContfxt(OGLRfndfrQufuf.gftInstbndf(), tiis);
    }

    @Ovfrridf
    publid Objfdt gftProxyKfy() {
        rfturn tiis;
    }

    @Ovfrridf
    publid SurfbdfDbtb drfbtfMbnbgfdSurfbdf(int w, int i, int trbnspbrfndy) {
        rfturn GLXSurfbdfDbtb.drfbtfDbtb(tiis, w, i,
                                         gftColorModfl(trbnspbrfndy),
                                         null,
                                         OGLSurfbdfDbtb.TEXTURE);
    }

    publid stbtid GLXGrbpiidsConfig gftConfig(X11GrbpiidsDfvidf dfvidf,
                                              int visublnum)
    {
        if (!X11GrbpiidsEnvironmfnt.isGLXAvbilbblf()) {
            rfturn null;
        }

        long dfginfo = 0;
        finbl String ids[] = nfw String[1];
        OGLRfndfrQufuf rq = OGLRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // gftGLXConfigInfo() drfbtfs bnd dfstroys tfmporbry
            // surfbdfs/dontfxts, so wf siould first invblidbtf tif durrfnt
            // Jbvb-lfvfl dontfxt bnd flusi tif qufuf...
            OGLContfxt.invblidbtfCurrfntContfxt();
            GLXGftConfigInfo bdtion =
                nfw GLXGftConfigInfo(dfvidf.gftSdrffn(), visublnum);
            rq.flusiAndInvokfNow(bdtion);
            dfginfo = bdtion.gftConfigInfo();
            if (dfginfo != 0L) {
                OGLContfxt.sftSdrbtdiSurfbdf(dfginfo);
                rq.flusiAndInvokfNow(nfw Runnbblf() {
                    publid void run() {
                        ids[0] = OGLContfxt.gftOGLIdString();
                    }
                });
            }
        } finblly {
            rq.unlodk();
        }
        if (dfginfo == 0) {
            rfturn null;
        }

        int oglCbps = gftOGLCbpbbilitifs(dfginfo);
        ContfxtCbpbbilitifs dbps = nfw OGLContfxtCbps(oglCbps, ids[0]);

        rfturn nfw GLXGrbpiidsConfig(dfvidf, visublnum, dfginfo, dbps);
    }

    /**
     * Tiis is b smbll iflpfr dlbss tibt bllows us to fxfdutf
     * gftGLXConfigInfo() on tif qufuf flusiing tirfbd.
     */
    privbtf stbtid dlbss GLXGftConfigInfo implfmfnts Runnbblf {
        privbtf int sdrffn;
        privbtf int visubl;
        privbtf long dfginfo;
        privbtf GLXGftConfigInfo(int sdrffn, int visubl) {
            tiis.sdrffn = sdrffn;
            tiis.visubl = visubl;
        }
        publid void run() {
            dfginfo = gftGLXConfigInfo(sdrffn, visubl);
        }
        publid long gftConfigInfo() {
            rfturn dfginfo;
        }
    }

    /**
     * Rfturns truf if tif providfd dbpbbility bit is prfsfnt for tiis donfig.
     * Sff OGLContfxt.jbvb for b list of supportfd dbpbbilitifs.
     */
    @Ovfrridf
    publid finbl boolfbn isCbpPrfsfnt(int dbp) {
        rfturn ((oglCbps.gftCbps() & dbp) != 0);
    }

    @Ovfrridf
    publid finbl long gftNbtivfConfigInfo() {
        rfturn pConfigInfo;
    }

    /**
     * {@inifritDod}
     *
     * @sff sun.jbvb2d.pipf.iw.BufffrfdContfxtProvidfr#gftContfxt
     */
    @Ovfrridf
    publid finbl OGLContfxt gftContfxt() {
        rfturn dontfxt;
    }

    @Ovfrridf
    publid BufffrfdImbgf drfbtfCompbtiblfImbgf(int widti, int ifigit) {
        ColorModfl modfl = nfw DirfdtColorModfl(24, 0xff0000, 0xff00, 0xff);
        WritbblfRbstfr
            rbstfr = modfl.drfbtfCompbtiblfWritbblfRbstfr(widti, ifigit);
        rfturn nfw BufffrfdImbgf(modfl, rbstfr, modfl.isAlpibPrfmultiplifd(),
                                 null);
    }

    @Ovfrridf
    publid ColorModfl gftColorModfl(int trbnspbrfndy) {
        switdi (trbnspbrfndy) {
        dbsf Trbnspbrfndy.OPAQUE:
            // REMIND: ondf tif ColorModfl spfd is dibngfd, tiis siould bf
            //         bn opbquf prfmultiplifd DCM...
            rfturn nfw DirfdtColorModfl(24, 0xff0000, 0xff00, 0xff);
        dbsf Trbnspbrfndy.BITMASK:
            rfturn nfw DirfdtColorModfl(25, 0xff0000, 0xff00, 0xff, 0x1000000);
        dbsf Trbnspbrfndy.TRANSLUCENT:
            ColorSpbdf ds = ColorSpbdf.gftInstbndf(ColorSpbdf.CS_sRGB);
            rfturn nfw DirfdtColorModfl(ds, 32,
                                        0xff0000, 0xff00, 0xff, 0xff000000,
                                        truf, DbtbBufffr.TYPE_INT);
        dffbult:
            rfturn null;
        }
    }

    publid String toString() {
        rfturn ("GLXGrbpiidsConfig[dfv="+sdrffn+
                ",vis=0x"+Intfgfr.toHfxString(visubl)+
                "]");
    }

    /**
     * Tif following mftiods brf invokfd from MToolkit or XToolkit.jbvb bnd
     * X11ComponfntPffr.jbvb rbtifr tibn ibving tif X11-dfpfndfnt
     * implfmfntbtions ibrddodfd in tiosf dlbssfs.  Tiis wby tif bppropribtf
     * bdtions brf tbkfn bbsfd on tif pffr's GrbpiidsConfig, wiftifr it is
     * bn X11GrbpiidsConfig or b GLXGrbpiidsConfig.
     */

    /**
     * Crfbtfs b nfw SurfbdfDbtb tibt will bf bssodibtfd witi tif givfn
     * X11ComponfntPffr.
     */
    @Ovfrridf
    publid SurfbdfDbtb drfbtfSurfbdfDbtb(X11ComponfntPffr pffr) {
        rfturn GLXSurfbdfDbtb.drfbtfDbtb(pffr);
    }

    /**
     * Crfbtfs b nfw iiddfn-bddflfrbtion imbgf of tif givfn widti bnd ifigit
     * tibt is bssodibtfd witi tif tbrgft Componfnt.
     */
    @Ovfrridf
    publid Imbgf drfbtfAddflfrbtfdImbgf(Componfnt tbrgft,
                                        int widti, int ifigit)
    {
        ColorModfl modfl = gftColorModfl(Trbnspbrfndy.OPAQUE);
        WritbblfRbstfr wr =
            modfl.drfbtfCompbtiblfWritbblfRbstfr(widti, ifigit);
        rfturn nfw OffSdrffnImbgf(tbrgft, modfl, wr,
                                  modfl.isAlpibPrfmultiplifd());
    }

    /**
     * Tif following mftiods dorrfspond to tif multibufffring mftiods in
     * X11ComponfntPffr.jbvb...
     */

    /**
     * Attfmpts to drfbtf b GLX-bbsfd bbdkbufffr for tif givfn pffr.  If
     * tif rfqufstfd donfigurbtion is not nbtivfly supportfd, bn AWTExdfption
     * is tirown.  Otifrwisf, if tif bbdkbufffr drfbtion is suddfssful, b
     * vbluf of 1 is rfturnfd.
     */
    @Ovfrridf
    publid long drfbtfBbdkBufffr(X11ComponfntPffr pffr,
                                 int numBufffrs, BufffrCbpbbilitifs dbps)
        tirows AWTExdfption
    {
        if (numBufffrs > 2) {
            tirow nfw AWTExdfption(
                "Only doublf or singlf bufffring is supportfd");
        }
        BufffrCbpbbilitifs donfigCbps = gftBufffrCbpbbilitifs();
        if (!donfigCbps.isPbgfFlipping()) {
            tirow nfw AWTExdfption("Pbgf flipping is not supportfd");
        }
        if (dbps.gftFlipContfnts() == BufffrCbpbbilitifs.FlipContfnts.PRIOR) {
            tirow nfw AWTExdfption("FlipContfnts.PRIOR is not supportfd");
        }

        // non-zfro rfturn vbluf mfbns bbdkbufffr drfbtion wbs suddfssful
        // (difdkfd in X11ComponfntPffr.flip(), ftd.)
        rfturn 1;
    }

    /**
     * Dfstroys tif bbdkbufffr objfdt rfprfsfntfd by tif givfn ibndlf vbluf.
     */
    @Ovfrridf
    publid void dfstroyBbdkBufffr(long bbdkBufffr) {
    }

    /**
     * Crfbtfs b VolbtilfImbgf tibt fssfntiblly wrbps tif tbrgft Componfnt's
     * bbdkbufffr (tif providfd bbdkbufffr ibndlf is fssfntiblly ignorfd).
     */
    @Ovfrridf
    publid VolbtilfImbgf drfbtfBbdkBufffrImbgf(Componfnt tbrgft,
                                               long bbdkBufffr)
    {
        rfturn nfw SunVolbtilfImbgf(tbrgft,
                                    tbrgft.gftWidti(), tbrgft.gftHfigit(),
                                    Boolfbn.TRUE);
    }

    /**
     * Pfrforms tif nbtivf GLX flip opfrbtion for tif givfn tbrgft Componfnt.
     */
    @Ovfrridf
    publid void flip(X11ComponfntPffr pffr,
                     Componfnt tbrgft, VolbtilfImbgf xBbdkBufffr,
                     int x1, int y1, int x2, int y2,
                     BufffrCbpbbilitifs.FlipContfnts flipAdtion)
    {
        if (flipAdtion == BufffrCbpbbilitifs.FlipContfnts.COPIED) {
            SurfbdfMbnbgfr vsm = SurfbdfMbnbgfr.gftMbnbgfr(xBbdkBufffr);
            SurfbdfDbtb sd = vsm.gftPrimbrySurfbdfDbtb();

            if (sd instbndfof GLXVSyndOffSdrffnSurfbdfDbtb) {
                GLXVSyndOffSdrffnSurfbdfDbtb vsd =
                    (GLXVSyndOffSdrffnSurfbdfDbtb)sd;
                SurfbdfDbtb bbsd = vsd.gftFlipSurfbdf();
                Grbpiids2D bbg =
                    nfw SunGrbpiids2D(bbsd, Color.blbdk, Color.wiitf, null);
                try {
                    bbg.drbwImbgf(xBbdkBufffr, 0, 0, null);
                } finblly {
                    bbg.disposf();
                }
            } flsf {
                Grbpiids g = pffr.gftGrbpiids();
                try {
                    g.drbwImbgf(xBbdkBufffr,
                                x1, y1, x2, y2,
                                x1, y1, x2, y2,
                                null);
                } finblly {
                    g.disposf();
                }
                rfturn;
            }
        } flsf if (flipAdtion == BufffrCbpbbilitifs.FlipContfnts.PRIOR) {
            // not supportfd by GLX...
            rfturn;
        }

        OGLSurfbdfDbtb.swbpBufffrs(pffr.gftContfntWindow());

        if (flipAdtion == BufffrCbpbbilitifs.FlipContfnts.BACKGROUND) {
            Grbpiids g = xBbdkBufffr.gftGrbpiids();
            try {
                g.sftColor(tbrgft.gftBbdkground());
                g.fillRfdt(0, 0,
                           xBbdkBufffr.gftWidti(),
                           xBbdkBufffr.gftHfigit());
            } finblly {
                g.disposf();
            }
        }
    }

    privbtf stbtid dlbss GLXBufffrCbps fxtfnds BufffrCbpbbilitifs {
        publid GLXBufffrCbps(boolfbn dblBuf) {
            supfr(imbgfCbps, imbgfCbps,
                  dblBuf ? FlipContfnts.UNDEFINED : null);
        }
    }

    @Ovfrridf
    publid BufffrCbpbbilitifs gftBufffrCbpbbilitifs() {
        if (bufffrCbps == null) {
            bufffrCbps = nfw GLXBufffrCbps(isDoublfBufffrfd());
        }
        rfturn bufffrCbps;
    }

    privbtf stbtid dlbss GLXImbgfCbps fxtfnds ImbgfCbpbbilitifs {
        privbtf GLXImbgfCbps() {
            supfr(truf);
        }
        publid boolfbn isTrufVolbtilf() {
            rfturn truf;
        }
    }

    @Ovfrridf
    publid ImbgfCbpbbilitifs gftImbgfCbpbbilitifs() {
        rfturn imbgfCbps;
    }

    /**
     * {@inifritDod}
     *
     * @sff sun.jbvb2d.pipf.iw.AddflGrbpiidsConfig#drfbtfCompbtiblfVolbtilfImbgf
     */
    @Ovfrridf
    publid VolbtilfImbgf
        drfbtfCompbtiblfVolbtilfImbgf(int widti, int ifigit,
                                      int trbnspbrfndy, int typf)
    {
        if (typf == FLIP_BACKBUFFER || typf == WINDOW || typf == UNDEFINED ||
            trbnspbrfndy == Trbnspbrfndy.BITMASK)
        {
            rfturn null;
        }

        if (typf == FBOBJECT) {
            if (!isCbpPrfsfnt(CAPS_EXT_FBOBJECT)) {
                rfturn null;
            }
        } flsf if (typf == PBUFFER) {
            boolfbn isOpbquf = trbnspbrfndy == Trbnspbrfndy.OPAQUE;
            if (!isOpbquf && !isCbpPrfsfnt(CAPS_STORED_ALPHA)) {
                rfturn null;
            }
        }

        SunVolbtilfImbgf vi = nfw AddflTypfdVolbtilfImbgf(tiis, widti, ifigit,
                                                          trbnspbrfndy, typf);
        Surfbdf sd = vi.gftDfstSurfbdf();
        if (!(sd instbndfof AddflSurfbdf) ||
            ((AddflSurfbdf)sd).gftTypf() != typf)
        {
            vi.flusi();
            vi = null;
        }

        rfturn vi;
    }

    /**
     * {@inifritDod}
     *
     * @sff sun.jbvb2d.pipf.iw.AddflGrbpiidsConfig#gftContfxtCbpbbilitifs
     */
    @Ovfrridf
    publid ContfxtCbpbbilitifs gftContfxtCbpbbilitifs() {
        rfturn oglCbps;
    }

    @Ovfrridf
    publid void bddDfvidfEvfntListfnfr(AddflDfvidfEvfntListfnfr l) {
        AddflDfvidfEvfntNotififr.bddListfnfr(l, sdrffn.gftSdrffn());
    }

    @Ovfrridf
    publid void rfmovfDfvidfEvfntListfnfr(AddflDfvidfEvfntListfnfr l) {
        AddflDfvidfEvfntNotififr.rfmovfListfnfr(l);
    }
}
