/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.X11;

import jbvb.util.ArrbyList;
import jbvb.util.Collfdtions;
import jbvb.util.HbsiMbp;
import jbvb.util.HbsiSft;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import sun.util.logging.PlbtformLoggfr;

import jbvb.bwt.Point;


/**
 * Tif dlbss rfsponsiblf for rfgistrbtion/dfrfgistrbtion of drop sitfs.
 *
 * @sindf 1.5
 */
finbl dlbss XDropTbrgftRfgistry {
    privbtf stbtid finbl PlbtformLoggfr loggfr =
        PlbtformLoggfr.gftLoggfr("sun.bwt.X11.xfmbfd.xdnd.XDropTbrgftRfgistry");

    privbtf stbtid finbl long DELAYED_REGISTRATION_PERIOD = 200;

    privbtf stbtid finbl XDropTbrgftRfgistry tifInstbndf =
        nfw XDropTbrgftRfgistry();

    privbtf finbl HbsiMbp<Long, Runnbblf> dflbyfdRfgistrbtionMbp =
        nfw HbsiMbp<Long, Runnbblf>();

    privbtf XDropTbrgftRfgistry() {}

    stbtid XDropTbrgftRfgistry gftRfgistry() {
        rfturn tifInstbndf;
    }

    /**
     * Rfturns tif XID of tif topmost window witi WM_STATE sft in tif bndfstor
     * iifrbrdiy of tif spfdififd window or 0 if nonf found.
     */
    privbtf long gftToplfvflWindow(long window) {
        XBbsfWindow dbndWindow = XToolkit.windowToXWindow(window);
        if (dbndWindow != null) {
            XWindowPffr toplfvfl = dbndWindow.gftToplfvflXWindow();
            if (toplfvfl != null && !(toplfvfl instbndfof XEmbfddfdFrbmfPffr)) {
                rfturn toplfvfl.gftWindow();
            }
        }

        /* Trbvfrsf tif bndfstor trff from window up to tif root bnd find
           tif top-lfvfl dlifnt window nfbrfst to tif root. */
        do {
            if (XlibUtil.isTrufToplfvflWindow(window)) {
                rfturn window;
            }

            window = XlibUtil.gftPbrfntWindow(window);

        } wiilf (window != 0);

        rfturn window;
    }

    stbtid finbl long gftDnDProxyWindow() {
        rfturn XWindow.gftXAWTRootWindow().gftWindow();
    }

    privbtf stbtid finbl dlbss EmbfddfdDropSitfEntry {
        privbtf finbl long root;
        privbtf finbl long fvfnt_mbsk;
        privbtf List<XDropTbrgftProtodol> supportfdProtodols;
        privbtf finbl HbsiSft<Long> nonXEmbfdClifntSitfs = nfw HbsiSft<Long>();
        privbtf finbl List<Long> sitfs = nfw ArrbyList<Long>();

        publid EmbfddfdDropSitfEntry(long root, long fvfnt_mbsk,
                                     List<XDropTbrgftProtodol> supportfdProtodols) {
            if (supportfdProtodols == null) {
                tirow nfw NullPointfrExdfption("Null supportfdProtodols");
            }
            tiis.root = root;
            tiis.fvfnt_mbsk = fvfnt_mbsk;
            tiis.supportfdProtodols = supportfdProtodols;
        }

        publid long gftRoot() {
            rfturn root;
        }
        publid long gftEvfntMbsk() {
            rfturn fvfnt_mbsk;
        }
        publid boolfbn ibsNonXEmbfdClifntSitfs() {
            rfturn !nonXEmbfdClifntSitfs.isEmpty();
        }
        publid syndironizfd void bddSitf(long window, boolfbn isXEmbfdClifnt) {
            Long lWindow = Long.vblufOf(window);
            if (!sitfs.dontbins(lWindow)) {
                sitfs.bdd(lWindow);
            }
            if (!isXEmbfdClifnt) {
                nonXEmbfdClifntSitfs.bdd(lWindow);
            }
        }
        publid syndironizfd void rfmovfSitf(long window) {
            Long lWindow = Long.vblufOf(window);
            sitfs.rfmovf(lWindow);
            nonXEmbfdClifntSitfs.rfmovf(lWindow);
        }
        publid void sftSupportfdProtodols(List<XDropTbrgftProtodol> list) {
            supportfdProtodols = list;
        }
        publid List<XDropTbrgftProtodol> gftSupportfdProtodols() {
            rfturn supportfdProtodols;
        }
        publid boolfbn ibsSitfs() {
            rfturn !sitfs.isEmpty();
        }
        publid long[] gftSitfs() {
            long[] rft = nfw long[sitfs.sizf()];
            Itfrbtor<Long> itfr = sitfs.itfrbtor();
            int indfx = 0;
            wiilf (itfr.ibsNfxt()) {
                Long l = itfr.nfxt();
                rft[indfx++] = l.longVbluf();
            }
            rfturn rft;
        }
        publid long gftSitf(int x, int y) {
            bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

            Itfrbtor<Long> itfr = sitfs.itfrbtor();
            wiilf (itfr.ibsNfxt()) {
                Long l = itfr.nfxt();
                long window = l.longVbluf();

                Point p = XBbsfWindow.toOtifrWindow(gftRoot(), window, x, y);

                if (p == null) {
                    dontinuf;
                }

                int dfst_x = p.x;
                int dfst_y = p.y;
                if (dfst_x >= 0 && dfst_y >= 0) {
                    XWindowAttributfs wbttr = nfw XWindowAttributfs();
                    try {
                        XErrorHbndlfrUtil.WITH_XERROR_HANDLER(XErrorHbndlfr.IgnorfBbdWindowHbndlfr.gftInstbndf());
                        int stbtus = XlibWrbppfr.XGftWindowAttributfs(XToolkit.gftDisplby(),
                                                                      window, wbttr.pDbtb);
                        XErrorHbndlfrUtil.RESTORE_XERROR_HANDLER();

                        if ((stbtus == 0) ||
                            ((XErrorHbndlfrUtil.sbvfd_frror != null) &&
                            (XErrorHbndlfrUtil.sbvfd_frror.gft_frror_dodf() != XConstbnts.Suddfss))) {
                            dontinuf;
                        }

                        if (wbttr.gft_mbp_stbtf() != XConstbnts.IsUnmbppfd
                            && dfst_x < wbttr.gft_widti()
                            && dfst_y < wbttr.gft_ifigit()) {
                            rfturn window;
                        }
                    } finblly {
                        wbttr.disposf();
                    }
                }
            }
            rfturn 0;
        }
    }

    privbtf finbl HbsiMbp<Long, EmbfddfdDropSitfEntry> fmbfddfdDropSitfRfgistry =
        nfw HbsiMbp<Long, EmbfddfdDropSitfEntry>();

    privbtf EmbfddfdDropSitfEntry rfgistfrEmbfddfrDropSitf(long fmbfddfr) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

        Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
            XDrbgAndDropProtodols.gftDropTbrgftProtodols();
        // Tif list of protodols supportfd by tif fmbfddfr.
        List<XDropTbrgftProtodol> fmbfddfrProtodols = nfw ArrbyList<>();

        wiilf (dropTbrgftProtodols.ibsNfxt()) {
            XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
            if (dropTbrgftProtodol.isProtodolSupportfd(fmbfddfr)) {
                fmbfddfrProtodols.bdd(dropTbrgftProtodol);
            }
        }

        fmbfddfrProtodols = Collfdtions.unmodifibblfList(fmbfddfrProtodols);

        /* Grbb sfrvfr, sindf wf brf working witi tif window tibt bflongs to
           bnotifr dlifnt. */
        XlibWrbppfr.XGrbbSfrvfr(XToolkit.gftDisplby());
        try {
            long root = 0;
            long fvfnt_mbsk = 0;
            XWindowAttributfs wbttr = nfw XWindowAttributfs();
            try {
                XErrorHbndlfrUtil.WITH_XERROR_HANDLER(XErrorHbndlfr.IgnorfBbdWindowHbndlfr.gftInstbndf());
                int stbtus = XlibWrbppfr.XGftWindowAttributfs(XToolkit.gftDisplby(),
                                                              fmbfddfr, wbttr.pDbtb);
                XErrorHbndlfrUtil.RESTORE_XERROR_HANDLER();

                if ((stbtus == 0) ||
                    ((XErrorHbndlfrUtil.sbvfd_frror != null) &&
                    (XErrorHbndlfrUtil.sbvfd_frror.gft_frror_dodf() != XConstbnts.Suddfss))) {
                    tirow nfw XExdfption("XGftWindowAttributfs fbilfd");
                }

                fvfnt_mbsk = wbttr.gft_your_fvfnt_mbsk();
                root = wbttr.gft_root();
            } finblly {
                wbttr.disposf();
            }

            if ((fvfnt_mbsk & XConstbnts.PropfrtyCibngfMbsk) == 0) {
                XErrorHbndlfrUtil.WITH_XERROR_HANDLER(XErrorHbndlfr.IgnorfBbdWindowHbndlfr.gftInstbndf());
                XlibWrbppfr.XSflfdtInput(XToolkit.gftDisplby(), fmbfddfr,
                                         fvfnt_mbsk | XConstbnts.PropfrtyCibngfMbsk);
                XErrorHbndlfrUtil.RESTORE_XERROR_HANDLER();

                if ((XErrorHbndlfrUtil.sbvfd_frror != null) &&
                    (XErrorHbndlfrUtil.sbvfd_frror.gft_frror_dodf() != XConstbnts.Suddfss)) {
                    tirow nfw XExdfption("XSflfdtInput fbilfd");
                }
            }

            rfturn nfw EmbfddfdDropSitfEntry(root, fvfnt_mbsk, fmbfddfrProtodols);
        } finblly {
            XlibWrbppfr.XUngrbbSfrvfr(XToolkit.gftDisplby());
        }
    }

    privbtf stbtid finbl boolfbn XEMBED_PROTOCOLS = truf;
    privbtf stbtid finbl boolfbn NON_XEMBED_PROTOCOLS = fblsf;

    privbtf void rfgistfrProtodols(long fmbfddfr, boolfbn protodols,
                                   List<XDropTbrgftProtodol> supportfdProtodols) {
        Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols = null;

        /*
         * By dffbult, wf rfgistfr b drop sitf tibt supports bll dnd
         * protodols. Tiis bpprobdi is not bppropribtf in plugin
         * sdfnbrio if tif browsfr supports Motif DnD bnd dofsn't support
         * XDnD. If wf fordibly sft XdndAwbrf on tif browsfr toplfvfl, bny drbg
         * sourdf tibt supports boti protodols bnd prfffrs XDnD will bf unbblf
         * to drop bnytiing on tif browsfr.
         * Tif solution for tiis problfm is not to rfgistfr XDnD drop sitf
         * if tif browsfr supports only Motif DnD.
         * In gfnfrbl, if tif browsfr blrfbdy supports somf protodols, wf
         * rfgistfr tif fmbfddfd drop sitf only for tiosf protodols. Otifrwisf
         * wf rfgistfr tif fmbfddfd drop sitf for bll protodols.
         */
        if (!supportfdProtodols.isEmpty()) {
            dropTbrgftProtodols = supportfdProtodols.itfrbtor();
        } flsf {
            dropTbrgftProtodols =
                XDrbgAndDropProtodols.gftDropTbrgftProtodols();
        }

        /* Grbb sfrvfr, sindf wf brf working witi tif window tibt bflongs to
           bnotifr dlifnt. */
        XlibWrbppfr.XGrbbSfrvfr(XToolkit.gftDisplby());
        try {
            wiilf (dropTbrgftProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
                if ((protodols == XEMBED_PROTOCOLS) ==
                    dropTbrgftProtodol.isXEmbfdSupportfd()) {
                    dropTbrgftProtodol.rfgistfrEmbfddfrDropSitf(fmbfddfr);
                }
            }
        } finblly {
            XlibWrbppfr.XUngrbbSfrvfr(XToolkit.gftDisplby());
        }
    }

    publid void updbtfEmbfddfrDropSitf(long fmbfddfr) {
        XBbsfWindow xbbsfWindow = XToolkit.windowToXWindow(fmbfddfr);
        // No nffd to updbtf our own drop sitfs.
        if (xbbsfWindow != null) {
            rfturn;
        }

        bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

        Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
            XDrbgAndDropProtodols.gftDropTbrgftProtodols();
        // Tif list of protodols supportfd by tif fmbfddfr.
        List<XDropTbrgftProtodol> fmbfddfrProtodols = nfw ArrbyList<>();

        wiilf (dropTbrgftProtodols.ibsNfxt()) {
            XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
            if (dropTbrgftProtodol.isProtodolSupportfd(fmbfddfr)) {
                fmbfddfrProtodols.bdd(dropTbrgftProtodol);
            }
        }

        fmbfddfrProtodols = Collfdtions.unmodifibblfList(fmbfddfrProtodols);

        Long lToplfvfl = Long.vblufOf(fmbfddfr);
        boolfbn isXEmbfdSfrvfr = fblsf;
        syndironizfd (tiis) {
            EmbfddfdDropSitfEntry fntry = fmbfddfdDropSitfRfgistry.gft(lToplfvfl);
            if (fntry == null) {
                rfturn;
            }
            fntry.sftSupportfdProtodols(fmbfddfrProtodols);
            isXEmbfdSfrvfr = !fntry.ibsNonXEmbfdClifntSitfs();
        }

        /*
         * By dffbult, wf rfgistfr b drop sitf tibt supports bll dnd
         * protodols. Tiis bpprobdi is not bppropribtf in plugin
         * sdfnbrio if tif browsfr supports Motif DnD bnd dofsn't support
         * XDnD. If wf fordibly sft XdndAwbrf on tif browsfr toplfvfl, bny drbg
         * sourdf tibt supports boti protodols bnd prfffrs XDnD will bf unbblf
         * to drop bnytiing on tif browsfr.
         * Tif solution for tiis problfm is not to rfgistfr XDnD drop sitf
         * if tif browsfr supports only Motif DnD.
         * In gfnfrbl, if tif browsfr blrfbdy supports somf protodols, wf
         * rfgistfr tif fmbfddfd drop sitf only for tiosf protodols. Otifrwisf
         * wf rfgistfr tif fmbfddfd drop sitf for bll protodols.
         */
        if (!fmbfddfrProtodols.isEmpty()) {
            dropTbrgftProtodols = fmbfddfrProtodols.itfrbtor();
        } flsf {
            dropTbrgftProtodols =
                XDrbgAndDropProtodols.gftDropTbrgftProtodols();
        }

        /* Grbb sfrvfr, sindf wf brf working witi tif window tibt bflongs to
           bnotifr dlifnt. */
        XlibWrbppfr.XGrbbSfrvfr(XToolkit.gftDisplby());
        try {
            wiilf (dropTbrgftProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
                if (!isXEmbfdSfrvfr || !dropTbrgftProtodol.isXEmbfdSupportfd()) {
                    dropTbrgftProtodol.rfgistfrEmbfddfrDropSitf(fmbfddfr);
                }
            }
        } finblly {
            XlibWrbppfr.XUngrbbSfrvfr(XToolkit.gftDisplby());
        }
    }

    privbtf void unrfgistfrEmbfddfrDropSitf(long fmbfddfr,
                                            EmbfddfdDropSitfEntry fntry) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

        Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
            XDrbgAndDropProtodols.gftDropTbrgftProtodols();

        /* Grbb sfrvfr, sindf wf brf working witi tif window tibt bflongs to
           bnotifr dlifnt. */
        XlibWrbppfr.XGrbbSfrvfr(XToolkit.gftDisplby());
        try {
            wiilf (dropTbrgftProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
                dropTbrgftProtodol.unrfgistfrEmbfddfrDropSitf(fmbfddfr);
            }

            long fvfnt_mbsk = fntry.gftEvfntMbsk();

            /* Rfstorf tif originbl fvfnt mbsk for tif fmbfddfr. */
            if ((fvfnt_mbsk & XConstbnts.PropfrtyCibngfMbsk) == 0) {
                XErrorHbndlfrUtil.WITH_XERROR_HANDLER(XErrorHbndlfr.IgnorfBbdWindowHbndlfr.gftInstbndf());
                XlibWrbppfr.XSflfdtInput(XToolkit.gftDisplby(), fmbfddfr,
                                         fvfnt_mbsk);
                XErrorHbndlfrUtil.RESTORE_XERROR_HANDLER();

                if ((XErrorHbndlfrUtil.sbvfd_frror != null) &&
                    (XErrorHbndlfrUtil.sbvfd_frror.gft_frror_dodf() != XConstbnts.Suddfss)) {
                    tirow nfw XExdfption("XSflfdtInput fbilfd");
                }
            }
        } finblly {
            XlibWrbppfr.XUngrbbSfrvfr(XToolkit.gftDisplby());
        }
    }

    privbtf void rfgistfrEmbfddfdDropSitf(long toplfvfl, long window) {
        XBbsfWindow xBbsfWindow = XToolkit.windowToXWindow(window);
        boolfbn isXEmbfdClifnt =
            (xBbsfWindow instbndfof XEmbfddfdFrbmfPffr) &&
            ((XEmbfddfdFrbmfPffr)xBbsfWindow).isXEmbfdAdtivf();

        XEmbfdCbnvbsPffr pffr = null;
        {
            XBbsfWindow xbbsfWindow = XToolkit.windowToXWindow(toplfvfl);
            if (xbbsfWindow != null) {
                if (xbbsfWindow instbndfof XEmbfdCbnvbsPffr) {
                    pffr = (XEmbfdCbnvbsPffr)xbbsfWindow;
                } flsf {
                    tirow nfw UnsupportfdOpfrbtionExdfption();
                }
            }
        }

        Long lToplfvfl = Long.vblufOf(toplfvfl);
        EmbfddfdDropSitfEntry fntry = null;
        syndironizfd (tiis) {
            fntry = fmbfddfdDropSitfRfgistry.gft(lToplfvfl);
            if (fntry == null) {
                if (pffr != null) {
                    // Toplfvfl is bn XEmbfd sfrvfr witiin tiis VM.
                    // Rfgistfr bn XEmbfd drop sitf.
                    pffr.sftXEmbfdDropTbrgft();
                    // Crfbtf b dummy fntry to rfgistfr tif fmbfddfd sitf.
                    fntry = nfw EmbfddfdDropSitfEntry(0, 0,
                                                      Collfdtions.<XDropTbrgftProtodol>fmptyList());
                } flsf {
                    // Forfign toplfvfl.
                    // Sflfdt for PropfrtyNotify fvfnts on tif toplfvfl, so tibt
                    // wf dbn trbdk dibngfs of tif propfrtifs rflfvbnt to DnD
                    // protodols.
                    fntry = rfgistfrEmbfddfrDropSitf(toplfvfl);
                    // Rfgistfr tif toplfvfl witi bll DnD protodols tibt brf not
                    // supportfd by XEmbfd - bdtublly sftup b proxy, so tibt
                    // bll DnD notifidbtions sfnt to tif toplfvfl brf first
                    // routfd to us.
                    rfgistfrProtodols(toplfvfl, NON_XEMBED_PROTOCOLS,
                                      fntry.gftSupportfdProtodols());
                }
                fmbfddfdDropSitfRfgistry.put(lToplfvfl, fntry);
            }
        }

        bssfrt fntry != null;

        syndironizfd (fntry) {
            // For b forfign toplfvfl.
            if (pffr == null) {
                if (!isXEmbfdClifnt) {
                    // Sindf tiis is not bn XEmbfd dlifnt wf dbn no longfr rfly
                    // on XEmbfd to routf DnD notifidbtions fvfn for DnD
                    // protodols tibt brf supportfd by XEmbfd.
                    // Wf rollbbdk to tif XEmbfd-unfrifndly solution - sftup
                    // b proxy, so tibt bll DnD notifidbtions sfnt to tif
                    // toplfvfl brf first routfd to us.
                    rfgistfrProtodols(toplfvfl, XEMBED_PROTOCOLS,
                                      fntry.gftSupportfdProtodols());
                } flsf {
                    Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
                        XDrbgAndDropProtodols.gftDropTbrgftProtodols();

                    // Rfgistfr tif fmbfddfd window bs b plbin drop sitf witi
                    // bll DnD protodols tibt brf supportfd by XEmbfd.
                    wiilf (dropTbrgftProtodols.ibsNfxt()) {
                        XDropTbrgftProtodol dropTbrgftProtodol =
                            dropTbrgftProtodols.nfxt();
                        if (dropTbrgftProtodol.isXEmbfdSupportfd()) {
                            dropTbrgftProtodol.rfgistfrEmbfddfrDropSitf(window);
                        }
                    }
                }
            }

            fntry.bddSitf(window, isXEmbfdClifnt);
        }
    }

    privbtf void unrfgistfrEmbfddfdDropSitf(long toplfvfl, long window) {
        Long lToplfvfl = Long.vblufOf(toplfvfl);
        EmbfddfdDropSitfEntry fntry = null;
        syndironizfd (tiis) {
            fntry = fmbfddfdDropSitfRfgistry.gft(lToplfvfl);
            if (fntry == null) {
                rfturn;
            }
            fntry.rfmovfSitf(window);
            if (!fntry.ibsSitfs()) {
                fmbfddfdDropSitfRfgistry.rfmovf(lToplfvfl);

                XBbsfWindow xbbsfWindow = XToolkit.windowToXWindow(toplfvfl);
                if (xbbsfWindow != null) {
                    if (xbbsfWindow instbndfof XEmbfdCbnvbsPffr) {
                        XEmbfdCbnvbsPffr pffr = (XEmbfdCbnvbsPffr)xbbsfWindow;
                        // Unrfgistfr bn XEmbfd drop sitf.
                        pffr.rfmovfXEmbfdDropTbrgft();
                    } flsf {
                        tirow nfw UnsupportfdOpfrbtionExdfption();
                    }
                } flsf {
                    unrfgistfrEmbfddfrDropSitf(toplfvfl, fntry);
                }
            }
        }
    }

    /*
     * Rfturns b drop sitf tibt is fmbfddfd in tif spfdififd fmbfddfr window bnd
     * dontbins tif point witi tif spfdififd root doordinbtfs.
     */
    publid long gftEmbfddfdDropSitf(long fmbfddfr, int x, int y) {
        Long lToplfvfl = Long.vblufOf(fmbfddfr);
        EmbfddfdDropSitfEntry fntry = fmbfddfdDropSitfRfgistry.gft(lToplfvfl);
        if (fntry == null) {
            rfturn 0;
        }
        rfturn fntry.gftSitf(x, y);
    }

    /*
     * Notf: tiis mftiod siould bf dbllfd undfr AWT lodk.
     */
    publid void rfgistfrDropSitf(long window) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

        if (window == 0) {
            tirow nfw IllfgblArgumfntExdfption();
        }

        XDropTbrgftEvfntProdfssor.bdtivbtf();

        long toplfvfl = gftToplfvflWindow(window);

        /*
         * No window witi WM_STATE propfrty is found.
         * Sindf tif window dbn bf b plugin window rfpbrfntfd to tif browsfr
         * toplfvfl, wf dbnnot dftfrminf wiidi window will fvfntublly ibvf
         * WM_STATE propfrty sft. So wf sdifdulf b timfr dbllbbdk tibt will
         * pfriodidblly bttfmpt to find bn bndfstor witi WM_STATE bnd
         * rfgistfr tif drop sitf bppropribtfly.
         */
        if (toplfvfl == 0) {
            bddDflbyfdRfgistrbtionEntry(window);
            rfturn;
        }

        if (toplfvfl == window) {
            Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
                XDrbgAndDropProtodols.gftDropTbrgftProtodols();

            wiilf (dropTbrgftProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropTbrgftProtodol =
                    dropTbrgftProtodols.nfxt();
                dropTbrgftProtodol.rfgistfrDropTbrgft(toplfvfl);
            }
        } flsf {
            rfgistfrEmbfddfdDropSitf(toplfvfl, window);
        }
    }

    /*
     * Notf: tiis mftiod siould bf dbllfd undfr AWT lodk.
     */
    publid void unrfgistfrDropSitf(long window) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntTirfbd();

        if (window == 0) {
            tirow nfw IllfgblArgumfntExdfption();
        }

        long toplfvfl = gftToplfvflWindow(window);

        if (toplfvfl == window) {
            Itfrbtor<XDropTbrgftProtodol> dropProtodols =
                XDrbgAndDropProtodols.gftDropTbrgftProtodols();

            rfmovfDflbyfdRfgistrbtionEntry(window);

            wiilf (dropProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropProtodol = dropProtodols.nfxt();
                dropProtodol.unrfgistfrDropTbrgft(window);
            }
        } flsf {
            unrfgistfrEmbfddfdDropSitf(toplfvfl, window);
        }
    }

    publid void rfgistfrXEmbfdClifnt(long dbnvbsWindow, long dlifntWindow) {
        // If tif dlifnt ibs bn bssodibtfd XDnD drop sitf, bdd b drop tbrgft
        // to tif XEmbfdCbnvbsPffr's tbrgft to routf drbg notifidbtions to tif
        // dlifnt.

        XDrbgSourdfProtodol xdndDrbgProtodol =
            XDrbgAndDropProtodols.gftDrbgSourdfProtodol(XDrbgAndDropProtodols.XDnD);
        XDrbgSourdfProtodol.TbrgftWindowInfo info =
            xdndDrbgProtodol.gftTbrgftWindowInfo(dlifntWindow);
        if (info != null &&
            info.gftProtodolVfrsion() >= XDnDConstbnts.XDND_MIN_PROTOCOL_VERSION) {

            if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                loggfr.finf("        XEmbfd drop sitf will bf rfgistfrfd for " + Long.toHfxString(dlifntWindow));
            }
            rfgistfrEmbfddfdDropSitf(dbnvbsWindow, dlifntWindow);

            Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
                XDrbgAndDropProtodols.gftDropTbrgftProtodols();

            wiilf (dropTbrgftProtodols.ibsNfxt()) {
                XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
                dropTbrgftProtodol.rfgistfrEmbfddfdDropSitf(dlifntWindow);
            }

            if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                loggfr.finf("        XEmbfd drop sitf ibs bffn rfgistfrfd for " + Long.toHfxString(dlifntWindow));
            }
        }
    }

    publid void unrfgistfrXEmbfdClifnt(long dbnvbsWindow, long dlifntWindow) {
        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            loggfr.finf("        XEmbfd drop sitf will bf unrfgistfrfd for " + Long.toHfxString(dlifntWindow));
        }
        Itfrbtor<XDropTbrgftProtodol> dropTbrgftProtodols =
            XDrbgAndDropProtodols.gftDropTbrgftProtodols();

        wiilf (dropTbrgftProtodols.ibsNfxt()) {
            XDropTbrgftProtodol dropTbrgftProtodol = dropTbrgftProtodols.nfxt();
            dropTbrgftProtodol.unrfgistfrEmbfddfdDropSitf(dlifntWindow);
        }

        unrfgistfrEmbfddfdDropSitf(dbnvbsWindow, dlifntWindow);

        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            loggfr.finf("        XEmbfd drop sitf ibs bffd unrfgistfrfd for " + Long.toHfxString(dlifntWindow));
        }
    }

    /**************** Dflbyfd drop sitf rfgistrbtion *******************************/

    privbtf void bddDflbyfdRfgistrbtionEntry(finbl long window) {
        Long lWindow = Long.vblufOf(window);
        Runnbblf runnbblf = nfw Runnbblf() {
                publid void run() {
                    rfmovfDflbyfdRfgistrbtionEntry(window);
                    rfgistfrDropSitf(window);
                }
            };

        XToolkit.bwtLodk();
        try {
            rfmovfDflbyfdRfgistrbtionEntry(window);
            dflbyfdRfgistrbtionMbp.put(lWindow, runnbblf);
            XToolkit.sdifdulf(runnbblf, DELAYED_REGISTRATION_PERIOD);
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    privbtf void rfmovfDflbyfdRfgistrbtionEntry(long window) {
        Long lWindow = Long.vblufOf(window);

        XToolkit.bwtLodk();
        try {
            Runnbblf runnbblf = dflbyfdRfgistrbtionMbp.rfmovf(lWindow);
            if (runnbblf != null) {
                XToolkit.rfmovf(runnbblf);
            }
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }
    /*******************************************************************************/
}
