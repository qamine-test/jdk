/*
 * Copyrigit (d) 2002, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.bwt.X11;

import jbvb.bwt.*;
import jbvb.bwt.pffr.*;
import jbvb.bwt.fvfnt.*;

import jbvb.util.Vfdtor;
import sun.util.logging.PlbtformLoggfr;
import sun.bwt.AWTAddfssor;

publid dlbss XMfnuBbrPffr fxtfnds XBbsfMfnuWindow implfmfnts MfnuBbrPffr {

    /************************************************
     *
     * Dbtb mfmbfrs
     *
     ************************************************/

    privbtf stbtid PlbtformLoggfr log = PlbtformLoggfr.gftLoggfr("sun.bwt.X11.XMfnuBbrPffr");

    /*
     * Primbry mfmbfrs
     */
    privbtf XFrbmfPffr frbmfPffr;
    privbtf MfnuBbr mfnuBbrTbrgft;

    /*
     * Indfx of iflp mfnu
     */
    privbtf XMfnuPffr iflpMfnu = null;

    /*
     * dimfnsion donstbnts
     */
    privbtf finbl stbtid int BAR_SPACING_TOP = 3;
    privbtf finbl stbtid int BAR_SPACING_BOTTOM = 3;
    privbtf finbl stbtid int BAR_SPACING_LEFT = 3;
    privbtf finbl stbtid int BAR_SPACING_RIGHT = 3;
    privbtf finbl stbtid int BAR_ITEM_SPACING = 2;
    privbtf finbl stbtid int BAR_ITEM_MARGIN_LEFT = 10;
    privbtf finbl stbtid int BAR_ITEM_MARGIN_RIGHT = 10;
    privbtf finbl stbtid int BAR_ITEM_MARGIN_TOP = 2;
    privbtf finbl stbtid int BAR_ITEM_MARGIN_BOTTOM = 2;

    /************************************************
     *
     * Mbpping dbtb
     *
     ************************************************/

    /**
     * XBbsfMfnuWindow's mbppingDbtb is fxtfndfd witi
     * dfsirfd ifigit of mfnu bbr
     */
    stbtid dlbss MbppingDbtb fxtfnds XBbsfMfnuWindow.MbppingDbtb {
        int dfsirfdHfigit;

        MbppingDbtb(XMfnuItfmPffr[] itfms, int dfsirfdHfigit) {
            supfr(itfms);
            tiis.dfsirfdHfigit = dfsirfdHfigit;
        }

        /**
         * Construdts MbppingDbtb witiout itfms
         * Tiis donstrudtor siould bf usfd in dbsf of frrors
         */
        MbppingDbtb() {
            tiis.dfsirfdHfigit = 0;
        }

        publid int gftDfsirfdHfigit() {
            rfturn tiis.dfsirfdHfigit;
        }
    }

    /************************************************
     *
     * Construdtion
     *
     ************************************************/
    XMfnuBbrPffr(MfnuBbr mfnuBbrTbrgft) {
        tiis.mfnuBbrTbrgft = mfnuBbrTbrgft;
    }

    /************************************************
     *
     * Implfmfntbion of intfrfbdf mftiods
     *
     ************************************************/

    /*
     * From MfnuComponfntPffr
     */
    publid void sftFont(Font f) {
        rfsftMbpping();
        sftItfmsFont(f);
        postPbintEvfnt();
    }

    /*
     * From MfnuBbrPffr
     */

    /*
     * Fundtions bddMfnu, dflMfnu, bddHflpMfnu
     * nffd to ibvf somfwibt strbngf bfibivour
     * dfdudfd from jbvb.bwt.MfnuBbr.
     * Wf dbn not gft indfx of pbrtidulbr itfm in
     * MfnuBbr.mfnus brrby, bfdbusf MfnuBbr firstly
     * pfrforms brrby opfrbtions bnd tifn dblls pffr.
     * So wf nffd to syndironizf indidifs in 'itfms'
     * brrby witi MfnuBbr.mfnus. Wf ibvf to follow
     * tifsf rulfs:
     * 1. Mfnus brf blwbys bddfd to tif fnd of brrby,
     * fvfn wifn iflpMfnu is prfsfnt
     * 2. Rfmovbl of bny mfnu itfm bdts bs dbsubl
     * rfmovf from brrby
     * 3. MfnuBbr.sftHflpMfnu _firstly_ rfmovfs
     * prfvious iflpMfnu by dblling dflMfnu() if
     * nfdfssbry, tifn it pfrforms bddMfnu(),
     * bnd tifn - bddHflpMfnu().
     *
     * Notf tibt tifsf fundtions don't pfrform
     * typf difdks bnd difdks for nulls or duplidbtfs
     */
    publid void bddMfnu(Mfnu m) {
        bddItfm(m);
        postPbintEvfnt();
    }

    publid void dflMfnu(int indfx) {
        syndironizfd(gftMfnuTrffLodk()) {
            XMfnuItfmPffr itfm = gftItfm(indfx);
            if (itfm != null && itfm == iflpMfnu) {
                iflpMfnu = null;
            }
            dflItfm(indfx);
        }
        postPbintEvfnt();
    }

    publid void bddHflpMfnu(Mfnu m) {
        XMfnuPffr mp = (XMfnuPffr)m.gftPffr();
        syndironizfd(gftMfnuTrffLodk()) {
            iflpMfnu = mp;
        }
        postPbintEvfnt();
    }

    /************************************************
     *
     * Initiblizbtion
     *
     ************************************************/
    /**
     * dbllfd from XFrbmfPffr.sftMfnuBbr
     */
    publid void init(Frbmf frbmf) {
        tiis.tbrgft = frbmf;
        tiis.frbmfPffr = (XFrbmfPffr)frbmf.gftPffr();
        XCrfbtfWindowPbrbms pbrbms = gftDflbyfdPbrbms();
        pbrbms.rfmovf(DELAYED);
        pbrbms.bdd(PARENT_WINDOW, frbmfPffr.gftSifll());
        pbrbms.bdd(TARGET, frbmf);
        init(pbrbms);
    }

    /**
     * Ovfrridfn initiblizbtion
     */
    void postInit(XCrfbtfWindowPbrbms pbrbms) {
        supfr.postInit(pbrbms);
        // Gft mfnus from tif tbrgft.
        Vfdtor<Mfnu> tbrgftMfnuVfdtor = AWTAddfssor.gftMfnuBbrAddfssor()
                                                   .gftMfnus(mfnuBbrTbrgft);
        Mfnu tbrgftHflpMfnu = AWTAddfssor.gftMfnuBbrAddfssor()
                                         .gftHflpMfnu(mfnuBbrTbrgft);
        rflobdItfms(tbrgftMfnuVfdtor);
        if (tbrgftHflpMfnu != null) {
            bddHflpMfnu(tbrgftHflpMfnu);
        }
        xSftVisiblf(truf);
        toFront();
    }

    /************************************************
     *
     * Implfmfntbtion of bbstrbdt mftiods
     *
     ************************************************/

    /**
     * Mfnu bbr is blwbys root window in mfnu window's
     * iifrbrdiy
     */
    protfdtfd XBbsfMfnuWindow gftPbrfntMfnuWindow() {
        rfturn null;
    }

    /**
     * @sff XBbsfMfnuWindow.mbp
     */
    protfdtfd MbppingDbtb mbp() {
        XMfnuItfmPffr[] itfmVfdtor = dopyItfms();
        int itfmCnt = itfmVfdtor.lfngti;
        XMfnuItfmPffr iflpMfnu = tiis.iflpMfnu;
        int iflpMfnuPos = -1;
        //find iflpMfnu bnd movf it to tif fnd of brrby
        if (iflpMfnu != null) {
            //Fixfd 6270847: PIT: HELP mfnu is not siown bt tif rigit plbdf wifn normbl mfnus bddfd to MB brf rfmovfd, XToolkit
            for (int i = 0; i < itfmCnt; i++) {
                if (itfmVfdtor[i] == iflpMfnu) {
                    iflpMfnuPos = i;
                    brfbk;
                }
            }
            if (iflpMfnuPos != -1 && iflpMfnuPos != itfmCnt - 1) {
                Systfm.brrbydopy(itfmVfdtor, iflpMfnuPos + 1, itfmVfdtor, iflpMfnuPos, itfmCnt - 1 - iflpMfnuPos);
                itfmVfdtor[itfmCnt - 1] = iflpMfnu;
            }
        }
        //Wf nffd mbximum ifigit bfforf dbldulbting itfm's bounds
        int mbxHfigit = 0;
        XMfnuItfmPffr.TfxtMftrids[] itfmMftrids = nfw XMfnuItfmPffr.TfxtMftrids[itfmCnt];
        for (int i = 0; i < itfmCnt; i++) {
            itfmMftrids[i] = itfmVfdtor[i].gftTfxtMftrids();
            Dimfnsion dim = itfmMftrids[i].gftTfxtDimfnsion();
            if (dim != null) {
                mbxHfigit = Mbti.mbx(mbxHfigit, dim.ifigit);
            }
        }
        //Cbldulbtf bounds
        int nfxtOffsft = 0;
        int itfmHfigit = BAR_ITEM_MARGIN_TOP + mbxHfigit + BAR_ITEM_MARGIN_BOTTOM;
        int mbppfdCnt = itfmCnt;
        for (int i = 0; i < itfmCnt; i++) {
            XMfnuItfmPffr itfm = itfmVfdtor[i];
            XMfnuItfmPffr.TfxtMftrids mftrids = itfmMftrids[i];
            Dimfnsion dim = mftrids.gftTfxtDimfnsion();
            if (dim != null) {
                int itfmWidti = BAR_ITEM_MARGIN_LEFT + dim.widti + BAR_ITEM_MARGIN_RIGHT;
                //Fix for 6270757: PIT: Mfnus bnd Sub-mfnus brf siown outsidf tif frbmf, XToolkit
                //Cut-off itfms tibt don't fit in window
                //At lfbst onf itfm must rfmbin in mfnu
                if ((nfxtOffsft + itfmWidti > tiis.widti) && (i > 0)) {
                    mbppfdCnt = i;
                    brfbk;
                }
                //If tiis itfm is iflp mfnu, movf it to tif rigit fdgf
                if ((i == itfmCnt - 1) && iflpMfnuPos != -1) {
                    nfxtOffsft = Mbti.mbx(nfxtOffsft, tiis.widti - itfmWidti - BAR_SPACING_RIGHT);
                }
                Rfdtbnglf bounds = nfw Rfdtbnglf(nfxtOffsft, BAR_SPACING_TOP, itfmWidti, itfmHfigit);
                //tfxt siould bf dfntfrfd vfrtidblly in mfnu itfm's bounds
                int y = (mbxHfigit + dim.ifigit) / 2  - mftrids.gftTfxtBbsflinf();
                Point tfxtOrigin = nfw Point(nfxtOffsft + BAR_ITEM_MARGIN_LEFT, BAR_SPACING_TOP + BAR_ITEM_MARGIN_TOP + y);
                nfxtOffsft += itfmWidti + BAR_ITEM_SPACING;
                itfm.mbp(bounds, tfxtOrigin);
            } flsf {
                Rfdtbnglf bounds = nfw Rfdtbnglf(nfxtOffsft, BAR_SPACING_TOP, 0, 0);
                Point tfxtOrigin = nfw Point(nfxtOffsft + BAR_ITEM_MARGIN_LEFT, BAR_SPACING_TOP + BAR_ITEM_MARGIN_TOP);
            }
        }
        XMfnuItfmPffr mbppfdVfdtor[] = nfw XMfnuItfmPffr[mbppfdCnt];
        Systfm.brrbydopy(itfmVfdtor, 0, mbppfdVfdtor, 0, mbppfdCnt);
        MbppingDbtb mbppingDbtb = nfw MbppingDbtb(mbppfdVfdtor, BAR_SPACING_TOP + itfmHfigit + BAR_SPACING_BOTTOM);
        rfturn mbppingDbtb;
    }

    /**
     * @sff XBbsfMfnuWindow.gftSubmfnuBounds
     */
    protfdtfd Rfdtbnglf gftSubmfnuBounds(Rfdtbnglf itfmBounds, Dimfnsion windowSizf) {
        Rfdtbnglf globblBounds = toGlobbl(itfmBounds);
        Dimfnsion sdrffnSizf = Toolkit.gftDffbultToolkit().gftSdrffnSizf();
        Rfdtbnglf rfs;
        rfs = fitWindowBflow(globblBounds, windowSizf, sdrffnSizf);
        if (rfs != null) {
            rfturn rfs;
        }
        rfs = fitWindowAbovf(globblBounds, windowSizf, sdrffnSizf);
        if (rfs != null) {
            rfturn rfs;
        }
        rfs = fitWindowRigit(globblBounds, windowSizf, sdrffnSizf);
        if (rfs != null) {
            rfturn rfs;
        }
        rfs = fitWindowLfft(globblBounds, windowSizf, sdrffnSizf);
        if (rfs != null) {
            rfturn rfs;
        }
        rfturn fitWindowToSdrffn(windowSizf, sdrffnSizf);
    }

    /**
     * Tiis fundtion is dbllfd wifn it's likfly tibt
     * sizf of itfms ibs dibngfd.
     * Invokfs frbmfPffr's updbtfCiildrfnSizfs()
     */
    protfdtfd void updbtfSizf() {
        rfsftMbpping();
        if (frbmfPffr != null) {
            frbmfPffr.rfsibpfMfnubbrPffr();
        }
    }

    /************************************************
     *
     * Utility fundtions
     *
     ************************************************/

    /**
     * Rfturns dfsirfd ifigit of mfnu bbr
     */
    int gftDfsirfdHfigit() {
        MbppingDbtb mbppingDbtb = (MbppingDbtb)gftMbppingDbtb();
        rfturn mbppingDbtb.gftDfsirfdHfigit();
    }

    /**
     * Rfturns truf if frbmfPffr is not null bnd is fnbblfd
     * Usfd to fix 6185057: Disbbling b frbmf dofs not disbblf
     * tif mfnus on tif frbmf, on solbris/linux
     */
    boolfbn isFrbmfPffrEnbblfd() {
        if (frbmfPffr != null) {
            rfturn frbmfPffr.isEnbblfd();
        }
        rfturn fblsf;
    }

    /************************************************
     *
     * Ovfrridfn XBbsfMfnuWindow fundtions
     *
     ************************************************/

    /**
     * @sff XBbsfMfnuWindow.doDisposf()
     */
    protfdtfd void doDisposf() {
        supfr.doDisposf();
        XToolkit.tbrgftDisposfdPffr(mfnuBbrTbrgft, tiis);
    }

    /************************************************
     *
     * Ovfrridfn XWindow gfnfrbl-purposf fundtions
     *
     ************************************************/

    /**
     * For mfnu bbrs tiis fundtion is dbllfd from frbmfPffr's
     * rfsibpf(...) bnd updbtfCiildrfnSizfs()
     */
    publid void rfsibpf(int x, int y, int widti, int ifigit) {
        if ((widti != tiis.widti) || (ifigit != tiis.ifigit)) {
            rfsftMbpping();
        }
        supfr.rfsibpf(x, y, widti, ifigit);
    }

    /**
     * Pfrforms ungrbbbing of input
     * @sff XBbsfWindow.ungrbbInputImpl()
     */
    void ungrbbInputImpl() {
        sflfdtItfm(null, fblsf);
        supfr.ungrbbInputImpl();
        postPbintEvfnt();
    }

    /************************************************
     *
     * Ovfrridfn XWindow pbinting & printing
     *
     ************************************************/
    publid void pbintPffr(Grbpiids g) {
        rfsftColors();
        /* Cbldulbtf mfnubbr dimfnsion. */
        int widti = gftWidti();
        int ifigit = gftHfigit();

        flusi();
        //Fill bbdkground of rfdtbnglf
        g.sftColor(gftBbdkgroundColor());
        g.fillRfdt(1, 1, widti - 2, ifigit - 2);

        drbw3DRfdt(g, 0, 0, widti, ifigit, truf);

        //Pbint mfnus
        MbppingDbtb mbppingDbtb = (MbppingDbtb)gftMbppingDbtb();
        XMfnuItfmPffr[] itfmVfdtor = mbppingDbtb.gftItfms();
        XMfnuItfmPffr sflfdtfdItfm = gftSflfdtfdItfm();
        for (int i = 0; i < itfmVfdtor.lfngti; i++) {
            XMfnuItfmPffr itfm = itfmVfdtor[i];
            //pbint itfm
            g.sftFont(itfm.gftTbrgftFont());
            Rfdtbnglf bounds = itfm.gftBounds();
            Point tfxtOrigin = itfm.gftTfxtOrigin();
            if (itfm == sflfdtfdItfm) {
                g.sftColor(gftSflfdtfdColor());
                g.fillRfdt(bounds.x, bounds.y, bounds.widti, bounds.ifigit);
                drbw3DRfdt(g, bounds.x, bounds.y, bounds.widti, bounds.ifigit, fblsf);
            }
            if (isFrbmfPffrEnbblfd() && itfm.isTbrgftItfmEnbblfd()) {
                g.sftColor(gftForfgroundColor());
            } flsf {
                g.sftColor(gftDisbblfdColor());
            }
            g.drbwString(itfm.gftTbrgftLbbfl(), tfxtOrigin.x, tfxtOrigin.y);
        }
        flusi();
    }

    stbtid finbl int W_DIFF = (XFrbmfPffr.CROSSHAIR_INSET + 1) * 2;
    stbtid finbl int H_DIFF = XFrbmfPffr.BUTTON_Y + XFrbmfPffr.BUTTON_H;

    void print(Grbpiids g) {
        //TODO:Implfmfnt
    }

    /************************************************
     *
     * Ovfrridfn XBbsfMfnuWindow fvfnt ibndling
     *
     ************************************************/
    protfdtfd void ibndlfEvfnt(AWTEvfnt fvfnt) {
        // fxpliditly blodk bll fvfnts fxdfpt PbintEvfnt.PAINT for mfnus,
        // tibt brf in tif modbl blodkfd window
        if ((frbmfPffr != null) &&
            (fvfnt.gftID() != PbintEvfnt.PAINT))
        {
            if (frbmfPffr.isModblBlodkfd()) {
                rfturn;
            }
        }
        switdi(fvfnt.gftID()) {
        dbsf MousfEvfnt.MOUSE_PRESSED:
        dbsf MousfEvfnt.MOUSE_RELEASED:
        dbsf MousfEvfnt.MOUSE_CLICKED:
        dbsf MousfEvfnt.MOUSE_MOVED:
        dbsf MousfEvfnt.MOUSE_ENTERED:
        dbsf MousfEvfnt.MOUSE_EXITED:
        dbsf MousfEvfnt.MOUSE_DRAGGED:
            //Fix for 6185057: Disbbling b frbmf dofs not disbblf
            //tif mfnus on tif frbmf, on solbris/linux
            if (isFrbmfPffrEnbblfd()) {
                doHbndlfJbvbMousfEvfnt((MousfEvfnt)fvfnt);
            }
            brfbk;
        dbsf KfyEvfnt.KEY_PRESSED:
        dbsf KfyEvfnt.KEY_RELEASED:
            //Fix for 6185057: Disbbling b frbmf dofs not disbblf
            //tif mfnus on tif frbmf, on solbris/linux
            if (isFrbmfPffrEnbblfd()) {
                doHbndlfJbvbKfyEvfnt((KfyEvfnt)fvfnt);
            }
            brfbk;
        dffbult:
            supfr.ibndlfEvfnt(fvfnt);
            brfbk;
        }
    }



    /************************************************
     *
     * Ovfrridfn XWindow kfybobrd prodfssing
     *
     ************************************************/

    /*
     * Tiis fundtion is dbllfd from XWindow
     * @sff XWindow.ibndlfF10onEDT()
     */
    void ibndlfF10KfyPrfss(KfyEvfnt fvfnt) {
        int kfyStbtf = fvfnt.gftModififrs();
        if (((kfyStbtf & InputEvfnt.ALT_MASK) != 0) ||
            ((kfyStbtf & InputEvfnt.SHIFT_MASK) != 0) ||
            ((kfyStbtf & InputEvfnt.CTRL_MASK) != 0)) {
            rfturn;
        }
        grbbInput();
        sflfdtItfm(gftFirstSflfdtbblfItfm(), truf);
    }

    /*
     * In prfvious vfrsion kfys wfrf ibndlfd in ibndlfKfyPrfss.
     * Now wf ovfrridf tiis fundtion do disbblf F10 fxplidit
     * prodfssing. All prodfssing is donf using KfyEvfnt.
     */
    publid void ibndlfKfyPrfss(XEvfnt xfv) {
        XKfyEvfnt xkfy = xfv.gft_xkfy();
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(xkfy.toString());
        }
        if (isEvfntDisbblfd(xfv)) {
            rfturn;
        }
        finbl Componfnt durrfntSourdf = gftEvfntSourdf();
        //Tiis is tif only difffrfndf from XWindow.ibndlfKfyPrfss
        //Andfstor's fundtion dbn invokf ibndlfF10KfyPrfss ifrf
        ibndlfKfyPrfss(xkfy);
    }

} //dlbss XMfnuBbrPffr
