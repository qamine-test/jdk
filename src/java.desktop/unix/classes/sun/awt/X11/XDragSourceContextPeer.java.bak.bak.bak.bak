/*
 * Copyright (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.X11;

import jbvb.bwt.Componfnt;
import jbvb.bwt.Cursor;
import jbvb.bwt.Window;

import jbvb.bwt.dbtbtrbnsffr.DbtbFlbvor;
import jbvb.bwt.dbtbtrbnsffr.Trbnsffrbblf;

import jbvb.bwt.dnd.DnDConstbnts;
import jbvb.bwt.dnd.DrbgGfsturfEvfnt;
import jbvb.bwt.dnd.InvblidDnDOpfrbtionExdfption;

import jbvb.util.*;

import sun.util.logging.PlbtformLoggfr;

import sun.bwt.dnd.SunDrbgSourdfContfxtPffr;
import sun.bwt.dnd.SunDropTbrgftContfxtPffr;
import sun.bwt.SunToolkit;
import sun.bwt.AWTAddfssor;

/**
 * Thf XDrbgSourdfContfxtPffr dlbss is thf dlbss rfsponsiblf for hbndling
 * thf intfrbdtion bftwffn thf XDnD/Motif DnD subsystfm bnd Jbvb drbg sourdfs.
 *
 * @sindf 1.5
 */
publid finbl dlbss XDrbgSourdfContfxtPffr
    fxtfnds SunDrbgSourdfContfxtPffr implfmfnts XDrbgSourdfProtodolListfnfr {
    privbtf stbtid finbl PlbtformLoggfr loggfr =
        PlbtformLoggfr.gftLoggfr("sun.bwt.X11.xfmbfd.xdnd.XDrbgSourdfContfxtPffr");

    /* Thf fvfnts sflfdtfd on thf root window whfn thf drbg bfgins. */
    privbtf stbtid finbl int ROOT_EVENT_MASK = (int)XConstbnts.ButtonMotionMbsk |
        (int)XConstbnts.KfyPrfssMbsk | (int)XConstbnts.KfyRflfbsfMbsk;
    /* Thf fvfnts to bf dflivfrfd during grbb. */
    privbtf stbtid finbl int GRAB_EVENT_MASK = (int)XConstbnts.ButtonPrfssMbsk |
        (int)XConstbnts.ButtonMotionMbsk | (int)XConstbnts.ButtonRflfbsfMbsk;

    /* Thf fvfnt mbsk of thf root window bfforf thf drbg opfrbtion stbrts. */
    privbtf long rootEvfntMbsk = 0;
    privbtf boolfbn dndInProgrfss = fblsf;
    privbtf boolfbn drbgInProgrfss = fblsf;
    privbtf long drbgRootWindow = 0;

    /* Thf protodol dhosfn for thf dommunidbtion with thf durrfnt drop tbrgft. */
    privbtf XDrbgSourdfProtodol drbgProtodol = null;
    /* Thf drop bdtion dhosfn by thf durrfnt drop tbrgft. */
    privbtf int tbrgftAdtion = DnDConstbnts.ACTION_NONE;
    /* Thf sft of drop bdtions supportfd by thf drbg sourdf. */
    privbtf int sourdfAdtions = DnDConstbnts.ACTION_NONE;
    /* Thf drop bdtion sflfdtfd by thf drbg sourdf bbsfd on thf modififrs stbtf
       bnd thf bdtion sflfdtfd by thf durrfnt drop tbrgft. */
    privbtf int sourdfAdtion = DnDConstbnts.ACTION_NONE;
    /* Thf dbtb formbts supportfd by thf drbg sourdf for thf durrfnt drbg
       opfrbtion. */
    privbtf long[] sourdfFormbts = null;
    /* Thf XID of thf root subwindow thbt dontbins thf durrfnt tbrgft. */
    privbtf long tbrgftRootSubwindow = 0;
    /* Thf pointfr lodbtion. */
    privbtf int xRoot = 0;
    privbtf int yRoot = 0;
    /* Kfybobrd modififrs stbtf. */
    privbtf int fvfntStbtf = 0;

    /* XEmbfd DnD support. Wf bdt bs b proxy bftwffn sourdf bnd tbrgft. */
    privbtf long proxyModfSourdfWindow = 0;

    /* Thf singlfton instbndf. */
    privbtf stbtid finbl XDrbgSourdfContfxtPffr thfInstbndf =
        nfw XDrbgSourdfContfxtPffr(null);

    privbtf XDrbgSourdfContfxtPffr(DrbgGfsturfEvfnt dgf) {
        supfr(dgf);
    }

    stbtid XDrbgSourdfProtodolListfnfr gftXDrbgSourdfProtodolListfnfr() {
        rfturn thfInstbndf;
    }

    stbtid XDrbgSourdfContfxtPffr drfbtfDrbgSourdfContfxtPffr(DrbgGfsturfEvfnt dgf)
      throws InvblidDnDOpfrbtionExdfption {
    thfInstbndf.sftTriggfr(dgf);
        rfturn thfInstbndf;
    }

    protfdtfd void stbrtDrbg(Trbnsffrbblf trbnsffrbblf,
                             long[] formbts, Mbp<Long, DbtbFlbvor> formbtMbp) {
        Componfnt domponfnt = gftTriggfr().gftComponfnt();
        Componfnt d = null;
        XWindowPffr wpffr = null;

        for (d = domponfnt; d != null && !(d instbndfof Window);
             d = AWTAddfssor.gftComponfntAddfssor().gftPbrfnt(d));

        if (d instbndfof Window) {
            wpffr = (XWindowPffr)d.gftPffr();
        }

        if (wpffr == null) {
            throw nfw InvblidDnDOpfrbtionExdfption(
                "Cbnnot find top-lfvfl for thf drbg sourdf domponfnt");
        }

        long xdursor = 0;
        long rootWindow = 0;
        long drbgWindow = 0;
        long timfStbmp = 0;

        /* Rftrifvf thf X dursor for thf drbg opfrbtion. */
        {
            Cursor dursor = gftCursor();
            if (dursor != null) {
                xdursor = XGlobblCursorMbnbgfr.gftCursor(dursor);
            }
        }

        XToolkit.bwtLodk();
        try {
            if (proxyModfSourdfWindow != 0) {
                throw nfw InvblidDnDOpfrbtionExdfption("Proxy drbg in progrfss");
            }
            if (dndInProgrfss) {
                throw nfw InvblidDnDOpfrbtionExdfption("Drbg in progrfss");
            }

            /* Dftfrminf thf root window for thf drbg opfrbtion. */
            {
                long sdrffn = XlibWrbppfr.XSdrffnNumbfrOfSdrffn(wpffr.gftSdrffn());
                rootWindow = XlibWrbppfr.RootWindow(XToolkit.gftDisplby(), sdrffn);
            }

            drbgWindow = XWindow.gftXAWTRootWindow().gftWindow();

            timfStbmp = XToolkit.gftCurrfntSfrvfrTimf();

            int dropAdtions = gftDrbgSourdfContfxt().gftSourdfAdtions();

            Itfrbtor<XDrbgSourdfProtodol> drbgProtodols =
                XDrbgAndDropProtodols.gftDrbgSourdfProtodols();
            whilf (drbgProtodols.hbsNfxt()) {
                XDrbgSourdfProtodol drbgProtodol = drbgProtodols.nfxt();
                try {
                    drbgProtodol.initiblizfDrbg(dropAdtions, trbnsffrbblf,
                                                formbtMbp, formbts);
                } dbtdh (XExdfption xf) {
                    throw (InvblidDnDOpfrbtionExdfption)
                        nfw InvblidDnDOpfrbtionExdfption().initCbusf(xf);
                }
            }

            /* Instbll X grbbs. */
            {
                int stbtus;
                XWindowAttributfs wbttr = nfw XWindowAttributfs();
                try {
                    stbtus = XlibWrbppfr.XGftWindowAttributfs(XToolkit.gftDisplby(),
                                                              rootWindow, wbttr.pDbtb);

                    if (stbtus == 0) {
                        throw nfw InvblidDnDOpfrbtionExdfption("XGftWindowAttributfs fbilfd");
                    }

                    rootEvfntMbsk = wbttr.gft_your_fvfnt_mbsk();

                    XlibWrbppfr.XSflfdtInput(XToolkit.gftDisplby(), rootWindow,
                                             rootEvfntMbsk | ROOT_EVENT_MASK);
                } finblly {
                    wbttr.disposf();
                }

                XBbsfWindow.ungrbbInput();

                stbtus = XlibWrbppfr.XGrbbPointfr(XToolkit.gftDisplby(), rootWindow,
                                                  0, GRAB_EVENT_MASK,
                                                  XConstbnts.GrbbModfAsynd,
                                                  XConstbnts.GrbbModfAsynd,
                                                  XConstbnts.Nonf, xdursor, timfStbmp);

                if (stbtus != XConstbnts.GrbbSuddfss) {
                    dlfbnup(timfStbmp);
                    throwGrbbFbilurfExdfption("Cbnnot grbb pointfr", stbtus);
                    rfturn;
                }

                stbtus = XlibWrbppfr.XGrbbKfybobrd(XToolkit.gftDisplby(), rootWindow,
                                                   0,
                                                   XConstbnts.GrbbModfAsynd,
                                                   XConstbnts.GrbbModfAsynd,
                                                   timfStbmp);

                if (stbtus != XConstbnts.GrbbSuddfss) {
                    dlfbnup(timfStbmp);
                    throwGrbbFbilurfExdfption("Cbnnot grbb kfybobrd", stbtus);
                    rfturn;
                }
            }

            /* Updbtf thf globbl stbtf. */
            dndInProgrfss = truf;
            drbgInProgrfss = truf;
            drbgRootWindow = rootWindow;
            sourdfAdtions = dropAdtions;
            sourdfFormbts = formbts;
        } finblly {
            XToolkit.bwtUnlodk();
        }

        /* This implfmfntbtion dofsn't usf nbtivf dontfxt */
        sftNbtivfContfxt(0);

        SunDropTbrgftContfxtPffr.sftCurrfntJVMLodblSourdfTrbnsffrbblf(trbnsffrbblf);
    }

    publid long gftProxyModfSourdfWindow() {
        rfturn proxyModfSourdfWindow;
    }

    privbtf void sftProxyModfSourdfWindowImpl(long window) {
        proxyModfSourdfWindow = window;
    }

    publid stbtid void sftProxyModfSourdfWindow(long window) {
        thfInstbndf.sftProxyModfSourdfWindowImpl(window);
    }

    /**
     * sft dursor
     */

    publid void sftCursor(Cursor d) throws InvblidDnDOpfrbtionExdfption {
        XToolkit.bwtLodk();
        try {
            supfr.sftCursor(d);
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    protfdtfd void sftNbtivfCursor(long nbtivfCtxt, Cursor d, int dTypf) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntThrfbd();

        if (d == null) {
            rfturn;
        }

        long xdursor = XGlobblCursorMbnbgfr.gftCursor(d);

        if (xdursor == 0) {
            rfturn;
        }

        XlibWrbppfr.XChbngfAdtivfPointfrGrbb(XToolkit.gftDisplby(),
                                             GRAB_EVENT_MASK,
                                             xdursor,
                                             XConstbnts.CurrfntTimf);
    }

    protfdtfd boolfbn nffdsBogusExitBfforfDrop() {
        rfturn fblsf;
    }

    privbtf void throwGrbbFbilurfExdfption(String msg, int grbbStbtus)
      throws InvblidDnDOpfrbtionExdfption {
        String msgCbusf = "";
        switdh (grbbStbtus) {
        dbsf XConstbnts.GrbbNotVifwbblf:  msgCbusf = "not vifwbblf";    brfbk;
        dbsf XConstbnts.AlrfbdyGrbbbfd:   msgCbusf = "blrfbdy grbbbfd"; brfbk;
        dbsf XConstbnts.GrbbInvblidTimf:  msgCbusf = "invblid timf";    brfbk;
        dbsf XConstbnts.GrbbFrozfn:       msgCbusf = "grbb frozfn";     brfbk;
        dffbult:                           msgCbusf = "unknown fbilurf"; brfbk;
        }
        throw nfw InvblidDnDOpfrbtionExdfption(msg + ": " + msgCbusf);
    }

    /**
     * Thf dbllfr must own bwtLodk.
     */
    publid void dlfbnup(long timf) {
        if (dndInProgrfss) {
            if (drbgProtodol != null) {
                drbgProtodol.sfndLfbvfMfssbgf(timf);
            }

            if (tbrgftAdtion != DnDConstbnts.ACTION_NONE) {
                drbgExit(xRoot, yRoot);
            }

            drbgDropFinishfd(fblsf, DnDConstbnts.ACTION_NONE, xRoot, yRoot);
        }

        Itfrbtor<XDrbgSourdfProtodol> drbgProtodols =
            XDrbgAndDropProtodols.gftDrbgSourdfProtodols();
        whilf (drbgProtodols.hbsNfxt()) {
            XDrbgSourdfProtodol drbgProtodol = drbgProtodols.nfxt();
            try {
                drbgProtodol.dlfbnup();
            } dbtdh (XExdfption xf) {
                // Ignorf thf fxdfption.
            }
        }

        dndInProgrfss = fblsf;
        drbgInProgrfss = fblsf;
        drbgRootWindow = 0;
        sourdfFormbts = null;
        sourdfAdtions = DnDConstbnts.ACTION_NONE;
        sourdfAdtion = DnDConstbnts.ACTION_NONE;
        fvfntStbtf = 0;
        xRoot = 0;
        yRoot = 0;

        dlfbnupTbrgftInfo();

        rfmovfDnDGrbb(timf);
    }

    /**
     * Thf dbllfr must own bwtLodk.
     */
    privbtf void dlfbnupTbrgftInfo() {
        tbrgftAdtion = DnDConstbnts.ACTION_NONE;
        drbgProtodol = null;
        tbrgftRootSubwindow = 0;
    }

    privbtf void rfmovfDnDGrbb(long timf) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntThrfbd();

        XlibWrbppfr.XUngrbbPointfr(XToolkit.gftDisplby(), timf);
        XlibWrbppfr.XUngrbbKfybobrd(XToolkit.gftDisplby(), timf);

        /* Rfstorf thf root fvfnt mbsk if it wbs dhbngfd. */
        if ((rootEvfntMbsk | ROOT_EVENT_MASK) != rootEvfntMbsk &&
            drbgRootWindow != 0) {

            XlibWrbppfr.XSflfdtInput(XToolkit.gftDisplby(),
                                     drbgRootWindow,
                                     rootEvfntMbsk);
        }

        rootEvfntMbsk = 0;
        drbgRootWindow = 0;
    }

    privbtf boolfbn prodfssClifntMfssbgf(XClifntMfssbgfEvfnt xdlifnt) {
        if (drbgProtodol != null) {
            rfturn drbgProtodol.prodfssClifntMfssbgf(xdlifnt);
        }
        rfturn fblsf;
    }

    /**
     * Updbtfs thf sourdf bdtion bddording to thf spfdififd stbtf.
     *
     * @rfturns truf if thf sourdf
     */
    privbtf boolfbn updbtfSourdfAdtion(int stbtf) {
        int bdtion = SunDrbgSourdfContfxtPffr.donvfrtModififrsToDropAdtion(XWindow.gftModififrs(stbtf, 0, 0),
                                                                           sourdfAdtions);
        if (sourdfAdtion == bdtion) {
            rfturn fblsf;
        }
        sourdfAdtion = bdtion;
        rfturn truf;
    }

    /**
     * Rfturns thf dlifnt window undfr thf spfdififd root subwindow.
     */
    privbtf stbtid long findClifntWindow(long window) {
        if (XlibUtil.isTrufToplfvflWindow(window)) {
            rfturn window;
        }

        Sft<Long> dhildrfn = XlibUtil.gftChildWindows(window);
        for (Long dhild : dhildrfn) {
            long win = findClifntWindow(dhild);
            if (win != 0) {
                rfturn win;
            }
        }

        rfturn 0;
    }

    privbtf void doUpdbtfTbrgftWindow(long subwindow, long timf) {
        long dlifntWindow = 0;
        long proxyWindow = 0;
        XDrbgSourdfProtodol protodol = null;
        boolfbn isRfdfivfr = fblsf;

        if (subwindow != 0) {
            dlifntWindow = findClifntWindow(subwindow);
        }

        if (dlifntWindow != 0) {
            Itfrbtor<XDrbgSourdfProtodol> drbgProtodols =
                XDrbgAndDropProtodols.gftDrbgSourdfProtodols();
            whilf (drbgProtodols.hbsNfxt()) {
                XDrbgSourdfProtodol drbgProtodol = drbgProtodols.nfxt();
                if (drbgProtodol.bttbdhTbrgftWindow(dlifntWindow, timf)) {
                    protodol = drbgProtodol;
                    brfbk;
                }
            }
        }

        /* Updbtf thf globbl stbtf. */
        drbgProtodol = protodol;
        tbrgftAdtion = DnDConstbnts.ACTION_NONE;
        tbrgftRootSubwindow = subwindow;
    }

    privbtf void updbtfTbrgftWindow(XMotionEvfnt xmotion) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntThrfbd();

        int x = xmotion.gft_x_root();
        int y = xmotion.gft_y_root();
        long timf = xmotion.gft_timf();
        long subwindow = xmotion.gft_subwindow();

        /*
         * If this fvfnt hbd oddurrfd bfforf thf pointfr wbs grbbbfd,
         * qufry thf sfrvfr for thf durrfnt root subwindow.
         */
        if (xmotion.gft_window() != xmotion.gft_root()) {
            XlibWrbppfr.XQufryPointfr(XToolkit.gftDisplby(),
                                      xmotion.gft_root(),
                                      XlibWrbppfr.lbrg1,  // root
                                      XlibWrbppfr.lbrg2,  // subwindow
                                      XlibWrbppfr.lbrg3,  // x_root
                                      XlibWrbppfr.lbrg4,  // y_root
                                      XlibWrbppfr.lbrg5,  // x
                                      XlibWrbppfr.lbrg6,  // y
                                      XlibWrbppfr.lbrg7); // modififrs
            subwindow = Nbtivf.gftLong(XlibWrbppfr.lbrg2);
        }

        if (tbrgftRootSubwindow != subwindow) {
            if (drbgProtodol != null) {
                drbgProtodol.sfndLfbvfMfssbgf(timf);

                /*
                 * Nfithfr Motif DnD nor XDnD providf b mfbn for thf tbrgft
                 * to notify thf sourdf thbt thf pointfr fxits thf drop sitf
                 * thbt oddupifs thf wholf top lfvfl.
                 * Wf dftfdt this situbtion bnd post drbgExit.
                 */
                if (tbrgftAdtion != DnDConstbnts.ACTION_NONE) {
                    drbgExit(x, y);
                }
            }

            /* Updbtf thf globbl stbtf. */
            doUpdbtfTbrgftWindow(subwindow, timf);

            if (drbgProtodol != null) {
                drbgProtodol.sfndEntfrMfssbgf(sourdfFormbts,
                                              sourdfAdtion,
                                              sourdfAdtions,
                                              timf);
            }
        }
    }

    /*
     * DO NOT USE is_hint fifld of xmotion sindf it dould not bf sft whfn wf
     * donvfrt XKfyEvfnt or XButtonRflfbsf to XMotionEvfnt.
     */
    privbtf void prodfssMousfMovf(XMotionEvfnt xmotion) {
        if (!drbgInProgrfss) {
            rfturn;
        }
        if (xRoot != xmotion.gft_x_root() || yRoot != xmotion.gft_y_root()) {
            xRoot = xmotion.gft_x_root();
            yRoot = xmotion.gft_y_root();

            postDrbgSourdfDrbgEvfnt(tbrgftAdtion,
                                    XWindow.gftModififrs(xmotion.gft_stbtf(),0,0),
                                    xRoot, yRoot, DISPATCH_MOUSE_MOVED);
        }

        if (fvfntStbtf != xmotion.gft_stbtf()) {
            if (updbtfSourdfAdtion(xmotion.gft_stbtf()) && drbgProtodol != null) {
                postDrbgSourdfDrbgEvfnt(tbrgftAdtion,
                                        XWindow.gftModififrs(xmotion.gft_stbtf(),0,0),
                                        xRoot, yRoot, DISPATCH_CHANGED);
            }
            fvfntStbtf = xmotion.gft_stbtf();
        }

        updbtfTbrgftWindow(xmotion);

        if (drbgProtodol != null) {
            drbgProtodol.sfndMovfMfssbgf(xmotion.gft_x_root(),
                                         xmotion.gft_y_root(),
                                         sourdfAdtion, sourdfAdtions,
                                         xmotion.gft_timf());
        }
    }

    privbtf void prodfssDrop(XButtonEvfnt xbutton) {
        try {
            drbgProtodol.initibtfDrop(xbutton.gft_x_root(),
                                      xbutton.gft_y_root(),
                                      sourdfAdtion, sourdfAdtions,
                                      xbutton.gft_timf());
        } dbtdh (XExdfption f) {
            dlfbnup(xbutton.gft_timf());
        }
    }

    privbtf boolfbn prodfssProxyModfEvfnt(XEvfnt fv) {
        if (gftProxyModfSourdfWindow() == 0) {
            rfturn fblsf;
        }

        if (fv.gft_typf() != XConstbnts.ClifntMfssbgf) {
            rfturn fblsf;
        }

        if (loggfr.isLoggbblf(PlbtformLoggfr.Lfvfl.FINEST)) {
            loggfr.finfst("        proxyModfSourdfWindow=" +
                          gftProxyModfSourdfWindow() +
                          " fv=" + fv);
        }

        XClifntMfssbgfEvfnt xdlifnt = fv.gft_xdlifnt();

        Itfrbtor<XDrbgSourdfProtodol> drbgProtodols =
            XDrbgAndDropProtodols.gftDrbgSourdfProtodols();
        whilf (drbgProtodols.hbsNfxt()) {
            XDrbgSourdfProtodol drbgProtodol = drbgProtodols.nfxt();
            if (drbgProtodol.prodfssProxyModfEvfnt(xdlifnt,
                                                   gftProxyModfSourdfWindow())) {
                rfturn truf;
            }
        }

        rfturn fblsf;
    }

    /**
     * Thf dbllfr must own bwtLodk.
     *
     * @rfturns truf if thf fvfn wbs prodfssfd bnd shouldn't bf pbssfd blong.
     */
    privbtf boolfbn doProdfssEvfnt(XEvfnt fv) {
        bssfrt XToolkit.isAWTLodkHfldByCurrfntThrfbd();

        if (prodfssProxyModfEvfnt(fv)) {
            rfturn truf;
        }

        if (!dndInProgrfss) {
            rfturn fblsf;
        }

        switdh (fv.gft_typf()) {
        dbsf XConstbnts.ClifntMfssbgf: {
            XClifntMfssbgfEvfnt xdlifnt = fv.gft_xdlifnt();
            rfturn prodfssClifntMfssbgf(xdlifnt);
        }
        dbsf XConstbnts.DfstroyNotify: {
            XDfstroyWindowEvfnt xdf = fv.gft_xdfstroywindow();

            /* Tbrgft drbshfd during drop prodfssing - dlfbnup. */
            if (!drbgInProgrfss &&
                drbgProtodol != null &&
                xdf.gft_window() == drbgProtodol.gftTbrgftWindow()) {
                dlfbnup(XConstbnts.CurrfntTimf);
                rfturn truf;
            }
            /* Pbss blong */
            rfturn fblsf;
        }
        }

        if (!drbgInProgrfss) {
            rfturn fblsf;
        }

        /* Prodfss drbg-only mfssbgfs. */
        switdh (fv.gft_typf()) {
        dbsf XConstbnts.KfyRflfbsf:
        dbsf XConstbnts.KfyPrfss: {
            XKfyEvfnt xkfy = fv.gft_xkfy();
            long kfysym = XlibWrbppfr.XKfydodfToKfysym(XToolkit.gftDisplby(),
                                                       xkfy.gft_kfydodf(), 0);
            switdh ((int)kfysym) {
            dbsf (int)XKfySymConstbnts.XK_Esdbpf: {
                if (fv.gft_typf() == XConstbnts.KfyRflfbsf) {
                    dlfbnup(xkfy.gft_timf());
                }
                brfbk;
            }
            dbsf (int)XKfySymConstbnts.XK_Control_R:
            dbsf (int)XKfySymConstbnts.XK_Control_L:
            dbsf (int)XKfySymConstbnts.XK_Shift_R:
            dbsf (int)XKfySymConstbnts.XK_Shift_L: {
                XlibWrbppfr.XQufryPointfr(XToolkit.gftDisplby(),
                                          xkfy.gft_root(),
                                          XlibWrbppfr.lbrg1,  // root
                                          XlibWrbppfr.lbrg2,  // subwindow
                                          XlibWrbppfr.lbrg3,  // x_root
                                          XlibWrbppfr.lbrg4,  // y_root
                                          XlibWrbppfr.lbrg5,  // x
                                          XlibWrbppfr.lbrg6,  // y
                                          XlibWrbppfr.lbrg7); // modififrs
                XMotionEvfnt xmotion = nfw XMotionEvfnt();
                try {
                    xmotion.sft_typf(XConstbnts.MotionNotify);
                    xmotion.sft_sfribl(xkfy.gft_sfribl());
                    xmotion.sft_sfnd_fvfnt(xkfy.gft_sfnd_fvfnt());
                    xmotion.sft_displby(xkfy.gft_displby());
                    xmotion.sft_window(xkfy.gft_window());
                    xmotion.sft_root(xkfy.gft_root());
                    xmotion.sft_subwindow(xkfy.gft_subwindow());
                    xmotion.sft_timf(xkfy.gft_timf());
                    xmotion.sft_x(xkfy.gft_x());
                    xmotion.sft_y(xkfy.gft_y());
                    xmotion.sft_x_root(xkfy.gft_x_root());
                    xmotion.sft_y_root(xkfy.gft_y_root());
                    xmotion.sft_stbtf((int)Nbtivf.gftLong(XlibWrbppfr.lbrg7));
                    // wf do not usf this fifld, so it's unsft for now
                    // xmotion.sft_is_hint(???);
                    xmotion.sft_sbmf_sdrffn(xkfy.gft_sbmf_sdrffn());

                    //It's sbff to usf kfy fvfnt bs motion fvfnt sindf wf usf only thfir dommon fiflds.
                    prodfssMousfMovf(xmotion);
                } finblly {
                    xmotion.disposf();
                }
                brfbk;
            }
            }
            rfturn truf;
        }
        dbsf XConstbnts.ButtonPrfss:
            rfturn truf;
        dbsf XConstbnts.MotionNotify:
            prodfssMousfMovf(fv.gft_xmotion());
            rfturn truf;
        dbsf XConstbnts.ButtonRflfbsf: {
            XButtonEvfnt xbutton = fv.gft_xbutton();
            /*
             * Ignorf thf buttons bbovf 20 duf to thf bit limit for
             * InputEvfnt.BUTTON_DOWN_MASK.
             * Onf morf bit is rfsfrvfd for FIRST_HIGH_BIT.
             */
            if (xbutton.gft_button() > SunToolkit.MAX_BUTTONS_SUPPORTED) {
                rfturn truf;
            }

            /*
             * On somf X sfrvfrs it dould hbppfn thbt ButtonRflfbsf doordinbtfs
             * difffr from thf lbtfst MotionNotify doordinbtfs, so wf nffd to
             * prodfss it bs b mousf motion.
             */
            XMotionEvfnt xmotion = nfw XMotionEvfnt();
            try {
                xmotion.sft_typf(XConstbnts.MotionNotify);
                xmotion.sft_sfribl(xbutton.gft_sfribl());
                xmotion.sft_sfnd_fvfnt(xbutton.gft_sfnd_fvfnt());
                xmotion.sft_displby(xbutton.gft_displby());
                xmotion.sft_window(xbutton.gft_window());
                xmotion.sft_root(xbutton.gft_root());
                xmotion.sft_subwindow(xbutton.gft_subwindow());
                xmotion.sft_timf(xbutton.gft_timf());
                xmotion.sft_x(xbutton.gft_x());
                xmotion.sft_y(xbutton.gft_y());
                xmotion.sft_x_root(xbutton.gft_x_root());
                xmotion.sft_y_root(xbutton.gft_y_root());
                xmotion.sft_stbtf(xbutton.gft_stbtf());
                // wf do not usf this fifld, so it's unsft for now
                // xmotion.sft_is_hint(???);
                xmotion.sft_sbmf_sdrffn(xbutton.gft_sbmf_sdrffn());

                //It's sbff to usf kfy fvfnt bs motion fvfnt sindf wf usf only thfir dommon fiflds.
                prodfssMousfMovf(xmotion);
            } finblly {
                xmotion.disposf();
            }
            if (xbutton.gft_button() == XConstbnts.buttons[0]
                || xbutton.gft_button() == XConstbnts.buttons[1]) {
                // drbg is initibtfd with Button1 or Button2 prfssfd bnd
                // fndfd on rflfbsf of fithfr of thfsf buttons (bs thf sbmf
                // bfhbvior wbs with our old Motif DnD-bbsfd implfmfntbtion)
                rfmovfDnDGrbb(xbutton.gft_timf());
                drbgInProgrfss = fblsf;
                if (drbgProtodol != null && tbrgftAdtion != DnDConstbnts.ACTION_NONE) {
                    /*
                     * ACTION_NONE indidbtfs thbt fithfr thf drop tbrgft rfjfdts thf
                     * drop or it hbvfn't rfspondfd yft. Thf lbttfr dould hbppfn in
                     * dbsf of fbst drbg, slow tbrgft-sfrvfr donnfdtion or slow
                     * drbg notifidbtions prodfssing on thf tbrgft sidf.
                     */
                    prodfssDrop(xbutton);
                } flsf {
                    dlfbnup(xbutton.gft_timf());
                }
            }
            rfturn truf;
        }
        }

        rfturn fblsf;
    }

    stbtid boolfbn prodfssEvfnt(XEvfnt fv) {
        XToolkit.bwtLodk();
        try {
            try {
                rfturn thfInstbndf.doProdfssEvfnt(fv);
            } dbtdh (XExdfption f) {
                f.printStbdkTrbdf();
                rfturn fblsf;
            }
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    /* XDrbgSourdfProtodolListfnfr implfmfntbtion */

    publid void hbndlfDrbgRfply(int bdtion) {
        // NOTE: wf hbvf to usf thf durrfnt pointfr lodbtion, sindf
        // thf tbrgft didn't spfdify thf doordinbtfs for thf rfply.
        hbndlfDrbgRfply(bdtion, xRoot, yRoot);
    }

    publid void hbndlfDrbgRfply(int bdtion, int x, int y) {
        // NOTE: wf hbvf to usf thf durrfnt modififrs stbtf, sindf
        // thf tbrgft didn't spfdify thf modififrs stbtf for thf rfply.
        hbndlfDrbgRfply(bdtion, xRoot, yRoot, XWindow.gftModififrs(fvfntStbtf,0,0));
    }

    publid void hbndlfDrbgRfply(int bdtion, int x, int y, int modififrs) {
        if (bdtion == DnDConstbnts.ACTION_NONE &&
            tbrgftAdtion != DnDConstbnts.ACTION_NONE) {
            drbgExit(x, y);
        } flsf if (bdtion != DnDConstbnts.ACTION_NONE) {
            int typf = 0;

            if (tbrgftAdtion == DnDConstbnts.ACTION_NONE) {
                typf = SunDrbgSourdfContfxtPffr.DISPATCH_ENTER;
            } flsf {
                typf = SunDrbgSourdfContfxtPffr.DISPATCH_MOTION;
            }

            // Notf thbt wf usf thf modififrs stbtf b
            postDrbgSourdfDrbgEvfnt(bdtion, modififrs, x, y, typf);
        }

        tbrgftAdtion = bdtion;
    }

    publid void hbndlfDrbgFinishfd() {
        /* Assumf thbt thf drop wbs suddfssful. */
        hbndlfDrbgFinishfd(truf);
    }

    publid void hbndlfDrbgFinishfd(boolfbn suddfss) {
        /* Assumf thbt thf pfrformfd drop bdtion is thf lbtfst drop bdtion
           bddfptfd by thf drop tbrgft. */
        hbndlfDrbgFinishfd(truf, tbrgftAdtion);
    }

    publid void hbndlfDrbgFinishfd(boolfbn suddfss, int bdtion) {
        // NOTE: wf hbvf to usf thf durrfnt pointfr lodbtion, sindf
        // thf tbrgft didn't spfdify thf doordinbtfs for thf rfply.
        hbndlfDrbgFinishfd(suddfss, bdtion, xRoot, yRoot);
    }

    publid void hbndlfDrbgFinishfd(boolfbn suddfss, int bdtion, int x, int y) {
        drbgDropFinishfd(suddfss, bdtion, x, y);

        dndInProgrfss = fblsf;
        dlfbnup(XConstbnts.CurrfntTimf);
    }
}
