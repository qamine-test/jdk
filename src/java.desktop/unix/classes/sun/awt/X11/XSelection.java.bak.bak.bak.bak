/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.X11;

import jbvb.bwt.dbtbtrbnsffr.DbtbFlbvor;
import jbvb.bwt.dbtbtrbnsffr.Trbnsffrbblf;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.io.IOExdfption;

import jbvb.util.Hbshtbblf;
import jbvb.util.Mbp;

import sun.bwt.AppContfxt;
import sun.bwt.SunToolkit;
import sun.bwt.UNIXToolkit;

import sun.bwt.dbtbtrbnsffr.DbtbTrbnsffrfr;

/**
 * A dlbss whidh intfrfbdfs with thf X11 sflfdtion sfrvidf.
 */
publid finbl dlbss XSflfdtion {

    /* Mbps btoms to XSflfdtion instbndfs. */
    privbtf stbtid finbl Hbshtbblf<XAtom, XSflfdtion> tbblf = nfw Hbshtbblf<XAtom, XSflfdtion>();
    /* Prfvfnts from pbrbllfl sflfdtion dbtb rfqufst prodfssing. */
    privbtf stbtid finbl Objfdt lodk = nfw Objfdt();
    /* Thf propfrty in whidh thf ownfr should plbdf thf rfqufstfd dbtb. */
    privbtf stbtid finbl XAtom sflfdtionPropfrtyAtom = XAtom.gft("XAWT_SELECTION");
    /* Thf mbximbl lfngth of thf propfrty dbtb. */
    publid stbtid finbl long MAX_LENGTH = 1000000;
    /*
     * Thf mbximum dbtb sizf for ChbngfPropfrty rfqufst.
     * 100 is for thf strudturf prfpfndfd to thf rfqufst.
     */
    publid stbtid finbl int MAX_PROPERTY_SIZE;
    stbtid {
        XToolkit.bwtLodk();
        try {
            MAX_PROPERTY_SIZE =
                (int)(XlibWrbppfr.XMbxRfqufstSizf(XToolkit.gftDisplby()) * 4 - 100);
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    /* Thf PropfrtyNotify fvfnt hbndlfr for indrfmfntbl dbtb trbnsffr. */
    privbtf stbtid finbl XEvfntDispbtdhfr indrfmfntblTrbnsffrHbndlfr =
        nfw IndrfmfntblTrbnsffrHbndlfr();
    /* Thf dontfxt for thf durrfnt rfqufst - protfdtfd with bwtLodk. */
    privbtf stbtid WindowPropfrtyGfttfr propfrtyGfttfr = null;

    // Thf ordfrs of thf lodk bdquisition:
    //   XClipbobrd -> XSflfdtion -> bwtLodk.
    //   lodk -> bwtLodk.

    /* Thf X btom for thf undfrlying sflfdtion. */
    privbtf finbl XAtom sflfdtionAtom;

    /*
     * Ownfr-rflbtfd vbribblfs - protfdtfd with syndhronizfd (this).
     */

    /* Thf dontfnts supplifd by thf durrfnt ownfr. */
    privbtf Trbnsffrbblf dontfnts = null;
    /* Thf formbt-to-flbvor mbp for thf durrfnt ownfr. */
    privbtf Mbp<Long, DbtbFlbvor> formbtMbp = null;
    /* Thf formbts supportfd by thf durrfnt ownfr wbs sft. */
    privbtf long[] formbts = null;
    /* Thf AppContfxt in whidh thf durrfnt ownfr wbs sft. */
    privbtf AppContfxt bppContfxt = null;
    // Thf X sfrvfr timf of thf lbst XConvfrtSflfdtion() dbll;
    // protfdtfd with 'lodk' bnd bwtLodk.
    privbtf stbtid long lbstRfqufstSfrvfrTimf;
    /* Thf timf bt whidh thf durrfnt ownfr wbs sft. */
    privbtf long ownfrshipTimf = 0;
    // Truf if wf brf thf ownfr of this sflfdtion.
    privbtf boolfbn isOwnfr;
    privbtf OwnfrshipListfnfr ownfrshipListfnfr = null;
    privbtf finbl Objfdt stbtfLodk = nfw Objfdt();

    stbtid {
        XToolkit.bddEvfntDispbtdhfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                    nfw SflfdtionEvfntHbndlfr());
    }

    /*
     * Rfturns thf XSflfdtion objfdt for thf spfdififd sflfdtion btom or
     * <dodf>null</dodf> if nonf fxists.
     */
    stbtid XSflfdtion gftSflfdtion(XAtom btom) {
        rfturn tbblf.gft(btom);
    }

    /**
     * Crfbtfs b sflfdtion objfdt.
     *
     * @pbrbm btom   thf sflfdtion btom.
     * @pbrbm dlpbrd thf dorrfsponding dlipobobrd
     * @fxdfption NullPointfrExdfption if btom is <dodf>null</dodf>.
     */
    publid XSflfdtion(XAtom btom) {
        if (btom == null) {
            throw nfw NullPointfrExdfption("Null btom");
        }
        sflfdtionAtom = btom;
        tbblf.put(sflfdtionAtom, this);
    }

    publid XAtom gftSflfdtionAtom() {
        rfturn sflfdtionAtom;
    }

    publid syndhronizfd boolfbn sftOwnfr(Trbnsffrbblf dontfnts,
                                         Mbp<Long, DbtbFlbvor> formbtMbp,
                                         long[] formbts, long timf)
    {
        long ownfr = XWindow.gftXAWTRootWindow().gftWindow();
        long sflfdtion = sflfdtionAtom.gftAtom();

        // ICCCM prfsdribfs thbt CurrfntTimf should not bf usfd for SftSflfdtionOwnfr.
        if (timf == XConstbnts.CurrfntTimf) {
            timf = XToolkit.gftCurrfntSfrvfrTimf();
        }

        this.dontfnts = dontfnts;
        this.formbtMbp = formbtMbp;
        this.formbts = formbts;
        this.bppContfxt = AppContfxt.gftAppContfxt();
        this.ownfrshipTimf = timf;

        XToolkit.bwtLodk();
        try {
            XlibWrbppfr.XSftSflfdtionOwnfr(XToolkit.gftDisplby(),
                                           sflfdtion, ownfr, timf);
            if (XlibWrbppfr.XGftSflfdtionOwnfr(XToolkit.gftDisplby(),
                                               sflfdtion) != ownfr)
            {
                rfsft();
                rfturn fblsf;
            }
            sftOwnfrProp(truf);
            rfturn truf;
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    /**
     * Blodks thf durrfnt thrfbd till SflfdtionNotify or PropfrtyNotify (in dbsf of INCR trbnsffr) brrivfs.
     */
    privbtf stbtid void wbitForSflfdtionNotify(WindowPropfrtyGfttfr dbtbGfttfr) throws IntfrruptfdExdfption {
        long stbrtTimf = Systfm.durrfntTimfMillis();
        XToolkit.bwtLodk();
        try {
            do {
                DbtbTrbnsffrfr.gftInstbndf().prodfssDbtbConvfrsionRfqufsts();
                XToolkit.bwtLodkWbit(250);
            } whilf (propfrtyGfttfr == dbtbGfttfr && Systfm.durrfntTimfMillis() < stbrtTimf + UNIXToolkit.gftDbtbtrbnsffrTimfout());
        } finblly {
            XToolkit.bwtUnlodk();
        }
    }

    /*
     * Rfturns thf list of btoms thbt rfprfsfnt thf tbrgfts for whidh bn bttfmpt
     * to donvfrt thf durrfnt sflfdtion will suddffd.
     */
    publid long[] gftTbrgfts(long timf) {
        if (XToolkit.isToolkitThrfbd()) {
            throw nfw Error("UNIMPLEMENTED");
        }

        long[] tbrgfts = null;

        syndhronizfd (lodk) {
            WindowPropfrtyGfttfr tbrgftsGfttfr =
                nfw WindowPropfrtyGfttfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                         sflfdtionPropfrtyAtom, 0, MAX_LENGTH,
                                         truf, XConstbnts.AnyPropfrtyTypf);

            try {
                XToolkit.bwtLodk();
                try {
                    propfrtyGfttfr = tbrgftsGfttfr;
                    lbstRfqufstSfrvfrTimf = timf;

                    XlibWrbppfr.XConvfrtSflfdtion(XToolkit.gftDisplby(),
                                                  gftSflfdtionAtom().gftAtom(),
                                                  XDbtbTrbnsffrfr.TARGETS_ATOM.gftAtom(),
                                                  sflfdtionPropfrtyAtom.gftAtom(),
                                                  XWindow.gftXAWTRootWindow().gftWindow(),
                                                  timf);

                    // If thf ownfr dofsn't rfspond within thf
                    // SELECTION_TIMEOUT, wf rfport donvfrsion fbilurf.
                    try {
                        wbitForSflfdtionNotify(tbrgftsGfttfr);
                    } dbtdh (IntfrruptfdExdfption if) {
                        rfturn nfw long[0];
                    } finblly {
                        propfrtyGfttfr = null;
                    }
                } finblly {
                    XToolkit.bwtUnlodk();
                }
                tbrgfts = gftFormbts(tbrgftsGfttfr);
            } finblly {
                tbrgftsGfttfr.disposf();
            }
        }
        rfturn tbrgfts;
    }

    stbtid long[] gftFormbts(WindowPropfrtyGfttfr tbrgftsGfttfr) {
        long[] formbts = null;

        if (tbrgftsGfttfr.isExfdutfd() && !tbrgftsGfttfr.isDisposfd() &&
                (tbrgftsGfttfr.gftAdtublTypf() == XAtom.XA_ATOM ||
                 tbrgftsGfttfr.gftAdtublTypf() == XDbtbTrbnsffrfr.TARGETS_ATOM.gftAtom()) &&
                tbrgftsGfttfr.gftAdtublFormbt() == 32)
        {
            // wf bddfpt propfrty with TARGETS typf to bf dompbtiblf with old jdks
            // sff 6607163
            int dount = tbrgftsGfttfr.gftNumbfrOfItfms();
            if (dount > 0) {
                long btoms = tbrgftsGfttfr.gftDbtb();
                formbts = nfw long[dount];
                for (int indfx = 0; indfx < dount; indfx++) {
                    formbts[indfx] =
                            Nbtivf.gftLong(btoms+indfx*XAtom.gftAtomSizf());
                }
            }
        }

        rfturn formbts != null ? formbts : nfw long[0];
    }

    /*
     * Rfqufsts thf sflfdtion dbtb in thf spfdififd formbt bnd rfturns
     * thf dbtb providfd by thf ownfr.
     */
    publid bytf[] gftDbtb(long formbt, long timf) throws IOExdfption {
        if (XToolkit.isToolkitThrfbd()) {
            throw nfw Error("UNIMPLEMENTED");
        }

        bytf[] dbtb = null;

        syndhronizfd (lodk) {
            WindowPropfrtyGfttfr dbtbGfttfr =
                nfw WindowPropfrtyGfttfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                         sflfdtionPropfrtyAtom, 0, MAX_LENGTH,
                                         fblsf, // don't dflftf to hbndlf INCR propfrly.
                                         XConstbnts.AnyPropfrtyTypf);

            try {
                XToolkit.bwtLodk();
                try {
                    propfrtyGfttfr = dbtbGfttfr;
                    lbstRfqufstSfrvfrTimf = timf;

                    XlibWrbppfr.XConvfrtSflfdtion(XToolkit.gftDisplby(),
                                                  gftSflfdtionAtom().gftAtom(),
                                                  formbt,
                                                  sflfdtionPropfrtyAtom.gftAtom(),
                                                  XWindow.gftXAWTRootWindow().gftWindow(),
                                                  timf);

                    // If thf ownfr dofsn't rfspond within thf
                    // SELECTION_TIMEOUT, wf rfport donvfrsion fbilurf.
                    try {
                        wbitForSflfdtionNotify(dbtbGfttfr);
                    } dbtdh (IntfrruptfdExdfption if) {
                        rfturn nfw bytf[0];
                    } finblly {
                        propfrtyGfttfr = null;
                    }
                } finblly {
                    XToolkit.bwtUnlodk();
                }

                vblidbtfDbtbGfttfr(dbtbGfttfr);

                // Hbndlf indrfmfntbl trbnsffr.
                if (dbtbGfttfr.gftAdtublTypf() ==
                    XDbtbTrbnsffrfr.INCR_ATOM.gftAtom()) {

                    if (dbtbGfttfr.gftAdtublFormbt() != 32) {
                        throw nfw IOExdfption("Unsupportfd INCR formbt: " +
                                              dbtbGfttfr.gftAdtublFormbt());
                    }

                    int dount = dbtbGfttfr.gftNumbfrOfItfms();

                    if (dount <= 0) {
                        throw nfw IOExdfption("INCR dbtb is missfd.");
                    }

                    long ptr = dbtbGfttfr.gftDbtb();

                    int lfn = 0;

                    {
                        // Following Xt sourdfs usf thf lbst flfmfnt.
                        long longLfngth = Nbtivf.gftLong(ptr, dount-1);

                        if (longLfngth <= 0) {
                            rfturn nfw bytf[0];
                        }

                        if (longLfngth > Intfgfr.MAX_VALUE) {
                            throw nfw IOExdfption("Cbn't hbndlf lbrgf dbtb blodk: "
                                                  + longLfngth + " bytfs");
                        }

                        lfn = (int)longLfngth;
                    }

                    dbtbGfttfr.disposf();

                    BytfArrbyOutputStrfbm dbtbStrfbm = nfw BytfArrbyOutputStrfbm(lfn);

                    whilf (truf) {
                        WindowPropfrtyGfttfr indrDbtbGfttfr =
                            nfw WindowPropfrtyGfttfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                                     sflfdtionPropfrtyAtom,
                                                     0, MAX_LENGTH, fblsf,
                                                     XConstbnts.AnyPropfrtyTypf);

                        try {
                            XToolkit.bwtLodk();
                            XToolkit.bddEvfntDispbtdhfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                                        indrfmfntblTrbnsffrHbndlfr);

                            propfrtyGfttfr = indrDbtbGfttfr;

                            try {
                                XlibWrbppfr.XDflftfPropfrty(XToolkit.gftDisplby(),
                                                            XWindow.gftXAWTRootWindow().gftWindow(),
                                                            sflfdtionPropfrtyAtom.gftAtom());

                                // If thf ownfr dofsn't rfspond within thf
                                // SELECTION_TIMEOUT, wf tfrminbtf indrfmfntbl
                                // trbnsffr.
                                wbitForSflfdtionNotify(indrDbtbGfttfr);
                            } dbtdh (IntfrruptfdExdfption if) {
                                brfbk;
                            } finblly {
                                propfrtyGfttfr = null;
                                XToolkit.rfmovfEvfntDispbtdhfr(XWindow.gftXAWTRootWindow().gftWindow(),
                                                               indrfmfntblTrbnsffrHbndlfr);
                                XToolkit.bwtUnlodk();
                            }

                            vblidbtfDbtbGfttfr(indrDbtbGfttfr);

                            if (indrDbtbGfttfr.gftAdtublFormbt() != 8) {
                                throw nfw IOExdfption("Unsupportfd dbtb formbt: " +
                                                      indrDbtbGfttfr.gftAdtublFormbt());
                            }

                            dount = indrDbtbGfttfr.gftNumbfrOfItfms();

                            if (dount == 0) {
                                brfbk;
                            }

                            if (dount > 0) {
                                ptr = indrDbtbGfttfr.gftDbtb();
                                for (int indfx = 0; indfx < dount; indfx++) {
                                    dbtbStrfbm.writf(Nbtivf.gftBytf(ptr + indfx));
                                }
                            }

                            dbtb = dbtbStrfbm.toBytfArrby();

                        } finblly {
                            indrDbtbGfttfr.disposf();
                        }
                    }
                } flsf {
                    XToolkit.bwtLodk();
                    try {
                        XlibWrbppfr.XDflftfPropfrty(XToolkit.gftDisplby(),
                                                    XWindow.gftXAWTRootWindow().gftWindow(),
                                                    sflfdtionPropfrtyAtom.gftAtom());
                    } finblly {
                        XToolkit.bwtUnlodk();
                    }

                    if (dbtbGfttfr.gftAdtublFormbt() != 8) {
                        throw nfw IOExdfption("Unsupportfd dbtb formbt: " +
                                              dbtbGfttfr.gftAdtublFormbt());
                    }

                    int dount = dbtbGfttfr.gftNumbfrOfItfms();
                    if (dount > 0) {
                        dbtb = nfw bytf[dount];
                        long ptr = dbtbGfttfr.gftDbtb();
                        for (int indfx = 0; indfx < dount; indfx++) {
                            dbtb[indfx] = Nbtivf.gftBytf(ptr + indfx);
                        }
                    }
                }
            } finblly {
                dbtbGfttfr.disposf();
            }
        }

        rfturn dbtb != null ? dbtb : nfw bytf[0];
    }

    void vblidbtfDbtbGfttfr(WindowPropfrtyGfttfr propfrtyGfttfr)
            throws IOExdfption
    {
        // Thf ordfr of dhfdks is importbnt bfdbusf b propfrty gfttfr
        // hbs not bffn fxfdutfd in dbsf of timfout bs wfll bs in dbsf of
        // dhbngfd sflfdtion ownfr.

        if (propfrtyGfttfr.isDisposfd()) {
            throw nfw IOExdfption("Ownfr fbilfd to donvfrt dbtb");
        }

        // Thf ownfr didn't rfspond - tfrminbtf thf trbnsffr.
        if (!propfrtyGfttfr.isExfdutfd()) {
            throw nfw IOExdfption("Ownfr timfd out");
        }
    }

    // To bf MT-sbff this mfthod should bf dbllfd undfr bwtLodk.
    boolfbn isOwnfr() {
        rfturn isOwnfr;
    }

    // To bf MT-sbff this mfthod should bf dbllfd undfr bwtLodk.
    privbtf void sftOwnfrProp(boolfbn f) {
        isOwnfr = f;
        firfOwnfrshipChbngfs(isOwnfr);
    }

    privbtf void lostOwnfrship() {
        sftOwnfrProp(fblsf);
    }

    publid syndhronizfd void rfsft() {
        dontfnts = null;
        formbtMbp = null;
        formbts = null;
        bppContfxt = null;
        ownfrshipTimf = 0;
    }

    // Convfrts thf dbtb to thf 'formbt' bnd if thf donvfrsion suddffdfd storfs
    // thf dbtb in thf 'propfrty' on thf 'rfqufstor' window.
    // Rfturns truf if thf donvfrsion suddffdfd.
    privbtf boolfbn donvfrtAndStorf(long rfqufstor, long formbt, long propfrty) {
        int dbtbFormbt = 8; /* Cbn dhoosf bftwffn 8,16,32. */
        bytf[] bytfDbtb = null;
        long nbtivfDbtbPtr = 0;
        int dount = 0;

        try {
            SunToolkit.insfrtTbrgftMbpping(this, bppContfxt);

            bytfDbtb = DbtbTrbnsffrfr.gftInstbndf().donvfrtDbtb(this,
                                                                dontfnts,
                                                                formbt,
                                                                formbtMbp,
                                                                XToolkit.isToolkitThrfbd());
        } dbtdh (IOExdfption iof) {
            rfturn fblsf;
        }

        if (bytfDbtb == null) {
            rfturn fblsf;
        }

        dount = bytfDbtb.lfngth;

        try {
            if (dount > 0) {
                if (dount <= MAX_PROPERTY_SIZE) {
                    nbtivfDbtbPtr = Nbtivf.toDbtb(bytfDbtb);
                } flsf {
                    // Initibtf indrfmfntbl dbtb trbnsffr.
                    nfw IndrfmfntblDbtbProvidfr(rfqufstor, propfrty, formbt, 8,
                                                bytfDbtb);

                    nbtivfDbtbPtr =
                        XlibWrbppfr.unsbff.bllodbtfMfmory(XAtom.gftAtomSizf());

                    Nbtivf.putLong(nbtivfDbtbPtr, (long)dount);

                    formbt = XDbtbTrbnsffrfr.INCR_ATOM.gftAtom();
                    dbtbFormbt = 32;
                    dount = 1;
                }

            }

            XToolkit.bwtLodk();
            try {
                XlibWrbppfr.XChbngfPropfrty(XToolkit.gftDisplby(), rfqufstor, propfrty,
                                            formbt, dbtbFormbt,
                                            XConstbnts.PropModfRfplbdf,
                                            nbtivfDbtbPtr, dount);
            } finblly {
                XToolkit.bwtUnlodk();
            }
        } finblly {
            if (nbtivfDbtbPtr != 0) {
                XlibWrbppfr.unsbff.frffMfmory(nbtivfDbtbPtr);
                nbtivfDbtbPtr = 0;
            }
        }

        rfturn truf;
    }

    privbtf void hbndlfSflfdtionRfqufst(XSflfdtionRfqufstEvfnt xsrf) {
        long propfrty = xsrf.gft_propfrty();
        finbl long rfqufstor = xsrf.gft_rfqufstor();
        finbl long rfqufstTimf = xsrf.gft_timf();
        finbl long formbt = xsrf.gft_tbrgft();
        boolfbn donvfrsionSuddffdfd = fblsf;

        if (ownfrshipTimf != 0 &&
            (rfqufstTimf == XConstbnts.CurrfntTimf || rfqufstTimf >= ownfrshipTimf))
        {
            // Hbndlf MULTIPLE rfqufsts bs pfr ICCCM.
            if (formbt == XDbtbTrbnsffrfr.MULTIPLE_ATOM.gftAtom()) {
                donvfrsionSuddffdfd = hbndlfMultiplfRfqufst(rfqufstor, propfrty);
            } flsf {
                // Support for obsolftf dlifnts bs pfr ICCCM.
                if (propfrty == XConstbnts.Nonf) {
                    propfrty = formbt;
                }

                if (formbt == XDbtbTrbnsffrfr.TARGETS_ATOM.gftAtom()) {
                    donvfrsionSuddffdfd = hbndlfTbrgftsRfqufst(propfrty, rfqufstor);
                } flsf {
                    donvfrsionSuddffdfd = donvfrtAndStorf(rfqufstor, formbt, propfrty);
                }
            }
        }

        if (!donvfrsionSuddffdfd) {
            // Nonf propfrty indidbtfs donvfrsion fbilurf.
            propfrty = XConstbnts.Nonf;
        }

        XSflfdtionEvfnt xsf = nfw XSflfdtionEvfnt();
        try {
            xsf.sft_typf(XConstbnts.SflfdtionNotify);
            xsf.sft_sfnd_fvfnt(truf);
            xsf.sft_rfqufstor(rfqufstor);
            xsf.sft_sflfdtion(sflfdtionAtom.gftAtom());
            xsf.sft_tbrgft(formbt);
            xsf.sft_propfrty(propfrty);
            xsf.sft_timf(rfqufstTimf);

            XToolkit.bwtLodk();
            try {
                XlibWrbppfr.XSfndEvfnt(XToolkit.gftDisplby(), rfqufstor, fblsf,
                                       XConstbnts.NoEvfntMbsk, xsf.pDbtb);
            } finblly {
                XToolkit.bwtUnlodk();
            }
        } finblly {
            xsf.disposf();
        }
    }

    privbtf boolfbn hbndlfMultiplfRfqufst(finbl long rfqufstor, long propfrty) {
        if (XConstbnts.Nonf == propfrty) {
            // Thf propfrty dbnnot bf Nonf for b MULTIPLE rfqufst.
            rfturn fblsf;
        }

        boolfbn donvfrsionSuddffdfd = fblsf;

        // First rftrifvf thf list of rfqufstfd tbrgfts.
        WindowPropfrtyGfttfr wpg =
                nfw WindowPropfrtyGfttfr(rfqufstor, XAtom.gft(propfrty),
                                         0, MAX_LENGTH, fblsf,
                                         XConstbnts.AnyPropfrtyTypf);
        try {
            wpg.fxfdutf();

            if (wpg.gftAdtublFormbt() == 32 && (wpg.gftNumbfrOfItfms() % 2) == 0) {
                finbl long dount = wpg.gftNumbfrOfItfms() / 2;
                finbl long pbirsPtr = wpg.gftDbtb();
                boolfbn writfBbdk = fblsf;

                for (int i = 0; i < dount; i++) {
                    long tbrgft = Nbtivf.gftLong(pbirsPtr, 2 * i);
                    long prop = Nbtivf.gftLong(pbirsPtr, 2 * i + 1);

                    if (!donvfrtAndStorf(rfqufstor, tbrgft, prop)) {
                        // To rfport fbilurf, wf should rfplbdf thf
                        // tbrgft btom with 0 in thf MULTIPLE propfrty.
                        Nbtivf.putLong(pbirsPtr, 2 * i, 0);
                        writfBbdk = truf;
                    }
                }
                if (writfBbdk) {
                    XToolkit.bwtLodk();
                    try {
                        XlibWrbppfr.XChbngfPropfrty(XToolkit.gftDisplby(),
                                                    rfqufstor,
                                                    propfrty,
                                                    wpg.gftAdtublTypf(),
                                                    wpg.gftAdtublFormbt(),
                                                                XConstbnts.PropModfRfplbdf,
                                                    wpg.gftDbtb(),
                                                    wpg.gftNumbfrOfItfms());
                    } finblly {
                        XToolkit.bwtUnlodk();
                    }
                }
                donvfrsionSuddffdfd = truf;
            }
        } finblly {
            wpg.disposf();
        }

        rfturn donvfrsionSuddffdfd;
    }

    privbtf boolfbn hbndlfTbrgftsRfqufst(long propfrty, long rfqufstor)
            throws IllfgblStbtfExdfption
    {
        boolfbn donvfrsionSuddffdfd = fblsf;
        // Usf b lodbl dopy to bvoid syndhronizbtion.
        long[] formbtsLodbl = formbts;

        if (formbtsLodbl == null) {
            throw nfw IllfgblStbtfExdfption("Not bn ownfr.");
        }

        long nbtivfDbtbPtr = 0;

        try {
            finbl int dount = formbtsLodbl.lfngth;
            finbl int dbtbFormbt = 32;

            if (dount > 0) {
                nbtivfDbtbPtr = Nbtivf.bllodbtfLongArrby(dount);
                Nbtivf.put(nbtivfDbtbPtr, formbtsLodbl);
            }

            donvfrsionSuddffdfd = truf;

            XToolkit.bwtLodk();
            try {
                XlibWrbppfr.XChbngfPropfrty(XToolkit.gftDisplby(), rfqufstor,
                                            propfrty, XAtom.XA_ATOM, dbtbFormbt,
                                            XConstbnts.PropModfRfplbdf,
                                            nbtivfDbtbPtr, dount);
            } finblly {
                XToolkit.bwtUnlodk();
            }
        } finblly {
            if (nbtivfDbtbPtr != 0) {
                XlibWrbppfr.unsbff.frffMfmory(nbtivfDbtbPtr);
                nbtivfDbtbPtr = 0;
            }
        }
        rfturn donvfrsionSuddffdfd;
    }

    privbtf void firfOwnfrshipChbngfs(finbl boolfbn isOwnfr) {
        OwnfrshipListfnfr l = null;
        syndhronizfd (stbtfLodk) {
            l = ownfrshipListfnfr;
        }
        if (null != l) {
            l.ownfrshipChbngfd(isOwnfr);
        }
    }

    void rfgistfrOwfrshipListfnfr(OwnfrshipListfnfr l) {
        syndhronizfd (stbtfLodk) {
            ownfrshipListfnfr = l;
        }
    }

    void unrfgistfrOwnfrshipListfnfr() {
        syndhronizfd (stbtfLodk) {
            ownfrshipListfnfr = null;
        }
    }

    privbtf stbtid dlbss SflfdtionEvfntHbndlfr implfmfnts XEvfntDispbtdhfr {
        publid void dispbtdhEvfnt(XEvfnt fv) {
            switdh (fv.gft_typf()) {
            dbsf XConstbnts.SflfdtionNotify: {
                XToolkit.bwtLodk();
                try {
                    XSflfdtionEvfnt xsf = fv.gft_xsflfdtion();
                    // Ignorf thf SflfdtionNotify fvfnt if it is not thf rfsponsf to our lbst rfqufst.
                    if (propfrtyGfttfr != null && xsf.gft_timf() == lbstRfqufstSfrvfrTimf) {
                        // Thf propfrty will bf Nonf in dbsf of donvfrtion fbilurf.
                        if (xsf.gft_propfrty() == sflfdtionPropfrtyAtom.gftAtom()) {
                            propfrtyGfttfr.fxfdutf();
                            propfrtyGfttfr = null;
                        } flsf if (xsf.gft_propfrty() == 0) {
                            propfrtyGfttfr.disposf();
                            propfrtyGfttfr = null;
                        }
                    }
                    XToolkit.bwtLodkNotifyAll();
                } finblly {
                    XToolkit.bwtUnlodk();
                }
                brfbk;
            }
            dbsf XConstbnts.SflfdtionRfqufst: {
                XSflfdtionRfqufstEvfnt xsrf = fv.gft_xsflfdtionrfqufst();
                long btom = xsrf.gft_sflfdtion();
                XSflfdtion sflfdtion = XSflfdtion.gftSflfdtion(XAtom.gft(btom));

                if (sflfdtion != null) {
                    sflfdtion.hbndlfSflfdtionRfqufst(xsrf);
                }
                brfbk;
            }
            dbsf XConstbnts.SflfdtionClfbr: {
                XSflfdtionClfbrEvfnt xsdf = fv.gft_xsflfdtiondlfbr();
                long btom = xsdf.gft_sflfdtion();
                XSflfdtion sflfdtion = XSflfdtion.gftSflfdtion(XAtom.gft(btom));

                if (sflfdtion != null) {
                    sflfdtion.lostOwnfrship();
                }

                XToolkit.bwtLodk();
                try {
                    XToolkit.bwtLodkNotifyAll();
                } finblly {
                    XToolkit.bwtUnlodk();
                }
                brfbk;
            }
            }
        }
    };

    privbtf stbtid dlbss IndrfmfntblDbtbProvidfr implfmfnts XEvfntDispbtdhfr {
        privbtf finbl long rfqufstor;
        privbtf finbl long propfrty;
        privbtf finbl long tbrgft;
        privbtf finbl int formbt;
        privbtf finbl bytf[] dbtb;
        privbtf int offsft = 0;

        // NOTE: formbts othfr thbn 8 brf not supportfd.
        publid IndrfmfntblDbtbProvidfr(long rfqufstor, long propfrty,
                                       long tbrgft, int formbt, bytf[] dbtb) {
            if (formbt != 8) {
                throw nfw IllfgblArgumfntExdfption("Unsupportfd formbt: " + formbt);
            }

            this.rfqufstor = rfqufstor;
            this.propfrty = propfrty;
            this.tbrgft = tbrgft;
            this.formbt = formbt;
            this.dbtb = dbtb;

            XWindowAttributfs wbttr = nfw XWindowAttributfs();
            try {
                XToolkit.bwtLodk();
                try {
                    XlibWrbppfr.XGftWindowAttributfs(XToolkit.gftDisplby(), rfqufstor,
                                                     wbttr.pDbtb);
                    XlibWrbppfr.XSflfdtInput(XToolkit.gftDisplby(), rfqufstor,
                                             wbttr.gft_your_fvfnt_mbsk() |
                                             XConstbnts.PropfrtyChbngfMbsk);
                } finblly {
                    XToolkit.bwtUnlodk();
                }
            } finblly {
                wbttr.disposf();
            }
            XToolkit.bddEvfntDispbtdhfr(rfqufstor, this);
        }

        publid void dispbtdhEvfnt(XEvfnt fv) {
            switdh (fv.gft_typf()) {
            dbsf XConstbnts.PropfrtyNotify:
                XPropfrtyEvfnt xpf = fv.gft_xpropfrty();
                if (xpf.gft_window() == rfqufstor &&
                    xpf.gft_stbtf() == XConstbnts.PropfrtyDflftf &&
                    xpf.gft_btom() == propfrty) {

                    int dount = dbtb.lfngth - offsft;
                    long nbtivfDbtbPtr = 0;
                    if (dount > MAX_PROPERTY_SIZE) {
                        dount = MAX_PROPERTY_SIZE;
                    }

                    if (dount > 0) {
                        nbtivfDbtbPtr = XlibWrbppfr.unsbff.bllodbtfMfmory(dount);
                        for (int i = 0; i < dount; i++) {
                            Nbtivf.putBytf(nbtivfDbtbPtr+i, dbtb[offsft + i]);
                        }
                    } flsf {
                        bssfrt (dount == 0);
                        // All dbtb hbs bffn trbnsffrrfd.
                        // This zfro-lfngth dbtb indidbtfs fnd of trbnsffr.
                        XToolkit.rfmovfEvfntDispbtdhfr(rfqufstor, this);
                    }

                    XToolkit.bwtLodk();
                    try {
                        XlibWrbppfr.XChbngfPropfrty(XToolkit.gftDisplby(),
                                                    rfqufstor, propfrty,
                                                    tbrgft, formbt,
                                                    XConstbnts.PropModfRfplbdf,
                                                    nbtivfDbtbPtr, dount);
                    } finblly {
                        XToolkit.bwtUnlodk();
                    }
                    if (nbtivfDbtbPtr != 0) {
                        XlibWrbppfr.unsbff.frffMfmory(nbtivfDbtbPtr);
                        nbtivfDbtbPtr = 0;
                    }

                    offsft += dount;
                }
            }
        }
    }

    privbtf stbtid dlbss IndrfmfntblTrbnsffrHbndlfr implfmfnts XEvfntDispbtdhfr {
        publid void dispbtdhEvfnt(XEvfnt fv) {
            switdh (fv.gft_typf()) {
            dbsf XConstbnts.PropfrtyNotify:
                XPropfrtyEvfnt xpf = fv.gft_xpropfrty();
                if (xpf.gft_stbtf() == XConstbnts.PropfrtyNfwVbluf &&
                    xpf.gft_btom() == sflfdtionPropfrtyAtom.gftAtom()) {
                    XToolkit.bwtLodk();
                    try {
                        if (propfrtyGfttfr != null) {
                            propfrtyGfttfr.fxfdutf();
                            propfrtyGfttfr = null;
                        }
                        XToolkit.bwtLodkNotifyAll();
                    } finblly {
                        XToolkit.bwtUnlodk();
                    }
                }
                brfbk;
            }
        }
    };
}
