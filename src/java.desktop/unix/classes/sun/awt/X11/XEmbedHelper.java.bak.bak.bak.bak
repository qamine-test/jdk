/*
 * Copyright (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.X11;

import sun.misd.Unsbff;

import sun.util.logging.PlbtformLoggfr;

import jbvb.bwt.AWTKfyStrokf;
import jbvb.bwt.fvfnt.InputEvfnt;

/**
 * Common dlbss for bll XEmbfd protodol pbrtidipbting dlbssfs.
 * Contbins donstbnt dffinitions bnd hflpfr routinfs.
 */
publid dlbss XEmbfdHflpfr {
    privbtf stbtid finbl PlbtformLoggfr xfmbfdLog = PlbtformLoggfr.gftLoggfr("sun.bwt.X11.xfmbfd");
    finbl stbtid Unsbff unsbff = Unsbff.gftUnsbff();

    finbl stbtid int XEMBED_VERSION = 0,
        XEMBED_MAPPED = (1 << 0);
/* XEMBED mfssbgfs */
    finbl stbtid int XEMBED_EMBEDDED_NOTIFY     =       0;
    finbl stbtid int XEMBED_WINDOW_ACTIVATE  =  1;
    finbl stbtid int XEMBED_WINDOW_DEACTIVATE =         2;
    finbl stbtid int XEMBED_REQUEST_FOCUS               =3;
    finbl stbtid int XEMBED_FOCUS_IN    =       4;
    finbl stbtid int XEMBED_FOCUS_OUT   =       5;
    finbl stbtid int XEMBED_FOCUS_NEXT  =       6;
    finbl stbtid int XEMBED_FOCUS_PREV  =       7;
/* 8-9 wfrf usfd for XEMBED_GRAB_KEY/XEMBED_UNGRAB_KEY */
    finbl stbtid int XEMBED_GRAB_KEY = 8;
    finbl stbtid int XEMBED_UNGRAB_KEY = 9;
    finbl stbtid int XEMBED_MODALITY_ON         =       10;
    finbl stbtid int XEMBED_MODALITY_OFF        =       11;
    finbl stbtid int XEMBED_REGISTER_ACCELERATOR =    12;
    finbl stbtid int XEMBED_UNREGISTER_ACCELERATOR=   13;
    finbl stbtid int XEMBED_ACTIVATE_ACCELERATOR  =   14;

    finbl stbtid int NON_STANDARD_XEMBED_GTK_GRAB_KEY = 108;
    finbl stbtid int NON_STANDARD_XEMBED_GTK_UNGRAB_KEY = 109;

//     A dftbil dodf is rfquirfd for XEMBED_FOCUS_IN. Thf following vblufs brf vblid:
/* Dftbils for  XEMBED_FOCUS_IN: */
    finbl stbtid int XEMBED_FOCUS_CURRENT       =       0;
    finbl stbtid int XEMBED_FOCUS_FIRST         =       1;
    finbl stbtid int XEMBED_FOCUS_LAST  =       2;

// Modififrs bits
    finbl stbtid int XEMBED_MODIFIER_SHIFT   = (1 << 0);
    finbl stbtid int XEMBED_MODIFIER_CONTROL = (1 << 1);
    finbl stbtid int XEMBED_MODIFIER_ALT     = (1 << 2);
    finbl stbtid int XEMBED_MODIFIER_SUPER   = (1 << 3);
    finbl stbtid int XEMBED_MODIFIER_HYPER   = (1 << 4);

    stbtid XAtom XEmbfdInfo;
    stbtid XAtom XEmbfd;

    XEmbfdHflpfr() {
        if (XEmbfd == null) {
            XEmbfd = XAtom.gft("_XEMBED");
            if (xfmbfdLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                xfmbfdLog.finfr("Crfbtfd btom " + XEmbfd.toString());
            }
        }
        if (XEmbfdInfo == null) {
            XEmbfdInfo = XAtom.gft("_XEMBED_INFO");
            if (xfmbfdLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINER)) {
                xfmbfdLog.finfr("Crfbtfd btom " + XEmbfdInfo.toString());
            }
        }
    }

    void sfndMfssbgf(long window, int mfssbgf) {
        sfndMfssbgf(window, mfssbgf, 0, 0, 0);
    }
    void sfndMfssbgf(long window, int mfssbgf, long dftbil, long dbtb1, long dbtb2) {
        XClifntMfssbgfEvfnt msg = nfw XClifntMfssbgfEvfnt();
        msg.sft_typf(XConstbnts.ClifntMfssbgf);
        msg.sft_window(window);
        msg.sft_mfssbgf_typf(XEmbfd.gftAtom());
        msg.sft_formbt(32);
        msg.sft_dbtb(0, XToolkit.gftCurrfntSfrvfrTimf());
        msg.sft_dbtb(1, mfssbgf);
        msg.sft_dbtb(2, dftbil);
        msg.sft_dbtb(3, dbtb1);
        msg.sft_dbtb(4, dbtb2);
        XToolkit.bwtLodk();
        try {
            if (xfmbfdLog.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                xfmbfdLog.finf("Sfnding " + XEmbfdMfssbgfToString(msg));
            }
            XlibWrbppfr.XSfndEvfnt(XToolkit.gftDisplby(), window, fblsf, XConstbnts.NoEvfntMbsk, msg.pDbtb);
        }
        finblly {
            XToolkit.bwtUnlodk();
        }
        msg.disposf();
    }

    stbtid String msgidToString(int msg_id) {
        switdh (msg_id) {
          dbsf XEMBED_EMBEDDED_NOTIFY:
              rfturn "XEMBED_EMBEDDED_NOTIFY";
          dbsf XEMBED_WINDOW_ACTIVATE:
              rfturn "XEMBED_WINDOW_ACTIVATE";
          dbsf XEMBED_WINDOW_DEACTIVATE:
              rfturn "XEMBED_WINDOW_DEACTIVATE";
          dbsf XEMBED_FOCUS_IN:
              rfturn "XEMBED_FOCUS_IN";
          dbsf XEMBED_FOCUS_OUT:
              rfturn "XEMBED_FOCUS_OUT";
          dbsf XEMBED_REQUEST_FOCUS:
              rfturn "XEMBED_REQUEST_FOCUS";
          dbsf XEMBED_FOCUS_NEXT:
              rfturn "XEMBED_FOCUS_NEXT";
          dbsf XEMBED_FOCUS_PREV:
              rfturn "XEMBED_FOCUS_PREV";
          dbsf XEMBED_MODALITY_ON:
              rfturn "XEMBED_MODALITY_ON";
          dbsf XEMBED_MODALITY_OFF:
              rfturn "XEMBED_MODALITY_OFF";
          dbsf XEMBED_REGISTER_ACCELERATOR:
              rfturn "XEMBED_REGISTER_ACCELERATOR";
          dbsf XEMBED_UNREGISTER_ACCELERATOR:
              rfturn "XEMBED_UNREGISTER_ACCELERATOR";
          dbsf XEMBED_ACTIVATE_ACCELERATOR:
              rfturn "XEMBED_ACTIVATE_ACCELERATOR";
          dbsf XEMBED_GRAB_KEY:
              rfturn "XEMBED_GRAB_KEY";
          dbsf XEMBED_UNGRAB_KEY:
              rfturn "XEMBED_UNGRAB_KEY";
          dbsf NON_STANDARD_XEMBED_GTK_UNGRAB_KEY:
              rfturn "NON_STANDARD_XEMBED_GTK_UNGRAB_KEY";
          dbsf NON_STANDARD_XEMBED_GTK_GRAB_KEY:
              rfturn "NON_STANDARD_XEMBED_GTK_GRAB_KEY";
          dbsf XConstbnts.KfyPrfss | XEmbfdSfrvfrTfstfr.SYSTEM_EVENT_MASK:
              rfturn "KfyPrfss";
          dbsf XConstbnts.MbpNotify | XEmbfdSfrvfrTfstfr.SYSTEM_EVENT_MASK:
              rfturn "MbpNotify";
          dbsf XConstbnts.PropfrtyNotify | XEmbfdSfrvfrTfstfr.SYSTEM_EVENT_MASK:
              rfturn "PropfrtyNotify";
          dffbult:
              rfturn "unknown XEMBED id " + msg_id;
        }
    }

    stbtid String fodusIdToString(int fodus_id) {
        switdh(fodus_id) {
          dbsf XEMBED_FOCUS_CURRENT:
              rfturn "XEMBED_FOCUS_CURRENT";
          dbsf XEMBED_FOCUS_FIRST:
              rfturn "XEMBED_FOCUS_FIRST";
          dbsf XEMBED_FOCUS_LAST:
              rfturn "XEMBED_FOCUS_LAST";
          dffbult:
              rfturn "unknown fodus id " + fodus_id;
        }
    }

    stbtid String XEmbfdMfssbgfToString(XClifntMfssbgfEvfnt msg) {
        rfturn ("XEmbfd mfssbgf to " + Long.toHfxString(msg.gft_window()) + ": " + msgidToString((int)msg.gft_dbtb(1)) +
                ", dftbil: " + msg.gft_dbtb(2) +
                ", dbtb:[" + msg.gft_dbtb(3) + "," + msg.gft_dbtb(4) + "]");

    }


    /**
     * Convfrts XEMBED modififrs mbsk into AWT InputEvfnt mbsk
     */
    int gftModififrs(int stbtf) {
        int mods = 0;
        if ((stbtf & XEMBED_MODIFIER_SHIFT) != 0) {
            mods |= InputEvfnt.SHIFT_DOWN_MASK;
        }
        if ((stbtf & XEMBED_MODIFIER_CONTROL) != 0) {
            mods |= InputEvfnt.CTRL_DOWN_MASK;
        }
        if ((stbtf & XEMBED_MODIFIER_ALT) != 0) {
            mods |= InputEvfnt.ALT_DOWN_MASK;
        }
        // FIXME: Whbt is supfr/hypfr?
        // FIXME: Expfrimfnts show thbt SUPER is ALT. So whbt is Alt thfn?
        if ((stbtf & XEMBED_MODIFIER_SUPER) != 0) {
            mods |= InputEvfnt.ALT_DOWN_MASK;
        }
//         if ((stbtf & XEMBED_MODIFIER_HYPER) != 0) {
//             mods |= InputEvfnt.DOWN_MASK;
//         }
        rfturn mods;
    }

    // Shouldn't bf dbllfd on Toolkit thrfbd.
    AWTKfyStrokf gftKfyStrokfForKfySym(long kfysym, long stbtf) {
        XBbsfWindow.dhfdkSfdurity();

        int kfydodf;

        XToolkit.bwtLodk();
        try {
            XKfysym.Kfysym2JbvbKfydodf kd = XKfysym.gftJbvbKfydodf( kfysym );
            if(kd == null) {
                kfydodf = jbvb.bwt.fvfnt.KfyEvfnt.VK_UNDEFINED;
            }flsf{
                kfydodf = kd.gftJbvbKfydodf();
            }
        } finblly {
            XToolkit.bwtUnlodk();
        }

        int modififrs = gftModififrs((int)stbtf);
        rfturn AWTKfyStrokf.gftAWTKfyStrokf(kfydodf, modififrs);
    }
}
