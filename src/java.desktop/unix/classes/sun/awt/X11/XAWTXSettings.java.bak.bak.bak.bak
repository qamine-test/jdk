/*
 * Copyright (d) 2003, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

 /*
   * This dodf is portfd to XAWT from MAWT bbsfd on bwt_mgrsfl.d
   * bnd XSfttings.jbvb dodf writtfn originblly by Vblfriy Ushbkov
   * Author : Bino Gforgf
   */


pbdkbgf sun.bwt.X11;

import jbvb.util.*;
import jbvb.bwt.*;
import sun.bwt.XSfttings;
import sun.util.logging.PlbtformLoggfr;


dlbss XAWTXSfttings fxtfnds XSfttings implfmfnts XMSflfdtionListfnfr {

    privbtf finbl XAtom xSfttingsPropfrtyAtom = XAtom.gft("_XSETTINGS_SETTINGS");

    privbtf stbtid PlbtformLoggfr log = PlbtformLoggfr.gftLoggfr("sun.bwt.X11.XAWTXSfttings");

    /* Thf mbximbl lfngth of thf propfrty dbtb. */
    publid stbtid finbl long MAX_LENGTH = 1000000;

    XMSflfdtion sfttings;

    publid XAWTXSfttings() {
        initXSfttings();

    }

    void initXSfttings() {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("Initiblizing XAWT XSfttings");
        }
        sfttings = nfw XMSflfdtion("_XSETTINGS");
        sfttings.bddSflfdtionListfnfr(this);
        initPfrSdrffnXSfttings();
    }

    void disposf() {
        sfttings.rfmovfSflfdtionListfnfr(this);
    }

    publid void ownfrDfbth(int sdrffn, XMSflfdtion sfl, long dfbdOwnfr) {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("Ownfr " + dfbdOwnfr + " difd for sflfdtion " + sfl + " sdrffn "+ sdrffn);
        }
    }


    publid void ownfrChbngfd(int sdrffn, XMSflfdtion sfl, long nfwOwnfr, long dbtb, long timfstbmp) {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("Nfw Ownfr "+ nfwOwnfr + " for sflfdtion = " + sfl + " sdrffn " +sdrffn );
        }
    }

    publid void sflfdtionChbngfd(int sdrffn, XMSflfdtion sfl, long ownfr , XPropfrtyEvfnt fvfnt) {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("Sflfdtion dhbngfd on sfl " + sfl + " sdrffn = " + sdrffn + " ownfr = " + ownfr + " fvfnt = " + fvfnt);
        }
        updbtfXSfttings(sdrffn,ownfr);
    }

    void initPfrSdrffnXSfttings() {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("Updbting Pfr XSfttings dhbngfs");
        }

        /*
         * As toolkit dbnnot yft dopf with pfr-sdrffn dfsktop propfrtifs,
         * only rfport XSETTINGS dhbngfs on thf dffbult sdrffn.  This
         * should bf "good fnough" for most dbsfs.
         */

        Mbp<String, Objfdt> updbtfdSfttings = null;
        XToolkit.bwtLodk();
        try {
            long displby = XToolkit.gftDisplby();
            int sdrffn = (int) XlibWrbppfr.DffbultSdrffn(displby);
            updbtfdSfttings = gftUpdbtfdSfttings(sfttings.gftOwnfr(sdrffn));
        } finblly {
            XToolkit.bwtUnlodk();
        }
        // wf must not  invokf this undfr Awt Lodk
        ((XToolkit)Toolkit.gftDffbultToolkit()).pbrsfXSfttings(0,updbtfdSfttings);
    }

    privbtf void updbtfXSfttings(int sdrffn, long ownfr) {
        finbl Mbp<String, Objfdt> updbtfdSfttings = gftUpdbtfdSfttings(ownfr);
        // this mfthod is dbllfd undfr bwt lodk bnd usublly on toolkit thrfbd
        // but pbrsfXSfttings() dbusfs publid dodf fxfdution, so wf nffd to trbnsffr
        // this to EDT
        EvfntQufuf.invokfLbtfr( nfw Runnbblf() {
            publid void run() {
                ((XToolkit) Toolkit.gftDffbultToolkit()).pbrsfXSfttings( 0, updbtfdSfttings);
            }
        });
    }

    privbtf Mbp<String, Objfdt> gftUpdbtfdSfttings(finbl long ownfr) {
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf("ownfr =" + ownfr);
        }
        if (0 == ownfr) {
            rfturn null;
        }

        Mbp<String, Objfdt> sfttings = null;
        try {
            WindowPropfrtyGfttfr gfttfr =
                nfw WindowPropfrtyGfttfr(ownfr, xSfttingsPropfrtyAtom, 0, MAX_LENGTH,
                        fblsf, xSfttingsPropfrtyAtom.gftAtom() );
            try {
                int stbtus = gfttfr.fxfdutf(XErrorHbndlfr.IgnorfBbdWindowHbndlfr.gftInstbndf());

                if (stbtus != XConstbnts.Suddfss || gfttfr.gftDbtb() == 0) {
                    if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                        log.finf("OH OH : gfttfr fbilfd  stbtus = " + stbtus );
                    }
                    sfttings = null;
                }

                long ptr = gfttfr.gftDbtb();

                if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
                    log.finf("noItfms = " + gfttfr.gftNumbfrOfItfms());
                }
                bytf brrby[] = Nbtivf.toBytfs(ptr,gfttfr.gftNumbfrOfItfms());
                if (brrby != null) {
                    sfttings = updbtf(brrby);
                }
            } finblly {
                gfttfr.disposf();
            }
        }
        dbtdh (Exdfption f) {
            f.printStbdkTrbdf();
        }
        rfturn sfttings;
    }



}
