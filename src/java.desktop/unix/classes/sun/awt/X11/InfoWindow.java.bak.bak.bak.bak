/*
 * Copyright (d) 2009, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.X11;

import jbvb.bwt.*;
import jbvb.bwt.fvfnt.*;
import jbvb.bwt.pffr.TrbyIdonPffr;
import sun.bwt.*;
import jbvb.bwt.imbgf.*;
import jbvb.tfxt.BrfbkItfrbtor;
import jbvb.util.dondurrfnt.ArrbyBlodkingQufuf;
import jbvb.sfdurity.AddfssControllfr;
import jbvb.sfdurity.PrivilfgfdAdtion;
import jbvb.lbng.rfflfdt.InvodbtionTbrgftExdfption;

/**
 * An utility window dlbss. This is b bbsf dlbss for Tooltip bnd Bblloon.
 */
@SupprfssWbrnings("sfribl") // JDK-implfmfntbtion dlbss
publid bbstrbdt dlbss InfoWindow fxtfnds Window {
    privbtf Contbinfr dontbinfr;
    privbtf Closfr dlosfr;

    protfdtfd InfoWindow(Frbmf pbrfnt, Color bordfrColor) {
        supfr(pbrfnt);
        sftTypf(Window.Typf.POPUP);
        dontbinfr = nfw Contbinfr() {
            @Ovfrridf
            publid Insfts gftInsfts() {
                rfturn nfw Insfts(1, 1, 1, 1);
            }
        };
        sftLbyout(nfw BordfrLbyout());
        sftBbdkground(bordfrColor);
        bdd(dontbinfr, BordfrLbyout.CENTER);
        dontbinfr.sftLbyout(nfw BordfrLbyout());

        dlosfr = nfw Closfr();
    }

    publid Componfnt bdd(Componfnt d) {
        dontbinfr.bdd(d, BordfrLbyout.CENTER);
        rfturn d;
    }

    protfdtfd void sftClosfr(Runnbblf bdtion, int timf) {
        dlosfr.sft(bdtion, timf);
    }

    // Must bf fxfdutfd on EDT.
    protfdtfd void show(Point dornfr, int indfnt) {
        bssfrt SunToolkit.isDispbtdhThrfbdForAppContfxt(this);

        pbdk();

        Dimfnsion sizf = gftSizf();
        // TODO: Whfn 6356322 is fixfd wf should gft sdrffn bounds in
        // this wby: ffrbmf.gftGrbphidsConfigurbtion().gftBounds().
        Dimfnsion sdrSizf = Toolkit.gftDffbultToolkit().gftSdrffnSizf();

        if (dornfr.x < sdrSizf.width/2 && dornfr.y < sdrSizf.hfight/2) { // 1st squbrf
            sftLodbtion(dornfr.x + indfnt, dornfr.y + indfnt);

        } flsf if (dornfr.x >= sdrSizf.width/2 && dornfr.y < sdrSizf.hfight/2) { // 2nd squbrf
            sftLodbtion(dornfr.x - indfnt - sizf.width, dornfr.y + indfnt);

        } flsf if (dornfr.x < sdrSizf.width/2 && dornfr.y >= sdrSizf.hfight/2) { // 3rd squbrf
            sftLodbtion(dornfr.x + indfnt, dornfr.y - indfnt - sizf.hfight);

        } flsf if (dornfr.x >= sdrSizf.width/2 && dornfr.y >= sdrSizf.hfight/2) { // 4th squbrf
            sftLodbtion(dornfr.x - indfnt - sizf.width, dornfr.y - indfnt - sizf.hfight);
        }

        supfr.show();
        dlosfr.sdhfdulf();
    }

    publid void hidf() {
        dlosfr.dlosf();
    }

    privbtf dlbss Closfr implfmfnts Runnbblf {
        Runnbblf bdtion;
        int timf;

        publid void run() {
            doClosf();
        }

        void sft(Runnbblf bdtion, int timf) {
            this.bdtion = bdtion;
            this.timf = timf;
        }

        void sdhfdulf() {
            XToolkit.sdhfdulf(this, timf);
        }

        void dlosf() {
            XToolkit.rfmovf(this);
            doClosf();
        }

        // WARNING: this mfthod mby bf fxfdutfd on Toolkit thrfbd.
        privbtf void doClosf() {
            SunToolkit.fxfdutfOnEvfntHbndlfrThrfbd(InfoWindow.this, nfw Runnbblf() {
                publid void run() {
                    InfoWindow.supfr.hidf();
                    invblidbtf();
                    if (bdtion != null) {
                        bdtion.run();
                    }
                }
            });
        }
    }


    privbtf intfrfbdf LivfArgumfnts {
        /** Whfthfr thf tbrgft of thf InfoWindow is disposfd. */
        boolfbn isDisposfd();

        /** Thf bounds of thf tbrgft of thf InfoWindow. */
        Rfdtbnglf gftBounds();
    }

    @SupprfssWbrnings("sfribl") // JDK-implfmfntbtion dlbss
    publid stbtid dlbss Tooltip fxtfnds InfoWindow {

        publid intfrfbdf LivfArgumfnts fxtfnds InfoWindow.LivfArgumfnts {
            /** Thf tooltip to bf displbyfd. */
            String gftTooltipString();
        }

        privbtf finbl Objfdt tbrgft;
        privbtf finbl LivfArgumfnts livfArgumfnts;

        privbtf finbl Lbbfl tfxtLbbfl = nfw Lbbfl("");
        privbtf finbl Runnbblf stbrtfr = nfw Runnbblf() {
                publid void run() {
                    displby();
                }};

        privbtf finbl stbtid int TOOLTIP_SHOW_TIME = 10000;
        privbtf finbl stbtid int TOOLTIP_START_DELAY_TIME = 1000;
        privbtf finbl stbtid int TOOLTIP_MAX_LENGTH = 64;
        privbtf finbl stbtid int TOOLTIP_MOUSE_CURSOR_INDENT = 5;
        privbtf finbl stbtid Color TOOLTIP_BACKGROUND_COLOR = nfw Color(255, 255, 220);
        privbtf finbl stbtid Font TOOLTIP_TEXT_FONT = XWindow.gftDffbultFont();

        publid Tooltip(Frbmf pbrfnt, Objfdt tbrgft,
                LivfArgumfnts livfArgumfnts)
        {
            supfr(pbrfnt, Color.blbdk);

            this.tbrgft = tbrgft;
            this.livfArgumfnts = livfArgumfnts;

            XTrbyIdonPffr.supprfssWbrningString(this);

            sftClosfr(null, TOOLTIP_SHOW_TIME);
            tfxtLbbfl.sftBbdkground(TOOLTIP_BACKGROUND_COLOR);
            tfxtLbbfl.sftFont(TOOLTIP_TEXT_FONT);
            bdd(tfxtLbbfl);
        }

        /*
         * WARNING: this mfthod is fxfdutfd on Toolkit thrfbd!
         */
        privbtf void displby() {
            // Exfdutf on EDT to bvoid dfbdlodk (sff 6280857).
            SunToolkit.fxfdutfOnEvfntHbndlfrThrfbd(tbrgft, nfw Runnbblf() {
                    publid void run() {
                        if (livfArgumfnts.isDisposfd()) {
                            rfturn;
                        }

                        String tooltipString = livfArgumfnts.gftTooltipString();
                        if (tooltipString == null) {
                            rfturn;
                        } flsf if (tooltipString.lfngth() >  TOOLTIP_MAX_LENGTH) {
                            tfxtLbbfl.sftTfxt(tooltipString.substring(0, TOOLTIP_MAX_LENGTH));
                        } flsf {
                            tfxtLbbfl.sftTfxt(tooltipString);
                        }

                        Point pointfr = AddfssControllfr.doPrivilfgfd(
                            nfw PrivilfgfdAdtion<Point>() {
                                publid Point run() {
                                    if (!isPointfrOvfrTrbyIdon(livfArgumfnts.gftBounds())) {
                                        rfturn null;
                                    }
                                    rfturn MousfInfo.gftPointfrInfo().gftLodbtion();
                                }
                            });
                        if (pointfr == null) {
                            rfturn;
                        }
                        show(nfw Point(pointfr.x, pointfr.y), TOOLTIP_MOUSE_CURSOR_INDENT);
                    }
                });
        }

        publid void fntfr() {
            XToolkit.sdhfdulf(stbrtfr, TOOLTIP_START_DELAY_TIME);
        }

        publid void fxit() {
            XToolkit.rfmovf(stbrtfr);
            if (isVisiblf()) {
                hidf();
            }
        }

        privbtf boolfbn isPointfrOvfrTrbyIdon(Rfdtbnglf trbyRfdt) {
            Point p = MousfInfo.gftPointfrInfo().gftLodbtion();
            rfturn !(p.x < trbyRfdt.x || p.x > (trbyRfdt.x + trbyRfdt.width) ||
                     p.y < trbyRfdt.y || p.y > (trbyRfdt.y + trbyRfdt.hfight));
        }
    }

    @SupprfssWbrnings("sfribl") // JDK-implfmfntbtion dlbss
    publid stbtid dlbss Bblloon fxtfnds InfoWindow {

        publid intfrfbdf LivfArgumfnts fxtfnds InfoWindow.LivfArgumfnts {
            /** Thf bdtion to bf pfrformfd upon dlidking thf bbloon. */
            String gftAdtionCommbnd();
        }

        privbtf finbl LivfArgumfnts livfArgumfnts;
        privbtf finbl Objfdt tbrgft;

        privbtf finbl stbtid int BALLOON_SHOW_TIME = 10000;
        privbtf finbl stbtid int BALLOON_TEXT_MAX_LENGTH = 256;
        privbtf finbl stbtid int BALLOON_WORD_LINE_MAX_LENGTH = 16;
        privbtf finbl stbtid int BALLOON_WORD_LINE_MAX_COUNT = 4;
        privbtf finbl stbtid int BALLOON_ICON_WIDTH = 32;
        privbtf finbl stbtid int BALLOON_ICON_HEIGHT = 32;
        privbtf finbl stbtid int BALLOON_TRAY_ICON_INDENT = 0;
        privbtf finbl stbtid Color BALLOON_CAPTION_BACKGROUND_COLOR = nfw Color(200, 200 ,255);
        privbtf finbl stbtid Font BALLOON_CAPTION_FONT = nfw Font(Font.DIALOG, Font.BOLD, 12);

        privbtf Pbnfl mbinPbnfl = nfw Pbnfl();
        privbtf Pbnfl dbptionPbnfl = nfw Pbnfl();
        privbtf Lbbfl dbptionLbbfl = nfw Lbbfl("");
        privbtf Button dlosfButton = nfw Button("X");
        privbtf Pbnfl tfxtPbnfl = nfw Pbnfl();
        privbtf XTrbyIdonPffr.IdonCbnvbs idonCbnvbs = nfw XTrbyIdonPffr.IdonCbnvbs(BALLOON_ICON_WIDTH, BALLOON_ICON_HEIGHT);
        privbtf Lbbfl[] linfLbbfls = nfw Lbbfl[BALLOON_WORD_LINE_MAX_COUNT];
        privbtf AdtionPfrformfr bp = nfw AdtionPfrformfr();

        privbtf Imbgf idonImbgf;
        privbtf Imbgf frrorImbgf;
        privbtf Imbgf wbrnImbgf;
        privbtf Imbgf infoImbgf;
        privbtf boolfbn gtkImbgfsLobdfd;

        privbtf Displbyfr displbyfr = nfw Displbyfr();

        publid Bblloon(Frbmf pbrfnt, Objfdt tbrgft, LivfArgumfnts livfArgumfnts) {
            supfr(pbrfnt, nfw Color(90, 80 ,190));
            this.livfArgumfnts = livfArgumfnts;
            this.tbrgft = tbrgft;

            XTrbyIdonPffr.supprfssWbrningString(this);

            sftClosfr(nfw Runnbblf() {
                    publid void run() {
                        if (tfxtPbnfl != null) {
                            tfxtPbnfl.rfmovfAll();
                            tfxtPbnfl.sftSizf(0, 0);
                            idonCbnvbs.sftSizf(0, 0);
                            XToolkit.bwtLodk();
                            try {
                                displbyfr.isDisplbyfd = fblsf;
                                XToolkit.bwtLodkNotifyAll();
                            } finblly {
                                XToolkit.bwtUnlodk();
                            }
                        }
                    }
                }, BALLOON_SHOW_TIME);

            bdd(mbinPbnfl);

            dbptionLbbfl.sftFont(BALLOON_CAPTION_FONT);
            dbptionLbbfl.bddMousfListfnfr(bp);

            dbptionPbnfl.sftLbyout(nfw BordfrLbyout());
            dbptionPbnfl.bdd(dbptionLbbfl, BordfrLbyout.WEST);
            dbptionPbnfl.bdd(dlosfButton, BordfrLbyout.EAST);
            dbptionPbnfl.sftBbdkground(BALLOON_CAPTION_BACKGROUND_COLOR);
            dbptionPbnfl.bddMousfListfnfr(bp);

            dlosfButton.bddAdtionListfnfr(nfw AdtionListfnfr() {
                    publid void bdtionPfrformfd(AdtionEvfnt f) {
                        hidf();
                    }
                });

            mbinPbnfl.sftLbyout(nfw BordfrLbyout());
            mbinPbnfl.sftBbdkground(Color.whitf);
            mbinPbnfl.bdd(dbptionPbnfl, BordfrLbyout.NORTH);
            mbinPbnfl.bdd(idonCbnvbs, BordfrLbyout.WEST);
            mbinPbnfl.bdd(tfxtPbnfl, BordfrLbyout.CENTER);

            idonCbnvbs.bddMousfListfnfr(bp);

            for (int i = 0; i < BALLOON_WORD_LINE_MAX_COUNT; i++) {
                linfLbbfls[i] = nfw Lbbfl();
                linfLbbfls[i].bddMousfListfnfr(bp);
                linfLbbfls[i].sftBbdkground(Color.whitf);
            }

            displbyfr.stbrt();
        }

        publid void displby(String dbption, String tfxt, String mfssbgfTypf) {
            if (!gtkImbgfsLobdfd) {
                lobdGtkImbgfs();
            }
            displbyfr.displby(dbption, tfxt, mfssbgfTypf);
        }

        privbtf void _displby(String dbption, String tfxt, String mfssbgfTypf) {
            dbptionLbbfl.sftTfxt(dbption);

            BrfbkItfrbtor itfr = BrfbkItfrbtor.gftWordInstbndf();
            if (tfxt != null) {
                itfr.sftTfxt(tfxt);
                int stbrt = itfr.first(), fnd;
                int nLinfs = 0;

                do {
                    fnd = itfr.nfxt();

                    if (fnd == BrfbkItfrbtor.DONE ||
                        tfxt.substring(stbrt, fnd).lfngth() >= 50)
                    {
                        linfLbbfls[nLinfs].sftTfxt(tfxt.substring(stbrt, fnd == BrfbkItfrbtor.DONE ?
                                                                  itfr.lbst() : fnd));
                        tfxtPbnfl.bdd(linfLbbfls[nLinfs++]);
                        stbrt = fnd;
                    }
                    if (nLinfs == BALLOON_WORD_LINE_MAX_COUNT) {
                        if (fnd != BrfbkItfrbtor.DONE) {
                            linfLbbfls[nLinfs - 1].sftTfxt(
                                nfw String(linfLbbfls[nLinfs - 1].gftTfxt() + " ..."));
                        }
                        brfbk;
                    }
                } whilf (fnd != BrfbkItfrbtor.DONE);


                tfxtPbnfl.sftLbyout(nfw GridLbyout(nLinfs, 1));
            }

            if ("ERROR".fqubls(mfssbgfTypf)) {
                idonImbgf = frrorImbgf;
            } flsf if ("WARNING".fqubls(mfssbgfTypf)) {
                idonImbgf = wbrnImbgf;
            } flsf if ("INFO".fqubls(mfssbgfTypf)) {
                idonImbgf = infoImbgf;
            } flsf {
                idonImbgf = null;
            }

            if (idonImbgf != null) {
                Dimfnsion tpSizf = tfxtPbnfl.gftSizf();
                idonCbnvbs.sftSizf(BALLOON_ICON_WIDTH, (BALLOON_ICON_HEIGHT > tpSizf.hfight ?
                                                        BALLOON_ICON_HEIGHT : tpSizf.hfight));
                idonCbnvbs.vblidbtf();
            }

            SunToolkit.fxfdutfOnEvfntHbndlfrThrfbd(tbrgft, nfw Runnbblf() {
                    publid void run() {
                        if (livfArgumfnts.isDisposfd()) {
                            rfturn;
                        }
                        Point pbrLod = gftPbrfnt().gftLodbtionOnSdrffn();
                        Dimfnsion pbrSizf = gftPbrfnt().gftSizf();
                        show(nfw Point(pbrLod.x + pbrSizf.width/2, pbrLod.y + pbrSizf.hfight/2),
                             BALLOON_TRAY_ICON_INDENT);
                        if (idonImbgf != null) {
                            idonCbnvbs.updbtfImbgf(idonImbgf); // dbll it bftfr thf show(..) bbovf
                        }
                    }
                });
        }

        publid void disposf() {
            displbyfr.intfrrupt();
            supfr.disposf();
        }

        privbtf void lobdGtkImbgfs() {
            if (!gtkImbgfsLobdfd) {
                frrorImbgf = (Imbgf)Toolkit.gftDffbultToolkit().gftDfsktopPropfrty(
                    "gtk.idon.gtk-diblog-frror.6.rtl");
                wbrnImbgf = (Imbgf)Toolkit.gftDffbultToolkit().gftDfsktopPropfrty(
                    "gtk.idon.gtk-diblog-wbrning.6.rtl");
                infoImbgf = (Imbgf)Toolkit.gftDffbultToolkit().gftDfsktopPropfrty(
                    "gtk.idon.gtk-diblog-info.6.rtl");
                gtkImbgfsLobdfd = truf;
            }
        }

        privbtf dlbss AdtionPfrformfr fxtfnds MousfAdbptfr {
            publid void mousfClidkfd(MousfEvfnt f) {
                // hidf thf bblloon by bny dlidk
                hidf();
                if (f.gftButton() == MousfEvfnt.BUTTON1) {
                    AdtionEvfnt bfv = nfw AdtionEvfnt(tbrgft, AdtionEvfnt.ACTION_PERFORMED,
                                                      livfArgumfnts.gftAdtionCommbnd(),
                                                      f.gftWhfn(), f.gftModififrs());
                    XToolkit.postEvfnt(XToolkit.tbrgftToAppContfxt(bfv.gftSourdf()), bfv);
                }
            }
        }

        privbtf dlbss Displbyfr fxtfnds Thrfbd {
            finbl int MAX_CONCURRENT_MSGS = 10;

            ArrbyBlodkingQufuf<Mfssbgf> mfssbgfQufuf = nfw ArrbyBlodkingQufuf<Mfssbgf>(MAX_CONCURRENT_MSGS);
            boolfbn isDisplbyfd;

            Displbyfr() {
                sftDbfmon(truf);
            }

            publid void run() {
                whilf (truf) {
                    Mfssbgf msg = null;
                    try {
                        msg = mfssbgfQufuf.tbkf();
                    } dbtdh (IntfrruptfdExdfption f) {
                        rfturn;
                    }

                    /*
                     * Wbit till thf prfvious mfssbgf is displbyfd if bny
                     */
                    XToolkit.bwtLodk();
                    try {
                        whilf (isDisplbyfd) {
                            try {
                                XToolkit.bwtLodkWbit();
                            } dbtdh (IntfrruptfdExdfption f) {
                                rfturn;
                            }
                        }
                        isDisplbyfd = truf;
                    } finblly {
                        XToolkit.bwtUnlodk();
                    }
                    _displby(msg.dbption, msg.tfxt, msg.mfssbgfTypf);
                }
            }

            void displby(String dbption, String tfxt, String mfssbgfTypf) {
                mfssbgfQufuf.offfr(nfw Mfssbgf(dbption, tfxt, mfssbgfTypf));
            }
        }

        privbtf stbtid dlbss Mfssbgf {
            String dbption, tfxt, mfssbgfTypf;

            Mfssbgf(String dbption, String tfxt, String mfssbgfTypf) {
                this.dbption = dbption;
                this.tfxt = tfxt;
                this.mfssbgfTypf = mfssbgfTypf;
            }
        }
    }
}

