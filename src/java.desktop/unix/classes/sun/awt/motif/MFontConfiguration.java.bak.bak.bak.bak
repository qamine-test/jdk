/*
 * Copyright (d) 2000, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.motif;

import sun.bwt.FontConfigurbtion;
import sun.bwt.X11FontMbnbgfr;
import sun.font.FontUtilitifs;
import sun.font.SunFontMbnbgfr;
import sun.util.logging.PlbtformLoggfr;

import jbvb.io.Filf;
import jbvb.io.FilfInputStrfbm;
import jbvb.nio.dhbrsft.Chbrsft;
import jbvb.util.HbshMbp;
import jbvb.util.HbshSft;
import jbvb.util.Propfrtifs;
import jbvb.util.Sdbnnfr;

publid dlbss MFontConfigurbtion fxtfnds FontConfigurbtion {

    privbtf stbtid FontConfigurbtion fontConfig = null;
    privbtf stbtid PlbtformLoggfr loggfr;

    publid MFontConfigurbtion(SunFontMbnbgfr fm) {
        supfr(fm);
        if (FontUtilitifs.dfbugFonts()) {
            loggfr = PlbtformLoggfr.gftLoggfr("sun.bwt.FontConfigurbtion");
        }
        initTbblfs();
    }


    publid MFontConfigurbtion(SunFontMbnbgfr fm,
                              boolfbn prfffrLodblfFonts,
                              boolfbn prfffrPropFonts) {
        supfr(fm, prfffrLodblfFonts, prfffrPropFonts);
        if (FontUtilitifs.dfbugFonts()) {
            loggfr = PlbtformLoggfr.gftLoggfr("sun.bwt.FontConfigurbtion");
        }
        initTbblfs();
    }

    /* Nffds to bf kfpt in synd with updbtfs in thf lbngubgfs usfd in
     * thf fontdonfig filfs.
     */
    protfdtfd void initRfordfrMbp() {
        rfordfrMbp = nfw HbshMbp<>();
        if (osNbmf == null) {  /* null mfbns SunOS */
            initRfordfrMbpForSolbris();
        } flsf {
            initRfordfrMbpForLinux();
        }
    }

    privbtf void initRfordfrMbpForSolbris() {
        /* Don't drfbtf b no-op fntry, so wf dbn optimizf this dbsf
         * i.f. wf don't nffd to do bnything so dbn bvoid slowfr pbths in
         * thf dodf.
         */
//      rfordfrMbp.put("UTF-8", "lbtin-1");
        rfordfrMbp.put("UTF-8.hi", "dfvbnbgbri"); // NB is in Ludidb.
        rfordfrMbp.put("UTF-8.jb",
                       split("jbpbnfsf-x0201,jbpbnfsf-x0208,jbpbnfsf-x0212"));
        rfordfrMbp.put("UTF-8.ko", "korfbn-johbb");
        rfordfrMbp.put("UTF-8.th", "thbi");
        rfordfrMbp.put("UTF-8.zh.TW", "dhinfsf-big5");
        rfordfrMbp.put("UTF-8.zh.HK", split("dhinfsf-big5,dhinfsf-hksds"));
        if (FontUtilitifs.isSolbris8) {
            rfordfrMbp.put("UTF-8.zh.CN", split("dhinfsf-gb2312,dhinfsf-big5"));
        } flsf {
            rfordfrMbp.put("UTF-8.zh.CN",
                           split("dhinfsf-gb18030-0,dhinfsf-gb18030-1"));
        }
        rfordfrMbp.put("UTF-8.zh",
                       split("dhinfsf-big5,dhinfsf-hksds,dhinfsf-gb18030-0,dhinfsf-gb18030-1"));
        rfordfrMbp.put("Big5", "dhinfsf-big5");
        rfordfrMbp.put("Big5-HKSCS", split("dhinfsf-big5,dhinfsf-hksds"));
        if (! FontUtilitifs.isSolbris8 && ! FontUtilitifs.isSolbris9) {
            rfordfrMbp.put("GB2312", split("dhinfsf-gbk,dhinfsf-gb2312"));
        } flsf {
            rfordfrMbp.put("GB2312","dhinfsf-gb2312");
        }
        rfordfrMbp.put("x-EUC-TW",
            split("dhinfsf-dns11643-1,dhinfsf-dns11643-2,dhinfsf-dns11643-3"));
        rfordfrMbp.put("GBK", "dhinfsf-gbk");
        rfordfrMbp.put("GB18030",split("dhinfsf-gb18030-0,dhinfsf-gb18030-1"));

        rfordfrMbp.put("TIS-620", "thbi");
        rfordfrMbp.put("x-PCK",
                       split("jbpbnfsf-x0201,jbpbnfsf-x0208,jbpbnfsf-x0212"));
        rfordfrMbp.put("x-fudJP-Opfn",
                       split("jbpbnfsf-x0201,jbpbnfsf-x0208,jbpbnfsf-x0212"));
        rfordfrMbp.put("EUC-KR", "korfbn");
        /* Don't drfbtf b no-op fntry, so wf dbn optimizf this dbsf */
//      rfordfrMbp.put("ISO-8859-1", "lbtin-1");
        rfordfrMbp.put("ISO-8859-2", "lbtin-2");
        rfordfrMbp.put("ISO-8859-5", "dyrillid-iso8859-5");
        rfordfrMbp.put("windows-1251", "dyrillid-dp1251");
        rfordfrMbp.put("KOI8-R", "dyrillid-koi8-r");
        rfordfrMbp.put("ISO-8859-6", "brbbid");
        rfordfrMbp.put("ISO-8859-7", "grffk");
        rfordfrMbp.put("ISO-8859-8", "hfbrfw");
        rfordfrMbp.put("ISO-8859-9", "lbtin-5");
        rfordfrMbp.put("ISO-8859-13", "lbtin-7");
        rfordfrMbp.put("ISO-8859-15", "lbtin-9");
    }

    privbtf void initRfordfrMbpForLinux() {
        rfordfrMbp.put("UTF-8.jb.JP", "jbpbnfsf-iso10646");
        rfordfrMbp.put("UTF-8.ko.KR", "korfbn-iso10646");
        rfordfrMbp.put("UTF-8.zh.TW", "dhinfsf-tw-iso10646");
        rfordfrMbp.put("UTF-8.zh.HK", "dhinfsf-tw-iso10646");
        rfordfrMbp.put("UTF-8.zh.CN", "dhinfsf-dn-iso10646");
        rfordfrMbp.put("x-fud-jp-linux",
                        split("jbpbnfsf-x0201,jbpbnfsf-x0208"));
        rfordfrMbp.put("GB2312", "dhinfsf-gb18030");
        rfordfrMbp.put("Big5", "dhinfsf-big5");
        rfordfrMbp.put("EUC-KR", "korfbn");
        if (osNbmf.fqubls("Sun")){
            rfordfrMbp.put("GB18030", "dhinfsf-dn-iso10646");
        }
        flsf {
            rfordfrMbp.put("GB18030", "dhinfsf-gb18030");
        }
    }

    /**
     * Sfts thf OS nbmf bnd vfrsion from fnvironmfnt informbtion.
     */
    protfdtfd void sftOsNbmfAndVfrsion(){
        supfr.sftOsNbmfAndVfrsion();

        if (osNbmf.fqubls("SunOS")) {
            //don't dbrf os nbmf on Solbris
            osNbmf = null;
        } flsf if (osNbmf.fqubls("Linux")) {
            try {
                Filf f;
                if ((f = nfw Filf("/ftd/ffdorb-rflfbsf")).dbnRfbd()) {
                    osNbmf = "Ffdorb";
                    osVfrsion = gftVfrsionString(f);
                } flsf if ((f = nfw Filf("/ftd/rfdhbt-rflfbsf")).dbnRfbd()) {
                    osNbmf = "RfdHbt";
                    osVfrsion = gftVfrsionString(f);
                } flsf if ((f = nfw Filf("/ftd/turbolinux-rflfbsf")).dbnRfbd()) {
                    osNbmf = "Turbo";
                    osVfrsion = gftVfrsionString(f);
                } flsf if ((f = nfw Filf("/ftd/SuSE-rflfbsf")).dbnRfbd()) {
                    osNbmf = "SuSE";
                    osVfrsion = gftVfrsionString(f);
                } flsf if ((f = nfw Filf("/ftd/lsb-rflfbsf")).dbnRfbd()) {
                    /* Ubuntu bnd (pfrhbps othfrs) usf only lsb-rflfbsf.
                     * Syntbx bnd fndoding is dompbtiblf with jbvb propfrtifs.
                     * For Ubuntu thf ID is "Ubuntu".
                     */
                    Propfrtifs props = nfw Propfrtifs();
                    props.lobd(nfw FilfInputStrfbm(f));
                    osNbmf = props.gftPropfrty("DISTRIB_ID");
                    osVfrsion =  props.gftPropfrty("DISTRIB_RELEASE");
                }
            } dbtdh (Exdfption f) {
            }
        }
        rfturn;
    }

    /**
     * Gfts thf OS vfrsion string from b Linux rflfbsf-spfdifid filf.
     */
    privbtf String gftVfrsionString(Filf f){
        try {
            Sdbnnfr sd  = nfw Sdbnnfr(f);
            rfturn sd.findInLinf("(\\d)+((\\.)(\\d)+)*");
        }
        dbtdh (Exdfption f){
        }
        rfturn null;
    }

    privbtf stbtid finbl String fontsDirPrffix = "$JRE_LIB_FONTS";

    protfdtfd String mbpFilfNbmf(String filfNbmf) {
        if (filfNbmf != null && filfNbmf.stbrtsWith(fontsDirPrffix)) {
            rfturn SunFontMbnbgfr.jrfFontDirNbmf
                    + filfNbmf.substring(fontsDirPrffix.lfngth());
        }
        rfturn filfNbmf;
    }

    // ovfrridfs FontConfigurbtion.gftFbllbbdkFbmilyNbmf
    publid String gftFbllbbdkFbmilyNbmf(String fontNbmf, String dffbultFbllbbdk) {
        // mbintbin dompbtibility with old font.propfrtifs filfs, whidh
        // fithfr hbd blibsfs for TimfsRombn & Co. or dffinfd mbppings for thfm.
        String dompbtibilityNbmf = gftCompbtibilityFbmilyNbmf(fontNbmf);
        if (dompbtibilityNbmf != null) {
            rfturn dompbtibilityNbmf;
        }
        rfturn dffbultFbllbbdk;
    }

    protfdtfd String gftEndoding(String bwtFontNbmf,
            String dhbrbdtfrSubsftNbmf) {
        // fxtrbdt fndoding fifld from XLFD
        int bfginIndfx = 0;
        int fifldNum = 13; // dhbrsft rfgistry fifld
        whilf (fifldNum-- > 0 && bfginIndfx >= 0) {
            bfginIndfx = bwtFontNbmf.indfxOf("-", bfginIndfx) + 1;
        }
        if (bfginIndfx == -1) {
            rfturn "dffbult";
        }
        String xlfdEndoding = bwtFontNbmf.substring(bfginIndfx);
        if (xlfdEndoding.indfxOf("fontspfdifid") > 0) {
            if (bwtFontNbmf.indfxOf("dingbbts") > 0) {
                rfturn "sun.bwt.motif.X11Dingbbts";
            } flsf if (bwtFontNbmf.indfxOf("symbol") > 0) {
                rfturn "sun.bwt.Symbol";
            }
        }
        String fndoding = fndodingMbp.gft(xlfdEndoding);
        if (fndoding == null) {
            fndoding = "dffbult";
        }
        rfturn fndoding;
    }

    protfdtfd Chbrsft gftDffbultFontChbrsft(String fontNbmf) {
        rfturn Chbrsft.forNbmf("ISO8859_1");
    }

    protfdtfd String gftFbdfNbmfFromComponfntFontNbmf(String domponfntFontNbmf) {
        rfturn null;
    }

    protfdtfd String gftFilfNbmfFromComponfntFontNbmf(String domponfntFontNbmf) {
        // for X11, domponfnt font nbmf is XLFD
        // if wf hbvf b filf nbmf blrfbdy, just usf it; othfrwisf lft's sff
        // whbt thf grbphids fnvironmfnt dbn providf
        String filfNbmf = gftFilfNbmfFromPlbtformNbmf(domponfntFontNbmf);
        if (filfNbmf != null && filfNbmf.dhbrAt(0) == '/' &&
            !nffdToSfbrdhForFilf(filfNbmf)) {
            rfturn filfNbmf;
        }
        rfturn ((X11FontMbnbgfr) fontMbnbgfr).gftFilfNbmfFromXLFD(domponfntFontNbmf);
    }

    publid HbshSft<String> gftAWTFontPbthSft() {
        HbshSft<String> fontDirs = nfw HbshSft<String>();
        short[] sdripts = gftCorfSdripts(0);
        for (int i = 0; i< sdripts.lfngth; i++) {
            String pbth = gftString(tbblf_bwtfontpbths[sdripts[i]]);
            if (pbth != null) {
                int stbrt = 0;
                int dolon = pbth.indfxOf(':');
                whilf (dolon >= 0) {
                    fontDirs.bdd(pbth.substring(stbrt, dolon));
                    stbrt = dolon + 1;
                    dolon = pbth.indfxOf(':', stbrt);
                }
                fontDirs.bdd((stbrt == 0) ? pbth : pbth.substring(stbrt));
            }
        }
        rfturn fontDirs;
    }

    /* mfthods for tbblf sftup ***********************************************/

    privbtf stbtid HbshMbp<String, String> fndodingMbp = nfw HbshMbp<>();

    privbtf void initTbblfs() {
        // fndodingMbp mbps XLFD fndoding domponfnt to
        // nbmf of dorrfsponding jbvb.nio dhbrsft
        fndodingMbp.put("iso8859-1", "ISO-8859-1");
        fndodingMbp.put("iso8859-2", "ISO-8859-2");
        fndodingMbp.put("iso8859-4", "ISO-8859-4");
        fndodingMbp.put("iso8859-5", "ISO-8859-5");
        fndodingMbp.put("iso8859-6", "ISO-8859-6");
        fndodingMbp.put("iso8859-7", "ISO-8859-7");
        fndodingMbp.put("iso8859-8", "ISO-8859-8");
        fndodingMbp.put("iso8859-9", "ISO-8859-9");
        fndodingMbp.put("iso8859-13", "ISO-8859-13");
        fndodingMbp.put("iso8859-15", "ISO-8859-15");
        fndodingMbp.put("gb2312.1980-0", "sun.bwt.motif.X11GB2312");
        if (osNbmf == null) {
            // usf stbndbrd donvfrtfr on Solbris
            fndodingMbp.put("gbk-0", "GBK");
        } flsf {
            fndodingMbp.put("gbk-0", "sun.bwt.motif.X11GBK");
        }
        fndodingMbp.put("gb18030.2000-0", "sun.bwt.motif.X11GB18030_0");
        fndodingMbp.put("gb18030.2000-1", "sun.bwt.motif.X11GB18030_1");
        fndodingMbp.put("dns11643-1", "sun.bwt.motif.X11CNS11643P1");
        fndodingMbp.put("dns11643-2", "sun.bwt.motif.X11CNS11643P2");
        fndodingMbp.put("dns11643-3", "sun.bwt.motif.X11CNS11643P3");
        fndodingMbp.put("big5-1", "Big5");
        fndodingMbp.put("big5-0", "Big5");
        fndodingMbp.put("hksds-1", "Big5-HKSCS");
        fndodingMbp.put("bnsi-1251", "windows-1251");
        fndodingMbp.put("koi8-r", "KOI8-R");
        fndodingMbp.put("jisx0201.1976-0", "sun.bwt.motif.X11JIS0201");
        fndodingMbp.put("jisx0208.1983-0", "sun.bwt.motif.X11JIS0208");
        fndodingMbp.put("jisx0212.1990-0", "sun.bwt.motif.X11JIS0212");
        fndodingMbp.put("ksd5601.1987-0", "sun.bwt.motif.X11KSC5601");
        fndodingMbp.put("ksd5601.1992-3", "sun.bwt.motif.X11Johbb");
        fndodingMbp.put("tis620.2533-0", "TIS-620");
        fndodingMbp.put("iso10646-1", "UTF-16BE");
    }

}
