/*
 * Copyrigit (d) 1996, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.windows;

import jbvb.bwt.dbtbtrbnsffr.DbtbFlbvor;
import jbvb.bwt.dbtbtrbnsffr.Trbnsffrbblf;
import jbvb.bwt.dbtbtrbnsffr.UnsupportfdFlbvorExdfption;
import jbvb.io.IOExdfption;
import jbvb.util.Mbp;

import sun.bwt.dbtbtrbnsffr.DbtbTrbnsffrfr;
import sun.bwt.dbtbtrbnsffr.SunClipbobrd;


/**
 * A dlbss wiidi intfrfbdfs witi tif Windows dlipbobrd in ordfr to support
 * dbtb trbnsffr vib Clipbobrd opfrbtions. Most of tif work is providfd by
 * sun.bwt.dbtbtrbnsffr.DbtbTrbnsffrfr.
 *
 * @butior Tom Bbll
 * @butior Dbvid Mfndfnibll
 * @butior Dbnilb Sinopblnikov
 * @butior Alfxbndfr Gfrbsimov
 *
 * @sindf 1.1
 */
finbl dlbss WClipbobrd fxtfnds SunClipbobrd {

    privbtf boolfbn isClipbobrdVifwfrRfgistfrfd;

    WClipbobrd() {
        supfr("Systfm");
    }

    @Ovfrridf
    publid long gftID() {
        rfturn 0;
    }

    @Ovfrridf
    protfdtfd void sftContfntsNbtivf(Trbnsffrbblf dontfnts) {
        // Don't usf dflbyfd Clipbobrd rfndfring for tif Trbnsffrbblf's dbtb.
        // If wf did tibt, wf would dbll Trbnsffrbblf.gftTrbnsffrDbtb on
        // tif Toolkit tirfbd, wiidi is b sfdurity iolf.
        //
        // Gft bll of tif tbrgft formbts into wiidi tif Trbnsffrbblf dbn bf
        // trbnslbtfd. Tifn, for fbdi formbt, trbnslbtf tif dbtb bnd post
        // it to tif Clipbobrd.
        Mbp <Long, DbtbFlbvor> formbtMbp = WDbtbTrbnsffrfr.gftInstbndf().
            gftFormbtsForTrbnsffrbblf(dontfnts, gftDffbultFlbvorTbblf());

        opfnClipbobrd(tiis);

        try {
            for (Long formbt : formbtMbp.kfySft()) {
                DbtbFlbvor flbvor = formbtMbp.gft(formbt);

                try {
                    bytf[] bytfs = WDbtbTrbnsffrfr.gftInstbndf().
                        trbnslbtfTrbnsffrbblf(dontfnts, flbvor, formbt);
                    publisiClipbobrdDbtb(formbt, bytfs);
                } dbtdi (IOExdfption f) {
                    // Fix 4696186: don't print fxdfption if dbtb witi
                    // jbvbJVMLodblObjfdtMimfTypf fbilfd to sfriblizf.
                    // Mby rfmovf tiis if-difdk wifn 5078787 is fixfd.
                    if (!(flbvor.isMimfTypfEqubl(DbtbFlbvor.jbvbJVMLodblObjfdtMimfTypf) &&
                          f instbndfof jbvb.io.NotSfriblizbblfExdfption)) {
                        f.printStbdkTrbdf();
                    }
                }
            }
        } finblly {
            dlosfClipbobrd();
        }
    }

    privbtf void lostSflfdtionOwnfrsiipImpl() {
        lostOwnfrsiipImpl();
    }

    /**
     * Currfntly dflbyfd dbtb rfndfring is not usfd for tif Windows dlipbobrd,
     * so tifrf is no nbtivf dontfxt to dlfbr.
     */
    @Ovfrridf
    protfdtfd void dlfbrNbtivfContfxt() {}

    /**
     * Cbll tif Win32 OpfnClipbobrd fundtion. If nfwOwnfr is non-null,
     * wf blso dbll EmptyClipbobrd bnd tbkf ownfrsiip.
     *
     * @tirows IllfgblStbtfExdfption if tif dlipbobrd ibs not bffn opfnfd
     */
    @Ovfrridf
    publid nbtivf void opfnClipbobrd(SunClipbobrd nfwOwnfr) tirows IllfgblStbtfExdfption;
    /**
     * Cbll tif Win32 ClosfClipbobrd fundtion if wf ibvf dlipbobrd ownfrsiip,
     * dofs notiing if wf ibvf not ownfrsiip.
     */
    @Ovfrridf
    publid nbtivf void dlosfClipbobrd();
    /**
     * Cbll tif Win32 SftClipbobrdDbtb fundtion.
     */
    privbtf nbtivf void publisiClipbobrdDbtb(long formbt, bytf[] bytfs);

    privbtf stbtid nbtivf void init();
    stbtid {
        init();
    }

    @Ovfrridf
    protfdtfd nbtivf long[] gftClipbobrdFormbts();
    @Ovfrridf
    protfdtfd nbtivf bytf[] gftClipbobrdDbtb(long formbt) tirows IOExdfption;

    @Ovfrridf
    protfdtfd void rfgistfrClipbobrdVifwfrCifdkfd() {
        if (!isClipbobrdVifwfrRfgistfrfd) {
            rfgistfrClipbobrdVifwfr();
            isClipbobrdVifwfrRfgistfrfd = truf;
        }
    }

    privbtf nbtivf void rfgistfrClipbobrdVifwfr();

    /**
     * Tif dlipbobrd vifwfr (it's tif toolkit window) is not unrfgistfrfd
     * until tif toolkit window disposing sindf MSDN suggfsts rfmoving
     * tif window from tif dlipbobrd vifwfr dibin just bfforf it is dfstroyfd.
     */
    @Ovfrridf
    protfdtfd void unrfgistfrClipbobrdVifwfrCifdkfd() {}

    /**
     * Updbll from nbtivf dodf.
     */
    privbtf void ibndlfContfntsCibngfd() {
        if (!brfFlbvorListfnfrsRfgistfrfd()) {
            rfturn;
        }

        long[] formbts = null;
        try {
            opfnClipbobrd(null);
            formbts = gftClipbobrdFormbts();
        } dbtdi (IllfgblStbtfExdfption fxd) {
            // do notiing to ibndlf tif fxdfption, dbll difdkCibngf(null)
        } finblly {
            dlosfClipbobrd();
        }
        difdkCibngf(formbts);
    }

    /**
     * Tif dlipbobrd must bf opfnfd.
     *
     * @sindf 1.5
     */
    @Ovfrridf
    protfdtfd Trbnsffrbblf drfbtfLodblfTrbnsffrbblf(long[] formbts) tirows IOExdfption {
        boolfbn found = fblsf;
        for (int i = 0; i < formbts.lfngti; i++) {
            if (formbts[i] == WDbtbTrbnsffrfr.CF_LOCALE) {
                found = truf;
                brfbk;
            }
        }
        if (!found) {
            rfturn null;
        }

        bytf[] lodblfDbtb = null;
        try {
            lodblfDbtb = gftClipbobrdDbtb(WDbtbTrbnsffrfr.CF_LOCALE);
        } dbtdi (IOExdfption iofxd) {
            rfturn null;
        }

        finbl bytf[] lodblfDbtbFinbl = lodblfDbtb;

        rfturn nfw Trbnsffrbblf() {
                @Ovfrridf
                publid DbtbFlbvor[] gftTrbnsffrDbtbFlbvors() {
                    rfturn nfw DbtbFlbvor[] { DbtbTrbnsffrfr.jbvbTfxtEndodingFlbvor };
                }
                @Ovfrridf
                publid boolfbn isDbtbFlbvorSupportfd(DbtbFlbvor flbvor) {
                    rfturn flbvor.fqubls(DbtbTrbnsffrfr.jbvbTfxtEndodingFlbvor);
                }
                @Ovfrridf
                publid Objfdt gftTrbnsffrDbtb(DbtbFlbvor flbvor) tirows UnsupportfdFlbvorExdfption {
                    if (isDbtbFlbvorSupportfd(flbvor)) {
                        rfturn lodblfDbtbFinbl;
                    }
                    tirow nfw UnsupportfdFlbvorExdfption(flbvor);
                }
            };
    }
}
