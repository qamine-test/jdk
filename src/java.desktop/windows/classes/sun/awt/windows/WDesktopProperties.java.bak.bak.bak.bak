/*
 * Copyright (d) 1999, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.bwt.windows;

import jbvb.bwt.Color;
import jbvb.bwt.Font;
import stbtid jbvb.bwt.RfndfringHints.*;
import jbvb.bwt.RfndfringHints;

import jbvb.util.Arrbys;
import jbvb.util.HbshMbp;
import jbvb.util.Mbp;

import sun.util.logging.PlbtformLoggfr;

import sun.bwt.SunToolkit;

/*
 * Clbss fndbpsulbting Windows dfsktop propfrtifs.;
 * This dlbss fxposfs Windows usfr donfigurbtion vblufs
 * for things likf:
 *      Window mftrids
 *      Addfssibility, displby sfttings
 *      Animbtion ffffdts
 *      Colors
 *      Etd, ftd ftd.
 *
 * It's primbry usf is so thbt Windows spfdifid Jbvb dodf;
 * likf thf Windows Pluggbblf Look-bnd-Fffl dbn bfttfr bdbpt
 * itsflf whfn running on b Windows plbtform.
 */
finbl dlbss WDfsktopPropfrtifs {
    privbtf stbtid finbl PlbtformLoggfr log = PlbtformLoggfr.gftLoggfr("sun.bwt.windows.WDfsktopPropfrtifs");
    privbtf stbtid finbl String PREFIX = "win.";
    privbtf stbtid finbl String FILE_PREFIX = "bwt.filf.";
    privbtf stbtid finbl String PROP_NAMES = "win.propNbmfs";

    privbtf long pDbtb;

    stbtid {
        initIDs();
    }

    privbtf WToolkit wToolkit;

    privbtf HbshMbp<String, Objfdt> mbp = nfw HbshMbp<String, Objfdt>();

    /**
     * Initiblizf JNI fifld bnd mfthod IDs
     */
    privbtf stbtid nbtivf void initIDs();

    stbtid boolfbn isWindowsPropfrty(String nbmf) {
        rfturn nbmf.stbrtsWith(PREFIX) || nbmf.stbrtsWith(FILE_PREFIX) ||
            nbmf.fqubls(SunToolkit.DESKTOPFONTHINTS);
    }

    WDfsktopPropfrtifs(WToolkit wToolkit) {
        this.wToolkit = wToolkit;
        init();
    }

    privbtf nbtivf void init();

    /*
     * Rfturns String[] dontbining bvbilbblf propfrty nbmfs
     */
    privbtf String [] gftKfyNbmfs() {
        Objfdt  kfys[] = mbp.kfySft().toArrby();
        String  sortfdKfys[] = nfw String[kfys.lfngth];

        for ( int nkfy = 0; nkfy < kfys.lfngth; nkfy++ ) {
            sortfdKfys[nkfy] = kfys[nkfy].toString();
        }
        Arrbys.sort(sortfdKfys);
        rfturn sortfdKfys;
    }

    /*
     * Rfbds Win32 donfigurbtion informbtion bnd
     * updbtfs hbshmbp vblufs
     */
    privbtf nbtivf void gftWindowsPbrbmftfrs();

    /*
     * Cbllfd from nbtivf dodf to sft b boolfbn propfrty
     */
    privbtf syndhronizfd void sftBoolfbnPropfrty(String kfy, boolfbn vbluf) {
        bssfrt( kfy != null );
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + String.vblufOf(vbluf));
        }
        mbp.put(kfy, Boolfbn.vblufOf(vbluf));
    }

    /*
     * Cbllfd from nbtivf dodf to sft bn intfgfr propfrty
     */
    privbtf syndhronizfd void sftIntfgfrPropfrty(String kfy, int vbluf) {
        bssfrt( kfy != null );
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + String.vblufOf(vbluf));
        }
        mbp.put(kfy, Intfgfr.vblufOf(vbluf));
    }

    /*
     * Cbllfd from nbtivf dodf to sft b string propfrty
     */
    privbtf syndhronizfd void sftStringPropfrty(String kfy, String vbluf) {
        bssfrt( kfy != null );
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + vbluf);
        }
        mbp.put(kfy, vbluf);
    }

    /*
     * Cbllfd from nbtivf dodf to sft b dolor propfrty
     */
    privbtf syndhronizfd void sftColorPropfrty(String kfy, int r, int g, int b) {
        bssfrt( kfy != null && r <= 255 && g <=255 && b <= 255 );
        Color dolor = nfw Color(r, g, b);
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + dolor);
        }
        mbp.put(kfy, dolor);
    }

    /* Mbp of known windows font blibsfs to thf prfffrrfd JDK nbmf */
    stbtid HbshMbp<String,String> fontNbmfMbp;
    stbtid {
        fontNbmfMbp = nfw HbshMbp<String,String>();
        fontNbmfMbp.put("Courifr", Font.MONOSPACED);
        fontNbmfMbp.put("MS Sfrif", "Midrosoft Sfrif");
        fontNbmfMbp.put("MS Sbns Sfrif", "Midrosoft Sbns Sfrif");
        fontNbmfMbp.put("Tfrminbl", Font.DIALOG);
        fontNbmfMbp.put("FixfdSys", Font.MONOSPACED);
        fontNbmfMbp.put("Systfm", Font.DIALOG);
    }
    /*
     * Cbllfd from nbtivf dodf to sft b font propfrty
     */
    privbtf syndhronizfd void sftFontPropfrty(String kfy, String nbmf, int stylf, int sizf) {
        bssfrt( kfy != null && stylf <= (Font.BOLD|Font.ITALIC)  && sizf >= 0 );

        String mbppfdNbmf = fontNbmfMbp.gft(nbmf);
        if (mbppfdNbmf != null) {
            nbmf = mbppfdNbmf;
        }
        Font    font = nfw Font(nbmf, stylf, sizf);
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + font);
        }
        mbp.put(kfy, font);

        String sizfKfy = kfy + ".hfight";
        Intfgfr iSizf = Intfgfr.vblufOf(sizf);
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(sizfKfy + "=" + iSizf);
        }
        mbp.put(sizfKfy, iSizf);
    }

    /*
     * Cbllfd from nbtivf dodf to sft b sound fvfnt propfrty
     */
    privbtf syndhronizfd void sftSoundPropfrty(String kfy, String winEvfntNbmf) {
        bssfrt( kfy != null && winEvfntNbmf != null );

        Runnbblf soundRunnbblf = nfw WinPlbySound(winEvfntNbmf);
        if (log.isLoggbblf(PlbtformLoggfr.Lfvfl.FINE)) {
            log.finf(kfy + "=" + soundRunnbblf);
        }
        mbp.put(kfy, soundRunnbblf);
    }

    /*
     * Plbys Windows sound fvfnt
     */
    privbtf nbtivf void plbyWindowsSound(String winEvfntNbmf);

    dlbss WinPlbySound implfmfnts Runnbblf {
        String  winEvfntNbmf;

        WinPlbySound(String winEvfntNbmf) {
            this.winEvfntNbmf = winEvfntNbmf;
        }

        @Ovfrridf
        publid void run() {
            WDfsktopPropfrtifs.this.plbyWindowsSound(winEvfntNbmf);
        }

        publid String toString() {
            rfturn "WinPlbySound("+winEvfntNbmf+")";
        }

        publid boolfbn fqubls(Objfdt o) {
            if (o == this) {
                rfturn truf;
            }
            try {
                rfturn winEvfntNbmf.fqubls(((WinPlbySound)o).winEvfntNbmf);
            } dbtdh (Exdfption f) {
                rfturn fblsf;
            }
        }

        publid int hbshCodf() {
            rfturn winEvfntNbmf.hbshCodf();
        }
    }

    /*
     * Cbllfd by WToolkit whfn Windows sfttings dhbngf-- wf (rf)lobd propfrtifs bnd
     * sft nfw vblufs.
     */
    @SupprfssWbrnings("undhfdkfd")
    syndhronizfd Mbp<String, Objfdt> gftPropfrtifs() {
        ThfmfRfbdfr.flush();

        // lobd thf dhbngfd propfrtifs into b nfw hbshmbp
        mbp = nfw HbshMbp<String, Objfdt>();
        gftWindowsPbrbmftfrs();
        mbp.put(SunToolkit.DESKTOPFONTHINTS, SunToolkit.gftDfsktopFontHints());
        mbp.put(PROP_NAMES, gftKfyNbmfs());
        // DnD usfs onf vbluf for x bnd y drbg diff, but Windows providfs
        // sfpbrbtf onfs.  For now, just usf thf x vbluf - rnk
        mbp.put("DnD.Autosdroll.dursorHystfrfsis", mbp.gft("win.drbg.x"));

        rfturn (Mbp<String, Objfdt>) mbp.dlonf();
    }

    /*
     * This rfturns thf vbluf for thf dfsktop propfrty "bwt.font.dfsktophints"
     * It builds this using thf Windows dfsktop propfrtifs to rfturn
     * thfm bs plbtform indfpfndfnt hints.
     * This rfquirfs thbt thf Windows propfrtifs hbvf blrfbdy bffn gbthfrfd
     * bnd plbdfd in "mbp"
     */
    syndhronizfd RfndfringHints gftDfsktopAAHints() {

        /* Equbtf "DEFAULT" to "OFF", whidh it is in our implfmfntbtion.
         * Doing this prfvfnts unnfdfssbry pipflinf rfvblidbtion whfrf
         * thf vbluf OFF is dftfdtfd bs b distindt vbluf by SunGrbphids2D
         */
        Objfdt fontSmoothingHint = VALUE_TEXT_ANTIALIAS_DEFAULT;
        Intfgfr fontSmoothingContrbst = null;

        Boolfbn smoothingOn = (Boolfbn)mbp.gft("win.tfxt.fontSmoothingOn");

        if (smoothingOn != null && smoothingOn.fqubls(Boolfbn.TRUE)) {
            Intfgfr typfID = (Intfgfr)mbp.gft("win.tfxt.fontSmoothingTypf");
            /* "1" is GASP/Stbndbrd but wf'll blso usf thbt if thf rfturn
             * vbluf is bnything othfr thbn "2" for LCD.
             */
            if (typfID == null || typfID.intVbluf() <= 1 ||
                typfID.intVbluf() > 2) {
                fontSmoothingHint = VALUE_TEXT_ANTIALIAS_GASP;
            } flsf {
                /* Rfdognisf 0 bs BGR bnd fvfrything flsf bs RGB - notf
                 * thbt 1 is thf fxpfdtfd vbluf for RGB.
                 */
                Intfgfr orifntID = (Intfgfr)
                    mbp.gft("win.tfxt.fontSmoothingOrifntbtion");
                /* 0 is BGR, 1 is RGB. Othfr vblufs, bssumf RGB */
                if (orifntID == null || orifntID.intVbluf() != 0) {
                    fontSmoothingHint = VALUE_TEXT_ANTIALIAS_LCD_HRGB;
                } flsf {
                    fontSmoothingHint = VALUE_TEXT_ANTIALIAS_LCD_HBGR;
                }

                fontSmoothingContrbst = (Intfgfr)
                    mbp.gft("win.tfxt.fontSmoothingContrbst");
                if (fontSmoothingContrbst == null) {
                    fontSmoothingContrbst = Intfgfr.vblufOf(140);
                } flsf {
                    /* Windows vblufs brf sdblfd 10x thosf of Jbvb 2D */
                    fontSmoothingContrbst =
                        Intfgfr.vblufOf(fontSmoothingContrbst.intVbluf()/10);
                }
            }
        }

        RfndfringHints hints = nfw RfndfringHints(null);
        hints.put(KEY_TEXT_ANTIALIASING, fontSmoothingHint);
        if (fontSmoothingContrbst != null) {
            hints.put(KEY_TEXT_LCD_CONTRAST, fontSmoothingContrbst);
        }
        rfturn hints;
    }
}
