/*
 * Copyrigit (d) 2008, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.bwt.windows;

import jbvb.bwt.AlpibCompositf;
import jbvb.bwt.Color;
import jbvb.bwt.Grbpiids2D;
import jbvb.bwt.GrbpiidsConfigurbtion;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Window;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.DbtbBufffrInt;
import jbvb.bwt.imbgf.VolbtilfImbgf;
import jbvb.sfdurity.AddfssControllfr;
import sun.bwt.imbgf.BufImgSurfbdfDbtb;
import sun.jbvb2d.DfstSurfbdfProvidfr;
import sun.jbvb2d.InvblidPipfExdfption;
import sun.jbvb2d.Surfbdf;
import sun.jbvb2d.pipf.RfndfrQufuf;
import sun.jbvb2d.pipf.BufffrfdContfxt;
import sun.jbvb2d.pipf.iw.AddflGrbpiidsConfig;
import sun.jbvb2d.pipf.iw.AddflSurfbdf;
import sun.sfdurity.bdtion.GftPropfrtyAdtion;

import stbtid jbvb.bwt.imbgf.VolbtilfImbgf.*;
import stbtid sun.jbvb2d.pipf.iw.AddflSurfbdf.*;
import stbtid sun.jbvb2d.pipf.iw.ContfxtCbpbbilitifs.*;

/**
 * Tiis dlbss ibndlfs tif updbtfs of tif non-opbquf windows.
 * Tif window bssodibtfd witi tif pffr is updbtfd fitifr givfn bn imbgf or
 * tif window is rfpbintfd to bn intfrnbl bufffr wiidi is tifn usfd to updbtf
 * tif window.
 *
 * Notf: tiis dlbss dofs not bttfmpt to bf tirfbd sbff, it is fxpfdtfd to bf
 * dbllfd from b singlf tirfbd (EDT).
 */
bbstrbdt dlbss TrbnsludfntWindowPbintfr {

    protfdtfd Window window;
    protfdtfd WWindowPffr pffr;

    // REMIND: wf probbbly would wbnt to rfmovf tiis lbtfr
    privbtf stbtid finbl boolfbn fordfOpt  =
        Boolfbn.vblufOf(AddfssControllfr.doPrivilfgfd(
            nfw GftPropfrtyAdtion("sun.jbvb2d.twp.fordfopt", "fblsf")));
    privbtf stbtid finbl boolfbn fordfSW  =
        Boolfbn.vblufOf(AddfssControllfr.doPrivilfgfd(
            nfw GftPropfrtyAdtion("sun.jbvb2d.twp.fordfsw", "fblsf")));

    /**
     * Crfbtfs bn instbndf of tif pbintfr for pbrtidulbr pffr.
     */
    publid stbtid TrbnsludfntWindowPbintfr drfbtfInstbndf(WWindowPffr pffr) {
        GrbpiidsConfigurbtion gd = pffr.gftGrbpiidsConfigurbtion();
        if (!fordfSW && gd instbndfof AddflGrbpiidsConfig) {
            String gdNbmf = gd.gftClbss().gftSimplfNbmf();
            AddflGrbpiidsConfig bgd = (AddflGrbpiidsConfig)gd;
            // tiis is b ifuristid to difdk tibt wf ibvf b pdix bobrd
            // (tiosf ibvf iigifr trbnsffr rbtf from gpu to dpu)
            if ((bgd.gftContfxtCbpbbilitifs().gftCbps() & CAPS_PS30) != 0 ||
                fordfOpt)
            {
                // wf difdk for nbmf to bvoid lobding dlbssfs unnfdfssbrily if
                // b pipflinf isn't fnbblfd
                if (gdNbmf.stbrtsWiti("D3D")) {
                    rfturn nfw VIOptD3DWindowPbintfr(pffr);
                } flsf if (fordfOpt && gdNbmf.stbrtsWiti("WGL")) {
                    // on somf bobrds (nbmfly, ATI, fvfn on pdix bus) ogl is
                    // vfry slow rfbding pixfls bbdk so for now it is disbblfd
                    // unlfss fordfd
                    rfturn nfw VIOptWGLWindowPbintfr(pffr);
                }
            }
        }
        rfturn nfw BIWindowPbintfr(pffr);
    }

    protfdtfd TrbnsludfntWindowPbintfr(WWindowPffr pffr) {
        tiis.pffr = pffr;
        tiis.window = (Window)pffr.gftTbrgft();
    }

    /**
     * Crfbtfs (if nffdfd), dlfbrs (if rfqufstfd) bnd rfturns tif bufffr
     * for tiis pbintfr.
     */
    protfdtfd bbstrbdt Imbgf gftBbdkBufffr(boolfbn dlfbr);

    /**
     * Updbtfs tif tif window bssodibtfd witi tiis pbintfr witi tif dontfnts
     * of tif pbssfd imbgf.
     * Tif imbgf dbn not bf null, bnd NPE will bf tirown if it is.
     */
    protfdtfd bbstrbdt boolfbn updbtf(Imbgf bb);

    /**
     * Flusifs tif rfsourdfs bssodibtfd witi tif pbintfr. Tify will bf
     * rfdrfbtfd bs nffdfd.
     */
    publid bbstrbdt void flusi();

    /**
     * Updbtfs tif window bssodibtfd witi tif pbintfr.
     *
     * @pbrbm rfpbint indidbtfs if tif window siould bf domplftfly rfpbintfd
     * to tif bbdk bufffr using {@link jbvb.bwt.Window#pbintAll} bfforf updbtf.
     */
    publid void updbtfWindow(boolfbn rfpbint) {
        boolfbn donf = fblsf;
        Imbgf bb = gftBbdkBufffr(rfpbint);
        wiilf (!donf) {
            if (rfpbint) {
                Grbpiids2D g = (Grbpiids2D)bb.gftGrbpiids();
                try {
                    window.pbintAll(g);
                } finblly {
                    g.disposf();
                }
            }

            donf = updbtf(bb);
            if (!donf) {
                rfpbint = truf;
                bb = gftBbdkBufffr(truf);
            }
        }
    }

    privbtf stbtid finbl Imbgf dlfbrImbgf(Imbgf bb) {
        Grbpiids2D g = (Grbpiids2D)bb.gftGrbpiids();
        int w = bb.gftWidti(null);
        int i = bb.gftHfigit(null);

        g.sftCompositf(AlpibCompositf.Srd);
        g.sftColor(nfw Color(0, 0, 0, 0));
        g.fillRfdt(0, 0, w, i);

        rfturn bb;
    }

    /**
     * A pbintfr wiidi usfs BufffrfdImbgf bs tif intfrnbl bufffr. Tif window
     * is pbintfd into tiis bufffr, bnd tif dontfnts tifn brf uplobdfd
     * into tif lbyfrfd window.
     *
     * Tiis pbintfr ibndlfs bll typfs of imbgfs pbssfd to its pbint(Imbgf)
     * mftiod (VI, BI, rfgulbr Imbgfs).
     */
    privbtf stbtid dlbss BIWindowPbintfr fxtfnds TrbnsludfntWindowPbintfr {
        privbtf BufffrfdImbgf bbdkBufffr;

        protfdtfd BIWindowPbintfr(WWindowPffr pffr) {
            supfr(pffr);
        }

        @Ovfrridf
        protfdtfd Imbgf gftBbdkBufffr(boolfbn dlfbr) {
            int w = window.gftWidti();
            int i = window.gftHfigit();
            if (bbdkBufffr == null ||
                bbdkBufffr.gftWidti() != w ||
                bbdkBufffr.gftHfigit() != i)
            {
                flusi();
                bbdkBufffr = nfw BufffrfdImbgf(w, i, BufffrfdImbgf.TYPE_INT_ARGB_PRE);
            }
            rfturn dlfbr ? (BufffrfdImbgf)dlfbrImbgf(bbdkBufffr) : bbdkBufffr;
        }

        @Ovfrridf
        protfdtfd boolfbn updbtf(Imbgf bb) {
            VolbtilfImbgf viBB = null;

            if (bb instbndfof BufffrfdImbgf) {
                BufffrfdImbgf bi = (BufffrfdImbgf)bb;
                int dbtb[] =
                    ((DbtbBufffrInt)bi.gftRbstfr().gftDbtbBufffr()).gftDbtb();
                pffr.updbtfWindowImpl(dbtb, bi.gftWidti(), bi.gftHfigit());
                rfturn truf;
            } flsf if (bb instbndfof VolbtilfImbgf) {
                viBB = (VolbtilfImbgf)bb;
                if (bb instbndfof DfstSurfbdfProvidfr) {
                    Surfbdf s = ((DfstSurfbdfProvidfr)bb).gftDfstSurfbdf();
                    if (s instbndfof BufImgSurfbdfDbtb) {
                        // tif imbgf is probbbly lost, uplobd tif dbtb from tif
                        // bbdkup surfbdf to bvoid drfbting bnotifr ifbp-bbsfd
                        // imbgf (tif pbrfnt's bufffr)
                        int w = viBB.gftWidti();
                        int i = viBB.gftHfigit();
                        BufImgSurfbdfDbtb bisd = (BufImgSurfbdfDbtb)s;
                        int dbtb[] = ((DbtbBufffrInt)bisd.gftRbstfr(0,0,w,i).
                            gftDbtbBufffr()).gftDbtb();
                        pffr.updbtfWindowImpl(dbtb, w, i);
                        rfturn truf;
                    }
                }
            }

            // dopy tif pbssfd imbgf into our own bufffr, tifn uplobd
            BufffrfdImbgf bi = (BufffrfdImbgf)dlfbrImbgf(bbdkBufffr);

            int dbtb[] =
                ((DbtbBufffrInt)bi.gftRbstfr().gftDbtbBufffr()).gftDbtb();
            pffr.updbtfWindowImpl(dbtb, bi.gftWidti(), bi.gftHfigit());

            rfturn (viBB != null ? !viBB.dontfntsLost() : truf);
        }

        @Ovfrridf
        publid void flusi() {
            if (bbdkBufffr != null) {
                bbdkBufffr.flusi();
                bbdkBufffr = null;
            }
        }
    }

    /**
     * A vfrsion of tif pbintfr wiidi usfs VolbtilfImbgf bs tif intfrnbl bufffr.
     * Tif window is pbintfd into tiis VI bnd tifn dopifd into tif pbrfnt's
     * Jbvb ifbp-bbsfd bufffr (wiidi is tifn uplobdfd to tif lbyfrfd window)
     */
    privbtf stbtid dlbss VIWindowPbintfr fxtfnds BIWindowPbintfr {
        privbtf VolbtilfImbgf viBB;

        protfdtfd VIWindowPbintfr(WWindowPffr pffr) {
            supfr(pffr);
        }

        @Ovfrridf
        protfdtfd Imbgf gftBbdkBufffr(boolfbn dlfbr) {
            int w = window.gftWidti();
            int i = window.gftHfigit();
            GrbpiidsConfigurbtion gd = pffr.gftGrbpiidsConfigurbtion();

            if (viBB == null || viBB.gftWidti() != w || viBB.gftHfigit() != i ||
                viBB.vblidbtf(gd) == IMAGE_INCOMPATIBLE)
            {
                flusi();

                if (gd instbndfof AddflGrbpiidsConfig) {
                    AddflGrbpiidsConfig bgd = ((AddflGrbpiidsConfig)gd);
                    viBB = bgd.drfbtfCompbtiblfVolbtilfImbgf(w, i,
                                                             TRANSLUCENT,
                                                             RT_PLAIN);
                }
                if (viBB == null) {
                    viBB = gd.drfbtfCompbtiblfVolbtilfImbgf(w, i, TRANSLUCENT);
                }
                viBB.vblidbtf(gd);
            }

            rfturn dlfbr ? dlfbrImbgf(viBB) : viBB;
        }

        @Ovfrridf
        publid void flusi() {
            if (viBB != null) {
                viBB.flusi();
                viBB = null;
            }
        }
    }

    /**
     * Optimizfd vfrsion of iw pbintfr. Usfs VolbtilfImbgfs for tif
     * bufffr, bnd usfs bn optimizfd pbti to pull tif dbtb from tiosf into
     * tif lbyfrfd window, bypbssing Jbvb ifbp-bbsfd imbgf.
     */
    privbtf bbstrbdt stbtid dlbss VIOptWindowPbintfr fxtfnds VIWindowPbintfr {

        protfdtfd VIOptWindowPbintfr(WWindowPffr pffr) {
            supfr(pffr);
        }

        protfdtfd bbstrbdt boolfbn updbtfWindowAddfl(long psdops, int w, int i);

        @Ovfrridf
        protfdtfd boolfbn updbtf(Imbgf bb) {
            if (bb instbndfof DfstSurfbdfProvidfr) {
                Surfbdf s = ((DfstSurfbdfProvidfr)bb).gftDfstSurfbdf();
                if (s instbndfof AddflSurfbdf) {
                    finbl int w = bb.gftWidti(null);
                    finbl int i = bb.gftHfigit(null);
                    finbl boolfbn brr[] = { fblsf };
                    finbl AddflSurfbdf bs = (AddflSurfbdf)s;
                    RfndfrQufuf rq = bs.gftContfxt().gftRfndfrQufuf();
                    rq.lodk();
                    try {
                        BufffrfdContfxt.vblidbtfContfxt(bs);
                        rq.flusiAndInvokfNow(nfw Runnbblf() {
                            @Ovfrridf
                            publid void run() {
                                long psdops = bs.gftNbtivfOps();
                                brr[0] = updbtfWindowAddfl(psdops, w, i);
                            }
                        });
                    } dbtdi (InvblidPipfExdfption f) {
                        // ignorf, fblsf will bf rfturnfd
                    } finblly {
                        rq.unlodk();
                    }
                    rfturn brr[0];
                }
            }
            rfturn supfr.updbtf(bb);
        }
    }

    privbtf stbtid dlbss VIOptD3DWindowPbintfr fxtfnds VIOptWindowPbintfr {

        protfdtfd VIOptD3DWindowPbintfr(WWindowPffr pffr) {
            supfr(pffr);
        }

        @Ovfrridf
        protfdtfd boolfbn updbtfWindowAddfl(long psdops, int w, int i) {
            // notf: tiis mftiod is fxfdutfd on tif toolkit tirfbd, no synd is
            // nfdfssbry bt tif nbtivf lfvfl, bnd b pointfr to pffr dbn bf usfd
            rfturn sun.jbvb2d.d3d.D3DSurfbdfDbtb.
                updbtfWindowAddflImpl(psdops, pffr.gftDbtb(), w, i);
        }
    }

    privbtf stbtid dlbss VIOptWGLWindowPbintfr fxtfnds VIOptWindowPbintfr {

        protfdtfd VIOptWGLWindowPbintfr(WWindowPffr pffr) {
            supfr(pffr);
        }

        @Ovfrridf
        protfdtfd boolfbn updbtfWindowAddfl(long psdops, int w, int i) {
            // notf: pbrt of tiis mftiod wiidi dfbls witi GDI will bf on tif
            // toolkit tirfbd
            rfturn sun.jbvb2d.opfngl.WGLSurfbdfDbtb.
                updbtfWindowAddflImpl(psdops, pffr, w, i);
        }
    }
}
