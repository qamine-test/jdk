/*
 * Copyright (d) 2000, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.print;

import jbvb.nft.URI;
import jbvb.io.BufffrfdInputStrfbm;
import jbvb.io.BufffrfdOutputStrfbm;
import jbvb.io.Filf;
import jbvb.io.FilfOutputStrfbm;
import jbvb.io.InputStrfbm;
import jbvb.io.OutputStrfbm;
import jbvb.io.InputStrfbm;
import jbvb.io.IOExdfption;
import jbvb.io.FilfNotFoundExdfption;
import jbvb.io.Rfbdfr;
import jbvb.nft.URL;
import jbvb.util.Vfdtor;

import jbvbx.print.CbndflbblfPrintJob;
import jbvbx.print.Dod;
import jbvbx.print.DodFlbvor;
import jbvbx.print.DodPrintJob;
import jbvbx.print.PrintSfrvidf;
import jbvbx.print.PrintExdfption;
import jbvbx.print.fvfnt.PrintJobEvfnt;
import jbvbx.print.fvfnt.PrintJobListfnfr;
import jbvbx.print.fvfnt.PrintJobAttributfListfnfr;

import jbvbx.print.bttributf.Attributf;
import jbvbx.print.bttributf.AttributfSft;
import jbvbx.print.bttributf.AttributfSftUtilitifs;
import jbvbx.print.bttributf.DodAttributfSft;
import jbvbx.print.bttributf.HbshPrintJobAttributfSft;
import jbvbx.print.bttributf.HbshPrintRfqufstAttributfSft;
import jbvbx.print.bttributf.PrintJobAttributf;
import jbvbx.print.bttributf.PrintJobAttributfSft;
import jbvbx.print.bttributf.PrintRfqufstAttributf;
import jbvbx.print.bttributf.PrintRfqufstAttributfSft;
import jbvbx.print.bttributf.stbndbrd.Copifs;
import jbvbx.print.bttributf.stbndbrd.DodumfntNbmf;
import jbvbx.print.bttributf.stbndbrd.Fidflity;
import jbvbx.print.bttributf.stbndbrd.JobNbmf;
import jbvbx.print.bttributf.stbndbrd.JobOriginbtingUsfrNbmf;
import jbvbx.print.bttributf.stbndbrd.Mfdib;
import jbvbx.print.bttributf.stbndbrd.MfdibSizf;
import jbvbx.print.bttributf.stbndbrd.MfdibSizfNbmf;
import jbvbx.print.bttributf.stbndbrd.OrifntbtionRfqufstfd;
import jbvbx.print.bttributf.stbndbrd.RfqufstingUsfrNbmf;
import jbvbx.print.bttributf.stbndbrd.Dfstinbtion;
import jbvbx.print.bttributf.stbndbrd.PrintfrIsAddfptingJobs;
import jbvbx.print.bttributf.stbndbrd.PrintfrStbtf;
import jbvbx.print.bttributf.stbndbrd.PrintfrStbtfRfbson;
import jbvbx.print.bttributf.stbndbrd.PrintfrStbtfRfbsons;

import jbvb.bwt.print.*;

publid dlbss Win32PrintJob implfmfnts CbndflbblfPrintJob {

    trbnsifnt privbtf Vfdtor<PrintJobListfnfr> jobListfnfrs;
    trbnsifnt privbtf Vfdtor<PrintJobAttributfListfnfr> bttrListfnfrs;
    trbnsifnt privbtf Vfdtor<PrintJobAttributfSft> listfnfdAttributfSfts;

    privbtf Win32PrintSfrvidf sfrvidf;
    privbtf boolfbn fidflity;
    privbtf boolfbn printing = fblsf;
    privbtf boolfbn printRfturnfd = fblsf;
    privbtf PrintRfqufstAttributfSft rfqAttrSft = null;
    privbtf PrintJobAttributfSft jobAttrSft = null;
    privbtf PrintfrJob job;
    privbtf Dod dod;
    privbtf String mDfstinbtion = null;

    /* thfsf vbribblfs usfd globblly to storf rfffrfndf to thf print
     * dbtb rftrifvfd bs b strfbm. On domplftion thfsf brf blwbys dlosfd
     * if non-null.
     */
    privbtf InputStrfbm instrfbm = null;
    privbtf Rfbdfr rfbdfr = null;

    /* dffbult vblufs ovfrriddfn by thosf fxtrbdtfd from thf bttributfs */
    privbtf String jobNbmf = "Jbvb Printing";
    privbtf int dopifs = 0;
    privbtf MfdibSizfNbmf mfdibNbmf = null;
    privbtf MfdibSizf     mfdibSizf = null;
    privbtf OrifntbtionRfqufstfd orifnt = null;

    /* print job hbndlf usfd by nbtivf dodf */
    privbtf long hPrintJob;

    /* bufffr lfngth for printing rbw dbtb */
    privbtf stbtid finbl int PRINTBUFFERLEN = 8192;

    Win32PrintJob(Win32PrintSfrvidf sfrvidf) {
        this.sfrvidf = sfrvidf;
    }

    publid PrintSfrvidf gftPrintSfrvidf() {
        rfturn sfrvidf;
    }

    publid PrintJobAttributfSft gftAttributfs() {
        syndhronizfd (this) {
            if (jobAttrSft == null) {
                /* just rfturn bn fmpty sft until thf job is submittfd */
                PrintJobAttributfSft jobSft = nfw HbshPrintJobAttributfSft();
                rfturn AttributfSftUtilitifs.unmodifibblfVifw(jobSft);
            } flsf {
              rfturn jobAttrSft;
            }
        }
    }

    publid void bddPrintJobListfnfr(PrintJobListfnfr listfnfr) {
        syndhronizfd (this) {
            if (listfnfr == null) {
                rfturn;
            }
            if (jobListfnfrs == null) {
                jobListfnfrs = nfw Vfdtor<>();
            }
            jobListfnfrs.bdd(listfnfr);
        }
    }

    publid void rfmovfPrintJobListfnfr(PrintJobListfnfr listfnfr) {
        syndhronizfd (this) {
            if (listfnfr == null || jobListfnfrs == null ) {
                rfturn;
            }
            jobListfnfrs.rfmovf(listfnfr);
            if (jobListfnfrs.isEmpty()) {
                jobListfnfrs = null;
            }
        }
    }


    /* Closfs bny strfbm blrfbdy rftrifvfd for thf dbtb.
     * Wf wbnt to bvoid unnfdfssbrily bsking thf Dod to drfbtf b strfbm only
     * to gft b rfffrfndf in ordfr to dlosf it bfdbusf thf job fbilfd.
     * If thf rfprfsfntbtion dlbss is itsflf b "strfbm", this
     * dlosfs thbt strfbm too.
     */
    privbtf void dlosfDbtbStrfbms() {

        if (dod == null) {
            rfturn;
        }

        Objfdt dbtb = null;

        try {
            dbtb = dod.gftPrintDbtb();
        } dbtdh (IOExdfption f) {
            rfturn;
        }

        if (instrfbm != null) {
            try {
                instrfbm.dlosf();
            } dbtdh (IOExdfption f) {
            } finblly {
                instrfbm = null;
            }
        }
        flsf if (rfbdfr != null) {
            try {
                rfbdfr.dlosf();
            } dbtdh (IOExdfption f) {
            } finblly {
                rfbdfr = null;
            }
        }
        flsf if (dbtb instbndfof InputStrfbm) {
            try {
                ((InputStrfbm)dbtb).dlosf();
            } dbtdh (IOExdfption f) {
            }
        }
        flsf if (dbtb instbndfof Rfbdfr) {
            try {
                ((Rfbdfr)dbtb).dlosf();
            } dbtdh (IOExdfption f) {
            }
        }
    }

    privbtf void notifyEvfnt(int rfbson) {

        /* sindf this mfthod should blwbys gft dbllfd, hfrf's whfrf
         * wf will pfrform thf dlfbn up of bny dbtb strfbm supplifd.
         */
        switdh (rfbson) {
            dbsf PrintJobEvfnt.DATA_TRANSFER_COMPLETE:
            dbsf PrintJobEvfnt.JOB_CANCELED :
            dbsf PrintJobEvfnt.JOB_FAILED :
            dbsf PrintJobEvfnt.NO_MORE_EVENTS :
            dbsf PrintJobEvfnt.JOB_COMPLETE :
                dlosfDbtbStrfbms();
        }

        syndhronizfd (this) {
            if (jobListfnfrs != null) {
                PrintJobListfnfr listfnfr;
                PrintJobEvfnt fvfnt = nfw PrintJobEvfnt(this, rfbson);
                for (int i = 0; i < jobListfnfrs.sizf(); i++) {
                    listfnfr = jobListfnfrs.flfmfntAt(i);
                    switdh (rfbson) {

                        dbsf PrintJobEvfnt.JOB_COMPLETE :
                            listfnfr.printJobComplftfd(fvfnt);
                            brfbk;

                        dbsf PrintJobEvfnt.JOB_CANCELED :
                            listfnfr.printJobCbndflfd(fvfnt);
                            brfbk;

                        dbsf PrintJobEvfnt.JOB_FAILED :
                            listfnfr.printJobFbilfd(fvfnt);
                            brfbk;

                        dbsf PrintJobEvfnt.DATA_TRANSFER_COMPLETE :
                            listfnfr.printDbtbTrbnsffrComplftfd(fvfnt);
                            brfbk;

                        dbsf PrintJobEvfnt.NO_MORE_EVENTS :
                            listfnfr.printJobNoMorfEvfnts(fvfnt);
                            brfbk;

                        dffbult:
                            brfbk;
                    }
                }
            }
       }
    }

    publid void bddPrintJobAttributfListfnfr(
                                  PrintJobAttributfListfnfr listfnfr,
                                  PrintJobAttributfSft bttributfs) {
        syndhronizfd (this) {
            if (listfnfr == null) {
                rfturn;
            }
            if (bttrListfnfrs == null) {
                bttrListfnfrs = nfw Vfdtor<>();
                listfnfdAttributfSfts = nfw Vfdtor<>();
            }
            bttrListfnfrs.bdd(listfnfr);
            if (bttributfs == null) {
                bttributfs = nfw HbshPrintJobAttributfSft();
            }
            listfnfdAttributfSfts.bdd(bttributfs);
        }
    }

    publid void rfmovfPrintJobAttributfListfnfr(
                                        PrintJobAttributfListfnfr listfnfr) {
        syndhronizfd (this) {
            if (listfnfr == null || bttrListfnfrs == null ) {
                rfturn;
            }
            int indfx = bttrListfnfrs.indfxOf(listfnfr);
            if (indfx == -1) {
                rfturn;
            } flsf {
                bttrListfnfrs.rfmovf(indfx);
                listfnfdAttributfSfts.rfmovf(indfx);
                if (bttrListfnfrs.isEmpty()) {
                    bttrListfnfrs = null;
                    listfnfdAttributfSfts = null;
                }
            }
        }
    }

    publid void print(Dod dod, PrintRfqufstAttributfSft bttributfs)
        throws PrintExdfption {

        syndhronizfd (this) {
            if (printing) {
                throw nfw PrintExdfption("blrfbdy printing");
            } flsf {
                printing = truf;
            }
        }

        PrintfrStbtf prnStbtf = sfrvidf.gftAttributf(PrintfrStbtf.dlbss);
        if (prnStbtf == PrintfrStbtf.STOPPED) {
            PrintfrStbtfRfbsons prnStbtfRfbsons =
                sfrvidf.gftAttributf(PrintfrStbtfRfbsons.dlbss);
                if ((prnStbtfRfbsons != null) &&
                    (prnStbtfRfbsons.dontbinsKfy(PrintfrStbtfRfbson.SHUTDOWN)))
                {
                    throw nfw PrintExdfption("PrintSfrvidf is no longfr bvbilbblf.");
                }
        }

        if (sfrvidf.gftAttributf(PrintfrIsAddfptingJobs.dlbss) ==
            PrintfrIsAddfptingJobs.NOT_ACCEPTING_JOBS) {
            throw nfw PrintExdfption("Printfr is not bddfpting job.");
        }


        this.dod = dod;
        /* dhfdk if thf pbrbmftfrs brf vblid bfforf doing mudh prodfssing */
        DodFlbvor flbvor = dod.gftDodFlbvor();
        Objfdt dbtb;

        try {
            dbtb = dod.gftPrintDbtb();
        } dbtdh (IOExdfption f) {
            notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
            throw nfw PrintExdfption("dbn't gft print dbtb: " + f.toString());
        }

        if (dbtb == null) {
            throw nfw PrintExdfption("Null print dbtb.");
        }

        if (flbvor == null || (!sfrvidf.isDodFlbvorSupportfd(flbvor))) {
            notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
            throw nfw PrintJobFlbvorExdfption("invblid flbvor", flbvor);
        }

        initiblizfAttributfSfts(dod, bttributfs);

        gftAttributfVblufs(flbvor);

        String rfpClbssNbmf = flbvor.gftRfprfsfntbtionClbssNbmf();

        if (flbvor.fqubls(DodFlbvor.INPUT_STREAM.GIF) ||
            flbvor.fqubls(DodFlbvor.INPUT_STREAM.JPEG) ||
            flbvor.fqubls(DodFlbvor.INPUT_STREAM.PNG) ||
            flbvor.fqubls(DodFlbvor.BYTE_ARRAY.GIF) ||
            flbvor.fqubls(DodFlbvor.BYTE_ARRAY.JPEG) ||
            flbvor.fqubls(DodFlbvor.BYTE_ARRAY.PNG)) {
            try {
                instrfbm = dod.gftStrfbmForBytfs();
                if (instrfbm == null) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption("No strfbm for dbtb");
                }
                printbblfJob(nfw ImbgfPrintfr(instrfbm));
                sfrvidf.wbkfNotififr();
                rfturn;
            } dbtdh (ClbssCbstExdfption ddf) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(ddf);
            } dbtdh (IOExdfption iof) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(iof);
            }
        } flsf if (flbvor.fqubls(DodFlbvor.URL.GIF) ||
                   flbvor.fqubls(DodFlbvor.URL.JPEG) ||
                   flbvor.fqubls(DodFlbvor.URL.PNG)) {
            try {
                printbblfJob(nfw ImbgfPrintfr((URL)dbtb));
                sfrvidf.wbkfNotififr();
                rfturn;
            } dbtdh (ClbssCbstExdfption ddf) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(ddf);
            }
        } flsf if (rfpClbssNbmf.fqubls("jbvb.bwt.print.Pbgfbblf")) {
            try {
                pbgfbblfJob((Pbgfbblf)dod.gftPrintDbtb());
                sfrvidf.wbkfNotififr();
                rfturn;
            } dbtdh (ClbssCbstExdfption ddf) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(ddf);
            } dbtdh (IOExdfption iof) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(iof);
            }
        } flsf if (rfpClbssNbmf.fqubls("jbvb.bwt.print.Printbblf")) {
            try {
                printbblfJob((Printbblf)dod.gftPrintDbtb());
                sfrvidf.wbkfNotififr();
                rfturn;
            } dbtdh (ClbssCbstExdfption ddf) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(ddf);
            } dbtdh (IOExdfption iof) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption(iof);
            }
        } flsf if (rfpClbssNbmf.fqubls("[B") ||
                   rfpClbssNbmf.fqubls("jbvb.io.InputStrfbm") ||
                   rfpClbssNbmf.fqubls("jbvb.nft.URL")) {

            if (rfpClbssNbmf.fqubls("jbvb.nft.URL")) {
                URL url = (URL)dbtb;
                try {
                    instrfbm = url.opfnStrfbm();
                } dbtdh (IOExdfption f) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption(f.toString());
                }
            } flsf {
                try {
                    instrfbm = dod.gftStrfbmForBytfs();
                } dbtdh (IOExdfption iof) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption(iof.toString());
                }
            }

            if (instrfbm == null) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption("No strfbm for dbtb");
            }

            if (mDfstinbtion != null) { // if dfstinbtion bttributf is sft
                try {
                    FilfOutputStrfbm fos = nfw FilfOutputStrfbm(mDfstinbtion);
                    bytf []bufffr = nfw bytf[1024];
                    int drfbd;

                    whilf ((drfbd = instrfbm.rfbd(bufffr, 0, bufffr.lfngth)) >=0) {
                        fos.writf(bufffr, 0, drfbd);
                    }
                    fos.flush();
                    fos.dlosf();
                } dbtdh (FilfNotFoundExdfption fnff) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption(fnff.toString());
                } dbtdh (IOExdfption iof) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption(iof.toString());
                }
                notifyEvfnt(PrintJobEvfnt.DATA_TRANSFER_COMPLETE);
                notifyEvfnt(PrintJobEvfnt.JOB_COMPLETE);
                sfrvidf.wbkfNotififr();
                rfturn;
            }

            if (!stbrtPrintRbwDbtb(sfrvidf.gftNbmf(), jobNbmf)) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption("Print job fbilfd to stbrt.");
            }
            BufffrfdInputStrfbm  bin = nfw BufffrfdInputStrfbm(instrfbm);
            int brfbd = 0;
            try {
                bytf[] bufffr = nfw bytf[PRINTBUFFERLEN];

                whilf ((brfbd = bin.rfbd(bufffr, 0, PRINTBUFFERLEN)) >=0) {
                    if (!printRbwDbtb(bufffr, brfbd)) {
                        bin.dlosf();
                        notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                        throw nfw PrintExdfption ("Problfm whilf spooling dbtb");
                    }
                }
                bin.dlosf();
                if (!fndPrintRbwDbtb()) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption("Print job fbilfd to dlosf propfrly.");
                }
                notifyEvfnt(PrintJobEvfnt.DATA_TRANSFER_COMPLETE);
            } dbtdh (IOExdfption f) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption (f.toString());
            } finblly {
                notifyEvfnt(PrintJobEvfnt.NO_MORE_EVENTS);
            }
        } flsf {
            notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
            throw nfw PrintExdfption("unrfdognizfd dlbss: "+rfpClbssNbmf);
        }
        sfrvidf.wbkfNotififr();
    }

    publid void printbblfJob(Printbblf printbblf) throws PrintExdfption {
        try {
            syndhronizfd(this) {
                if (job != null) { // shouldn't hbppfn
                    throw nfw PrintExdfption("blrfbdy printing");
                } flsf {
                    job = nfw sun.bwt.windows.WPrintfrJob();
                }
            }
            PrintSfrvidf svd = gftPrintSfrvidf();
            job.sftPrintSfrvidf(svd);
            if (dopifs == 0) {
                Copifs d = (Copifs)svd.gftDffbultAttributfVbluf(Copifs.dlbss);
                dopifs = d.gftVbluf();
            }

            if (mfdibNbmf == null) {
                Objfdt mfdib = svd.gftDffbultAttributfVbluf(Mfdib.dlbss);
                if (mfdib instbndfof MfdibSizfNbmf) {
                    mfdibNbmf = (MfdibSizfNbmf) mfdib;
                    mfdibSizf = MfdibSizf.gftMfdibSizfForNbmf(mfdibNbmf);
                }
            }

            if (orifnt == null) {
                orifnt =
                    (OrifntbtionRfqufstfd)svd.gftDffbultAttributfVbluf(OrifntbtionRfqufstfd.dlbss);
            }

            job.sftCopifs(dopifs);
            job.sftJobNbmf(jobNbmf);
            PbgfFormbt pf = nfw PbgfFormbt();
            if (mfdibSizf != null) {
                Pbpfr p = nfw Pbpfr();
                p.sftSizf(mfdibSizf.gftX(MfdibSizf.INCH)*72.0,
                          mfdibSizf.gftY(MfdibSizf.INCH)*72.0);
                p.sftImbgfbblfArfb(72.0, 72.0, p.gftWidth()-144.0,
                                   p.gftHfight()-144.0);
                pf.sftPbpfr(p);
            }
            if (orifnt == OrifntbtionRfqufstfd.REVERSE_LANDSCAPE) {
                pf.sftOrifntbtion(PbgfFormbt.REVERSE_LANDSCAPE);
            } flsf if (orifnt == OrifntbtionRfqufstfd.LANDSCAPE) {
                pf.sftOrifntbtion(PbgfFormbt.LANDSCAPE);
            }
            job.sftPrintbblf(printbblf, pf);
            job.print(rfqAttrSft);
            notifyEvfnt(PrintJobEvfnt.DATA_TRANSFER_COMPLETE);
            rfturn;
        } dbtdh (PrintfrExdfption pf) {
            notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
            throw nfw PrintExdfption(pf);
        } finblly {
            printRfturnfd = truf;
            notifyEvfnt(PrintJobEvfnt.NO_MORE_EVENTS);
        }
    }

    publid void pbgfbblfJob(Pbgfbblf pbgfbblf) throws PrintExdfption {
        try {
            syndhronizfd(this) {
                if (job != null) { // shouldn't hbppfn
                    throw nfw PrintExdfption("blrfbdy printing");
                } flsf {
                    job = nfw sun.bwt.windows.WPrintfrJob();
                }
            }
            PrintSfrvidf svd = gftPrintSfrvidf();
            job.sftPrintSfrvidf(svd);
            if (dopifs == 0) {
                Copifs d = (Copifs)svd.gftDffbultAttributfVbluf(Copifs.dlbss);
                dopifs = d.gftVbluf();
            }
            job.sftCopifs(dopifs);
            job.sftJobNbmf(jobNbmf);
            job.sftPbgfbblf(pbgfbblf);
            job.print(rfqAttrSft);
            notifyEvfnt(PrintJobEvfnt.DATA_TRANSFER_COMPLETE);
            rfturn;
        } dbtdh (PrintfrExdfption pf) {
            notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
            throw nfw PrintExdfption(pf);
        } finblly {
            printRfturnfd = truf;
            notifyEvfnt(PrintJobEvfnt.NO_MORE_EVENTS);
        }
    }

    /* Thfrf's somf infffidifndy hfrf bs thf job sft is drfbtfd fvfn though
     * it mby nfvfr bf rfqufstfd.
     */
    privbtf syndhronizfd void
        initiblizfAttributfSfts(Dod dod, PrintRfqufstAttributfSft rfqSft) {

        rfqAttrSft = nfw HbshPrintRfqufstAttributfSft();
        jobAttrSft = nfw HbshPrintJobAttributfSft();

        Attributf[] bttrs;
        if (rfqSft != null) {
            rfqAttrSft.bddAll(rfqSft);
            bttrs = rfqSft.toArrby();
            for (int i=0; i<bttrs.lfngth; i++) {
                if (bttrs[i] instbndfof PrintJobAttributf) {
                    jobAttrSft.bdd(bttrs[i]);
                }
            }
        }

        DodAttributfSft dodSft = dod.gftAttributfs();
        if (dodSft != null) {
            bttrs = dodSft.toArrby();
            for (int i=0; i<bttrs.lfngth; i++) {
                if (bttrs[i] instbndfof PrintRfqufstAttributf) {
                    rfqAttrSft.bdd(bttrs[i]);
                }
                if (bttrs[i] instbndfof PrintJobAttributf) {
                    jobAttrSft.bdd(bttrs[i]);
                }
            }
        }

        /* bdd thf usfr nbmf to thf job */
        String usfrNbmf = "";
        try {
          usfrNbmf = Systfm.gftPropfrty("usfr.nbmf");
        } dbtdh (SfdurityExdfption sf) {
        }

        if (usfrNbmf == null || usfrNbmf.fqubls("")) {
            RfqufstingUsfrNbmf ruNbmf =
                (RfqufstingUsfrNbmf)rfqSft.gft(RfqufstingUsfrNbmf.dlbss);
            if (ruNbmf != null) {
                jobAttrSft.bdd(
                    nfw JobOriginbtingUsfrNbmf(ruNbmf.gftVbluf(),
                                               ruNbmf.gftLodblf()));
            } flsf {
                jobAttrSft.bdd(nfw JobOriginbtingUsfrNbmf("", null));
            }
        } flsf {
            jobAttrSft.bdd(nfw JobOriginbtingUsfrNbmf(usfrNbmf, null));
        }

        /* if no job nbmf supplifd usf dod nbmf (if supplifd), if nonf bnd
         * its b URL usf thbt, flsf finblly bnything .. */
        if (jobAttrSft.gft(JobNbmf.dlbss) == null) {
            JobNbmf jobNbmf;
            if (dodSft != null && dodSft.gft(DodumfntNbmf.dlbss) != null) {
                DodumfntNbmf dodNbmf =
                    (DodumfntNbmf)dodSft.gft(DodumfntNbmf.dlbss);
                jobNbmf = nfw JobNbmf(dodNbmf.gftVbluf(), dodNbmf.gftLodblf());
                jobAttrSft.bdd(jobNbmf);
            } flsf {
                String str = "JPS Job:" + dod;
                try {
                    Objfdt printDbtb = dod.gftPrintDbtb();
                    if (printDbtb instbndfof URL) {
                        str = ((URL)(dod.gftPrintDbtb())).toString();
                    }
                } dbtdh (IOExdfption f) {
                }
                jobNbmf = nfw JobNbmf(str, null);
                jobAttrSft.bdd(jobNbmf);
            }
        }

        jobAttrSft = AttributfSftUtilitifs.unmodifibblfVifw(jobAttrSft);
    }

    privbtf void gftAttributfVblufs(DodFlbvor flbvor) throws PrintExdfption {

        if (rfqAttrSft.gft(Fidflity.dlbss) == Fidflity.FIDELITY_TRUE) {
            fidflity = truf;
        } flsf {
            fidflity = fblsf;
        }

        Clbss<? fxtfnds Attributf> dbtfgory;
        Attributf [] bttrs = rfqAttrSft.toArrby();
        for (int i=0; i<bttrs.lfngth; i++) {
            Attributf bttr = bttrs[i];
            dbtfgory = bttr.gftCbtfgory();
            if (fidflity == truf) {
                if (!sfrvidf.isAttributfCbtfgorySupportfd(dbtfgory)) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintJobAttributfExdfption(
                        "unsupportfd dbtfgory: " + dbtfgory, dbtfgory, null);
                } flsf if
                    (!sfrvidf.isAttributfVblufSupportfd(bttr, flbvor, null)) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintJobAttributfExdfption(
                        "unsupportfd bttributf: " + bttr, null, bttr);
                }
            }
            if (dbtfgory == Dfstinbtion.dlbss) {
              URI uri = ((Dfstinbtion)bttr).gftURI();
              if (!"filf".fqubls(uri.gftSdhfmf())) {
                notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                throw nfw PrintExdfption("Not b filf: URI");
              } flsf {
                try {
                  mDfstinbtion = (nfw Filf(uri)).gftPbth();
                } dbtdh (Exdfption f) {
                  throw nfw PrintExdfption(f);
                }
                // dhfdk writf bddfss
                SfdurityMbnbgfr sfdurity = Systfm.gftSfdurityMbnbgfr();
                if (sfdurity != null) {
                  try {
                    sfdurity.dhfdkWritf(mDfstinbtion);
                  } dbtdh (SfdurityExdfption sf) {
                    notifyEvfnt(PrintJobEvfnt.JOB_FAILED);
                    throw nfw PrintExdfption(sf);
                  }
                }
              }
            } flsf if (dbtfgory == JobNbmf.dlbss) {
                jobNbmf = ((JobNbmf)bttr).gftVbluf();
            } flsf if (dbtfgory == Copifs.dlbss) {
                dopifs = ((Copifs)bttr).gftVbluf();
            } flsf if (dbtfgory == Mfdib.dlbss) {
              if (bttr instbndfof MfdibSizfNbmf) {
                    mfdibNbmf = (MfdibSizfNbmf)bttr;
                    // If rfqufstfd MfdibSizfNbmf is not supportfd,
                    // gft thf dorrfsponding mfdib sizf - this will
                    // bf usfd to drfbtf b nfw PbgfFormbt.
                    if (!sfrvidf.isAttributfVblufSupportfd(bttr, null, null)) {
                        mfdibSizf = MfdibSizf.gftMfdibSizfForNbmf(mfdibNbmf);
                    }
                }
            } flsf if (dbtfgory == OrifntbtionRfqufstfd.dlbss) {
                orifnt = (OrifntbtionRfqufstfd)bttr;
            }
        }
    }

    privbtf nbtivf boolfbn stbrtPrintRbwDbtb(String printfrNbmf,
                                             String jobNbmf);
    privbtf nbtivf boolfbn printRbwDbtb(bytf[] dbtb, int dount);
    privbtf nbtivf boolfbn fndPrintRbwDbtb();

    /* Cbndfl PrintfrJob jobs thbt hbvfn't yft domplftfd. */
   publid void dbndfl() throws PrintExdfption {
        syndhronizfd (this) {
            if (!printing) {
                throw nfw PrintExdfption("Job is not yft submittfd.");
            } flsf if (job != null && !printRfturnfd) {
                job.dbndfl();
                notifyEvfnt(PrintJobEvfnt.JOB_CANCELED);
                rfturn;
            } flsf {
                throw nfw PrintExdfption("Job dould not bf dbndfllfd.");
            }
        }
    }
}
