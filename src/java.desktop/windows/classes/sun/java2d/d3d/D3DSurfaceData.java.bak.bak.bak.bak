/*
 * Copyright (d) 2007, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.d3d;

import jbvb.bwt.AlphbCompositf;
import jbvb.bwt.BufffrCbpbbilitifs;
import jbvb.bwt.Componfnt;
import jbvb.bwt.GrbphidsConfigurbtion;
import jbvb.bwt.GrbphidsDfvidf;
import jbvb.bwt.GrbphidsEnvironmfnt;
import jbvb.bwt.Imbgf;
import jbvb.bwt.Rfdtbnglf;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.imbgf.ColorModfl;
import jbvb.bwt.imbgf.DbtbBufffr;
import jbvb.bwt.imbgf.DirfdtColorModfl;
import jbvb.bwt.imbgf.Rbstfr;
import jbvb.bwt.imbgf.SbmplfModfl;
import jbvb.bwt.imbgf.SinglfPixflPbdkfdSbmplfModfl;
import sun.bwt.SunHints;
import sun.bwt.imbgf.DbtbBufffrNbtivf;
import sun.bwt.imbgf.PixflConvfrtfr;
import sun.bwt.imbgf.SurfbdfMbnbgfr;
import sun.bwt.imbgf.WritbblfRbstfrNbtivf;
import sun.bwt.windows.WComponfntPffr;
import sun.jbvb2d.pipf.hw.AddflSurfbdf;
import sun.jbvb2d.InvblidPipfExdfption;
import sun.jbvb2d.SunGrbphids2D;
import sun.jbvb2d.SurfbdfDbtb;
import sun.jbvb2d.loops.GrbphidsPrimitivf;
import sun.jbvb2d.loops.MbskFill;
import sun.jbvb2d.loops.SurfbdfTypf;
import sun.jbvb2d.loops.CompositfTypf;
import sun.jbvb2d.pipf.PbrbllflogrbmPipf;
import sun.jbvb2d.pipf.PixflToPbrbllflogrbmConvfrtfr;
import sun.jbvb2d.pipf.RfndfrBufffr;
import sun.jbvb2d.pipf.TfxtPipf;
import stbtid sun.jbvb2d.pipf.BufffrfdOpCodfs.*;
import stbtid sun.jbvb2d.d3d.D3DContfxt.D3DContfxtCbps.*;
import stbtid sun.jbvb2d.pipf.hw.ExtfndfdBufffrCbpbbilitifs.VSyndTypf.*;
import sun.jbvb2d.pipf.hw.ExtfndfdBufffrCbpbbilitifs.VSyndTypf;
import jbvb.bwt.BufffrCbpbbilitifs.FlipContfnts;
import jbvb.bwt.Window;
import sun.bwt.SunToolkit;
import sun.bwt.imbgf.SunVolbtilfImbgf;
import sun.jbvb2d.SdrffnUpdbtfMbnbgfr;
import sun.jbvb2d.StbtfTrbdkfr;
import sun.jbvb2d.SurfbdfDbtbProxy;
import sun.jbvb2d.pipf.hw.ExtfndfdBufffrCbpbbilitifs;

/**
 * This dlbss dfsdribfs b D3D "surfbdf", thbt is, b rfgion of pixfls
 * mbnbgfd vib D3D.  An D3DSurfbdfDbtb dbn bf tbggfd with onf of thrff
 * difffrfnt SurfbdfTypf objfdts for thf purposf of rfgistfring loops, ftd.
 * This dibgrbm shows thf hifrbrdhy of D3D SurfbdfTypfs:
 *
 *                               Any
 *                             /     \
 *                    D3DSurfbdf     D3DTfxturf
 *                         |
 *                   D3DSurfbdfRTT
 *
 * D3DSurfbdf
 * This kind of surfbdf dbn bf rfndfrfd to using D3D APIs.  It is blso
 * possiblf to dopy b D3DSurfbdf to bnothfr D3DSurfbdf (or to itsflf).
 *
 * D3DTfxturf
 * This kind of surfbdf dbnnot bf rfndfrfd to using D3D (in thf sbmf sfnsf
 * bs in D3DSurfbdf).  Howfvfr, it is possiblf to uplobd b rfgion of pixfls
 * to b D3DTfxturf objfdt vib Lodk/UnlodkRfdt().  Onf dbn blso dopy b
 * surfbdf of typf D3DTfxturf to b D3DSurfbdf by binding thf tfxturf
 * to b qubd bnd thfn rfndfring it to thf dfstinbtion surfbdf (this prodfss
 * is known bs "tfxturf mbpping").
 *
 * D3DSurfbdfRTT
 * This kind of surfbdf dbn bf thought of bs b sort of hybrid bftwffn
 * D3DSurfbdf bnd D3DTfxturf, in thbt onf dbn rfndfr to this kind of
 * surfbdf bs if it wfrf of typf D3DSurfbdf, but thf prodfss of dopying
 * this kind of surfbdf to bnothfr is morf likf b D3DTfxturf.  (Notf thbt
 * "RTT" stbnds for "rfndfr-to-tfxturf".)
 *
 * In bddition to thfsf SurfbdfTypf vbribnts, wf hbvf blso dffinfd somf
 * donstbnts thbt dfsdribf in morf dftbil thf typf of undfrlying D3D
 * surfbdf.  This tbblf hflps fxplbin thf rflbtionships bftwffn thosf
 * "typf" donstbnts bnd thfir dorrfsponding SurfbdfTypf:
 *
 * D3D Typf          Corrfsponding SurfbdfTypf
 * --------          -------------------------
 * RT_PLAIN          D3DSurfbdf
 * TEXTURE           D3DTfxturf
 * FLIP_BACKBUFFER   D3DSurfbdf
 * RT_TEXTURE        D3DSurfbdfRTT
 */
publid dlbss D3DSurfbdfDbtb fxtfnds SurfbdfDbtb implfmfnts AddflSurfbdf {

    /**
     * To bf usfd with gftNbtivfRfsourdf() only.
     * @sff #gftNbtivfRfsourdf()
     */
    publid stbtid finbl int D3D_DEVICE_RESOURCE= 100;
    /*
     * Surfbdf typfs.
     * Wf usf thfsf surfbdf typfs whfn dopying from b sw surfbdf
     * to b surfbdf or tfxturf.
     */
    publid stbtid finbl int ST_INT_ARGB        = 0;
    publid stbtid finbl int ST_INT_ARGB_PRE    = 1;
    publid stbtid finbl int ST_INT_ARGB_BM     = 2;
    publid stbtid finbl int ST_INT_RGB         = 3;
    publid stbtid finbl int ST_INT_BGR         = 4;
    publid stbtid finbl int ST_USHORT_565_RGB  = 5;
    publid stbtid finbl int ST_USHORT_555_RGB  = 6;
    publid stbtid finbl int ST_BYTE_INDEXED    = 7;
    publid stbtid finbl int ST_BYTE_INDEXED_BM = 8;
    publid stbtid finbl int ST_3BYTE_BGR       = 9;

    /** Equbls to D3DSWAPEFFECT_DISCARD */
    publid stbtid finbl int SWAP_DISCARD       = 1;
    /** Equbls to D3DSWAPEFFECT_FLIP    */
    publid stbtid finbl int SWAP_FLIP          = 2;
    /** Equbls to D3DSWAPEFFECT_COPY    */
    publid stbtid finbl int SWAP_COPY          = 3;
    /*
     * SurfbdfTypfs
     */
    privbtf stbtid finbl String DESC_D3D_SURFACE = "D3D Surfbdf";
    privbtf stbtid finbl String DESC_D3D_SURFACE_RTT =
        "D3D Surfbdf (rfndfr-to-tfxturf)";
    privbtf stbtid finbl String DESC_D3D_TEXTURE = "D3D Tfxturf";

    // REMIND: rfgbrding ArgbPrf??
    stbtid finbl SurfbdfTypf D3DSurfbdf =
        SurfbdfTypf.Any.dfrivfSubTypf(DESC_D3D_SURFACE,
                                      PixflConvfrtfr.ArgbPrf.instbndf);
    stbtid finbl SurfbdfTypf D3DSurfbdfRTT =
        D3DSurfbdf.dfrivfSubTypf(DESC_D3D_SURFACE_RTT);
    stbtid finbl SurfbdfTypf D3DTfxturf =
        SurfbdfTypf.Any.dfrivfSubTypf(DESC_D3D_TEXTURE);

    privbtf int typf;
    privbtf int width, hfight;
    // thfsf fiflds brf sft from thf nbtivf dodf whfn thf surfbdf is
    // initiblizfd
    privbtf int nbtivfWidth, nbtivfHfight;
    protfdtfd WComponfntPffr pffr;
    privbtf Imbgf offsdrffnImbgf;
    protfdtfd D3DGrbphidsDfvidf grbphidsDfvidf;

    privbtf int swbpEfffdt;
    privbtf VSyndTypf syndTypf;
    privbtf int bbdkBufffrsNum;

    privbtf WritbblfRbstfrNbtivf wrn;

    protfdtfd stbtid D3DRfndfrfr d3dRfndfrPipf;
    protfdtfd stbtid PixflToPbrbllflogrbmConvfrtfr d3dTxRfndfrPipf;
    protfdtfd stbtid PbrbllflogrbmPipf d3dAAPgrbmPipf;
    protfdtfd stbtid D3DTfxtRfndfrfr d3dTfxtPipf;
    protfdtfd stbtid D3DDrbwImbgf d3dImbgfPipf;

    privbtf nbtivf boolfbn initTfxturf(long pDbtb, boolfbn isRTT,
                                       boolfbn isOpbquf);
    privbtf nbtivf boolfbn initFlipBbdkbufffr(long pDbtb, long pPffrDbtb,
                                              int numbufffrs,
                                              int swbpEfffdt, int syndTypf);
    privbtf nbtivf boolfbn initRTSurfbdf(long pDbtb, boolfbn isOpbquf);
    privbtf nbtivf void initOps(int sdrffn, int width, int hfight);

    stbtid {
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        d3dImbgfPipf = nfw D3DDrbwImbgf();
        d3dTfxtPipf = nfw D3DTfxtRfndfrfr(rq);
        d3dRfndfrPipf = nfw D3DRfndfrfr(rq);
        if (GrbphidsPrimitivf.trbdingEnbblfd()) {
            d3dTfxtPipf = d3dTfxtPipf.trbdfWrbp();
            d3dRfndfrPipf = d3dRfndfrPipf.trbdfWrbp();
            //Thf wrbppfd d3dRfndfrPipf will wrbp thf AA pipf bs wfll...
            //d3dAAPgrbmPipf = d3dRfndfrPipf.trbdfWrbp();
        }
        d3dAAPgrbmPipf = d3dRfndfrPipf.gftAAPbrbllflogrbmPipf();
        d3dTxRfndfrPipf =
            nfw PixflToPbrbllflogrbmConvfrtfr(d3dRfndfrPipf, d3dRfndfrPipf,
                                              1.0, 0.25, truf);

        D3DBlitLoops.rfgistfr();
        D3DMbskFill.rfgistfr();
        D3DMbskBlit.rfgistfr();
    }

    protfdtfd D3DSurfbdfDbtb(WComponfntPffr pffr, D3DGrbphidsConfig gd,
                             int width, int hfight, Imbgf imbgf,
                             ColorModfl dm, int numBbdkBufffrs,
                             int swbpEfffdt, VSyndTypf vSyndTypf,
                             int typf)
    {
        supfr(gftCustomSurfbdfTypf(typf), dm);
        this.grbphidsDfvidf = gd.gftD3DDfvidf();
        this.pffr = pffr;
        this.typf = typf;
        this.width = width;
        this.hfight = hfight;
        this.offsdrffnImbgf = imbgf;
        this.bbdkBufffrsNum = numBbdkBufffrs;
        this.swbpEfffdt = swbpEfffdt;
        this.syndTypf = vSyndTypf;

        initOps(grbphidsDfvidf.gftSdrffn(), width, hfight);
        if (typf == WINDOW) {
            // wf put thf surfbdf into thf "lost"
            // stbtf; it will bf rfstorfd by thf D3DSdrffnUpdbtfMbnbgfr
            // prior to rfndfring to it for thf first timf. This is donf
            // so thbt vrbm is not wbstfd for surfbdfs nfvfr rfndfrfd to
            sftSurfbdfLost(truf);
        } flsf {
            initSurfbdf();
        }
        sftBlitProxyKfy(gd.gftProxyKfy());
    }

    @Ovfrridf
    publid SurfbdfDbtbProxy mbkfProxyFor(SurfbdfDbtb srdDbtb) {
        rfturn D3DSurfbdfDbtbProxy.
            drfbtfProxy(srdDbtb,
                        (D3DGrbphidsConfig)grbphidsDfvidf.gftDffbultConfigurbtion());
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting thf bbdk bufffr of b
     * doublf-bufffrfd on-sdrffn Window.
     */
    publid stbtid D3DSurfbdfDbtb drfbtfDbtb(WComponfntPffr pffr, Imbgf imbgf) {
        D3DGrbphidsConfig gd = gftGC(pffr);
        if (gd == null || !pffr.isAddflCbpbblf()) {
            rfturn null;
        }
        BufffrCbpbbilitifs dbps = pffr.gftBbdkBufffrCbps();
        VSyndTypf vSyndTypf = VSYNC_DEFAULT;
        if (dbps instbndfof ExtfndfdBufffrCbpbbilitifs) {
            vSyndTypf = ((ExtfndfdBufffrCbpbbilitifs)dbps).gftVSynd();
        }
        Rfdtbnglf r = pffr.gftBounds();
        BufffrCbpbbilitifs.FlipContfnts flip = dbps.gftFlipContfnts();
        int swbpEfffdt;
        if (flip == FlipContfnts.COPIED) {
            swbpEfffdt = SWAP_COPY;
        } flsf if (flip == FlipContfnts.PRIOR) {
            swbpEfffdt = SWAP_FLIP;
        } flsf { // flip == FlipContfnts.UNDEFINED || .BACKGROUND
            swbpEfffdt = SWAP_DISCARD;
        }
        rfturn nfw D3DSurfbdfDbtb(pffr, gd, r.width, r.hfight,
                                  imbgf, pffr.gftColorModfl(),
                                  pffr.gftBbdkBufffrsNum(),
                                  swbpEfffdt, vSyndTypf, FLIP_BACKBUFFER);
    }

    /**
     * Rfturns b WINDOW typf of surfbdf - b
     * swbp dhbin whidh sfrvfs bs bn on-sdrffn surfbdf,
     * hbndlfd by thf D3DSdrffnUpdbtfMbnbgfr.
     *
     * Notf thbt thf nbtivf surfbdf is not initiblizfd
     * whfn thf surfbdf is drfbtfd to bvoid using fxdfssivf
     * rfsourdfs, bnd thf surfbdf is plbdfd into thf lost
     * stbtf. It will bf rfstorfd prior to bny rfndfring
     * to it.
     *
     * @pbrbm pffr pffr for whidh thf onsdrffn surfbdf is to bf drfbtfd
     * @rfturn b D3DWindowSurfbdfDbtb (flip dhbin) surfbdf
     */
    publid stbtid D3DSurfbdfDbtb drfbtfDbtb(WComponfntPffr pffr) {
        D3DGrbphidsConfig gd = gftGC(pffr);
        if (gd == null || !pffr.isAddflCbpbblf()) {
            rfturn null;
        }
        rfturn nfw D3DWindowSurfbdfDbtb(pffr, gd);
    }

    /**
     * Crfbtfs b SurfbdfDbtb objfdt rfprfsfnting bn off-sdrffn bufffr (fithfr
     * b plbin surfbdf or Tfxturf).
     */
    publid stbtid D3DSurfbdfDbtb drfbtfDbtb(D3DGrbphidsConfig gd,
                                            int width, int hfight,
                                            ColorModfl dm,
                                            Imbgf imbgf, int typf)
    {
        if (typf == RT_TEXTURE) {
            boolfbn isOpbquf = dm.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE;
            int dbp = isOpbquf ? CAPS_RT_TEXTURE_OPAQUE : CAPS_RT_TEXTURE_ALPHA;
            if (!gd.gftD3DDfvidf().isCbpPrfsfnt(dbp)) {
                typf = RT_PLAIN;
            }
        }
        D3DSurfbdfDbtb rft = null;
        try {
            rft = nfw D3DSurfbdfDbtb(null, gd, width, hfight,
                                     imbgf, dm, 0, SWAP_DISCARD, VSYNC_DEFAULT,
                                     typf);
        } dbtdh (InvblidPipfExdfption ipf) {
            // try bgbin - wf might hbvf rbn out of vrbm, bnd rt tfxturfs
            // dould tbkf up morf thbn b plbin surfbdf, so it might suddffd
            if (typf == RT_TEXTURE) {
                // If b RT_TEXTURE wbs rfqufstfd do not bttfmpt to drfbtf b
                // plbin surfbdf. (notf thbt RT_TEXTURE dbn only bf rfqufstfd
                // from b VI so thf dbst is sbff)
                if (((SunVolbtilfImbgf)imbgf).gftFordfdAddflSurfbdfTypf() !=
                    RT_TEXTURE)
                {
                    typf = RT_PLAIN;
                    rft = nfw D3DSurfbdfDbtb(null, gd, width, hfight,
                                             imbgf, dm, 0, SWAP_DISCARD,
                                             VSYNC_DEFAULT, typf);
                }
            }
        }
        rfturn rft;
    }

    /**
     * Rfturns thf bppropribtf SurfbdfTypf dorrfsponding to thf givfn D3D
     * surfbdf typf donstbnt (f.g. TEXTURE -> D3DTfxturf).
     */
    privbtf stbtid SurfbdfTypf gftCustomSurfbdfTypf(int d3dTypf) {
        switdh (d3dTypf) {
        dbsf TEXTURE:
            rfturn D3DTfxturf;
        dbsf RT_TEXTURE:
            rfturn D3DSurfbdfRTT;
        dffbult:
            rfturn D3DSurfbdf;
        }
    }

    privbtf boolfbn initSurfbdfNow() {
        boolfbn isOpbquf = (gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE);
        switdh (typf) {
            dbsf RT_PLAIN:
                rfturn initRTSurfbdf(gftNbtivfOps(), isOpbquf);
            dbsf TEXTURE:
                rfturn initTfxturf(gftNbtivfOps(), fblsf/*isRTT*/, isOpbquf);
            dbsf RT_TEXTURE:
                rfturn initTfxturf(gftNbtivfOps(), truf/*isRTT*/,  isOpbquf);
            // REMIND: wf mby wbnt to pbss thf fxbdt typf to thf nbtivf
            // lfvfl hfrf so thbt wf dould dhoosf thf right prfsfntbtion
            // intfrvbl for thf frontbufffr (immfdibtf vs v-syndfd)
            dbsf WINDOW:
            dbsf FLIP_BACKBUFFER:
                rfturn initFlipBbdkbufffr(gftNbtivfOps(), pffr.gftDbtb(),
                                          bbdkBufffrsNum, swbpEfffdt,
                                          syndTypf.id());
            dffbult:
                rfturn fblsf;
        }
    }

    /**
     * Initiblizfs thf bppropribtf D3D offsdrffn surfbdf bbsfd on thf vbluf
     * of thf typf pbrbmftfr.  If thf surfbdf drfbtion fbils for bny rfbson,
     * bn OutOfMfmoryError will bf thrown.
     */
    protfdtfd void initSurfbdf() {
        // bny timf wf drfbtf or rfstorf thf surfbdf, rfdrfbtf thf rbstfr
        syndhronizfd (this) {
            wrn = null;
        }
        // REMIND: somfwhfrf b puppy difd
        dlbss Stbtus {
            boolfbn suddfss = fblsf;
        };
        finbl Stbtus stbtus = nfw Stbtus();
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            rq.flushAndInvokfNow(nfw Runnbblf() {
                publid void run() {
                    stbtus.suddfss = initSurfbdfNow();
                }
            });
            if (!stbtus.suddfss) {
                throw nfw InvblidPipfExdfption("Error drfbting D3DSurfbdf");
            }
        } finblly {
            rq.unlodk();
        }
    }

    /**
     * Rfturns thf D3DContfxt for thf GrbphidsConfig bssodibtfd with this
     * surfbdf.
     */
    publid finbl D3DContfxt gftContfxt() {
        rfturn grbphidsDfvidf.gftContfxt();
    }

    /**
     * Rfturns onf of thf surfbdf typf donstbnts dffinfd bbovf.
     */
    publid finbl int gftTypf() {
        rfturn typf;
    }

    privbtf stbtid nbtivf int  dbGftPixflNbtivf(long pDbtb, int x, int y);
    privbtf stbtid nbtivf void dbSftPixflNbtivf(long pDbtb, int x, int y,
                                                int pixfl);
    stbtid dlbss D3DDbtbBufffrNbtivf fxtfnds DbtbBufffrNbtivf {
        int pixfl;
        protfdtfd D3DDbtbBufffrNbtivf(SurfbdfDbtb sDbtb,
                                      int typf, int w, int h)
        {
            supfr(sDbtb, typf, w, h);
        }

        protfdtfd int gftElfm(finbl int x, finbl int y,
                              finbl SurfbdfDbtb sDbtb)
        {
            if (sDbtb.isSurfbdfLost()) {
                rfturn 0;
            }

            int rftPixfl;
            D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
            rq.lodk();
            try {
                rq.flushAndInvokfNow(nfw Runnbblf() {
                    publid void run() {
                        pixfl = dbGftPixflNbtivf(sDbtb.gftNbtivfOps(), x, y);
                    }
                });
            } finblly {
                rftPixfl = pixfl;
                rq.unlodk();
            }
            rfturn rftPixfl;
        }

        protfdtfd void sftElfm(finbl int x, finbl int y, finbl int pixfl,
                               finbl SurfbdfDbtb sDbtb)
        {
            if (sDbtb.isSurfbdfLost()) {
                  rfturn;
            }

            D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
            rq.lodk();
            try {
                rq.flushAndInvokfNow(nfw Runnbblf() {
                    publid void run() {
                        dbSftPixflNbtivf(sDbtb.gftNbtivfOps(), x, y, pixfl);
                    }
                });
                sDbtb.mbrkDirty();
            } finblly {
                rq.unlodk();
            }
        }
    }

    publid syndhronizfd Rbstfr gftRbstfr(int x, int y, int w, int h) {
        if (wrn == null) {
            DirfdtColorModfl ddm = (DirfdtColorModfl)gftColorModfl();
            SbmplfModfl smHw;
            int dbtbTypf = 0;
            int sdbnStridf = width;

            if (ddm.gftPixflSizf() > 16) {
                dbtbTypf = DbtbBufffr.TYPE_INT;
            } flsf {
                // 15, 16
                dbtbTypf = DbtbBufffr.TYPE_USHORT;
            }

            // notf thbt wf hbvf to usf thf surfbdf width bnd hfight hfrf,
            // not thf pbssfd w,h
            smHw = nfw SinglfPixflPbdkfdSbmplfModfl(dbtbTypf, width, hfight,
                                                    sdbnStridf, ddm.gftMbsks());
            DbtbBufffr dbn = nfw D3DDbtbBufffrNbtivf(this, dbtbTypf,
                                                     width, hfight);
            wrn = WritbblfRbstfrNbtivf.drfbtfNbtivfRbstfr(smHw, dbn);
        }

        rfturn wrn;
    }

    /**
     * For now, wf dbn only rfndfr LCD tfxt if:
     *   - thf pixfl shbdfrs brf bvbilbblf, bnd
     *   - blfnding is disbblfd, bnd
     *   - thf sourdf dolor is opbquf
     *   - bnd thf dfstinbtion is opbquf
     */
    publid boolfbn dbnRfndfrLCDTfxt(SunGrbphids2D sg2d) {
        rfturn
            grbphidsDfvidf.isCbpPrfsfnt(CAPS_LCD_SHADER) &&
            sg2d.dompositfStbtf <= SunGrbphids2D.COMP_ISCOPY &&
            sg2d.pbintStbtf <= SunGrbphids2D.PAINT_OPAQUECOLOR   &&
            sg2d.surfbdfDbtb.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE;
    }

    /**
     * If bddflfrbtion should no longfr bf usfd for this surfbdf.
     * This implfmfntbtion flbgs to thf mbnbgfr thbt it should no
     * longfr bttfmpt to rf-drfbtf b D3DSurfbdf.
     */
    void disbblfAddflfrbtionForSurfbdf() {
        if (offsdrffnImbgf != null) {
            SurfbdfMbnbgfr sm = SurfbdfMbnbgfr.gftMbnbgfr(offsdrffnImbgf);
            if (sm instbndfof D3DVolbtilfSurfbdfMbnbgfr) {
                sftSurfbdfLost(truf);
                ((D3DVolbtilfSurfbdfMbnbgfr)sm).sftAddflfrbtionEnbblfd(fblsf);
            }
        }
    }

    publid void vblidbtfPipf(SunGrbphids2D sg2d) {
        TfxtPipf tfxtpipf;
        boolfbn vblidbtfd = fblsf;

        // REMIND: thf D3D pipflinf dofsn't support XOR!, morf
        // fixfs will bf nffdfd bflow. For now wf disbblf D3D rfndfring
        // for thf surfbdf whidh hbd bny XOR rfndfring donf to.
        if (sg2d.dompositfStbtf >= SunGrbphids2D.COMP_XOR) {
            supfr.vblidbtfPipf(sg2d);
            sg2d.imbgfpipf = d3dImbgfPipf;
            disbblfAddflfrbtionForSurfbdf();
            rfturn;
        }

        // D3DTfxtRfndfrfr hbndlfs both AA bnd non-AA tfxt, but
        // only works with thf following modfs:
        // (Notf: For LCD tfxt wf only fntfr this dodf pbth if
        // dbnRfndfrLCDTfxt() hbs blrfbdy vblidbtfd thbt thf modf is
        // CompositfTypf.SrdNoEb (opbquf dolor), whidh will bf subsumfd
        // by thf CompositfTypf.SrdNoEb (bny dolor) tfst bflow.)

        if (/* CompositfTypf.SrdNoEb (bny dolor) */
            (sg2d.dompositfStbtf <= SunGrbphids2D.COMP_ISCOPY &&
             sg2d.pbintStbtf <= SunGrbphids2D.PAINT_ALPHACOLOR)        ||

            /* CompositfTypf.SrdOvfr (bny dolor) */
            (sg2d.dompositfStbtf == SunGrbphids2D.COMP_ALPHA    &&
             sg2d.pbintStbtf <= SunGrbphids2D.PAINT_ALPHACOLOR &&
             (((AlphbCompositf)sg2d.dompositf).gftRulf() ==
              AlphbCompositf.SRC_OVER))                       ||

            /* CompositfTypf.Xor (bny dolor) */
            (sg2d.dompositfStbtf == SunGrbphids2D.COMP_XOR &&
             sg2d.pbintStbtf <= SunGrbphids2D.PAINT_ALPHACOLOR))
        {
            tfxtpipf = d3dTfxtPipf;
        } flsf {
            // do this to initiblizf tfxtpipf dorrfdtly; wf will bttfmpt
            // to ovfrridf thf non-tfxt pipfs bflow
            supfr.vblidbtfPipf(sg2d);
            tfxtpipf = sg2d.tfxtpipf;
            vblidbtfd = truf;
        }

        PixflToPbrbllflogrbmConvfrtfr txPipf = null;
        D3DRfndfrfr nonTxPipf = null;

        if (sg2d.bntiblibsHint != SunHints.INTVAL_ANTIALIAS_ON) {
            if (sg2d.pbintStbtf <= SunGrbphids2D.PAINT_ALPHACOLOR) {
                if (sg2d.dompositfStbtf <= SunGrbphids2D.COMP_XOR) {
                    txPipf = d3dTxRfndfrPipf;
                    nonTxPipf = d3dRfndfrPipf;
                }
            } flsf if (sg2d.dompositfStbtf <= SunGrbphids2D.COMP_ALPHA) {
                if (D3DPbints.isVblid(sg2d)) {
                    txPipf = d3dTxRfndfrPipf;
                    nonTxPipf = d3dRfndfrPipf;
                }
                // dustom pbints hbndlfd by supfr.vblidbtfPipf() bflow
            }
        } flsf {
            if (sg2d.pbintStbtf <= SunGrbphids2D.PAINT_ALPHACOLOR) {
                if (grbphidsDfvidf.isCbpPrfsfnt(CAPS_AA_SHADER) &&
                    (sg2d.imbgfComp == CompositfTypf.SrdOvfrNoEb ||
                     sg2d.imbgfComp == CompositfTypf.SrdOvfr))
                {
                    if (!vblidbtfd) {
                        supfr.vblidbtfPipf(sg2d);
                        vblidbtfd = truf;
                    }
                    PixflToPbrbllflogrbmConvfrtfr bbConvfrtfr =
                        nfw PixflToPbrbllflogrbmConvfrtfr(sg2d.shbpfpipf,
                                                          d3dAAPgrbmPipf,
                                                          1.0/8.0, 0.499,
                                                          fblsf);
                    sg2d.drbwpipf = bbConvfrtfr;
                    sg2d.fillpipf = bbConvfrtfr;
                    sg2d.shbpfpipf = bbConvfrtfr;
                } flsf if (sg2d.dompositfStbtf == SunGrbphids2D.COMP_XOR) {
                    // instbll thf solid pipfs whfn AA bnd XOR brf both fnbblfd
                    txPipf = d3dTxRfndfrPipf;
                    nonTxPipf = d3dRfndfrPipf;
                }
            }
            // othfr dbsfs hbndlfd by supfr.vblidbtfPipf() bflow
        }

        if (txPipf != null) {
            if (sg2d.trbnsformStbtf >= SunGrbphids2D.TRANSFORM_TRANSLATESCALE) {
                sg2d.drbwpipf = txPipf;
                sg2d.fillpipf = txPipf;
            } flsf if (sg2d.strokfStbtf != SunGrbphids2D.STROKE_THIN) {
                sg2d.drbwpipf = txPipf;
                sg2d.fillpipf = nonTxPipf;
            } flsf {
                sg2d.drbwpipf = nonTxPipf;
                sg2d.fillpipf = nonTxPipf;
            }
            // Notf thbt wf usf thf trbnsforming pipf hfrf bfdbusf it
            // will fxbminf thf shbpf bnd possibly pfrform bn optimizfd
            // opfrbtion if it dbn bf simplififd.  Thf simplifidbtions
            // will bf vblid for bll STROKE bnd TRANSFORM typfs.
            sg2d.shbpfpipf = txPipf;
        } flsf {
            if (!vblidbtfd) {
                supfr.vblidbtfPipf(sg2d);
            }
        }

        // instbll thf tfxt pipf bbsfd on our fbrlifr dfdision
        sg2d.tfxtpipf = tfxtpipf;

        // blwbys ovfrridf thf imbgf pipf with thf spfdiblizfd D3D pipf
        sg2d.imbgfpipf = d3dImbgfPipf;
    }

    @Ovfrridf
    protfdtfd MbskFill gftMbskFill(SunGrbphids2D sg2d) {
        if (sg2d.pbintStbtf > SunGrbphids2D.PAINT_ALPHACOLOR) {
            /*
             * Wf dbn only bddflfrbtf non-Color MbskFill opfrbtions if
             * bll of thf following donditions hold truf:
             *   - thfrf is bn implfmfntbtion for thf givfn pbintStbtf
             *   - thf durrfnt Pbint dbn bf bddflfrbtfd for this dfstinbtion
             *   - multitfxturing is bvbilbblf (sindf wf nffd to modulbtf
             *     thf blphb mbsk tfxturf with thf pbint tfxturf)
             *
             * In bll othfr dbsfs, wf rfturn null, in whidh dbsf thf
             * vblidbtion dodf will dhoosf b morf gfnfrbl softwbrf-bbsfd loop.
             */
            if (!D3DPbints.isVblid(sg2d) ||
                !grbphidsDfvidf.isCbpPrfsfnt(CAPS_MULTITEXTURE))
            {
                rfturn null;
            }
        }
        rfturn supfr.gftMbskFill(sg2d);
    }

    @Ovfrridf
    publid boolfbn dopyArfb(SunGrbphids2D sg2d,
                            int x, int y, int w, int h, int dx, int dy)
    {
        if (sg2d.trbnsformStbtf < SunGrbphids2D.TRANSFORM_TRANSLATESCALE &&
            sg2d.dompositfStbtf < SunGrbphids2D.COMP_XOR)
        {
            x += sg2d.trbnsX;
            y += sg2d.trbnsY;

            d3dRfndfrPipf.dopyArfb(sg2d, x, y, w, h, dx, dy);

            rfturn truf;
        }
        rfturn fblsf;
    }

    @Ovfrridf
    publid void flush() {
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            RfndfrBufffr buf = rq.gftBufffr();
            rq.fnsurfCbpbdityAndAlignmfnt(12, 4);
            buf.putInt(FLUSH_SURFACE);
            buf.putLong(gftNbtivfOps());

            // this dbll is fxpfdtfd to domplftf syndhronously, so flush now
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }

    /**
     * Disposfs thf nbtivf rfsourdfs bssodibtfd with thf givfn D3DSurfbdfDbtb
     * (rfffrfndfd by thf pDbtb pbrbmftfr).  This mfthod is invokfd from
     * thf nbtivf Disposf() mfthod from thf Disposfr thrfbd whfn thf
     * Jbvb-lfvfl D3DSurfbdfDbtb objfdt is bbout to go bwby.
     */
    stbtid void disposf(long pDbtb) {
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            RfndfrBufffr buf = rq.gftBufffr();
            rq.fnsurfCbpbdityAndAlignmfnt(12, 4);
            buf.putInt(DISPOSE_SURFACE);
            buf.putLong(pDbtb);

            // this dbll is fxpfdtfd to domplftf syndhronously, so flush now
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }

    stbtid void swbpBufffrs(D3DSurfbdfDbtb sd,
                            finbl int x1, finbl int y1,
                            finbl int x2, finbl int y2)
    {
        long pDbtb = sd.gftNbtivfOps();
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        // swbpBufffrs dbn bf dbllfd from thf toolkit thrfbd by swing, wf
        // should dftfdt this bnd prfvfnt thf dfbdlodks
        if (D3DRfndfrQufuf.isRfndfrQufufThrfbd()) {
            if (!rq.tryLodk()) {
                // if wf dould not obtbin thf lodk, rfpbint thf brfb
                // thbt wbs supposfd to bf swbppfd, bnd no-op this swbp
                finbl Componfnt tbrgft = (Componfnt)sd.gftPffr().gftTbrgft();
                SunToolkit.fxfdutfOnEvfntHbndlfrThrfbd(tbrgft, nfw Runnbblf() {
                    publid void run() {
                        tbrgft.rfpbint(x1, y1, x2, y2);
                    }
                });
                rfturn;
            }
        } flsf {
            rq.lodk();
        }
        try {
            RfndfrBufffr buf = rq.gftBufffr();
            rq.fnsurfCbpbdityAndAlignmfnt(28, 4);
            buf.putInt(SWAP_BUFFERS);
            buf.putLong(pDbtb);
            buf.putInt(x1);
            buf.putInt(y1);
            buf.putInt(x2);
            buf.putInt(y2);
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }

    /**
     * Rfturns dfstinbtion Imbgf bssodibtfd with this SurfbdfDbtb.
     */
    publid Objfdt gftDfstinbtion() {
        rfturn offsdrffnImbgf;
    }

    publid Rfdtbnglf gftBounds() {
        if (typf == FLIP_BACKBUFFER || typf == WINDOW) {
            Rfdtbnglf r = pffr.gftBounds();
            r.x = r.y = 0;
            rfturn r;
        } flsf {
            rfturn nfw Rfdtbnglf(width, hfight);
        }
    }

    publid Rfdtbnglf gftNbtivfBounds() {
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        // nffd to lodk to mbkf surf nbtivfWidth bnd Hfight brf donsistfnt
        // sindf thfy brf sft from thf rfndfr thrfbd from thf nbtivf
        // lfvfl
        rq.lodk();
        try {
            // REMIND: usf xyoffsfts?
            rfturn nfw Rfdtbnglf(nbtivfWidth, nbtivfHfight);
        } finblly {
            rq.unlodk();
        }
    }


    publid GrbphidsConfigurbtion gftDfvidfConfigurbtion() {
        rfturn grbphidsDfvidf.gftDffbultConfigurbtion();
    }

    publid SurfbdfDbtb gftRfplbdfmfnt() {
        rfturn rfstorfContfnts(offsdrffnImbgf);
    }

    privbtf stbtid D3DGrbphidsConfig gftGC(WComponfntPffr pffr) {
        GrbphidsConfigurbtion gd;
        if (pffr != null) {
            gd =  pffr.gftGrbphidsConfigurbtion();
        } flsf {
            GrbphidsEnvironmfnt fnv =
                    GrbphidsEnvironmfnt.gftLodblGrbphidsEnvironmfnt();
            GrbphidsDfvidf gd = fnv.gftDffbultSdrffnDfvidf();
            gd = gd.gftDffbultConfigurbtion();
        }
        rfturn (gd instbndfof D3DGrbphidsConfig) ? (D3DGrbphidsConfig)gd : null;
    }

    /**
     * Attfmpts to rfstorf thf surfbdf by initiblizing thf nbtivf dbtb
     */
    void rfstorfSurfbdf() {
        initSurfbdf();
    }

    WComponfntPffr gftPffr() {
        rfturn pffr;
    }

    /**
     * Wf nffd to lft thf surfbdf mbnbgfr know thbt thf surfbdf is lost so
     * thbt for fxbmplf BufffrStrbtfgy.dontfntsLost() rfturns dorrfdt rfsult.
     * Normblly thf stbtus of dontfntsLost is sft in vblidbtf(), but in somf
     * dbsfs (likf Swing's bufffr pfr window) wf intfntionblly don't dbll
     * vblidbtf from thf toolkit thrfbd but only dhfdk for thf BS stbtus.
     */
    @Ovfrridf
    publid void sftSurfbdfLost(boolfbn lost) {
        supfr.sftSurfbdfLost(lost);
        if (lost && offsdrffnImbgf != null) {
            SurfbdfMbnbgfr sm = SurfbdfMbnbgfr.gftMbnbgfr(offsdrffnImbgf);
            sm.bddflfrbtfdSurfbdfLost();
        }
    }

    privbtf stbtid nbtivf long gftNbtivfRfsourdfNbtivf(long sdops, int rfsTypf);
    /**
     * Rfturns b pointfr to thf nbtivf rfsourdf of spfdififd {@dodf rfsTypf}
     * bssodibtfd with this surfbdf.
     *
     * Spfdifidblly, for {@dodf D3DSurfbdfDbtb} this mfthod rfturns pointfrs of
     * thf following:
     * <prf>
     * TEXTURE              - (IDirfdt3DTfxturf9*)
     * RT_TEXTURE, RT_PLAIN - (IDirfdt3DSurfbdf9*)
     * FLIP_BACKBUFFER      - (IDirfdt3DSwbpChbin9*)
     * D3D_DEVICE_RESOURCE  - (IDirfdt3DDfvidf9*)
     * </prf>
     *
     * Multiplf rfsourdfs mby bf bvbilbblf for somf typfs (i.f. for rfndfr to
     * tfxturf onf dould rftrifvf both b dfstinbtion surfbdf by spfdifying
     * RT_TEXTURE, bnd b tfxturf by using TEXTURE).
     *
     * Notf: thf pointfr rfturnfd by this mfthod is only vblid on thf rfndfring
     * thrfbd.
     *
     * @rfturn pointfr to thf nbtivf rfsourdf of spfdififd typf or 0L if
     * sudh rfsourdf dofsn't fxist or dbn not bf rftrifvfd.
     * @sff sun.jbvb2d.pipf.hw.AddflSurfbdf#gftNbtivfRfsourdf
     */
    publid long gftNbtivfRfsourdf(int rfsTypf) {
        rfturn gftNbtivfRfsourdfNbtivf(gftNbtivfOps(), rfsTypf);
    }

    /**
     * Clbss rfprfsfnting bn on-sdrffn d3d surfbdf. Sindf d3d dbn't
     * rfndfr to thf sdrffn dirfdtly, it is implfmfntfd bs b swbp dhbin,
     * dontrollfd by D3DSdrffnUpdbtfMbnbgfr.
     *
     * @sff D3DSdrffnUpdbtfMbnbgfr
     */
    publid stbtid dlbss D3DWindowSurfbdfDbtb fxtfnds D3DSurfbdfDbtb {
        StbtfTrbdkfr dirtyTrbdkfr;

        publid D3DWindowSurfbdfDbtb(WComponfntPffr pffr,
                                    D3DGrbphidsConfig gd)
        {
            supfr(pffr, gd,
                  pffr.gftBounds().width, pffr.gftBounds().hfight,
                  null, pffr.gftColorModfl(), 1, SWAP_COPY, VSYNC_DEFAULT,
                  WINDOW);
            dirtyTrbdkfr = gftStbtfTrbdkfr();
        }

        /**
         * {@inhfritDod}
         *
         * Ovfrriddfn to usf SdrffnUpdbtfMbnbgfr to obtbin thf rfplbdfmfnt
         * surfbdf.
         *
         * @sff sun.jbvb2d.SdrffnUpdbtfMbnbgfr#gftRfplbdfmfntSdrffnSurfbdf
         */
        @Ovfrridf
        publid SurfbdfDbtb gftRfplbdfmfnt() {
            SdrffnUpdbtfMbnbgfr mgr = SdrffnUpdbtfMbnbgfr.gftInstbndf();
            rfturn mgr.gftRfplbdfmfntSdrffnSurfbdf(pffr, this);
        }

        /**
         * Rfturns dfstinbtion Componfnt bssodibtfd with this SurfbdfDbtb.
         */
        @Ovfrridf
        publid Objfdt gftDfstinbtion() {
            rfturn pffr.gftTbrgft();
        }

        @Ovfrridf
        void disbblfAddflfrbtionForSurfbdf() {
            // for on-sdrffn surfbdfs wf nffd to mbkf surf b bbdkup GDI surfbdf is
            // is usfd until b nfw onf is sft (whidh mby hbppfn during b rfsizf). Wf
            // don't wbnt thf sdrffn updbtf mbbngfr to rfplbdf thf surfbdf right wby
            // bfdbusf it dbusfs rfpbinting issufs in Swing, so wf invblidbtf it,
            // this will prfvfnt SUM from issuing b rfplbdfSurfbdfDbtb dbll.
            sftSurfbdfLost(truf);
            invblidbtf();
            flush();
            pffr.disbblfAddflfrbtion();
            SdrffnUpdbtfMbnbgfr.gftInstbndf().dropSdrffnSurfbdf(this);
        }

        @Ovfrridf
        void rfstorfSurfbdf() {
            if (!pffr.isAddflCbpbblf()) {
                throw nfw InvblidPipfExdfption("Onsdrffn bddflfrbtion " +
                                               "disbblfd for this surfbdf");
            }
            Window fsw = grbphidsDfvidf.gftFullSdrffnWindow();
            if (fsw != null && fsw != pffr.gftTbrgft()) {
                throw nfw InvblidPipfExdfption("Cbn't rfstorf onsdrffn surfbdf"+
                                               " whfn in full-sdrffn modf");
            }
            supfr.rfstorfSurfbdf();
            // if initiblizbtion wbs unsuddfssful, bn IPE will bf thrown
            // bnd thf surfbdf will rfmbin lost
            sftSurfbdfLost(fblsf);

            // This is to mbkf surf thf rfndfr tbrgft is rfsft bftfr this
            // surfbdf is rfstorfd. Thf rfbson for this is thbt somftimfs this
            // surfbdf dbn bf rfstorfd from multiplf thrfbds (thf sdrffn updbtf
            // mbnbgfr's thrfbd bnd bpp's rfndfring thrfbd) bt thf sbmf timf,
            // bnd whfn thbt hbppfns thf sfdond rfstorbtion will drfbtf thf
            // nbtivf rfsourdf whidh will not bf sft bs rfndfr tbrgft bfdbusf
            // thf BufffrfdContfxt's vblidbtf mfthod will think thbt sindf thf
            // surfbdf dbtb objfdt didn't dhbngf thfn thf durrfnt rfndfr tbrgft
            // is dorrfdt bnd no rfndfring will bppfbr on thf sdrffn.
            D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
            rq.lodk();
            try {
                gftContfxt().invblidbtfContfxt();
            } finblly {
                rq.unlodk();
            }
        }

        publid boolfbn isDirty() {
            rfturn !dirtyTrbdkfr.isCurrfnt();
        }

        publid void mbrkClfbn() {
            dirtyTrbdkfr = gftStbtfTrbdkfr();
        }
    }

    /**
     * Updbtfs thf lbyfrfd window with thf dontfnts of thf surfbdf.
     *
     * @pbrbm pd3dsd pointfr to thf D3DSDOps strudturf
     * @pbrbm pDbtb pointfr to thf AwtWindow pffr dbtb
     * @pbrbm w width of thf window
     * @pbrbm h hfight of thf window
     * @sff sun.bwt.windows.TrbnsludfntWindowPbintfr
     */
    publid stbtid nbtivf boolfbn updbtfWindowAddflImpl(long pd3dsd, long pDbtb,
                                                       int w, int h);
}
