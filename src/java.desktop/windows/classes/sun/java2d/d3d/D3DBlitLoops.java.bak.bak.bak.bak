/*
 * Copyright (d) 2007, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jbvb2d.d3d;

import jbvb.bwt.Compositf;
import jbvb.bwt.Trbnspbrfndy;
import jbvb.bwt.gfom.AffinfTrbnsform;
import jbvb.bwt.imbgf.AffinfTrbnsformOp;
import jbvb.bwt.imbgf.BufffrfdImbgf;
import jbvb.bwt.imbgf.BufffrfdImbgfOp;
import jbvb.lbng.rff.WfbkRfffrfndf;
import jbvb.lbng.bnnotbtion.Nbtivf;
import sun.jbvb2d.SdrffnUpdbtfMbnbgfr;
import sun.jbvb2d.SurfbdfDbtb;
import sun.jbvb2d.loops.Blit;
import sun.jbvb2d.loops.CompositfTypf;
import sun.jbvb2d.loops.GrbphidsPrimitivf;
import sun.jbvb2d.loops.GrbphidsPrimitivfMgr;
import sun.jbvb2d.loops.SdblfdBlit;
import sun.jbvb2d.loops.SurfbdfTypf;
import sun.jbvb2d.loops.TrbnsformBlit;
import sun.jbvb2d.pipf.Rfgion;
import sun.jbvb2d.pipf.RfndfrBufffr;
import sun.jbvb2d.pipf.RfndfrQufuf;
import stbtid sun.jbvb2d.pipf.BufffrfdOpCodfs.*;
import sun.jbvb2d.windows.GDIWindowSurfbdfDbtb;

dlbss D3DBlitLoops {

    stbtid void rfgistfr() {
        Blit blitIntArgbPrfToSurfbdf =
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.IntArgbPrf,
                                   D3DSurfbdfDbtb.ST_INT_ARGB_PRE);
        Blit blitIntArgbPrfToTfxturf =
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.IntArgbPrf,
                                   D3DSurfbdfDbtb.ST_INT_ARGB_PRE);

        GrbphidsPrimitivf[] primitivfs = {
            // prfvfnt D3DSurfbdf -> Sdrffn blits
            nfw D3DSurfbdfToGDIWindowSurfbdfBlit(),
            nfw D3DSurfbdfToGDIWindowSurfbdfSdblf(),
            nfw D3DSurfbdfToGDIWindowSurfbdfTrbnsform(),

            // surfbdf->surfbdf ops
            nfw D3DSurfbdfToSurfbdfBlit(),
            nfw D3DSurfbdfToSurfbdfSdblf(),
            nfw D3DSurfbdfToSurfbdfTrbnsform(),

            // rfndfr-to-tfxturf surfbdf->surfbdf ops
            nfw D3DRTTSurfbdfToSurfbdfBlit(),
            nfw D3DRTTSurfbdfToSurfbdfSdblf(),
            nfw D3DRTTSurfbdfToSurfbdfTrbnsform(),

            // surfbdf->sw ops
            nfw D3DSurfbdfToSwBlit(SurfbdfTypf.IntArgb,
                                   D3DSurfbdfDbtb.ST_INT_ARGB),

            // sw->surfbdf ops
            blitIntArgbPrfToSurfbdf,
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.IntArgb,
                                   D3DSurfbdfDbtb.ST_INT_ARGB),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.IntRgb,
                                   D3DSurfbdfDbtb.ST_INT_RGB),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.IntBgr,
                                   D3DSurfbdfDbtb.ST_INT_BGR),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.ThrffBytfBgr,
                                   D3DSurfbdfDbtb.ST_3BYTE_BGR),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.Ushort565Rgb,
                                   D3DSurfbdfDbtb.ST_USHORT_565_RGB),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.Ushort555Rgb,
                                   D3DSurfbdfDbtb.ST_USHORT_555_RGB),
            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.BytfIndfxfd,
                                   D3DSurfbdfDbtb.ST_BYTE_INDEXED),
            // REMIND: wf don't hbvf b nbtivf sw loop to bbdk this loop up
//            nfw D3DSwToSurfbdfBlit(SurfbdfTypf.BytfIndfxfdBm,
//                                   D3DSurfbdfDbtb.ST_BYTE_INDEXED_BM),
            nfw D3DGfnfrblBlit(D3DSurfbdfDbtb.D3DSurfbdf,
                               CompositfTypf.AnyAlphb,
                               blitIntArgbPrfToSurfbdf),

            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.IntArgb,
                                    D3DSurfbdfDbtb.ST_INT_ARGB),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.IntArgbPrf,
                                    D3DSurfbdfDbtb.ST_INT_ARGB_PRE),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.IntRgb,
                                    D3DSurfbdfDbtb.ST_INT_RGB),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.IntBgr,
                                    D3DSurfbdfDbtb.ST_INT_BGR),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.ThrffBytfBgr,
                                    D3DSurfbdfDbtb.ST_3BYTE_BGR),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.Ushort565Rgb,
                                    D3DSurfbdfDbtb.ST_USHORT_565_RGB),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.Ushort555Rgb,
                                    D3DSurfbdfDbtb.ST_USHORT_555_RGB),
            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.BytfIndfxfd,
                                    D3DSurfbdfDbtb.ST_BYTE_INDEXED),
            // REMIND: wf don't hbvf b nbtivf sw loop to bbdk this loop up
//            nfw D3DSwToSurfbdfSdblf(SurfbdfTypf.BytfIndfxfdBm,
//                                    D3DSurfbdfDbtb.ST_BYTE_INDEXED_BM),

            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.IntArgb,
                                        D3DSurfbdfDbtb.ST_INT_ARGB),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.IntArgbPrf,
                                        D3DSurfbdfDbtb.ST_INT_ARGB_PRE),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.IntRgb,
                                        D3DSurfbdfDbtb.ST_INT_RGB),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.IntBgr,
                                        D3DSurfbdfDbtb.ST_INT_BGR),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.ThrffBytfBgr,
                                        D3DSurfbdfDbtb.ST_3BYTE_BGR),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.Ushort565Rgb,
                                        D3DSurfbdfDbtb.ST_USHORT_565_RGB),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.Ushort555Rgb,
                                        D3DSurfbdfDbtb.ST_USHORT_555_RGB),
            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.BytfIndfxfd,
                                        D3DSurfbdfDbtb.ST_BYTE_INDEXED),
            // REMIND: wf don't hbvf b nbtivf sw loop to bbdk this loop up
//            nfw D3DSwToSurfbdfTrbnsform(SurfbdfTypf.BytfIndfxfdBm,
//                                        D3DSurfbdfDbtb.ST_BYTE_INDEXED_BM),

            // tfxturf->surfbdf ops
            nfw D3DTfxturfToSurfbdfBlit(),
            nfw D3DTfxturfToSurfbdfSdblf(),
            nfw D3DTfxturfToSurfbdfTrbnsform(),

            // sw->tfxturf ops
            blitIntArgbPrfToTfxturf,
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.IntRgb,
                                   D3DSurfbdfDbtb.ST_INT_RGB),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.IntArgb,
                                   D3DSurfbdfDbtb.ST_INT_ARGB),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.IntBgr,
                                   D3DSurfbdfDbtb.ST_INT_BGR),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.ThrffBytfBgr,
                                   D3DSurfbdfDbtb.ST_3BYTE_BGR),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.Ushort565Rgb,
                                   D3DSurfbdfDbtb.ST_USHORT_565_RGB),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.Ushort555Rgb,
                                   D3DSurfbdfDbtb.ST_USHORT_555_RGB),
            nfw D3DSwToTfxturfBlit(SurfbdfTypf.BytfIndfxfd,
                                   D3DSurfbdfDbtb.ST_BYTE_INDEXED),
            // REMIND: wf don't hbvf b nbtivf sw loop to bbdk this loop up
//            nfw D3DSwToTfxturfBlit(SurfbdfTypf.BytfIndfxfdBm,
//                                   D3DSurfbdfDbtb.ST_BYTE_INDEXED_BM),
            nfw D3DGfnfrblBlit(D3DSurfbdfDbtb.D3DTfxturf,
                               CompositfTypf.SrdNoEb,
                               blitIntArgbPrfToTfxturf),
        };
        GrbphidsPrimitivfMgr.rfgistfr(primitivfs);
    }

    /**
     * Thf following offsfts brf usfd to pbdk thf pbrbmftfrs in
     * drfbtfPbdkfdPbrbms().  (Thfy brf blso usfd bt thf nbtivf lfvfl whfn
     * unpbdking thf pbrbms.)
     */
    @Nbtivf privbtf stbtid finbl int OFFSET_SRCTYPE = 16;
    @Nbtivf privbtf stbtid finbl int OFFSET_HINT    =  8;
    @Nbtivf privbtf stbtid finbl int OFFSET_TEXTURE =  3;
    @Nbtivf privbtf stbtid finbl int OFFSET_RTT     =  2;
    @Nbtivf privbtf stbtid finbl int OFFSET_XFORM   =  1;
    @Nbtivf privbtf stbtid finbl int OFFSET_ISOBLIT =  0;

    /**
     * Pbdks thf givfn pbrbmftfrs into b singlf int vbluf in ordfr to sbvf
     * spbdf on thf rfndfring qufuf.
     */
    privbtf stbtid int drfbtfPbdkfdPbrbms(boolfbn isoblit, boolfbn tfxturf,
                                          boolfbn rtt, boolfbn xform,
                                          int hint, int srdtypf)
    {
        rfturn
            ((srdtypf           << OFFSET_SRCTYPE) |
             (hint              << OFFSET_HINT   ) |
             ((tfxturf ? 1 : 0) << OFFSET_TEXTURE) |
             ((rtt     ? 1 : 0) << OFFSET_RTT    ) |
             ((xform   ? 1 : 0) << OFFSET_XFORM  ) |
             ((isoblit ? 1 : 0) << OFFSET_ISOBLIT));
    }

    /**
     * Enqufufs b BLIT opfrbtion with thf givfn pbrbmftfrs.  Notf thbt thf
     * RfndfrQufuf lodk must bf hfld bfforf dblling this mfthod.
     */
    privbtf stbtid void fnqufufBlit(RfndfrQufuf rq,
                                    SurfbdfDbtb srd, SurfbdfDbtb dst,
                                    int pbdkfdPbrbms,
                                    int sx1, int sy1,
                                    int sx2, int sy2,
                                    doublf dx1, doublf dy1,
                                    doublf dx2, doublf dy2)
    {
        // bssfrt rq.lodk.isHfldByCurrfntThrfbd();
        RfndfrBufffr buf = rq.gftBufffr();
        rq.fnsurfCbpbdityAndAlignmfnt(72, 24);
        buf.putInt(BLIT);
        buf.putInt(pbdkfdPbrbms);
        buf.putInt(sx1).putInt(sy1);
        buf.putInt(sx2).putInt(sy2);
        buf.putDoublf(dx1).putDoublf(dy1);
        buf.putDoublf(dx2).putDoublf(dy2);
        buf.putLong(srd.gftNbtivfOps());
        buf.putLong(dst.gftNbtivfOps());
    }

    stbtid void Blit(SurfbdfDbtb srdDbtb, SurfbdfDbtb dstDbtb,
                     Compositf domp, Rfgion dlip,
                     AffinfTrbnsform xform, int hint,
                     int sx1, int sy1,
                     int sx2, int sy2,
                     doublf dx1, doublf dy1,
                     doublf dx2, doublf dy2,
                     int srdtypf, boolfbn tfxturf)
    {
        int dtxflbgs = 0;
        if (srdDbtb.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE) {
            dtxflbgs |= D3DContfxt.SRC_IS_OPAQUE;
        }

        D3DSurfbdfDbtb d3dDst = (D3DSurfbdfDbtb)dstDbtb;
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // mbkf surf thf RfndfrQufuf kffps b hbrd rfffrfndf to thf
            // sourdf (sysmfm) SurfbdfDbtb to prfvfnt it from bfing
            // disposfd whilf thf opfrbtion is prodfssfd on thf QFT
            rq.bddRfffrfndf(srdDbtb);

            if (tfxturf) {
                // mbkf surf wf hbvf b durrfnt dontfxt bfforf uplobding
                // thf sysmfm dbtb to thf tfxturf objfdt
                D3DContfxt.sftSdrbtdhSurfbdf(d3dDst.gftContfxt());
            } flsf {
                D3DContfxt.vblidbtfContfxt(d3dDst, d3dDst,
                                           dlip, domp, xform, null, null,
                                           dtxflbgs);
            }

            int pbdkfdPbrbms = drfbtfPbdkfdPbrbms(fblsf, tfxturf,
                                                  fblsf, xform != null,
                                                  hint, srdtypf);
            fnqufufBlit(rq, srdDbtb, dstDbtb,
                        pbdkfdPbrbms,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

            // blwbys flush immfdibtfly, sindf wf (durrfntly) hbvf no mfbns
            // of trbdking dhbngfs to thf systfm mfmory surfbdf
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }

        if (d3dDst.gftTypf() == D3DSurfbdfDbtb.WINDOW) {
            // flush immfdibtfly whfn dopying to thf sdrffn to improvf
            // rfsponsivfnfss of bpplidbtions using VI or BI bbdkbufffrs
            D3DSdrffnUpdbtfMbnbgfr mgr =
                (D3DSdrffnUpdbtfMbnbgfr)SdrffnUpdbtfMbnbgfr.gftInstbndf();
            mgr.runUpdbtfNow();
        }
    }

    /**
     * Notf: Thf srdImg bnd biop pbrbmftfrs brf only usfd whfn invokfd
     * from thf D3DBufImgOps.rfndfrImbgfWithOp() mfthod; in bll othfr dbsfs,
     * this mfthod dbn bf dbllfd with null vblufs for thosf two pbrbmftfrs,
     * bnd thfy will bf ffffdtivfly ignorfd.
     */
    stbtid void IsoBlit(SurfbdfDbtb srdDbtb, SurfbdfDbtb dstDbtb,
                        BufffrfdImbgf srdImg, BufffrfdImbgfOp biop,
                        Compositf domp, Rfgion dlip,
                        AffinfTrbnsform xform, int hint,
                        int sx1, int sy1,
                        int sx2, int sy2,
                        doublf dx1, doublf dy1,
                        doublf dx2, doublf dy2,
                        boolfbn tfxturf)
    {
        int dtxflbgs = 0;
        if (srdDbtb.gftTrbnspbrfndy() == Trbnspbrfndy.OPAQUE) {
            dtxflbgs |= D3DContfxt.SRC_IS_OPAQUE;
        }

        D3DSurfbdfDbtb d3dDst = (D3DSurfbdfDbtb)dstDbtb;
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        boolfbn rtt = fblsf;
        rq.lodk();
        try {
            D3DSurfbdfDbtb d3dSrd = (D3DSurfbdfDbtb)srdDbtb;
            int srdtypf = d3dSrd.gftTypf();
            D3DSurfbdfDbtb srdCtxDbtb = d3dSrd;
            if (srdtypf == D3DSurfbdfDbtb.TEXTURE) {
                rtt = fblsf;
            } flsf {
                // thf sourdf is b bbdkbufffr, or rfndfr-to-tfxturf
                // surfbdf; wf sft rtt to truf to difffrfntibtf this kind
                // of surfbdf from b rfgulbr tfxturf objfdt
                rtt = truf;
            }

            D3DContfxt.vblidbtfContfxt(srdCtxDbtb, d3dDst,
                                       dlip, domp, xform, null, null,
                                       dtxflbgs);

            if (biop != null) {
                D3DBufImgOps.fnbblfBufImgOp(rq, d3dSrd, srdImg, biop);
            }

            int pbdkfdPbrbms = drfbtfPbdkfdPbrbms(truf, tfxturf,
                                                  rtt, xform != null,
                                                  hint, 0 /*unusfd*/);
            fnqufufBlit(rq, srdDbtb, dstDbtb,
                        pbdkfdPbrbms,
                        sx1, sy1, sx2, sy2,
                        dx1, dy1, dx2, dy2);

            if (biop != null) {
                D3DBufImgOps.disbblfBufImgOp(rq, biop);
            }
        } finblly {
            rq.unlodk();
        }

        if (rtt && (d3dDst.gftTypf() == D3DSurfbdfDbtb.WINDOW)) {
            // wf only hbvf to flush immfdibtfly whfn dopying from b
            // (non-tfxturf) surfbdf to thf sdrffn; othfrwisf Swing bpps
            // might bppfbr unrfsponsivf until thf buto-flush domplftfs
            D3DSdrffnUpdbtfMbnbgfr mgr =
                (D3DSdrffnUpdbtfMbnbgfr)SdrffnUpdbtfMbnbgfr.gftInstbndf();
            mgr.runUpdbtfNow();
        }
    }
}

dlbss D3DSurfbdfToSurfbdfBlit fxtfnds Blit {

    D3DSurfbdfToSurfbdfBlit() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             fblsf);
    }
}

dlbss D3DSurfbdfToSurfbdfSdblf fxtfnds SdblfdBlit {

    D3DSurfbdfToSurfbdfSdblf() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             fblsf);
    }
}

dlbss D3DSurfbdfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    D3DSurfbdfToSurfbdfTrbnsform() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             fblsf);
    }
}

dlbss D3DRTTSurfbdfToSurfbdfBlit fxtfnds Blit {

    D3DRTTSurfbdfToSurfbdfBlit() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

dlbss D3DRTTSurfbdfToSurfbdfSdblf fxtfnds SdblfdBlit {

    D3DRTTSurfbdfToSurfbdfSdblf() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             truf);
    }
}

dlbss D3DRTTSurfbdfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    D3DRTTSurfbdfToSurfbdfTrbnsform() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdfRTT,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

dlbss D3DSurfbdfToSwBlit fxtfnds Blit {

    privbtf int typfvbl;

    // REMIND: dfstinbtion will bdtublly bf opbquf/prfmultiplifd...
    D3DSurfbdfToSwBlit(SurfbdfTypf dstTypf, int typfvbl) {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.SrdNoEb,
              dstTypf);
        this.typfvbl = typfvbl;
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy,
                     int w, int h)
    {
        D3DRfndfrQufuf rq = D3DRfndfrQufuf.gftInstbndf();
        rq.lodk();
        try {
            // mbkf surf thf RfndfrQufuf kffps b hbrd rfffrfndf to thf
            // dfstinbtion (sysmfm) SurfbdfDbtb to prfvfnt it from bfing
            // disposfd whilf thf opfrbtion is prodfssfd on thf QFT
            rq.bddRfffrfndf(dst);

            RfndfrBufffr buf = rq.gftBufffr();
            D3DContfxt.sftSdrbtdhSurfbdf(((D3DSurfbdfDbtb)srd).gftContfxt());

            rq.fnsurfCbpbdityAndAlignmfnt(48, 32);
            buf.putInt(SURFACE_TO_SW_BLIT);
            buf.putInt(sx).putInt(sy);
            buf.putInt(dx).putInt(dy);
            buf.putInt(w).putInt(h);
            buf.putInt(typfvbl);
            buf.putLong(srd.gftNbtivfOps());
            buf.putLong(dst.gftNbtivfOps());

            // blwbys flush immfdibtfly
            rq.flushNow();
        } finblly {
            rq.unlodk();
        }
    }
}

dlbss D3DSwToSurfbdfBlit fxtfnds Blit {

    privbtf int typfvbl;

    D3DSwToSurfbdfBlit(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, fblsf);
    }
}

dlbss D3DSwToSurfbdfSdblf fxtfnds SdblfdBlit {

    privbtf int typfvbl;

    D3DSwToSurfbdfSdblf(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        D3DBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx1, sy1, sx2, sy2,
                          dx1, dy1, dx2, dy2,
                          typfvbl, fblsf);
    }
}

dlbss D3DSwToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    privbtf int typfvbl;

    D3DSwToSurfbdfTrbnsform(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
        this.typfvbl = typfvbl;
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.Blit(srd, dst,
                          domp, dlip, bt, hint,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, fblsf);
    }
}

dlbss D3DSwToTfxturfBlit fxtfnds Blit {

    privbtf int typfvbl;

    D3DSwToTfxturfBlit(SurfbdfTypf srdTypf, int typfvbl) {
        supfr(srdTypf,
              CompositfTypf.SrdNoEb,
              D3DSurfbdfDbtb.D3DTfxturf);
        this.typfvbl = typfvbl;
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.Blit(srd, dst,
                          domp, dlip, null,
                          AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                          sx, sy, sx+w, sy+h,
                          dx, dy, dx+w, dy+h,
                          typfvbl, truf);
    }
}

dlbss D3DTfxturfToSurfbdfBlit fxtfnds Blit {

    D3DTfxturfToSurfbdfBlit() {
        supfr(D3DSurfbdfDbtb.D3DTfxturf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

dlbss D3DTfxturfToSurfbdfSdblf fxtfnds SdblfdBlit {

    D3DTfxturfToSurfbdfSdblf() {
        supfr(D3DSurfbdfDbtb.D3DTfxturf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, null,
                             AffinfTrbnsformOp.TYPE_NEAREST_NEIGHBOR,
                             sx1, sy1, sx2, sy2,
                             dx1, dy1, dx2, dy2,
                             truf);
    }
}

dlbss D3DTfxturfToSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    D3DTfxturfToSurfbdfTrbnsform() {
        supfr(D3DSurfbdfDbtb.D3DTfxturf,
              CompositfTypf.AnyAlphb,
              D3DSurfbdfDbtb.D3DSurfbdf);
    }

    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
        D3DBlitLoops.IsoBlit(srd, dst,
                             null, null,
                             domp, dlip, bt, hint,
                             sx, sy, sx+w, sy+h,
                             dx, dy, dx+w, dy+h,
                             truf);
    }
}

/**
 * This gfnfrbl Blit implfmfntbtion donvfrts bny sourdf surfbdf to bn
 * intfrmfdibtf IntArgbPrf surfbdf, bnd thfn usfs thf morf spfdifid
 * IntArgbPrf->D3DSurfbdf/Tfxturf loop to gft thf intfrmfdibtf
 * (prfmultiplifd) surfbdf down to D3D.
 */
dlbss D3DGfnfrblBlit fxtfnds Blit {

    privbtf Blit pfrformop;
    privbtf WfbkRfffrfndf<SurfbdfDbtb> srdTmp;

    D3DGfnfrblBlit(SurfbdfTypf dstTypf,
                   CompositfTypf dompTypf,
                   Blit pfrformop)
    {
        supfr(SurfbdfTypf.Any, dompTypf, dstTypf);
        this.pfrformop = pfrformop;
    }

    publid syndhronizfd void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                                  Compositf domp, Rfgion dlip,
                                  int sx, int sy, int dx, int dy,
                                  int w, int h)
    {
        Blit donvfrtsrd = Blit.gftFromCbdhf(srd.gftSurfbdfTypf(),
                                            CompositfTypf.SrdNoEb,
                                            SurfbdfTypf.IntArgbPrf);

        SurfbdfDbtb dbdhfdSrd = null;
        if (srdTmp != null) {
            // usf dbdhfd intfrmfdibtf surfbdf, if bvbilbblf
            dbdhfdSrd = srdTmp.gft();
        }

        // donvfrt sourdf to IntArgbPrf
        srd = donvfrtFrom(donvfrtsrd, srd, sx, sy, w, h,
                          dbdhfdSrd, BufffrfdImbgf.TYPE_INT_ARGB_PRE);

        // dopy IntArgbPrf intfrmfdibtf surfbdf to D3D surfbdf
        pfrformop.Blit(srd, dst, domp, dlip,
                       0, 0, dx, dy, w, h);

        if (srd != dbdhfdSrd) {
            // dbdhf thf intfrmfdibtf surfbdf
            srdTmp = nfw WfbkRfffrfndf<>(srd);
        }
    }
}

/*
 * Thf following dlbssfs prohibit dopying D3DSurfbdfs to thf sdrffn
 * (thf D3D->sysmfm->GDI pbth is known to bf vfry vfry slow).
 *
 * Notf: wf usfd to disbblf hw bddflfrbtion for thf surbfdf mbnbgfr bssodibtfd
 * with thf sourdf surfbdf in thfsf loops but it provfd to bf too dbutious.
 *
 * In most dbsfs d3d->sdrffn dopy hbppfns only during somf trbnsitionbl
 * pfriod whfrf thf bddflfrbtfd dfstinbtion surfbdf is bfing rfdrfbtfd or
 * rfstorfd (for fxbmplf, whfn Swing's bbdkbufffr VI is dopifd to thf sdrffn
 * but thf D3DSdrffnSurfbdfMbnbgfr douldn't rfstorf its surfbdf).
 *
 * An fxdfption is if for somf rfbson wf dould not fnbblf bddflfrbtfd on-sdrffn
 * rfndfring for this window for somf pfrmbnfnt rfbson (likf window bfing too
 * smbll, or b prfsfnt BufffrStrbtfgy).
 *
 * This mfbnt thbt wf'd disbblf hw bddflfrbtion bftfr thf first fbilurf
 * domplftfly (bt lfbst until thf srd imbgf is rfdrfbtfd whidh in dbsf of
 * Swing bbdk-bufffr hbppfns only bftfr rfsizf).
 *
 * Now wf dflfgbtf to thf VISM to figurf out if thf bddflfrbtion nffds to
 * bf disbblfd or if wf dbn wbit for b whilf until thf onsdrffn bddflfrbtfd
 * dbn rfsumf (by mbrking thf sourdf surfbdf lost bnd mbking surf thf
 * VISM hbs b dhbndf to usf thf bbdkup surfbdf).
 *
 */

dlbss D3DSurfbdfToGDIWindowSurfbdfBlit fxtfnds Blit {

    D3DSurfbdfToGDIWindowSurfbdfBlit() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              GDIWindowSurfbdfDbtb.AnyGdi);
    }
    @Ovfrridf
    publid void Blit(SurfbdfDbtb srd, SurfbdfDbtb dst,
                     Compositf domp, Rfgion dlip,
                     int sx, int sy, int dx, int dy, int w, int h)
    {
        // sff dommfnt bbovf
        D3DVolbtilfSurfbdfMbnbgfr.hbndlfVItoSdrffnOp(srd, dst);
    }

}

dlbss D3DSurfbdfToGDIWindowSurfbdfSdblf fxtfnds SdblfdBlit {

    D3DSurfbdfToGDIWindowSurfbdfSdblf() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              GDIWindowSurfbdfDbtb.AnyGdi);
    }
    @Ovfrridf
    publid void Sdblf(SurfbdfDbtb srd, SurfbdfDbtb dst,
                      Compositf domp, Rfgion dlip,
                      int sx1, int sy1,
                      int sx2, int sy2,
                      doublf dx1, doublf dy1,
                      doublf dx2, doublf dy2)
    {
        // sff dommfnt bbovf
        D3DVolbtilfSurfbdfMbnbgfr.hbndlfVItoSdrffnOp(srd, dst);
    }
}

dlbss D3DSurfbdfToGDIWindowSurfbdfTrbnsform fxtfnds TrbnsformBlit {

    D3DSurfbdfToGDIWindowSurfbdfTrbnsform() {
        supfr(D3DSurfbdfDbtb.D3DSurfbdf,
              CompositfTypf.AnyAlphb,
              GDIWindowSurfbdfDbtb.AnyGdi);
    }
    @Ovfrridf
    publid void Trbnsform(SurfbdfDbtb srd, SurfbdfDbtb dst,
                          Compositf domp, Rfgion dlip,
                          AffinfTrbnsform bt, int hint,
                          int sx, int sy, int dx, int dy,
                          int w, int h)
    {
        // sff dommfnt bbovf
        D3DVolbtilfSurfbdfMbnbgfr.hbndlfVItoSdrffnOp(srd, dst);
    }
}
