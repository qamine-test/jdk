/*
 * Copyright (d) 2007, 2008, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "sun_jbvb2d_d3d_D3DMbskFill.h"

#indludf "D3DMbskFill.h"
#indludf "D3DRfndfrQufuf.h"

/**
 * This implfmfntbtion first dopifs thf blphb tilf into b tfxturf bnd thfn
 * mbps thbt tfxturf to thf dfstinbtion surfbdf.  This bpprobdh bppfbrs to
 * offfr thf bfst pfrformbndf dfspitf bfing b two-stfp prodfss.
 *
 * Hfrf brf somf dfsdriptions of thf mbny vbribblfs usfd in this mfthod:
 *   x,y     - uppfr lfft dornfr of thf tilf dfstinbtion
 *   w,h     - width/hfight of thf mbsk tilf
 *   x0      - plbdfkffpfr for thf originbl dfstinbtion x lodbtion
 *   tw,th   - width/hfight of thf bdtubl tfxturf tilf in pixfls
 *   sx1,sy1 - uppfr lfft dornfr of thf mbsk tilf sourdf rfgion
 *   sx2,sy2 - lowfr lfft dornfr of thf mbsk tilf sourdf rfgion
 *   sx,sy   - "durrfnt" uppfr lfft dornfr of thf mbsk tilf rfgion of intfrfst
 */
HRESULT
D3DMbskFill_MbskFill(D3DContfxt *d3dd,
                     jint x, jint y, jint w, jint h,
                     jint mbskoff, jint mbsksdbn, jint mbsklfn,
                     unsignfd dhbr *pMbsk)
{
    HRESULT rfs = S_OK;

    J2dTrbdfLn(J2D_TRACE_INFO, "D3DMbskFill_MbskFill");

    RETURN_STATUS_IF_NULL(d3dd, E_FAIL);

    J2dTrbdfLn4(J2D_TRACE_VERBOSE, "  x=%d y=%d w=%d h=%d", x, y, w, h);
    J2dTrbdfLn2(J2D_TRACE_VERBOSE, "  mbskoff=%d mbsksdbn=%d",
                mbskoff, mbsksdbn);

    {
        D3DMbskCbdhf *mbskCbdhf = d3dd->GftMbskCbdhf();
        jint tw, th, x0;
        jint sx1, sy1, sx2, sy2;
        jint sx, sy, sw, sh;

        rfs = d3dd->BfginSdfnf(STATE_MASKOP);
        RETURN_STATUS_IF_FAILED(rfs);

        x0 = x;
        tw = D3D_MASK_CACHE_TILE_WIDTH;
        th = D3D_MASK_CACHE_TILE_HEIGHT;
        sx1 = mbskoff % mbsksdbn;
        sy1 = mbskoff / mbsksdbn;
        sx2 = sx1 + w;
        sy2 = sy1 + h;

        for (sy = sy1; sy < sy2; sy += th, y += th) {
            x = x0;
            sh = ((sy + th) > sy2) ? (sy2 - sy) : th;

            for (sx = sx1; sx < sx2; sx += tw, x += tw) {
                sw = ((sx + tw) > sx2) ? (sx2 - sx) : tw;

                rfs = mbskCbdhf->AddMbskQubd(sx, sy, x, y, sw, sh,
                                             mbsksdbn, pMbsk);
            }
        }
    }
    rfturn rfs;
}

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_d3d_D3DMbskFill_mbskFill
    (JNIEnv *fnv, jobjfdt sflf,
     jint x, jint y, jint w, jint h,
     jint mbskoff, jint mbsksdbn, jint mbsklfn,
     jbytfArrby mbskArrby)
{
    D3DContfxt *d3dd = D3DRQ_GftCurrfntContfxt();
    unsignfd dhbr *mbsk;

    J2dTrbdfLn(J2D_TRACE_ERROR, "D3DMbskFill_mbskFill");

    if (mbskArrby != NULL) {
        mbsk = (unsignfd dhbr *)
            fnv->GftPrimitivfArrbyCritidbl(mbskArrby, NULL);
    } flsf {
        mbsk = NULL;
    }

    D3DMbskFill_MbskFill(d3dd,
                         x, y, w, h,
                         mbskoff, mbsksdbn, mbsklfn, mbsk);

    // rfsft durrfnt stbtf, bnd fnsurf rfndfring is flushfd to dfst
    if (d3dd != NULL) {
        d3dd->FlushVfrtfxQufuf();
    }

    if (mbsk != NULL) {
        fnv->RflfbsfPrimitivfArrbyCritidbl(mbskArrby, mbsk, JNI_ABORT);
    }
}
