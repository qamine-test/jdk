/*
 * Copyright (d) 2007, 2008, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "D3DPipflinf.h"

#indludf "sun_jbvb2d_d3d_D3DRfndfrfr.h"

#indludf "D3DContfxt.h"
#indludf "D3DRfndfrfr.h"
#indludf "D3DRfndfrQufuf.h"

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwLinf(D3DContfxt *d3dd,
                     jint x1, jint y1, jint x2, jint y2)
{
    J2dTrbdfLn4(J2D_TRACE_INFO,
                "D3DRfndfrfr_doDrbwLinfD3D x1=%-4d y1=%-4d x2=%-4d y2=%-4d",
                x1, y1, x2, y2);
    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->DrbwLinf(x1, y1, x2, y2);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwRfdt(D3DContfxt *d3dd,
                     jint x, jint y, jint w, jint h)
{
    J2dTrbdfLn4(J2D_TRACE_INFO,
                "D3DRfndfrfr_DrbwRfdt x=%-4d y=%-4d w=%-4d h=%-4d",
                x, y, w, h);

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->DrbwRfdt(x, y, x + w, y + h);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_FillRfdt(D3DContfxt *d3dd,
                     jint x, jint y, jint w, jint h)
{
    J2dTrbdfLn4(J2D_TRACE_INFO,
               "D3DRfndfrfr_FillRfdt x=%-4d y=%-4d w=%-4d h=%-4d",
                x, y, w, h);

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->FillRfdt(x, y, x + w, y + h);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwPoly(D3DContfxt *d3dd,
                     jint nPoints, jboolfbn isClosfd,
                     jint trbnsX, jint trbnsY,
                     jint *xPoints, jint *yPoints)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "D3DRfndfrfr_DrbwPoly");

    if (d3dd == NULL || xPoints == NULL || yPoints == NULL) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR,
            "D3DRfndfrfr_DrbwPoly: d3dd, xPoints or yPoints is NULL");
        rfturn E_FAIL;
    }

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->DrbwPoly(nPoints, isClosfd, trbnsX, trbnsY,
                                    xPoints, yPoints);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwSdbnlinfs(D3DContfxt *d3dd,
                          jint sdbnlinfCount, jint *sdbnlinfs)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "D3DRfndfrfr_DrbwSdbnlinfs");

    if (d3dd == NULL) {
       rfturn E_FAIL;
    }
    if (sdbnlinfs == NULL || sdbnlinfCount <= 0) {
        rfturn D3D_OK;
    }

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->DrbwSdbnlinfs(sdbnlinfCount, sdbnlinfs);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_FillSpbns(D3DContfxt *d3dd, jint spbnCount, jint *spbns)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "D3DRfndfrfr_FillSpbns");
    if (d3dd == NULL) {
        rfturn E_FAIL;
    }

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->FillSpbns(spbnCount, spbns);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_FillPbrbllflogrbm(D3DContfxt *d3dd,
                              jflobt fx11, jflobt fy11,
                              jflobt dx21, jflobt dy21,
                              jflobt dx12, jflobt dy12)
{
    J2dTrbdfLn6(J2D_TRACE_INFO,
                "D3DRfndfrfr_FillPbrbllflogrbm "
                "x=%6.2f y=%6.2f "
                "dx1=%6.2f dy1=%6.2f "
                "dx2=%6.2f dy2=%6.2f ",
                fx11, fy11,
                dx21, dy21,
                dx12, dy12);

    d3dd->BfginSdfnf(STATE_RENDEROP);
    rfturn d3dd->pVCbdhfr->FillPbrbllflogrbm(fx11, fy11,
                                             dx21, dy21,
                                             dx12, dy12);
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwPbrbllflogrbm(D3DContfxt *d3dd,
                              jflobt fx11, jflobt fy11,
                              jflobt dx21, jflobt dy21,
                              jflobt dx12, jflobt dy12,
                              jflobt lwr21, jflobt lwr12)
{
    HRESULT rfs;

    J2dTrbdfLn8(J2D_TRACE_INFO,
                "D3DRfndfrfr_DrbwPbrbllflogrbm "
                "x=%6.2f y=%6.2f "
                "dx1=%6.2f dy1=%6.2f lwr1=%6.2f "
                "dx2=%6.2f dy2=%6.2f lwr2=%6.2f ",
                fx11, fy11,
                dx21, dy21, lwr21,
                dx12, dy12, lwr12);

    // dx,dy for linf width in thf "21" bnd "12" dirfdtions.
    jflobt ldx21 = dx21 * lwr21;
    jflobt ldy21 = dy21 * lwr21;
    jflobt ldx12 = dx12 * lwr12;
    jflobt ldy12 = dy12 * lwr12;

    // dbldulbtf origin of thf outfr pbrbllflogrbm
    jflobt ox11 = fx11 - (ldx21 + ldx12) / 2.0f;
    jflobt oy11 = fy11 - (ldy21 + ldy12) / 2.0f;

    rfs = d3dd->BfginSdfnf(STATE_RENDEROP);
    RETURN_STATUS_IF_FAILED(rfs);

    // Only nffd to gfnfrbtf 4 qubds if thf intfrior still
    // hbs b holf in it (i.f. if thf linf width rbtio wbs
    // lfss thbn 1.0)
    if (lwr21 < 1.0f && lwr12 < 1.0f) {
        // Notf: "TOP", "BOTTOM", "LEFT" bnd "RIGHT" hfrf brf
        // rflbtivf to whfthfr thf dxNN vbribblfs brf positivf
        // bnd nfgbtivf.  Thf mbth works finf rfgbrdlfss of
        // thfir signs, but for dondfptubl simplidity thf
        // dommfnts will rfffr to thf sidfs bs if thf dxNN
        // wfrf bll positivf.  "TOP" bnd "BOTTOM" sfgmfnts
        // brf dffinfd by thf dxy21 dfltbs.  "LEFT" bnd "RIGHT"
        // sfgmfnts brf dffinfd by thf dxy12 dfltbs.

        // Ebdh sfgmfnt indludfs its stbrting dornfr bnd domfs
        // to just short of thf following dornfr.  Thus, fbdh
        // dornfr is indludfd just ondf bnd thf only lfngths
        // nffdfd brf thf originbl pbrbllflogrbm dfltb lfngths
        // bnd thf "linf width dfltbs".  Thf sidfs will dovfr
        // thf following rflbtivf tfrritorifs:
        //
        //     T T T T T R
        //      L         R
        //       L         R
        //        L         R
        //         L         R
        //          L B B B B B

        // TOP sfgmfnt, to lfft sidf of RIGHT fdgf
        // "width" of originbl pgrbm, "hfight" of hor. linf sizf
        fx11 = ox11;
        fy11 = oy11;
        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbm(fx11, fy11,
                                                dx21, dy21,
                                                ldx12, ldy12);

        // RIGHT sfgmfnt, to top of BOTTOM fdgf
        // "width" of vfrt. linf sizf , "hfight" of originbl pgrbm
        fx11 = ox11 + dx21;
        fy11 = oy11 + dy21;
        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbm(fx11, fy11,
                                                ldx21, ldy21,
                                                dx12, dy12);

        // BOTTOM sfgmfnt, from right sidf of LEFT fdgf
        // "width" of originbl pgrbm, "hfight" of hor. linf sizf
        fx11 = ox11 + dx12 + ldx21;
        fy11 = oy11 + dy12 + ldy21;
        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbm(fx11, fy11,
                                                dx21, dy21,
                                                ldx12, ldy12);

        // LEFT sfgmfnt, from bottom of TOP fdgf
        // "width" of vfrt. linf sizf , "hfight" of innfr pgrbm
        fx11 = ox11 + ldx12;
        fy11 = oy11 + ldy12;
        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbm(fx11, fy11,
                                                ldx21, ldy21,
                                                dx12, dy12);
    } flsf {
        // Thf linf width rbtios wfrf lbrgf fnough to donsumf
        // thf fntirf holf in thf middlf of thf pbrbllflogrbm
        // so wf dbn just issuf onf lbrgf qubd for thf outfr
        // pbrbllflogrbm.
        dx21 += ldx21;
        dy21 += ldy21;
        dx12 += ldx12;
        dy12 += ldy12;

        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbm(ox11, oy11,
                                                dx21, dy21,
                                                dx12, dy12);
    }

    rfturn rfs;
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_FillAAPbrbllflogrbm(D3DContfxt *d3dd,
                                jflobt fx11, jflobt fy11,
                                jflobt dx21, jflobt dy21,
                                jflobt dx12, jflobt dy12)
{
    IDirfdt3DDfvidf9 *pd3dDfvidf;
    HRESULT rfs;

    J2dTrbdfLn6(J2D_TRACE_INFO,
                "D3DRfndfrfr_FillAAPbrbllflogrbm "
                "x=%6.2f y=%6.2f "
                "dx1=%6.2f dy1=%6.2f "
                "dx2=%6.2f dy2=%6.2f ",
                fx11, fy11,
                dx21, dy21,
                dx12, dy12);

    rfs = d3dd->BfginSdfnf(STATE_AAPGRAMOP);
    RETURN_STATUS_IF_FAILED(rfs);

    pd3dDfvidf = d3dd->Gft3DDfvidf();
    if (pd3dDfvidf == NULL) {
        rfturn E_FAIL;
    }

    rfs = d3dd->pVCbdhfr->FillPbrbllflogrbmAA(fx11, fy11,
                                              dx21, dy21,
                                              dx12, dy12);
    rfturn rfs;
}

HRESULT D3DPIPELINE_API
D3DRfndfrfr_DrbwAAPbrbllflogrbm(D3DContfxt *d3dd,
                                jflobt fx11, jflobt fy11,
                                jflobt dx21, jflobt dy21,
                                jflobt dx12, jflobt dy12,
                                jflobt lwr21, jflobt lwr12)
{
    IDirfdt3DDfvidf9 *pd3dDfvidf;
    // dx,dy for linf width in thf "21" bnd "12" dirfdtions.
    jflobt ldx21, ldy21, ldx12, ldy12;
    // pbrbmftfrs for "outfr" pbrbllflogrbm
    jflobt ofx11, ofy11, odx21, ody21, odx12, ody12;
    // pbrbmftfrs for "innfr" pbrbllflogrbm
    jflobt ifx11, ify11, idx21, idy21, idx12, idy12;
    HRESULT rfs;

    J2dTrbdfLn8(J2D_TRACE_INFO,
                "D3DRfndfrfr_DrbwAAPbrbllflogrbm "
                "x=%6.2f y=%6.2f "
                "dx1=%6.2f dy1=%6.2f lwr1=%6.2f "
                "dx2=%6.2f dy2=%6.2f lwr2=%6.2f ",
                fx11, fy11,
                dx21, dy21, lwr21,
                dx12, dy12, lwr12);

    rfs = d3dd->BfginSdfnf(STATE_AAPGRAMOP);
    RETURN_STATUS_IF_FAILED(rfs);

    pd3dDfvidf = d3dd->Gft3DDfvidf();
    if (pd3dDfvidf == NULL) {
        rfturn E_FAIL;
    }

    // dbldulbtf truf dx,dy for linf widths from thf "linf width rbtios"
    ldx21 = dx21 * lwr21;
    ldy21 = dy21 * lwr21;
    ldx12 = dx12 * lwr12;
    ldy12 = dy12 * lwr12;

    // dbldulbtf doordinbtfs of thf outfr pbrbllflogrbm
    ofx11 = fx11 - (ldx21 + ldx12) / 2.0f;
    ofy11 = fy11 - (ldy21 + ldy12) / 2.0f;
    odx21 = dx21 + ldx21;
    ody21 = dy21 + ldy21;
    odx12 = dx12 + ldx12;
    ody12 = dy12 + ldy12;

    // Only prodfss thf innfr pbrbllflogrbm if thf linf width rbtio
    // did not donsumf thf fntirf intfrior of thf pbrbllflogrbm
    // (i.f. if thf width rbtio wbs lfss thbn 1.0)
    if (lwr21 < 1.0f && lwr12 < 1.0f) {
        // dbldulbtf doordinbtfs of thf innfr pbrbllflogrbm
        ifx11 = fx11 + (ldx21 + ldx12) / 2.0f;
        ify11 = fy11 + (ldy21 + ldy12) / 2.0f;
        idx21 = dx21 - ldx21;
        idy21 = dy21 - ldy21;
        idx12 = dx12 - ldx12;
        idy12 = dy12 - ldy12;

        rfs = d3dd->pVCbdhfr->DrbwPbrbllflogrbmAA(ofx11, ofy11,
                                                  odx21, ody21,
                                                  odx12, ody12,
                                                  ifx11, ify11,
                                                  idx21, idy21,
                                                  idx12, idy12);
    } flsf {
        // Just invokf b rfgulbr fill on thf outfr pbrbllflogrbm
        rfs = d3dd->pVCbdhfr->FillPbrbllflogrbmAA(ofx11, ofy11,
                                                  odx21, ody21,
                                                  odx12, ody12);
    }

    rfturn rfs;
}

#ifndff D3D_PPL_DLL

fxtfrn "C"
{

JNIEXPORT void JNICALL
Jbvb_sun_jbvb2d_d3d_D3DRfndfrfr_drbwPoly
    (JNIEnv *fnv, jobjfdt d3dr,
     jintArrby xpointsArrby, jintArrby ypointsArrby,
     jint nPoints, jboolfbn isClosfd,
     jint trbnsX, jint trbnsY)
{
    jint *xPoints, *yPoints;

    J2dTrbdfLn(J2D_TRACE_INFO, "D3DRfndfrfr_drbwPoly");

    xPoints = (jint *)fnv->GftPrimitivfArrbyCritidbl(xpointsArrby, NULL);
    if (xPoints != NULL) {
        yPoints = (jint *)fnv->GftPrimitivfArrbyCritidbl(ypointsArrby, NULL);
        if (yPoints != NULL) {
            D3DContfxt *d3dd = D3DRQ_GftCurrfntContfxt();

            D3DRfndfrfr_DrbwPoly(d3dd,
                                 nPoints, isClosfd,
                                 trbnsX, trbnsY,
                                 xPoints, yPoints);

            if (d3dd != NULL) {
                HRESULT rfs = d3dd->EndSdfnf();
                D3DRQ_MbrkLostIfNffdfd(rfs,
                    D3DRQ_GftCurrfntDfstinbtion());
            }
            fnv->RflfbsfPrimitivfArrbyCritidbl(ypointsArrby, yPoints, JNI_ABORT);
        }
        fnv->RflfbsfPrimitivfArrbyCritidbl(xpointsArrby, xPoints, JNI_ABORT);
    }
}

}

#fndif // D3D_PPL_DLL
