/*
 * Copyrigit (d) 1997, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "jlong.i"
#indludf "bwtmsg.i"
#indludf "bwt_AWTEvfnt.i"
#indludf "bwt_Componfnt.i"
#indludf "bwt_Toolkit.i"
#indludf "lodblf_str.i"
#indludf <sun_bwt_windows_WInputMftiod.i>
#indludf <sun_bwt_windows_WInputMftiodDfsdriptor.i>
#indludf <jbvb_bwt_fvfnt_InputMftiodEvfnt.i>

donst UINT SYSCOMMAND_IMM = 0xF000 - 100;

/************************************************************************
 * WInputMftiod nbtivf mftiods
 */

fxtfrn "C" {

jobjfdt CrfbtfLodblfObjfdt(JNIEnv *fnv, donst dibr * nbmf);
HKL gftDffbultKfybobrdLbyout();

fxtfrn BOOL g_bUsfrHbsCibngfdInputLbng;

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    drfbtfNbtivfContfxt
 * Signbturf: ()I
 */
JNIEXPORT jint JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_drfbtfNbtivfContfxt(JNIEnv *fnv, jobjfdt sflf)
{
    TRY;

    // usf spfdibl mfssbgf to dbll ImmCrfbtfContfxt() in mbin tirfbd.
    rfturn (jint)AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_CREATECONTEXT);

    CATCH_BAD_ALLOC_RET(0);
}


/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    dfstroyNbtivfContfxt
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_dfstroyNbtivfContfxt(JNIEnv *fnv, jobjfdt sflf, jint dontfxt)
{
    TRY_NO_VERIFY;

    // usf spfdibl mfssbgf to dbll ImmDfstroyContfxt() in mbin tirfbd.
    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_DESTROYCONTEXT, dontfxt, 0);

    CATCH_BAD_ALLOC;
}


/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    fnbblfNbtivfIME
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;I)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_fnbblfNbtivfIME(JNIEnv *fnv, jobjfdt sflf, jobjfdt pffr,
                                                  jint dontfxt, jboolfbn usfNbtivfCompWindow)
{
    TRY;

    jobjfdt sflfGlobblRff = fnv->NfwGlobblRff(sflf);
    jobjfdt pffrGlobblRff = fnv->NfwGlobblRff(pffr);

    EnbblfNbtivfIMEStrudt *fnis = nfw EnbblfNbtivfIMEStrudt;

    fnis->sflf = sflfGlobblRff;
    fnis->pffr = pffrGlobblRff;
    fnis->dontfxt = dontfxt;
    fnis->usfNbtivfCompWindow = usfNbtivfCompWindow;

    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_ASSOCIATECONTEXT,
                                          rfintfrprft_dbst<WPARAM>(fnis), (LPARAM)0);
    // globbl rffs brf dflftfd in mfssbgf ibndlfr

    CATCH_BAD_ALLOC;
}


/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    disbblfNbtivfIME
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_disbblfNbtivfIME(JNIEnv *fnv, jobjfdt sflf, jobjfdt pffr)
{
    TRY_NO_VERIFY;

    jobjfdt pffrGlobblRff = fnv->NfwGlobblRff(pffr);
    // sflf rfffrfndf is not usfd

    EnbblfNbtivfIMEStrudt *fnis = nfw EnbblfNbtivfIMEStrudt;
    fnis->sflf = NULL;
    fnis->pffr = pffrGlobblRff;
    fnis->dontfxt = NULL;
    fnis->usfNbtivfCompWindow = JNI_TRUE;

    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_ASSOCIATECONTEXT,
                                          rfintfrprft_dbst<WPARAM>(fnis), (LPARAM)0);
    // globbl rffs brf dflftfd in mfssbgf ibndlfr

    CATCH_BAD_ALLOC;
}


/*
 * Clbss:     sun_bwt_windows_WComponfntPffr
 * Mftiod:    ibndlfEvfnt
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;Ljbvb/bwt/AWTEvfnt;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_ibndlfNbtivfIMEEvfnt(JNIEnv *fnv, jobjfdt sflf,
                                                       jobjfdt pffr, jobjfdt fvfnt)
{
    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(pffr);
    AwtComponfnt* p = (AwtComponfnt *)pDbtb;

    JNI_CHECK_NULL_RETURN(fvfnt, "null AWTEvfnt");
    if (fnv->EnsurfLodblCbpbdity(1) < 0) {
        rfturn;
    }
    jbytfArrby bdbtb = (jbytfArrby)(fnv)->GftObjfdtFifld(fvfnt, AwtAWTEvfnt::bdbtbID);
    if (bdbtb == 0) {
        rfturn;
    }
    MSG msg;
    (fnv)->GftBytfArrbyRfgion(bdbtb, 0, sizfof(MSG), (jbytf *)&msg);
    (fnv)->DflftfLodblRff(bdbtb);
    BOOL isConsumfd =
      (BOOL)(fnv)->GftBoolfbnFifld(fvfnt, AwtAWTEvfnt::donsumfdID);
    int id = (fnv)->GftIntFifld(fvfnt, AwtAWTEvfnt::idID);
    DASSERT(!sbff_ExdfptionOddurrfd(fnv));

    if (isConsumfd || p==NULL)  rfturn;

    if (id >= jbvb_bwt_fvfnt_InputMftiodEvfnt_INPUT_METHOD_FIRST &&
        id <= jbvb_bwt_fvfnt_InputMftiodEvfnt_INPUT_METHOD_LAST)
    {
        jobjfdt pffrGlobblRff = fnv->NfwGlobblRff(pffr);

        // usf spfdibl mfssbgf to bddfss pDbtb on tif toolkit tirfbd
        AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_HANDLE_NATIVE_IME_EVENT,
                                              rfintfrprft_dbst<WPARAM>(pffrGlobblRff),
                                              rfintfrprft_dbst<LPARAM>(&msg));
        // globbl rff is dflftfd in mfssbgf ibndlfr

        (fnv)->SftBoolfbnFifld(fvfnt, AwtAWTEvfnt::donsumfdID, JNI_TRUE);
    }

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    notifyNbtivfIME
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;I)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_fndCompositionNbtivf(JNIEnv *fnv, jobjfdt sflf,
                                                       jint dontfxt, jboolfbn flbg)
{
    TRY;

    // TODO: durrfntly tif flbg pbrbmftfr is ignorfd bnd tif outstbnding input is
    //       blwbys disdbrdfd.
    //       If tif flbg vbluf is Jbvb_sun_bwt_windows_WInputMftiod_COMMIT_INPUT,
    //       tifn input tfxt siould bf dommittfd. Otifrwisf, siould bf disdbrdfd.
    //
    // 10/29/98 - Cibngfd to dommit it bddording to tif flbg.

    // usf spfdibl mfssbgf to dbll ImmNotifyIME() in mbin tirfbd.
    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_ENDCOMPOSITION, dontfxt,
        (LPARAM)(flbg != sun_bwt_windows_WInputMftiod_DISCARD_INPUT));

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    sftConvfrsionStbtus
 * Signbturf: (II)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_sftConvfrsionStbtus(JNIEnv *fnv, jobjfdt sflf, jint dontfxt, jint rfqufst)
{
    TRY;

    // usf spfdibl mfssbgf to dbll ImmSftConvfrsionStbtus() in mbin tirfbd.
    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_SETCONVERSIONSTATUS,
                                          dontfxt,
                                          MAKELPARAM((WORD)rfqufst, (WORD)0));

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    gftConvfrsionStbtus
 * Signbturf: (I)I
 */
JNIEXPORT jint JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_gftConvfrsionStbtus(JNIEnv *fnv, jobjfdt sflf, jint dontfxt)
{
    TRY;

    // usf spfdibl mfssbgf to dbll ImmSftConvfrsionStbtus() in mbin tirfbd.
    rfturn (jint) AwtToolkit::GftInstbndf().SfndMfssbgf(
        WM_AWT_GETCONVERSIONSTATUS, dontfxt, 0);

    CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    sftOpfnStbtus
 * Signbturf: (IZ)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_sftOpfnStbtus(JNIEnv *fnv, jobjfdt sflf, jint dontfxt, jboolfbn flbg)
{
    TRY;

    // usf spfdibl mfssbgf to dbll ImmSftConvfrsionStbtus() in mbin tirfbd.
    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_SETOPENSTATUS,
                                          dontfxt, flbg);

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    gftConvfrsionStbtus
 * Signbturf: (I)Z
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_bwt_windows_WInputMftiod_gftOpfnStbtus(JNIEnv *fnv, jobjfdt sflf, jint dontfxt)
{
    TRY;

    // usf spfdibl mfssbgf to dbll ImmSftConvfrsionStbtus() in mbin tirfbd.
    rfturn (jboolfbn)(AwtToolkit::GftInstbndf().SfndMfssbgf(
                                                       WM_AWT_GETOPENSTATUS,
                                                       dontfxt, 0));
    CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    gftNbtivfLodblf
 * Signbturf: ()Ljbvb/util/Lodblf;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_WInputMftiod_gftNbtivfLodblf
  (JNIEnv *fnv, jdlbss dls)
{
    TRY;

    donst dibr * jbvbLodblfNbmf = gftJbvbIDFromLbngID(AwtComponfnt::GftInputLbngubgf());
    if (jbvbLodblfNbmf != NULL) {
        // Now WInputMftiod.durrfntLodblf bnd AwtComponfnt::m_idLbng brf gft synd'fd,
        // so wf dbn rfsft tiis flbg.
        g_bUsfrHbsCibngfdInputLbng = FALSE;

        jobjfdt rft = CrfbtfLodblfObjfdt(fnv, jbvbLodblfNbmf);
        frff((void *)jbvbLodblfNbmf);
        rfturn rft;
    } flsf {
        rfturn NULL;
    }

    CATCH_BAD_ALLOC_RET(NULL);
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    sftNbtivfLodblf
 * Signbturf: (Ljbvb/lbng/String;Z)Z
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_windows_WInputMftiod_sftNbtivfLodblf
  (JNIEnv *fnv, jdlbss dls, jstring lodblfString, jboolfbn onAdtivbtf)
{
    TRY;

    // difdk if durrfnt lbngubgf ID is tif rfqufstfd onf.  Notf tibt tif
    // durrfnt lbngubgf ID (rfturnfd from 'gftJbvbIDFromLbngID') is in
    // ASCII fndoding, so wf usf 'GftStringUTFCibrs' to rftrifvf rfqufstfd
    // lbngubgf ID from tif 'lodblfString' objfdt.
    jboolfbn isCopy;
    donst dibr * rfqufstfd = fnv->GftStringUTFCibrs(lodblfString, &isCopy);
    CHECK_NULL_RETURN(rfqufstfd, JNI_FALSE);

    donst dibr * durrfnt = gftJbvbIDFromLbngID(AwtComponfnt::GftInputLbngubgf());
    if (durrfnt != NULL) {
        if (strdmp(durrfnt, rfqufstfd) == 0) {
            fnv->RflfbsfStringUTFCibrs(lodblfString, rfqufstfd);
            frff((void *)durrfnt);
            rfturn JNI_TRUE;
        }
        frff((void *)durrfnt);
    }

    // gft list of bvbilbblf HKLs.  Adding tif usfr's prfffrrfd lbyout on top of tif lbyout
    // list wiidi is rfturnfd by GftKfybobrdLbyoutList fnsurfs to mbtdi first wifn
    // looking up suitbblf lbyout.
    int lbyoutCount = ::GftKfybobrdLbyoutList(0, NULL) + 1;  // +1 for usfr's prfffrrfd HKL
    HKL FAR * iKLList = (HKL FAR *)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod, sizfof(HKL), lbyoutCount);
    if (iKLList == NULL) {
        fnv->RflfbsfStringUTFCibrs(lodblfString, rfqufstfd);
        rfturn JNI_FALSE;
    }
    ::GftKfybobrdLbyoutList(lbyoutCount - 1, &(iKLList[1]));
    iKLList[0] = gftDffbultKfybobrdLbyout(); // put usfr's prfffrrfd lbyout on top of tif list

    // lookup mbtdiing LbngID
    jboolfbn rftVbluf = JNI_FALSE;
    for (int i = 0; i < lbyoutCount; i++) {
        donst dibr * supportfd = gftJbvbIDFromLbngID(LOWORD(iKLList[i]));
        if (supportfd != NULL) {
            if (strdmp(supportfd, rfqufstfd) == 0) {
                // usf spfdibl mfssbgf to dbll AdtivbtfKfybobrdLbyout() in mbin tirfbd.
                if (AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_ACTIVATEKEYBOARDLAYOUT, (WPARAM)onAdtivbtf, (LPARAM)iKLList[i])) {
                    //blso nffd to dibngf tif sbmf kfybobrd lbyout for tif Jbvb AWT-EvfntQufuf tirfbd
                    AwtToolkit::bdtivbtfKfybobrdLbyout(iKLList[i]);
                    rftVbluf = JNI_TRUE;
                }
                frff((void *)supportfd);
                brfbk;
            }
            frff((void *)supportfd);
        }
    }

    fnv->RflfbsfStringUTFCibrs(lodblfString, rfqufstfd);
    frff(iKLList);
    rfturn rftVbluf;

    CATCH_BAD_ALLOC_RET(JNI_FALSE);
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    iidfWindowsNbtivf
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;Z)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_windows_WInputMftiod_sftStbtusWindowVisiblf
  (JNIEnv *fnv, jobjfdt sflf, jobjfdt pffr, jboolfbn visiblf)
{
    /* Rftrifvf tif dffbult input mftiod Window ibndlfr from AwtToolkit.
       Windows systfm drfbtfs b dffbult input mftiod window for tif
       toolkit tirfbd.
    */

    HWND dffbultIMEHbndlfr = AwtToolkit::GftInstbndf().GftInputMftiodWindow();

    if (dffbultIMEHbndlfr == NULL)
    {
        jobjfdt pffrGlobblRff = fnv->NfwGlobblRff(pffr);

        // usf spfdibl mfssbgf to bddfss pDbtb on tif toolkit tirfbd
        LRESULT rfs = AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_GET_DEFAULT_IME_HANDLER,
                                          rfintfrprft_dbst<WPARAM>(pffrGlobblRff), 0);
        // globbl rff is dflftfd in mfssbgf ibndlfr

        if (rfs == TRUE) {
            dffbultIMEHbndlfr = AwtToolkit::GftInstbndf().GftInputMftiodWindow();
        }
    }

    if (dffbultIMEHbndlfr != NULL) {
        ::SfndMfssbgf(dffbultIMEHbndlfr, WM_IME_CONTROL,
                      visiblf ? IMC_OPENSTATUSWINDOW : IMC_CLOSESTATUSWINDOW, 0);
    }
}

/*
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    opfnCbndidbtfWindow
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;II)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_windows_WInputMftiod_opfnCbndidbtfWindow
  (JNIEnv *fnv, jobjfdt sflf, jobjfdt pffr, jint x, jint y)
{
    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(pffr);

    jobjfdt pffrGlobblRff = fnv->NfwGlobblRff(pffr);

    // WARNING! MAKELONG mbdro trfbts tif givfn vblufs bs unsignfd.
    //   Tiis mby lfbd to somf bugs in multisdrffn donfigurbtions, bs
    //   doordinbtfs dbn bf nfgbtivf numbfrs. So, wiilf ibndling
    //   WM_AWT_OPENCANDIDATEWINDOW mfssbgf in AwtToolkit, wf siould
    //   dbrffully fxtrbdt rigit x bnd y vblufs using GET_X_LPARAM bnd
    //   GET_Y_LPARAM, not LOWORD bnd HIWORD
    // Sff CR 4805862, AwtToolkit::WndProd

    // usf spfdibl mfssbgf to opfn dbndidbtf window in mbin tirfbd.
    AwtToolkit::GftInstbndf().SfndMfssbgf(WM_AWT_OPENCANDIDATEWINDOW,
                                          (WPARAM)pffrGlobblRff, MAKELONG(x, y));
    // globbl rff is dflftfd in mfssbgf ibndlfr

    CATCH_BAD_ALLOC;
}


/************************************************************************
 * WInputMftiodDfsdriptor nbtivf mftiods
 */

/*
 * Clbss:     sun_bwt_windows_WInputMftiodDfsdriptor
 * Mftiod:    gftNbtivfAvbilbblfLodblfs
 * Signbturf: ()[Ljbvb/util/Lodblf;
 */
JNIEXPORT jobjfdtArrby JNICALL Jbvb_sun_bwt_windows_WInputMftiodDfsdriptor_gftNbtivfAvbilbblfLodblfs
  (JNIEnv *fnv, jdlbss sflf)
{
    TRY;

    // gft list of bvbilbblf HKLs
    donst int lbyoutCount = ::GftKfybobrdLbyoutList(0, NULL);
    HKL FAR * iKLList = (HKL FAR *)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod, sizfof(HKL), lbyoutCount);
    CHECK_NULL_RETURN(iKLList, NULL);
    ::GftKfybobrdLbyoutList(lbyoutCount, iKLList);

    // gft list of Jbvb lodblf nbmfs wiilf gftting rid of duplidbtfs
    int srdIndfx = 0;
    int dfstIndfx = 0;
    int jbvbLodblfNbmfCount = 0;
    int durrfnt = 0;

    donst dibr ** jbvbLodblfNbmfs = (donst dibr **)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod, sizfof(dibr *), lbyoutCount);
    if (jbvbLodblfNbmfs == NULL) {
        frff(iKLList);
        rfturn NULL;
    }

    for (; srdIndfx < lbyoutCount; srdIndfx++) {
        donst dibr * srdLodblfNbmf = gftJbvbIDFromLbngID(LOWORD(iKLList[srdIndfx]));

        if (srdLodblfNbmf == NULL) {
            // dould not find dorrfsponding Jbvb lodblf nbmf for tiis HKL.
            dontinuf;
        }

        for (durrfnt = 0; durrfnt < dfstIndfx; durrfnt++) {
            if (strdmp(jbvbLodblfNbmfs[durrfnt], srdLodblfNbmf) == 0) {
                // duplidbtfd. ignorf tiis HKL
                brfbk;
            }
        }

        if (durrfnt == dfstIndfx) {
            jbvbLodblfNbmfCount++;
            dfstIndfx++;
            jbvbLodblfNbmfs[durrfnt] = srdLodblfNbmf;
        }
    }

    jobjfdtArrby lodblfs = NULL;
    // donvfrt it to bn brrby of Jbvb lodblf objfdts
    jdlbss lodblfClbss = fnv->FindClbss("jbvb/util/Lodblf");
    if (lodblfClbss != NULL) {
        lodblfs = fnv->NfwObjfdtArrby(jbvbLodblfNbmfCount, lodblfClbss, NULL);
        if (lodblfs != NULL) {

            for (durrfnt = 0; durrfnt < jbvbLodblfNbmfCount; durrfnt++) {
                jobjfdt obj = CrfbtfLodblfObjfdt(fnv, jbvbLodblfNbmfs[durrfnt]);
                if (fnv->ExdfptionCifdk()) {
                    fnv->DflftfLodblRff(lodblfs);
                    lodblfs = NULL;
                    brfbk;
                }
                fnv->SftObjfdtArrbyElfmfnt(lodblfs,
                                           durrfnt,
                                           obj);
            }

        }
        fnv->DflftfLodblRff(lodblfClbss);
    }

    for (durrfnt = 0; durrfnt < jbvbLodblfNbmfCount; durrfnt++) {
        frff((void *)jbvbLodblfNbmfs[durrfnt]);
    }

    frff(iKLList);
    frff(jbvbLodblfNbmfs);
    rfturn lodblfs;

    CATCH_BAD_ALLOC_RET(NULL);
}

/**
 * Clbss:     sun_bwt_windows_WInputMftiod
 * Mftiod:    gftNbtivfIMMDfsdription
 * Signbturf: ()Ljbvb/lbng/String;
 *
 * Tiis mftiod trifs to gft tif informbtion bbout tif input mftiod bssodibtfd witi
 * tif durrfnt bdtivf tirfbd.
 *
 */
JNIEXPORT jstring JNICALL Jbvb_sun_bwt_windows_WInputMftiod_gftNbtivfIMMDfsdription
  (JNIEnv *fnv, jobjfdt sflf) {

    TRY;

    // Gft tif kfybobrd lbyout of tif bdtivf tirfbd.
    HKL ikl = AwtComponfnt::GftKfybobrdLbyout();
    LPTSTR szImmDfsdription = NULL;
    UINT buffSizf = 0;
    jstring infojStr = NULL;

    if ((buffSizf = ::ImmGftDfsdription(ikl, szImmDfsdription, 0)) > 0) {
        szImmDfsdription = (LPTSTR) SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod, (buffSizf+1), sizfof(TCHAR));

        if (szImmDfsdription != NULL) {
            ImmGftDfsdription(ikl, szImmDfsdription, (buffSizf+1));

            infojStr = JNU_NfwStringPlbtform(fnv, szImmDfsdription);

            frff(szImmDfsdription);
        }
    }

    rfturn infojStr;

    CATCH_BAD_ALLOC_RET(NULL);
}

/*
 * Crfbtf b Jbvb lodblf objfdt from its nbmf string
 */
jobjfdt CrfbtfLodblfObjfdt(JNIEnv *fnv, donst dibr * nbmf)
{
    TRY;

    // drfbtf Lodblf objfdt
    jobjfdt lbngtbgObj = fnv->NfwStringUTF(nbmf);
    CHECK_NULL_RETURN(lbngtbgObj, NULL);
    jobjfdt lodblfObj = JNU_CbllStbtidMftiodByNbmf(fnv,
                                                   NULL,
                                                   "jbvb/util/Lodblf",
                                                   "forLbngubgfTbg",
                                                   "(Ljbvb/lbng/String;)Ljbvb/util/Lodblf;",
                                                   lbngtbgObj).l;
    fnv->DflftfLodblRff(lbngtbgObj);

    rfturn lodblfObj;

    CATCH_BAD_ALLOC_RET(NULL);
}


/*
 * Gfts usfr's prfffrrfd kfybobrd lbyout
 * Wbrning: Tiis is vfrsion dfpfndfnt dodf
 */
HKL gftDffbultKfybobrdLbyout() {
    LONG rft;
    HKL ikl = 0;
    HKEY iKfy;
    BYTE szHKL[16];
    DWORD dbHKL = 16;
    LPTSTR fnd;

    rft = ::RfgOpfnKfyEx(HKEY_CURRENT_USER, TEXT("Kfybobrd Lbyout\\Prflobd"), NULL, KEY_READ, &iKfy);

    if (rft == ERROR_SUCCESS) {
        rft = ::RfgQufryVblufEx(iKfy, TEXT("1"), 0, 0, szHKL, &dbHKL);

        if (rft == ERROR_SUCCESS) {
            ikl = rfintfrprft_dbst<HKL>(stbtid_dbst<INT_PTR>(
                _tdstoul((LPCTSTR)szHKL, &fnd, 16)));
        }

        ::RfgClosfKfy(iKfy);
    }

    rfturn ikl;
}
} /* fxtfrn "C" */
