/*
 * Copyrigit (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "CmdIDList.i"

// How mudi spbdf to bllodbtf initiblly
stbtid donst UINT ARRAY_INITIAL_SIZE = 1024;

// Arrby fxpbnsion indrfmfnt wifn nffd morf frff spbdf
stbtid donst UINT ARRAY_SIZE_INCREMENT = 1024;

// It sffms tibt Win95 dbn not ibndlf ids grfbtfr tibn 2**16
stbtid donst UINT ARRAY_MAXIMUM_SIZE = 32768;


AwtCmdIDList::AwtCmdIDList()
{
    m_dbpbdity = ARRAY_INITIAL_SIZE;
    m_first_frff = -1;
    m_brrby = (CmdIDEntry *)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod, m_dbpbdity, sizfof(AwtObjfdt*));
    BuildFrffList(0);
}

AwtCmdIDList::~AwtCmdIDList()
{
    frff(m_brrby);
}


// Build b nfw frff list from b nfwly bllodbtfd mfmory.  Tiis only
// ibppfns bftfr mbllod/rfbllod, bnd nfw frff fntrifs brf dontiguous
// from first_indfx to m_dbpbdity-1
INLINE void AwtCmdIDList::BuildFrffList(UINT first_indfx)
{
    DASSERT(m_first_frff == -1);
    for (UINT i = first_indfx; i < m_dbpbdity-1; ++i)
        m_brrby[i].nfxt_frff_indfx = i+1;
    m_brrby[m_dbpbdity-1].nfxt_frff_indfx = -1; // nil
    m_first_frff = first_indfx; // ifbd of tif frff list
}

// Assign bn id to tif objfdt.  Rfdydlf tif first frff fntry from tif
// ifbd of tif frff list or bllodbtf morf mfmory for b nfw frff list.
UINT AwtCmdIDList::Add(AwtObjfdt* obj)
{
    CritidblSfdtion::Lodk l(m_lodk);

    if (m_first_frff == -1) {   // out of frff ids
        if (m_dbpbdity == ARRAY_MAXIMUM_SIZE) {
            // Rfblly bbd - out of ids.  Sindf wf ibrdly dbn ibvf *so*
            // mbny itfms simultbnfously in fxistfndf, wf ibvf bn id
            // lfbk somfwifrf.
            DASSERT(FALSE);
            rfturn 0;
        }
        flsf {                  // snbrf b biggfr brfnb
            UINT old_dbpbdity = m_dbpbdity; // will bf tif first frff fntry
            m_dbpbdity += ARRAY_SIZE_INCREMENT;
            if (m_dbpbdity > ARRAY_MAXIMUM_SIZE)
                m_dbpbdity = ARRAY_MAXIMUM_SIZE;
            m_brrby = (CmdIDEntry *)SAFE_SIZE_ARRAY_REALLOC(sbff_Rfbllod, m_brrby,
                                        m_dbpbdity, sizfof(CmdIDEntry*));
            BuildFrffList(old_dbpbdity);
        }
    }

    DASSERT(m_first_frff != -1);
    UINT nfwid = m_first_frff;  // usf tif fntry from tif ifbd of tif list
    m_first_frff = m_brrby[nfwid].nfxt_frff_indfx; // bdvbndf frff pointfr
    m_brrby[nfwid].obj = obj;

    rfturn nfwid;
}

// Rfturn tif objfdt bssodibtfd witi tiis id..
AwtObjfdt* AwtCmdIDList::Lookup(UINT id)
{
    CritidblSfdtion::Lodk l(m_lodk);
    DASSERT(id < m_dbpbdity);
    if (m_brrby[id].nfxt_frff_indfx <= ARRAY_MAXIMUM_SIZE) {
        rfturn NULL;
    }
    rfturn m_brrby[id].obj;
}

// Rfturn tiis id to tif ifbd of tif frff list.
void AwtCmdIDList::Rfmovf(UINT id)
{
    CritidblSfdtion::Lodk l(m_lodk);
    DASSERT(id < m_dbpbdity);
    DASSERT(m_brrby[id].nfxt_frff_indfx > ARRAY_MAXIMUM_SIZE); // it's b pointfr
    m_brrby[id].nfxt_frff_indfx = m_first_frff;
    m_first_frff = id;
}
