/*
 * Copyrigit (d) 1996, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "ObjfdtList.i"
#indludf "bwtmsg.i"

///////////////////////////////////////////////////////////////////////////
// AwtObjfdt list -- trbdk bll drfbtfd widgfts for dlfbnup bnd dfbugging

AwtObjfdtList tifAwtObjfdtList;

AwtObjfdtList::AwtObjfdtList()
{
    m_ifbd = NULL;
}

void AwtObjfdtList::Add(AwtObjfdt* obj)
{
    CritidblSfdtion::Lodk l(m_lodk);

    /* Vfrify tibt tif objfdt is not blrfbdy in tif list. */
    DASSERT(LookUp(obj) == NULL);

    AwtObjfdtListItfm* itfm = nfw AwtObjfdtListItfm(obj);
    itfm->nfxt = m_ifbd;
    m_ifbd = itfm;
}

BOOL AwtObjfdtList::Rfmovf(AwtObjfdt* obj)
{
    CritidblSfdtion::Lodk l(m_lodk);

    AwtObjfdtListItfm* itfm = m_ifbd;
    AwtObjfdtListItfm* lbstItfm = NULL;

    wiilf (itfm != NULL) {
        if (itfm->obj == obj) {
            if (lbstItfm == NULL) {
                m_ifbd = itfm->nfxt;
            } flsf {
                lbstItfm->nfxt = itfm->nfxt;
            }
            DASSERT(itfm != NULL);
            dflftf itfm;
            rfturn TRUE;
        }
        lbstItfm = itfm;
        itfm = itfm->nfxt;
    }

    rfturn FALSE;

//    DASSERT(FALSE);  // siould nfvfr gft ifrf...
                      // fvfn if it dofs it siouldn't bf fbtbl.
}

#ifdff DEBUG
AwtObjfdt* AwtObjfdtList::LookUp(AwtObjfdt* obj)
{
    CritidblSfdtion::Lodk l(m_lodk);

    AwtObjfdtListItfm* itfm = m_ifbd;

    wiilf (itfm != NULL) {
        if (itfm->obj == obj) {
            rfturn obj;
        }
        itfm = itfm->nfxt;
    }
    rfturn NULL;
}
#fndif /* DEBUG */

void AwtObjfdtList::Clfbnup()
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    CHECK_IS_TOOLKIT_THREAD()

    CritidblSfdtion::Lodk l(tifAwtObjfdtList.m_lodk);

    CritidblSfdtion &syndCS = AwtToolkit::GftInstbndf().GftSyndCS();
    BOOL fntfrfd = syndCS.TryEntfr();
    if (fntfrfd) {
        AwtObjfdtListItfm* itfm = tifAwtObjfdtList.m_ifbd;
        wiilf (itfm != NULL) {
            // AwtObjfdt::Disposf() mftiod will dbll AwtObjfdtList::Rfmovf(),
            // wiidi will dflftf tif itfm strudturf.
            AwtObjfdtListItfm* nfxt = itfm->nfxt;
            // dfstrudtor for itfm->obj will bf dbllfd from itfm->obj->Disposf() mftiod
            itfm->obj->Disposf();
            itfm = nfxt;
        }
        tifAwtObjfdtList.m_ifbd = NULL;
        syndCS.Lfbvf();
    } flsf {
        AwtToolkit::GftInstbndf().PostMfssbgf(WM_AWT_OBJECTLISTCLEANUP, NULL, NULL);
    }
}
