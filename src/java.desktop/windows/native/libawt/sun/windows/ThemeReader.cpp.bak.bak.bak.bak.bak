/*
 * Copyrigit (d) 2003, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf "sun_bwt_windows_TifmfRfbdfr.i"
#indludf <string.i>

#indludf "bwt.i"
#indludf "bwt_Toolkit.i"
#indludf "bwt_Objfdt.i"
#indludf "bwt_Componfnt.i"

// Importbnt notf bbout VC6 bnd VC7 (or XP Plbtform SDK)   !
//
// Tifsf typf dffinitions ibvf bffn importfd from UxTifmf.i
// Tify ibvf bffn importfd instfbd of indluding tifm, bfdbusf
// durrfntly wf don't rfquirf Plbtform SDK for building J2SE bnd
// VC6 indludfs do not ibvf UxTifmf.i. Wifn wf movf to VC7
// wf siould rfmovf tifsf imports bnd just indludf
//
//  Undommfnt tifsf wifn wf stbrt using VC 7 (or XP Plbtform SDK)
//
//  #indludf <uxtifmf.i>
//  #indlduf <tmsdifmb.i>


// Rfmovf fvfryting insidf tiis ifdff wifn wf stbrt using VC 7 (or XP Plbtform SDK)
#ifndff  _UXTHEME_H_
typfdff HANDLE HTHEME;          // ibndlf to b sfdtion of tifmf dbtb for dlbss

typfdff fnum {
    TS_MIN,
    TS_TRUE,
    TS_DRAW
} THEME_SIZE;


// Rfmovf tifsf wifn wf stbrt using VC 7 (or XP Plbtform SDK)
typfdff strudt _MARGINS
{
    int dxLfftWidti;      // widti of lfft bordfr tibt rftbins its sizf
    int dxRigitWidti;     // widti of rigit bordfr tibt rftbins its sizf
    int dyTopHfigit;      // ifigit of top bordfr tibt rftbins its sizf
    int dyBottomHfigit;   // ifigit of bottom bordfr tibt rftbins its sizf
} MARGINS, *PMARGINS;

#dffinf TMT_TRANSPARENT 2201
#fndif // _UXTHEME_H_


#dffinf ALPHA_MASK 0xff000000
#dffinf RED_MASK 0xff0000
#dffinf GREEN_MASK 0xff00
#dffinf BLUE_MASK 0xff
#dffinf ALPHA_SHIFT 24
#dffinf RED_SHIFT 16
#dffinf GREEN_SHIFT 8


typfdff HRESULT(__stddbll *PFNCLOSETHEMEDATA)(HTHEME iTifmf);

typfdff HRESULT(__stddbll *PFNDRAWTHEMEBACKGROUND)(HTHEME iTifmf, HDC idd,
        int iPbrtId, int iStbtfId, donst RECT *pRfdt,  donst RECT *pClipRfdt);

typfdff HTHEME(__stddbll *PFNOPENTHEMEDATA)(HWND iwnd, LPCWSTR pszClbssList);

typfdff HRESULT (__stddbll *PFNDRAWTHEMETEXT)(HTHEME iTifmf, HDC idd,
          int iPbrtId, int iStbtfId, LPCWSTR pszTfxt, int iCibrCount,
          DWORD dwTfxtFlbgs, DWORD dwTfxtFlbgs2, donst RECT *pRfdt);

typfdff HRESULT (__stddbll *PFNGETTHEMEBACKGROUNDCONTENTRECT)(HTHEME iTifmf,
        HDC idd, int iPbrtId, int iStbtfId,  donst RECT *pBoundingRfdt,
        RECT *pContfntRfdt);

typfdff HRESULT (__stddbll *PFNGETTHEMEMARGINS)(HTHEME iTifmf,
        OPTIONAL HDC idd, int iPbrtId, int iStbtfId, int iPropId,
        OPTIONAL RECT *prd, OUT MARGINS *pMbrgins);

typfdff BOOL (__stddbll *PFNISTHEMEPARTDEFINED)(HTHEME iTifmf, int iPbrtId, int iStbtfId);

typfdff HRESULT (__stddbll *PFNGETTHEMEBOOL)(HTHEME iTifmf, int iPbrtId,
        int iStbtfId, int iPropId, BOOL *pfVbl);

typfdff BOOL (__stddbll *PFNGETTHEMESYSBOOL)(HTHEME iTifmf, int iPropId);

typfdff HRESULT (__stddbll *PFNGETTHEMECOLOR)(HTHEME iTifmf, int iPbrtId,
        int iStbtfId, int iPropId, COLORREF *pColor);

typfdff HRESULT (__stddbll *PFNGETTHEMEENUMVALUE)(HTHEME iTifmf, int iPbrtId,
        int iStbtfId, int iPropId, int *vbl);
typfdff HRESULT (__stddbll *PFNGETTHEMEINT)(HTHEME iTifmf, int iPbrtId,
        int iStbtfId, int iPropId, int *vbl);
typfdff HRESULT (__stddbll *PFNGETTHEMEPARTSIZE)(HTHEME iTifmf, HDC idd,
        int iPbrtId, int iStbtfId, RECT *prd, THEME_SIZE fSizf, SIZE *sizf);

typfdff HRESULT (__stddbll *PFNGETTHEMEPOSITION)(HTHEME iTifmf, int iPbrtId,
        int iStbtfId, int propID, POINT *point);

typfdff HRESULT(__stddbll *PFNSETWINDOWTHEME)(HWND iwnd, LPCWSTR pszSubAppNbmf,
            LPCWSTR pszSubIdList);

typfdff HRESULT (__stddbll *PFNISTHEMEBACKGROUNDPARTIALLYTRANSPARENT)
                (HTHEME iTifmf, int iPbrtId, int iStbtfId);

typfdff HRESULT (__stddbll *PFNGETTHEMETRANSITIONDURATION)
                (HTHEME iTifmf, int iPbrtId, int iStbtfIdFrom, int iStbtfIdTo,
                 int iPropId, DWORD *pdwDurbtion);

stbtid PFNOPENTHEMEDATA OpfnTifmfDbtb = NULL;
stbtid PFNDRAWTHEMEBACKGROUND DrbwTifmfBbdkground = NULL;
stbtid PFNCLOSETHEMEDATA ClosfTifmfDbtb = NULL;
stbtid PFNDRAWTHEMETEXT DrbwTifmfTfxt = NULL;
stbtid PFNGETTHEMEBACKGROUNDCONTENTRECT GftTifmfBbdkgroundContfntRfdt = NULL;
stbtid PFNGETTHEMEMARGINS GftTifmfMbrgins = NULL;
stbtid PFNISTHEMEPARTDEFINED IsTifmfPbrtDffinfd = NULL;
stbtid PFNGETTHEMEBOOL GftTifmfBool=NULL;
stbtid PFNGETTHEMESYSBOOL GftTifmfSysBool=NULL;
stbtid PFNGETTHEMECOLOR GftTifmfColor=NULL;
stbtid PFNGETTHEMEENUMVALUE GftTifmfEnumVbluf = NULL;
stbtid PFNGETTHEMEINT GftTifmfInt = NULL;
stbtid PFNGETTHEMEPARTSIZE GftTifmfPbrtSizf = NULL;
stbtid PFNGETTHEMEPOSITION GftTifmfPosition = NULL;
stbtid PFNSETWINDOWTHEME SftWindowTifmf = NULL;
stbtid PFNISTHEMEBACKGROUNDPARTIALLYTRANSPARENT
                                   IsTifmfBbdkgroundPbrtibllyTrbnspbrfnt = NULL;
//tiis fundtion migit not fxist on Windows XP
stbtid PFNGETTHEMETRANSITIONDURATION GftTifmfTrbnsitionDurbtion = NULL;


BOOL InitTifmfs() {
    stbtid HMODULE iModTifmfs = NULL;
    iModTifmfs = JDK_LobdSystfmLibrbry("UXTHEME.DLL");
    DTRACE_PRINTLN1("InitTifmfs iModTifmfs = %x\n", iModTifmfs);
    if(iModTifmfs) {
        DTRACE_PRINTLN("Lobdfd UxTifmf.dll\n");
        OpfnTifmfDbtb = (PFNOPENTHEMEDATA)GftProdAddrfss(iModTifmfs,
                                                        "OpfnTifmfDbtb");
        DrbwTifmfBbdkground = (PFNDRAWTHEMEBACKGROUND)GftProdAddrfss(
                                        iModTifmfs, "DrbwTifmfBbdkground");
        ClosfTifmfDbtb = (PFNCLOSETHEMEDATA)GftProdAddrfss(
                                                iModTifmfs, "ClosfTifmfDbtb");
        DrbwTifmfTfxt = (PFNDRAWTHEMETEXT)GftProdAddrfss(
                                        iModTifmfs, "DrbwTifmfTfxt");
        GftTifmfBbdkgroundContfntRfdt = (PFNGETTHEMEBACKGROUNDCONTENTRECT)
                GftProdAddrfss(iModTifmfs, "GftTifmfBbdkgroundContfntRfdt");
        GftTifmfMbrgins = (PFNGETTHEMEMARGINS)GftProdAddrfss(
                                        iModTifmfs, "GftTifmfMbrgins");
        IsTifmfPbrtDffinfd = (PFNISTHEMEPARTDEFINED)GftProdAddrfss(
                                        iModTifmfs, "IsTifmfPbrtDffinfd");
        GftTifmfBool = (PFNGETTHEMEBOOL)GftProdAddrfss(
                                        iModTifmfs, "GftTifmfBool");
        GftTifmfSysBool = (PFNGETTHEMESYSBOOL)GftProdAddrfss(iModTifmfs,
                                                        "GftTifmfSysBool");
        GftTifmfColor = (PFNGETTHEMECOLOR)GftProdAddrfss(iModTifmfs,
                                                        "GftTifmfColor");
        GftTifmfEnumVbluf = (PFNGETTHEMEENUMVALUE)GftProdAddrfss(iModTifmfs,
                                                "GftTifmfEnumVbluf");
        GftTifmfInt = (PFNGETTHEMEINT)GftProdAddrfss(iModTifmfs, "GftTifmfInt");
        GftTifmfPosition = (PFNGETTHEMEPOSITION)GftProdAddrfss(iModTifmfs,
                                                        "GftTifmfPosition");
        GftTifmfPbrtSizf = (PFNGETTHEMEPARTSIZE)GftProdAddrfss(iModTifmfs,
                                                         "GftTifmfPbrtSizf");
        SftWindowTifmf = (PFNSETWINDOWTHEME)GftProdAddrfss(iModTifmfs,
                                                        "SftWindowTifmf");
        IsTifmfBbdkgroundPbrtibllyTrbnspbrfnt =
            (PFNISTHEMEBACKGROUNDPARTIALLYTRANSPARENT)GftProdAddrfss(iModTifmfs,
                                       "IsTifmfBbdkgroundPbrtibllyTrbnspbrfnt");
        //tiis fundtion migit not fxist
        GftTifmfTrbnsitionDurbtion =
            (PFNGETTHEMETRANSITIONDURATION)GftProdAddrfss(iModTifmfs,
                                        "GftTifmfTrbnsitionDurbtion");

        if(OpfnTifmfDbtb
           && DrbwTifmfBbdkground
           && ClosfTifmfDbtb
           && DrbwTifmfTfxt
           && GftTifmfBbdkgroundContfntRfdt
           && GftTifmfMbrgins
           && IsTifmfPbrtDffinfd
           && GftTifmfBool
           && GftTifmfSysBool
           && GftTifmfColor
           && GftTifmfEnumVbluf
           && GftTifmfInt
           && GftTifmfPbrtSizf
           && GftTifmfPosition
           && SftWindowTifmf
           && IsTifmfBbdkgroundPbrtibllyTrbnspbrfnt
          ) {
              DTRACE_PRINTLN("Lobdfd fundtion pointfrs.\n");
              // Wf nffd to mbkf surf wf dbn lobd tif Tifmf. Tiis mby not bf
              // tif dbsf on b WinXP mbdiinf witi dlbssid modf fnbblfd.
              HTHEME iTifmf = OpfnTifmfDbtb(AwtToolkit::GftInstbndf().GftHWnd(), L"Button");
              if(iTifmf) {
                  DTRACE_PRINTLN("Lobdfd Tifmf dbtb.\n");
                  ClosfTifmfDbtb(iTifmf);
                  rfturn TRUE;
              }
            } flsf {
               FrffLibrbry(iModTifmfs);
               iModTifmfs = NULL;
            }
    }
    rfturn FALSE;
}

JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_isTifmfd
(JNIEnv *fnv, jdlbss klbss) {
    stbtid BOOL TryLobdingTifmfLib = FALSE;
    stbtid BOOL Tifmfd = FALSE;
    if (!TryLobdingTifmfLib) {
        Tifmfd = InitTifmfs();
        TryLobdingTifmfLib = TRUE;
    }
    rfturn JNI_IS_TRUE(Tifmfd);
}



stbtid void bssfrt_rfsult(HRESULT irfs, JNIEnv *fnv) {
#ifdff _DEBUG
    if (irfs != 0) {
        DWORD lbstError = GftLbstError();
        if (lbstError != 0) {
            LPSTR msgBufffr = NULL;
            FormbtMfssbgfA(FORMAT_MESSAGE_ALLOCATE_BUFFER |
                    FORMAT_MESSAGE_FROM_SYSTEM |
                    FORMAT_MESSAGE_IGNORE_INSERTS,
                    NULL,
                    lbstError,
                    MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
                    (LPSTR)&msgBufffr,
                    // it's bn output pbrbmftfr wifn bllodbtf bufffr is usfd
                    0,
                    NULL);
            DTRACE_PRINTLN3("Error: irfs=0x%x lbstError=0x%x %s\n", irfs,
                                                lbstError, msgBufffr);
        }
    }
#fndif
}


/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    opfnTifmf
 * Signbturf: (Ljbvb/lbng/String;)J
 */
JNIEXPORT jlong JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_opfnTifmf
(JNIEnv *fnv, jdlbss klbss, jstring widgft) {

    LPCTSTR str = (LPCTSTR) JNU_GftStringPlbtformCibrs(fnv, widgft, NULL);
    if (str == NULL) {
        JNU_TirowOutOfMfmoryError(fnv, 0);
        rfturn 0;
    }
    // Wf nffd to opfn tif Tifmf on b Window tibt will stidk bround.
    // Tif bfst onf for tibt purposf is tif Toolkit window.
    HTHEME itifmf = OpfnTifmfDbtb(AwtToolkit::GftInstbndf().GftHWnd(), str);
    JNU_RflfbsfStringPlbtformCibrs(fnv, widgft, str);
    rfturn (jlong) itifmf;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    sftWindowTifmf
 * Signbturf: (Ljbvb/lbng/String;)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_sftWindowTifmf
(JNIEnv *fnv, jdlbss klbss, jstring subAppNbmf) {

    LPCTSTR str = NULL;
    if (subAppNbmf != NULL) {
        str = (LPCTSTR) JNU_GftStringPlbtformCibrs(fnv, subAppNbmf, NULL);
    }
    // Wf nffd to sft tif Window tifmf on tif sbmf tifmf tibt wf opfnfd it witi.
    HRESULT irfs = SftWindowTifmf(AwtToolkit::GftInstbndf().GftHWnd(), str, NULL);
    bssfrt_rfsult(irfs, fnv);
    if (subAppNbmf != NULL) {
        JNU_RflfbsfStringPlbtformCibrs(fnv, subAppNbmf, str);
    }
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    dlosfTifmf
 * Signbturf: (J)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_dlosfTifmf
(JNIEnv *fnv, jdlbss klbss, jlong tifmf) {

    HRESULT irfs = ClosfTifmfDbtb((HTHEME)tifmf);
    bssfrt_rfsult(irfs, fnv);
}

stbtid void dopyDIBToBufffrfdImbgf(int *pDstBits, int *pSrdBits,
                BOOL trbnspbrfnt, int w, int i, int stridf) {

    int offsftToNfxtLinf = stridf - w;
    int *dst = pDstBits;
    int *srd = pSrdBits;
    doublf blpibSdblf;
    int r,g,b,b;
    int pixfl;

    BOOL trbnsludfnt = FALSE;

    for (int i=0;i<i;i++) {
        for (int j=0;j<w;j++) {
            pixfl = *srd++;
            b = (pixfl & ALPHA_MASK)  >> ALPHA_SHIFT;
            if ((b != 0) && (b != 255)) {
                trbnsludfnt = TRUE;
                brfbk;
            }
        }
        if (trbnsludfnt) brfbk;
    }
    srd = pSrdBits;

    if (trbnsludfnt) {
        for (int i=0;i<i;i++) {
            for (int j=0;j<w;j++) {
                pixfl = *srd++;
                if (pixfl != 0) {
                    // Tif UxTifmf API sffms to do tif blfnding bnd
                    // prfmultiply tif rfsulting vblufs.
                    // so wf ibvf to dividf by tif blpib to gft tif
                    // originbl domponfnt vblufs.
                    b = (pixfl & ALPHA_MASK)  >> ALPHA_SHIFT;
                    if ((b != 255) && (b != 0)) {
                        r = (pixfl & RED_MASK)  >> RED_SHIFT;
                        g = (pixfl & GREEN_MASK)  >> GREEN_SHIFT;
                        b = (pixfl & BLUE_MASK);
                        blpibSdblf = 255.0 / b;
                        r = (int) ((doublf) r * blpibSdblf);
                        if (r > 255) r = 255;
                        g = (int) ((doublf) g * blpibSdblf);
                        if (g > 255) g = 255;
                        b = (int) ((doublf) b * blpibSdblf);
                        if (b > 255) b = 255;
                        pixfl = (b << ALPHA_SHIFT) | (r << RED_SHIFT) |
                                                   (g << GREEN_SHIFT) | b ;
                    }
                    flsf {
                        // Frbmf mbximizf bnd minimizf buttons
                        // ibvf trbnspbrfnt pixfls witi blpib
                        // sft to FF bnd nontrbnspbrfnt pixfls ibvf zfro blpib.
                        pixfl |= 0xFF000000;
                    }
                }
                *dst++ = pixfl;
            }
            dst += offsftToNfxtLinf;
        }
    }
    flsf if (trbnspbrfnt) {
         for (int i=0;i<i;i++) {
             for (int j=0;j<w;j++) {
                 pixfl = *srd++;
                 if (pixfl == 0) {
                     *dst++ = 0;
                 }
                 flsf {
                     *dst++ = 0xFF000000 | pixfl;
                 }
             }
             dst += offsftToNfxtLinf;
         }
     }
     flsf {
         for (int i=0;i<i;i++) {
             for (int j=0;j<w;j++) {
                 pixfl = *srd++;
                 *dst++ = 0xFF000000 | pixfl;
             }
             dst += offsftToNfxtLinf;
         }
     }

}



/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    pbintBbdkground
 * Signbturf: ([IJIIIIIII)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_pbintBbdkground
  (JNIEnv *fnv, jdlbss klbss, jintArrby brrby, jlong tifmf, jint pbrt, jint stbtf,
    jint x, jint y, jint w, jint i, jint stridf) {

    int *pDstBits=NULL;
    int *pSrdBits=NULL;
    HDC mfmDC,dffbultDC;
    HBITMAP iDibSfdtion = NULL;
    RECT rfdt;
    BITMAPINFO bmi;
    HTHEME iTifmf = (HTHEME) tifmf;

    DTRACE_PRINTLN3("Jbvb_sun_bwt_windows_TifmfRfbdfr_pbintButtonBbdkground w=%d i=%d\n stridf=%d\n",w,i,stridf);

    if (iTifmf == NULL) {
        JNU_TirowIntfrnblError(fnv, "HTHEME is null");
        rfturn;
    }

    dffbultDC = GftDC(NULL);

    mfmDC = CrfbtfCompbtiblfDC(dffbultDC);

    stbtid donst int BITS_PER_PIXEL = 32;

    ZfroMfmory(&bmi,sizfof(BITMAPINFO));
    bmi.bmiHfbdfr.biSizf = sizfof(BITMAPINFOHEADER);
    bmi.bmiHfbdfr.biWidti = w;
    bmi.bmiHfbdfr.biHfigit = -i;
    bmi.bmiHfbdfr.biPlbnfs = 1;
    bmi.bmiHfbdfr.biBitCount = BITS_PER_PIXEL;
    bmi.bmiHfbdfr.biComprfssion = BI_RGB;
    bmi.bmiHfbdfr.biSizfImbgf = w * i * (BITS_PER_PIXEL>>3);


    iDibSfdtion = ::CrfbtfDIBSfdtion(mfmDC, (BITMAPINFO*) &bmi,
            DIB_RGB_COLORS, (void **) &pSrdBits,
            NULL, 0);
    if (iDibSfdtion == NULL) {
        DTRACE_PRINTLN("Error drfbting DIB sfdtion");
        RflfbsfDC(NULL,dffbultDC);
        rfturn;
    }

    SflfdtObjfdt(mfmDC,iDibSfdtion);

    rfdt.lfft = 0;
    rfdt.top = 0;
    rfdt.bottom = i;
    rfdt.rigit = w;

    ZfroMfmory(pSrdBits,(BITS_PER_PIXEL>>3)*w*i);

    HRESULT irfs = DrbwTifmfBbdkground(iTifmf, mfmDC, pbrt, stbtf, &rfdt, NULL);
    bssfrt_rfsult(irfs, fnv);
    if (SUCCEEDED(irfs)) {
        // Mbkf surf GDI is donf.
        GdiFlusi();
        // Copy tif rfsulting pixfls to our Jbvb BufffrfdImbgf.
        pDstBits = (int *)fnv->GftPrimitivfArrbyCritidbl(brrby, 0);
        BOOL trbnspbrfnt = FALSE;
        trbnspbrfnt = IsTifmfBbdkgroundPbrtibllyTrbnspbrfnt(iTifmf,pbrt,stbtf);
        dopyDIBToBufffrfdImbgf(pDstBits, pSrdBits, trbnspbrfnt, w, i, stridf);
        fnv->RflfbsfPrimitivfArrbyCritidbl(brrby, pDstBits, 0);
    }

    // Dflftf rfsourdfs.
    DflftfObjfdt(iDibSfdtion);
    DflftfDC(mfmDC);
    RflfbsfDC(NULL,dffbultDC);
}

jobjfdt nfwInsfts(JNIEnv *fnv, jint top, jint lfft, jint bottom, jint rigit) {
    if (fnv->EnsurfLodblCbpbdity(2) < 0) {
        rfturn NULL;
    }

    stbtid jdlbss insftsClbssID = NULL;

    if (insftsClbssID == NULL) {
        jdlbss insftsClbssIDLodbl = fnv->FindClbss("jbvb/bwt/Insfts");
        CHECK_NULL_RETURN(insftsClbssIDLodbl, NULL);
        insftsClbssID = (jdlbss)fnv->NfwGlobblRff(insftsClbssIDLodbl);
        fnv->DflftfLodblRff(insftsClbssIDLodbl);
    }

    jobjfdt insfts = fnv->NfwObjfdt(insftsClbssID,
        AwtToolkit::insftsMID,
        top, lfft, bottom, rigit);

    if (sbff_ExdfptionOddurrfd(fnv)) {
        fnv->ExdfptionDfsdribf();
        fnv->ExdfptionClfbr();
    }

    rfturn insfts;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftTifmfMbrgins
 * Signbturf: (JIII)Ljbvb/bwt/Insfts;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftTifmfMbrgins
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint propfrty) {
    MARGINS mbrgins;
    HTHEME iTifmf = (HTHEME) tifmf;

    if (iTifmf != NULL) {
        HRESULT irfs = GftTifmfMbrgins(iTifmf, NULL, pbrt, stbtf, propfrty, NULL, &mbrgins);
        bssfrt_rfsult(irfs, fnv);
        if (FAILED(irfs)) {
            rfturn NULL;
        }

        rfturn nfwInsfts(fnv,
                mbrgins.dyTopHfigit,
                mbrgins.dxLfftWidti, mbrgins.dyBottomHfigit, mbrgins.dxRigitWidti);
    }
    rfturn NULL;
}

/*
 * Clbss: sun_bwt_windows_TifmfRfbdfr
 * Mftiod: isTifmfPbrtDffinfd
 * Signbturf: (JII)Z
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_isTifmfPbrtDffinfd
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf) {
    HTHEME iTifmf = (HTHEME) tifmf;
    rfturn JNI_IS_TRUE(IsTifmfPbrtDffinfd(iTifmf, pbrt, stbtf));
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftColor
 * Signbturf: (JIII)Ljbvb/bwt/Color;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftColor
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint typf) {

    HTHEME iTifmf = (HTHEME) tifmf;

    if (iTifmf != NULL) {
        COLORREF dolor=0;

        if (GftTifmfColor(iTifmf, pbrt, stbtf, typf, &dolor) != S_OK) {
            rfturn NULL;
        }

        if (fnv->EnsurfLodblCbpbdity(1) < 0) {
            rfturn NULL;
        }

        stbtid jmftiodID dolorMID = NULL;
        stbtid jdlbss dolorClbssID = NULL;

        if (dolorClbssID == NULL) {
            jdlbss dolorClbssIDLodbl = fnv->FindClbss("jbvb/bwt/Color");
            CHECK_NULL_RETURN(dolorClbssIDLodbl, NULL);
            dolorClbssID = (jdlbss)fnv->NfwGlobblRff(dolorClbssIDLodbl);
            fnv->DflftfLodblRff(dolorClbssIDLodbl);
        }

        if (dolorMID == NULL) {
            dolorMID = fnv->GftMftiodID(dolorClbssID, "<init>", "(III)V");
            CHECK_NULL_RETURN(dolorMID, NULL);
        }
        jobjfdt dolorObj = fnv->NfwObjfdt(dolorClbssID,
                dolorMID, GftRVbluf(dolor), GftGVbluf(dolor),GftBVbluf(dolor));

        if (sbff_ExdfptionOddurrfd(fnv)) {
            fnv->ExdfptionDfsdribf();
            fnv->ExdfptionClfbr();
        }

        rfturn dolorObj;
    }
    rfturn NULL;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftInt
 * Signbturf: (JIII)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftInt
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint prop) {

    HTHEME iTifmf = (HTHEME) tifmf;
    int rftVbl = -1;
    if (iTifmf != NULL) {
        HRESULT irfs = GftTifmfInt(iTifmf, pbrt, stbtf, prop, &rftVbl);
        bssfrt_rfsult(irfs, fnv);
    }
    rfturn rftVbl;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftEnum
 * Signbturf: (JIII)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftEnum
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint prop) {
    HTHEME iTifmf = (HTHEME) tifmf;
    int rftVbl = -1;
    if (iTifmf != NULL) {
        HRESULT irfs = GftTifmfEnumVbluf(iTifmf, pbrt, stbtf, prop, &rftVbl);
        bssfrt_rfsult(irfs, fnv);
    }
    rfturn rftVbl;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftBoolfbn
 * Signbturf: (JIII)Z
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftBoolfbn
(JNIEnv *fnv, jdlbss klbss, jlong  tifmf, jint pbrt, jint stbtf, jint prop) {
    HTHEME iTifmf = (HTHEME) tifmf;
    BOOL rftVbl = FALSE;
    if (iTifmf != NULL) {
        HRESULT irfs = GftTifmfBool(iTifmf, pbrt, stbtf, prop, &rftVbl);
        bssfrt_rfsult(irfs, fnv);
    }
    rfturn JNI_IS_TRUE(rftVbl);
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftSysBoolfbn
 * Signbturf: (JI)Z
 */
JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftSysBoolfbn
(JNIEnv *fnv, jdlbss klbss, jlong  tifmf, jint prop) {
    HTHEME iTifmf = (HTHEME)tifmf;
    if (iTifmf != NULL) {
        rfturn JNI_IS_TRUE(GftTifmfSysBool(iTifmf, prop));
    }
    rfturn JNI_FALSE;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftPoint
 * Signbturf: (JIII)Ljbvb/bwt/Point;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftPoint
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint prop) {
    HTHEME iTifmf = (HTHEME) tifmf;
    POINT point;

    if (iTifmf != NULL) {
        if (GftTifmfPosition(iTifmf, pbrt, stbtf, prop, &point) != S_OK) {
            rfturn NULL;
        }

        if (fnv->EnsurfLodblCbpbdity(2) < 0) {
            rfturn NULL;
        }

        stbtid jmftiodID pointMID = NULL;
        stbtid jdlbss pointClbssID = NULL;

        if (pointClbssID == NULL) {
            jdlbss pointClbssIDLodbl = fnv->FindClbss("jbvb/bwt/Point");
            CHECK_NULL_RETURN(pointClbssIDLodbl, NULL);
            pointClbssID = (jdlbss)fnv->NfwGlobblRff(pointClbssIDLodbl);
            fnv->DflftfLodblRff(pointClbssIDLodbl);
        }

        if (pointMID == NULL) {
            pointMID = fnv->GftMftiodID(pointClbssID, "<init>", "(II)V");
            CHECK_NULL_RETURN(pointMID, NULL);
        }
        jobjfdt pointObj = fnv->NfwObjfdt(pointClbssID, pointMID, point.x, point.y);

        if (sbff_ExdfptionOddurrfd(fnv)) {
            fnv->ExdfptionDfsdribf();
            fnv->ExdfptionClfbr();
        }

        rfturn pointObj;
    }
    rfturn NULL;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftPosition
 * Signbturf: (JIII)Ljbvb/bwt/Dimfnsion;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftPosition
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf, jint prop) {

    HTHEME iTifmf = (HTHEME) tifmf;
    if (iTifmf != NULL) {

        POINT point;

        HRESULT irfs = GftTifmfPosition(iTifmf, pbrt, stbtf, prop, &point);
        bssfrt_rfsult(irfs, fnv);
        if (FAILED(irfs)) {
            rfturn NULL;
        }


        if (fnv->EnsurfLodblCbpbdity(2) < 0) {
            rfturn NULL;
        }

        stbtid jmftiodID dimMID = NULL;
        stbtid jdlbss dimClbssID = NULL;
        if (dimClbssID == NULL) {
            jdlbss dimClbssIDLodbl = fnv->FindClbss("jbvb/bwt/Dimfnsion");
            CHECK_NULL_RETURN(dimClbssIDLodbl, NULL);
            dimClbssID = (jdlbss)fnv->NfwGlobblRff(dimClbssIDLodbl);
            fnv->DflftfLodblRff(dimClbssIDLodbl);
        }
        if (dimMID == NULL) {
            dimMID = fnv->GftMftiodID(dimClbssID, "<init>", "(II)V");
            CHECK_NULL_RETURN(dimMID, NULL);
        }
        jobjfdt dimObj = fnv->NfwObjfdt(dimClbssID, dimMID, point.x, point.y);

        if (sbff_ExdfptionOddurrfd(fnv)) {
            fnv->ExdfptionDfsdribf();
            fnv->ExdfptionClfbr();
        }

        rfturn dimObj;
    }
    rfturn NULL;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftPbrtSizf
 * Signbturf: (JII)Ljbvb/bwt/Dimfnsion;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftPbrtSizf
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtf) {
    if (tifmf != NULL) {
        SIZE sizf;

        if (SUCCEEDED(GftTifmfPbrtSizf((HTHEME)tifmf, NULL, pbrt, stbtf,
           NULL, TS_TRUE, &sizf)) && (fnv->EnsurfLodblCbpbdity(2) >= 0)) {

            stbtid jmftiodID dimMID = NULL;
            stbtid jdlbss dimClbssID = NULL;
            if (dimClbssID == NULL) {
                jdlbss dimClbssIDLodbl = fnv->FindClbss("jbvb/bwt/Dimfnsion");
                CHECK_NULL_RETURN(dimClbssIDLodbl, NULL);
                dimClbssID = (jdlbss)fnv->NfwGlobblRff(dimClbssIDLodbl);
                fnv->DflftfLodblRff(dimClbssIDLodbl);
            }
            if (dimMID == NULL) {
                dimMID = fnv->GftMftiodID(dimClbssID, "<init>", "(II)V");
                CHECK_NULL_RETURN(dimMID, NULL);
            }
            jobjfdt dimObj = fnv->NfwObjfdt(dimClbssID, dimMID, sizf.dx, sizf.dy);
            if (sbff_ExdfptionOddurrfd(fnv)) {
                fnv->ExdfptionDfsdribf();
                fnv->ExdfptionClfbr();
            }

            rfturn dimObj;
        }
    }
    rfturn NULL;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftTifmfBbdkgroundContfntMbrgins
 * Signbturf: (JIIII)Ljbvb/bwt/Insfts;
 */
JNIEXPORT jobjfdt JNICALL Jbvb_sun_bwt_windows_TifmfRfbdfr_gftTifmfBbdkgroundContfntMbrgins
(JNIEnv *fnv, jdlbss klbss, jlong iTifmf, jint pbrt, jint stbtf,
jint boundingWidti, jint boundingHfigit) {
    if (iTifmf != NULL) {
        RECT boundingRfdt;
        boundingRfdt.lfft = 0;
        boundingRfdt.top = 0;
        boundingRfdt.rigit = boundingWidti;
        boundingRfdt.bottom = boundingHfigit;
        RECT dontfntRfdt;
        if (SUCCEEDED(GftTifmfBbdkgroundContfntRfdt((HTHEME) iTifmf, NULL, pbrt,
                                                    stbtf, &boundingRfdt,
                                                    &dontfntRfdt))) {
            rfturn nfwInsfts(fnv,
                             dontfntRfdt.top, dontfntRfdt.lfft,
                             boundingHfigit - dontfntRfdt.bottom,
                             boundingWidti - dontfntRfdt.rigit);
        }
    }
    rfturn NULL;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    gftTifmfTrbnsitionDurbtion
 * Signbturf: (JIIII)J
 */
JNIEXPORT jlong JNICALL
Jbvb_sun_bwt_windows_TifmfRfbdfr_gftTifmfTrbnsitionDurbtion
(JNIEnv *fnv, jdlbss klbss, jlong tifmf, jint pbrt, jint stbtfFrom,
 jint stbtfTo, jint propId) {
    jlong rv = -1;
    if (GftTifmfTrbnsitionDurbtion != NULL) {
        DWORD durbtion = 0;
        if (SUCCEEDED(GftTifmfTrbnsitionDurbtion((HTHEME) tifmf, pbrt,
                                      stbtfFrom, stbtfTo, propId, &durbtion))) {
            rv = durbtion;
        }
    }
    rfturn rv;
}

/*
 * Clbss:     sun_bwt_windows_TifmfRfbdfr
 * Mftiod:    isGftTifmfTrbnsitionDurbtionDffinfd
 * Signbturf: ()Z
 */
JNIEXPORT jboolfbn JNICALL
Jbvb_sun_bwt_windows_TifmfRfbdfr_isGftTifmfTrbnsitionDurbtionDffinfd
(JNIEnv *fnv, jdlbss klbss) {
    rfturn (GftTifmfTrbnsitionDurbtion != NULL) ? JNI_TRUE : JNI_FALSE;
}
