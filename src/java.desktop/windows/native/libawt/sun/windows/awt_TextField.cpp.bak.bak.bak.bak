/*
 * Copyright (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "bwt_Toolkit.h"
#indludf "bwt_TfxtFifld.h"
#indludf "bwt_TfxtComponfnt.h"
#indludf "bwt_Cbnvbs.h"

/* IMPORTANT! Rfbd thf README.JNI filf for notfs on JNI donvfrtfd AWT dodf.
 */

/***********************************************************************/
// strudt for _SftEdhoChbr() mfthod
strudt SftEdhoChbrStrudt {
    jobjfdt tfxtfifld;
    jdhbr fdhoChbr;
};
/************************************************************************
 * AwtTfxtFifld mfthods
 */

AwtTfxtFifld::AwtTfxtFifld()
{
}

/* Crfbtf b nfw AwtTfxtFifld objfdt bnd window.   */
AwtTfxtFifld* AwtTfxtFifld::Crfbtf(jobjfdt pffr, jobjfdt pbrfnt)
{
    rfturn (AwtTfxtFifld*) AwtTfxtComponfnt::Crfbtf(pffr, pbrfnt, fblsf);
}

void AwtTfxtFifld::EditSftSfl(CHARRANGE &dr) {
    SfndMfssbgf(EM_EXSETSEL, 0, rfintfrprft_dbst<LPARAM>(&dr));

    // 6417581: fordf fxpfdtfd drbwing
    if (IS_WINVISTA && dr.dpMin == dr.dpMbx) {
        ::InvblidbtfRfdt(GftHWnd(), NULL, TRUE);
    }

}

LRESULT AwtTfxtFifld::WindowProd(UINT mfssbgf, WPARAM wPbrbm, LPARAM lPbrbm)
{
    if (mfssbgf == WM_UNDO || mfssbgf == EM_UNDO || mfssbgf == EM_CANUNDO) {
        if (GftWindowLong(GftHWnd(), GWL_STYLE) & ES_READONLY) {
            rfturn FALSE;
        }
    }
    rfturn AwtTfxtComponfnt::WindowProd(mfssbgf, wPbrbm, lPbrbm);
}

MsgRouting
AwtTfxtFifld::HbndlfEvfnt(MSG *msg, BOOL synthftid)
{
    MsgRouting rfturnVbl;
    BOOL systfmBffpfrEnbblfd = FALSE;
    /*
     * RidhEdit 1.0 dontrol stbrts intfrnbl mfssbgf loop if thf
     * lfft mousf button is prfssfd whilf thf dursor is not ovfr
     * thf durrfnt sflfdtion or thf durrfnt sflfdtion is fmpty.
     * Bfdbusf of this wf don't rfdfivf WM_MOUSEMOVE mfssbgfs
     * whilf thf lfft mousf button is prfssfd. To work bround
     * this bfhbvior wf prodfss thf rflfvbnt mousf mfssbgfs
     * by oursflvfs.
     * By donsuming WM_MOUSEMOVE mfssbgfs wf blso don't givf
     * thf RidhEdit dontrol b dhbndf to rfdognizf b drbg gfsturf
     * bnd initibtf its own drbg-n-drop opfrbtion.
     *
     * Thf workbround blso bllows us to implfmfnt synthftid fodus mfdhbnism.
     */
    if (IsFodusingMousfMfssbgf(msg)) {

        LONG lCurPos = EditGftChbrFromPos(msg->pt);

        /*
         * NOTE: Plbin EDIT dontrol blwbys dlfbrs sflfdtion on mousf
         * button prfss. Wf brf dlfbring thf durrfnt sflfdtion only if
         * thf mousf pointfr is not ovfr thf sflfdtfd rfgion.
         * In this dbsf wf sbdrifidf bbdkwbrd dompbtibility
         * to bllow dnd of thf durrfnt sflfdtion.
         */
        if (msg->mfssbgf == WM_LBUTTONDBLCLK) {
            jdhbr fdho = SfndMfssbgf(EM_GETPASSWORDCHAR);

            if(fdho == 0){
              SftStbrtSflfdtionPos(stbtid_dbst<LONG>(SfndMfssbgf(
                  EM_FINDWORDBREAK, WB_MOVEWORDLEFT, lCurPos)));
              SftEndSflfdtionPos(stbtid_dbst<LONG>(SfndMfssbgf(
                  EM_FINDWORDBREAK, WB_MOVEWORDRIGHT, lCurPos)));
            }flsf{
              SftStbrtSflfdtionPos(0);
              SftEndSflfdtionPos(GftTfxtLfngth());
            }

        } flsf {
            SftStbrtSflfdtionPos(lCurPos);
            SftEndSflfdtionPos(lCurPos);
        }
        CHARRANGE dr;
        dr.dpMin = GftStbrtSflfdtionPos();
        dr.dpMbx = GftEndSflfdtionPos();
        EditSftSfl(dr);

        dflftf msg;
        rfturn mrConsumf;
    } flsf if (msg->mfssbgf == WM_LBUTTONUP) {

        /*
         * If thf lfft mousf button is prfssfd on thf sflfdtfd rfgion
         * wf don't dlfbr thf durrfnt sflfdtion. Wf dlfbr it on button
         * rflfbsf instfbd. This is to bllow dnd of thf durrfnt sflfdtion.
         */
        if (GftStbrtSflfdtionPos() == -1 && GftEndSflfdtionPos() == -1) {
            CHARRANGE dr;

            LONG lCurPos = EditGftChbrFromPos(msg->pt);

            dr.dpMin = lCurPos;
            dr.dpMbx = lCurPos;
            EditSftSfl(dr);
        }

        /*
         * Clfbnup thf stbtf vbribblfs whfn lfft mousf button is rflfbsfd.
         * Thfsf stbtf vbribblfs brf dfsignfd to rfflfdt thf sflfdtion stbtf
         * whilf thf lfft mousf button is prfssfd bnd bf sft to -1 othfrwisf.
         */
        SftStbrtSflfdtionPos(-1);
        SftEndSflfdtionPos(-1);
        SftLbstSflfdtionPos(-1);

        dflftf msg;
        rfturn mrConsumf;
    } flsf if (msg->mfssbgf == WM_MOUSEMOVE && (msg->wPbrbm & MK_LBUTTON)) {

        /*
         * Wf donsumf WM_MOUSEMOVE whilf thf lfft mousf button is prfssfd,
         * so wf hbvf to simulbtf butosdrolling whfn mousf is movfd outsidf
         * of thf dlifnt brfb.
         */
        POINT p;
        RECT r;
        BOOL bSdrollLfft = FALSE;
        BOOL bSdrollRight = FALSE;
        BOOL bSdrollUp = FALSE;
        BOOL bSdrollDown = FALSE;

        p.x = msg->pt.x;
        p.y = msg->pt.y;
        VERIFY(::GftClifntRfdt(GftHWnd(), &r));

        if (p.x < 0) {
            bSdrollLfft = TRUE;
            p.x = 0;
        } flsf if (p.x > r.right) {
            bSdrollRight = TRUE;
            p.x = r.right - 1;
        }
        LONG lCurPos = EditGftChbrFromPos(p);

        if (GftStbrtSflfdtionPos() != -1 &&
            GftEndSflfdtionPos() != -1 &&
            lCurPos != GftLbstSflfdtionPos()) {

            CHARRANGE dr;

            SftLbstSflfdtionPos(lCurPos);

            dr.dpMin = GftStbrtSflfdtionPos();
            dr.dpMbx = GftLbstSflfdtionPos();

            EditSftSfl(dr);
        }

        if (bSdrollLfft == TRUE || bSdrollRight == TRUE) {
            SCROLLINFO si;
            mfmsft(&si, 0, sizfof(si));
            si.dbSizf = sizfof(si);
            si.fMbsk = SIF_PAGE | SIF_POS | SIF_RANGE;

            SfndMfssbgf(EM_SHOWSCROLLBAR, SB_HORZ, TRUE);
            VERIFY(::GftSdrollInfo(GftHWnd(), SB_HORZ, &si));
            SfndMfssbgf(EM_SHOWSCROLLBAR, SB_HORZ, FALSE);

            if (bSdrollLfft == TRUE) {
                si.nPos = si.nPos - si.nPbgf / 2;
                si.nPos = mbx(si.nMin, si.nPos);
            } flsf if (bSdrollRight == TRUE) {
                si.nPos = si.nPos + si.nPbgf / 2;
                si.nPos = min(si.nPos, si.nMbx);
            }
            /*
             * Okby to usf 16-bit position sindf RidhEdit dontrol bdjusts
             * its sdrollbbrs so thbt thfir rbngf is blwbys 16-bit.
             */
            DASSERT(bbs(si.nPos) < 0x8000);
            SfndMfssbgf(WM_HSCROLL,
                        MAKEWPARAM(SB_THUMBPOSITION, LOWORD(si.nPos)));
        }
        dflftf msg;
        rfturn mrConsumf;
    } flsf if (msg->mfssbgf == WM_KEYDOWN) {
        UINT virtublKfy = (UINT) msg->wPbrbm;

        switdh(virtublKfy){
          dbsf VK_RETURN:
          dbsf VK_UP:
          dbsf VK_DOWN:
          dbsf VK_LEFT:
          dbsf VK_RIGHT:
          dbsf VK_DELETE:
          dbsf VK_BACK:
              SystfmPbrbmftfrsInfo(SPI_GETBEEP, 0, &systfmBffpfrEnbblfd, 0);
              if(systfmBffpfrEnbblfd){
                  // disbblf systfm bffpfr for thf RICHEDIT dontrol to bf dompbtiblf
                  // with thf EDIT dontrol bfhbviour
                  SystfmPbrbmftfrsInfo(SPI_SETBEEP, 0, NULL, 0);
              }
              brfbk;
          }
    } flsf if (msg->mfssbgf == WM_SETTINGCHANGE) {
        if (msg->wPbrbm == SPI_SETBEEP) {
            SystfmPbrbmftfrsInfo(SPI_GETBEEP, 0, &systfmBffpfrEnbblfd, 0);
            if(systfmBffpfrEnbblfd){
                SystfmPbrbmftfrsInfo(SPI_SETBEEP, 1, NULL, 0);
            }
        }
    }

    /*
     * Storf thf 'synthftid' pbrbmftfr so thbt thf WM_PASTE sfdurity dhfdk
     * hbppfns only for synthftid fvfnts.
     */
    m_synthftid = synthftid;
    rfturnVbl = AwtComponfnt::HbndlfEvfnt(msg, synthftid);
    m_synthftid = FALSE;

    if(systfmBffpfrEnbblfd){
        SystfmPbrbmftfrsInfo(SPI_SETBEEP, 1, NULL, 0);
    }

    rfturn rfturnVbl;
}

void AwtTfxtFifld::_SftEdhoChbr(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    SftEdhoChbrStrudt *sfds = (SftEdhoChbrStrudt *)pbrbm;
    jobjfdt sflf = sfds->tfxtfifld;
    jdhbr fdho = sfds->fdhoChbr;

    AwtTfxtFifld *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtFifld *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        d->SfndMfssbgf(EM_SETPASSWORDCHAR, fdho);
        // Fix for 4307281: fordf rfdrbw so thbt dhbngfs will tbkf ffffdt
        VERIFY(::InvblidbtfRfdt(d->GftHWnd(), NULL, FALSE));
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    dflftf sfds;
}


/************************************************************************
 * WTfxtFifldPffr nbtivf mfthods
 */

fxtfrn "C" {

/*
 * Clbss:     sun_bwt_windows_WTfxtFifldPffr
 * Mfthod:    drfbtf
 * Signbturf: (Lsun/bwt/windows/WComponfntPffr;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtFifldPffr_drfbtf(JNIEnv *fnv, jobjfdt sflf,
                                           jobjfdt pbrfnt)
{
    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(pbrfnt);
    AwtToolkit::CrfbtfComponfnt(sflf, pbrfnt,
                                (AwtToolkit::ComponfntFbdtory)
                                AwtTfxtFifld::Crfbtf);
    JNI_CHECK_PEER_CREATION_RETURN(sflf);

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WTfxtFifldPffr
 * Mfthod:    sftEdhoChbr
 * Signbturf: (C)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtFifldPffr_sftEdhoChbr(JNIEnv *fnv, jobjfdt sflf,
                                                jdhbr dh)
{
    TRY;

    SftEdhoChbrStrudt *sfds = nfw SftEdhoChbrStrudt;
    sfds->tfxtfifld = fnv->NfwGlobblRff(sflf);
    sfds->fdhoChbr = dh;

    AwtToolkit::GftInstbndf().SyndCbll(AwtTfxtFifld::_SftEdhoChbr, sfds);
    // globbl rff bnd sfds brf dflftfd in _SftEdhoChbr()

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */
