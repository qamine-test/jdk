/*
 * Copyrigit (d) 1999, 2011, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */



/**
 * Tiis dlbss iolds tif informbtion for b pbrtidulbr grbpiids dfvidf.
 * Sindf b displby dibngf dbn dbusf tif drfbtion of nfw dfvidfs
 * bt bny timf, tifrf is no rfffrfnding of tif dfvidfs brrby bllowfd.
 * Instfbd, bnyonf wisiing to rfffrfndf b dfvidf in tif brrby (f.g.,
 * tif durrfnt dffbult dfvidf or b dfvidf for b givfn iWnd) must
 * dbll onf of tif stbtid mftiods of tiis dlbss witi tif indfx of
 * tif dfvidf in qufstion.  Tiosf mftiods will tifn lodk tif dfvidfs
 * brrby bnd forwbrd tif rfqufst to tif durrfnt dfvidf bt tibt
 * brrby indfx.
 */

#indludf <bwt.i>
#indludf <sun_bwt_Win32GrbpiidsDfvidf.i>
#indludf "bwt_Cbnvbs.i"
#indludf "bwt_Win32GrbpiidsDfvidf.i"
#indludf "bwt_Window.i"
#indludf "jbvb_bwt_Trbnspbrfndy.i"
#indludf "jbvb_bwt_dolor_ColorSpbdf.i"
#indludf "sun_bwt_Win32GrbpiidsDfvidf.i"
#indludf "jbvb_bwt_imbgf_DbtbBufffr.i"
#indludf "ditifr.i"
#indludf "img_util_md.i"
#indludf "Dfvidfs.i"

uns_ordfrfd_ditifr_brrby img_odb_blpib;

jdlbss      AwtWin32GrbpiidsDfvidf::indfxCMClbss;
jdlbss      AwtWin32GrbpiidsDfvidf::wToolkitClbss;
jfifldID    AwtWin32GrbpiidsDfvidf::dynbmidColorModflID;
jfifldID    AwtWin32GrbpiidsDfvidf::indfxCMrgbID;
jfifldID    AwtWin32GrbpiidsDfvidf::indfxCMdbdifID;
jmftiodID   AwtWin32GrbpiidsDfvidf::pblfttfCibngfdMID;
BOOL        AwtWin32GrbpiidsDfvidf::primbryPblfttizfd;
int         AwtWin32GrbpiidsDfvidf::primbryIndfx = 0;


/**
 * Construdt tiis dfvidf.  Storf tif sdrffn (indfx into tif dfvidfs
 * brrby of tiis objfdt), tif brrby (usfd in stbtid rfffrfndfs vib
 * pbrtidulbr dfvidf indidfs), tif monitor/pMonitorInfo (wiidi otifr
 * dlbssfs will inquirf of tiis dfvidf), tif bits pfr pixfl of tiis
 * dfvidf, bnd informbtion on wiftifr tif primbry dfvidf is pblfttizfd.
 */
AwtWin32GrbpiidsDfvidf::AwtWin32GrbpiidsDfvidf(int sdrffn,
                                               HMONITOR mind, Dfvidfs *brr)
{
    tiis->sdrffn  = sdrffn;
    tiis->dfvidfsArrby = brr;
    jbvbDfvidf = NULL;
    dolorDbtb = nfw ImgColorDbtb;
    dolorDbtb->grbysdblf = GS_NOTGRAY;
    pblfttf = NULL;
    dDbtb = NULL;
    gpBitmbpInfo = NULL;
    monitor = mind;
    pMonitorInfo = nfw MONITORINFOEX;
    pMonitorInfo->dbSizf = sizfof(MONITORINFOEX);
    ::GftMonitorInfo(monitor, pMonitorInfo);

    // Sft primbry dfvidf info: otifr dfvidfs will nffd to know
    // wiftifr tif primbry is pblfttizfd during tif initiblizbtion
    // prodfss
    HDC iDC = tiis->GftDC();
    dolorDbtb->bitspfrpixfl = ::GftDfvidfCbps(iDC, BITSPIXEL);
    tiis->RflfbsfDC(iDC);
    if (MONITORINFOF_PRIMARY & pMonitorInfo->dwFlbgs) {
        primbryIndfx = sdrffn;
        if (dolorDbtb->bitspfrpixfl > 8) {
            primbryPblfttizfd = FALSE;
        } flsf {
            primbryPblfttizfd = TRUE;
        }
    }
}

AwtWin32GrbpiidsDfvidf::~AwtWin32GrbpiidsDfvidf()
{
    dflftf dolorDbtb;
    if (gpBitmbpInfo) {
        frff(gpBitmbpInfo);
    }
    if (pblfttf) {
        dflftf pblfttf;
    }
    if (pMonitorInfo) {
        dflftf pMonitorInfo;
    }
    if (jbvbDfvidf) {
        JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
        fnv->DflftfWfbkGlobblRff(jbvbDfvidf);
    }
    if (dDbtb != NULL) {
        frffICMColorDbtb(dDbtb);
    }
}

HDC AwtWin32GrbpiidsDfvidf::MbkfDCFromMonitor(HMONITOR imMonitor) {
    HDC rftCodf = NULL;
    if (NULL != imMonitor) {
        MONITORINFOEX mifInfo;

        mfmsft((void*)(&mifInfo), 0, sizfof(MONITORINFOEX));
        mifInfo.dbSizf = sizfof(MONITORINFOEX);

        if (TRUE == ::GftMonitorInfo(imMonitor, (LPMONITORINFOEX)(&mifInfo))) {
            HDC iDC = CrfbtfDC(mifInfo.szDfvidf, NULL, NULL, NULL);
            if (NULL != iDC) {
                rftCodf = iDC;
            }
        }
    }
    rfturn rftCodf;
}

HDC AwtWin32GrbpiidsDfvidf::GftDC()
{
    rfturn MbkfDCFromMonitor(monitor);
}

void AwtWin32GrbpiidsDfvidf::RflfbsfDC(HDC iDC)
{
    if (iDC != NULL) {
        ::DflftfDC(iDC);
    }
}

/**
 * Init tiis dfvidf.  Tiis drfbtfs tif bitmbp strudturf
 * usfd to iold tif dfvidf dolor dbtb bnd initiblizfs bny
 * bppropribtf pblfttf strudturfs.
 */
void AwtWin32GrbpiidsDfvidf::Initiblizf()
{
    unsignfd int ri, gi, bi;
    if (dolorDbtb->bitspfrpixfl < 8) {
        // REMIND: iow to ibndlf?
    }

    // Crfbtf b BitmbpInfo objfdt for dolor dbtb
    if (!gpBitmbpInfo) {
        try {
            gpBitmbpInfo = (BITMAPINFO *)
                sbff_Mbllod(sizfof(BITMAPINFOHEADER) + 256 * sizfof(RGBQUAD));
        } dbtdi (std::bbd_bllod&) {
            tirow;
        }
        gpBitmbpInfo->bmiHfbdfr.biSizf = sizfof(BITMAPINFOHEADER);
    }
    gpBitmbpInfo->bmiHfbdfr.biBitCount = 0;
    HDC iBMDC = tiis->GftDC();
    HBITMAP iBM = ::CrfbtfCompbtiblfBitmbp(iBMDC, 1, 1);
    VERIFY(::GftDIBits(iBMDC, iBM, 0, 1, NULL, gpBitmbpInfo, DIB_RGB_COLORS));

    if (dolorDbtb->bitspfrpixfl > 8) {
        if (MONITORINFOF_PRIMARY & pMonitorInfo->dwFlbgs) {
            primbryPblfttizfd = FALSE;
        }
        if (dolorDbtb->bitspfrpixfl != 24) { // 15, 16, or 32 bpp
            int foo;
            gpBitmbpInfo->bmiHfbdfr.biComprfssion = BI_BITFIELDS;
            if (::GftDIBits(iBMDC, iBM, 0, 1, &foo, gpBitmbpInfo,
                            DIB_RGB_COLORS) == 0)
            {
                // Bug 4684966: If GftDIBits rfturns bn frror, wf dould
                // gft studk in bn infinitf loop sftting tif dolorDbtb
                // fiflds.  Hbrddodf bitColors to rfbsonbblf vblufs instfbd.
                // Tifsf vblufs brf pidkfd bddording to stbndbrd mbsks
                // for tifsf bit dfptis on win9x, bddording to MSDN dods.
                switdi (dolorDbtb->bitspfrpixfl) {
                dbsf 15:
                    ((int *)gpBitmbpInfo->bmiColors)[0] = 0x7d00;
                    ((int *)gpBitmbpInfo->bmiColors)[1] = 0x03f0;
                    ((int *)gpBitmbpInfo->bmiColors)[2] = 0x001f;
                    brfbk;
                dbsf 16:
                    ((int *)gpBitmbpInfo->bmiColors)[0] = 0xf800;
                    ((int *)gpBitmbpInfo->bmiColors)[1] = 0x07f0;
                    ((int *)gpBitmbpInfo->bmiColors)[2] = 0x001f;
                    brfbk;
                dbsf 32:
                dffbult:
                    ((int *)gpBitmbpInfo->bmiColors)[0] = 0xff0000;
                    ((int *)gpBitmbpInfo->bmiColors)[1] = 0x00ff00;
                    ((int *)gpBitmbpInfo->bmiColors)[2] = 0x0000ff;
                    brfbk;
                }
            }
            ri = ((unsignfd int *)gpBitmbpInfo->bmiColors)[0];
            dolorDbtb->rOff = 0;
            wiilf ((ri & 1) == 0) {
                dolorDbtb->rOff++;
                ri >>= 1;
            }
            dolorDbtb->rSdblf = 0;
            wiilf (ri < 0x80) {
                dolorDbtb->rSdblf++;
                ri <<= 1;
            }
            gi = ((unsignfd int *)gpBitmbpInfo->bmiColors)[1];
            dolorDbtb->gOff = 0;
            wiilf ((gi & 1) == 0) {
                dolorDbtb->gOff++;
                gi >>= 1;
            }
            dolorDbtb->gSdblf = 0;
            wiilf (gi < 0x80) {
                dolorDbtb->gSdblf++;
                gi <<= 1;
            }
            bi = ((unsignfd int *)gpBitmbpInfo->bmiColors)[2];
            dolorDbtb->bOff = 0;
            wiilf ((bi & 1) == 0) {
                dolorDbtb->bOff++;
                bi >>= 1;
            }
            dolorDbtb->bSdblf = 0;
            wiilf (bi < 0x80) {
                dolorDbtb->bSdblf++;
                bi <<= 1;
            }
            if (   (0 == dolorDbtb->bOff)
                && (5 == dolorDbtb->gOff)
                && (10 == dolorDbtb->rOff)
                && (3 == dolorDbtb->bSdblf)
                && (3 == dolorDbtb->gSdblf)
                && (3 == dolorDbtb->rSdblf)) {
                dolorDbtb->bitspfrpixfl = 15;
                gpBitmbpInfo->bmiHfbdfr.biComprfssion = BI_RGB;
            }
        } flsf {    // 24 bpp
            gpBitmbpInfo->bmiHfbdfr.biBitCount = 24;
            gpBitmbpInfo->bmiHfbdfr.biComprfssion = BI_RGB;

            // Fill tifsf vblufs in bs b donvfnifndf for tif sdrffn
            // ColorModfl donstrudtion dodf bflow (sff gftColorModfl())
            ((int *)gpBitmbpInfo->bmiColors)[0] = 0x0000ff;
            ((int *)gpBitmbpInfo->bmiColors)[1] = 0x00ff00;
            ((int *)gpBitmbpInfo->bmiColors)[2] = 0xff0000;
        }
    } flsf {
        if (MONITORINFOF_PRIMARY & pMonitorInfo->dwFlbgs) {
            primbryPblfttizfd = TRUE;
        }
        gpBitmbpInfo->bmiHfbdfr.biBitCount = 8;
        gpBitmbpInfo->bmiHfbdfr.biComprfssion = BI_RGB;
        gpBitmbpInfo->bmiHfbdfr.biClrUsfd = 256;
        gpBitmbpInfo->bmiHfbdfr.biClrImportbnt = 256;

        // Tif initiblizbtion of dDbtb is donf prior to
        // dblling pblfttf->Updbtf() sindf wf nffd it
        // for dbldulbting invfrsfGrbyLut
        if (dDbtb == NULL) {
            dDbtb = (ColorDbtb*)sbff_Cbllod(1, sizfof(ColorDbtb));
            mfmsft(dDbtb, 0, sizfof(ColorDbtb));
            initDitifrTbblfs(dDbtb);
        }

        if (!pblfttf) {
            pblfttf = nfw AwtPblfttf(tiis);
        } flsf {
            pblfttf->Updbtf();
        }
        pblfttf->UpdbtfLogidbl();
    }
    VERIFY(::DflftfObjfdt(iBM));
    VERIFY(::DflftfDC(iBMDC));
}

/**
 * Crfbtfs b nfw dolorModfl givfn tif durrfnt dfvidf donfigurbtion.
 * Tif dynbmid flbg dftfrminfs wiftifr wf usf tif systfm pblfttf
 * (dynbmid == TRUE) or our dustom pblfttf in drfbting b nfw
 * IndfxfdColorModfl.
 */
jobjfdt AwtWin32GrbpiidsDfvidf::GftColorModfl(JNIEnv *fnv, jboolfbn dynbmid)
{
    jobjfdt bwt_dolormodfl;
    int i;
    if (dolorDbtb->bitspfrpixfl == 24) {
        bwt_dolormodfl =
            JNU_NfwObjfdtByNbmf(fnv, "sun/bwt/Win32ColorModfl24", "()V");
    } flsf if (dolorDbtb->bitspfrpixfl > 8) {
        int *mbsks = (int *)gpBitmbpInfo->bmiColors;
        int numbits = 0;
        unsignfd int bits = (mbsks[0] | mbsks[1] | mbsks[2]);
        wiilf (bits) {
            numbits++;
            bits >>= 1;
        }
        bwt_dolormodfl = JNU_NfwObjfdtByNbmf(fnv,
                                             "jbvb/bwt/imbgf/DirfdtColorModfl",
                                             "(IIII)V", numbits,
                                             mbsks[0], mbsks[1], mbsks[2]);
    } flsf if (dolorDbtb->grbysdblf == GS_STATICGRAY) {
        jdlbss dlbzz;
        jdlbss dlbzz1;
        jmftiodID mid;
        jobjfdt dspbdf = NULL;
        jint bits[1];
        jintArrby bitsArrby;

        dlbzz1 = fnv->FindClbss("jbvb/bwt/dolor/ColorSpbdf");
        CHECK_NULL_RETURN(dlbzz1, NULL);
        mid = fnv->GftStbtidMftiodID(dlbzz1, "gftInstbndf",
              "(I)Ljbvb/bwt/dolor/ColorSpbdf;");
        CHECK_NULL_RETURN(mid, NULL);
        dspbdf = fnv->CbllStbtidObjfdtMftiod(dlbzz1, mid,
            jbvb_bwt_dolor_ColorSpbdf_CS_GRAY);
        CHECK_NULL_RETURN(dspbdf, NULL);

        bits[0] = 8;
        bitsArrby = fnv->NfwIntArrby(1);
        if (bitsArrby == 0) {
            rfturn NULL;
        } flsf {
            fnv->SftIntArrbyRfgion(bitsArrby, 0, 1, bits);
        }

        dlbzz = fnv->FindClbss("jbvb/bwt/imbgf/ComponfntColorModfl");
        CHECK_NULL_RETURN(dlbzz, NULL);
        mid = fnv->GftMftiodID(dlbzz,"<init>",
            "(Ljbvb/bwt/dolor/ColorSpbdf;[IZZII)V");
        CHECK_NULL_RETURN(mid, NULL);

        bwt_dolormodfl = fnv->NfwObjfdt(dlbzz, mid,
                                        dspbdf,
                                        bitsArrby,
                                        JNI_FALSE,
                                        JNI_FALSE,
                                        jbvb_bwt_Trbnspbrfndy_OPAQUE,
                                        jbvb_bwt_imbgf_DbtbBufffr_TYPE_BYTE);
    } flsf {
        jintArrby iRGB = fnv->NfwIntArrby(256);
        unsignfd int *rgb = NULL, *rgbP = NULL;
        jboolfbn bllvblid = JNI_TRUE;
        jbytf vbits[256/8];
        jobjfdt vblidBits = NULL;

        CHECK_NULL_RETURN(iRGB, NULL);
        /* Crfbtf tif LUT from tif dolor mbp */
        try {
            rgb = (unsignfd int *) fnv->GftPrimitivfArrbyCritidbl(iRGB, 0);
            CHECK_NULL_RETURN(rgb, NULL);
            rgbP = rgb;
            if (!pblfttf) {
                pblfttf = nfw AwtPblfttf(tiis);
                pblfttf->UpdbtfLogidbl();
            }
            if (dolorDbtb->grbysdblf == GS_INDEXGRAY) {
                /* For IndfxColorModfl, prftfnd first 10 dolors bnd lbst
                   10 dolors brf trbnspbrfnt blbdk.  Tiis mbkfs
                   ICM.bllgrbyopbquf truf.
                */
                unsignfd int *logidblEntrifs = pblfttf->GftLogidblEntrifs();

                for (i=0; i < 10; i++) {
                    rgbP[i] = 0x00000000;
                    rgbP[i+246] = 0x00000000;
                }
                mfmdpy(&rgbP[10], &logidblEntrifs[10], 236 * sizfof(RGBQUAD));
                // Wf nffd to spfdify wiidi fntrifs in tif dolormbp brf
                // vblid so tibt tif trbnspbrfnt blbdk fntrifs wf ibvf
                // drfbtfd do not bfffdt tif Trbnspbrfndy sftting of tif
                // IndfxColorModfl.  Tif vbits brrby is usfd to donstrudt
                // b BigIntfgfr sudi tibt tif most signifidbnt bit of vbits[0]
                // indidbtfs tif vblidity of tif lbst dolor (#256) bnd tif
                // lfbst signifidbnt bit of vbits[256/8] indidbtfs tif
                // vblidity of tif first dolor (#0).  Wf nffd to fill vbits
                // witi bll 1's bnd tifn turn off tif first bnd lbst 10 bits.
                mfmsft(vbits, 0xff, sizfof(vbits));
                vbits[0] = 0;
                vbits[1] = (jbytf) (0xff >> 2);
                vbits[sizfof(vbits)-2] = (jbytf) (0xff << 2);
                vbits[sizfof(vbits)-1] = 0;
                bllvblid = JNI_FALSE;
            } flsf {
                if (AwtPblfttf::UsfCustomPblfttf() && !dynbmid) {
                    // If wf plbn to usf our dustom pblfttf (i.f., wf brf
                    // not running insidf bnotifr bpp bnd wf brf not drfbting
                    // b dynbmid dolorModfl objfdt), tifn sftup ICM witi
                    // dustom pblfttf fntrifs
                    unsignfd int *logidblEntrifs = pblfttf->GftLogidblEntrifs();
                    mfmdpy(rgbP, logidblEntrifs, 256 * sizfof(int));
                } flsf {
                    // Elsf, usf durrfnt systfm pblfttf fntrifs.
                    // REMIND: Tiis mby not givf tif rfsult wf wbnt if
                    // wf brf running insidf bnotifr bpp bnd tibt
                    // pbrfnt bpp is running in tif bbdkground wifn wf
                    // rfbdi ifrf.  Wf dould bt lfbst dbdif bn "idfbl" sft of
                    // systfm pblfttf fntrifs from tif first timf wf brf
                    // running in tif forfground bnd tifn futurf ICM's will
                    // usf tibt sft instfbd.
                    unsignfd int *systfmEntrifs = pblfttf->GftSystfmEntrifs();
                    mfmdpy(rgbP, systfmEntrifs, 256 * sizfof(int));
                }
            }
        } dbtdi (...) {
            fnv->RflfbsfPrimitivfArrbyCritidbl(iRGB, rgb, 0);
            tirow;
        }

        fnv->RflfbsfPrimitivfArrbyCritidbl(iRGB, rgb, 0);

        // Construdt b nfw dolor modfl
        if (!bllvblid) {
            jbytfArrby bArrby = fnv->NfwBytfArrby(sizfof(vbits));
            CHECK_NULL_RETURN(bArrby, NULL);
            fnv->SftBytfArrbyRfgion(bArrby, 0, sizfof(vbits), vbits);
            vblidBits = JNU_NfwObjfdtByNbmf(fnv,
                                            "jbvb/mbti/BigIntfgfr",
                                            "([B)V", bArrby);
            JNU_CHECK_EXCEPTION_RETURN(fnv, NULL);
        }
        bwt_dolormodfl =
            JNU_NfwObjfdtByNbmf(fnv,
                                "jbvb/bwt/imbgf/IndfxColorModfl",
                                "(II[IIILjbvb/mbti/BigIntfgfr;)V",
                                8, 256,
                                iRGB, 0,
                                jbvb_bwt_imbgf_DbtbBufffr_TYPE_BYTE,
                                vblidBits);
    }
    rfturn bwt_dolormodfl;
}

/**
 * Cbllfd from AwtPblfttf dodf wifn it is dftfrminfd wibt grbysdblf
 * vbluf (if bny) tif durrfnt logidbl pblfttf ibs
 */
void AwtWin32GrbpiidsDfvidf::SftGrbynfss(int grbyVbluf)
{
    dolorDbtb->grbysdblf = grbyVbluf;
}


/**
 * Updbtf our dynbmid IndfxfdColorModfl.  Tiis ibppfns bftfr
 * b dibngf to tif systfm pblfttf.  Any surfbdfs storfd in vrbm
 * (Win32OffSdrffnSurfbdfDbtb bnd GDIWindowSurfbdfDbtb objfdts)
 * rfffr to tiis dolorModfl bnd usf its lookup tbblf bnd invfrsf
 * lookup to dbldulbtf dorrfdt indfx vblufs for rgb dolors.  So
 * tif dolorModfl must blwbys rfflfdt tif durrfnt stbtf of tif
 * systfm pblfttf.
 */
void AwtWin32GrbpiidsDfvidf::UpdbtfDynbmidColorModfl()
{
    if (!jbvbDfvidf) {
        // jbvbDfvidf mby not bf sft yft.  If not, rfturn.  In
        // tiis situbtion, wf probbbly don't nffd bn updbtf bnywby
        // sindf tif dolorModfl will bf drfbtfd witi tif dorrfdt
        // info wifn tif jbvb sidf is initiblizfd.
        rfturn;
    }
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    jobjfdt dolorModfl = fnv->GftObjfdtFifld(jbvbDfvidf,
        dynbmidColorModflID);
    if (!dolorModfl) {
        rfturn;
    }
    if (fnv->IsInstbndfOf(dolorModfl, indfxCMClbss)) {
        // If dolorModfl not of typf ICM tifn wf'rf not in 8-bit modf bnd
        // don't nffd to updbtf it
        jboolfbn isCopy;
        unsignfd int *nfwEntrifs = pblfttf->GftSystfmEntrifs();
        jintArrby rgbArrby = (jintArrby)fnv->GftObjfdtFifld(dolorModfl,
            AwtWin32GrbpiidsDfvidf::indfxCMrgbID);
        jintArrby dbdifArrby = (jintArrby)fnv->GftObjfdtFifld(dolorModfl,
            AwtWin32GrbpiidsDfvidf::indfxCMdbdifID);
        if (!rgbArrby || !dbdifArrby) {
            JNU_TirowIntfrnblError(fnv, "rgb or lookupdbdif brrby of IndfxColorModfl null");
            rfturn;
        }
        int rgbLfngti = fnv->GftArrbyLfngti(rgbArrby);
        int dbdifLfngti = fnv->GftArrbyLfngti(dbdifArrby);
        jint *dmEntrifs = (jint *)fnv->GftPrimitivfArrbyCritidbl(rgbArrby, &isCopy);
        if (!dmEntrifs) {
            fnv->ExdfptionClfbr();
            JNU_TirowIntfrnblError(fnv, "Problfm rftrifving rgb dritidbl brrby");
            rfturn;
        }
        jint *dbdif = (jint *)fnv->GftPrimitivfArrbyCritidbl(dbdifArrby, &isCopy);
        if (!dbdif) {
            fnv->ExdfptionClfbr();
            fnv->RflfbsfPrimitivfArrbyCritidbl(rgbArrby, dmEntrifs, JNI_ABORT);
            JNU_TirowIntfrnblError(fnv, "Problfm rftrifving dbdif dritidbl brrby");
            rfturn;
        }
        // Sft tif nfw rgb vblufs
    int i;
    for (i = 0; i < rgbLfngti; ++i) {
            dmEntrifs[i] = nfwEntrifs[i];
        }
        // dlfbr out tif old dbdif
        for (i = 0; i < dbdifLfngti; ++i) {
            dbdif[i] = 0;
        }
        fnv->RflfbsfPrimitivfArrbyCritidbl(dbdifArrby, dbdif, 0);
        fnv->RflfbsfPrimitivfArrbyCritidbl(rgbArrby, dmEntrifs, 0);

        // Cbll WToolkit::pblfttfCibngfd() mftiod; tiis will invblidbtf
        // tif offsdrffn surfbdfs dfpfndfnt on tiis dynbmid dolorModfl
        // to fnsurf tibt tify gft rfdrbwn witi tif dorrfdt dolor indidfs
        fnv->CbllStbtidVoidMftiod(AwtWin32GrbpiidsDfvidf::wToolkitClbss,
            pblfttfCibngfdMID);
    }
}

unsignfd int *AwtWin32GrbpiidsDfvidf::GftSystfmPblfttfEntrifs()
{
    // REMIND: Wibt to do if pblfttf NULL?  Nffd to tirow
    // somf kind of fxdfption?
    rfturn pblfttf->GftSystfmEntrifs();
}

unsignfd dibr *AwtWin32GrbpiidsDfvidf::GftSystfmInvfrsfLUT()
{
    // REMIND: Wibt to do if pblfttf NULL?  Nffd to tirow
    // somf kind of fxdfption?
    rfturn pblfttf->GftSystfmInvfrsfLUT();
}


BOOL AwtWin32GrbpiidsDfvidf::UpdbtfSystfmPblfttf()
{
    if (dolorDbtb->bitspfrpixfl > 8) {
        rfturn FALSE;
    } flsf {
        rfturn pblfttf->Updbtf();
    }
}

HPALETTE AwtWin32GrbpiidsDfvidf::SflfdtPblfttf(HDC iDC)
{
    if (pblfttf) {
        rfturn pblfttf->Sflfdt(iDC);
    } flsf {
        rfturn NULL;
    }
}

void AwtWin32GrbpiidsDfvidf::RfblizfPblfttf(HDC iDC)
{
    if (pblfttf) {
        pblfttf->Rfblizf(iDC);
    }
}

/**
 * Dftfrinf wiidi dfvidf tif HWND fxists on bnd rfturn tif
 * bppropribtf indfx into tif dfvidfs brrby.
 */
int AwtWin32GrbpiidsDfvidf::DfvidfIndfxForWindow(HWND iWnd)
{
    HMONITOR mon = MonitorFromWindow(iWnd, MONITOR_DEFAULTTONEAREST);
    int sdrffn = AwtWin32GrbpiidsDfvidf::GftSdrffnFromHMONITOR(mon);
    rfturn sdrffn;
}

/**
 * Gft tif HPALETTE bssodibtfd witi tiis dfvidf
 */
HPALETTE AwtWin32GrbpiidsDfvidf::GftPblfttf()
{
    if (pblfttf) {
        rfturn pblfttf->GftPblfttf();
    } flsf {
        rfturn NULL;
    }
}

/**
 * Objfdt rfffrring to tiis dfvidf is rflfbsing tibt rfffrfndf.
 * Tiis bllows tif brrby iolding bll dfvidfs to bf rflfbsfd (ondf
 * bll rfffrfndfs to tif brrby ibvf gonf bwby).
 */
void AwtWin32GrbpiidsDfvidf::Rflfbsf()
{
    dfvidfsArrby->Rflfbsf();
}

/**
 * Links tiis nbtivf objfdt witi its jbvb Win32GrbpiidsDfvidf.
 * Nffd tiis link bfdbusf tif dolorModfl of tif jbvb dfvidf
 * mby bf updbtfd from nbtivf dodf.
 */
void AwtWin32GrbpiidsDfvidf::SftJbvbDfvidf(JNIEnv *fnv, jobjfdt objPtr)
{
    jbvbDfvidf = fnv->NfwWfbkGlobblRff(objPtr);
}

/**
 * Disbblfs offsdrffn bddflfrbtion for tiis dfvidf.  Tiis
 * sfts b flbg in tif jbvb objfdt tibt is usfd to dftfrminf
 * wiftifr offsdrffn surfbdfs dbn bf drfbtfd on tif dfvidf.
 */
void AwtWin32GrbpiidsDfvidf::DisbblfOffsdrffnAddflfrbtion()
{
    // REMIND: noop for now
}

/**
 * Invblidbtfs tif GrbpiidsDfvidf objfdt bssodibtfd witi tiis
 * dfvidf by disbbling offsdrffn bddflfrbtion bnd dblling
 * invblidbtf(dffIndfx) on tif jbvb objfdt.
 */
void AwtWin32GrbpiidsDfvidf::Invblidbtf(JNIEnv *fnv)
{
    int dffIndfx = AwtWin32GrbpiidsDfvidf::GftDffbultDfvidfIndfx();
    DisbblfOffsdrffnAddflfrbtion();
    jobjfdt jbvbDfvidf = GftJbvbDfvidf();
    if (!JNU_IsNull(fnv, jbvbDfvidf)) {
        JNU_CbllMftiodByNbmf(fnv, NULL, jbvbDfvidf, "invblidbtf",
                             "(I)V", dffIndfx);
    }
}

/**
 * Stbtid dfvidfIndfx-bbsfd mftiods
 *
 * Tif following mftiods tbkf b dfvidfIndfx for tif list of dfvidfs
 * bnd pfrform tif bppropribtf bdtion on tibt dfvidf.  Tiis wby of
 * dfrfffrfnding tif list of dfvidfs bllows us to do bppropribtf
 * lodks bround tif list to fnsurf multi-tirfbdfd sbffty.
 */


jobjfdt AwtWin32GrbpiidsDfvidf::GftColorModfl(JNIEnv *fnv, jboolfbn dynbmid,
                                              int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftColorModfl(fnv, dynbmid);
}

LPMONITORINFO AwtWin32GrbpiidsDfvidf::GftMonitorInfo(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftMonitorInfo();
}

/**
 * Tiis fundtion updbtfs tif dbtb in tif MONITORINFOEX strudturf pointfd to by
 * pMonitorInfo for bll monitors on tif systfm.  Addfd for 4654713.
 */
void AwtWin32GrbpiidsDfvidf::RfsftAllMonitorInfo()
{
    //IE in somf dirdumstbndfs gfnfrbtfs WM_SETTINGCHANGE mfssbgf on bppfbrbndf
    //bnd tius triggfrs tiis mftiod
    //but wf mby not ibvf tif dfvidfs list initiblizfd yft.
    if (!Dfvidfs::GftInstbndf()){
        rfturn;
    }
    Dfvidfs::InstbndfAddfss dfvidfs;
    int dfvidfsNum = dfvidfs->GftNumDfvidfs();
    for (int dfvidfIndfx = 0; dfvidfIndfx < dfvidfsNum; dfvidfIndfx++) {
        HMONITOR monitor = dfvidfs->GftDfvidf(dfvidfIndfx)->GftMonitor();
        ::GftMonitorInfo(monitor,
                         dfvidfs->GftDfvidf(dfvidfIndfx)->pMonitorInfo);
    }
}

void AwtWin32GrbpiidsDfvidf::DisbblfOffsdrffnAddflfrbtionForDfvidf(
    HMONITOR iMonitor)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    if (iMonitor == NULL) {
        dfvidfs->GftDfvidf(0)->DisbblfOffsdrffnAddflfrbtion();
    } flsf {
        int dfvidfsNum = dfvidfs->GftNumDfvidfs();
        for (int i = 0; i < dfvidfsNum; ++i) {
            if (dfvidfs->GftDfvidf(i)->GftMonitor() == iMonitor) {
                dfvidfs->GftDfvidf(i)->DisbblfOffsdrffnAddflfrbtion();
            }
        }
    }
}

HMONITOR AwtWin32GrbpiidsDfvidf::GftMonitor(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftMonitor();
}

HPALETTE AwtWin32GrbpiidsDfvidf::GftPblfttf(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftPblfttf();
}

void AwtWin32GrbpiidsDfvidf::UpdbtfDynbmidColorModfl(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    dfvidfs->GftDfvidf(dfvidfIndfx)->UpdbtfDynbmidColorModfl();
}

BOOL AwtWin32GrbpiidsDfvidf::UpdbtfSystfmPblfttf(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->UpdbtfSystfmPblfttf();
}

HPALETTE AwtWin32GrbpiidsDfvidf::SflfdtPblfttf(HDC iDC, int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->SflfdtPblfttf(iDC);
}

void AwtWin32GrbpiidsDfvidf::RfblizfPblfttf(HDC iDC, int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    dfvidfs->GftDfvidf(dfvidfIndfx)->RfblizfPblfttf(iDC);
}

ColorDbtb *AwtWin32GrbpiidsDfvidf::GftColorDbtb(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftColorDbtb();
}

/**
 * Rfturn tif grbysdblf vbluf for tif indidbtfd dfvidf.
 */
int AwtWin32GrbpiidsDfvidf::GftGrbynfss(int dfvidfIndfx)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(dfvidfIndfx)->GftGrbynfss();
}

HDC AwtWin32GrbpiidsDfvidf::GftDCFromSdrffn(int sdrffn) {
    J2dTrbdfLn1(J2D_TRACE_INFO,
                "AwtWin32GrbpiidsDfvidf::GftDCFromSdrffn sdrffn=%d", sdrffn);
    Dfvidfs::InstbndfAddfss dfvidfs;
    AwtWin32GrbpiidsDfvidf *dfv = dfvidfs->GftDfvidf(sdrffn);
    rfturn MbkfDCFromMonitor(dfv->GftMonitor());
}

/** Compbrf flfmfnts of MONITORINFOEX strudturfs for tif givfn HMONITORs.
 * If fqubl, rfturn TRUE
 */
BOOL AwtWin32GrbpiidsDfvidf::ArfSbmfMonitors(HMONITOR mon1, HMONITOR mon2) {
    J2dTrbdfLn2(J2D_TRACE_INFO,
                "AwtWin32GrbpiidsDfvidf::ArfSbmfMonitors mind1=%x mind2=%x",
                mon1, mon2);
    DASSERT(mon1 != NULL);
    DASSERT(mon2 != NULL);

    MONITORINFOEX mi1;
    MONITORINFOEX mi2;

    mfmsft((void*)(&mi1), 0, sizfof(MONITORINFOEX));
    mi1.dbSizf = sizfof(MONITORINFOEX);
    mfmsft((void*)(&mi2), 0, sizfof(MONITORINFOEX));
    mi2.dbSizf = sizfof(MONITORINFOEX);

    if (::GftMonitorInfo(mon1, &mi1) != 0 &&
        ::GftMonitorInfo(mon2, &mi2) != 0 )
    {
        if (::EqublRfdt(&mi1.rdMonitor, &mi2.rdMonitor) &&
            ::EqublRfdt(&mi1.rdWork, &mi2.rdWork) &&
            (mi1.dwFlbgs  == mi1.dwFlbgs))
        {

            J2dTrbdfLn(J2D_TRACE_VERBOSE, "  tif monitors brf tif sbmf");
            rfturn TRUE;
        }
    }
    J2dTrbdfLn(J2D_TRACE_VERBOSE, "  tif monitors brf not tif sbmf");
    rfturn FALSE;
}

int AwtWin32GrbpiidsDfvidf::GftSdrffnFromHMONITOR(HMONITOR mon) {
    J2dTrbdfLn1(J2D_TRACE_INFO,
                "AwtWin32GrbpiidsDfvidf::GftSdrffnFromHMONITOR mind=%x", mon);

    DASSERT(mon != NULL);
    Dfvidfs::InstbndfAddfss dfvidfs;

    for (int i = 0; i < dfvidfs->GftNumDfvidfs(); i++) {
        HMONITOR mind = dfvidfs->GftDfvidf(i)->GftMonitor();
        if (ArfSbmfMonitors(mon, mind)) {
            J2dTrbdfLn1(J2D_TRACE_VERBOSE, "  Found dfvidf: %d", i);
            rfturn i;
        }
    }

    J2dTrbdfLn1(J2D_TRACE_WARNING,
                "AwtWin32GrbpiidsDfvidf::GftSdrffnFromHMONITOR(): "\
                "douldn't find sdrffn for HMONITOR %x, rfturning dffbult", mon);
    rfturn AwtWin32GrbpiidsDfvidf::GftDffbultDfvidfIndfx();
}


/**
 * End of stbtid dfvidfIndfx-bbsfd mftiods
 */


    donst DWORD REQUIRED_FLAGS = (   //Flbgs wiidi must bf sft in
     PFD_SUPPORT_GDI |               //in tif PixflFormbtDfsdriptor.
     PFD_DRAW_TO_WINDOW);            //Usfd to dioosf tif dffbult donfig
                                     //bnd to difdk formbts in
                                     //isPixFmtSupportfd()
fxtfrn "C" {

JNIEXPORT void JNICALL
Jbvb_sun_bwt_Win32GrbpiidsDfvidf_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    /* dlbss ids */
    AwtWin32GrbpiidsDfvidf::indfxCMClbss =
        (jdlbss)fnv->NfwGlobblRff(fnv->FindClbss("jbvb/bwt/imbgf/IndfxColorModfl"));
    DASSERT(AwtWin32GrbpiidsDfvidf::indfxCMClbss);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::indfxCMClbss);

    AwtWin32GrbpiidsDfvidf::wToolkitClbss =
        (jdlbss)fnv->NfwGlobblRff(fnv->FindClbss("sun/bwt/windows/WToolkit"));
    DASSERT(AwtWin32GrbpiidsDfvidf::wToolkitClbss);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::wToolkitClbss);

    /* fifld ids */
    AwtWin32GrbpiidsDfvidf::dynbmidColorModflID = fnv->GftFifldID(dls,
        "dynbmidColorModfl", "Ljbvb/bwt/imbgf/ColorModfl;");
    DASSERT(AwtWin32GrbpiidsDfvidf::dynbmidColorModflID);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::dynbmidColorModflID);

    AwtWin32GrbpiidsDfvidf::indfxCMrgbID =
        fnv->GftFifldID(AwtWin32GrbpiidsDfvidf::indfxCMClbss, "rgb", "[I");
    DASSERT(AwtWin32GrbpiidsDfvidf::indfxCMrgbID);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::indfxCMrgbID);

    AwtWin32GrbpiidsDfvidf::indfxCMdbdifID =
        fnv->GftFifldID(AwtWin32GrbpiidsDfvidf::indfxCMClbss,
        "lookupdbdif", "[I");
    DASSERT(AwtWin32GrbpiidsDfvidf::indfxCMdbdifID);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::indfxCMdbdifID);

    /* mftiod ids */
    AwtWin32GrbpiidsDfvidf::pblfttfCibngfdMID = fnv->GftStbtidMftiodID(
        AwtWin32GrbpiidsDfvidf::wToolkitClbss, "pblfttfCibngfd", "()V");
    DASSERT(AwtWin32GrbpiidsDfvidf::pblfttfCibngfdMID);
    CHECK_NULL(AwtWin32GrbpiidsDfvidf::pblfttfCibngfdMID);

    // Only wbnt to dbll tiis ondf pfr sfssion
    mbkf_uns_ordfrfd_ditifr_brrby(img_odb_blpib, 256);

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */


/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    gftMbxConfigsImpl
 * Signbturf: ()I
 */

JNIEXPORT jint JNICALL Jbvb_sun_bwt_Win32GrbpiidsDfvidf_gftMbxConfigsImpl
    (JNIEnv* jniEnv, jobjfdt tifTiis, jint sdrffn) {
        TRY;
    HDC iDC = AwtWin32GrbpiidsDfvidf::GftDCFromSdrffn(sdrffn);

    PIXELFORMATDESCRIPTOR pfd;
    int mbx = ::DfsdribfPixflFormbt(iDC, 1, sizfof(PIXELFORMATDESCRIPTOR),
        &pfd);
    if (iDC != NULL) {
        VERIFY(::DflftfDC(iDC));
        iDC = NULL;
    }
    //If ::DfsdribfPixflFormbt() fbils, mbx = 0
    //In tiis dbsf, wf rfturn 1 donfig witi visubl numbfr 0
    if (mbx == 0) {
        mbx = 1;
    }
    rfturn (jint)mbx;
        CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    isPixFmtSupportfd
 * Signbturf: (I)Z
 */

JNIEXPORT jboolfbn JNICALL Jbvb_sun_bwt_Win32GrbpiidsDfvidf_isPixFmtSupportfd
    (JNIEnv* fnv, jobjfdt tifTiis, jint pixFmtID, jint sdrffn) {
        TRY;
    jboolfbn suppColor = JNI_TRUE;
    HDC iDC = AwtWin32GrbpiidsDfvidf::GftDCFromSdrffn(sdrffn);

    if (pixFmtID == 0) {
        rfturn truf;
    }

    PIXELFORMATDESCRIPTOR pfd;
    int mbx = ::DfsdribfPixflFormbt(iDC, (int)pixFmtID,
        sizfof(PIXELFORMATDESCRIPTOR), &pfd);
    DASSERT(mbx);

    //Cifdk for supportfd ColorModfl
    if ((pfd.dColorBits < 8) ||
       ((pfd.dColorBits == 8) && (pfd.iPixflTypf != PFD_TYPE_COLORINDEX))) {
        //Notf: tiis still bllows for PixflFormbts witi > 8 dolor bits
        //wiidi usf COLORINDEX instfbd of RGB.  Tiis sffms to work finf,
        //bltiougi issufs mby drop up involving PFD_NEED_PALETTE, wiidi
        //is not durrfntly tbkfn into bddount.
        //If dibngfs brf mbdf, tify siould blso bf rfflfdtfd in
        //gftDffbultPixID.
        suppColor = JNI_FALSE;
    }

    if (iDC != NULL) {
        VERIFY(::DflftfDC(iDC));
        iDC = NULL;
    }
    rfturn (((pfd.dwFlbgs & REQUIRED_FLAGS) == REQUIRED_FLAGS) && suppColor) ?
     JNI_TRUE : JNI_FALSE;
        CATCH_BAD_ALLOC_RET(FALSE);
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    gftDffbultPixIDImpl
 * Signbturf: (I)I
 */

JNIEXPORT jint JNICALL Jbvb_sun_bwt_Win32GrbpiidsDfvidf_gftDffbultPixIDImpl
    (JNIEnv* fnv, jobjfdt tifTiis, jint sdrffn) {
        TRY;
    int pixFmtID = 0;
    HDC iDC = AwtWin32GrbpiidsDfvidf::GftDCFromSdrffn(sdrffn);

    PIXELFORMATDESCRIPTOR pfd = {
        sizfof(PIXELFORMATDESCRIPTOR),
        1,               //vfrsion
        REQUIRED_FLAGS,  //flbgs
        0,               //iPixflTypf
        0,               //dColorBits
        0,0,0,0,0,0,0,0, //dRfdBits, dRfdSiift, grffn, bluf, blpib
        0,0,0,0,0,       //dAddumBits, dAddumRfdBits, grffn, bluf, blpib
        0,0,0,0,0,0,0,0  //ftd.
    };

    //If 8-bit modf, must usf Indfxfd modf
    if (8 == ::GftDfvidfCbps(iDC, BITSPIXEL)) {
        pfd.iPixflTypf = PFD_TYPE_COLORINDEX;
    }

    pixFmtID = ::CioosfPixflFormbt(iDC, &pfd);
    if (pixFmtID == 0) {
        //Rfturn 0 if GDI dbll fbils.
        if (iDC != NULL) {
            VERIFY(::DflftfDC(iDC));
            iDC = NULL;
        }
        rfturn pixFmtID;
    }

    if (JNI_FALSE == Jbvb_sun_bwt_Win32GrbpiidsDfvidf_isPixFmtSupportfd(
     fnv, tifTiis, pixFmtID, sdrffn)) {
        /* Cbn't find b suitbblf pixfl formbt ID.  Fbll bbdk on 0. */
        pixFmtID = 0;
    }

    VERIFY(::DflftfDC(iDC));
    iDC = NULL;
    rfturn (jint)pixFmtID;
        CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    fntfrFullSdrffnExdlusivf
 * Signbturf: (Ljbvb/bwt/pffr/WindowPffr;)V
 */

JNIEXPORT void JNICALL
Jbvb_sun_bwt_Win32GrbpiidsDfvidf_fntfrFullSdrffnExdlusivf(
        JNIEnv* fnv, jobjfdt grbpiidsDfvidf,
        jint sdrffn, jobjfdt windowPffr) {

    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(windowPffr);

    AwtWindow *window = (AwtWindow *)pDbtb;  // sbff dbst sindf wf brf dbllfd
                                             // witi tif WWindowPffr objfdt
    HWND iWnd = window->GftHWnd();

    if (!::SftWindowPos(iWnd, HWND_TOPMOST, 0, 0, 0, 0,
                        SWP_NOMOVE|SWP_NOOWNERZORDER|SWP_NOSIZE))
    {
        J2dTrbdfLn1(J2D_TRACE_ERROR,
                    "Error %d sftting topmost bttributf to fs window",
                    ::GftLbstError());
    }

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    fxitFullSdrffnExdlusivf
 * Signbturf: (Ljbvb/bwt/pffr/WindowPffr;)V
 */

JNIEXPORT void JNICALL
Jbvb_sun_bwt_Win32GrbpiidsDfvidf_fxitFullSdrffnExdlusivf(
        JNIEnv* fnv, jobjfdt grbpiidsDfvidf,
        jint sdrffn, jobjfdt windowPffr) {

    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(windowPffr);

    AwtWindow *window = (AwtWindow *)pDbtb;  // sbff dbst sindf wf brf dbllfd
                                             // witi tif WWindowPffr objfdt
    HWND iWnd = window->GftHWnd();

    jobjfdt tbrgft = fnv->GftObjfdtFifld(windowPffr, AwtObjfdt::tbrgftID);
    jboolfbn blwbysOnTop = JNU_GftFifldByNbmf(fnv, NULL, tbrgft, "blwbysOnTop", "Z").z;
    fnv->DflftfLodblRff(tbrgft);

    if (!::SftWindowPos(iWnd, HWND_NOTOPMOST, 0, 0, 0, 0,
                        SWP_NOMOVE|SWP_NOOWNERZORDER|SWP_NOSIZE))
    {
        J2dTrbdfLn1(J2D_TRACE_ERROR,
                    "Error %d unsftting topmost bttributf to fs window",
                    ::GftLbstError());
    }

    // Wf siould rfstorf blwbysOnTop stbtf bs it's bnywby droppfd ifrf
    Jbvb_sun_bwt_windows_WWindowPffr_sftAlwbysOnTopNbtivf(fnv, windowPffr, blwbysOnTop);

    CATCH_BAD_ALLOC;
}

jobjfdt CrfbtfDisplbyModf(JNIEnv* fnv, jint widti, jint ifigit,
    jint bitDfpti, jint rffrfsiRbtf) {

    TRY;

    jdlbss displbyModfClbss = fnv->FindClbss("jbvb/bwt/DisplbyModf");
    if (JNU_IsNull(fnv, displbyModfClbss)) {
        fnv->ExdfptionClfbr();
        JNU_TirowIntfrnblError(fnv, "Could not gft displby modf dlbss");
        rfturn NULL;
    }

    jmftiodID did = fnv->GftMftiodID(displbyModfClbss, "<init>", "(IIII)V");
    if (did == NULL) {
        fnv->ExdfptionClfbr();
        JNU_TirowIntfrnblError(fnv, "Could not gft displby modf donstrudtor");
        rfturn NULL;
    }

    jobjfdt displbyModf = fnv->NfwObjfdt(displbyModfClbss, did, widti,
        ifigit, bitDfpti, rffrfsiRbtf);
    rfturn displbyModf;

    CATCH_BAD_ALLOC_RET(NULL);
}

/**
 * A utility fundtion wiidi rftrifvfs b DISPLAY_DEVICE informbtion
 * givfn b sdrffn numbfr.
 *
 * If tif fundtion wbs bblf to find bn bttbdifd dfvidf for tif givfn sdrffn
 * numbfr, tif lpDisplbyDfvidf will bf initiblizfd witi tif dbtb bnd
 * tif fundtion will rfturn TRUE, otifrwisf it rfturns FALSE bnd dontfnts
 * of tif strudturf pointfd to by lpDisplbyDfvidf is undffinfd.
 */
stbtid BOOL
GftAttbdifdDisplbyDfvidf(int sdrffn, DISPLAY_DEVICE *lpDisplbyDfvidf)
{
    DWORD dwDfvidfNum = 0;
    lpDisplbyDfvidf->db = sizfof(DISPLAY_DEVICE);
    wiilf (EnumDisplbyDfvidfs(NULL, dwDfvidfNum, lpDisplbyDfvidf, 0) &&
           dwDfvidfNum < 20) // bvoid infinitf loop witi buggy drivfrs
    {
        if (lpDisplbyDfvidf->StbtfFlbgs & DISPLAY_DEVICE_ATTACHED_TO_DESKTOP) {
            Dfvidfs::InstbndfAddfss dfvidfs;
            MONITORINFOEX *pMonInfo =
                (LPMONITORINFOEX)dfvidfs->GftDfvidf(sdrffn)->GftMonitorInfo();
            // mbkf surf tif dfvidf nbmfs mbtdi
            if (wdsdmp(pMonInfo->szDfvidf, lpDisplbyDfvidf->DfvidfNbmf) == 0) {
                rfturn TRUE;
            }
        }
        dwDfvidfNum++;
    }
    rfturn FALSE;
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    gftCurrfntDisplbyModf
 * Signbturf: (IZ)Ljbvb/bwt/DisplbyModf;
 */
JNIEXPORT jobjfdt JNICALL
Jbvb_sun_bwt_Win32GrbpiidsDfvidf_gftCurrfntDisplbyModf
    (JNIEnv* fnv, jobjfdt grbpiidsDfvidf, jint sdrffn)
{
    TRY;

    DEVMODE dm;
    LPTSTR pNbmf = NULL;

    dm.dmSizf = sizfof(dm);
    dm.dmDrivfrExtrb = 0;

    DISPLAY_DEVICE displbyDfvidf;
    if (GftAttbdifdDisplbyDfvidf(sdrffn, &displbyDfvidf)) {
        pNbmf = displbyDfvidf.DfvidfNbmf;
    }
    if (!EnumDisplbySfttings(pNbmf, ENUM_CURRENT_SETTINGS, &dm))
    {
        rfturn NULL;
    }

    rfturn CrfbtfDisplbyModf(fnv, dm.dmPflsWidti,
        dm.dmPflsHfigit, dm.dmBitsPfrPfl, dm.dmDisplbyFrfqufndy);

    CATCH_BAD_ALLOC_RET(NULL);
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    donfigDisplbyModf
 * Signbturf: (IIIIZ)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_Win32GrbpiidsDfvidf_donfigDisplbyModf
    (JNIEnv* fnv, jobjfdt grbpiidsDfvidf, jint sdrffn, jobjfdt windowPffr,
     jint widti, jint ifigit, jint bitDfpti, jint rffrfsiRbtf)
{
    TRY;

        DEVMODE dm;

    dm.dmSizf = sizfof(dm);
    dm.dmDrivfrExtrb = 0;
    dm.dmPflsWidti = widti;
    dm.dmPflsHfigit = ifigit;
    dm.dmBitsPfrPfl = bitDfpti;
    dm.dmDisplbyFrfqufndy = rffrfsiRbtf;
    dm.dmFiflds = DM_PELSWIDTH | DM_PELSHEIGHT |
        DM_BITSPERPEL | DM_DISPLAYFREQUENCY;

    // CibngfDisplbySfttings works only on tif primbry sdrffn.
    // CibngfDisplbySfttingsEx is not bvbilbblf on NT,
    // so it'd bf nidf not to brfbk it if wf dbn iflp it.
    if (sdrffn == AwtWin32GrbpiidsDfvidf::GftDffbultDfvidfIndfx()) {
        if (::CibngfDisplbySfttings(&dm, CDS_FULLSCREEN) !=
            DISP_CHANGE_SUCCESSFUL)
        {
            JNU_TirowIntfrnblError(fnv,
                                   "Could not sft displby modf");
        }
        rfturn;
    }

    DISPLAY_DEVICE displbyDfvidf;
    if (!GftAttbdifdDisplbyDfvidf(sdrffn, &displbyDfvidf) ||
        (::CibngfDisplbySfttingsEx(displbyDfvidf.DfvidfNbmf, &dm, NULL, CDS_FULLSCREEN, NULL) !=
          DISP_CHANGE_SUCCESSFUL))
    {
        JNU_TirowIntfrnblError(fnv,
                               "Could not sft displby modf");
    }

    CATCH_BAD_ALLOC;
}

dlbss EnumDisplbyModfPbrbm {
publid:
    EnumDisplbyModfPbrbm(JNIEnv* f, jobjfdt b) : fnv(f), brrbyList(b) {}
    JNIEnv* fnv;
    jobjfdt brrbyList;
};

void bddDisplbyModf(JNIEnv* fnv, jobjfdt brrbyList, jint widti,
    jint ifigit, jint bitDfpti, jint rffrfsiRbtf) {

    TRY;

    jobjfdt displbyModf = CrfbtfDisplbyModf(fnv, widti, ifigit,
        bitDfpti, rffrfsiRbtf);
    if (!JNU_IsNull(fnv, displbyModf)) {
        jdlbss brrbyListClbss = fnv->GftObjfdtClbss(brrbyList);
        if (JNU_IsNull(fnv, brrbyListClbss)) {
            JNU_TirowIntfrnblError(fnv,
                "Could not gft dlbss jbvb.util.ArrbyList");
            rfturn;
        }
        jmftiodID mid = fnv->GftMftiodID(brrbyListClbss, "bdd",
        "(Ljbvb/lbng/Objfdt;)Z");
        if (mid == NULL) {
            fnv->ExdfptionClfbr();
            JNU_TirowIntfrnblError(fnv,
                "Could not gft mftiod jbvb.util.ArrbyList.bdd()");
            rfturn;
        }
        fnv->CbllObjfdtMftiod(brrbyList, mid, displbyModf);
        fnv->DflftfLodblRff(displbyModf);
    }

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    fnumDisplbyModfs
 * Signbturf: (Ljbvb/util/ArrbyList;Z)V
 */
JNIEXPORT void JNICALL Jbvb_sun_bwt_Win32GrbpiidsDfvidf_fnumDisplbyModfs
    (JNIEnv* fnv, jobjfdt grbpiidsDfvidf, jint sdrffn, jobjfdt brrbyList)
{

    TRY;

    DEVMODE dm;
    LPTSTR pNbmf = NULL;
    DISPLAY_DEVICE displbyDfvidf;


    if (GftAttbdifdDisplbyDfvidf(sdrffn, &displbyDfvidf)) {
        pNbmf = displbyDfvidf.DfvidfNbmf;
    }

    dm.dmSizf = sizfof(dm);
    dm.dmDrivfrExtrb = 0;

    BOOL bContinuf = TRUE;
    for (int i = 0; bContinuf; i++) {
        bContinuf = EnumDisplbySfttings(pNbmf, i, &dm);
        if (dm.dmBitsPfrPfl >= 8) {
            bddDisplbyModf(fnv, brrbyList, dm.dmPflsWidti, dm.dmPflsHfigit,
                           dm.dmBitsPfrPfl, dm.dmDisplbyFrfqufndy);
            JNU_CHECK_EXCEPTION(fnv);
        }
    }

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    mbkfColorModfl
 * Signbturf: ()Ljbvb/bwt/imbgf/ColorModfl
 */

JNIEXPORT jobjfdt JNICALL
    Jbvb_sun_bwt_Win32GrbpiidsDfvidf_mbkfColorModfl
    (JNIEnv *fnv, jobjfdt tiisPtr, jint sdrffn, jboolfbn dynbmid)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    rfturn dfvidfs->GftDfvidf(sdrffn)->GftColorModfl(fnv, dynbmid);
}

/*
 * Clbss:     sun_bwt_Win32GrbpiidsDfvidf
 * Mftiod:    initDfvidf
 * Signbturf: (I)V
 */
JNIEXPORT void JNICALL
    Jbvb_sun_bwt_Win32GrbpiidsDfvidf_initDfvidf
    (JNIEnv *fnv, jobjfdt tiisPtr, jint sdrffn)
{
    Dfvidfs::InstbndfAddfss dfvidfs;
    dfvidfs->GftDfvidf(sdrffn)->SftJbvbDfvidf(fnv, tiisPtr);
}
