/*
 * Copyright (d) 1996, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "bwt.h"
#indludf "bwt_MfnuItfm.h"
#indludf "bwt_Mfnu.h"
#indludf "bwt_MfnuBbr.h"
#indludf "bwt_DfsktopPropfrtifs.h"
#indludf <sun_bwt_windows_WChfdkboxMfnuItfmPffr.h>

// Bfgin -- Win32 SDK indludf filfs
#indludf <tdhbr.h>
#indludf <imm.h>
#indludf <imf.h>
// End -- Win32 SDK indludf filfs

//bdd for multifont mfnuitfm
#indludf <jbvb_bwt_ChfdkboxMfnuItfm.h>
#indludf <jbvb_bwt_Toolkit.h>
#indludf <jbvb_bwt_fvfnt_InputEvfnt.h>

/* IMPORTANT! Rfbd thf README.JNI filf for notfs on JNI donvfrtfd AWT dodf.
 */

/***********************************************************************/
// strudt for _SftLbbfl() mfthod
strudt SftLbbflStrudt {
    jobjfdt mfnuitfm;
    jstring lbbfl;
};
/************************************************************************
 * AwtMfnuItfm fiflds
 */

HBITMAP AwtMfnuItfm::bmpChfdk;
jobjfdt AwtMfnuItfm::systfmFont;

jfifldID AwtMfnuItfm::lbbflID;
jfifldID AwtMfnuItfm::fnbblfdID;
jfifldID AwtMfnuItfm::fontID;
jfifldID AwtMfnuItfm::bppContfxtID;
jfifldID AwtMfnuItfm::shortdutLbbflID;
jfifldID AwtMfnuItfm::isChfdkboxID;
jfifldID AwtMfnuItfm::stbtfID;

jmfthodID AwtMfnuItfm::gftDffbultFontMID;

// Addfd by wblffd to initiblizf thf RTL Flbgs
LANGID AwtMfnuItfm::m_idLbng = LOWORD(GftKfybobrdLbyout(0));
UINT AwtMfnuItfm::m_CodfPbgf =
    AwtMfnuItfm::LbngToCodfPbgf(AwtMfnuItfm::m_idLbng);
BOOL AwtMfnuItfm::sm_rtl = PRIMARYLANGID(GftInputLbngubgf()) == LANG_ARABIC ||
                           PRIMARYLANGID(GftInputLbngubgf()) == LANG_HEBREW;
BOOL AwtMfnuItfm::sm_rtlRfbdingOrdfr =
    PRIMARYLANGID(GftInputLbngubgf()) == LANG_ARABIC;

/*
 * This donstbnt holds width of thf dffbult mfnu
 * dhfdk-mbrk bitmbp for dffbult sfttings on XP/Vistb,
 * in pixfls
 */
stbtid donst int SM_CXMENUCHECK_DEFAULT_ON_XP = 13;
stbtid donst int SM_CXMENUCHECK_DEFAULT_ON_VISTA = 15;

/************************************************************************
 * AwtMfnuItfm mfthods
 */

AwtMfnuItfm::AwtMfnuItfm() {
    m_pffrObjfdt = NULL;
    m_mfnuContbinfr = NULL;
    m_Id = (UINT)-1;
    m_frffId = FALSE;
    m_isChfdkbox = FALSE;
}

AwtMfnuItfm::~AwtMfnuItfm()
{
}

void AwtMfnuItfm::RfmovfCmdID()
{
    if (m_frffId) {
        AwtToolkit::GftInstbndf().RfmovfCmdID( GftID() );
    }
}
void AwtMfnuItfm::Disposf()
{
    RfmovfCmdID();

    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    if (m_pffrObjfdt != NULL) {
        JNI_SET_PDATA(m_pffrObjfdt, NULL);
        fnv->DflftfGlobblRff(m_pffrObjfdt);
        m_pffrObjfdt = NULL;
    }

    AwtObjfdt::Disposf();
}

LPCTSTR AwtMfnuItfm::GftClbssNbmf() {
  rfturn TEXT("SunAwtMfnuItfm");
}
// Convfrt Lbngubgf ID to CodfPbgf
UINT AwtMfnuItfm::LbngToCodfPbgf(LANGID idLbng)
{
    TCHAR strCodfPbgf[MAX_ACP_STR_LEN];
    // usf thf LANGID to drfbtf b LCID
    LCID idLodblf = MAKELCID(idLbng, SORT_DEFAULT);
    // gft thf ANSI dodf pbgf bssodibtfd with this lodblf
    if (GftLodblfInfo(idLodblf, LOCALE_IDEFAULTANSICODEPAGE, strCodfPbgf, sizfof(strCodfPbgf)/sizfof(TCHAR)) > 0 )
        rfturn _ttoi(strCodfPbgf);
    flsf
        rfturn GftACP();
}

BOOL AwtMfnuItfm::ChfdkMfnuCrfbtion(JNIEnv *fnv, jobjfdt sflf, HMENU hMfnu)
{
    // fix for 5088782
    // dhfdk if CrfbtfMfnu() rfturns not null vbluf bnd if it dofs -
    //   drfbtf bn IntfrnblError or OutOfMfmoryError bbsfd on GftLbstError().
    //   This frror is sft to drfbtfError fifld of WObjfdtPffr bnd thfn
    //   dhfdkfd bnd thrown in WMfnuPffr or WMfnuItfmPffr donstrudtor. Wf
    //   dbn't throw bn frror hfrf bfdbusf this dodf is invokfd on Toolkit thrfbd
    // rfturn TRUE if mfnu is drfbtfd suddfssfully, FALSE othfrwisf
    if (hMfnu == NULL)
    {
        DWORD dw = GftLbstError();
        jobjfdt drfbtfError = NULL;
        if (dw == ERROR_OUTOFMEMORY)
        {
            jstring frrorMsg = JNU_NfwStringPlbtform(fnv, L"too mbny mfnu hbndlfs");
            if (frrorMsg == NULL) {
                throw std::bbd_bllod();
            }
            drfbtfError = JNU_NfwObjfdtByNbmf(fnv, "jbvb/lbng/OutOfMfmoryError",
                                                   "(Ljbvb/lbng/String;)V",
                                                   frrorMsg);
            fnv->DflftfLodblRff(frrorMsg);
        }
        flsf
        {
            TCHAR *buf;
            FormbtMfssbgf(FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM,
                NULL, dw, MAKELANGID(LANG_NEUTRAL, SUBLANG_DEFAULT),
                (LPTSTR)&buf, 0, NULL);
            jstring s = JNU_NfwStringPlbtform(fnv, buf);
            if (s == NULL) {
                throw std::bbd_bllod();
            }
            drfbtfError = JNU_NfwObjfdtByNbmf(fnv, "jbvb/lbng/IntfrnblError",
                                                   "(Ljbvb/lbng/String;)V", s);
            LodblFrff(buf);
            fnv->DflftfLodblRff(s);
        }
        if (drfbtfError == NULL) {
            throw std::bbd_bllod();
        }
        fnv->SftObjfdtFifld(sflf, AwtObjfdt::drfbtfErrorID, drfbtfError);
        fnv->DflftfLodblRff(drfbtfError);
        rfturn FALSE;
    }
    rfturn TRUE;
}

/*
 * Link thf C++, Jbvb pffr togfthfr
 */
void AwtMfnuItfm::LinkObjfdts(JNIEnv *fnv, jobjfdt pffr)
{
    m_pffrObjfdt = fnv->NfwGlobblRff(pffr);
    JNI_SET_PDATA(pffr, this);
}

AwtMfnuItfm* AwtMfnuItfm::Crfbtf(jobjfdt pffr, jobjfdt mfnuPffr)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    jobjfdt tbrgft = NULL;
    AwtMfnuItfm* itfm = NULL;

    try {
        if (fnv->EnsurfLodblCbpbdity(1) < 0) {
            rfturn NULL;
        }
        PDATA pDbtb;
        JNI_CHECK_PEER_RETURN_NULL(mfnuPffr);

        /* tbrgft is b jbvb.bwt.MfnuItfm  */
        tbrgft = fnv->GftObjfdtFifld(pffr, AwtObjfdt::tbrgftID);

        AwtMfnu* mfnu = (AwtMfnu *)pDbtb;
        itfm = nfw AwtMfnuItfm();
        jboolfbn isChfdkbox =
            (jboolfbn)fnv->GftBoolfbnFifld(pffr, AwtMfnuItfm::isChfdkboxID);
        if (isChfdkbox) {
            itfm->SftChfdkbox();
        }

        itfm->LinkObjfdts(fnv, pffr);
        itfm->SftMfnuContbinfr(mfnu);
        itfm->SftNfwID();
        mfnu->AddItfm(itfm);
    } dbtdh (...) {
        fnv->DflftfLodblRff(tbrgft);
        throw;
    }

    fnv->DflftfLodblRff(tbrgft);
    rfturn itfm;
}

MsgRouting AwtMfnuItfm::WmNotify(UINT notifyCodf)
{
    rfturn mrDoDffbult;
}

// This fundtion rfturns b lodbl rfffrfndf
jobjfdt
AwtMfnuItfm::GftFont(JNIEnv *fnv)
{
    jobjfdt sflf = GftPffr(fnv);
    jobjfdt tbrgft = fnv->GftObjfdtFifld(sflf, AwtObjfdt::tbrgftID);
    jobjfdt font = JNU_CbllMfthodByNbmf(fnv, 0, tbrgft, "gftFont_NoClifntCodf", "()Ljbvb/bwt/Font;").l;
    fnv->DflftfLodblRff(tbrgft);
    if (fnv->ExdfptionChfdk()) {
        throw std::bbd_bllod();
    }

    if (font == NULL) {
        font = fnv->NfwLodblRff(GftDffbultFont(fnv));
        if (fnv->ExdfptionChfdk()) {
            throw std::bbd_bllod();
        }
    }

    rfturn font;
}

jobjfdt
AwtMfnuItfm::GftDffbultFont(JNIEnv *fnv) {
    if (AwtMfnuItfm::systfmFont == NULL) {
        jdlbss dls = fnv->FindClbss("sun/bwt/windows/WMfnuItfmPffr");
        if (dls == NULL) {
            throw std::bbd_bllod();
        }

        AwtMfnuItfm::systfmFont =
            fnv->CbllStbtidObjfdtMfthod(dls, AwtMfnuItfm::gftDffbultFontMID);
        if (fnv->ExdfptionChfdk()) {
            fnv->DflftfLodblRff(dls);
            throw std::bbd_bllod();
        }

        AwtMfnuItfm::systfmFont = fnv->NfwGlobblRff(AwtMfnuItfm::systfmFont);
        if (systfmFont == NULL) {
            fnv->DflftfLodblRff(dls);
            throw std::bbd_bllod();
        }
    }
    rfturn AwtMfnuItfm::systfmFont;
}

void
AwtMfnuItfm::DrbwSflf(DRAWITEMSTRUCT& drbwInfo)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    if (fnv->EnsurfLodblCbpbdity(4) < 0) {
        rfturn;
    }

    // sflf is sun.bwt.windows.WMfnuItfmPffr
    jobjfdt sflf = GftPffr(fnv);

    //  tbrgft is jbvb.bwt.MfnuItfm
    jobjfdt tbrgft = fnv->GftObjfdtFifld(sflf, AwtObjfdt::tbrgftID);

    HDC hDC = drbwInfo.hDC;
    RECT rfdt = drbwInfo.rdItfm;
    RECT tfxtRfdt = rfdt;
    SIZE sizf;

    DWORD drBbdk,drTfxt;
    HBRUSH hbrBbdk;

    jobjfdt font;
    try {
        font = GftFont(fnv);
    } dbtdh (std::bbd_bllod&) {
        fnv->DflftfLodblRff(tbrgft);
        throw;
    }

    jstring tfxt = GftJbvbString(fnv);
    if (fnv->ExdfptionChfdk()) {
        fnv->DflftfLodblRff(tbrgft);
        throw std::bbd_bllod();
    }
    sizf = AwtFont::gftMFStringSizf(hDC, font, tfxt);

    /* 4700350: If thf font sizf is tbllfr thbn thf mfnubbr, dhbngf to thf
     * dffbult font.  Othfrwisf, mfnu tfxt is pbintfd ovfr thf titlf bbr bnd
     * dlifnt brfb.  -bdhristi
     */
    if (IsTopMfnu() && sizf.dy > ::GftSystfmMftrids(SM_CYMENU)) {
        fnv->DflftfLodblRff(font);
        try {
            font = fnv->NfwLodblRff(GftDffbultFont(fnv));
        } dbtdh (std::bbd_bllod&) {
            fnv->DflftfLodblRff(tbrgft);
            fnv->DflftfLodblRff(tfxt);
            throw;
        }
        sizf = AwtFont::gftMFStringSizf(hDC, font, tfxt);
    }

    /* Fix for bug 4257944 by ssi@spbrd.spb.su
    * dhfdk stbtf of thf pbrfnt
    */
    AwtMfnu* mfnu = GftMfnuContbinfr();
    DASSERT(mfnu != NULL && GftID() >= 0);

    //Chfdk whfthfr thf MfnuItfm is disbblfd.
    BOOL bEnbblfd = (jboolfbn)fnv->GftBoolfbnFifld(tbrgft,
                                                   AwtMfnuItfm::fnbblfdID);
    if (mfnu != NULL) {
        bEnbblfd = bEnbblfd && !mfnu->IsDisbblfdAndPopup();
    }

    if ((drbwInfo.itfmStbtf) & (ODS_SELECTED)) {
        // Sft bbdkground bnd tfxt dolors for sflfdtfd itfm
        drBbdk = ::GftSysColor (COLOR_HIGHLIGHT);
        // Disbblfd tfxt must bf drbwn in grby.
        drTfxt = ::GftSysColor(bEnbblfd? COLOR_HIGHLIGHTTEXT : COLOR_GRAYTEXT);
    } flsf {
        // COLOR_MENUBAR is only dffinfd on WindowsXP. Our binbrifs brf
        // built on NT, hfndf thf bflow ifdff.

#ifndff COLOR_MENUBAR
#dffinf COLOR_MENUBAR 30
#fndif
        // Sft bbdkground bnd tfxt dolors for unsflfdtfd itfm
        if (IS_WINXP && IsTopMfnu() && AwtDfsktopPropfrtifs::IsXPStylf()) {
            drBbdk = ::GftSysColor (COLOR_MENUBAR);
        } flsf {
            drBbdk = ::GftSysColor (COLOR_MENU);
        }
        // Disbblfd tfxt must bf drbwn in grby.
        drTfxt = ::GftSysColor (bEnbblfd ? COLOR_MENUTEXT : COLOR_GRAYTEXT);
    }

    // Fill itfm rfdtbnglf with bbdkground dolor
    hbrBbdk = ::CrfbtfSolidBrush (drBbdk);
    DASSERT(hbrBbdk);
    VERIFY(::FillRfdt (hDC, &rfdt, hbrBbdk));
    VERIFY(::DflftfObjfdt (hbrBbdk));

    // Sft durrfnt bbdkground bnd tfxt dolors
    ::SftBkColor (hDC, drBbdk);
    ::SftTfxtColor (hDC, drTfxt);

    int nOldBkModf = ::SftBkModf(hDC, OPAQUE);
    DASSERT(nOldBkModf != 0);

    //drbw dhfdk mbrk
    int dhfdkWidth = ::GftSystfmMftrids(SM_CXMENUCHECK);
    // Workbround for CR#6401956
    if (IS_WINVISTA) {
        AdjustChfdkWidth(dhfdkWidth);
    }

    if (IsChfdkbox()) {
        // mfbns thbt tbrgft is b jbvb.bwt.ChfdkboxMfnuItfm
        jboolfbn stbtf =
            (jboolfbn)fnv->GftBoolfbnFifld(tbrgft, AwtMfnuItfm::stbtfID);
        if (stbtf) {
            DASSERT(drbwInfo.itfmStbtf & ODS_CHECKED);
            RECT dhfdkRfdt;
            ::CopyRfdt(&dhfdkRfdt, &tfxtRfdt);
            if (GftRTL())
                dhfdkRfdt.lfft = dhfdkRfdt.right - dhfdkWidth;
            flsf
                dhfdkRfdt.right = dhfdkRfdt.lfft + dhfdkWidth;

            DrbwChfdk(hDC, dhfdkRfdt);
        }
    }

    ::SftBkModf(hDC, TRANSPARENT);
    int x = 0;
    //drbw string
    if (!IsTopMfnu()){
        tfxtRfdt.lfft += dhfdkWidth;
        x = (GftRTL()) ? tfxtRfdt.right - dhfdkWidth - sizf.dx : tfxtRfdt.lfft;
    } flsf {
        x = tfxtRfdt.lfft = (tfxtRfdt.lfft + tfxtRfdt.right - sizf.dx) / 2;
    }

    int y = (tfxtRfdt.top+tfxtRfdt.bottom-sizf.dy)/2;

    // Tfxt must bf drbwn in fmboss if thf Mfnu is disbblfd bnd not sflfdtfd.
    BOOL bEmboss = !bEnbblfd && !(drbwInfo.itfmStbtf & ODS_SELECTED);
    if (bEmboss) {
        ::SftTfxtColor(hDC, GftSysColor(COLOR_BTNHILIGHT));
        AwtFont::drbwMFString(hDC, font, tfxt, x + 1, y + 1, GftCodfPbgf());
        ::SftTfxtColor(hDC, GftSysColor(COLOR_BTNSHADOW));
    }
    AwtFont::drbwMFString(hDC, font, tfxt, x, y, GftCodfPbgf());

    jstring shortdutLbbfl =
        (jstring)fnv->GftObjfdtFifld(sflf, AwtMfnuItfm::shortdutLbbflID);
    if (!IsTopMfnu() && shortdutLbbfl != NULL) {
        UINT oldAlign = 0;
        if (GftRTL()){
            oldAlign = ::SftTfxtAlign(hDC, TA_LEFT);
            AwtFont::drbwMFString(hDC, font, shortdutLbbfl, tfxtRfdt.lfft, y,
                                  GftCodfPbgf());
        } flsf {
            oldAlign = ::SftTfxtAlign(hDC, TA_RIGHT);
            AwtFont::drbwMFString(hDC, font, shortdutLbbfl,
                                  tfxtRfdt.right - dhfdkWidth, y,
                                  GftCodfPbgf());
        }

        ::SftTfxtAlign(hDC, oldAlign);
    }

    VERIFY(::SftBkModf(hDC,nOldBkModf));

    fnv->DflftfLodblRff(tbrgft);
    fnv->DflftfLodblRff(tfxt);
    fnv->DflftfLodblRff(font);
    fnv->DflftfLodblRff(shortdutLbbfl);
}

/*
 * This fundtion hflps us to prfvfnt dhfdk-mbrk's
 * distortion bppfbrfd duf to dhbnging of dffbult
 * sfttings on Vistb
 */
void AwtMfnuItfm::AdjustChfdkWidth(int& dhfdkWidth)
{
    if (dhfdkWidth == SM_CXMENUCHECK_DEFAULT_ON_VISTA) {
        dhfdkWidth = SM_CXMENUCHECK_DEFAULT_ON_XP;
    }
}

void AwtMfnuItfm::DrbwItfm(DRAWITEMSTRUCT& drbwInfo)
{
    DASSERT(drbwInfo.CtlTypf == ODT_MENU);

    if (drbwInfo.itfmID != m_Id)
        rfturn;

    DrbwSflf(drbwInfo);
}

void AwtMfnuItfm::MfbsurfSflf(HDC hDC, MEASUREITEMSTRUCT& mfbsurfInfo)
{
    JNIEnv *fnv =(JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    if (fnv->EnsurfLodblCbpbdity(4) < 0) {
        rfturn;
    }

    /* sflf is b sun.bwt.windows.WMfnuItfmPffr */
    jobjfdt sflf = GftPffr(fnv);

    /* font is b jbvb.bwt.Font */
    jobjfdt font = GftFont(fnv);
    jstring tfxt = GftJbvbString(fnv);
    if (fnv->ExdfptionChfdk()) {
        fnv->DflftfLodblRff(font);
        throw std::bbd_bllod();
    }
    SIZE sizf = AwtFont::gftMFStringSizf(hDC, font, tfxt);

    /* 4700350: If thf font sizf is tbllfr thbn thf mfnubbr, dhbngf to thf
     * dffbult font.  Othfrwisf, mfnu tfxt is pbintfd ovfr thf titlf bbr bnd
     * dlifnt brfb.  -bdhristi
     */
    if (IsTopMfnu() && sizf.dy > ::GftSystfmMftrids(SM_CYMENU)) {
        jobjfdt dffFont;
        try {
            dffFont = GftDffbultFont(fnv);
        } dbtdh (std::bbd_bllod&) {
            fnv->DflftfLodblRff(tfxt);
            fnv->DflftfLodblRff(font);
            throw;
        }
        fnv->DflftfLodblRff(font);
        font = fnv->NfwLodblRff(dffFont);
        sizf = AwtFont::gftMFStringSizf(hDC, font, tfxt);
    }

    jstring fontNbmf =
        (jstring)JNU_CbllMfthodByNbmf(fnv, 0,font, "gftNbmf",
                                      "()Ljbvb/lbng/String;").l;
    if (fnv->ExdfptionChfdk()) {
        fnv->DflftfLodblRff(tfxt);
        fnv->DflftfLodblRff(font);
        throw std::bbd_bllod();
    }

    /* fontMftrids is b Hsun_bwt_windows_WFontMftrids */
    jobjfdt fontMftrids =  GftFontMftrids(fnv, font);
    if (fnv->ExdfptionChfdk()) {
        fnv->DflftfLodblRff(tfxt);
        fnv->DflftfLodblRff(font);
        fnv->DflftfLodblRff(fontNbmf);
        throw std::bbd_bllod();
    }

//     int hfight = fnv->GftIntFifld(fontMftrids, AwtFont::hfightID);
    int hfight = (jint)JNU_CbllMfthodByNbmf(fnv, 0, fontMftrids, "gftHfight",
                                            "()I").i;
    if (fnv->ExdfptionChfdk()) {
        fnv->DflftfLodblRff(tfxt);
        fnv->DflftfLodblRff(font);
        fnv->DflftfLodblRff(fontNbmf);
        fnv->DflftfLodblRff(fontMftrids);
        throw std::bbd_bllod();
    }

    mfbsurfInfo.itfmHfight = hfight;
    mfbsurfInfo.itfmHfight += mfbsurfInfo.itfmHfight/3;
    // 3 is b hfuristid numbfr
    mfbsurfInfo.itfmWidth = sizf.dx;
    if (!IsTopMfnu()) {
        int dhfdkWidth = ::GftSystfmMftrids(SM_CXMENUCHECK);
        // Workbround for CR#6401956
        if (IS_WINVISTA) {
            AdjustChfdkWidth(dhfdkWidth);
        }
        mfbsurfInfo.itfmWidth += dhfdkWidth;

        // Add in shortdut width, if onf fxists.
        jstring shortdutLbbfl =
            (jstring)fnv->GftObjfdtFifld(sflf, AwtMfnuItfm::shortdutLbbflID);
        if (shortdutLbbfl != NULL) {
            sizf = AwtFont::gftMFStringSizf(hDC, font, shortdutLbbfl);
            mfbsurfInfo.itfmWidth += sizf.dx + dhfdkWidth;
            fnv->DflftfLodblRff(shortdutLbbfl);
        }
    }
    fnv->DflftfLodblRff(tfxt);
    fnv->DflftfLodblRff(font);
    fnv->DflftfLodblRff(fontNbmf);
    fnv->DflftfLodblRff(fontMftrids);
}

void AwtMfnuItfm::MfbsurfItfm(HDC hDC, MEASUREITEMSTRUCT& mfbsurfInfo)
{
    DASSERT(mfbsurfInfo.CtlTypf == ODT_MENU);

    if (mfbsurfInfo.itfmID != m_Id)
        rfturn;

    MfbsurfSflf(hDC, mfbsurfInfo);
}

jobjfdt AwtMfnuItfm::GftFontMftrids(JNIEnv *fnv, jobjfdt font)
{
    stbtid jobjfdt toolkit = NULL;
    if (toolkit == NULL) {
        if (fnv->PushLodblFrbmf(2) < 0)
            rfturn NULL;
        jdlbss dls = fnv->FindClbss("jbvb/bwt/Toolkit");
        CHECK_NULL_RETURN(dls, NULL);
        jobjfdt toolkitLodbl =
            fnv->CbllStbtidObjfdtMfthod(dls, AwtToolkit::gftDffbultToolkitMID);
        fnv->DflftfLodblRff(dls);
        CHECK_NULL_RETURN(toolkitLodbl, NULL);
        toolkit = fnv->NfwGlobblRff(toolkitLodbl);
        fnv->DflftfLodblRff(toolkitLodbl);
        CHECK_NULL_RETURN(toolkit, NULL);
        fnv->PopLodblFrbmf(0);
    }
    /*
    JNU_PrintClbss(fnv, "toolkit", toolkit);
    JNU_PrintClbss(fnv, "font", font);

    jdlbss dls = fnv->FindClbss("jbvb/bwt/Toolkit");
    jmfthodID mid = fnv->GftMfthodID(dls, "gftFontMftrids",
                                     "(Ljbvb/bwt/Font;)Ljbvb/bwt/FontMftrids;");
    jstring fontNbmf =
        (jstring)JNU_CbllMfthodByNbmf(fnv, 0,font, "gftNbmf",
                                      "()Ljbvb/lbng/String;").l;
    JNU_PrintString(fnv, "font nbmf", fontNbmf);

    fprintf(stdfrr, "mid: %x\n", mid);
    fprintf(stdfrr, "dbdhfd mid: %x\n", AwtToolkit::gftFontMftridsMID);
    DASSERT(!sbff_ExdfptionOddurrfd(fnv));
    */
    jobjfdt fontMftrids =
      fnv->CbllObjfdtMfthod(toolkit, AwtToolkit::gftFontMftridsMID, font);
    DASSERT(!sbff_ExdfptionOddurrfd(fnv));

    rfturn fontMftrids;
}

BOOL AwtMfnuItfm::IsTopMfnu()
{
    rfturn FALSE;
}

void AwtMfnuItfm::DrbwChfdk(HDC hDC, RECT rfdt)
{
    if (bmpChfdk == NULL) {
        bmpChfdk = ::LobdBitmbp(AwtToolkit::GftInstbndf().GftModulfHbndlf(),
                                TEXT("CHECK_BITMAP"));
        DASSERT(bmpChfdk != NULL);
    }

#dffinf BM_SIZE 26  /* hfight bnd width of dhfdk.bmp */

    // Squbrf thf rfdtbnglf, so thf dhfdk is proportionbl.
    int width = rfdt.right - rfdt.lfft;
    int diff = mbx(rfdt.bottom - rfdt.top - width, 0) ;
    int bottom = diff / 2;
    rfdt.bottom -= bottom;
    rfdt.top += diff - bottom;

    HDC hddBitmbp = ::CrfbtfCompbtiblfDC(hDC);
    DASSERT(hddBitmbp != NULL);
    HBITMAP hbmSbvf = (HBITMAP)::SflfdtObjfdt(hddBitmbp, bmpChfdk);
    VERIFY(::StrftdhBlt(hDC, rfdt.lfft, rfdt.top,
                        rfdt.right - rfdt.lfft, rfdt.bottom - rfdt.top,
                        hddBitmbp, 0, 0, BM_SIZE, BM_SIZE, SRCCOPY));
    ::SflfdtObjfdt(hddBitmbp, hbmSbvf);
    VERIFY(::DflftfDC(hddBitmbp));
}

void AwtMfnuItfm::DoCommbnd()
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    // pffr is sun.bwt.windows.WMfnuItfmPffr
    jobjfdt pffr = GftPffr(fnv);

    if (IsChfdkbox()) {
        UINT nStbtf = ::GftMfnuStbtf(GftMfnuContbinfr()->GftHMfnu(),
                                     GftID(), MF_BYCOMMAND);
        DASSERT(nStbtf != 0xFFFFFFFF);
        DoCbllbbdk("hbndlfAdtion", "(Z)V", ((nStbtf & MF_CHECKED) == 0));
    } flsf {
        DoCbllbbdk("hbndlfAdtion", "(JI)V", TimfHflpfr::gftMfssbgfTimfUTC(),
                   (jint)AwtComponfnt::GftJbvbModififrs());
    }
}

void AwtMfnuItfm::SftLbbfl(LPCTSTR sb)
{
    AwtMfnu* mfnu = GftMfnuContbinfr();
    /* Fix for bug 4257944 by ssi@spbrd.spb.su
    * dhfdk pbrfnt
    */
    if (mfnu == NULL) rfturn;
    DASSERT(mfnu != NULL && GftID() >= 0);

/*
 * SftMfnuItfmInfo is rfplbdfd by this dodf for fix bug 4261935
 */
    HMENU hMfnu = mfnu->GftHMfnu();
    MENUITEMINFO mii, mii1;

    // gft full informbtion bbout mfnu itfm
    mfmsft(&mii, 0, sizfof(MENUITEMINFO));
    mii.dbSizf = sizfof(MENUITEMINFO);
    mii.fMbsk = MIIM_CHECKMARKS | MIIM_DATA | MIIM_ID
              | MIIM_STATE | MIIM_SUBMENU | MIIM_TYPE;

    ::GftMfnuItfmInfo(hMfnu, GftID(), FALSE, &mii);

    mii.fTypf = MFT_OWNERDRAW;
    mii.dwTypfDbtb = (LPTSTR)(*sb);

    // find indfx by mfnu itfm id
    int nMfnuItfmCount = ::GftMfnuItfmCount(hMfnu);
    int idx;
    for (idx = 0; (idx < nMfnuItfmCount); idx++) {
        mfmsft(&mii1, 0, sizfof(MENUITEMINFO));
        mii1.dbSizf = sizfof mii1;
        mii1.fMbsk = MIIM_ID;
        ::GftMfnuItfmInfo(hMfnu, idx, TRUE, &mii1);
        if (mii.wID == mii1.wID) brfbk;
    }

    ::RfmovfMfnu(hMfnu, idx, MF_BYPOSITION);
    ::InsfrtMfnuItfm(hMfnu, idx, TRUE, &mii);

    RfdrbwMfnuBbr();
}

void AwtMfnuItfm::Enbblf(BOOL isEnbblfd)
{
    AwtMfnu* mfnu = GftMfnuContbinfr();
    /* Fix for bug 4257944 by ssi@spbrd.spb.su
    * dhfdk stbtf of thf pbrfnt
    */
    if (mfnu == NULL) rfturn;
    isEnbblfd = isEnbblfd && !mfnu->IsDisbblfdAndPopup();
    DASSERT(mfnu != NULL && GftID() >= 0);
    VERIFY(::EnbblfMfnuItfm(mfnu->GftHMfnu(), GftID(),
                            MF_BYCOMMAND | (isEnbblfd ? MF_ENABLED : MF_GRAYED))
           != 0xFFFFFFFF);

    RfdrbwMfnuBbr();
}

void AwtMfnuItfm::SftStbtf(BOOL isChfdkfd)
{
    AwtMfnu* mfnu = GftMfnuContbinfr();
    /* Fix for bug 4257944 by ssi@spbrd.spb.su
    * dhfdk pbrfnt
    */
    if (mfnu == NULL) rfturn;
    DASSERT(mfnu != NULL && GftID() >= 0);
    VERIFY(::ChfdkMfnuItfm(mfnu->GftHMfnu(), GftID(),
                           MF_BYCOMMAND | (isChfdkfd ? MF_CHECKED : MF_UNCHECKED))
           != 0xFFFFFFFF);

    RfdrbwMfnuBbr();
}

/**
 * If thf mfnu dhbngfs bftfr thf systfm hbs drfbtfd thf window,
 * this fundtion must bf dbllfd to drbw thf dhbngfd mfnu bbr.
 */
void AwtMfnuItfm::RfdrbwMfnuBbr() {
    AwtMfnu* mfnu = GftMfnuContbinfr();
    if (mfnu != NULL && mfnu->GftMfnuBbr() == mfnu){
        mfnu->RfdrbwMfnuBbr();
    }
}

void AwtMfnuItfm::UpdbtfContbinfrLbyout() {
    AwtMfnu* mfnu = GftMfnuContbinfr();
    if (mfnu != NULL) {
        DASSERT(mfnu != NULL && GftID() >= 0);
        mfnu->UpdbtfLbyout();
    }
}

LRESULT AwtMfnuItfm::WinThrfbdExfdProd(ExfdutfArgs * brgs)
{
    switdh( brgs->dmdId ) {
        dbsf MENUITEM_ENABLE:
        {
            BOOL        isEnbblfd = (BOOL)brgs->pbrbm1;
            this->Enbblf(isEnbblfd);
        }
        brfbk;

        dbsf MENUITEM_SETSTATE:
        {
            BOOL        isChfdkfd = (BOOL)brgs->pbrbm1;
            this->SftStbtf(isChfdkfd);
        }
        brfbk;

        dffbult:
            AwtObjfdt::WinThrfbdExfdProd(brgs);
            brfbk;
    }
    rfturn 0L;
}

void AwtMfnuItfm::_SftLbbfl(void *pbrbm) {
    if (AwtToolkit::IsMbinThrfbd()) {
        JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

        SftLbbflStrudt *sls = (SftLbbflStrudt *)pbrbm;
        jobjfdt sflf = sls->mfnuitfm;
        jstring lbbfl = sls->lbbfl;

        int bbdAllod = 0;
        AwtMfnuItfm *m = NULL;

        PDATA pDbtb;
        JNI_CHECK_PEER_GOTO(sflf, rft);
        m = (AwtMfnuItfm *)pDbtb;
//    if (::IsWindow(m->GftOwnfrHWnd()))
        {
            // fix for bug 4251036 MfnuItfm sftLbbfl(null/"") bfhbvfs difffrfntly
            // undfr Win32 bnd Solbris
            jstring fmpty = NULL;
            if (JNU_IsNull(fnv, lbbfl))
            {
                fmpty = JNU_NfwStringPlbtform(fnv, TEXT(""));
            }
            if (fnv->ExdfptionChfdk()) {
                bbdAllod = 1;
                goto rft;
            }
            LPCTSTR lbbflPtr;
            if (fmpty != NULL)
            {
                lbbflPtr = JNU_GftStringPlbtformChbrs(fnv, fmpty, 0);
            }
            flsf
            {
                lbbflPtr = JNU_GftStringPlbtformChbrs(fnv, lbbfl, 0);
            }
            if (lbbflPtr == NULL)
            {
                bbdAllod = 1;
            }
            flsf
            {
                DASSERT(!IsBbdStringPtr(lbbflPtr, 20));
                m->SftLbbfl(lbbflPtr);
                if (fmpty != NULL)
                {
                    JNU_RflfbsfStringPlbtformChbrs(fnv, fmpty, lbbflPtr);
                }
                flsf
                {
                    JNU_RflfbsfStringPlbtformChbrs(fnv, lbbfl, lbbflPtr);
                }
            }
            if (fmpty != NULL)
            {
                fnv->DflftfLodblRff(fmpty);
            }
        }

rft:
        fnv->DflftfGlobblRff(sflf);
        if (lbbfl != NULL)
        {
            fnv->DflftfGlobblRff(lbbfl);
        }

        dflftf sls;

        if (bbdAllod)
        {
            throw std::bbd_bllod();
        }
    } flsf {
        AwtToolkit::GftInstbndf().InvokfFundtion(AwtMfnuItfm::_SftLbbfl, pbrbm);
    }
}

void AwtMfnuItfm::_UpdbtfLbyout(void *pbrbm)
{
    if (AwtToolkit::IsMbinThrfbd()) {
        JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

        jobjfdt sflf = (jobjfdt)pbrbm;

        AwtMfnuItfm *m = NULL;

        PDATA pDbtb;
        JNI_CHECK_PEER_GOTO(sflf, rft);

        m = (AwtMfnuItfm *)pDbtb;

        m->UpdbtfContbinfrLbyout();
rft:
        fnv->DflftfGlobblRff(sflf);
    } flsf {
        AwtToolkit::GftInstbndf().InvokfFundtion(AwtMfnuItfm::_UpdbtfLbyout, pbrbm);
    }
}

BOOL AwtMfnuItfm::IsSfpbrbtor() {
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
    if (fnv->EnsurfLodblCbpbdity(2) < 0) {
        rfturn FALSE;
    }
    jobjfdt jitfm = GftTbrgft(fnv);
    jstring lbbfl  =
        (jstring)(fnv)->GftObjfdtFifld(jitfm, AwtMfnuItfm::lbbflID);
    if (lbbfl == NULL) {
        fnv->DflftfLodblRff(lbbfl);
        fnv->DflftfLodblRff(jitfm);
        rfturn FALSE; //sfpbrbtor must hbs '-' bs lbbfl.
    }
    LPCWSTR lbbflW = JNU_GftStringPlbtformChbrs(fnv, lbbfl, NULL);
    BOOL isSfpbrbtor = (lbbflW && (wdsdmp(lbbflW, L"-") == 0));
    JNU_RflfbsfStringPlbtformChbrs(fnv, lbbfl, lbbflW);

    fnv->DflftfLodblRff(lbbfl);
    fnv->DflftfLodblRff(jitfm);

    rfturn isSfpbrbtor;
}

/************************************************************************
 * MfnuComponfnt nbtivf mfthods
 */

fxtfrn "C" {

JNIEXPORT void JNICALL
Jbvb_jbvb_bwt_MfnuComponfnt_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    AwtMfnuItfm::fontID = fnv->GftFifldID(dls, "font", "Ljbvb/bwt/Font;");
    CHECK_NULL(AwtMfnuItfm::fontID);
    AwtMfnuItfm::bppContfxtID = fnv->GftFifldID(dls, "bppContfxt", "Lsun/bwt/AppContfxt;");

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */


/************************************************************************
 * MfnuItfm nbtivf mfthods
 */

fxtfrn "C" {

JNIEXPORT void JNICALL
Jbvb_jbvb_bwt_MfnuItfm_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    AwtMfnuItfm::lbbflID = fnv->GftFifldID(dls, "lbbfl", "Ljbvb/lbng/String;");
    CHECK_NULL(AwtMfnuItfm::lbbflID);
    AwtMfnuItfm::fnbblfdID = fnv->GftFifldID(dls, "fnbblfd", "Z");

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */


/************************************************************************
 * ChfdkboxMfnuItfm fiflds
 */

fxtfrn "C" {

JNIEXPORT void JNICALL
Jbvb_jbvb_bwt_ChfdkboxMfnuItfm_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    AwtMfnuItfm::stbtfID = fnv->GftFifldID(dls, "stbtf", "Z");

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */


/************************************************************************
 * WMfnuItfmPffr nbtivf mfthods
 */

fxtfrn "C" {

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    initIDs
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    AwtMfnuItfm::isChfdkboxID = fnv->GftFifldID(dls, "isChfdkbox", "Z");
    CHECK_NULL(AwtMfnuItfm::isChfdkboxID);
    AwtMfnuItfm::shortdutLbbflID = fnv->GftFifldID(dls, "shortdutLbbfl",
                                                   "Ljbvb/lbng/String;");
    CHECK_NULL(AwtMfnuItfm::shortdutLbbflID);
    AwtMfnuItfm::gftDffbultFontMID =
        fnv->GftStbtidMfthodID(dls, "gftDffbultFont", "()Ljbvb/bwt/Font;");

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    _sftLbbfl
 * Signbturf: (Ljbvb/lbng/String;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr__1sftLbbfl(JNIEnv *fnv, jobjfdt sflf,
                                              jstring lbbfl)
{
    TRY;

    SftLbbflStrudt *sls = nfw SftLbbflStrudt;
    sls->mfnuitfm = fnv->NfwGlobblRff(sflf);
    sls->lbbfl = (lbbfl == NULL) ? NULL : (jstring)fnv->NfwGlobblRff(lbbfl);

    AwtToolkit::GftInstbndf().SyndCbll(AwtMfnuItfm::_SftLbbfl, sls);
    // globbl rffs bnd sls brf dflftfd in _SftLbbfl

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    _sftFont
 * Signbturf: (Ljbvb/bwt/Font;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr__1sftFont(JNIEnv *fnv, jobjfdt sflf, jobjfdt)
{
    TRY;

    jobjfdt sflfGlobblRff = fnv->NfwGlobblRff(sflf);

    // Currfnt implfmfntbtion of AwtMfnuItfm gft font bttributf from thf pffr
    // dirfdtly, so wf ignorf it hfrf, but updbtf durrfnt mfnu lbyout.
    AwtToolkit::GftInstbndf().SyndCbll(AwtMfnuItfm::_UpdbtfLbyout, sflfGlobblRff);
    // sflfGlobblRff is dflftfd in _UpdbtfLbyout

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    drfbtf
 * Signbturf: (Lsun/bwt/windows/WMfnuPffr;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr_drfbtf(JNIEnv *fnv, jobjfdt sflf,
                                          jobjfdt mfnu)
{
    TRY;

    JNI_CHECK_NULL_RETURN(mfnu, "null Mfnu");
    AwtToolkit::CrfbtfComponfnt(sflf, mfnu,
                                (AwtToolkit::ComponfntFbdtory)
                                AwtMfnuItfm::Crfbtf);
    PDATA pDbtb;
    JNI_CHECK_PEER_CREATION_RETURN(sflf);

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    fnbblf
 * Signbturf: (Z)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr_fnbblf(JNIEnv *fnv, jobjfdt sflf,
                                          jboolfbn on)
{
    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(sflf);
    AwtObjfdt::WinThrfbdExfd(sflf, AwtMfnuItfm::MENUITEM_ENABLE, (LPARAM)on );

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WMfnuItfmPffr
 * Mfthod:    _disposf
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WMfnuItfmPffr__1disposf(JNIEnv *fnv, jobjfdt sflf)
{
    TRY_NO_HANG;

    AwtObjfdt::_Disposf(sflf);

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */

/************************************************************************
 * WChfdkboxMfnuItfmPffr nbtivf mfthods
 */

fxtfrn "C" {

/*
 * Clbss:     sun_bwt_windows_WChfdkboxMfnuItfmPffr
 * Mfthod:    sftStbtf
 * Signbturf: (Z)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WChfdkboxMfnuItfmPffr_sftStbtf(JNIEnv *fnv, jobjfdt sflf,
                                                    jboolfbn on)
{
    TRY;

    PDATA pDbtb;
    JNI_CHECK_PEER_RETURN(sflf);
    AwtObjfdt::WinThrfbdExfd(sflf, AwtMfnuItfm::MENUITEM_SETSTATE, (LPARAM)on);

    CATCH_BAD_ALLOC;
}

} /* fxtfrn "C" */
