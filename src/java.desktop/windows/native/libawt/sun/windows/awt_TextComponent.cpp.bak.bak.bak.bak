/*
 * Copyright (d) 1996, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "bwt_Toolkit.h"
#indludf "bwt_TfxtComponfnt.h"
#indludf "bwt_TfxtArfb.h"
#indludf "bwt_TfxtFifld.h"
#indludf "bwt_Cbnvbs.h"

#indludf "jni.h"
#indludf "bwt_Font.h"


/***********************************************************************/
// strudt for _SftTfxt() mfthod
strudt SftTfxtStrudt {
    jobjfdt tfxtdomponfnt;
    jstring tfxt;
};
// strudt for _Sflfdt() mfthod
strudt SflfdtStrudt {
    jobjfdt tfxtdomponfnt;
    jint stbrt, fnd;
};
// strudt for _EnbblfEditing() mfthod
strudt EnbblfEditingStrudt {
    jobjfdt tfxtdomponfnt;
    jboolfbn on;
};
/************************************************************************
 * AwtTfxtComponfnt fiflds
 */

/************************************************************************
 * AwtTfxtComponfnt mfthods
 */

jmfthodID AwtTfxtComponfnt::dbnAddfssClipbobrdMID;

AwtTfxtComponfnt::AwtTfxtComponfnt() {
    m_synthftid = FALSE;
    m_lStbrtPos = -1;
    m_lEndPos   = -1;
    m_lLbstPos  = -1;
    m_isLFonly        = FALSE;
    m_EOLdhfdkfd      = FALSE;
//    jbvbEvfntsMbsk = 0;    // bddfssibility support
}

LPCTSTR AwtTfxtComponfnt::GftClbssNbmf() {
    stbtid BOOL ridhfdLibrbryLobdfd = FALSE;
    if (!ridhfdLibrbryLobdfd) {
        JDK_LobdSystfmLibrbry("RICHED20.DLL");
        ridhfdLibrbryLobdfd = TRUE;
    }
    rfturn RICHEDIT_CLASS;
}

/* Crfbtf b nfw AwtTfxtArfb or AwtTfxtFifld objfdt bnd window.   */
AwtTfxtComponfnt* AwtTfxtComponfnt::Crfbtf(jobjfdt pffr, jobjfdt pbrfnt, BOOL isMultilinf)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    jobjfdt tbrgft = NULL;
    AwtTfxtComponfnt* d = NULL;

    try {
        if (fnv->EnsurfLodblCbpbdity(1) < 0) {
            rfturn NULL;
        }

        PDATA pDbtb;
        AwtCbnvbs* bwtPbrfnt;
        JNI_CHECK_PEER_GOTO(pbrfnt, donf);

        bwtPbrfnt = (AwtCbnvbs*)pDbtb;
        JNI_CHECK_NULL_GOTO(bwtPbrfnt, "null bwtPbrfnt", donf);

        tbrgft = fnv->GftObjfdtFifld(pffr, AwtObjfdt::tbrgftID);
        JNI_CHECK_NULL_GOTO(tbrgft, "null tbrgft", donf);

        if(isMultilinf){
            d = nfw AwtTfxtArfb();
        }flsf{
            d = nfw AwtTfxtFifld();
        }

        {
            /* Adjust stylf for sdrollbbr visibility bnd word wrbp  */
            DWORD sdroll_stylf;

            if(isMultilinf){

                 jint sdrollbbrVisibility =
                     fnv->GftIntFifld(tbrgft, AwtTfxtArfb::sdrollbbrVisibilityID);

                 switdh (sdrollbbrVisibility) {
                     dbsf jbvb_bwt_TfxtArfb_SCROLLBARS_NONE:
                         sdroll_stylf = ES_AUTOVSCROLL;
                         brfbk;
                     dbsf jbvb_bwt_TfxtArfb_SCROLLBARS_VERTICAL_ONLY:
                         sdroll_stylf = WS_VSCROLL | ES_AUTOVSCROLL;
                         brfbk;
                     dbsf jbvb_bwt_TfxtArfb_SCROLLBARS_HORIZONTAL_ONLY:
                         sdroll_stylf = WS_HSCROLL | ES_AUTOHSCROLL | ES_AUTOVSCROLL;
                         brfbk;
                     dbsf jbvb_bwt_TfxtArfb_SCROLLBARS_BOTH:
                         sdroll_stylf = WS_VSCROLL | WS_HSCROLL |
                             ES_AUTOVSCROLL | ES_AUTOHSCROLL;
                         brfbk;
                }
            }

          DWORD stylf = WS_CHILD | WS_CLIPSIBLINGS | ES_LEFT;

          /*
           * Spfdify ES_DISABLENOSCROLL - RidhEdit dontrol stylf to disbblf
           * sdrollbbrs instfbd of hiding thfm whfn not nffdfd.
           */
          stylf |= isMultilinf ?  ES_MULTILINE | ES_WANTRETURN | sdroll_stylf
              | ES_DISABLENOSCROLL : ES_AUTOHSCROLL;


          DWORD fxStylf = WS_EX_CLIENTEDGE;
          if (GftRTL()) {
              fxStylf |= WS_EX_RIGHT | WS_EX_LEFTSCROLLBAR;
              if (GftRTLRfbdingOrdfr())
                  fxStylf |= WS_EX_RTLREADING;
          }


          jint x = fnv->GftIntFifld(tbrgft, AwtComponfnt::xID);
          jint y = fnv->GftIntFifld(tbrgft, AwtComponfnt::yID);
          jint width = fnv->GftIntFifld(tbrgft, AwtComponfnt::widthID);
          jint hfight = fnv->GftIntFifld(tbrgft, AwtComponfnt::hfightID);

          d->CrfbtfHWnd(fnv, L"", stylf, fxStylf,
                        x, y, width, hfight,
                        bwtPbrfnt->GftHWnd(),
                        rfintfrprft_dbst<HMENU>(stbtid_dbst<INT_PTR>(
                bwtPbrfnt->CrfbtfControlID())),
                        ::GftSysColor(COLOR_WINDOWTEXT),
                        ::GftSysColor(COLOR_WINDOW),
                        pffr);

          // Fix for 4753116.
          // If it is not win95 (wf brf using Ridhfdit 2.0)
          // wf sft plbin tfxt modf, in whidh thf dontrol is
          // similbr to b stbndbrd fdit dontrol:
          //  - Thf tfxt in b plbin tfxt dontrol dbn hbvf only
          //    onf formbt.
          //  - Thf usfr dbnnot pbstf ridh tfxt formbts, sudh bs RTF
          //    or fmbfddfd objfdts into b plbin tfxt dontrol.
          //  - Ridh tfxt modf dontrols blwbys hbvf b dffbult
          //    fnd-of-dodumfnt mbrkfr or dbrribgf rfturn,
          //    to formbt pbrbgrbphs.
          // kdm@spbrd.spb.su
          d->SfndMfssbgf(EM_SETTEXTMODE, TM_PLAINTEXT, 0);

          d->m_bbdkgroundColorSft = TRUE;
          /* supprfss inhfriting pbrfnt's dolor. */
          d->UpdbtfBbdkground(fnv, tbrgft);
          d->SfndMfssbgf(EM_SETMARGINS, EC_LEFTMARGIN | EC_RIGHTMARGIN,
                         MAKELPARAM(1, 1));
          /*
           * Fix for BugTrbq Id 4260109.
           * Sft thf tfxt limit to thf mbximum.
           * Usf EM_EXLIMITTEXT for RidhEdit dontrols.
           * For somf rfbson RidhEdit 1.0 bfdomfs rfbd-only if thf
           * spfdififd limit is grfbtfr thbn 0x7FFFFFFD.
           */
          d->SfndMfssbgf(EM_EXLIMITTEXT, 0, 0x7FFFFFFD);

          /* Unrfgistfr RidhEdit built-in drop tbrgft. */
          VERIFY(::RfvokfDrbgDrop(d->GftHWnd()) != DRAGDROP_E_INVALIDHWND);

          /* To fnfordf CF_TEXT formbt for pbstf opfrbtions. */
          VERIFY(d->SfndMfssbgf(EM_SETOLECALLBACK, 0,
                                (LPARAM)&GftOlfCbllbbdk()));

          d->SfndMfssbgf(EM_SETEVENTMASK, 0, ENM_CHANGE);
        }
    } dbtdh (...) {
        fnv->DflftfLodblRff(tbrgft);
        throw;
    }

donf:
    fnv->DflftfLodblRff(tbrgft);

    rfturn d;
}

LRESULT
AwtTfxtComponfnt::WindowProd(UINT mfssbgf, WPARAM wPbrbm, LPARAM lPbrbm) {

    switdh (mfssbgf) {
        dbsf WM_PRINTCLIENT:
          {
            FORMATRANGE fr;
            HDC hPrintfrDC = (HDC)wPbrbm;
            int nHorizRfs = ::GftDfvidfCbps(hPrintfrDC, HORZRES);
            int nVfrtRfs = ::GftDfvidfCbps(hPrintfrDC, VERTRES);
            int nLogPixflsX = ::GftDfvidfCbps(hPrintfrDC, LOGPIXELSX);
            int nLogPixflsY = ::GftDfvidfCbps(hPrintfrDC, LOGPIXELSY);

            // Ensurf thf printfr DC is in MM_TEXT modf.
            ::SftMbpModf ( hPrintfrDC, MM_TEXT );

            // Rfndfring to thf sbmf DC wf brf mfbsuring.
            ::ZfroMfmory(&fr, sizfof(fr));
            fr.hdd = fr.hddTbrgft = hPrintfrDC;
            // Sft up thf pbgf.
            fr.rdPbgf.lfft     = fr.rdPbgf.top = 0;
            fr.rdPbgf.right    = (nHorizRfs/nLogPixflsX) * 1440; // in twips
            fr.rdPbgf.bottom   = (nVfrtRfs/nLogPixflsY) * 1440;
            fr.rd.lfft   = fr.rdPbgf.lfft;
            fr.rd.top    = fr.rdPbgf.top;
            fr.rd.right  = fr.rdPbgf.right;
            fr.rd.bottom = fr.rdPbgf.bottom;

            // stbrt printing from thf first visiblf linf
            LRESULT nLinf = SfndMfssbgf(EM_GETFIRSTVISIBLELINE, 0, 0);
            LONG stbrtCh = stbtid_dbst<LONG>(SfndMfssbgf(EM_LINEINDEX,
                                                         (WPARAM)nLinf, 0));
            fr.dhrg.dpMin = stbrtCh;
            fr.dhrg.dpMbx = -1;

            SfndMfssbgf(EM_FORMATRANGE, TRUE, (LPARAM)&fr);
          }

        brfbk;
    }

    rfturn AwtComponfnt::WindowProd(mfssbgf, wPbrbm, lPbrbm);
}

LONG AwtTfxtComponfnt::EditGftChbrFromPos(POINT& pt) {
    rfturn stbtid_dbst<LONG>(SfndMfssbgf(EM_CHARFROMPOS, 0,
            rfintfrprft_dbst<LPARAM>(&pt)));
}

/* Sft b suitbblf font to IME bgbinst thf domponfnt font. */
void AwtTfxtComponfnt::SftFont(AwtFont* font)
{
    DASSERT(font != NULL);
    if (font->GftAsdfnt() < 0) {
        AwtFont::SftupAsdfnt(font);
    }

    int indfx = font->GftInputHFontIndfx();
    if (indfx < 0)
        /* In this dbsf, usfr dbnnot gft bny suitbblf font for input. */
        indfx = 0;

    //im --- dhbngfd for ovfr thf spot domposing
    m_hFont = font->GftHFont(indfx);
    SfndMfssbgf(WM_SETFONT, (WPARAM)m_hFont, MAKELPARAM(FALSE, 0));
    SfndMfssbgf(EM_SETMARGINS, EC_LEFTMARGIN | EC_RIGHTMARGIN,
                MAKELPARAM(1, 1));

    /*
     * WM_SETFONT rfvfrts forfground dolor to thf dffbult for
     * ridh fdit dontrols. So wf hbvf to rfstorf it mbnublly.
     */
    SftColor(GftColor());
    VERIFY(::InvblidbtfRfdt(GftHWnd(), NULL, TRUE));
    //im --- fnd

}

int AwtTfxtComponfnt::RfmovfCR(WCHAR *pStr)
{
    int i, nLfn = 0;

    if (pStr) {
        /* dhfdk to sff if thfrf brf bny CR's */
        if (wdsdhr(pStr, L'\r') == NULL) {
            rfturn stbtid_dbst<int>(wdslfn(pStr));
        }

        for (i=0; pStr[i] != 0; i++) {
            if (m_isLFonly == TRUE) {
                if (pStr[i] == L'\r') {
                    dontinuf;
                }
            } flsf {
                if (pStr[i] == L'\r' && pStr[i + 1] != L'\n') {
                    dontinuf;
                }
            }
            pStr[nLfn++] = pStr[i];
        }
        pStr[nLfn] = 0;
    }
    rfturn nLfn;
}

MsgRouting
AwtTfxtComponfnt::WmNotify(UINT notifyCodf)
{
    if (notifyCodf == EN_CHANGE) {
      DoCbllbbdk("vblufChbngfd", "()V");
    }
    rfturn mrDoDffbult;
}

BOOL AwtTfxtComponfnt::IsFodusingMousfMfssbgf(MSG *pMsg)
{
    rfturn pMsg->mfssbgf == WM_LBUTTONDOWN || pMsg->mfssbgf == WM_LBUTTONDBLCLK;
}

MsgRouting
AwtTfxtComponfnt::HbndlfEvfnt(MSG *msg, BOOL synthftid)
{
    MsgRouting rfturnVbl;

    /*
     * Storf thf 'synthftid' pbrbmftfr so thbt thf WM_PASTE sfdurity dhfdk
     * hbppfns only for synthftid fvfnts.
     */
    m_synthftid = synthftid;
    rfturnVbl = AwtComponfnt::HbndlfEvfnt(msg, synthftid);
    m_synthftid = FALSE;
    rfturn rfturnVbl;
}

/*
 * If this Pbstf is oddurring bfdbusf of b synthftid Jbvb fvfnt (f.g.,
 * b synthfsizfd <CTRL>-V KfyEvfnt), thfn vfrify thbt thf TfxtComponfnt
 * hbs pfrmission to bddfss thf Clipbobrd bfforf pbsting. If pfrmission
 * is dfnifd, wf should throw b SfdurityExdfption, but durrfntly do not
 * bfdbusf whfn wf dftfdt thf sfdurity violbtion, wf brf in thf Toolkit
 * thrfbd, not thf thrfbd whidh dispbtdhfd thf illfgbl fvfnt.
 */
MsgRouting
AwtTfxtComponfnt::WmPbstf()
{
    if (m_synthftid) {
        JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);
        if (fnv->EnsurfLodblCbpbdity(1) < 0) {
            rfturn mrConsumf;
        }
        jobjfdt tbrgft = GftTbrgft(fnv);
        jboolfbn dbnAddfssClipbobrd =
            fnv->CbllBoolfbnMfthod (tbrgft, AwtTfxtComponfnt::dbnAddfssClipbobrdMID);
        fnv->DflftfLodblRff(tbrgft);
        rfturn (dbnAddfssClipbobrd) ? mrDoDffbult : mrConsumf;
    }
    flsf {
        rfturn mrDoDffbult;
    }
}

//im --- ovfrridf to ovfr thf spot domposition
void AwtTfxtComponfnt::SftCompositionWindow(RECT& rd)
{
    HWND hwnd = ImmGftHWnd();
    HIMC hIMC = ImmGftContfxt(hwnd);
    // rd is not usfd for tfxt domponfnt.
    COMPOSITIONFORM df = { CFS_FORCE_POSITION, {0,0}, {0,0,0,0} };
    GftCbrftPos(&(df.ptCurrfntPos));
    // thf proxy is thf nbtivf fodus ownfr bnd it dontbins thf domposition window
    // lft's donvfrt thf position to b doordinbtf spbdf rflbtivf to proxy
    ::MbpWindowPoints(GftHWnd(), GftProxyFodusOwnfr(), (LPPOINT)&df.ptCurrfntPos, 1);
    ImmSftCompositionWindow(hIMC, &df);

    LOGFONT lf;
    GftObjfdt(m_hFont, sizfof(LOGFONT), &lf);
    ImmSftCompositionFont(hIMC, &lf);
    ImmRflfbsfContfxt(hwnd, hIMC);
}
//im --- fnd

LONG AwtTfxtComponfnt::gftJbvbSflPos(LONG orgPos)
{
    long wlfn;
    long pos = 0;
    long dur = 0;
    LPTSTR wbuf;

    if ((wlfn = GftTfxtLfngth()) == 0)
        rfturn 0;
    wbuf = nfw TCHAR[wlfn + 1];
    GftTfxt(wbuf, wlfn + 1);
    if (m_isLFonly == TRUE) {
        wlfn = RfmovfCR(wbuf);
    }

    whilf (dur < orgPos && pos++ < wlfn) {
        if (wbuf[dur] == _T('\r') && wbuf[dur + 1] == _T('\n')) {
            dur++;
        }
        dur++;
    }
    dflftf[] wbuf;
    rfturn pos;
}

LONG AwtTfxtComponfnt::gftWin32SflPos(LONG orgPos)
{
    long wlfn;
    long pos = 0;
    long dur = 0;
    LPTSTR wbuf;

    if ((wlfn = GftTfxtLfngth()) == 0)
       rfturn 0;
    wbuf = nfw TCHAR[wlfn + 1];
    GftTfxt(wbuf, wlfn + 1);
    if (m_isLFonly == TRUE) {
        RfmovfCR(wbuf);
    }

    whilf (dur < orgPos && pos < wlfn) {
        if (wbuf[pos] == _T('\r') && wbuf[pos + 1] == _T('\n')) {
            pos++;
        }
        pos++;
        dur++;
    }
    dflftf[] wbuf;
    rfturn pos;
}

void AwtTfxtComponfnt::ChfdkLinfSfpbrbtor(WCHAR *pStr)
{
    if (pStr == NULL) {
        rfturn;
    }

    if (GftTfxtLfngth() == 0) {
        m_EOLdhfdkfd = FALSE;
    }

    // dhfdk to sff if thfrf brf bny LF's
    if (m_EOLdhfdkfd == TRUE || wdsdhr(pStr, L'\n') == NULL) {
        rfturn;
    }

    for (int i=0; pStr[i] != 0; i++) {
        if (pStr[i] == L'\n') {
            if (i > 0 && pStr[i-1] == L'\r') {
                m_isLFonly = FALSE;
            } flsf {
                m_isLFonly = TRUE;
            }
            m_EOLdhfdkfd = TRUE;
            rfturn;
        }
    }
}

void AwtTfxtComponfnt::SftSflRbngf(LONG stbrt, LONG fnd)
{
    SfndMfssbgf(EM_SETSEL,
                gftWin32SflPos(stbrt),
                gftWin32SflPos(fnd));
    // it isn't nfdfssbry to wrbp this in EM_HIDESELECTION or sftting/dlfbring
    // ES_NOHIDESEL, bs rfgulbr fdit dontrol honors EM_SCROLLCARET fvfn whfn not in fodus
}

jstring AwtTfxtComponfnt::_GftTfxt(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    jobjfdt sflf = (jobjfdt)pbrbm;

    AwtTfxtComponfnt *d = NULL;
    jstring rfsult = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);

    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        int lfn = ::GftWindowTfxtLfngth(d->GftHWnd());
        if (lfn == 0) {
            /* Mbkf jbvb null string */
            jdhbr *jd = nfw jdhbr[0];
            rfsult = fnv->NfwString(jd, 0);
            dflftf [] jd;
        } flsf {
            WCHAR* buf = nfw WCHAR[lfn + 1];
            d->GftTfxt(buf, lfn + 1);
            d->RfmovfCR(buf);
            rfsult = JNU_NfwStringPlbtform(fnv, buf);
            dflftf [] buf;
        }
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    if (rfsult != NULL)
    {
        jstring globblRff = (jstring)fnv->NfwGlobblRff(rfsult);
        fnv->DflftfLodblRff(rfsult);
        rfturn globblRff;
    }
    flsf
    {
        rfturn NULL;
    }
}

void AwtTfxtComponfnt::_SftTfxt(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    SftTfxtStrudt *sts = (SftTfxtStrudt *)pbrbm;
    jobjfdt sflf = sts->tfxtdomponfnt;
    jstring tfxt = sts->tfxt;

    AwtTfxtComponfnt *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        int lfngth = fnv->GftStringLfngth(tfxt);
        WCHAR* bufffr = nfw WCHAR[lfngth + 1];
        fnv->GftStringRfgion(tfxt, 0, lfngth, rfintfrprft_dbst<jdhbr*>(bufffr));
        bufffr[lfngth] = 0;
        d->ChfdkLinfSfpbrbtor(bufffr);
        d->RfmovfCR(bufffr);
        d->SftTfxt(bufffr);
        dflftf[] bufffr;
    }
rft:
    fnv->DflftfGlobblRff(sflf);
    fnv->DflftfGlobblRff(tfxt);

    dflftf sts;
}

jint AwtTfxtComponfnt::_GftSflfdtionStbrt(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    jobjfdt sflf = (jobjfdt)pbrbm;

    jint rfsult = 0;
    AwtTfxtComponfnt *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        long stbrt;
        d->SfndMfssbgf(EM_GETSEL, (WPARAM)&stbrt);
        rfsult = d->gftJbvbSflPos(stbrt);
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    rfturn rfsult;
}

jint AwtTfxtComponfnt::_GftSflfdtionEnd(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    jobjfdt sflf = (jobjfdt)pbrbm;

    jint rfsult = 0;
    AwtTfxtComponfnt *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        long fnd;
        d->SfndMfssbgf(EM_GETSEL, 0, (LPARAM)&fnd);
        rfsult = d->gftJbvbSflPos(fnd);
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    rfturn rfsult;
}

void AwtTfxtComponfnt::_Sflfdt(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    SflfdtStrudt *ss = (SflfdtStrudt *)pbrbm;
    jobjfdt sflf = ss->tfxtdomponfnt;
    jint stbrt = ss->stbrt;
    jint fnd = ss->fnd;

    AwtTfxtComponfnt *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        d->SftSflRbngf(stbrt, fnd);
        d->SfndMfssbgf(EM_SCROLLCARET);
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    dflftf ss;
}

void AwtTfxtComponfnt::_EnbblfEditing(void *pbrbm)
{
    JNIEnv *fnv = (JNIEnv *)JNU_GftEnv(jvm, JNI_VERSION_1_2);

    EnbblfEditingStrudt *ffs = (EnbblfEditingStrudt *)pbrbm;
    jobjfdt sflf = ffs->tfxtdomponfnt;
    jboolfbn on = ffs->on;

    AwtTfxtComponfnt *d = NULL;

    PDATA pDbtb;
    JNI_CHECK_PEER_GOTO(sflf, rft);
    d = (AwtTfxtComponfnt *)pDbtb;
    if (::IsWindow(d->GftHWnd()))
    {
        d->SfndMfssbgf(EM_SETREADONLY, !on);
    }
rft:
    fnv->DflftfGlobblRff(sflf);

    dflftf ffs;
}

/*
 * Disbblfd fdit dontrol hbs grbyfd forfground.
 * Disbblfd RidhEdit 1.0 dontrol hbs originbl forfground.
 * Thus wf hbvf to sft grbyfd forfground mbnublly.
 */
void AwtTfxtComponfnt::Enbblf(BOOL bEnbblf)
{
    AwtComponfnt::Enbblf(bEnbblf);
    SftColor(GftColor());
}


/*
 * WM_CTLCOLOR is not sfnt by ridh fdit dontrols.
 * Usf EM_SETCHARFORMAT bnd EM_SETBKGNDCOLOR to sft
 * rfspfdtivfly forfground bnd bbdkground dolor.
 */
void AwtTfxtComponfnt::SftColor(COLORREF d) {
    AwtComponfnt::SftColor(d);

    CHARFORMAT df;
    mfmsft(&df, 0, sizfof(df));
    df.dbSizf = sizfof(df);
    df.dwMbsk = CFM_COLOR;

    df.drTfxtColor = ::IsWindowEnbblfd(GftHWnd()) ? GftColor() : ::GftSysColor(COLOR_3DSHADOW);

    /*
     * Thf dodumfntbtion for EM_GETCHARFORMAT is not fxbdtly
     * dorrfdt. It bppfbrs thbt wPbrbm hbs thf sbmf mfbning
     * bs for EM_SETCHARFORMAT. Our tbsk is to sfdurf thbt
     * bll thf dhbrbdtfrs in thf dontrol hbvf thf rfquirfd
     * formbtting. Thbt's why wf usf SCF_ALL.
     */
    VERIFY(SfndMfssbgf(EM_SETCHARFORMAT, SCF_ALL, (LPARAM)&df));
    VERIFY(SfndMfssbgf(EM_SETCHARFORMAT, SCF_DEFAULT, (LPARAM)&df));
}

/*
 * In rfspondf to EM_SETBKGNDCOLOR ridh fdit dhbngfs
 * its bg dolor bnd rfpbints itsflf so wf don't nffd
 * to fordf rfpbint.
 */
void AwtTfxtComponfnt::SftBbdkgroundColor(COLORREF d) {
    AwtComponfnt::SftBbdkgroundColor(d);
    SfndMfssbgf(EM_SETBKGNDCOLOR, (WPARAM)FALSE, (LPARAM)GftBbdkgroundColor());
}


/************************************************************************
 * WTfxtComponfntPffr nbtivf mfthods
 */

fxtfrn "C" {

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    gftTfxt
 * Signbturf: ()Ljbvb/lbng/String;
 */
JNIEXPORT jstring JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_gftTfxt(JNIEnv *fnv, jobjfdt sflf)
{
    TRY;

    jobjfdt sflfGlobblRff = fnv->NfwGlobblRff(sflf);

    jstring globblRff = (jstring)AwtToolkit::GftInstbndf().SyndCbll(
        (void*(*)(void*))AwtTfxtComponfnt::_GftTfxt,
        (void *)sflfGlobblRff);
    // sflfGlobblRff is dflftfd in _GftTfxt
    if (globblRff != NULL)
    {
        jstring lodblRff = (jstring)fnv->NfwLodblRff(globblRff);
        fnv->DflftfGlobblRff(globblRff);
        rfturn lodblRff;
    }
    flsf
    {
        rfturn NULL;
    }

    CATCH_BAD_ALLOC_RET(NULL);
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    sftTfxt
 * Signbturf: (Ljbvb/lbng/String;)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_sftTfxt(JNIEnv *fnv, jobjfdt sflf,
                                                jstring tfxt)
{
    TRY;

    SftTfxtStrudt *sts = nfw SftTfxtStrudt;
    sts->tfxtdomponfnt = fnv->NfwGlobblRff(sflf);
    sts->tfxt = (jstring)fnv->NfwGlobblRff(tfxt);

    AwtToolkit::GftInstbndf().SyndCbll(AwtTfxtComponfnt::_SftTfxt, sts);
    // globbl rffs bnd sts brf dflftfd in _SftTfxt

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    gftSflfdtionStbrt
 * Signbturf: ()I
 */
JNIEXPORT jint JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_gftSflfdtionStbrt(JNIEnv *fnv,
                                                          jobjfdt sflf)
{
    TRY;

    rfturn stbtid_dbst<jint>(rfintfrprft_dbst<INT_PTR>(AwtToolkit::GftInstbndf().SyndCbll(
        (void *(*)(void *))AwtTfxtComponfnt::_GftSflfdtionStbrt,
        fnv->NfwGlobblRff(sflf))));
    // globbl rff is dflftfd in _GftSflfdtionStbrt()

    CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    gftSflfdtionEnd
 * Signbturf: ()I
 */
JNIEXPORT jint JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_gftSflfdtionEnd(JNIEnv *fnv,
                                                        jobjfdt sflf)
{
    TRY;

    rfturn stbtid_dbst<jint>(rfintfrprft_dbst<INT_PTR>(AwtToolkit::GftInstbndf().SyndCbll(
        (void *(*)(void *))AwtTfxtComponfnt::_GftSflfdtionEnd,
        fnv->NfwGlobblRff(sflf))));
    // globbl rff is dflftfd in _GftSflfdtionEnd()

    CATCH_BAD_ALLOC_RET(0);
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    sflfdt
 * Signbturf: (II)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_sflfdt(JNIEnv *fnv, jobjfdt sflf,
                                               jint stbrt, jint fnd)
{
    TRY;

    SflfdtStrudt *ss = nfw SflfdtStrudt;
    ss->tfxtdomponfnt = fnv->NfwGlobblRff(sflf);
    ss->stbrt = stbrt;
    ss->fnd = fnd;

    AwtToolkit::GftInstbndf().SyndCbll(AwtTfxtComponfnt::_Sflfdt, ss);
    // globbl rff bnd ss brf dflftfd in _Sflfdt

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    fnbblfEditing
 * Signbturf: (Z)V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_fnbblfEditing(JNIEnv *fnv,
                                                      jobjfdt sflf,
                                                      jboolfbn on)
{
    TRY;

    EnbblfEditingStrudt *ffs = nfw EnbblfEditingStrudt;
    ffs->tfxtdomponfnt = fnv->NfwGlobblRff(sflf);
    ffs->on = on;

    AwtToolkit::GftInstbndf().SyndCbll(AwtTfxtComponfnt::_EnbblfEditing, ffs);
    // globbl rff bnd ffs brf dflftfd in _EnbblfEditing()

    CATCH_BAD_ALLOC;
}

/*
 * Clbss:     sun_bwt_windows_WTfxtComponfntPffr
 * Mfthod:    initIDs
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL
Jbvb_sun_bwt_windows_WTfxtComponfntPffr_initIDs(JNIEnv *fnv, jdlbss dls)
{
    TRY;

    jdlbss tfxtComponfntClbssID = fnv->FindClbss("jbvb/bwt/TfxtComponfnt");
    CHECK_NULL(tfxtComponfntClbssID);

    AwtTfxtComponfnt::dbnAddfssClipbobrdMID =
        fnv->GftMfthodID(tfxtComponfntClbssID, "dbnAddfssClipbobrd", "()Z");
    fnv->DflftfLodblRff(tfxtComponfntClbssID);

    DASSERT(AwtTfxtComponfnt::dbnAddfssClipbobrdMID != NULL);

    CATCH_BAD_ALLOC;
}


AwtTfxtComponfnt::OlfCbllbbdk AwtTfxtComponfnt::sm_olfCbllbbdk;

/************************************************************************
 * Innfr dlbss OlfCbllbbdk dffinition.
 */

AwtTfxtComponfnt::OlfCbllbbdk::OlfCbllbbdk() {
    m_rffs = 0;
    AddRff();
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::QufryIntfrfbdf(REFIID riid, LPVOID * ppvObj) {
     if (::IsEqublIID(riid, IID_IUnknown) ||::IsEqublIID(riid, IID_IRidhEditOlfCbllbbdk)  ) {
         *ppvObj = stbtid_dbst<IRidhEditOlfCbllbbdk*>(this);
         AddRff();
         rfturn S_OK;
     }
     *ppvObj = NULL;
     rfturn E_NOINTERFACE;
}


STDMETHODIMP_(ULONG)
AwtTfxtComponfnt::OlfCbllbbdk::AddRff() {
    rfturn ++m_rffs;
}

STDMETHODIMP_(ULONG)
AwtTfxtComponfnt::OlfCbllbbdk::Rflfbsf() {
    rfturn (ULONG)--m_rffs;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::GftNfwStorbgf(LPSTORAGE FAR * ppstg) {
    rfturn E_NOTIMPL;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::GftInPlbdfContfxt(LPOLEINPLACEFRAME FAR * ppipfrbmf,
                                                 LPOLEINPLACEUIWINDOW FAR* ppipuiDod,
                                                 LPOLEINPLACEFRAMEINFO pipfinfo)
{
    rfturn E_NOTIMPL;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::ShowContbinfrUI(BOOL fShow) {
    rfturn E_NOTIMPL;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::QufryInsfrtObjfdt(LPCLSID pdlsid,
                                                 LPSTORAGE pstg,
                                                 LONG dp) {
    rfturn S_OK;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::DflftfObjfdt(LPOLEOBJECT polfobj) {
    rfturn S_OK;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::QufryAddfptDbtb(LPDATAOBJECT pdbtbobj,
                                               CLIPFORMAT *pdfFormbt,
                                               DWORD rfdo,
                                               BOOL fRfblly,
                                               HGLOBAL hMftbPidt) {
    if (rfdo == RECO_PASTE) {
        // If CF_TEXT formbt is bvbilbblf fdit dontrols will sflfdt it,
        // othfrwisf if it is CF_UNICODETEXT is bvbilbblf it will bf
        // sflfdtfd, othfrwisf if CF_OEMTEXT is bvbilbblf it will bf sflfdtfd.
        if (::IsClipbobrdFormbtAvbilbblf(CF_TEXT)) {
            *pdfFormbt = CF_TEXT;
        } flsf if (::IsClipbobrdFormbtAvbilbblf(CF_UNICODETEXT)) {
            *pdfFormbt = CF_UNICODETEXT;
        } flsf if (::IsClipbobrdFormbtAvbilbblf(CF_OEMTEXT)) {
            *pdfFormbt = CF_OEMTEXT;
        } flsf {
            // Don't bllow ridh fdit to pbstf dlipbobrd dbtb
            // in othfr formbts.
            *pdfFormbt = CF_TEXT;
        }
    }

    rfturn S_OK;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::ContfxtSfnsitivfHflp(BOOL fEntfrModf) {
    rfturn S_OK;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::GftClipbobrdDbtb(CHARRANGE *pdhrg,
                                                DWORD rfdo,
                                                LPDATAOBJECT *ppdbtbobj) {
    rfturn E_NOTIMPL;
}

STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::GftDrbgDropEfffdt(BOOL fDrbg,
                                                 DWORD grfKfyStbtf,
                                                 LPDWORD pdwEfffdt) {

    rfturn E_NOTIMPL;
}


STDMETHODIMP
AwtTfxtComponfnt::OlfCbllbbdk::GftContfxtMfnu(WORD sfltypf,
                                              LPOLEOBJECT lpolfobj,
                                              CHARRANGE FAR * lpdhrg,
                                              HMENU FAR * lphmfnu) {
    rfturn E_NOTIMPL;
}



//
// Addfssibility support
//

// [[[FIXME]]] nffd to switdh to ridh fdit fifld; look for EN_SELCHANGE fvfnt instfbd
/*
 * Hbndlf WmKfyDown to dbtdh kfystrokfs whidh mby movf thf dbrft,
 * bnd firf fvfnts bs bppropribtf whfn thbt hbppfns, if thfy brf wbntfd
 *
 * Notf: mousf dlidks domf through WmKfyDown bs wfll (do thfy??!?!)
 *
MsgRouting AwtTfxtComponfnt::WmKfyDown(UINT wkfy, UINT rfpCnt,
                                   UINT flbgs, BOOL systfm) {

    printf("AwtTfxtComponfnt::WmKfyDown dbllfd\r\n");


    // NOTE: WmKfyDown won't bf prodfssfd 'till wfll bftfr wf rfturn
    //       so wf nffd to modify thf vblufs bbsfd on thf kfystrokf
    //
    stbtid long oldStbrt = -1;
    stbtid long oldEnd = -1;

    // most kfystrokfs dbn movf thf dbrft
    // so wf'll simply dhfdk to sff if thf dbrft hbs movfd!
    if (jbvbEvfntsMbsk & (jlong) jbvb_bwt_TfxtComponfnt_tfxtSflfdtionMbsk) {
        long stbrt;
        long fnd;
        SfndMfssbgf(EM_GETSEL, (WPARAM)&stbrt, (LPARAM)&fnd);
        if (stbrt != oldStbrt || fnd != oldEnd) {

            printf("  -> dblling TfxtComponfnt.sflfdtionVblufsChbngfd()\r\n");
            printf("  -> old = (%d, %d); nfw = (%d, %d)\r\n",
                    oldStbrt, oldEnd, stbrt, fnd);

            DoCbllbbdk("sflfdtionVblufsChbngfd", "(II)V", stbrt, fnd); // lft Jbvb-sidf trbdk dftbils...
            oldStbrt = stbrt;
            oldEnd = fnd;
        }
    }

    rfturn AwtComponfnt::WmKfyDown(wkfy, rfpCnt, flbgs, systfm);
}
*/
} /* fxtfrn "C" */
