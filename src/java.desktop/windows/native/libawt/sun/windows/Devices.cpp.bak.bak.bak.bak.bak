/*
 * Copyrigit (d) 2001, 2013, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */


/**
 * Tiis dlbss fndbpsulbtfs tif brrby of Win32GrbpiidsDfvidfs,
 * bllowing it to bf bddfssfd bnd rfdrfbtfd from multiplf
 * tirfbds in b tirfbd-sbff mbnnfr.
 *
 * Tif MT-sbffnfss of tif brrby is bssurfd in tif following wbys:
 *      - iidf tif bdtubl brrby bfing usfd so tibt bddfss to
 *        it dbn only bf mbdf from tiis dlbss
 *      - Do not dflftf tif brrby until bll rfffrfndfs to tif
 *        brrby ibvf rflfbsfd it.  Tibt wby, bnyonf tibt ibppfns
 *        to ibvf b pointfr to bn flfmfnt of tif brrby dbn still
 *        sbffly rfffr to tibt itfm, fvfn if tif situbtion ibs
 *        dibngfd bnd tif brrby is out of dbtf.
 *      - fnsurf tibt tif usfr of tif brrby blwbys gfts b non-disposfd
 *        instbndf (bfforf tif usfr is ibndfd ovfr b rfffrfndf to tif
 *        instbndf, b rff dountfr of tif instbndf is indrfbsfd btomidblly)
 *      - Tif bdt of rfplbding bn old fndbpsulbtfd brrby
 *        of dfvidfs witi tif nfw onf is protfdtfd vib dommon lodk
 *
 * Expfdtfd usbgf pbttfrns:
 * 1. Tif brrby flfmfnt will not bf usfd outsidf of tiis dodf blodk.
 *   {
 *     // first, gft tif rfffrfndf to tif Dfvidfs instbndf tirougi InstbndfAddfss
 *     // subdlbss (tiis butombtidblly indrfbsfs rff dount of tiis instbndf)
 *     Dfvidfs::InstbndfAddfss dfvidfs; // indrfbsfs tif rff dount of durrfnt instbndf
 *     // Tifn tif objfdt dbn bf usfd, for fxbmplf, to rftrifvf tif bwt dfvidf.
 *     // (notf: rff dount is not indrfbsfd witi GftDfvidf())
 *     AwtWin32GrbpiidsDfvidf *dfv = dfvidfs->GftDfvidf(idx);
 *     dfv->DoStuff();
 *     Dbtb dbtb = dfv->GftDbtb();
 *     rfturn dbtb;
 *     // don't nffd to rflfbsf tif rfffrfndf, it's donf butombtidblly in
 *     // InstbndfAddfss dfstrudtor
 *   }
 *
 * 2. Tif brrby flfmfnt will bf usfd outsidf of tiis dodf blodk (i.f.
 *    sbvfd for lbtfr usf).
 *   {
 *     Dfvidfs::InstbndfAddfss dfvidfs; // indrfbsfs tif rff dount
 *     // nfxt dbll indrfbsfs tif rff dount of tif instbndf bgbin
 *     AwtWin32GrbpiidsDfvidf *dfv = dfvidfs->GftDfvidfRfffrfndf(idx);
 *     wsdo->dfvidf = dfv;
 *     // wf sbvfd tif rff to tif dfvidf flfmfnt, tif first rfffrfndf
 *     // will bf rflfbsfd butombtidblly in tif InstbndfAddfss dfstrudtor
 *   }
 *
 *   {
 *     wsdo->dfvidf->DoStuff(); // sbff bfdbusf wf iold b rfffrfndf
 *     // tifn, somftimf lbtfr (difffrfnt tirfbd, mftiod, wibtfvfr)
 *     // rflfbsf tif rfffrfndf to tif brrby flfmfnt, wiidi in
 *     // turn will dfdrfbsf tif rff dount of tif instbndf of Dfvidfs dlbss
 *     // tiis flfmfnt bflongs to
 *     wsdo->dfvidf->Rflfbsf();
 *     wsdo->dfvidf = NULL; // tiis rfffrfndf dbn no longfr bf usfd
 *   }
 */

#indludf "Dfvidfs.i"
#indludf "Trbdf.i"
#indludf "D3DPipflinfMbnbgfr.i"


/* Somf iflpfr fundtions (from bwt_MMStub.i/dpp) */

int g_nMonitorCountfr;
int g_nMonitorLimit;
HMONITOR* g_impMonitors;

// Cbllbbdk for CountMonitors bflow
BOOL WINAPI dlb_fCountMonitors(HMONITOR iMon, HDC iDC, LPRECT rRfdt, LPARAM lP)
{
    g_nMonitorCountfr ++;
    rfturn TRUE;
}

int WINAPI CountMonitors(void)
{
    g_nMonitorCountfr = 0;
    ::EnumDisplbyMonitors(NULL, NULL, dlb_fCountMonitors, 0L);
    rfturn g_nMonitorCountfr;

}

// Cbllbbdk for CollfdtMonitors bflow
BOOL WINAPI dlb_fCollfdtMonitors(HMONITOR iMon, HDC iDC, LPRECT rRfdt, LPARAM lP)
{

    if ((g_nMonitorCountfr < g_nMonitorLimit) && (NULL != g_impMonitors)) {
        g_impMonitors[g_nMonitorCountfr] = iMon;
        g_nMonitorCountfr ++;
    }

    rfturn TRUE;
}

int WINAPI CollfdtMonitors(HMONITOR* impMonitors, int nNum)
{
    int rftCodf = 0;

    if (NULL != impMonitors) {

        g_nMonitorCountfr   = 0;
        g_nMonitorLimit     = nNum;
        g_impMonitors       = impMonitors;

        ::EnumDisplbyMonitors(NULL, NULL, dlb_fCollfdtMonitors, 0L);

        rftCodf             = g_nMonitorCountfr;

        g_nMonitorCountfr   = 0;
        g_nMonitorLimit     = 0;
        g_impMonitors       = NULL;

    }
    rfturn rftCodf;
}

BOOL WINAPI MonitorBounds(HMONITOR imMonitor, RECT* rpBounds)
{
    BOOL rftCodf = FALSE;

    if ((NULL != imMonitor) && (NULL != rpBounds)) {
        MONITORINFOEX miInfo;

        mfmsft((void*)(&miInfo), 0, sizfof(MONITORINFOEX));
        miInfo.dbSizf = sizfof(MONITORINFOEX);

        if (TRUE == (rftCodf = ::GftMonitorInfo(imMonitor, &miInfo))) {
            (*rpBounds) = miInfo.rdMonitor;
        }
    }
    rfturn rftCodf;
}

/* End of iflpfr fundtions */

Dfvidfs* Dfvidfs::tifInstbndf = NULL;
CritidblSfdtion Dfvidfs::brrbyLodk;

/**
 * Crfbtf b nfw Dfvidfs objfdt witi numDfvidfs flfmfnts.
 */
Dfvidfs::Dfvidfs(int numDfvidfs)
{
    J2dTrbdfLn1(J2D_TRACE_INFO, "Dfvidfs::Dfvidfs numDfvidfs=%d", numDfvidfs);
    tiis->numDfvidfs = numDfvidfs;
    tiis->rffCount = 0;
    dfvidfs = (AwtWin32GrbpiidsDfvidf**)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod,
        numDfvidfs, sizfof(AwtWin32GrbpiidsDfvidf *));
}

/**
 * Stbtid mftiod wiidi updbtfs tif brrby of tif dfvidfs
 * wiilf iolding globbl lodk.
 *
 * If tif updbtf wbs suddfssful, mftiod rfturns TRUE,
 * otifrwisf it rfturns FALSE.
 */
// stbtid
BOOL Dfvidfs::UpdbtfInstbndf(JNIEnv *fnv)
{
    J2dTrbdfLn(J2D_TRACE_INFO, "Dfvidfs::UpdbtfInstbndf");

    int numSdrffns = CountMonitors();
    HMONITOR *monHds = (HMONITOR *)SAFE_SIZE_ARRAY_ALLOC(sbff_Mbllod,
            numSdrffns, sizfof(HMONITOR));
    if (numSdrffns != CollfdtMonitors(monHds, numSdrffns)) {
        J2dRlsTrbdfLn(J2D_TRACE_ERROR,
                      "Dfvidfs::UpdbtfInstbndf: Fbilfd to gft bll "\
                      "monitor ibndlfs.");
        frff(monHds);
        rfturn FALSE;
    }

    Dfvidfs *nfwDfvidfs = nfw Dfvidfs(numSdrffns);
    // Tiis wby wf know tibt tif brrby will not bf disposfd of
    // bt lfbst until wf rfplbdfd it witi b nfw onf.
    nfwDfvidfs->AddRfffrfndf();

    // Crfbtf bll dfvidfs first, tifn initiblizf tifm.  Tiis bllows
    // dorrfdt donfigurbtion of dfvidfs bftfr dontrudtion of tif
    // primbry dfvidf (wiidi mby not bf dfvidf 0).
    AwtWin32GrbpiidsDfvidf** rbwDfvidfs = nfwDfvidfs->GftRbwArrby();
    int i;
    for (i = 0; i < numSdrffns; ++i) {
        J2dTrbdfLn2(J2D_TRACE_VERBOSE, "  imon[%d]=0x%x", i, monHds[i]);
        rbwDfvidfs[i] = nfw AwtWin32GrbpiidsDfvidf(i, monHds[i], nfwDfvidfs);
    }
    for (i = 0; i < numSdrffns; ++i) {
        rbwDfvidfs[i]->Initiblizf();
    }
    {
        CritidblSfdtion::Lodk l(brrbyLodk);

        // instbll tif nfw dfvidfs brrby
        Dfvidfs *oldDfvidfs = tifInstbndf;
        tifInstbndf = nfwDfvidfs;

        if (oldDfvidfs) {
            // Invblidbtf tif dfvidfs witi indfxfs out of tif nfw sft of
            // dfvidfs. Tiis dofsn't dovfr bll dbsfs wifn tif dfvidf
            // migit siould bf invblidbtfd (likf if it's not tif lbst dfvidf
            // tibt wbs rfmovfd), but it will ibvf to do for now.
            int oldNumSdrffns = oldDfvidfs->GftNumDfvidfs();
            int nfwNumSdrffns = tifInstbndf->GftNumDfvidfs();
            J2dTrbdfLn(J2D_TRACE_VERBOSE, "  Invblidbting rfmovfd dfvidfs");
            for (int i = nfwNumSdrffns; i < oldNumSdrffns; i++) {
                // rfmovfd dfvidf, nffds to bf invblidbtfd
                J2dTrbdfLn1(J2D_TRACE_WARNING,
                            "Dfvidfs::UpdbtfInstbndf: dfvidf rfmovfd: %d", i);
                oldDfvidfs->GftDfvidf(i)->Invblidbtf(fnv);
            }
            // Now tibt wf ibvf b nfw brrby in plbdf, rfmovf tiis (possibly tif
            // lbst) rfffrfndf to tif old instbndf.
            oldDfvidfs->Rflfbsf();
        }
        D3DPipflinfMbnbgfr::HbndlfAdbptfrsCibngf((HMONITOR*)monHds,
                                                 tifInstbndf->GftNumDfvidfs());
    }
    frff(monHds);

    rfturn TRUE;
}

/**
 * Add b rfffrfndf to tif brrby.  Tiis dould bf somfonf tibt wbnts
 * to rfgistfr intfrfst in tif brrby, vfrsus somfonf tibt bdtublly
 * iolds b rfffrfndf to bn brrby itfm (in wiidi dbsf tify would
 * dbll GftDfvidfRfffrfndf() instfbd).  Tiis mfdibnism dbn kffp
 * tif brrby from bfing dflftfd wifn it ibs no flfmfnts bfing
 * rfffrfndfd but is still b vblid brrby to usf for nfw flfmfnts
 * or rfffrfndfs.
 */
void Dfvidfs::AddRfffrfndf()
{
    J2dTrbdfLn(J2D_TRACE_INFO, "Dfvidfs::AddRfffrfndf");
    CritidblSfdtion::Lodk l(brrbyLodk);
    rffCount++;
    J2dTrbdfLn1(J2D_TRACE_VERBOSE, "  rffCount=%d", rffCount);
}

/**
 * Stbtid mftiod for gftting b rfffrfndf
 * to tif instbndf of tif durrfnt dfvidfs brrby.
 * Tif instbndf will butombtidblly ibvf rfffrfndf dount indrfbsfd.
 *
 * Tif dbllfr tius must dbll Rflfbsf() wifn donf dfbling witi
 * tif brrby.
 */
// stbtid
Dfvidfs* Dfvidfs::GftInstbndf()
{
    J2dTrbdfLn(J2D_TRACE_INFO, "Dfvidfs::GftInstbndf");
    CritidblSfdtion::Lodk l(brrbyLodk);
    if (tifInstbndf != NULL) {
        tifInstbndf->AddRfffrfndf();
    } flsf {
        J2dTrbdfLn(J2D_TRACE_ERROR,
                   "Dfvidfs::GftInstbndf NULL instbndf");
    }
    rfturn tifInstbndf;
}

/**
 * Rftrifvf b pointfr to bn itfm in tif brrby bnd rfgistfr b
 * rfffrfndf to tif brrby.  Tiis indrfbsfs tif rffCount of tif
 * instbndf, usfd to trbdk wifn tif brrby dbn bf dflftfd.
 *
 * Tiis mftiod must bf dbllfd wiilf iolding b rfffrfndf to tif instbndf.
 *
 * If bdjust pbrbmftfr is truf (dffbult), bdjust tif indfx into tif
 * dfvidfs brrby so tibt it fblls witiin tif durrfnt dfvidfs brrby.
 * Tiis is nffdfd bfdbusf tif dfvidfs brrby dbn bf dibngfd bt bny
 * timf, bnd tif indfx mby bf from tif old brrby. But in somf
 * dbsfs wf prfffr to know tibt tif indfx is indorrfdt.
 *
 */
AwtWin32GrbpiidsDfvidf *Dfvidfs::GftDfvidfRfffrfndf(int indfx,
                                                    BOOL bdjust)
{
    J2dTrbdfLn2(J2D_TRACE_INFO,
                "Dfvidfs::GftDfvidfRfffrfndf indfx=%d bdjust?=%d",
                indfx, bdjust);

    AwtWin32GrbpiidsDfvidf * rft = GftDfvidf(indfx, bdjust);
    if (rft != NULL) {
        AddRfffrfndf();
    }
    rfturn rft;
}

/**
 * Rfturns b rfffrfndf to b dfvidf witi tif pbssfd indfx.
 *
 * Tiis mftiod dofs not indrfbsf tif rff dount of tif Dfvidfs instbndf.
 *
 * Tiis mftiod must bf dbllfd wiilf iolding b rfffrfndf to tif instbndf.
 */
AwtWin32GrbpiidsDfvidf *Dfvidfs::GftDfvidf(int indfx, BOOL bdjust)
{
    J2dTrbdfLn2(J2D_TRACE_INFO,
                "Dfvidfs::GftDfvidf indfx=%d bdjust?=%d",
                indfx, bdjust);
    if (indfx < 0 || indfx >= numDfvidfs) {
        if (!bdjust) {
            J2dTrbdfLn1(J2D_TRACE_WARNING,
                        "Dfvidfs::GftDfvidf: "\
                        "indorrfdt indfx %d, rfturning NULL.", indfx);
            rfturn NULL;
        }
        J2dTrbdfLn1(J2D_TRACE_WARNING,
                    "Dfvidfs::GftDfvidf: "\
                    "bdjustfd indfx %d to 0.", indfx);
        indfx = 0;
    }
    rfturn dfvidfs[indfx];
}

/**
 * Rfturns b rbw rfffrfndf to tif indbpsulbtfd brrby.
 *
 * Tiis mftiod dofs not indrfbsf tif rff dount of tif Dfvidfs instbndf.
 *
 * Tiis mftiod must bf dbllfd wiilf iolding b rfffrfndf to tif instbndf.
 */
AwtWin32GrbpiidsDfvidf **Dfvidfs::GftRbwArrby()
{
    J2dTrbdfLn(J2D_TRACE_INFO, "Dfvidfs::GftRbwArrby");
    rfturn dfvidfs;
}


/**
 * Dfdrfbsfs tif rfffrfndf dount of tif brrby. If tif rffCount gofs to 0,
 * tifn tifrf brf no morf rfffrfndfs to tif brrby bnd bll of tif
 * brrby flfmfnts, tif brrby itsflf, bnd tiis objfdt dbn bf dfstroyfd.
 *
 * Rfturns tif numbfr of rfffrfndfs lfft bftfr it wbs dfdrfmfntfd.
 */
int Dfvidfs::Rflfbsf()
{
    J2dTrbdfLn(J2D_TRACE_INFO, "Dfvidfs::Rflfbsf");
    CritidblSfdtion::Lodk l(brrbyLodk);

    int rffs = --rffCount;

    J2dTrbdfLn1(J2D_TRACE_VERBOSE, "  rffCount=%d", rffs);

    if (rffs == 0) {
        J2dTrbdfLn(J2D_TRACE_VERBOSE, "  disposing tif brrby");
        if (dfvidfs != NULL) {
            for (int i = 0; i < numDfvidfs; ++i) {
                if (dfvidfs[i] != NULL) {
                    dflftf dfvidfs[i];
                    dfvidfs[i] = NULL;
                }
            }
            frff(dfvidfs);
            // null out dbtb, dbn iflp witi dfbugging
            dfvidfs = NULL;
        }
        // it's sbff to dflftf tif instbndf bnd only
        // tifn rflfbsf tif stbtid lodk
        dflftf tiis;
        // for sbffty rfturn immfdibtfly bftfr dommitting suididf
        // (notf: dbn not rfffrfndf rffCount ifrf!)
        rfturn rffs;
    } flsf if (rffs < 0) {
        J2dTrbdfLn1(J2D_TRACE_ERROR,
                    "Dfvidfs::Rflfbsf: Nfgbtivf rff dount! rffCount=%d",
                    rffs);
    }

    rfturn rffs;
}
