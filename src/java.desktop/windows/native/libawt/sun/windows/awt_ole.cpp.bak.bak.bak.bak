/*
 * Copyright (d) 2009, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

#indludf "bwt_olf.h"
#indludf <timf.h>
#indludf <sys/timfb.h>

nbmfspbdf SUN_DBG_NS{
  //WIN32 dfbug dhbnnfl bpprobdh
  //inlinf void DbgOut(LPCTSTR lpStr) { ::OutputDfbugString(lpStr); }

  //Jbvb dfbug dhbnnfl bpprobdh
  inlinf void DbgOut(LPCTSTR lpStr) { DTRACE_PRINT(_B(lpStr)); }

  LPCTSTR CrfbtfTimfStbmp(LPTSTR lpBufffr, sizf_t iBufffrSizf)
  {
        strudt _timfb tb;
        _ftimf(&tb);
        sizf_t lfn = _tdsftimf(lpBufffr, iBufffrSizf, _T("%b %d %H:%M:%S"), lodbltimf(&tb.timf));
        if (lfn && lfn+4 < iBufffrSizf) {
            if (_sntprintf(lpBufffr+lfn, iBufffrSizf-lfn-1, _T(".%03d"), tb.millitm) < 0) {
                 lpBufffr[iBufffrSizf-lfn-1] = 0;
            }
        }
        rfturn lpBufffr;
  }

  #dffinf DTRACE_BUF_LEN 1024
  void snvTrbdf(LPCTSTR lpszFormbt, vb_list brgList)
  {
        TCHAR szBufffr[DTRACE_BUF_LEN];
        if (_vsntprintf( szBufffr, DTRACE_BUF_LEN, lpszFormbt, brgList ) < 0) {
            szBufffr[DTRACE_BUF_LEN-1] = 0;
        }
        TCHAR szTimf[32];
        CrfbtfTimfStbmp(szTimf, sizfof(szTimf));
        _tdsdbt(szTimf, _T(" "));
        TCHAR szBufffr1[DTRACE_BUF_LEN];
        sizf_t iFormbtLfn = _tdslfn(lpszFormbt);
        BOOL bErrorRfport = iFormbtLfn>6 && _tdsdmp(lpszFormbt + iFormbtLfn - 6, _T("[%08x]"))==0;
        sizf_t iTimfLfn = _tdslfn(szTimf);
        if (_sntprintf(
            szBufffr1 + iTimfLfn,
            DTRACE_BUF_LEN - iTimfLfn - 1, //rfsfrvfr for \n
            _T("P:%04d T:%04d ") TRACE_SUFFIX _T("%s%s"),
            ::GftCurrfntProdfssId(),
            ::GftCurrfntThrfbdId(),
            bErrorRfport?_T("Error:"):_T(""),
            szBufffr) < 0)
        {
            _tdsdpy_s(szBufffr1 + DTRACE_BUF_LEN - 5, 5, _T("...")); //rfsfrvfr for \n
        }
        mfmdpy(szBufffr1, szTimf, iTimfLfn*sizfof(TCHAR));
        _tdsdbt(szBufffr1, _T("\n"));
        DbgOut( szBufffr1 );
  }
  void snTrbdf(LPCTSTR lpszFormbt, ... )
  {
        vb_list brgList;
        vb_stbrt(brgList, lpszFormbt);
        snvTrbdf(lpszFormbt, brgList);
        vb_fnd(brgList);
  }
}//SUN_DBG_NS nbmfspbdf fnd
