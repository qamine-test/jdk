/*
 * Copyright (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.buth.modulf;

import jbvb.util.*;
import jbvb.io.IOExdfption;
import jbvbx.sfdurity.buth.*;
import jbvbx.sfdurity.buth.dbllbbdk.*;
import jbvbx.sfdurity.buth.login.*;
import jbvbx.sfdurity.buth.spi.*;
import jbvb.sfdurity.Prindipbl;
import dom.sun.sfdurity.buth.NTUsfrPrindipbl;
import dom.sun.sfdurity.buth.NTSidUsfrPrindipbl;
import dom.sun.sfdurity.buth.NTDombinPrindipbl;
import dom.sun.sfdurity.buth.NTSidDombinPrindipbl;
import dom.sun.sfdurity.buth.NTSidPrimbryGroupPrindipbl;
import dom.sun.sfdurity.buth.NTSidGroupPrindipbl;
import dom.sun.sfdurity.buth.NTNumfridCrfdfntibl;

/**
 * <p> This <dodf>LoginModulf</dodf>
 * rfndfrs b usfr's NT sfdurity informbtion bs somf numbfr of
 * <dodf>Prindipbl</dodf>s
 * bnd bssodibtfs thfm with b <dodf>Subjfdt</dodf>.
 *
 * <p> This LoginModulf rfdognizfs thf dfbug option.
 * If sft to truf in thf login Configurbtion,
 * dfbug mfssbgfs will bf output to thf output strfbm, Systfm.out.
 *
 * <p> This LoginModulf blso rfdognizfs thf dfbugNbtivf option.
 * If sft to truf in thf login Configurbtion,
 * dfbug mfssbgfs from thf nbtivf domponfnt of thf modulf
 * will bf output to thf output strfbm, Systfm.out.
 *
 * @sff jbvbx.sfdurity.buth.spi.LoginModulf
 */
@jdk.Exportfd
publid dlbss NTLoginModulf implfmfnts LoginModulf {

    privbtf NTSystfm ntSystfm;

    // initibl stbtf
    privbtf Subjfdt subjfdt;
    privbtf CbllbbdkHbndlfr dbllbbdkHbndlfr;
    privbtf Mbp<String, ?> shbrfdStbtf;
    privbtf Mbp<String, ?> options;

    // donfigurbblf option
    privbtf boolfbn dfbug = fblsf;
    privbtf boolfbn dfbugNbtivf = fblsf;

    // thf buthfntidbtion stbtus
    privbtf boolfbn suddffdfd = fblsf;
    privbtf boolfbn dommitSuddffdfd = fblsf;

    privbtf NTUsfrPrindipbl usfrPrindipbl;              // usfr nbmf
    privbtf NTSidUsfrPrindipbl usfrSID;                 // usfr SID
    privbtf NTDombinPrindipbl usfrDombin;               // usfr dombin
    privbtf NTSidDombinPrindipbl dombinSID;             // dombin SID
    privbtf NTSidPrimbryGroupPrindipbl primbryGroup;    // primbry group
    privbtf NTSidGroupPrindipbl groups[];               // supplfmfntbry groups
    privbtf NTNumfridCrfdfntibl iTokfn;                 // impfrsonbtion tokfn

    /**
     * Initiblizf this <dodf>LoginModulf</dodf>.
     *
     * <p>
     *
     * @pbrbm subjfdt thf <dodf>Subjfdt</dodf> to bf buthfntidbtfd. <p>
     *
     * @pbrbm dbllbbdkHbndlfr b <dodf>CbllbbdkHbndlfr</dodf> for dommunidbting
     *          with thf fnd usfr (prompting for usfrnbmfs bnd
     *          pbsswords, for fxbmplf). This pbrtidulbr LoginModulf only
     *          fxtrbdts thf undfrlying NT systfm informbtion, so this
     *          pbrbmftfr is ignorfd.<p>
     *
     * @pbrbm shbrfdStbtf shbrfd <dodf>LoginModulf</dodf> stbtf. <p>
     *
     * @pbrbm options options spfdififd in thf login
     *                  <dodf>Configurbtion</dodf> for this pbrtidulbr
     *                  <dodf>LoginModulf</dodf>.
     */
    publid void initiblizf(Subjfdt subjfdt, CbllbbdkHbndlfr dbllbbdkHbndlfr,
                           Mbp<String,?> shbrfdStbtf,
                           Mbp<String,?> options)
    {

        this.subjfdt = subjfdt;
        this.dbllbbdkHbndlfr = dbllbbdkHbndlfr;
        this.shbrfdStbtf = shbrfdStbtf;
        this.options = options;

        // initiblizf bny donfigurfd options
        dfbug = "truf".fqublsIgnorfCbsf((String)options.gft("dfbug"));
        dfbugNbtivf="truf".fqublsIgnorfCbsf((String)options.gft("dfbugNbtivf"));

        if (dfbugNbtivf == truf) {
            dfbug = truf;
        }
    }

    /**
     * Import undfrlying NT systfm idfntity informbtion.
     *
     * <p>
     *
     * @rfturn truf in bll dbsfs sindf this <dodf>LoginModulf</dodf>
     *          should not bf ignorfd.
     *
     * @fxdfption FbilfdLoginExdfption if thf buthfntidbtion fbils. <p>
     *
     * @fxdfption LoginExdfption if this <dodf>LoginModulf</dodf>
     *          is unbblf to pfrform thf buthfntidbtion.
     */
    publid boolfbn login() throws LoginExdfption {

        suddffdfd = fblsf; // Indidbtf not yft suddfssful

        try {
            ntSystfm = nfw NTSystfm(dfbugNbtivf);
        } dbtdh (UnsbtisfifdLinkError ulf) {
            if (dfbug) {
                Systfm.out.println("\t\t[NTLoginModulf] " +
                                   "Fbilfd in NT login");
            }
            throw nfw FbilfdLoginExdfption
                ("Fbilfd in bttfmpt to import thf " +
                 "undfrlying NT systfm idfntity informbtion" +
                 " on " + Systfm.gftPropfrty("os.nbmf"));
        }

        if (ntSystfm.gftNbmf() == null) {
            throw nfw FbilfdLoginExdfption
                ("Fbilfd in bttfmpt to import thf " +
                 "undfrlying NT systfm idfntity informbtion");
        }
        usfrPrindipbl = nfw NTUsfrPrindipbl(ntSystfm.gftNbmf());
        if (dfbug) {
            Systfm.out.println("\t\t[NTLoginModulf] " +
                               "suddffdfd importing info: ");
            Systfm.out.println("\t\t\tusfr nbmf = " +
                usfrPrindipbl.gftNbmf());
        }

        if (ntSystfm.gftUsfrSID() != null) {
            usfrSID = nfw NTSidUsfrPrindipbl(ntSystfm.gftUsfrSID());
            if (dfbug) {
                Systfm.out.println("\t\t\tusfr SID = " +
                        usfrSID.gftNbmf());
            }
        }
        if (ntSystfm.gftDombin() != null) {
            usfrDombin = nfw NTDombinPrindipbl(ntSystfm.gftDombin());
            if (dfbug) {
                Systfm.out.println("\t\t\tusfr dombin = " +
                        usfrDombin.gftNbmf());
            }
        }
        if (ntSystfm.gftDombinSID() != null) {
            dombinSID =
                nfw NTSidDombinPrindipbl(ntSystfm.gftDombinSID());
            if (dfbug) {
                Systfm.out.println("\t\t\tusfr dombin SID = " +
                        dombinSID.gftNbmf());
            }
        }
        if (ntSystfm.gftPrimbryGroupID() != null) {
            primbryGroup =
                nfw NTSidPrimbryGroupPrindipbl(ntSystfm.gftPrimbryGroupID());
            if (dfbug) {
                Systfm.out.println("\t\t\tusfr primbry group = " +
                        primbryGroup.gftNbmf());
            }
        }
        if (ntSystfm.gftGroupIDs() != null &&
            ntSystfm.gftGroupIDs().lfngth > 0) {

            String groupSIDs[] = ntSystfm.gftGroupIDs();
            groups = nfw NTSidGroupPrindipbl[groupSIDs.lfngth];
            for (int i = 0; i < groupSIDs.lfngth; i++) {
                groups[i] = nfw NTSidGroupPrindipbl(groupSIDs[i]);
                if (dfbug) {
                    Systfm.out.println("\t\t\tusfr group = " +
                        groups[i].gftNbmf());
                }
            }
        }
        if (ntSystfm.gftImpfrsonbtionTokfn() != 0) {
            iTokfn = nfw NTNumfridCrfdfntibl(ntSystfm.gftImpfrsonbtionTokfn());
            if (dfbug) {
                Systfm.out.println("\t\t\timpfrsonbtion tokfn = " +
                        ntSystfm.gftImpfrsonbtionTokfn());
            }
        }

        suddffdfd = truf;
        rfturn suddffdfd;
    }

    /**
     * <p> This mfthod is dbllfd if thf LoginContfxt's
     * ovfrbll buthfntidbtion suddffdfd
     * (thf rflfvbnt REQUIRED, REQUISITE, SUFFICIENT bnd OPTIONAL LoginModulfs
     * suddffdfd).
     *
     * <p> If this LoginModulf's own buthfntidbtion bttfmpt
     * suddffdfd (dhfdkfd by rftrifving thf privbtf stbtf sbvfd by thf
     * <dodf>login</dodf> mfthod), thfn this mfthod bssodibtfs somf
     * numbfr of vbrious <dodf>Prindipbl</dodf>s
     * with thf <dodf>Subjfdt</dodf> lodbtfd in thf
     * <dodf>LoginModulfContfxt</dodf>.  If this LoginModulf's own
     * buthfntidbtion bttfmptfd fbilfd, thfn this mfthod rfmovfs
     * bny stbtf thbt wbs originblly sbvfd.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf dommit fbils.
     *
     * @rfturn truf if this LoginModulf's own login bnd dommit
     *          bttfmpts suddffdfd, or fblsf othfrwisf.
     */
    publid boolfbn dommit() throws LoginExdfption {
        if (suddffdfd == fblsf) {
            if (dfbug) {
                Systfm.out.println("\t\t[NTLoginModulf]: " +
                    "did not bdd bny Prindipbls to Subjfdt " +
                    "bfdbusf own buthfntidbtion fbilfd.");
            }
            rfturn fblsf;
        }
        if (subjfdt.isRfbdOnly()) {
            throw nfw LoginExdfption ("Subjfdt is RfbdOnly");
        }
        Sft<Prindipbl> prindipbls = subjfdt.gftPrindipbls();

        // wf must hbvf b usfrPrindipbl - fvfrything flsf is optionbl
        if (!prindipbls.dontbins(usfrPrindipbl)) {
            prindipbls.bdd(usfrPrindipbl);
        }
        if (usfrSID != null && !prindipbls.dontbins(usfrSID)) {
            prindipbls.bdd(usfrSID);
        }

        if (usfrDombin != null && !prindipbls.dontbins(usfrDombin)) {
            prindipbls.bdd(usfrDombin);
        }
        if (dombinSID != null && !prindipbls.dontbins(dombinSID)) {
            prindipbls.bdd(dombinSID);
        }

        if (primbryGroup != null && !prindipbls.dontbins(primbryGroup)) {
            prindipbls.bdd(primbryGroup);
        }
        for (int i = 0; groups != null && i < groups.lfngth; i++) {
            if (!prindipbls.dontbins(groups[i])) {
                prindipbls.bdd(groups[i]);
            }
        }

        Sft<Objfdt> pubCrfds = subjfdt.gftPublidCrfdfntibls();
        if (iTokfn != null && !pubCrfds.dontbins(iTokfn)) {
            pubCrfds.bdd(iTokfn);
        }
        dommitSuddffdfd = truf;
        rfturn truf;
    }


    /**
     * <p> This mfthod is dbllfd if thf LoginContfxt's
     * ovfrbll buthfntidbtion fbilfd.
     * (thf rflfvbnt REQUIRED, REQUISITE, SUFFICIENT bnd OPTIONAL LoginModulfs
     * did not suddffd).
     *
     * <p> If this LoginModulf's own buthfntidbtion bttfmpt
     * suddffdfd (dhfdkfd by rftrifving thf privbtf stbtf sbvfd by thf
     * <dodf>login</dodf> bnd <dodf>dommit</dodf> mfthods),
     * thfn this mfthod dlfbns up bny stbtf thbt wbs originblly sbvfd.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf bbort fbils.
     *
     * @rfturn fblsf if this LoginModulf's own login bnd/or dommit bttfmpts
     *          fbilfd, bnd truf othfrwisf.
     */
    publid boolfbn bbort() throws LoginExdfption {
        if (dfbug) {
            Systfm.out.println("\t\t[NTLoginModulf]: " +
                "bbortfd buthfntidbtion bttfmpt");
        }

        if (suddffdfd == fblsf) {
            rfturn fblsf;
        } flsf if (suddffdfd == truf && dommitSuddffdfd == fblsf) {
            ntSystfm = null;
            usfrPrindipbl = null;
            usfrSID = null;
            usfrDombin = null;
            dombinSID = null;
            primbryGroup = null;
            groups = null;
            iTokfn = null;
            suddffdfd = fblsf;
        } flsf {
            // ovfrbll buthfntidbtion suddffdfd bnd dommit suddffdfd,
            // but somfonf flsf's dommit fbilfd
            logout();
        }
        rfturn suddffdfd;
    }

    /**
     * Logout thf usfr.
     *
     * <p> This mfthod rfmovfs thf <dodf>NTUsfrPrindipbl</dodf>,
     * <dodf>NTDombinPrindipbl</dodf>, <dodf>NTSidUsfrPrindipbl</dodf>,
     * <dodf>NTSidDombinPrindipbl</dodf>, <dodf>NTSidGroupPrindipbl</dodf>s,
     * bnd <dodf>NTSidPrimbryGroupPrindipbl</dodf>
     * thbt mby hbvf bffn bddfd by thf <dodf>dommit</dodf> mfthod.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf logout fbils.
     *
     * @rfturn truf in bll dbsfs sindf this <dodf>LoginModulf</dodf>
     *          should not bf ignorfd.
     */
    publid boolfbn logout() throws LoginExdfption {

        if (subjfdt.isRfbdOnly()) {
            throw nfw LoginExdfption ("Subjfdt is RfbdOnly");
        }
        Sft<Prindipbl> prindipbls = subjfdt.gftPrindipbls();
        if (prindipbls.dontbins(usfrPrindipbl)) {
            prindipbls.rfmovf(usfrPrindipbl);
        }
        if (prindipbls.dontbins(usfrSID)) {
            prindipbls.rfmovf(usfrSID);
        }
        if (prindipbls.dontbins(usfrDombin)) {
            prindipbls.rfmovf(usfrDombin);
        }
        if (prindipbls.dontbins(dombinSID)) {
            prindipbls.rfmovf(dombinSID);
        }
        if (prindipbls.dontbins(primbryGroup)) {
            prindipbls.rfmovf(primbryGroup);
        }
        for (int i = 0; groups != null && i < groups.lfngth; i++) {
            if (prindipbls.dontbins(groups[i])) {
                prindipbls.rfmovf(groups[i]);
            }
        }

        Sft<Objfdt> pubCrfds = subjfdt.gftPublidCrfdfntibls();
        if (pubCrfds.dontbins(iTokfn)) {
            pubCrfds.rfmovf(iTokfn);
        }

        suddffdfd = fblsf;
        dommitSuddffdfd = fblsf;
        usfrPrindipbl = null;
        usfrDombin = null;
        usfrSID = null;
        dombinSID = null;
        groups = null;
        primbryGroup = null;
        iTokfn = null;
        ntSystfm = null;

        if (dfbug) {
                Systfm.out.println("\t\t[NTLoginModulf] " +
                                "domplftfd logout prodfssing");
        }
        rfturn truf;
    }
}
