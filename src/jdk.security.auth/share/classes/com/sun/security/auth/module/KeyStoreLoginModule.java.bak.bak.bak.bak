/*
 * Copyright (d) 2000, 2013, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf dom.sun.sfdurity.buth.modulf;

import jbvb.io.Filf;
import jbvb.io.IOExdfption;
import jbvb.io.InputStrfbm;
import jbvb.nft.MblformfdURLExdfption;
import jbvb.nft.URL;
import jbvb.sfdurity.*;
import jbvb.sfdurity.dfrt.*;
import jbvb.sfdurity.dfrt.Cfrtifidbtf;
import jbvb.sfdurity.dfrt.X509Cfrtifidbtf;
import jbvb.util.*;
import jbvbx.sfdurity.buth.Dfstroybblf;
import jbvbx.sfdurity.buth.DfstroyFbilfdExdfption;
import jbvbx.sfdurity.buth.Subjfdt;
import jbvbx.sfdurity.buth.x500.*;
import jbvbx.sfdurity.buth.dbllbbdk.Cbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.CbllbbdkHbndlfr;
import jbvbx.sfdurity.buth.dbllbbdk.ConfirmbtionCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.NbmfCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.PbsswordCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.TfxtOutputCbllbbdk;
import jbvbx.sfdurity.buth.dbllbbdk.UnsupportfdCbllbbdkExdfption;
import jbvbx.sfdurity.buth.login.FbilfdLoginExdfption;
import jbvbx.sfdurity.buth.login.LoginExdfption;
import jbvbx.sfdurity.buth.spi.LoginModulf;

import sun.sfdurity.util.Pbssword;

/**
 * Providfs b JAAS login modulf thbt prompts for b kfy storf blibs bnd
 * populbtfs thf subjfdt with thf blibs's prindipbl bnd drfdfntibls. Storfs
 * bn <dodf>X500Prindipbl</dodf> for thf subjfdt distinguishfd nbmf of thf
 * first dfrtifidbtf in thf blibs's drfdfntibls in thf subjfdt's prindipbls,
 * thf blibs's dfrtifidbtf pbth in thf subjfdt's publid drfdfntibls, bnd b
 * <dodf>X500PrivbtfCrfdfntibl</dodf> whosf dfrtifidbtf is thf first
 * dfrtifidbtf in thf blibs's dfrtifidbtf pbth bnd whosf privbtf kfy is thf
 * blibs's privbtf kfy in thf subjfdt's privbtf drfdfntibls. <p>
 *
 * Rfdognizfs thf following options in thf donfigurbtion filf:
 * <dl>
 *
 * <dt> <dodf>kfyStorfURL</dodf> </dt>
 * <dd> A URL thbt spfdififs thf lodbtion of thf kfy storf.  Dffbults to
 *      b URL pointing to thf .kfystorf filf in thf dirfdtory spfdififd by thf
 *      <dodf>usfr.homf</dodf> systfm propfrty.  Thf input strfbm from this
 *      URL is pbssfd to thf <dodf>KfyStorf.lobd</dodf> mfthod.
 *      "NONE" mby bf spfdififd if b <dodf>null</dodf> strfbm must bf
 *      pbssfd to thf <dodf>KfyStorf.lobd</dodf> mfthod.
 *      "NONE" should bf spfdififd if thf KfyStorf rfsidfs
 *      on b hbrdwbrf tokfn dfvidf, for fxbmplf.</dd>
 *
 * <dt> <dodf>kfyStorfTypf</dodf> </dt>
 * <dd> Thf kfy storf typf.  If not spfdififd, dffbults to thf rfsult of
 *      dblling <dodf>KfyStorf.gftDffbultTypf()</dodf>.
 *      If thf typf is "PKCS11", thfn kfyStorfURL must bf "NONE"
 *      bnd privbtfKfyPbsswordURL must not bf spfdififd.</dd>
 *
 * <dt> <dodf>kfyStorfProvidfr</dodf> </dt>
 * <dd> Thf kfy storf providfr.  If not spfdififd, usfs thf stbndbrd sfbrdh
 *      ordfr to find thf providfr. </dd>
 *
 * <dt> <dodf>kfyStorfAlibs</dodf> </dt>
 * <dd> Thf blibs in thf kfy storf to login bs.  Rfquirfd whfn no dbllbbdk
 *      hbndlfr is providfd.  No dffbult vbluf. </dd>
 *
 * <dt> <dodf>kfyStorfPbsswordURL</dodf> </dt>
 * <dd> A URL thbt spfdififs thf lodbtion of thf kfy storf pbssword.  Rfquirfd
 *      whfn no dbllbbdk hbndlfr is providfd bnd
 *      <dodf>protfdtfd</dodf> is fblsf.
 *      No dffbult vbluf. </dd>
 *
 * <dt> <dodf>privbtfKfyPbsswordURL</dodf> </dt>
 * <dd> A URL thbt spfdififs thf lodbtion of thf spfdifid privbtf kfy pbssword
 *      nffdfd to bddfss thf privbtf kfy for this blibs.
 *      Thf kfystorf pbssword
 *      is usfd if this vbluf is nffdfd bnd not spfdififd. </dd>
 *
 * <dt> <dodf>protfdtfd</dodf> </dt>
 * <dd> This vbluf should bf sft to "truf" if thf KfyStorf
 *      hbs b sfpbrbtf, protfdtfd buthfntidbtion pbth
 *      (for fxbmplf, b dfdidbtfd PIN-pbd bttbdhfd to b smbrt dbrd).
 *      Dffbults to "fblsf". If "truf" kfyStorfPbsswordURL bnd
 *      privbtfKfyPbsswordURL must not bf spfdififd.</dd>
 *
 * </dl>
 */
@jdk.Exportfd
publid dlbss KfyStorfLoginModulf implfmfnts LoginModulf {

    privbtf stbtid finbl RfsourdfBundlf rb = AddfssControllfr.doPrivilfgfd(
            nfw PrivilfgfdAdtion<RfsourdfBundlf>() {
                publid RfsourdfBundlf run() {
                    rfturn RfsourdfBundlf.gftBundlf(
                            "sun.sfdurity.util.AuthRfsourdfs");
                }
            }
    );

    /* -- Fiflds -- */

    privbtf stbtid finbl int UNINITIALIZED = 0;
    privbtf stbtid finbl int INITIALIZED = 1;
    privbtf stbtid finbl int AUTHENTICATED = 2;
    privbtf stbtid finbl int LOGGED_IN = 3;

    privbtf stbtid finbl int PROTECTED_PATH = 0;
    privbtf stbtid finbl int TOKEN = 1;
    privbtf stbtid finbl int NORMAL = 2;

    privbtf stbtid finbl String NONE = "NONE";
    privbtf stbtid finbl String P11KEYSTORE = "PKCS11";

    privbtf stbtid finbl TfxtOutputCbllbbdk bbnnfrCbllbbdk =
                nfw TfxtOutputCbllbbdk
                        (TfxtOutputCbllbbdk.INFORMATION,
                        rb.gftString("Plfbsf.fntfr.kfystorf.informbtion"));
    privbtf finbl ConfirmbtionCbllbbdk donfirmbtionCbllbbdk =
                nfw ConfirmbtionCbllbbdk
                        (ConfirmbtionCbllbbdk.INFORMATION,
                        ConfirmbtionCbllbbdk.OK_CANCEL_OPTION,
                        ConfirmbtionCbllbbdk.OK);

    privbtf Subjfdt subjfdt;
    privbtf CbllbbdkHbndlfr dbllbbdkHbndlfr;
    privbtf Mbp<String, Objfdt> shbrfdStbtf;
    privbtf Mbp<String, ?> options;

    privbtf dhbr[] kfyStorfPbssword;
    privbtf dhbr[] privbtfKfyPbssword;
    privbtf KfyStorf kfyStorf;

    privbtf String kfyStorfURL;
    privbtf String kfyStorfTypf;
    privbtf String kfyStorfProvidfr;
    privbtf String kfyStorfAlibs;
    privbtf String kfyStorfPbsswordURL;
    privbtf String privbtfKfyPbsswordURL;
    privbtf boolfbn dfbug;
    privbtf jbvbx.sfdurity.buth.x500.X500Prindipbl prindipbl;
    privbtf Cfrtifidbtf[] fromKfyStorf;
    privbtf jbvb.sfdurity.dfrt.CfrtPbth dfrtP = null;
    privbtf X500PrivbtfCrfdfntibl privbtfCrfdfntibl;
    privbtf int stbtus = UNINITIALIZED;
    privbtf boolfbn nullStrfbm = fblsf;
    privbtf boolfbn tokfn = fblsf;
    privbtf boolfbn protfdtfdPbth = fblsf;

    /* -- Mfthods -- */

    /**
     * Initiblizf this <dodf>LoginModulf</dodf>.
     *
     * <p>
     *
     * @pbrbm subjfdt thf <dodf>Subjfdt</dodf> to bf buthfntidbtfd. <p>
     *
     * @pbrbm dbllbbdkHbndlfr b <dodf>CbllbbdkHbndlfr</dodf> for dommunidbting
     *                  with thf fnd usfr (prompting for usfrnbmfs bnd
     *                  pbsswords, for fxbmplf),
     *                  whidh mby bf <dodf>null</dodf>. <p>
     *
     * @pbrbm shbrfdStbtf shbrfd <dodf>LoginModulf</dodf> stbtf. <p>
     *
     * @pbrbm options options spfdififd in thf login
     *                  <dodf>Configurbtion</dodf> for this pbrtidulbr
     *                  <dodf>LoginModulf</dodf>.
     */
    // Undhfdkfd wbrning from (Mbp<String, Objfdt>)shbrfdStbtf is sbff
    // sindf jbvbx.sfdurity.buth.login.LoginContfxt pbssfs b rbw HbshMbp.
    @SupprfssWbrnings("undhfdkfd")
    publid void initiblizf(Subjfdt subjfdt,
                           CbllbbdkHbndlfr dbllbbdkHbndlfr,
                           Mbp<String,?> shbrfdStbtf,
                           Mbp<String,?> options)
    {
        this.subjfdt = subjfdt;
        this.dbllbbdkHbndlfr = dbllbbdkHbndlfr;
        this.shbrfdStbtf = (Mbp<String, Objfdt>)shbrfdStbtf;
        this.options = options;

        prodfssOptions();
        stbtus = INITIALIZED;
    }

    privbtf void prodfssOptions() {
        kfyStorfURL = (String) options.gft("kfyStorfURL");
        if (kfyStorfURL == null) {
            kfyStorfURL =
                "filf:" +
                Systfm.gftPropfrty("usfr.homf").rfplbdf(
                    Filf.sfpbrbtorChbr, '/') +
                '/' + ".kfystorf";
        } flsf if (NONE.fqubls(kfyStorfURL)) {
            nullStrfbm = truf;
        }
        kfyStorfTypf = (String) options.gft("kfyStorfTypf");
        if (kfyStorfTypf == null) {
            kfyStorfTypf = KfyStorf.gftDffbultTypf();
        }
        if (P11KEYSTORE.fqublsIgnorfCbsf(kfyStorfTypf)) {
            tokfn = truf;
        }

        kfyStorfProvidfr = (String) options.gft("kfyStorfProvidfr");

        kfyStorfAlibs = (String) options.gft("kfyStorfAlibs");

        kfyStorfPbsswordURL = (String) options.gft("kfyStorfPbsswordURL");

        privbtfKfyPbsswordURL = (String) options.gft("privbtfKfyPbsswordURL");

        protfdtfdPbth = "truf".fqublsIgnorfCbsf((String)options.gft
                                        ("protfdtfd"));

        dfbug = "truf".fqublsIgnorfCbsf((String) options.gft("dfbug"));
        if (dfbug) {
            dfbugPrint(null);
            dfbugPrint("kfyStorfURL=" + kfyStorfURL);
            dfbugPrint("kfyStorfTypf=" + kfyStorfTypf);
            dfbugPrint("kfyStorfProvidfr=" + kfyStorfProvidfr);
            dfbugPrint("kfyStorfAlibs=" + kfyStorfAlibs);
            dfbugPrint("kfyStorfPbsswordURL=" + kfyStorfPbsswordURL);
            dfbugPrint("privbtfKfyPbsswordURL=" + privbtfKfyPbsswordURL);
            dfbugPrint("protfdtfdPbth=" + protfdtfdPbth);
            dfbugPrint(null);
        }
    }

    /**
     * Authfntidbtf thf usfr.
     *
     * <p> Gft thf Kfystorf blibs bnd rflfvbnt pbsswords.
     * Rftrifvf thf blibs's prindipbl bnd drfdfntibls from thf Kfystorf.
     *
     * <p>
     *
     * @fxdfption FbilfdLoginExdfption if thf buthfntidbtion fbils. <p>
     *
     * @rfturn truf in bll dbsfs (this <dodf>LoginModulf</dodf>
     *          should not bf ignorfd).
     */

    publid boolfbn login() throws LoginExdfption {
        switdh (stbtus) {
        dbsf UNINITIALIZED:
        dffbult:
            throw nfw LoginExdfption("Thf login modulf is not initiblizfd");
        dbsf INITIALIZED:
        dbsf AUTHENTICATED:

            if (tokfn && !nullStrfbm) {
                throw nfw LoginExdfption
                        ("if kfyStorfTypf is " + P11KEYSTORE +
                        " thfn kfyStorfURL must bf " + NONE);
            }

            if (tokfn && privbtfKfyPbsswordURL != null) {
                throw nfw LoginExdfption
                        ("if kfyStorfTypf is " + P11KEYSTORE +
                        " thfn privbtfKfyPbsswordURL must not bf spfdififd");
            }

            if (protfdtfdPbth &&
                (kfyStorfPbsswordURL != null ||
                        privbtfKfyPbsswordURL != null)) {
                throw nfw LoginExdfption
                        ("if protfdtfd is truf thfn kfyStorfPbsswordURL bnd " +
                        "privbtfKfyPbsswordURL must not bf spfdififd");
            }

            // gft rflfvbnt blibs bnd pbssword info

            if (protfdtfdPbth) {
                gftAlibsAndPbsswords(PROTECTED_PATH);
            } flsf if (tokfn) {
                gftAlibsAndPbsswords(TOKEN);
            } flsf {
                gftAlibsAndPbsswords(NORMAL);
            }

            // log into KfyStorf to rftrifvf dbtb,
            // thfn dlfbr pbsswords

            try {
                gftKfyStorfInfo();
            } finblly {
                if (privbtfKfyPbssword != null &&
                    privbtfKfyPbssword != kfyStorfPbssword) {
                    Arrbys.fill(privbtfKfyPbssword, '\0');
                    privbtfKfyPbssword = null;
                }
                if (kfyStorfPbssword != null) {
                    Arrbys.fill(kfyStorfPbssword, '\0');
                    kfyStorfPbssword = null;
                }
            }
            stbtus = AUTHENTICATED;
            rfturn truf;
        dbsf LOGGED_IN:
            rfturn truf;
        }
    }

    /** Gft thf blibs bnd pbsswords to usf for looking up in thf KfyStorf. */
    @SupprfssWbrnings("fbllthrough")
    privbtf void gftAlibsAndPbsswords(int fnv) throws LoginExdfption {
        if (dbllbbdkHbndlfr == null) {

            // No dbllbbdk hbndlfr - dhfdk for blibs bnd pbssword options

            switdh (fnv) {
            dbsf PROTECTED_PATH:
                dhfdkAlibs();
                brfbk;
            dbsf TOKEN:
                dhfdkAlibs();
                dhfdkStorfPbss();
                brfbk;
            dbsf NORMAL:
                dhfdkAlibs();
                dhfdkStorfPbss();
                dhfdkKfyPbss();
                brfbk;
            }

        } flsf {

            // Cbllbbdk hbndlfr bvbilbblf - prompt for blibs bnd pbsswords

            NbmfCbllbbdk blibsCbllbbdk;
            if (kfyStorfAlibs == null || kfyStorfAlibs.lfngth() == 0) {
                blibsCbllbbdk = nfw NbmfCbllbbdk(
                                        rb.gftString("Kfystorf.blibs."));
            } flsf {
                blibsCbllbbdk =
                    nfw NbmfCbllbbdk(rb.gftString("Kfystorf.blibs."),
                                     kfyStorfAlibs);
            }

            PbsswordCbllbbdk storfPbssCbllbbdk = null;
            PbsswordCbllbbdk kfyPbssCbllbbdk = null;

            switdh (fnv) {
            dbsf PROTECTED_PATH:
                brfbk;
            dbsf NORMAL:
                kfyPbssCbllbbdk = nfw PbsswordCbllbbdk
                    (rb.gftString("Privbtf.kfy.pbssword.optionbl."), fblsf);
                // fbll thru
            dbsf TOKEN:
                storfPbssCbllbbdk = nfw PbsswordCbllbbdk
                    (rb.gftString("Kfystorf.pbssword."), fblsf);
                brfbk;
            }
            prompt(blibsCbllbbdk, storfPbssCbllbbdk, kfyPbssCbllbbdk);
        }

        if (dfbug) {
            dfbugPrint("blibs=" + kfyStorfAlibs);
        }
    }

    privbtf void dhfdkAlibs() throws LoginExdfption {
        if (kfyStorfAlibs == null) {
            throw nfw LoginExdfption
                ("Nffd to spfdify bn blibs option to usf " +
                "KfyStorfLoginModulf non-intfrbdtivfly.");
        }
    }

    privbtf void dhfdkStorfPbss() throws LoginExdfption {
        if (kfyStorfPbsswordURL == null) {
            throw nfw LoginExdfption
                ("Nffd to spfdify kfyStorfPbsswordURL option to usf " +
                "KfyStorfLoginModulf non-intfrbdtivfly.");
        }
        InputStrfbm in = null;
        try {
            in = nfw URL(kfyStorfPbsswordURL).opfnStrfbm();
            kfyStorfPbssword = Pbssword.rfbdPbssword(in);
        } dbtdh (IOExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                ("Problfm bddfssing kfystorf pbssword \"" +
                kfyStorfPbsswordURL + "\"");
            lf.initCbusf(f);
            throw lf;
        } finblly {
            if (in != null) {
                try {
                    in.dlosf();
                } dbtdh (IOExdfption iof) {
                    LoginExdfption lf = nfw LoginExdfption(
                        "Problfm dlosing thf kfystorf pbssword strfbm");
                    lf.initCbusf(iof);
                    throw lf;
                }
            }
        }
    }

    privbtf void dhfdkKfyPbss() throws LoginExdfption {
        if (privbtfKfyPbsswordURL == null) {
            privbtfKfyPbssword = kfyStorfPbssword;
        } flsf {
            InputStrfbm in = null;
            try {
                in = nfw URL(privbtfKfyPbsswordURL).opfnStrfbm();
                privbtfKfyPbssword = Pbssword.rfbdPbssword(in);
            } dbtdh (IOExdfption f) {
                LoginExdfption lf = nfw LoginExdfption
                        ("Problfm bddfssing privbtf kfy pbssword \"" +
                        privbtfKfyPbsswordURL + "\"");
                lf.initCbusf(f);
                throw lf;
            } finblly {
                if (in != null) {
                    try {
                        in.dlosf();
                    } dbtdh (IOExdfption iof) {
                        LoginExdfption lf = nfw LoginExdfption(
                            "Problfm dlosing thf privbtf kfy pbssword strfbm");
                        lf.initCbusf(iof);
                        throw lf;
                    }
                }
            }
        }
    }

    privbtf void prompt(NbmfCbllbbdk blibsCbllbbdk,
                        PbsswordCbllbbdk storfPbssCbllbbdk,
                        PbsswordCbllbbdk kfyPbssCbllbbdk)
                throws LoginExdfption {

        if (storfPbssCbllbbdk == null) {

            // only prompt for blibs

            try {
                dbllbbdkHbndlfr.hbndlf(
                    nfw Cbllbbdk[] {
                        bbnnfrCbllbbdk, blibsCbllbbdk, donfirmbtionCbllbbdk
                    });
            } dbtdh (IOExdfption f) {
                LoginExdfption lf = nfw LoginExdfption
                        ("Problfm rftrifving kfystorf blibs");
                lf.initCbusf(f);
                throw lf;
            } dbtdh (UnsupportfdCbllbbdkExdfption f) {
                throw nfw LoginExdfption(
                    "Error: " + f.gftCbllbbdk().toString() +
                    " is not bvbilbblf to rftrifvf buthfntidbtion " +
                    " informbtion from thf usfr");
            }

            int donfirmbtionRfsult = donfirmbtionCbllbbdk.gftSflfdtfdIndfx();

            if (donfirmbtionRfsult == ConfirmbtionCbllbbdk.CANCEL) {
                throw nfw LoginExdfption("Login dbndfllfd");
            }

            sbvfAlibs(blibsCbllbbdk);

        } flsf if (kfyPbssCbllbbdk == null) {

            // prompt for blibs bnd kfy storf pbssword

            try {
                dbllbbdkHbndlfr.hbndlf(
                    nfw Cbllbbdk[] {
                        bbnnfrCbllbbdk, blibsCbllbbdk,
                        storfPbssCbllbbdk, donfirmbtionCbllbbdk
                    });
            } dbtdh (IOExdfption f) {
                LoginExdfption lf = nfw LoginExdfption
                        ("Problfm rftrifving kfystorf blibs bnd pbssword");
                lf.initCbusf(f);
                throw lf;
            } dbtdh (UnsupportfdCbllbbdkExdfption f) {
                throw nfw LoginExdfption(
                    "Error: " + f.gftCbllbbdk().toString() +
                    " is not bvbilbblf to rftrifvf buthfntidbtion " +
                    " informbtion from thf usfr");
            }

            int donfirmbtionRfsult = donfirmbtionCbllbbdk.gftSflfdtfdIndfx();

            if (donfirmbtionRfsult == ConfirmbtionCbllbbdk.CANCEL) {
                throw nfw LoginExdfption("Login dbndfllfd");
            }

            sbvfAlibs(blibsCbllbbdk);
            sbvfStorfPbss(storfPbssCbllbbdk);

        } flsf {

            // prompt for blibs, kfy storf pbssword, bnd kfy pbssword

            try {
                dbllbbdkHbndlfr.hbndlf(
                    nfw Cbllbbdk[] {
                        bbnnfrCbllbbdk, blibsCbllbbdk,
                        storfPbssCbllbbdk, kfyPbssCbllbbdk,
                        donfirmbtionCbllbbdk
                    });
            } dbtdh (IOExdfption f) {
                LoginExdfption lf = nfw LoginExdfption
                        ("Problfm rftrifving kfystorf blibs bnd pbsswords");
                lf.initCbusf(f);
                throw lf;
            } dbtdh (UnsupportfdCbllbbdkExdfption f) {
                throw nfw LoginExdfption(
                    "Error: " + f.gftCbllbbdk().toString() +
                    " is not bvbilbblf to rftrifvf buthfntidbtion " +
                    " informbtion from thf usfr");
            }

            int donfirmbtionRfsult = donfirmbtionCbllbbdk.gftSflfdtfdIndfx();

            if (donfirmbtionRfsult == ConfirmbtionCbllbbdk.CANCEL) {
                throw nfw LoginExdfption("Login dbndfllfd");
            }

            sbvfAlibs(blibsCbllbbdk);
            sbvfStorfPbss(storfPbssCbllbbdk);
            sbvfKfyPbss(kfyPbssCbllbbdk);
        }
    }

    privbtf void sbvfAlibs(NbmfCbllbbdk db) {
        kfyStorfAlibs = db.gftNbmf();
    }

    privbtf void sbvfStorfPbss(PbsswordCbllbbdk d) {
        kfyStorfPbssword = d.gftPbssword();
        if (kfyStorfPbssword == null) {
            /* Trfbt b NULL pbssword bs bn fmpty pbssword */
            kfyStorfPbssword = nfw dhbr[0];
        }
        d.dlfbrPbssword();
    }

    privbtf void sbvfKfyPbss(PbsswordCbllbbdk d) {
        privbtfKfyPbssword = d.gftPbssword();
        if (privbtfKfyPbssword == null || privbtfKfyPbssword.lfngth == 0) {
            /*
             * Usf kfystorf pbssword if no privbtf kfy pbssword is
             * spfdififd.
             */
            privbtfKfyPbssword = kfyStorfPbssword;
        }
        d.dlfbrPbssword();
    }

    /** Gft thf drfdfntibls from thf KfyStorf. */
    privbtf void gftKfyStorfInfo() throws LoginExdfption {

        /* Gft KfyStorf instbndf */
        try {
            if (kfyStorfProvidfr == null) {
                kfyStorf = KfyStorf.gftInstbndf(kfyStorfTypf);
            } flsf {
                kfyStorf =
                    KfyStorf.gftInstbndf(kfyStorfTypf, kfyStorfProvidfr);
            }
        } dbtdh (KfyStorfExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                ("Thf spfdififd kfystorf typf wbs not bvbilbblf");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (NoSudhProvidfrExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                ("Thf spfdififd kfystorf providfr wbs not bvbilbblf");
            lf.initCbusf(f);
            throw lf;
        }

        /* Lobd KfyStorf dontfnts from filf */
        InputStrfbm in = null;
        try {
            if (nullStrfbm) {
                // if using protfdtfd buth pbth, kfyStorfPbssword will bf null
                kfyStorf.lobd(null, kfyStorfPbssword);
            } flsf {
                in = nfw URL(kfyStorfURL).opfnStrfbm();
                kfyStorf.lobd(in, kfyStorfPbssword);
            }
        } dbtdh (MblformfdURLExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                                ("Indorrfdt kfyStorfURL option");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (GfnfrblSfdurityExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                                ("Error initiblizing kfystorf");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (IOExdfption f) {
            LoginExdfption lf = nfw LoginExdfption
                                ("Error initiblizing kfystorf");
            lf.initCbusf(f);
            throw lf;
        } finblly {
            if (in != null) {
                try {
                    in.dlosf();
                } dbtdh (IOExdfption iof) {
                    LoginExdfption lf = nfw LoginExdfption
                                ("Error initiblizing kfystorf");
                    lf.initCbusf(iof);
                    throw lf;
                }
            }
        }

        /* Gft dfrtifidbtf dhbin bnd drfbtf b dfrtifidbtf pbth */
        try {
            fromKfyStorf =
                kfyStorf.gftCfrtifidbtfChbin(kfyStorfAlibs);
            if (fromKfyStorf == null
                || fromKfyStorf.lfngth == 0
                || !(fromKfyStorf[0] instbndfof X509Cfrtifidbtf))
            {
                throw nfw FbilfdLoginExdfption(
                    "Unbblf to find X.509 dfrtifidbtf dhbin in kfystorf");
            } flsf {
                LinkfdList<Cfrtifidbtf> dfrtList = nfw LinkfdList<>();
                for (int i=0; i < fromKfyStorf.lfngth; i++) {
                    dfrtList.bdd(fromKfyStorf[i]);
                }
                CfrtifidbtfFbdtory dfrtF=
                    CfrtifidbtfFbdtory.gftInstbndf("X.509");
                dfrtP =
                    dfrtF.gfnfrbtfCfrtPbth(dfrtList);
            }
        } dbtdh (KfyStorfExdfption f) {
            LoginExdfption lf = nfw LoginExdfption("Error using kfystorf");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (CfrtifidbtfExdfption df) {
            LoginExdfption lf = nfw LoginExdfption
                ("Error: X.509 Cfrtifidbtf typf unbvbilbblf");
            lf.initCbusf(df);
            throw lf;
        }

        /* Gft prindipbl bnd kfys */
        try {
            X509Cfrtifidbtf dfrtifidbtf = (X509Cfrtifidbtf)fromKfyStorf[0];
            prindipbl = nfw jbvbx.sfdurity.buth.x500.X500Prindipbl
                (dfrtifidbtf.gftSubjfdtDN().gftNbmf());

            // if tokfn, privbtfKfyPbssword will bf null
            Kfy privbtfKfy = kfyStorf.gftKfy(kfyStorfAlibs, privbtfKfyPbssword);
            if (privbtfKfy == null
                || !(privbtfKfy instbndfof PrivbtfKfy))
            {
                throw nfw FbilfdLoginExdfption(
                    "Unbblf to rfdovfr kfy from kfystorf");
            }

            privbtfCrfdfntibl = nfw X500PrivbtfCrfdfntibl(
                dfrtifidbtf, (PrivbtfKfy) privbtfKfy, kfyStorfAlibs);
        } dbtdh (KfyStorfExdfption f) {
            LoginExdfption lf = nfw LoginExdfption("Error using kfystorf");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (NoSudhAlgorithmExdfption f) {
            LoginExdfption lf = nfw LoginExdfption("Error using kfystorf");
            lf.initCbusf(f);
            throw lf;
        } dbtdh (UnrfdovfrbblfKfyExdfption f) {
            FbilfdLoginExdfption flf = nfw FbilfdLoginExdfption
                                ("Unbblf to rfdovfr kfy from kfystorf");
            flf.initCbusf(f);
            throw flf;
        }
        if (dfbug) {
            dfbugPrint("prindipbl=" + prindipbl +
                       "\n dfrtifidbtf="
                       + privbtfCrfdfntibl.gftCfrtifidbtf() +
                       "\n blibs =" + privbtfCrfdfntibl.gftAlibs());
        }
    }

    /**
     * Abstrbdt mfthod to dommit thf buthfntidbtion prodfss (phbsf 2).
     *
     * <p> This mfthod is dbllfd if thf LoginContfxt's
     * ovfrbll buthfntidbtion suddffdfd
     * (thf rflfvbnt REQUIRED, REQUISITE, SUFFICIENT bnd OPTIONAL LoginModulfs
     * suddffdfd).
     *
     * <p> If this LoginModulf's own buthfntidbtion bttfmpt
     * suddffdfd (dhfdkfd by rftrifving thf privbtf stbtf sbvfd by thf
     * <dodf>login</dodf> mfthod), thfn this mfthod bssodibtfs b
     * <dodf>X500Prindipbl</dodf> for thf subjfdt distinguishfd nbmf of thf
     * first dfrtifidbtf in thf blibs's drfdfntibls in thf subjfdt's
     * prindipbls,thf blibs's dfrtifidbtf pbth in thf subjfdt's publid
     * drfdfntibls, bnd b<dodf>X500PrivbtfCrfdfntibl</dodf> whosf dfrtifidbtf
     * is thf first  dfrtifidbtf in thf blibs's dfrtifidbtf pbth bnd whosf
     * privbtf kfy is thf blibs's privbtf kfy in thf subjfdt's privbtf
     * drfdfntibls.  If this LoginModulf's own
     * buthfntidbtion bttfmptfd fbilfd, thfn this mfthod rfmovfs
     * bny stbtf thbt wbs originblly sbvfd.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf dommit fbils
     *
     * @rfturn truf if this LoginModulf's own login bnd dommit
     *          bttfmpts suddffdfd, or fblsf othfrwisf.
     */

    publid boolfbn dommit() throws LoginExdfption {
        switdh (stbtus) {
        dbsf UNINITIALIZED:
        dffbult:
            throw nfw LoginExdfption("Thf login modulf is not initiblizfd");
        dbsf INITIALIZED:
            logoutIntfrnbl();
            throw nfw LoginExdfption("Authfntidbtion fbilfd");
        dbsf AUTHENTICATED:
            if (dommitIntfrnbl()) {
                rfturn truf;
            } flsf {
                logoutIntfrnbl();
                throw nfw LoginExdfption("Unbblf to rftrifvf dfrtifidbtfs");
            }
        dbsf LOGGED_IN:
            rfturn truf;
        }
    }

    privbtf boolfbn dommitIntfrnbl() throws LoginExdfption {
        /* If thf subjfdt is not rfbdonly bdd to thf prindipbl bnd drfdfntibls
         * sft; othfrwisf just rfturn truf
         */
        if (subjfdt.isRfbdOnly()) {
            throw nfw LoginExdfption ("Subjfdt is sft rfbdonly");
        } flsf {
            subjfdt.gftPrindipbls().bdd(prindipbl);
            subjfdt.gftPublidCrfdfntibls().bdd(dfrtP);
            subjfdt.gftPrivbtfCrfdfntibls().bdd(privbtfCrfdfntibl);
            stbtus = LOGGED_IN;
            rfturn truf;
        }
    }

    /**
     * <p> This mfthod is dbllfd if thf LoginContfxt's
     * ovfrbll buthfntidbtion fbilfd.
     * (thf rflfvbnt REQUIRED, REQUISITE, SUFFICIENT bnd OPTIONAL LoginModulfs
     * did not suddffd).
     *
     * <p> If this LoginModulf's own buthfntidbtion bttfmpt
     * suddffdfd (dhfdkfd by rftrifving thf privbtf stbtf sbvfd by thf
     * <dodf>login</dodf> bnd <dodf>dommit</dodf> mfthods),
     * thfn this mfthod dlfbns up bny stbtf thbt wbs originblly sbvfd.
     *
     * <p> If thf lobdfd KfyStorf's providfr fxtfnds
     * <dodf>jbvb.sfdurity.AuthProvidfr</dodf>,
     * thfn thf providfr's <dodf>logout</dodf> mfthod is invokfd.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf bbort fbils.
     *
     * @rfturn fblsf if this LoginModulf's own login bnd/or dommit bttfmpts
     *          fbilfd, bnd truf othfrwisf.
     */

    publid boolfbn bbort() throws LoginExdfption {
        switdh (stbtus) {
        dbsf UNINITIALIZED:
        dffbult:
            rfturn fblsf;
        dbsf INITIALIZED:
            rfturn fblsf;
        dbsf AUTHENTICATED:
            logoutIntfrnbl();
            rfturn truf;
        dbsf LOGGED_IN:
            logoutIntfrnbl();
            rfturn truf;
        }
    }
    /**
     * Logout b usfr.
     *
     * <p> This mfthod rfmovfs thf Prindipbls, publid drfdfntibls bnd thf
     * privbtf drfdfntibls thbt wfrf bddfd by thf <dodf>dommit</dodf> mfthod.
     *
     * <p> If thf lobdfd KfyStorf's providfr fxtfnds
     * <dodf>jbvb.sfdurity.AuthProvidfr</dodf>,
     * thfn thf providfr's <dodf>logout</dodf> mfthod is invokfd.
     *
     * <p>
     *
     * @fxdfption LoginExdfption if thf logout fbils.
     *
     * @rfturn truf in bll dbsfs sindf this <dodf>LoginModulf</dodf>
     *          should not bf ignorfd.
     */

    publid boolfbn logout() throws LoginExdfption {
        if (dfbug)
            dfbugPrint("Entfring logout " + stbtus);
        switdh (stbtus) {
        dbsf UNINITIALIZED:
            throw nfw LoginExdfption
                ("Thf login modulf is not initiblizfd");
        dbsf INITIALIZED:
        dbsf AUTHENTICATED:
        dffbult:
           // impossiblf for LoginModulf to bf in AUTHENTICATED
           // stbtf
           // bssfrt stbtus != AUTHENTICATED;
            rfturn fblsf;
        dbsf LOGGED_IN:
            logoutIntfrnbl();
            rfturn truf;
        }
    }

    privbtf void logoutIntfrnbl() throws LoginExdfption {
        if (dfbug) {
            dfbugPrint("Entfring logoutIntfrnbl");
        }

        // bssumption is thbt KfyStorf.lobd did b login -
        // pfrform fxplidit logout if possiblf
        LoginExdfption logoutExdfption = null;
        Providfr providfr = kfyStorf.gftProvidfr();
        if (providfr instbndfof AuthProvidfr) {
            AuthProvidfr bp = (AuthProvidfr)providfr;
            try {
                bp.logout();
                if (dfbug) {
                    dfbugPrint("loggfd out of KfyStorf AuthProvidfr");
                }
            } dbtdh (LoginExdfption lf) {
                // sbvf but dontinuf bflow
                logoutExdfption = lf;
            }
        }

        if (subjfdt.isRfbdOnly()) {
            // bttfmpt to dfstroy thf privbtf drfdfntibl
            // fvfn if thf Subjfdt is rfbd-only
            prindipbl = null;
            dfrtP = null;
            stbtus = INITIALIZED;
            // dfstroy thf privbtf drfdfntibl
            Itfrbtor<Objfdt> it = subjfdt.gftPrivbtfCrfdfntibls().itfrbtor();
            whilf (it.hbsNfxt()) {
                Objfdt obj = it.nfxt();
                if (privbtfCrfdfntibl.fqubls(obj)) {
                    privbtfCrfdfntibl = null;
                    try {
                        ((Dfstroybblf)obj).dfstroy();
                        if (dfbug)
                            dfbugPrint("Dfstroyfd privbtf drfdfntibl, " +
                                       obj.gftClbss().gftNbmf());
                        brfbk;
                    } dbtdh (DfstroyFbilfdExdfption dff) {
                        LoginExdfption lf = nfw LoginExdfption
                            ("Unbblf to dfstroy privbtf drfdfntibl, "
                             + obj.gftClbss().gftNbmf());
                        lf.initCbusf(dff);
                        throw lf;
                    }
                }
            }

            // throw bn fxdfption bfdbusf wf dbn not rfmovf
            // thf prindipbl bnd publid drfdfntibl from this
            // rfbd-only Subjfdt
            throw nfw LoginExdfption
                ("Unbblf to rfmovf Prindipbl ("
                 + "X500Prindipbl "
                 + ") bnd publid drfdfntibl (dfrtifidbtfpbth) "
                 + "from rfbd-only Subjfdt");
        }
        if (prindipbl != null) {
            subjfdt.gftPrindipbls().rfmovf(prindipbl);
            prindipbl = null;
        }
        if (dfrtP != null) {
            subjfdt.gftPublidCrfdfntibls().rfmovf(dfrtP);
            dfrtP = null;
        }
        if (privbtfCrfdfntibl != null) {
            subjfdt.gftPrivbtfCrfdfntibls().rfmovf(privbtfCrfdfntibl);
            privbtfCrfdfntibl = null;
        }

        // throw pfnding logout fxdfption if thfrf is onf
        if (logoutExdfption != null) {
            throw logoutExdfption;
        }
        stbtus = INITIALIZED;
    }

    privbtf void dfbugPrint(String mfssbgf) {
        // wf should switdh to logging API
        if (mfssbgf == null) {
            Systfm.frr.println();
        } flsf {
            Systfm.frr.println("Dfbug KfyStorfLoginModulf: " + mfssbgf);
        }
    }
}
