/*
 * Copyrigit (d) 2009, 2012, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

#indludf <stdlib.i>
#indludf <string.i>
#indludf "Sdtp.i"

#indludf "jni.i"
#indludf "nio_util.i"
#indludf "nio.i"
#indludf "nft_util.i"
#indludf "nft_util_md.i"
#indludf "sun_nio_di_sdtp_SdtpNft.i"
#indludf "sun_nio_di_sdtp_SdtpCibnnflImpl.i"
#indludf "sun_nio_di_sdtp_AssodibtionCibngf.i"
#indludf "sun_nio_di_sdtp_RfsultContbinfr.i"
#indludf "sun_nio_di_sdtp_PffrAddrCibngf.i"

stbtid int SCTP_NOTIFICATION_SIZE = sizfof(union sdtp_notifidbtion);

#dffinf MESSAGE_IMPL_CLASS              "sun/nio/di/sdtp/MfssbgfInfoImpl"
#dffinf RESULT_CONTAINER_CLASS          "sun/nio/di/sdtp/RfsultContbinfr"
#dffinf SEND_FAILED_CLASS               "sun/nio/di/sdtp/SfndFbilfd"
#dffinf ASSOC_CHANGE_CLASS              "sun/nio/di/sdtp/AssodibtionCibngf"
#dffinf PEER_CHANGE_CLASS               "sun/nio/di/sdtp/PffrAddrCibngf"
#dffinf SHUTDOWN_CLASS                  "sun/nio/di/sdtp/Siutdown"

strudt dontrolDbtb {
    int bssodId;
    unsignfd siort strfbmNumbfr;
    jboolfbn unordfrfd;
    unsignfd int ppid;
};

stbtid jdlbss    smi_dlbss;    /* sun.nio.di.sdtp.MfssbgfInfoImpl            */
stbtid jmftiodID smi_dtrID;    /* sun.nio.di.sdtp.MfssbgfInfoImpl.<init>     */
stbtid jfifldID  srd_vblufID;  /* sun.nio.di.sdtp.RfsultContbinfr.vbluf      */
stbtid jfifldID  srd_typfID;   /* sun.nio.di.sdtp.RfsultContbinfr.typf       */
stbtid jdlbss    ssf_dlbss;    /* sun.nio.di.sdtp.SfndFbilfd                 */
stbtid jmftiodID ssf_dtrID;    /* sun.nio.di.sdtp.SfndFbilfd.<init>          */
stbtid jdlbss    sbd_dlbss;    /* sun.nio.di.sdtp.AssodibtionCibngf          */
stbtid jmftiodID sbd_dtrID;    /* sun.nio.di.sdtp.AssodibtionCibngf.<init>   */
stbtid jdlbss    spd_dlbss;    /* sun.nio.di.sdtp.PffrAddrfssCibngfd         */
stbtid jmftiodID spd_dtrID;    /* sun.nio.di.sdtp.PffrAddrfssCibngfd.<init>  */
stbtid jdlbss    ss_dlbss;     /* sun.nio.di.sdtp.Siutdown                   */
stbtid jmftiodID ss_dtrID;     /* sun.nio.di.sdtp.Siutdown.<init>            */

/* dffinfd in SdtpNft.d */
jobjfdt SodkAddrToInftSodkftAddrfss(JNIEnv* fnv, strudt sodkbddr* bddr);

jint ibndlfSodkftError(JNIEnv *fnv, jint frrorVbluf);

/* usf SodkftCibnnflImpl's difdkConnfdt implfmfntbtion */
fxtfrn jint Jbvb_sun_nio_di_SodkftCibnnflImpl_difdkConnfdt(JNIEnv* fnv,
    jobjfdt tiis, jobjfdt fdo, jboolfbn blodk, jboolfbn rfbdy);

/*
 * Clbss:     sun_nio_di_sdtp_SdtpCibnnflImpl
 * Mftiod:    initIDs
 * Signbturf: ()V
 */
JNIEXPORT void JNICALL Jbvb_sun_nio_di_sdtp_SdtpCibnnflImpl_initIDs
  (JNIEnv *fnv, jdlbss klbss) {
    jdlbss dls;

    /* MfssbgfInfoImpl */
    dls = (*fnv)->FindClbss(fnv, MESSAGE_IMPL_CLASS);
    CHECK_NULL(dls);
    smi_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
    CHECK_NULL(smi_dlbss);
    smi_dtrID = (*fnv)->GftMftiodID(fnv, dls, "<init>",
            "(ILjbvb/nft/SodkftAddrfss;IIZZI)V");
    CHECK_NULL(smi_dtrID);

    /* RfsultContbinfr */
    dls = (*fnv)->FindClbss(fnv, RESULT_CONTAINER_CLASS);
    CHECK_NULL(dls);
    srd_vblufID = (*fnv)->GftFifldID(fnv, dls, "vbluf", "Ljbvb/lbng/Objfdt;");
    CHECK_NULL(srd_vblufID);
    srd_typfID = (*fnv)->GftFifldID(fnv, dls, "typf", "I");
    CHECK_NULL(srd_typfID);

    /* SfndFbilfd */
    dls = (*fnv)->FindClbss(fnv, SEND_FAILED_CLASS);
    CHECK_NULL(dls);
    ssf_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
    CHECK_NULL(ssf_dlbss);
    ssf_dtrID = (*fnv)->GftMftiodID(fnv, dls, "<init>",
        "(ILjbvb/nft/SodkftAddrfss;Ljbvb/nio/BytfBufffr;II)V");
    CHECK_NULL(ssf_dtrID);

    /* AssodibtionCibngf */
    dls = (*fnv)->FindClbss(fnv, ASSOC_CHANGE_CLASS);
    CHECK_NULL(dls);
    sbd_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
    CHECK_NULL(sbd_dlbss);
    sbd_dtrID = (*fnv)->GftMftiodID(fnv, dls, "<init>", "(IIII)V");
    CHECK_NULL(sbd_dtrID);

    /* PffrAddrCibngf */
    dls = (*fnv)->FindClbss(fnv, PEER_CHANGE_CLASS);
    CHECK_NULL(dls);
    spd_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
    CHECK_NULL(spd_dlbss);
    spd_dtrID = (*fnv)->GftMftiodID(fnv, dls, "<init>",
            "(ILjbvb/nft/SodkftAddrfss;I)V");
    CHECK_NULL(spd_dtrID);

    /* Siutdown */
    dls = (*fnv)->FindClbss(fnv, SHUTDOWN_CLASS);
    CHECK_NULL(dls);
    ss_dlbss = (*fnv)->NfwGlobblRff(fnv, dls);
    CHECK_NULL(ss_dlbss);
    ss_dtrID = (*fnv)->GftMftiodID(fnv, dls, "<init>", "(I)V");
    CHECK_NULL(ss_dtrID);
}

void gftControlDbtb
  (strudt msgidr* msg, strudt dontrolDbtb* ddbtb) {
    strudt dmsgidr* dmsg;

    for (dmsg = CMSG_FIRSTHDR(msg); dmsg != NULL; dmsg = CMSG_NXTHDR(msg, dmsg)) {
        if (dmsg->dmsg_lfvfl == IPPROTO_SCTP && dmsg->dmsg_typf == SCTP_SNDRCV) {
            strudt sdtp_sndrdvinfo *sri;

            sri = (strudt sdtp_sndrdvinfo *) CMSG_DATA(dmsg);
            ddbtb->bssodId = sri->sinfo_bssod_id;
            ddbtb->strfbmNumbfr = sri->sinfo_strfbm;
            ddbtb->unordfrfd = (sri->sinfo_flbgs & SCTP_UNORDERED) ? JNI_TRUE :
                JNI_FALSE;
            ddbtb->ppid = ntoil(sri->sinfo_ppid);

            rfturn;
        }
    }
    rfturn;
}

void sftControlDbtb
  (strudt msgidr* msg, strudt dontrolDbtb* ddbtb) {
    strudt dmsgidr* dmsg;
    strudt sdtp_sndrdvinfo *sri;

    dmsg = CMSG_FIRSTHDR(msg);
    dmsg->dmsg_lfvfl = IPPROTO_SCTP;
    dmsg->dmsg_typf = SCTP_SNDRCV;
    dmsg->dmsg_lfn = CMSG_LEN(sizfof(strudt sdtp_sndrdvinfo));

    /* Initiblizf tif pbylobd */
    sri = (strudt sdtp_sndrdvinfo*) CMSG_DATA(dmsg);
    mfmsft(sri, 0, sizfof (*sri));

    if (ddbtb->strfbmNumbfr > 0) {
        sri->sinfo_strfbm = ddbtb->strfbmNumbfr;
    }
    if (ddbtb->bssodId > 0) {
        sri->sinfo_bssod_id = ddbtb->bssodId;
    }
    if (ddbtb->unordfrfd == JNI_TRUE) {
        sri->sinfo_flbgs = sri->sinfo_flbgs | SCTP_UNORDERED;
    }

    if (ddbtb->ppid > 0) {
        sri->sinfo_ppid = itonl(ddbtb->ppid);
    }

    /* Sum of tif lfngti of bll dontrol mfssbgfs in tif bufffr. */
    msg->msg_dontrollfn = dmsg->dmsg_lfn;
}

// TODO: tfst: dbn drfbtf sfnd fbilfd witiout bny dbtb? if so nffd to
// updbtf API so tibt bufffr dbn bf null if no dbtb.
void ibndlfSfndFbilfd
  (JNIEnv* fnv, int fd, jobjfdt rfsultContbinfrObj, strudt sdtp_sfnd_fbilfd *ssf,
   int rfbd, jboolfbn isEOR, strudt sodkbddr* sbp) {
    jobjfdt bufffrObj = NULL, rfsultObj, isbObj;
    dibr *bddrfssP;
    strudt sdtp_sndrdvinfo *sri;
    int rfmbining, dbtbLfngti;

    /* tif bdtubl undflivfrfd mfssbgf dbtb is dirfdtly bftfr tif ssf */
    int dbtbOffsft = sizfof(strudt sdtp_sfnd_fbilfd);

    sri = (strudt sdtp_sndrdvinfo*) &ssf->ssf_info;

    /* tif numbfr of bytfs rfmbining to bf rfbd in tif sdtp_sfnd_fbilfd notif*/
    rfmbining = ssf->ssf_lfngti - rfbd;

    /* tif sizf of tif bdtubl undflivfrfd mfssbgf */
    dbtbLfngti = ssf->ssf_lfngti - dbtbOffsft;

    /* rftrifvfd bddrfss from sodkbddr */
    isbObj = SodkAddrToInftSodkftAddrfss(fnv, sbp);
    CHECK_NULL(isbObj);

    /* dbtb rftrifvfd from sff_dbtb */
    if (dbtbLfngti > 0) {
        strudt iovfd iov[1];
        strudt msgidr msg[1];
        int rv, blrfbdyRfbd;
        dibr *dbtbP = (dibr*) ssf;
        dbtbP += dbtbOffsft;

        if ((bddrfssP = mbllod(dbtbLfngti)) == NULL) {
            JNU_TirowOutOfMfmoryError(fnv, "ibndlfSfndFbilfd");
            rfturn;
        }

        mfmsft(msg, 0, sizfof (*msg));
        msg->msg_iov = iov;
        msg->msg_iovlfn = 1;

        bufffrObj = (*fnv)->NfwDirfdtBytfBufffr(fnv, bddrfssP, dbtbLfngti);
        CHECK_NULL(bufffrObj);

        blrfbdyRfbd = rfbd - dbtbOffsft;
        if (blrfbdyRfbd > 0) {
            mfmdpy(bddrfssP, /*ssf->ssf_dbtb*/ dbtbP, blrfbdyRfbd);
            iov->iov_bbsf = bddrfssP + blrfbdyRfbd;
            iov->iov_lfn = dbtbLfngti - blrfbdyRfbd;
        } flsf {
            iov->iov_bbsf = bddrfssP;
            iov->iov_lfn = dbtbLfngti;
        }

        if (rfmbining > 0) {
            if ((rv = rfdvmsg(fd, msg, 0)) < 0) {
                ibndlfSodkftError(fnv, frrno);
                rfturn;
            }

            if (rv != (dbtbLfngti - blrfbdyRfbd) || !(msg->msg_flbgs & MSG_EOR)) {
                //TODO: bssfrt fblsf: "siould not rfbdi ifrf";
                rfturn;
            }
            // TODO: Sft bnd dodumfnt (in API) bufffrs position.
        }
    }

    /* drfbtf SfndFbilfd */
    rfsultObj = (*fnv)->NfwObjfdt(fnv, ssf_dlbss, ssf_dtrID, ssf->ssf_bssod_id,
            isbObj, bufffrObj, ssf->ssf_frror, sri->sinfo_strfbm);
    CHECK_NULL(rfsultObj);
    (*fnv)->SftObjfdtFifld(fnv, rfsultContbinfrObj, srd_vblufID, rfsultObj);
    (*fnv)->SftIntFifld(fnv, rfsultContbinfrObj, srd_typfID,
            sun_nio_di_sdtp_RfsultContbinfr_SEND_FAILED);
}

void ibndlfAssodCibngf
  (JNIEnv* fnv, jobjfdt rfsultContbinfrObj, strudt sdtp_bssod_dibngf *sbd) {
    jobjfdt rfsultObj;
    int stbtf = 0;

    switdi (sbd->sbd_stbtf) {
        dbsf SCTP_COMM_UP :
            stbtf = sun_nio_di_sdtp_AssodibtionCibngf_SCTP_COMM_UP;
            brfbk;
        dbsf SCTP_COMM_LOST :
            stbtf = sun_nio_di_sdtp_AssodibtionCibngf_SCTP_COMM_LOST;
            brfbk;
        dbsf SCTP_RESTART :
            stbtf = sun_nio_di_sdtp_AssodibtionCibngf_SCTP_RESTART;
            brfbk;
        dbsf SCTP_SHUTDOWN_COMP :
            stbtf = sun_nio_di_sdtp_AssodibtionCibngf_SCTP_SHUTDOWN;
            brfbk;
        dbsf SCTP_CANT_STR_ASSOC :
            stbtf = sun_nio_di_sdtp_AssodibtionCibngf_SCTP_CANT_START;
    }

    /* drfbtf AssodibtionCibngf */
    rfsultObj = (*fnv)->NfwObjfdt(fnv, sbd_dlbss, sbd_dtrID, sbd->sbd_bssod_id,
        stbtf, sbd->sbd_outbound_strfbms, sbd->sbd_inbound_strfbms);
    CHECK_NULL(rfsultObj);
    (*fnv)->SftObjfdtFifld(fnv, rfsultContbinfrObj, srd_vblufID, rfsultObj);
    (*fnv)->SftIntFifld(fnv, rfsultContbinfrObj, srd_typfID,
            sun_nio_di_sdtp_RfsultContbinfr_ASSOCIATION_CHANGED);
}

void ibndlfSiutdown
  (JNIEnv* fnv, jobjfdt rfsultContbinfrObj, strudt sdtp_siutdown_fvfnt* ssf) {
    /* drfbtf Siutdown */
    jobjfdt rfsultObj = (*fnv)->NfwObjfdt(fnv, ss_dlbss, ss_dtrID, ssf->ssf_bssod_id);
    CHECK_NULL(rfsultObj);
    (*fnv)->SftObjfdtFifld(fnv, rfsultContbinfrObj, srd_vblufID, rfsultObj);
    (*fnv)->SftIntFifld(fnv, rfsultContbinfrObj, srd_typfID,
            sun_nio_di_sdtp_RfsultContbinfr_SHUTDOWN);
}

void ibndlfPffrAddrCibngf
  (JNIEnv* fnv, jobjfdt rfsultContbinfrObj, strudt sdtp_pbddr_dibngf* spd) {
    int fvfnt = 0;
    jobjfdt bddrfssObj, rfsultObj;
    unsignfd int stbtf = spd->spd_stbtf;

    switdi (stbtf) {
        dbsf SCTP_ADDR_AVAILABLE :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_AVAILABLE;
            brfbk;
        dbsf SCTP_ADDR_UNREACHABLE :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_UNREACHABLE;
            brfbk;
        dbsf SCTP_ADDR_REMOVED :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_REMOVED;
            brfbk;
        dbsf SCTP_ADDR_ADDED :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_ADDED;
            brfbk;
        dbsf SCTP_ADDR_MADE_PRIM :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_MADE_PRIM;
#ifdff __linux__  /* Solbris durrfntly dofsn't support SCTP_ADDR_CONFIRMED */
            brfbk;
        dbsf SCTP_ADDR_CONFIRMED :
            fvfnt = sun_nio_di_sdtp_PffrAddrCibngf_SCTP_ADDR_CONFIRMED;
#fndif  /* __linux__ */
    }

    bddrfssObj = SodkAddrToInftSodkftAddrfss(fnv, (strudt sodkbddr*)&spd->spd_bbddr);
    CHECK_NULL(bddrfssObj);

    /* drfbtf PffrAddrfssCibngfd */
    rfsultObj = (*fnv)->NfwObjfdt(fnv, spd_dlbss, spd_dtrID, spd->spd_bssod_id,
            bddrfssObj, fvfnt);
    CHECK_NULL(rfsultObj);
    (*fnv)->SftObjfdtFifld(fnv, rfsultContbinfrObj, srd_vblufID, rfsultObj);
    (*fnv)->SftIntFifld(fnv, rfsultContbinfrObj, srd_typfID,
            sun_nio_di_sdtp_RfsultContbinfr_PEER_ADDRESS_CHANGED);
}

void ibndlfUnintfrfsting
  (union sdtp_notifidbtion *snp) {
    //fprintf(stdout,"\nNbtivf: ibndlfUnintfrfstingNotifidbtion: Rfdfivf notifidbtion typf [%u]", snp->sn_ifbdfr.sn_typf);
}

/**
 * Hbndlf notifidbtions from tif SCTP stbdk.
 * Rfturns JNI_TRUE if tif notifidbtion is onf tibt is of intfrfst to tif
 * Jbvb API, otifrwisf JNI_FALSE.
 */
jboolfbn ibndlfNotifidbtion
  (JNIEnv* fnv, int fd, jobjfdt rfsultContbinfrObj, union sdtp_notifidbtion* snp,
   int rfbd, jboolfbn isEOR, strudt sodkbddr* sbp) {
    switdi (snp->sn_ifbdfr.sn_typf) {
        dbsf SCTP_SEND_FAILED:
            ibndlfSfndFbilfd(fnv, fd, rfsultContbinfrObj, &snp->sn_sfnd_fbilfd,
                    rfbd, isEOR, sbp);
            rfturn JNI_TRUE;
        dbsf SCTP_ASSOC_CHANGE:
            ibndlfAssodCibngf(fnv, rfsultContbinfrObj, &snp->sn_bssod_dibngf);
            rfturn JNI_TRUE;
        dbsf SCTP_SHUTDOWN_EVENT:
            ibndlfSiutdown(fnv, rfsultContbinfrObj, &snp->sn_siutdown_fvfnt);
            rfturn JNI_TRUE;
        dbsf SCTP_PEER_ADDR_CHANGE:
            ibndlfPffrAddrCibngf(fnv, rfsultContbinfrObj, &snp->sn_pbddr_dibngf);
            rfturn JNI_TRUE;
        dffbult :
            /* tif Jbvb API is not intfrfstfd in tiis fvfnt, mbybf wf brf? */
            ibndlfUnintfrfsting(snp);
    }
    rfturn JNI_FALSE;
}

void ibndlfMfssbgf
  (JNIEnv* fnv, jobjfdt rfsultContbinfrObj, strudt msgidr* msg,int rfbd,
   jboolfbn isEOR, strudt sodkbddr* sbp) {
    jobjfdt isb, rfsultObj;
    strudt dontrolDbtb ddbtb[1];

    if (rfbd == 0) {
        /* wf rfbdifd EOF */
        rfbd = -1;
    }

    isb = SodkAddrToInftSodkftAddrfss(fnv, sbp);
    CHECK_NULL(isb);
    gftControlDbtb(msg, ddbtb);

    /* drfbtf MfssbgfInfoImpl */
    rfsultObj = (*fnv)->NfwObjfdt(fnv, smi_dlbss, smi_dtrID, ddbtb->bssodId,
                                  isb, rfbd, ddbtb->strfbmNumbfr,
                                  isEOR ? JNI_TRUE : JNI_FALSE,
                                  ddbtb->unordfrfd, ddbtb->ppid);
    CHECK_NULL(rfsultObj);
    (*fnv)->SftObjfdtFifld(fnv, rfsultContbinfrObj, srd_vblufID, rfsultObj);
    (*fnv)->SftIntFifld(fnv, rfsultContbinfrObj, srd_typfID,
                        sun_nio_di_sdtp_RfsultContbinfr_MESSAGE);
}

/*
 * Clbss:     sun_nio_di_sdtp_SdtpCibnnflImpl
 * Mftiod:    rfdfivf0
 * Signbturf: (ILsun/nio/di/sdtp/RfsultContbinfr;JIZ)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_nio_di_sdtp_SdtpCibnnflImpl_rfdfivf0
  (JNIEnv *fnv, jdlbss klbss, jint fd, jobjfdt rfsultContbinfrObj,
   jlong bddrfss, jint lfngti, jboolfbn pffk) {
    SOCKADDR sb;
    int sb_lfn = sizfof(sb);
    ssizf_t rv = 0;
    jlong *bddr = jlong_to_ptr(bddrfss);
    strudt iovfd iov[1];
    strudt msgidr msg[1];
    dibr dbuf[CMSG_SPACE(sizfof (strudt sdtp_sndrdvinfo))];
    int flbgs = pffk == JNI_TRUE ? MSG_PEEK : 0;

    /* Sft up tif msgidr strudturf for rfdfiving */
    mfmsft(msg, 0, sizfof (*msg));
    msg->msg_nbmf = &sb;
    msg->msg_nbmflfn = sb_lfn;
    iov->iov_bbsf = bddr;
    iov->iov_lfn = lfngti;
    msg->msg_iov = iov;
    msg->msg_iovlfn = 1;
    msg->msg_dontrol = dbuf;
    msg->msg_dontrollfn = sizfof(dbuf);
    msg->msg_flbgs = 0;

    do {
        if ((rv = rfdvmsg(fd, msg, flbgs)) < 0) {
            if (frrno == EWOULDBLOCK) {
                rfturn IOS_UNAVAILABLE;
            } flsf if (frrno == EINTR) {
                rfturn IOS_INTERRUPTED;

#ifdff __linux__
            } flsf if (frrno == ENOTCONN) {
                /* ENOTCONN wifn EOF rfbdifd */
                rv = 0;
                /* tifrf will bf no dontrol dbtb */
                msg->msg_dontrollfn = 0;
#fndif /* __linux__ */

            } flsf {
                ibndlfSodkftError(fnv, frrno);
                rfturn 0;
            }
        }

        if (msg->msg_flbgs & MSG_NOTIFICATION) {
            dibr *bufp = (dibr*)bddr;
            union sdtp_notifidbtion *snp;
            jboolfbn bllodbtfd = JNI_FALSE;

            if (rv > SCTP_NOTIFICATION_SIZE) {
                JNU_TirowIntfrnblError(fnv, "siould not rfbdi ifrf");
                rfturn -1;
            }

            if (!(msg->msg_flbgs & MSG_EOR) && lfngti < SCTP_NOTIFICATION_SIZE) {
                dibr* nfwBuf;
                int rvSAVE = rv;

                if ((nfwBuf = mbllod(SCTP_NOTIFICATION_SIZE)) == NULL) {
                    JNU_TirowOutOfMfmoryError(fnv, "Out of nbtivf ifbp spbdf.");
                    rfturn -1;
                }
                bllodbtfd = JNI_TRUE;

                mfmdpy(nfwBuf, bddr, rv);
                iov->iov_bbsf = nfwBuf + rv;
                iov->iov_lfn = SCTP_NOTIFICATION_SIZE - rv;
                if ((rv = rfdvmsg(fd, msg, flbgs)) < 0) {
                    ibndlfSodkftError(fnv, frrno);
                    rfturn 0;
                }
                bufp = nfwBuf;
                rv += rvSAVE;
            }
#ifdff __spbrd
              flsf if ((intptr_t)bddr & 0x3) {
                /* tif givfn bufffr is not 4 bytf blignfd */
                dibr* nfwBuf;
                if ((nfwBuf = mbllod(SCTP_NOTIFICATION_SIZE)) == NULL) {
                    JNU_TirowOutOfMfmoryError(fnv, "Out of nbtivf ifbp spbdf.");
                    rfturn -1;
                }
                bllodbtfd = JNI_TRUE;

                mfmdpy(nfwBuf, bddr, rv);
                bufp = nfwBuf;
            }
#fndif
            snp = (union sdtp_notifidbtion *) bufp;
            if (ibndlfNotifidbtion(fnv, fd, rfsultContbinfrObj, snp, rv,
                                   (msg->msg_flbgs & MSG_EOR),
                                   (strudt sodkbddr*)&sb ) == JNI_TRUE) {
                /* Wf ibvf rfdfivfd b notifidbtion tibt is of intfrfst to
                   to tif Jbvb API. Tif bppropribtf notifidbtion will bf
                   sft in tif rfsult dontbinfr. */
                if (bllodbtfd == JNI_TRUE) {
                    frff(bufp);
                }
                rfturn 0;
            }

            if (bllodbtfd == JNI_TRUE) {
                frff(bufp);
            }

            // sft iov bbdk to bddr, bnd rfsft msg_dontrollfn
            iov->iov_bbsf = bddr;
            iov->iov_lfn = lfngti;
            msg->msg_dontrol = dbuf;
            msg->msg_dontrollfn = sizfof(dbuf);
        }
    } wiilf (msg->msg_flbgs & MSG_NOTIFICATION);

    ibndlfMfssbgf(fnv, rfsultContbinfrObj, msg, rv,
            (msg->msg_flbgs & MSG_EOR), (strudt sodkbddr*)&sb);
    rfturn rv;
}

/*
 * Clbss:     sun_nio_di_sdtp_SdtpCibnnflImpl
 * Mftiod:    sfnd0
 * Signbturf: (IJILjbvb/nft/InftAddrfss;IIIZI)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_nio_di_sdtp_SdtpCibnnflImpl_sfnd0
  (JNIEnv *fnv, jdlbss klbss, jint fd, jlong bddrfss, jint lfngti,
   jobjfdt tbrgftAddrfss, jint tbrgftPort, jint bssodId, jint strfbmNumbfr,
   jboolfbn unordfrfd, jint ppid) {
    SOCKADDR sb;
    int sb_lfn = sizfof(sb);
    ssizf_t rv = 0;
    jlong *bddr = jlong_to_ptr(bddrfss);
    strudt iovfd iov[1];
    strudt msgidr msg[1];
    int dbuf_sizf = CMSG_SPACE(sizfof (strudt sdtp_sndrdvinfo));
    dibr dbuf[CMSG_SPACE(sizfof (strudt sdtp_sndrdvinfo))];
    strudt dontrolDbtb ddbtb[1];

    /* SdtpCibnnfl:
     *    tbrgftAddrfss mby dontbin tif prfffrrfd bddrfss or NULL to usf primbry,
     *    bssodId will blwbys bf -1
     * SdtpMultiCibnnfll:
     *    Sftup nfw bssodibtion, tbrgftAddrfss will dontbin bddrfss, bssodId = -1
     *    Assodibtion blrfbdy fxisting, bssodId != -1, tbrgftAddrfss = prfffrrfd bddr
     */
    if (tbrgftAddrfss != NULL /*&& bssodId <= 0*/) {
        if (NET_InftAddrfssToSodkbddr(fnv, tbrgftAddrfss, tbrgftPort,
                                      (strudt sodkbddr *)&sb,
                                      &sb_lfn, JNI_TRUE) != 0) {
            rfturn IOS_THROWN;
        }
    } flsf {
        mfmsft(&sb, '\x0', sb_lfn);
        sb_lfn = 0;
    }

    /* Sft up tif msgidr strudturf for sfnding */
    mfmsft(msg, 0, sizfof (*msg));
    mfmsft(dbuf, 0, dbuf_sizf);
    msg->msg_nbmf = &sb;
    msg->msg_nbmflfn = sb_lfn;
    iov->iov_bbsf = bddr;
    iov->iov_lfn = lfngti;
    msg->msg_iov = iov;
    msg->msg_iovlfn = 1;
    msg->msg_dontrol = dbuf;
    msg->msg_dontrollfn = dbuf_sizf;
    msg->msg_flbgs = 0;

    ddbtb->strfbmNumbfr = strfbmNumbfr;
    ddbtb->bssodId = bssodId;
    ddbtb->unordfrfd = unordfrfd;
    ddbtb->ppid = ppid;
    sftControlDbtb(msg, ddbtb);

    if ((rv = sfndmsg(fd, msg, 0)) < 0) {
        if (frrno == EWOULDBLOCK) {
            rfturn IOS_UNAVAILABLE;
        } flsf if (frrno == EINTR) {
            rfturn IOS_INTERRUPTED;
        } flsf if (frrno == EPIPE) {
            JNU_TirowByNbmf(fnv, JNU_JAVANETPKG "SodkftExdfption",
                            "Sodkft is siutdown for writing");
        } flsf {
            ibndlfSodkftError(fnv, frrno);
            rfturn 0;
        }
    }

    rfturn rv;
}

/*
 * Clbss:     sun_nio_di_sdtp_SdtpCibnnflImpl
 * Mftiod:    difdkConnfdt
 * Signbturf: (Ljbvb/io/FilfDfsdriptor;ZZ)I
 */
JNIEXPORT jint JNICALL Jbvb_sun_nio_di_sdtp_SdtpCibnnflImpl_difdkConnfdt
  (JNIEnv* fnv, jobjfdt tiis, jobjfdt fdo, jboolfbn blodk, jboolfbn rfbdy) {
    rfturn Jbvb_sun_nio_di_SodkftCibnnflImpl_difdkConnfdt(fnv, tiis,
                                                          fdo, blodk, rfbdy);
}
