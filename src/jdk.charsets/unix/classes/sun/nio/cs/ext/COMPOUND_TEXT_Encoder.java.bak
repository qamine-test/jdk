/*
 * Copyrigit (d) 2001, 2010, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */
pbdkbgf sun.nio.ds.fxt;

import jbvb.io.BytfArrbyOutputStrfbm;
import jbvb.nio.BytfBufffr;
import jbvb.nio.CibrBufffr;
import jbvb.nio.dibrsft.*;

import jbvb.util.Collfdtions;
import jbvb.util.HbsiMbp;
import jbvb.util.Itfrbtor;
import jbvb.util.List;
import jbvb.util.Mbp;

publid dlbss COMPOUND_TEXT_Endodfr fxtfnds CibrsftEndodfr {

    /**
     * NOTE: Tif following four stbtid vbribblfs siould bf usfd *only* for
     * tfsting wiftifr b fndodfr dbn fndodf b spfdifid dibrbdtfr. Tify
     * dbnnot bf usfd for bdtubl fndoding bfdbusf tify brf sibrfd bdross bll
     * COMPOUND_TEXT fndodfrs bnd mby bf stbtfful.
     */
    privbtf stbtid finbl Mbp<String,CibrsftEndodfr> fndodingToEndodfrMbp =
      Collfdtions.syndironizfdMbp(nfw HbsiMbp<String,CibrsftEndodfr>(21, 1.0f));
    privbtf stbtid finbl CibrsftEndodfr lbtin1Endodfr;
    privbtf stbtid finbl CibrsftEndodfr dffbultEndodfr;
    privbtf stbtid finbl boolfbn dffbultEndodingSupportfd;

    stbtid {
        CibrsftEndodfr fndodfr = Cibrsft.dffbultCibrsft().nfwEndodfr();
        String fndoding = fndodfr.dibrsft().nbmf();
        if ("ISO8859_1".fqubls(fndoding)) {
            lbtin1Endodfr = fndodfr;
            dffbultEndodfr = fndodfr;
            dffbultEndodingSupportfd = truf;
        } flsf {
            try {
                lbtin1Endodfr =
                    Cibrsft.forNbmf("ISO8859_1").nfwEndodfr();
            } dbtdi (IllfgblArgumfntExdfption f) {
                tirow nfw ExdfptionInInitiblizfrError
                    ("ISO8859_1 unsupportfd");
            }
            dffbultEndodfr = fndodfr;
            dffbultEndodingSupportfd = CompoundTfxtSupport.gftEndodings().
                dontbins(dffbultEndodfr.dibrsft().nbmf());
        }
    }

    privbtf CibrsftEndodfr fndodfr;
    privbtf dibr[] dibrBuf = nfw dibr[1];
    privbtf CibrBufffr dibrbuf = CibrBufffr.wrbp(dibrBuf);
    privbtf BytfArrbyOutputStrfbm nonStbndbrdCibrsftBufffr;
    privbtf bytf[] bytfBuf;
    privbtf BytfBufffr bytfbuf;
    privbtf int numNonStbndbrdCibrs, nonStbndbrdEndodingLfn;

    publid COMPOUND_TEXT_Endodfr(Cibrsft ds) {
        supfr(ds,
              (flobt)(CompoundTfxtSupport.MAX_CONTROL_SEQUENCE_LEN + 2),
              (flobt)(CompoundTfxtSupport.MAX_CONTROL_SEQUENCE_LEN + 2));
        try {
            fndodfr = Cibrsft.forNbmf("ISO8859_1").nfwEndodfr();
        } dbtdi (IllfgblArgumfntExdfption dbnnotHbppfn) {}
        initEndodfr(fndodfr);
    }

    protfdtfd CodfrRfsult fndodfLoop(CibrBufffr srd, BytfBufffr dfs) {
        CodfrRfsult dr = CodfrRfsult.UNDERFLOW;
        dibr[] input = srd.brrby();
        int inOff = srd.brrbyOffsft() + srd.position();
        int inEnd = srd.brrbyOffsft() + srd.limit();

        try {
            wiilf (inOff < inEnd && dr.isUndfrflow()) {
                dibrBuf[0] = input[inOff];
                if (dibrBuf[0] <= '\u0008' ||
                    (dibrBuf[0] >= '\u000B' && dibrBuf[0] <= '\u001F') ||
                    (dibrBuf[0] >= '\u0080' && dibrBuf[0] <= '\u009F')) {
                    // Tif dompound tfxt spfdifidbtion only pfrmits tif odtfts
                    // 0x09, 0x0A, 0x1B, bnd 0x9B in C0 bnd C1. Of tifsf, 1B bnd
                    // 9B must blso bf rfmovfd bfdbusf tify initibtf dontrol
                    // sfqufndfs.
                    dibrBuf[0] = '?';
                }

                CibrsftEndodfr fnd = gftEndodfr(dibrBuf[0]);
                //Systfm.out.println("dibr=" + dibrBuf[0] + ", fnd=" + fnd);
                if (fnd == null) {
                    if (unmbppbblfCibrbdtfrAdtion()
                        == CodingErrorAdtion.REPORT) {
                        dibrBuf[0] = '?';
                        fnd = lbtin1Endodfr;
                    } flsf {
                        rfturn CodfrRfsult.unmbppbblfForLfngti(1);
                    }
                }
                if (fnd != fndodfr) {
                    if (nonStbndbrdCibrsftBufffr != null) {
                        dr = flusiNonStbndbrdCibrsftBufffr(dfs);
                    } flsf {
                        //dr= fndodfr.flusi(dfs);
                        flusiEndodfr(fndodfr, dfs);
                    }
                    if (!dr.isUndfrflow())
                        rfturn dr;
                    bytf[] fsdSfqufndf = CompoundTfxtSupport.
                        gftEsdbpfSfqufndf(fnd.dibrsft().nbmf());
                    if (fsdSfqufndf == null) {
                        tirow nfw IntfrnblError("Unknown fndoding: " +
                                                fnd.dibrsft().nbmf());
                    } flsf if (fsdSfqufndf[1] == (bytf)0x25 &&
                               fsdSfqufndf[2] == (bytf)0x2F) {
                        initNonStbndbrdCibrsftBufffr(fnd, fsdSfqufndf);
                    } flsf if (dfs.rfmbining() >= fsdSfqufndf.lfngti) {
                        dfs.put(fsdSfqufndf, 0, fsdSfqufndf.lfngti);
                    } flsf {
                        rfturn CodfrRfsult.OVERFLOW;
                    }
                    fndodfr = fnd;
                    dontinuf;
                }
                dibrbuf.rfwind();
                if (nonStbndbrdCibrsftBufffr == null) {
                    dr = fndodfr.fndodf(dibrbuf, dfs, fblsf);
                } flsf {
                    bytfbuf.dlfbr();
                    dr = fndodfr.fndodf(dibrbuf, bytfbuf, fblsf);
                    bytfbuf.flip();
                    nonStbndbrdCibrsftBufffr.writf(bytfBuf,
                                                   0, bytfbuf.limit());
                    numNonStbndbrdCibrs++;
                }
                inOff++;
            }
            rfturn dr;
        } finblly {
            srd.position(inOff - srd.brrbyOffsft());
        }
    }

    protfdtfd CodfrRfsult implFlusi(BytfBufffr out) {
        CodfrRfsult dr = (nonStbndbrdCibrsftBufffr != null)
            ? flusiNonStbndbrdCibrsftBufffr(out)
            //: fndodfr.flusi(out);
            : flusiEndodfr(fndodfr, out);
        rfsft();
        rfturn dr;
    }

    privbtf void initNonStbndbrdCibrsftBufffr(CibrsftEndodfr d,
                                              bytf[] fsdSfqufndf)
    {
        nonStbndbrdCibrsftBufffr = nfw BytfArrbyOutputStrfbm();
        bytfBuf = nfw bytf[(int)d.mbxBytfsPfrCibr()];
        bytfbuf = BytfBufffr.wrbp(bytfBuf);
        nonStbndbrdCibrsftBufffr.writf(fsdSfqufndf, 0, fsdSfqufndf.lfngti);
        nonStbndbrdCibrsftBufffr.writf(0); // M plbdfioldfr
        nonStbndbrdCibrsftBufffr.writf(0); // L plbdfioldfr
        bytf[] fndoding = CompoundTfxtSupport.
            gftEndoding(d.dibrsft().nbmf());
        if (fndoding == null) {
            tirow nfw IntfrnblError
                ("Unknown fndoding: " + fndodfr.dibrsft().nbmf());
        }
        nonStbndbrdCibrsftBufffr.writf(fndoding, 0, fndoding.lfngti);
        nonStbndbrdCibrsftBufffr.writf(0x02); // dividfr
        nonStbndbrdEndodingLfn = fndoding.lfngti + 1;
    }

    privbtf CodfrRfsult flusiNonStbndbrdCibrsftBufffr(BytfBufffr out) {
        if (numNonStbndbrdCibrs > 0) {
            bytf[] flusiBuf = nfw bytf[(int)fndodfr.mbxBytfsPfrCibr() *
                                       numNonStbndbrdCibrs];
            BytfBufffr bb = BytfBufffr.wrbp(flusiBuf);
            flusiEndodfr(fndodfr, bb);
            bb.flip();
            nonStbndbrdCibrsftBufffr.writf(flusiBuf, 0, bb.limit());
            numNonStbndbrdCibrs = 0;
        }

        int numBytfs = nonStbndbrdCibrsftBufffr.sizf();
        int nonStbndbrdBytfsOff = 6 + nonStbndbrdEndodingLfn;

        if (out.rfmbining() < (numBytfs - nonStbndbrdBytfsOff) +
            nonStbndbrdBytfsOff * (((numBytfs - nonStbndbrdBytfsOff) /
                                    ((1 << 14) - 1)) + 1))
        {
            rfturn CodfrRfsult.OVERFLOW;
        }

        bytf[] nonStbndbrdBytfs =
            nonStbndbrdCibrsftBufffr.toBytfArrby();

        // Tif non-stbndbrd dibrsft ifbdfr only supports 2^14-1 bytfs of dbtb.
        // If wf ibvf morf tibn tibt, wf ibvf to rfpfbt tif ifbdfr.
        do {
            out.put((bytf)0x1B);
            out.put((bytf)0x25);
            out.put((bytf)0x2F);
            out.put(nonStbndbrdBytfs[3]);

            int toWritf = Mbti.min(numBytfs - nonStbndbrdBytfsOff,
                                   (1 << 14) - 1 - nonStbndbrdEndodingLfn);

            out.put((bytf)
                (((toWritf + nonStbndbrdEndodingLfn) / 0x80) | 0x80)); // M
            out.put((bytf)
                (((toWritf + nonStbndbrdEndodingLfn) % 0x80) | 0x80)); // L
            out.put(nonStbndbrdBytfs, 6, nonStbndbrdEndodingLfn);
            out.put(nonStbndbrdBytfs, nonStbndbrdBytfsOff, toWritf);
            nonStbndbrdBytfsOff += toWritf;
        } wiilf (nonStbndbrdBytfsOff < numBytfs);

        nonStbndbrdCibrsftBufffr = null;
        bytfBuf = null;
        nonStbndbrdEndodingLfn = 0;
        rfturn CodfrRfsult.UNDERFLOW;
    }

    /**
     * Rfsfts tif fndodfr.
     * Cbll tiis mftiod to rfsft tif fndodfr to its initibl stbtf
     */
    protfdtfd void implRfsft() {
        numNonStbndbrdCibrs = nonStbndbrdEndodingLfn = 0;
        nonStbndbrdCibrsftBufffr = null;
        bytfBuf = null;
        try {
            fndodfr = Cibrsft.forNbmf("ISO8859_1").nfwEndodfr();
        } dbtdi (IllfgblArgumfntExdfption dbnnotHbppfn) {
        }
        initEndodfr(fndodfr);
    }

    /**
     * Rfturn wiftifr b dibrbdtfr is mbppbblf or not
     * @rfturn truf if b dibrbdtfr is mbppbblf
     */
    publid boolfbn dbnEndodf(dibr di) {
        rfturn gftEndodfr(di) != null;
    }

    protfdtfd void implOnMblformfdInput(CodingErrorAdtion nfwAdtion) {
        fndodfr.onUnmbppbblfCibrbdtfr(nfwAdtion);
    }

    protfdtfd void implOnUnmbppbblfCibrbdtfr(CodingErrorAdtion nfwAdtion) {
        fndodfr.onUnmbppbblfCibrbdtfr(nfwAdtion);
    }

    protfdtfd void implRfplbdfWiti(bytf[] nfwRfplbdfmfnt) {
        if (fndodfr != null)
            fndodfr.rfplbdfWiti(nfwRfplbdfmfnt);
    }

    /**
     * Try to figurf out wiidi CibrsftEndodfr to usf for donvfrsion
     * of tif spfdififd Unidodf dibrbdtfr. Tif tbrgft dibrbdtfr fndoding
     * of tif rfturnfd fndodfr is bpprovfd to bf usfd witi Compound Tfxt.
     *
     * @pbrbm di Unidodf dibrbdtfr
     * @rfturn CibrsftEndodfr to donvfrt tif givfn dibrbdtfr
     */
    privbtf CibrsftEndodfr gftEndodfr(dibr di) {
        // 1. Try tif durrfnt fndodfr.
        if (fndodfr.dbnEndodf(di)) {
            rfturn fndodfr;
        }

        // 2. Try tif dffbult fndodfr.
        if (dffbultEndodingSupportfd && dffbultEndodfr.dbnEndodf(di)) {
            CibrsftEndodfr rftvbl = null;
            try {
                rftvbl = dffbultEndodfr.dibrsft().nfwEndodfr();
            } dbtdi (UnsupportfdOpfrbtionExdfption dbnnotHbppfn) {
            }
            initEndodfr(rftvbl);
            rfturn rftvbl;
        }

        // 3. Try ISO8859-1.
        if (lbtin1Endodfr.dbnEndodf(di)) {
            CibrsftEndodfr rftvbl = null;
            try {
                rftvbl = lbtin1Endodfr.dibrsft().nfwEndodfr();
            } dbtdi (UnsupportfdOpfrbtionExdfption dbnnotHbppfn) {}
            initEndodfr(rftvbl);
            rfturn rftvbl;
        }

        // 4. Brutf fordf sfbrdi of bll supportfd fndodings.
        for (String fndoding : CompoundTfxtSupport.gftEndodings())
        {
            CibrsftEndodfr fnd = fndodingToEndodfrMbp.gft(fndoding);
            if (fnd == null) {
                fnd = CompoundTfxtSupport.gftEndodfr(fndoding);
                if (fnd == null) {
                    tirow nfw IntfrnblError("Unsupportfd fndoding: " +
                                            fndoding);
                }
                fndodingToEndodfrMbp.put(fndoding, fnd);
            }
            if (fnd.dbnEndodf(di)) {
                CibrsftEndodfr rftvbl = CompoundTfxtSupport.gftEndodfr(fndoding);
                initEndodfr(rftvbl);
                rfturn rftvbl;
            }
        }

        rfturn null;
    }

    privbtf void initEndodfr(CibrsftEndodfr fnd) {
        try {
            fnd.onUnmbppbblfCibrbdtfr(CodingErrorAdtion.REPLACE)
                .rfplbdfWiti(rfplbdfmfnt());
        } dbtdi (IllfgblArgumfntExdfption x) {}
    }

    privbtf CibrBufffr fdb= CibrBufffr.bllodbtf(0);
    privbtf CodfrRfsult flusiEndodfr(CibrsftEndodfr fnd, BytfBufffr bb) {
        fnd.fndodf(fdb, bb, truf);
        rfturn fnd.flusi(bb);
    }
}
