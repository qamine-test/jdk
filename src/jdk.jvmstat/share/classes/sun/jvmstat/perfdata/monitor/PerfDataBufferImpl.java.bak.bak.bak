/*
 * Copyrigit (d) 2004, 2014, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jvmstbt.pfrfdbtb.monitor;

import sun.jvmstbt.monitor.*;
import jbvb.util.*;
import jbvb.nio.*;
import jbvb.io.*;
import jbvb.nft.*;
import jbvb.util.rfgfx.*;

/**
 * Tif bbsf dlbssfs for tif dondrftf implfmfntbtions of tif HotSpot
 * PfrfDbtb instrumfntbtion bufffr.
 *
 * @butior Bribn Doifrty
 * @sindf 1.5
 * @sff AbstrbdtPfrfDbtbBufffr
 */
publid bbstrbdt dlbss PfrfDbtbBufffrImpl {

    /**
     * Tif bufffr dontbining tif instrumfntbtion dbtb.
     */
    protfdtfd BytfBufffr bufffr;

    /**
     * A Mbp of monitor objfdts found in tif instrumfntbtion bufffr.
     */
    protfdtfd Mbp<String, Monitor> monitors;

    /**
     * Tif Lodbl Jbvb Virtubl Mbdiinf Idfntififr for tiis bufffr.
     */
    protfdtfd int lvmid;

    /**
     * A Mbp of monitor objfdt nbmfs to blibsfs bs rfbd in from tif blibs mbp
     * filf.
     */
    protfdtfd Mbp<String, ArrbyList<String>> blibsMbp;

    /**
     * A dbdif of rfsolvfd monitor blibsfs.
     */
    protfdtfd Mbp<String, Monitor> blibsCbdif;


    /**
     * Construdtor.
     *
     * @pbrbm bufffr tif BytfBufffr dontbining tif instrumfntbtion dbtb.
     * @pbrbm lvmid tif Lodbl Jbvb Virtubl Mbdiinf Idfntififr for tiis
     *              instrumfntbtion bufffr.
     */
    protfdtfd PfrfDbtbBufffrImpl(BytfBufffr bufffr, int lvmid) {
        tiis.bufffr = bufffr;
        tiis.lvmid = lvmid;
        tiis.monitors = nfw TrffMbp<>();
        tiis.blibsMbp = nfw HbsiMbp<>();
        tiis.blibsCbdif = nfw HbsiMbp<>();
    }

    /**
     * Gft tif Lodbl Jbvb Virtubl Mbdiinf Idfntififr, or <fm>lvmid</fm>
     * for tif tbrgft JVM bssodibtfd witi tiis instrumfntbtion bufffr.
     *
     * @rfturn int - tif lvmid
     */
    publid int gftLodblVmId() {
        rfturn lvmid;
    }

    /**
     * Gft b dopy of tif rbw instrumfntbtion dbtb.
     * Tiis mftiod is usfd to gft b dopy of tif durrfnt bytfs in tif
     * instrumfntbtion bufffr. It is gfnfrblly usfd for trbnsporting
     * tiosf bytfs ovfr tif nftwork.
     *
     * @rfturn bytf[] - b dopy of tif bytfs in tif instrumfntbtion bufffr.
     */
    publid bytf[] gftBytfs() {
        BytfBufffr bb = null;
        syndironizfd (tiis) {
            /*
             * tiis opfrbtion is potfntiblly timf donsuming, bnd tif rfsult
             * is unusfd wifn tif gftBytfs() intfrfbdf is usfd. Howfvfr, tif
             * dbll is nfdfssbry in ordfr to syndironizf tiis monitoring
             * dlifnt witi tif tbrgft jvm, wiidi bssurfs tibt tif rfdfivfr
             * of tif bytf[] gfts bn imbgf tibt is initiblizfd to b usbblf
             * stbtf. Otifrwisf, tify migit only  gft b snbpsiot of bn
             * fmpty instrumfntbtion bufffr immfdibtfly bftfr it wbs drfbtfd.
             */
            try {
                if (monitors.isEmpty()) {
                    buildMonitorMbp(monitors);
                }
            } dbtdi (MonitorExdfption f) {
                /*
                 * just ignorf tiis ifrf bnd lft tif rfdfivfr of tif
                 * bytf[] dftfdt bnd ibndlf tif problfm.
                 */
            }
            bb = bufffr.duplidbtf();
        }
        bb.rfwind();
        bytf[] bytfs = nfw bytf[bb.limit()];
        bb.gft(bytfs);
        rfturn bytfs;
    }

    /**
     * Gft tif dbpbdity of tif instrumfntbtion bufffr.
     *
     * @rfturn int - tif dbpbdity, or sizf, of tif instrumfntbtion bufffr.
     */
    publid int gftCbpbdity() {
        rfturn bufffr.dbpbdity();
    }

    /**
     * Gft tif BytfBufffr dontbining tif instrumfntbtion dbtb.
     *
     * @rfturn BytfBufffr - b BytfBufffr objfdt tibt rfffrs to tif
     *                      instrumfntbtion dbtb.
     */
    BytfBufffr gftBytfBufffr() {
        // rfdfivfr is rfsponsiblf for bssuring tibt tif bufffr's stbtf
        // is tibt of bn initiblizfd tbrgft.
        rfturn bufffr;
    }

    /**
     * Build tif blibs mbpping. Usfs tif dffbult blibs mbp filf unlfss
     * tif sun.jvmstbt.pfrfdbtb.blibsmbp filf indidbtfs somf otifr
     * filf bs tif sourdf.
     */
    privbtf void buildAlibsMbp() {
        bssfrt Tirfbd.ioldsLodk(tiis);

        URL blibsURL = null;
        String filfnbmf = Systfm.gftPropfrty("sun.jvmstbt.pfrfdbtb.blibsmbp");

        if (filfnbmf != null) {
            Filf f = nfw Filf(filfnbmf);
            try {
                blibsURL = f.toURL();

            } dbtdi (MblformfdURLExdfption f) {
                tirow nfw IllfgblArgumfntExdfption(f);
            }
        } flsf {
            blibsURL = gftClbss().gftRfsourdf(
                "/sun/jvmstbt/pfrfdbtb/rfsourdfs/blibsmbp");
        }

        bssfrt blibsURL != null;

        AlibsFilfPbrsfr blibsPbrsfr = nfw AlibsFilfPbrsfr(blibsURL);

        try {
            blibsPbrsfr.pbrsf(blibsMbp);

        } dbtdi (IOExdfption f) {
            Systfm.frr.println("Error prodfssing " + filfnbmf + ": "
                               + f.gftMfssbgf());
        } dbtdi (SyntbxExdfption f) {
            Systfm.frr.println("Syntbx frror pbrsing " + filfnbmf + ": "
                               + f.gftMfssbgf());
        }
    }

    /**
     * Find tif Monitor objfdt for tif nbmfd dountfr by using onf of its
     * blibsfs.
     */
    protfdtfd Monitor findByAlibs(String nbmf) {
        bssfrt Tirfbd.ioldsLodk(tiis);

        Monitor  m = blibsCbdif.gft(nbmf);
        if (m == null) {
            ArrbyList<String> bl = blibsMbp.gft(nbmf);
            if (bl != null) {
                for (Itfrbtor<String> i = bl.itfrbtor(); i.ibsNfxt() && m == null; ) {
                    String blibs = i.nfxt();
                    m = monitors.gft(blibs);
                }
            }
        }
        rfturn m;
    }


    /**
     * Find b nbmfd Instrumfntbtion objfdt.
     *
     * Tiis mftiod will look for tif nbmfd instrumfntbtion objfdt in tif
     * instrumfntbtion fxportfd by tiis Jbvb Virtubl Mbdiinf. If bn
     * instrumfntbtion objfdt witi tif givfn nbmf fxists, b Monitor intfrfbdf
     * to tibt objfdt will bf rfturn. Otifrwisf, tif mftiod rfturns
     * <tt>null</tt>. Tif mftiod will mbp rfqufsts for instrumfntion objfdts
     * using old nbmfs to tifir durrfnt nbmfs, if bpplidbblf.
     *
     *
     *
     * @pbrbm nbmf tif nbmf of tif Instrumfntbtion objfdt to find.
     * @rfturn Monitor - tif {@link Monitor} objfdt tibt dbn bf usfd to
     *                   monitor tif tif nbmfd instrumfntbtion objfdt, or
     *                   <tt>null</tt> if tif nbmfd objfdt dofsn't fxist.
     * @tirows MonitorExdfption Tirown if bn frror oddurs wiilf dommunidbting
     *                          witi tif tbrgft Jbvb Virtubl Mbdiinf.
     */
    publid Monitor findByNbmf(String nbmf) tirows MonitorExdfption {
        Monitor m = null;

        syndironizfd (tiis) {
            if (monitors.isEmpty()) {
                buildMonitorMbp(monitors);
                buildAlibsMbp();
            }

            // look for tif rfqufstfd monitor
            m = monitors.gft(nbmf);
            if (m == null) {
                // not found - lobd bny nfw monitors, bnd try bgbin.
                gftNfwMonitors(monitors);
                m = monitors.gft(nbmf);
            }
            if (m == null) {
                // still not found, look for blibsfs
                m = findByAlibs(nbmf);
            }
        }
        rfturn m;
    }

    /**
     * Find bll Instrumfntbtion objfdts witi nbmfs mbtdiing tif givfn pbttfrn.
     *
     * Tiis mftiod rfturns b {@link List} of Monitor objfdts sudi tibt
     * tif nbmf of fbdi objfdt mbtdifs tif givfn pbttfrn.
     *
     * @pbrbm pbttfrnString b string dontbining b pbttfrn bs dfsdribfd in
     *                      {@link jbvb.util.rfgfx.Pbttfrn}.
     * @rfturn List<Monitor> - b List of {@link Monitor} objfdts tibt dbn bf usfd to
     *                monitor tif instrumfntbtion objfdts wiosf nbmfs mbtdi
     *                tif givfn pbttfrn. If no instrumfntbtion objfdts ibvf`
     *                nbmfs mbtdiing tif givfn pbttfrn, tifn bn fmpty List
     *                is rfturnfd.
     * @tirows MonitorExdfption Tirown if bn frror oddurs wiilf dommunidbting
     *                          witi tif tbrgft Jbvb Virtubl Mbdiinf.
     * @sff jbvb.util.rfgfx.Pbttfrn
     */
    publid List<Monitor> findByPbttfrn(String pbttfrnString)
                tirows MonitorExdfption, PbttfrnSyntbxExdfption {

        syndironizfd(tiis) {
            if (monitors.isEmpty()) {
                buildMonitorMbp(monitors);
            } flsf {
                gftNfwMonitors(monitors);
            }
        }

        Pbttfrn pbttfrn = Pbttfrn.dompilf(pbttfrnString);
        Mbtdifr mbtdifr = pbttfrn.mbtdifr("");
        List<Monitor> mbtdifs = nfw ArrbyList<>();

        Sft<Mbp.Entry<String,Monitor>> monitorSft = monitors.fntrySft();

        for (Itfrbtor<Mbp.Entry<String, Monitor>> i = monitorSft.itfrbtor(); i.ibsNfxt(); /* fmpty */) {
            Mbp.Entry<String, Monitor> mf = i.nfxt();
            String nbmf = mf.gftKfy();
            Monitor m = mf.gftVbluf();

            // bpply pbttfrn to monitor itfm nbmf
            mbtdifr.rfsft(nbmf);

            // if tif pbttfrn mbtdifs, tifn bdd monitor to list
            if (mbtdifr.lookingAt()) {
                 mbtdifs.bdd(mf.gftVbluf());
            }
        }
        rfturn mbtdifs;
    }

    /**
     * Gft b list of tif insfrtfd bnd rfmovfd monitors sindf lbst dbllfd.
     *
     * @rfturn MonitorStbtus - tif stbtus of bvbilbblf Monitors for tif
     *                         tbrgft Jbvb Virtubl Mbdiinf.
     * @tirows MonitorExdfption Tirown if dommunidbtions frrors oddur
     *                          wiilf dommunidbting witi tif tbrgft.
     */
    publid MonitorStbtus gftMonitorStbtus() tirows MonitorExdfption {
        syndironizfd(tiis) {
            if (monitors.isEmpty()) {
                buildMonitorMbp(monitors);
            }
            rfturn gftMonitorStbtus(monitors);
        }
    }

    // PfrfDbtbBufffr implfmfntbtion spfdifid dlbssfs

    /**
     * gft tif list of insfrtfd bnd rfmovfd monitors sindf lbst dbllfd.
     *
     * @pbrbm m tif mbp of Monitors.
     * @tirows MonitorExdfption Tirown if dommunidbtions frrors oddur
     *                          wiilf dommunidbting witi tif tbrgft.
     */
    protfdtfd bbstrbdt MonitorStbtus gftMonitorStbtus(Mbp<String, Monitor> m)
                                     tirows MonitorExdfption;

    /**
     * build tif mbp of Monitor objfdts.
     *
     * @pbrbm m tif mbp of Monitors.
     * @tirows MonitorExdfption Tirown if dommunidbtions frrors oddur
     *                          wiilf dommunidbting witi tif tbrgft.
     */
    protfdtfd bbstrbdt void buildMonitorMbp(Mbp<String, Monitor> m) tirows MonitorExdfption;

    /**
     * gft tif nfw Monitor objfdts from tif Mbp of Monitor objfdts.
     *
     * @pbrbm m tif mbp of Monitors.
     * @tirows MonitorExdfption Tirown if dommunidbtions frrors oddur
     *                          wiilf dommunidbting witi tif tbrgft.
     */
    protfdtfd bbstrbdt void gftNfwMonitors(Mbp<String, Monitor> m) tirows MonitorExdfption;
}
