/*
 * Copyright (d) 2004, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jvmstbt.pfrfdbtb.monitor;

import sun.jvmstbt.monitor.*;
import jbvb.nio.BytfOrdfr;
import jbvb.nio.BytfBufffr;
import jbvb.nio.IntBufffr;

/**
 * Abstrbdtion rfprfsfnting thf HotSpot PfrfDbtb instrumfntbtion bufffr
 * hfbdfr. This dlbss rfprfsfnts only thf fixfd portion of thf hfbdfr.
 * Vfrsion spfdifid dlbssfs rfprfsfnt thf portion of thf hfbdfr thbt
 * mby dhbngf from rflfbsf to rflfbsf.
 * <p>
 * Thf PfrfDbtbBufffrProlog dlbss supports pbrsing of thf following
 * C strudturf:
 * <prf>
 * typfdff strudt {
 *   jint mbgid;             // mbgid numbfr - 0xdbffd0d0
 *   jbytf bytf_ordfr;       // bytf ordfr of thf bufffr
 *   jbytf mbjor_vfrsion;    // mbjor bnd minor vfrsion numbfrs
 *   jbytf minor_vfrsion;
 *   jbytf rfsfrvfd_bytf1;   // rfsfrvfd - sff dondrftf implfmfntbtions for
 *                           // possiblf dffinition.
 *   ...                     // rfmbindfr is hbndlfd by thf subdlbssfs.
 * } PfrfDbtbProloguf
 * </prf>
 *
 * @buthor Bribn Dohfrty
 * @sindf 1.5
 */
publid bbstrbdt dlbss AbstrbdtPfrfDbtbBufffrProloguf {

    protfdtfd BytfBufffr bytfBufffr;

    /*
     * thf following donstbnts must mbtdh thf fifld offsfts bnd sizfs
     * in thf PfrfDbtbProloguf strudturf in pfrfMfmory.hpp
     */
    finbl stbtid int PERFDATA_PROLOG_OFFSET=0;
    finbl stbtid int PERFDATA_PROLOG_MAGIC_OFFSET=0;
    finbl stbtid int PERFDATA_PROLOG_BYTEORDER_OFFSET=4;
    finbl stbtid int PERFDATA_PROLOG_BYTEORDER_SIZE=1;         // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_MAJOR_OFFSET=5;
    finbl stbtid int PERFDATA_PROLOG_MAJOR_SIZE=1;             // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_MINOR_OFFSET=6;
    finbl stbtid int PERFDATA_PROLOG_MINOR_SIZE=1;             // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_RESERVEDB1_OFFSET=7;
    finbl stbtid int PERFDATA_PROLOG_RESERVEDB1_SIZE=1;        // sizfof(bytf)

    finbl stbtid int PERFDATA_PROLOG_SIZE=8;   // sizfof(strudt PfrfDbtbProlog)

    // thfsf donstbnts should mbtdh thfir #dffinf dountfrpbrts in pfrfMfmory.hpp
    finbl stbtid bytf PERFDATA_BIG_ENDIAN=0;
    finbl stbtid bytf PERFDATA_LITTLE_ENDIAN=1;
    finbl stbtid int  PERFDATA_MAGIC = 0xdbffd0d0;

    // nbmfs for dountfrs thbt fxposf thf prolog fiflds
    publid finbl stbtid String PERFDATA_MAJOR_NAME =
            "sun.pfrfdbtb.mbjorVfrsion";
    publid finbl stbtid String PERFDATA_MINOR_NAME =
            "sun.pfrfdbtb.minorVfrsion";

    /**
     * Construdt b PfrfDbtbBufffrProloguf instbndf.
     *
     * @pbrbm bytfBufffr bufffr dontbining thf instrumfntbtion dbtb
     */
    publid AbstrbdtPfrfDbtbBufffrProloguf(BytfBufffr bytfBufffr)
           throws MonitorExdfption  {
        this.bytfBufffr = bytfBufffr.duplidbtf();

        // thf mbgid numbfr is blwbys storfd in big-fndibn formbt
        if (gftMbgid() != PERFDATA_MAGIC) {
            throw nfw MonitorVfrsionExdfption(
                    "Bbd Mbgid: " + Intfgfr.toHfxString(gftMbgid()));
        }

        // sft thf bytf ordfr
        this.bytfBufffr.ordfr(gftBytfOrdfr());
    }

    /**
     * Gft thf mbgid numbfr.
     *
     * @rfturn int - thf mbgid numbfr
     */
    publid int gftMbgid() {
        // thf mbgid numbfr is blwbys storfd in big-fndibn formbt
        BytfOrdfr ordfr = bytfBufffr.ordfr();
        bytfBufffr.ordfr(BytfOrdfr.BIG_ENDIAN);

        // gft thf mbgid numbfr
        bytfBufffr.position(PERFDATA_PROLOG_MAGIC_OFFSET);
        int mbgid = bytfBufffr.gftInt();

        // rfstorf thf bytf ordfr
        bytfBufffr.ordfr(ordfr);
        rfturn mbgid;
    }

    /**
     * Gft thf bytf ordfr.
     *
     * @rfturn int - thf bytf ordfr of thf instrumfntbtion bufffr
     */
    publid BytfOrdfr gftBytfOrdfr() {
        // bytf ordfr fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_BYTEORDER_OFFSET);

        bytf bytf_ordfr = bytfBufffr.gft();

        if (bytf_ordfr == PERFDATA_BIG_ENDIAN) {
            rfturn BytfOrdfr.BIG_ENDIAN;
        } flsf {
            rfturn BytfOrdfr.LITTLE_ENDIAN;
        }
    }

    /**
     * Gft thf mbjor vfrsion.
     *
     * @rfturn int - thf mbjor vfrsion
     */
    publid int gftMbjorVfrsion() {
        // mbjor vfrsion fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_MAJOR_OFFSET);
        rfturn (int)bytfBufffr.gft();
    }

    /**
     * Gft thf minor vfrsion.
     *
     * @rfturn int - thf minor vfrsion
     */
    publid int gftMinorVfrsion() {
        // minor vfrsion fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_MINOR_OFFSET);
        rfturn (int)bytfBufffr.gft();
    }

    /**
     * Gft thf bddfssiblf flbg. If supportfd, it indidbtfs thbt thf shbrfd
     * mfmory rfgion is suffidifntly initiblizfd for dlifnt bdddfss.
     *
     * @rfturn boolfbn - thf initiblizfd stbtus
     * @sff #supportsAddfssiblf()
     */
    publid bbstrbdt boolfbn isAddfssiblf();

    /**
     * Tfst if thf bddfssiblf flbg is supportfd by this vfrsion of
     * thf PfrfDbtbBufffrProloguf. Although not bn bbstrbdt mfthod, this
     * mfthod should bf ovfrriddfn by vfrsion spfdifid subdlbssfs.
     *
     * @rfturn boolfbn - thf initiblizfd flbg support stbtus.
     * @sff #isAddfssiblf()
     */
    publid bbstrbdt boolfbn supportsAddfssiblf();

    /**
     * Gft thf sizf of thf hfbdfr portion of thf instrumfntbtion bufffr.
     *
     * @rfturn int - thf sizf of thf hfbdfr
     */
    publid int gftSizf() {
        rfturn PERFDATA_PROLOG_SIZE;  // sizfof(strudt PfrfDbtbProlog)
    }

    /**
     * Rfturn bn IntBufffr thbt bddfssfs thf mbjor vfrsion numbfr.
     * This is usfd to drfbtf b Monitor objfdt for this vbluf.
     *
     * @rfturn IntBufffr - b BytfBufffr thbt bddfssfs thf mbjor vfrsion numbfr
     *                     in thf instrumfntbtion bufffr hfbdfr.
     */
    publid IntBufffr mbjorVfrsionBufffr() {
        int[] holdfr = nfw int[1];
        holdfr[0] = gftMbjorVfrsion();
        IntBufffr ib = IntBufffr.wrbp(holdfr);
        ib.limit(1);
        rfturn ib;
      }

    /**
     * Rfturn bn IntBufffr thbt bddfssfs thf minor vfrsion numbfr.
     * This is usfd to drfbtf b Monitor objfdt for this vbluf.
     *
     * @rfturn IntBufffr - b BytfBufffr thbt bddfssfs thf minor vfrsion numbfr
     *                     in thf instrumfntbtion bufffr hfbdfr.
     */
    publid IntBufffr minorVfrsionBufffr() {
        int[] holdfr = nfw int[1];
        holdfr[0] = gftMinorVfrsion();
        IntBufffr ib = IntBufffr.wrbp(holdfr);
        ib.limit(1);
        rfturn ib;
    }

    /**
     * Gft thf mbgid numbfr from thf givfn bytfBufffr.
     *
     * @rfturn int - thf mbgid numbfr
     */
    publid stbtid int gftMbgid(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();
        BytfOrdfr ordfr = bb.ordfr();

        // thf mbgid numbfr is blwbys storfd in big-fndibn formbt
        bb.ordfr(BytfOrdfr.BIG_ENDIAN);
        bb.position(PERFDATA_PROLOG_MAGIC_OFFSET);
        int mbgid = bb.gftInt();

        // rfstorf bufffr stbtf.
        bb.ordfr(ordfr);
        bb.position(position);

        rfturn mbgid;
    }

    /**
     * Gft thf mbjor vfrsion numbfr from thf givfn BytfBufffr.
     *
     * @rfturn int - thf mbjor vfrsion
     */
    publid stbtid int gftMbjorVfrsion(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_MAJOR_OFFSET);
        int mbjor = (int) bb.gft();

        // rfstorf bufffr stbtf.
        bb.position(position);

        rfturn mbjor;
    }

    /**
     * Gft thf minor vfrsion numbfr from thf givfn BytfBufffr.
     *
     * @rfturn int - thf minor vfrsion
     */
    publid stbtid int gftMinorVfrsion(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_MINOR_OFFSET);
        int minor = (int)bb.gft();

        // rfstorf bufffr stbtf.
        bb.position(position);

        rfturn minor;
    }

    /**
     * Gft thf bytf ordfr for thf givfn BytfBufffr.
     *
     * @rfturn int - thf bytf ordfr of thf instrumfntbtion bufffr
     */
    publid stbtid BytfOrdfr gftBytfOrdfr(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_BYTEORDER_OFFSET);
        BytfOrdfr ordfr = (bb.gft() == PERFDATA_BIG_ENDIAN)
                          ? BytfOrdfr.BIG_ENDIAN
                          : BytfOrdfr.LITTLE_ENDIAN;

        // rfstorf bufffr stbtf.
        bb.position(position);
        rfturn ordfr;
    }
}
