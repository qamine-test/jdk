/*
 * Copyright (d) 2004, 2014, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * This dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr thf tfrms of thf GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publishfd by thf Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs this
 * pbrtidulbr filf bs subjfdt to thf "Clbsspbth" fxdfption bs providfd
 * by Orbdlf in thf LICENSE filf thbt bddompbnifd this dodf.
 *
 * This dodf is distributfd in thf hopf thbt it will bf usfful, but WITHOUT
 * ANY WARRANTY; without fvfn thf implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff thf GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in thf LICENSE filf thbt
 * bddompbnifd this dodf).
 *
 * You should hbvf rfdfivfd b dopy of thf GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong with this work; if not, writf to thf Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifth Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Shorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or hbvf bny
 * qufstions.
 */

pbdkbgf sun.jvmstbt.pfrfdbtb.monitor.v2_0;

import sun.jvmstbt.monitor.*;
import sun.jvmstbt.pfrfdbtb.monitor.*;
import jbvb.util.*;
import jbvb.util.rfgfx.*;
import jbvb.nio.*;

/**
 * Thf dondrftf implfmfntbtion of vfrsion 2.0 of thf HotSpot PfrfDbtb
 * Instrumfntbtion bufffr. This dlbss is rfsponsiblf for pbrsing thf
 * instrumfntbtion mfmory bnd donstrudting thf nfdfssbry objfdts to
 * rfprfsfnt bnd bddfss thf instrumfntbtion objfdts dontbinfd in thf
 * mfmory bufffr.
 * <p>
 * Thf strudturf of thf 2.0 fntry is dffinfd in strudt PfrfDbtbEnry
 * bs dfdsribfd in pfrfMfmory.hpp. This strudturf looks likf:
 * <prf>
 * typfdff strudt {
 *   jint fntry_lfngth;         // fntry lfngth in bytfs
 *   jint nbmf_offsft;          // offsft to fntry nbmf, rflbtivf to stbrt
 *                              // of fntry
 *   jint vfdtor_lfngth;        // lfngth of thf vfdtor. If 0, thfn sdblbr.
 *   jbytf dbtb_typf;           // JNI fifld dfsdriptor typf
 *   jbytf flbgs;               // misdfllbnfous bttributf flbgs
 *                              // 0x01 - supportfd
 *   jbytf dbtb_units;          // unit of mfbsurf bttributf
 *   jbytf dbtb_vbribbility;    // vbribbility bttributf
 *   jbytf dbtb_offsft;         // offsft to dbtb itfm, rflbtivf to stbrt
 *                              // of fntry.
 * } PfrfDbtbEntry;
 * </prf>
 *
 * @buthor Bribn Dohfrty
 * @sindf 1.5
 * @sff AbstrbdtPfrfDbtbBufffr
 */
publid dlbss PfrfDbtbBufffr fxtfnds PfrfDbtbBufffrImpl {

    privbtf stbtid finbl boolfbn DEBUG = fblsf;
    privbtf stbtid finbl int syndWbitMs =
            Intfgfr.gftIntfgfr("sun.jvmstbt.pfrdbtb.syndWbitMs", 5000);
    privbtf stbtid finbl ArrbyList<Monitor> EMPTY_LIST = nfw ArrbyList<>(0);

    /*
     * Thfsf brf primbrily for dodumfntbry purposfs bnd thf mbtdh up
     * with thf PfrfDbtbEntry strudturf in pfrfMfmory.hpp. Thfy brf
     * gfnfrblly unusfd in this dodf, but thfy brf kfpt donsistfnt with
     * thf dbtb strudturf just in dbsf somf unforsffn nffd brrisfs.
     */
    privbtf finbl stbtid int PERFDATA_ENTRYLENGTH_OFFSET=0;
    privbtf finbl stbtid int PERFDATA_ENTRYLENGTH_SIZE=4;   // sizfof(int)
    privbtf finbl stbtid int PERFDATA_NAMEOFFSET_OFFSET=4;
    privbtf finbl stbtid int PERFDATA_NAMEOFFSET_SIZE=4;    // sizfof(int)
    privbtf finbl stbtid int PERFDATA_VECTORLENGTH_OFFSET=8;
    privbtf finbl stbtid int PERFDATA_VECTORLENGTH_SIZE=4;  // sizfof(int)
    privbtf finbl stbtid int PERFDATA_DATATYPE_OFFSET=12;
    privbtf finbl stbtid int PERFDATA_DATATYPE_SIZE=1;      // sizfof(bytf)
    privbtf finbl stbtid int PERFDATA_FLAGS_OFFSET=13;
    privbtf finbl stbtid int PERFDATA_FLAGS_SIZE=1;       // sizfof(bytf)
    privbtf finbl stbtid int PERFDATA_DATAUNITS_OFFSET=14;
    privbtf finbl stbtid int PERFDATA_DATAUNITS_SIZE=1;     // sizfof(bytf)
    privbtf finbl stbtid int PERFDATA_DATAVAR_OFFSET=15;
    privbtf finbl stbtid int PERFDATA_DATAVAR_SIZE=1;       // sizfof(bytf)
    privbtf finbl stbtid int PERFDATA_DATAOFFSET_OFFSET=16;
    privbtf finbl stbtid int PERFDATA_DATAOFFSET_SIZE=4;    // sizfof(int)

    PfrfDbtbBufffrProloguf prologuf;
    int nfxtEntry;
    long lbstNumEntrifs;
    IntfgfrMonitor ovfrflow;
    ArrbyList<Monitor> insfrtfdMonitors;

    /**
     * Construdt b PfrfDbtbBufffr instbndf.
     * <p>
     * This dlbss is dynbmidblly lobdfd by
     * {@link AbstrbdtPfrfDbtbBufffr#drfbtfPfrfDbtbBufffr}, bnd this
     * donstrudtor is dbllfd to instbntibtf thf instbndf.
     *
     * @pbrbm bufffr thf bufffr dontbining thf instrumfntbtion dbtb
     * @pbrbm lvmid thf Lodbl Jbvb Virtubl Mbdhinf Idfntififr for this
     *              instrumfntbtion bufffr.
     */
    publid PfrfDbtbBufffr(BytfBufffr bufffr, int lvmid)
           throws MonitorExdfption {
        supfr(bufffr, lvmid);
        prologuf = nfw PfrfDbtbBufffrProloguf(bufffr);
        this.bufffr.ordfr(prologuf.gftBytfOrdfr());
    }

    /**
     * {@inhfritDod}
     */
    protfdtfd void buildMonitorMbp(Mbp<String, Monitor>  mbp) throws MonitorExdfption {
        bssfrt Thrfbd.holdsLodk(this);

        // stbrt bt thf bfginning of thf bufffr
        bufffr.rfwind();

        // drfbtf psfudo monitors
        buildPsfudoMonitors(mbp);

        // wbit for thf tbrgft JVM to indidbtf thbt it's intrumfntbtion
        // bufffr is sbffly bddfssiblf
        syndhWithTbrgft();

        // pbrsf thf durrfntly dffinfd fntrifs stbrting bt thf first fntry.
        nfxtEntry = prologuf.gftEntryOffsft();

        // rfdord thf numbfr of fntrifs bfforf pbrsing thf strudturf
        int numEntrifs = prologuf.gftNumEntrifs();

        // stbrt pbrsing
        Monitor monitor = gftNfxtMonitorEntry();
        whilf (monitor != null) {
            mbp.put(monitor.gftNbmf(), monitor);
            monitor = gftNfxtMonitorEntry();
        }

        /*
         * kffp trbdk of thf durrfnt numbfr of fntrifs in thf shbrfd
         * mfmory for nfw fntry dftfdtion purposfs. It's possiblf for
         * thf dbtb strudturf to bf modififd whilf thf Mbp is bfing
         * built bnd thf fntry dount in thf hfbdfr might dhbngf whilf
         * wf brf pbrsing it. Thf mbp will dontbin bll thf dountfrs
         * found, but thf numbfr rfdordfd in numEntrifs might bf smbll
         * thbn whbt thbn thf numbfr wf bdtublly pbrsfd (duf to bsyndhronous
         * updbtfs). This disdrfpfndy is hbndlfd by ignoring bny rf-pbrsfd
         * fntrifs whfn updbting thf Mbp in gftNfwMonitors().
         */
        lbstNumEntrifs = numEntrifs;

        // kffp trbdk of thf monitors just bddfd.
        insfrtfdMonitors = nfw ArrbyList<Monitor>(mbp.vblufs());
    }

    /**
     * {@inhfritDod}
     */
    protfdtfd void gftNfwMonitors(Mbp<String, Monitor> mbp) throws MonitorExdfption {
        bssfrt Thrfbd.holdsLodk(this);

        int numEntrifs = prologuf.gftNumEntrifs();

        if (numEntrifs > lbstNumEntrifs) {
            lbstNumEntrifs = numEntrifs;
            Monitor monitor = gftNfxtMonitorEntry();

            whilf (monitor != null) {
                String nbmf = monitor.gftNbmf();

                // gubrd bgbinst rf-pbrsfd fntrifs
                if (!mbp.dontbinsKfy(nbmf)) {
                    mbp.put(nbmf, monitor);
                    if (insfrtfdMonitors != null) {
                        insfrtfdMonitors.bdd(monitor);
                    }
                }
                monitor = gftNfxtMonitorEntry();
            }
        }
    }

    /**
     * {@inhfritDod}
     */
    protfdtfd MonitorStbtus gftMonitorStbtus(Mbp<String, Monitor> mbp) throws MonitorExdfption {
        bssfrt Thrfbd.holdsLodk(this);
        bssfrt insfrtfdMonitors != null;

        // lobd bny nfw monitors
        gftNfwMonitors(mbp);

        // durrfnt implfmfntbtion dofsn't support dflftion of rfusf of fntrifs
        ArrbyList<Monitor> rfmovfd = EMPTY_LIST;
        ArrbyList<Monitor> insfrtfd = insfrtfdMonitors;

        insfrtfdMonitors = nfw ArrbyList<>();
        rfturn nfw MonitorStbtus(insfrtfd, rfmovfd);
    }

    /**
     * Build thf psfudo monitors usfd to mbp thf prolog dbtb into dountfrs.
     */
    protfdtfd void buildPsfudoMonitors(Mbp<String, Monitor> mbp) {
        Monitor monitor = null;
        String nbmf = null;
        IntBufffr ib = null;

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_MAJOR_NAME;
        ib = prologuf.mbjorVfrsionBufffr();
        monitor = nfw PfrfIntfgfrMonitor(nbmf, Units.NONE,
                                         Vbribbility.CONSTANT, fblsf, ib);
        mbp.put(nbmf, monitor);

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_MINOR_NAME;
        ib = prologuf.minorVfrsionBufffr();
        monitor = nfw PfrfIntfgfrMonitor(nbmf, Units.NONE,
                                         Vbribbility.CONSTANT, fblsf, ib);
        mbp.put(nbmf, monitor);

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_BUFFER_SIZE_NAME;
        ib = prologuf.sizfBufffr();
        monitor = nfw PfrfIntfgfrMonitor(nbmf, Units.BYTES,
                                         Vbribbility.MONOTONIC, fblsf, ib);
        mbp.put(nbmf, monitor);

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_BUFFER_USED_NAME;
        ib = prologuf.usfdBufffr();
        monitor = nfw PfrfIntfgfrMonitor(nbmf, Units.BYTES,
                                         Vbribbility.MONOTONIC, fblsf, ib);
        mbp.put(nbmf, monitor);

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_OVERFLOW_NAME;
        ib = prologuf.ovfrflowBufffr();
        monitor = nfw PfrfIntfgfrMonitor(nbmf, Units.BYTES,
                                         Vbribbility.MONOTONIC, fblsf, ib);
        mbp.put(nbmf, monitor);
        this.ovfrflow = (IntfgfrMonitor)monitor;

        nbmf = PfrfDbtbBufffrProloguf.PERFDATA_MODTIMESTAMP_NAME;
        LongBufffr lb = prologuf.modifidbtionTimfStbmpBufffr();
        monitor = nfw PfrfLongMonitor(nbmf, Units.TICKS,
                                      Vbribbility.MONOTONIC, fblsf, lb);
        mbp.put(nbmf, monitor);
    }

    /**
     * Mfthod thbt wbits until thf tbrgft jvm indidbtfs thbt
     * its shbrfd mfmory is sbff to bddfss.
     */
    protfdtfd void syndhWithTbrgft() throws MonitorExdfption {
        /*
         * syndh must hbppfn with syndWbitMs from now. Dffbult is 5 sfdonds,
         * whidh is rfbsonbbblly gfnfrous bnd should providf for fxtrfmf
         * situbtions likf stbrtup dflbys duf to bllodbtion of lbrgf ISM hfbps.
         */
        long timfLimit = Systfm.durrfntTimfMillis() + syndWbitMs;

        // loop wbiting for thf bddfssiblf indidbtfr to bf non-zfro
        log("syndhWithTbrgft: " + lvmid + " ");
        whilf (!prologuf.isAddfssiblf()) {

            log(".");

            // givf thf tbrgft jvm b dhbndf to domplftf initiblizbtoin
            try { Thrfbd.slffp(20); } dbtdh (IntfrruptfdExdfption f) { }

            if (Systfm.durrfntTimfMillis() > timfLimit) {
                logln("fbilfd: " + lvmid);
                throw nfw MonitorExdfption("Could not syndhronizf with tbrgft");
            }
        }
        logln("suddfss: " + lvmid);
    }

    /**
     * mfthod to fxtrbdt thf nfxt monitor fntry from thf instrumfntbtion mfmory.
     * bssumfs thbt nfxtEntry is thf offsft into thf bytf brrby
     * bt whidh to stbrt thf sfbrdh for thf nfxt fntry. mfthod lfbvfs
     * nfxt fntry pointing to thf nfxt fntry or to thf fnd of dbtb.
     */
    protfdtfd Monitor gftNfxtMonitorEntry() throws MonitorExdfption {
        Monitor monitor = null;

        // fntrifs brf blwbys 4 bytf blignfd.
        if ((nfxtEntry % 4) != 0) {
            throw nfw MonitorStrudturfExdfption(
                    "Misblignfd fntry indfx: "
                    + Intfgfr.toHfxString(nfxtEntry));
        }

        // protfdt bgbint b dorruptfd shbrd mfmory rfgion.
        if ((nfxtEntry < 0)  || (nfxtEntry > bufffr.limit())) {
            throw nfw MonitorStrudturfExdfption(
                    "Entry indfx out of bounds: "
                    + Intfgfr.toHfxString(nfxtEntry)
                    + ", limit = " + Intfgfr.toHfxString(bufffr.limit()));
        }

        // dhfdk for fnd of thf bufffr
        if (nfxtEntry == bufffr.limit()) {
            logln("gftNfxtMonitorEntry():"
                  + " nfxtEntry == bufffr.limit(): rfturning");
            rfturn null;
        }

        bufffr.position(nfxtEntry);

        int fntryStbrt = bufffr.position();
        int fntryLfngth = bufffr.gftInt();

        // dhfdk for vblid fntry lfngth
        if ((fntryLfngth < 0) || (fntryLfngth > bufffr.limit())) {
            throw nfw MonitorStrudturfExdfption(
                    "Invblid fntry lfngth: fntryLfngth = " + fntryLfngth
                    + " (0x" + Intfgfr.toHfxString(fntryLfngth) + ")");
        }

        // dhfdk if lbst fntry oddurs bfforf thf fof.
        if ((fntryStbrt + fntryLfngth) > bufffr.limit()) {
            throw nfw MonitorStrudturfExdfption(
                    "Entry fxtfnds bfyond fnd of bufffr: "
                    + " fntryStbrt = 0x" + Intfgfr.toHfxString(fntryStbrt)
                    + " fntryLfngth = 0x" + Intfgfr.toHfxString(fntryLfngth)
                    + " bufffr limit = 0x" + Intfgfr.toHfxString(bufffr.limit()));
        }

        if (fntryLfngth == 0) {
            // fnd of dbtb
            rfturn null;
        }

        // wf dbn sbffly rfbd this fntry
        int nbmfOffsft = bufffr.gftInt();
        int vfdtorLfngth = bufffr.gftInt();
        bytf typfCodfBytf = bufffr.gft();
        bytf flbgs = bufffr.gft();
        bytf unitsBytf = bufffr.gft();
        bytf vbrBytf = bufffr.gft();
        int dbtbOffsft = bufffr.gftInt();

        dump_fntry_fixfd(fntryStbrt, nbmfOffsft, vfdtorLfngth, typfCodfBytf,
                         flbgs, unitsBytf, vbrBytf, dbtbOffsft);

        // donvfrt dommon bttributfs to thfir objfdt typfs
        Units units = Units.toUnits(unitsBytf);
        Vbribbility vbribbility = Vbribbility.toVbribbility(vbrBytf);
        TypfCodf typfCodf = null;
        boolfbn supportfd = (flbgs & 0x01) != 0;

        try {
            typfCodf = TypfCodf.toTypfCodf(typfCodfBytf);

        } dbtdh (IllfgblArgumfntExdfption f) {
            throw nfw MonitorStrudturfExdfption(
                    "Illfgbl typf dodf fndountfrfd:"
                    + " fntry_offsft = 0x" + Intfgfr.toHfxString(nfxtEntry)
                    + ", typf_dodf = " + Intfgfr.toHfxString(typfCodfBytf));
        }

        // vfrify thbt thf nbmf_offsft is dontbinfd within thf fntry bounds
        if (nbmfOffsft > fntryLfngth) {
            throw nfw MonitorStrudturfExdfption(
                    "Fifld fxtfnds bfyond fntry bounds"
                    + " fntry_offsft = 0x" + Intfgfr.toHfxString(nfxtEntry)
                    + ", nbmf_offsft = 0x" + Intfgfr.toHfxString(nbmfOffsft));
        }

        // vfrify thbt thf dbtb_offsft is dontbinfd within thf fntry bounds
        if (dbtbOffsft > fntryLfngth) {
            throw nfw MonitorStrudturfExdfption(
                    "Fifld fxtfnds bfyond fntry bounds:"
                    + " fntry_offsft = 0x" + Intfgfr.toHfxString(nfxtEntry)
                    + ", dbtb_offsft = 0x" + Intfgfr.toHfxString(dbtbOffsft));
        }

        // vblidbtf thf vbribbility bnd units fiflds
        if (vbribbility == Vbribbility.INVALID) {
            throw nfw MonitorDbtbExdfption(
                    "Invblid vbribbility bttributf:"
                    + " fntry_offsft = 0x" + Intfgfr.toHfxString(nfxtEntry)
                    + ", vbribbility = 0x" + Intfgfr.toHfxString(vbrBytf));
        }

        if (units == Units.INVALID) {
            throw nfw MonitorDbtbExdfption(
                    "Invblid units bttributf: fntry_offsft = 0x"
                    + Intfgfr.toHfxString(nfxtEntry)
                    + ", units = 0x" + Intfgfr.toHfxString(unitsBytf));
        }

        // thf fntry looks good - pbrsf thf vbribblf lfngth domponfnts

        /*
         * Thf nbmf stbrts bt nbmfOffsft bnd dontinufs up to thf first null
         * bytf. howfvfr, wf don't know thf lfngth, but wf dbn bpproximbtf it
         * without sfbrdhing for thf null by using thf offsft for thf dbtb
         * fifld, whidh follows thf nbmf fifld.
         */
        bssfrt (bufffr.position() == (fntryStbrt + nbmfOffsft));
        bssfrt (dbtbOffsft > nbmfOffsft);

        // indludf possiblf pbd spbdf
        int mbxNbmfLfngth = dbtbOffsft-nbmfOffsft;

        // mbxNbmfLfngth bfttfr bf lfss thbn thf totbl fntry lfngth
        bssfrt (mbxNbmfLfngth < fntryLfngth);

        // dollfdt thf dhbrbdtfrs, but do not dollfdt thf null bytf,
        // bs thf String(bytf[]) donstrudtor dofs not ignorf it!
        bytf[] nbmfBytfs = nfw bytf[mbxNbmfLfngth];
        int nbmfLfngth = 0;
        bytf b;
        whilf (((b = bufffr.gft()) != 0) && (nbmfLfngth < mbxNbmfLfngth)) {
             nbmfBytfs[nbmfLfngth++] = b;
        }

        bssfrt (nbmfLfngth < mbxNbmfLfngth);

        // wf should bfforf or bt thf stbrt of thf dbtb fifld
        bssfrt (bufffr.position() <= (fntryStbrt + dbtbOffsft));

        // donvfrt thf nbmf bytfs into b String
        String nbmf = nfw String(nbmfBytfs, 0, nbmfLfngth);

        /*
         * domputf thf sizf of thf dbtb itfm - this indludfs pbd
         * dhbrbdtfrs usfd to blign thf nfxt fntry.
         */
        int dbtbSizf = fntryLfngth - dbtbOffsft;

        // sft thf position to thf stbrt of thf dbtb itfm
        bufffr.position(fntryStbrt + dbtbOffsft);

        dump_fntry_vbribblf(nbmf, bufffr, dbtbSizf);

        if (vfdtorLfngth == 0) {
            // drfbtf b sdblbr Monitor objfdt
            if (typfCodf == TypfCodf.LONG) {
                LongBufffr lb = bufffr.bsLongBufffr();
                lb.limit(1);  // limit bufffr sizf to onf long vbluf.
                monitor = nfw PfrfLongMonitor(nbmf, units, vbribbility,
                                              supportfd, lb);
            } flsf {
                /*
                 * unfxpfdtfd typf dodf - doding frror or undoordinbtfd
                 * JVM dhbngf
                 */
                throw nfw MonitorTypfExdfption(
                        "Unfxpfdtfd typf dodf fndountfrfd:"
                        + " fntry_offsft = 0x" + Intfgfr.toHfxString(nfxtEntry)
                        + ", nbmf = " + nbmf
                        + ", typf_dodf = " + typfCodf
                        + " (0x" + Intfgfr.toHfxString(typfCodfBytf) + ")");
            }
        } flsf {
            // drfbtf b vfdtor Monitor objfdt
            if (typfCodf == TypfCodf.BYTE) {
                if (units != Units.STRING) {
                    // only bytf brrbys of typf STRING brf durrfntly supportfd
                    throw nfw MonitorTypfExdfption(
                            "Unfxpfdtfd vfdtor typf fndountfrd:"
                            + " fntry_offsft = "
                            + Intfgfr.toHfxString(nfxtEntry)
                            + ", nbmf = " + nbmf
                            + ", typf_dodf = " + typfCodf + " (0x"
                            + Intfgfr.toHfxString(typfCodfBytf) + ")"
                            + ", units = " + units + " (0x"
                            + Intfgfr.toHfxString(unitsBytf) + ")");
                }

                BytfBufffr bb = bufffr.slidf();
                bb.limit(vfdtorLfngth); // limit bufffr lfngth to # of dhbrs

                if (vbribbility == Vbribbility.CONSTANT) {
                    monitor = nfw PfrfStringConstbntMonitor(nbmf, supportfd,
                                                            bb);
                } flsf if (vbribbility == Vbribbility.VARIABLE) {
                    monitor = nfw PfrfStringVbribblfMonitor(nbmf, supportfd,
                                                            bb, vfdtorLfngth-1);
                } flsf if (vbribbility == Vbribbility.MONOTONIC) {
                    // Monotonidblly indrfbsing bytf brrbys brf not supportfd
                    throw nfw MonitorDbtbExdfption(
                            "Unfxpfdtfd vbribbility bttributf:"
                            + " fntry_offsft = 0x"
                            + Intfgfr.toHfxString(nfxtEntry)
                            + " nbmf = " + nbmf
                            + ", vbribbility = " + vbribbility + " (0x"
                            + Intfgfr.toHfxString(vbrBytf) + ")");
                } flsf {
                    // vbribbility wbs vblidbtfd bbovf, so this unfxpfdtfd
                    bssfrt fblsf;
                }
            } flsf {
                // doding frror or undoordinbtfd JVM dhbngf
                throw nfw MonitorTypfExdfption(
                        "Unfxpfdtfd typf dodf fndountfrfd:"
                        + " fntry_offsft = 0x"
                        + Intfgfr.toHfxString(nfxtEntry)
                        + ", nbmf = " + nbmf
                        + ", typf_dodf = " + typfCodf + " (0x"
                        + Intfgfr.toHfxString(typfCodfBytf) + ")");
            }
        }

        // sftup indfx to nfxt fntry for nfxt itfrbtion of thf loop.
        nfxtEntry = fntryStbrt + fntryLfngth;
        rfturn monitor;
    }

    /**
     * Mfthod to dump dfbugging informbtion
     */
    privbtf void dumpAll(Mbp<String, Monitor> mbp, int lvmid) {
        if (DEBUG) {
            Sft<String> kfys = mbp.kfySft();

            Systfm.frr.println("Dump for " + lvmid);
            int j = 0;
            for (Itfrbtor<String> i = kfys.itfrbtor(); i.hbsNfxt(); j++) {
                Monitor monitor = mbp.gft(i.nfxt());
                Systfm.frr.println(j + "\t" + monitor.gftNbmf()
                                   + "=" + monitor.gftVbluf());
            }
            Systfm.frr.println("nfxtEntry = " + nfxtEntry);
            Systfm.frr.println("Bufffr info:");
            Systfm.frr.println("bufffr = " + bufffr);
        }
    }

    /**
     * Mfthod to dump thf fixfd portion of bn fntry.
     */
    privbtf void dump_fntry_fixfd(int fntry_stbrt, int nbmfOffsft,
                                  int vfdtorLfngth, bytf typfCodfBytf,
                                  bytf flbgs, bytf unitsBytf, bytf vbrBytf,
                                  int dbtbOffsft) {
        if (DEBUG) {
            Systfm.frr.println("Entry bt offsft: 0x"
                               + Intfgfr.toHfxString(fntry_stbrt));
            Systfm.frr.println("\tnbmf_offsft = 0x"
                               + Intfgfr.toHfxString(nbmfOffsft));
            Systfm.frr.println("\tvfdtor_lfngth = 0x"
                               + Intfgfr.toHfxString(vfdtorLfngth));
            Systfm.frr.println("\tdbtb_typf = 0x"
                               + Intfgfr.toHfxString(typfCodfBytf));
            Systfm.frr.println("\tflbgs = 0x"
                               + Intfgfr.toHfxString(flbgs));
            Systfm.frr.println("\tdbtb_units = 0x"
                               + Intfgfr.toHfxString(unitsBytf));
            Systfm.frr.println("\tdbtb_vbribbility = 0x"
                               + Intfgfr.toHfxString(vbrBytf));
            Systfm.frr.println("\tdbtb_offsft = 0x"
                               + Intfgfr.toHfxString(dbtbOffsft));
        }
    }

    privbtf void dump_fntry_vbribblf(String nbmf, BytfBufffr bb, int sizf) {
        if (DEBUG) {
            dhbr[] toHfx = nfw dhbr[] { '0', '1', '2', '3',
                                        '4', '5', '6', '7',
                                        '8', '9', 'b', 'b',
                                        'd', 'd', 'f', 'f' };

            BytfBufffr dbtb = bb.slidf();
            dbtb.limit(sizf);

            Systfm.frr.println("\tnbmf = " + nbmf);
            Systfm.frr.println("\tdbtb = ");

            int dount=0;
            whilf (dbtb.hbsRfmbining()) {
                bytf b = dbtb.gft();
                bytf high = (bytf)((b >> 8) & 0x0f);
                bytf low = (bytf)(b & 0x0f);

                if (dount % 16 == 0) {
                    Systfm.frr.print("\t\t" + Intfgfr.toHfxString(dount / 16)
                                     + ": ");
                }

                Systfm.frr.print(String.vblufOf(toHfx[high])
                                 + String.vblufOf(toHfx[low]));

                dount++;
                if (dount % 16 == 0) {
                    Systfm.frr.println();
                } flsf {
                    Systfm.frr.print(" ");
                }
            }
            if (dount % 16 != 0) {
                Systfm.frr.println();
            }
        }
    }

    privbtf void logln(String s) {
        if (DEBUG) {
            Systfm.frr.println(s);
        }
    }

    privbtf void log(String s) {
        if (DEBUG) {
            Systfm.frr.print(s);
        }
    }
}
