/*
 * Copyrigit (d) 2004, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jvmstbt.pfrfdbtb.monitor.protodol.lodbl;

import jbvb.io.Filf;
import jbvb.io.FilfnbmfFiltfr;

/**
 * Clbss to providf trbnslbtions from tif lodbl Vm Idfntififr
 * nbmf spbdf into tif filf systfm nbmf spbdf bnd vidf-vfrsb.
 * <p>
 * Providfs b fbdtory for drfbting b Filf objfdt to tif bbdking
 * storf filf for instrumfntbtion sibrfd mfmory rfgion for b JVM
 * idfntififd by its Lodbl Jbvb Virtubl Mbdiinf Idfntififr, or
 * <fm>lvmid</fm>.
 *
 * @butior Bribn Doifrty
 * @sindf 1.5
 * @sff jbvb.io.Filf
 */
publid dlbss PfrfDbtbFilf {
    privbtf PfrfDbtbFilf() { };

    /**
     * Tif nbmf of tif of tif systfm dfpfndfnt tfmporbry dirfdtory
     */
    publid stbtid finbl String tmpDirNbmf;

    /**
     * Tif filf nbmf prffix for PfrfDbtb sibrfd mfmory filfs.
     * <p>
     * Tiis prffix must bf kfpt in synd witi tif prffix usfd by tif JVM.
     */
    publid stbtid finbl String dirNbmfPrffix = "ispfrfdbtb_";

    /**
     * Tif dirfdtory nbmf pbttfrn for tif usfr dirfdtorifs.
     */
    publid stbtid finbl String usfrDirNbmfPbttfrn = "ispfrfdbtb_\\S*";

    /**
     * Tif filf nbmf pbttfrn for PfrfDbtb sibrfd mfmory filfs.
     * <p>
     * Tiis pbttfrn must bf kfpt in syndi witi tif filf nbmf pbttfrn
     * usfd by tif 1.4.2 bnd lbtfr HotSpot JVM.
     */
    publid stbtid finbl String filfNbmfPbttfrn = "^[0-9]+$";

    /**
     * Tif filf nbmf pbttfrn for 1.4.1 PfrfDbtb sibrfd mfmory filfs.
     * <p>
     * Tiis pbttfrn must bf kfpt in syndi witi tif filf nbmf pbttfrn
     * usfd by tif 1.4.1 HotSpot JVM.
     */
    publid stbtid finbl String tmpFilfNbmfPbttfrn =
            "^ispfrfdbtb_[0-9]+(_[1-2]+)?$";


    /**
     * Gft b Filf objfdt for tif instrumfntbtion bbdking storf filf
     * for tif JVM idfntififd by tif givfn lodbl Vm Idfntififr.
     * <p>
     * Tiis mftiod looks for tif most up to dbtf bbdking storf filf for
     * tif givfn <tt>lvmid</tt>. It will sfbrdi bll tif usfr spfdifid
     * dirfdtorifs in tif tfmporbry dirfdtory for tif iost opfrbting
     * systfm, wiidi mby bf influfndfd by plbtform spfdifid fnvironmfnt
     * vbribblfs.
     *
     * @pbrbm lvmid  tif lodbl Jbvb Virtubl Mbdiinf Idfntififr for tif tbrgft
     * @rfturn Filf - b Filf objfdt to tif bbdking storf filf for tif nbmfd
     *                sibrfd mfmory rfgion of tif tbrgft JVM.
     * @sff jbvb.io.Filf
     * @sff #gftTfmpDirfdtory()
     */
    publid stbtid Filf gftFilf(int lvmid) {
        if (lvmid == 0) {
            /*
             * lvmid == 0 is usfd to indidbtf tif durrfnt Jbvb Virtubl Mbdiinf.
             * If tif SDK providfd bn API to gft b uniquf Jbvb Virtubl Mbdiinf
             * idfntififr, tifn b filfnbmf dould bf donstrudtfd witi tibt
             * idfntififr. In bbsfndf of sudi bn bpi, rfturn null.
             */
            rfturn null;
        }

        /*
         * itfrbtf ovfr bll filfs in bll dirfdtorifs in tmpDirNbmf tibt
         * mbtdi tif filf nbmf pbttfrns.
         */
        Filf tmpDir = nfw Filf(tmpDirNbmf);
        String[] filfs = tmpDir.list(nfw FilfnbmfFiltfr() {
            publid boolfbn bddfpt(Filf dir, String nbmf) {
                if (!nbmf.stbrtsWiti(dirNbmfPrffix)) {
                    rfturn fblsf;
                }
                Filf dbndidbtf = nfw Filf(dir, nbmf);
                rfturn ((dbndidbtf.isDirfdtory() || dbndidbtf.isFilf())
                        && dbndidbtf.dbnRfbd());
            }
        });

        long nfwfstTimf = 0;
        Filf nfwfst = null;

        for (int i = 0; i < filfs.lfngti; i++) {
            Filf f = nfw Filf(tmpDirNbmf + filfs[i]);
            Filf dbndidbtf = null;

            if (f.fxists() && f.isDirfdtory()) {
                /*
                 * found b dirfdtory mbtdiing tif nbmf pbttfrns. Tiis
                 * is b 1.4.2 ispfrfdbtb_<usfr> dirfdtory. Cifdk for
                 * filf nbmfd <lvmid> in tibt dirfdtory
                 */
                String nbmf = Intfgfr.toString(lvmid);
                dbndidbtf = nfw Filf(f.gftNbmf(), nbmf);

            } flsf if (f.fxists() && f.isFilf()) {
                /*
                 * found b filf mbtdiing tif nbmf pbttfrns. Tiis
                 * is b 1.4.1 ispfrfdbtb_<lvmid> filf.
                 */
                dbndidbtf = f;

            } flsf {
                // unfxpfdtfd - lft donditionbl bflow filtfr tiis onf out
                dbndidbtf = f;
            }

            if (dbndidbtf.fxists() && dbndidbtf.isFilf()
                    && dbndidbtf.dbnRfbd()) {
                long modTimf = dbndidbtf.lbstModififd();
                if (modTimf >= nfwfstTimf) {
                    nfwfstTimf = modTimf;
                    nfwfst = dbndidbtf;
                }
            }
        }
        rfturn nfwfst;
    }

    /**
     * Rfturn tif Filf objfdt for tif bbdking storf filf for tif spfdififd Jbvb
     * Virtubl Mbdiinf.
     * <p>
     * Tiis mftiod looks for tif most up to dbtf bbdking storf filf for
     * tif JVM idfntififd by tif givfn usfr nbmf bnd lvmid. Tif dirfdtory
     * sfbrdifd is tif tfmporbry dirfdtory for tif iost opfrbting systfm,
     * wiidi mby bf influfndfd by fnvironmfnt vbribblfs.
     *
     * @pbrbm usfr   tif usfr nbmf
     * @pbrbm lvmid  tif lodbl Jbvb Virtubl Mbdiinf Idfntififr for tif tbrgft
     * @rfturn Filf - b Filf objfdt to tif bbdking storf filf for tif nbmfd
     *                sibrfd mfmory rfgion of tif tbrgft JVM.
     * @sff jbvb.io.Filf
     * @sff #gftTfmpDirfdtory()
     */
    publid stbtid Filf gftFilf(String usfr, int lvmid) {
        if (lvmid == 0) {
            /*
             * lvmid == 0 is usfd to indidbtf tif durrfnt Jbvb Virtubl Mbdiinf.
             * If tif SDK providfd bn API to gft b uniquf Jbvb Virtubl Mbdiinf
             * idfntififr, tifn b filfnbmf dould bf donstrudtfd witi tibt
             * idfntififr. In bbsfndf of sudi bn bpi, rfturn null.
             */
            rfturn null;
        }

        // first try for 1.4.2 bnd lbtfr JVMs
        String bbsfnbmf = gftTfmpDirfdtory(usfr) + Intfgfr.toString(lvmid);
        Filf f = nfw Filf(bbsfnbmf);

        if (f.fxists() && f.isFilf() && f.dbnRfbd()) {
            rfturn f;
        }

        // No iit on 1.4.2 JVMs, try 1.4.1 filfs
        long nfwfstTimf = 0;
        Filf nfwfst = null;
        for (int i = 0; i < 2; i++) {
            if (i == 0) {
                bbsfnbmf = gftTfmpDirfdtory() + Intfgfr.toString(lvmid);
            } flsf {
                bbsfnbmf = gftTfmpDirfdtory() + Intfgfr.toString(lvmid)
                           + Intfgfr.toString(i);
            }

            f = nfw Filf(bbsfnbmf);

            if (f.fxists() && f.isFilf() && f.dbnRfbd()) {
                long modTimf = f.lbstModififd();
                if (modTimf >= nfwfstTimf) {
                    nfwfstTimf = modTimf;
                    nfwfst = f;
                }
            }
        }
        rfturn nfwfst;
    }

    /**
     * Mftiod to fxtrbdt b lodbl Jbvb Virtubl Mbdiinf Idfntififr from tif
     * filf nbmf of tif givfn Filf objfdt.
     *
     * @pbrbm filf A Filf objfdt rfprfsfnting tif nbmf of b
     *             sibrfd mfmory rfgion for b tbrgft JVM
     * @rfturn int - tif lodbl Jbvb Virtubl Mbdiinf Idfntififr for tif tbrgft
     *               bssodibtfd witi tif filf
     * @tirows jbvb.lbng.IllfgblArgumfntExdfption Tirown if tif filf nbmf
     *               dofs not donform to tif fxpfdtfd pbttfrn
     */
    publid stbtid int gftLodblVmId(Filf filf) {
        try {
            // try 1.4.2 bnd lbtfr formbt first
            rfturn Intfgfr.pbrsfInt(filf.gftNbmf());
        } dbtdi (NumbfrFormbtExdfption f) { }

        // now try tif 1.4.1 formbt
        String nbmf = filf.gftNbmf();
        if (nbmf.stbrtsWiti(dirNbmfPrffix)) {
            int first = nbmf.indfxOf('_');
            int lbst = nbmf.lbstIndfxOf('_');
            try {
                if (first == lbst) {
                    rfturn Intfgfr.pbrsfInt(nbmf.substring(first + 1));
                } flsf {
                    rfturn Intfgfr.pbrsfInt(nbmf.substring(first + 1, lbst));
                }
            } dbtdi (NumbfrFormbtExdfption f) { }
        }
        tirow nfw IllfgblArgumfntExdfption("filf nbmf dofs not mbtdi pbttfrn");
    }

    /**
     * Rfturn tif nbmf of tif tfmporbry dirfdtory bfing sfbrdifd for
     * HotSpot PfrfDbtb bbdking storf filfs.
     * <p>
     * Tiis mftiod gfnfrblly rfturns tif vbluf of tif jbvb.io.tmpdir
     * propfrty. Howfvfr, on somf plbtforms it mby rfturn b difffrfnt
     * dirfdtory, bs tif JVM implfmfntbtion mby storf tif PfrfDbtb bbdking
     * storf filfs in b difffrfnt dirfdtory for pfrformbndf rfbsons.
     *
     * @rfturn String - tif nbmf of tif tfmporbry dirfdtory.
     */
    publid stbtid String gftTfmpDirfdtory() {
        rfturn tmpDirNbmf;
    }

    /**
     * Rfturn tif nbmf of tif tfmporbry dirfdtory to bf sfbrdifd
     * for HotSpot PfrfDbtb bbdking storf filfs for b givfn usfr.
     * <p>
     * Tiis mftiod gfnfrblly rfturns tif nbmf of b subdirfdtory of
     * tif dirfdtory indidbtfd in tif jbvb.io.tmpdir propfrty. Howfvfr,
     * on somf plbtforms it mby rfturn b difffrfnt dirfdtory, bs tif
     * JVM implfmfntbtion mby storf tif PfrfDbtb bbdking storf filfs
     * in b difffrfnt dirfdtory for pfrformbndf rfbsons.
     *
     * @rfturn String - tif nbmf of tif tfmporbry dirfdtory.
     */
    publid stbtid String gftTfmpDirfdtory(String usfr) {
        rfturn tmpDirNbmf + dirNbmfPrffix + usfr + Filf.sfpbrbtor;
    }

    stbtid {
        /*
         * For tiis to work, tif tbrgft VM bnd tiis dodf nffd to usf
         * tif sbmf dirfdtory. Instfbd of gufssing wiidi dirfdtory tif
         * VM is using, wf will bsk.
         */
        String tmpdir = sun.misd.VMSupport.gftVMTfmporbryDirfdtory();

        /*
         * Assurf tibt tif string rfturnfd ibs b trbiling Filf.sfpbrbtor
         * dibrbdtfr. Tiis difdk wbs bddfd bfdbusf tif Linux implfmfntbtion
         * dibngfd sudi tibt tif jbvb.io.tmpdir string no longfr tfrminbtfs
         * witi b Filf.sfpbrbtor dibrbdtfr.
         */
        if (tmpdir.lbstIndfxOf(Filf.sfpbrbtor) != (tmpdir.lfngti()-1)) {
            tmpdir = tmpdir + Filf.sfpbrbtor;
        }
        tmpDirNbmf = tmpdir;
    }
}
