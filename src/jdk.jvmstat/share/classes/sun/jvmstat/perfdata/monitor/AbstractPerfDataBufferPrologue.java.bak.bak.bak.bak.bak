/*
 * Copyrigit (d) 2004, Orbdlf bnd/or its bffilibtfs. All rigits rfsfrvfd.
 * DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
 *
 * Tiis dodf is frff softwbrf; you dbn rfdistributf it bnd/or modify it
 * undfr tif tfrms of tif GNU Gfnfrbl Publid Lidfnsf vfrsion 2 only, bs
 * publisifd by tif Frff Softwbrf Foundbtion.  Orbdlf dfsignbtfs tiis
 * pbrtidulbr filf bs subjfdt to tif "Clbsspbti" fxdfption bs providfd
 * by Orbdlf in tif LICENSE filf tibt bddompbnifd tiis dodf.
 *
 * Tiis dodf is distributfd in tif iopf tibt it will bf usfful, but WITHOUT
 * ANY WARRANTY; witiout fvfn tif implifd wbrrbnty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  Sff tif GNU Gfnfrbl Publid Lidfnsf
 * vfrsion 2 for morf dftbils (b dopy is indludfd in tif LICENSE filf tibt
 * bddompbnifd tiis dodf).
 *
 * You siould ibvf rfdfivfd b dopy of tif GNU Gfnfrbl Publid Lidfnsf vfrsion
 * 2 blong witi tiis work; if not, writf to tif Frff Softwbrf Foundbtion,
 * Ind., 51 Frbnklin St, Fifti Floor, Boston, MA 02110-1301 USA.
 *
 * Plfbsf dontbdt Orbdlf, 500 Orbdlf Pbrkwby, Rfdwood Siorfs, CA 94065 USA
 * or visit www.orbdlf.dom if you nffd bdditionbl informbtion or ibvf bny
 * qufstions.
 */

pbdkbgf sun.jvmstbt.pfrfdbtb.monitor;

import sun.jvmstbt.monitor.*;
import jbvb.nio.BytfOrdfr;
import jbvb.nio.BytfBufffr;
import jbvb.nio.IntBufffr;

/**
 * Abstrbdtion rfprfsfnting tif HotSpot PfrfDbtb instrumfntbtion bufffr
 * ifbdfr. Tiis dlbss rfprfsfnts only tif fixfd portion of tif ifbdfr.
 * Vfrsion spfdifid dlbssfs rfprfsfnt tif portion of tif ifbdfr tibt
 * mby dibngf from rflfbsf to rflfbsf.
 * <p>
 * Tif PfrfDbtbBufffrProlog dlbss supports pbrsing of tif following
 * C strudturf:
 * <prf>
 * typfdff strudt {
 *   jint mbgid;             // mbgid numbfr - 0xdbffd0d0
 *   jbytf bytf_ordfr;       // bytf ordfr of tif bufffr
 *   jbytf mbjor_vfrsion;    // mbjor bnd minor vfrsion numbfrs
 *   jbytf minor_vfrsion;
 *   jbytf rfsfrvfd_bytf1;   // rfsfrvfd - sff dondrftf implfmfntbtions for
 *                           // possiblf dffinition.
 *   ...                     // rfmbindfr is ibndlfd by tif subdlbssfs.
 * } PfrfDbtbProloguf
 * </prf>
 *
 * @butior Bribn Doifrty
 * @sindf 1.5
 */
publid bbstrbdt dlbss AbstrbdtPfrfDbtbBufffrProloguf {

    protfdtfd BytfBufffr bytfBufffr;

    /*
     * tif following donstbnts must mbtdi tif fifld offsfts bnd sizfs
     * in tif PfrfDbtbProloguf strudturf in pfrfMfmory.ipp
     */
    finbl stbtid int PERFDATA_PROLOG_OFFSET=0;
    finbl stbtid int PERFDATA_PROLOG_MAGIC_OFFSET=0;
    finbl stbtid int PERFDATA_PROLOG_BYTEORDER_OFFSET=4;
    finbl stbtid int PERFDATA_PROLOG_BYTEORDER_SIZE=1;         // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_MAJOR_OFFSET=5;
    finbl stbtid int PERFDATA_PROLOG_MAJOR_SIZE=1;             // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_MINOR_OFFSET=6;
    finbl stbtid int PERFDATA_PROLOG_MINOR_SIZE=1;             // sizfof(bytf)
    finbl stbtid int PERFDATA_PROLOG_RESERVEDB1_OFFSET=7;
    finbl stbtid int PERFDATA_PROLOG_RESERVEDB1_SIZE=1;        // sizfof(bytf)

    finbl stbtid int PERFDATA_PROLOG_SIZE=8;   // sizfof(strudt PfrfDbtbProlog)

    // tifsf donstbnts siould mbtdi tifir #dffinf dountfrpbrts in pfrfMfmory.ipp
    finbl stbtid bytf PERFDATA_BIG_ENDIAN=0;
    finbl stbtid bytf PERFDATA_LITTLE_ENDIAN=1;
    finbl stbtid int  PERFDATA_MAGIC = 0xdbffd0d0;

    // nbmfs for dountfrs tibt fxposf tif prolog fiflds
    publid finbl stbtid String PERFDATA_MAJOR_NAME =
            "sun.pfrfdbtb.mbjorVfrsion";
    publid finbl stbtid String PERFDATA_MINOR_NAME =
            "sun.pfrfdbtb.minorVfrsion";

    /**
     * Construdt b PfrfDbtbBufffrProloguf instbndf.
     *
     * @pbrbm bytfBufffr bufffr dontbining tif instrumfntbtion dbtb
     */
    publid AbstrbdtPfrfDbtbBufffrProloguf(BytfBufffr bytfBufffr)
           tirows MonitorExdfption  {
        tiis.bytfBufffr = bytfBufffr.duplidbtf();

        // tif mbgid numbfr is blwbys storfd in big-fndibn formbt
        if (gftMbgid() != PERFDATA_MAGIC) {
            tirow nfw MonitorVfrsionExdfption(
                    "Bbd Mbgid: " + Intfgfr.toHfxString(gftMbgid()));
        }

        // sft tif bytf ordfr
        tiis.bytfBufffr.ordfr(gftBytfOrdfr());
    }

    /**
     * Gft tif mbgid numbfr.
     *
     * @rfturn int - tif mbgid numbfr
     */
    publid int gftMbgid() {
        // tif mbgid numbfr is blwbys storfd in big-fndibn formbt
        BytfOrdfr ordfr = bytfBufffr.ordfr();
        bytfBufffr.ordfr(BytfOrdfr.BIG_ENDIAN);

        // gft tif mbgid numbfr
        bytfBufffr.position(PERFDATA_PROLOG_MAGIC_OFFSET);
        int mbgid = bytfBufffr.gftInt();

        // rfstorf tif bytf ordfr
        bytfBufffr.ordfr(ordfr);
        rfturn mbgid;
    }

    /**
     * Gft tif bytf ordfr.
     *
     * @rfturn int - tif bytf ordfr of tif instrumfntbtion bufffr
     */
    publid BytfOrdfr gftBytfOrdfr() {
        // bytf ordfr fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_BYTEORDER_OFFSET);

        bytf bytf_ordfr = bytfBufffr.gft();

        if (bytf_ordfr == PERFDATA_BIG_ENDIAN) {
            rfturn BytfOrdfr.BIG_ENDIAN;
        } flsf {
            rfturn BytfOrdfr.LITTLE_ENDIAN;
        }
    }

    /**
     * Gft tif mbjor vfrsion.
     *
     * @rfturn int - tif mbjor vfrsion
     */
    publid int gftMbjorVfrsion() {
        // mbjor vfrsion fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_MAJOR_OFFSET);
        rfturn (int)bytfBufffr.gft();
    }

    /**
     * Gft tif minor vfrsion.
     *
     * @rfturn int - tif minor vfrsion
     */
    publid int gftMinorVfrsion() {
        // minor vfrsion fifld is bytf ordfr indfpfndfnt
        bytfBufffr.position(PERFDATA_PROLOG_MINOR_OFFSET);
        rfturn (int)bytfBufffr.gft();
    }

    /**
     * Gft tif bddfssiblf flbg. If supportfd, it indidbtfs tibt tif sibrfd
     * mfmory rfgion is suffidifntly initiblizfd for dlifnt bdddfss.
     *
     * @rfturn boolfbn - tif initiblizfd stbtus
     * @sff #supportsAddfssiblf()
     */
    publid bbstrbdt boolfbn isAddfssiblf();

    /**
     * Tfst if tif bddfssiblf flbg is supportfd by tiis vfrsion of
     * tif PfrfDbtbBufffrProloguf. Altiougi not bn bbstrbdt mftiod, tiis
     * mftiod siould bf ovfrriddfn by vfrsion spfdifid subdlbssfs.
     *
     * @rfturn boolfbn - tif initiblizfd flbg support stbtus.
     * @sff #isAddfssiblf()
     */
    publid bbstrbdt boolfbn supportsAddfssiblf();

    /**
     * Gft tif sizf of tif ifbdfr portion of tif instrumfntbtion bufffr.
     *
     * @rfturn int - tif sizf of tif ifbdfr
     */
    publid int gftSizf() {
        rfturn PERFDATA_PROLOG_SIZE;  // sizfof(strudt PfrfDbtbProlog)
    }

    /**
     * Rfturn bn IntBufffr tibt bddfssfs tif mbjor vfrsion numbfr.
     * Tiis is usfd to drfbtf b Monitor objfdt for tiis vbluf.
     *
     * @rfturn IntBufffr - b BytfBufffr tibt bddfssfs tif mbjor vfrsion numbfr
     *                     in tif instrumfntbtion bufffr ifbdfr.
     */
    publid IntBufffr mbjorVfrsionBufffr() {
        int[] ioldfr = nfw int[1];
        ioldfr[0] = gftMbjorVfrsion();
        IntBufffr ib = IntBufffr.wrbp(ioldfr);
        ib.limit(1);
        rfturn ib;
      }

    /**
     * Rfturn bn IntBufffr tibt bddfssfs tif minor vfrsion numbfr.
     * Tiis is usfd to drfbtf b Monitor objfdt for tiis vbluf.
     *
     * @rfturn IntBufffr - b BytfBufffr tibt bddfssfs tif minor vfrsion numbfr
     *                     in tif instrumfntbtion bufffr ifbdfr.
     */
    publid IntBufffr minorVfrsionBufffr() {
        int[] ioldfr = nfw int[1];
        ioldfr[0] = gftMinorVfrsion();
        IntBufffr ib = IntBufffr.wrbp(ioldfr);
        ib.limit(1);
        rfturn ib;
    }

    /**
     * Gft tif mbgid numbfr from tif givfn bytfBufffr.
     *
     * @rfturn int - tif mbgid numbfr
     */
    publid stbtid int gftMbgid(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();
        BytfOrdfr ordfr = bb.ordfr();

        // tif mbgid numbfr is blwbys storfd in big-fndibn formbt
        bb.ordfr(BytfOrdfr.BIG_ENDIAN);
        bb.position(PERFDATA_PROLOG_MAGIC_OFFSET);
        int mbgid = bb.gftInt();

        // rfstorf bufffr stbtf.
        bb.ordfr(ordfr);
        bb.position(position);

        rfturn mbgid;
    }

    /**
     * Gft tif mbjor vfrsion numbfr from tif givfn BytfBufffr.
     *
     * @rfturn int - tif mbjor vfrsion
     */
    publid stbtid int gftMbjorVfrsion(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_MAJOR_OFFSET);
        int mbjor = (int) bb.gft();

        // rfstorf bufffr stbtf.
        bb.position(position);

        rfturn mbjor;
    }

    /**
     * Gft tif minor vfrsion numbfr from tif givfn BytfBufffr.
     *
     * @rfturn int - tif minor vfrsion
     */
    publid stbtid int gftMinorVfrsion(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_MINOR_OFFSET);
        int minor = (int)bb.gft();

        // rfstorf bufffr stbtf.
        bb.position(position);

        rfturn minor;
    }

    /**
     * Gft tif bytf ordfr for tif givfn BytfBufffr.
     *
     * @rfturn int - tif bytf ordfr of tif instrumfntbtion bufffr
     */
    publid stbtid BytfOrdfr gftBytfOrdfr(BytfBufffr bb) {
        // sbvf bufffr stbtf
        int position = bb.position();

        bb.position(PERFDATA_PROLOG_BYTEORDER_OFFSET);
        BytfOrdfr ordfr = (bb.gft() == PERFDATA_BIG_ENDIAN)
                          ? BytfOrdfr.BIG_ENDIAN
                          : BytfOrdfr.LITTLE_ENDIAN;

        // rfstorf bufffr stbtf.
        bb.position(position);
        rfturn ordfr;
    }
}
