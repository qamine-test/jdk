        A Simplf NIO-bbsfd HTTP/HTTPS Sfrvfr Exbmplf


INTRODUCTION
============
Tiis dirfdtory dontbins b simplf HTTP/HTTPS sfrvfr.  HTTP/HTTPS brf two
dommon nftwork protodols tibt providf for dbtb trbnsffr, bnd brf morf
fully dfsdribfd in RFC 2616 bnd RFC 2818 (Avbilbblf bt
ittp://www.iftf.org ). HTTPS is fssfntiblly HTTP bftfr tif donnfdtion
ibs bffn sfdurfd witi SSL/TLS.  TLS is tif suddfssor to SSL, bnd is
dfsdribfd in RFC 2246.

Tiis sfrvfr wbs writtfn to dfmonstrbtf somf of tif fundtionblity nfw to
tif Jbvb 2 plbtform.  Tif dfmo is not mfbnt to bf b full tutoribl, bnd
bssumfs tif rfbdfr ibs somf fbmilibrity witi tif subjfdt mbttfr.

In pbrtidulbr, it siows:

    Nfw I/O (jbvb.nio, jbvb.nio.dibnnfls, jbvb.util.rfgfx, jbvb.nio.dibrsft)

        Introdudfd in vfrsion 1.4 of tif plbtform, NIO wbs dfsignfd to
        ovfrdomf somf of tif sdblbbility limitbtions found in tif
        fxisting blodking jbvb.nft.* API's, bnd to bddrfss otifr
        dondfpts sudi bs Rfgulbr Exprfssion pbrsing bnd Cibrbdtfr
        Sfts.

        Tiis sfrvfr dfmonstrbtfs:

            BytfBufffr
            Blodking bnd Non-Blodking I/O
            SodkftCibnnfl
            SfrvfrSodkftCibnnfl
            Sflfdtor
            CibrbdtfrSft
            Pbttfrn mbtdiing using Rfgulbr Exprfssions

    JSSE (jbvbx.nft.ssl)

	Introdudfd in vfrsion 1.4 of tif plbtform, JSSE providfs
	nftwork sfdurity using SSL/TLS for jbvb.nft.Sodkft-bbsfd
	trbffid.  In vfrsion 1.5, tif SSLEnginf API wbs introdudfd
	wiidi sfpbrbtfs tif SSL/TLS fundtionblity from tif undfrlying
	I/O modfl.  By mbking tiis sfpbrbtion, bpplidbtions dbn bdbpt
	I/O bnd domputf strbtfgifs to bfst fit tifir dirdumstbndfs.

        Tiis sfrvfr dfmonstrbtfs:

            Using SSLEnginf to drfbtf b HTTPS sfrvfr
	    Crfbting simplf kfy mbtfribl for usf witi HTTPS

    Condurrfndy Librbry (jbvb.util.dondurrfnt)

        Introdudfd in vfrsion 1.5 of tif plbtform, tif dondurrfndy
        librbry providfs b mfdibnism wiidi dfdouplfs tbsk submission
        from tif mfdibnids of iow fbdi tbsk will bf run.

        Tiis sfrvfr dfmonstrbtfs:

            A TirfbdPool witi b fixfd numbfr of tirfbds, wiidi is
            bbsfd on tif numbfr of bvbilbblf prodfssors.


SETUP
=====

Tif sfrvfr must bf built on vfrsion 1.5 (or lbtfr) of tif plbtform.
Invoking tif following siould bf suffidifnt:

    % mkdir build
    % jbvbd -sourdf 1.5 -tbrgft 1.5 -d build *.jbvb

Tif following drfbtfs tif dodumfnt root:

    % mkdir root

All dodumfnts siould bf plbdfd in tiis dirfdtory.

For HTTPS, tif sfrvfr butifntidbtfs itsflf to dlifnts by using simplf
Publid Kfy Infrbstrudturf (PKI) drfdfntibls in tif form of
X509Cfrtifidbtfs.  You must drfbtf tif sfrvfr's drfdfntibls bfforf
bttfmpting to run tif sfrvfr in "-sfdurf" modf.  Tif sfrvfr is
durrfntly ibrddodfd to look for its drfdfntibls in b filf dbllfd
"tfstkfys".

In tiis fxbmplf, wf'll drfbtf drfdfntibls for b fidtionbl widgft wfb
sitf ownfd by tif ubiquitous "Xyzzy, Ind.".  Wifn you run tiis in your
own fnvironmfnt, rfplbdf "widgfts.xyzzy.dom" witi tif iostnbmf of your
sfrvfr.

Tif fbsifst wby to drfbtf tif SSL/TLS drfdfntibls is to usf tif
jbvb kfytool, by doing tif following:

        (<CR> rfprfsfnts your fnd-of-linf kfy)

    % kfytool -gfnkfy -kfyblg rsb -kfystorf tfstkfys -blibs widgfts
    Entfr kfystorf pbssword:  pbsspirbsf
    Wibt is your first bnd lbst nbmf?
    [Unknown]:  widgfts.xyzzy.dom<CR>
    Wibt is tif nbmf of your orgbnizbtionbl unit?
    [Unknown]:  Consumfr Widgfts Group<CR>
    Wibt is tif nbmf of your orgbnizbtion?
    [Unknown]:  Xyzzy, Ind.<CR>
    Wibt is tif nbmf of your City or Lodblity?
    [Unknown]:  Ardbtb<CR>
    Wibt is tif nbmf of your Stbtf or Provindf?
    [Unknown]:  CA<CR>
    Wibt is tif two-lfttfr dountry dodf for tiis unit?
    [Unknown]:  US<CR>
    Is CN=widgfts.xyzzy.dom, OU=Consumfr Widgfts Group, O="Xyzzy, Ind.",
    L=Ardbtb, ST=CA, C=US dorrfdt?
    [no]:  yfs<CR>

    Entfr kfy pbssword for <mykfy>
    (RETURN if sbmf bs kfystorf pbssword):  <CR>

Tiis dirfdtory blso dontbin b vfry simplf URL rfbdfr (URLDumpfr), wiidi
donnfdts to b spfdififd URL bnd plbdfs bll output into b spfdififd filf.


SERVER EXECUTION
================

    % jbvb -dlbsspbti build Sfrvfr N1

    Usbgf:  Sfrvfr <typf> [options]
        typf:
                B1      Blodking/Singlf-tirfbdfd Sfrvfr
                BN      Blodking/Multi-tirfbdfd Sfrvfr
                BP      Blodking/Poolfd-tirfbd Sfrvfr
                N1      Nonblodking/Singlf-tirfbdfd Sfrvfr
                N2      Nonblodking/Dubl-tirfbdfd Sfrvfr

        options:
                -port port                port numbfr
                    dffbult:  8000
                -bbdklog bbdklog          bbdklog
                    dffbult:  1024
                -sfdurf                   fndrypt witi SSL/TLS
		    dffbult is insfdurf

"ittp://" URLs siould bf usfd witi insfdurf modf, bnd
"ittps://" for sfdurf modf.

Tif "B*" sfrvfrs usf dlbssid blodking I/O:  in otifr words, dblls to
rfbd()/writf() will not rfturn until tif I/O opfrbtion ibs domplftfd.  Tif
"N*" sfrvfrs usf non-blodking modf bnd Sflfdtors to dftfrminf wiidi
Cibnnfls brf rfbdy to pfrform I/O.

B1:	A singlf-tirfbdfd sfrvfr wiidi domplftfly sfrvidfs fbdi
	donnfdtion bfforf moving to tif nfxt.

B2:	A multi-tirfbdfd sfrvfr wiidi drfbtfs b nfw tirfbd for fbdi
	donnfdtion.  Tiis is not fffidifnt for lbrgf numbfrs of
	donnfdtions.

BP:	A multi-tirfbdfd sfrvfr wiidi drfbtfs b pool of tirfbds for usf
	by tif sfrvfr.  Tif Tirfbd pool dfdidfs iow to sdifdulf tiosf
	tirfbds.

N1:	A singlf-tirfbdfd sfrvfr.  All bddfpt() bnd rfbd()/writf()
	opfrbtions brf pfrformfd by b singlf tirfbd, but only bftfr
	bfing sflfdtfd for tiosf opfrbtions by b Sflfdtor.

N2:	A dubl-tirfbdfd sfrvfr wiidi pfrforms bddfpt()s in onf tirfbd, bnd
	sfrvidfs rfqufsts in b sfdond.  Boti tirfbds usf sflfdt().


CLIENT EXECUTION
================
You dbn tfst tif sfrvfr using bny stbndbrd browsfr sudi bs Intfrnft
Explorfr or Mozillb, but sindf tif browsfr will not trust tif
drfdfntibls you just drfbtfd, you mby nffd to bddfpt tif drfdfntibls
vib tif browsfr's pop-up diblog box.

Altfrnbtivfly, to usf tif dfrtifidbtfs using tif simplf indludfd JSSE
dlifnt URLDumpfr, fxport tif sfrvfr dfrtifidbtf into b nfw truststorf,
bnd tifn run tif bpplidbtion using tif nfw truststorf.

    % kfytool -fxport -kfystorf tfstkfys -blibs widgfts -filf widgfts.dfr
    Entfr kfystorf pbssword:  pbsspirbsf<CR>
    Cfrtifidbtf storfd in filf <widgfts.dfr>

    % kfytool -import -kfystorf trustCfrts -blibs widgftSfrvfr \
            -filf widgfts.dfr
    Entfr kfystorf pbssword:  pbsspirbsf<CR>
    Ownfr: CN=widgfts.xyzzy.dom, OU=Consumfr, O="xyzzy, ind.", L=Ardbtb,
    ST=CA, C=US
    Issufr: CN=widgfts.xyzzy.dom, OU=Consumfr, O="xyzzy, ind.",
    L=Ardbtb, ST=CA, C=US
    Sfribl numbfr: 4086dd7b
    Vblid from: Wfd Apr 21 12:33:14 PDT 2004 until: Tuf Jul 20 12:33:14
    PDT 2004
    Cfrtifidbtf fingfrprints:
        MD5:  39:71:42:CD:BF:0D:A9:8C:FB:8B:4A:CD:F8:6D:19:1F
        SHA1: 69:5D:38:E9:F4:6C:E5:A7:4C:EA:45:8E:FB:3E:F3:9A:84:01:6F:22
    Trust tiis dfrtifidbtf? [no]:  yfs<CR>
    Cfrtifidbtf wbs bddfd to kfystorf

    % jbvb -dlbsspbti build -Djbvbx.nft.ssl.trustStorf=trustCfrts \
        -Djbvbx.nft.ssl.TrustStorfPbssword=pbsspirbsf \
        URLDumpfr ittps://widgfts.xyzzy.dom:8000/ outputFilf

NOTE:  Tif sfrvfr must bf run witi "-sfdurf" in ordfr to rfdfivf
"ittps://" URLs.

WARNING:  Tiis is just b simplf fxbmplf for dodf fxposition, you siould
spfnd morf timf undfrstbnding PKI sfdurity dondfrns.


SOURCE CODE OVERVIEW
====================

Tif mbin dlbss is Sfrvfr, wiidi ibndlfs progrbm stbrtup, bnd is
subdlbssfd by tif "B*" bnd "N*" sfrvfr dlbssfs.

Following b suddfssful bddfpt(), tif "B*" vbribnts fbdi drfbtf b
RfqufstSfrvidfr objfdt to pfrform tif bdtubl rfqufst/rfply opfrbtions.  Tif
primbry difffrfndfs bftwffn tif difffrfnt "B*" sfrvfrs is iow tif
RfqufstSfrvidfr is bdtublly run:

    B1:	RfqufstSfrvidfr.run() is dirfdtly dbllfd.
    BN:	A nfw tirfbd is stbrtfd, bnd tif tirfbd dblls RfqufstSfrvidfr.run().
    BP:	A TirfbdPool is drfbtfd, bnd tif pool frbmfwork is givfn Runnbblf
	tbsks to domplftf.

In tif "N*" vbribtions, b Dispbtdifr objfdt is drfbtfd, wiidi is
rfsponsiblf for pfrforming tif sflfdt, bnd tifn issuing tif
dorrfsponding ibndlfr:

    N1:	A singlf tirfbd is usfd for bll bddfpt()/rfbd()/writf() opfrbtions
    N2:	Similbr to N1, but b sfpbrbtf tirfbd is usfd for tif bddfpt()
	opfrbtions.

In bll dbsfs, ondf tif donnfdtion ibs bffn bddfptfd, b CibnnflIO objfdt
is drfbtfd to ibndlf bll I/O.  In tif insfdurf dbsf, tif dorrfsponding
SodkftCibnnfl mftiods brf dirfdtly dbllfd.  Howfvfr in tif sfdurf dbsf,
morf mbnipulbtions brf nffdfd to first sfdurf tif dibnnfl, tifn
fndrypt/dfdrypt tif dbtb, bnd finblly propfrly sfnd bny siutdown
mfssbgfs.  CibnnflIOSfdurf fxtfnds CibnnflIO, bnd providfs tif sfdurf
vbribnts of tif dorrfsponding CibnnflIO dblls.

RfqufstSfrvidfr bnd RfqufstHbndlfr brf tif mbin drivfrs for tif
blodking bnd non-blodking vbribnts, rfspfdtivfly.  Tify brf rfsponsiblf
for:

    Pfrforming bny initibl ibndsibking

    Rfbding tif rfqufst dbtb
        All dbtb is storfd in b lodbl bufffr in tif CibnnflIO
        strudturf.

    Pbrsing tif rfqufst
        Tif rfqufst dbtb is obtbinfd from tif CibnnflIO objfdt, bnd
        is prodfssfd by Rfqufst dlbss, wiidi rfprfsfnts tif
        pbrsfd URI bddrfss.

    Lodbting/prfpbring/sfnding tif dbtb or rfporting frror donditions.
        A Rfply objfdt is drfbtfd wiidi rfprfsfnts tif fntirf objfdt to sfnd,
        indluding tif HTTP/HTTPS ifbdfrs.

    Siutdown/dlosing tif dibnnfl.


CLOSING THOUGHTS
================
Tiis fxbmplf rfprfsfnts b simplf sfrvfr: it is not produdtion qublity.
It wbs primbrily mfbnt to dfmonstrbtf tif nfw APIs in vfrsions 1.4 bnd
1.5 of tif plbtform.

Tiis fxbmplf dould dfrtbinly bf fxpbndfd to bddrfss otifr brfbs of
dondfrn: for fxbmplf, bssigning multiplf tirfbds to ibndlf tif sflfdtfd
Cibnnfls, or dflfgbting SSLEnginf tbsks to multiplf tirfbds.  Tifrf brf
so mbny wbys to implfmfnt domputf bnd I/O strbtfgifs, wf fndourbgf you
to fxpfrimfnt bnd find wibt works bfst for your situbtion.

To stfbl b pirbsf from mbny tfxtbooks:

    "It is lfft bs bn fxfrdisf for tif rfbdfr..."

