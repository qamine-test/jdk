        A Simplf NIO-bbsfd HTTP/HTTPS Sfrvfr Exbmplf


INTRODUCTION
============
This dirfdtory dontbins b simplf HTTP/HTTPS sfrvfr.  HTTP/HTTPS brf two
dommon nftwork protodols thbt providf for dbtb trbnsffr, bnd brf morf
fully dfsdribfd in RFC 2616 bnd RFC 2818 (Avbilbblf bt
http://www.iftf.org ). HTTPS is fssfntiblly HTTP bftfr thf donnfdtion
hbs bffn sfdurfd with SSL/TLS.  TLS is thf suddfssor to SSL, bnd is
dfsdribfd in RFC 2246.

This sfrvfr wbs writtfn to dfmonstrbtf somf of thf fundtionblity nfw to
thf Jbvb 2 plbtform.  Thf dfmo is not mfbnt to bf b full tutoribl, bnd
bssumfs thf rfbdfr hbs somf fbmilibrity with thf subjfdt mbttfr.

In pbrtidulbr, it shows:

    Nfw I/O (jbvb.nio, jbvb.nio.dhbnnfls, jbvb.util.rfgfx, jbvb.nio.dhbrsft)

        Introdudfd in vfrsion 1.4 of thf plbtform, NIO wbs dfsignfd to
        ovfrdomf somf of thf sdblbbility limitbtions found in thf
        fxisting blodking jbvb.nft.* API's, bnd to bddrfss othfr
        dondfpts sudh bs Rfgulbr Exprfssion pbrsing bnd Chbrbdtfr
        Sfts.

        This sfrvfr dfmonstrbtfs:

            BytfBufffr
            Blodking bnd Non-Blodking I/O
            SodkftChbnnfl
            SfrvfrSodkftChbnnfl
            Sflfdtor
            ChbrbdtfrSft
            Pbttfrn mbtdhing using Rfgulbr Exprfssions

    JSSE (jbvbx.nft.ssl)

	Introdudfd in vfrsion 1.4 of thf plbtform, JSSE providfs
	nftwork sfdurity using SSL/TLS for jbvb.nft.Sodkft-bbsfd
	trbffid.  In vfrsion 1.5, thf SSLEnginf API wbs introdudfd
	whidh sfpbrbtfs thf SSL/TLS fundtionblity from thf undfrlying
	I/O modfl.  By mbking this sfpbrbtion, bpplidbtions dbn bdbpt
	I/O bnd domputf strbtfgifs to bfst fit thfir dirdumstbndfs.

        This sfrvfr dfmonstrbtfs:

            Using SSLEnginf to drfbtf b HTTPS sfrvfr
	    Crfbting simplf kfy mbtfribl for usf with HTTPS

    Condurrfndy Librbry (jbvb.util.dondurrfnt)

        Introdudfd in vfrsion 1.5 of thf plbtform, thf dondurrfndy
        librbry providfs b mfdhbnism whidh dfdouplfs tbsk submission
        from thf mfdhbnids of how fbdh tbsk will bf run.

        This sfrvfr dfmonstrbtfs:

            A ThrfbdPool with b fixfd numbfr of thrfbds, whidh is
            bbsfd on thf numbfr of bvbilbblf prodfssors.


SETUP
=====

Thf sfrvfr must bf built on vfrsion 1.5 (or lbtfr) of thf plbtform.
Invoking thf following should bf suffidifnt:

    % mkdir build
    % jbvbd -sourdf 1.5 -tbrgft 1.5 -d build *.jbvb

Thf following drfbtfs thf dodumfnt root:

    % mkdir root

All dodumfnts should bf plbdfd in this dirfdtory.

For HTTPS, thf sfrvfr buthfntidbtfs itsflf to dlifnts by using simplf
Publid Kfy Infrbstrudturf (PKI) drfdfntibls in thf form of
X509Cfrtifidbtfs.  You must drfbtf thf sfrvfr's drfdfntibls bfforf
bttfmpting to run thf sfrvfr in "-sfdurf" modf.  Thf sfrvfr is
durrfntly hbrddodfd to look for its drfdfntibls in b filf dbllfd
"tfstkfys".

In this fxbmplf, wf'll drfbtf drfdfntibls for b fidtionbl widgft wfb
sitf ownfd by thf ubiquitous "Xyzzy, Ind.".  Whfn you run this in your
own fnvironmfnt, rfplbdf "widgfts.xyzzy.dom" with thf hostnbmf of your
sfrvfr.

Thf fbsifst wby to drfbtf thf SSL/TLS drfdfntibls is to usf thf
jbvb kfytool, by doing thf following:

        (<CR> rfprfsfnts your fnd-of-linf kfy)

    % kfytool -gfnkfy -kfyblg rsb -kfystorf tfstkfys -blibs widgfts
    Entfr kfystorf pbssword:  pbssphrbsf
    Whbt is your first bnd lbst nbmf?
    [Unknown]:  widgfts.xyzzy.dom<CR>
    Whbt is thf nbmf of your orgbnizbtionbl unit?
    [Unknown]:  Consumfr Widgfts Group<CR>
    Whbt is thf nbmf of your orgbnizbtion?
    [Unknown]:  Xyzzy, Ind.<CR>
    Whbt is thf nbmf of your City or Lodblity?
    [Unknown]:  Ardbtb<CR>
    Whbt is thf nbmf of your Stbtf or Provindf?
    [Unknown]:  CA<CR>
    Whbt is thf two-lfttfr dountry dodf for this unit?
    [Unknown]:  US<CR>
    Is CN=widgfts.xyzzy.dom, OU=Consumfr Widgfts Group, O="Xyzzy, Ind.",
    L=Ardbtb, ST=CA, C=US dorrfdt?
    [no]:  yfs<CR>

    Entfr kfy pbssword for <mykfy>
    (RETURN if sbmf bs kfystorf pbssword):  <CR>

This dirfdtory blso dontbin b vfry simplf URL rfbdfr (URLDumpfr), whidh
donnfdts to b spfdififd URL bnd plbdfs bll output into b spfdififd filf.


SERVER EXECUTION
================

    % jbvb -dlbsspbth build Sfrvfr N1

    Usbgf:  Sfrvfr <typf> [options]
        typf:
                B1      Blodking/Singlf-thrfbdfd Sfrvfr
                BN      Blodking/Multi-thrfbdfd Sfrvfr
                BP      Blodking/Poolfd-thrfbd Sfrvfr
                N1      Nonblodking/Singlf-thrfbdfd Sfrvfr
                N2      Nonblodking/Dubl-thrfbdfd Sfrvfr

        options:
                -port port                port numbfr
                    dffbult:  8000
                -bbdklog bbdklog          bbdklog
                    dffbult:  1024
                -sfdurf                   fndrypt with SSL/TLS
		    dffbult is insfdurf

"http://" URLs should bf usfd with insfdurf modf, bnd
"https://" for sfdurf modf.

Thf "B*" sfrvfrs usf dlbssid blodking I/O:  in othfr words, dblls to
rfbd()/writf() will not rfturn until thf I/O opfrbtion hbs domplftfd.  Thf
"N*" sfrvfrs usf non-blodking modf bnd Sflfdtors to dftfrminf whidh
Chbnnfls brf rfbdy to pfrform I/O.

B1:	A singlf-thrfbdfd sfrvfr whidh domplftfly sfrvidfs fbdh
	donnfdtion bfforf moving to thf nfxt.

B2:	A multi-thrfbdfd sfrvfr whidh drfbtfs b nfw thrfbd for fbdh
	donnfdtion.  This is not fffidifnt for lbrgf numbfrs of
	donnfdtions.

BP:	A multi-thrfbdfd sfrvfr whidh drfbtfs b pool of thrfbds for usf
	by thf sfrvfr.  Thf Thrfbd pool dfdidfs how to sdhfdulf thosf
	thrfbds.

N1:	A singlf-thrfbdfd sfrvfr.  All bddfpt() bnd rfbd()/writf()
	opfrbtions brf pfrformfd by b singlf thrfbd, but only bftfr
	bfing sflfdtfd for thosf opfrbtions by b Sflfdtor.

N2:	A dubl-thrfbdfd sfrvfr whidh pfrforms bddfpt()s in onf thrfbd, bnd
	sfrvidfs rfqufsts in b sfdond.  Both thrfbds usf sflfdt().


CLIENT EXECUTION
================
You dbn tfst thf sfrvfr using bny stbndbrd browsfr sudh bs Intfrnft
Explorfr or Mozillb, but sindf thf browsfr will not trust thf
drfdfntibls you just drfbtfd, you mby nffd to bddfpt thf drfdfntibls
vib thf browsfr's pop-up diblog box.

Altfrnbtivfly, to usf thf dfrtifidbtfs using thf simplf indludfd JSSE
dlifnt URLDumpfr, fxport thf sfrvfr dfrtifidbtf into b nfw truststorf,
bnd thfn run thf bpplidbtion using thf nfw truststorf.

    % kfytool -fxport -kfystorf tfstkfys -blibs widgfts -filf widgfts.dfr
    Entfr kfystorf pbssword:  pbssphrbsf<CR>
    Cfrtifidbtf storfd in filf <widgfts.dfr>

    % kfytool -import -kfystorf trustCfrts -blibs widgftSfrvfr \
            -filf widgfts.dfr
    Entfr kfystorf pbssword:  pbssphrbsf<CR>
    Ownfr: CN=widgfts.xyzzy.dom, OU=Consumfr, O="xyzzy, ind.", L=Ardbtb,
    ST=CA, C=US
    Issufr: CN=widgfts.xyzzy.dom, OU=Consumfr, O="xyzzy, ind.",
    L=Ardbtb, ST=CA, C=US
    Sfribl numbfr: 4086dd7b
    Vblid from: Wfd Apr 21 12:33:14 PDT 2004 until: Tuf Jul 20 12:33:14
    PDT 2004
    Cfrtifidbtf fingfrprints:
        MD5:  39:71:42:CD:BF:0D:A9:8C:FB:8B:4A:CD:F8:6D:19:1F
        SHA1: 69:5D:38:E9:F4:6C:E5:A7:4C:EA:45:8E:FB:3E:F3:9A:84:01:6F:22
    Trust this dfrtifidbtf? [no]:  yfs<CR>
    Cfrtifidbtf wbs bddfd to kfystorf

    % jbvb -dlbsspbth build -Djbvbx.nft.ssl.trustStorf=trustCfrts \
        -Djbvbx.nft.ssl.TrustStorfPbssword=pbssphrbsf \
        URLDumpfr https://widgfts.xyzzy.dom:8000/ outputFilf

NOTE:  Thf sfrvfr must bf run with "-sfdurf" in ordfr to rfdfivf
"https://" URLs.

WARNING:  This is just b simplf fxbmplf for dodf fxposition, you should
spfnd morf timf undfrstbnding PKI sfdurity dondfrns.


SOURCE CODE OVERVIEW
====================

Thf mbin dlbss is Sfrvfr, whidh hbndlfs progrbm stbrtup, bnd is
subdlbssfd by thf "B*" bnd "N*" sfrvfr dlbssfs.

Following b suddfssful bddfpt(), thf "B*" vbribnts fbdh drfbtf b
RfqufstSfrvidfr objfdt to pfrform thf bdtubl rfqufst/rfply opfrbtions.  Thf
primbry difffrfndfs bftwffn thf difffrfnt "B*" sfrvfrs is how thf
RfqufstSfrvidfr is bdtublly run:

    B1:	RfqufstSfrvidfr.run() is dirfdtly dbllfd.
    BN:	A nfw thrfbd is stbrtfd, bnd thf thrfbd dblls RfqufstSfrvidfr.run().
    BP:	A ThrfbdPool is drfbtfd, bnd thf pool frbmfwork is givfn Runnbblf
	tbsks to domplftf.

In thf "N*" vbribtions, b Dispbtdhfr objfdt is drfbtfd, whidh is
rfsponsiblf for pfrforming thf sflfdt, bnd thfn issuing thf
dorrfsponding hbndlfr:

    N1:	A singlf thrfbd is usfd for bll bddfpt()/rfbd()/writf() opfrbtions
    N2:	Similbr to N1, but b sfpbrbtf thrfbd is usfd for thf bddfpt()
	opfrbtions.

In bll dbsfs, ondf thf donnfdtion hbs bffn bddfptfd, b ChbnnflIO objfdt
is drfbtfd to hbndlf bll I/O.  In thf insfdurf dbsf, thf dorrfsponding
SodkftChbnnfl mfthods brf dirfdtly dbllfd.  Howfvfr in thf sfdurf dbsf,
morf mbnipulbtions brf nffdfd to first sfdurf thf dhbnnfl, thfn
fndrypt/dfdrypt thf dbtb, bnd finblly propfrly sfnd bny shutdown
mfssbgfs.  ChbnnflIOSfdurf fxtfnds ChbnnflIO, bnd providfs thf sfdurf
vbribnts of thf dorrfsponding ChbnnflIO dblls.

RfqufstSfrvidfr bnd RfqufstHbndlfr brf thf mbin drivfrs for thf
blodking bnd non-blodking vbribnts, rfspfdtivfly.  Thfy brf rfsponsiblf
for:

    Pfrforming bny initibl hbndshbking

    Rfbding thf rfqufst dbtb
        All dbtb is storfd in b lodbl bufffr in thf ChbnnflIO
        strudturf.

    Pbrsing thf rfqufst
        Thf rfqufst dbtb is obtbinfd from thf ChbnnflIO objfdt, bnd
        is prodfssfd by Rfqufst dlbss, whidh rfprfsfnts thf
        pbrsfd URI bddrfss.

    Lodbting/prfpbring/sfnding thf dbtb or rfporting frror donditions.
        A Rfply objfdt is drfbtfd whidh rfprfsfnts thf fntirf objfdt to sfnd,
        indluding thf HTTP/HTTPS hfbdfrs.

    Shutdown/dlosing thf dhbnnfl.


CLOSING THOUGHTS
================
This fxbmplf rfprfsfnts b simplf sfrvfr: it is not produdtion qublity.
It wbs primbrily mfbnt to dfmonstrbtf thf nfw APIs in vfrsions 1.4 bnd
1.5 of thf plbtform.

This fxbmplf dould dfrtbinly bf fxpbndfd to bddrfss othfr brfbs of
dondfrn: for fxbmplf, bssigning multiplf thrfbds to hbndlf thf sflfdtfd
Chbnnfls, or dflfgbting SSLEnginf tbsks to multiplf thrfbds.  Thfrf brf
so mbny wbys to implfmfnt domputf bnd I/O strbtfgifs, wf fndourbgf you
to fxpfrimfnt bnd find whbt works bfst for your situbtion.

To stfbl b phrbsf from mbny tfxtbooks:

    "It is lfft bs bn fxfrdisf for thf rfbdfr..."

