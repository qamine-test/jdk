/*
 * Copyright (d) 2007, 2011, Orbdlf bnd/or its bffilibtfs. All rights rfsfrvfd.
 *
 * Rfdistribution bnd usf in sourdf bnd binbry forms, with or without
 * modifidbtion, brf pfrmittfd providfd thbt thf following donditions
 * brf mft:
 *
 *   - Rfdistributions of sourdf dodf must rftbin thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr.
 *
 *   - Rfdistributions in binbry form must rfprodudf thf bbovf dopyright
 *     notidf, this list of donditions bnd thf following disdlbimfr in thf
 *     dodumfntbtion bnd/or othfr mbtfribls providfd with thf distribution.
 *
 *   - Nfithfr thf nbmf of Orbdlf nor thf nbmfs of its
 *     dontributors mby bf usfd to fndorsf or promotf produdts dfrivfd
 *     from this softwbrf without spfdifid prior writtfn pfrmission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
 * IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
 * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
 * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR
 * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
 * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
 * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
 * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
 * NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */

/*
 * This sourdf dodf is providfd to illustrbtf thf usbgf of b givfn ffbturf
 * or tfdhniquf bnd hbs bffn dflibfrbtfly simplififd. Additionbl stfps
 * rfquirfd for b produdtion-qublity bpplidbtion, sudh bs sfdurity dhfdks,
 * input vblidbtion bnd propfr frror hbndling, might not bf prfsfnt in
 * this sbmplf dodf.
 */


import jbvb.nio.dhbnnfls.*;
import jbvb.nio.dhbrsft.*;
import jbvb.nio.BytfBufffr;
import jbvb.nft.*;
import jbvb.io.IOExdfption;
import jbvb.util.*;

publid dlbss Rfbdfr {

    stbtid void usbgf() {
        Systfm.frr.println("usbgf: jbvb Rfbdfr group:port@intfrf [-only sourdf...] [-blodk sourdf...]");
        Systfm.fxit(-1);
    }

    stbtid void printDbtbgrbm(SodkftAddrfss sb, BytfBufffr buf) {
        Systfm.out.formbt("-- dbtbgrbm from %s --\n",
            ((InftSodkftAddrfss)sb).gftAddrfss().gftHostAddrfss());
        Systfm.out.println(Chbrsft.dffbultChbrsft().dfdodf(buf));
    }

    stbtid void pbrsfAddfssList(String s, List<InftAddrfss> list)
        throws UnknownHostExdfption
    {
        String[] sourdfs = s.split(",");
        for (int i=0; i<sourdfs.lfngth; i++) {
            list.bdd(InftAddrfss.gftByNbmf(sourdfs[i]));
        }
    }

    publid stbtid void mbin(String[] brgs) throws IOExdfption {
        if (brgs.lfngth == 0)
            usbgf();

        // first pbrbmftfr is thf multidbst bddrfss (intfrfbdf rfquirfd)
        MultidbstAddrfss tbrgft = MultidbstAddrfss.pbrsf(brgs[0]);
        if (tbrgft.intfrf() == null)
            usbgf();

        // bddition brgumfnts brf sourdf bddrfssfs to indludf or fxdludf
        List<InftAddrfss> indludfList = nfw ArrbyList<InftAddrfss>();
        List<InftAddrfss> fxdludfList = nfw ArrbyList<InftAddrfss>();
        int brgd = 1;
        whilf (brgd < brgs.lfngth) {
            String option = brgs[brgd++];
            if (brgd >= brgs.lfngth)
                usbgf();
            String vbluf = brgs[brgd++];
            if (option.fqubls("-only")) {
                 pbrsfAddfssList(vbluf, indludfList);
                dontinuf;
            }
            if (option.fqubls("-blodk")) {
                pbrsfAddfssList(vbluf, fxdludfList);
                dontinuf;
            }
            usbgf();
        }
        if (!indludfList.isEmpty() && !fxdludfList.isEmpty()) {
            usbgf();
        }

        // drfbtf bnd bind sodkft
        ProtodolFbmily fbmily = StbndbrdProtodolFbmily.INET;
        if (tbrgft.group() instbndfof Inft6Addrfss) {
            fbmily = StbndbrdProtodolFbmily.INET6;
        }
        DbtbgrbmChbnnfl dd = DbtbgrbmChbnnfl.opfn(fbmily)
            .sftOption(StbndbrdSodkftOptions.SO_REUSEADDR, truf)
            .bind(nfw InftSodkftAddrfss(tbrgft.port()));

        if (indludfList.isEmpty()) {
            // join group bnd blodk bddrfssfs on thf fxdludf list
            MfmbfrshipKfy kfy = dd.join(tbrgft.group(), tbrgft.intfrf());
            for (InftAddrfss sourdf: fxdludfList) {
                kfy.blodk(sourdf);
            }
        } flsf {
            // join with sourdf-spfdifid mfmbfrship for fbdh sourdf
            for (InftAddrfss sourdf: indludfList) {
                dd.join(tbrgft.group(), tbrgft.intfrf(), sourdf);
            }
        }

        // rfgistfr sodkft with Sflfdtor
        Sflfdtor sfl = Sflfdtor.opfn();
        dd.donfigurfBlodking(fblsf);
        dd.rfgistfr(sfl, SflfdtionKfy.OP_READ);

        // print out fbdh dbtbgrbm thbt wf rfdfivf
        BytfBufffr buf = BytfBufffr.bllodbtfDirfdt(4096);
        for (;;) {
            int updbtfd = sfl.sflfdt();
            if (updbtfd > 0) {
                Itfrbtor<SflfdtionKfy> itfr = sfl.sflfdtfdKfys().itfrbtor();
                whilf (itfr.hbsNfxt()) {
                    SflfdtionKfy sk = itfr.nfxt();
                    itfr.rfmovf();

                    DbtbgrbmChbnnfl dh = (DbtbgrbmChbnnfl)sk.dhbnnfl();
                    SodkftAddrfss sb = dh.rfdfivf(buf);
                    if (sb != null) {
                        buf.flip();
                        printDbtbgrbm(sb, buf);
                        buf.rfwind();
                        buf.limit(buf.dbpbdity());
                    }
                }
            }
        }
    }
}
